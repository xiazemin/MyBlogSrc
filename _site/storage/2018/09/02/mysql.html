<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">MySQL协议分析</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2018-09-02T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Sep 2, 2018</time></p>
					</div>
					 <p>目录<br />
1 交互过程<br />
1.1 握手认证阶段<br />
1.2 命令执行阶段<br />
2 基本类型<br />
2.1 整型值<br />
2.2 字符串（以NULL结尾）（Null-Terminated String）<br />
2.3 二进制数据（长度编码）（Length Coded Binary）<br />
2.4 字符串（长度编码）（Length Coded String）<br />
3 报文结构<br />
3.1 消息头<br />
3.1.1 报文长度<br />
3.1.2 序号<br />
3.2 消息体<br />
4 报文类型<br />
4.1 登陆认证交互报文<br />
4.1.1 握手初始化报文（服务器 -&gt; 客户端）<br />
4.1.2 登陆认证报文（客户端 -&gt; 服务器）<br />
4.2 客户端命令请求报文（客户端 -&gt; 服务器）<br />
4.2.1 COM_QUIT 消息报文<br />
4.2.2 COM_INIT_DB 消息报文<br />
4.2.3 COM_QUERY 消息报文<br />
4.2.4 COM_FIELD_LIST 消息报文<br />
4.2.5 COM_CREATE_DB 消息报文<br />
4.2.6 COM_DROP_DB 消息报文<br />
4.2.7 COM_REFRESH 消息报文<br />
4.2.8 COM_SHUTDOWN 消息报文<br />
4.2.9 COM_STATISTICS 消息报文<br />
4.2.10 COM_PROCESS_INFO 消息报文<br />
4.2.11 COM_PROCESS_KILL 消息报文<br />
4.2.12 COM_DEBUG 消息报文<br />
4.2.13 COM_PING 消息报文<br />
4.2.14 COM_CHANGE_USER 消息报文<br />
4.2.15 COM_BINLOG_DUMP 消息报文<br />
4.2.16 COM_TABLE_DUMP 消息报文<br />
4.2.17 COM_REGISTER_SLAVE 消息报文<br />
4.2.18 COM_PREPARE 消息报文<br />
4.2.19 COM_EXECUTE 消息报文<br />
4.2.20 COM_LONG_DATA 消息报文<br />
4.2.21 COM_CLOSE_STMT 消息报文<br />
4.2.22 COM_RESET_STMT 消息报文<br />
4.2.23 COM_SET_OPTION 消息报文<br />
4.2.24 COM_FETCH_STMT 消息报文<br />
4.3 服务器响应报文（服务器 -&gt; 客户端）<br />
4.3.1 OK 响应报文<br />
4.3.2 Error 响应报文<br />
4.3.3 Result Set 消息<br />
4.3.4 Result Set Header 结构<br />
4.3.5 Field 结构<br />
4.3.6 EOF 结构<br />
4.3.7 Row Data 结构<br />
4.3.8 Row Data 结构（二进制数据）<br />
4.3.9 PREPARE_OK 响应报文（Prepared Statement）<br />
4.3.10 Parameter 响应报文（Prepared Statement）<br />
5 参考资料<br />
<!-- more --><br />
1 交互过程<br />
MySQL客户端与服务器的交互主要分为两个阶段：握手认证阶段和命令执行阶段。</p><br />
<br />
<p>1.1 握手认证阶段<br />
握手认证阶段为客户端与服务器建立连接后进行，交互过程如下：</p><br />
<br />
<p>服务器 -&gt; 客户端：握手初始化消息<br />
客户端 -&gt; 服务器：登陆认证消息<br />
服务器 -&gt; 客户端：认证结果消息<br />
1.2 命令执行阶段<br />
客户端认证成功后，会进入命令执行阶段，交互过程如下：</p><br />
<br />
<p>客户端 -&gt; 服务器：执行命令消息<br />
服务器 -&gt; 客户端：命令执行结果<br />
MySQL客户端与服务器的完整交互过程如下：<br />
<img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_message.png" /><br />
2 基本类型<br />
2.1 整型值<br />
MySQL报文中整型值分别有1、2、3、4、8字节长度，使用小字节序传输。</p><br />
<br />
<p>2.2 字符串（以NULL结尾）（Null-Terminated String）<br />
字符串长度不固定，当遇到’NULL’（0x00）字符时结束。</p><br />
<br />
<p>2.3 二进制数据（长度编码）（Length Coded Binary）<br />
数据长度不固定，长度值由数据前的1-9个字节决定，其中长度值所占的字节数不定，字节数由第1个字节决定，如下表：</p><br />
<br />
<p>第一个字节值	后续字节数	长度值说明<br />
0-250	0	第一个字节值即为数据的真实长度<br />
251	0	空数据，数据的真实长度为零<br />
252	2	后续额外2个字节标识了数据的真实长度<br />
253	3	后续额外3个字节标识了数据的真实长度<br />
254	8	后续额外8个字节标识了数据的真实长度<br />
2.4 字符串（长度编码）（Length Coded String）<br />
字符串长度不固定，无’NULL’（0x00）结束符，编码方式与上面的 Length Coded Binary 相同。</p><br />
<br />
<p>3 报文结构<br />
报文分为消息头和消息体两部分，其中消息头占用固定的4个字节，消息体长度由消息头中的长度字段决定，报文结构如下：<br />
<img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_struct.png" /><br />
3.1 消息头<br />
3.1.1 报文长度<br />
用于标记当前请求消息的实际数据长度值，以字节为单位，占用3个字节，最大值为 0xFFFFFF，即接近 16 MB 大小（比16MB少1个字节）。<br />
3.1.2 序号<br />
在一次完整的请求/响应交互过程中，用于保证消息顺序的正确，每次客户端发起请求时，序号值都会从0开始计算。<br />
3.2 消息体<br />
消息体用于存放请求的内容及响应的数据，长度由消息头中的长度值决定。</p><br />
<br />
<p>4 报文类型<br />
4.1 登陆认证交互报文<br />
4.1.1 握手初始化报文（服务器 -&gt; 客户端）<br />
<img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_handshake.png" /><br />
服务协议版本号：该值由 PROTOCOL_VERSION 宏定义决定（参考MySQL源代码/include/mysql_version.h头文件定义）</p><br />
<br />
<p>服务版本信息：该值为字符串，由 MYSQL_SERVER_VERSION 宏定义决定（参考MySQL源代码/include/mysql_version.h头文件定义）</p><br />
<br />
<p>服务器线程ID：服务器为当前连接所创建的线程ID。</p><br />
<br />
<p>挑战随机数：MySQL数据库用户认证采用的是挑战/应答的方式，服务器生成该挑战数并发送给客户端，由客户端进行处理并返回相应结果，然后服务器检查是否与预期的结果相同，从而完成用户认证的过程。</p><br />
<br />
<p>服务器权能标志：用于与客户端协商通讯方式，各标志位含义如下（参考MySQL源代码/include/mysql_com.h中的宏定义）：</p><br />
<br />
<p>标志位名称	标志位	说明<br />
CLIENT_LONG_PASSWORD	0x0001	new more secure passwords<br />
CLIENT_FOUND_ROWS	0x0002	Found instead of affected rows<br />
CLIENT_LONG_FLAG	0x0004	Get all column flags<br />
CLIENT_CONNECT_WITH_DB	0x0008	One can specify db on connect<br />
CLIENT_NO_SCHEMA	0x0010	Do not allow database.table.column<br />
CLIENT_COMPRESS	0x0020	Can use compression protocol<br />
CLIENT_ODBC	0x0040	Odbc client<br />
CLIENT_LOCAL_FILES	0x0080	Can use LOAD DATA LOCAL<br />
CLIENT_IGNORE_SPACE	0x0100	Ignore spaces before ‘(‘<br />
CLIENT_PROTOCOL_41	0x0200	New 4.1 protocol<br />
CLIENT_INTERACTIVE	0x0400	This is an interactive client<br />
CLIENT_SSL	0x0800	Switch to SSL after handshake<br />
CLIENT_IGNORE_SIGPIPE	0x1000	IGNORE sigpipes<br />
CLIENT_TRANSACTIONS	0x2000	Client knows about transactions<br />
CLIENT_RESERVED	0x4000	Old flag for 4.1 protocol<br />
CLIENT_SECURE_CONNECTION	0x8000	New 4.1 authentication<br />
CLIENT_MULTI_STATEMENTS	0x0001 0000	Enable/disable multi-stmt support<br />
CLIENT_MULTI_RESULTS	0x0002 0000	Enable/disable multi-results<br />
字符编码：标识服务器所使用的字符集。</p><br />
<br />
<p>服务器状态：状态值定义如下（参考MySQL源代码/include/mysql_com.h中的宏定义）：</p><br />
<br />
<p>状态名称	状态值<br />
SERVER_STATUS_IN_TRANS	0x0001<br />
SERVER_STATUS_AUTOCOMMIT	0x0002<br />
SERVER_STATUS_CURSOR_EXISTS	0x0040<br />
SERVER_STATUS_LAST_ROW_SENT	0x0080<br />
SERVER_STATUS_DB_DROPPED	0x0100<br />
SERVER_STATUS_NO_BACKSLASH_ESCAPES	0x0200<br />
SERVER_STATUS_METADATA_CHANGED	0x0400<br />
4.1.2 登陆认证报文（客户端 -&gt; 服务器）<br />
MySQL 4.0 及之前的版本</p><br />
<br />
<p><img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_auth_40.png" /></p><br />
<br />
<p>MySQL 4.1 及之后的版本<br />
<img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_auth_41.png" /></p><br />
<br />
<p>客户端权能标志：用于与客户端协商通讯方式，标志位含义与握手初始化报文中的相同。客户端收到服务器发来的初始化报文后，会对服务器发送的权能标志进行修改，保留自身所支持的功能，然后将权能标返回给服务器，从而保证服务器与客户端通讯的兼容性。</p><br />
<br />
<p>最大消息长度：客户端发送请求报文时所支持的最大消息长度值。</p><br />
<br />
<p>字符编码：标识通讯过程中使用的字符编码，与服务器在认证初始化报文中发送的相同。</p><br />
<br />
<p>用户名：客户端登陆用户的用户名称。</p><br />
<br />
<p>挑战认证数据：客户端用户密码使用服务器发送的挑战随机数进行加密后，生成挑战认证数据，然后返回给服务器，用于对用户身份的认证。</p><br />
<br />
<p>数据库名称：当客户端的权能标志位 CLIENT_CONNECT_WITH_DB 被置位时，该字段必须出现。</p><br />
<br />
<p>4.2 客户端命令请求报文（客户端 -&gt; 服务器）<br />
<img src="https://xiazemin.github.io/MyBlog/img/mysql_protocol_command.png" /></p><br />
<br />
<p>命令：用于标识当前请求消息的类型，例如切换数据库（0x02）、查询命令（0x03）等。命令值的取值范围及说明如下表（参考MySQL源代码/include/mysql_com.h头文件中的定义）：</p><br />
<br />
<p>类型值	命令	功能	关联函数<br />
0x00	COM_SLEEP	（内部线程状态）	（无）<br />
0x01	COM_QUIT	关闭连接	mysql_close<br />
0x02	COM_INIT_DB	切换数据库	mysql_select_db<br />
0x03	COM_QUERY	SQL查询请求	mysql_real_query<br />
0x04	COM_FIELD_LIST	获取数据表字段信息	mysql_list_fields<br />
0x05	COM_CREATE_DB	创建数据库	mysql_create_db<br />
0x06	COM_DROP_DB	删除数据库	mysql_drop_db<br />
0x07	COM_REFRESH	清除缓存	mysql_refresh<br />
0x08	COM_SHUTDOWN	停止服务器	mysql_shutdown<br />
0x09	COM_STATISTICS	获取服务器统计信息	mysql_stat<br />
0x0A	COM_PROCESS_INFO	获取当前连接的列表	mysql_list_processes<br />
0x0B	COM_CONNECT	（内部线程状态）	（无）<br />
0x0C	COM_PROCESS_KILL	中断某个连接	mysql_kill<br />
0x0D	COM_DEBUG	保存服务器调试信息	mysql_dump_debug_info<br />
0x0E	COM_PING	测试连通性	mysql_ping<br />
0x0F	COM_TIME	（内部线程状态）	（无）<br />
0x10	COM_DELAYED_INSERT	（内部线程状态）	（无）<br />
0x11	COM_CHANGE_USER	重新登陆（不断连接）	mysql_change_user<br />
0x12	COM_BINLOG_DUMP	获取二进制日志信息	（无）<br />
0x13	COM_TABLE_DUMP	获取数据表结构信息	（无）<br />
0x14	COM_CONNECT_OUT	（内部线程状态）	（无）<br />
0x15	COM_REGISTER_SLAVE	从服务器向主服务器进行注册	（无）<br />
0x16	COM_STMT_PREPARE	预处理SQL语句	mysql_stmt_prepare<br />
0x17	COM_STMT_EXECUTE	执行预处理语句	mysql_stmt_execute<br />
0x18	COM_STMT_SEND_LONG_DATA	发送BLOB类型的数据	mysql_stmt_send_long_data<br />
0x19	COM_STMT_CLOSE	销毁预处理语句	mysql_stmt_close<br />
0x1A	COM_STMT_RESET	清除预处理语句参数缓存	mysql_stmt_reset<br />
0x1B	COM_SET_OPTION	设置语句选项	mysql_set_server_option<br />
0x1C	COM_STMT_FETCH	获取预处理语句的执行结果	mysql_stmt_fetch<br />
参数：内容是用户在MySQL客户端输入的命令（不包括每行命令结尾的”;”分号）。另外这个字段的字符串不是以NULL字符结尾，而是通过消息头中的长度值计算而来。</p><br />
<br />
<p>例如：当我们在MySQL客户端中执行use hutaow;命令时（切换到hutaow数据库），发送的请求报文数据会是下面的样子：</p><br />
<br />
<p>0x02 0x68 0x75 0x74 0x61 0x6f 0x77<br />
其中，0x02为请求类型值COM_INIT_DB，后面的0x68 0x75 0x74 0x61 0x6f 0x77为ASCII字符hutaow。</p><br />
<br />
<p>4.2.1 COM_QUIT 消息报文<br />
功能：关闭当前连接（客户端退出），无参数。</p><br />
<br />
<p>4.2.2 COM_INIT_DB 消息报文<br />
功能：切换数据库，对应的SQL语句为USE <database>。</database></p><br />
<br />
<p>字节	说明<br />
n	数据库名称（字符串到达消息尾部时结束，无结束符）<br />
4.2.3 COM_QUERY 消息报文<br />
功能：最常见的请求消息类型，当用户执行SQL语句时发送该消息。</p><br />
<br />
<p>字节	说明<br />
n	SQL语句（字符串到达消息尾部时结束，无结束符）<br />
4.2.4 COM_FIELD_LIST 消息报文<br />
功能：查询某表的字段（列）信息，等同于SQL语句SHOW [FULL] FIELDS FROM …。</p><br />
<br />
<p>字节	说明<br />
n	表格名称（Null-Terminated String）<br />
n	字段（列）名称或通配符（可选）<br />
4.2.5 COM_CREATE_DB 消息报文<br />
功能：创建数据库，该消息已过时，而被SQL语句CREATE DATABASE代替。</p><br />
<br />
<p>字节	说明<br />
n	数据库名称（字符串到达消息尾部时结束，无结束符）<br />
4.2.6 COM_DROP_DB 消息报文<br />
功能：删除数据库，该消息已过时，而被SQL语句DROP DATABASE代替。</p><br />
<br />
<p>字节	说明<br />
n	数据库名称（字符串到达消息尾部时结束，无结束符）<br />
4.2.7 COM_REFRESH 消息报文<br />
功能：清除缓存，等同于SQL语句FLUSH，或是执行mysqladmin flush-foo命令时发送该消息。</p><br />
<br />
<p>字节	说明<br />
1	清除缓存选项（位图方式存储，各标志位含义如下）<br />
 	0x01: REFRESH_GRANT<br />
 	0x02: REFRESH_LOG<br />
 	0x04: REFRESH_TABLES<br />
 	0x08: REFRESH_HOSTS<br />
 	0x10: REFRESH_STATUS<br />
 	0x20: REFRESH_THREADS<br />
 	0x40: REFRESH_SLAVE<br />
 	0x80: REFRESH_MASTER<br />
4.2.8 COM_SHUTDOWN 消息报文<br />
功能：停止MySQL服务。执行mysqladmin shutdown命令时发送该消息。</p><br />
<br />
<p>字节	说明<br />
1	停止服务选项<br />
 	0x00: SHUTDOWN_DEFAULT<br />
 	0x01: SHUTDOWN_WAIT_CONNECTIONS<br />
 	0x02: SHUTDOWN_WAIT_TRANSACTIONS<br />
 	0x08: SHUTDOWN_WAIT_UPDATES<br />
 	0x10: SHUTDOWN_WAIT_ALL_BUFFERS<br />
 	0x11: SHUTDOWN_WAIT_CRITICAL_BUFFERS<br />
 	0xFE: KILL_QUERY<br />
 	0xFF: KILL_CONNECTION<br />
4.2.9 COM_STATISTICS 消息报文<br />
功能：查看MySQL服务的统计信息（例如运行时间、每秒查询次数等）。执行mysqladmin status命令时发送该消息，无参数。</p><br />
<br />
<p>4.2.10 COM_PROCESS_INFO 消息报文<br />
功能：获取当前活动的线程（连接）列表。等同于SQL语句SHOW PROCESSLIST，或是执行mysqladmin processlist命令时发送该消息，无参数。</p><br />
<br />
<p>4.2.11 COM_PROCESS_KILL 消息报文<br />
功能：要求服务器中断某个连接。等同于SQL语句KILL <id>。</id></p><br />
<br />
<p>字节	说明<br />
4	连接ID号（小字节序）<br />
4.2.12 COM_DEBUG 消息报文<br />
功能：要求服务器将调试信息保存下来，保存的信息多少依赖于编译选项设置（debug=no|yes|full）。执行mysqladmin debug命令时发送该消息，无参数。</p><br />
<br />
<p>4.2.13 COM_PING 消息报文<br />
功能：该消息用来测试连通性，同时会将服务器的无效连接（超时）计数器清零。执行mysqladmin ping命令时发送该消息，无参数。</p><br />
<br />
<p>4.2.14 COM_CHANGE_USER 消息报文<br />
功能：在不断连接的情况下重新登陆，该操作会销毁MySQL服务器端的会话上下文（包括临时表、会话变量等）。有些连接池用这种方法实现清除会话上下文。</p><br />
<br />
<p>字节	说明<br />
n	用户名（字符串以NULL结尾）<br />
n	密码（挑战数）<br />
 	MySQL 3.23 版本：Null-Terminated String（长度9字节）<br />
 	MySQL 4.1 版本：Length Coded String（长度1+21字节）<br />
n	数据库名称（Null-Terminated String）<br />
2	字符编码<br />
4.2.15 COM_BINLOG_DUMP 消息报文<br />
功能：该消息是备份连接时由从服务器向主服务器发送的最后一个请求，主服务器收到后，会响应一系列的报文，每个报文都包含一个二进制日志事件。如果主服务器出现故障时，会发送一个EOF报文。</p><br />
<br />
<p>字节	说明<br />
4	二进制日志数据的起始位置（小字节序）<br />
4	二进制日志数据标志位（目前未使用，永远为0x00）<br />
4	从服务器的服务器ID值（小字节序）<br />
n	二进制日志的文件名称（可选，默认值为主服务器上第一个有效的文件名）<br />
4.2.16 COM_TABLE_DUMP 消息报文<br />
功能：将数据表从主服务器复制到从服务器中，执行SQL语句LOAD TABLE … FROM MASTER时发送该消息。目前该消息已过时，不再使用。</p><br />
<br />
<p>字节	说明<br />
n	数据库名称（Length Coded String）<br />
n	数据表名称（Length Coded String）<br />
4.2.17 COM_REGISTER_SLAVE 消息报文<br />
功能：在从服务器report_host变量设置的情况下，当备份连接时向主服务器发送的注册消息。</p><br />
<br />
<p>字节	说明<br />
4	从服务器ID值（小字节序）<br />
n	主服务器IP地址（Length Coded String）<br />
n	主服务器用户名（Length Coded String）<br />
n	主服务器密码（Length Coded String）<br />
2	主服务器端口号<br />
4	安全备份级别（由MySQL服务器rpl_recovery_rank变量设置，暂时未使用）<br />
4	主服务器ID值（值恒为0x00）<br />
4.2.18 COM_PREPARE 消息报文<br />
功能：预处理SQL语句，使用带有”?”占位符的SQL语句时发送该消息。</p><br />
<br />
<p>字节	说明<br />
n	带有”?”占位符的SQL语句（字符串到达消息尾部时结束，无结束符）<br />
4.2.19 COM_EXECUTE 消息报文<br />
功能：执行预处理语句。</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值<br />
1	标志位<br />
 	0x00: CURSOR_TYPE_NO_CURSOR<br />
 	0x01: CURSOR_TYPE_READ_ONLY<br />
 	0x02: CURSOR_TYPE_FOR_UPDATE<br />
 	0x04: CURSOR_TYPE_SCROLLABLE<br />
4	保留（值恒为0x01）<br />
如果参数数量大于0	 <br />
n	空位图（Null-Bitmap，长度 = (参数数量 + 7) / 8 字节）<br />
1	参数分隔标志<br />
如果参数分隔标志值为1	 <br />
n	每个参数的类型值（长度 = 参数数量 * 2 字节）<br />
n	每个参数的值<br />
4.2.20 COM_LONG_DATA 消息报文<br />
该消息报文有两种形式，一种用于发送二进制数据，另一种用于发送文本数据。</p><br />
<br />
<p>功能：用于发送二进制（BLOB）类型的数据（调用mysql_stmt_send_long_data函数）。</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值（小字节序）<br />
2	参数序号（小字节序）<br />
n	数据负载（数据到达消息尾部时结束，无结束符）<br />
功能：用于发送超长字符串类型的数据（调用mysql_send_long_data函数）</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值（小字节序）<br />
2	参数序号（小字节序）<br />
2	数据类型（未使用）<br />
n	数据负载（数据到达消息尾部时结束，无结束符）<br />
4.2.21 COM_CLOSE_STMT 消息报文<br />
功能：销毁预处理语句。</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值（小字节序）<br />
4.2.22 COM_RESET_STMT 消息报文<br />
功能：将预处理语句的参数缓存清空。多数情况和COM_LONG_DATA一起使用。</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值（小字节序）<br />
4.2.23 COM_SET_OPTION 消息报文<br />
功能：设置语句选项，选项值为/include/mysql_com.h头文件中定义的enum_mysql_set_option枚举类型：</p><br />
<br />
<p>MYSQL_OPTION_MULTI_STATEMENTS_ON<br />
MYSQL_OPTION_MULTI_STATEMENTS_OFF<br />
字节	说明<br />
2	选项值（小字节序）<br />
4.2.24 COM_FETCH_STMT 消息报文<br />
功能：获取预处理语句的执行结果（一次可以获取多行数据）。</p><br />
<br />
<p>字节	说明<br />
4	预处理语句的ID值（小字节序）<br />
4	数据的行数（小字节序）<br />
4.3 服务器响应报文（服务器 -&gt; 客户端）<br />
当客户端发起认证请求或命令请求后，服务器会返回相应的执行结果给客户端。客户端在收到响应报文后，需要首先检查第1个字节的值，来区分响应报文的类型。</p><br />
<br />
<p>响应报文类型	第1个字节取值范围<br />
OK 响应报文	0x00<br />
Error 响应报文	0xFF<br />
Result Set 报文	0x01 - 0xFA<br />
Field 报文	0x01 - 0xFA<br />
Row Data 报文	0x01 - 0xFA<br />
EOF 报文	0xFE<br />
注：响应报文的第1个字节在不同类型中含义不同，比如在OK报文中，该字节并没有实际意义，值恒为0x00；而在Result Set报文中，该字节又是长度编码的二进制数据结构（Length Coded Binary）中的第1字节。</p><br />
<br />
<p>4.3.1 OK 响应报文<br />
客户端的命令执行正确时，服务器会返回OK响应报文。</p><br />
<br />
<p>MySQL 4.0 及之前的版本</p><br />
<br />
<p>字节	说明<br />
1	OK报文，值恒为0x00<br />
1-9	受影响行数（Length Coded Binary）<br />
1-9	索引ID值（Length Coded Binary）<br />
2	服务器状态<br />
n	服务器消息（字符串到达消息尾部时结束，无结束符）<br />
MySQL 4.1 及之后的版本</p><br />
<br />
<p>字节	说明<br />
1	OK报文，值恒为0x00<br />
1-9	受影响行数（Length Coded Binary）<br />
1-9	索引ID值（Length Coded Binary）<br />
2	服务器状态<br />
2	告警计数<br />
n	服务器消息（字符串到达消息尾部时结束，无结束符，可选）<br />
受影响行数：当执行INSERT/UPDATE/DELETE语句时所影响的数据行数。</p><br />
<br />
<p>索引ID值：该值为AUTO_INCREMENT索引字段生成，如果没有索引字段，则为0x00。注意：当INSERT插入语句为多行数据时，该索引ID值为第一个插入的数据行索引值，而非最后一个。</p><br />
<br />
<p>服务器状态：客户端可以通过该值检查命令是否在事务处理中。</p><br />
<br />
<p>告警计数：告警发生的次数。</p><br />
<br />
<p>服务器消息：服务器返回给客户端的消息，一般为简单的描述性字符串，可选字段。</p><br />
<br />
<p>4.3.2 Error 响应报文<br />
MySQL 4.0 及之前的版本</p><br />
<br />
<p>字节	说明<br />
1	Error报文，值恒为0xFF<br />
2	错误编号（小字节序）<br />
n	服务器消息<br />
MySQL 4.1 及之后的版本</p><br />
<br />
<p>字节	说明<br />
1	Error报文，值恒为0xFF<br />
2	错误编号（小字节序）<br />
1	服务器状态标志，恒为’#’字符<br />
5	服务器状态（5个字符）<br />
n	服务器消息<br />
错误编号：错误编号值定义在源代码/include/mysqld_error.h头文件中。</p><br />
<br />
<p>服务器状态：服务器将错误编号通过mysql_errno_to_sqlstate函数转换为状态值，状态值由5字节的ASCII字符组成，定义在源代码/include/sql_state.h头文件中。</p><br />
<br />
<p>服务器消息：错误消息字符串到达消息尾时结束，长度可以由消息头中的长度值计算得出。消息长度为0-512字节。</p><br />
<br />
<p>4.3.3 Result Set 消息<br />
当客户端发送查询请求后，在没有错误的情况下，服务器会返回结果集（Result Set）给客户端。</p><br />
<br />
<p>Result Set 消息分为五部分，结构如下：</p><br />
<br />
<p>结构	说明<br />
[Result Set Header]	列数量<br />
[Field]	列信息（多个）<br />
[EOF]	列结束<br />
[Row Data]	行数据（多个）<br />
[EOF]	数据结束<br />
4.3.4 Result Set Header 结构<br />
字节	说明<br />
1-9	Field结构计数（Length Coded Binary）<br />
1-9	额外信息（Length Coded Binary）<br />
Field结构计数：用于标识Field结构的数量，取值范围0x00-0xFA。</p><br />
<br />
<p>额外信息：可选字段，一般情况下不应该出现。只有像SHOW COLUMNS这种语句的执行结果才会用到额外信息（标识表格的列数量）。</p><br />
<br />
<p>4.3.5 Field 结构<br />
Field为数据表的列信息，在Result Set中，Field会连续出现多次，次数由Result Set Header结构中的IField结构计数值决定。</p><br />
<br />
<p>MySQL 4.0 及之前的版本</p><br />
<br />
<p>字节	说明<br />
n	数据表名称（Length Coded String）<br />
n	列（字段）名称（Length Coded String）<br />
4	列（字段）长度（Length Coded String）<br />
2	列（字段）类型（Length Coded String）<br />
2	列（字段）标志（Length Coded String）<br />
1	整型值精度<br />
n	默认值（Length Coded String）<br />
MySQL 4.1 及之后的版本</p><br />
<br />
<p>字节	说明<br />
n	目录名称（Length Coded String）<br />
n	数据库名称（Length Coded String）<br />
n	数据表名称（Length Coded String）<br />
n	数据表原始名称（Length Coded String）<br />
n	列（字段）名称（Length Coded String）<br />
4	列（字段）原始名称（Length Coded String）<br />
1	填充值<br />
2	字符编码<br />
4	列（字段）长度<br />
1	列（字段）类型<br />
2	列（字段）标志<br />
1	整型值精度<br />
2	填充值（0x00）<br />
n	默认值（Length Coded String）<br />
目录名称：在4.1及之后的版本中，该字段值为”def”。</p><br />
<br />
<p>数据库名称：数据库名称标识。</p><br />
<br />
<p>数据表名称：数据表的别名（AS之后的名称）。</p><br />
<br />
<p>数据表原始名称：数据表的原始名称（AS之前的名称）。</p><br />
<br />
<p>列（字段）名称：列（字段）的别名（AS之后的名称）。</p><br />
<br />
<p>列（字段）原始名称：列（字段）的原始名称（AS之前的名称）。</p><br />
<br />
<p>字符编码：列（字段）的字符编码值。</p><br />
<br />
<p>列（字段）长度：列（字段）的长度值，真实长度可能小于该值，例如VARCHAR(2)类型的字段实际只能存储1个字符。</p><br />
<br />
<p>列（字段）类型：列（字段）的类型值，取值范围如下（参考源代码/include/mysql_com.h头文件中的enum_field_type枚举类型定义）：</p><br />
<br />
<p>类型值	名称<br />
0x00	FIELD_TYPE_DECIMAL<br />
0x01	FIELD_TYPE_TINY<br />
0x02	FIELD_TYPE_SHORT<br />
0x03	FIELD_TYPE_LONG<br />
0x04	FIELD_TYPE_FLOAT<br />
0x05	FIELD_TYPE_DOUBLE<br />
0x06	FIELD_TYPE_NULL<br />
0x07	FIELD_TYPE_TIMESTAMP<br />
0x08	FIELD_TYPE_LONGLONG<br />
0x09	FIELD_TYPE_INT24<br />
0x0A	FIELD_TYPE_DATE<br />
0x0B	FIELD_TYPE_TIME<br />
0x0C	FIELD_TYPE_DATETIME<br />
0x0D	FIELD_TYPE_YEAR<br />
0x0E	FIELD_TYPE_NEWDATE<br />
0x0F	FIELD_TYPE_VARCHAR (new in MySQL 5.0)<br />
0x10	FIELD_TYPE_BIT (new in MySQL 5.0)<br />
0xF6	FIELD_TYPE_NEWDECIMAL (new in MYSQL 5.0)<br />
0xF7	FIELD_TYPE_ENUM<br />
0xF8	FIELD_TYPE_SET<br />
0xF9	FIELD_TYPE_TINY_BLOB<br />
0xFA	FIELD_TYPE_MEDIUM_BLOB<br />
0xFB	FIELD_TYPE_LONG_BLOB<br />
0xFC	FIELD_TYPE_BLOB<br />
0xFD	FIELD_TYPE_VAR_STRING<br />
0xFE	FIELD_TYPE_STRING<br />
0xFF	FIELD_TYPE_GEOMETRY<br />
列（字段）标志：各标志位定义如下（参考源代码/include/mysql_com.h头文件中的宏定义）：</p><br />
<br />
<p>标志位	名称<br />
0x0001	NOT_NULL_FLAG<br />
0x0002	PRI_KEY_FLAG<br />
0x0004	UNIQUE_KEY_FLAG<br />
0x0008	MULTIPLE_KEY_FLAG<br />
0x0010	BLOB_FLAG<br />
0x0020	UNSIGNED_FLAG<br />
0x0040	ZEROFILL_FLAG<br />
0x0080	BINARY_FLAG<br />
0x0100	ENUM_FLAG<br />
0x0200	AUTO_INCREMENT_FLAG<br />
0x0400	TIMESTAMP_FLAG<br />
0x0800	SET_FLAG<br />
数值精度：该字段对DECIMAL和NUMERIC类型的数值字段有效，用于标识数值的精度（小数点位置）。</p><br />
<br />
<p>默认值：该字段用在数据表定义中，普通的查询结果中不会出现。</p><br />
<br />
<p>附：Field结构的相关处理函数：</p><br />
<br />
<p>客户端：/client/client.c源文件中的unpack_fields函数<br />
服务器：/sql/sql_base.cc源文件中的send_fields函数<br />
4.3.6 EOF 结构<br />
EOF结构用于标识Field和Row Data的结束，在预处理语句中，EOF也被用来标识参数的结束。</p><br />
<br />
<p>MySQL 4.0 及之前的版本</p><br />
<br />
<p>字节	说明<br />
1	EOF值（0xFE）<br />
MySQL 4.1 及之后的版本</p><br />
<br />
<p>字节	说明<br />
1	EOF值（0xFE）<br />
2	告警计数<br />
2	状态标志位<br />
告警计数：服务器告警数量，在所有数据都发送给客户端后该值才有效。</p><br />
<br />
<p>状态标志位：包含类似SERVER_MORE_RESULTS_EXISTS这样的标志位。</p><br />
<br />
<p>注：由于EOF值与其它Result Set结构共用1字节，所以在收到报文后需要对EOF包的真实性进行校验，校验条件为：</p><br />
<br />
<p>第1字节值为0xFE<br />
包长度小于9字节<br />
附：EOF结构的相关处理函数：</p><br />
<br />
<p>服务器：protocol.cc源文件中的send_eof函数<br />
4.3.7 Row Data 结构<br />
在Result Set消息中，会包含多个Row Data结构，每个Row Data结构又包含多个字段值，这些字段值组成一行数据。</p><br />
<br />
<p>字节	说明<br />
n	字段值（Length Coded String）<br />
…	（一行数据中包含多个字段值）<br />
字段值：行数据中的字段值，字符串形式。</p><br />
<br />
<p>附：Row Data结构的相关处理函数：</p><br />
<br />
<p>客户端：/client/client.c源文件中的read_rows函数<br />
4.3.8 Row Data 结构（二进制数据）<br />
该结构用于传输二进制的字段值，既可以是服务器返回的结果，也可以是由客户端发送的（当执行预处理语句时，客户端使用Result Set消息来发送参数及数据）。</p><br />
<br />
<p>字节	说明<br />
1	结构头（0x00）<br />
(列数量 + 7 + 2) / 8	空位图<br />
n	字段值<br />
…	（一行数据中包含多个字段值）<br />
空位图：前2个比特位被保留，值分别为0和1，以保证不会和OK、Error包的首字节冲突。在MySQL 5.0及之后的版本中，这2个比特位的值都为0。</p><br />
<br />
<p>字段值：行数据中的字段值，二进制形式。</p><br />
<br />
<p>4.3.9 PREPARE_OK 响应报文（Prepared Statement）<br />
用于响应客户端发起的预处理语句报文，组成结构如下：</p><br />
<br />
<p>结构	说明<br />
[PREPARE_OK]	PREPARE_OK结构<br />
如果参数数量大于0	 <br />
[Field]	与Result Set消息结构相同<br />
[EOF]	 <br />
如果列数大于0	 <br />
[Field]	与Result Set消息结构相同<br />
[EOF]	 <br />
其中 PREPARD_OK 的结构如下：</p><br />
<br />
<p>字节	说明<br />
1	OK报文，值为0x00<br />
4	预处理语句ID值<br />
2	列数量<br />
2	参数数量<br />
1	填充值（0x00）<br />
2	告警计数<br />
4.3.10 Parameter 响应报文（Prepared Statement）<br />
预处理语句的值与参数正确对应后，服务器会返回 Parameter 报文。</p><br />
<br />
<p>字节	说明<br />
2	类型<br />
2	标志<br />
1	数值精度<br />
4	字段长度<br />
类型：与 Field 结构中的字段类型相同。</p><br />
<br />
<p>标志：与 Field 结构中的字段标志相同。</p><br />
<br />
<p>数值精度：与 Field 结构中的数值精度相同。</p><br />
<br />
<p>字段长度：与 Field 结构中的字段长度相同。</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category storage
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>