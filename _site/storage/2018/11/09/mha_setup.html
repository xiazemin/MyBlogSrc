<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">MHA的搭建</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2018-11-09T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Nov 9, 2018</time></p>
					</div>
					 <!-- more --><br />
<p>Master High Availability又称MHA，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的软件。MySQL故障切换过程中，MHA能够做到在30秒之内自动完成数据库的故障切换操作，并在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p><br />
<br />
<p>主机及实例IP<br />
Manager : 192.168.18.250<br />
Master : 172.16.18.2:3306<br />
Slave1 : 172.16.18.3:3306<br />
Slave2 : 172.16.18.4:3306<br />
VIP : 172.16.18.5<br />
Slave的配置参数<br />
log_bin=/home/birdteam/log/mysql-bin<br />
read_only=1<br />
relay_log_purge=0<br />
#一主一从不用此项，两从及以上建议打开此参数，防止切换为成主库的从库自动删除中继日志后，无法给其他从库应用这部分日志<br />
配置主从同步<br />
mysql&gt;grant replication slave on <em>.</em> to ‘repl_17zuoye’@’%’ identified by ‘office.repl.17zuoye’;<br />
mysql&gt;flush privileges;<br />
#三个节点都要配置，用于当某个slave升为主后其他的从进行同步<br />
mysql&gt;change master to master_host=’172.16.18.2’,master_user=’dtstack’,master_port=3306,master_password=’abc123’,master_log_file=’logbin.000014’,master_log_pos=70980879;<br />
mysql&gt;start slave;<br />
配置SSH免秘钥，四台服务器之间可互通</p><br />
<h1 id="ssh-keygen--t-rsa">ssh-keygen -t rsa</h1><br />
<h1 id="ssh-copy-id--i-sshid_rsapub-root17216182">ssh-copy-id -i .ssh/id_rsa.pub root@172.16.18.2</h1><br />
<p>四个节点安装EPEL源以及相关yum包</p><br />
<h1 id="rpm--ivh-httpdownloadfedoraprojectorgpubepel6x86_64epel-release-6-8noarchrpm">rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</h1><br />
<h1 id="yum--y-install-perl-dbd-mysql-perl-config-tiny-perl-log-dispatch-perl-parallel-forkmanager-perltime-hires">yum -y install perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perlTime-HiRes</h1><br />
<p>下载安装mha包</p><br />
<h1 id="wget-httpscodegooglecompmysql-master-hawikidownloadstm2">wget https://code.google.com/p/mysql-master-ha/wiki/Downloads?tm=2</h1><br />
<p>manager节点：</p><br />
<h1 id="rpm-ivh-mha4mysql-manager-056-0el6noarchrpm">rpm –ivh mha4mysql-manager-0.56-0.el6.noarch.rpm</h1><br />
<h1 id="rpm-ivh-mha4mysql-node-056-0el6noarchrpm">rpm –ivh mha4mysql-node-0.56-0.el6.noarch.rpm</h1><br />
<p>node 节点：</p><br />
<h1 id="rpm-ivh-mha4mysql-node-056-0el6noarchrpm-1">rpm –ivh mha4mysql-node-0.56-0.el6.noarch.rpm</h1><br />
<p>建立与授权mha用户<br />
mysql&gt;GRANT ALL PRIVILEGES ON <em>.</em> TO ‘mha’@’%’ IDENTIFIED BY ‘mhamha’;<br />
mysql&gt;flush privileges;<br />
manager节点建立相关目录和配置文件</p><br />
<h1 id="tree-mha">tree /mha</h1><br />
<p>/mha<br />
├── app1<br />
│   ├── app1.conf<br />
│   └── manager.log<br />
└── conf<br />
├── master_ip_failover_3306<br />
├── master_ip_online_change<br />
└── send_report<br />
2 directories, 5 files<br />
相关配置文件内容</p><br />
<h1 id="cat-app1conf">cat app1.conf</h1><br />
<p>[server default]<br />
manager_workdir = /mha/app1<br />
manager_log = /mha/app1/manager.log<br />
remote_workdir = /mha/app1<br />
master_ip_failover_script=/mha/conf/master_ip_failover_3306<br />
#master failover时执行<br />
report_script=/mha/conf/send_report<br />
#master failover时执行，发送邮件使用<br />
master_ip_online_change_script=/mha/conf/master_ip_online_change<br />
#master_switchover时执行（手动切换）<br />
user=mha<br />
password=mhamha<br />
ping_interval=1<br />
ping_type=CONNECT<br />
repl_password=office.repl.17zuoye<br />
repl_user=repl_17zuoye<br />
ssh_port=22<br />
ssh_user=root<br />
[server1]<br />
hostname = 10.200.3.2<br />
port=3306<br />
master_binlog_dir = /database1/data_5.6.17_3306/binlog<br />
candidate_master = 1<br />
#这个服务器有较高的优先级提升为新的master（还要具备：开启binlog使复制没有延迟）<br />
[server2]<br />
hostname = 10.200.3.3<br />
port=3306<br />
master_binlog_dir = /database1/data_5.6.17_3306/binlog<br />
candidate_master =1<br />
ignore_fail=1<br />
[server3]<br />
hostname = 10.200.3.4<br />
port=3306<br />
master_binlog_dir = /database1/data_5.6.17_3306/binlog<br />
candidate_master =1<br />
ignore_fail=1<br />
#如slave存在故障，在主库出现问题时默认情况下mha不会进行故障切换，该参数即设定MHA会在所有的机器有问题的时间也会进行故障切换<br />
no_master=1<br />
#不将这台主机转换为master<br />
主库启动一个虚IP</p><br />
<h1 id="sbinifconfig-em10-102003523-up">/sbin/ifconfig em1:0 10.200.3.5/23 up</h1><br />
<p>失败切换脚本</p><br />
<h1 id="cat-master_ip_failover_3306">cat master_ip_failover_3306</h1><br />
<p>#!/usr/bin/env perl<br />
use strict;<br />
use warnings FATAL =&gt; ‘all’;<br />
use Getopt::Long;<br />
my (<br />
    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,<br />
    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port<br />
);<br />
my $vip = ‘10.200.3.5/23’;  # Virtual IP<br />
my $key = “0”;<br />
my $ssh_start_vip = “/sbin/ifconfig em1:$key $vip”;<br />
my $start_new_master_vip = “/sbin/ifconfig em1:$key $vip”;<br />
my $ssh_stop_vip = “/sbin/ifconfig em1:$key down”;<br />
my $arp = “/usr/sbin/arping -A -q -c 2 -I em1:$key 10.200.3.5”;<br />
#虚IP配置，在哪个网卡上，key编号的对应<br />
GetOptions(<br />
    ‘command=s’          =&gt; $command,<br />
    ‘ssh_user=s’         =&gt; $ssh_user,<br />
    ‘orig_master_host=s’ =&gt; $orig_master_host,<br />
    ‘orig_master_ip=s’   =&gt; $orig_master_ip,<br />
    ‘orig_master_port=i’ =&gt; $orig_master_port,<br />
    ‘new_master_host=s’  =&gt; $new_master_host,<br />
    ‘new_master_ip=s’    =&gt; $new_master_ip,<br />
    ‘new_master_port=i’  =&gt; $new_master_port,<br />
);<br />
exit &amp;main();<br />
sub main {<br />
    print “\n\nIN SCRIPT TEST====$ssh_stop_vip==$start_new_master_vip===\n\n”;<br />
    if ( $command eq “stop” || $command eq “stopssh” ) {<br />
        # $orig_master_host, $orig_master_ip, $orig_master_port are passed.<br />
        # If you manage master ip address at global catalog database,<br />
        # invalidate orig_master_ip here.<br />
        my $exit_code = 1;<br />
        eval {<br />
            print “Disabling the VIP on old master: $orig_master_host \n”;<br />
            &amp;stop_vip();<br />
            $exit_code = 0;<br />
        };<br />
        if ($@) {<br />
            warn “Got Error: $@\n”;<br />
            exit $exit_code;<br />
        }<br />
        exit $exit_code;<br />
    }<br />
    elsif ( $command eq “start” ) {<br />
        # all arguments are passed.<br />
        # If you manage master ip address at global catalog database,<br />
        # activate new_master_ip here.<br />
        # You can also grant write access (create user, set read_only=0, etc) here.<br />
        my $exit_code = 10;<br />
        eval {<br />
            print “Enabling the VIP - $vip on the new master - $new_master_host \n”;<br />
            &amp;start_vip();<br />
            $exit_code = 0;<br />
        };<br />
        if ($@) {<br />
            warn $@;<br />
            exit $exit_code;<br />
        }<br />
        exit $exit_code;<br />
    }<br />
    elsif ( $command eq “status” ) {<br />
       # print “Checking the Status of the script.. OK \n”;<br />
       # <code class="language-plaintext highlighter-rouge">ssh $ssh_user\@tm01.okooo.cn \" $ssh_start_vip \"</code>;<br />
        exit 0;<br />
    }<br />
    else {<br />
        &amp;usage();<br />
        exit 1;<br />
    }<br />
}</p><br />
<h1 id="a-simple-system-call-that-enable-the-vip-on-the-new-master">A simple system call that enable the VIP on the new master</h1><br />
<p>sub start_vip() {<br />
    <code class="language-plaintext highlighter-rouge">ssh root\@$new_master_host \" $ssh_start_vip \"</code>;<br />
    <code class="language-plaintext highlighter-rouge">ssh root\@$new_master_host \" $arp \"</code>;<br />
}</p><br />
<h1 id="a-simple-system-call-that-disable-the-vip-on-the-old_master">A simple system call that disable the VIP on the old_master</h1><br />
<p>sub stop_vip() {<br />
    return 0 unless ($ssh_user);<br />
    <code class="language-plaintext highlighter-rouge">ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"</code>;<br />
}<br />
sub usage {<br />
    print<br />
    “Usage: master_ip_failover –command=start|stop|stopssh|status –orig_master_host=host –orig_master_ip=ip –orig_master_port=port –new_master_host=host –new_master_ip=ip –new_master_port=port\n”;<br />
}<br />
手动在线切换脚本</p><br />
<h1 id="cat-master_ip_online_change">cat master_ip_online_change</h1><br />
<p>#!/usr/bin/env perl<br />
use strict;<br />
use warnings FATAL =&gt;’all’;<br />
use Getopt::Long;<br />
my $vip = ‘10.200.3.5/23’;  # Virtual IP<br />
my $key = “0”;<br />
my $ssh_start_vip = “/sbin/ifconfig em1:$key $vip”;<br />
my $ssh_stop_vip = “/sbin/ifconfig em1:$key down”;<br />
my $exit_code = 0;<br />
my (<br />
  $command,              $orig_master_is_new_slave, $orig_master_host,<br />
  $orig_master_ip,       $orig_master_port,         $orig_master_user,<br />
  $orig_master_password, $orig_master_ssh_user,     $new_master_host,<br />
  $new_master_ip,        $new_master_port,          $new_master_user,<br />
  $new_master_password,  $new_master_ssh_user,<br />
);<br />
GetOptions(<br />
  ‘command=s’                =&gt; $command,<br />
  ‘orig_master_is_new_slave’ =&gt; $orig_master_is_new_slave,<br />
  ‘orig_master_host=s’       =&gt; $orig_master_host,<br />
  ‘orig_master_ip=s’         =&gt; $orig_master_ip,<br />
  ‘orig_master_port=i’       =&gt; $orig_master_port,<br />
  ‘orig_master_user=s’       =&gt; $orig_master_user,<br />
  ‘orig_master_password=s’   =&gt; $orig_master_password,<br />
  ‘orig_master_ssh_user=s’   =&gt; $orig_master_ssh_user,<br />
  ‘new_master_host=s’        =&gt; $new_master_host,<br />
  ‘new_master_ip=s’          =&gt; $new_master_ip,<br />
  ‘new_master_port=i’        =&gt; $new_master_port,<br />
  ‘new_master_user=s’        =&gt; $new_master_user,<br />
  ‘new_master_password=s’    =&gt; $new_master_password,<br />
  ‘new_master_ssh_user=s’    =&gt; $new_master_ssh_user,<br />
);<br />
exit &amp;main();<br />
sub main {<br />
#print “\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n”;<br />
if ( $command eq “stop” || $command eq “stopssh” ) {<br />
        # $orig_master_host, $orig_master_ip, $orig_master_port are passed.<br />
        # If you manage master ip address at global catalog database,<br />
        # invalidate orig_master_ip here.<br />
        my $exit_code = 1;<br />
        eval {<br />
            print “\n\n\n<strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong><em>\n”;<br />
            print “Disabling the VIP - $vip on old master: $orig_master_host\n”;<br />
            print “</em></strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>\n\n\n\n”;<br />
&amp;stop_vip();<br />
            $exit_code = 0;<br />
        };<br />
        if ($@) {<br />
            warn “Got Error: $@\n”;<br />
            exit $exit_code;<br />
        }<br />
        exit $exit_code;<br />
}<br />
elsif ( $command eq “start” ) {<br />
        # all arguments are passed.<br />
        # If you manage master ip address at global catalog database,<br />
        # activate new_master_ip here.<br />
        # You can also grant write access (create user, set read_only=0, etc) here.<br />
my $exit_code = 10;<br />
        eval {<br />
            print “\n\n\n<strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong><em>\n”;<br />
            print “Enabling the VIP - $vip on new master: $new_master_host \n”;<br />
            print “</em></strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong><strong>**</strong>\n\n\n\n”;<br />
&amp;start_vip();<br />
            $exit_code = 0;<br />
        };<br />
        if ($@) {<br />
            warn $@;<br />
            exit $exit_code;<br />
        }<br />
        exit $exit_code;<br />
}<br />
elsif ( $command eq “status” ) {<br />
        print “Checking the Status of the script.. OK \n”;<br />
        <code class="language-plaintext highlighter-rouge">ssh $orig_master_ssh_user\@$orig_master_host \" $ssh_start_vip \"</code>; <br />
        exit 0; <br />
}<br /><br />
else { <br />
&amp;usage(); <br />
        exit 1; <br />
} <br />
}</p><br />
<br />
<h1 id="a-simple-system-call-that-enable-the-vip-on-the-new-master-1">A simple system call that enable the VIP on the new master</h1><br />
<p>sub start_vip() { <br />
<code class="language-plaintext highlighter-rouge">ssh $new_master_ssh_user\@$new_master_host \" $ssh_start_vip \"</code>; <br />
}</p><br />
<h1 id="a-simple-system-call-that-disable-the-vip-on-the-old_master-1">A simple system call that disable the VIP on the old_master</h1><br />
<p>sub stop_vip() { <br />
<code class="language-plaintext highlighter-rouge">ssh $orig_master_ssh_user\@$orig_master_host \" $ssh_stop_vip \"</code>; <br />
}</p><br />
<br />
<p>sub usage { <br />
print <br />
“Usage: master_ip_failover –command=start|stop|stopssh|status –orig_master_host=host –orig_master_ip=ip –orig_master_port=po<br />
rt –new_master_host=host –new_master_ip=ip –new_master_port=port\n”;<br />
}<br />
failover后发送邮件脚本</p><br />
<h1 id="cat-send_report">cat send_report</h1><br />
<p>#!/bin/bash<br />
source /root/.bash_profile<br />
orig_master_host=<code class="language-plaintext highlighter-rouge">echo "$1" | awk -F = '{print $2}'</code><br />
new_master_host=<code class="language-plaintext highlighter-rouge">echo "$2" | awk -F = '{print $2}'</code><br />
new_slave_hosts=<code class="language-plaintext highlighter-rouge">echo "$3" | awk -F = '{print $2}'</code><br />
subject=<code class="language-plaintext highlighter-rouge">echo "$4" | awk -F = '{print $2}'</code><br />
body=<code class="language-plaintext highlighter-rouge">echo "$5" | awk -F = '{print $2}'</code><br />
#判断日志结尾是否有successfully，有则表示切换成功，成功与否都发邮件<br />
tac /mha/app1/manager.log | sed -n 2p | grep ‘successfully’ &gt; /dev/null<br />
if [ $? -eq 0 ]<br />
  then<br />
  echo -e “MHA $subject 主从切换成功\n master:$orig_master_host –&gt; $new_master_host \n $body \n 当前从库:$new_slave_hosts” | mailx -s “MySQL实例宕掉,MHA $subject 切换成功” noreply@birdteam.net<br />
else<br />
  echo -e “MHA $subject 主从切换失败\n master:$orig_master_host –&gt; $new_master_host \n $body” | mailx -s “MySQL实例宕掉,MHA $subject 切换失败” noreply@birdteam.net<br />
fi<br />
修改脚本属主属组，并且增加执行权限</p><br />
<h1 id="chown-mysqlmysql-">chown mysql.mysql ./*</h1><br />
<h1 id="chmod-x-">chmod +x ./*</h1><br />
<p>检查SSH的配置</p><br />
<h1 id="masterha_check_ssh-confmhaapp1app1conf">masterha_check_ssh –conf=/mha/app1/app1.conf</h1><br />
<p>Tue Jan  5 17:16:41 2016 - [info] All SSH connectiontests passed successfully.<br />
检查MHA的配置</p><br />
<h1 id="masterha_check_repl-confmhaapp1app1conf">masterha_check_repl –conf=/mha/app1/app1.conf</h1><br />
<p>MySQL Replication Health is OK.<br />
启动MHA的服务</p><br />
<h1 id="masterha_manager-confmhaapp1app1conf">masterha_manager –conf=/mha/app1/app1.conf</h1><br />
<p>发生failover主从切换后，MHAmanager服务会自动停掉，且在manager_workdir目录下面生成文件app1.failover.complete，若想要启动MHA，必须先确保没有此文件</p><br />
<h1 id="ll">ll</h1><br />
<p>total 80<br />
-rw-r–r– 1 mysql mysql   556 Aug 29 11:23 app1.conf<br />
-rw-r–r– 1 root  root      0 Aug 29 15:33 app1.failover.complete<br />
-rw-r–r– 1 root  root  69838 Aug 29 15:33 manager.log<br />
-rw-r–r– 1 root  root    143 Aug 29 15:33 saved_master_binlog_from_192.168.100.111_3306_20160829153340.binlog<br />
在线手动切换主从，如果MHA在运行，需要先停止MHA，然后再检查MHA当前设置</p><br />
<h1 id="masterha_check_repl-confmhaapp1app1conf-1">masterha_check_repl –conf=/mha/app1/app1.conf</h1><br />
<p>手动切换<br />
如果不指定new_master_host，则会根据配置文件app1.cnf选出new_master_host，但new_master_port默认是3306<br />
masterha_master_switch –master_state=alive –conf=/mha/app1/app1.conf  –orig_master_is_new_slave -running_updates_limit=3600 –interactive=0<br />
以下为切换时指定了new_master_host和new_master_port<br />
masterha_master_switch –master_state=alive –conf=/mha/app1/app1.conf  –orig_master_is_new_slave -running_updates_limit=3600 –interactive=0 –new_master_host=10.200.3.2 –new_master_port=3306<br />
参数–running_updates_limit如果现在master执行写操作的执行时间大于这个参数，或任何一台slave的Seconds_Behind_Master大于这个参数，那么master switch将自动放弃，默认参数为1s；<br />
参数–interactive=0非交互切换，建议加上，可以大大加快切换速度，加上后库不忙时大概3秒内切换完成。<br />
注意<br />
如果需要将现有的从库修改为从，再启动mha的时候可能会报错；<br />
Wed Sep  7 12:18:56 2016 - [error][/usr/share/perl5/vendor_perl/MHA/ServerManager.pm, ln671] Master 192.168.100.111:3306 from which slave 10.200.3.2(10.200.3.2:3306) replicates is not defined in the configuration file!<br />
切换脚本可在MHA的官网查看。</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category storage
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>