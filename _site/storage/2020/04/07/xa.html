<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">xa mysql xid</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-04-07T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Apr 7, 2020</time></p>
					</div>
					 <p>MySQL 从5.0.3开始支持XA分布式事务，且只有InnoDB存储引擎支持。MySQL Connector/J 从5.0.0版本之后开始直接提供对XA的支持<br />
 在DTP模型中，mysql属于资源管理器(RM)。而一个完整的分布式事务中，一般会存在多个RM，由事务管理器TM来统一进行协调。因此，这里所说的mysql对XA分布式事务的支持，一般指的是单台mysql实例如何执行自己的事务分支。<br />
 MySQL XA 事务SQL语法<br />
https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html</p><br />
<br />
<p>XA {START|BEGIN} xid [JOIN|RESUME]   //开启XA事务，如果使用的是XA START而不是XA BEGIN，那么不支持[JOIN|RESUME]，xid是一个唯一值，表示事务分支标识符<br />
XA END xid [SUSPEND [FOR MIGRATE]]   //结束一个XA事务，不支持[SUSPEND [FOR MIGRATE]]<br />
XA PREPARE xid 准备提交<br />
XA COMMIT xid [ONE PHASE] //提交，如果使用了ONE PHASE，则表示使用一阶段提交。两阶段提交协议中，如果只有一个RM参与，那么可以优化为一阶段提交<br />
XA ROLLBACK xid  //回滚<br />
XA RECOVER [CONVERT XID]  //列出所有处于PREPARE阶段的XA事务<br />
下面是一个简单的msyql XA事务案例，演示了mysql作为全局事务中的一个事务分支，将一行记录插入到一个表中<br />
mysql&gt; XA START ‘xatest’;  //其中’xatest’就是xid的值<br />
Query OK, 0 rows affected (0.00 sec)</p><br />
<br />
<p>mysql&gt; insert into user(name) values(“tianshozuhi”);<br />
Query OK, 1 row affected (0.00 sec)</p><br />
<br />
<p>mysql&gt; XA END ‘xatest’;<br />
Query OK, 0 rows affected (0.00 sec)</p><br />
<br />
<p>mysql&gt; XA PREPARE ‘xatest’;<br />
Query OK, 0 rows affected (0.01 sec)</p><br />
<br />
<p>mysql&gt; XA COMMIT ‘xatest’;<br />
Query OK, 0 rows affected (0.01 sec)</p><br />
<br />
<p>Mysql XA事务状态<br />
https://dev.mysql.com/doc/refman/5.7/en/xa-states.html</p><br />
<br />
<p>XA事务的状态，按照如下步骤进行展开</p><br />
<br />
<ol><br />
  <li><br />
    <p>使用XA START来启动一个XA事务，并把它置于ACTIVE状态。</p><br />
  </li><br />
  <li><br />
    <p>对于一个ACTIVE状态的 XA事务，我们可以执行构成事务的SQL语句，然后发布一个XA END语句。XA END把事务放入IDLE状态。</p><br />
  </li><br />
  <li><br />
    <p>对于一个IDLE 状态XA事务，可以执行一个XA PREPARE语句或一个XA COMMIT…ONE PHASE语句：</p><br />
  </li><br />
</ol><br />
<br />
<p>XA PREPARE把事务放入PREPARED状态。在此点上的XA RECOVER语句将在其输出中包括事务的xid值，因为XA RECOVER会列出处于PREPARED状态的所有XA事务。</p><br />
<br />
<p>XA COMMIT…ONE PHASE用于预备和提交事务。xid值将不会被XA RECOVER列出，因为事务终止。</p><br />
<br />
<ol><br />
  <li>对于一个PREPARED状态的 XA事务，您可以发布一个XA COMMIT语句来提交和终止事务，或者发布XA ROLLBACK来回滚并终止事务。</li><br />
</ol><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>针对一个给定的客户端连接而言，XA事务和非XA事务(即本地事务)是互斥的。例如，已经执行了”XA START”命令来开启一个XA事务，则本地事务不会被启动，直到XA事务已经被提交或被 回滚为止。相反的，如果已经使用START TRANSACTION启动一个本地事务，则XA语句不能被使用，直到该事务被提交或被 回滚为止。<br />
<br />
最后，如果一个XA事务处于ACTIVE状态，是不能直接进行提交的，如果这样做，mysql会抛出异常：<br />
</code></pre></div></div><br />
<br />
<p>ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed<br />
when global transaction is in the ACTIVE state<br />
3 关于XID的说明<br />
mysql中使用xid来作为一个事务分支的标识符。事实上xid作为事务分支标识符是在XA规范中定义的，在« Distributed Transaction Processing: The XA Specification» 4.2 节中，规定了一个xid的结构，通过C语言进行描述，如下：</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/∗<br />
∗ Transaction branch identification: XID and NULLXID:<br />
∗/<br />
#define XIDDATASIZE 128  /∗ size in bytes ∗/<br />
#define MAXGTRIDSIZE 64  /∗ maximum size in bytes of gtrid ∗/<br />
#define MAXBQUALSIZE 64  /∗ maximum size in bytes of bqual ∗/<br />
struct xid_t {<br />
    long formatID;     /* format identifier */<br />
    long gtrid_length; /* value 1-64 */<br />
    long bqual_length; /* value 1-64 */<br />
    char data[XIDDATASIZE];<br />
    };<br />
/∗<br />
∗ A value of -1 in formatID means that the XID is null.<br />
∗/<br />
typedef struct xid_t XID;<br />
/∗<br />
∗ Declarations of routines by which RMs call TMs:<br />
∗/<br />
extern int ax_reg(int, XID ∗, long);<br />
extern int ax_unreg(int, long); XA规范定义了一个xid有4个部分组成：<br />
</code></pre></div></div><br />
<br />
<p>gtrid：</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>全局事务标识符(global transaction identifier)，最大不能超过64字节<br />
</code></pre></div></div><br />
<br />
<p>bqual：</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>分支限定符(branch qualifier)，最大不能超过64字节<br />
</code></pre></div></div><br />
<br />
<p>data：</p><br />
<br />
<p>xid的值，其是 gtrid和bqual拼接后的内容。因为gtrid和bqual最大都是64个字节，因此data的最大长度为128。不过，在xid的结构体中，并没有gtrid和bqual，只有gtrid_length、bqual_length。由于二者的内容都存储在data中，因此我们可以根据data反推出gtrid和bqual。举例来说，假设gtrid为”g12345”(5个字节)，bqual为”b456”(4个字节)。那么在构造xid结构体时，gtrid_length=5，bqual_length=4，data=”g12345b456”，那么在反推的时候：</p><br />
<br />
<p>从data[0]到data[gtrid_length-1]之间的部分就是gtrid的值；从data[gtrid_length]到data[gtrid_length+bqual_length-1]部分就是bqual的值。</p><br />
<br />
<p>formatId：</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>而formatId的作用就是记录gtrid、bqual的格式，类似于memcached中flags字段的作用。XA规范中通过一个结构体约定了xid的组成部分，但是并没有规定data中存储的gtrid、bqual内容到底应该是什么格式。你可以选择使用数字，也可以选择使用字符串，到底选择什么由开发者自行决定，只要最终能保证data中的内容是全局唯一的即可。XA规范建议使用OSI CCR风格来组织xid的内容，此时formatId应该设置为0.<br />
</code></pre></div></div><br />
<br />
<p>在mysql官方文档中，关于xid的组成也有类似的说明：</p><br />
<br />
<p>xid: gtrid [, bqual [, formatID ]]<br />
其中，bqual、formatID是可选的。解释如下：</p><br />
<br />
<p>gtrid : 是一个全局事务标识符(global transaction identifier)，</p><br />
<br />
<p>bqual:是一个分支限定符(branch qualifier)，如果没有提供bqual，那么默认值为空字符串’‘。</p><br />
<br />
<p>formatID：是一个数字，用于标记gtrid和bqual值的格式，这是一个无符号整数(unsigned integer)，也就是说，最小为0。如果没有提供formatID，那么其默认值为1。</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>特别需要注意的是，xid作为一个事务分支的标识符，理论上只要有分支限定符(bqual)就可以了，为什么要包含全局事务标识符(gtrid)？这主要是为了管理方便，通过包含进xid，我们可以很容易的判断出这个事务分支属于哪一个全局事务。 <br />
<br />
例如，前面提到 XA RECOVER命令的作用是列出所有处于PREPARE阶段的XA事务，以下是一个案例：<br />
<br />
mysql&gt;  XA RECOVER;<br />
+----------+--------------+--------------+--------------+<br />
| formatID | gtrid_length | bqual_length | data         |<br />
+----------+--------------+--------------+--------------+<br />
|        1 |            6 |            6 | g12345b67890 |<br />
+----------+--------------+--------------+--------------+ 这里列出的是一个分支事务xid的组成信息，根据前面的介绍，我们可以推断出：<br />
<br />
gtrid是data[0]到data[gtrid_length-1]部分的内容，即data[0]到data[6-1=5]部分的内容，结果为g12345；<br />
<br />
而bqual是data[gtrid_length]到data[gtrid_length+bqual_length-1]部分的内容，即data[6]到data[6+6-1=11]部分的内容，结果b67890。<br />
</code></pre></div></div><br />
<br />
<p>因此，根据这个信息，我们就可以判断出这个xid表示的是：全局事务(g12345)中的事务分支(b67890)。</p><br />
<br />
<p>4、通过jdbc操作mysql xa事务<br />
    MySQL Connector/J 从5.0.0版本之后开始直接提供对XA的支持，也就是提供了java版本XA接口的实现。意味着我们可以直接通过java代码来执行mysql xa事务。</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>需要注意的是，业务开发人员在编写代码时，不应该直接操作这些XA事务操作的接口。因为在DTP模型中，RM上的事务分支的开启、结束、准备、提交、回滚等操作，都应该是由事务管理器TM来统一管理。<br />
<br />
由于目前我们还没有接触到TM，那么我们不妨做一回"人肉事务管理器"，用你智慧的大脑，来控制多个mysql实例上xa事务分支的执行，提交/回滚。通过直接操作这些接口，你将对xa事务有更深刻的认识。<br />
</code></pre></div></div><br />
<br />
<p>import com.mysql.jdbc.jdbc2.optional.MysqlXAConnection;<br />
import com.mysql.jdbc.jdbc2.optional.MysqlXid;<br />
import javax.sql.XAConnection;<br />
import javax.transaction.xa.XAException;<br />
import javax.transaction.xa.XAResource;<br />
import javax.transaction.xa.Xid;<br />
import java.sql.Connection;<br />
import java.sql.DriverManager;<br />
import java.sql.PreparedStatement;<br />
import java.sql.SQLException;<br />
public class MysqlXAConnectionTest {<br />
   public static void main(String[] args) throws SQLException {<br />
      //true表示打印XA语句,，用于调试<br />
      boolean logXaCommands = true;<br />
      // 获得资源管理器操作接口实例 RM1<br />
      Connection conn1 = DriverManager.getConnection(“jdbc:mysql://localhost:3306/test”, “root”, “shxx12151022”);<br />
      XAConnection xaConn1 = new MysqlXAConnection((com.mysql.jdbc.Connection) conn1, logXaCommands);<br />
      XAResource rm1 = xaConn1.getXAResource();<br />
      // 获得资源管理器操作接口实例 RM2<br />
      Connection conn2 = DriverManager.getConnection(“jdbc:mysql://localhost:3306/test”, “root”,<br />
            “shxx12151022”);<br />
      XAConnection xaConn2 = new MysqlXAConnection((com.mysql.jdbc.Connection) conn2, logXaCommands);<br />
      XAResource rm2 = xaConn2.getXAResource();<br />
      // AP请求TM执行一个分布式事务，TM生成全局事务id<br />
      byte[] gtrid = “g12345”.getBytes();<br />
      int formatId = 1;<br />
      try {<br />
         // ==============分别执行RM1和RM2上的事务分支====================<br />
         // TM生成rm1上的事务分支id<br />
         byte[] bqual1 = “b00001”.getBytes();<br />
         Xid xid1 = new MysqlXid(gtrid, bqual1, formatId);<br />
         // 执行rm1上的事务分支<br />
         rm1.start(xid1, XAResource.TMNOFLAGS);//One of TMNOFLAGS, TMJOIN, or TMRESUME.<br />
         PreparedStatement ps1 = conn1.prepareStatement(“INSERT into user(name) VALUES (‘tianshouzhi’)”);<br />
         ps1.execute();<br />
         rm1.end(xid1, XAResource.TMSUCCESS);<br />
         // TM生成rm2上的事务分支id<br />
         byte[] bqual2 = “b00002”.getBytes();<br />
         Xid xid2 = new MysqlXid(gtrid, bqual2, formatId);<br />
         // 执行rm2上的事务分支<br />
         rm2.start(xid2, XAResource.TMNOFLAGS);<br />
         PreparedStatement ps2 = conn2.prepareStatement(“INSERT into user(name) VALUES (‘wangxiaoxiao’)”);<br />
         ps2.execute();<br />
         rm2.end(xid2, XAResource.TMSUCCESS);<br />
         // ===================两阶段提交================================<br />
         // phase1：询问所有的RM 准备提交事务分支<br />
         int rm1_prepare = rm1.prepare(xid1);<br />
         int rm2_prepare = rm2.prepare(xid2);<br />
         // phase2：提交所有事务分支<br />
         boolean onePhase = false; //TM判断有2个事务分支，所以不能优化为一阶段提交<br />
         if (rm1_prepare == XAResource.XA_OK<br />
               &amp;&amp; rm2_prepare == XAResource.XA_OK<br />
               ) {//所有事务分支都prepare成功，提交所有事务分支<br />
            rm1.commit(xid1, onePhase);<br />
            rm2.commit(xid2, onePhase);<br />
         } else {//如果有事务分支没有成功，则回滚<br />
            rm1.rollback(xid1);<br />
            rm1.rollback(xid2);<br />
         }<br />
      } catch (XAException e) {<br />
         // 如果出现异常，也要进行回滚<br />
         e.printStackTrace();<br />
      }<br />
   }<br />
}<br />
    在这个案例中，演示了2个RM的情况下分布式事务的工作流程。因为我们充当了”人肉事务管理器”TM，因此很多本应该由TM来处理的工作处理细节也直接体现在上述代码中，如:生成全局事务id和分支事务id、在RM上开启事务分支、两阶段提交等。虽然我们自己作为”人肉事务管理器”是很不可靠的，但是上述代码可以让我们了解一个TM内部的主要工作流程是怎样的。</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>在实际开发中，代码绝不会像上表面那样复杂，因为我们通常都会使用第三方或者容器提供的TM功能，因此在操作分布式事务时，代码可以得到极大的简化。<br />
<br />
最后，由于我们设置了logXaCommands=true，程序在运行的时候回打印出执行的XA命令。如下所示：<br />
<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA START 0x673132333435,0x623030303031,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA END 0x673132333435,0x623030303031,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA START 0x673132333435,0x623030303032,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA END 0x673132333435,0x623030303032,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA PREPARE 0x673132333435,0x623030303031,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA PREPARE 0x673132333435,0x623030303032,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA COMMIT 0x673132333435,0x623030303031,0x1<br />
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA COMMIT 0x673132333435,0x623030303032,0x1 5 MySQL Connector/J XA事务支持源码简单分析<br />
最后，我们对上述源码进行一下简单的分析。在前面直接使用mysql命令操作的时候，我们通过"XA START xid”等XA命令来执行XA事务。而在上述java代码中，我们是获取了一个普通的链接Connection之后，封装成了MysqlXAConnection。如下：<br />
</code></pre></div></div><br />
<br />
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection</p><br />
<br />
<p>public class MysqlXAConnection extends MysqlPooledConnection implements XAConnection, XAResource {<br />
  private com.mysql.jdbc.Connection underlyingConnection;<br />
  private Log log;<br />
  protected boolean logXaCommands;</p><br />
<br />
<p>//构造方法<br />
  public MysqlXAConnection(com.mysql.jdbc.Connection connection, boolean logXaCommands) throws SQLException {<br />
    super(connection);<br />
    this.underlyingConnection = connection;<br />
    this.log = connection.getLog();<br />
    this.logXaCommands = logXaCommands;<br />
  }<br />
…<br />
}<br />
可以看到，MysqlXAConnection本身就实现了XAResource接口，因此当调用getXAResource()方法时，返回的就是其自己</p><br />
<br />
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#getXAResource</p><br />
<br />
<p>public XAResource getXAResource() throws SQLException {<br />
    return this;<br />
}<br />
之后，我们调用XAResource的start方法来开启XA事务。start方法源码如下所示：</p><br />
<br />
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#start</p><br />
<br />
<p>public void start(Xid xid, int flags) throws XAException {<br />
    //1、封装XA命令<br />
    StringBuilder commandBuf = new StringBuilder(MAX_COMMAND_LENGTH);<br />
    commandBuf.append(“XA START “);<br />
    appendXid(commandBuf, xid);</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//2、添加flag标记<br />
switch (flags) {<br />
    case TMJOIN:<br />
        commandBuf.append(" JOIN");<br />
        break;<br />
    case TMRESUME:<br />
        commandBuf.append(" RESUME");<br />
        break;<br />
    case TMNOFLAGS:<br />
        // no-op<br />
        break;<br />
    default:<br />
        throw new XAException(XAException.XAER_INVAL);<br />
}<br />
<br />
//执行命令<br />
dispatchCommand(commandBuf.toString());<br />
this.underlyingConnection.setInGlobalTx(true); }  可以看到，当我们调用MysqlXAConnection的start方法时，实际上就是执行了一个”XA START xid [JOIN|RESUME]”命令而已，和我们直接在命令行中的操作是一样一样的，只不过通过封装简化了我们的操作。<br />
对于MysqlXAConnection的end、prepare、commit、rollback等方法，也都是是类似的，不再赘述。<br />
<br />
最后提示， MySQL Connector/J 中提供的XA操作接口，如上面提到的XAConnection、XAResource、Xid等，实际上都遵循了JTA规范。<br />
<br />
mysql8.0文档：https://dev.mysql.com/doc/refman/8.0/en/xa-statements.html。13.3.8.1 XA Transaction SQL Syntax章节讲述了Mysql对于XA事务的语法。<br />
</code></pre></div></div><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
      <td>XA {START</td><br />
      <td>BEGIN} xid [JOIN</td><br />
      <td>RESUME] XA END xid [SUSPEND [FOR MIGRATE]] XA PREPARE xid XA COMMIT xid [ONE PHASE] XA ROLLBACK xid XA RECOVER [CONVERT XID]</td><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>首先，根据DTP（Distributed Transaction Processing: Reference Model）参考模型中，Mysql是作为资源管理器这一组件。所以Mysql也仅仅是作为XA规范中的一个组件而已，Mysql对于XA的支持，其实是提供了RMs与TM之间的接口交互支持。TM（Transaction manager）是一个事务的协调者，协调众多的事务参与者。明白了这一点以后，我们再来看Mysql中使用XA事务的语法，mysql官方文档中也有详细的描述，我们在下面列举一二，另外关于mysql支持XA是从什么版本开始，以及java驱动包什么版本支持XA，请见以下文档原文</p><br />
<br />
<p>Support for XA transactions is available for the</p><br />
<br />
<p>InnoDB</p><br />
<br />
<p>storage engine. The MySQL XA implementation is based on the X/Open CAE document Distributed Transaction Processing: The XA Specification. This document is published by The Open Group and available athttp://www.opengroup.org/public/pubs/catalog/c193.htm. Limitations of the current XA implementation are described in Section C.6, “Restrictions on XA Transactions”.</p><br />
<br />
<p>innodb存储引擎支持XA事务</p><br />
<br />
<p>Among the MySQL Connectors, MySQL Connector/J 5.0.0 and higher supports XA directly, by means of a class interface that handles the XA SQL statement interface for you.</p><br />
<br />
<p>5.0.0版本mysql连接驱动开始支持XA</p><br />
<br />
<p>XA事务命令都是XA开头的，xa start 和 xa begin 都可以开启一个xa事务，但是xa start 不支持join 、resume，这两个是什么，我暂时不了解，暂且不管，xa start 还需要跟一个xid，这个是事务的唯一标识，关于xid的构成，下面再详述，这里仅需要知道xid是一个事务的id标识即可。</p><br />
<br />
<p>xa end xid，即完成sql 操作后，让xa事务进入IDLE状态的命令，同样要指明xid，操作的是哪个XA事务，注意这里xa end并不是要结束xa事务，只是进入到IDLE状态，后续还有两阶段提交过程，prepare和commit；</p><br />
<br />
<p>xa prepare xid ，标识两阶段提交的第一个提交阶段，通知资源管理器RM做提交前的准备，防止数据丢失，之前讨论两阶段提交时已经讲了，这个阶段，mysql就会记录下这个事务的各种日志，防止丢失，即使宕机重启也能恢复。prepare结束就具备了这种恢复的能力，RM prepare回复TM，prepare成功后，RM会等TM的commit通知，而TM要等所有RM的成功消息，所有RM回复成功，TM就下发commit给所有RM；如果部分RM回复不成功，那么TM就下发rollback给所有RM回滚事务。</p><br />
<br />
<p>xa rollback xid就是回滚事务的指令，xa commit xid就是提交事务的指令，xa commit xid ONE PHASE 是明确知道RM只有一个的情况下，采用一阶段提交的方式，这种情况下就不需要prepare阶段了，xa end后即可xa commit xid ONE PHASE了。</p><br />
<br />
<p>xa recover ，是用来查看哪些xid已经完成prepare的，异常宕机情况下，xa recover也能列出宕机前哪些xa事务完成prepare，等待commit的。</p><br />
<br />
<p>xid: gtrid [, bqual [, formatID ]]</p><br />
<br />
<p>以上是xid的构成，gtrid全局事务id标识，然后bqual 事务分支标识，formatID是格式标识，具体什么用处暂时不明白。bqual和formatID都是可选，如果不给值时默认值分别为”和1.</p><br />
<br />
<p>gtrid 和 bqual 都必须是字符串类型，长度是64byte，formatID是无符号整型。</p><br />
<br />
<p>我们来看个实际例子</p><br />
<br />
<p>我建立了一个全局事务aaa，两个分支事务bbb和ccc。然后两个分支事务都进入了prepare，从分支事务ccc截图中xa recover可以看出。但是ccc回滚，bbb提交。最开始理解这块的时候，我认为既然一个全局事务，那么怎么能够一个回滚一个提交呢？后来仔细一想，这个过程应该是交给TM来统一的，mysql支持XA并不体现在控制全局事务下所有子事务一致提交，而是提供和TM交互的接口，由TM最终来控制，通知所有子事务提交，或都回滚，而不会通知部分提交、部分回滚。</p><br />
<br />
<p>https://mp.weixin.qq.com/s/KeZId8WScnS-rlc0kedEzw<br />
<!-- more --><br />
比如我们现在有两个数据库，mysql3306和mysql3307。这里我们使用docker来创建这两个实例：</p><br />
<br />
<h1 id="mysql3306创建命令">mysql3306创建命令</h1><br />
<br />
<h2 id="docker-run">docker run</h2><br />
<p>d <br />
-<br />
p <br />
3306<br />
:<br />
3306</p><br />
<br />
<p>-<br />
v <br />
/<br />
Users<br />
/<br />
yjf<br />
/<br />
Documents<br />
/<br />
workspace<br />
/<br />
mysql<br />
-<br />
docker<br />
/<br />
my3306<br />
.<br />
cnf<br />
:<br />
/etc/<br />
mysql<br />
/<br />
mysql<br />
.<br />
conf<br />
.<br />
d<br />
/<br />
mysqld<br />
.<br />
cnf <br />
-<br />
v <br />
/<br />
Users<br />
/<br />
yjf<br />
/<br />
Documents<br />
/<br />
workspace<br />
/<br />
mysql<br />
-<br />
docker<br />
/<br />
data3306<br />
:<br />
/var/<br />
lib<br />
/<br />
mysql <br />
-<br />
e MYSQL_ROOT_PASSWORD<br />
=<br />
123456</p><br />
<br />
<p>–<br />
name mysql<br />
-<br />
3307<br />
 mysql<br />
:<br />
5.7</p><br />
<br />
<h1 id="msyql3306的配置">msyql3306的配置：</h1><br />
<br />
<p>[<br />
mysqld<br />
]</p><br />
<br />
<h2 id="pid">pid</h2><br />
<p>file  <br /><br />
=</p><br />
<br />
<p>/var/<br />
run<br />
/<br />
mysqld<br />
/<br />
mysqld<br />
.<br />
pid</p><br />
<br />
<h1 id="socket">socket</h1><br />
<br />
<p>/var/<br />
run<br />
/<br />
mysqld<br />
/<br />
mysqld<br />
.<br />
sock</p><br />
<br />
<h1 id="datadir">datadir</h1><br />
<br />
<p>/var/<br />
lib<br />
/<br />
mysql</p><br />
<br />
<h2 id="server">server</h2><br />
<p>id <br />
=</p><br />
<br />
<p>1</p><br />
<br />
<h1 id="log_bin">log_bin</h1><br />
<p>mysql<br />
-<br />
bin</p><br />
<br />
<h1 id="binlog_format">binlog_format</h1><br />
<p>ROW</p><br />
<br />
<h1 id="expire_logs_days">expire_logs_days</h1><br />
<br />
<p>30</p><br />
<br />
<h1 id="mysql3307创建命令">mysql3307创建命令</h1><br />
<br />
<h2 id="docker-run-1">docker run</h2><br />
<p>d <br />
-<br />
p <br />
3307<br />
:<br />
3306</p><br />
<br />
<p>-<br />
v <br />
/<br />
Users<br />
/<br />
yjf<br />
/<br />
Documents<br />
/<br />
workspace<br />
/<br />
mysql<br />
-<br />
docker<br />
/<br />
my3307<br />
.<br />
cnf<br />
:<br />
/etc/<br />
mysql<br />
/<br />
mysql<br />
.<br />
conf<br />
.<br />
d<br />
/<br />
mysqld<br />
.<br />
cnf <br />
-<br />
v <br />
/<br />
Users<br />
/<br />
yjf<br />
/<br />
Documents<br />
/<br />
workspace<br />
/<br />
mysql<br />
-<br />
docker<br />
/<br />
data3307<br />
:<br />
/var/<br />
lib<br />
/<br />
mysql <br />
-<br />
e MYSQL_ROOT_PASSWORD<br />
=<br />
123456</p><br />
<br />
<p>–<br />
name mysql<br />
-<br />
3307<br />
 mysql<br />
:<br />
5.7</p><br />
<br />
<h1 id="msyql3307的配置">msyql3307的配置：</h1><br />
<br />
<p>[<br />
mysqld<br />
]</p><br />
<br />
<h2 id="pid-1">pid</h2><br />
<p>file  <br /><br />
=</p><br />
<br />
<p>/var/<br />
run<br />
/<br />
mysqld<br />
/<br />
mysqld<br />
.<br />
pid</p><br />
<br />
<h1 id="socket-1">socket</h1><br />
<br />
<p>/var/<br />
run<br />
/<br />
mysqld<br />
/<br />
mysqld<br />
.<br />
sock</p><br />
<br />
<h1 id="datadir-1">datadir</h1><br />
<br />
<p>/var/<br />
lib<br />
/<br />
mysql</p><br />
<br />
<h2 id="server-1">server</h2><br />
<p>id <br />
=</p><br />
<br />
<p>2</p><br />
<br />
<h1 id="log_bin-1">log_bin</h1><br />
<p>mysql<br />
-<br />
bin</p><br />
<br />
<h1 id="binlog_format-1">binlog_format</h1><br />
<p>ROW</p><br />
<br />
<h1 id="expire_logs_days-1">expire_logs_days</h1><br />
<br />
<p>30</p><br />
<br />
<p>在mysql3306中<br />
我们有一个user表</p><br />
<br />
<p>create table user <br />
(</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id  int ,<br />
<br />
name varchar ( 10 ),<br />
<br />
score  int<br />
</code></pre></div></div><br />
<br />
<p>);</p><br />
<br />
<p>insert <br />
into<br />
 user values<br />
(<br />
1<br />
,</p><br />
<br />
<p>“foo”<br />
,</p><br />
<br />
<p>10<br />
)</p><br />
<br />
<p>在mysql3307中，我们有一个wallet表。</p><br />
<br />
<p>create table wallet <br />
(</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id  int ,<br />
<br />
money  float<br />
</code></pre></div></div><br />
<br />
<p>);</p><br />
<br />
<p>insert <br />
into<br />
 wallet values<br />
(<br />
1<br />
,</p><br />
<br />
<p>10.1<br />
)</p><br />
<br />
<p>我们可以看到，id为1的用户初始分数（score）为10，而它的钱，在wallet中初始钱（money）为10.1。</p><br />
<br />
<p>现在假设我们有一个操作，需要对这个用户进行操作：每次操作增加分数2，并且增加钱数1.2。</p><br />
<br />
<p>这个操作需要很强的一致性。</p><br />
<br />
<p>思考<br />
两阶段提交<br />
这里是一个分布式事务的概念，我们可以使用2PC的方法进行保证事务</p><br />
<br />
<p>2PC的概念如图所示，引入一个资源协调者的概念，由这个资源协调者进行事务协调。</p><br />
<br />
<p>第一阶段，由这个资源协调者对每个mysql实例调用prepare命令，让所有的mysql实例准备好，如果其中由mysql实例没有准备好，协调者就让所有实例调用rollback命令进行回滚。如果所有mysql都prepare完成，那么就进入第二阶段。</p><br />
<br />
<p>第二阶段，资源协调者让每个mysql实例都调用commit方法，进行提交。</p><br />
<br />
<p>mysql里面也提供了分布式事务的语句XA。</p><br />
<br />
<p>用单个实例的事务行不行<br />
等等，这个两阶段提交和我们的事务感觉也差不多，都是进行一次开始，然后执行，最后commit，mysql为什么还要专门定义一个xa的命令呢？于是我陷入了思考…</p><br />
<br />
<p>思考不如实操，于是我用golang写了一个使用mysql的事务实现的“两阶段提交”:</p><br />
<br />
<p>package<br />
 main</p><br />
<br />
<p>import</p><br />
<br />
<p>(</p><br />
<br />
<p>“database/sql”</p><br />
<br />
<p>“fmt”</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"<br />
</code></pre></div></div><br />
<br />
<p>“github.com/pkg/errors”</p><br />
<br />
<p>)</p><br />
<br />
<p>func main<br />
()</p><br />
<br />
<p>{</p><br />
<br />
<p>var<br />
 err error</p><br />
<br />
<p>// db1的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3306)/hade1”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// db2的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3307)/hade2”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// 开始前显示</p><br />
<br />
<p>var<br />
 score <br />
int</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
</code></pre></div></div><br />
<br />
<p>var<br />
 money float64</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
<br />
<br />
<br />
tx1 ,  err  :=  db1 . Begin ()<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tx2 ,  err  :=  db2 . Begin ()<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()<br />
</code></pre></div></div><br />
<br />
<p>{</p><br />
<br />
<p>if<br />
 err <br />
:=<br />
 recover<br />
();<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )<br />
<br />
        fmt . Println ( "=== call rollback ====" )<br />
<br />
        tx1 . Rollback ()<br />
<br />
        tx2 . Rollback ()<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
    fmt . Println ( "user1 score:" ,  score )<br />
<br />
    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
    fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}()</p><br />
<br />
<p>// DML操作</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 tx1<br />
.<br />
Exec<br />
(<br />
“update user set score=score+2 where id =1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 tx2<br />
.<br />
Exec<br />
(<br />
“update wallet set money=money+1.2 where id=1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“commit before error”))</p><br />
<br />
<p>// commit</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )<br />
<br />
err  =  tx1 . Commit ()<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“commit db2 before error”))</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>err  =  tx2 . Commit ()<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
<br />
db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>我这里已经非常小心地在defer中recover错误信息，并且执行了rollback命令。</p><br />
<br />
<p>如果我在commit命令之前的任意一个地方调用了 panic(errors.New(“commit before error”)) 那么命令就会进入到了rollback这里，就会把两个实例的事务都进行回滚。</p><br />
<br />
<p>通过结果我们可以看到，分数和钱数都没有改变。这个是ok的。</p><br />
<br />
<p>但是如果我在db2的commit之前触发了panic，那么这个命令进入到了rollback中，但是db1已经commit了，db2还没有commit，这个时候会出现什么情况？</p><br />
<br />
<p>非常可惜，我们看到了这里的score增长了，但是money没有增长，这个就说明无法做到事务一致性了。</p><br />
<br />
<p>回到mysql的xa<br />
那么还要回归到2PC，mysql为2PC的实现增加了xa命令，那么使用这个命令我们能不能避免这个问题呢？</p><br />
<br />
<p>同样，我用golang写了一个使用xa命令的代码</p><br />
<br />
<p>package<br />
 main</p><br />
<br />
<p>import</p><br />
<br />
<p>(</p><br />
<br />
<p>“database/sql”</p><br />
<br />
<p>“fmt”</p><br />
<br />
<p>“strconv”</p><br />
<br />
<p>“time”</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"<br />
</code></pre></div></div><br />
<br />
<p>“github.com/pkg/errors”</p><br />
<br />
<p>)</p><br />
<br />
<p>func main<br />
()</p><br />
<br />
<p>{</p><br />
<br />
<p>var<br />
 err error</p><br />
<br />
<p>// db1的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3306)/hade1”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// db2的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3307)/hade2”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// 开始前显示</p><br />
<br />
<p>var<br />
 score <br />
int</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
</code></pre></div></div><br />
<br />
<p>var<br />
 money float64</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>// 生成xid</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),<br />
</code></pre></div></div><br />
<br />
<p>10<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"<br />
</code></pre></div></div><br />
<br />
<p>+<br />
 xid <br />
+</p><br />
<br />
<p>” ====”<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()<br />
</code></pre></div></div><br />
<br />
<p>{</p><br />
<br />
<p>if<br />
 err <br />
:=<br />
 recover<br />
();<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )<br />
<br />
        fmt . Println ( "=== call rollback ====" )<br />
<br />
        db1 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))<br />
<br />
        db2 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
    fmt . Println ( "user1 score:" ,  score )<br />
<br />
    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
    fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}()</p><br />
<br />
<p>// XA 启动</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// DML操作</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
“update user set score=score+2 where id =1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
“update wallet set money=money+1.2 where id=1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// XA end</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// prepare</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“db2 prepare error”))</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// commit</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“db2 commit error”))</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
<br />
db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>首先看成功的情况：</p><br />
<br />
<p>一切完美。</p><br />
<br />
<p>如果我们在prepare阶段抛出panic，那么结果如下:</p><br />
<br />
<p>证明在第一阶段出现异常是可以回滚的。</p><br />
<br />
<p>但是如果我们在commit阶段抛出panic:</p><br />
<br />
<p>我们发现，这里的分数增加了，但是money却没有增加。</p><br />
<br />
<p>那么这个xa和单个事务有什么区别呢？我又陷入了深深的沉思…</p><br />
<br />
<p>xa的用法不对<br />
经过在技术群（全栈神盾局）请教，讨论之后，发现这里对2pc的两个阶段理解还没到位，这里之所以分为两个阶段，是强调的是每个阶段都会持久化，就是第一个阶段完成了之后，每个mysql实例就把第一个阶段的请求实例化了，这个时候不管是mysql实例停止了还是其他问题，每次重启的时候都会重新回复这个commit。</p><br />
<br />
<p>我们把这个代码的rollback去掉，假设commit必须成功。</p><br />
<br />
<p>package<br />
 main</p><br />
<br />
<p>import</p><br />
<br />
<p>(</p><br />
<br />
<p>“database/sql”</p><br />
<br />
<p>“fmt”</p><br />
<br />
<p>“strconv”</p><br />
<br />
<p>“time”</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"<br />
</code></pre></div></div><br />
<br />
<p>“github.com/pkg/errors”</p><br />
<br />
<p>)</p><br />
<br />
<p>func main<br />
()</p><br />
<br />
<p>{</p><br />
<br />
<p>var<br />
 err error</p><br />
<br />
<p>// db1的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3306)/hade1”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// db2的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3307)/hade2”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// 开始前显示</p><br />
<br />
<p>var<br />
 score <br />
int</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
</code></pre></div></div><br />
<br />
<p>var<br />
 money float64</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>// 生成xid</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),<br />
</code></pre></div></div><br />
<br />
<p>10<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"<br />
</code></pre></div></div><br />
<br />
<p>+<br />
 xid <br />
+</p><br />
<br />
<p>” ====”<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()<br />
</code></pre></div></div><br />
<br />
<p>{</p><br />
<br />
<p>if<br />
 err <br />
:=<br />
 recover<br />
();<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )<br />
<br />
        fmt . Println ( "=== call rollback ====" )<br />
</code></pre></div></div><br />
<br />
<p>// db1.Exec(fmt.Sprintf(“XA ROLLBACK ‘%s’”, xid))</p><br />
<br />
<p>// db2.Exec(fmt.Sprintf(“XA ROLLBACK ‘%s’”, xid))</p><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
    fmt . Println ( "user1 score:" ,  score )<br />
<br />
    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
    fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}()</p><br />
<br />
<p>// XA 启动</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// DML操作</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
“update user set score=score+2 where id =1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
“update wallet set money=money+1.2 where id=1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// XA end</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// prepare</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“db2 prepare error”))</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// commit</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>panic ( errors . New ( "db2 commit error" ))<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
<br />
db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>这个时候，我们停掉程序（停掉mysql的链接），使用 xa recover可以发现，db2的xa事务还留在db2中了。</p><br />
<br />
<p>我们在控制台直接调用 xa commit’1585644880’ 还能继续把这个xa事务进行提交。</p><br />
<br />
<p>这下money就进行了提交，又恢复了一致性。</p><br />
<br />
<p>所以呢，我琢磨了一下，我们写xa的代码应该如下：</p><br />
<br />
<p>package<br />
 main</p><br />
<br />
<p>import</p><br />
<br />
<p>(</p><br />
<br />
<p>“database/sql”</p><br />
<br />
<p>“fmt”</p><br />
<br />
<p>“log”</p><br />
<br />
<p>“strconv”</p><br />
<br />
<p>“time”</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"<br />
</code></pre></div></div><br />
<br />
<p>“github.com/pkg/errors”</p><br />
<br />
<p>)</p><br />
<br />
<p>func main<br />
()</p><br />
<br />
<p>{</p><br />
<br />
<p>var<br />
 err error</p><br />
<br />
<p>// db1的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3306)/hade1”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// db2的连接</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,<br />
</code></pre></div></div><br />
<br />
<p>“root:123456@tcp(127.0.0.1:3307)/hade2”<br />
)</p><br />
<br />
<p>if<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()<br />
</code></pre></div></div><br />
<br />
<p>// 开始前显示</p><br />
<br />
<p>var<br />
 score <br />
int</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
</code></pre></div></div><br />
<br />
<p>var<br />
 money float64</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>// 生成xid</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),<br />
</code></pre></div></div><br />
<br />
<p>10<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"<br />
</code></pre></div></div><br />
<br />
<p>+<br />
 xid <br />
+</p><br />
<br />
<p>” ====”<br />
)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()<br />
</code></pre></div></div><br />
<br />
<p>{</p><br />
<br />
<p>if<br />
 err <br />
:=<br />
 recover<br />
();<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )<br />
<br />
        fmt . Println ( "=== call rollback ====" )<br />
<br />
        db1 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))<br />
<br />
        db2 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
    fmt . Println ( "user1 score:" ,  score )<br />
<br />
    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
    fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}()</p><br />
<br />
<p>// XA 启动</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA START ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// DML操作</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
“update user set score=score+2 where id =1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
“update wallet set money=money+1.2 where id=1”<br />
);<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// XA end</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA END ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// prepare</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“db2 prepare error”))</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA PREPARE ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>// commit</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )<br />
</code></pre></div></div><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db1<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<p>// TODO: 尝试重新提交COMMIT</p><br />
<br />
<p>// TODO: 如果还失败，记录xid，进入数据恢复逻辑，等待数据库恢复重新提交</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "xid:"<br />
</code></pre></div></div><br />
<br />
<p>+<br />
 xid<br />
)</p><br />
<br />
<p>}</p><br />
<br />
<p>// panic(errors.New(“db2 commit error”))</p><br />
<br />
<p>if<br />
 _<br />
,<br />
 err <br />
=<br />
 db2<br />
.<br />
Exec<br />
(<br />
fmt<br />
.<br />
Sprintf<br />
(<br />
“XA COMMIT ‘%s’”<br />
,<br />
 xid<br />
));<br />
 err <br />
!=</p><br />
<br />
<p>nil</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "xid:"<br />
</code></pre></div></div><br />
<br />
<p>+<br />
 xid<br />
)</p><br />
<br />
<p>}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )<br />
<br />
fmt . Println ( "user1 score:" ,  score )<br />
<br />
db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )<br />
<br />
fmt . Println ( "wallet1 money:" ,  money )<br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>就是第二阶段的commit，我们必须设定它一定会“成功”，如果有不成功的情况，那么就需要记录下不成功的xid，有一个数据恢复逻辑，重新commit这个xid。来保证最终一致性。</p><br />
<br />
<p>binlog<br />
其实我们使用binlog也能看出一些端倪</p><br />
<br />
<h1 id="这里的mysql-bin0003替换成为你当前的log">这里的mysql-bin.0003替换成为你当前的log</h1><br />
<br />
<p>SHOW BINLOG EVENTS <br />
in</p><br />
<br />
<p>‘mysql-bin.000003’<br />
;</p><br />
<br />
<h2 id="xa的binlog">XA的binlog</h2><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1967</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Anonymous_Gtid</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2032</p><br />
<br />
<p>|<br />
 SET <br />
@<br />
@SESSION<br />
.<br />
GTID_NEXT<br />
=</p><br />
<br />
<p>‘ANONYMOUS’</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2032</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Query</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2138</p><br />
<br />
<p>|<br />
 XA START X<br />
‘31353835363338363233’<br />
,<br />
X<br />
‘’<br />
,<br />
1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2138</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Table_map</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2190</p><br />
<br />
<p>|<br />
 table_id<br />
:</p><br />
<br />
<p>108</p><br />
<br />
<p>(<br />
hade1<br />
.<br />
user<br />
)</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2190</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Update_rows</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2252</p><br />
<br />
<p>|<br />
 table_id<br />
:</p><br />
<br />
<p>108<br />
 flags<br />
:<br />
 STMT_END_F                                                  <br /><br />
|</p><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2252</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Query</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2356</p><br />
<br />
<p>|<br />
 XA <br />
END<br />
 X<br />
‘31353835363338363233’<br />
,<br />
X<br />
‘’<br />
,<br />
1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2356</p><br />
<br />
<p>|<br />
 XA_prepare   <br /><br />
|</p><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2402</p><br />
<br />
<p>|<br />
 XA PREPARE X<br />
‘31353835363338363233’<br />
,<br />
X<br />
‘’<br />
,<br />
1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2402</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Anonymous_Gtid</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2467</p><br />
<br />
<p>|<br />
 SET <br />
@<br />
@SESSION<br />
.<br />
GTID_NEXT<br />
=</p><br />
<br />
<p>‘ANONYMOUS’</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2467</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Query</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2574</p><br />
<br />
<p>|<br />
 XA COMMIT X<br />
‘31353835363338363233’<br />
,<br />
X<br />
‘’<br />
,<br />
1</p><br />
<br />
<h2 id="非xa的事务">非xa的事务</h2><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2574</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Anonymous_Gtid</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2639</p><br />
<br />
<p>|<br />
 SET <br />
@<br />
@SESSION<br />
.<br />
GTID_NEXT<br />
=</p><br />
<br />
<p>‘ANONYMOUS’</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2639</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Query</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2712</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>BEGIN</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2712</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Table_map</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2764</p><br />
<br />
<p>|<br />
 table_id<br />
:</p><br />
<br />
<p>108</p><br />
<br />
<p>(<br />
hade1<br />
.<br />
user<br />
)</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2764</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Update_rows</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2826</p><br />
<br />
<p>|<br />
 table_id<br />
:</p><br />
<br />
<p>108<br />
 flags<br />
:<br />
 STMT_END_F                                                  <br /><br />
|</p><br />
<br />
<p>|<br />
 mysql<br />
-<br />
bin<br />
.<br />
000003</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2826</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>Xid</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>2857</p><br />
<br />
<p>|<br />
 COMMIT <br />
/* xid=67 */</p><br />
<br />
<p>我们很明显可以看到两阶段提交中是有两个GTID的，生成一个GTID就代表内部生成一个事务，所以第一个阶段prepare结束之后，第二个阶段commit的时候就持久化了第一个阶段的内容，并且生成了第二个事务。当commit失败的时候，最多就是第二个事务丢失，第一个事务实际上已经保存起来了了（只是还没commit）。</p><br />
<br />
<p>而非xa的事务，只有一个GTID，在commit之前任意一个阶段出现问题，整个事务就全部丢失，无法找回了。所以这就是mysql xa命令的机制。</p><br />
<br />
<p>总结<br />
看了一些资料，原来mysql从5.7之后才真正实现了两阶段的xa。当然这个两阶段方式在真实的工程中的使用其实很少的，xa的第一定律是避免使用xa。工程中会有很多方式来避免这种分库的事务情况。</p><br />
<br />
<p>不过，不妨碍掌握了mysql的xa，在一些特定的场合，我们也能完美解决问题</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category storage
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>