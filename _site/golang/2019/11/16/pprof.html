<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">pprof</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-11-16T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Nov 16, 2019</time></p>
					</div>
					 <p>https://github.com/google/pprof/pull/188<br />
<!-- more --><br />
Last week me and my cool coworker Josh were debugging some memory problems in a Go program using pprof.</p><br />
<br />
<p>There’s a bunch of pprof documentation on the internet but I found a few things confusing so here are some notes so I can find them easily.</p><br />
<br />
<p>First – when working with pprof it’s good to be running a recent version of Go! For example Go 1.8 adds mutex profiles so you can see mutex contention.</p><br />
<br />
<p>in this post I’ll</p><br />
<br />
<p>link to the useful pprof resource I found<br />
explain what a pprof profile is<br />
give an example of how to look at a heap profile of a Go program<br />
explain a few things about the heap profiler works (what do the stack traces mean? how are they collected?)<br />
most importantly (to me), deconstruct an example pprof protobuf file so we understand what a pprof profile actually is<br />
This post won’t really explain in detail how to to use pprof to diagnose performance issues in Go programs, but I think these fundamentals (“what even is a pprof file”) will help me do that more easily.</p><br />
<br />
<p>pprof basics<br />
pprof lets you collect CPU profiles, traces, and heap profiles for your Go programs. The normal way to use pprof seems to be:</p><br />
<br />
<p>Set up a webserver for getting Go profiles (with import _ “net/http/pprof”)<br />
Run curl localhost:$PORT/debug/pprof/$PROFILE_TYPE to save a profile<br />
Use go tool pprof to analyze said profile<br />
You can also generate pprof profiles in your code using the pprof package but I haven’t done that.</p><br />
<br />
<p>Useful pprof reading<br />
Here is every useful link I’ve found so far about pprof on the internet. Basically the material on the internet about pprof seems to be the official documentation + rakyll’s amazing blog.</p><br />
<br />
<p>Setting up a pprof webserver: https://golang.org/pkg/net/http/pprof/<br />
Generating pprof profiles in code: https://golang.org/pkg/runtime/pprof/<br />
https://github.com/google/pprof (from which I found out that pprof can read perf files!!)<br />
The developer docs: https://github.com/google/pprof/blob/master/doc/pprof.md<br />
The output of go tool pprof –help (I pasted the output on my system here)<br />
@rakyll’s blog, which has a huge number of great posts about pprof: https://rakyll.org/archive/. In particular this post on custom pprof profile types and this on the newish profile type for seeing contended mutexes are great.<br />
(there are probably also talks about pprof but I am too impatient to watch talks, that’s part of why I write lots of blog posts and give few talks)</p><br />
<br />
<p>What’s a profile? What kinds of profiles can I get?<br />
When understanding how things work I like to start at the beginning. What is a “profile” exactly?</p><br />
<br />
<p>Well, let’s read the documentation! The 7th time I looked at the runtime/pprof docs, I read this very useful sentence:</p><br />
<br />
<p>A Profile is a collection of stack traces showing the call sequences that led to instances of a particular event, such as allocation. Packages can create and maintain their own profiles; the most common use is for tracking resources that must be explicitly closed, such as files or network connections.</p><br />
<br />
<p>Each Profile has a unique name. A few profiles are predefined:</p><br />
<br />
<p>goroutine    - stack traces of all current goroutines<br />
heap         - a sampling of all heap allocations<br />
threadcreate - stack traces that led to the creation of new OS threads<br />
block        - stack traces that led to blocking on synchronization primitives<br />
mutex        - stack traces of holders of contended mutexes<br />
There are 7 places you can get profiles in the default webserver: the ones mentioned above</p><br />
<br />
<p>http://localhost:6060/debug/pprof/goroutine<br />
http://localhost:6060/debug/pprof/heap<br />
http://localhost:6060/debug/pprof/threadcreate<br />
http://localhost:6060/debug/pprof/block<br />
http://localhost:6060/debug/pprof/mutex<br />
and also 2 more: the CPU profile and the CPU trace.</p><br />
<br />
<p>http://localhost:6060/debug/pprof/profile<br />
http://localhost:6060/debug/pprof/trace?seconds=5<br />
To analyze these profiles (lists of stack traces), the tool to use is go tool pprof, which is a bunch of tools for visualizing stack traces.</p><br />
<br />
<p>super confusing note: the trace endpoint (/debug/pprof/trace?seconds=5), unlike all the rest, outputs a file that is not a pprof profile. Instead it’s a trace and you can view it using go tool trace (not go tool pprof).</p><br />
<br />
<p>You can see the available profiles with http://localhost:6060/debug/pprof/ in your browser. Except it doesn’t tell you about /debug/pprof/profile or /debug/pprof/trace for some reason.</p><br />
<br />
<p>All of these kinds of profiles (goroutine, heap allocations, etc) are just collections of stacktraces, maybe with some metadata attached. If we look at the pprof protobuf definition, you see that a profile is mostly a bunch of Samples.</p><br />
<br />
<p>A sample is basically a stack trace. That stack trace might have some extra information attached to it! For example in a heap profile, the stack trace has a number of bytes of memory attached to it. I think the Samples are the most important part of the profile.</p><br />
<br />
<p>We’re going to deconstruct what exactly is inside a pprof file later, but for now let’s start by doing a quick example of what analyzing a heap profile looks like!</p><br />
<br />
<p>Getting a heap profile with pprof<br />
I’m mostly interested in debugging memory problems right now. So I decided to write a program that allocates a bunch of memory to profile with pprof.</p><br />
<br />
<p>func main() {<br />
    // we need a webserver to get the pprof webserver<br />
    go func() {<br />
        log.Println(http.ListenAndServe(“localhost:6060”, nil))<br />
    }()<br />
    fmt.Println(“hello world”)<br />
    var wg sync.WaitGroup<br />
    wg.Add(1)<br />
    go leakyFunction(wg)<br />
    wg.Wait()<br />
}</p><br />
<br />
<p>func leakyFunction(wg sync.WaitGroup) {<br />
    defer wg.Done()<br />
    s := make([]string, 3)<br />
    for i:= 0; i &lt; 10000000; i++{<br />
        s = append(s, “magical pandas”)<br />
        if (i % 100000) == 0 {<br />
            time.Sleep(500 * time.Millisecond)<br />
        }<br />
    }<br />
}<br />
Basically this just starts a goroutine leakyFunction that allocates a bunch of memory and then exits eventually.</p><br />
<br />
<p>Getting a heap profile of this program is really easy – we just need to run go tool pprof http://localhost:6060/debug/pprof/heap. This puts us into an interactive mode where we run top</p><br />
<br />
<p>$ go tool pprof  http://localhost:6060/debug/pprof/heap<br />
    Fetching profile from http://localhost:6060/debug/pprof/heap<br />
    Saved profile in /home/bork/pprof/pprof.localhost:6060.inuse_objects.inuse_space.004.pb.gz<br />
    Entering interactive mode (type “help” for commands)<br />
(pprof) top<br />
    34416.04kB of 34416.04kB total (  100%)<br />
    Showing top 10 nodes out of 16 (cum &gt;= 512.04kB)<br />
          flat  flat%   sum%        cum   cum%<br />
       33904kB 98.51% 98.51%    33904kB 98.51%  main.leakyFunction<br />
I can also do the same thing outside interactive mode with go tool pprof -top http://localhost:6060/debug/pprof/heap.</p><br />
<br />
<p>This basically tells us that main.leakyFunction is using 339MB of memory. Neat!</p><br />
<br />
<p>We can also generate a PNG profile like this: go tool pprof -png http://localhost:6060/debug/pprof/heap &gt; out.png.</p><br />
<br />
<p>Here’s what that looks like (I ran it at a different time so it’s only using 100MBish of memory).</p><br />
<br />
<p>what do the stack traces in a heap profile mean?<br />
This is not complicated but also was not 100% obvious to me. The stack traces in the heap profile are the stack trace at time of allocation.</p><br />
<br />
<p>So the stack traces in the heap profile might be for code that is not running anymore – like maybe a function allocated a bunch of memory, returned, and a different function that should be freeing that memory is misbehaving. So the function to blame for the memory leak might be totally different than the function listed in the heap profile.</p><br />
<br />
<p>alloc_space vs inuse_space<br />
go tool pprof has the option to show you either allocation counts or in use memory. If you’re concerned with the amount of memory being used, you probably want the inuse metrics, but if you’re worried about time spent in garbage collection, look at allocations!</p><br />
<br />
<p>-inuse_space      Display in-use memory size<br />
  -inuse_objects    Display in-use object counts<br />
  -alloc_space      Display allocated memory size<br />
  -alloc_objects    Display allocated object counts<br />
I was originally confused about this works – the profiles have already be collected! How can I make this choice after the fact? I think how the heap profiles work is – allocations are recorded at some sample rate. Then every time one of those allocation is freed, that’s also recorded. So you get a history of both allocations and frees for some sample of memory activity. Then when it comes time to analyze your memory usage, you can decide where you want inuse memory or total allocation counts!</p><br />
<br />
<p>You can read the source for the memory profiler here: https://golang.org/src/runtime/mprof.go. It has a lot of useful comments! For example here are the comments about setting the sample rate:</p><br />
<br />
<p>// MemProfileRate controls the fraction of memory allocations<br />
// that are recorded and reported in the memory profile.<br />
// The profiler aims to sample an average of<br />
// one allocation per MemProfileRate bytes allocated.</p><br />
<br />
<p>// To include every allocated block in the profile, set MemProfileRate to 1.<br />
// To turn off profiling entirely, set MemProfileRate to 0.</p><br />
<br />
<p>// The tools that process the memory profiles assume that the<br />
// profile rate is constant across the lifetime of the program<br />
// and equal to the current value. Programs that change the<br />
// memory profiling rate should do so just once, as early as<br />
// possible in the execution of the program (for example,<br />
// at the beginning of main).<br />
pprof fundamentals: deconstructing a pprof file<br />
When I started working with pprof I was confused about what was actually happening. It was generating these heap profiles named like pprof.localhost:6060.inuse_objects.inuse_space.004.pb.gz – what is that? How can I see the contents?</p><br />
<br />
<p>Well, let’s take a look!! I wrote an even simpler Go program to get the simplest possible heap profile.</p><br />
<br />
<p>package main</p><br />
<br />
<p>import “runtime”<br />
import “runtime/pprof”<br />
import “os”<br />
import “time”</p><br />
<br />
<p>func main() {<br />
    go leakyFunction()<br />
    time.Sleep(500 * time.Millisecond)<br />
    f, _ := os.Create(“/tmp/profile.pb.gz”)<br />
    defer f.Close()<br />
    runtime.GC()<br />
    pprof.WriteHeapProfile(f);<br />
}</p><br />
<br />
<p>func leakyFunction() {<br />
    s := make([]string, 3)<br />
    for i:= 0; i &lt; 10000000; i++{<br />
        s = append(s, “magical pprof time”)<br />
    }<br />
}<br />
This program just allocates some memory, writes a heap profile, and exits. Pretty simple. Let’s look at this file /tmp/profile.pb.gz! You can download a gunzipped version profile.pb here: profile.pb. I installed protoc using these directions.</p><br />
<br />
<p>profile.pb is a protobuf file, and it turns out you can view protobuf files with protoc, the protobuf compiler.</p><br />
<br />
<p>go get github.com/google/pprof/proto<br />
protoc –decode=perftools.profiles.Profile  $GOPATH/src/github.com/google/pprof/proto/profile.proto –proto_path $GOPATH/src/github.com/google/pprof/proto/<br />
The output of this is a bit long, you can view it all here: output.</p><br />
<br />
<p>Here’s a summary though of what’s in this heap profile file! This contains 1 sample. A sample is a stack trace, and this stack trace has 2 locations: 1 and 2. What are locations 1 and 2? Well they correspond to mappings 1 and 2, which in turn correspond to filenames 7 and 8.</p><br />
<br />
<p>If we look at the string table, we see that filenames 7 and 8 are these two:</p><br />
<br />
<p>string_table: “/home/bork/work/experiments/golang-pprof/leak_simplest”<br />
string_table: “[vdso]”<br />
sample {<br />
  location_id: 1<br />
  location_id: 2<br />
  value: 1<br />
  value: 34717696<br />
  value: 1<br />
  value: 34717696<br />
}<br />
mapping {<br />
  id: 1<br />
  memory_start: 4194304<br />
  memory_limit: 5066752<br />
  filename: 7<br />
}<br />
mapping {<br />
  id: 2<br />
  memory_start: 140720922800128<br />
  memory_limit: 140720922808320<br />
  filename: 8<br />
}<br />
location {<br />
  id: 1<br />
  mapping_id: 1<br />
  address: 5065747<br />
}<br />
location {<br />
  id: 2<br />
  mapping_id: 1<br />
  address: 4519969<br />
}<br />
string_table: “”<br />
string_table: “alloc_objects”<br />
string_table: “count”<br />
string_table: “alloc_space”<br />
string_table: “bytes”<br />
string_table: “inuse_objects”<br />
string_table: “inuse_space”<br />
string_table: “/home/bork/work/experiments/golang-pprof/leak_simplest”<br />
string_table: “[vdso]”<br />
string_table: “[vsyscall]”<br />
string_table: “space”<br />
time_nanos: 1506268926947477256<br />
period_type {<br />
  type: 10<br />
  unit: 4<br />
}<br />
period: 524288<br />
pprof files don’t always contain function names<br />
One interesting thing about this pprof file profile.pb is that it doesn’t contain the names of the functions we’re running! But If I run go tool pprof on it, it prints out the name of the leaky function. How did you do that, go tool pprof?!</p><br />
<br />
<p>go tool pprof -top  profile.pb <br />
59.59MB of 59.59MB total (  100%)<br />
      flat  flat%   sum%        cum   cum%<br />
   59.59MB   100%   100%    59.59MB   100%  main.leakyFunction<br />
         0     0%   100%    59.59MB   100%  runtime.goexit<br />
I answered this with strace, obviously – I straced go tool pprof and this is what I saw:</p><br />
<br />
<p>5015  openat(AT_FDCWD, “/home/bork/pprof/binaries/leak_simplest”, O_RDONLY|O_CLOEXEC &lt;unfinished …&gt;<br />
5015  openat(AT_FDCWD, “/home/bork/work/experiments/golang-pprof/leak_simplest”, O_RDONLY|O_CLOEXEC) = 3<br />
So it seems that go tool pprof noticed that the filename in profile.pb was /home/bork/work/experiments/golang-pprof/leak_simplest, and then it just opened up that file on my computer and used that to get the function names. Neat!</p><br />
<br />
<p>You can also pass the binary to go tool pprof like go tool pprof -out $BINARY_FILE myprofile.pb.gz. Sometimes pprof files contain function names and sometimes they don’t, I haven’t figured out what determines that yet.</p><br />
<br />
<p>pprof keeps improving!<br />
also I found out that thanks to the great work of people like rakyll, pprof keeps getting better!! For example There’s this pull request https://github.com/google/pprof/pull/188 which is being worked on RIGHT NOW which adds flamegraph support to the pprof web interface. Flamegraphs are the best thing in the universe so I’m very excited for that to be available.</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>