<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">ast rewrite</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-11-27T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Nov 27, 2019</time></p>
					</div>
					 <p>https://github.com/fatih/astrewrite<br />
http://goast.yuroyoro.net/<br />
https://github.com/xdg-go/go-rewrap-errors<br />
<!-- more --><br />
At work, my team decided to switch our codebase from pkg/errors to Go 1.13’s native error wrapping. We used to wrap our errors like this:</p><br />
<br />
<p>var errBadStuff := errors.New(“something happened”)<br />
…<br />
err := errors.Wrapf(errBadStuff, “some context ‘%s’”, label)<br />
Starting in 1.13, we can wrap errors directly using fmt.Errorf and the %w code:</p><br />
<br />
<p>err := fmt.Errorf(“some context ‘%s’: %w”, label, errBadStuff)<br />
Rather than change hundreds of wrappings across tens of thousands of lines by hand or with kludgy string replacement, I wrote a program to rewrite our source files using Go’s AST instead.</p><br />
<br />
<p>Parsing, walking and rewriting an AST<br />
The central function of the program takes in old source, parses it, transforms it and returns the new code. Parsing uses Go’s built-in packages token and parser to produce an AST for a file:</p><br />
<br />
<p>func Rewrite(filename string, oldSource []byte) ([]byte, error) {<br />
    fset := token.NewFileSet()<br />
    oldAST, err := parser.ParseFile(fset, filename, oldSource, parser.ParseComments)<br />
    if err != nil {<br />
        return nil, fmt.Errorf(“error parsing %s: %w”, filename, err)<br />
    }<br />
    …<br />
}<br />
Confusingly, the parser.ParseComments argument to ParseFile means “include comments in the parse, not just code”, which I need to preserve all the input for rewriting.</p><br />
<br />
<p>I used Fatih Arslan’s astrewrite library for the AST manipulation, as it provides a Walk function that (unlike Go’s built-in AST walker), lets me return a modified node to replace in the AST structure.</p><br />
<br />
<p>func Rewrite(filename string, oldSource []byte) ([]byte, error) {<br />
    …<br />
    newAST := astrewrite.Walk(oldAST, visitor)<br />
    …<br />
}<br />
Given the rewritten AST, the output is rendered using the same library used by gofmt, called format:</p><br />
<br />
<p>func Rewrite(filename string, oldSource []byte) ([]byte, error) {<br />
    …<br />
    buf := &amp;bytes.Buffer{}<br />
    err = format.Node(buf, fset, newAST)<br />
    if err != nil {<br />
        return nil, fmt.Errorf(“error formatting new code: %w”, err)<br />
    }<br />
    return buf.Bytes(), nil<br />
}<br />
That’s the high-level flow. All the interesting details are in the visitor function that finds the nodes of interest and rewrites them.</p><br />
<br />
<p>Inspecting the AST<br />
Finding nodes in the AST and changing them requires understanding what the AST looks like. My first attempt just dumped out nodes to stdout in visitor, but I later found an online Go AST Viewer that makes it easy to see the AST. By giving it a small bit of code, I can see how that looks in AST-form.</p><br />
<br />
<p>For example, here is errors.Wrapf(“foo ‘%s’, err) in its AST form, which appears as an *ast.CallExpr:</p><br />
<br />
<p>X: *ast.CallExpr {<br />
   Fun: *ast.SelectorExpr {<br />
      X: *ast.Ident {<br />
         NamePos: 10:2<br />
         Name: “errors”<br />
      }<br />
      Sel: *ast.Ident {<br />
         NamePos: 10:9<br />
         Name: “Wrapf”<br />
      }<br />
   }<br />
   Lparen: 10:14<br />
   Args: []ast.Expr (len = 2) {<br />
      0: *ast.BasicLit {<br />
         ValuePos: 10:15<br />
         Kind: STRING<br />
         Value: “"foo ‘%s’"”<br />
      }<br />
      1: *ast.Ident {<br />
         NamePos: 10:27<br />
         Name: “err”<br />
         Obj: *(obj @ 54)<br />
      }<br />
   }<br />
   Ellipsis: -<br />
   Rparen: 10:30<br />
}<br />
The important parts are the Fun and Args fields, which give the command “name” and arguments, respectively. The name of the call is in a SelectorExpr, split into X and Sel, but the AST dump is slightly deceptive because SelectorExpr actually has an interface type for X:</p><br />
<br />
<p>type SelectorExpr struct {<br />
    X   Expr   // expression<br />
    Sel *Ident // field selector<br />
}<br />
So when checking if a CallExpr.SelectorExpr.X is errors.Wrapf, I must check if the concrete type is Ident.</p><br />
<br />
<p>Here’s a helper function I wrote to extract the function call name out of a CallExpr:</p><br />
<br />
<p>func getCallExprLiteral(c <em>ast.CallExpr) string {<br />
    s, ok := c.Fun.(</em>ast.SelectorExpr)<br />
    if !ok {<br />
        return “”<br />
    }</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i, ok := s.X.(*ast.Ident)<br />
if !ok {<br />
    return ""<br />
}<br />
<br />
return i.Name + "." + s.Sel.Name } If the CallExpr doesn’t give us a literal function name, the helper returns an empty string to signal that no literal name was found.<br />
</code></pre></div></div><br />
<br />
<p>Finding a node to rewrite<br />
Knowing the AST structure and having a helper to extract a function name from the AST is all that’s needed for the “find a node to rewrite” part of the visitor function. If it’s visiting a CallExpr, the visitor just delegates to a handler for that type.</p><br />
<br />
<p>func visitor(n ast.Node) (ast.Node, bool) {<br />
    switch v := n.(type) {<br />
    case *ast.CallExpr:<br />
        return handleCallExpr(v)<br />
    default:<br />
        return n, true<br />
    }<br />
}<br />
The handler only has something to do if the function name matches the names I’m looking for from pkg/errors.</p><br />
<br />
<p>func handleCallExpr(ce *ast.CallExpr) (ast.Node, bool) {<br />
    name := getCallExprLiteral(ce)<br />
    switch name {<br />
    case “errors.Wrap”:<br />
        return rewriteWrap(ce), true<br />
    case “errors.Wrapf”:<br />
        return rewriteWrap(ce), true<br />
    default:<br />
        return ce, true<br />
    }<br />
}<br />
If it does match, then the program rewrites it. Otherwise, nodes are returned unchanged from visitor.</p><br />
<br />
<p>Rewriting an AST node<br />
Here are the signatures for the pkg/errors functions to rewrite:</p><br />
<br />
<p>func Wrap(err error, message string) error<br />
func Wrapf(err error, format string, args …interface{}) error<br />
Three things need to happen to rewrite these to fmt.Errorf. First, the error argument needs to rotate from the beginning to the end of the argument list. Second, the message or format strings need to have “: %w” appended to them. Finally, the function name has to change.</p><br />
<br />
<p>Everything needed for the first two changes is in the *ast.CallExpr.Args field. For the rotation, I create a new argument list, copy everything but the original first argument, then append the original first argument.</p><br />
<br />
<p>func rewriteWrap(ce *ast.CallExpr) *ast.CallExpr {<br />
    // Rotate err to the end of a new args list<br />
    newArgs := make([]ast.Expr, len(ce.Args)-1)<br />
    copy(newArgs, ce.Args[1:])<br />
    newArgs = append(newArgs, ce.Args[0])<br />
    …<br />
}<br />
For appending “: %w”, I have to account for whether the message/format is a literal string or if it’s another expression, such a global variable or function that returns a string.</p><br />
<br />
<p>If it’s a literal, then the literal value itself needs to be amended. Here’s how a format string looks as an *ast.BasicLit type from the CallExpr example above:</p><br />
<br />
<p>*ast.BasicLit {<br />
     ValuePos: 10:15<br />
     Kind: STRING<br />
     Value: “"foo ‘%s’"”<br />
}<br />
Note that the Value field includes the quotation marks. To append, I can remove the trailing “ and add : %w”.</p><br />
<br />
<p>If the value isn’t a BasicLit, then given some expression X, I need to replace that with the expression X + “: %w”. In AST terms, that’s an *ast.BinaryExpr that adds the original argument and a new BasicLit.</p><br />
<br />
<p>(How did I know that? I guessed, based on my experience with other language AST’s, but if I didn’t know that, I could put an example into the AST Viewer and see what it shows.)</p><br />
<br />
<p>Here’s how that looks in code. If the first argument is a basic literal, amend the Value, otherwise, replace the first argument with a new BinaryExpr:</p><br />
<br />
<p>func rewriteWrap(ce <em>ast.CallExpr) *ast.CallExpr {<br />
    …<br />
    // If the format string is a literal, we can rewrite it:<br />
    //     “……” -&gt; “……: %w”<br />
    // Otherwise, we replace it with a binary op to add the wrap code:<br />
    //     SomeNonLiteral -&gt; SomeNonLiteral + “: %w”<br />
    fmtStr, ok := newArgs[0].(</em>ast.BasicLit)<br />
    if ok {<br />
        // Strip trailing <code class="language-plaintext highlighter-rouge">"</code> and append wrap code and new trailing <code class="language-plaintext highlighter-rouge">"</code><br />
        fmtStr.Value = fmtStr.Value[:len(fmtStr.Value)-1] + <code class="language-plaintext highlighter-rouge">: %w"</code><br />
    } else {<br />
        binOp := &amp;ast.BinaryExpr{<br />
            X:  newArgs[0],<br />
            Op: token.ADD,<br />
            Y:  &amp;ast.BasicLit{Kind: token.STRING, Value: <code class="language-plaintext highlighter-rouge">": %w"</code>},<br />
        }<br />
        newArgs[0] = binOp<br />
    }<br />
    …<br />
}<br />
The last part of the rewrite is to return a new CallExpr with fmt.Errof as the function name and with the new argument list.</p><br />
<br />
<p>func rewriteWrap(ce *ast.CallExpr) *ast.CallExpr {<br />
    …<br />
    return newErrorfExpr(newArgs)<br />
}</p><br />
<br />
<p>func newErrorfExpr(args []ast.Expr) *ast.CallExpr {<br />
    return &amp;ast.CallExpr{<br />
        Fun: &amp;ast.SelectorExpr{<br />
            X:   &amp;ast.Ident{Name: “fmt”},<br />
            Sel: &amp;ast.Ident{Name: “Errorf”},<br />
        },<br />
        Args: args,<br />
    }<br />
}<br />
That’s it! The visitor function will now rewrite errors.Wrap and errors.Wrapf to fmt.Errorf.</p><br />
<br />
<p>Applying it to the codebase<br />
The main function I wrote only handles individual files. While I didn’t show it in this article, it also replaces the github.com/pkg/errors import statement with errors so that errors.New uses the core errors library. But it’s possible that errors isn’t needed anymore, only fmt, so in the end, I used a loop to rewrap the errors with my program and then wash the results through goimports:</p><br />
<br />
<p>for f in $(find . -iname “*.go”); do go-rewrap-errors -w $f; goimports -w $f; done<br />
This did exactly what I wanted – rewrite hundreds of wrapping functions across thousands of lines of code, without messing with my editor or string replacement. And it’s a reusable tool for other codebases at my company (or that you can use with the link at the end of this article).</p><br />
<br />
<p>I did have to go through and fix up a couple things by hand:</p><br />
<br />
<p>Our custom error types had a Cause method to unwrap the inner error. I changed those to Unwrap, which is what built-in errors expects. There were so few of these that it was faster to edit by hand than do it via AST transformation.<br />
In a few places, we were using pkg/errors.Cause to unwrap errors. I changed those to use built-in errors.As or errors.Is.<br />
We weren’t using other feature of pkg/errors so there was nothing else to do.</p><br />
<br />
<p>While the Go AST seems intimidating at first, it’s an extremely powerful tool for code transformation. With some visualization to see what before and after code looks like, and some trial and error, it made a hard job updating our codebase seem very easy.</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>