<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>æ³½æ°‘åšå®¢ | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--ç™¾åº¦ç»Ÿè®¡-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--è½®æ’­å›¾ç‰‡-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--æ°´å°-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'æ³½æ°‘åšå®¢',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--æ°´å°-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">æ³½æ°‘åšå®¢</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">å†…å­˜åˆ†æ</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by å¤æ³½æ°‘</span></span> <time datetime="2019-11-08T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Nov 8, 2019</time></p>
					</div>
					 <p>golang pprof<br />
å½“ä½ çš„golangç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ¶ˆè€—äº†è¶…å‡ºä½ ç†è§£çš„å†…å­˜æ—¶ï¼Œä½ å°±éœ€è¦ææ˜ç™½ï¼Œåˆ°åº•æ˜¯ ç¨‹åºä¸­å“ªäº›ä»£ç å¯¼è‡´äº†è¿™äº›å†…å­˜æ¶ˆè€—ã€‚æ­¤æ—¶golangç¼–è¯‘å¥½çš„ç¨‹åºå¯¹ä½ æ¥è¯´æ˜¯ä¸ªé»‘ç›’ï¼Œè¯¥ å¦‚ä½•ææ¸…å…¶ä¸­çš„å†…å­˜ä½¿ç”¨å‘¢ï¼Ÿå¹¸å¥½golangå·²ç»å†…ç½®äº†ä¸€äº›æœºåˆ¶æ¥å¸®åŠ©æˆ‘ä»¬è¿›è¡Œåˆ†æå’Œè¿½ è¸ªã€‚</p><br />
<br />
<p>æ­¤æ—¶ï¼Œé€šå¸¸æˆ‘ä»¬å¯ä»¥é‡‡ç”¨golangçš„pprofæ¥å¸®åŠ©æˆ‘ä»¬åˆ†ægolangè¿›ç¨‹çš„å†…å­˜ä½¿ç”¨ã€‚<br />
<!-- more --><br />
pprof å®ä¾‹<br />
é€šå¸¸æˆ‘ä»¬é‡‡ç”¨http apiæ¥å°†pprofä¿¡æ¯æš´éœ²å‡ºæ¥ä»¥ä¾›åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨net/http/pprof è¿™ä¸ªpackageã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p><br />
<br />
<p>// pprof çš„initå‡½æ•°ä¼šå°†pprofé‡Œçš„ä¸€äº›handleræ³¨å†Œåˆ°http.DefaultServeMuxä¸Š<br />
// å½“ä¸ä½¿ç”¨http.DefaultServeMuxæ¥æä¾›http apiæ—¶ï¼Œå¯ä»¥æŸ¥é˜…å…¶initå‡½æ•°ï¼Œè‡ªå·±æ³¨å†Œhandler<br />
import _ â€œnet/http/pprofâ€</p><br />
<br />
<p>go func() {<br />
    http.ListenAndServe(â€œ0.0.0.0:8080â€, nil)<br />
}()<br />
æ­¤æ—¶æˆ‘ä»¬å¯ä»¥å¯åŠ¨è¿›ç¨‹ï¼Œç„¶åè®¿é—®http://localhost:8080/debug/pprof/å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç®€å•çš„ é¡µé¢ï¼Œé¡µé¢ä¸Šæ˜¾ç¤º: æ³¨æ„: ä»¥ä¸‹çš„å…¨éƒ¨æ•°æ®ï¼ŒåŒ…æ‹¬go tool pprof é‡‡é›†åˆ°çš„æ•°æ®éƒ½ä¾èµ–è¿›ç¨‹ä¸­çš„pprofé‡‡æ ·ç‡ï¼Œé»˜è®¤512kbè¿›è¡Œ ä¸€æ¬¡é‡‡æ ·ï¼Œå½“æˆ‘ä»¬è®¤ä¸ºæ•°æ®ä¸å¤Ÿç»†è‡´æ—¶ï¼Œå¯ä»¥è°ƒèŠ‚é‡‡æ ·ç‡runtime.MemProfileRateï¼Œä½†æ˜¯é‡‡æ ·ç‡è¶Šä½ï¼Œè¿› ç¨‹è¿è¡Œé€Ÿåº¦è¶Šæ…¢ã€‚</p><br />
<br />
<p>/debug/pprof/</p><br />
<br />
<p>profiles:<br />
0         block<br />
136840    goroutine<br />
902       heap<br />
0         mutex<br />
40        threadcreate</p><br />
<br />
<p>full goroutine stack dump<br />
ä¸Šé¢ç®€å•æš´éœ²å‡ºäº†å‡ ä¸ªå†…ç½®çš„Profileç»Ÿè®¡é¡¹ã€‚ä¾‹å¦‚æœ‰136840ä¸ªgoroutineåœ¨è¿è¡Œï¼Œç‚¹å‡»ç›¸å…³é“¾æ¥ å¯ä»¥çœ‹åˆ°è¯¦ç»†ä¿¡æ¯ã€‚</p><br />
<br />
<p>å½“æˆ‘ä»¬åˆ†æå†…å­˜ç›¸å…³çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥ç‚¹å‡»heapé¡¹ï¼Œè¿›å…¥http://127.0.0.1:8080/debug/pprof/heap?debug=1 å¯ä»¥æŸ¥çœ‹å…·ä½“çš„æ˜¾ç¤ºï¼š</p><br />
<br />
<p>heap profile: 3190: 77516056 [54762: 612664248] @ heap/1048576<br />
1: 29081600 [1: 29081600] @ 0x89368e 0x894cd9 0x8a5a9d 0x8a9b7c 0x8af578 0x8b4441 0x8b4c6d 0x8b8504 0x8b2bc3 0x45b1c1</p><br />
<h1 id="0x89368d----githubcomsyndtrgoleveldbleveldbmemdbdbput0x59d">0x89368d    github.com/syndtr/goleveldb/leveldb/memdb.(*DB).Put+0x59d</h1><br />
<h1 id="0x894cd8----xxxxxstorageinternalmemtablememtableset0x88">0x894cd8    xxxxx/storage/internal/memtable.(*MemTable).Set+0x88</h1><br />
<h1 id="0x8a5a9c----xxxxxstoragesnapshotterappendcommitlog0x1cc">0x8a5a9c    xxxxx/storage.(*snapshotter).AppendCommitLog+0x1cc</h1><br />
<h1 id="0x8a9b7b----xxxxxstoragestoreupdate0x26b">0x8a9b7b    xxxxx/storage.(*store).Update+0x26b</h1><br />
<h1 id="0x8af577----xxxxxconfigconfigupdate0xa7">0x8af577    xxxxx/config.(*config).Update+0xa7</h1><br />
<h1 id="0x8b4440----xxxxxnamingnamingupdate0x120">0x8b4440    xxxxx/naming.(*naming).update+0x120</h1><br />
<h1 id="0x8b4c6c----xxxxxnamingnaminginstancetimeout0x27c">0x8b4c6c    xxxxx/naming.(*naming).instanceTimeout+0x27c</h1><br />
<h1 id="0x8b8503----xxxxxnamingnamingxxxxxnaminginstancetimeout-fm0x63">0x8b8503    xxxxx/naming.(*naming).(xxxxx/naming.instanceTimeout)-fm+0x63</h1><br />
<br />
<p>â€¦â€¦</p><br />
<br />
<h1 id="runtimememstats">runtime.MemStats</h1><br />
<h1 id="alloc--2463648064">Alloc = 2463648064</h1><br />
<h1 id="totalalloc--31707239480">TotalAlloc = 31707239480</h1><br />
<h1 id="sys--4831318840">Sys = 4831318840</h1><br />
<h1 id="lookups--2690464">Lookups = 2690464</h1><br />
<h1 id="mallocs--274619648">Mallocs = 274619648</h1><br />
<h1 id="frees--262711312">Frees = 262711312</h1><br />
<h1 id="heapalloc--2463648064">HeapAlloc = 2463648064</h1><br />
<h1 id="heapsys--3877830656">HeapSys = 3877830656</h1><br />
<h1 id="heapidle--854990848">HeapIdle = 854990848</h1><br />
<h1 id="heapinuse--3022839808">HeapInuse = 3022839808</h1><br />
<h1 id="heapreleased--0">HeapReleased = 0</h1><br />
<h1 id="heapobjects--11908336">HeapObjects = 11908336</h1><br />
<h1 id="stack--655949824--655949824">Stack = 655949824 / 655949824</h1><br />
<h1 id="mspan--63329432--72040448">MSpan = 63329432 / 72040448</h1><br />
<h1 id="mcache--38400--49152">MCache = 38400 / 49152</h1><br />
<h1 id="buckhashsys--1706593">BuckHashSys = 1706593</h1><br />
<h1 id="gcsys--170819584">GCSys = 170819584</h1><br />
<h1 id="othersys--52922583">OtherSys = 52922583</h1><br />
<h1 id="nextgc--3570699312">NextGC = 3570699312</h1><br />
<h1 id="pausens--1052815-217503-208124-233034-1146462-456882-1098525-530706-551702-419372-768322-596273-387826-455807-563621-587849-416204-599143-572823-488681-701731-656358-2476770-12141392-5827253-3508261-1715582-1295487-908563-788435-718700-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0-0">PauseNs = [1052815 217503 208124 233034 1146462 456882 1098525 530706 551702 419372 768322 596273 387826 455807 563621 587849 416204 599143 572823 488681 701731 656358 2476770 12141392 5827253 3508261 1715582 1295487 908563 788435 718700 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</h1><br />
<h1 id="numgc--31">NumGC = 31</h1><br />
<h1 id="debuggc--false">DebugGC = false</h1><br />
<p>å…¶ä¸­æ˜¾ç¤ºçš„å†…å®¹ä¼šæ¯”è¾ƒå¤šï¼Œä½†æ˜¯ä¸»ä½“åˆ†ä¸º2ä¸ªéƒ¨åˆ†: ç¬¬ä¸€ä¸ªéƒ¨åˆ†æ‰“å°ä¸ºé€šè¿‡runtime.MemProfile()è·å–çš„runtime.MemProfileRecordè®°å½•ã€‚ å…¶å«ä¹‰ä¸ºï¼š</p><br />
<br />
<p>heap profile: 3190(inused objects): 77516056(inused bytes) [54762(alloc objects): 612664248(alloc bytes)] @ heap/1048576(2*MemProfileRate)<br />
1: 29081600 [1: 29081600] (å‰é¢4ä¸ªæ•°è·Ÿç¬¬ä¸€è¡Œçš„ä¸€æ ·ï¼Œæ­¤è¡Œä»¥åæ˜¯æ¯æ¬¡è®°å½•çš„ï¼Œåé¢çš„åœ°å€æ˜¯è®°å½•ä¸­çš„æ ˆæŒ‡é’ˆ)@ 0x89368e 0x894cd9 0x8a5a9d 0x8a9b7c 0x8af578 0x8b4441 0x8b4c6d 0x8b8504 0x8b2bc3 0x45b1c1</p><br />
<h1 id="0x89368d----githubcomsyndtrgoleveldbleveldbmemdbdbput0x59d-æ ˆä¿¡æ¯">0x89368d    github.com/syndtr/goleveldb/leveldb/memdb.(*DB).Put+0x59d æ ˆä¿¡æ¯</h1><br />
<p>ç¬¬äºŒéƒ¨åˆ†å°±æ¯”è¾ƒå¥½ç†è§£ï¼Œæ‰“å°çš„æ˜¯é€šè¿‡runtime.ReadMemStats()è¯»å–çš„runtime.MemStatsä¿¡æ¯ã€‚ æˆ‘ä»¬å¯ä»¥é‡ç‚¹å…³æ³¨ä¸€ä¸‹</p><br />
<br />
<p>Sys è¿›ç¨‹ä»ç³»ç»Ÿè·å¾—çš„å†…å­˜ç©ºé—´ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´ã€‚<br />
HeapAlloc è¿›ç¨‹å †å†…å­˜åˆ†é…ä½¿ç”¨çš„ç©ºé—´ï¼Œé€šå¸¸æ˜¯ç”¨æˆ·newå‡ºæ¥çš„å †å¯¹è±¡ï¼ŒåŒ…å«æœªè¢«gcæ‰çš„ã€‚<br />
HeapSys è¿›ç¨‹ä»ç³»ç»Ÿè·å¾—çš„å †å†…å­˜ï¼Œå› ä¸ºgolangåº•å±‚ä½¿ç”¨TCmallocæœºåˆ¶ï¼Œä¼šç¼“å­˜ä¸€éƒ¨åˆ†å †å†…å­˜ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´ã€‚<br />
PauseNs è®°å½•æ¯æ¬¡gcæš‚åœçš„æ—¶é—´(çº³ç§’)ï¼Œæœ€å¤šè®°å½•256ä¸ªæœ€æ–°è®°å½•ã€‚<br />
NumGC è®°å½•gcå‘ç”Ÿçš„æ¬¡æ•°ã€‚<br />
ç›¸ä¿¡ï¼Œå¯¹pprofä¸äº†è§£çš„ç”¨æˆ·çœ‹äº†ä»¥ä¸Šå†…å®¹ï¼Œå¾ˆéš¾è·å¾—æ›´å¤šçš„æœ‰ç”¨ä¿¡æ¯ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¼•ç”¨æ›´å¤šå·¥å…·æ¥å¸®åŠ© æˆ‘ä»¬æ›´åŠ ç®€å•çš„è§£è¯»pprofå†…å®¹ã€‚</p><br />
<br />
<p>go tool<br />
æˆ‘ä»¬å¯ä»¥é‡‡ç”¨go tool pprof -inuse_space http://127.0.0.1:8080/debug/pprof/heapå‘½ä»¤è¿æ¥åˆ°è¿›ç¨‹ä¸­ æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„ä¸€äº›å†…å­˜ç›¸å…³ä¿¡æ¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¾—åˆ°ä¸€ä¸ªå¯ä»¥äº¤äº’çš„å‘½ä»¤è¡Œã€‚</p><br />
<br />
<p>æˆ‘ä»¬å¯ä»¥çœ‹æ•°æ®top10æ¥æŸ¥çœ‹æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡è¾ƒå¤šçš„10ä¸ªå‡½æ•°å…¥å£ã€‚é€šå¸¸ç”¨æ¥æ£€æµ‹æœ‰æ²¡æœ‰ä¸ç¬¦åˆé¢„æœŸçš„å†…å­˜ å¯¹è±¡å¼•ç”¨ã€‚</p><br />
<br />
<p>(pprof) top10<br />
1355.47MB of 1436.26MB total (94.38%)<br />
Dropped 371 nodes (cum &lt;= 7.18MB)<br />
Showing top 10 nodes out of 61 (cum &gt;= 23.50MB)<br />
      flat  flat%   sum%        cum   cum%<br />
  512.96MB 35.71% 35.71%   512.96MB 35.71%  net/http.newBufioWriterSize<br />
  503.93MB 35.09% 70.80%   503.93MB 35.09%  net/http.newBufioReader<br />
  113.04MB  7.87% 78.67%   113.04MB  7.87%  runtime.rawstringtmp<br />
   55.02MB  3.83% 82.50%    55.02MB  3.83%  runtime.malg<br />
   45.01MB  3.13% 85.64%    45.01MB  3.13%  xxxxx/storage.(<em>Node).clone<br />
   26.50MB  1.85% 87.48%    52.50MB  3.66%  context.WithCancel<br />
   25.50MB  1.78% 89.26%    83.58MB  5.82%  runtime.systemstack<br />
   25.01MB  1.74% 91.00%    58.51MB  4.07%  net/http.readRequest<br />
      25MB  1.74% 92.74%    29.03MB  2.02%  runtime.mapassign<br />
   23.50MB  1.64% 94.38%    23.50MB  1.64%  net/http.(</em>Server).newConn<br />
ç„¶åæˆ‘ä»¬åœ¨ç”¨go tool pprof -alloc_space http://127.0.0.1:8080/debug/pprof/heapå‘½ä»¤é“¾æ¥ç¨‹åºæ¥æŸ¥çœ‹ å†…å­˜å¯¹è±¡åˆ†é…çš„ç›¸å…³æƒ…å†µã€‚ç„¶åè¾“å…¥topæ¥æŸ¥çœ‹ç´¯ç§¯åˆ†é…å†…å­˜è¾ƒå¤šçš„ä¸€äº›å‡½æ•°è°ƒç”¨:</p><br />
<br />
<p>(pprof) top<br />
523.38GB of 650.90GB total (80.41%)<br />
Dropped 342 nodes (cum &lt;= 3.25GB)<br />
Showing top 10 nodes out of 106 (cum &gt;= 28.02GB)<br />
      flat  flat%   sum%        cum   cum%<br />
  147.59GB 22.68% 22.68%   147.59GB 22.68%  runtime.rawstringtmp<br />
  129.23GB 19.85% 42.53%   129.24GB 19.86%  runtime.mapassign<br />
   48.23GB  7.41% 49.94%    48.23GB  7.41%  bytes.makeSlice<br />
   46.25GB  7.11% 57.05%    71.06GB 10.92%  encoding/json.Unmarshal<br />
   31.41GB  4.83% 61.87%   113.86GB 17.49%  net/http.readRequest<br />
   30.55GB  4.69% 66.57%   171.20GB 26.30%  net/http.(*conn).readRequest<br />
   22.95GB  3.53% 70.09%    22.95GB  3.53%  net/url.parse<br />
   22.70GB  3.49% 73.58%    22.70GB  3.49%  runtime.stringtoslicebyte<br />
   22.70GB  3.49% 77.07%    22.70GB  3.49%  runtime.makemap<br />
   21.75GB  3.34% 80.41%    28.02GB  4.31%  context.WithCancel<br />
å¯ä»¥çœ‹å‡ºstring-[]byteç›¸äº’è½¬æ¢ã€åˆ†é…mapã€bytes.makeSliceã€encoding/json.Unmarshalç­‰è°ƒç”¨ç´¯ç§¯åˆ†é…çš„å†…å­˜è¾ƒå¤šã€‚ æ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥reviewä»£ç ï¼Œå¦‚ä½•å‡å°‘è¿™äº›ç›¸å…³çš„è°ƒç”¨ï¼Œæˆ–è€…ä¼˜åŒ–ç›¸å…³ä»£ç é€»è¾‘ã€‚</p><br />
<br />
<p>å½“æˆ‘ä»¬ä¸æ˜ç¡®è¿™äº›è°ƒç”¨æ—¶æ˜¯è¢«å“ªäº›å‡½æ•°å¼•èµ·çš„æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¾“å…¥top -cumæ¥æŸ¥æ‰¾ï¼Œ-cumçš„æ„æ€å°±æ˜¯ï¼Œå°†å‡½æ•°è°ƒç”¨å…³ç³» ä¸­çš„æ•°æ®è¿›è¡Œç´¯ç§¯ï¼Œæ¯”å¦‚Aå‡½æ•°è°ƒç”¨çš„Bå‡½æ•°ï¼Œåˆ™Bå‡½æ•°ä¸­çš„å†…å­˜åˆ†é…é‡ä¹Ÿä¼šç´¯ç§¯åˆ°Aä¸Šé¢ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå®¹æ˜“çš„æ‰¾å‡ºè°ƒç”¨é“¾ã€‚</p><br />
<br />
<p>(pprof) top20 -cum<br />
322890.40MB of 666518.53MB total (48.44%)<br />
Dropped 342 nodes (cum &lt;= 3332.59MB)<br />
Showing top 20 nodes out of 106 (cum &gt;= 122316.23MB)<br />
      flat  flat%   sum%        cum   cum%<br />
         0     0%     0% 643525.16MB 96.55%  runtime.goexit<br />
 2184.63MB  0.33%  0.33% 620745.26MB 93.13%  net/http.(<em>conn).serve<br />
         0     0%  0.33% 435300.50MB 65.31%  xxxxx/api/server.(</em>HTTPServer).ServeHTTP<br />
 5865.22MB  0.88%  1.21% 435300.50MB 65.31%  xxxxx/api/server/router.(<em>httpRouter).ServeHTTP<br />
         0     0%  1.21% 433121.39MB 64.98%  net/http.serverHandler.ServeHTTP<br />
         0     0%  1.21% 430456.29MB 64.58%  xxxxx/api/server/filter.(</em>chain).Next<br />
   43.50MB 0.0065%  1.21% 429469.71MB 64.43%  xxxxx/api/server/filter.TransURLTov1<br />
         0     0%  1.21% 346440.39MB 51.98%  xxxxx/api/server/filter.Role30x<br />
31283.56MB  4.69%  5.91% 175309.48MB 26.30%  net/http.(<em>conn).readRequest<br />
         0     0%  5.91% 153589.85MB 23.04%  github.com/julienschmidt/httprouter.(</em>Router).ServeHTTP<br />
         0     0%  5.91% 153589.85MB 23.04%  github.com/julienschmidt/httprouter.(<em>Router).ServeHTTP-fm<br />
         0     0%  5.91% 153540.85MB 23.04%  xxxxx/api/server/router.(</em>httpRouter).Register.func1<br />
       2MB 0.0003%  5.91% 153117.78MB 22.97%  xxxxx/api/server/filter.Validate<br />
151134.52MB 22.68% 28.58% 151135.02MB 22.68%  runtime.rawstringtmp<br />
         0     0% 28.58% 150714.90MB 22.61%  xxxxx/api/server/router/naming/v1.(<em>serviceRouter).(git.intra.weibo.com/platform/vintage/api/server/router/naming/v1.service)-fm<br />
         0     0% 28.58% 150714.90MB 22.61%  xxxxx/api/server/router/naming/v1.(</em>serviceRouter).service<br />
         0     0% 28.58% 141200.76MB 21.18%  net/http.Redirect<br />
132334.96MB 19.85% 48.44% 132342.95MB 19.86%  runtime.mapassign<br />
      42MB 0.0063% 48.44% 125834.16MB 18.88%  xxxxx/api/server/router/naming/v1.heartbeat<br />
         0     0% 48.44% 122316.23MB 18.35%  xxxxxx/config.(*config).Lookup<br />
å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬å°±å¾ˆå®¹æ˜“çš„æŸ¥æ‰¾åˆ°è¿™äº›å‡½æ•°æ˜¯è¢«å“ªäº›å‡½æ•°è°ƒç”¨çš„ã€‚</p><br />
<br />
<p>æ ¹æ®ä»£ç çš„è°ƒç”¨å…³ç³»ï¼Œfilter.TransURLTov1ä¼šè°ƒç”¨filter.Role30xï¼Œä½†æ˜¯ä»–ä»¬ä¹‹é—´çš„cum%å·®å€¼æœ‰12.45%ï¼Œå› æ­¤ æˆ‘ä»¬å¯ä»¥å¾—çŸ¥filter.TransURLTov1å†…éƒ¨è‡ªå·±ç›´æ¥åˆ†é…çš„å†…å­˜é‡è¾¾åˆ°äº†æ•´ä¸ªè¿›ç¨‹åˆ†é…å†…å­˜æ€»é‡çš„12.45%ï¼Œè¿™å¯æ˜¯ä¸€ä¸ª å€¼å¾—å¤§å¤§ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p><br />
<br />
<p>ç„¶åæˆ‘ä»¬å¯ä»¥è¾“å…¥å‘½ä»¤webï¼Œå…¶ä¼šç»™æˆ‘ä»¬çš„æµè§ˆå™¨å¼¹å‡ºä¸€ä¸ª.svgå›¾ç‰‡ï¼Œå…¶ä¼šæŠŠè¿™äº›ç´¯ç§¯å…³ç³»ç”»æˆä¸€ä¸ªæ‹“æ‰‘å›¾ï¼Œæä¾›ç»™ æˆ‘ä»¬ã€‚æˆ–è€…ç›´æ¥æ‰§è¡Œgo tool pprof -alloc_space -cum -svg http://127.0.0.1:8080/debug/pprof/heap &gt; heap.svgæ¥ç”Ÿ æˆheap.svgå›¾ç‰‡ã€‚</p><br />
<br />
<p>ä¸‹é¢æˆ‘ä»¬å–ä¸€ä¸ªå›¾ç‰‡ä¸­çš„ä¸€ä¸ªç‰‡æ®µè¿›è¡Œåˆ†æ:</p><br />
<br />
<p>golang-memory-pprof.png</p><br />
<br />
<p>æ¯ä¸€ä¸ªæ–¹å—ä¸ºpprofè®°å½•çš„ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ ˆï¼ŒæŒ‡å‘æ–¹å—çš„ç®­å¤´ä¸Šçš„æ•°å­—æ˜¯è®°å½•çš„è¯¥æ ˆç´¯ç§¯åˆ†é…çš„å†…å­˜å‘ï¼Œä»æ–¹å—æŒ‡å‡ºçš„ ç®­å¤´ä¸Šçš„æ•°å­—ä¸ºè¯¥å‡½æ•°è°ƒç”¨çš„å…¶ä»–å‡½æ•°ç´¯ç§¯åˆ†é…çš„å†…å­˜ã€‚ä»–ä»¬ä¹‹é—´çš„å·®å€¼å¯ä»¥ç®€å•ç†è§£ä¸ºæœ¬å‡½æ•°é™¤è°ƒç”¨å…¶ä»–å‡½æ•°å¤–ï¼Œè‡ª èº«åˆ†é…çš„ã€‚æ–¹å—å†…éƒ¨çš„æ•°å­—ä¹Ÿä½“ç°äº†è¿™ä¸€ç‚¹ï¼Œå…¶æ•°å­—ä¸º:(è‡ªèº«åˆ†é…çš„å†…å­˜ of è¯¥å‡½æ•°ç´¯ç§¯åˆ†é…çš„å†…å­˜)ã€‚</p><br />
<br />
<p>â€“inuse/alloc_space â€“inuse/alloc_objectsåŒºåˆ«<br />
é€šå¸¸æƒ…å†µä¸‹ï¼š</p><br />
<br />
<p>ç”¨â€“inuse_spaceæ¥åˆ†æç¨‹åºå¸¸é©»å†…å­˜çš„å ç”¨æƒ…å†µ;<br />
ç”¨â€“alloc_objectsæ¥åˆ†æå†…å­˜çš„ä¸´æ—¶åˆ†é…æƒ…å†µï¼Œå¯ä»¥æé«˜ç¨‹åºçš„è¿è¡Œé€Ÿåº¦ã€‚<br />
go-torch<br />
é™¤äº†ç›´æ¥ä½¿ç”¨go tool pprofå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨æ›´åŠ ç›´è§‚äº†ç«ç„°å›¾ ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨go-torchæ¥ç”Ÿæˆgolangç¨‹åºçš„ç«ç„°å›¾ï¼Œè¯¥å·¥å…·ä¹Ÿç›´æ¥ ä¾èµ–pprof/go tool pprofç­‰ã€‚è¯¥å·¥å…·çš„ç›¸å…³å®‰è£…è¯·çœ‹è¯¥é¡¹ç›®çš„ä»‹ç»ã€‚è¯¥è½¯ä»¶çš„ a4daa2b ä»¥åç‰ˆæœ¬æ‰æ”¯æŒå†…å­˜çš„profilingã€‚</p><br />
<br />
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨</p><br />
<br />
<p>go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem<br />
go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem<br />
æ³¨æ„:-alloc_space/-inuse_spaceå‚æ•°ä¸-u/-bç­‰å‚æ•°æœ‰å†²çªï¼Œä½¿ç”¨äº†-alloc_space/-inuse_spaceåè¯·å°†pprofçš„ èµ„æºç›´æ¥è¿½åŠ åœ¨å‚æ•°åé¢ï¼Œè€Œä¸è¦ä½¿ç”¨-u/-bå‚æ•°å»æŒ‡å®šï¼Œè¿™ä¸go-torchçš„å‚æ•°è§£æé—®é¢˜æœ‰å…³ï¼Œçœ‹è¿‡å…¶æºç åæ—¢èƒ½æ˜ç™½ã€‚ åŒæ—¶è¿˜è¦æ³¨æ„ï¼Œåˆ†æå†…å­˜çš„URLä¸€å®šæ˜¯heapç»“å°¾çš„ï¼Œå› ä¸ºé»˜è®¤è·¯å¾„æ˜¯profileçš„ï¼Œå…¶ç”¨æ¥åˆ†æcpuç›¸å…³é—®é¢˜ã€‚</p><br />
<br />
<p>é€šè¿‡ä¸Šé¢2ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°alloc_space/inuse_spaceå«ä¹‰çš„2ä¸ªç«ç„°å›¾ï¼Œä¾‹å¦‚ alloc_space.svg/inuse_space.svgã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è§‚å¯Ÿè¿™2å¼ å›¾ï¼Œè¿™å¼ å›¾ï¼Œå°±åƒä¸€ä¸ªå±±è„‰çš„æˆªé¢å›¾ï¼Œä»ä¸‹è€Œä¸Šæ˜¯æ¯ä¸ªå‡½æ•°çš„è°ƒç”¨æ ˆï¼Œå› æ­¤å±±çš„é«˜åº¦è·Ÿå‡½æ•° è°ƒç”¨çš„æ·±åº¦æ­£ç›¸å…³ï¼Œè€Œå±±çš„å®½åº¦è·Ÿä½¿ç”¨/åˆ†é…å†…å­˜çš„æ•°é‡æˆæ­£æ¯”ã€‚æˆ‘ä»¬åªéœ€è¦ç•™æ„é‚£äº›å®½è€Œå¹³çš„å±±é¡¶ï¼Œè¿™äº›éƒ¨åˆ†é€šå¸¸æ˜¯æˆ‘ä»¬ éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚</p><br />
<br />
<p>testing<br />
å½“æˆ‘ä»¬éœ€è¦å¯¹go testä¸­æŸäº›test/benchmarkè¿›è¡Œprofilingæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„æ–¹æ³•ã€‚ä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å…ˆä½¿ç”¨go test å†…ç½®çš„å‚æ•°ç”Ÿæˆpprofæ•°æ®ï¼Œç„¶åå€ŸåŠ©go tool pprof/go-torchæ¥åˆ†æã€‚</p><br />
<br />
<p>ç”Ÿæˆcpuã€memçš„pprofæ–‡ä»¶<br />
go test -bench=BenchmarkStorageXXX -cpuprofile cpu.out -memprofile mem.out<br />
æ­¤æ—¶ä¼šç”Ÿæˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶å’Œ2ä¸ªpprofæ•°æ®æ–‡ä»¶ï¼Œä¾‹å¦‚<br />
storage.test cpu.out mem.out<br />
ç„¶åä½¿ç”¨go-torchæ¥åˆ†æï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ”¾å‰é¢<br />
#åˆ†æcpu<br />
go-torch storage.test cpu.out<br />
#åˆ†æå†…å­˜<br />
go-torch â€“colors=mem -alloc_space storage.test mem.out<br />
go-torch â€“colors=mem -inuse_space storage.test mem.out<br />
ä¼˜åŒ–å»ºè®®<br />
Debugging performance issues in Go programs æä¾›äº†ä¸€äº›å¸¸ç”¨çš„ä¼˜åŒ–å»ºè®®:</p><br />
<br />
<p>1 å°†å¤šä¸ªå°å¯¹è±¡åˆå¹¶æˆä¸€ä¸ªå¤§çš„å¯¹è±¡<br />
2 å‡å°‘ä¸å¿…è¦çš„æŒ‡é’ˆé—´æ¥å¼•ç”¨ï¼Œå¤šä½¿ç”¨copyå¼•ç”¨<br />
ä¾‹å¦‚ä½¿ç”¨bytes.Bufferä»£æ›¿*bytes.Bufferï¼Œå› ä¸ºä½¿ç”¨æŒ‡é’ˆæ—¶ï¼Œä¼šåˆ†é…2ä¸ªå¯¹è±¡æ¥å®Œæˆå¼•ç”¨ã€‚</p><br />
<br />
<p>3 å±€éƒ¨å˜é‡é€ƒé€¸æ—¶ï¼Œå°†å…¶èšåˆèµ·æ¥<br />
è¿™ä¸€ç‚¹ç†è®ºè·Ÿ1ç›¸åŒï¼Œæ ¸å¿ƒåœ¨äºå‡å°‘objectçš„åˆ†é…ï¼Œå‡å°‘gcçš„å‹åŠ›ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç </p><br />
<br />
<p>for k, v := range m {<br />
	k, v := k, v   // copy for capturing by the goroutine<br />
	go func() {<br />
		// use k and v<br />
	}()<br />
}<br />
å¯ä»¥ä¿®æ”¹ä¸º:</p><br />
<br />
<p>for k, v := range m {<br />
	x := struct{ k, v string }{k, v}   // copy for capturing by the goroutine<br />
	go func() {<br />
		// use x.k and x.v<br />
	}()<br />
}<br />
ä¿®æ”¹åï¼Œé€ƒé€¸çš„å¯¹è±¡å˜ä¸ºäº†xï¼Œå°†kï¼Œv2ä¸ªå¯¹è±¡å‡å°‘ä¸º1ä¸ªå¯¹è±¡ã€‚</p><br />
<br />
<p>4 []byteçš„é¢„åˆ†é…<br />
å½“æˆ‘ä»¬æ¯”è¾ƒæ¸…æ¥šçš„çŸ¥é“[]byteä¼šåˆ°åº•ä½¿ç”¨å¤šå°‘å­—èŠ‚ï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡‡ç”¨ä¸€ä¸ªæ•°ç»„æ¥é¢„åˆ†é…è¿™æ®µå†…å­˜ã€‚ ä¾‹å¦‚:</p><br />
<br />
<p>type X struct {<br />
    buf      []byte<br />
    bufArray [16]byte // Buf usually does not grow beyond 16 bytes.<br />
}</p><br />
<br />
<p>func MakeX() *X {<br />
    x := &amp;X{}<br />
    // Preinitialize buf with the backing array.<br />
    x.buf = x.bufArray[:0]<br />
    return x<br />
}<br />
5 å°½å¯èƒ½ä½¿ç”¨å­—èŠ‚æ•°å°‘çš„ç±»å‹<br />
å½“æˆ‘ä»¬çš„ä¸€äº›constæˆ–è€…è®¡æ•°å­—æ®µä¸éœ€è¦å¤ªå¤§çš„å­—èŠ‚æ•°æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥å°†å…¶å£°æ˜ä¸ºint8ç±»å‹ã€‚</p><br />
<br />
<p>6 å‡å°‘ä¸å¿…è¦çš„æŒ‡é’ˆå¼•ç”¨<br />
å½“ä¸€ä¸ªå¯¹è±¡ä¸åŒ…å«ä»»ä½•æŒ‡é’ˆï¼ˆæ³¨æ„ï¼šstringsï¼Œslicesï¼Œmaps å’ŒchansåŒ…å«éšå«çš„æŒ‡é’ˆï¼‰ï¼Œæ—¶ï¼Œå¯¹gcçš„æ‰«æå½±å“å¾ˆå°ã€‚ æ¯”å¦‚ï¼Œ1GB byte çš„sliceäº‹å®ä¸ŠåªåŒ…å«æœ‰é™çš„å‡ ä¸ªobjectï¼Œä¸ä¼šå½±å“åƒåœ¾æ”¶é›†æ—¶é—´ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°½å¯èƒ½çš„å‡å°‘æŒ‡é’ˆçš„å¼•ç”¨ã€‚</p><br />
<br />
<p>7 ä½¿ç”¨sync.Poolæ¥ç¼“å­˜å¸¸ç”¨çš„å¯¹è±¡</p><br />
<br />
<p>Go å¸¸è§å†…å­˜æ³„æ¼çš„æƒ…å†µ<br />
Goç¨‹åºå¯èƒ½ä¼šåœ¨ä¸€äº›æƒ…å†µä¸‹é€ æˆå†…å­˜æ³„æ¼ã€‚go101ç½‘ç«™æ€»ç»“äº†å„ç§å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œæˆ‘åœ¨è¿™é‡Œç®€å•ç½—åˆ—ä¸€ä¸‹ï¼š</p><br />
<br />
<p>è·å–é•¿å­—ç¬¦ä¸²ä¸­çš„ä¸€æ®µå¯¼è‡´é•¿å­—ç¬¦ä¸²æœªé‡Šæ”¾<br />
åŒæ ·ï¼Œè·å–é•¿sliceä¸­çš„ä¸€æ®µå¯¼è‡´é•¿sliceæœªé‡Šæ”¾<br />
åœ¨é•¿sliceæ–°å»ºsliceå¯¼è‡´æ³„æ¼<br />
goroutineæ³„æ¼<br />
time.Tickeræœªå…³é—­å¯¼è‡´æ³„æ¼<br />
Finalizerå¯¼è‡´æ³„æ¼<br />
Deferring Function Callå¯¼è‡´æ³„æ¼<br />
å†…å­˜å›æ”¶åˆ†æ<br />
å®é™…é—®é¢˜<br />
å†™è¿™ç¯‡æ–‡ç« çš„åˆè¡·æ˜¯æˆ‘åœ¨å®ç°ä¸€ä¸ªæ–°é¡¹ç›®çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªé—®é¢˜ã€‚è¿™ä¸ªé¡¹ç›®ä½¿ç”¨äº†ä¸€ä¸ªç¼“å­˜ç»„ä»¶å¯¹è¯·æ±‚çš„ç»“æœè¿›è¡Œç¼“å­˜ï¼Œä»¥æé«˜è¯·æ±‚çš„è€—æ—¶ã€‚è¿™ä¸ªç¼“å­˜ç»„ä»¶å¯¹ä½¿ç”¨çš„æœ€å¤§å†…å­˜è¿›è¡Œäº†é™åˆ¶ï¼Œæ¯”å¦‚ç¼“å­˜å ç”¨çš„æœ€å¤§å†…å­˜ä¸º1GBã€‚è¿è¡Œè¿‡ç¨‹ä¸­å¯ä»¥å¯¹è¿™ä¸ªæœ€å¤§å€¼è¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥è°ƒæ•´åˆ°100MBã€‚åœ¨è°ƒæ•´çš„è¿‡ç¨‹ä¸­å‘ç°è™½ç„¶æœ€å¤§å†…å­˜ä»1GBè°ƒæ•´åˆ°100MBä¹‹åï¼Œç¨‹åºçš„RSSä¾ç„¶å ç”¨å¾ˆå¤§ï¼Œä¸€ç›´æ˜¯1GB+ ~ 2GBçš„å†…å­˜ï¼Œæ„Ÿè§‰å†…å­˜å¹¶æ²¡æœ‰é™ä¸‹å»ã€‚</p><br />
<br />
<p>å¯ä»¥çœ‹åˆ°ç¼“å­˜è°ƒå°äº†å®ƒå ç”¨çš„å†…å­˜ç¡®å®é™åˆ°å‡ ä¹ä¸º0äº†:</p><br />
<br />
<p>ä½†æ˜¯é‡Šæ”¾çš„å†…å­˜å¹¶æ²¡æœ‰è¿”å›ç»™æ“ä½œç³»ç»Ÿï¼ˆHeapReleasedï¼‰</p><br />
<br />
<p>å½“ç„¶ç»è¿‡ç›¸åº”çš„æµ‹è¯•å’Œè°ƒç ”ä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜çš„æœ€å¤§å†…å­˜å‡å°‘åå ç”¨å†…å­˜å’ŒRSSä¹Ÿä¸‹é™äº†ï¼š</p><br />
<br />
<p>ä»“ä¿ƒä¹‹é—´æˆ‘åªæˆªå–äº†å¾ˆå°ä¸€æ®µæ—¶é—´çš„æŒ‡æ ‡ï¼Œå®é™…è§‚å¯Ÿå¾ˆé•¿æ—¶é—´ä¹Ÿæ˜¯è¿™æ ·ã€‚</p><br />
<br />
<p>æµ‹è¯•ç¨‹åº<br />
æˆ‘åœ¨è¿™ä¸ªé¡¹ç›®ä¸­å®ç°äº†ä¸€ä¸ª LRUçš„cache, è¿™ä¸ªcacheåŸºäºå†…å­˜ç®¡ç†ï¼Œä¸€æ—¦ä½¿ç”¨çš„å†…å­˜è¶…è¿‡äº†MaxMemory,å°±ä¼šè‡ªåŠ¨è¿›è¡Œå†…å­˜æ¸…ç†å·¥ä½œï¼Œå°†æœ€ä¸å¸¸ç”¨çš„ç¼“å­˜é¡¹åˆ é™¤ï¼Œå…·ä½“å®ç°å¤ªé•¿å°±ä¸è´´å‡ºæ¥äº†ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯map + container/list + sync.Mutexçš„å®ç°ï¼Œå®ç°çš„æ¥å£å¦‚ä¸‹:<br />
type Cache interface {<br />
	AddValue(slot uint32, key string, value []byte)<br />
	GetAndValidate(key string, bizKey []byte) (value *CachedValue, ok bool)<br />
	SetMaxMemory(m int64)<br />
	Clear()<br />
}<br />
ç°åœ¨é€šè¿‡ä¸€ä¸ªç¨‹åºè¿›è¡Œæµ‹è¯•ï¼Œåˆ†åˆ«æµ‹è¯•æµ‹è¯•å‰ã€å¢åŠ ä¸€åƒä¸‡æ¡æ•°æ®ã€å°†æœ€å¤§å†…å­˜ä»1Gå‡å°‘åˆ°1Bã€å¼ºåˆ¶åƒåœ¾å›æ”¶å››ä¸ªåŠ¨ä½œä¹‹åçš„å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»£ç å¦‚ä¸‹:<br />
âœ  memoryleak git:(master) âœ— GODEBUG=gctrace=1 go run leak.go<br />
gc 1 @0.027s 0%: 0.009+0.43+0.009 ms clock, 0.037+0.13/0.31/0.82+0.038 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 P<br />
gc 2 @0.048s 0%: 0.005+0.40+0.003 ms clock, 0.022+0.17/0.29/0.91+0.014 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 P<br />
â€¦â€¦<br />
gc 4 @0.063s 6%: 0.003+7.8+0.028 ms clock, 0.012+0.12/6.1/15+0.11 ms cpu, 23-&gt;24-&gt;22 MB, 24 MB goal, 4 P<br />
gc 5 @0.121s 5%: 0.003+12+0.035 ms clock, 0.013+1.3/11/27+0.14 ms cpu, 42-&gt;43-&gt;40 MB, 44 MB goal, 4 P<br />
ğŸ€ before: inuse: 656 KB, idle: 63 MB, released: 0 B, heapsys: 63 MB, sys: 66 MB<br />
gc 1 @0.007s 3%: 0.031+0.94+0.013 ms clock, 0.12+0.10/0.84/0.18+0.052 ms cpu, 4-&gt;4-&gt;4 MB, 5 MB goal, 4 P<br />
gc 2 @0.013s 7%: 0.004+4.3+0.045 ms clock, 0.017+0.078/3.9/0.85+0.18 ms cpu, 7-&gt;8-&gt;8 MB, 8 MB goal, 4 P<br />
â€¦â€¦<br />
gc 17 @22.855s 6%: 0.018+517+0.011 ms clock, 0.072+105/516/11+0.047 ms cpu, 2441-&gt;2644-&gt;1368 MB, 2553 MB goal, 4 P<br />
ğŸ€ added: inuse: 1 GB, idle: 942 MB, released: 0 B, heapsys: 2 GB, sys: 2 GB, current: 1023 MB<br />
gc 18 @24.763s 6%: 0.015+87+0.009 ms clock, 0.063+6.0/83/13+0.038 ms cpu, 2568-&gt;2622-&gt;128 MB, 2737 MB goal, 4 P<br />
gc 19 @25.295s 6%: 0.014+35+0.009 ms clock, 0.056+0.41/35/64+0.037 ms cpu, 247-&gt;263-&gt;90 MB, 257 MB goal, 4 P<br />
gc 20 @25.397s 6%: 0.015+89+0.004 ms clock, 0.061+14/50/0.60+0.019 ms cpu, 173-&gt;194-&gt;95 MB, 181 MB goal, 4 P<br />
gc 21 @25.551s 6%: 0.012+59+0.010 ms clock, 0.050+17/59/0.46+0.043 ms cpu, 175-&gt;207-&gt;105 MB, 191 MB goal, 4 P<br />
ğŸ€ after decreased: inuse: 156 MB, idle: 2 GB, released: 0 B, heapsys: 2 GB, sys: 2 GB, current: 0 B<br />
gc 22 @25.651s 6%: 0.003+67+0.003 ms clock, 0.015+0/52/14+0.012 ms cpu, 156-&gt;156-&gt;74 MB, 211 MB goal, 4 P (forced)<br />
scvg-1: 2740 MB released<br />
scvg-1: inuse: 75, idle: 2740, sys: 2815, released: 2740, consumed: 75 (MB)<br />
ğŸ€ after gc: inuse: 75 MB, idle: 2 GB, released: 2 GB, heapsys: 2 GB, sys: 2 GB, current: 0 B<br />
é¦–å…ˆï¼Œæˆ‘ä»¬å¤ä¹ ä¸€ä¸‹Goåƒåœ¾å›æ”¶çš„æ—¥å¿—çš„æ„ä¹‰ï¼Œå†è¿›ä¸€æ­¥çœ‹å„ä¸ªé˜¶æ®µå†…å­˜çš„å˜åŒ–ã€‚</p><br />
<br />
<p>ä»¥è¿™ä¸€æ¡ä¸ºä¾‹:</p><br />
<br />
<p>1<br />
gc 21 @25.551s 6%: 0.012+59+0.010 ms clock, 0.050+17/59/0.46+0.043 ms cpu, 175-&gt;207-&gt;105 MB, 191 MB goal, 4 P<br />
gc 21: 21æ˜¯åƒåœ¾å›æ”¶çš„ç¼–å·ï¼Œé€æ­¥é€’å¢ï¼Œå¯èƒ½ä¼šä»1é‡æ–°å¼€å§‹<br />
@25.551s: è‡ªç¨‹åºå¼€å§‹ç»å†äº†å¤šå°‘æ—¶é—´,è¿™é‡Œæ˜¯25ç§’å¤š<br />
6%: è‡ªç¨‹åºå¯åŠ¨èŠ±åœ¨GCä¸Šçš„CPUæ—¶é—´ç™¾åˆ†æ¯”, CPU 6%èŠ±åœ¨äº†GCä¸Š<br />
0.012+59+0.010 ms clock: GCå„é˜¶æ®µçš„å¢™ä¸Šæ—¶é—´(wall-clock),å„é˜¶æ®µåŒ…æ‹¬STW sweep terminationã€concurrent mark and scanã€STW mark termination<br />
0.050+17/59/0.46+0.043 ms cpu: å„é˜¶æ®µçš„CPUæ—¶é—´ã€‚å„é˜¶æ®µåŒä¸Šï¼Œå…¶ä¸­mark/scané˜¶æ®µåˆåˆ†æˆäº†assist timeã€background GC timeå’Œidle GC timeé˜¶æ®µ<br />
175-&gt;207-&gt;105 MB: GCå¼€å§‹æ—¶ã€GCç»“æŸçš„heapå¤§å°ã€å­˜æ´»(live)çš„heapå¤§å°<br />
191 MB goal:ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶çš„ç›®æ ‡å€¼<br />
4 P: ä½¿ç”¨çš„å¤„ç†å™¨çš„æ•°é‡<br />
(forced): å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼Œ ç¨‹åºä¸­è°ƒç”¨runtime.GC()æˆ–è€…ç±»ä¼¼æ“ä½œ<br />
scvg-1: 2740 MB released: gctraceçš„å€¼å¤§äº0æ—¶ï¼Œå¦‚æœåƒåœ¾å›æ”¶å°†å†…å­˜è¿”å›ç»™æ“ä½œç³»ç»Ÿæ—¶ï¼Œä¼šæ‰“å°ä¸€æ¡summary,åŒ…æ‹¬ä¸‹ä¸€æ¡æ•°æ®<br />
é€šè¿‡å¯¹æ¯ä¸€é¡¹çš„ä»‹ç»ï¼Œä½ åº”è¯¥äº†è§£äº†go gcæ—¥å¿—çš„å«ä¹‰ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬çš„æµ‹è¯•å„é˜¶æ®µçš„å†…å­˜å ç”¨æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æ ‡è®°ğŸ€çš„æ—¥å¿—ï¼š</p><br />
<br />
<p>1<br />
2<br />
3<br />
4<br />
ğŸ€ before: inuse: 656 KB, idle: 63 MB, released: 0 B, heapsys: 63 MB, sys: 66 MB<br />
ğŸ€ added: inuse: 1 GB, idle: 942 MB, released: 0 B, heapsys: 2 GB, sys: 2 GB, current: 1023 MB<br />
ğŸ€ after decreased: inuse: 156 MB, idle: 2 GB, released: 0 B, heapsys: 2 GB, sys: 2 GB, current: 0 B<br />
ğŸ€ after gc: inuse: 75 MB, idle: 2 GB, released: 2 GB, heapsys: 2 GB, sys: 2 GB, current: 0 B<br />
åœ¨ç¨‹åºåˆšå¯åŠ¨æ—¶ï¼Œå†…å­˜å ç”¨å¾ˆå°ï¼Œ çœŸæ­£inuseä¸åˆ°1MBã€‚<br />
æˆ‘ä»¬å¢åŠ äº†ä¸Šä¸‡æ¡æ•°æ®ï¼Œæ¯æ¡æ•°æ®å…‰æ•°å°±1KB,å¦‚æœåŠ ä¸Škeyçš„å¤§å°ï¼Œä»¥åŠç®¡ç†cacheçš„ä¸€äº›æ•°æ®ç»“æ„çš„é¢å¤–å¼€é”€ï¼Œå ç”¨å°±æ¯”è¾ƒå¤§äº†ï¼Œç²—ç•¥ç»Ÿè®¡inuseçš„å ç”¨å°±è¾¾åˆ°äº†1GBä»¥ä¸Šï¼Œidleçš„spançš„å­—èŠ‚æ•°ä¸åˆ°1GB,ä»æ“ä½œç³»ç»Ÿè·å¾—äº†2GBçš„å†…å­˜ï¼Œæ²¡æœ‰å†…å­˜è¿”å›ã€‚å¯ä»¥çœ‹åˆ°cacheä½¿ç”¨çš„å†…å­˜ç²—ç®—ä¸º1023MBã€‚<br />
æˆ‘ä»¬å°†cacheçš„æœ€å¤§å†…å­˜è®¾ç½®ä¸º1B,è¿™ä¼šè§¦å‘cacheå¯¹è±¡çš„æ¸…ç†å·¥ä½œï¼Œå› ä¸ºæœ€å¤§å†…å­˜å¾ˆå°ï¼Œå¯¼è‡´åç»­çš„å¢åŠ ç¼“å­˜æ“ä½œå®é™…å¹¶ä¸ä¼šç¼“å­˜å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ç¼“å­˜çš„å®é™…å¤§å°ä¸º0Bã€‚å¯ä»¥çœ‹åˆ°inuseè®²åˆ°äº†156MB,æˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹ä½œé¢å¤–çš„ä¸€äº›å¼€é”€ï¼Œå®é™…ä¸Šå¼€å§‹æ·»åŠ çš„å¯¹è±¡éƒ½è¢«å›æ”¶æ‰äº†ã€‚idle spançš„å­—èŠ‚æ•°è¾¾åˆ°äº†2GB,ä½†æ˜¯å¹¶æ²¡æœ‰å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚è¿™ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿè®¤ä¸ºè¿™ä¸ªç¨‹åºå ç”¨å†…å­˜è¾¾åˆ°2GB,linuxæœåŠ¡å™¨ä¸Šæœ‰å¯èƒ½ä¼šå¯¼è‡´OOM killeræ€æ‰è¿™ä¸ªç¨‹åºã€‚<br />
æˆ‘ä»¬è¿›è¡Œäº†ä¸€æ¬¡å¼ºåˆ¶åƒåœ¾å›æ”¶(å®é™…è°ƒç”¨debug.FreeOSMemory()ï¼Œå®ƒä¼šè¿›è¡Œä¸€æ¬¡å¼ºåˆ¶åƒåœ¾å›æ”¶)ï¼Œå¯ä»¥çœ‹åˆ°è™½ç„¶idle spançš„å€¼è¿˜æ˜¯2GB+,ä½†æ˜¯å®é™…å…¶ä¸­çš„2GB+çš„å¤§å°è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿäº†ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™ä½ èƒ½å¤Ÿé€šè¿‡topè§‚å¯Ÿç¨‹åºçš„å†…å­˜ä½¿ç”¨çš„è¯ï¼Œå¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºçš„RESå ç”¨å¾ˆå°äº†ã€‚<br />
topå‘½ä»¤ä¸­å…³äºç¨‹åºä½¿ç”¨å†…å­˜çš„é¡¹ä»‹ç»ï¼š</p><br />
<br />
<p>%MEMï¼šMemory usage (RES) å†…å­˜å ç”¨<br />
ä½¿ç”¨çš„ç‰©ç†å†…å­˜</p><br />
<br />
<p>VIRTï¼šVirtual Image (kb) è™šæ‹Ÿé•œåƒ<br />
æ€»è™šæ‹Ÿå†…å­˜çš„ä½¿ç”¨æ•°é‡</p><br />
<br />
<p>SWAPï¼šSwapped size (kb)<br />
éé©»ç•™ä½†æ˜¯å­˜åœ¨äºç¨‹åºä¸­çš„å†…å­˜ï¼Œè™šæ‹Ÿå†…å­˜å‡å»ç‰©ç†å†…å­˜</p><br />
<br />
<p>RESï¼šResident size (kb)<br />
éswapçš„ç‰©ç†å†…å­˜</p><br />
<br />
<p>SHRï¼šShared Mem size (kb)<br />
ç¨‹åºä½¿ç”¨çš„å…±äº«å†…å­˜ï¼Œå¯ä»¥è¢«å…¶å®ƒè¿›ç¨‹æ‰€å…±äº«</p><br />
<br />
<p>å¯ä»¥çœ‹åˆ°ï¼Œå½“å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™ï¼Œé‡Šæ”¾å‡ºæ¥çš„å†…å­˜å¹¶æ²¡æœ‰ç«‹å³è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè€Œåœ¨æˆ‘ä»¬è¿›è¡Œäº†ä¸€æ¬¡å¼ºåˆ¶åƒåœ¾å›æ”¶åæ‰è¿”è¿˜ã€‚ Goè¯­è¨€æŠŠè¿”è¿˜çš„è¿‡ç¨‹å«åšscavenging (æ‹¾è’)ã€‚è¿™ä¸ªæ‹¾è’çš„ç®—æ³•ä¸€ç›´åœ¨æ¼”åŒ–ï¼Œå¯ä»¥æŸ¥çœ‹issue #16930ï¼Œç›¸å…³çš„ä¼˜åŒ–ææ¡ˆå¯ä»¥å‚è€ƒ:issue #30333ã€‚</p><br />
<br />
<p>åŸå…ˆçš„scavengingæ˜¯æ¯éš”å‡ åˆ†é’Ÿ(5åˆ†é’Ÿ)æ‰§è¡Œä¸€æ¬¡æ‹¾è’æ“ä½œï¼Œä¿è¯ç¨‹åºä½¿ç”¨çš„å†…å­˜å’ŒRSSåŸºæœ¬ä¸€è‡´ã€‚åæ¥åœ¨1.11ã€1.12çš„æ¼”åŒ–è¿‡ç¨‹ä¸­ï¼Œæ”¹æˆäº†â€æ™ºèƒ½â€çš„æ‹¾è’æ“ä½œã€‚ç›®æ ‡æ˜¯å°½é‡é¿å…å…¨éƒ¨è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿå¯¼è‡´çš„å¾ˆé‡çš„é‡è·å–çš„èŠ±é”€ï¼Œä½†æ˜¯è¿™ä¹Ÿå¸¦æ¥äº†ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å½“å‰çš„æ‹¾è’è®¾è®¡å¯¹äºå¶å°”ä¸€ä¸ªå°–å³°ï¼Œå¹¶ä¸ä¼šå°†ä¸ç”¨çš„å¤§é‡å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯æœ¬æ–‡ä¸€å¼€å§‹æˆ‘åœ¨é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜åœ¨issueä¸­ä¹Ÿæœ‰è®¨è®ºï¼š</p><br />
<br />
<p>Thus, I propose the following heuristic, borrowed from #16930: retain C*max(heap goal, max(heap goal over the last N GCs))</p><br />
<br />
<p>What happens in an application that has a huge heap spike (say, an initial loading phase) and then the heap drops significantly? In particular, letâ€™s say this is drastic enough that the runtime doesnâ€™t even notice the drop until a 2 minute GC kicks in. At that scale, it could take a while for N GCs to pass, and we wonâ€™t reclaim the heap spike until they do.</p><br />
<br />
<p>This is something that came to my mind recently too. An alternative is to set a schedule to decrease the scavenge goal linearly, or according to a smoothstep function, which goes to zero over N GCs. If this schedule ever gets below C * the heap goal, we use that instead. Weâ€™ll get smoother cliffs in general and still make progress in the case you describe. Smoothstep is preferred here since we wonâ€™t over-fit to transient drops in heap size, but this also means we might be slower to react in the case you described. I prefer not to over-fit here because that carries a performance cost.</p><br />
<br />
<p>è¿™æ˜¯ä¸€ä¸ªå‘ï¼Œä¸å¹¸è¸©åˆ°äº†ã€‚æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„éœ€æ±‚å°±æ˜¯è¿ç»´äººå‘˜æœ‰æ—¶å€™å¯ä»¥å°†ç¼“å­˜ä½¿ç”¨çš„æœ€å¤§å†…å­˜è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒå°çš„æ•°ï¼Œè®¾ç½®ä¹‹åï¼Œgoè¿è¡Œæ—¶ä¸è§¦å‘æ‹¾è’äº‹ä»¶ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜è¢«å¤§é‡å ç”¨è€Œä¸è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p><br />
<br />
<p>ç›®å‰æˆ‘çš„ä¿®æ”¹æ˜¯åœ¨cacheçš„æœ€å¤§å†…å­˜è°ƒå°åæ‰§è¡Œä¸€æ¬¡debug.FreeOSMemory(),è¿™æ ·å¯ä»¥ä¿è¯ä¸ç”¨çš„ä¸€äº›å†…å­˜è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚å½“ç„¶æ‰§è¡Œè¿™ä¸ªæ“ä½œä¹Ÿæ˜¯æœ‰ä»£ä»·çš„ï¼š</p><br />
<br />
<p>Returning all free memory back to the underlying system at once is expensive, and can lead to latency spikes as it holds the heap lock through the whole process.<br />
Itâ€™s an invasive solution: you need to modify your code to call it when you need it.<br />
Reusing free chunks of memory becomes more expensive. On UNIX-y systems that means an extra page fault (which is surprisingly expensive on some systems).<br />
Go 1.13ä¸­å¯¹æ‹¾è’çš„å®ç°æœ‰è¿›è¡Œäº†æ”¹è¿›ï¼Œè€Œä¸”Go 1.13ä¹Ÿå¿«å‘å¸ƒäº†ï¼Œå‘å¸ƒä¹‹åæˆ‘å†åšè¿›ä¸€æ­¥çš„æµ‹è¯•ï¼Œå°½é‡é¿å…ä½¿ç”¨debug.FreeOSMemory()ã€‚</p><br />
<br />
<p>runtime.MemStats<br />
é€šè¿‡runtime.MemStatså¯ä»¥å®æ—¶çš„è·å–Goè¿è¡Œæ—¶çš„å†…å­˜ç»Ÿè®¡ä¿¡æ¯ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„åŒ…å«å¾ˆå¤šçš„å­—æ®µã€‚å­—æ®µè™½ç„¶å¾ˆå¤šï¼Œä½†æ˜¯ç”±äºæ–‡æ¡£è¿˜æ˜¯ä¸å¤Ÿè¯¦ç»†ï¼Œå¦‚æœæ²¡æœ‰æ·±å…¥ç†è§£Goè¯­è¨€å†…éƒ¨çš„å®ç°æ–¹å¼å’Œç›¸å…³çš„æ¦‚å¿µçš„è¯ï¼Œä¸å®¹æ˜“ç†è§£è¿™ä¸ªæ•°æ®ç»“æ„å…·ä½“çš„å«ä¹‰ï¼Œåªæ ¹æ®å­—é¢å€¼å»ç†è§£å¾ˆå®¹æ˜“è¯¯ç”¨ï¼Œ æ¯”å¦‚HeapIdleå¹¶ä¸æ˜¯Goå ç”¨çš„è¿˜æ²¡æœ‰é‡Šæ”¾çš„å†…å­˜ç©ºé—´ï¼Œå…¶ä¸­çš„HeapReleasedå…¶å®å·²ç»è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿäº†ã€‚</p><br />
<br />
<p>æˆ‘å°†å„ä¸ªå­—æ®µçš„ä¸­æ–‡è§£é‡Šåˆ—åœ¨äº†è¿™é‡Œï¼Œå¦‚æœä½ è¦ç›‘æ§goè¿è¡Œæ—¶çš„å†…å­˜ï¼Œéœ€è¦ä»”ç»†é˜…è¯»ç›¸å…³çš„å­—æ®µçš„è§£é‡Šã€‚<br />
type MemStats struct {<br />
        // å·²åˆ†é…çš„å¯¹è±¡çš„å­—èŠ‚æ•°.<br />
        //<br />
        // å’ŒHeapAllocç›¸åŒ.<br />
        Alloc uint64<br />
        // åˆ†é…çš„å­—èŠ‚æ•°ç´¯ç§¯ä¹‹å’Œ.<br />
        //<br />
        // æ‰€ä»¥å¯¹è±¡é‡Šæ”¾çš„æ—¶å€™è¿™ä¸ªå€¼ä¸ä¼šå‡å°‘.<br />
        TotalAlloc uint64<br />
        // ä»æ“ä½œç³»ç»Ÿè·å¾—çš„å†…å­˜æ€»æ•°.<br />
        //<br />
        // Sysæ˜¯ä¸‹é¢çš„XXXSyså­—æ®µçš„æ•°å€¼çš„å’Œ, æ˜¯ä¸ºå †ã€æ ˆã€å…¶å®ƒå†…éƒ¨æ•°æ®ä¿ç•™çš„è™šæ‹Ÿå†…å­˜ç©ºé—´. <br />
        // æ³¨æ„è™šæ‹Ÿå†…å­˜ç©ºé—´å’Œç‰©ç†å†…å­˜çš„åŒºåˆ«.<br />
        Sys uint64<br />
        // è¿è¡Œæ—¶åœ°å€æŸ¥æ‰¾çš„æ¬¡æ•°ï¼Œä¸»è¦ç”¨åœ¨è¿è¡Œæ—¶å†…éƒ¨è°ƒè¯•ä¸Š.<br />
        Lookups uint64<br />
        // å †å¯¹è±¡åˆ†é…çš„æ¬¡æ•°ç´¯ç§¯å’Œ.<br />
        // æ´»åŠ¨å¯¹è±¡çš„æ•°é‡ç­‰äº<code class="language-plaintext highlighter-rouge">Mallocs - Frees</code>.<br />
        Mallocs uint64<br />
        // é‡Šæ”¾çš„å¯¹è±¡æ•°.<br />
        Frees uint64<br />
        // åˆ†é…çš„å †å¯¹è±¡çš„å­—èŠ‚æ•°.<br />
        //<br />
        // åŒ…æ‹¬æ‰€æœ‰å¯è®¿é—®çš„å¯¹è±¡ä»¥åŠè¿˜æœªè¢«åƒåœ¾å›æ”¶çš„ä¸å¯è®¿é—®çš„å¯¹è±¡.<br />
        // æ‰€ä»¥è¿™ä¸ªå€¼æ˜¯å˜åŒ–çš„ï¼Œåˆ†é…å¯¹è±¡æ—¶ä¼šå¢åŠ ï¼Œåƒåœ¾å›æ”¶å¯¹è±¡æ—¶ä¼šå‡å°‘.<br />
        HeapAlloc uint64<br />
        // ä»æ“ä½œç³»ç»Ÿè·å¾—çš„å †å†…å­˜å¤§å°.<br />
        //<br />
        // è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸ºå †ä¿ç•™çš„å¤§å°ï¼ŒåŒ…æ‹¬è¿˜æ²¡æœ‰è¢«ä½¿ç”¨çš„.<br />
        // HeapSys å¯è¢«ä¼°ç®—ä¸ºå †å·²æœ‰çš„æœ€å¤§å°ºå¯¸.<br />
        HeapSys uint64<br />
        // HeapIdleæ˜¯idle(æœªè¢«ä½¿ç”¨çš„) spanä¸­çš„å­—èŠ‚æ•°.<br />
        //<br />
        // Idle spanæ˜¯æŒ‡æ²¡æœ‰ä»»ä½•å¯¹è±¡çš„span,è¿™äº›span <strong>å¯ä»¥</strong>è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œæˆ–è€…å®ƒä»¬å¯ä»¥è¢«é‡ç”¨,<br />
        // æˆ–è€…å®ƒä»¬å¯ä»¥ç”¨åšæ ˆå†…å­˜.<br />
        //<br />
        // HeapIdle å‡å» HeapReleased çš„å€¼å¯ä»¥å½“ä½œâ€å¯ä»¥è¿”å›åˆ°æ“ä½œç³»ç»Ÿä½†ç”±è¿è¡Œæ—¶ä¿ç•™çš„å†…å­˜é‡â€.<br />
        // ä»¥ä¾¿åœ¨ä¸å‘æ“ä½œç³»ç»Ÿè¯·æ±‚æ›´å¤šå†…å­˜çš„æƒ…å†µä¸‹å¢åŠ å †ï¼Œä¹Ÿå°±æ˜¯è¿è¡Œæ—¶çš„â€å°é‡‘åº“â€.<br />
        //<br />
        // å¦‚æœè¿™ä¸ªå·®å€¼æ˜æ˜¾æ¯”å †çš„å¤§å°å¤§å¾ˆå¤šï¼Œè¯´æ˜æœ€è¿‘åœ¨æ´»åŠ¨å †çš„ä¸Šæœ‰ä¸€æ¬¡å°–å³°.<br />
        HeapIdle uint64<br />
        // æ­£åœ¨ä½¿ç”¨çš„spançš„å­—èŠ‚å¤§å°.<br />
        //<br />
        // æ­£åœ¨ä½¿ç”¨çš„spanæ˜¯å€¼å®ƒè‡³å°‘åŒ…å«ä¸€ä¸ªå¯¹è±¡åœ¨å…¶ä¸­.<br />
        // HeapInuse å‡å» HeapAllocçš„å€¼æ˜¯ä¸ºç‰¹æ®Šå¤§å°ä¿ç•™çš„å†…å­˜ï¼Œä½†æ˜¯å½“å‰è¿˜æ²¡æœ‰è¢«ä½¿ç”¨.<br />
        HeapInuse uint64<br />
        // HeapReleased æ˜¯è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ç‰©ç†å†…å­˜çš„å­—èŠ‚æ•°.<br />
        //<br />
        // å®ƒç»Ÿè®¡äº†ä»idle spanä¸­è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œæ²¡æœ‰è¢«é‡æ–°è·å–çš„å†…å­˜å¤§å°.<br />
        HeapReleased uint64<br />
        // HeapObjects å®æ—¶ç»Ÿè®¡çš„åˆ†é…çš„å †å¯¹è±¡çš„æ•°é‡,ç±»ä¼¼HeapAlloc.<br />
        HeapObjects uint64<br />
        // æ ˆspanä½¿ç”¨çš„å­—èŠ‚æ•°ã€‚<br />
        // æ­£åœ¨ä½¿ç”¨çš„æ ˆspanæ˜¯æŒ‡è‡³å°‘æœ‰ä¸€ä¸ªæ ˆåœ¨å…¶ä¸­.<br />
        //<br />
        // æ³¨æ„å¹¶æ²¡æœ‰idleçš„æ ˆspan,å› ä¸ºæœªä½¿ç”¨çš„æ ˆspanä¼šè¢«è¿”è¿˜ç»™å †(HeapIdle).<br />
        StackInuse uint64<br />
        // ä»æ“ä½œç³»ç»Ÿå–å¾—çš„æ ˆå†…å­˜å¤§å°.<br />
        // ç­‰äºStackInuse å†åŠ ä¸Šä¸ºæ“ä½œç³»ç»Ÿçº¿ç¨‹æ ˆè·å¾—çš„å†…å­˜.<br />
        StackSys uint64<br />
        // åˆ†é…çš„mspanæ•°æ®ç»“æ„çš„å­—èŠ‚æ•°.<br />
        MSpanInuse uint64<br />
        // ä»æ“ä½œç³»ç»Ÿä¸ºmspanè·å–çš„å†…å­˜å­—èŠ‚æ•°.<br />
        MSpanSys uint64<br />
        // åˆ†é…çš„mcacheæ•°æ®ç»“æ„çš„å­—èŠ‚æ•°.<br />
        MCacheInuse uint64<br />
        // ä»æ“ä½œç³»ç»Ÿä¸ºmcacheè·å–çš„å†…å­˜å­—èŠ‚æ•°.<br />
        MCacheSys uint64<br />
        // åœ¨profiling bucket hash tablesä¸­çš„å†…å­˜å­—èŠ‚æ•°.<br />
        BuckHashSys uint64<br />
        // åƒåœ¾å›æ”¶å…ƒæ•°æ®ä½¿ç”¨çš„å†…å­˜å­—èŠ‚æ•°.<br />
        GCSys uint64 // Go 1.2<br />
        // off-heapçš„æ‚é¡¹å†…å­˜å­—èŠ‚æ•°.<br />
        OtherSys uint64 // Go 1.2<br />
        // ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶çš„ç›®æ ‡å¤§å°ï¼Œä¿è¯ HeapAlloc â‰¤ NextGC.<br />
        // åŸºäºå½“å‰å¯è®¿é—®çš„æ•°æ®å’ŒGOGCçš„å€¼è®¡ç®—è€Œå¾—.<br />
        NextGC uint64<br />
        // ä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶çš„æ—¶é—´.<br />
        LastGC uint64<br />
        // è‡ªç¨‹åºå¼€å§‹ STW æš‚åœçš„ç´¯ç§¯çº³ç§’æ•°.<br />
        // STWçš„æ—¶å€™é™¤äº†åƒåœ¾å›æ”¶å™¨ä¹‹å¤–æ‰€æœ‰çš„goroutineéƒ½ä¼šæš‚åœ.<br />
        PauseTotalNs uint64<br />
        // ä¸€ä¸ªå¾ªç¯bufferï¼Œç”¨æ¥è®°å½•æœ€è¿‘çš„256ä¸ªGC STWçš„æš‚åœæ—¶é—´.<br />
        PauseNs [256]uint64<br />
        // æœ€è¿‘256ä¸ªGCæš‚åœæˆªæ­¢çš„æ—¶é—´.<br />
        PauseEnd [256]uint64 // Go 1.4<br />
        // GCçš„æ€»æ¬¡æ•°.<br />
        NumGC uint32<br />
        // å¼ºåˆ¶GCçš„æ¬¡æ•°.<br />
        NumForcedGC uint32 // Go 1.8<br />
        // è‡ªç¨‹åºå¯åŠ¨åç”±GCå ç”¨çš„CPUå¯ç”¨æ—¶é—´ï¼Œæ•°å€¼åœ¨ 0 åˆ° 1 ä¹‹é—´.<br />
        // 0ä»£è¡¨GCæ²¡æœ‰æ¶ˆè€—ç¨‹åºçš„CPU. GOMAXPROCS * ç¨‹åºè¿è¡Œæ—¶é—´ç­‰äºç¨‹åºçš„CPUå¯ç”¨æ—¶é—´.<br />
        GCCPUFraction float64 // Go 1.5<br />
        // æ˜¯å¦å…è®¸GC.<br />
        EnableGC bool<br />
        // æœªä½¿ç”¨.<br />
        DebugGC bool<br />
        // æŒ‰ç…§å¤§å°è¿›è¡Œçš„å†…å­˜åˆ†é…çš„ç»Ÿè®¡,å…·ä½“å¯ä»¥çœ‹Goå†…å­˜åˆ†é…çš„æ–‡ç« ä»‹ç».<br />
        BySize [61]struct {<br />
                // Size is the maximum byte size of an object in this<br />
                // size class.<br />
                Size uint32<br />
                // Mallocs is the cumulative count of heap objects<br />
                // allocated in this size class. The cumulative bytes<br />
                // of allocation is Size*Mallocs. The number of live<br />
                // objects in this size class is Mallocs - Frees.<br />
                Mallocs uint64<br />
                // Frees is the cumulative count of heap objects freed<br />
                // in this size class.<br />
                Frees uint64<br />
        }<br />
}<br />
Goè¿è¡Œæ—¶çš„å†…å­˜åˆ†é…ç®—æ³•å¯ä»¥æŸ¥çœ‹æ–‡ç« : A visual guide to Go Memory Allocator from scratch (Golang) , æˆ–è€…ä¸­æ–‡ç¿»è¯‘: Go å†…å­˜åˆ†é…å™¨å¯è§†åŒ–æŒ‡å—ï¼Œè¿™æ˜¯ç›®å‰ç¬¬ä¸€ç¯‡å…¨é¢ä»‹ç»Goè¿è¡Œæ—¶å†…å­˜ç®¡ç†çš„æ–‡ç« ã€‚</p><br />
<br />
<p>runtime.SetGCPercent<br />
GOGCè®¾ç½®åƒåœ¾å›æ”¶çš„ç›®æ ‡ç™¾åˆ†æ¯”ã€‚ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘Goè¿è¡Œæ—¶çš„åƒåœ¾å›æ”¶æ“ä½œå‘¢ï¼Œä¸»è¦é è¿™ä¸ªå€¼ã€‚å½“è¿™æ¬¡æ–°åˆ†é…çš„æ•°æ®å’Œä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶åå­˜æ´»æ•°æ®ä¹‹æ¯”è¾¾åˆ°è¿™ä¸ªæ•°å€¼ä¹‹åå°±ä¼šè§¦å‘ä¸€æ¬¡åƒåœ¾å›æ”¶ã€‚</p><br />
<br />
<p>GOGCçš„é»˜è®¤å€¼æ˜¯100ã€‚è®¾ç½®GOGC=offä¼šç¦æ­¢åƒåœ¾å›æ”¶ã€‚</p><br />
<br />
<p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»£ç è®¾ç½®è¿™ä¸ªå‚æ•°ï¼Œè°ƒç”¨runtime.SetGCPercentè¿›è¡Œè®¾ç½®ã€‚</p><br />
<br />
<p>MADV<br />
MADVæ˜¯Linuxçš„ä¸€ä¸ªç‰¹æ€§ï¼Œï¼Œå¯ä»¥çœ‹ç›¸å…³çš„ä»‹ç»ï¼šMADV_FREE functionality</p><br />
<br />
<p>ä¸€ç›´ä»¥æ¥ go çš„ runtime åœ¨é‡Šæ”¾å†…å­˜è¿”å›åˆ°å†…æ ¸æ—¶ï¼Œåœ¨ Linux ä¸Šä½¿ç”¨çš„æ˜¯ MADV_DONTNEEDï¼Œè™½ç„¶æ•ˆç‡æ¯”è¾ƒä½ï¼Œä½†æ˜¯ä¼šè®© RSSï¼ˆresident set size å¸¸é©»å†…å­˜é›†ï¼‰æ•°é‡ä¸‹é™å¾—å¾ˆå¿«ã€‚ä¸è¿‡åœ¨ go 1.12 é‡Œä¸“é—¨é’ˆå¯¹è¿™ä¸ªåšäº†ä¼˜åŒ–ï¼Œruntime åœ¨é‡Šæ”¾å†…å­˜æ—¶ï¼Œä½¿ç”¨äº†æ›´åŠ é«˜æ•ˆçš„ MADV_FREE è€Œä¸æ˜¯ä¹‹å‰çš„ MADV_DONTNEEDã€‚è¿™æ ·å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œä¸€æ¬¡ GC åçš„å†…å­˜åˆ†é…å»¶è¿Ÿå¾—ä»¥æ”¹å–„ï¼Œruntime ä¹Ÿä¼šæ›´åŠ ç§¯æåœ°å°†é‡Šæ”¾çš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œä»¥åº”å¯¹å¤§å—å†…å­˜åˆ†é…æ— æ³•é‡ç”¨å·²å­˜åœ¨çš„å †ç©ºé—´çš„é—®é¢˜ã€‚ä¸è¿‡ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªå‰¯ä½œç”¨ï¼šRSS ä¸ä¼šç«‹åˆ»ä¸‹é™ï¼Œè€Œæ˜¯è¦ç­‰åˆ°ç³»ç»Ÿæœ‰å†…å­˜å‹åŠ›äº†ï¼Œæ‰ä¼šå»¶è¿Ÿä¸‹é™ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMADV_FREE éœ€è¦ 4.5 ä»¥åŠä»¥ä¸Šå†…æ ¸ï¼Œå¦åˆ™ runtime ä¼šç»§ç»­ä½¿ç”¨åŸå…ˆçš„ MADV_DONTNEED æ–¹å¼ã€‚å½“ç„¶ go 1.12 ä¸ºäº†é¿å…åƒè¿™æ ·ä¸€äº›é åˆ¤æ–­ RSS å¤§å°çš„è‡ªåŠ¨åŒ–æµ‹è¯•å› æ­¤å‡ºé—®é¢˜ï¼Œä¹Ÿæä¾›äº†ä¸€ä¸ª GODEBUG=madvdontneed=1 å‚æ•°å¯ä»¥å¼ºåˆ¶ runtime ç»§ç»­ä½¿ç”¨ MADV_DONTNEEDï¼šruntime: provide way to disable MADV_FREEã€‚</p><br />
<br />
<p>ç›¸å…³issueå’Œèµ„æ–™<br />
è¿™é‡Œåˆ—å‡ºäº†Goå®˜æ–¹åº“ä¸­çš„ä¸€äº›å†…å­˜æ³„æ¼ç›¸å…³çš„issue,ä»¥åŠå…³äºGoå†…å­˜æ³„æ¼çš„ä¸€äº›æ–‡ç« ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è¿›ä¸€æ­¥é˜…è¯»ã€‚</p><br />
<br />
<p>https://golang.org/pkg/runtime/#MemStats<br />
https://github.com/golang/go/issues/33684<br />
https://github.com/golang/go/issues/33376<br />
https://github.com/golang/go/issues/32284<br />
https://github.com/golang/go/issues/16843<br />
https://github.com/golang/go/issues/14521<br />
https://go101.org/article/memory-leaking.html<br />
http://play.golang.org/p/Nb39COQgxr<br />
https://www.freecodecamp.org/news/how-i-investigated-memory-leaks-in-go-using-pprof-on-a-large-codebase-4bec4325e192/<br />
https://medium.com/dm03514-tech-blog/sre-debugging-simple-memory-leaks-in-go-e0a9e6d63d4d<br />
https://github.com/golang/go/issues/16930<br />
https://github.com/golang/go/issues/30333<br />
https://go-review.googlesource.com/c/go/+/135395/<br />
https://github.com/golang/go/issues/23687<br />
https://ms2008.github.io/2019/06/30/golang-madvfree/<br />
https://golang.org/doc/go1.12#runtime</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--èµ-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">é¦–é¡µ</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">å¤æ³½æ°‘</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"åˆ†äº«åˆ°ï¼š","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // å¼€å¯å¯¹è¯æ¡†
            enable: true,
            script: {
              // æ¯ç©ºé—² 10 ç§’é’Ÿï¼Œæ˜¾ç¤ºä¸€æ¡ä¸€è¨€
              'every idle 10s': '$hitokoto$',
              // å½“è§¦æ‘¸åˆ°æ˜Ÿæ˜Ÿå›¾æ¡ˆ
              'hover .star': 'æ˜Ÿæ˜Ÿåœ¨å¤©ä¸Šè€Œä½ åœ¨æˆ‘å¿ƒé‡Œ (*/Ï‰ï¼¼*)',
              // å½“è§¦æ‘¸åˆ°è§’è‰²èº«ä½“
              'tap body': 'å“å‘€ï¼åˆ«ç¢°æˆ‘ï¼',
              // å½“è§¦æ‘¸åˆ°è§’è‰²å¤´éƒ¨
              'tap face': 'äººå®¶å·²ç»ä¸æ˜¯å°å­©å­äº†ï¼'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--æœ¬æ–‡æ¥è‡ª-->
     <script type="text/javascript">
      /* ä»…IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/næœ¬ç¯‡æ–‡ç« æ¥æºäº xiazemin çš„ æ³½æ°‘åšå®¢|https://xiazemin.github.io/MyBlog/index.html åŸæ–‡é“¾æ¥ï¼š"+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //ç»‘å®šåœ¨äº†bodyä¸Šï¼Œä¹Ÿå¯ä»¥ç»‘å®šåœ¨å…¶ä»–å¯ç”¨å…ƒç´ è¡Œï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰å…ƒç´ éƒ½æ”¯æŒcopyå’Œpastäº‹ä»¶ã€‚

     /*
$(document.body).bind({
    copy: function(event) {//copyäº‹ä»¶
        //var cpTxt = "å¤åˆ¶çš„æ•°æ®";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//å¯ä»¥è·å–ç”¨æˆ·é€‰ä¸­å¤åˆ¶çš„æ•°æ®
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//å¦åˆ™è®¾ä¸ç”Ÿæ•ˆ
    },paste: function(e) {//pasteäº‹ä»¶
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />æœ¬æ–‡æ¥æºï¼šxiazemin çš„ æ³½æ°‘åšå®¢ <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+å½“å‰é¡µé¢é“¾æ¥
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--æœ¬æ–‡æ¥è‡ª-->

</div>
  </body>

</html>