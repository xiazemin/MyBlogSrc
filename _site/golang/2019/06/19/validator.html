<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">validator</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-06-19T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jun 19, 2019</time></p>
					</div>
					 <p>https://github.com/go-validator/validator<br />
这个包怎么用的<br />
type NewUserRequest struct {<br />
	Username string <code class="language-plaintext highlighter-rouge">validate:"min=3,max=40,regexp=^[a-zA-Z]*$"</code><br />
	Name string     <code class="language-plaintext highlighter-rouge">validate:"nonzero"</code><br />
	Age int         <code class="language-plaintext highlighter-rouge">validate:"min=21"</code><br />
	Password string <code class="language-plaintext highlighter-rouge">validate:"min=8"</code><br />
}</p><br />
<br />
<p>nur := NewUserRequest{Username: “something”, Age: 20}<br />
if errs := validator.Validate(nur); errs != nil {<br />
	// values not valid, deal with errors here<br />
}<br />
使用validate作为 tag 的名字，然后以逗号分隔验证逻辑，然后对于这样的 struct 值，调用validator.Validate(nur)验证<br />
本包有 6 个内置的验证函数，并且可以手动添加自定义的验证函数<br />
我们在定义 struct 的时候可以使用validate作为 tag 的名字添加一些验证规则，然后使用validator.Validate(nur)验证数据是否满足我们定义的规则，如果不满足的话，就会返回 err<br />
<!-- more --><br />
显然第一步就是，使用reflect将每个 field 的 tag 取出来，我们规定你必须使用 validate 作为 tag 的名字，这样我们就能拿到规则了</p><br />
<br />
<p>然后我们规定多个规则使用逗号分隔，这样我们就可以对于一个 field，可以拿到一组规则了（可以是 0 个，1 个，任意多个）</p><br />
<br />
<p>接下来就是遍历获取到的规则，执行当前规则对于当前值的校验，很显然，这里有这几个因素：field 的值 + 规则</p><br />
<br />
<p>在本包里面，他把规则解释为一个函数，所以还需要有函数的参数（这里脑洞开大一点：其实不仅仅可以是函数，可以自定义语言？但是成本太大：开发成本和用户学习成本；同一个 field 的不同规则之间可以相互作用？）</p><br />
<br />
<p>ok，所以现在一个规则有这么几个因素：field 值 + 规则函数 + 规则参数</p><br />
<br />
<p>那接下来就很好办了，就是调用这个给定的规则函数，参数是 field 值 + 给定的规则参数，看看合不合法，也就是返回一个 error</p><br />
<br />
<p>甚至我们到这里已经可以猜出规则函数的函数签名了：func(v interface{}, param string) error，第一个参数是 field 值，第二个参数是规则参数</p><br />
<br />
<p>具体代码详解<br />
1 遍历<br />
使用包的入口是 validator.Validate，也就是func (mv *Validator) Validate(v interface{}) error</p><br />
<br />
<p>sv := reflect.ValueOf(v)<br />
st := reflect.TypeOf(v)<br />
这个方法里面使用reflect包遍历reflect.Type.NumField()，然后使用reflect.Type.Field(i).Tag获得了各个 field 的 tag</p><br />
<br />
<p>当然在处理反射的时候，有一些注意事项：</p><br />
<br />
<p>对于 reflect.Value.Kind() 为指针的处理方式，递归 .Elem().Interface()</p><br />
<br />
<p>if sv.Kind() == reflect.Ptr &amp;&amp; !sv.IsNil() {<br />
	return mv.Validate(sv.Elem().Interface()) // 递归<br />
}<br />
并且这里的验证只支持结构体：</p><br />
<br />
<p>reflect.Value.Kind() 需要是 reflect.Struct 或者 reflect.Interface</p><br />
<br />
<p>if sv.Kind() != reflect.Struct &amp;&amp; sv.Kind() != reflect.Interface {<br />
	return ErrUnsupported<br />
}<br />
ok，然后接下来就是遍历所有的 field 进行验证了，所有的验证规则都没有返回 err，那么就返回 nil</p><br />
<br />
<p>2 每个 field 的处理<br />
首先，只支持 exported 的字段：</p><br />
<br />
<p>if !unicode.IsUpper(rune(st.Field(i).Name[0])) {<br />
	continue<br />
}<br />
处理 field 仍然是指针：</p><br />
<br />
<p>对于 reflect.Value.Field(i).Kind() 为指针的处理方式，一直取 .Elem()</p><br />
<br />
<p>f := sv.Field(i)<br />
for f.Kind() == reflect.Ptr &amp;&amp; !f.IsNil() {<br />
	f = f.Elem()<br />
}<br />
然后获取 tag 的值（其实这里我认为应该用 lookup）</p><br />
<br />
<p>tag := st.Field(i).Tag.Get(mv.tagName)<br />
跳过 -</p><br />
<br />
<p>if tag == “-“ {<br />
	continue<br />
}<br />
然后用规则去验证，代码： err := mv.Valid(f.Interface(), tag)</p><br />
<br />
<p>然后验证 TODO，代码 mv.deepValidateCollection(f, fname, m)</p><br />
<br />
<p>结束，返回 err 或者 nil</p><br />
<br />
<p>3 处理每个 tag 不为空的 field<br />
调用func (mv *Validator) Valid(val interface{}, tags string)</p><br />
<br />
<p>这个函数是干嘛的呢：这个函数的第一个参数不要求是 struct 了，根据提供的 tag 进行验证</p><br />
<br />
<p>跳过 -</p><br />
<br />
<p>v := reflect.ValueOf(val)<br />
处理指针：对于 reflect.Value.Kind() 为指针的处理方式，递归 .Elem().Interface()</p><br />
<br />
<p>if v.Kind() == reflect.Ptr &amp;&amp; !v.IsNil() {<br />
	return mv.Valid(v.Elem().Interface(), tags)<br />
}<br />
然后调用func (mv *Validator) validateVar(v interface{}, tag string) error处理</p><br />
<br />
<p>switch v.Kind() {<br />
case reflect.Invalid:<br />
	err = mv.validateVar(nil, tags)<br />
default:<br />
	err = mv.validateVar(val, tags)<br />
}<br />
在 validateVar 中：首先将 tag 解析为 n 个规则（每个规则包括函数，函数名称，参数），然后遍历调用这些规则</p><br />
<br />
<p>for _, t := range tags {<br />
	if err := t.Fn(v, t.Param); err != nil {<br />
		errs = append(errs, err)<br />
	}<br />
}<br />
4 处理所有的 field<br />
调用func (mv *Validator) deepValidateCollection(f reflect.Value, fname string, m ErrorMap)</p><br />
<br />
<p>刚刚处理了所有 tag 不为空的 field，但是还需要处理所有的 field，比如 []AxxxStruct这个 field 的 tag 就是空，但是他里面的AxxxStruct的 tag 不为空</p><br />
<br />
<p>这个方法的最后一个参数一个 err 的 map，以在递归的过程中拿到所有的 error</p><br />
<br />
<p>在这个函数里面，需要处理三种情形：</p><br />
<br />
<p>4.1 struct，interface，ptr<br />
调用func (mv *Validator) Validate(v interface{}) error，已经在上面讲过了，就是入口函数</p><br />
<br />
<p>相当于：struct 的 struct 的 struct，递归调用 Validate 去处理</p><br />
<br />
<p>4.2 array，slice<br />
对于每个元素递归调用 deepValidateCollection</p><br />
<br />
<p>4.3 map<br />
对于 key 和 map 递归调用 deepValidateCollection</p><br />
<br />
<p>代码详解注释<br />
diff –git validator.go validator.go<br />
index a23f3ee..d1ed91c 100644<br />
— validator.go<br />
+++ validator.go<br />
@@ -1,369 +1,401 @@<br />
 // Package validator implements value validations<br />
 //<br />
 // Copyright 2014 Roberto Teixeira <a href="mailto:robteix@robteix.com">robteix@robteix.com</a><br />
 //<br />
 // Licensed under the Apache License, Version 2.0 (the “License”);<br />
 // you may not use this file except in compliance with the License.<br />
 // You may obtain a copy of the License at<br />
 //<br />
 //    http://www.apache.org/licenses/LICENSE-2.0<br />
 //<br />
 // Unless required by applicable law or agreed to in writing, software<br />
 // distributed under the License is distributed on an “AS IS” BASIS,<br />
 // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.<br />
 // See the License for the specific language governing permissions and<br />
 // limitations under the License.</p><br />
<br />
<p>package validator</p><br />
<br />
<p>import (<br />
        “errors”<br />
        “fmt”<br />
        “reflect”<br />
        “regexp”<br />
        “strings”<br />
        “unicode”<br />
 )</p><br />
<br />
<p>// TextErr is an error that also implements the TextMarshaller interface for<br />
 // serializing out to various plain text encodings. Packages creating their<br />
 // own custom errors should use TextErr if they’re intending to use serializing<br />
 // formats like json, msgpack etc.<br />
 type TextErr struct {<br />
        Err error<br />
 }</p><br />
<br />
<p>// Error implements the error interface.<br />
 func (t TextErr) Error() string {<br />
        return t.Err.Error()<br />
 }</p><br />
<br />
<p>// MarshalText implements the TextMarshaller<br />
 func (t TextErr) MarshalText() ([]byte, error) {<br />
        return []byte(t.Err.Error()), nil<br />
 }</p><br />
<br />
<p>var (<br />
        // ErrZeroValue is the error returned when variable has zero valud<br />
        // and nonzero was specified<br />
        ErrZeroValue = TextErr{errors.New(“zero value”)}<br />
        // ErrMin is the error returned when variable is less than mininum<br />
        // value specified<br />
        ErrMin = TextErr{errors.New(“less than min”)}<br />
        // ErrMax is the error returned when variable is more than<br />
        // maximum specified<br />
        ErrMax = TextErr{errors.New(“greater than max”)}<br />
        // ErrLen is the error returned when length is not equal to<br />
        // param specified<br />
        ErrLen = TextErr{errors.New(“invalid length”)}<br />
        // ErrRegexp is the error returned when the value does not<br />
        // match the provided regular expression parameter<br />
        ErrRegexp = TextErr{errors.New(“regular expression mismatch”)}<br />
        // ErrUnsupported is the error error returned when a validation rule<br />
        // is used with an unsupported variable type<br />
        ErrUnsupported = TextErr{errors.New(“unsupported type”)}<br />
        // ErrBadParameter is the error returned when an invalid parameter<br />
        // is provided to a validation rule (e.g. a string where an int was<br />
        // expected (max=foo,len=bar) or missing a parameter when one is required (len=))<br />
        ErrBadParameter = TextErr{errors.New(“bad parameter”)}<br />
        // ErrUnknownTag is the error returned when an unknown tag is found<br />
        ErrUnknownTag = TextErr{errors.New(“unknown tag”)}<br />
        // ErrInvalid is the error returned when variable is invalid<br />
        // (normally a nil pointer)<br />
        ErrInvalid = TextErr{errors.New(“invalid value”)}<br />
 )</p><br />
<br />
<p>// ErrorMap is a map which contains all errors from validating a struct.<br />
 type ErrorMap map[string]ErrorArray</p><br />
<br />
<p>// ErrorMap implements the Error interface so we can check error against nil.<br />
 // The returned error is if existent the first error which was added to the map.<br />
 func (err ErrorMap) Error() string {<br />
        for k, errs := range err {<br />
                if len(errs) &gt; 0 {<br />
                        return fmt.Sprintf(“%s: %s”, k, errs.Error())<br />
                }<br />
        }</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    return ""  }<br />
</code></pre></div></div><br />
<br />
<p>// ErrorArray is a slice of errors returned by the Validate function.<br />
 type ErrorArray []error</p><br />
<br />
<p>// ErrorArray implements the Error interface and returns the first error as<br />
 // string if existent.<br />
 func (err ErrorArray) Error() string {<br />
        if len(err) &gt; 0 {<br />
                return err[0].Error()<br />
        }<br />
        return “”<br />
 }</p><br />
<br />
<p>+// 上面自定义了三个error： TextErr ErrorMap ErrorArray<br />
+<br />
 // ValidationFunc is a function that receives the value of a<br />
 // field and a parameter used for the respective validation tag.<br />
 type ValidationFunc func(v interface{}, param string) error</p><br />
<br />
<p>// Validator implements a validator<br />
 type Validator struct {<br />
        // Tag name being used.</p><br />
<ul><br />
  <li>// 取field的哪个tag去验证，默认是validate<br />
tagName string<br />
// validationFuncs is a map of ValidationFuncs indexed<br />
// by their name.</li><br />
  <li>// 验证函数<br />
validationFuncs map[string]ValidationFunc<br />
 }</li><br />
</ul><br />
<br />
<p>// Helper validator so users can use the<br />
 // functions directly from the package<br />
+// 默认验证器，tag是validate，验证函数有内置的5个：nonzero len min max regexp<br />
 var defaultValidator = NewValidator()</p><br />
<br />
<p>// NewValidator creates a new Validator<br />
 func NewValidator() *Validator {<br />
        return &amp;Validator{<br />
                tagName: “validate”,<br />
                validationFuncs: map[string]ValidationFunc{<br />
                        “nonzero”: nonzero,<br />
                        “len”:     length,<br />
                        “min”:     min,<br />
                        “max”:     max,<br />
                        “regexp”:  regex,<br />
                },<br />
        }<br />
 }</p><br />
<br />
<p>// SetTag allows you to change the tag name used in structs<br />
+// 切换验证所使用的tag<br />
 func SetTag(tag string) {<br />
        defaultValidator.SetTag(tag)<br />
 }</p><br />
<br />
<p>// SetTag allows you to change the tag name used in structs<br />
 func (mv *Validator) SetTag(tag string) {<br />
        mv.tagName = tag<br />
 }</p><br />
<br />
<p>// WithTag creates a new Validator with the new tag name. It is<br />
 // useful to chain-call with Validate so we don’t change the tag<br />
 // name permanently: validator.WithTag(“foo”).Validate(t)<br />
+// 和SetTag一样，是链式调用，并且不会改变原来的验证器的tag值<br />
 func WithTag(tag string) *Validator {<br />
        return defaultValidator.WithTag(tag)<br />
 }</p><br />
<br />
<p>// WithTag creates a new Validator with the new tag name. It is<br />
 // useful to chain-call with Validate so we don’t change the tag<br />
 // name permanently: validator.WithTag(“foo”).Validate(t)<br />
 func (mv *Validator) WithTag(tag string) *Validator {<br />
        v := mv.copy()<br />
        v.SetTag(tag)<br />
        return v<br />
 }</p><br />
<br />
<p>// Copy a validator<br />
+// 克隆验证器<br />
 func (mv *Validator) copy() *Validator {<br />
        newFuncs := map[string]ValidationFunc{}<br />
        for k, f := range mv.validationFuncs {<br />
                newFuncs[k] = f<br />
        }<br />
        return &amp;Validator{<br />
                tagName:         mv.tagName,<br />
                validationFuncs: newFuncs,<br />
        }<br />
 }</p><br />
<br />
<p>// SetValidationFunc sets the function to be used for a given<br />
 // validation constraint. Calling this function with nil vf<br />
 // is the same as removing the constraint function from the list.<br />
+// 添加自定义的验证函数，或者删除某一个验证函数（函数为nil的情况）<br />
 func SetValidationFunc(name string, vf ValidationFunc) error {<br />
        return defaultValidator.SetValidationFunc(name, vf)<br />
 }</p><br />
<br />
<p>// SetValidationFunc sets the function to be used for a given<br />
 // validation constraint. Calling this function with nil vf<br />
 // is the same as removing the constraint function from the list.<br />
 func (mv *Validator) SetValidationFunc(name string, vf ValidationFunc) error {<br />
        if name == “” {<br />
                return errors.New(“name cannot be empty”)<br />
        }<br />
        if vf == nil {<br />
                delete(mv.validationFuncs, name)<br />
                return nil<br />
        }<br />
        mv.validationFuncs[name] = vf<br />
        return nil<br />
 }</p><br />
<br />
<p>// Validate validates the fields of a struct based<br />
 // on ‘validator’ tags and returns errors found indexed<br />
 // by the field name.<br />
+//<br />
+// 基于 validator 的tag对struct进行校验<br />
 func Validate(v interface{}) error {<br />
        return defaultValidator.Validate(v)<br />
 }</p><br />
<br />
<p>// Validate validates the fields of a struct based<br />
 // on ‘validator’ tags and returns errors found indexed<br />
 // by the field name.<br />
 func (mv *Validator) Validate(v interface{}) error {<br />
        sv := reflect.ValueOf(v)<br />
        st := reflect.TypeOf(v)<br />
+</p><br />
<ul><br />
  <li>// 对于 reflect.Value.Kind() 为指针的处理方式，递归 .Elem().Interface()<br />
if sv.Kind() == reflect.Ptr &amp;&amp; !sv.IsNil() {<br />
        return mv.Validate(sv.Elem().Interface())<br />
}<br />
+</li><br />
  <li><br />
    <p>// reflect.Value.Kind() 需要是 reflect.Struct 或者 reflect.Interface<br />
if sv.Kind() != reflect.Struct &amp;&amp; sv.Kind() != reflect.Interface {<br />
        return ErrUnsupported<br />
}</p><br />
  </li><br />
  <li>nfields := sv.NumField()<br />
m := make(ErrorMap)</li><br />
  <li>for i := 0; i &lt; nfields; i++ {</li><br />
  <li>// 遍历 field</li><br />
  <li>// reflect.Type.NumField()</li><br />
  <li>for i := 0; i &lt; sv.NumField(); i++ {</li><br />
  <li>// reflect.Type.Field(i)</li><br />
  <li>//                      .Name<br />
fname := st.Field(i).Name<br />
if !unicode.IsUpper(rune(fname[0])) {</li><br />
  <li><br />
    <p>// 只处理exported的field<br />
continue<br />
                }</p><br />
  </li><br />
  <li>// 对于 reflect.Value.Field(i).Kind() 为指针的处理方式，一直取 .Elem()<br />
f := sv.Field(i)</li><br />
  <li>// deal with pointers<br />
for f.Kind() == reflect.Ptr &amp;&amp; !f.IsNil() {<br />
        f = f.Elem()<br />
}</li><br />
  <li>// 获取tag： reflect.Type.Field(i).Tag.Get(name)<br />
tag := st.Field(i).Tag.Get(mv.tagName)<br />
if tag == “-“ {</li><br />
  <li><br />
    <p>// 跳过 <code class="language-plaintext highlighter-rouge">-</code><br />
continue<br />
                }<br />
                var errs ErrorArray</p><br />
  </li><br />
  <li>// 处理tag不为空的<br />
if tag != “” {</li><br />
  <li><br />
    <p>// reflect.Value.Field(i).Interface() 对应的field的值 ，以及tag的名字，使用.Valid进行校验<br />
err := mv.Valid(f.Interface(), tag)<br />
if errors, ok := err.(ErrorArray); ok {<br />
        errs = errors<br />
} else {<br />
        if err != nil {<br />
                errs = ErrorArray{err}<br />
        }<br />
}<br />
                }</p><br />
  </li><br />
  <li><br />
    <p>// TODO<br />
mv.deepValidateCollection(f, fname, m) // no-op if field is not a struct, interface, array, slice or map</p><br />
<br />
    <p>if len(errs) &gt; 0 {<br />
        m[st.Field(i).Name] = errs<br />
}<br />
        }</p><br />
  </li><br />
</ul><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if len(m) &gt; 0 {<br />
            return m<br />
    }<br />
    return nil  }<br />
</code></pre></div></div><br />
<br />
<p>func (mv *Validator) deepValidateCollection(f reflect.Value, fname string, m ErrorMap) {<br />
        switch f.Kind() {<br />
        case reflect.Struct, reflect.Interface, reflect.Ptr:</p><br />
<ul><br />
  <li>// struct的struct的struct，递归调用Validate去处理<br />
e := mv.Validate(f.Interface())<br />
if e, ok := e.(ErrorMap); ok &amp;&amp; len(e) &gt; 0 {<br />
        for j, k := range e {<br />
                m[fname+”.”+j] = k<br />
        }<br />
}<br />
        case reflect.Array, reflect.Slice:</li><br />
  <li>// 对于每个元素递归调用deepValidateCollection<br />
for i := 0; i &lt; f.Len(); i++ {<br />
        mv.deepValidateCollection(f.Index(i), fmt.Sprintf(“%s[%d]”, fname, i), m)<br />
}<br />
        case reflect.Map:</li><br />
  <li>// 对于key和map递归调用deepValidateCollection<br />
for _, key := range f.MapKeys() {<br />
        mv.deepValidateCollection(key, fmt.Sprintf(“%s<a href="key">%+v</a>”, fname, key.Interface()), m) // validate the map key<br />
        value := f.MapIndex(key)<br />
        mv.deepValidateCollection(value, fmt.Sprintf(“%s<a href="value">%+v</a>”, fname, key.Interface()), m)<br />
}<br />
        }<br />
 }</li><br />
</ul><br />
<br />
<p>// Valid validates a value based on the provided<br />
 // tags and returns errors found or nil.<br />
+// 这个验证的范围更大，可以在所有类型上验证，并且可以指定tag的值<br />
 func Valid(val interface{}, tags string) error {<br />
        return defaultValidator.Valid(val, tags)<br />
 }</p><br />
<br />
<p>// Valid validates a value based on the provided<br />
 // tags and returns errors found or nil.<br />
 func (mv *Validator) Valid(val interface{}, tags string) error {<br />
        if tags == “-“ {</p><br />
<ul><br />
  <li>// 跳过 -<br />
return nil<br />
        }<br />
        v := reflect.ValueOf(val)</li><br />
  <li>// 对于 reflect.Value.Kind() 为指针的处理方式，递归 .Elem().Interface()<br />
if v.Kind() == reflect.Ptr &amp;&amp; !v.IsNil() {<br />
        return mv.Valid(v.Elem().Interface(), tags)<br />
}<br />
var err error<br />
switch v.Kind() {<br />
case reflect.Invalid:<br />
        err = mv.validateVar(nil, tags)<br />
default:<br />
        err = mv.validateVar(val, tags)<br />
}<br />
return err<br />
 }</li><br />
</ul><br />
<br />
<p>// validateVar validates one single variable<br />
 func (mv *Validator) validateVar(v interface{}, tag string) error {<br />
        tags, err := mv.parseTags(tag)<br />
        if err != nil {<br />
                // unknown tag found, give up.<br />
                return err<br />
        }<br />
        errs := make(ErrorArray, 0, len(tags))<br />
        for _, t := range tags {<br />
                if err := t.Fn(v, t.Param); err != nil {<br />
                        errs = append(errs, err)<br />
                }<br />
        }<br />
        if len(errs) &gt; 0 {<br />
                return errs<br />
        }<br />
        return nil<br />
 }</p><br />
<br />
<p>// tag represents one of the tag items<br />
+// 一个tag计算式，有名字，函数，参数<br />
 type tag struct {<br />
        Name  string         // name of the tag<br />
        Fn    ValidationFunc // validation function to call<br />
        Param string         // parameter to send to the validation function<br />
 }</p><br />
<br />
<p>// separate by no escaped commas<br />
 var sepPattern *regexp.Regexp = regexp.MustCompile(<code class="language-plaintext highlighter-rouge">((?:^|[^\\])(?:\\\\)*),</code>)</p><br />
<br />
<p>func splitUnescapedComma(str string) []string {<br />
        ret := []string{}<br />
        indexes := sepPattern.FindAllStringIndex(str, -1)<br />
        last := 0<br />
        for _, is := range indexes {<br />
                ret = append(ret, str[last:is[1]-1])<br />
                last = is[1]<br />
        }<br />
        ret = append(ret, str[last:])<br />
        return ret<br />
 }</p><br />
<br />
<p>// parseTags parses all individual tags found within a struct tag.<br />
 func (mv *Validator) parseTags(t string) ([]tag, error) {<br />
        tl := splitUnescapedComma(t)</p><br />
<ul><br />
  <li><br />
    <p>fmt.Printf(“tl %v\n”, tl)<br />
tags := make([]tag, 0, len(tl))<br />
for _, i := range tl {<br />
        i = strings.Replace(i, <code class="language-plaintext highlighter-rouge">\,</code>, “,”, -1)<br />
        tg := tag{}<br />
        v := strings.SplitN(i, “=”, 2)<br />
        tg.Name = strings.Trim(v[0], “ “)<br />
        if tg.Name == “” {<br />
                return []tag{}, ErrUnknownTag<br />
        }<br />
        if len(v) &gt; 1 {<br />
                tg.Param = strings.Trim(v[1], “ “)<br />
        }<br />
        var found bool<br />
        if tg.Fn, found = mv.validationFuncs[tg.Name]; !found {<br />
                return []tag{}, ErrUnknownTag<br />
        }<br />
        tags = append(tags, tg)</p><br />
<br />
    <p>}<br />
return tags, nil<br />
 }</p><br />
  </li><br />
</ul><br />
<br />
<p>从字段校验的需求来讲，无论我们采用深度优先搜索还是广度优先搜索来对这棵结构体树来进行遍历，都是可以的。</p><br />
<br />
<p>通过golang的structTag来配置验证器<br />
type Class struct {<br />
    Cid       int64  <code class="language-plaintext highlighter-rouge">validate:"required||integer=10000,_"</code><br />
    Cname     string <code class="language-plaintext highlighter-rouge">validate:"required||string=1,5||unique"</code><br />
    BeginTime string <code class="language-plaintext highlighter-rouge">validate:"required||datetime=H:i"</code><br />
}</p><br />
<br />
<p>type Student struct {<br />
    Uid          int64    <code class="language-plaintext highlighter-rouge">validate:"required||integer=10000,_"</code><br />
    Name         string   <code class="language-plaintext highlighter-rouge">validate:"required||string=1,5"</code><br />
    Age          int64    <code class="language-plaintext highlighter-rouge">validate:"required||integer=10,30"</code><br />
    Sex          string   <code class="language-plaintext highlighter-rouge">validate:"required||in=male,female"</code><br />
    Email        string   <code class="language-plaintext highlighter-rouge">validate:"email||user||vm"</code><br />
    PersonalPage string   <code class="language-plaintext highlighter-rouge">validate:"url"</code><br />
    Hobby        []string <code class="language-plaintext highlighter-rouge">validate:"array=_,2||unique||in=swimming,running,drawing"</code><br />
    CreateTime   string   <code class="language-plaintext highlighter-rouge">validate:"datetime"</code><br />
    Class        []Class  <code class="language-plaintext highlighter-rouge">validate:"array=1,3"</code><br />
}<br />
required 判断字段对应的值是否是对应类型的零值<br />
integer 表示字段类型是否是整数类型，如果integer后边不接=?,?，那么表示只判断是否是整数类型，如果后边接=?,?，那么有四种写法<br />
(1). integer=10 表示字段值 = 10<br />
(2). integer=_ ,10 表示字段值 &lt;= 10，字段值最小值为字段对应类型的最小值(比如字段对应类型为int8，那么最小为−128)，最大值为10<br />
(3). integer=10, _ 表示字段值 &gt;= 10，字段值最小值为10，最大值为字段对应类型的最大值(比如字段对应类型为int8，那么最大为127)<br />
(4). integer=1,20 表示字段值 &gt;=1 并且 &lt;= 20<br />
array、string 同 integer，array=?,? 表示元素个数范围，string=?,? 表示字符串长度范围<br />
email 表示字段值是否是合法的email地址<br />
url 表示字段值是否是合法的url地址<br />
in 表示字段值在in指定的值中，比如 Hobby 字段中，in=swimming,running,drawing，表示 Hobby 字段的值，只能是swimming,running,drawing中的一个或多个<br />
datetime 表示字段值符合日期类型，如果datetime后边不接=?，那么默认为Y-m-d H:i:s，否则验证器会按照指定格式判断，比如 datetime=Y-m、datetime=Y/m/d H:i:s等，可以是Y m d H i s 的随意拼接<br />
unique 表示字段值唯一，比如 Hobby 字段的 unique，表示 Hobby 字段值唯一，Class 中，Cname 字段的 unique，表示 Cname 字段值唯一</p><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>