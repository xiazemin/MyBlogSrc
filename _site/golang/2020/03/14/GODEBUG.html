<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">GODEBUG</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-03-14T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Mar 14, 2020</time></p>
					</div>
					 <p>GODEBUG 变量可以控制运行时内的调试变量，参数以逗号分隔，格式为：name=val。<br />
https://github.com/mailgun/godebug 是一个跨平台的调试包 <br />
godebug是一个跨平台的Go程序调试工具，传统的编译型语言调试器使用底层系统调用并读取二进制文件用于调试各类符号。使用起来很麻烦而且很难移植。</p><br />
<br />
<p>godebug使用不同的方法，直接把源码作为目标程序，在每一行插入调试代码，然后编译并运行。结果就是一个全功能的调试器，完全可以移植到不同平台。事实上，由于有了gopherjs ，你也可以在浏览器上进行调试：<br />
第一次godebug插入调试instrumentation，然后gopherjs将结果编译成JavaScript。</p><br />
<br />
<p>让我们看一下instrumentation步骤，以下是godebug插入的调用：</p><br />
<br />
<p>godebug.EnterFunc：让godebug运行时库知道我们在进入一个函数。由于“next”不停止内部函数调用，运行时库注意这些调用并知道何时跳过这些行。<br />
godebug.ExitFunc：让godebug运行时库知道我们在离开一个函数，main中省略。<br />
godebug运行时库：当且仅当用户用命令或一个断点告知其时，使程序暂停并等待输入，暂停时，它会提示用户输入并响应任何命令。<br />
godebug.Declare：记录变量名和值的映射。该映射通过输出命令使用。<br />
<!-- more --><br />
让 Go 更强大的原因之一莫过于它的 GODEBUG 工具，GODEBUG 的设置可以让 Go 程序在运行时输出调试信息，可以根据你的要求很直观的看到你想要的调度器或垃圾回收等详细信息，并且还不需要加装其它的插件，非常方便，今天我们将先讲解 GODEBUG 的调度器相关内容，希望对你有所帮助。</p><br />
<br />
<p>不过在开始前，没接触过的小伙伴得先补补如下前置知识，便于更好的了解调试器输出的信息内容。</p><br />
<br />
<p>前置知识<br />
Go scheduler 的主要功能是针对在处理器上运行的 OS 线程分发可运行的 Goroutine，而我们一提到调度器，就离不开三个经常被提到的缩写，分别是：</p><br />
<br />
<p>G：Goroutine，实际上我们每次调用 go func 就是生成了一个 G。</p><br />
<br />
<p>P：处理器，一般为处理器的核数，可以通过 GOMAXPROCS 进行修改。</p><br />
<br />
<p>M：OS 线程</p><br />
<br />
<p>这三者交互实际来源于 Go 的 M: N 调度模型，也就是 M 必须与 P 进行绑定，然后不断地在 M 上循环寻找可运行的 G 来执行相应的任务，如果想具体了解可以详细阅读 《Go Runtime Scheduler》<br />
当我们执行 go func() 时，实际上就是创建一个全新的 Goroutine，我们称它为 G。</p><br />
<br />
<p>新创建的 G 会被放入 P 的本地队列（Local Queue）或全局队列（Global Queue）中，准备下一步的动作。</p><br />
<br />
<p>唤醒或创建 M 以便执行 G。</p><br />
<br />
<p>不断地进行事件循环</p><br />
<br />
<p>寻找在可用状态下的 G 进行执行任务</p><br />
<br />
<p>清除后，重新进入事件循环</p><br />
<br />
<p>而在描述中有提到全局和本地这两类队列，其实在功能上来讲都是用于存放正在等待运行的 G，但是不同点在于，本地队列有数量限制，不允许超过 256 个。并且在新建 G 时，会优先选择 P 的本地队列，如果本地队列满了，则将 P 的本地队列的一半的 G 移动到全局队列，这其实可以理解为调度资源的共享和再平衡。</p><br />
<br />
<p>另外我们可以看到图上有 steal 行为，这是用来做什么的呢，我们都知道当你创建新的 G 或者 G 变成可运行状态时，它会被推送加入到当前 P 的本地队列中。但其实当 P 执行 G 完毕后，它也会 “干活”，它会将其从本地队列中弹出 G，同时会检查当前本地队列是否为空，如果为空会随机的从其他 P 的本地队列中尝试窃取一半可运行的 G 到自己的名下。</p><br />
<br />
<p>在这个例子中，P2 在本地队列中找不到可以运行的 G，它会执行 work-stealing 调度算法，随机选择其它的处理器 P1，并从 P1 的本地队列中窃取了三个 G 到它自己的本地队列中去。至此，P1、P2 都拥有了可运行的 G，P1 多余的 G 也不会被浪费，调度资源将会更加平均的在多个处理器中流转。</p><br />
<br />
<p>GODEBUG<br />
GODEBUG 变量可以控制运行时内的调试变量，参数以逗号分隔，格式为：name=val。本文着重点在调度器观察上，将会使用如下两个参数：</p><br />
<br />
<p>schedtrace：设置 schedtrace=X 参数可以使运行时在每 X 毫秒发出一行调度器的摘要信息到标准 err 输出中。</p><br />
<br />
<p>scheddetail：设置 schedtrace=X 和 scheddetail=1 可以使运行时在每 X 毫秒发出一次详细的多行信息，信息内容主要包括调度程序、处理器、OS 线程 和 Goroutine 的状态。<br />
package main</p><br />
<br />
<p>import “sync”</p><br />
<br />
<p>func main() {<br />
	wg := sync.WaitGroup{}<br />
	wg.Add(10)<br />
	for i := 0; i&lt;10; i++{<br />
		go func(wg *sync.WaitGroup) {<br />
			var counter int<br />
			for i := 0; i &lt; 1e10; i++{<br />
				counter++<br />
			}<br />
			wg.Done()<br />
		}(&amp;wg)<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wg.Wait() }<br />
</code></pre></div></div><br />
<br />
<p>schedtrace<br />
$ GODEBUG=schedtrace=1000 ./awesomeProject<br />
SCHED 0ms: gomaxprocs=4 idleprocs=1 threads=5 spinningthreads=1 idlethreads=0 runqueue=0 [0 0 0 0]<br />
SCHED 1000ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 2000ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 3001ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 4010ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 5011ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 6012ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 [1 2 2 1]<br />
SCHED 7021ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 8023ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 9031ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 10033ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 11038ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 12044ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 13051ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=4 [0 1 1 0]<br />
SCHED 14052ms: gomaxprocs=4 idleprocs=2 threads=5</p><br />
<br />
<p>sched：每一行都代表调度器的调试信息，后面提示的毫秒数表示启动到现在的运行时间，输出的时间间隔受 schedtrace 的值影响。</p><br />
<br />
<p>gomaxprocs：当前的 CPU 核心数（GOMAXPROCS 的当前值）。</p><br />
<br />
<p>idleprocs：空闲的处理器数量，后面的数字表示当前的空闲数量。</p><br />
<br />
<p>threads：OS 线程数量，后面的数字表示当前正在运行的线程数量。</p><br />
<br />
<p>spinningthreads：自旋状态的 OS 线程数量。</p><br />
<br />
<p>idlethreads：空闲的线程数量。</p><br />
<br />
<p>runqueue：全局队列中中的 Goroutine 数量，而后面的 [0 0 1 1] 则分别代表这 4 个 P 的本地队列正在运行的 Goroutine 数量。</p><br />
<br />
<p>在上面我们有提到 “自旋线程” 这个概念，如果你之前没有了解过相关概念，一听 “自旋” 肯定会比较懵，我们引用 《Head First of Golang Scheduler》 的内容来说明：</p><br />
<br />
<p>自旋线程的这个说法，是因为 Go Scheduler 的设计者在考虑了 “OS 的资源利用率” 以及 “频繁的线程抢占给 OS 带来的负载” 之后，提出了 “Spinning Thread” 的概念。也就是当 “自旋线程” 没有找到可供其调度执行的 Goroutine 时，并不会销毁该线程 ，而是采取 “自旋” 的操作保存了下来。虽然看起来这是浪费了一些资源，但是考虑一下 syscall 的情景就可以知道，比起 “自旋”，线程间频繁的抢占以及频繁的创建和销毁操作可能带来的危害会更大。</p><br />
<br />
<p>scheddetail<br />
如果我们想要更详细的看到调度器的完整信息时，我们可以增加 scheddetail 参数，就能够更进一步的查看调度的细节逻辑，如下：<br />
$ GODEBUG=scheddetail=1,schedtrace=1000 ./awesomeProject<br />
SCHED 1000ms: gomaxprocs=4 idleprocs=0 threads=5 spinningthreads=0 idlethreads=0 runqueue=0 gcwaiting=0 nmidlelocked=0 stopwait=0 sysmonwait=0<br />
  P0: status=1 schedtick=2 syscalltick=0 m=3 runqsize=3 gfreecnt=0<br />
  P1: status=1 schedtick=2 syscalltick=0 m=4 runqsize=1 gfreecnt=0<br />
  P2: status=1 schedtick=2 syscalltick=0 m=0 runqsize=1 gfreecnt=0<br />
  P3: status=1 schedtick=1 syscalltick=0 m=2 runqsize=1 gfreecnt=0<br />
  M4: p=1 curg=18 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 spinning=false blocked=false lockedg=-1<br />
  M3: p=0 curg=22 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 spinning=false blocked=false lockedg=-1<br />
  M2: p=3 curg=24 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 spinning=false blocked=false lockedg=-1<br />
  M1: p=-1 curg=-1 mallocing=0 throwing=0 preemptoff= locks=1 dying=0 spinning=false blocked=false lockedg=-1<br />
  M0: p=2 curg=26 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 spinning=false blocked=false lockedg=-1<br />
  G1: status=4(semacquire) m=-1 lockedm=-1<br />
  G2: status=4(force gc (idle)) m=-1 lockedm=-1<br />
  G3: status=4(GC sweep wait) m=-1 lockedm=-1<br />
  G17: status=1() m=-1 lockedm=-1<br />
  G18: status=2() m=4 lockedm=-1<br />
  G19: status=1() m=-1 lockedm=-1<br />
  G20: status=1() m=-1 lockedm=-1<br />
  G21: status=1() m=-1 lockedm=-1<br />
  G22: status=2() m=3 lockedm=-1<br />
  G23: status=1() m=-1 lockedm=-1<br />
  G24: status=2() m=2 lockedm=-1<br />
  G25: status=1() m=-1 lockedm=-1</p><br />
<br />
<p>在这里我们抽取了 1000ms 时的调试信息来查看，信息量比较大，我们先从每一个字段开始了解。如下：</p><br />
<br />
<p>G<br />
status：G 的运行状态。</p><br />
<br />
<p>m：隶属哪一个 M。</p><br />
<br />
<p>lockedm：是否有锁定 M。</p><br />
<br />
<p>在第一点中我们有提到 G 的运行状态，这对于分析内部流转非常的有用，共涉及如下 9 种状态：</p><br />
<br />
<p>状态	值	含义<br />
_Gidle	0	刚刚被分配，还没有进行初始化。<br />
_Grunnable	1	已经在运行队列中，还没有执行用户代码。<br />
_Grunning	2	不在运行队列里中，已经可以执行用户代码，此时已经分配了 M 和 P。<br />
_Gsyscall	3	正在执行系统调用，此时分配了 M。<br />
_Gwaiting	4	在运行时被阻止，没有执行用户代码，也不在运行队列中，此时它正在某处阻塞等待中。<br />
_Gmoribund_unused	5	尚未使用，但是在 gdb 中进行了硬编码。<br />
_Gdead	6	尚未使用，这个状态可能是刚退出或是刚被初始化，此时它并没有执行用户代码，有可能有也有可能没有分配堆栈。<br />
_Genqueue_unused	7	尚未使用。<br />
_Gcopystack	8	正在复制堆栈，并没有执行用户代码，也不在运行队列中。<br />
在理解了各类的状态的意思后，我们结合上述案例看看，如下：</p><br />
<br />
<p>G1: status=4(semacquire) m=-1 lockedm=-1<br />
G2: status=4(force gc (idle)) m=-1 lockedm=-1<br />
G3: status=4(GC sweep wait) m=-1 lockedm=-1<br />
G17: status=1() m=-1 lockedm=-1<br />
G18: status=2() m=4 lockedm=-1<br />
在这个片段中，G1 的运行状态为 _Gwaiting，并没有分配 M 和锁定。这时候你可能好奇在片段中括号里的是什么东西呢，其实是因为该 status=4 是表示 Goroutine 在运行时时被阻止，而阻止它的事件就是 semacquire 事件，是因为 semacquire 会检查信号量的情况，在合适的时机就调用 goparkunlock 函数，把当前 Goroutine 放进等待队列，并把它设为 _Gwaiting 状态。</p><br />
<br />
<p>那么在实际运行中还有什么原因会导致这种现象呢，我们一起看看，如下：</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waitReasonZero                                    // ""<br />
waitReasonGCAssistMarking                         // "GC assist marking"<br />
waitReasonIOWait                                  // "IO wait"<br />
waitReasonChanReceiveNilChan                      // "chan receive (nil chan)"<br />
waitReasonChanSendNilChan                         // "chan send (nil chan)"<br />
waitReasonDumpingHeap                             // "dumping heap"<br />
waitReasonGarbageCollection                       // "garbage collection"<br />
waitReasonGarbageCollectionScan                   // "garbage collection scan"<br />
waitReasonPanicWait                               // "panicwait"<br />
waitReasonSelect                                  // "select"<br />
waitReasonSelectNoCases                           // "select (no cases)"<br />
waitReasonGCAssistWait                            // "GC assist wait"<br />
waitReasonGCSweepWait                             // "GC sweep wait"<br />
waitReasonChanReceive                             // "chan receive"<br />
waitReasonChanSend                                // "chan send"<br />
waitReasonFinalizerWait                           // "finalizer wait"<br />
waitReasonForceGGIdle                             // "force gc (idle)"<br />
waitReasonSemacquire                              // "semacquire"<br />
waitReasonSleep                                   // "sleep"<br />
waitReasonSyncCondWait                            // "sync.Cond.Wait"<br />
waitReasonTimerGoroutineIdle                      // "timer goroutine (idle)"<br />
waitReasonTraceReaderBlocked                      // "trace reader (blocked)"<br />
waitReasonWaitForGCCycle                          // "wait for GC cycle"<br />
waitReasonGCWorkerIdle                            // "GC worker (idle)" 我们通过以上 waitReason 可以了解到 Goroutine 会被暂停运行的原因要素，也就是会出现在括号中的事件。<br />
</code></pre></div></div><br />
<br />
<p>M<br />
p：隶属哪一个 P。</p><br />
<br />
<p>curg：当前正在使用哪个 G。</p><br />
<br />
<p>runqsize：运行队列中的 G 数量。</p><br />
<br />
<p>gfreecnt：可用的G（状态为 Gdead）。</p><br />
<br />
<p>mallocing：是否正在分配内存。</p><br />
<br />
<p>throwing：是否抛出异常。</p><br />
<br />
<p>preemptoff：不等于空字符串的话，保持 curg 在这个 m 上运行。</p><br />
<br />
<p>P<br />
status：P 的运行状态。</p><br />
<br />
<p>schedtick：P 的调度次数。</p><br />
<br />
<p>syscalltick：P 的系统调用次数。</p><br />
<br />
<p>m：隶属哪一个 M。</p><br />
<br />
<p>runqsize：运行队列中的 G 数量。</p><br />
<br />
<p>gfreecnt：可用的G（状态为 Gdead）。</p><br />
<br />
<p>状态	值	含义<br />
_Pidle	0	刚刚被分配，还没有进行进行初始化。<br />
_Prunning	1	当 M 与 P 绑定调用 acquirep 时，P 的状态会改变为 _Prunning。<br />
_Psyscall	2	正在执行系统调用。<br />
_Pgcstop	3	暂停运行，此时系统正在进行 GC，直至 GC 结束后才会转变到下一个状态阶段。<br />
_Pdead	4	废弃，不再使用。</p><br />
<br />
<p>如何开启打印gc信息<br />
只要在程序执行之前加上环境变量GODEBUG gctrace =1 ，如：<br />
GODEBUG gctrace =1 ./xxxx.exe or GODEBUG gctrace =1 go run main.go</p><br />
<br />
<p>程序将会显示gc信息，如下</p><br />
<br />
<p>gc 1 @2.104s 0%: 0.018+1.3+0.076 ms clock, 0.054+0.35/1.0/3.0+0.23 ms cpu, 4-&gt;4-&gt;3 MB, 5 MB goal, 4 P<br />
gc 2 @2.241s 0%: 0.019+2.4+0.077 ms clock, 0.079+0/2.4/6.4+0.30 ms cpu, 5-&gt;6-&gt;5 MB, 6 MB goal, 4 P<br />
gc 3 @2.510s 0%: 0.011+3.2+0.063 ms clock, 0.047+0.10/2.9/9.0+0.25 ms cpu, 11-&gt;11-&gt;10 MB, 12 MB goal, 4 P<br />
gc 4 @3.021s 0%: 0.013+6.6+0.076 ms clock, 0.053+0.34/6.2/18+0.30 ms cpu, 21-&gt;21-&gt;20 MB, 22 MB goal, 4 P<br />
gc 5 @3.725s 0%: 0.015+15+0.079 ms clock, 0.062+0.35/15/45+0.31 ms cpu, 40-&gt;40-&gt;39 MB, 41 MB goal, 4 P<br />
gc 6 @4.741s 0%: 0.008+35+0.17 ms clock, 0.035+0.19/35/100+0.70 ms cpu, 76-&gt;76-&gt;75 MB, 78 MB goal, 4 P<br />
gc 7 @6.688s 0%: 0.020+117+0.34 ms clock, 0.082+11/117/330+1.3 ms cpu, 147-&gt;148-&gt;146 MB, 151 MB goal, 4 P<br />
gc 8 @68.645s 0%: 0.019+146+0.30 ms clock, 0.078+0.006/146/407+1.2 ms cpu, 285-&gt;285-&gt;248 MB, 292 MB goal, 4 P<br />
scvg0: inuse: 426, idle: 0, sys: 427, released: 0, consumed: 427 (MB)<br />
gc 9 @175.448s 0%: 0.030+60+0.12 ms clock, 0.12+0.013/60/177+0.51 ms cpu, 484-&gt;484-&gt;248 MB, 496 MB goal, 4 P<br />
gc 10 @236.621s 0%: 0.006+59+0.11 ms clock, 0.025+0/59/173+0.47 ms cpu, 484-&gt;484-&gt;248 MB, 496 MB goal, 4 P<br />
gc 11 @285.967s 0%: 0.027+57+0.22 ms clock, 0.11+0/57/163+0.89 ms cpu, 484-&gt;484-&gt;248 MB, 496 MB goal, 4 P<br />
scvg1: inuse: 331, idle: 175, sys: 507, released: 0, consumed: 507 (MB)<br />
gc 12 @333.817s 0%: 0.009+52+0.18 ms clock, 0.036+0/52/155+0.72 ms cpu, 484-&gt;484-&gt;248 MB, 496 MB goal, 4 P</p><br />
<br />
<p>gc信息的含义<br />
查看官方的runtime说明：</p><br />
<br />
<p>gctrace: setting gctrace=1 causes the garbage collector to emit a single line to standard<br />
error at each collection, summarizing the amount of memory collected and the<br />
length of the pause. Setting gctrace=2 emits the same summary but also<br />
repeats each collection. The format of this line is subject to change.<br />
Currently, it is:<br />
	gc # @#s #%: #+#+# ms clock, #+#/#/#+# ms cpu, #-&gt;#-&gt;# MB, # MB goal, # P<br />
where the fields are as follows:<br />
	gc #        the GC number, incremented at each GC<br />
	@#s         time in seconds since program start<br />
	#%          percentage of time spent in GC since program start<br />
	#+…+#     wall-clock/CPU times for the phases of the GC<br />
	#-&gt;#-&gt;# MB  heap size at GC start, at GC end, and live heap<br />
	# MB goal   goal heap size<br />
	# P         number of processors used<br />
The phases are stop-the-world (STW) sweep termination, concurrent<br />
mark and scan, and STW mark termination. The CPU times<br />
for mark/scan are broken down in to assist time (GC performed in<br />
line with allocation), background GC time, and idle GC time.<br />
If the line ends with “(forced)”, this GC was forced by a<br />
runtime.GC() call and all phases are STW.</p><br />
<br />
<p>Setting gctrace to any value &gt; 0 also causes the garbage collector<br />
to emit a summary when memory is released back to the system.<br />
This process of returning memory to the system is called scavenging.<br />
The format of this summary is subject to change.<br />
Currently it is:<br />
	scvg#: # MB released  printed only if non-zero<br />
	scvg#: inuse: # idle: # sys: # released: # consumed: # (MB)<br />
where the fields are as follows:<br />
	scvg#        the scavenge cycle number, incremented at each scavenge<br />
	inuse: #     MB used or partially used spans<br />
	idle: #      MB spans pending scavenging<br />
	sys: #       MB mapped from the system<br />
	released: #  MB released to the system<br />
	consumed: #  MB allocated from the system<br />
垃圾回收信息<br />
gc 1 @2.104s 0%: 0.018+1.3+0.076 ms clock, 0.054+0.35/1.0/3.0+0.23 ms cpu, 4-&gt;4-&gt;3 MB, 5 MB goal, 4 P。</p><br />
<br />
<p>1 表示第一次执行<br />
@2.104s 表示程序执行的总时间<br />
0% 垃圾回收时间占用的百分比，（不知道和谁比？难道是和上面的程序执行总时间，这样比较感觉没意义）<br />
0.018+1.3+0.076 ms clock 垃圾回收的时间，分别为STW（stop-the-world）清扫的时间, 并发标记和扫描的时间，STW标记的时间<br />
0.054+0.35/1.0/3.0+0.23 ms cpu 垃圾回收占用cpu时间<br />
4-&gt;4-&gt;3 MB 堆的大小，gc后堆的大小，存活堆的大小<br />
5 MB goal 整体堆的大小<br />
4 P 使用的处理器数量</p><br />
<br />
<p>系统内存回收信息,这个很直白，看单词就知道大概意思了<br />
scvg0: inuse: 426, idle: 0, sys: 427, released: 0, consumed: 427 (MB)</p><br />
<br />
<p>426 使用多少M内存<br />
0 剩下要清除的内存<br />
427 系统映射的内存<br />
0 释放的系统内存<br />
427 申请的系统内存</p><br />
<br />
<p>golang的环境变量有不少，平时安装完go之后，我们关注的一般只是GOPATH、GOROOT这些，还有与go mod有关的几个环境变量，对于其他变量了解不多，想要深入了解这门语言，有必要了解其他环境变量。</p><br />
<br />
<p>我们先总的来了解下有哪些环境变量，以及它们代表的含义：</p><br />
<br />
<p>$ go help environment<br />
The go command and the tools it invokes consult environment variables<br />
for configuration. If an environment variable is unset, the go command<br />
uses a sensible default setting. To see the effective setting of the<br />
variable <NAME>, run 'go env <NAME>'. To change the default setting,<br />
run 'go env -w <NAME>=<VALUE>'. Defaults changed using 'go env -w'<br />
are recorded in a Go environment configuration file stored in the<br />
per-user configuration directory, as reported by os.UserConfigDir.<br />
The location of the configuration file can be changed by setting<br />
the environment variable GOENV, and 'go env GOENV' prints the<br />
effective location, but 'go env -w' cannot change the default location.<br />
See 'go help env' for details.</VALUE></NAME></NAME></NAME></p><br />
<br />
<p>General-purpose environment variables:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GCCGO<br />
            The gccgo command to run for 'go build -compiler=gccgo'.<br />
    GOARCH<br />
            The architecture, or processor, for which to compile code.<br />
            Examples are amd64, 386, arm, ppc64.<br />
    GOBIN<br />
            The directory where 'go install' will install a command.<br />
    GOCACHE<br />
            The directory where the go command will store cached<br />
            information for reuse in future builds.<br />
    GODEBUG<br />
            Enable various debugging facilities. See 'go doc runtime'<br />
            for details.<br />
    GOENV<br />
            The location of the Go environment configuration file.<br />
            Cannot be set using 'go env -w'.<br />
    GOFLAGS<br />
            A space-separated list of -flag=value settings to apply<br />
            to go commands by default, when the given flag is known by<br />
            the current command. Each entry must be a standalone flag.<br />
            Because the entries are space-separated, flag values must<br />
            not contain spaces. Flags listed on the command line<br />
            are applied after this list and therefore override it.<br />
    GOOS<br />
            The operating system for which to compile code.<br />
            Examples are linux, darwin, windows, netbsd.<br />
    GOPATH<br />
            For more details see: 'go help gopath'.<br />
    GOPROXY<br />
            URL of Go module proxy. See 'go help modules'.<br />
    GOPRIVATE, GONOPROXY, GONOSUMDB<br />
            Comma-separated list of glob patterns (in the syntax of Go's path.Match)<br />
            of module path prefixes that should always be fetched directly<br />
            or that should not be compared against the checksum database.<br />
            See 'go help module-private'.<br />
    GOROOT<br />
            The root of the go tree.<br />
    GOSUMDB<br />
            The name of checksum database to use and optionally its public key and<br />
            URL. See 'go help module-auth'.<br />
    GOTMPDIR<br />
            The directory where the go command will write<br />
            temporary source files, packages, and binaries.<br />
</code></pre></div></div><br />
<br />
<p>Environment variables for use with cgo:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    AR<br />
            The command to use to manipulate library archives when<br />
            building with the gccgo compiler.<br />
            The default is 'ar'.<br />
    CC<br />
            The command to use to compile C code.<br />
    CGO_ENABLED<br />
            Whether the cgo command is supported. Either 0 or 1.<br />
    CGO_CFLAGS<br />
            Flags that cgo will pass to the compiler when compiling<br />
            C code.<br />
    CGO_CFLAGS_ALLOW<br />
            A regular expression specifying additional flags to allow<br />
            to appear in #cgo CFLAGS source code directives.<br />
            Does not apply to the CGO_CFLAGS environment variable.<br />
    CGO_CFLAGS_DISALLOW<br />
            A regular expression specifying flags that must be disallowed<br />
            from appearing in #cgo CFLAGS source code directives.<br />
            Does not apply to the CGO_CFLAGS environment variable.<br />
    CGO_CPPFLAGS, CGO_CPPFLAGS_ALLOW, CGO_CPPFLAGS_DISALLOW<br />
            Like CGO_CFLAGS, CGO_CFLAGS_ALLOW, and CGO_CFLAGS_DISALLOW,<br />
            but for the C preprocessor.<br />
    CGO_CXXFLAGS, CGO_CXXFLAGS_ALLOW, CGO_CXXFLAGS_DISALLOW<br />
            Like CGO_CFLAGS, CGO_CFLAGS_ALLOW, and CGO_CFLAGS_DISALLOW,<br />
            but for the C++ compiler.<br />
    CGO_FFLAGS, CGO_FFLAGS_ALLOW, CGO_FFLAGS_DISALLOW<br />
            Like CGO_CFLAGS, CGO_CFLAGS_ALLOW, and CGO_CFLAGS_DISALLOW,<br />
            but for the Fortran compiler.<br />
    CGO_LDFLAGS, CGO_LDFLAGS_ALLOW, CGO_LDFLAGS_DISALLOW<br />
            Like CGO_CFLAGS, CGO_CFLAGS_ALLOW, and CGO_CFLAGS_DISALLOW,<br />
            but for the linker.<br />
    CXX<br />
            The command to use to compile C++ code.<br />
    FC<br />
            The command to use to compile Fortran code.<br />
    PKG_CONFIG<br />
            Path to pkg-config tool.<br />
</code></pre></div></div><br />
<br />
<p>Architecture-specific environment variables:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GOARM<br />
            For GOARCH=arm, the ARM architecture for which to compile.<br />
            Valid values are 5, 6, 7.<br />
    GO386<br />
            For GOARCH=386, the floating point instruction set.<br />
            Valid values are 387, sse2.<br />
    GOMIPS<br />
            For GOARCH=mips{,le}, whether to use floating point instructions.<br />
            Valid values are hardfloat (default), softfloat.<br />
    GOMIPS64<br />
            For GOARCH=mips64{,le}, whether to use floating point instructions.<br />
            Valid values are hardfloat (default), softfloat.<br />
    GOWASM<br />
            For GOARCH=wasm, comma-separated list of experimental WebAssembly features to use.<br />
            Valid values are satconv, signext.<br />
</code></pre></div></div><br />
<br />
<p>Special-purpose environment variables:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GCCGOTOOLDIR<br />
            If set, where to find gccgo tools, such as cgo.<br />
            The default is based on how gccgo was configured.<br />
    GOROOT_FINAL<br />
            The root of the installed Go tree, when it is<br />
            installed in a location other than where it is built.<br />
            File names in stack traces are rewritten from GOROOT to<br />
            GOROOT_FINAL.<br />
    GO_EXTLINK_ENABLED<br />
            Whether the linker should use external linking mode<br />
            when using -linkmode=auto with code that uses cgo.<br />
            Set to 0 to disable external linking mode, 1 to enable it.<br />
    GIT_ALLOW_PROTOCOL<br />
            Defined by Git. A colon-separated list of schemes that are allowed<br />
            to be used with git fetch/clone. If set, any scheme not explicitly<br />
            mentioned will be considered insecure by 'go get'.<br />
            Because the variable is defined by Git, the default value cannot<br />
            be set using 'go env -w'.<br />
</code></pre></div></div><br />
<br />
<p>Additional information available from ‘go env’ but not read from the environment:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    GOEXE<br />
            The executable file name suffix (".exe" on Windows, "" on other systems).<br />
    GOGCCFLAGS<br />
            A space-separated list of arguments supplied to the CC command.<br />
    GOHOSTARCH<br />
            The architecture (GOARCH) of the Go toolchain binaries.<br />
    GOHOSTOS<br />
            The operating system (GOOS) of the Go toolchain binaries.<br />
    GOMOD<br />
            The absolute path to the go.mod of the main module,<br />
            or the empty string if not using modules.<br />
    GOTOOLDIR<br />
            The directory where the go tools (compile, cover, doc, etc...) are installed. 你可以使用以下命令查看你的go环境变量：<br />
</code></pre></div></div><br />
<br />
<p>$ go env<br />
除开跟go mod有关的几个环境变量还有跟GOPATH有关的几个我们不谈，因为我已经在上篇文章讲go mod的时候聊过了，接下来就来了解一下其他的环境变量。</p><br />
<br />
<p>GOARCH 和 GOOS<br />
GOARCH ：cpu架构，386、amd64、arm等，在交叉编译的时候设置，可以编译不同平台的包。<br />
GOOS：平台，linux、windows等，通常和GOARCH搭配使用。<br />
这里贴一下在不同平台下交叉编译的命令：</p><br />
<br />
<p>Mac下编译Linux, Windows平台的64位可执行程序：<br />
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build test.go<br />
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go</p><br />
<br />
<p>Linux下编译Mac, Windows平台的64位可执行程序：<br />
CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build test.go<br />
CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go</p><br />
<br />
<p>Windows下编译Mac, Linux平台的64位可执行程序：<br />
SET CGO_ENABLED=0<br />
SET GOOS=darwin<br />
SET GOARCH=amd64<br />
go build test.go<br />
SET CGO_ENABLED=0<br />
SET GOOS=linux<br />
SET GOARCH=amd64<br />
go build test.go</p><br />
<br />
<p>GOCACHE<br />
这是go build产生的缓存，这可以加快编译速度，我在GOCACHE打印出来的路径下看到了一个README文件，它解释了GOCACHE。</p><br />
<br />
<p>This directory holds cached build artifacts from the Go build system.<br />
Run “go clean -cache” if the directory is getting too large.<br />
See golang.org to learn more about Go.<br />
可以使用”go clean -cache”命令清除编译缓存。</p><br />
<br />
<p>GOENV<br />
本地的go环境文件存储位置，不可以用”go env -w”设置它。</p><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>