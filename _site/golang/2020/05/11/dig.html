<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Digging deeper into the analysis of Go-code</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-05-11T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 11, 2020</time></p>
					</div>
					 <p>https://nakabonne.dev/posts/digging-deeper-into-the-analysis-of-go-code/<br />
The analysis of source code at the syntactic level can help you with your coding in a variety of ways. For that, the text is almost always converted to AST first to make it easier to handle in most languages.<br />
As some of you may know, Go has a powerful package go/parser, with it, you can convert source code to AST relatively easily. However, I couldn’t help but be curious about how it is working, and I realized my mind could only be satisfied by getting started to read the API implementation. In this article, I will walk you through how it is converted, by reading the implementation of its API.</p><br />
<br />
<p>Even those unfamiliar with the Go language don’t need to close the tab in the browsers, as this is a generic enough article to understand how programming languages are analyzed.<br />
This article is also the first step in understanding the compiler and interpreter, as well as delving into static analysis.<br />
<!-- more --><br />
AST<br />
Let’s start with some of the knowledge you need to read the implementation. What is AST(Abstract Syntax Tree)? According to Wikipedia:</p><br />
<br />
<p>In computer science, an abstract syntax tree (AST), or just syntax tree, is a tree representation of the abstract syntactic structure of source code written in a programming language. Each node of the tree denotes a construct occurring in the source code.</p><br />
<br />
<p>Most compilers and interpreters use AST as an internal representation of the source code; AST typically omits semicolons, line feed characters, white spaces, braces, square brackets, and round brackets from the syntax tree, etc.</p><br />
<br />
<p>What you can do with AST:</p><br />
<br />
<p>Source code analysis<br />
Code generation<br />
Can be rewritten<br />
How to convert to AST<br />
Plain text is quite straightforward for us, but from a machine, nothing is tougher to handle. Therefore, you have to first do lexical analysis the text with a lexer. The general flow is to pass it to a parser and retrieve the AST.</p><br />
<br />
<p>I’d prefer to point out here that there is not a single universal AST format which can be used by any parser. For instance, x + 2 in Go is represented by:</p><br />
<br />
<p>*ast.BinaryExpr {<br />
.  X: *ast.Ident {<br />
.  .  NamePos: 1<br />
.  .  Name: “x”<br />
.  .  Obj: *ast.Object {<br />
.  .  .  Kind: bad<br />
.  .  .  Name: “”<br />
.  .  }<br />
.  }<br />
.  OpPos: 3<br />
.  Op: +<br />
.  Y: *ast.BasicLit {<br />
.  .  ValuePos: 5<br />
.  .  Kind: INT<br />
.  .  Value: “2”<br />
.  }<br />
}<br />
Lexical analysis<br />
As mentioned earlier, the analysis typically starts by passing the text to a lexer and then fetching the tokens. A token is a string with an assigned and thus identified meaning. go/scanner.Scanner is in charge of the lexer in Go.<br />
What is the identified meaning? Seeing is believing.</p><br />
<br />
<p>Let’s say you write:</p><br />
<br />
<p>package main</p><br />
<br />
<p>const s = “foo”<br />
This is what happens when you tokenize it:</p><br />
<br />
<p>PACKAGE(package)<br />
IDENT(main)<br />
CONST(const)<br />
IDENT(s)<br />
ASSIGN(=)<br />
STRING(“foo”)<br />
EOF()<br />
All tokens in Go are defined here.</p><br />
<br />
<p>Peeling away at the parsing API<br />
To convert a Go source file to AST, just call go/parser.ParseFile as shown below:</p><br />
<br />
<p>fset := token.NewFileSet()<br />
f, _ := parser.ParseFile(fset, “foo.go”, nil, parser.ParseComments)<br />
Now that we’ve figured out the conversion steps by the previous chapter, let’s actually read the internal implementation of that method! (The version of Go we refer to is 1.14.1).</p><br />
<br />
<p>Scanner.Scan() — a method for Lexical Analysis<br />
How does Go perform lexical analysis? As previously mentioned, go/scanner.Scanner is in charge of the lexer in Go. Thus at first, let’s take a closer look at that Scanner.Scan() method — which is called by parser.ParseFile() internally.</p><br />
<br />
<p>scanner/scanner.go</p><br />
<br />
<p>func (s *Scanner) Scan() (pos token.Pos, tok token.Token, lit string) {<br />
… // Omission<br />
	switch ch := s.ch; {<br />
	case isLetter(ch):<br />
		lit = s.scanIdentifier()<br />
		if len(lit) &gt; 1 {<br />
			// keywords are longer than one letter - avoid lookup otherwise<br />
			tok = token.Lookup(lit)<br />
			switch tok {<br />
			case token.IDENT, token.BREAK, token.CONTINUE, token.FALLTHROUGH, token.RETURN:<br />
				insertSemi = true<br />
			}<br />
		} else {<br />
… // Omission<br />
}<br />
ch is the current character held by Scanner. Scanner.Scan() advances to next character by calling Scanner.next() and populates ch, as long as it is available as an identifier name. The code above is for the case where ch is a letter; It pauses its advance as soon as it encounters a character that cannot be used as an identifier and then determines the type of token.</p><br />
<br />
<p>There are different ways to determine where does a single token start and where does it end, depending on the character. For instance, in the case of String, it continues to advance until “ appears:</p><br />
<br />
<p>scanner/scanner.go</p><br />
<br />
<p>case ‘”’:<br />
	insertSemi = true<br />
	tok = token.STRING<br />
	lit = s.scanString()</p><br />
<br />
<p>func (s *Scanner) scanString() string {<br />
	// ‘”’ opening already consumed<br />
	offs := s.offset - 1</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for {<br />
	ch := s.ch<br />
	if ch == '\n' || ch &lt; 0 {<br />
		s.error(offs, "string literal not terminated")<br />
		break<br />
	}<br />
	s.next()<br />
	if ch == '"' {<br />
		break<br />
	}<br />
	if ch == '\\' {<br />
		s.scanEscape('"')<br />
	}<br />
}<br />
<br />
return string(s.src[offs:s.offset]) } Finally, the Scanner.Scan() method returns a token that has been identified.<br />
</code></pre></div></div><br />
<br />
<p>Parsing<br />
Before taking a look parsing a file, let’s check the file structure in Go. According to The Go Programming Language Specification - Source file organization:</p><br />
<br />
<p>Each source file consists of a package clause defining the package to which it belongs, followed by a possibly empty set of import declarations that declare packages whose contents it wishes to use, followed by a possibly empty set of declarations of functions, types, variables, and constants.</p><br />
<br />
<p>That is, the structure is:</p><br />
<br />
<p>A package clause<br />
Import declarations<br />
Top level declarations<br />
After parsing a package clause and import declarations, parser.parseFile() repeats the parsing of the declaration to the end of the file.</p><br />
<br />
<p>parser/parser.go</p><br />
<br />
<p>for p.tok != token.EOF {<br />
	decls = append(decls, p.parseDecl(declStart))<br />
}<br />
So let’s look at parser.parseDecl next.</p><br />
<br />
<p>parser.parseDecl() — a method to parse the syntax of a declaration<br />
parser.parseDecl() returns ast.Decl, the node of the syntax tree representing the declaration in the Go source code.</p><br />
<br />
<p>parser/parser.go</p><br />
<br />
<p>func (p *parser) parseDecl(sync map[token.Token]bool) ast.Decl {<br />
	if p.trace {<br />
		defer un(trace(p, “Declaration”))<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var f parseSpecFunction<br />
switch p.tok {<br />
case token.CONST, token.VAR:<br />
	f = p.parseValueSpec<br />
<br />
case token.TYPE:<br />
	f = p.parseTypeSpec<br />
<br />
case token.FUNC:<br />
	return p.parseFuncDecl()<br />
<br />
default:<br />
	pos := p.pos<br />
	p.errorExpected(pos, "declaration")<br />
	p.advance(sync)<br />
	return &amp;ast.BadDecl{From: pos, To: p.pos}<br />
}<br />
<br />
return p.parseGenDecl(p.tok, f) } It goes through the tokens and process them differently for each keyword. Let’s deep dive into parseFuncDecl().<br />
</code></pre></div></div><br />
<br />
<p>parser/parser.go</p><br />
<br />
<p>if p.tok == token.LPAREN {<br />
	recv = p.parseParameters(scope, false)<br />
}</p><br />
<br />
<p>ident := p.parseIdent()</p><br />
<br />
<p>params, results := p.parseSignature(scope)</p><br />
<br />
<p>var body *ast.BlockStmt<br />
if p.tok == token.LBRACE {<br />
	body = p.parseBody(scope)<br />
	p.expectSemi()<br />
} else if p.tok == token.SEMICOLON {<br />
	p.next()<br />
Internally, it advances the token by calling Scanner.Scan() — which we saw in detail earlier.</p><br />
<br />
<p>token.LPAREN represents (, so you can see that it starts parsing the parameters as soon as ( is found.<br />
token.LBRACE represents {, so you can see that it starts parsing the function body as soon as { is found.</p><br />
<br />
<p>.<br />
.<br />
.<br />
Oops, it’s going to take forever at this rate…</p><br />
<br />
<p>Summary<br />
Parsing the tokens by myself has made me feel closer to the compiler and interpreter that I used to feel horrible about. I’d love to dabble in Writing A Compiler In Go and Writing An Interpreter In Go as well.</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>