<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Testing in Go Clean Tests Using t Cleanup</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-02-20T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Feb 20, 2020</time></p>
					</div>
					 <p>https://ieftimov.com/post/testing-in-go-clean-tests-using-t-cleanup/<br />
<!-- more --><br />
Go v1.14 ships with improvements across different aspects of the language. Two of them are brand new t.Cleanup, and b.Cleanup methods, added to the testing package.</p><br />
<br />
<p>The introduction of these methods will make it easier for our tests to clean up after themselves. This was always achievable through the careful composition of (sub)tests and helper functions, but since Go 1.14, the testing package will ship with one right way to do that.</p><br />
<br />
<p>Let’s explore through a scenario, one very common in web development, how these methods work, and how to put them in use.</p><br />
<br />
<p>In this article, we will focus on the t.Cleanup function, but the points made here apply to the b.Cleanup function too.</p><br />
<br />
<p>Vulnerable Authentication<br />
A web service that we own has an authentication middleware that uses HTTP Basic Authentication. The middleware takes the Authorization header values of an HTTP request using the BasicAuth helper method and authenticates the request. Depending on the authentication result, it will return an error response or let the request go through.</p><br />
<br />
<p>The AuthMiddleware authorization middleware:</p><br />
<br />
<p>type AuthMiddleware struct {<br />
	db *gorm.DB<br />
}</p><br />
<br />
<p>func (am *AuthMiddleware) Validate(username, password string) bool {<br />
	var u User</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := am.db.Where("username = ? AND password = ?", username, password).First(&amp;u).Error; err != nil {<br />
	return false<br />
}<br />
<br />
return true }<br />
</code></pre></div></div><br />
<br />
<p>func (am *AuthMiddleware) Middleware(next http.Handler) http.Handler {<br />
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {<br />
		if u, p, ok := r.BasicAuth(); ok &amp;&amp; am.Validate(u, p) {<br />
			next.ServeHTTP(w, r)<br />
		} else {<br />
			http.Error(w, “Forbidden”, http.StatusForbidden)<br />
		}<br />
	})<br />
}<br />
The AuthMiddleware is a struct that has a db attribute of the type *gorm.DB, which, in fact, is a Gorm database connection pool. The Validate method of the middleware will check the validity of the authorization credentials sent by the client. (Yes, this is a very dumb and vulnerable service - stores plain text passwords in the database. No, you should never keep your customers’ passwords in plain text.)</p><br />
<br />
<p>To do that, it uses the Request.BasicAuth method that returns the username and password provided in the request’s Authorization header. Then, we invoke the Validate method with u (the username) and p (the password) as arguments, that returns a bool.</p><br />
<br />
<p>When the request successfully authorized, the response of the endpoint will be returned. If the request does not supply proper HTTP Basic Authentication credentials, or the supplied credentials are invalid, it will return an HTTP 403 Forbidden error.</p><br />
<br />
<p>The simplistic server that builds the router and mounts the handler and the middleware:</p><br />
<br />
<p>func main() {<br />
	db, err := gorm.Open(“sqlite3”, “./cleanups.db”)<br />
	if err != nil {<br />
		log.Fatal(err)<br />
	}<br />
	defer db.Close()</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aum := &amp;AuthMiddleware{db}<br />
r := mux.NewRouter()<br />
r.Use(aum.Middleware)<br />
r.HandleFunc("/foo", func(w http.ResponseWriter, r *http.Request) {<br />
            io.WriteString(w, "6 x 9 = 42\n")<br />
})<br />
<br />
log.Fatal(http.ListenAndServe(":8888", r)) } The main function opens a Gorm connection to an SQLite3 database, builds a mux router, and mounts a handler at the /foo URI. Then, it mounts the router on a server and starts listening on 127.0.0.1:8888.<br />
</code></pre></div></div><br />
<br />
<p>So, a sensible question would be, how can we test such a middleware? Since there is a database connection in play here, we have to make sure the database contains the actual username and password we want to send in the test.</p><br />
<br />
<p>Testing the Vulnerable Authentication<br />
Given that the authorization middleware expects a database connection, testing it can be a messy exercise. To test it, we will have to open a database connection (to a test database) and then use it to initialize a test server that mounts the router. Then, we have to send requests to that same server and run our assertions on its response body and status.</p><br />
<br />
<p>Let’s take a stab at it:</p><br />
<br />
<p>package main</p><br />
<br />
<p>import (<br />
	“fmt”<br />
	“io/ioutil”<br />
	“log”<br />
	“net/http”<br />
	“net/http/httptest”<br />
	“os”<br />
	“strings”<br />
	“testing”</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"github.com/jinzhu/gorm" )<br />
</code></pre></div></div><br />
<br />
<p>func TestServer(t *testing.T) {<br />
	db, err := gorm.Open(“sqlite3”, “./cleanups_test.db”)<br />
	if err != nil {<br />
		t.Fatal(err)<br />
	}<br />
	defer db.Close()</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r := Router(db)<br />
<br />
tcs := []struct {<br />
	name           string<br />
	username       string<br />
	password       string<br />
	responseBody   string<br />
	responseStatus int<br />
}{<br />
	{<br />
		name:           "with invalid username-password combo",<br />
		username:       "jane",<br />
		password:       "doe",<br />
		responseBody:   "Forbidden",<br />
		responseStatus: http.StatusForbidden,<br />
	},<br />
	{<br />
		name:           "with valid username-password combo",<br />
		username:       "jane",<br />
		password:       "doe123",<br />
		responseBody:   "6 x 9 = 42",<br />
		responseStatus: http.StatusOK,<br />
	},<br />
}<br />
<br />
ts := httptest.NewServer(r)<br />
defer ts.Close()<br />
client := ts.Client()<br />
<br />
req, err := http.NewRequest("GET", fmt.Sprintf("%s/foo", ts.URL), nil)<br />
if err != nil {<br />
	t.Fatal(err)<br />
}<br />
<br />
for _, tc := range tcs {<br />
	t.Run(tc.name, func(t *testing.T) {<br />
		req.SetBasicAuth(tc.username, tc.password)<br />
<br />
		res, err := client.Do(req)<br />
		if err != nil {<br />
			t.Fatal(err)<br />
		}<br />
		defer res.Body.Close()<br />
<br />
		response, err := ioutil.ReadAll(res.Body)<br />
		if err != nil {<br />
			t.Errorf(err)<br />
		}<br />
<br />
		if res.StatusCode != tc.responseStatus {<br />
			t.Errorf("Want '%d', got '%d'", tc.responseStatus, res.StatusCode)<br />
		}<br />
<br />
		if strings.TrimSpace(string(response)) != tc.responseBody {<br />
			t.Errorf("Want '%s', got '%s'", tc.responseBody, string(response))<br />
		}<br />
	})<br />
} } We first open a database connection to a test database and pass the connection as an argument to the Router function. In the second highlighted block, we mount the returned router from the Router function on the test HTTP server. Also, we create a client for the server that we will use to send requests to the server.<br />
</code></pre></div></div><br />
<br />
<p>We then build a new request for the server, and in the next highlighted block, we attach the username and the password of the test case to the request using the Request.SetBasicAuth method.</p><br />
<br />
<p>We send the request to the HTTP server using the client.Do method, and get a response back. We then parse the response and do our assertions on the status code of the response and the contents of the body.</p><br />
<br />
<p>If we ran this test, it would fail. Why? Although the test setup is correct, the test database is empty. When we send a request to the HTTP server, it will try to validate the credentials our test sends, and it will find an empty database:</p><br />
<br />
<p>$ go test ./… -v -count=1<br />
=== RUN   TestServer<br />
    TestServer: server_test.go:17: no such table: users</p><br />
<br />
<p>(/app/server_test.go:16)<br />
[2020-02-16 17:29:26]  no such table: users<br />
— FAIL: TestServer (0.01s)<br />
FAIL<br />
FAIL	github.com/fteem/go-playground/testing-in-go-cleanup	0.015s<br />
FAIL<br />
This means our test is missing an initial seed of test data, where we create the users table and put some records in it so we can use them in the test.</p><br />
<br />
<p>Adding data and cleaning it up, the old way<br />
The widely-approved approach to seeding the test database is to insert some records before running the test and then remove them once the test is done. The benefit being that the database will always be empty after the tests are done running, without the need to recreate the database and its tables every time we run the tests. Precisely what our failing tests need.</p><br />
<br />
<p>Achieving this in the most idiomatic way is by using a cleanup closure that is returned by the function that inserts the data. Usually, the returning cleanup function “pattern” looks like this:</p><br />
<br />
<p>func createUser(t *testing.T, db *gorm.DB) func() {<br />
	user := User{Username: “jane”, Password: “doe123”}<br />
	if err := db.Create(&amp;user).Error; err != nil {<br />
		t.Fatal(err)<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return func() {<br />
	db.Delete(&amp;user)<br />
} }<br />
</code></pre></div></div><br />
<br />
<p>func TestServer(t *testing.T) {<br />
	db, err := gorm.Open(“sqlite3”, “./cleanups_test.db”)<br />
	if err != nil {<br />
		t.Fatal(err)<br />
	}<br />
	defer db.Close()</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cleanup := createUser(t, db)<br />
defer cleanup()<br />
<br />
r := Router(db)<br />
<br />
tcs := []struct {<br />
	name           string<br />
	username       string<br />
	password       string<br />
	responseBody   string responseStatus int<br />
}{<br />
	{<br />
		name:           "with invalid username-password combo",<br />
		username:       "jane",<br />
		password:       "doe",<br />
		responseBody:   "Forbidden",<br />
		responseStatus: http.StatusForbidden,<br />
	},<br />
	{<br />
		name:           "with valid username-password combo",<br />
		username:       "jane",<br />
		password:       "doe123",<br />
		responseBody:   "6 x 9 = 42",<br />
		responseStatus: http.StatusOK,<br />
	},<br />
}<br />
<br />
ts := httptest.NewServer(r)<br />
defer ts.Close()<br />
client := ts.Client()<br />
<br />
req, err := http.NewRequest("GET", fmt.Sprintf("%s/foo", ts.URL), nil)<br />
if err != nil {<br />
	t.Fatal(err)<br />
}<br />
<br />
for _, tc := range tcs {<br />
	t.Run(tc.name, func(t *testing.T) {<br />
		req.SetBasicAuth(tc.username, tc.password)<br />
<br />
		res, err := client.Do(req)<br />
		if err != nil {<br />
			t.Fatal(err)<br />
		}<br />
		defer res.Body.Close()<br />
<br />
		response, err := ioutil.ReadAll(res.Body)<br />
		if err != nil {<br />
			t.Error(err)<br />
		}<br />
<br />
		if res.StatusCode != tc.responseStatus {<br />
			t.Errorf("Want '%d', got '%d'", tc.responseStatus, res.StatusCode)<br />
		}<br />
<br />
		if strings.TrimSpace(string(response)) != tc.responseBody {<br />
			t.Errorf("Want '%s', got '%s'", tc.responseBody, string(response))<br />
		}<br />
	})<br />
} } The createUser function takes a database connection as an argument and uses it to insert a new User in the users table. After that, it will return a closure that, when invoked, will remove the added user.<br />
</code></pre></div></div><br />
<br />
<p>The reason we pass the testing.T pointer to the createUser function is to be able to fail the test if the database cannot be opened for writing. We check the db.Error field on the Gorm database connection pool for any errors and invoke the t.Fatal function, if we hit any errors.</p><br />
<br />
<p>(You can read more about the behavior of t.Fatal in my article on the topic.)</p><br />
<br />
<p>In the test itself, we invoke createUser with the test database connection and the testing.T pointer. The return value of createUser is a function which we store in the cleanup variable. Then, we defer the invocation of cleanup to happen at the exit of the test function. Using cleanup, we can remove the data from the test database before exiting the tests.</p><br />
<br />
<p>While the approach above works and it’s idiomatic Go, it has a few downsides worth mentioning:</p><br />
<br />
<p>It works fine for one test case, but if the test file has many tests that modify the state of the test database, they will get contaminated with cleanup-like functions.<br />
Adding to the above point, imagine tests where we have to clean up other things, such as processes, files, or open sockets. That will lead to a substantial increase in cleanup-closures pollution.<br />
It adds cognitive overhead when reading the code, which otherwise is a straightforward testing code<br />
The definition of the cleanup function is buried in the createUser function, visually separated from the test function that uses/invokes it. A reader of the test file can experience difficulty navigating the functions and putting the pieces together<br />
Because of these reasons, the Go authors decided to add a t.Cleanup function to the testing package. The change was merged on November 4, 2019 – right on time to get into the v1.14 release.</p><br />
<br />
<p>Let’s explore how t.Cleanup can make our life easier.</p><br />
<br />
<p>Adding data and cleaning it up, using t.Cleanup<br />
With the t.Cleanup, and b.Cleanup methods, we get better control to cleaning up after our tests. t.Cleanup registers a function to be called when the test and all its subtests complete. This means that even if our tests run as subtests, which is the case in our example, the cleanup will only happen after all the subtests are done.</p><br />
<br />
<p>Here’s the reworked version of our tests:</p><br />
<br />
<p>func createUser(t *testing.T, db *gorm.DB) {<br />
	user := User{Username: “jane”, Password: “doe123”}<br />
	if err := db.Create(&amp;user).Error; err != nil {<br />
		t.Fatal(err)<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>t.Cleanup(func() {<br />
	db.Delete(&amp;user)<br />
}) }<br />
</code></pre></div></div><br />
<br />
<p>func TestServer(t *testing.T) {<br />
	db, err := gorm.Open(“sqlite3”, “./cleanups_test.db”)<br />
	if err != nil {<br />
		t.Fatal(err)<br />
	}<br />
	defer db.Close()</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>createUser(t, db)<br />
<br />
r := Router(db)<br />
<br />
// Snipped for brewity... } While the code change is small, there is a substantial difference between the new and the old versions.<br />
</code></pre></div></div><br />
<br />
<p>The most significant difference lies in the fact that the createUser function takes care of its clean up now. The invoker function (TestServer) does not need to worry about the cleanup of the data added in the database – we know that the createUser will remove the data. Most importantly, it will remove the data just in time – once all of the subtests are done.</p><br />
<br />
<p>Having t.Cleanup, and b.Cleanup in the standard library does not stop us from using the old way using composition and returning cleanup callbacks – it is still a valid way to clean up any state or files that our tests might create. But, using the new t.Cleanup &amp; b.Cleanup functions things get a bit easier: there’s now a way to do just that, and the standard library supports it.</p><br />
<br />
<p>And having the Go v1 compatibility promise in mind – it is here to stay.</p><br />
<br />
<p>comments powered by Disqus</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>