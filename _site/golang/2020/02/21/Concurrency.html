<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Concurrency</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-02-21T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Feb 21, 2020</time></p>
					</div>
					 <p>https://encore.dev/blog/advanced-go-concurrency</p><br />
<br />
<p>If you’ve used Go for a while you’re probably aware of some of the basic Go concurrency primitives:</p><br />
<br />
<p>The go keyword for spawning goroutines<br />
Channels, for communicating between goroutines<br />
The context package for propagating cancellation<br />
The sync and sync/atomic packages for lower-level primitives such as mutexes and atomic memory access<br />
These language features and packages combine to provide a very rich set of tools for building concurrent applications. What you might not have discovered yet is a set of higher-level concurrency primitives available in the “extended standard library” available at golang.org/x/sync. We’ll be taking a look at these in this article.<br />
<!-- more --><br />
Package singleflight<br />
As the package documentation states, this package provides a duplicate function call suppression mechanism.</p><br />
<br />
<p>This package is extremely useful for cases where you are doing something computationally expensive (or just slow, like network access) in response to user activity. For example, let’s say you have a database with weather information per city and you want to expose this as an API. In some cases you might have multiple users ask for the weather for the same city at the same time.</p><br />
<br />
<p>When that happens, wouldn’t it be great if you could just query the database, and then share the result to all the waiting requests? That’s exactly what the singleflight package does!</p><br />
<br />
<p>To use it, create a singleflight.Group somewhere. It needs to be shared across all the requests to work correctly. Then wrap the slow or expensive operation in a call to group.Do(key, fn). Multiple concurrent requests for the same key will only call fn once, and the result will be returned to all callers once fn returns.</p><br />
<br />
<p>Here’s how it looks in practice:</p><br />
<br />
<p>package weather</p><br />
<br />
<p>type Info struct {<br />
    TempC, TempF int // temperature in Celsius and Farenheit<br />
    Conditions string // “sunny”, “snowing”, etc<br />
}</p><br />
<br />
<p>var group singleflight.Group</p><br />
<br />
<p>func City(city string) (<em>Info, error) {<br />
    results, err, _ := group.Do(city, func() (interface{}, error) {<br />
        info, err := fetchWeatherFromDB(city) // slow operation<br />
        return info, err<br />
    })<br />
    if err != nil {<br />
        return nil, fmt.Errorf(“weather.City %s: %w”, city, err)<br />
    }<br />
    return results.(</em>Info), nil<br />
}<br />
Note that the closure we pass to group.Do must return (interface{}, error) to work with the Go type system. The third return value from group.Do, which is ignored in the example above, indicates whether the result was shared between multiple callers or not.</p><br />
<br />
<p>To see a more complete example, check out the code in the Encore Playground.</p><br />
<br />
<p>Package errgroup<br />
Another invaluable package is the errgroup package. It is best described as a sync.WaitGroup but where the tasks return errors that are propagated back to the waiter.</p><br />
<br />
<p>This package is useful when you have multiple operations that you want to wait for, but you also want to determine if they all completed successfully. For example, to build on the weather example from above, let’s say you want to lookup the weather for multiple cities at once, and fail if any of the lookups fails.</p><br />
<br />
<p>Start by defining an errgroup.Group, and use the group.Go(fn func() error) method for each city. This method spawns a goroutine to run the task. When you’ve spawned all the tasks you want, use group.Wait() to wait for them to complete. Note that this method returns an error, unlike sync.WaitGroup’s equivalent. The error is nil if and only if all the tasks returned a nil error.</p><br />
<br />
<p>In practice it looks like this:</p><br />
<br />
<p>func Cities(cities …string) ([]<em>Info, error) {<br />
    var g errgroup.Group<br />
    var mu sync.Mutex<br />
    res := make([]</em>Info, len(cities)) // res[i] corresponds to cities[i]</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i, city := range cities {<br />
    i, city := i, city // create locals for closure below<br />
    g.Go(func() error {<br />
        info, err := City(city)<br />
        mu.Lock()<br />
        res[i] = info<br />
        mu.Unlock()<br />
        return err<br />
    })<br />
}<br />
if err := g.Wait(); err != nil {<br />
    return nil, err<br />
}<br />
return res, nil } Here we are allocating an slice of results so that each goroutine can write to its own index. While the above code is safe even without the mu mutex, since each goroutine is writing to its own entry in the slice, we use one anyway in case the code is changed over time.<br />
</code></pre></div></div><br />
<br />
<p>Bounded concurrency<br />
The code above will lookup weather information for all the given cities concurrently. That’s fine when the number of cities is small, but can cause performance issues if the number of cities is massive. In those cases it’s useful to introduce bounded concurrency.</p><br />
<br />
<p>Go makes it really easy to create bounded concurrency with the use of semaphores. A semaphore is a concurrency primitive that you might have come across if you studied Computer Science, but if not, don’t worry. You can use semaphores for several purposes, but we’re just going to use them to keep track of how many tasks are running, and to block until there is room for another task to start.</p><br />
<br />
<p>In Go we can accomplish this through a clever use of channels! If we want to allow up to 10 tasks to run at once, we create a channel with space for 10 items: semaphore := make(chan struct{}, 10). You can picture this as a pipe that can fit 10 balls.</p><br />
<br />
<p>To start a new task, blocking if too many tasks are already running, we simply attempt to send a value on the channel: semaphore &lt;- struct{}{}. This is analogous to trying to push another ball into the pipe. If the pipe is full, it waits until there is room.</p><br />
<br />
<p>When a task completes, mark it as such by taking a value out of the channel: &lt;-semaphore. This is analogous to pulling a ball out at the other end of the pipe, which leaves room for another ball to be pushed in (another task started).</p><br />
<br />
<p>And that’s it! Our modified Cities looks like this:</p><br />
<br />
<p>func Cities(cities …string) ([]<em>Info, error) {<br />
    var g errgroup.Group<br />
    var mu sync.Mutex<br />
    res := make([]</em>Info, len(cities)) // res[i] corresponds to cities[i]<br />
    sem := make(chan struct{}, 10)<br />
    for i, city := range cities {<br />
        i, city := i, city // create locals for closure below<br />
        sem &lt;- struct{}{}<br />
        g.Go(func() error {<br />
            info, err := City(city)<br />
            mu.Lock()<br />
            res[i] = info<br />
            mu.Unlock()<br />
            &lt;-sem<br />
            return err<br />
        })<br />
    }<br />
    if err := g.Wait(); err != nil {<br />
        return nil, err<br />
    }<br />
    return res, nil<br />
}<br />
Weighted bounded concurrency<br />
And finally, sometimes you want bounded concurrency, but not all tasks are equally expensive. In that case the amount of resources we’ll consume will vary drastically depending on the distribution of cheap and expensive tasks and how they happen to start.</p><br />
<br />
<p>A better solution for this use case is to use weighted bounded concurrency. How this works is simple: instead of reasoning about the number of tasks we want to run concurrently, we come up with a “cost” for every task and acquire and release that cost from a semaphore.</p><br />
<br />
<p>We can’t model this with channels any longer since we need the whole cost acquired and released at once. Fortunately the “extended standard library” comes to our rescue once more! The golang.org/x/sync/sempahore package provides a weighted semaphore implementation exactly for this purpose.</p><br />
<br />
<p>The sem &lt;- struct{}{} operation is called “Acquire” and the &lt;-sem operation is called “Release”. You will note that the semaphore.Acquire method returns an error; that is because it can be used with the context package to abort the operation early. For the purpose of this example we will ignore it.</p><br />
<br />
<p>The weather lookup example is realistically too simple to warrant a weighted semaphore, but for the sake of simplicity let’s pretend the cost varies with the length of the city name. Then we arrive at the following:</p><br />
<br />
<p>func Cities(cities …string) ([]<em>Info, error) {<br />
    ctx := context.TODO() // replace with a real context<br />
    var g errgroup.Group<br />
    var mu sync.Mutex<br />
    res := make([]</em>Info, len(cities)) // res[i] corresponds to cities[i]<br />
    sem := semaphore.NewWeighted(100) // 100 chars processed concurrently<br />
    for i, city := range cities {<br />
        i, city := i, city // create locals for closure below<br />
        cost := int64(len(city))<br />
        if err := sem.Acquire(ctx, cost); err != nil {<br />
            break<br />
        }<br />
        g.Go(func() error {<br />
            info, err := City(city)<br />
            mu.Lock()<br />
            res[i] = info<br />
            mu.Unlock()<br />
            sem.Release(cost)<br />
            return err<br />
        })<br />
    }<br />
    if err := g.Wait(); err != nil {<br />
        return nil, err<br />
    } else if err := ctx.Err(); err != nil {<br />
        return nil, err<br />
    }<br />
    return res, nil<br />
}<br />
Conclusion<br />
The above examples show how easy it is to add concurrency to a Go program, and then fine-tune it based on your needs.</p><br />
<br />
<p>Feedback, corrections and suggestions on how this article can be improved are very welcome! Please reach out to me on Twitter.</p><br />
<br />
<p>We’re building something new<br />
This blog post comes directly from our experiences building a new project we call Encore.</p><br />
<br />
<p>We kept feeling that backend development took much longer than we liked, and that we had to spend so much time configuring build systems, managing Kubernetes yaml files, provisioning databases and more. We built Encore to solve all of these problems.</p><br />
<br />
<p>With Encore you can focus on the application itself. We take care of setting up all the infrastructure, from build and deployment systems to auto-scaling Kubernetes clusters and provisioning databases. That way you can focus on what makes your application unique, and create value for your users much faster than ever before.</p><br />
<br />
<p>We’re almost ready to launch, and would love to hear your thoughts!</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>