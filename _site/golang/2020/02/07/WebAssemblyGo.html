<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">WebAssembly Go</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-02-07T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Feb 7, 2020</time></p>
					</div>
					 <p>已经安装Go 1.11及以上版本。</p><br />
<br />
<p>Getting Started<br />
编辑main.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>import “fmt”</p><br />
<br />
<p>func main() {<br />
    fmt.Println(“Hello, Go WebAssembly!”)<br />
}<br />
把main.go build成WebAssembly(简写为wasm)二进制文件</p><br />
<br />
<p>GOOS=js GOARCH=wasm go build -o lib.wasm main.go<br />
把JavaScript依赖拷贝到当前路径</p><br />
<br />
<p>cp “$(go env GOROOT)/misc/wasm/wasm_exec.js” .</p><br />
<br />
<p>ls  /usr/local/go/misc/wasm/<br />
go_js_wasm_exec wasm_exec.html  wasm_exec.js</p><br />
<br />
<p>创建一个index.html文件，并引入wasm_exec.js文件，调用刚才build的lib.wasm</p><br />
<br />
<html><br />
    <head><br />
        <meta charset="utf-8" /><br />
        <script src="wasm_exec.js"></script><br />
        <script><br />
            const go = new Go();<br />
            WebAssembly.instantiateStreaming(fetch("lib.wasm"), go.importObject).then((result) => {<br />
                go.run(result.instance);<br />
            });<br />
        </script><br />
    </head><br />
    <body></body><br />
</html><br />
<p>创建server.go监听8080端口，serve当前路径</p><br />
<br />
<p>package main</p><br />
<br />
<p>import (<br />
  “flag”<br />
  “log”<br />
  “net/http”<br />
)</p><br />
<br />
<p>var (<br />
  listen = flag.String(“listen”, “:8080”, “listen address”)<br />
  dir    = flag.String(“dir”, “.”, “directory to serve”)<br />
)</p><br />
<br />
<p>func main() {<br />
  flag.Parse()<br />
  log.Printf(“listening on %q…”, <em>listen)<br />
  err := http.ListenAndServe(</em>listen, http.FileServer(http.Dir(*dir)))<br />
  log.Fatalln(err)<br />
}<br />
启动服务</p><br />
<br />
<p>go run server.go<br />
在浏览器访问localhost:8080,打开浏览器console，就可以看到输出Hello, Go WebAssembly!。</p><br />
<br />
<p>reference<br />
https://github.com/golang/go/wiki/WebAssembly<br />
<!-- more --><br />
编写main.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>import (<br />
  “strconv”<br />
  “syscall/js”<br />
)<br />
// 传入value1, value2, result三个元素的id，将value1+value2结果赋给result元素<br />
func add(ids []js.Value) {<br />
  // 根据id获取输入值<br />
  value1 := js.Global().Get(“document”).Call(“getElementById”, ids[0].String()).Get(“value”).String()<br />
  value2 := js.Global().Get(“document”).Call(“getElementById”, ids[1].String()).Get(“value”).String()</p><br />
<br />
<p>int1, _ := strconv.Atoi(value1)<br />
  int2, _ := strconv.Atoi(value2)<br />
  // 将相加结果set给result元素<br />
  js.Global().Get(“document”).Call(“getElementById”, ids[2].String()).Set(“value”, int1+int2)<br />
}</p><br />
<br />
<p>// 添加监听事件<br />
func registerCallbacks() {<br />
  js.Global().Set(“add”, js.NewCallback(add))<br />
}</p><br />
<br />
<p>func main() {<br />
  c := make(chan struct{}, 0)<br />
  println(“Go WebAssembly Initialized!”)<br />
  registerCallbacks()</p><br />
<br />
<p>&lt;-c<br />
}</p><br />
<br />
<p>将main.go编译成lib.wasm</p><br />
<br />
<p>GOOS=js GOARCH=wasm go build -o lib.wasm main.go<br />
在index.html中调用lib.wasm</p><br />
<br />
<html><br />
  <head><br />
    <meta charset="utf-8" /><br />
    <script src="wasm_exec.js"></script><br />
    <script><br />
      if (!WebAssembly.instantiateStreaming) { // polyfill<br />
        WebAssembly.instantiateStreaming = async (resp, importObject) => {<br />
          const source = await (await resp).arrayBuffer();<br />
          return await WebAssembly.instantiate(source, importObject);<br />
        };<br />
      }<br />
<br />
      const go = new Go();<br />
      let mod, inst;<br />
      WebAssembly.instantiateStreaming(fetch("lib.wasm"), go.importObject).then(async (result) => {<br />
        mod = result.module;<br />
        inst = result.instance;<br />
        await go.run(inst)<br />
      });<br />
    </script><br />
  </head><br />
  <body><br />
    <input type="text" id="value1" /><br />
    <input type="text" id="value2" /><br />
    <button type="button" id="add" onclick="add('value1', 'value2', 'result');">add</button><br />
    <input type="text" id="result" /><br />
  </body><br />
</html><br />
<p>打开server，在浏览器打开即可调用WebAssembly二进制文件执行。</p><br />
<br />
<p>go run server.go<br />
示例代码GitHub<br />
https://github.com/wlchn/go-webassembly<br />
reference<br />
https://tutorialedge.net/golang/go-webassembly-tutorial/</p><br />
<br />
<p>https://github.com/golang/go/wiki/WebAssembly<br />
https://godoc.org/syscall/js<br />
https://github.com/siongui/godom/<br />
https://github.com/gopherjs/gopherjs</p><br />
<br />
<p>WebAssembly（也称为wasm）将很快改变这种情况。使用WebAssembly可以用任何语言编写Web应用程序。在本文中，我们将了解如何编写Go程序并使用wasm在浏览器中运行它们。</p><br />
<br />
<p>但首先，什么是WebAssembly<br />
webassembly.org 将其定义为“基于堆栈的虚拟机的二进制指令格式”。这是一个很好的定义，但让我们将其分解为我们可以轻松理解的内容。</p><br />
<br />
<p>从本质上讲，wasm是一种二进制格式; 就像ELF，Mach和PE一样。唯一的区别是它适用于虚拟编译目标，而不是实际的物理机器。为何虚拟？因为不同于 C/C++ 二进制文件，wasm二进制文件不针对特定平台。因此，您可以在Linux，Windows和Mac中使用相同的二进制文件而无需进行任何更改。 因此，我们需要另一个“代理”，它将二进制文件中的wasm指令转换为特定于平台的指令并运行它们。通常，这个“代理”是一个浏览器，但从理论上讲，它也可以是其他任何东西。</p><br />
<br />
<p>这为我们提供了一个通用的编译目标，可以使用我们选择的任何编程语言构建Web应用程序！只要我们编译为wasm格式，我们就不必担心目标平台。就像我们编写一个Web应用程序一样，但是现在我们有了用我们选择的任何语言编写它的优势。</p><br />
<br />
<p>你好 WASM<br />
让我们从一个简单的“hello world”程序开始，但是要确保您的Go版本至少为1.11。我们可以这样写：</p><br />
<br />
<p>package main</p><br />
<br />
<p>import (<br />
    “fmt”<br />
)</p><br />
<br />
<p>func main() {<br />
    fmt.Println(“hello wasm”)<br />
}<br />
保存为test.go。看起来像是一个普通的Go程序。现在让我们将它编译为wasm平台程序。我们需要设置GOOS和GOARCH。</p><br />
<br />
<p>$GOOS=js GOARCH=wasm go build -o test.wasm test.go<br />
现在我们生成了 wasm 二进制文件。但与原生系统不同，我们需要在浏览器中运行它。为此，还需要再做一点工作来实现这一目标：</p><br />
<br />
<p>Web服务器来运行应用<br />
一个index.html文件，其中包含加载wasm二进制文件所需的一些js代码。<br />
还有一个js文件，它作为浏览器和我们的wasm二进制文件之间的通信接口。</p><br />
<br />
<p>现在Go目录中已经包含了html和js文件，因此我们将其复制过来。</p><br />
<br />
<p>$cp “$(go env GOROOT)/misc/wasm/wasm_exec.js” .<br />
$cp “$(go env GOROOT)/misc/wasm/wasm_exec.html” .</p><br />
<br />
<p>DOM API<br />
但首先，要使Go代码与浏览器进行交互，我们需要一个DOM API。我们有syscall/js库来帮助我们解决这个问题。它是一个非常简单却功能强大的DOM API形式，我们可以在其上构建我们的应用程序。在我们制作应用程序之前，让我们快速了解它的一些功能。</p><br />
<br />
<p>回调<br />
为了响应DOM事件，我们声明了回调并用这样的事件将它们连接起来：</p><br />
<br />
<p>import “syscall/js”</p><br />
<br />
<p>// Declare callback<br />
cb := js.NewEventCallback(js.PreventDefault, func(ev js.Value) {<br />
    // handle event<br />
})</p><br />
<br />
<p>// Hook it up with a DOM event<br />
js.Global().Get(“document”).<br />
    Call(“getElementById”, “myBtn”).<br />
    Call(“addEventListener”, “click”, cb)</p><br />
<br />
<p>// Call cb.Release() on your way out.<br />
更新DOM<br />
要从Go中更新DOM，我们可以</p><br />
<br />
<p>import “syscall/js”</p><br />
<br />
<p>js.Global().Get(“document”).<br />
        Call(“getElementById”, “myTextBox”).<br />
        Set(“value”, “hello wasm”)<br />
您甚至可以调用JS函数并操作本机JS对象，如 FileReader或Canvas。查看syscall/js文档以获取更多详细信息。</p><br />
<br />
<p>正确的 Web 应用程序<br />
接下来我们将构建一个小应用程序，它将获取输入的图像，然后对图像执行一些操作，如亮度，对比度，色调，饱和度，最后将输出图像发送回浏览器。 每个效果都会有滑块，用户可以更改这些效果并实时查看目标图像的变化。</p><br />
<br />
<p>首先，我们需要从浏览器获取输入的图像给到我们的Go代码，以便可以处理它。为了有效地做到这一点，我们需要采取一些不安全的技巧，这里跳过具体细节。拥有图像后，它完全在我们的控制之下，我们可以自由地做任何事情。下面是图像加载器回调的简短片段，为简洁起见略有简化：</p><br />
<br />
<p>onImgLoadCb = js.NewCallback(func(args []js.Value) {<br />
    reader := bytes.NewReader(inBuf) // inBuf is a []uint8 slice where our image is loaded<br />
    sourceImg, _, err := image.Decode(reader)<br />
    if err != nil {<br />
        // handle error<br />
    }<br />
    // Now the sourceImg is an image.Image with which we are free to do anything!<br />
})</p><br />
<br />
<p>js.Global().Set(“loadImage”, onImgLoadCb)<br />
然后我们从效果滑块中获取用户值，并操纵图像。我们使用了很棒的bild库。下面是回调的一小部分：</p><br />
<br />
<p>import “github.com/anthonynsimon/bild/adjust”</p><br />
<br />
<p>contrastCb = js.NewEventCallback(js.PreventDefault, func(ev js.Value) {<br />
    delta := ev.Get(“target”).Get(“valueAsNumber”).Float()<br />
    res := adjust.Contrast(sourceImg, delta)<br />
})</p><br />
<br />
<p>js.Global().Get(“document”).<br />
        Call(“getElementById”, “contrast”).<br />
        Call(“addEventListener”, “change”, contrastCb)<br />
在此之后，我们将目标图像编码为jpeg并将其发送回浏览器。这是完整的应用程序</p><br />
<br />
<p>由于Go是一种垃圾收集语言，因此整个运行时都在wasm二进制文件中。因此，二进制文件通常有几MB的大小。与C/Rust等其他语言相比，这仍然是一个痛点; 因为向浏览器发送MB级数据并不理想。但是，如果wasm规范本身支持GC，那么这可能会改变。<br />
Go中的Wasm支持正式进行试验。syscall/js API本身也在不断变化，未来可能会发生变化。如果您发现错误，请随时在我们issues报告问题。<br />
与所有技术一样，WebAssembly也不是一颗银弹。有时，简单的JS更快更容易编写。然而，wasm规范本身正在开发中，并且即将推出更多功能。线程支持就是这样一个特性。</p><br />
<br />
<p>环境<br />
需要golang版本高于go1.11, 本文golang版本:</p><br />
<br />
<p>升级go 版本后idea golang 标准库也标红 解决办法，将 /usr/local/go/ 也加入gopath 问题解决</p><br />
<br />
<p>$ go version</p><br />
<blockquote><br />
  <p>go version go1.11.1 darwin/amd64<br />
js中调用golang函数案例<br />
本案例基于goland IDE编写, 为了获取syscall/js库的自动提示, 需要对IDE进行如下设置:<br />
<img src="https://xiazemin.github.io/MyBlog/img/system_js.jpg" /></p><br />
</blockquote><br />
<br />
<p>点击File -&gt; Project Structure 打开项目结构配置窗口。 加载go1.13.5</p><br />
<br />
<p>解决方法是 File-Invalidate Caches 然后重启IDEA。</p><br />
<br />
<p>./webassembly.go:54:35: undefined: js.NewCallback</p><br />
<br />
<p>js.Global().Set(“jsFunctionName”, js.NewCallback(goCallback))<br />
should be as:</p><br />
<br />
<p>js.Global().Set(“jsFunctionName”, js.FuncOf(goCallback))<br />
Note the signature of goCallback has changed and now since Go 1.12, there is a support for return values. For example, here is how to expose a simple add function:</p><br />
<br />
<p>// function definition<br />
func add(this js.Value, i []js.Value) interface{} {<br />
  return js.ValueOf(i[0].Int()+i[1].Int())<br />
}</p><br />
<br />
<p>// exposing to JS<br />
js.Global().Set(“add”, js.FuncOf(add))</p><br />
<br />
<p>https://stackoverflow.com/questions/55800163/golangs-syscall-js-js-newcallback-is-undefined</p><br />
<br />
<p>./main.go:22:34: cannot use add (type func([]js.Value)) as type func(js.Value, []js.Value) interface {} in argument to js.FuncOf</p><br />
<br />
<p>//https://godoc.org/syscall/js<br />
//https://github.com/golang/go/wiki/WebAssembly#getting-started</p><br />
<br />
<p>https://github.com/vugu/vugu</p><br />
<br />
<p>在每个浏览器里面，无论Chrome，Firefox，Safari，Edge，能够运行的语言就是Javascript。为了能够让其他语言的代码在浏览器中运行，WebAssembly被创造出来。它拥有更好性能，更小的size，能够更快的加载和执行。我们无需编写WebAssembly的代码，只需要将其他高级语言编译成WebAssembly，这样就能在浏览器中复用大量的其他语言现有的代码。</p><br />
<br />
<p>WebAssembly仍在持续的发展，还有大量的特性即将到来。其最早发明出来是为了将C++的转译成JS，然后在浏览器中运行起来，这样就能把大量现有的C++代码在浏览器中复用。被转译后的JS代码比原生的JS代码要慢，Mozilla的工程师发现一种类型系统，可以让被转译后的JS运行得更快，这就是asm.js. 同时，其他浏览器厂商发现asm.js的运行速度非常快，也把这种优化加入到他们的浏览器引擎中。这仅仅是开始，工程师们仍在持续努力，但是，不是将其他语言编译成JS，而是一种新的语言，那就是WebAssembly。</p><br />
<br />
<p>最小可用产品</p><br />
<br />
<p>WebAssembly不仅仅支持C/C++，同时也希望支持更多的高级语言，因此，需要一个语言无关的编译目标，就像汇编语言一样，支持任何语言编译成汇编语言。这个编译目标有如下的特点：</p><br />
<br />
<p>跟具体的平台无关，因此不同平台的不同浏览器都能运行WebAssembly。<br />
拥有足够快的运行速度，能够带来足够流畅的交互体验。<br />
加载速度要足够快，因此，需要编译目标能够被压缩，减小加载内容的大小<br />
能够手动的管理，分配内存。我们知道C/C++一类的语言支持指针的特性，通过指针可以读写特定地址的内存；为了安全考虑，还要对限制特定地址的内存进行操作。出于以上的亮点，WebAssembly使用了线性内存模型。<br />
通过以上的特点，保证了WebAssembly能够在生产环境中使用起来。</p><br />
<br />
<p>如何应对繁重的桌面应用</p><br />
<br />
<p>我们知道，大量的桌面应用，像PS，AutoCAD，这些应用非常的庞大，对性能要求非常苛刻。要先让他们在浏览器里面运行起来非常的难，因此需要更多的特性来确保更佳的性能：</p><br />
<br />
<p>首当其冲的，是需要支持多线程。现代的计算机都是多核的，通过多线程能够更好的利用计算机的计算能力。<br />
SIMD(单指令多数据)。通过SIMD，能够将一组内存划分成不同的执行单元，就像多核一样。<br />
64位寻址。借助64位寻址，能够使用更多的内存，这对一些内存敏感性的应用是非常有利的。<br />
流式编译。前面提到了，提升加载的速度，其实我们有更好的办法，就是刚下载的时候就开始编译，这将是巨大的提升。<br />
HTTP缓存。如何两个浏览器加载相同的WebAssembly代码，将会编译成相同的机器码，因此可以将编译后的机器码保存在HTTP缓存中，这样就可以跳过编译的过程，复用机器码。<br />
现状<br />
多线程：一个草案已经接近完成，其中的关键SharedArrayBuffers，已经被否决了。<br />
SIMD：正在开发中…<br />
64位寻址：wasm-64即将登场<br />
流式编译：Firefox已经在2017年支持，其他浏览器也即将支持<br />
虽然这些特性仍在开发中，但是我们能够看到已经有大量的桌面应用在浏览器中运行起来，其中最大的幕后功臣就是WebAssembly。</p><br />
<br />
<p>WebAssembly与JavaScript</p><br />
<br />
<p>对于很多的web应用场景，我们可能只需要在一些性能敏感的部分，使用WebAssembly。因此，某些模块需要用WebAssembly来编写，然后替换掉那些JS写的部分。一个例子就是Firefox中的source map library的parser，它用WebAssembly编写，比原来用JS编写的快11倍。为了能让这种场景下，WebAssembly更好的发挥作用，有更多的要求：</p><br />
<br />
<p>JS和WASM能够更快的相互调用。因为要将WASM代码作为模块继承到现存的JS应用中，需要他们能够更快的相互调用，Firefox中已经有了巨大的提升<br />
快速而容易的数据转换。在JS和WASM相互调用时，需要传递数据，要想实现上面的两个目标，非常的难：WASM只理解数字，那就需要将各种数据格式转换成数字<br />
ES module。集成WASM模块，通常在JS中使用import，export关键词，因此，浏览器需要内置ES module。<br />
工具链。在JS中，可以使用npm，brower等工具，但是在WASM中，好像没有这个工具…<br />
兼容性。前端开发，都逃不了兼容性的问题。<br />
现状<br />
Firefox中，JS和WASM能够很快的调用<br />
引用类型草案登场，其增加了一种新的，WASM函数能够接收和返回的类型，这个类型引用一个外部的object，可以是JS的Object。<br />
一个ES module的草案被提及，浏览器厂商正在支持。<br />
Rust生态的wasm-pack能够像npm一样支持包管理<br />
借助wasm2js工具，能够让WASM在旧版的浏览器中得到支持<br />
通过以上的特性以及正在开发中的功能，WASM的能力得到释放，接下来就是如何再现有的Web生态中使用WASM。</p><br />
<br />
<p>应用</p><br />
<br />
<p>在前端开发中，大量涉及的框架及编译成JS的语言都将是WASM发挥作用的场景。所以就有两种选择了：1，使用WASM来重写现有的Web框架；2，将Reasonml，Elm等语言编译成WASM。为了实现这些功能，需要WASM提供更多高级语言的特性，包括：</p><br />
<br />
<p>GC。首先，提供GC功能对重写web框架是非常有优势的。例如：使用WASM重写React中的diff功能，借助多线程，手动的内存分配，能够提供以前无法现象的高性能，但是当你跟JS 对象交互时，例如组件，仍然需要GC来减轻开发的负担。<br />
异常处理。很多的高级语言，如C/C++提供异常处理，在某些特定场景下非常有用，同时JS也有异常处理，当WASM和JS互操作时，也需要有异常处理的支持。<br />
debug。这个就不多说<br />
现状<br />
JS拥有Typed Objects 草案，WASM拥有GC草案。通过这两个草案，JS和WASM都能够清晰的知道一个对象的结构以及如何去存储，使用，回收。<br />
异常处理。目前还在开发阶段。<br />
debug。目前，大多数浏览器已经支持。</p><br />
<br />
<p>https://hacks.mozilla.org/2018/10/webassemblys-post-mvp-future/</p><br />
<br />
<p>https://cloud.tencent.com/developer/article/1369556</p><br />
<br />
<p>able Of Contents<br />
Introduction<br />
Starting Point<br />
Function Registration<br />
Components<br />
Building a Router<br />
A Full Example<br />
Challenges Going Forward<br />
Conclusion<br />
JavaScript Frontend frameworks have undoubtedly helped to push the boundaries of what was previously possible in the context of a browser. Ever more complex applications have come out built on top of the likes of React, Angular and VueJS to name but a few and there’s the well known joke about how a new frontend framework seems to come out every day.</p><br />
<br />
<p>However, this pace of development is exceptionally good news for developers around the world. With each new framework, we discover better ways of handling state, or rendering efficiently with things like the shadow DOM.</p><br />
<br />
<p>The latest trend however, seems to be moving towards writing these frameworks in languages other than JavaScript and compiling them into WebAssembly. We’re starting to see major improvements in the way that JavaScript and WebAssembly communicates thanks to the likes of Lin Clark and we’ll undoubtedly see more major improvements as WebAssembly starts to become more prominent in our lives.</p><br />
<br />
<p>Introduction<br />
So, in this tutorial, I thought it would be a good idea to build the base of an incredibly simple frontend framework written in Go that compiles into WebAssembly. At a minimum, this will include the following features:</p><br />
<br />
<p>Function Registration<br />
Components<br />
Super Simplistic-Routing<br />
I’m warning you now though that these are going to be incredibly simple and nowhere near production ready. If this is article is somewhat popular, I’ll hopefully be taking it forward however, and trying to build something that meets the requirements of a semi-decent frontend framework.</p><br />
<br />
<p>Github: The full source code of this project can be found here: elliotforbes/oak. If you fancy contributing to the project, feel free, I’d be happy to get any pull requests!</p><br />
<br />
<p>Starting Point<br />
Right, let’s dive into our editor of choice and start coding! The first thing we’ll want to do is create a really simple index.html that will act as our entry point for our frontend framework:</p><br />
<br />
<p>1&lt;!doctype html&gt;<br />
 2<!--<br />
 3Copyright 2018 The Go Authors. All rights reserved.<br />
 4Use of this source code is governed by a BSD-style<br />
 5license that can be found in the LICENSE file.<br />
 6--><br />
 7&lt;html&gt;<br />
 8<br />
 9&lt;head&gt;<br />
10    <meta charset="utf-8" /><br />
11    <title>Go wasm</title><br />
12    <script src="./static/wasm_exec.js"></script><br />
13    <script src="./static/entrypoint.js"></script><br />
14&lt;/head&gt;<br />
15&lt;body&gt;  <br /><br />
16<br />
17  &lt;div class="container"&gt;<br />
18    &lt;h2&gt;Oak WebAssembly Framework&lt;/h2&gt;<br />
19  &lt;/div&gt;<br />
20&lt;/body&gt;<br />
21<br />
22&lt;/html&gt;<br />
You’ll notice these have 2 js files being imported at the top, these allow us to execute our finished WebAssembly binary. The first of which is about 414 lines long so, in the interest of keeping this tutorial readable, I recommend you download it from here: https://github.com/elliotforbes/oak/blob/master/examples/blog/static/wasm_exec.js</p><br />
<br />
<p>The second is our entrypoint.js file. This will fetch and run the lib.wasm that we’ll be building very shortly.</p><br />
<br />
<p>1// static/entrypoint.js<br />
2const go = new Go();<br />
3WebAssembly.instantiateStreaming(fetch(“lib.wasm”), go.importObject).then((result) =&gt; {<br />
4    go.run(result.instance);<br />
5});<br />
Finally, now that we have that out of the way, we can start diving into some Go code! Create a new file called main.go which will contain the entry point to our Oak Web Framework!</p><br />
<br />
<p>1// main.go<br />
2package main<br />
3<br />
4func main() {<br />
5    println(“Oak Framework Initialized”)<br />
6}<br />
This is as simple as it gets. We’ve created a really simple Go program that should just print out Oak Framework Initialized when we open up our web app. To verify that everything works, we need to compile this using the following command:</p><br />
<br />
<p>1$ GOOS=js GOARCH=wasm go build -o lib.wasm main.go<br />
This should then build our Go code and output our lib.wasm file which we referenced in our entrypoint.js file.</p><br />
<br />
<p>Awesome, if everything worked, then we are ready to try it out in the browser! We can use a really simple file server like this:</p><br />
<br />
<p>1// server.go<br />
 2package main<br />
 3<br />
 4import (<br />
 5    “flag”<br />
 6    “log”<br />
 7    “net/http”<br />
 8)<br />
 9<br />
10var (<br />
11    listen = flag.String(“listen”, “:8080”, “listen address”)<br />
12    dir    = flag.String(“dir”, “.”, “directory to serve”)<br />
13)<br />
14<br />
15func main() {<br />
16    flag.Parse()<br />
17    log.Printf(“listening on %q…”, <em>listen)<br />
18    log.Fatal(http.ListenAndServe(</em>listen, http.FileServer(http.Dir(*dir))))<br />
19}<br />
You can then serve your application by typing go run server.go and you should be able to access your app from http://localhost:8080.</p><br />
<br />
<p>Function Registration<br />
Ok, so we’ve got a fairly basic print statement working, but in the grand scheme of things, I don’t quite think that qualifies it as a Web Framework just yet.</p><br />
<br />
<p>Let’s take a look at how we can build functions in Go and register these so we can call them in our index.html. We’ll create a new utility function which will take in both a string which will be the name of our function as well as the Go function it will map to.</p><br />
<br />
<p>Add the following to your existing main.go file:</p><br />
<br />
<p>1// main.go<br />
2import “syscall/js”<br />
3<br />
4// RegisterFunction<br />
5func RegisterFunction(funcName string, myfunc func(i []js.Value)) {<br />
6    js.Global().Set(funcName, js.NewCallback(myfunc))<br />
7}<br />
So, this is where things start to become a bit more useful. Our framework now allows us to register functions so users of the framework can start creating their own functionality.</p><br />
<br />
<p>Other projects using our framework can start to register their own functions that can subsequently be used within their own frontend applications.</p><br />
<br />
<p>Components<br />
So, I guess the next thing we need to consider adding to our framework is the concept of components. Basically, I want to be able to define a components/ directory within a project that uses this, and within that directory I want to be able to build like a home.gocomponent that features all the code needed for my homepage.</p><br />
<br />
<p>So, how do we go about doing this?</p><br />
<br />
<p>Well, React tends to feature classes that feature render() functions which return the HTML/JSX/whatever code you wish to render for said component. Let’s steal this and use it within our own components.</p><br />
<br />
<p>I essentially want to be able to do something like this within a project that uses this framework:</p><br />
<br />
<p>1package components<br />
2<br />
3type HomeComponent struct{}<br />
4<br />
5var Home HomeComponent<br />
6<br />
7func (h HomeComponent) Render() string {<br />
8    return “&lt;h2&gt;Home Component&lt;/h2&gt;”<br />
9}<br />
So, within my components package, I define a HomeComponent which features a Render() method which returns our HTML.</p><br />
<br />
<p>In order to add components to our framework, we’ll keep it simple and just define an interface to which any components we subsequently define will have to adhere to. Create a new file called components/comopnent.go within our Oak framework:</p><br />
<br />
<p>1// components/component.go<br />
2package component<br />
3<br />
4type Component interface {<br />
5    Render() string<br />
6}<br />
What happens if we want to add new functions to our various components? Well, this allows us to do just that. We can use the oak.RegisterFunction call within the initfunction of our component to register any functions we want to use within our component!</p><br />
<br />
<p>1package components<br />
 2<br />
 3import (<br />
 4    “syscall/js”<br />
 5<br />
 6    “github.com/elliotforbes/oak”<br />
 7)<br />
 8<br />
 9type AboutComponent struct{}<br />
10<br />
11var About AboutComponent<br />
12<br />
13func init() {<br />
14    oak.RegisterFunction(“coolFunc”, CoolFunc)<br />
15}<br />
16<br />
17func CoolFunc(i []js.Value) {<br />
18    println(“does stuff”)<br />
19}<br />
20<br />
21func (a AboutComponent) Render() string {<br />
22    return <code class="language-plaintext highlighter-rouge">&lt;div&gt;<br />
23                        &lt;h2&gt;About Component Actually Works&lt;/h2&gt;<br />
24                        &lt;button onClick="coolFunc();"&gt;Cool Func&lt;/button&gt;<br />
25                    &lt;/div&gt;</code><br />
26}<br />
When we combine this with a router, we should be able to see our HTML being rendered to our page and we should be able to click that button which calls coolFunc() and it will print out does stuff within our browser console!</p><br />
<br />
<p>Awesome, let’s see how we can go about building a simple router now.</p><br />
<br />
<p>Building a Router<br />
Ok, so we’ve got the concept of components within our web framework down. We’ve almost finished right?</p><br />
<br />
<p>Not quite, the next thing we’ll likely need is a means to navigate between different components. Most frameworks seem to have a &lt;div&gt; with a particular id that they bind to and render all their components within, so we’ll steal that same tactic within Oak.</p><br />
<br />
<p>Let’s create a router/router.go file within our oak framework so that we can start hacking away.</p><br />
<br />
<p>Within this, we’ll want to map string paths to components, we wont do any URL checking, we’ll just keep everything in memory for now to keep things simple:</p><br />
<br />
<p>1// router/router.go<br />
 2package router<br />
 3<br />
 4import (<br />
 5    “syscall/js”<br />
 6<br />
 7    “github.com/elliotforbes/oak/component”<br />
 8)<br />
 9<br />
10type Router struct {<br />
11    Routes map[string]component.Component<br />
12}<br />
13<br />
14var router Router<br />
15<br />
16func init() {<br />
17    router.Routes = make(map[string]component.Component)<br />
18}<br />
So within this, we’ve created a new Router struct which contains Routes which are a map of strings to the components we defined in the previous section.</p><br />
<br />
<p>Routing won’t be a mandatory concept within our framework, we’ll want users to choose when they wish to initialize a new router. So let’s create a new function that will register a Link function and also bind the first route in our map to our &lt;div id="view"/&gt; html tag:</p><br />
<br />
<p>1// router/router.go<br />
 2// …<br />
 3func NewRouter() {<br />
 4    js.Global().Set(“Link”, js.NewCallback(Link))<br />
 5    js.Global().Get(“document”).Call(“getElementById”, “view”).Set(“innerHTML”, “”)<br />
 6}<br />
 7<br />
 8func RegisterRoute(path string, component component.Component) {<br />
 9    router.Routes[path] = component<br />
10}<br />
11<br />
12func Link(i []js.Value) {<br />
13    println(“Link Hit”)<br />
14<br />
15    comp := router.Routes[i[0].String()]<br />
16    html := comp.Render()<br />
17<br />
18    js.Global().Get(“document”).Call(“getElementById”, “view”).Set(“innerHTML”, html)<br />
19}<br />
You should notice, we’ve created a RegisterRoute function which allows us to register a path to a given component.</p><br />
<br />
<p>Our Link function is also pretty cool in the sense that it will allow us to navigate between various components within a project. We can specify really simple <button>elements to allow us to navigate to registered paths like so:</button></p><br />
<br />
<p>1<button onclick="Link('link')">Clicking this will render our mapped Link component</button><br />
Awesome, so we’ve got a really simple router up and running now, if we wanted to use this in a simple application we could do so like this:</p><br />
<br />
<p>1// my-project/main.go<br />
 2package main<br />
 3<br />
 4import (<br />
 5    “github.com/elliotforbes/oak”<br />
 6    “github.com/elliotforbes/oak/examples/blog/components”<br />
 7    “github.com/elliotforbes/oak/router”<br />
 8)<br />
 9<br />
10func main() {<br />
11    // Starts the Oak framework<br />
12    oak.Start()<br />
13<br />
14    // Starts our Router<br />
15    router.NewRouter()<br />
16    router.RegisterRoute(“home”, components.Home)<br />
17    router.RegisterRoute(“about”, components.About)<br />
18<br />
19    // keeps our app running<br />
20    done := make(chan struct{}, 0)<br />
21    &lt;-done<br />
22}<br />
A Full Example<br />
With all of this put together, we can start building really simple web applications that feature components and routing. If you want to see a couple of examples as to how this works, then check out the examples within the official repo: elliotforbes/oak/examples</p><br />
<br />
<p>Challenges Going Forward<br />
The code in this framework is in no way production ready, but I’m hoping this post kicks off good discussion as to how we can start building more production ready frameworks in Go.</p><br />
<br />
<p>If nothing else, it starts the journey of identifying what still has to be done to make this a viable alternative to the likes of React/Angular/VueJS, all of which are phenomenal frameworks that massively speed up developer productivity.</p><br />
<br />
<p>I’m hoping this article motivates some of you to go off and start looking at how you can improve on this incredibly simple starting point.</p><br />
<br />
<p>Conclusion<br />
If you enjoyed this tutorial, then please feel free to share it to your friends, on your twitter, or wherever you feel like, it really helps the site and directly supports me writing more!</p><br />
<br />
<p>I’m also on YouTube, so feel free to subscribe to my channel for more Go content! - TutorialEdge.</p><br />
<br />
<p>The full source code for the Oak framework can be found here: github.com/elliotforbes/oak. Feel free to submit PRs!</p><br />
<br />
<p>https://www.vugu.org/doc/start<br />
https://github.com/vugu/vugu</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>