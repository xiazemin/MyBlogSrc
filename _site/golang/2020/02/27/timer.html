<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>æ³½æ°‘åšå®¢ | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--ç™¾åº¦ç»Ÿè®¡-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--è½®æ’­å›¾ç‰‡-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--æ°´å°-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'æ³½æ°‘åšå®¢',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--æ°´å°-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">æ³½æ°‘åšå®¢</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">go1.14åŸºäºnetpollä¼˜åŒ–timerå®šæ—¶å™¨å®ç°åŸç†</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by å¤æ³½æ°‘</span></span> <time datetime="2020-02-27T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Feb 27, 2020</time></p>
					</div>
					 <p>http://xiaorui.cc/2020/02/11/go1-14%e5%9f%ba%e4%ba%8enetpoll%e4%bc%98%e5%8c%96timer%e5%ae%9a%e6%97%b6%e5%99%a8%e5%ae%9e%e7%8e%b0%e5%8e%9f%e7%90%86/<br />
golang1.14ç‰ˆçš„rcå·²ç»å‘å¸ƒæœ‰äº›æ—¥å­äº†ï¼Œåœ¨å®˜æ–¹go1.14çš„ä»‹ç»é‡Œæœ‰è¯´ä¼˜åŒ–äº†timerå®šæ—¶å™¨ã€‚golangçš„å®šæ—¶å™¨å·²ç»ç»å†äº†å‡ ç‰ˆçš„ä¼˜åŒ–ï¼Œä½†åœ¨ä¾èµ–å®šæ—¶å™¨çš„é«˜æ€§èƒ½åœºæ™¯ï¼Œè¿˜æ˜¯æˆä¸ºä¸€ä¸ªå¤§çš„æ€§èƒ½æ€æ‰‹ã€‚<br />
<!-- more --><br />
go1.13å’Œgo1.14çš„åŒºåˆ«ï¼Ÿ</p><br />
<br />
<p>åºŸè¯ä¸å¤šè¯´ï¼Œæ¥å¥½å¥½ä»‹ç»ä¸‹å®šæ—¶å™¨åœ¨go 1.13 å’Œ go1.14ä¸­çš„åŒºåˆ«ï¼Ÿ</p><br />
<br />
<p>golangåœ¨1.10ç‰ˆæœ¬ä¹‹å‰æ˜¯ç”±ä¸€ä¸ªç‹¬ç«‹çš„timerprocé€šè¿‡å°é¡¶å †å’Œfutexsleepæ¥ç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚1.10ä¹‹åé‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯æŠŠç‹¬ç«‹çš„timerprocå’Œå°é¡¶å †åˆ†æˆæœ€å¤š64ä¸ªtimerprocåç¨‹å’Œå››å‰å †ï¼Œç”¨æ¥ä¼‘çœ å°±è¿‘æ—¶é—´çš„æ–¹æ³•è¿˜æ˜¯ä¾èµ–futex timeoutæœºåˆ¶ã€‚é»˜è®¤timerprocæ•°é‡ä¼šè·ŸGOMAXPROCSä¸€è‡´çš„ï¼Œä½†æœ€å¤§ä¹Ÿå°±64ä¸ªï¼Œå› ä¸ºä¼šè¢«64å–æ‘¸ã€‚</p><br />
<br />
<p>é‚£ä¹ˆç®€å•è¯´go1.14ç‰ˆçš„timeræ˜¯å¦‚ä½•ä¼˜åŒ–æ€§èƒ½ï¼Ÿé¦–å…ˆæŠŠå­˜æ”¾å®šæ—¶äº‹ä»¶çš„å››å‰å †æ”¾åˆ°pç»“æ„ä¸­ï¼Œå¦å¤–å–æ¶ˆäº†timerprocåç¨‹ï¼Œè½¬è€Œä½¿ç”¨netpollçš„epoll waitæ¥åšå°±è¿‘æ—¶é—´çš„ä¼‘çœ ç­‰å¾…ã€‚åœ¨æ¯æ¬¡runtime.scheduleè°ƒåº¦æ—¶éƒ½æ£€æŸ¥è¿è¡Œåˆ°æœŸçš„å®šæ—¶å™¨ã€‚</p><br />
<br />
<p>å¿«é€Ÿæµè§ˆgo1.13çš„å®šæ—¶å™¨å®ç°åŸç†</p><br />
<br />
<p>åœ¨è¿™é‡Œç®€å•çš„è¿‡ä¸€égo1.13ç‰ˆå®šæ—¶å™¨çš„å®ç°ï¼Œå†ç»†èŠ‚å¯ä»¥çœ‹ä¸‹æˆ‘å†™è¿‡çš„æ–‡ç« ã€‚</p><br />
<br />
<p>ä¸ç®¡æ˜¯NewTimerã€NewTickerã€Afterç­‰å…¶å®è°ƒç”¨çš„éƒ½æ˜¯addTimeræ¥æ–°å¢å®šæ—¶ä»»åŠ¡ï¼ŒassignBucketç»™å½“å‰åç¨‹åˆ†é…ä¸€ä¸ªtimerBucketã€‚goåˆå§‹åŒ–æ—¶ä¼šé¢„å…ˆå®ä¾‹åŒ–é•¿åº¦64çš„timersæ•°ç»„ï¼Œé€šè¿‡åç¨‹çš„pè·Ÿ64å–æ‘¸æ¥åˆ†é…timerBucketã€‚å¦‚æœæ–°çš„å®šæ—¶ä»»åŠ¡è¾ƒæ–°ï¼Œé‚£ä¹ˆä½¿ç”¨notewakeupæ¥æ¿€æ´»å”¤é†’timerprocçš„futexç­‰å¾…ã€‚å¦‚æœå‘ç°æ²¡æœ‰å®ä¾‹åŒ–timerprocï¼Œåˆ™å¯åŠ¨ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>const timersLen = 64</p><br />
<br />
<p>var timers [timersLen]struct {<br />
    timersBucket<br />
}</p><br />
<br />
<p>func addtimer(t *timer) {<br />
    tb := t.assignBucket()<br />
    lock(&amp;tb.lock)<br />
    ok := tb.addtimerLocked(t)<br />
    unlock(&amp;tb.lock)<br />
    ,,,<br />
}</p><br />
<br />
<p>func (t *timer) assignBucket() *timersBucket {<br />
    id := uint8(getg().m.p.ptr().id) % timersLen<br />
    t.tb = &amp;timers[id].timersBucket<br />
    return t.tb<br />
}</p><br />
<br />
<p>func (tb *timersBucket) addtimerLocked(t *timer) bool {<br />
    t.i = len(tb.t)<br />
    tb.t = append(tb.t, t)<br />
    if !siftupTimer(tb.t, t.i) {<br />
        return false<br />
    }<br />
    if t.i == 0 {<br />
        if tb.sleeping &amp;&amp; tb.sleepUntil &gt; t.when {<br />
            tb.sleeping = false<br />
            notewakeup(&amp;tb.waitnote)<br />
        }<br />
        ,,,<br />
        if !tb.created {<br />
            tb.created = true<br />
            go timerproc(tb)<br />
        }<br />
    }<br />
    return true<br />
}<br />
timerprocåç¨‹è¿è¡Œæ—¶ä¼šä»å †é¡¶æ‹¿timerï¼Œç„¶ååˆ¤æ–­æ˜¯å¦åˆ°æœŸï¼Œåˆ°æœŸåˆ™ç›´æ¥æ‰§è¡Œï¼Œå½“bucketæ— ä»»åŠ¡æ—¶ï¼Œè°ƒç”¨runtime.goparkunlockæ¥ä¼‘çœ è¯¥åç¨‹ã€‚å½“è‡³å°‘æœ‰ä¸€ä¸ªtimerä»»åŠ¡æ—¶ï¼Œåˆ™é€šè¿‡notetsleepgä¼ å…¥ä¸‹æ¬¡çš„åˆ°æœŸæ—¶é—´æ¥è¿›è¡Œä¼‘çœ ã€‚å€¼å¾—ä¸€è¯´çš„æ˜¯notetsleepgä¼šè°ƒç”¨entersyscallblockè§¦å‘handoffpï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬åœ¨æ–‡ç« åæœ‰è¯´æ˜ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>func timerproc(tb *timersBucket) {<br />
    tb.gp = getg()<br />
    for {<br />
        lock(&amp;tb.lock)<br />
        now := nanotime()<br />
        delta := int64(-1)<br />
        for {<br />
            t := tb.t[0]<br />
            delta = t.when - now<br />
            if delta &gt; 0 {<br />
               break<br />
            }<br />
            arg := t.arg<br />
            seq := t.seq<br />
            unlock(&amp;tb.lock)<br />
            ,,,<br />
            f(arg, seq)<br />
            lock(&amp;tb.lock)<br />
        }<br />
        if delta &lt; 0 || faketime &gt; 0 {<br />
            // No timers left - put goroutine to sleep.<br />
            goparkunlock(&amp;tb.lock, waitReasonTimerGoroutineIdle, traceEvGoBlock, 1)<br />
            continue<br />
        }<br />
     }<br />
     ,,,<br />
     tb.sleepUntil = now + delta<br />
     unlock(&amp;tb.lock)<br />
     notetsleepg(&amp;tb.waitnote, delta)<br />
}<br />
timerprocçš„notetsleepgç”¨æ¥ä¼‘çœ ï¼ŒaddTimerLockedçš„notewakeupç”¨æ¥å”¤é†’ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>// notetsleepg -&gt; notetsleep_internal -&gt; futexsleep<br />
func futexsleep(addr *uint32, val uint32, ns int64) {<br />
    var ts timespec<br />
    ts.setNsec(ns) <br />
    futex(unsafe.Pointer(addr), _FUTEX_WAIT_PRIVATE, val, unsafe.Pointer(&amp;ts), nil, 0)<br />
}</p><br />
<br />
<p>// notewakeup -&gt; futexwakeup<br />
func futexwakeup(addr *uint32, cnt uint32) {<br />
    ret := futex(unsafe.Pointer(addr), _FUTEX_WAKE_PRIVATE, cnt, nil, nil, 0)<br />
    ,,,<br />
}<br />
æºç åˆ†ægo1.14 timer</p><br />
<br />
<p>åœ¨struct pä¸­å®šä¹‰äº†timerç›¸å…³å­—æ®µï¼Œtimersæ•°ç»„ç”¨æ¥åšå››å‰å †æ•°æ®ç»“æ„ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>type p struct {<br />
        // ä¿æŠ¤timerså †è¯»å†™å®‰å…¨<br />
        timersLock mutex</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // å­˜æ”¾å®šæ—¶å™¨ä»»åŠ¡<br />
    timers []*timer<br />
<br />
    ,,, } å®šæ—¶å™¨timerç»“æ„çš„å®šä¹‰.<br />
</code></pre></div></div><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>type timer struct {<br />
    pp puintptr  // pçš„ä½ç½®</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>when   int64 // åˆ°æœŸæ—¶é—´<br />
period int64 // å‘¨æœŸæ—¶é—´ï¼Œé€‚åˆticker<br />
f      func(interface{}, uintptr) // å›è°ƒæ–¹æ³•<br />
arg    interface{}  // å‚æ•°<br />
seq    uintptr  // åºå·<br />
<br />
nextwhen int64 // ä¸‹æ¬¡çš„åˆ°æœŸæ—¶é—´<br />
status uint32 // çŠ¶æ€ } å¦‚ä½•å¢åŠ å®šæ—¶ä»»åŠ¡çš„ï¼Ÿ<br />
</code></pre></div></div><br />
<br />
<p>æˆ‘ä»¬è°ƒç”¨NewTimerã€Afterã€AfterFuncæ—¶ä¼šæ„å»ºruntimeTimerå®šæ—¶ç»“æ„ï¼Œç„¶åé€šè¿‡runttime.startTimeræ¥æ’å…¥åˆ°æ—¶é—´å †é‡Œã€‚å¦å¤–åœ¨ä¿®æ”¹ï¼Œé‡ç½®å®šæ—¶å™¨çš„é€»è¾‘éƒ½ä¼šå°è¯•è°ƒç”¨wakeNetPolleræ¥å”¤é†’netpollerã€‚</p><br />
<br />
<p>æ³¨æ„ï¼Œtime/sleep.goé‡Œçš„runtimeTimerè·Ÿruntimeçš„timerç»“æ„æ˜¯ä¸€è‡´çš„ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>time/sleep.go</p><br />
<br />
<p>func NewTimer(d Duration) *Timer {<br />
    c := make(chan Time, 1)<br />
    t := &amp;Timer{<br />
        C: c,<br />
        r: runtimeTimer{<br />
            when: when(d),<br />
            f:    sendTime,<br />
            arg:  c,<br />
        },<br />
    }<br />
    startTimer(&amp;t.r)<br />
    return t<br />
}</p><br />
<br />
<p>func After(d Duration) &lt;-chan Time {<br />
    return NewTimer(d).C<br />
}</p><br />
<br />
<p>func AfterFunc(d Duration, f func()) *Timer {<br />
    t := &amp;Timer{<br />
        r: runtimeTimer{<br />
            when: when(d),<br />
            f:    goFunc,<br />
            arg:  f,<br />
        },<br />
    }<br />
    startTimer(&amp;t.r)<br />
    return t<br />
}</p><br />
<br />
<p>func goFunc(arg interface{}, seq uintptr) {<br />
    go arg.(func())()<br />
}</p><br />
<br />
<p>func sendTime(c interface{}, seq uintptr) {<br />
    select {<br />
    case c.(chan Time) &lt;- Now():<br />
    default:<br />
    }<br />
}<br />
ä¸‹é¢æ˜¯å…·ä½“æ“ä½œå®šæ—¶å™¨æ·»åŠ çš„è¿‡ç¨‹ï¼Œtime/sleep.goå¯ä»¥ç†è§£ä¸ºåº”ç”¨å±‚å®šæ—¶å™¨çš„å°è£…ï¼Œruntime/time.goæ˜¯å®šæ—¶å™¨è°ƒåº¦çš„å°è£…ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>// é€šè¿‡linkåšæ–¹æ³•æ˜ å°„ï¼Œç®€å•è¯´time/sleep.goé‡Œè°ƒç”¨çš„time.startTimerå…¶å®æ˜¯runtimeåŒ…é‡Œçš„ã€‚<br />
//go:linkname startTimer time.startTimer<br />
func startTimer(t *timer) {<br />
    addtimer(t)<br />
}</p><br />
<br />
<p>// æŠŠå®šæ—¶ä»»åŠ¡æ”¾åˆ°å½“å‰gå…³è”çš„Pé‡Œã€‚<br />
func addtimer(t *timer) {<br />
    if t.when &lt; 0 {<br />
        t.when = maxWhen<br />
    }<br />
    t.status = timerWaiting  // çŠ¶æ€ä¸ºç­‰å¾…ä¸­</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>addInitializedTimer(t) }<br />
</code></pre></div></div><br />
<br />
<p>// åŠ é”æ¥æ¸…ç†ä»»åŠ¡ï¼Œå¹¶ä¸”å¢åŠ å®šæ—¶ä»»åŠ¡ï¼Œæœ€åæ ¹æ®æ—¶é—´å°±è¿‘æ¥å”¤é†’netpoll<br />
func addInitializedTimer(t *timer) {<br />
    when := t.when</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pp := getg().m.p.ptr()<br />
lock(&amp;pp.timersLock)<br />
ok := cleantimers(pp) &amp;&amp; doaddtimer(pp, t)<br />
unlock(&amp;pp.timersLock)<br />
if !ok {<br />
    badTimer()<br />
}<br />
<br />
wakeNetPoller(when) } å½“æ–°æ·»åŠ çš„å®šæ—¶ä»»åŠ¡whenå°äºnetpollç­‰å¾…çš„æ—¶é—´ï¼Œé‚£ä¹ˆwakeNetPollerä¼šæ¿€æ´»NetPollçš„ç­‰å¾…ã€‚æ¿€æ´»çš„æ–¹æ³•å¾ˆç®€å•ï¼Œåœ¨findrunnableé‡Œçš„æœ€åä¼šä½¿ç”¨è¶…æ—¶é˜»å¡çš„æ–¹æ³•è°ƒç”¨epollwaitï¼Œè¿™æ ·æ—¢å¯ç›‘æ§äº†epfdçº¢é»‘æ ‘ä¸Šçš„fdï¼Œåˆå¯å…¼é¡¾æœ€è¿‘çš„å®šæ—¶ä»»åŠ¡çš„ç­‰å¾…ã€‚<br />
</code></pre></div></div><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>var (<br />
    epfd int32 = -1 // epoll descriptor<br />
    netpollBreakRd, netpollBreakWr uintptr // ç”¨æ¥ç»™netpollä¸­æ–­<br />
)</p><br />
<br />
<p>// åˆå§‹åŒ–å…¨å±€çš„epfdåŠbreakçš„ä¸¤ä¸ªè¯»å†™ç®¡é“<br />
func netpollinit() {<br />
    epfd = epollcreate1(_EPOLL_CLOEXEC)<br />
    ,,,<br />
    r, w, errno := nonblockingPipe() // rä¸ºç®¡é“çš„è¯»ç«¯ï¼Œwä¸ºå†™ç«¯<br />
    ,,,<br />
    errno = epollctl(epfd, _EPOLL_CTL_ADD, r, &amp;ev)  // æŠŠç®¡é“çš„rç«¯åŠ åˆ°epfdé‡Œè¿›è¡Œç›‘å¬<br />
    ,,,<br />
    netpollBreakRd = uintptr(r)<br />
    netpollBreakWr = uintptr(w)<br />
}</p><br />
<br />
<p>// å”¤é†’æ­£åœ¨netpollä¼‘çœ çš„çº¿ç¨‹ï¼Œå‰ææ˜¯whençš„å€¼å°äºpollUntilæ—¶é—´ã€‚<br />
func wakeNetPoller(when int64) {<br />
    if atomic.Load64(&amp;sched.lastpoll) == 0 {<br />
        pollerPollUntil := int64(atomic.Load64(&amp;sched.pollUntil))<br />
        if pollerPollUntil == 0 || pollerPollUntil &gt; when {<br />
            netpollBreak()<br />
        }<br />
    }<br />
}</p><br />
<br />
<p>// netpollBreakWræ˜¯ä¸€ä¸ªç®¡é“ï¼Œç”¨writeç»™netpollBreakWrå†™æ•°æ®ï¼Œè¿™æ ·netpollè‡ªç„¶å°±å¯è¢«å”¤é†’ã€‚<br />
func netpollBreak() {<br />
    for {<br />
        var b byte<br />
        n := write(netpollBreakWr, unsafe.Pointer(&amp;b), 1)<br />
        if n == 1 {<br />
            break<br />
        }<br />
        if n == -_EINTR {<br />
            continue<br />
        }<br />
        if n == -_EAGAIN {<br />
            return<br />
        }<br />
        println(â€œruntime: netpollBreak write failed withâ€, -n)<br />
        throw(â€œruntime: netpollBreak write failedâ€)<br />
    }<br />
}<br />
å¢åŠ å’Œä¿®æ”¹çš„é€»è¾‘å¤§åŒå°å¼‚ï¼Œä½†æ˜¯åˆ é™¤ä¸ä¸€æ ·ï¼Œåˆ é™¤æ›´å¤šçš„æ˜¯æ ‡è®°timerç»“æ„ä¸­çš„statusä¸ºtimerDeletedçŠ¶æ€ï¼Œè¿™æ ·å½“checkTimers</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>// time/sleep.goçš„stopTimerç”¨çš„æ˜¯runtime.stopTimeræ–¹æ³•<br />
//go:linkname stopTimer time.stopTimer<br />
func stopTimer(t *timer) bool {<br />
    return deltimer(t)<br />
}</p><br />
<br />
<p>func deltimer(t *timer) bool {<br />
    for {<br />
        switch s := atomic.Load(&amp;t.status); s {<br />
        case timerWaiting, timerModifiedLater:<br />
            // åŸå­æ›´æ–°ä¸ºåˆ é™¤<br />
            if atomic.Cas(&amp;t.status, s, timerDeleted) {<br />
                atomic.Xadd(&amp;tpp.deletedTimers, 1)<br />
                return true<br />
            }<br />
        ,,,<br />
        // å·²ç»è¢«åˆ é™¤<br />
        case timerDeleted, timerRemoving, timerRemoved:<br />
            return false<br />
,,,</p><br />
<br />
<p>// runtime/proc.go checkTimers -&gt; runtime/time.go runtimer<br />
func runtimer(pp *p, now int64) int64 {<br />
    for {<br />
        t := pp.timers[0]<br />
        ,,,<br />
        switch s := atomic.Load(&amp;t.status); s {<br />
        case timerWaiting:<br />
            runOneTimer(p, t, now)  // æ‰§è¡Œ<br />
        case timerDeleted:<br />
            continue<br />
    ,,,<br />
    }<br />
}<br />
ä¸‹é¢æ˜¯æ£€æµ‹å’Œæ‰§è¡Œå®šæ—¶å™¨çš„å…¥å£</p><br />
<br />
<p>ç¬¬ä¸€ï¼Œé€šè¿‡findrunnableæ‰¾ä»»åŠ¡æ—¶ä¼šæ£€æŸ¥timeräº‹ä»¶ã€‚å‡½æ•°åˆšå¼€å§‹æ—¶ä¼šä½¿ç”¨checkTimersæ£€æµ‹è¿è¡Œæœ¬pçš„å®šæ—¶ä»»åŠ¡ï¼Œåé¢å†å·ä»»åŠ¡æ—¶ä¸ä»…å·å…¶ä»–pçš„runqï¼Œè€Œä¸”è¿˜å·å…¶ä»–påˆ°æœŸçš„timersï¼Œå…·ä½“ä½¿ç”¨çš„æ˜¯checkTimersæ–¹æ³•ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>func findrunnable() (gp *g, inheritTime bool) {<br />
    <em>g</em> := getg()</p><br />
<br />
<p>top:<br />
    <em>p</em> := <em>g</em>.m.p.ptr()</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ£€æµ‹è¿è¡Œæœ¬pçš„å®šæ—¶ä»»åŠ¡<br />
now, pollUntil, _ := checkTimers(_p_, 0)<br />
<br />
<br />
// ä»æœ¬pä¸­è·å–goroutine<br />
if gp, inheritTime := runqget(_p_); gp != nil {<br />
    return gp, inheritTime<br />
}<br />
<br />
// ä»å…¨å±€pä¸­è·å–goroutine<br />
if sched.runqsize != 0 {<br />
    lock(&amp;sched.lock)<br />
    gp := globrunqget(_p_, 0)<br />
    unlock(&amp;sched.lock)<br />
    if gp != nil {<br />
        return gp, false<br />
    }<br />
}<br />
<br />
// éé˜»å¡çš„è½®è¯¢ç½‘ç»œäº‹ä»¶<br />
if netpollinited() &amp;&amp; atomic.Load(&amp;netpollWaiters) &gt; 0 &amp;&amp; atomic.Load64(&amp;sched.lastpoll) != 0 {<br />
    if list := netpoll(0); !list.empty() { // non-blocking<br />
        gp := list.pop()<br />
        injectglist(&amp;list)  // æŠŠè¢«å”¤é†’è·Ÿfdå…³è”çš„goroutineæ”¾åˆ°runqé‡Œã€‚<br />
        casgstatus(gp, _Gwaiting, _Grunnable)<br />
        if trace.enabled {<br />
            traceGoUnpark(gp, 0)<br />
        }<br />
        return gp, false<br />
    }<br />
}<br />
<br />
<br />
// ä»å…¶ä»–på·ä»»åŠ¡, éå†4ä¸‹, å…ˆä»å…¶ä»–çš„pçš„runqå·ï¼Œå†ä»å…¶ä»–pçš„timerså·.<br />
procs := uint32(gomaxprocs)<br />
for i := 0; i &lt; 4; i++ {<br />
    for enum := stealOrder.start(fastrand()); !enum.done(); enum.next() {<br />
        // å·å…¶ä»–pçš„runq<br />
        if gp := runqsteal(_p_, p2, stealRunNextG); gp != nil {<br />
            return gp, false<br />
        }<br />
<br />
        // ç»§ç»­å·å…¶ä»–pçš„timers<br />
        if i &gt; 2 &amp;&amp; shouldStealTimers(p2) {<br />
            tnow, w, ran := checkTimers(p2, now)  // æ‰§è¡Œå·²ç»åˆ°æœŸçš„å®šæ—¶ä»»åŠ¡<br />
        }<br />
    }<br />
}<br />
<br />
// å¸¦è¶…æ—¶çš„netpollé˜»å¡è°ƒç”¨<br />
if netpollinited() &amp;&amp; (atomic.Load(&amp;netpollWaiters) &gt; 0 || pollUntil != 0) &amp;&amp; atomic.Xchg64(&amp;sched.lastpoll, 0) != 0 {<br />
    list := netpoll(delta) // block until new work is available<br />
    ,,,<br />
} } netpollè¿™é‡Œåˆ†ä¸ºé˜»å¡å’Œéé˜»å¡æ–¹æ³•ï¼Œå½“delayå°äºåˆ™æ˜¯é˜»å¡æ¨¡å¼ï¼Œç­‰äº0ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå¤§äº0æ˜¯è¶…æ—¶æ¨¡å¼ã€‚delayçš„æ—¶é—´ä¸ºçº³ç§’ï¼Œepoll waitçš„è¶…æ—¶æ—¶é—´å•ä½ä¸ºæ¯«ç§’ï¼Œä¸ºäº†é¿å…è¿‡åº¦çš„ç³»ç»Ÿè°ƒç”¨ï¼Œåšäº†ä¸€äº›ç²’åº¦ä¸Šçš„åˆå¹¶ã€‚<br />
</code></pre></div></div><br />
<br />
<p>å¦å¤–ï¼Œgolangä¸ºäº†å°½é‡è§„é¿epollçš„æƒŠç¾¤é—®é¢˜ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªä¼šæœ‰ä¸€ä¸ªåç¨‹é™·å…¥epoll waitä¼‘çœ ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>// netpoll checks for ready network connections.<br />
// Returns list of goroutines that become runnable.<br />
// delay &lt; 0: blocks indefinitely<br />
// delay == 0: does not block, just polls<br />
// delay &gt; 0: block for up to that many nanoseconds<br />
func netpoll(delay int64) gList {<br />
    if epfd == -1 {  // epfdä¸ºå…¨å±€å¯¹è±¡ï¼Œnetpollinitæ—¶å°±ä¼šåˆå§‹åŒ–<br />
        return gList{}<br />
    }<br />
    var waitms int32<br />
    if delay &lt; 0 {<br />
        waitms = -1<br />
    } else if delay == 0 {<br />
        waitms = 0<br />
    } else if delay &lt; 1e6 { // 1ms<br />
        waitms = 1<br />
    } else if delay &lt; 1e15 { // 11.574 å¤©<br />
        waitms = int32(delay / 1e6) // æœ€å¤§ 1s<br />
    } else {<br />
        // An arbitrary cap on how long to wait for a timer.<br />
        // 1e9 ms == ~11.5 days.<br />
        waitms = 1e9  // 1s<br />
    }<br />
    var events [128]epollevent<br />
retry:<br />
    n := epollwait(epfd, &amp;events[0], int32(len(events)), waitms)<br />
    ,,,<br />
    for i := int32(0); i &lt; n; i++ {<br />
        ,,,<br />
        // å¦‚æœfdä¸ºç”¨æ¥ä¸­æ–­çš„netpollBreakRdåˆ™continueã€‚<br />
        if *(**uintptr)(unsafe.Pointer(&amp;ev.data)) == &amp;netpollBreakRd {<br />
            var tmp [16]byte<br />
            read(int32(netpollBreakRd), noescape(unsafe.Pointer(&amp;tmp[0])), int32(len(tmp)))<br />
        }<br />
        continue<br />
    }<br />
    ,,,<br />
}<br />
epollwaitå‡½æ•°çš„å®ç°æ˜¯æ±‡ç¼–ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>// int32 runtimeÂ·epollwait(int32 epfd, EpollEvent *ev, int32 nev, int32 timeout);<br />
TEXT runtimeÂ·epollwait(SB),NOSPLIT,$0<br />
    MOVL    epfd+0(FP), DI<br />
    MOVQ    ev+8(FP), SI<br />
    MOVL    nev+16(FP), DX<br />
    MOVL    timeout+20(FP), R10<br />
    MOVQ    $0, R8<br />
    MOVL    $SYS_epoll_pwait, AX<br />
    SYSCALL<br />
    MOVL    AX, ret+24(FP)<br />
    RET<br />
ç¬¬äºŒï¼Œåœ¨go runtimeçš„pmgè°ƒåº¦æ¨¡å‹ä¸‹ï¼Œå½“ä¸€ä¸ªmæ‰§è¡Œå®Œä¸€ä¸ªGçš„åç¨‹è°ƒåº¦åï¼Œè°ƒç”¨runtime.scheduleæ–¹æ³•æ¥å¯»æ‰¾å¯ç”¨çš„goroutineå¹¶æ‰§è¡Œã€‚è¿™é‡Œå…³é”®çš„æ–¹æ³•ä¹Ÿæ˜¯checkTimersã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>func schedule() {<br />
    ,,,<br />
    pp := <em>g</em>.m.p.ptr()<br />
    checkTimers(pp, 0)<br />
    ,,,<br />
    if gp == nil {<br />
       gp, inheritTime = findrunnable() // blocks until work is available<br />
    }<br />
    ,,,<br />
}<br />
é‚£ä¹ˆcheckTimersæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p><br />
<br />
<p>checkTimersè¯¥å‡½æ•°åªæ£€æŸ¥ä¼ é€’è¿›æ¥çš„pï¼Œé€šè¿‡runtimeræ¥è¿è¡Œåˆ°æœŸçš„å®šæ—¶ä»»åŠ¡ï¼Œå¹¶ä¸”è¿”å›ä¸‹ä¸€æ¬¡åˆ°æœŸçš„æ—¶é—´åŠæ˜¯å¦æœ‰å®šæ—¶ä»»åŠ¡åˆ°æœŸã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>func checkTimers(pp *p, now int64) (rnow, pollUntil int64, ran bool) {<br />
    â€¦<br />
    lock(&amp;pp.timersLock)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rnow = now<br />
if len(pp.timers) &gt; 0 {<br />
    if rnow == 0 {<br />
        rnow = nanotime()<br />
    }<br />
    for len(pp.timers) &gt; 0 {<br />
<br />
        // å°è¯•æ‰§è¡Œä»»åŠ¡<br />
        if tw := runtimer(pp, rnow); tw != 0 {<br />
            if tw &gt; 0 {<br />
                pollUntil = tw<br />
            }<br />
            break<br />
        }<br />
        ran = true<br />
    }<br />
}<br />
<br />
unlock(&amp;pp.timersLock)<br />
<br />
return rnow, pollUntil, ran } runtimeréå†å †é¡¶çš„ä»»åŠ¡æ—¶é—´æ˜¯å¦åˆ°æœŸï¼Œå¦‚åˆ°æœŸå›è°ƒæ‰§è¡Œï¼Œå¦‚æ˜¯å‘¨æœŸæ€§ä¼šé‡æ–°ã€‚<br />
</code></pre></div></div><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>//go:systemstack<br />
func runtimer(pp *p, now int64) int64 {<br />
        for {<br />
                t := pp.timers[0] // è·å–å››å‰å †çš„å †é¡¶<br />
                ,,,<br />
                switch s := atomic.Load(&amp;t.status); s {<br />
                case timerWaiting:<br />
                        if t.when &gt; now {<br />
                                // Not ready to run.<br />
                                return t.when<br />
                        }<br />
                        // åŸå­ä¿®æ”¹å®šæ—¶ä»»åŠ¡çš„çŠ¶æ€<br />
                        if !atomic.Cas(&amp;t.status, s, timerRunning) {<br />
                                continue<br />
                        }</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                    runOneTimer(pp, t, now)<br />
                    return 0 ,,,<br />
</code></pre></div></div><br />
<br />
<p>// ç›´æ¥æ‰§è¡Œè¯¥å®šæ—¶ä»»åŠ¡ï¼Œå¦‚æœæ˜¯å‘¨æœŸæ€§ä»»åŠ¡ä¼šé‡æ–°å…¥é˜Ÿã€‚<br />
func runOneTimer(pp *p, t *timer, now int64) {<br />
        (â€¦)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    f := t.f<br />
    arg := t.arg<br />
    seq := t.seq<br />
<br />
    // å¦‚æœæ˜¯ period &gt; 0 åˆ™è¯´æ˜æ­¤æ—¶ timer ä¸º tickerï¼Œéœ€è¦å†æ¬¡è§¦å‘<br />
    if t.period &gt; 0 {<br />
            delta := t.when - now<br />
            t.when += t.period * (1 + -delta/t.period)<br />
            if !siftdownTimer(pp.timers, 0) {  // è°ƒæ•´å †<br />
                    panic(...)<br />
            }<br />
            // åŸå­é‡ç½®çŠ¶æ€ä¸ºtiemrWaiting<br />
            if !atomic.Cas(&amp;t.status, timerRunning, timerWaiting) {<br />
                    panic(...)<br />
            }<br />
    } else { // å¦åˆ™ä¸ºä¸€æ¬¡æ€§ timer<br />
            // ä»å †ä¸­ç§»é™¤<br />
            if !dodeltimer0(pp) {<br />
                    panic(...)<br />
            }<br />
            if !atomic.Cas(&amp;t.status, timerRunning, timerNoStatus) {<br />
                    panic(...)<br />
            }<br />
    }<br />
<br />
    ,,,<br />
<br />
    unlock(&amp;pp.timersLock)<br />
<br />
    f(arg, seq)  // å›è°ƒæ‰§è¡Œå®šæ—¶ä»»åŠ¡ä¸­çš„æ–¹æ³•<br />
    lock(&amp;pp.timersLock)<br />
<br />
    ,,, } å€Ÿç”¨go pprofçš„å›¾å¯ä»¥æ˜æ˜¾çš„è·Ÿè¸ªå®šæ—¶å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ã€‚<br />
</code></pre></div></div><br />
<br />
<p>é€šè¿‡straceåˆ†ægo1.14çš„å˜åŒ–</p><br />
<br />
<p>å†™ä¸ªè„šæœ¬å¤§é‡çš„åˆ›å»ºå‘¨æœŸè¾ƒé•¿çš„å®šæ—¶å™¨ï¼Œä½†æ¯ç»„æ–°çš„å®šæ—¶å™¨è¦æ¯”ä¸Šæ¬¡å°ï¼Œæœ€å°çš„ç­‰å¾…æ—¶é—´ä¸º5ç§’ã€‚</p><br />
<br />
<p>ä¸‹é¢æ˜¯go1.13å®šæ—¶å™¨çš„è¡¨ç°ï¼Œé€šè¿‡straceå¯ä»¥çœ‹åˆ°ç©ºé—²æœŸå‡ºç°å¤šä¸ªçº¿ç¨‹æŒ‚åœ¨futexç³»ç»Ÿè°ƒç”¨ä¸Šã€‚futexä¸»è¦æœ‰ä¸¤ä¸ªflagï¼ŒFUTEX_WAIT_PRIVATEä¸ºä¼‘çœ ï¼ŒFUTEX_WAIT_PRIVATEä¸ºå”¤é†’ï¼Œfutexçš„ç¬¬å››ä¸ªå‚æ•°ä¸ºè¶…æ—¶æ—¶é—´ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>[pid 21518] 09:14:34 futex(0xc0000ba4c8, FUTEX_WAIT_PRIVATE, 0, NULL &lt;unfinished â€¦&gt;<br />
[pid 21517] 09:14:34 futex(0xc00033a4c8, FUTEX_WAIT_PRIVATE, 0, NULL &lt;unfinished â€¦&gt;<br />
[pid 21516] 09:14:34 futex(0xc0000aa4c8, FUTEX_WAIT_PRIVATE, 0, NULL &lt;unfinished â€¦&gt;<br />
[pid 21496] 09:14:34 futex(0x96bb20, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished â€¦&gt;<br />
[pid 21493] 09:14:34 futex(0x96bb40, FUTEX_WAIT_PRIVATE, 0, {4, 939313694} &lt;unfinished â€¦&gt;<br />
[pid 21496] 09:14:34 &lt;â€¦ futex resumed&gt; ) = 0 &lt;0.000021&gt;<br />
[pid 21496] 09:14:34 futex(0xc0000ba148, FUTEX_WAIT_PRIVATE, 0, NULL &lt;unfinished â€¦&gt;</p><br />
<br />
<p>// ç­‰å¾…äº†å°†è¿‘5ç§’åè¢«å”¤é†’.</p><br />
<br />
<p>[pid 21491] 09:14:34 futex(0x967d30, FUTEX_WAIT_PRIVATE, 0, {60, 0} &lt;unfinished â€¦&gt;<br />
[pid 21493] 09:14:39 futex(0x967d30, FUTEX_WAKE_PRIVATE, 1) = 1 &lt;0.000013&gt;<br />
[pid 21491] 09:14:39 &lt;â€¦ futex resumed&gt; ) = 0 &lt;4.937629&gt;<br />
[pid 21493] 09:14:39 futex(0xc0000ba148, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished â€¦&gt;<br />
[pid 21496] 09:14:39 &lt;â€¦ futex resumed&gt; ) = 0 &lt;4.939627&gt;<br />
[pid 21493] 09:14:39 futex(0xc0000aa4c8, FUTEX_WAKE_PRIVATE, 1 &lt;unfinished â€¦&gt;<br />
[pid 21516] 09:14:39 &lt;â€¦ futex resumed&gt; ) = 0 &lt;4.939849&gt;<br />
ä¸‹é¢æ˜¯go1.14çš„å®šæ—¶å™¨è¡¨ç°ï¼Œå¯ä»¥çœ‹åˆ°åªæœ‰ä¸€ä¸ªçº¿ç¨‹é™·å…¥epoll_pwaitè¶…æ—¶ä¼‘çœ ï¼Œepoll waitçš„æ—¶é—´å•ä½æ˜¯æ¯«ç§’ï¼Œé‚£ä¹ˆ4877å°†è¿‘5sã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>[pid 22039] 09:16:42 epoll_pwait(3, {{EPOLLIN, {u32=10005312, u64=10005312}}}, 128, 4877, NULL) = 1 &lt;0.000004&gt;</p><br />
<br />
<p>// ç­‰å¾…äº†5s â€¦</p><br />
<br />
<p>[pid 22039] 09:16:47 &lt;â€¦ epoll_pwait resumed&gt; {}, 128, 4876, NULL) = 0 &lt;4.877084&gt;<br />
[pid 22039] 09:16:47 epoll_pwait(3,  &lt;unfinished â€¦&gt;<br />
[pid 22039] 09:16:47 &lt;â€¦ epoll_pwait resumed&gt; {}, 128, 0, NULL) = 0 &lt;0.000029&gt;<br />
[pid 22040] 09:16:47 epoll_pwait(3,  &lt;unfinished â€¦&gt;<br />
go1.14æ€§èƒ½ä¼˜åŒ–</p><br />
<br />
<p>æ€§èƒ½æ€ä¹ˆå°±æé«˜äº†ï¼Ÿ ğŸ˜…</p><br />
<br />
<p>é”ç«äº‰å†²çªå‡å°‘ï¼Ÿgo1.14è™½ç„¶æŠŠtimersæ”¾åˆ°äº†pç»“æ„ä¸­ï¼Œä½†æœ¬pæ“ä½œå †ä¾ç„¶ä¹Ÿéœ€è¦åŠ é”ã€‚å› ä¸º1.14çš„findrunnableæ–¹æ³•ä¼šå·å…¶ä»–pçš„timersä»»åŠ¡ï¼Œä¸ºäº†å†™å®‰å…¨å¿…ç„¶æ˜¯åŠ é”çš„ã€‚å¦å¤–ï¼Œ1.13çš„é”çš„ç²’åº¦èŒƒå›´è·Ÿ1.14æ˜¯å·®ä¸å¤šçš„ï¼Œæ¯ä¸ªtimerprocæœ‰æŒ‡å®šçš„timerså’Œlockï¼Œæœ€å¤§æ‹†åˆ†64ã€‚å¯ä»¥æƒ³è±¡æ“ä½œtimersç»“æ„çš„é”è²Œä¼¼æ²¡å‡å°‘ã€‚</p><br />
<br />
<p>ä½†é—®é¢˜æ¥äº†ï¼Œgo1.13ä¼šæœ‰æ›´å¤šçš„çº¿ç¨‹å»å¤„ç†timerprocæ“ä½œnotetsleepgï¼Œç»§è€Œå¼•å‘entersyscallblockè°ƒç”¨ï¼Œè¯¥æ–¹æ³•ä¼šä¸»åŠ¨è§£ç»‘handoffpã€‚é‚£ä¹ˆå½“ä¸‹ä¸€ä¸ªå®šæ—¶äº‹ä»¶åˆ°æ¥æ—¶ï¼Œåˆå°è¯•å»pmgç»‘å®šï¼Œç»‘å®šæ—¶æœ‰æ¶‰åŠåˆ°sched.locké”ã€‚</p><br />
<br />
<p>é€šè¿‡ä¸‹é¢çš„ç³»ç»Ÿè°ƒç”¨ç»Ÿè®¡æ•°æ®æ¥çœ‹ï¼Œgo1.13ä¸å•æ˜¯futexç™¾åˆ†æ¯”å¤§ï¼Œè€Œä¸”è¿˜ç›¸å½“çš„è€—æ—¶ã€‚</p><br />
<br />
<p>// xiaorui.cc</p><br />
<br />
<p>go1.13</p><br />
<br />
<p>% time     seconds  usecs/call     calls    errors syscall<br />
â€”â€” â€”â€”â€”â€“ â€”â€”â€”â€“ â€”â€”â€” â€”â€”â€” â€”â€”â€”â€”â€”-<br />
 79.37  114.646338        6223     18422      5370 futex<br />
 18.88   27.277894        1190     22919           nanosleep<br />
  1.75    2.521039           0  15031115           clock_gettime</p><br />
<br />
<p>go1.14</p><br />
<br />
<p>% time     seconds  usecs/call     calls    errors syscall<br />
â€”â€” â€”â€”â€”â€“ â€”â€”â€”â€“ â€”â€”â€” â€”â€”â€” â€”â€”â€”â€”â€”-<br />
 53.74   24.281933         242    100240     96899 futex<br />
 43.02   19.437270         295     65827         3 nanosleep<br />
  2.76    1.246966           0  10975847           clock_gettime<br />
  0.44    0.197550          17     11900           epoll_pwait<br />
runtimeè°ƒåº¦å¼€é”€ï¼Ÿgo1.13æœ€å¤šå¯ä»¥å¼€åˆ°GOMAXPROCSæ•°é‡çš„timerprocåç¨‹ï¼Œå½“ç„¶ä¸è¶…è¿‡64ã€‚ä½†æˆ‘ä»¬è¦çŸ¥é“timerprocè‡ªèº«å°±æ˜¯åç¨‹ï¼Œä¹Ÿéœ€è¦runtime pmgçš„è°ƒåº¦ã€‚åè€Œgo 1.14æŠŠæ£€æŸ¥åˆ°æœŸå®šæ—¶ä»»åŠ¡çš„å·¥ä½œäº¤ç»™äº†runtime.scheduleï¼Œä¸éœ€è¦é¢å¤–çš„è°ƒåº¦ï¼Œæ¯æ¬¡runtime.scheduleå’Œfindrunableæ—¶ç›´æ¥è¿è¡Œåˆ°æœŸçš„å®šæ—¶ä»»åŠ¡ã€‚</p><br />
<br />
<p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Ÿæ–°æ·»åŠ çš„å®šæ—¶ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´æ›´å°æ—¶ï¼Œä¸ç®¡æ˜¯ä½¿ç”¨futexè¿˜æ˜¯epoll_waitç³»ç»Ÿè°ƒç”¨éƒ½ä¼šè¢«å”¤é†’é‡æ–°ä¼‘çœ ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹ä¼šäº§ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä½†ç”±äºgo1.14æ²¡æœ‰timerprocçš„å­˜åœ¨ï¼Œæ–°å®šæ—¶ä»»åŠ¡å¯ç›´æ¥æ’å…¥æˆ–å¤šæ¬¡æ’å…¥åå†è€ƒè™‘æ˜¯å¦ä¼‘çœ ã€‚</p><br />
<br />
<p>ç»“è®ºï¼Œgolang 1.13çš„å®šæ—¶å™¨åœ¨ä»»åŠ¡ç¹å¤šæ—¶ï¼Œå¿…ç„¶ä¼šé€ æˆæ›´å¤šçš„ä¸Šçº¿æ–‡åˆ‡æ¢åŠruntime pmgè°ƒåº¦ï¼Œè€Œgolang 1.14åšäº†æ›´å¥½çš„ä¼˜åŒ–ã€‚</p><br />
<br />
<p>é€šè¿‡prometheusç›‘æ§å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç‰ˆæœ¬cpuçš„ä½¿ç”¨ç‡å¯¹æ¯”ï¼Œgo1.14è¦æ¯”go1.13æ˜¯èŠ‚çœäº†ä¸€äº›èµ„æºã€‚</p><br />
<br />
<p>golang timer æ€§èƒ½ä¼˜åŒ–<br />
åŠ å…¥go tool pprofçš„æ€§èƒ½è¡¨ç°ï¼Œå¯ä»¥çœ‹åˆ°æ–°ä»»åŠ¡çš„æ·»åŠ ç¡®å®å¿«äº†ã€‚</p><br />
<br />
<p>golang å®šæ—¶å™¨<br />
golang timer<br />
1.13 vs 1.14æ€§èƒ½å¯¹æ¯”ï¼Ÿ</p><br />
<br />
<p>è¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„go1.14 vs 1.13å®šæ—¶å™¨æ€§èƒ½æµ‹è¯•ï¼Œçœ‹ç»“æœéšç€gomaxprocsçš„å¢å¤šï¼Œæ€§èƒ½è¡¨ç°ä¹Ÿè¶Šæ¥è¶Šå¥½ã€‚ å®˜æ–¹æ²¡æœ‰æä¾›ååŠæ®µæµ‹è¯•çš„æ–¹æ³•ã€‚</p><br />
<br />
<p>https://github.com/golang/go/commit/76f4fd8a5251b4f63ea14a3c1e2fe2e78eb74f81</p><br />
<br />
<p>Below are relevant benchmark results for various GOMAXPROCS values<br />
on linux/amd64:</p><br />
<br />
<p>context package:</p><br />
<br />
<p>name                                     old time/op  new time/op  delta<br />
WithTimeout/concurrency=40      4.92Âµs Â± 0%  5.17Âµs Â± 1%  +5.07%  (p=0.000 n=9+9)<br />
WithTimeout/concurrency=4000    6.03Âµs Â± 1%  6.49Âµs Â± 0%  +7.63%  (p=0.000 n=8+10)<br />
WithTimeout/concurrency=400000  8.58Âµs Â± 7%  9.02Âµs Â± 4%  +5.02%  (p=0.019 n=10+10)</p><br />
<br />
<p>name                                     old time/op  new time/op  delta<br />
WithTimeout/concurrency=40-2      3.70Âµs Â± 1%  2.78Âµs Â± 4%  -24.90%  (p=0.000 n=8+9)<br />
WithTimeout/concurrency=4000-2    4.49Âµs Â± 4%  3.67Âµs Â± 5%  -18.26%  (p=0.000 n=10+10)<br />
WithTimeout/concurrency=400000-2  6.16Âµs Â±10%  5.15Âµs Â±13%  -16.30%  (p=0.000 n=10+10)</p><br />
<br />
<p>name                                     old time/op  new time/op  delta<br />
WithTimeout/concurrency=40-4      3.58Âµs Â± 1%  2.64Âµs Â± 2%  -26.13%  (p=0.000 n=9+10)<br />
WithTimeout/concurrency=4000-4    4.17Âµs Â± 0%  3.32Âµs Â± 1%  -20.36%  (p=0.000 n=10+10)<br />
WithTimeout/concurrency=400000-4  5.57Âµs Â± 9%  4.83Âµs Â±10%  -13.27%  (p=0.001 n=10+10)</p><br />
<br />
<p>time package:</p><br />
<br />
<p>name                     old time/op  new time/op  delta<br />
AfterFunc                6.15ms Â± 3%  6.07ms Â± 2%     ~     (p=0.133 n=10+9)<br />
AfterFunc-2              3.43ms Â± 1%  3.56ms Â± 1%   +3.91%  (p=0.000 n=10+9)<br />
AfterFunc-4              5.04ms Â± 2%  2.36ms Â± 0%  -53.20%  (p=0.000 n=10+9)<br />
After                    6.54ms Â± 2%  6.49ms Â± 3%     ~     (p=0.393 n=10+10)<br />
After-2                  3.68ms Â± 1%  3.87ms Â± 0%   +5.14%  (p=0.000 n=9+9)<br />
After-4                  6.66ms Â± 1%  2.87ms Â± 1%  -56.89%  (p=0.000 n=10+10)<br />
Stop                      698Âµs Â± 2%   689Âµs Â± 1%   -1.26%  (p=0.011 n=10+10)<br />
Stop-2                    729Âµs Â± 2%   434Âµs Â± 3%  -40.49%  (p=0.000 n=10+10)<br />
Stop-4                    837Âµs Â± 3%   333Âµs Â± 2%  -60.20%  (p=0.000 n=10+10)<br />
SimultaneousAfterFunc     694Âµs Â± 1%   692Âµs Â± 7%     ~     (p=0.481 n=10+10)<br />
SimultaneousAfterFunc-2   714Âµs Â± 3%   569Âµs Â± 2%  -20.33%  (p=0.000 n=10+10)<br />
SimultaneousAfterFunc-4   782Âµs Â± 2%   386Âµs Â± 2%  -50.67%  (p=0.000 n=10+10)<br />
StartStop                 267Âµs Â± 3%   274Âµs Â± 0%   +2.64%  (p=0.000 n=8+9)<br />
StartStop-2               238Âµs Â± 2%   140Âµs Â± 3%  -40.95%  (p=0.000 n=10+8)<br />
StartStop-4               320Âµs Â± 1%   125Âµs Â± 1%  -61.02%  (p=0.000 n=9+9)<br />
Reset                    75.0Âµs Â± 1%  77.5Âµs Â± 2%   +3.38%  (p=0.000 n=10+10)<br />
Reset-2                   150Âµs Â± 2%    40Âµs Â± 5%  -73.09%  (p=0.000 n=10+9)<br />
Reset-4                   226Âµs Â± 1%    33Âµs Â± 1%  -85.42%  (p=0.000 n=10+10)<br />
Sleep                     857Âµs Â± 6%   878Âµs Â± 9%     ~     (p=0.079 n=10+9)<br />
Sleep-2                   617Âµs Â± 4%   585Âµs Â± 2%   -5.21%  (p=0.000 n=10+10)<br />
Sleep-4                   689Âµs Â± 3%   465Âµs Â± 4%  -32.53%  (p=0.000 n=10+10)<br />
Ticker                   55.9ms Â± 2%  55.9ms Â± 2%     ~     (p=0.971 n=10+10)<br />
Ticker-2                 28.7ms Â± 2%  28.1ms Â± 1%   -2.06%  (p=0.000 n=10+10)<br />
Ticker-4                 14.6ms Â± 0%  13.6ms Â± 1%   -6.80%  (p=0.000 n=9+10)<br />
æ€»ç»“:</p><br />
<br />
<p>go1.14çš„å®šæ—¶å™¨è™½ç„¶åšäº†ä¸å°‘æ€§èƒ½ä¼˜åŒ–ï¼Œè®©è¿™ä¸ªæ‰€è°“çš„æ€§èƒ½æ€æ‰‹ä¹Ÿå¾—ä»¥â€å–˜æ¯â€ï¼Œä½†ä»è®¾è®¡æ¨¡å‹ä¸Šæ¥è¯´ï¼Œè¿˜æ˜¯è·Ÿç²—ç²¾åº¦çš„æ—¶é—´è½®æœ‰æ€§èƒ½å·®è·ã€‚</p><br />
<br />
<p>golang æ—¶é—´è½®</p><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--èµ-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">é¦–é¡µ</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">å¤æ³½æ°‘</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"åˆ†äº«åˆ°ï¼š","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // å¼€å¯å¯¹è¯æ¡†
            enable: true,
            script: {
              // æ¯ç©ºé—² 10 ç§’é’Ÿï¼Œæ˜¾ç¤ºä¸€æ¡ä¸€è¨€
              'every idle 10s': '$hitokoto$',
              // å½“è§¦æ‘¸åˆ°æ˜Ÿæ˜Ÿå›¾æ¡ˆ
              'hover .star': 'æ˜Ÿæ˜Ÿåœ¨å¤©ä¸Šè€Œä½ åœ¨æˆ‘å¿ƒé‡Œ (*/Ï‰ï¼¼*)',
              // å½“è§¦æ‘¸åˆ°è§’è‰²èº«ä½“
              'tap body': 'å“å‘€ï¼åˆ«ç¢°æˆ‘ï¼',
              // å½“è§¦æ‘¸åˆ°è§’è‰²å¤´éƒ¨
              'tap face': 'äººå®¶å·²ç»ä¸æ˜¯å°å­©å­äº†ï¼'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--æœ¬æ–‡æ¥è‡ª-->
     <script type="text/javascript">
      /* ä»…IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/næœ¬ç¯‡æ–‡ç« æ¥æºäº xiazemin çš„ æ³½æ°‘åšå®¢|https://xiazemin.github.io/MyBlog/index.html åŸæ–‡é“¾æ¥ï¼š"+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //ç»‘å®šåœ¨äº†bodyä¸Šï¼Œä¹Ÿå¯ä»¥ç»‘å®šåœ¨å…¶ä»–å¯ç”¨å…ƒç´ è¡Œï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰å…ƒç´ éƒ½æ”¯æŒcopyå’Œpastäº‹ä»¶ã€‚

     /*
$(document.body).bind({
    copy: function(event) {//copyäº‹ä»¶
        //var cpTxt = "å¤åˆ¶çš„æ•°æ®";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//å¯ä»¥è·å–ç”¨æˆ·é€‰ä¸­å¤åˆ¶çš„æ•°æ®
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//å¦åˆ™è®¾ä¸ç”Ÿæ•ˆ
    },paste: function(e) {//pasteäº‹ä»¶
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />æœ¬æ–‡æ¥æºï¼šxiazemin çš„ æ³½æ°‘åšå®¢ <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+å½“å‰é¡µé¢é“¾æ¥
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--æœ¬æ–‡æ¥è‡ª-->

</div>
  </body>

</html>