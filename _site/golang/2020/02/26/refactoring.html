<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Go lessons learnt by refactoring</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-02-26T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Feb 26, 2020</time></p>
					</div>
					 <p>https://anto.pt/post/go-lessons-learnt-by-refactoring/<br />
Not gonna lie. I’m not a Go expert, I’m still improving day by day, and most of my knowledge is coming while working with it.</p><br />
<br />
<p>A little context: I recently moved to a new company and they are starting using the Go language for some of the projects currently developing. I found myself reading a bunch of code written by people who only recently started writing Go, and came from years of experience in other languages - i.e. Java and C++.</p><br />
<br />
<p>After asking for a refactor of the code before it gets too tangled, I’ve seen some non-idiomatic patterns emerge and I’m documenting them here for future references. We starts from basics but you may found them interesting as well!<br />
<!-- more --><br />
Names cluttering<br />
This one is really common and already discussed everywhere but I’m facing it on a daily basis so I’m going to repeat it here.</p><br />
<br />
<p>Always think about how a function or type is going to be referenced from the outside:</p><br />
<br />
<p>Don’t</p><br />
<br />
<p>package services</p><br />
<br />
<p>func NewService() { /* … */ }</p><br />
<br />
<p>// services.NewService()</p><br />
<br />
<p>Do</p><br />
<br />
<p>package services</p><br />
<br />
<p>func New() { /* … */ }</p><br />
<br />
<p>// services.New()</p><br />
<br />
<p>Slices initialization<br />
Don’t</p><br />
<br />
<p>slice := []int{}<br />
// or<br />
slice := make([]int, 0)</p><br />
<br />
<p>Do</p><br />
<br />
<p>var slice []int</p><br />
<br />
<p>// you can still append(), even if list is nil<br />
slice = append(slice, 4)</p><br />
<br />
<p>The reason is that the first snippet will initialize a slice with length 0 and it’s really not necessary most of the time.</p><br />
<br />
<p>A nil slice will act just like a zero-length slice, without the useless memory allocation.</p><br />
<br />
<p>Change behaviour through composition<br />
This is a method actually used in Go stdlib sort package, where there’s a Interface with some common methods, and a reverse struct that changes the behavior for one of the methods of Interface to make it sort reversed.</p><br />
<br />
<p>In this example, I’m showing how easy it is to take a Stringer and return a Stringer, meaning that anywhere a Stringer was used it’s still valid, but it will print the string uppercase.</p><br />
<br />
<p>type upperStringer struct {<br />
	fmt.Stringer<br />
}</p><br />
<br />
<p>func (us *upperStringer) String() string {<br />
	return strings.ToUpper(us.Stringer.String())<br />
}</p><br />
<br />
<p>func Upper(s fmt.Stringer) fmt.Stringer {<br />
	return &amp;upperStringer{s}<br />
}</p><br />
<br />
<p>This is made possible by embedding an interface so that my custom String() method can call the original String() method.</p><br />
<br />
<p>Check your receiver pointer for nil<br />
Don’t</p><br />
<br />
<p>type T struct{<br />
	name string<br />
}</p><br />
<br />
<p>func (t *T) PrintName() {<br />
	fmt.Println(t.name)<br />
}</p><br />
<br />
<p>You should check for the pointer, and take some kind of action instead of panicking:</p><br />
<br />
<p>Do</p><br />
<br />
<p>type T struct{<br />
	name string<br />
}</p><br />
<br />
<p>func (t *T) PrintName() {<br />
	if t == nil {<br />
		fmt.Println(“A nil has no name”)<br />
	} else {<br />
		fmt.Println(t.name)<br />
	}<br />
}</p><br />
<br />
<p>func main() {<br />
	var t *T<br />
	t.PrintName()<br />
	// Output: A nil has no name<br />
}</p><br />
<br />
<p>Avoid unneeded singleton pattern<br />
(or be safe and implement it correctly)</p><br />
<br />
<p>Don’t</p><br />
<br />
<p>package foo</p><br />
<br />
<p>type Foo struct{}</p><br />
<br />
<p>func (f *Foo) Bar() {<br />
  // do stuff<br />
}</p><br />
<br />
<p>func GetFoo() *Foo {<br />
	return newFoo()<br />
}</p><br />
<br />
<p>// foo is the singleton instance.<br />
var foo *Foo</p><br />
<br />
<p>func newFoo() *Foo {<br />
	if foo != nil {<br />
		return foo<br />
	}<br />
	foo = &amp;Foo{}<br />
	return foo<br />
}</p><br />
<br />
<p>Let’s start with a real bug I encountered refactoring this: GetFoo() is not thread-safe! If you have a bunch of goroutines booting and asking for their Foo, you are ending up with race conditions.</p><br />
<br />
<p>But instead of adding a mutex, let’s step back. Do you need a singleton?</p><br />
<br />
<p>Go, just like a lot of other languages, doesn’t force you to create a class for everything. If I can, I’d prefer to just have a package foo with the functions I need.</p><br />
<br />
<p>Do</p><br />
<br />
<p>package foo</p><br />
<br />
<p>func Bar() {<br />
}</p><br />
<br />
<p>This is so much cleaner, isn’t it?</p><br />
<br />
<p>If you’re wondering how can you mock the foo package for testing, I’ll just show you in the following sections - promise, but before doing that I need to show a neat trick:</p><br />
<br />
<p>A function can satisfy an interface by calling itself</p><br />
<br />
<p>package io</p><br />
<br />
<p>type Reader interface{<br />
	Read(p []byte) (n int, err error)<br />
}</p><br />
<br />
<p>package main</p><br />
<br />
<p>// ReaderFunc wraps a simple function into an io.Reader.<br />
type ReaderFunc func(p []byte) (n int, err error)</p><br />
<br />
<p>func (f ReaderFunc) Read(p []byte) (n int, err error) {<br />
	return f(p)<br />
}</p><br />
<br />
<p>// Mock is a function that acts like Reader.Read().<br />
func Mock(p []byte) (n int, err error) {<br />
	s := []byte(“hello\n”)<br />
	n = copy(p, s)<br />
	return<br />
}</p><br />
<br />
<p>func main() {<br />
	// you cannot:<br />
	// bufio.NewReader(ReaderMock)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// but for example you can now:<br />
r := bufio.NewReader(ReaderFunc(Mock))<br />
<br />
l, _ := r.ReadString('\n')<br />
fmt.Println(l) }<br />
</code></pre></div></div><br />
<br />
<p>We actually made a function to satisfy the Reader interface by calling itself. If you are a little confused that’s ok, just read it again a couple of times and remember that ReaderFunc(Mock) is a type cast, not a function call.</p><br />
<br />
<p>Testing without singletons and other OOP patterns<br />
So back to the singleton problem. We saw how to remove a useless type, the new problem is that now we can’t easily mock that methods:</p><br />
<br />
<p>Before</p><br />
<br />
<p>// foo.go</p><br />
<br />
<p>package foo</p><br />
<br />
<p>type IFoo interface {<br />
	Bar()<br />
}</p><br />
<br />
<p>// main.go</p><br />
<br />
<p>package main<br />
func Run(f IFoo) {<br />
	f.Bar()<br />
}</p><br />
<br />
<p>func main() {<br />
	Run(foo.GetFoo())<br />
}</p><br />
<br />
<p>// main_test.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>func TestRun(t *testing.T) {<br />
	Run(&amp;MockFoo{})<br />
}</p><br />
<br />
<p>type MockFoo struct {}</p><br />
<br />
<p>func (f *MockFoo) Bar {<br />
	fmt.Println(“Mocking Bar()”)<br />
}</p><br />
<br />
<p>But it turns out that’s not an idiomatic way of thinking in Go. There is A LOT to talk about interfaces and how they are different from other languages but let’s just relax and focus on our test.</p><br />
<br />
<p>We have these files:</p><br />
<br />
<p>Now</p><br />
<br />
<p>// foo.go</p><br />
<br />
<p>package foo</p><br />
<br />
<p>func Bar() { /<em>…</em>/ }</p><br />
<br />
<p>// main.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>func Run() {<br />
  foo.Bar()<br />
}</p><br />
<br />
<p>func main() {<br />
  Run()<br />
}</p><br />
<br />
<p>// main_test.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>func TestRun(t <em>testing.T) {<br />
  /</em> ???????? */<br />
}</p><br />
<br />
<p>The problem is that Run() strictly depends on foo.Bar() while it should not.</p><br />
<br />
<p>Before, Run used a dependency injection of an IFoo. In more idiomatic way, we can say that anyone that can Bar() is sufficient - let’s call it a Barrer:</p><br />
<br />
<p>// main.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>type Barrer interface{<br />
	Bar()<br />
}</p><br />
<br />
<p>func Run(b Barrer) {<br />
	b.Bar()<br />
}</p><br />
<br />
<p>func main() {<br />
	type fooBarrer struct{}<br />
	func (f *fooBarrer) Bar() {<br />
		foo.Bar()<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Run(&amp;fooBarrer{}) }<br />
</code></pre></div></div><br />
<br />
<p>But having to define a new type inside the main seems to overcomplicate things. Applying the previous section we can have a function implements the Barrer interface:</p><br />
<br />
<p>// main.go</p><br />
<br />
<p>package main</p><br />
<br />
<p>type Barrer interface{<br />
	Bar()<br />
}</p><br />
<br />
<p>type BarrerFunc func()</p><br />
<br />
<p>func (f BarrerFunc) Bar() {<br />
	f()<br />
}</p><br />
<br />
<p>func Run(b Barrer) {<br />
	b.Bar()<br />
}</p><br />
<br />
<p>func main() {<br />
	Run(BarrerFunc(foo.Bar))<br />
}</p><br />
<br />
<p>At this point, testing Run is trivial:</p><br />
<br />
<p>// main_test.go</p><br />
<br />
<p>func TestRun(…) {<br />
	Run(BarrerFunc(func() {<br />
		// … do some tests<br />
	}))<br />
}</p><br />
<br />
<p>I’m trying to keep this example as simple as possible and it doesn’t really feel necessary to have a Barrer and a BarrerFunc, but you have to trust me that as complexity grows, you can benefit a lot from this pattern.</p><br />
<br />
<p>Talking about interfaces<br />
How is IFoo different from Barrer? First of all, the name - an IFoo is a set methods implemented by Foo. A Barrer is just someone that can Bar.</p><br />
<br />
<p>If you still don’t see the difference, an interface like IFoo is implemented only once by Foo and it’s going to grow indefinitely over time. But our Run only needed one of these methods!</p><br />
<br />
<p>There’s also an important difference that could get unnoticed from my examples. IFoo was defined in the foo package, together with its class. And that’s normal because of how tightly the interface is coupled to its implementation.</p><br />
<br />
<p>In Go you don’t do that! The Barrer interface is defined nearly where it’s used: in the main package. That’s possible thanks to Go implicit satisfaction of interfaces, package foo doesn’t need to know what interfaces it implements.</p><br />
<br />
<p>If you think about it, that’s truly different from the main object-oriented programming such as Java. And in my opinion, is one of the peculiarities that make Go such a beautiful language</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>