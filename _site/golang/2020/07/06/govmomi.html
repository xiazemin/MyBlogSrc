<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">govmomi 创建 VMware 虚拟机</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-07-06T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jul 6, 2020</time></p>
					</div>
					 <p>使用 vsphere-automation-sdk-python 自动创建虚拟机：这是 Python 版的；<br />
vsphere golang sdk govmomi 使用指南：这是 govmomi 的基础操作，建议你在看本篇文章前先看看。</p><br />
<br />
<p>之所以使用 govmomi 原因有很多，有性能的原因，go 性能强出 Python 太多；有个人的原因，本人比较喜欢 go；当然还有公司的原因，公司的运维平台是 go 写的。<br />
当然，无论是 govmomi 也好，pyvmomi 也好，还是其他各种 vmomi 也好，都是 VMware 自身 api 的封装，使用起来都是大同小异，适合自己的就是最好的，没必要纠结太多。<br />
需要说明的是，本文创建虚拟机是将 ovf 模板放入内容库后，通过内容库部署的，而非直接通过模板创建。另外，6.7 的内容库除了支持 ovf 这种模板类型之外，还支持 vm-template，我没有来得及研究<br />
<!-- more --><br />
https://juejin.im/post/5f01c0095188252e8d0dde68</p><br />
<br />
<p>内容库是 VMware 6.0 新增的功能，使用它可以跨 vsphere 共享 iso 文件、虚拟机模板等，当你有多个 vsphere 时，使用起来会很便利。要使用内容库，你首先得创建一个内容库（library），给它一个名称，然后就可以上传文件啊模板啊到这个库中，每个文件或者模板称为一个 item。<br />
当你在一个 vsphere 中创建内容库后，其他 vsphere 就订阅该内容库了，这样内容库中的文件就会同步到所有订阅它的内容库中，通过这种方式来保证多个 vsphere 内容库中文件的一致性。<br />
内容库的使用这里就不演示了，网上教程很多，随便就能找到。这里假设你已经有了一个内容库，并且里面已经有了一个 ovf 模板。要想使用内容库，我们就必须先找到这个内容库对象，再通过它来找到其中的 ovf 模板这个对象。<br />
想必通过之前的文章你已经知道了怎么安装和登录 vsphere 了，那这里就直接登录了：<br />
const (<br />
    ip = “”<br />
    user = “”<br />
    password = “”<br />
)</p><br />
<br />
<p>u := &amp;url.URL{<br />
    Scheme: “https”,<br />
    Host:   ip,<br />
    Path:   “/sdk”,<br />
}</p><br />
<br />
<p>ctx := context.Background()<br />
u.User = url.UserPassword(user, password)<br />
client, err := govmomi.NewClient(ctx, u, true)<br />
if err != nil {<br />
    fmt.Fprintf(os.Stderr, “Login to vsphere failed, %v”, err)<br />
    os.Exit(1)<br />
}<br />
复制代码本文需要导入的库有这些：<br />
import (<br />
	“context”<br />
	“fmt”<br />
	“github.com/vmware/govmomi”<br />
	“github.com/vmware/govmomi/object”<br />
	“github.com/vmware/govmomi/vapi/library”<br />
	“github.com/vmware/govmomi/vapi/rest”<br />
	“github.com/vmware/govmomi/vapi/vcenter”<br />
	“net/url”<br />
	“os”<br />
)<br />
复制代码后面就不贴出来了，基本 IDE 都会自动补全。<br />
这里的 client 就可以用来操作整个 vsphere 了，不过通过它无法直接操作内容库，我们必须先要通过它来获得 rest client：<br />
rc := rest.NewClient(client.Client)<br />
if err := rc.Login(ctx, url.UserPassword(user, password)); err != nil {<br />
    fmt.Fprintf(os.Stderr, “rc.Login failed, %v”, err)<br />
    os.Exit(1)<br />
}<br />
复制代码这就相当于又重新登录了一次，不知道为什么 VMware 这么设计，直接通过 client 不好么？有了 rc 之后，就可以操作内容库了：<br />
func getLibraryItem(ctx context.Context, rc <em>rest.Client) (</em>library.Item, error) {<br />
	const (<br />
		libraryName = “”<br />
		libraryItemName = “”<br />
		libraryItemType = “ovf”<br />
	)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 需要通过 rc 来获得 library.Manager 对象<br />
m := library.NewManager(rc)<br />
// 通过内容库的名称来查找内容库<br />
libraries, err := m.FindLibrary(ctx, library.Find{Name: libraryName})<br />
if err != nil {<br />
	fmt.Printf("Find library by name %s failed, %v", libraryName, err)<br />
	return nil, err<br />
}<br />
<br />
// 判断是否找到<br />
if len(libraries) == 0 {<br />
	fmt.Printf("Library %s was not found", libraryName)<br />
	return nil, fmt.Errorf("library %s was not found", libraryName)<br />
}<br />
<br />
if len(libraries) &gt; 1 {<br />
	fmt.Printf("There are multiple libraries with the name %s", libraryName)<br />
	return nil, fmt.Errorf("there are multiple libraries with the name %s", libraryName)<br />
}<br />
<br />
// 在内容库中通过 ovf 模板的名称来找到 ovf 模板<br />
items, err := m.FindLibraryItems(ctx, library.FindItem{Name: libraryItemName,<br />
	Type: libraryItemType, LibraryID: libraries[0]})<br />
<br />
if err != nil {<br />
	fmt.Printf("Find library item by name %s failed", libraryItemName)<br />
	return nil, fmt.Errorf("find library item by name %s failed", libraryItemName)<br />
}<br />
<br />
if len(items) == 0 {<br />
	fmt.Printf("Library item %s was not found", libraryItemName)<br />
	return nil, fmt.Errorf("library item %s was not found", libraryItemName)<br />
}<br />
<br />
if len(items) &gt; 1 {<br />
	fmt.Printf("There are multiple library items with the name %s", libraryItemName)<br />
	return nil, fmt.Errorf("there are multiple library items with the name %s", libraryItemName)<br />
}<br />
<br />
item, err := m.GetLibraryItem(ctx, items[0])<br />
if err != nil {<br />
	fmt.Printf("Get library item by %s failed, %v", items[0], err)<br />
	return nil, err<br />
}<br />
<br />
return item, nil } 复制代码可以看到，找到 ovf 模板还是挺绕的。如果你确保你的内容库以及里面的 ovf 不会被删除重建的话，你可以首先找到这个 ovf 模板，记下它的 id。等下次要查找的时候，直接调用 m.GetLibraryItem() 就可以了。这样就不用找库，再通过库来找 item 了。 资源类型 模板有了，现在要做的就是确定要将虚拟机部署在哪。vsphere 中资源是有层级的，最外层就是数据中心，所有的资源都得属于某个数据中心，而一个 vsphere 中可以存在多个数据中心。 所以首先你得确认你要将虚拟机部署到哪个数据中心，然后再确定放在哪个集群的哪个资源池、哪个存储、哪个网络、哪个文件夹等，等这些都确定了就可以部署了。 因此我们首先要通过名称来找到这些资源，从数据中心开始。 数据中心 其实创建虚拟机不需要用到数据中心，但是由于其他的资源都在数据中心下面，所以你可以了解了解，当然你不看也没啥影响。 // 通过这个 finder 你可以列出 VMware 中的所有资源 finder := find.NewFinder(client.Client) dcs, err := finder.DatacenterList(ctx, "*") if err != nil {<br />
fmt.Fprintf(os.Stderr, "Failed to list data center at vc %s, %v\n", ip, err)<br />
os.Exit(1) }<br />
</code></pre></div></div><br />
<br />
<p>for _, dc := range dcs {<br />
    // 这个唯一名称是 vshpere 中的 id，大概类似于数据库中的自增 id，同一个 vsphere 中唯一，多个 vsphere 不唯一<br />
    dcUniqName := dc.Reference().Value<br />
    // 类型就是 DataCenter<br />
    dcType := dc.Reference().Type<br />
    // 数据中心的名称<br />
    dcName := dc.Name()<br />
    // 数据中心的路径，VMware 中的资源类似于 linux 的文件系统，从根开始，每个资源都有它唯一的路径<br />
    // 如果你知道一个资源的 path，那么你就可以直接通过这个路径找到这个资源，后续会提到<br />
    dcPath := dc.InventoryPath</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Printf("id =&gt; %s\nname =&gt; %s\npath =&gt; %s\ntype =&gt; %s\n", dcUniqName, dcName, dcPath, dcType) } 复制代码这就列出了所有的数据中心了。 集群 集群中有很多资源，有资源池和 esxi（也就是宿主机，VMware 中称为 HostSystem）。在有 vsan 或者集中存储的环境，你可以将虚拟机直接放在其中的集群资源池上（没有划分资源池也不要紧，集群默认就是一个资源池）；如果没有，那么就只能将虚拟机直接部署到宿主机上了。 因此你要么将虚拟机放到资源池中，要么放在宿主机上。而这种两种资源都属于集群，因此我们首先获取集群。当然其实你不获取集群也没有关系，可以直接获取资源池或者 host。我这里只是将获取集群的方式列出来，其实所有资源都是这么获取的： // 集群的名称为 ClusterComputeResource，不要搞错了 clusters, err := finder.ClusterComputeResourceList(ctx, "*") if err != nil {<br />
fmt.Fprintf(os.Stderr, "Failed to list cluster at vc %s, %v", ip, err)<br />
os.Exit(1) } for _, cluster := range clusters {<br />
clusterUniqName := cluster.Reference().Value<br />
clusterType := cluster.Reference().Type<br />
clusterName := cluster.Name()<br />
clusterPath := cluster.InventoryPath<br />
fmt.Printf("id =&gt; %s\nname =&gt; %s\npath =&gt; %s\ntype =&gt; %s\n", clusterUniqName, clusterName, clusterPath, clusterType) } 复制代码这里只是演示如何获取集群，但是创建虚拟机用不到，需要用的是资源池或者宿主机。它们两种的获取方式和集群一样： resourcePools, err := finder.ResourcePoolList(ctx, "*") hosts, err := finder.HostSystemList(ctx, "*") 复制代码当然你也可以直接通过集群来获取它自身的资源池： clusters[0].ResourcePool(ctx) 复制代码这种遍历资源的方式其实很 low，这个先不管，先把流程走通再说。 存储 储存也属于数据中心，既可以是 vsan，也可以是宿主机。这个是和上面的选择是一一对应的，如果你将虚拟机建在宿主机上，那么存储你就应该选择宿主机。 datastores, err := finder.DatastoreList(ctx, "*") if err != nil {<br />
fmt.Fprintf(os.Stderr, "Failed to list datastore at vc %s, %v", ip, err)<br />
os.Exit(1) } for _, datastore := range datastores {<br />
datastoreUniqName := datastore.Reference().Value<br />
datastoreType := datastore.Reference().Type<br />
datastoreName := datastore.Name()<br />
datastorePath := datastore.InventoryPath<br />
fmt.Printf("id =&gt; %s\nname =&gt; %s\npath =&gt; %s\ntype =&gt; %s\n", datastoreUniqName, datastoreName, datastorePath, datastoreType) } 复制代码VMware 中还存在 datastoreCluste 这种资源类型，但是我没有研究。 网络 网络属于数据中心，它会复杂一点，因为它有很多种类型：<br />
</code></pre></div></div><br />
<br />
<p>Network<br />
OpaqueNetwork<br />
DistributedVirtualPortgroup<br />
DistributedVirtualSwitch<br />
VmwareDistributedVirtualSwitch</p><br />
<br />
<p>具体有啥区别我不是很清楚，大概是如果你使用分布式交换机的话，你只需要选择端口组（DistributedVirtualPortgroup）这种的（交换机就不用选了），否则就选择 Network。<br />
networks, err := finder.NetworkList(ctx, “*”)<br />
if err != nil {<br />
    fmt.Fprintf(os.Stderr, “Failed to list network at vc %s, %v”, ip, err)<br />
    os.Exit(1)<br />
}</p><br />
<br />
<p>for _, network := range networks {<br />
    networkUniqName := network.Reference().Value<br />
    // 这就是它的 type，需要注意区分<br />
    networkType := network.Reference().Type<br />
    // 没有 name，name 可以通过 path 来获取<br />
    networkPath := network.GetInventoryPath()<br />
    fmt.Printf(“id =&gt; %s\npath =&gt; %s\ntype =&gt; %s\n”, networkUniqName, networkPath, networkType)<br />
}<br />
复制代码文件夹<br />
文件夹属于数据中心，获取起来方式一样：<br />
folders, err := finder.FolderList(ctx, “*”)<br />
if err != nil {<br />
    fmt.Fprintf(os.Stderr, “Failed to list folder at vc %s, %v”, ip, err)<br />
    os.Exit(1)<br />
}</p><br />
<br />
<p>for _, folder := range folders {<br />
    folderUniqName := folder.Reference().Value<br />
    folderType := folder.Reference().Type<br />
    folderName := folder.Name()<br />
    folderPath := folder.InventoryPath<br />
    fmt.Printf(“id =&gt; %s\nname =&gt; %s\npath =&gt; %s\ntype =&gt; %s\n”, folderUniqName, folderName, folderPath, folderType)<br />
}<br />
复制代码部署虚拟机<br />
资源都已经具备了，但是在部署之前，我们需要获取 ovf 模板的网络和存储，后面会用到。所以要拿到它们，可能是后面通过它部署虚拟机的时候，要把它们替换掉吧。<br />
获取的方式很简单：<br />
rc := rest.NewClient(client.Client)<br />
if err := rc.Login(ctx, url.UserPassword(user, password)); err != nil {<br />
    fmt.Fprintf(os.Stderr, “rc.Login failed, %v”, err)<br />
    os.Exit(1)<br />
}</p><br />
<br />
<p>// 先获取 ovf 模板，这个函数定义在前面<br />
item, err := getLibraryItem(ctx, rc)<br />
if err != nil {<br />
    panic(err)<br />
}</p><br />
<br />
<p>m := vcenter.NewManager(rc)<br />
// 这里需要前面获取到的资源池和文件夹，当然宿主机和文件夹也行，就是要将 ResourcePoolID 换成 HostID<br />
// 至于为什么这么做我也不清楚，只要可以获得我们需要的结果就行<br />
fr := vcenter.FilterRequest{Target: vcenter.Target{<br />
    ResourcePoolID: resources[0].Reference().Value,<br />
    FolderID:       folders[0].Reference().Value,<br />
},<br />
}<br />
r, err := m.FilterLibraryItem(ctx, item.ID, fr)<br />
if err != nil {<br />
    fmt.Fprintf(os.Stderr, “FilterLibraryItem error, %v\n”, err)<br />
    os.Exit(1)<br />
}<br />
// 模板中的网卡和磁盘可能有多个，我这里当做一个来处理，建议模板中只有一个网卡的磁盘，因为创建虚拟机的时候可以加<br />
// 这两个 key 后面会用到<br />
networkKey := r.Networks[0]<br />
storageKey := r.StorageGroups[0]<br />
fmt.Println(networkKey, storageKey)<br />
复制代码接下里就是部署了：<br />
deploy := vcenter.Deploy{<br />
    DeploymentSpec: vcenter.DeploymentSpec{<br />
        // 虚拟机名称<br />
        Name:               “test”,<br />
        DefaultDatastoreID: datastores[0].Reference().Value,<br />
        AcceptAllEULA:      true,<br />
        NetworkMappings: []vcenter.NetworkMapping{{<br />
            Key:   networkKey,<br />
            Value: networks[0].Reference().Value,<br />
        }},<br />
        StorageMappings: []vcenter.StorageMapping{{<br />
            Key: storageKey,<br />
            Value: vcenter.StorageGroupMapping{<br />
                Type:         “DATASTORE”,<br />
                DatastoreID:  datastores[0].Reference().Value,<br />
                // 精简置备<br />
                Provisioning: “thin”,<br />
            },<br />
        }},<br />
        // 精简置备<br />
        StorageProvisioning: “thin”,<br />
    },<br />
    Target: vcenter.Target{<br />
        ResourcePoolID: resources[0].Reference().Value,<br />
        FolderID:       folders[0].Reference().Value,<br />
    },<br />
}</p><br />
<br />
<p>ref, err := vcenter.NewManager(rc).DeployLibraryItem(ctx, item.ID, deploy)<br />
if err != nil {<br />
    fmt.Printf(“Deploy vm from library failed, %v”, err)<br />
    return<br />
}</p><br />
<br />
<p>f := find.NewFinder(client.Client)<br />
obj, err := f.ObjectReference(ctx, *ref)<br />
if err != nil {<br />
    fmt.Fprintf(os.Stderr, “Find vm failed, %v\n”, err)<br />
    os.Exit(1)<br />
}</p><br />
<br />
<p>// 这是虚拟机本尊，后面会用到<br />
vm = obj.(*object.VirtualMachine)<br />
复制代码这就开始部署了。<br />
注意我这里所有的资源都是选择的第一个，只是为了演示，你在使用的时候，需要选择正确的才行。当然前面通过遍历的方式获取所有的资源方式显得很 low，而且性能很差。我们的做法是定时去抓取所有 vsphere 的所有资源，将其存到 MySQL 中，包括资源的名称、类型（网络才需要）、路径（这是关键）、资源的 ID（也就是 uniqName）。<br />
这样在创建虚拟机的时候通过选择这些资源，就可以拿到这些资源的路径，而通过这些路径是可以直接获取资源本身的。这里以存储举例：<br />
si := object.NewSearchIndex(client.Client)<br />
inventoryPath, err := si.FindByInventoryPath(ctx, “/beijing/datastore/store1”)<br />
if inventoryPath == nil {<br />
    fmt.Fprintf(os.Stderr, “Get datastore object failed, %v”, err)<br />
    return<br />
}</p><br />
<br />
<p>// 如果是其他资源就换成其他资源就行<br />
ds := object.NewDatastore(client.Client, inventoryPath.Reference())<br />
复制代码完整代码<br />
package main</p><br />
<br />
<p>import (<br />
	“context”<br />
	“fmt”<br />
	“github.com/vmware/govmomi”<br />
	“github.com/vmware/govmomi/find”<br />
	“github.com/vmware/govmomi/vapi/library”<br />
	“github.com/vmware/govmomi/vapi/rest”<br />
	“github.com/vmware/govmomi/vapi/vcenter”<br />
	“net/url”<br />
	“os”<br />
)</p><br />
<br />
<p>func getLibraryItem(ctx context.Context, rc <em>rest.Client) (</em>library.Item, error) {<br />
	const (<br />
		libraryName     = “Librarysub_from_49.100”<br />
		libraryItemName = “CentOS 7.5”<br />
		libraryItemType = “ovf”<br />
	)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m := library.NewManager(rc)<br />
libraries, err := m.FindLibrary(ctx, library.Find{Name: libraryName})<br />
if err != nil {<br />
	fmt.Printf("Find library by name %s failed, %v", libraryName, err)<br />
	return nil, err<br />
}<br />
<br />
if len(libraries) == 0 {<br />
	fmt.Printf("Library %s was not found", libraryName)<br />
	return nil, fmt.Errorf("library %s was not found", libraryName)<br />
}<br />
<br />
if len(libraries) &gt; 1 {<br />
	fmt.Printf("There are multiple libraries with the name %s", libraryName)<br />
	return nil, fmt.Errorf("there are multiple libraries with the name %s", libraryName)<br />
}<br />
<br />
items, err := m.FindLibraryItems(ctx, library.FindItem{Name: libraryItemName,<br />
	Type: libraryItemType, LibraryID: libraries[0]})<br />
<br />
if err != nil {<br />
	fmt.Printf("Find library item by name %s failed", libraryItemName)<br />
	return nil, fmt.Errorf("find library item by name %s failed", libraryItemName)<br />
}<br />
<br />
if len(items) == 0 {<br />
	fmt.Printf("Library item %s was not found", libraryItemName)<br />
	return nil, fmt.Errorf("library item %s was not found", libraryItemName)<br />
}<br />
<br />
if len(items) &gt; 1 {<br />
	fmt.Printf("There are multiple library items with the name %s", libraryItemName)<br />
	return nil, fmt.Errorf("there are multiple library items with the name %s", libraryItemName)<br />
}<br />
<br />
item, err := m.GetLibraryItem(ctx, items[0])<br />
if err != nil {<br />
	fmt.Printf("Get library item by %s failed, %v", items[0], err)<br />
	return nil, err<br />
}<br />
return item, nil }<br />
</code></pre></div></div><br />
<br />
<p>func main() {<br />
	const (<br />
		ip       = “”<br />
		user     = “”<br />
		password = “”<br />
	)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>u := &amp;url.URL{<br />
	Scheme: "https",<br />
	Host:   ip,<br />
	Path:   "/sdk",<br />
}<br />
ctx := context.Background()<br />
u.User = url.UserPassword(user, password)<br />
client, err := govmomi.NewClient(ctx, u, true)<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Login to vsphere failed, %v", err)<br />
	os.Exit(1)<br />
}<br />
<br />
finder := find.NewFinder(client.Client)<br />
resourcePools, err := finder.ResourcePoolList(ctx, "*")<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Failed to list resource pool at vc %s, %v", ip, err)<br />
	os.Exit(1)<br />
}<br />
//hosts, err := finder.HostSystemList(ctx, "*")<br />
datastores, err := finder.DatastoreList(ctx, "*")<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Failed to list datastore at vc %s, %v", ip, err)<br />
	os.Exit(1)<br />
}<br />
<br />
networks, err := finder.NetworkList(ctx, "*")<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Failed to list network at vc %s, %v", ip, err)<br />
	os.Exit(1)<br />
}<br />
<br />
folders, err := finder.FolderList(ctx, "*")<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Failed to list folder at vc %s, %v", ip, err)<br />
	os.Exit(1)<br />
}<br />
<br />
rc := rest.NewClient(client.Client)<br />
if err := rc.Login(ctx, url.UserPassword(user, password)); err != nil {<br />
	fmt.Fprintf(os.Stderr, "rc.Login failed, %v", err)<br />
	os.Exit(1)<br />
}<br />
<br />
item, err := getLibraryItem(ctx, rc)<br />
if err != nil {<br />
	return<br />
}<br />
<br />
m := vcenter.NewManager(rc)<br />
fr := vcenter.FilterRequest{Target: vcenter.Target{<br />
	ResourcePoolID: resourcePools[0].Reference().Value,<br />
	FolderID:       folders[0].Reference().Value,<br />
},<br />
}<br />
r, err := m.FilterLibraryItem(ctx, item.ID, fr)<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "FilterLibraryItem error, %v\n", err)<br />
	os.Exit(1)<br />
}<br />
networkKey := r.Networks[0]<br />
storageKey := r.StorageGroups[0]<br />
<br />
deploy := vcenter.Deploy{<br />
	DeploymentSpec: vcenter.DeploymentSpec{<br />
		Name:               "test",<br />
		DefaultDatastoreID: datastores[0].Reference().Value,<br />
		AcceptAllEULA:      true,<br />
		NetworkMappings: []vcenter.NetworkMapping{{<br />
			Key:   networkKey,<br />
			Value: networks[0].Reference().Value,<br />
		}},<br />
		StorageMappings: []vcenter.StorageMapping{{<br />
			Key: storageKey,<br />
			Value: vcenter.StorageGroupMapping{<br />
				Type:        "DATASTORE",<br />
				DatastoreID: datastores[0].Reference().Value,<br />
				Provisioning: "thin",<br />
			},<br />
		}},<br />
		StorageProvisioning: "thin",<br />
	},<br />
	Target: vcenter.Target{<br />
		ResourcePoolID: resourcePools[0].Reference().Value,<br />
		FolderID:       folders[0].Reference().Value,<br />
	},<br />
}<br />
<br />
ref, err := vcenter.NewManager(rc).DeployLibraryItem(ctx, item.ID, deploy)<br />
if err != nil {<br />
	fmt.Printf("Deploy vm from library failed, %v", err)<br />
	return<br />
}<br />
<br />
f := find.NewFinder(client.Client)<br />
obj, err := f.ObjectReference(ctx, *ref)<br />
if err != nil {<br />
	fmt.Fprintf(os.Stderr, "Find vm failed, %v\n", err)<br />
	os.Exit(1)<br />
}<br />
<br />
vm = obj.(*object.VirtualMachine) } 复制代码设置 ip 部署完成后，我们还需要对虚拟机做一些配置，包括配置 ip、更改 cpu 和内存的配置、增加磁盘等，注意这些操作必须在虚拟机关机的情况下才能进行，而刚部署完的虚拟机处于关机状态，我们正好进行操作。 需要注意的是，配置 ip 依赖于 vmtools，因此你得先确保你的模板中已经存在 vmtools。CentOS 6 安装 vm_tools 可能有些麻烦，还得挂盘按照官方的要求一步步进行。但是在 CentOS 7 上你只需要安装 open-vm-tools，然后安装 perl 即可。 type ipAddr struct {<br />
ip       string<br />
netmask  string<br />
gateway  string<br />
hostname string }<br />
</code></pre></div></div><br />
<br />
<p>func (p *ipAddr) setIP(ctx context.Context, vm *object.VirtualMachine) error {<br />
	cam := types.CustomizationAdapterMapping{<br />
		Adapter: types.CustomizationIPSettings{<br />
			Ip:         &amp;types.CustomizationFixedIp{IpAddress: p.ip},<br />
			SubnetMask: p.netmask,<br />
			Gateway:    []string{p.gateway},<br />
		},<br />
	}</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>customSpec := types.CustomizationSpec{<br />
	NicSettingMap: []types.CustomizationAdapterMapping{cam},<br />
	Identity:      &amp;types.CustomizationLinuxPrep{HostName: &amp;types.CustomizationFixedName{Name: p.hostname}},<br />
}<br />
<br />
task, err := vm.Customize(ctx, customSpec)<br />
if err != nil {<br />
	return err<br />
}<br />
<br />
return task.Wait(ctx) } 复制代码设置 CPU 和内存 func setCPUAndMem(ctx context.Context, vm *object.VirtualMachine, cpuNum int32, mem int64) error {<br />
spec := types.VirtualMachineConfigSpec{<br />
	NumCPUs:             cpuNum,<br />
	NumCoresPerSocket:   cpuNum / 2,<br />
	MemoryMB:            1024 * mem,<br />
	CpuHotAddEnabled:    types.NewBool(true),<br />
	MemoryHotAddEnabled: types.NewBool(true),<br />
}<br />
task, err := vm.Reconfigure(ctx, spec)<br />
if err != nil {<br />
	return err<br />
}<br />
<br />
return task.Wait(ctx) } 复制代码添加磁盘 你需要给它传递一个数据存储对象： func addDisk(ctx context.Context, vm *object.VirtualMachine, diskCapacityKB int64, ds *types.ManagedObjectReference) error {<br />
devices, err := vm.Device(ctx)<br />
if err != nil {<br />
	log.Errorf("Failed to get device list for vm %s, %v", vm.Name(), err)<br />
	return err<br />
}<br />
<br />
// 这里要看你的磁盘类型，如果你有 nvme，就选择 nvme；否则就选 scsi。当然还有 ide，但是还有人用么<br />
controller, err := devices.FindDiskController("scsi")<br />
if err != nil {<br />
	log.Errorf("Failed to find disk controller by name scsi, %v", err)<br />
	return err<br />
}<br />
<br />
device := types.VirtualDisk{<br />
	CapacityInKB: diskCapacityKB,<br />
	VirtualDevice: types.VirtualDevice{<br />
		Backing: &amp;types.VirtualDiskFlatVer2BackingInfo{<br />
			DiskMode:        string(types.VirtualDiskModePersistent),<br />
			ThinProvisioned: types.NewBool(true),<br />
			VirtualDeviceFileBackingInfo: types.VirtualDeviceFileBackingInfo{<br />
				Datastore: ds,<br />
			},<br />
		},<br />
	},<br />
}<br />
<br />
devices.AssignController(&amp;device, controller)<br />
DeviceSpec := &amp;types.VirtualDeviceConfigSpec{<br />
	Operation:     types.VirtualDeviceConfigSpecOperationAdd,<br />
	FileOperation: types.VirtualDeviceConfigSpecFileOperationCreate,<br />
	Device:        &amp;device,<br />
}<br />
<br />
spec := types.VirtualMachineConfigSpec{}<br />
spec.DeviceChange = append(spec.DeviceChange, DeviceSpec)<br />
task, err := vm.Reconfigure(ctx, spec)<br />
if err != nil {<br />
	log.Errorf("Failed to add disk for vm %s, %v", vm.Name(), err)<br />
	return err<br />
}<br />
<br />
if err := task.Wait(ctx); err != nil {<br />
	log.Errorf("Failed to add disk for vm %s, %v", vm.Name(), err)<br />
	return err<br />
}<br />
return nil } 复制代码开机 在设置了 ip 之后，开机会启动两次，就是第一次启动成功后会重启一次，两次加起来时间还有点长。我也不知道为啥会这样，反正需要等一会儿。 func powerOn(ctx context.Context, vm *object.VirtualMachine) error {<br />
task, err := vm.PowerOn(ctx)<br />
if err != nil {<br />
	log.Errorf("Failed to power on %s", vm.Name())<br />
	return err<br />
}<br />
<br />
return task.Wait(ctx) } 复制代码govmomi 的功能非常多，我这里用到的这是非常少的一部分，如果无法满足你的所有需求，你可能需要看看 govc 源码了<br />
</code></pre></div></div><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>