<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">delve</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-04-10T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Apr 10, 2020</time></p>
					</div>
					 <p>安装Devle<br />
　　安装Devle非常简单，直接运行go  get 即可：</p><br />
<br />
<p>go get -u github.com/derekparker/delve/cmd/dlv<br />
　　如果你的go版本为1.5请先设置环境变量GO15VENDOREXPERIMENT=1再运行go get。我的go版本为1.10，不用设置。<br />
　　<br />
　　git clone https://github.com/go-delve/delve.git $GOPATH/src/github.com/go-delve/delve<br />
cd $GOPATH/src/github.com/go-delve/delve<br />
make install</p><br />
<br />
<!-- more --><br />
<p>使用Devle调试golang服务<br />
　　先写一个简单的web服务，然后使用Devle来进行调试。<br />
　　<br />
package main</p><br />
<br />
<p>import (<br />
    “fmt”<br />
    “log”<br />
    “net/http”<br />
    “os”<br />
)</p><br />
<br />
<p>const port  = “8000”</p><br />
<br />
<p>func main() {<br />
    http.HandleFunc(“/hi”, hi)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println("runing on port: " + port)<br />
log.Fatal(http.ListenAndServe(":" + port, nil)) }<br />
</code></pre></div></div><br />
<br />
<p>func hi(w http.ResponseWriter, r *http.Request) {<br />
    hostName, _ := os.Hostname()<br />
    fmt.Fprintf(w, “HostName: %s”, hostName)<br />
}</p><br />
<br />
<p>简单吧，一个运行在8000端口上的web服务，访问 hi会返回机器的名称。上面代码的行号是很有用的，等会我们打断点的时候会用到。</p><br />
<br />
<p>　  使用Delve运行我们的main.go</p><br />
<br />
<p>dlv debug ./main.go</p><br />
<br />
<p>很简单的一些命令</p><br />
<br />
<p>　　我们先打在main方法上打一个断点：</p><br />
<br />
<p>b main.main</p><br />
<br />
<p>然后运行c 来运行到断点，<br />
在func li  里打一个断点，我们可以使用</p><br />
<br />
<p>b main.hi<br />
或者使用   “文件:行号”来打断点</p><br />
<br />
<p>b /home/goworkspace/src/github.com/mytest/main.go:20</p><br />
<br />
<p>现在执行continue 让服务跑起来。访问一下我们的服务，看hi方法会不会停下来。</p><br />
<br />
<p>curl localhost:8000/hi<br />
　　看到了没，在19号停下来了。<br />
　　<br />
输入 n 回车，执行到下一行</p><br />
<br />
<p>　　输入s 回车，单步执行</p><br />
<br />
<p>　　输入 print（别名p）输出变量信息　　</p><br />
<br />
<p>　　输入 args 打印出所有的方法参数信息</p><br />
<br />
<p>　　输入 locals 打印所有的本地变量</p><br />
<br />
<p>使用Delve附加到运行的golang服务进行调试<br />
 　　先编译一下我们的main.go然后去行main</p><br />
<br />
<p>go build main.go</p><br />
<br />
<p>./main</p><br />
<br />
<p>然后使用Delve附加到我们的项目上，先看一下我们的项目的pid</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
      <td>ps aux</td><br />
      <td>grep main</td><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>或者<br />
$ lsof -i tcp:8000<br />
COMMAND   PID USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME<br />
main    56267 didi    3u  IPv6 0xf6b535637660b19f      0t0  TCP *:irdmi (LISTEN)</p><br />
<br />
<p>dlv attach 56267</p><br />
<br />
<p>远程调试</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
      <td>在服务器上 ps x</td><br />
      <td>grep game 查找到gameserver的进程pid</td><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>然后服务器命令行输入：<br />
dlv attach $PID –headless –api-version=2 –log –listen=:8181</p><br />
<br />
<p>本机只要输入：</p><br />
<br />
<p>dlv connect remote_ip:8181 连接到服务器上的dlv进程，就可以在本机远程调试了。</p><br />
<br />
<p>goland调试<br />
<img src="https://xiazemin.github.io/MyBlog/img/goland_dlv.png" /><br />
dlv停止调试可以用ctrl+|</p><br />
<br />
<p>dlv attach go程序<br />
dlv attach 7148 –headless –listen=:2345 –api-version=2 –accept-multiclient</p><br />
<br />
<p>GoLand配置<br />
Main menu-&gt;Run-&gt;Edit Configurations…</p><br />
<br />
<p>-&gt; Go Remote<br />
Host改成服务器ip</p><br />
<br />
<p>Port: 2345</p><br />
<br />
<p>保存 后 Debug go remote</p><br />
<br />
<p>此时可以设置断点, 在 Variables 面板可以查看变量, 可以点击<strong>+增加Watch</strong></p><br />
<br />
<p>终止dlv和go程序<br />
dlv不终止, 则 go程序也无法终止<br />
而dlv只能通过终止进程的方式终止掉</p><br />
<br />
<p>kill -9 <code class="language-plaintext highlighter-rouge">ps -ef | grep "dlv|mytest" -E | awk '{print $2}'</code></p><br />
<br />
<p>为build或install参数加入关闭编译器优化的参数 -gcflags “-N -l”。例如:</p><br />
<br />
<p>go install -gcflags “-N -l” svc/gamesvc</p><br />
<br />
<p>LiteIDE中的delve调试器配置<br />
选择调试器<br />
在LiteIDE菜单中选择 调试-&gt;debugger/delve</p><br />
<br />
<p>delve环境变量设置<br />
这个时候, LiteIDE依然找不到delve, 因为它不在环境变量PATH中, 这里无需修改环境变量, 只需要LiteIDE的环境配置。在LiteIDE菜单中选择 查看-&gt;编辑当前环境, 在弹出的文档中修改</p><br />
<br />
<p>PATH=c:\mingw32\bin;%GOROOT%\bin;%PATH%;c:\your\path\to\delve<br />
1<br />
去掉PATH前的注释#, 在%PATH%添加分号, 然后和你到delve调试器的路径</p><br />
<br />
<p>goland是基于intellij IDEA推出的开发go的IDE，所以很多之前Intellij的使用习惯可以保留下来，实属developer的福音，今天遇到一个新的问题，就是我要调试远程服务器上的go代码，远程系统是ubuntu或者centos，总之是没有图形界面的，我想在本地调试该怎么办呢，答案是使用Delve 这个专门的调试工具。</p><br />
<br />
<p>前提：本地代码和远程代码保持一致，否则可能出现断点语句跟预期不一致或莫名其妙的情况。可以在Intellij中使用经典的remote host access插件来dowload或者upload代码实现同步。因为比较简单，具体使用姿势自行探索。</p><br />
<br />
<p>step1 远程主机<br />
安装delve，项目地址：https://github.com/derekparker/delve<br />
按照官方的提示安装即可（注意因为GFW等你懂得的原因，网络下载可能较慢或不可用，请自行使用某高科技软件，如ss+proxychains等工具）。</p><br />
<br />
<p>下载并安装完成后输入dlv就会看到帮助信息：</p><br />
<br />
<p>step2 本地<br />
本地进入IDE，在要调试的地方打上断点，然后<br />
run–debug–eidit configurations–&gt;添加remote主机信息。</p><br />
<br />
<p>点debug 确认后，就会等待远端传回的debug信息。切远端：</p><br />
<br />
<p>step3 远端<br />
如我要对 main.go 这个项目debug，对main进行编译后，可以直接运行<br />
dlv –listen=:2345 –headless=true –api-version=2 exec ./main<br />
然后本地就收到了调试信息。</p><br />
<br />
<p>golang remote debug和docker debug<br />
有时候我么需要远程调试golang程序,比如我们在macos写的代码,但是有时在linux上运行的,所以我们需要远程调试运行在linux系统的代码。另外一种情况是我们可以把goalng打包到docker 镜像中,代码跑在容器中同样可以调试。以goland为例。</p><br />
<br />
<p>remote debug<br />
远程调试golang代码需要在运行代码的远程机器上按照delve,然后以delve运行要调试的程序。</p><br />
<br />
<p>编译<br />
   export CGO_ENABLED=0 GOOS=linux GOARCH=amd64<br />
   go build -gcflags=’all -N -l’ main.go<br />
install delve<br />
   go get go get -u github.com/derekparker/delve/cmd/dlv <br />
delve 运行程序<br />
 dlv –listen=:2345 –headless=true –api-version=2 exec ./main<br />
goland 设置remote debug<br />
host为远程主机ip 端口是刚才dlv设置的端口</p><br />
<br />
<p>debug<br />
然后就像调试本地代码一样调试远程主机上的程序</p><br />
<br />
<p>dlv –listen=:2345 –headless=true –api-version=2 –accept-multiclient exec ./test1</p><br />
<br />
<table><br />
  <tbody><br />
    <tr><br />
      <td>在服务器上 ps x</td><br />
      <td>grep game 查找到gameserver的进程pid</td><br />
    </tr><br />
  </tbody><br />
</table><br />
<br />
<p>然后服务器命令行输入：<br />
dlv attach $PID –headless –api-version=2 –log –listen=:8181</p><br />
<br />
<p>本机只要输入：</p><br />
<br />
<p>dlv connect www.example.com:8181 连接到服务器上的dlv进程，就可以在本机远程调试了。</p><br />
<br />
<p>需要注意的是</p><br />
<br />
<p>本机quit 以后，远程dlv进程也会结束。<br />
本机没有dlv connect，远程dlv直接关闭会导致 远程调试进程PID直接退出（很是忧伤）<br />
本机dlv输入quit以后，会让你选择是否关闭调试进程，这个有时候也方便，不过大多数都是选择N 不关闭调试进程PID</p><br />
<br />
<p>could not attach to pid 56267: open : no such file or directory</p><br />
<br />
<p>问题<br />
Goland和Idea使用debug报错，如下：could not launch process: decoding dwarf section info at offset 0x0: too short。</p><br />
<br />
<p>解决方法<br />
1,更新dlv</p><br />
<br />
<p>go get -u github.com/derekparker/delve/cmd/dlv<br />
2.修改goland或idea配置<br />
更新后的div在$gopath路径下的bin文件夹下。</p><br />
<br />
<p>替换到idea或goland的这个目录下</p><br />
<br />
<p>Delve（dlv）无法附加到进程<br />
I’m getting this error back from dlv</p><br />
<br />
<p>could not attach to pid 20727: decoding dwarf section info at offset 0x0: too short<br />
The binary is built in this way:</p><br />
<br />
<p>go build -a -v -ldflags “-w -X main.gitCommit=<sha> -linkmode 'auto' -extldflags '-static'"<br />
Could you confirm that is the<br />
-w<br />
flag that cause the following issue? Does it strip the debug symbol?</sha></p><br />
<br />
<p>After I’ve removed the -w flag delve was able to attach to the process</p><br />
<br />
<p>$ sudo dlv attach 69291<br />
could not attach to pid 69291: open : no such file or directory</p><br />
<br />
<p>https://stackoverflow.com/questions/54338111/delve-dlv-is-not-able-to-attach-to-the-process</p><br />
<br />
<p>https://stackoverflow.com/questions/53621853/golang-dlv-unable-to-see-source-no-such-file-or-directory</p><br />
<br />
<p>could not attach to pid: decoding dwarf section info at offset 0x0: too short</p><br />
<br />
<p>第一次使用dlv attach，就碰到了这个莫名的问题。查了好多资料，都说是dlv版本太低，让更新dlv，，，试了，无果。<br />
终于在derekparker/delve的issue中的一个问题找到查错思路，go build的参数？<br />
查看编译命令：go build -o $(APP) -x -ldflags “-w -s”<br />
参数中-ldflags “-w -s”含义：</p><br />
<br />
<p>-ldflags ‘flag list’<br />
    ‘-s -w’: 压缩编译后的体积<br />
    -s: 去掉符号表<br />
    -w: 去掉调试信息，不能gdb调试了</p><br />
<br />
<p>去掉了-ldflags “-w -s”后重新编包，问题解决。</p><br />
<br />
<p>gdb是强大的调试工具。但对于golang程序来说，delve是个更好的选择，它能更好地理解Go runtime, data structures, and expressions，尤其是goroutine。</p><br />
<br />
<p>以下描述引用自Debugging Go Code with GDB【1】</p><br />
<br />
<p>Note that Delve is a better alternative to GDB when debugging Go programs built with the standard toolchain. It understands the Go runtime, data structures, and expressions better than GDB. Delve currently supports Linux, OSX, and Windows on amd64. For the most up-to-date list of supported platforms, please see the Delve documentation.</p><br />
<br />
<p>GDB does not understand Go programs well. The stack management, threading, and runtime contain aspects that differ enough from the execution model GDB expects that they can confuse the debugger and cause incorrect results even when the program is compiled with gccgo. As a consequence, although GDB can be useful in some situations (e.g., debugging Cgo code, or debugging the runtime itself), it is not a reliable debugger for Go programs, particularly heavily concurrent ones. Moreover, it is not a priority for the Go project to address these issues, which are difficult.</p><br />
<br />
<p>Delve is a debugger for the Go programming language【2】.</p><br />
<br />
<p>安装<br />
安装过程参考https://github.com/go-delve/delve/tree/master/Documentation/installation</p><br />
<br />
<p>安装好后，可以查看版本</p><br />
<br />
<p>➜  _posts dlv version<br />
Delve Debugger<br />
Version: 1.1.0<br />
Build: $Id: 1990ba12450cab9425a2ae62e6ab988725023d5c<br />
调试方法<br />
dlv提供了多种调试命令，如debug、exec、attach、core等，具体见官网文档或help信息。接下介绍常用的几种。</p><br />
<br />
<p>dlv debug<br />
这是一个代码工程实例, 位于目录GoWorks/GoDbg。</p><br />
<br />
<p>image</p><br />
<br />
<p>如果位于工程目录下，可以dlv debug开始调试；<br />
也可以指定目录，dlv debug GoWorks/GoDbg;<br />
如果要传入参数，添加–后指定， 如dlv debug GoWorks/GoDbg – -arg1 value<br />
➜  GoDbg dlv debug GoWorks/GoDbg<br />
Type ‘help’ for list of commands.<br />
(dlv) break main.main<br />
Breakpoint 1 set at 0x1089f6b for main.main() ./main.go:7<br />
(dlv) continue</p><br />
<blockquote><br />
  <p>main.main() ./main.go:7 (hits goroutine(1):1 total:1) (PC: 0x1089f6b)<br />
     2:	import (<br />
     3:		“GoWorks/GoDbg/mylib”<br />
     4:		“fmt”<br />
     5:		“os”<br />
     6:	)<br />
=&gt;   7:	func main() {<br />
     8:		fmt.Println(“Golang dbg test…”)<br />
     9:		var argc = len(os.Args)<br />
    10:		var argv = append([]string{}, os.Args…)<br />
    11:		fmt.Printf(“argc:%d\n”, argc)<br />
    12:		fmt.Printf(“argv:%v\n”, argv)<br />
(dlv) next<br />
main.main() ./main.go:8 (PC: 0x1089f82)<br />
     3:		“GoWorks/GoDbg/mylib”<br />
     4:		“fmt”<br />
     5:		“os”<br />
     6:	)<br />
     7:	func main() {<br />
=&gt;   8:		fmt.Println(“Golang dbg test…”)<br />
     9:		var argc = len(os.Args)<br />
    10:		var argv = append([]string{}, os.Args…)<br />
    11:		fmt.Printf(“argc:%d\n”, argc)<br />
    12:		fmt.Printf(“argv:%v\n”, argv)<br />
    13:		var var1 = 1<br />
具体有哪些debug命令，可以help来查看，与gdb的很类似，goroutine/goroutines的是dlv中特有的。</p><br />
</blockquote><br />
<br />
<p>(dlv) help<br />
The following commands are available:<br />
    args ———————— Print function arguments.<br />
    break (alias: b) ———— Sets a breakpoint.<br />
    breakpoints (alias: bp) —– Print out info for active breakpoints.<br />
    call ———————— Resumes process, injecting a function call (EXPERIMENTAL!!!)<br />
    clear ———————– Deletes breakpoint.<br />
    clearall ——————– Deletes multiple breakpoints.<br />
    condition (alias: cond) —– Set breakpoint condition.<br />
    config ———————- Changes configuration parameters.<br />
    continue (alias: c) ——— Run until breakpoint or program termination.   // 继续运行<br />
    deferred ——————– Executes command in the context of a deferred call.<br />
    disassemble (alias: disass) - Disassembler.<br />
    down ———————— Move the current frame down.<br />
    edit (alias: ed) ———— Open where you are in $DELVE_EDITOR or $EDITOR<br />
    exit (alias: quit | q) —— Exit the debugger.<br />
    frame ———————– Set the current frame, or execute command on a different frame.<br />
    funcs ———————– Print list of functions.<br />
    goroutine (alias: gr) ——- Shows or changes current goroutine<br />
    goroutines (alias: grs) —– List program goroutines.<br />
    help (alias: h) ————- Prints the help message.<br />
    libraries ——————- List loaded dynamic libraries<br />
    list (alias: ls | l) ——– Show source code.    // 显示代码<br />
    locals ———————- Print local variables.<br />
    next (alias: n) ————- Step over to next source line.  // 单步下一句<br />
    on ————————– Executes a command when a breakpoint is hit.<br />
    print (alias: p) ———— Evaluate an expression.<br />
    regs ———————— Print contents of CPU registers.<br />
    restart (alias: r) ———- Restart process.<br />
    set ————————- Changes the value of a variable.<br />
    source ———————- Executes a file containing a list of delve commands<br />
    sources ——————— Print list of source files.<br />
    stack (alias: bt) ———– Print stack trace.<br />
    step (alias: s) ————- Single step through program.  // 进入函数内,单步下一句<br />
    step-instruction (alias: si)  Single step a single cpu instruction.<br />
    stepout (alias: so) ——— Step out of the current function.<br />
    thread (alias: tr) ———- Switch to the specified thread.<br />
    threads ——————— Print out info for every traced thread.<br />
    trace (alias: t) ———— Set tracepoint.<br />
    types ———————– Print list of types<br />
    up ————————– Move the current frame up.<br />
    vars ———————— Print package variables.<br />
    whatis ———————- Prints type of an expression.<br />
Type help followed by a command for full documentation.<br />
dlv exec<br />
Execute a precompiled binary, and begin a debug session.</p><br />
<br />
<p>➜  file ./main<br />
./main: Mach-O 64-bit executable x86_64<br />
➜  dlv exec ./main<br />
Type ‘help’ for list of commands.<br />
(dlv)<br />
dlv attach<br />
Attach to running process and begin debugging.</p><br />
<br />
<p>注意：在退出时，有可选是否要kill该进程。</p><br />
<br />
<p>[root@yg-man-uhost-set9-01 ~]# dlv attach 22063<br />
Type ‘help’ for list of commands.<br />
(dlv) q<br />
Would you like to kill the process? [Y/n] n<br />
dlv core<br />
Examine a core dump.</p><br />
<br />
<p>注意：dlv不支持生成core，可以通过gdb attach上去后，执行gcore来生成core；然后再dlv core来调试。</p><br />
<br />
<p>线上调试的例子<br />
排查过程<br />
线上一个服务出现了问题，看日志是一个接口的程序跑了一半，后面不再执行下去了。</p><br />
<br />
<p>dlv attach上去后，看到有很多.runtime_SemacquireMutex这个的goroutine，一直卡着。</p><br />
<br />
<p>Goroutine 28232679 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232684 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232685 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232686 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232688 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232704 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232705 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232710 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232714 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232715 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232718 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232719 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232721 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232726 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232727 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28232939 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28232940 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28239464 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239465 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28239914 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239915 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28239938 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239939 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28239965 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239966 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28239968 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(<em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239984 - User: /Users/patrick.xu/go/src/uframework/task/tcp_task.go:84 uframework/task.(</em>TCPTask).Run (0x6ce8cc)<br />
Goroutine 28239985 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28240001 - User: /usr/local/go/src/runtime/sema.go:62 sync.runtime_SemacquireMutex (0x43cb74)<br />
Goroutine 28240961 - User: /Users/patrick.xu/go/src/uframework/log/logext.go:281 uframework/log.RealWrite (0x6bff2d)<br />
Goroutine 28241103 - User: /Users/patrick.xu/go/src/uframework/utils/zookeeper/zk/conn.go:515 uframework/utils/zookeeper/zk.(<em>Conn).sendLoop (0x7c7835)<br />
Goroutine 28241104 - User: /usr/local/go/src/runtime/netpoll.go:164 net.runtime_pollWait (0x426ec9)<br />
Goroutine 28241126 - User: /usr/local/go/src/runtime/sema.go:47 sync.runtime_Semacquire (0x43ca94)<br />
看这个goroutine卡在了0x000000000046c45d in sync.(</em>Mutex).Lock，对应业务代码uhost-go/uhost-scheduler/logic.updateBuffer。</p><br />
<br />
<p>(dlv) gr 28239985<br />
Switched from 28241159 to 28239985 (thread 31788)<br />
(dlv) bt<br />
0  0x000000000042c76a in runtime.gopark<br />
   at /usr/local/go/src/runtime/proc.go:272<br />
1  0x000000000042c84e in runtime.goparkunlock<br />
   at /usr/local/go/src/runtime/proc.go:277<br />
2  0x000000000043ce91 in runtime.semacquire<br />
   at /usr/local/go/src/runtime/sema.go:130<br />
3  0x000000000043cb74 in sync.runtime_SemacquireMutex<br />
   at /usr/local/go/src/runtime/sema.go:62<br />
4  0x000000000046c45d in sync.(<em>Mutex).Lock<br />
   at /usr/local/go/src/sync/mutex.go:87<br />
5  0x0000000000817b1d in uhost-go/uhost-scheduler/logic.updateBuffer<br />
   at /Users/patrick.xu/go/src/uhost-go/uhost-scheduler/logic/get_suitable_resource.go:418<br />
6  0x0000000000814bd7 in uhost-go/uhost-scheduler/logic.getSuitableResource<br />
   at /Users/patrick.xu/go/src/uhost-go/uhost-scheduler/logic/get_suitable_resource.go:328<br />
7  0x00000000006cecd4 in uframework/task.TCPTaskFunc.ServeTCP<br />
   at /Users/patrick.xu/go/src/uframework/task/tcp_task_handle.go:27<br />
8  0x00000000006d02b8 in uframework/task.(</em>TCPTask).Run.func1<br />
   at /Users/patrick.xu/go/src/uframework/task/tcp_task.go:66<br />
9  0x0000000000458dd1 in runtime.goexit<br />
   at /usr/local/go/src/runtime/asm_amd64.s:2197<br />
再去看业务代码， frame 5 list</p><br />
<br />
<p>(dlv) frame 5 list<br />
Goroutine 28239985 frame 5 at /Users/patrick.xu/go/src/uhost-go/uhost-scheduler/logic/get_suitable_resource.go:418 (PC: 0x817b1d)<br />
Command failed: open /Users/patrick.xu/go/src/uhost-go/uhost-scheduler/logic/get_suitable_resource.go: no such file or directory<br />
由于线上没有源代码，提示文件不存在。到本地查看这行的代码。<br />
image</p><br />
<br />
<p>定位到这行后，再结合业务逻辑去分析，就能定位到是哪里问题，造成了这里的死锁。</p><br />
<br />
<p>最后退出来后，注意向上代码别重启。</p><br />
<br />
<p>(dlv) q<br />
Would you like to kill the process? [Y/n] n<br />
和gdb的对比<br />
gdb能看出的信息有限，只能定位到线程这个层面，无法到goroutine这一层，很难定位出问题。</p><br />
<br />
<p>(gdb) info threads</p><br />
<ul><br />
  <li>1 process 10732  runtime.epollwait () at /usr/local/go/src/runtime/sys_linux_amd64.s:560<br />
(gdb) thread apply all bt</li><br />
</ul><br />
<br />
<p>Thread 1 (process 10732):<br />
#0  runtime.epollwait () at /usr/local/go/src/runtime/sys_linux_amd64.s:560<br />
#1  0x00000000004280d1 in runtime.netpoll (block=true, ~r1=0x1) at /usr/local/go/src/runtime/netpoll_epoll.go:67<br />
#2  0x0000000000430f8f in runtime.findrunnable (gp#10=0xc42001c000, inheritTime=false) at /usr/local/go/src/runtime/proc.go:2084<br />
#3  0x0000000000431aec in runtime.schedule () at /usr/local/go/src/runtime/proc.go:2222<br />
#4  0x0000000000431deb in runtime.park_m (gp=0xc4200011e0) at /usr/local/go/src/runtime/proc.go:2285<br />
#5  0x000000000045626b in runtime.mcall () at /usr/local/go/src/runtime/asm_amd64.s:269<br />
#6  0x0000000000cebd00 in runtime.work ()<br />
#7  0x00007ffe3162bc70 in ?? ()<br />
#8  0x0000000000cebd80 in runtime.work ()<br />
#9  0x00007ffe3162bc60 in ?? ()<br />
#10 0x000000000042f0e4 in runtime.mstart () at /usr/local/go/src/runtime/proc.go:1149<br />
#11 0x00000000004560d9 in runtime.rt0_go () at /usr/local/go/src/runtime/asm_amd64.s:169<br />
#12 0x0000000000000009 in ?? ()<br />
#13 0x00007ffe3162bca8 in ?? ()<br />
#14 0x0000000000000009 in ?? ()<br />
#15 0x00007ffe3162bca8 in ?? ()<br />
#16 0x0000000000000000 in ?? ()<br />
但可以用gdb产生core，采集一些现场信息，然后重启尽快恢复业务，事后再用dlv分析core来定位原因。</p><br />
<br />
<p>参考链接<br />
Debugging Go Code with GDB<br />
go-delve/delve<br />
Golang程序调试工具介绍(gdb vs dlv)<br />
实战分析一个运行起来会卡死的Go程序</p><br />
<br />
<p>https://xusenqi.github.io/2019/08/25/%E9%80%9A%E8%BF%87delve-dlv-%E8%B0%83%E8%AF%95golang%E7%A8%8B%E5%BA%8F/</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>