<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Handling Errors in Your HTTP Handlers</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-04-15T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Apr 15, 2020</time></p>
					</div>
					 <p>It’s been a while since my last post, so I thought I would write about a pattern that I’ve come to like for handling errors in HTTP Handlers in Go.</p><br />
<br />
<p>I’ve always enjoyed the simplicity of writing web services in Go. You create your http.HandlerFuncs, add them to your router or server, and you’re done. There’s no magic.</p><br />
<br />
<p>With this simplicity however also comes with some downsides.</p><br />
<br />
<p>One thing I’ve never liked is how you are forced to handle errors in your http.Handler s and http.HandlerFunc s. Any error handling has to be done in your handler code, since the signatures require you to conform to handling a http.ResponseWriter and *http.Request without returning anything.<br />
<!-- more --><br />
// http.Handler interface<br />
ServeHTTP(w http.ResponseWriter, r *http.Request)</p><br />
<br />
<p>// http.HandlerFunc type<br />
func(http.ResponseWriter, *http.Request)<br />
This is typically fine for small web services/APIs that don’t have a large surface area, but I’ve found this approach breaks down when building APIs with a lot of functionality. It also makes it very difficult to conform to an API specification that has well defined error codes and responses.</p><br />
<br />
<p>Let me elaborate with a somewhat contrived example.</p><br />
<br />
<p>Implementing a Docker Registry API Endpoint<br />
Let’s say you want to implement the Docker Registry HTTP API V2 specification. This is the same API that Docker Hub implements which the Docker client communicates with when you do a docker pull or docker push.</p><br />
<br />
<p>Luckily for us, Docker did a great job when writing this spec and gives overviews of what your registry needs to implement in order to work with the Docker client. Heck, they even provided the appropriate Error Codes that you should return when something goes wrong, along with a description of when it’s appropriate to return these errors.</p><br />
<br />
<p>Back to our example. For the sake of terseness, let’s see what it would look like to implement a single endpoint for Pulling an Image Manifest, which is one of the first endpoints that the Docker client calls when you do a docker pull.</p><br />
<br />
<p>The spec defines that this endpoint should resolve requests that match:</p><br />
<br />
<p>GET /v2/<name>/manifests/<reference><br />
Let's implement this endpoint in pseudo-code, conforming to the http.HandlerFunc type.</reference></name></p><br />
<br />
<p>func (a *API) GetImageManifest(w http.ResponseWriter, *r http.Request) {<br />
    // TODO: do your auth here, handle unauthorized errors (1)</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// get the `name` and `reference` path variables using your favorite routing library (or stdlib if you are a masochist)<br />
var (<br />
  vars = mux.Vars(r)<br />
  name = vars["name"]<br />
  ref = vars["reference"]<br />
)<br />
<br />
// TODO: do some validation on those path variables, return errors if invalid (2/3)<br />
<br />
// get the image manifest from your database that matches that name/reference<br />
<br />
manifest, err := a.DB.GetManifest(name, ref)<br />
if err != nil {<br />
  // TODO: handle errors (4/5/6)<br />
}<br />
<br />
// encode your manifest to JSON, assume your manifest type has JSON struct tags added already or implements the json.Marshaller interface<br />
<br />
if err := json.NewEncoder(w).Encode(manifest); err != nil {<br />
  // TODO: handle error (7)<br />
}<br />
<br />
w.Header().Set("Content-Length", contentLength)<br />
w.Header().Set("Docker-Content-Digest", digest)<br />
w.WriteHeader(http.StatusOK) } Now that doesn't look too bad at first glance does it? But lets look a bit deeper and see all of the places that we have TODOs to handle errors.<br />
</code></pre></div></div><br />
<br />
<p>What Can Go Wrong?<br />
Here are some of the un-happy paths that we need to handle:</p><br />
<br />
<p>Authorization/Authentication fails: The user making the request is not authenticated in the case of a private image, or has invalid permissions<br />
The name variable from the request does not pass validation<br />
The ref variable from the request does not pass validation<br />
The manifest requested is not found<br />
The manifest found is somehow invalid<br />
The DB that you are retrieving the manifest from is not available or has some other error retrieving the results<br />
Encoding the retrieved manifest to JSON fails<br />
This list doesn’t even include the myriad of other networking related errors that can occur in the lifetime of your request, such as requests being cancelled or timing out.</p><br />
<br />
<p>Remember that for each of these error cases, we need to interpret the error and return the appropriate error response so that the Docker client can determine what to do.</p><br />
<br />
<p>This will lead to a lot of repetitive, boilerplate error handling across all of your http.Handlers such as:</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err == ErrNameInvalid {<br />
  // set correct HTTP Status code<br />
  // return `NAME_INVALID` error code in JSON response along with description<br />
}<br />
<br />
if err == ErrDigestInvalid {<br />
  // set correct HTTP Status code<br />
  // return `DIGEST_INVALID` error code in JSON response along with description<br />
} Not to mention what the error handling will look like for calls to lower level code that can return multiple error types such as:<br />
<br />
manifest, err := a.DB.GetManifest(name, ref)<br />
<br />
if err != nil {<br />
  switch t := err.(type) {<br />
    case NotFoundError:<br />
      // set 404 HTTP Status code<br />
      // return `MANIFEST_UNKNOWN` error code in JSON response along with description<br />
    case InvalidManifestError:<br />
      // set 400 HTTP Status code<br />
      // return `MANIFEST_INVALID` error code in JSON response along with description<br />
    case DBTimeoutError:<br />
      // set correct HTTP Status Code? Probably 500?<br />
      // return some appropriate error code in the JSON response?<br />
    case ...<br />
  }<br />
} You'll have to repeat this error handling code across your application whenever you call out to lower level code that do things like interacting with your database or authenticating requests.<br />
</code></pre></div></div><br />
<br />
<p>Also, think about what happens when someone adds a new error type that can be returned from this underlying code in the future? You’d have to go update all of your error handling code across your application!</p><br />
<br />
<p>A Different (Better?) Way<br />
What if you didn’t have to do all this repetitive error handling at all?</p><br />
<br />
<p>What if you could delegate this error handling to a single place in your application, that would allow you to more easily test your HTTP handlers as well as reduce the surface area of code that needs to change when new error types pop up?</p><br />
<br />
<p>Let’s change our http.HandlerFuncs to return an error:</p><br />
<br />
<p>// blasphemy!<br />
type handlerFunc func(w http.ResponseWriter, r *http.Request) error<br />
Obviously this no longer matches http.HandlerFuncs signature, so we can’t plug it in directly. However, we can adapt our new handlerFunc to match that which Go expects in one of two ways:</p><br />
<br />
<p>We can create a helper func to adapt our handlerFunc to a http.HandlerFunc:<br />
func handle(f handlerFunc) http.HandlerFunc {<br />
  return http.HandlerFunc(w http.ResponseWriter, r *http.Request) {<br />
    if err := f(w, r); err != nil {<br />
      // do all your error switching/handling here in one place!<br />
    }<br />
  }<br />
}<br />
We can also make our handlerFunc implement http.Handler:<br />
func (f handlerFunc) ServeHTTP(w http.ResponseWriter, r *http.Request) {<br />
    if err := f(w, r); err != nil {<br />
      // do all your error switching/handling here in one place!<br />
    }<br />
}<br />
How does this change our API code (boilerplate excluded)?</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>manifest, err := a.DB.GetManifest(name, ref)<br />
if err != nil {<br />
  return err<br />
}<br />
<br />
if err := json.NewEncoder(w).Encode(manifest); err != nil {<br />
  return err<br />
}<br />
<br />
w.Header().Set("Content-Length", contentLength)<br />
w.Header().Set("Docker-Content-Digest", digest)<br />
w.WriteHeader(http.StatusOK)<br />
<br />
return nil Then, when mounting our http.Handlers in our router we can do:<br />
</code></pre></div></div><br />
<br />
<p>// create a new <code class="language-plaintext highlighter-rouge">handlerFunc</code> from <code class="language-plaintext highlighter-rouge">a.GetImageManifest</code> which implements <code class="language-plaintext highlighter-rouge">http.Handler</code><br />
r.Handle(handlerFunc(a.GetImageManifest))</p><br />
<br />
<p>// or, return a <code class="language-plaintext highlighter-rouge">http.HandlerFunc</code> by calling our <code class="language-plaintext highlighter-rouge">handle</code> helper func<br />
r.HandleFunc(handle(a.GetImageManifest))<br />
Assumptions/Derivations<br />
Now, this pattern does come with some baked in assumptions that I should probably make explicit:</p><br />
<br />
<p>If the error returned from your handlerFunc is nil, then it’s expected that you already called w.Write and w.WriteHeader in your handler<br />
If the error returned from your handlerFunc is non-nil, then it’s expected that you haven’t called either, and will let the error handling code do that for you<br />
Of course you could make your own handlerFunc with any signature you wanted, and define your own ‘rules’. For example you could return an (status int, err error) to allow specifying the HTTP status code in the handlers themselves. Or you could even create and return your own type to include any metadata you want.</p><br />
<br />
<p>You can even create different adapter funcs/types to handle areas in your code that have different types of errors they can return.</p><br />
<br />
<p>The point is that you aren’t limited to the http.Handler or http.HandlerFunc signatures when implementing your handlers.</p><br />
<br />
<p>Testing<br />
Another major benefit that I’ve found when using this pattern is that it makes testing your handler code much easier when testing error conditions, which IMO are where you should spend the most time unit testing anyways.</p><br />
<br />
<p>Instead of inspecting the status code and body of the returned httptest.ResponseRecorder to assert that your errors were handled correctly, you can simply assert the errors returned from your handler code directly such as:</p><br />
<br />
<p>err := myHandler(w, r)</p><br />
<br />
<p>// using the wonderful https://github.com/stretchr/testify assert library<br />
assert.EqualError(t, err, “unauthorized”)<br />
Then you can test your error handling code in isolation as well, allowing you to have more complete test coverage!</p><br />
<br />
<p>Wrap Up<br />
I know that I didn’t invent this pattern, nor is it earth shattering. But I haven’t read much about it’s use in the past, so I thought I would write this post in case someone was looking for an alternative way to handle errors while reducing repetition when writing their HTTP handlers in Go.</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category golang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>