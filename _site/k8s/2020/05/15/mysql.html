<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Google Kubernetes Engine上运行HA MySQL</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-05-15T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 15, 2020</time></p>
					</div>
					 <p>https://mp.weixin.qq.com/s/woQkOCGxwmkGb2b0-VPBsw<br />
谷歌Kubernetes Engine(GKE)是一个用于在谷歌云平台中部署容器化应用程序的托管、可生产的环境。GKE于2015年上线，是第一个基于谷歌在容器中运营Gmail、YouTube等服务12年多经验的托管容器平台之一。为了完全消除对安装，管理，和操作Kubernetes集群的需要，GKE允许客户快速安装和运行Kubernetes。</p><br />
<br />
<p>Portworx是一个用于运行部署在多种编排引擎（包括Kubernetes）的持久性工作负载的云本地存储平台。利用Portworx，用户可以根据其选择利用任意框架和任意容器和容器调度管理数据库。无论服务运行在哪里，Portworx都能为有状态服务提供独立的数据管理层。本教程介绍了在GKE上部署和管理高可用MySQL数据库的步骤。总之，在谷歌云平台运行HA MySQL，你需要：</p><br />
<br />
<p>部署一个GKE集群</p><br />
<br />
<p>在GKE上安装类似Portworx的云本地存储解决方案作为守护进程组</p><br />
<br />
<p>创建存储类来定义存储需求，例如复制因子、快照策略，性能概要</p><br />
<br />
<p>利用Kubernetes部署MySQL</p><br />
<br />
<p>通过杀死或禁止调度节点检测故障转移<br />
<!-- more --><br />
如何部署GKE集群</p><br />
<br />
<p>在部署GKE集群运行Portworx之前，你需要确认集群是建立在Ubuntu系统上。由于基于容器优化OS (COS)的GKE集群的某些限制，Portworx需要Ubuntu作为GKE节点的基本镜像。以下命令在ap-south-1-a空间内配置了3个节点的GKE集群。你可以根据需要适当修改。</p><br />
<br />
<p>$ gcloud container clusters create “gke-px” <br /><br />
–zone “asia-south1-a” <br /><br />
–username “admin” <br /><br />
–cluster-version “1.8.10-gke.0” <br /><br />
–machine-type “n1-standard-4” <br /><br />
–image-type “UBUNTU” <br /><br />
–disk-type “pd-ssd” <br /><br />
–disk-size “100” <br /><br />
–num-nodes “3” <br /><br />
–enable-cloud-logging <br /><br />
–enable-cloud-monitoring <br /><br />
–network “default” <br /><br />
–addons HorizontalPodAutoscaling,HttpLoadBalancing,KubernetesDashboard</p><br />
<br />
<p>当集群已就绪，用以下命令配置kubectl CLI：</p><br />
<br />
<p>$ gcloud container clusters get-credentials gke-px –zone asia-south1-a</p><br />
<br />
<p>Portworx需要为用户建立ClusterRoleBinding。如果没有此配置，执行命令会报clusterroles.rbac.authorization.k8s.io “portworx-pvc-controller-role” is forbidden错误。</p><br />
<br />
<p>用以下命令创建ClusterRoleBinding：</p><br />
<br />
<p>$ kubectl create clusterrolebinding cluster-admin-binding <br /><br />
–clusterrole cluster-admin <br /><br />
–user $(gcloud config get-value account)</p><br />
<br />
<p>现在你应该已经在谷歌云平台搭建好了三个节点的Kubernetes集群。</p><br />
<br />
<p>$ kubectl get nodes<br />
NAME                                    STATUS    ROLES     AGE       VERSION<br />
gke-gke-px-default-pool-177a3f0b-nvxm   Ready         9d        v1.8.10-gke.0<br />
gke-gke-px-default-pool-177a3f0b-slkb   Ready         9d        v1.8.10-gke.0<br />
gke-gke-px-default-pool-177a3f0b-st0n   Ready         9d        v1.8.10-gke.0</p><br />
<br />
<p>在GKE中安装Portworx</p><br />
<br />
<p>在Amazon GKE中安装Portworx和通过Kops安装Kubernetes几乎没什么不同。</p><br />
<br />
<p>Portworx GKE文档包含在部署在GCP中的Kubernetes环境中运行Portworx集群所涉及的步骤。</p><br />
<br />
<p>在执行下一步之前，我们需要在GKE上启动Portworx集群。Kube-system命名空间应该有出于运行状态的Portoworx pods。</p><br />
<br />
<p>$ kubectl get pods -n=kube-system -l name=portworx<br />
NAME             READY     STATUS    RESTARTS   AGE<br />
portworx-g8sq5   1/1       Running   0          9d<br />
portworx-gnjpx   1/1       Running   0          9d<br />
portworx-tbrc6   1/1       Running   0          9d</p><br />
<br />
<p>为MySQL创建Kubernetes存储类</p><br />
<br />
<p>一旦GKE集群启动并运行，并且安装并配置了Portworx，我们将部署一个高可用的MySQL数据库。</p><br />
<br />
<p>通过Kubernetes存储类对象，管理员可以定义集群中提供的Portworx卷的不同类型。在动态提供判断时将会使用这些类。存储类定义复制因子、I/O配置文件(例如，用于数据库或CMS)和优先级(例如，SSD或HDD)。这些参数影响工作负载的可用性和吞吐量，我们可以为每个卷指定这些参数。这点非常重要，因为生产级数据库的要求不同于开发级的Jenkins集群。</p><br />
<br />
<p>在这个例子中，我们部署的存储类副本数为3，IO配置文件设置为”db”，优先级设置为”high”。这意味着存储将针对低延迟数据库工作负载(如MySQL)进行优化，同时将被放置到集群中可用的最高性能存储上。注意，我们还在存储类中涉及到了xfs文件系统。</p><br />
<br />
<p>$ cat &gt; px-mysql-sc.yaml « EOF<br />
kind: StorageClass<br />
apiVersion: storage.k8s.io/v1beta1<br />
metadata:<br />
    name: px-ha-sc<br />
provisioner: kubernetes.io/portworx-volume<br />
parameters:<br />
   repl: “3”<br />
   io_profile: “db”<br />
   io_priority: “high”<br />
   fs: “xfs”<br />
EOF<br />
$ kubectl create -f px-mysql-sc.yaml<br />
storageclass.storage.k8s.io “px-ha-sc” created</p><br />
<br />
<p>$ kubectl get sc<br />
NAME                PROVISIONER                     AGE<br />
px-ha-sc            kubernetes.io/portworx-volume   10s<br />
stork-snapshot-sc   stork-snapshot                  3d</p><br />
<br />
<p>在Kubernetes上创建MySQL PVC</p><br />
<br />
<p>现在，我们可以在存储类的基础上创建PVC。幸好有动态配置，这些声明将在没有显式配置持久卷(PV)的情况下创建。</p><br />
<br />
<p>$ cat &gt; px-mysql-pvc.yaml « EOF<br />
kind: PersistentVolumeClaim<br />
apiVersion: v1<br />
metadata:<br />
   name: px-mysql-pvc<br />
   annotations:<br />
     volume.beta.kubernetes.io/storage-class: px-ha-sc<br />
spec:<br />
   accessModes:<br />
     - ReadWriteOnce<br />
   resources:<br />
     requests:<br />
       storage: 1Gi<br />
EOF</p><br />
<br />
<p>$ kubectl create -f px-mysql-pvc.yaml<br />
persistentvolumeclaim “px-mysql-pvc” created</p><br />
<br />
<p>$ kubectl get pvc<br />
NAME           STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE<br />
px-mysql-pvc   Bound     pvc-ebe875f5-99e8-11e8-9de8-42010aa00fdd   1Gi        RWO            px-ha-sc       6s</p><br />
<br />
<p>GKE上部署MySQL</p><br />
<br />
<p>最后，我们来创建MySQL实例来作为Kubernetes部署对象。简单起见，我们先只部署一个MySQL pod。因为Portworx为高可用性提供同步复制，所以单个MySQL实例可能是MySQL数据库的最佳部署选项。Portworx也为多节点MySQL集群提供备用盘卷，这个自由选择。</p><br />
<br />
<p>$ cat &gt; px-mysql-app.yaml « EOF<br />
apiVersion: extensions/v1beta1<br />
kind: Deployment<br />
metadata:<br />
  name: mysql<br />
spec:<br />
  strategy:<br />
    rollingUpdate:<br />
      maxSurge: 1<br />
      maxUnavailable: 1<br />
    type: RollingUpdate<br />
  replicas: 1<br />
  template:<br />
    metadata:<br />
      labels:<br />
        app: mysql<br />
    spec:<br />
      schedulerName: stork<br />
      containers:<br />
      - name: mysql<br />
        image: mysql:5.6<br />
        imagePullPolicy: “Always”<br />
        env:<br />
        - name: MYSQL_ROOT_PASSWORD<br />
          value: password<br />
        ports:<br />
        - containerPort: 3306<br />
        volumeMounts:<br />
        - mountPath: /var/lib/mysql<br />
          name: mysql-data<br />
      volumes:<br />
      - name: mysql-data<br />
        persistentVolumeClaim:<br />
          claimName: px-mysql-pvc<br />
EOF<br />
$ kubectl create -f px-mysql-app.yaml<br />
deployment.extensions “mysql” created</p><br />
<br />
<p>上面定义的MySQL部署显式地与前面步骤中创建的PVC相关联。</p><br />
<br />
<p>该部署创建一个单独的pod用来运行Portworx支持的MySQL。</p><br />
<br />
<p>$ kubectl get pods<br />
NAME                     READY     STATUS    RESTARTS   AGE<br />
mysql-dff54d66d-m9r6q   1/1       Running   0          6s</p><br />
<br />
<p>我们可以通过访问使用MySQL pod运行的pxctl工具来检查Portworx卷。</p><br />
<br />
<p>$ VOL=<code class="language-plaintext highlighter-rouge">kubectl get pvc | grep px-mysql-pvc | awk '{print $3}'</code><br />
$ PX_POD=$(kubectl get pods -l name=portworx -n kube-system -o jsonpath=’{.items[0].metadata.name}’)<br />
$ kubectl exec -it $PX_POD -n kube-system – /opt/pwx/bin/pxctl volume inspect ${VOL}<br />
Volume	:  549063659345266352<br />
	Name            	 :  pvc-ebe875f5-99e8-11e8-9de8-42010aa00fdd<br />
	Size            	 :  1.0 GiB<br />
	Format          	 :  xfs<br />
	HA              	 :  3<br />
	IO Priority     	 :  LOW<br />
	Creation time   	 :  Aug 7 02:23:50 UTC 2018<br />
	Shared          	 :  no<br />
	Status          	 :  up<br />
	State           	 :  Attached: gke-gke-px-default-pool-177a3f0b-st0n (10.240.0.3)<br />
	Device Path     	 :  /dev/pxd/pxd549063659345266352<br />
	Labels          	 :  namespace=default,pvc=px-mysql-pvc<br />
	Reads           	 :  77<br />
	Reads MS        	 :  64<br />
	Bytes Read      	 :  339968<br />
	Writes          	 :  481<br />
	Writes MS       	 :  10220<br />
	Bytes Written   	 :  166514688<br />
	IOs in progress 	 :  0<br />
	Bytes used      	 :  126 MiB<br />
	Replica sets on nodes:<br />
		Set 0<br />
		  Node 		 : 10.240.0.4 (Pool 0)<br />
		  Node 		 : 10.240.0.2 (Pool 0)<br />
		  Node 		 : 10.240.0.3 (Pool 0)<br />
	Replication Status	 :  Up<br />
	Volume consumers	 :<br />
		- Name           : mysql-8776f4ff-p7b22 (2b1c0719-99e9-11e8-9de8-42010aa00fdd) (Pod)<br />
		  Namespace      : default<br />
		  Running on     : gke-gke-px-default-pool-177a3f0b-st0n<br />
		  Controlled by  : mysql-8776f4ff (ReplicaSet)</p><br />
<br />
<p>上面命令的输出对创建的MySQL数据库实例的卷进行确认。</p><br />
<br />
<p>Kubernetes中MySQL pod执行失败</p><br />
<br />
<p>填充样本数据</p><br />
<br />
<p>接下来在数据库中填充样本数据。</p><br />
<br />
<p>我们将首先找到访问shell的MySQL pod。</p><br />
<br />
<p>$ POD=<code class="language-plaintext highlighter-rouge">kubectl get pods -l app=mysql | grep Running | grep 1/1 | awk '{print $1}'</code></p><br />
<br />
<p>$ kubectl exec -it $POD – mysql -uroot -ppassword<br />
Welcome to the MySQL monitor.  Commands end with ; or \g.<br />
Your MySQL connection id is 1<br />
Server version: 5.6.40 MySQL Community Server (GPL)</p><br />
<br />
<p>Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</p><br />
<br />
<p>Oracle is a registered trademark of Oracle Corporation and/or its<br />
affiliates. Other names may be trademarks of their respective<br />
owners.</p><br />
<br />
<p>Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</p><br />
<br />
<p>mysql&gt;</p><br />
<br />
<p>现在我们进入shell中，可以填充数据库和表了。</p><br />
<br />
<p>mysql&gt; CREATE DATABASE <code class="language-plaintext highlighter-rouge">classicmodels</code>;</p><br />
<br />
<p>mysql&gt; USE <code class="language-plaintext highlighter-rouge">classicmodels</code>;</p><br />
<br />
<p>mysql&gt; CREATE TABLE <code class="language-plaintext highlighter-rouge">offices</code> (<br />
  <code class="language-plaintext highlighter-rouge">officeCode</code> varchar(10) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">city</code> varchar(50) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">phone</code> varchar(50) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">addressLine1</code> varchar(50) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">addressLine2</code> varchar(50) DEFAULT NULL,<br />
  <code class="language-plaintext highlighter-rouge">state</code> varchar(50) DEFAULT NULL,<br />
  <code class="language-plaintext highlighter-rouge">country</code> varchar(50) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">postalCode</code> varchar(15) NOT NULL,<br />
  <code class="language-plaintext highlighter-rouge">territory</code> varchar(10) NOT NULL,<br />
  PRIMARY KEY (<code class="language-plaintext highlighter-rouge">officeCode</code>)<br />
) ENGINE=InnoDB DEFAULT CHARSET=latin1;</p><br />
<br />
<p>mysql&gt; insert  into <code class="language-plaintext highlighter-rouge">offices</code>(<code class="language-plaintext highlighter-rouge">officeCode</code>,<code class="language-plaintext highlighter-rouge">city</code>,<code class="language-plaintext highlighter-rouge">phone</code>,<code class="language-plaintext highlighter-rouge">addressLine1</code>,<code class="language-plaintext highlighter-rouge">addressLine2</code>,<code class="language-plaintext highlighter-rouge">state</code>,<code class="language-plaintext highlighter-rouge">country</code>,<code class="language-plaintext highlighter-rouge">postalCode</code>,<code class="language-plaintext highlighter-rouge">territory</code>) values<br />
(‘1’,’San Francisco’,’+1 650 219 4782’,’100 Market Street’,’Suite 300’,’CA’,’USA’,’94080’,’NA’),<br />
(‘2’,’Boston’,’+1 215 837 0825’,’1550 Court Place’,’Suite 102’,’MA’,’USA’,’02107’,’NA’),<br />
(‘3’,’NYC’,’+1 212 555 3000’,’523 East 53rd Street’,’apt. 5A’,’NY’,’USA’,’10022’,’NA’),<br />
(‘4’,’Paris’,’+33 14 723 4404’,’43 Rue Jouffroy D'abbans’,NULL,NULL,’France’,’75017’,’EMEA’),<br />
(‘5’,’Tokyo’,’+81 33 224 5000’,’4-1 Kioicho’,NULL,’Chiyoda-Ku’,’Japan’,’102-8578’,’Japan’),<br />
(‘6’,’Sydney’,’+61 2 9264 2451’,’5-11 Wentworth Avenue’,’Floor #2’,NULL,’Australia’,’NSW 2010’,’APAC’),<br />
(‘7’,’London’,’+44 20 7877 2041’,’25 Old Broad Street’,’Level 7’,NULL,’UK’,’EC2N 1HN’,’EMEA’);</p><br />
<br />
<p>现在执行一下查询语句：</p><br />
<br />
<p>mysql&gt; select <code class="language-plaintext highlighter-rouge">officeCode</code>,<code class="language-plaintext highlighter-rouge">city</code>,<code class="language-plaintext highlighter-rouge">phone</code>,<code class="language-plaintext highlighter-rouge">addressLine1</code>,<code class="language-plaintext highlighter-rouge">city</code> from <code class="language-plaintext highlighter-rouge">offices</code>;<br />
+————+—————+——————+————————–+—————+<br />
| officeCode | city          | phone            | addressLine1             | city          |<br />
+————+—————+——————+————————–+—————+<br />
| 1          | San Francisco | +1 650 219 4782  | 100 Market Street        | San Francisco |<br />
| 2          | Boston        | +1 215 837 0825  | 1550 Court Place         | Boston        |<br />
| 3          | NYC           | +1 212 555 3000  | 523 East 53rd Street     | NYC           |<br />
| 4          | Paris         | +33 14 723 4404  | 43 Rue Jouffroy D’abbans | Paris         |<br />
| 5          | Tokyo         | +81 33 224 5000  | 4-1 Kioicho              | Tokyo         |<br />
| 6          | Sydney        | +61 2 9264 2451  | 5-11 Wentworth Avenue    | Sydney        |<br />
| 7          | London        | +44 20 7877 2041 | 25 Old Broad Street      | London        |<br />
+————+—————+——————+————————–+—————+<br />
7 rows in set (0.01 sec)</p><br />
<br />
<p>例：查找USA中的所有办公室</p><br />
<br />
<p>mysql&gt; select <code class="language-plaintext highlighter-rouge">officeCode</code>, <code class="language-plaintext highlighter-rouge">city</code>, <code class="language-plaintext highlighter-rouge">phone</code>  from <code class="language-plaintext highlighter-rouge">offices</code> where <code class="language-plaintext highlighter-rouge">country</code> = “USA”;<br />
+————+—————+—————–+<br />
| officeCode | city          | phone           |<br />
+————+—————+—————–+<br />
| 1          | San Francisco | +1 650 219 4782 |<br />
| 2          | Boston        | +1 215 837 0825 |<br />
| 3          | NYC           | +1 212 555 3000 |<br />
+————+—————+—————–+<br />
3 rows in set (0.00 sec)</p><br />
<br />
<p>退出MySQL shell返回主机。</p><br />
<br />
<p>模拟节点故障</p><br />
<br />
<p>我们通过停止运行MySQL的节点调度来模拟节点故障。</p><br />
<br />
<p>$ NODE=<code class="language-plaintext highlighter-rouge">kubectl get pods -l app=mysql -o wide | grep -v NAME | awk '{print $7}'</code></p><br />
<br />
<p>$ kubectl cordon ${NODE}<br />
node “gke-gke-px-default-pool-177a3f0b-st0n” cordoned</p><br />
<br />
<p>上面的命令禁用了其中一个节点上的调度。</p><br />
<br />
<p>$ kubectl get nodes<br />
NAME                                            STATUS                     ROLES     AGE       VERSION<br />
gke-gke-px-default-pool-177a3f0b-nvxm   Ready                          9d        v1.8.10-gke.0<br />
gke-gke-px-default-pool-177a3f0b-slkb   Ready                          9d        v1.8.10-gke.0<br />
gke-gke-px-default-pool-177a3f0b-st0n   Ready,SchedulingDisabled       9d        v1.8.10-gke.0</p><br />
<br />
<p>现在继续，删除MySQL pod。</p><br />
<br />
<p>$ POD=<code class="language-plaintext highlighter-rouge">kubectl get pods -l app=mysql -o wide | grep -v NAME | awk '{print $1}'</code><br />
$ kubectl delete pod ${POD}<br />
pod “mysql-dff54d66d-m9r6q” deleted</p><br />
<br />
<p>一旦删除pod，它就被重新定位到具有复制数据的节点上。利用Kubernetes存储协调器(STORK)， Portworx的自定义存储调度程序允许在存储数据的确切节点上共同定位pod。它确保为调度pod选择了合适的节点。</p><br />
<br />
<p>让我们通过运行下面的命令来验证这一点。我们将注意到在不同的节点中创建并调度了一个新的pod。</p><br />
<br />
<p>$ kubectl get pods -l app=mysql -o wide<br />
NAME                     READY     STATUS    RESTARTS   AGE       IP               NODE<br />
mysql-dff54d66d-tzvjw   1/1       Running   0          15s       192.168.86.169   ip-192-168-95-234.us-west-2.compute.internal<br />
$ kubectl uncordon ${NODE}<br />
node “ip-192-168-203-81.us-west-2.compute.internal” uncordoned</p><br />
<br />
<p>最后，让我们验证数据是否仍然可用。</p><br />
<br />
<p>验证数据是否完整</p><br />
<br />
<p>接下来，找到pod名称并运行“exec”命令，然后访问MySQL shell。</p><br />
<br />
<p>kubectl exec -it $POD – mysql -uroot -ppassword<br />
Welcome to the MySQL monitor.  Commands end with ; or \g.<br />
Your MySQL connection id is 1<br />
Server version: 5.6.40 MySQL Community Server (GPL)</p><br />
<br />
<p>Copyright (c) 2000, 2018, Oracle and/or its affiliates. All rights reserved.</p><br />
<br />
<p>Oracle is a registered trademark of Oracle Corporation and/or its<br />
affiliates. Other names may be trademarks of their respective<br />
owners.</p><br />
<br />
<p>Type ‘help;’ or ‘\h’ for help. Type ‘\c’ to clear the current input statement.</p><br />
<br />
<p>mysql&gt;</p><br />
<br />
<p>查询数据库验证数据完整性。</p><br />
<br />
<p>mysql&gt; USE <code class="language-plaintext highlighter-rouge">classicmodels</code>;<br />
mysql&gt; select <code class="language-plaintext highlighter-rouge">officeCode</code>, <code class="language-plaintext highlighter-rouge">city</code>, <code class="language-plaintext highlighter-rouge">phone</code>  from <code class="language-plaintext highlighter-rouge">offices</code> where <code class="language-plaintext highlighter-rouge">country</code> = “USA”;<br />
+————+—————+—————–+<br />
| officeCode | city          | phone           |<br />
+————+—————+—————–+<br />
| 1          | San Francisco | +1 650 219 4782 |<br />
| 2          | Boston        | +1 215 837 0825 |<br />
| 3          | NYC           | +1 212 555 3000 |<br />
+————+—————+—————–+<br />
3 rows in set (0.00 sec)</p><br />
<br />
<p>注意，数据库表存在，所有内容都完整。从客户端shell退出，返回到主机。</p><br />
<br />
<p>在MySQL上执行存储操作</p><br />
<br />
<p>在测试数据库的端到端故障转移之后，我们接下来在GKE集群上执行存储操作</p><br />
<br />
<p>在不停机的情况下扩展Kubernetes卷<br />
目前我们最初创建的Portworx卷大小为1Gib。我们现在将把它扩大到两倍的存储容量。</p><br />
<br />
<p>首先，我们获取卷名并通过pxctl工具检查。</p><br />
<br />
<p>如果有访问权限，请SSH进入其中一个节点并运行以下命令。</p><br />
<br />
<p>$ POD=<code class="language-plaintext highlighter-rouge">/opt/pwx/bin/pxctl volume list --label pvc=px-mysql-pvc | grep -v ID | awk '{print $1}'</code><br />
$ /opt/pwx/bin/pxctl v i $POD<br />
Volume	:  150455926773027922<br />
	Name            	 :  pvc-3a6788df-9274-11e8-8c5e-0253036635a0<br />
	Size            	 :  1.0 GiB<br />
	Format          	 :  xfs<br />
	HA              	 :  3<br />
	IO Priority     	 :  LOW<br />
	Creation time   	 :  Jul 28 14:40:52 UTC 2018<br />
	Shared          	 :  no<br />
	Status          	 :  up<br />
	State           	 :  Attached: ip-192-168-95-234.us-west-2.compute.internal<br />
	Device Path     	 :  /dev/pxd/pxd150455926773027922<br />
	Labels          	 :  namespace=default,pvc=px-mysql-pvc<br />
	Reads           	 :  188<br />
	Reads MS        	 :  104<br />
	Bytes Read      	 :  8458240<br />
	Writes          	 :  23<br />
	Writes MS       	 :  128<br />
	Bytes Written   	 :  2347008<br />
	IOs in progress 	 :  0<br />
	Bytes used      	 :  126 MiB<br />
	Replica sets on nodes:<br />
		Set  0<br />
		  Node 		 :  192.168.95.234 (Pool 0)<br />
		  Node 		 :  192.168.203.81 (Pool 0)<br />
		  Node 		 :  192.168.185.157 (Pool 0)<br />
	Replication Status	 :  Up</p><br />
<br />
<p>注意当前的Portworx卷。它是1GiB。我们把它扩展到2GiB。</p><br />
<br />
<p>$ /opt/pwx/bin/pxctl volume update $POD –size=2<br />
Update Volume: Volume update successful for volume 150455926773027922<br />
检查新卷大小。</p><br />
<br />
<p>$ /opt/pwx/bin/pxctl v i $POD<br />
Volume	:  150455926773027922<br />
	Name            	 :  pvc-3a6788df-9274-11e8-8c5e-0253036635a0<br />
	Size            	 :  2.0 GiB<br />
	Format          	 :  xfs<br />
	HA              	 :  3<br />
	IO Priority     	 :  LOW<br />
	Creation time   	 :  Jul 28 14:40:52 UTC 2018<br />
	Shared          	 :  no<br />
	Status          	 :  up<br />
	State           	 :  Attached: ip-192-168-95-234.us-west-2.compute.internal<br />
	Device Path     	 :  /dev/pxd/pxd150455926773027922<br />
	Labels          	 :  namespace=default,pvc=px-mysql-pvc<br />
	Reads           	 :  200<br />
	Reads MS        	 :  104<br />
	Bytes Read      	 :  8507392<br />
	Writes          	 :  60<br />
	Writes MS       	 :  164<br />
	Bytes Written   	 :  2498560<br />
	IOs in progress 	 :  0<br />
	Bytes used      	 :  126 MiB<br />
	Replica sets on nodes:<br />
		Set  0<br />
		  Node 		 :  192.168.95.234 (Pool 0)<br />
		  Node 		 :  192.168.203.81 (Pool 0)<br />
		  Node 		 :  192.168.185.157 (Pool 0)<br />
	Replication Status	 :  Up</p><br />
<br />
<p>获取Kubernetes卷快照<br />
并恢复数据库</p><br />
<br />
<p>Portworx支持为Kubernetes PVC创建快照。</p><br />
<br />
<p>接下来我们为MySQL创建的Kubernetes PVC创建快照。</p><br />
<br />
<p>cat &gt;  px-mysql-snap.yaml « EOF<br />
apiVersion: volumesnapshot.external-storage.k8s.io/v1<br />
kind: VolumeSnapshot<br />
metadata:<br />
  name: px-mysql-snapshot<br />
  namespace: default<br />
spec:<br />
  persistentVolumeClaimName: px-mysql-pvc<br />
EOF<br />
$ kubectl create -f px-mysql-snap.yaml<br />
volumesnapshot.volumesnapshot.external-storage.k8s.io “px-mysql-snapshot” created</p><br />
<br />
<p>验证卷快照的创建。</p><br />
<br />
<p>$ kubectl get volumesnapshot<br />
NAME                AGE<br />
px-mysql-snapshot   30s<br />
$ kubectl get volumesnapshotdatas<br />
NAME                                                       AGE<br />
k8s-volume-snapshot-6ab731c7-9278-11e8-b018-e2f4b6cbb690   34s</p><br />
<br />
<p>快照就绪后，我们继续并删除数据库。</p><br />
<br />
<p>$ POD=<code class="language-plaintext highlighter-rouge">kubectl get pods -l app=mysql | grep Running | grep 1/1 | awk '{print $1}'</code><br />
$ kubectl exec -it $POD – mysql -uroot -ppassword<br />
drop database classicmodels;</p><br />
<br />
<p>由于快照和卷基本相同，我们可以使用它来启动MySQL的一个新实例。让我们通过恢复快照数据来创建一个MySQL的新实例。</p><br />
<br />
<p>$ cat &gt; px-mysql-snap-pvc « EOF<br />
apiVersion: v1<br />
kind: PersistentVolumeClaim<br />
metadata:<br />
  name: px-mysql-snap-clone<br />
  annotations:<br />
    snapshot.alpha.kubernetes.io/snapshot: px-mysql-snapshot<br />
spec:<br />
  accessModes:<br />
     - ReadWriteOnce<br />
  storageClassName: stork-snapshot-sc<br />
  resources:<br />
    requests:<br />
      storage: 2Gi<br />
EOF</p><br />
<br />
<p>$ kubectl create -f px-mysql-snap-pvc.yaml<br />
persistentvolumeclaim “px-mysql-snap-clone” created</p><br />
<br />
<p>从新的PVC创建MySQL pod。</p><br />
<br />
<p>$ cat &lt; px-mysql-snap-restore.yaml » EOF<br />
apiVersion: extensions/v1beta1<br />
kind: Deployment<br />
metadata:<br />
  name: mysql-snap<br />
spec:<br />
  strategy:<br />
    rollingUpdate:<br />
      maxSurge: 1<br />
      maxUnavailable: 1<br />
    type: RollingUpdate<br />
  replicas: 1<br />
  template:<br />
    metadata:<br />
      labels:<br />
        app: mysql-snap<br />
    spec:<br />
      affinity:<br />
        nodeAffinity:<br />
          requiredDuringSchedulingIgnoredDuringExecution:<br />
            nodeSelectorTerms:<br />
            - matchExpressions:<br />
              - key: px/running<br />
                operator: NotIn<br />
                values:<br />
                - “false”<br />
              - key: px/enabled<br />
                operator: NotIn<br />
                values:<br />
                - “false”<br />
    spec:<br />
      containers:<br />
      - name: mysql<br />
        image: mysql:5.6<br />
        imagePullPolicy: “Always”<br />
        env:<br />
        - name: MYSQL_ROOT_PASSWORD<br />
          value: password<br />
        ports:<br />
        - containerPort: 3306<br />
        volumeMounts:<br />
        - mountPath: /var/lib/mysql<br />
          name: mysql-data<br />
      volumes:<br />
      - name: mysql-data<br />
        persistentVolumeClaim:<br />
          claimName: px-mysql-snap-clone<br />
EOF<br />
$ kubectl create -f px-mysql-snap-restore.yaml<br />
deployment.extensions “mysql-snap” created</p><br />
<br />
<p>验证新pod是否处于运行状态。</p><br />
<br />
<p>$ kubectl get pods -l app=mysql-snap<br />
NAME                         READY     STATUS    RESTARTS   AGE<br />
mysql-snap-5ddd6b6848-bb6wx   1/1       Running   0          30s</p><br />
<br />
<p>最后，我们访问本实例前面创建的示例数据。</p><br />
<br />
<p>$ POD=<code class="language-plaintext highlighter-rouge">kubectl get pods -l app=mysql-snap | grep Running | grep 1/1 | awk '{print $1}'</code><br />
$ kubectl exec -it $POD – mysql -uroot -ppassword<br />
mysql&gt; USE <code class="language-plaintext highlighter-rouge">classicmodels</code>;<br />
mysql&gt; select <code class="language-plaintext highlighter-rouge">officeCode</code>, <code class="language-plaintext highlighter-rouge">city</code>, <code class="language-plaintext highlighter-rouge">phone</code>  from <code class="language-plaintext highlighter-rouge">offices</code> where <code class="language-plaintext highlighter-rouge">country</code> = “USA”;<br />
+————+—————+—————–+<br />
| officeCode | city          | phone           |<br />
+————+—————+—————–+<br />
| 1          | San Francisco | +1 650 219 4782 |<br />
| 2          | Boston        | +1 215 837 0825 |<br />
| 3          | NYC           | +1 212 555 3000 |<br />
+————+—————+—————–+<br />
3 rows in set (0.00 sec)</p><br />
<br />
<p>注意，集合仍然存在，数据仍然完整。如果希望在另一个区域创建灾难恢复备份，还可以将快照推送到Amazon S3。Portworx快照还可以与任何S3兼容的对象存储一起工作，因此可以备份到不同的云，或者可以备份到一个本地数据中心。</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category k8s
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>