<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">libiop</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2018-09-14T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Sep 14, 2018</time></p>
					</div>
					 <p>https://github.com/wangzhione/libiop<br />
一个c语言开发的跨平台网络IO库</p><br />
<br />
<p>功能特性：</p><br />
<br />
<p>1：c/c++ api, 底层支持epoll,select,poll等io模型</p><br />
<br />
<p>2：异步事件模型</p><br />
<br />
<p>3：任务池模型，跨平台线程接口</p><br />
<br />
<p>4：跨平台(Linux/windows)</p><br />
<br />
<p>5:日志服务</p><br />
<br />
<p>6：稳定，支持7*24小时无间断运行，自动处理异常状态</p><br />
<br />
<p>7：高并发与快速响应</p><br />
<br />
<p>8：API简洁， 学习成本底<br />
<!-- more --><br />
iop_def.h, 这里面定义了常用的数据结构</p><br />
<br />
<p>tag_iop_base_t 主要用于管理所有事件，每个事件是一个iop_t,</p><br />
<br />
<p>maxio表示最大的文件描述符，</p><br />
<br />
<p>free_list_head 表示可用的空闲列表头部id，一般用iops + free_list_head</p><br />
<br />
<p>取出iop_t 的元素</p><br />
<br />
<p>同理free_list_tail，最后一个可用iop,</p><br />
<br />
<p>iop_op_t 是封装了几个函数指针的结构体,</p><br />
<br />
<p>包括网络模型的名字，事件的添加，事件的删除，事件的更改，事件的派发</p><br />
<br />
<p>剩下的如注释所示</p><br />
<br />
<p>struct tag_iop_base_t<br />
{<br />
    iop_t <em>iops;        /</em>所有iop<em>/<br />
    int maxio;            /</em>最大并发io数,包括定时器在内<em>/<br />
    int maxbuf;            /</em>单个发送或接收缓存的最大值<em>/<br />
    int free_list_head;    /</em>可用iop列表<em>/<br />
    int free_list_tail; /</em>最后一个可用iop<em>/<br />
    int io_list_head;    /</em>已用io类型的iop列表<em>/<br />
    int timer_list_head;    /</em>已用timer类型的iop列表<em>/<br />
    int connect_list_head;  /</em>异步连接的iop列表<em>/<br />
    volatile int exit_flag;    /</em>退出标志*/</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int dispatch_interval;        /*高度的间隔时间*/<br />
iop_op_t op_imp;           /*事件模型的内部实现*/<br />
void *model_data;         /*事件模型特定的数据*/<br />
<br />
iop_time_t cur_time;        /*当前调度时间*/<br />
iop_time_t last_time;        /*上次调度时间*/<br />
iop_time_t last_keepalive_time; /*上次检查keepalive的时间*/<br />
<br />
_list_node_t * tcp_protocol_list_head;    /*use for advance tcp server model.*/ };<br />
</code></pre></div></div><br />
<br />
<p>看一下iop_t结构体，id是从0开始到n的数,这个是在tag_iop_base_t 中初始化队列时做的，</p><br />
<br />
<p>io_handle_t是这个结构存储的socket id, iop_type分三种0表示释放，1表示io读写，2表示</p><br />
<br />
<p>定时器事件， iop_event_cb表示事件回调函数指针，每一个iop_t绑定了不同的回调函数，</p><br />
<br />
<p>比如accept，比如read，比如write，但是这些回调函数要封装成iop_event_cb类型，</p><br />
<br />
<p>dbuf_t 是作者封装的一个管理发送和接受数据的结构</p><br />
<br />
<p>/*<br />
<em>tag_iop_t:iop结构，每一个iop对象都会对应一个tag_iop_t结构<br />
*/<br />
struct tag_iop_t<br />
{<br />
    int id;                    /</em>对应的id<em>/<br />
    io_handle_t handle;        /</em>关联的句柄<em>/<br />
    int iop_type;            /</em>对象类型：0：free,1:io,2:timer<em>/<br />
    int prev;                /</em>上一个对象<em>/<br />
    int next;                /</em>下一个对象<em>/<br />
    unsigned int events;                /</em>关注的事件<em>/<br />
    int timeout;            /</em>超时值<em>/<br />
    iop_event_cb evcb;        /</em>事件回调<em>/<br />
    void *arg;                /</em>用户指定的参数,由用户负责释放资源<em>/<br />
    void *sys_arg;            /</em>系统指定的参数，系统自动释放资源<em>/<br />
    /</em>以下字段对定时器无用<em>/<br />
    dbuf_t *sbuf;        /</em>发送缓存区<em>/<br />
    dbuf_t *rbuf;        /</em>接收缓存区<em>/<br />
    iop_time_t last_dispatch_time;    /</em>上次调度的时间*/<br />
};</p><br />
<br />
<p>iop_event_cb 定义如下</p><br />
<br />
<p>/<em>事件回调函数,返回-1代表要删除对象,返回0代表正常</em>/<br />
typedef int (*iop_event_cb)(iop_base_t *,int,unsigned int,void *);</p><br />
<br />
<p>dbuf_t结构如下</p><br />
<br />
<p>struct tag_dbuf<br />
{<br />
    unsigned int capacity;<br />
    unsigned int size;<br />
    void *data;<br />
};<br />
至于dbuf_t如何开辟空间释放空间，读写偏移的都不做赘述</p><br />
<br />
<p>iop_base_t中iop_op_t 结构很重要，是事件调度的核心</p><br />
<br />
<p>结构如下</p><br />
<br />
<p>struct tag_iop_op_t<br />
{<br />
    const char <em>name;                               //模型名称<br />
    void (</em>base_free)(iop_base_t <em>);        //资源释放的接口<br />
    int (</em>base_dispatch)(iop_base_t <em>, int);  //模型调度接口<br />
    //添加事件<br />
    int (</em>base_add)(iop_base_t <em>, int, io_handle_t, unsigned int);<br />
    //删除事件<br />
    int (</em>base_del)(iop_base_t <em>, int,io_handle_t);<br />
    //修改事件<br />
    int (</em>base_mod)(iop_base_t *, int, io_handle_t, unsigned int);<br />
};<br />
因为对应不同的平台，我们要应用不同的网络模型，比如epoll,select,iocp等等。</p><br />
<br />
<p>但是对于异步通信IO我们采取事件回调机制，也就是说提前绑定好读事件，写事件等，</p><br />
<br />
<p>在循环中调用base_dispatch函数指针，就可以实现对于不同模型的派发。</p><br />
<br />
<p>上面就是libiop模型的基本结构和框架</p><br />
<br />
<p>我们看下epoll模型的封装</p><br />
<br />
<p>tag_epoll_data 是封装的epoll基本结构，</p><br />
<br />
<p>这个结构存在iop_base_t的model_data里</p><br />
<br />
<p>struct tag_epoll_data {<br />
    struct epoll_event *events; //监听的epoll_events 队列<br />
    int nevents; //epoll_events 事件大小<br />
    int epfd; //epoll_create 产生的epoll表句柄<br />
};<br />
两个函数，iop_t应用层的读写宏</p><br />
<br />
<p>EV_TYPE_READ和<br />
EV_TYPE_WRITE<br />
epoll的读写宏<br />
EPOLLIN和EPOLLOUT互相转换<br />
static uint32_t to_epoll_events(uint32_t what)<br />
{<br />
    uint32_t events=0;<br />
    if(what &amp; EV_TYPE_READ)  <br /><br />
    {<br />
        events = EPOLLIN;<br />
    }<br />
    if(what &amp; EV_TYPE_WRITE)  <br /><br />
    {<br />
        events |= EPOLLOUT;<br />
    }<br />
    return events;<br />
}</p><br />
<br />
<p>static uint32_t from_epoll_events(uint32_t events)<br />
{<br />
    uint32_t what=0;<br />
    if(events &amp; (EPOLLHUP|EPOLLERR))<br />
    {<br />
        what = EV_TYPE_READ | EV_TYPE_WRITE;<br />
    }<br />
    else<br />
    {<br />
        if(events &amp; EPOLLIN){what |= EV_TYPE_READ;}<br />
        if(events &amp; EPOLLOUT){what |= EV_TYPE_WRITE;}<br />
    }<br />
    return what;          <br /><br />
}</p><br />
<br />
<p>初始化epoll结构和数据</p><br />
<br />
<p>int iop_init_epoll(void *iop_base, int maxev)<br />
{<br />
    iop_base_t *base = (iop_base_t *)iop_base;<br />
    //iop_base  事 件 操作结构体</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//iop_base_t中op_imp取出模型抽象的结构体<br />
iop_op_t *iop_op = &amp;(base-&gt;op_imp);<br />
//开辟epoll_data空间<br />
iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(malloc(sizeof(iop_epoll_data_t)));<br />
if(!iop_data)<br />
{<br />
    return -1;<br />
}<br />
//监听的队列大小为maxev<br />
iop_data-&gt;nevents = maxev;<br />
//为epll_data里监听事件队列开辟连续空间<br />
iop_data-&gt;events = (struct epoll_event *)(malloc(sizeof(struct epoll_event) * maxev));<br />
if(!iop_data)<br />
{<br />
    free(iop_data);<br />
    return -1;<br />
}<br />
<br />
//模型内部实现，不同模型不同的函数指针和名字<br />
iop_op-&gt;name = "epoll";<br />
iop_op-&gt;base_free = epoll_free;<br />
iop_op-&gt;base_dispatch = epoll_dispatch;<br />
iop_op-&gt;base_add = epoll_add;<br />
iop_op-&gt;base_del = epoll_del;<br />
iop_op-&gt;base_mod = epoll_mod;<br />
<br />
//1024 is not the max events limit.<br />
//创建epoll表句柄<br />
int epfd = epoll_create(1024);<br />
if(epfd &lt; 0)<br />
{<br />
    free(iop_data-&gt;events);<br />
    free(iop_data);<br />
    free(iop_op);<br />
    return -1;<br />
}<br />
iop_data-&gt;epfd = epfd;<br />
<br />
<br />
//iop_epoll_data_t类型的数据存在base的model_data里<br />
//方便回调<br />
base-&gt;model_data = iop_data;<br />
<br />
return 0; }<br />
</code></pre></div></div><br />
<br />
<p>对应的释放epoll开辟的空间和数据</p><br />
<br />
<p>//epoll 释放<br />
static void epoll_free(iop_base_t *base)<br />
{<br />
    //model_data里存放了epoll数据的指针<br />
    iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(base-&gt;model_data);<br />
    if(!iop_data){return;}<br />
    //释放events队列<br />
    if(iop_data-&gt;events)<br />
    {<br />
        free(iop_data-&gt;events);<br />
    }<br />
    //关闭iop_data-&gt;epfd<br />
    if(iop_data-&gt;epfd &gt;= 0)<br />
    {<br />
        close(iop_data-&gt;epfd);<br />
    }<br />
    free(iop_data);<br />
    base-&gt;model_data = (void *)0;<br />
}</p><br />
<br />
<p>epoll 添加事件</p><br />
<br />
<p>//epoll添加事件<br />
//base 为iop_base回传指针<br />
//id为iop的id<br />
//io_handle_t 为socket<br />
//events 为事件类型（EV_TYPE_READ或者EV_TYPE_WRITE）<br />
static int epoll_add(iop_base_t *base, int id, io_handle_t handle, unsigned int events)<br />
{<br />
    iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(base-&gt;model_data);<br />
    struct epoll_event ev;<br />
    ev.data.u32 = id; <br />
    //转换为EPOLLIN或者EPOLLOUT<br />
    ev.events = to_epoll_events(events);<br />
    //iop_set_nonblock(handle);<br />
    return epoll_ctl(iop_data-&gt;epfd, EPOLL_CTL_ADD, (int)handle, &amp;ev);              <br /><br />
}</p><br />
<br />
<p>epoll删除事件</p><br />
<br />
<p>//epoll删除事件<br />
//base 为iop_base回传指针<br />
//id为iop的id<br />
//io_handle_t 为socket<br />
static int epoll_del(iop_base_t *base, int id,io_handle_t handle)<br />
{<br />
    iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(base-&gt;model_data);<br />
    struct epoll_event ev;<br />
    ev.data.u32 = id;<br /><br />
    ev.events = 0;<br />
    //ev回传进去，删除epoll_events中socket为handle的注册事件<br />
    return epoll_ctl(iop_data-&gt;epfd, EPOLL_CTL_DEL, (int)handle, &amp;ev);              <br /><br />
}</p><br />
<br />
<p>epoll事件更改</p><br />
<br />
<p>//epoll 模式更改(读写更改)<br />
static int epoll_mod(iop_base_t *base, int id, io_handle_t handle, unsigned int events)<br />
{<br />
    iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(base-&gt;model_data);<br />
    struct epoll_event ev;<br />
    ev.data.u32 = id;<br /><br />
    ev.events = to_epoll_events(events);<br />
    return epoll_ctl(iop_data-&gt;epfd, EPOLL_CTL_MOD, (int)handle, &amp;ev);              <br /><br />
}</p><br />
<br />
<p>epoll事件派发</p><br />
<br />
<p>//epoll 事件派发<br />
static int epoll_dispatch(iop_base_t * base, int timeout)<br />
{<br />
    int i;<br />
    int id = 0;<br />
    iop_t *iop = NULL;<br />
    //iop_base中取出模型数据<br />
    iop_epoll_data_t *iop_data = (iop_epoll_data_t *)(base-&gt;model_data);<br />
    int n = 0;<br />
    do{<br />
        n = epoll_wait(iop_data-&gt;epfd, iop_data-&gt;events, iop_data-&gt;nevents, timeout);  <br /><br />
    }while((n &lt; 0) &amp;&amp; (errno == EINTR));<br />
    base-&gt;cur_time = time(NULL);<br />
    for(i = 0; i &lt; n; i++)<br />
    {<br />
        //取出iop的id<br />
        id = (int)((iop_data-&gt;events)[i].data.u32);<br />
        if(id &gt;= 0 &amp;&amp; id &lt; base-&gt;maxio)<br />
        {<br />
            iop = (base-&gt;iops)+id;<br />
            //这个宏是调用绑定在iop的事件回调函数（accept,read,write等）<br />
            IOP_CB(base,iop,from_epoll_events(iop_data-&gt;events[i].events));<br />
        }<br />
    }<br />
    return n;<br />
}<br />
以上就是libiop事件驱动的核心结构和设计，做个简单的总结，如果我们要设计一个多路复用的事件驱动</p><br />
<br />
<p>基本结构是这样的</p><br />
<br />
<p>//eventEle是应用层管理的最小单元</p><br />
<br />
<p>int (<em>WRAFuc  )(eventLoop</em> eventLoopP, int id, int mask, …);</p><br />
<br />
<p>//mask为应用层自己定义的读写标记</p><br />
<br />
<p>struct eventEle</p><br />
<br />
<p>{</p><br />
<br />
<p>int socket; //关联的socket</p><br />
<br />
<p>WRAFuc  mPfunc;  //读写接受等功能回调的函数</p><br />
<br />
<p>//读写缓冲区可自己封装</p><br />
<br />
<p>char  readBuf[];   //读缓冲区</p><br />
<br />
<p>char writeBuff[];  //写缓冲区</p><br />
<br />
<p>};</p><br />
<br />
<p>//事件轮询的基本结构</p><br />
<br />
<p>struct eventLoop</p><br />
<br />
<p>{</p><br />
<br />
<p>eventEle * eventList;</p><br />
<br />
<p>int maxfd;</p><br />
<br />
<p>int lastActiveTime;</p><br />
<br />
<p>iop_op_t op_imp;    /<em>事件模型的内部实现</em>/</p><br />
<br />
<p>void * model_data;  /<em>void 指针指向开辟的不同模型的数据</em>/</p><br />
<br />
<p>};</p><br />
<br />
<p>不同模型的操作进行封装成一个结构体，</p><br />
<br />
<p>结构体里面有添加，删除，更改，派发，释放的函数指针</p><br />
<br />
<p>struct tag_iop_op_t<br />
{<br />
const char <em>name; //模型名称<br />
void (</em>base_free)(iop_base_t <em>); //资源释放的接口<br />
int (</em>base_dispatch)(iop_base_t <em>, int); //模型调度接口<br />
//添加事件<br />
int (</em>base_add)(iop_base_t <em>, int, io_handle_t, unsigned int);<br />
//删除事件<br />
int (</em>base_del)(iop_base_t <em>, int,io_handle_t);<br />
//修改事件<br />
int (</em>base_mod)(iop_base_t *, int, io_handle_t, unsigned int);<br />
};<br />
这就是设计一个基本的事件驱动网络库的基本思路，</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category web
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>