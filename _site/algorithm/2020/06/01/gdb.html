<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">gdb</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-06-01T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jun 1, 2020</time></p>
					</div>
					 <p>https://www.cnblogs.com/sunsky303/p/12957078.html<br />
Golang程序调试工具介绍(gdb vs dlv)<br />
通过log库输出日志，我们可以对程序进行异常分析和问题追踪。但有时候，我也希望能有更直接的程序跟踪及定位工具能够帮助我们更方便快捷的追踪、定位问题，最直观的感觉还是使用调试器。Linux平台下，原生的C/C++程序，我们往往使用gdb进行程序调试，切换到Golang，我们同样还是可以使用gdb进行调试。同时我们还可以使用golang实现的调试器dlv进行调试。以下内容是我对gdb以及dlv使用及对比总结<br />
<!-- more --><br />
安装<br />
go get github.com/go-delve/delve/cmd/dlv<br />
准备工作<br />
为展示整个调试过程，准备了一个演示项目GoDbg,整个目录结构如下所示</p><br />
<br />
<p>[lday@alex GoDbg]$ tree<br />
.<br />
├── main.go<br />
└── mylib<br />
    └── dbgTest.go</p><br />
<br />
<p>其中，main.go为主函数入口，而dbgTest.go启动多个goroutine，用于演示调试操作。<br />
main.go:<br />
package main</p><br />
<br />
<p>import (<br />
“GoWorks/GoDbg/mylib”<br />
“fmt”<br />
“os”<br />
)</p><br />
<br />
<p>func main() {<br />
fmt.Println(“Golang dbg test…”)</p><br />
<br />
<p>var argc = len(os.Args)<br />
var argv = append([]string{}, os.Args…)</p><br />
<br />
<p>fmt.Printf(“argc:%d\n”, argc)<br />
fmt.Printf(“argv:%v\n”, argv)</p><br />
<br />
<p>var var1 = 1<br />
var var2 = “golang dbg test”<br />
var var3 = []int{1, 2, 3}<br />
var var4 mylib.MyStruct<br />
var4.A = 1<br />
var4.B = “golang dbg my struct field B”<br />
var4.C = map[int]string{1: “value1”, 2: “value2”, 3: “value3”}<br />
var4.D = []string{“D1”, “D2”, “D3”}</p><br />
<br />
<p>mylib.DBGTestRun(var1, var2, var3, var4)<br />
fmt.Println(“Golang dbg test over”)<br />
}</p><br />
<br />
<p>dbgTest.go:<br />
package mylib</p><br />
<br />
<p>import (<br />
“fmt”<br />
“sync”<br />
“time”<br />
)</p><br />
<br />
<p>type MyStruct struct {<br />
A int<br />
B string<br />
C map[int]string<br />
D []string<br />
}</p><br />
<br />
<p>func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) {<br />
fmt.Println(“DBGTestRun Begin!\n”)<br />
waiter := &amp;sync.WaitGroup{}</p><br />
<br />
<p>waiter.Add(1)<br />
go RunFunc1(var1, waiter)</p><br />
<br />
<p>waiter.Add(1)<br />
go RunFunc2(var2, waiter)</p><br />
<br />
<p>waiter.Add(1)<br />
go RunFunc3(&amp;var3, waiter)</p><br />
<br />
<p>waiter.Add(1)<br />
go RunFunc4(&amp;var4, waiter)</p><br />
<br />
<p>waiter.Wait()<br />
fmt.Println(“DBGTestRun Finished!\n”)<br />
}</p><br />
<br />
<p>func RunFunc1(variable int, waiter *sync.WaitGroup) {<br />
fmt.Printf(“var1:%v\n”, variable)<br />
for {<br />
if variable != 123456 {<br />
continue<br />
} else {<br />
break<br />
}<br />
}<br />
time.Sleep(10 * time.Second)<br />
waiter.Done()<br />
}</p><br />
<br />
<p>func RunFunc2(variable string, waiter *sync.WaitGroup) {<br />
fmt.Printf(“var2:%v\n”, variable)<br />
time.Sleep(10 * time.Second)<br />
waiter.Done()<br />
}</p><br />
<br />
<p>func RunFunc3(pVariable <em>[]int, waiter *sync.WaitGroup) {<br />
fmt.Printf(“</em>pVar3:%v\n”, *pVariable)<br />
time.Sleep(10 * time.Second)<br />
waiter.Done()<br />
}</p><br />
<br />
<p>func RunFunc4(pVariable <em>MyStruct, waiter *sync.WaitGroup) {<br />
fmt.Printf(“</em>pVar4:%v\n”, *pVariable)<br />
time.Sleep(10 * time.Second)<br />
waiter.Done()<br />
}</p><br />
<br />
<p>在对程序进行调试前，我们需要对目标程序进行调试版本程序的编译。C/C++程序，我们会通过gcc/g++进行编译、链接时加入-g3等参数，使得程序编译时带入调试信息，进而让调试器能够最终并解释相关的程序代码。同样的，在我们对Golang程序进行调试时，我们也需要加入相应的编译、链接选项：-gcflags=”-N -l”，生成程序调试信息（-N -l用于关闭编译器的内联优化）。编译GoDbg项目指令：go build -gcflags=”-N -l” GoWorks/GoDbg</p><br />
<br />
<p>gdb调试程序<br />
因为gdb对Golang的支持也是在不断完善中，为使用gdb调试Golang程序，建议将gdb升级到相对较新版本，目前，我使用的版本是gdb7.10。<br />
大多数命令在使用gdb调试C/C++时都会用到，详细说明可参考：Debugging Go Code with GDB，具体操作如下：</p><br />
<br />
<p>启动调试程序（gdb）</p><br />
<br />
<p>[lday@alex GoDbg]$ gdb ./GoDbg<br />
在main函数上设置断点（b）</p><br />
<br />
<p>(gdb) b main.main<br />
Breakpoint 1 at 0x401000: file /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go, line 9.<br />
带参数启动程序（r）</p><br />
<br />
<p>(gdb) r arg1 arg2<br />
Starting program: /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/GoDbg arg1 arg2<br />
[New LWP 8412]<br />
[New LWP 8413]<br />
[New LWP 8414]<br />
[New LWP 8415]</p><br />
<br />
<p>Breakpoint 1, main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
9    func main() {<br />
在文件dbgTest.go上通过行号设置断点（b）</p><br />
<br />
<p>(gdb) b dbgTest.go:16<br />
Breakpoint 3 at 0x457960: file /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go, line 16.<br />
查看断点设置情况（info b）</p><br />
<br />
<p>(gdb) info b<br />
Num     Type           Disp Enb Address            What<br />
1       breakpoint     keep y   0x0000000000401000 in main.main <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
    breakpoint already hit 1 time<br />
2       breakpoint     keep y   0x0000000000401000 in main.main <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
    breakpoint already hit 1 time<br />
3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16<br />
禁用断点（dis n）</p><br />
<br />
<p>(gdb) dis 1 <br /><br />
(gdb) info b<br />
Num     Type           Disp Enb Address            What<br />
1       breakpoint     keep n   0x0000000000401000 in main.main <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
    breakpoint already hit 1 time<br />
2       breakpoint     keep y   0x0000000000401000 in main.main <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
    breakpoint already hit 1 time<br />
3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16<br />
删除断点（del n）</p><br />
<br />
<p>(gdb) del 1<br />
(gdb) info b<br />
Num     Type           Disp Enb Address            What<br />
2       breakpoint     keep y   0x0000000000401000 in main.main <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:9<br />
    breakpoint already hit 1 time<br />
3       breakpoint     keep y   0x0000000000457960 in GoWorks/GoDbg/mylib.DBGTestRun <br />
                                                   at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16<br />
断点后继续执行（c）</p><br />
<br />
<p>(gdb) c<br />
Continuing.<br />
Golang dbg test…<br />
argc:3<br />
argv:[/home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/GoDbg arg1 arg2]</p><br />
<br />
<p>Breakpoint 3, GoWorks/GoDbg/mylib.DBGTestRun (var1=1, var2=”golang dbg test”)<br />
    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:16<br />
16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) {<br />
(gdb) <br />
显示代码（l）</p><br />
<br />
<p>(gdb) l<br />
11        B string<br />
12        C map[int]string<br />
13        D []string<br />
14    }<br />
15  <br /><br />
16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) {<br />
17        fmt.Println(“DBGTestRun Begin!\n”)<br />
18        waiter := &amp;sync.WaitGroup{}<br />
19  <br /><br />
20        waiter.Add(1)<br />
单步执行（n）</p><br />
<br />
<p>(gdb) n<br />
DBGTestRun Begin!</p><br />
<br />
<p>18        waiter := &amp;sync.WaitGroup{}<br />
打印变量信息（print/p）<br />
在进入DBGTestRun的地方设置断点(b dbgTest.go:16)，进入该函数后，通过p命令显示对应变量：</p><br />
<br />
<p>(gdb) l 17<br />
12        C map[int]string<br />
13        D []string<br />
14    }<br />
15  <br /><br />
16    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) {<br />
17        fmt.Println(“DBGTestRun Begin!\n”)<br />
18        waiter := &amp;sync.WaitGroup{}<br />
19  <br /><br />
20        waiter.Add(1)<br />
21        go RunFunc1(var1, waiter)<br />
(gdb) p var1 <br />
$3 = 1<br />
(gdb) p var2<br />
$4 = “golang dbg test”<br />
(gdb) p var3<br />
No symbol “var3” in current context.<br />
从上面的输出我们可以看到一个很奇怪的事情，虽然DBGTestRun有4个参数传入，但是，似乎var3和var4 gdb无法识别，在后续对dlv的实验操作中，我们发现，dlv能够识别var3， var4.</p><br />
<br />
<p>查看调用栈（bt），切换调用栈（f n），显示当前栈变量信息</p><br />
<br />
<p>(gdb) bt<br />
#0  GoWorks/GoDbg/mylib.DBGTestRun (var1=1, var2=”golang dbg test”)<br />
    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:17<br />
#1  0x00000000004018c2 in main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:27<br />
(gdb) f 1<br />
#1  0x00000000004018c2 in main.main () at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/main.go:27<br />
27        mylib.DBGTestRun(var1, var2, var3, var4)<br />
(gdb) l<br />
22        var4.A = 1<br />
23        var4.B = “golang dbg my struct field B”<br />
24        var4.C = map[int]string{1: “value1”, 2: “value2”, 3: “value3”}<br />
25        var4.D = []string{“D1”, “D2”, “D3”}<br />
26  <br /><br />
27        mylib.DBGTestRun(var1, var2, var3, var4)<br />
28        fmt.Println(“Golang dbg test over”)<br />
29    }<br />
(gdb) print var1 <br />
$5 = 1<br />
(gdb) print var2<br />
$6 = “golang dbg test”<br />
(gdb) print var3<br />
$7 =  []int = {1, 2, 3}</p><br />
<br />
<p>(gdb) print var4<br />
$8 = {A = 1, B = “golang dbg my struct field B”, C = map[int]string = {[1] = “value1”, [2] = “value2”, [3] = “value3”}, <br />
D =  []string = {“D1”, “D2”, “D3”}}<br />
显示goroutine列表（info goroutines）<br />
当程序执行到dbgTest.go:23时，程序通过go启动了第一个goroutine，并执行RunFunc1()，我们可以通过上述命令查看goroutine列表</p><br />
<br />
<p>(gdb) n<br />
23        waiter.Add(1)<br />
(gdb) info goroutines</p><br />
<ul><br />
  <li>1 running  runtime.systemstack_switch<br />
2 waiting  runtime.gopark<br />
17 waiting  runtime.gopark<br />
18 waiting  runtime.gopark<br />
19 runnable GoWorks/GoDbg/mylib.RunFunc1<br />
查看goroutine的具体情况（goroutine n cmd）</li><br />
</ul><br />
<br />
<p>(gdb) goroutine 19 bt<br />
#0  GoWorks/GoDbg/mylib.RunFunc1 (variable=1, waiter=0xc8200721f0)<br />
    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:36<br />
#1  0x0000000000456df1 in runtime.goexit () at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:1998<br />
#2  0x0000000000000001 in ?? ()<br />
#3  0x000000c8200721f0 in ?? ()<br />
#4  0x0000000000000000 in ?? ()<br />
我们可以通过上述指令查看goroutine 9的调用栈，显然，该goroutine正在执行dbgTest.go:36行的函数：RunFunc1的goroutine。我们通过goroutine 19 info args等命令来查看该goroutine最顶层调用栈的变量信息，但是，如果我们需要查看的信息不再最顶层调用栈上，则很遗憾，gdb没法输出</p><br />
<br />
<p>(gdb) goroutine 19 info args<br />
variable = 1<br />
waiter = 0xc8200721f0<br />
(gdb) goroutine 19 p waiter <br />
$1 = (struct sync.WaitGroup *) 0xc8200721f0</p><br />
<br />
<p>(gdb) goroutine 19 p *waiter <br />
$2 = {state1 = “\000\000\000\000\001\000\000\000\000\000\000”, sema = 0}<br />
当我们执行到第26行，第2个goroutine被我们启动时，再次查看goroutine列表：</p><br />
<br />
<p>(gdb) n<br />
26        waiter.Add(1)<br />
(gdb) info goroutines</p><br />
<ul><br />
  <li>1 running  runtime.systemstack_switch<br />
2 waiting  runtime.gopark<br />
17 waiting  runtime.gopark<br />
18 waiting  runtime.gopark</li><br />
  <li>19 running  syscall.Syscall<br />
20 runnable GoWorks/GoDbg/mylib.RunFunc2<br />
此时我们再次查看goroutine 19的状态</li><br />
</ul><br />
<br />
<p>(gdb) goroutine 19 bt<br />
#0  syscall.Syscall () at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/syscall/asm_linux_amd64.s:19<br />
#1  0x00000000004ab95f in syscall.write (fd=1, p= []uint8 = {…}, n=859530587568, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/syscall/zsyscall_linux_amd64.go:1064<br />
#2  0x00000000004ab40d in syscall.Write (fd=5131648, p= []uint8, n=0, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/syscall/syscall_unix.go:180<br />
#3  0x000000000046c928 in os.(<em>File).write (f=0xc820084008, b= []uint8, n=4571929, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/os/file_unix.go:255<br />
#4  0x000000000046aa24 in os.(</em>File).Write (f=0xc82008a000, b= []uint8 = {…}, n=7, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/os/file.go:144<br />
#5  0x000000000045c707 in fmt.Fprintf (w=…, format=”var1:%v\n”, a= []interface {} = {…}, n=7, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:190<br />
#6  0x000000000045c7b4 in fmt.Printf (format=”var1:%v\n”, a= []interface {} = {…}, n=7, err=…)<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:197<br />
#7  0x00000000004583eb in GoWorks/GoDbg/mylib.RunFunc1 (variable=1, waiter=0xc8200721f0)<br />
    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:37<br />
#8  0x0000000000456df1 in runtime.goexit () at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:1998<br />
#9  0x0000000000000001 in ?? ()<br />
#10 0x000000c8200721f0 in ?? ()<br />
#11 0x0000000000000000 in ?? ()<br />
从第7，8层调用栈我们可以看到，此时goroutine 19已经进入到RunFunc1的fmt.Printf函数中，当我们尝试在goroutine 19上切换栈时，gdb报错：</p><br />
<br />
<p>(gdb) goroutine 19 f 7<br />
#7  0x00000000004583eb in GoWorks/GoDbg/mylib.RunFunc1 (variable=1, waiter=0xc8200721f0)<br />
    at /home/lday/Works/Go_Works/GoLocalWorks/src/GoWorks/GoDbg/mylib/dbgTest.go:37<br />
37        fmt.Printf(“var1:%v\n”, variable)<br />
Python Exception &lt;class ‘gdb.error’&gt; Frame is invalid.: <br />
Error occurred in Python command: Frame is invalid.<br />
似乎gdb不允许我们在goroutine上做调用栈的切换，因此我们没法在这种状态下查看某层调用栈的变量信息。缺少在goroutine上不同frame的变量查看，个人感觉gdb调试Golang程序功能大打折扣，在后面对dlv的实验操作中我们可以看到，dlv可以！</p><br />
<br />
<p>dlv调试程序<br />
尝试了”老牌”调试器gdb，我们再来试试新进的Golang原生调试器delve(dlv)。</p><br />
<br />
<p>Delve is a debugger for the Go programming language. The goal of the project is to provide a simple, full featured debugging tool for Go</p><br />
<br />
<p>dlv是Golang实现的Golang调试器，目前dlv对windows平台的支持似乎不是很好，我在windows平台调试，dlv无法找到目标程序的源代码，因此建议在Linux平台下调试Golang程序时使用。使用dlv前，需在本地通过go get github.com/derekparker/delve/cmd/dlv进行安装。dlv的详细介绍可参见github上的delve介绍。以下是具体操作说明</p><br />
<br />
<p>带参数启动程序（dlv exec ./GoDbg – arg1 arg2）</p><br />
<br />
<p>[lday@alex GoDbg]$ dlv exec ./GoDbg – arg1 arg2 <br />
Type ‘help’ for list of commands.<br />
(dlv) <br />
在main函数上设置断点（b）</p><br />
<br />
<p>(dlv) b main.main<br />
Breakpoint 1 set at 0x40101b for main.main() ./main.go:9<br />
启动调试，断点后继续执行（c）</p><br />
<br />
<p>(dlv) c</p><br />
<blockquote><br />
  <p>main.main() ./main.go:9 (hits goroutine(1):1 total:1) (PC: 0x40101b)<br />
     4:        “GoWorks/GoDbg/mylib”<br />
     5:        “fmt”<br />
     6:        “os”<br />
     7:    )<br />
     8:  <br /><br />
=&gt;   9:    func main() {<br />
    10:        fmt.Println(“Golang dbg test…”)<br />
    11:  <br /><br />
    12:        var argc = len(os.Args)<br />
    13:        var argv = append([]string{}, os.Args…)<br />
    14:  <br /><br />
在文件dbgTest.go上通过行号设置断点（b）</p><br />
</blockquote><br />
<br />
<p>(dlv) b dbgTest.go:17<br />
Breakpoint 2 set at 0x457f51 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:17<br />
(dlv) b dbgTest.go:23<br />
Breakpoint 3 set at 0x4580d0 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:23<br />
(dlv) b dbgTest.go:26<br />
Breakpoint 4 set at 0x458123 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:26<br />
(dlv) b dbgTest.go:29<br />
Breakpoint 5 set at 0x458166 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:29<br />
显示所有断点列表（bp）</p><br />
<br />
<p>(dlv) bp<br />
Breakpoint unrecovered-panic at 0x429690 for runtime.startpanic() /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/panic.go:524 (0)<br />
Breakpoint 1 at 0x40101b for main.main() ./main.go:9 (1)<br />
Breakpoint 2 at 0x457f51 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:17 (0)<br />
Breakpoint 3 at 0x4580d0 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:23 (0)<br />
Breakpoint 4 at 0x458123 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:26 (0)<br />
Breakpoint 5 at 0x458166 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:29 (0)<br />
dlv似乎没有提供类似gdbdis x，禁止某个断点的功能，在文档中暂时没有查到。不过这个功能用处不大。</p><br />
<br />
<p>删除某个断点（clear x）</p><br />
<br />
<p>(dlv) clear 5<br />
Breakpoint 5 cleared at 0x458166 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:29<br />
(dlv) bp<br />
Breakpoint unrecovered-panic at 0x429690 for runtime.startpanic() /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/panic.go:524 (0)<br />
Breakpoint 1 at 0x40101b for main.main() ./main.go:9 (1)<br />
Breakpoint 2 at 0x457f51 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:17 (0)<br />
Breakpoint 3 at 0x4580d0 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:23 (0)<br />
Breakpoint 4 at 0x458123 for GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:26 (0)<br />
显示当前运行的代码位置（ls）</p><br />
<br />
<p>(dlv) ls</p><br />
<blockquote><br />
  <p>GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:17 (hits goroutine(1):1 total:1) (PC: 0x457f51)<br />
    12:        C map[int]string<br />
    13:        D []string<br />
    14:    }<br />
    15:  <br /><br />
    16:    func DBGTestRun(var1 int, var2 string, var3 []int, var4 MyStruct) {<br />
=&gt;  17:        fmt.Println(“DBGTestRun Begin!\n”)<br />
    18:        waiter := &amp;sync.WaitGroup{}<br />
    19:  <br /><br />
    20:        waiter.Add(1)<br />
    21:        go RunFunc1(var1, waiter)<br />
    22:  <br /><br />
查看当前调用栈信息（bt）</p><br />
</blockquote><br />
<br />
<p>(dlv) bt<br />
0  0x0000000000457f51 in GoWorks/GoDbg/mylib.DBGTestRun<br />
   at ./mylib/dbgTest.go:17<br />
1  0x0000000000401818 in main.main<br />
   at ./main.go:27<br />
2  0x000000000042aefb in runtime.main<br />
   at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/proc.go:188<br />
3  0x0000000000456df0 in runtime.goexit<br />
   at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:1998<br />
输出变量信息（print/p）</p><br />
<br />
<p>(dlv) print var1<br />
1<br />
(dlv) print var2<br />
“golang dbg test”<br />
(dlv) print var3<br />
[]int len: 3, cap: 3, [1,2,3]<br />
(dlv) print var4<br />
GoWorks/GoDbg/mylib.MyStruct {<br />
    A: 1,<br />
    B: “golang dbg my struct field B”,<br />
    C: map[int]string [<br />
        1: “value1”, <br />
        2: “value2”, <br />
        3: “value3”, <br />
    ],<br />
    D: []string len: 3, cap: 3, [“D1”,”D2”,”D3”],}<br />
类比gdb调试，我们看到，之前我们使用gdb进行调试时，发现gdb在此时无法输出var3, var4的内容，而dlv可以</p><br />
<br />
<p>在第n层调用栈上执行相应指令（frame n cmd）</p><br />
<br />
<p>(dlv) frame 1 ls<br />
    22:        var4.A = 1<br />
    23:        var4.B = “golang dbg my struct field B”<br />
    24:        var4.C = map[int]string{1: “value1”, 2: “value2”, 3: “value3”}<br />
    25:        var4.D = []string{“D1”, “D2”, “D3”}<br />
    26:  <br /><br />
=&gt;  27:        mylib.DBGTestRun(var1, var2, var3, var4)<br />
    28:        fmt.Println(“Golang dbg test over”)<br />
    29:    }<br />
frame 1 ls将显示程序在第1层调用栈上的具体实行位置</p><br />
<br />
<p>查看goroutine的信息（goroutines）<br />
当我们执行到dbgTest.go:26时，我们已经启动了两个goroutine</p><br />
<br />
<p>(dlv)</p><br />
<blockquote><br />
  <p>GoWorks/GoDbg/mylib.DBGTestRun() ./mylib/dbgTest.go:26 (hits goroutine(1):1 total:1) (PC: 0x458123)<br />
    21:        go RunFunc1(var1, waiter)<br />
    22:  <br /><br />
    23:        waiter.Add(1)<br />
    24:        go RunFunc2(var2, waiter)<br />
    25:  <br /><br />
=&gt;  26:        waiter.Add(1)<br />
    27:        go RunFunc3(&amp;var3, waiter)<br />
    28:  <br /><br />
    29:        waiter.Add(1)<br />
    30:        go RunFunc4(&amp;var4, waiter)<br />
    31:  <br /><br />
此时我们来查看程序的goroutine状态信息</p><br />
</blockquote><br />
<br />
<p>(dlv) goroutines<br />
[6 goroutines]</p><br />
<ul><br />
  <li>Goroutine 1 - User: ./mylib/dbgTest.go:26 GoWorks/GoDbg/mylib.DBGTestRun (0x458123) (thread 9022)<br />
Goroutine 2 - User: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/proc.go:263 runtime.gopark (0x42b2d3)<br />
Goroutine 3 - User: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/proc.go:263 runtime.gopark (0x42b2d3)<br />
Goroutine 4 - User: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/proc.go:263 runtime.gopark (0x42b2d3)<br />
Goroutine 5 - User: ./mylib/dbgTest.go:39 GoWorks/GoDbg/mylib.RunFunc1 (0x4583eb) (thread 9035)<br />
Goroutine 6 - User: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/format.go:130 fmt.(*fmt).padString (0x459545)<br />
从输出的信息来看，先启动的goroutine 5，执行RunFunc1，此时还没有执行fmt.Printf，而后启动的goroutine 6，执行RunFunc2，则已经进入到fmt.Printf的内部调用过程中了</li><br />
</ul><br />
<br />
<p>进一步查看goroutine信息（goroutine x）<br />
接第11步的操作，此时我想查看goroutine 6的具体执行情况，则执行goroutine 6</p><br />
<br />
<p>(dlv) goroutine 6<br />
Switched from 1 to 6 (thread 9022)<br />
在此基础上，执行bt，则可以看到当前goroutine的调用栈情况</p><br />
<br />
<p>(dlv) bt<br />
 0  0x0000000000454730 in runtime.systemstack_switch<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:245<br />
 1  0x000000000040f700 in runtime.mallocgc<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/malloc.go:643<br />
 2  0x000000000040fc43 in runtime.rawmem<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/malloc.go:809<br />
 3  0x000000000043c2a5 in runtime.growslice<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/slice.go:95<br />
 4  0x000000000043c015 in runtime.growslice_n<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/slice.go:44<br />
 5  0x0000000000459545 in fmt.(<em>fmt).padString<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/format.go:130<br />
 6  0x000000000045a13f in fmt.(</em>fmt).fmt_s<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/format.go:322<br />
 7  0x000000000045e905 in fmt.(<em>pp).fmtString<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:518<br />
 8  0x000000000046200f in fmt.(</em>pp).printArg<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:797<br />
 9  0x0000000000468a8d in fmt.(*pp).doPrintf<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:1238<br />
10  0x000000000045c654 in fmt.Fprintf<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:188<br />
此时输出了10层调用栈，但似乎最原始的我自身程序dbgTest.go的调用栈没有输出， 可以通过bt加depth参数，设定bt的输出深度，进而找到我们自己的调用栈，例如bt 13</p><br />
<br />
<p>(dlv) bt 13<br />
…<br />
10  0x000000000045c654 in fmt.Fprintf<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:188<br />
11  0x000000000045c74b in fmt.Printf<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/print.go:197<br />
12  0x000000000045846f in GoWorks/GoDbg/mylib.RunFunc2<br />
    at ./mylib/dbgTest.go:50<br />
13  0x0000000000456df0 in runtime.goexit<br />
    at /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:1998<br />
我们看到，我们自己dbgTest.go的调用栈在第12层。当前goroutine已经不再我们自己的调用栈上，而是进入到系统函数的调用中，在这种情况下，使用gdb进行调试时，我们发现，此时我们没有很好的方法能够输出我们需要的调用栈变量信息。dlv可以!此时只需简单的通过frame x cmd就可以输出我们想要的调用栈信息了</p><br />
<br />
<p>(dlv) frame 12 ls<br />
    45:        time.Sleep(10 * time.Second)<br />
    46:        waiter.Done()<br />
    47:    }<br />
    48:  <br /><br />
    49:    func RunFunc2(variable string, waiter *sync.WaitGroup) {<br />
=&gt;  50:        fmt.Printf(“var2:%v\n”, variable)<br />
    51:        time.Sleep(10 * time.Second)<br />
    52:        waiter.Done()<br />
    53:    }<br />
    54:  <br /><br />
    55:    func RunFunc3(pVariable *[]int, waiter *sync.WaitGroup) {<br />
(dlv) frame 12 print variable <br />
“golang dbg test”<br />
(dlv) frame 12 print waiter<br />
*sync.WaitGroup {<br />
    state1: [12]uint8 [0,0,0,0,2,0,0,0,0,0,0,0],<br />
    sema: 0,}<br />
多好的功能啊！</p><br />
<br />
<p>查看当前是在哪个goroutine上（goroutine）<br />
当使用goroutine不带参数时，dlv就会显示当前goroutine信息，这可以帮助我们在调试时确认是否需要做goroutine切换</p><br />
<br />
<p>(dlv) goroutine<br />
Thread 9022 at ./mylib/dbgTest.go:26<br />
Goroutine 6:<br />
    Runtime: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/runtime/asm_amd64.s:245 runtime.systemstack_switch (0x454730)<br />
    User: /home/lday/Tools/Dev_Tools/Go_Tools/go_1_6_2/src/fmt/format.go:130 fmt.(*fmt).padString (0x459545)<br />
    Go: ./mylib/dbgTest.go:26 GoWorks/GoDbg/mylib.DBGTestRun (0x458123)<br />
dlv前端(gdlv)<br />
dlv提供了类似gdb的cli调试系统，而有第三方还提供了dlv的GUI前端(gdlv)，对于那些习惯了使用GUI进行调试的人来说，结合gdlv和dlv，调试会更加方便。gdlv有个问题是：他无法在xwindows server上运行，只能在server本地运行。</p><br />
<br />
<p>结论<br />
综合比较两个Golang程序调试器gdb和dlv，我认为dlv的功能更为完善，更能满足实际调试时的功能需求。两者的优缺点比较大致如下</p><br />
<br />
<p>调试器	优势	不足<br />
dlv	对goroutine, go类型调试支持比较完善	只支持 go, 不支持调试某些Go内部底部数据<br />
gdb	符合现有的调试习惯，类似C/C++调试指令都有	对goroutine场景支持不足，不能很好的应对goroutine的调试<br />
参考<br />
https://github.com/go-delve/delve/tree/master/Documentation</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category algorithm
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>