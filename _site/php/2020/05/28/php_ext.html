<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">php7 基础上编译扩展，hack文件操作</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-05-28T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 28, 2020</time></p>
					</div>
					 <p>https://www.laruence.com/2009/04/28/719.html</p><br />
<br />
<p>函数声明宏	语义<br />
PHP_MINIT_FUNCTION()	当PHP被装载时，模块启动函数即被引擎调用。这使得引擎做一些例如资源类型，注册INI变量等的一次初始化。<br />
PHP_MSHUTDOWN_FUNCTION()	当PHP完全关闭时，模块关闭函数即被引擎调用。通常用于注销INI条目<br />
PHP_RINIT_FUNCTION()	在每次PHP请求开始，请求前启动函数被调用。通常用于管理请求前逻辑。<br />
PHP_RSHUTDOWN_FUNCTION()	在每次PHP请求结束后，请求前关闭函数被调用。经常应用在清理请求前启动函数的逻辑。<br />
PHP_MINFO_FUNCTION()	调用phpinfo()时模块信息函数被呼叫，从而打印出模块信息。<br />
<!-- more --></p><br />
<br />
<p>PHP框架提供了称作VCWD （virtual current working directory 虚拟当前工作目录）宏，用来代替任何依赖当前工作目录的存取函数。这些宏与被替代的函数具备同样的功能，同时是被透明地处理。在某些没有标准C函数库平台的情况下，VCWD框架则不会得到支持。例如，Win32下不存在chown()，就不会有相应的VCWD_CHOWN()宏被定义。</p><br />
<br />
<p>INI文件(php.ini)的实现使得PHP扩展注册和监听各自的INI条目。如果这些INI条目由php.ini、Apache的htaccess或其他配置方法来赋值，注册的INI变量总是更新到正确的值。整个INI框架有许多不同的选项以实现其灵活性。我们涉及一些基本的（也是个好的开端），借助本章的其他材料，我们就能够应付日常开发工作的需要。<br />
通过在PHP_INI_BEGIN()/PHP_INI_END()宏之间的STD_PHP_INI_ENTRY()宏注册PHP INI指令。</p><br />
<br />
<p>PECL_Gen(http://pear.php.net/package/PECL_Gen)，这个工具正在开发之中，比起本章使用的ext_skel有更多的特性。</p><br />
<br />
<p>https://www.jianshu.com/p/ad5afec527f0</p><br />
<br />
<p>php-src/ext/myFile/myFile.c:37:25: error: unknown type name<br />
      ‘zend_rsrc_list_entry’<br />
zend_rsrc_list_entry =&gt; zend_resource</p><br />
<br />
<p>参数类型是zend_resource。这是 PHP7 新增的数据结构，在 PHP 5 则是zend_rsrc_list_entry。</p><br />
<br />
<p>ZEND_REGISTER_RESOURCE(rsrc_result, rsrc_pointer, rsrc_type);<br />
在 PHP 7 中删除了原来的ZEND_REGISTER_RESOURCE宏，直接使用zend_register_resource函数</p><br />
<br />
<p>ZEND_API zend_resource<em> zend_register_resource(void</em>rsrc_pointer,intrsrc_type)</p><br />
<br />
<p>新写法     RETURN_RES(zend_register_resource(rsrc_pointer, rsrc_type));</p><br />
<br />
<p>ZEND_API int zend_register_list_destructors_ex(rsrc_dtor_func_t ld, rsrc_dtor_func_t pld,constchar*type_name,intmodule_number)</p><br />
<br />
<p>error: use of undeclared identifier<br />
      ‘rsrc_pointer’<br />
    RETURN_RES(zend_register_resource(rsrc_pointer, rsrc_type));</p><br />
<br />
<p>RETURN_RES(zend_register_resource(fp, le_myfile));</p><br />
<br />
<p>php-src/ext/myFile/myFile.c:100:43: error: use of undeclared identifier<br />
      ‘le_myfile’; did you mean ‘le_myFile’?<br />
    RETURN_RES(zend_register_resource(fp, le_myfile));<br />
                                          ^~~~~~~~~<br />
                                          le_myFile</p><br />
<br />
<p>写错了，看生成的代码<br />
 /* True global resources - no need for thread safety here */<br />
static int le_myFile;</p><br />
<br />
<p>ext/myFile/myFile.c:150:29: error: unexpected type name ‘FILE’:<br />
      expected expression<br />
    ZEND_FETCH_RESOURCE(fp, FILE *, &amp;filehandle, -1, “standard-cfile”, le_myFile);</p><br />
<br />
<p>ZEND_APIvoid<em>zend_fetch_resource(zend_resource </em>res,constchar*resource_type_name,intresource_type)</p><br />
<br />
<p>在 PHP 7 中删除了原有的ZEND_FETCH_RESOURCE宏，直接使用函数zend_fetch_resource，而且解析方式也变得简单了很多，想比 PHP 5 要高效很多</p><br />
<br />
<p>php-src/ext/myFile/myFile.c:154:28: error: too many arguments provided to<br />
      function-like macro invocation<br />
     RETURN_STRING(result, 0);<br />
                           ^<br />
     //RETURN_STRING(result, 0);<br />
     RETURN_STRING(result);</p><br />
<br />
<p>php-src/ext/myFile/myFile.c:150:60: error: too many arguments to function<br />
      call, expected 3, have 4<br />
    zend_fetch_resource(&amp;filehandle, -1, “standard-cfile”, le_myFile);</p><br />
<br />
<p>zend_fetch_resource(&amp;filehandle, -1, “standard-cfile”, le_myFile);<br />
zend_fetch_resource(&amp;filehandle, “standard-cfile”, le_myFile);</p><br />
<br />
<p>Build complete.<br />
Don’t forget to run ‘make test’.</p><br />
<br />
<p>$php testmyFile.php<br />
Segmentation fault: 11</p><br />
<br />
<p>/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:120:27: warning: implicit declaration of<br />
      function ‘Z_RESVAL_P’ is invalid in C99 [-Wimplicit-function-declaration]<br />
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {<br />
                          ^<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:120:27: warning: incompatible integer to<br />
      pointer conversion passing ‘int’ to parameter of type ‘zend_resource *’<br />
      (aka ‘struct _zend_resource *’) [-Wint-conversion]<br />
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {<br />
                          ^~~~~~~~~~~~~~~~~~~~~~<br />
/usr/local/include/php/Zend/zend_list.h:59:46: note: passing argument to parameter ‘res’ here<br />
ZEND_API int zend_list_delete(zend_resource *res);<br />
                                             ^<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150:25: warning: incompatible pointer types<br />
      passing ‘zval **’ (aka ‘struct _zval_struct **’) to parameter of type ‘zend_resource *’<br />
      (aka ‘struct _zend_resource *’) [-Wincompatible-pointer-types]<br />
    zend_fetch_resource(&amp;filehandle,”standard-cfile”, le_myFile);<br />
                        ^~~~~~~~~~~<br />
/usr/local/include/php/Zend/zend_list.h:63:51: note: passing argument to parameter ‘res’ here<br />
ZEND_API void *zend_fetch_resource(zend_resource *res, const char *resource_type_name, int resour…<br />
                                                  ^<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:181:23: warning: incompatible pointer types<br />
      passing ‘zval **’ (aka ‘struct _zval_struct **’) to parameter of type ‘zend_resource *’<br />
      (aka ‘struct _zend_resource *’) [-Wincompatible-pointer-types]<br />
                zend_fetch_resource(&amp;filehandle,”standard-cfile”, le_myFile);<br />
                                    ^~~~~~~~~~~<br />
/usr/local/include/php/Zend/zend_list.h:63:51: note: passing argument to parameter ‘res’ here<br />
ZEND_API void *zend_fetch_resource(zend_resource *res, const char *resource_type_name, int resour…<br />
                                                  ^<br />
4 warnings generated.</p><br />
<br />
<p>一步步测试<br />
$fp_in = file_open(“test.txt”, “r”) or die(“Unable to open input file\n”);<br />
$fp_out = file_open(“test.txt.new”, “w”) or die(“Unable to open output file\n”);<br />
var_dump(file_eof($fp_in));<br />
var_dump(file_read($fp_in, 1024));</p><br />
<br />
<p>发现file_read 报错了</p><br />
<br />
<p>写php扩展时最后返回值不管是RETURN_STRING(str10,1);还是RETURN_STRING(str10,0);总是显示Segmentation fault (core dumped)错误。</p><br />
<br />
<p>str10=(char <em>)malloc((strlen(str9)+1)</em>sizeof(char));</p><br />
<br />
<p>是哪个地方出错了吗？</p><br />
<br />
<p>不写RETURN_STRING只用下面就没Segmentation fault了<br />
printf(“%s\n”,str10);free(str10);str10=NULL;</p><br />
<br />
<p>如果我直接使用类似如下的代码，就会出segfault错误</p><br />
<br />
<p>char* ret = “hello world”;<br />
RETURN_STRINGL(ret, strlen(ret), 0);<br />
无论ret是直接写字符串，还是先初始化成char[100]这样，都不行<br />
但是只要将程序稍加改进使用动态分配内存就没事：</p><br />
<br />
<p>char* hello = “hello world”;<br />
int   len = strlen(hello);<br />
char* ret = (char*)emalloc(len);<br />
memcpy(ret, hello, len);<br />
RETURN_STRINGL(ret, len, 0);<br />
补充一句：后来发现RETURN_STRINGL的第三个参数改成1也不会有越界访问错误了</p><br />
<br />
<p>php本身是类型安全的脚本语言，对于RETURN_STRINGL或是RETURN_STRING返回的字符串，php会在适当的时候free掉，所以程序员要保证返回的字符串在堆里，能够free掉，这就是为什么动态分配就没事的原因。而：</p><br />
<br />
<p>char* ret = “hello world”;<br />
RETURN_STRINGL(ret, strlen(ret), 0);<br />
这是直接返回了一个静态字符串，导致php在free这个字符串的时候出错。<br />
RETURN_STRINGL和RETURN_STRING最后一个参数，如果是1，表示对第一个参数中的字符串在堆里复制一份返回。这就是为什么最后一个参数等于1的时候，程序正常的原因。</p><br />
<br />
<p>//RETURN_STRING(result, 0);<br />
 RETURN_STRING(result，bytes_read＋1，1);</p><br />
<br />
<p>27error::  errortoo : many argumentstoo  providedmany  toarguments<br />
       providedfunction-like  tomacro<br />
       function-likeinvocation macro<br />
 invocation<br />
     RETURN_STRING(result,bytes_read+1,1);<br />
     RETURN_STRING(result,bytes_read+1,1);</p><br />
<br />
<p>/php-src/ext/myFile/myFile.c7::157 :7:error : error: use ofuse  undeclaredof  identifierundeclared<br />
       identifier’RETURN_STRING’</p><br />
<br />
<p>‘RETURN_STRING’<br />
             RETURN_STRING(result,0);<br />
             ^<br />
             RETURN_STRING(result,0);</p><br />
<br />
<p>RETURN_STRING(result);</p><br />
<br />
<p>make clean <br />
 make</p><br />
<br />
<p>var_dump(file_eof($fp_in));  //这一行注释掉就没有问题了<br />
var_dump(file_read($fp_in, 1024));</p><br />
<br />
<p>Warning: file_read(): supplied resource is not a valid standard-cfile resource in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 5</p><br />
<br />
<p>https://github.com/zhoumengkang/notes/blob/master/php-extension/php7.0/tipi_file/tipi_file.c</p><br />
<br />
<p>仔细看代码发现，一个FILE＊指针没有初始化，干掉，问题解决</p><br />
<br />
<p>ln: myFile.la: File exists<br />
make: *** [myFile.la] Error 1</p><br />
<br />
<p>$rm myFile.la</p><br />
<br />
<p>$make clean &amp; make &amp; make install</p><br />
<br />
<p>$php testmyFile.php<br />
bool(true)<br />
string(16) “13456576<br />
dfghjk<br />
“<br />
[Thu May 28 12:54:56 2020]  Script:  ‘/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php’<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(153) :  Freeing 0x000000010e26c000 (1025 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php<br />
=== Total 1 memory leaks detected ===</p><br />
<br />
<p>$php testmyFile.php<br />
dyld: lazy symbol binding failed: Symbol not found: _Z_RESVAL_P<br />
  Referenced from: /usr/local/lib/php/extensions/debug-non-zts-20160303/myFile.so<br />
  Expected in: flat namespace</p><br />
<br />
<p>dyld: Symbol not found: _Z_RESVAL_P<br />
  Referenced from: /usr/local/lib/php/extensions/debug-non-zts-20160303/myFile.so<br />
  Expected in: flat namespace</p><br />
<br />
<p>Trace/BPT trap: 5</p><br />
<br />
<p>报这个错的原因是:路径所指向的文件不对;或者路径下没有这个文件</p><br />
<br />
<p>https://blog.csdn.net/moqiluoji/article/details/79792671</p><br />
<br />
<p>替换<br />
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {<br />
          RETURN_FALSE;<br />
     }</p><br />
<br />
<p>为</p><br />
<br />
<p>zend_list_close(Z_RES_P(filehandle));</p><br />
<br />
<p>testbool(true)<br />
string(16) “13456576<br />
dfghjk<br />
“<br />
PHP Fatal error:  Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p><br />
<br />
<p>Fatal error: Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p><br />
<br />
<p>把  RETURN_STRING(result);<br />
替换为  RETURN_STRINGL(result,0);<br />
如果是1，表示对第一个参数中的字符串在堆里复制一份返回。这就是为什么最后一个参数等于1的时候，程序正常的原因。</p><br />
<br />
<p>https://www.cnblogs.com/zjoch/p/5260883.html</p><br />
<br />
<p>$php testmyFile.php<br />
testbool(true)<br />
string(0) “”<br />
PHP Fatal error:  Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p><br />
<br />
<p>替换<br />
RETURN_STRINGL(result,0);<br />
 RETURN_STRINGL(result,bytes_read);</p><br />
<br />
<p>https://my.oschina.net/kear/blog/85257</p><br />
<br />
<p>如果我们在一次请求的生命周期中通过emalloc分配了内存，但是没有释放，那么在PHP整个生命周期是不会造成内存泄漏的。因为在请求结束的时候，PHP会自动帮我们释放掉这些内存。但是，在一次请求中，如果一直不自己释放内存，那么这次请求很可能会内存不够，导致PHP进程挂掉。</p><br />
<br />
<p>https://zhuanlan.zhihu.com/p/83815759<br />
 https://www.cnblogs.com/farwish/p/5663993.html</p><br />
<br />
<p>char *dest = (char *)emalloc(1024);</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strcat(dest, src1);<br />
strcat(dest, ori);<br />
strcat(dest, src2);<br />
<br />
RETURN_STRING(dest, 0);<br />
</code></pre></div></div><br />
<br />
<p>显然 dest 是长期占用内存的，但你如何在返回值之后，还能再把它销毁呢，恐怕无法做到。</p><br />
<br />
<p>这里就要引入一个概念，当你的函数没有返回值时，函数默认返回的变量是 zval *return_value，也就是你用它就不会有问题。</p><br />
<br />
<p>feof(fp) 0表示未结束，非0表示结束<br />
if (feof(fp) &lt;= 0) {<br />
RETURN_TRUE;<br />
}<br />
这段脚本有误吧。当feof得到0时，返回TURE，下面while循环是不执行的。<br />
while (!file_eof($fp_in))</p><br />
<br />
<p>feof是C语言标准库函数，其原型在stdio.h中，其功能是检测流上的文件结束符，如果文件结束，则返回非0值，否则返回0（即，文件结束：返回非0值；文件未结束：返回0值）。</p><br />
<br />
<p>[Thu May 28 13:51:36 2020]  Script:  ‘/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php’<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(150) :  Freeing 0x000000010ec66000 (513 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php<br />
=== Total 1 memory leaks detected ===</p><br />
<br />
<p>整个问题解决</p><br />
<br />
<p>定义了全局变量需要把生成的.h文件里<br />
ZEND_BEGIN_MODULE_GLOBALS(myFile)<br />
	zend_long  global_value;<br />
	char *global_string;<br />
ZEND_END_MODULE_GLOBALS(myFile)<br />
注释去掉</p><br />
<br />
<p>同时需要把 .c文件里的注释也去掉<br />
/* If you declare any globals in php_myFile.h uncomment this:<br />
ZEND_DECLARE_MODULE_GLOBALS(myFile)<br />
*/</p><br />
<br />
<p>你也许希望在每次PHP请求的开始初始化全局变量。另外，做为一个例子，全局变量已指向了一个已分配的内存，在每次PHP请求结束时需要释放内存。为了达到这些目的，全局变量机制提供了一个特殊的宏，用于注册全局变量的构造和析构函数（参考表对宏参数的说明）：</p><br />
<br />
<p>ZEND_INIT_MODULE_GLOBALS(module_name, globals_ctor, globals_dtor)</p><br />
<br />
<p>添加自定义INI指令<br />
通过在PHP_INI_BEGIN()/PHP_INI_END()宏之间的STD_PHP_INI_ENTRY()宏注册PHP INI指令。</p><br />
<br />
<p>为了使自定义INI条目机制正常工作，你需要分别去掉PHP_MINIT_FUNCTION(myfile)中的REGISTER_INI_ENTRIES()调用和PHP_MSHUTDOWN_FUNCTION(myfile)中的UNREGISTER_INI_ENTRIES()的注释。<br />
访问两个示例全局变量中的一个与在扩展里编写MYFILE_G(global_value) 和MYFILE_G(global_string)一样简单。<br />
如果你把下面的两行放在php.ini中，MYFILE_G(global_value)的值会变为99。</p><br />
<br />
<p>; php.ini – The following line sets the INI entry myFile.global_value to 99.<br />
myFile.global_value = 99</p><br />
<br />
<p>void myfunc(){<br />
     TSRMLS_FETCH();<br />
     MYFILE_G(myglobal) = 2;<br />
}</p><br />
<br />
<p>最后，为了使自定义INI条目机制正常工作，你需要分别去掉PHP_MINIT_FUNCTION(myfile)中的REGISTER_INI_ENTRIES()调用和PHP_MSHUTDOWN_FUNCTION(myfile)中的UNREGISTER_INI_ENTRIES()的注释。<br />
访问两个示例全局变量中的一个与在扩展里编写MYFILE_G(global_value) 和MYFILE_G(global_string)一样简单。<br />
如果你把下面的两行放在php.ini中，MYFILE_G(global_value)的值会变为99。</p><br />
<br />
<p>$php testmyFile.php<br />
testbool(false)<br />
xiazemin:99	13456576<br />
dfghjk<br />
get result:xiazemin:99	13456576<br />
dfghjk<br />
[Thu May 28 14:29:19 2020]  Script:  ‘/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php’<br />
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(161) :  Freeing 0x000000010da04c80 (28 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php<br />
=== Total 1 memory leaks detected ===</p><br />
<br />
<p>完美解决</p><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category php
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>