<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">composer autoload</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-08-19T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Aug 19, 2020</time></p>
					</div>
					 <p>$composer global require xxx<br />
Changed current directory to /Users/didi/.composer<br />
You are running Composer with SSL/TLS protection disabled.<br />
./composer.json is not readable.</p><br />
<br />
<p>$ cat  /usr/local/ssl/cert.pem<br />
&lt;!DOCTYPE HTML PUBLIC “-//IETF//DTD HTML 2.0//EN”&gt;</p><br />
<html><head><br />
<title>301 Moved Permanently</title><br />
</head><body><br />
<h1>Moved Permanently</h1><br />
<p>The document has moved <a href="https://curl.haxx.se/ca/cacert.pem">here</a>.</p><br />
<hr /><br />
<address>Apache Server at curl.haxx.se Port 80</address><br />
</body></html><br />
<br />
<p>rm -rf /usr/local/ssl/cert.pem</p><br />
<br />
<p>~$composer<br />
Segmentation fault: 11</p><br />
<br />
<p>rm -rf ~/.composer/</p><br />
<br />
<p>正常</p><br />
<br />
<p>https://stackoverflow.com/questions/24675167/ca-certificates-mac-os-x</p><br />
<br />
<p>$brew uninstall –ignore-dependencies openssl<br />
Uninstalling /usr/local/Cellar/openssl@1.1/1.1.1g… (8,052 files, 18.4MB)</p><br />
<br />
<p>Warning: The following openssl@1.1 configuration files have not been removed</p><br />
<br />
<p>https://github.com/Homebrew/homebrew-core/issues/28806</p><br />
<br />
<p>$ composer global require xxx -vvv<br />
Changed current directory to /Users/didi/.composer<br />
Loading config file /Users/didi/.composer/config.json<br />
Loading config file /Users/didi/.composer/auth.json<br />
Reading /Users/didi/.composer/composer.json<br />
Loading config file /Users/didi/.composer/config.json<br />
Loading config file /Users/didi/.composer/auth.json<br />
Loading config file /Users/didi/.composer/composer.json<br />
Loading config file /Users/didi/.composer/auth.json<br />
Reading /Users/didi/.composer/auth.json<br />
Checked CA file /usr/local/ssl/cert.pem: invalid<br />
Segmentation fault: 11</p><br />
<br />
<p>$lldb -c /cores/core.1795<br />
(lldb) target create –core “/cores/core.1795”<br />
warning: (x86_64) /cores/core.1795 load command 113 LC_SEGMENT_64 has a fileoff + filesize (0x28cd0000) that extends beyond the end of the file (0x28ccf000), the segment will be truncated to match<br />
Core file ‘/cores/core.1795’ (x86_64) was loaded.<br />
(lldb) bt<br />
openssl.so was compiled with optimization - stepping may behave oddly; variables may not be available.</p><br />
<ul><br />
  <li>thread #1: tid = 0x0000, 0x000000010f52c1fe openssl.so`zif_openssl_x509_parse [inlined] php_openssl_add_assoc_asn1_string(val=0x000000010f222d90, key=<unavailable>, str=0xffffffffffffffff) at openssl.c:913, stop reason = signal SIGSTOP<br />
</unavailable>    <ul><br />
      <li>frame #0: 0x000000010f52c1fe openssl.so<code class="language-plaintext highlighter-rouge">zif_openssl_x509_parse [inlined] php_openssl_add_assoc_asn1_string(val=0x000000010f222d90, key=&lt;unavailable&gt;, str=0xffffffffffffffff) at openssl.c:913 [opt]<br />
frame #1: 0x000000010f52c1fe openssl.so</code>zif_openssl_x509_parse(execute_data=<unavailable>, return_value=0x000000010f222d90) + 510 at openssl.c:2367 [opt]<br />
frame #2: 0x000000010e751ce3 php`ZEND_DO_FCALL_BY_NAME_SPEC_RETVAL_USED_HANDLER(execute_data=0x000000010f222bf0) + 483 at zend_vm_execute.h:820 [opt]<br />
frame #3: 0x000000010e6f0178 php`execute_ex(ex=<unavailable>) + 72 at zend_vm_execute.h:59767 [opt]<br />
frame #4: 0x000000010e6f0323 php`zend_execute(op_array=0x000000010f27c620, return_value=<unavailable>) + 355 at zend_vm_execute.h:63804 [opt]<br />
frame #5: 0x000000010e6a86ab php`zend_execute_scripts(type=<unavailable>, retval=0x0000000000000000, file_count=<unavailable>) + 315 at zend.c:1498 [opt]</unavailable></unavailable></unavailable></unavailable></unavailable></li><br />
    </ul><br />
  </li><br />
</ul><br />
<br />
<p>https://unix.stackexchange.com/questions/368355/where-and-how-do-i-obtain-and-install-certificates-to-a-new-installation-of-open</p><br />
<br />
<p>https://superuser.com/questions/437330/how-do-you-add-a-certificate-authority-ca-to-ubuntu</p><br />
<br />
<p>https://github.com/composer/composer/issues/8231</p><br />
<br />
<p>https://github.com/composer/composer/blob/master/README.md</p><br />
<br />
<p>https://curl.haxx.se/docs/caextract.html</p><br />
<br />
<p>curl –remote-name –time-cond cacert.pem https://curl.haxx.se/ca/cacert.pem<br />
ls<br />
cp cacert.pem  /usr/local/ssl/cert.pem<br />
cat  /usr/local/ssl/cert.pem</p><br />
<br />
<p>1、下载composer代码</p><br />
<br />
<p>2、同级目录创建 composer.json 文件</p><br />
<br />
<p>3、通过php执行composer代码（composer使用php写的）读取composer.json 中的文件并下载指定库 指定版本 到 指定文件夹</p><br />
<br />
<p>php执行composer的命令可以写成 bat脚本（win平台），添加脚本路径到环境变量 path ，命令行可以直接执行 composer 命令来使用composer （添加path 自行google， cmd命令set path 的方式是临时修改 所以务必通过计算机右键 属性 的方式修改）</p><br />
<br />
<p>我们已经知道 composer是php写出来的一个脚本 所以第一步我们要下载composer的php源代码   然后通过 php 来执行composer源代码 就可以使用了</p><br />
<br />
<p>Packagist：<br />
用来管理软件的商店。但是它只是起到了一个链接的作用，实际上软件是从github中下载的。因此，我们还要把github和packagist连接起来。</p><br />
<br />
<p>安装composer<br />
下载安装脚本 － composer-setup.php － 到当前目录<br />
php -r “copy(‘https://getcomposer.org/installer’, ‘composer-setup.php’);”</p><br />
<br />
<p>执行安装过程<br />
php composer-setup.php 。将生成一个composer.phar文件</p><br />
<br />
<p>删除安装脚本<br />
php -r “unlink(‘composer-setup.php’);”</p><br />
<br />
<p>Mac 或 Linux 系统：<br />
将composer.phar 文件移动到 /usr/local/bin/ 目录下面：</p><br />
<br />
<p>sudo mv composer.phar /usr/local/bin/composer</p><br />
<br />
<!-- more --><br />
<p>composer 项目的控制台应用依赖于 Symfony 控制台组件<br />
installer 是啥<br />
它是一个 php 脚本文件，执行 php installer 后运行</p><br />
<br />
<p>初始化 installer</p><br />
<br />
<p>function setupEnvironment()<br />
{<br />
  ini_set(‘display_errors’, 1);</p><br />
<br />
<p>$installer = ‘Composer Installer’;<br />
  //win系统版本号，如果你的系统是win10返回10【本人觉得win系统开发复杂，因为我真的没法调度程序】<br />
  if (defined(‘PHP_WINDOWS_VERSION_MAJOR’)) {<br />
      if ($version = getenv(‘COMPOSERSETUP’)) {<br />
          $installer = sprintf(‘Composer-Setup.exe %s’, $version);<br />
      }<br />
  }</p><br />
<br />
<p>define(‘COMPOSER_INSTALLER’, $installer);<br />
}<br />
` process</p><br />
<br />
<p>//$argv位置参数，来源于linux运行一个程序时，会把位置参数传递给main入口<br />
process(is_array($argv) ? $argv : array()); <br />
function process($argv)<br />
{</p><br />
<br />
<p>//安装选项参数https://getcomposer.org/download/说明<br />
 //对于我来说，无用<br />
 //运行时可配置安装位置<br />
$installDir = getOptValue(‘–install-dir’, $argv, false);<br />
//可指定版本，不指定就拉取最新的版本<br />
$version = getOptValue(‘–version’, $argv, false);<br />
//默认下载后重命名为composer.phar一般默认<br />
$filename = getOptValue(‘–filename’, $argv, ‘composer.phar’);<br />
$cafile = getOptValue(‘–cafile’, $argv, false);</p><br />
<br />
<p>//$installDir $version $cafile 检查你提供的参数是否有效【就是你在安装的时候是否指定了这些选项，指定了就会检查】<br />
if (!checkParams($installDir, $version, $cafile)) {<br />
exit(1);<br />
}</p><br />
<br />
<p>//检测你的PHP环境如扩展有没有安装好<br />
$ok = checkPlatform($warnings, $quiet, $disableTls, true);</p><br />
<br />
<p>if ($check) {</p><br />
<br />
<p>if ($ok) {<br />
showWarnings($warnings);<br />
showSecurityWarning($disableTls);<br />
}<br />
exit($ok ? 0 : 1);<br />
}</p><br />
<br />
<p>if ($ok || $force) {<br />
//实例化安装器<br />
$installer = new Installer($quiet, $disableTls, $cafile);<br />
//开始安装<br />
//1先从https://getcomposer.org/versions 获取目前官网最新的版本号<br />
//所以你在安装的时候是可以指定版本号的，不然默认就是拉取最新的<br />
//2、从https://getcomposer.org/download/1.10.5/composer.phar 下载此项目<br />
//phar文件是PHP的PHAR扩展打包的php项目【如果你用过PHAR扩展打包过，就知道了】<br />
//非常的简单<br />
if ($installer-&gt;run($version, $installDir, $filename, $channel)) {<br />
//装完退出当前进程<br />
exit(0);<br />
}<br />
}<br />
exit(1);<br />
}<br />
安装说明：php composer-setup.php 文件时从 getcomposer.org 网站下载打包好的 composer.phar 项目到本地</p><br />
<br />
<p>#!/usr/bin/env php</p><br />
<br />
<p>Composer 工作原理详说 [源码注解] 并非 PPT 概念扯蛋</p><br />
<br />
<p>入口文件源码【精简提炼了，大堆受不了】</p><br />
<br />
<p>#!/usr/bin/env php env可执行文件它最终会找php解释器如上图<br />
&lt;?php</p><br />
<br />
<p>if (PHP_SAPI !== ‘cli’ &amp;&amp; PHP_SAPI !== ‘phpdbg’) {<br />
}<br />
//引入自动【自动加载php类文件】加载文件<br />
require <strong>DIR</strong>.’/../src/bootstrap.php’;<br />
putenv(‘COMPOSER_BINARY=’.realpath($_SERVER[‘argv’][0]));<br />
// run the command application<br />
//控制台应用依赖于Symfony框架<br />
//具体如何使用本人在laravel5.5LTS版本注解过<br />
//如果你不清楚可以去看看，或是到symfony官方找到控制台应用组件复制粘贴运行一下就懂<br />
//实在懒的看算了 本人不在重复<br />
$application = new Application();<br />
$application-&gt;run();<br />
composer.phar 依赖的扩展包<br />
autoload.php	composer	justinrainbow	psr		seld		symfony</p><br />
<br />
<p>composer 控制台应用 run 流程</p><br />
<br />
<p>加载命令类文件<br />
建议自行去撸一下 symfony 的控制台组件，如果不想撸可以看我这里的大体说明，其它的如加载用户自定义的插件命令，加载 composer 的配置文件，auth 文件，初始化各种如下载管理器，插件管理器等在此不题。</p><br />
<br />
<p>1、$exitCode = $this-&gt;doRun($input, $output);<br />
2、$command = $this-&gt;find($name);<br />
//添加所有命令<br />
3、$this-&gt;init();<br />
private function init()<br />
{<br />
 foreach ($this-&gt;getDefaultCommands() as $command) {<br />
     $this-&gt;add($command);<br />
 }<br />
}<br />
public function add(Command $command)<br />
{</p><br />
<br />
<p>$command-&gt;setApplication($this);<br />
 if (!$command-&gt;isEnabled()) {<br />
     $command-&gt;setApplication(null);<br />
     return;<br />
 }<br />
 $this-&gt;commands[$command-&gt;getName()] = $command;<br />
 foreach ($command-&gt;getAliases() as $alias) {<br />
     $this-&gt;commands[$alias] = $command;<br />
 }<br />
 return $command;<br />
}<br />
protected function getDefaultCommands()<br />
{<br />
$commands = array_merge(parent::getDefaultCommands(), array(<br />
new Command\AboutCommand(),<br />
new Command\ConfigCommand(),<br />
new Command\DependsCommand(),<br />
new Command\ProhibitsCommand(),<br />
new Command\InitCommand(),<br />
new Command\InstallCommand(),<br />
new Command\CreateProjectCommand(),<br />
new Command\UpdateCommand(),<br />
new Command\SearchCommand(),<br />
new Command\ValidateCommand(),<br />
new Command\ShowCommand(),<br />
new Command\SuggestsCommand(),<br />
new Command\RequireCommand(),<br />
new Command\DumpAutoloadCommand(),<br />
new Command\StatusCommand(),<br />
new Command\ArchiveCommand(),<br />
new Command\DiagnoseCommand(),<br />
new Command\RunScriptCommand(),<br />
new Command\LicensesCommand(),<br />
new Command\GlobalCommand(),<br />
new Command\ClearCacheCommand(),<br />
new Command\RemoveCommand(),<br />
new Command\HomeCommand(),<br />
new Command\ExecCommand(),<br />
new Command\OutdatedCommand(),<br />
new Command\CheckPlatformReqsCommand(),<br />
));</p><br />
<br />
<p>if (‘phar:’ === substr(<strong>FILE</strong>, 0, 5)) {<br />
$commands[] = new Command\SelfUpdateCommand();<br />
}</p><br />
<br />
<p>return $commands;<br />
}<br />
4、$exitCode = $this-&gt;doRunCommand($command, $input, $output);<br />
5、return $command-&gt;run($input, $output);<br />
//最终运行execute【命令类的方法】<br />
6、$statusCode = $this-&gt;execute($input, $output);<br />
Composer 对象构建流程<br />
Composer 项目的关键配置文件目录结构</p><br />
<br />
<p>Composer 对象构建源码</p><br />
<br />
<p>1、实例化NUllIO类<br />
Composer\IO\NullIO extends BaseIO 类<br />
$this-&gt;io = new NullIO();<br /><br />
2、工厂Composer\Factory类<br />
Composer\Factory<br />
public static function create(IOInterface $io, $config = null, $disablePlugins = false)<br />
{<br />
  $factory = new static();</p><br />
<br />
<p>return $factory-&gt;createComposer($io, $config, $disablePlugins);<br />
}<br />
$this-&gt;composer = Factory::create($this-&gt;io, null, $disablePlugins);</p><br />
<br />
<p>3、createComposer<br />
public function createComposer(IOInterface $io, $localConfig = null, $disablePlugins = false, $cwd = null, $fullLoad = true)<br />
 {</p><br />
<br />
<p>$cwd = $cwd ?: getcwd();//当前进程运行的目录<br />
  if (null === $localConfig) {<br />
  //获取当前项目根目录下的composer.json文件<br />
  $localConfig = static::getComposerFile();<br />
  }<br />
  if (is_string($localConfig)) {<br />
      $composerFile = $localConfig;<br />
      $file = new JsonFile($localConfig, null, $io);<br />
      $file-&gt;validateSchema(JsonFile::LAX_SCHEMA);<br />
    //读取composer.json的内容<br />
      $localConfig = $file-&gt;read();<br />
  }<br />
 //得到配置类Composer/config实例并且合并了.composer目录下的配置文件 config.json auth.json<br /><br />
  $config = static::createConfig($io, $cwd);<br />
  //合并项目根目录下的composer.json配置文件<br />
  $config-&gt;merge($localConfig);<br />
  $config-&gt;setConfigSource(new JsonConfigSource(new JsonFile(realpath($composerFile), null, $io)));<br />
  //vendor目录<br />
  $vendorDir = $config-&gt;get(‘vendor-dir’);<br />
 //composer工厂类<br />
  $composer = new Composer();<br />
  //1、给Composer实例添加【配置实例】<br />
  $composer-&gt;setConfig($config);<br />
   //给baseIo实例添加config实例<br />
  $io-&gt;loadConfiguration($config);<br />
  //工厂类构建Composer\Util\RemoteFileSystem实例<br />
  $rfs = self::createRemoteFilesystem($io, $config);<br />
  //2、给composer实例添加【事件调度器实例】<br />
  $dispatcher = new EventDispatcher($composer, $io);<br />
  $composer-&gt;setEventDispatcher($dispatcher);<br />
 //调用源码仓库工厂构建仓库管理器实例Composer\Repository\RepositoryManager<br />
  $rm = RepositoryFactory::manager($io, $config, $dispatcher, $rfs);<br />
  //3、给composer实例添加【仓库管理器实例】<br />
  $composer-&gt;setRepositoryManager($rm);</p><br />
<br />
<p>//给RespositoryManager添加new Repository\InstalledFilesystemRepository(new JsonFile($vendorDir.’/composer/installed.json’, null, $io))本地仓库实例对象<br />
  //仓库管理器添加了svn,git,github,vsc,composer等仓库管理类实例<br />
  $this-&gt;addLocalRepository($io, $rm, $vendorDir);</p><br />
<br />
<p>// force-set the version of the global package if not defined as<br />
 // guessing it adds no value and only takes time  if (!$fullLoad &amp;&amp; !isset($localConfig[‘version’])) {<br />
  $localConfig[‘version’] = ‘1.0.0’;<br />
  }</p><br />
<br />
<p>// 加载扩展包实例<br />
  $parser = new VersionParser;<br />
  $guesser = new VersionGuesser($config, new ProcessExecutor($io), $parser);<br />
  $loader = new Package\Loader\RootPackageLoader($rm, $config, $parser, $guesser, $io);<br />
  //4、读取项目根目录下的composer.json配置数据，并保存在Composer\Package\BasePackage 扩展包实例中<br />
//同时根据config.json的配置【镜像类型一般有svn,git,github,composer,vcs等】一般为composer配置了Composer\Repository\ComposerRepository composer仓库实例</p><br />
<br />
<p>$package = $loader-&gt;load($localConfig, ‘Composer\Package\RootPackage’, $cwd);<br />
  $composer-&gt;setPackage($package);</p><br />
<br />
<p>// initialize installation manager<br />
 //5、给composer实例添加Installer\InstallationManager() 【安装管理器】<br />
  $im = $this-&gt;createInstallationManager();<br />
  $composer-&gt;setInstallationManager($im);</p><br />
<br />
<p>if ($fullLoad) {<br />
  // initialize download manager<br />
 //6、给composer实例添加Downloader\DownloadManager 【下载管理器】<br />
  $dm = $this-&gt;createDownloadManager($io, $config, $dispatcher, $rfs);<br />
  $composer-&gt;setDownloadManager($dm);</p><br />
<br />
<p>//7、给composer实例添加【自动加载生成器实例】<br />
  $generator = new AutoloadGenerator($dispatcher, $io);<br />
  $composer-&gt;setAutoloadGenerator($generator);</p><br />
<br />
<p>// 8、给composer实例添加压缩【ZIP,PHAR打包】归档管理器<br />
  $am = $this-&gt;createArchiveManager($config, $dm);<br />
  $composer-&gt;setArchiveManager($am);<br />
  }</p><br />
<br />
<p>//给安装管理器添加一些安装器【如pear,package,plugin,library】<br />
  $this-&gt;createDefaultInstallers($im, $composer, $io);</p><br />
<br />
<p>if ($fullLoad) {<br />
  $globalComposer = null;<br />
  if (realpath($config-&gt;get(‘home’)) !== $cwd) {<br />
  $globalComposer = $this-&gt;createGlobalComposer($io, $config, $disablePlugins);<br />
  }<br />
//return new Plugin\PluginManager($io, $composer, $globalComposer, $disablePlugins);<br />
 //9、给composer实例添加【插件管理器实例】<br />
  $pm = $this-&gt;createPluginManager($io, $composer, $globalComposer, $disablePlugins);<br />
  $composer-&gt;setPluginManager($pm);</p><br />
<br />
<p>//运行用户在composer.json配置的插件类或是composer-installer安装器<br />
  $pm-&gt;loadInstalledPlugins();<br />
  }</p><br />
<br />
<dl><br />
  <dt>if ($fullLoad &amp;&amp; isset($composerFile)) {</dt><br />
  <dt>  $lockFile = “json” === pathinfo($composerFile, PATHINFO_EXTENSION)</dt><br />
  <dt> ? substr($composerFile, 0, -4).’lock’</dt><br />
  <dd>$composerFile . ‘.lock’;<br />
  //10、给composer实例添加【Locker实例】<br />
  $locker = new Package\Locker($io, new JsonFile($lockFile, null, $io), $rm, $im, file_get_contents($composerFile));<br />
  $composer-&gt;setLocker($locker);<br />
  }<br />
  return $composer;<br />
  }<br />
composer/config 对象<br />
namespace Composer<br />
class Config<br />
{<br />
public static $defaultConfig = array(<br />
    ‘process-timeout’ =&gt; 300,<br />
    ‘use-include-path’ =&gt; false,<br />
    ‘preferred-install’ =&gt; ‘auto’,<br />
    ‘notify-on-install’ =&gt; true,<br />
    ‘github-protocols’ =&gt; array(‘https’, ‘ssh’, ‘git’),<br />
    ‘vendor-dir’ =&gt; ‘vendor’,<br />
    ‘bin-dir’ =&gt; ‘{$vendor-dir}/bin’,<br />
    ‘cache-dir’ =&gt; ‘{$home}/cache’,<br />
    ‘data-dir’ =&gt; ‘{$home}’,<br />
    ‘cache-files-dir’ =&gt; ‘{$cache-dir}/files’,<br />
    ‘cache-repo-dir’ =&gt; ‘{$cache-dir}/repo’,<br />
    ‘cache-vcs-dir’ =&gt; ‘{$cache-dir}/vcs’,<br />
    ‘cache-ttl’ =&gt; 15552000, // 6 months<br />
    ‘cache-files-ttl’ =&gt; null, // fallback to cache-ttl<br />
    ‘cache-files-maxsize’ =&gt; ‘300MiB’,<br />
    ‘bin-compat’ =&gt; ‘auto’,<br />
    ‘discard-changes’ =&gt; false,<br />
    ‘autoloader-suffix’ =&gt; null,<br />
    ‘sort-packages’ =&gt; false,<br />
    ‘optimize-autoloader’ =&gt; false,<br />
    ‘classmap-authoritative’ =&gt; false,<br />
    ‘apcu-autoloader’ =&gt; false,<br />
    ‘prepend-autoloader’ =&gt; true,<br />
    ‘github-domains’ =&gt; array(‘github.com’),<br />
    ‘bitbucket-expose-hostname’ =&gt; true,<br />
    ‘disable-tls’ =&gt; false,<br />
    ‘secure-http’ =&gt; true,<br />
    ‘cafile’ =&gt; null,<br />
    ‘capath’ =&gt; null,<br />
    ‘github-expose-hostname’ =&gt; true,<br />
    ‘gitlab-domains’ =&gt; array(‘gitlab.com’),<br />
    ‘store-auths’ =&gt; ‘prompt’,<br />
    ‘platform’ =&gt; array(),<br />
    ‘archive-format’ =&gt; ‘tar’,<br />
    ‘archive-dir’ =&gt; ‘.’,<br />
    ‘htaccess-protect’ =&gt; true,<br />
    ‘use-github-api’ =&gt; true,<br />
    ‘lock’ =&gt; true,<br />
    // valid keys without defaults (auth config stuff):<br />
    // bitbucket-oauth<br />
    // github-oauth<br />
    // gitlab-oauth<br />
    // gitlab-token<br />
    // http-basic<br />
);<br />
<br />
    <p>public static $defaultRepositories = array(<br />
    ‘packagist.org’ =&gt; array(<br />
        ‘type’ =&gt; ‘composer’,<br />
        ‘url’ =&gt; ‘https?://repo.packagist.org’,//镜像地址，通过composer config便可以修改，比如我上面列出的config.json配置文件<br />
        ‘allow_ssl_downgrade’ =&gt; true,<br />
    ),<br />
);</p><br />
<br />
    <p>public function __construct($useEnvironment = true, $baseDir = null)<br />
{<br />
    // load defaults<br />
    $this-&gt;config = static::$defaultConfig;<br />
    $this-&gt;repositories = static::$defaultRepositories;<br />
    $this-&gt;useEnvironment = (bool) $useEnvironment;<br />
    $this-&gt;baseDir = $baseDir;<br />
}<br />
Composer 类<br />
namespace Composer;</p><br />
  </dd><br />
</dl><br />
<br />
<p>use Composer\Package\RootPackageInterface;<br />
use Composer\Package\Locker;<br />
use Composer\Repository\RepositoryManager;<br />
use Composer\Installer\InstallationManager;<br />
use Composer\Plugin\PluginManager;<br />
use Composer\Downloader\DownloadManager;<br />
use Composer\EventDispatcher\EventDispatcher;<br />
use Composer\Autoload\AutoloadGenerator;<br />
use Composer\Package\Archiver\ArchiveManager;</p><br />
<br />
<p>class Composer<br />
{<br />
    const VERSION = ‘@package_version@’;<br />
    const BRANCH_ALIAS_VERSION = ‘@package_branch_alias_version@’;<br />
    const RELEASE_DATE = ‘@release_date@’;<br />
    const SOURCE_VERSION = ‘1.10-dev+source’;</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static function getVersion()<br />
{<br />
 <br />
    return self::VERSION;<br />
}<br />
 <br />
/**<br />
 * @var Package\RootPackageInterface<br />
 */<br />
private $package;<br />
 <br />
/**<br />
 * @var Locker<br />
 */<br />
private $locker;<br />
 <br />
/**<br />
 * @var Repository\RepositoryManager<br />
 */<br />
private $repositoryManager;<br />
 <br />
/**<br />
 * @var Downloader\DownloadManager<br />
 */<br />
private $downloadManager;<br />
 <br />
/**<br />
 * @var Installer\InstallationManager<br />
 */<br />
private $installationManager;<br />
 <br />
/**<br />
 * @var Plugin\PluginManager<br />
 */<br />
private $pluginManager;<br />
 <br />
/**<br />
 * @var Config<br />
 */<br />
private $config;<br />
 <br />
/**<br />
 * @var EventDispatcher<br />
 */<br />
private $eventDispatcher;<br />
 <br />
/**<br />
 * @var Autoload\AutoloadGenerator<br />
 */<br />
private $autoloadGenerator;<br />
 <br />
/**<br />
 * @var ArchiveManager<br />
 */<br />
private $archiveManager;<br />
 <br />
/**<br />
 * @param  Package\RootPackageInterface $package<br />
 * @return void<br />
 */<br />
public function setPackage(RootPackageInterface $package)<br />
{<br />
    $this-&gt;package = $package;<br />
}<br />
 <br />
/**<br />
 * @return Package\RootPackageInterface<br />
 */<br />
public function getPackage()<br />
{<br />
    return $this-&gt;package;<br />
}<br />
 <br />
/**Composer/Config 实例<br />
 * @param Config $config<br />
 */<br />
public function setConfig(Config $config)<br />
{<br />
    $this-&gt;config = $config;<br />
}<br />
 <br />
/**Composer/Config 实例<br />
 * @return Config<br />
 */<br />
public function getConfig()<br />
{<br />
    return $this-&gt;config;<br />
}<br />
 <br />
/**<br />
 * @param Package\Locker $locker<br />
 */<br />
public function setLocker(Locker $locker)<br />
{<br />
    $this-&gt;locker = $locker;<br />
}<br />
 <br />
/**<br />
 * @return Package\Locker<br />
 */<br />
public function getLocker()<br />
{<br />
    return $this-&gt;locker;<br />
}<br />
 <br />
/**<br />
 * @param Repository\RepositoryManager $manager<br />
 */<br />
public function setRepositoryManager(RepositoryManager $manager)<br />
{<br />
    $this-&gt;repositoryManager = $manager;<br />
}<br />
 <br />
/**<br />
 * @return Repository\RepositoryManager<br />
 */<br />
public function getRepositoryManager()<br />
{<br />
    return $this-&gt;repositoryManager;<br />
}<br />
 <br />
/**<br />
 * @param Downloader\DownloadManager $manager<br />
 */<br />
public function setDownloadManager(DownloadManager $manager)<br />
{<br />
    $this-&gt;downloadManager = $manager;<br />
}<br />
 <br />
/**<br />
 * @return Downloader\DownloadManager<br />
 */<br />
public function getDownloadManager()<br />
{<br />
    return $this-&gt;downloadManager;<br />
}<br />
 <br />
/**<br />
 * @param ArchiveManager $manager<br />
 */<br />
public function setArchiveManager(ArchiveManager $manager)<br />
{<br />
    $this-&gt;archiveManager = $manager;<br />
}<br />
 <br />
/**<br />
 * @return ArchiveManager<br />
 */<br />
public function getArchiveManager()<br />
{<br />
    return $this-&gt;archiveManager;<br />
}<br />
 <br />
/**<br />
 * @param Installer\InstallationManager $manager<br />
 */<br />
public function setInstallationManager(InstallationManager $manager)<br />
{<br />
    $this-&gt;installationManager = $manager;<br />
}<br />
 <br />
/**<br />
 * @return Installer\InstallationManager<br />
 */<br />
public function getInstallationManager()<br />
{<br />
    return $this-&gt;installationManager;<br />
}<br />
 <br />
/**<br />
 * @param Plugin\PluginManager $manager<br />
 */<br />
public function setPluginManager(PluginManager $manager)<br />
{<br />
    $this-&gt;pluginManager = $manager;<br />
}<br />
 <br />
/**<br />
 * @return Plugin\PluginManager<br />
 */<br />
public function getPluginManager()<br />
{<br />
    return $this-&gt;pluginManager;<br />
}<br />
 <br />
/**Composer\EventDispatcher 实例<br />
 * @param EventDispatcher $eventDispatcher<br />
 */<br />
public function setEventDispatcher(EventDispatcher $eventDispatcher)<br />
{<br />
    $this-&gt;eventDispatcher = $eventDispatcher;<br />
}<br />
 <br />
/**<br />
 * @return EventDispatcher<br />
 */<br />
public function getEventDispatcher()<br />
{<br />
    return $this-&gt;eventDispatcher;<br />
}<br />
 <br />
/**<br />
 * @param Autoload\AutoloadGenerator $autoloadGenerator<br />
 */<br />
public function setAutoloadGenerator(AutoloadGenerator $autoloadGenerator)<br />
{<br />
    $this-&gt;autoloadGenerator = $autoloadGenerator;<br />
}<br />
 <br />
/**<br />
 * @return Autoload\AutoloadGenerator<br />
 */<br />
public function getAutoloadGenerator()<br />
{<br />
    return $this-&gt;autoloadGenerator;<br />
} } composer 扩展包类结构<br />
</code></pre></div></div><br />
<br />
<p>Composer 工作原理 [源码分析]</p><br />
<br />
<p>composer 重要命令运行流程说明<br />
composer require 命令<br />
require 命令类结构【继承】图<br />
Composer 工作原理 [源码分析]</p><br />
<br />
<p>//测试composer require nicmart/tree<br />
//$input封装了运行composer脚本时传递的位置参数<br />
//$output对象<br />
RequireCommand-&gt;execute(InputInterface $input, OutputInterface $output)<br />
RequireCommand-&gt;doUpdate($input, $output, $io, $requirements);<br />
//安装器<br />
Composer\Installer-&gt;run();<br />
Composer\Installer-&gt;doInstall($localRepo, $installedRepo, $platformRepo, $aliases);<br />
Composer\Installer\InstallationManager-&gt;installationManager-&gt;execute($localRepo, $operation);<br /><br />
//包安装器<br />
Composer\Installer\LibraryInstaller-&gt;install(InstalledRepositoryInterface $repo, PackageInterface $package);<br />
Composer\Installer\LibraryInstaller-&gt;installCode(PackageInterface $package)<br />
//下载管理器<br />
Composer\Downloader-&gt;download(PackageInterface $package, $targetDir, $preferSource = null);<br />
//git下载管理器<br />
Composer\Downloader\GitDownloader extends VcsDownloader-&gt;doDownload(PackageInterface $package, $path, $url);<br />
//git 命令<br />
$command = ‘git clone –no-checkout %url% %path% &amp;&amp; cd ‘.$flag.’%path% &amp;&amp; git remote add composer %url% &amp;&amp; git fetch composer &amp;&amp; git remote set-url origin %sanitizedUrl% &amp;&amp; git remote set-url composer %sanitizedUrl%’;<br /><br />
Composer\Util\Git-&gt;runCommand($commandCallable, $url, $cwd, $initialClone = false);<br /><br />
// 低层源码执行情况【如何跟踪 linux 源码运行情况可以参考本人在 larave 社区写过的 nginx 低层数据交互原理】：<br />
1、execve(“/usr/local/bin/php”, [“php”, “/bin/composer”, “require”, “nicmart/tree”], [/* 26 vars */]) = 0<br />
连接自己配置的镜像<br />
连接国外的镜像网站</p><br />
<br />
<p>2、execve(“/bin/git”, [“git”, “clone”, “–no-checkout”, “https://github.com/nicmart/Tree.”…, “/home/worker/vendor/nicmart/tree”], [/* 29 vars */]) = 0</p><br />
<br />
<p>https://blog.csdn.net/qq_35383263/article/details/105798510</p><br />
<br />
<p>https://github.com/composer/installers<br />
https://getcomposer.org/doc/faqs/how-do-i-install-a-package-to-a-custom-path-for-my-framework.md<br />
https://github.com/composer/composer</p><br />
<br />
<p>https://www.cntofu.com/book/107/PHP%20Composer-%E2%80%94%E2%80%94-%E6%B3%A8%E5%86%8C%E4%B8%8E%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md</p><br />
<br />
<p>https://www.codenong.com/cs105798510/</p><br />
<br />
<p>https://segmentfault.com/a/1190000014948542</p><br />
<br />
<p>PHP Composer—— 初始化源码分析</p><br />
<br />
<p>https://www.bookstack.cn/read/laravel-source-analysis/PHP%20Composer%E2%80%94%E2%80%94%20%E5%88%9D%E5%A7%8B%E5%8C%96%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90.md</p><br />
<br />
<p>https://zhuanlan.zhihu.com/p/30785203</p><br />
<br />
<p>https://learnku.com/docs/the-laravel-way/5.6/Tao-3-1/2928</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category php
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>