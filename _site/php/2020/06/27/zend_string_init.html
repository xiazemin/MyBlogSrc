<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">zend_string_init</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-06-27T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jun 27, 2020</time></p>
					</div>
					 <p>char * 转zend_string<br />
zend_string_init</p><br />
<br />
<p>zend_string转char＊<br />
ZSTR_VAL<br />
<!-- more --><br />
一、字符串的结构<br />
Copy<br />
struct _zend_string {<br />
	zend_refcounted_h gc;       /* 字符串类别及引用计数 <em>/<br />
	zend_ulong        h;        /</em> 字符串的哈希值 <em>/<br />
	size_t            len;      /</em> 字符串的长度 <em>/<br />
	char              val[1];   /</em> 柔性数组，字符串存储位置 */<br />
};<br />
zend_refcounted_h对应的结构体：</p><br />
<br />
<p>Copy<br />
typedef struct _zend_refcounted_h {<br />
	uint32_t         refcount;			/* 引用计数 <em>/<br />
	union {<br />
		struct {<br />
			ZEND_ENDIAN_LOHI_3(<br />
				zend_uchar    type,   <br /><br />
				zend_uchar    flags,    /</em> 字符串的类型 <em>/<br />
				uint16_t      gc_info   /</em> 垃圾回收信息 */<br />
			)<br />
		} v;<br />
		uint32_t type_info;<br />
	} u;<br />
} zend_refcounted_h;<br />
image</p><br />
<br />
<p>下面我们来了解一下具体每个成员的作用：</p><br />
<br />
<p>gc：就是_zend_refcounted_h结构体，主要作用是引用计数以及标记变量的类别。<br />
h：字符串的哈希值，在字符串被用来当数组的key时才初始化，这样如果同一个字符串被多次用来做key，就不会重复计算了。<br />
val：这里的char[1]并不意味着只存储1位，char[1]被称为柔性数组，下面来了解一下PHP在字符串内存分配时做了什么。<br />
Copy<br />
static zend_always_inline zend_string *zend_string_alloc(size_t len, int persistent)<br />
{<br />
	zend_string *ret = (zend_string *)pemalloc(ZEND_MM_ALIGNED_SIZE(_ZSTR_STRUCT_SIZE(len)), persistent);<br />
    ……<br />
}<br />
宏替换后：</p><br />
<br />
<p>Copy<br />
static zend_always_inline zend_string *zend_string_alloc(size_t len, int persistent)<br />
{<br />
	zend_string *ret = (zend_string *)pemalloc(ZEND_MM_ALIGNED_SIZE(XtOffsetOf(zend_string, val) + len + 1), persistent);<br />
    ……<br />
}<br />
示例中的代码XtOffsetOf(zend_string, val)表示计算出zend_string结构体的大小，而len就是要分配字符串的长度，最后的+1是留给结束字符\0的。也就是说，分配内存时不仅仅分配结构体大小的内存，还要顾及到长度不可控的val，这样不仅柔性的分配了内存，还使它与其他成员存储在同一块连续的空间中，在分配、释放内存时可以把struct统一处理。</p><br />
<br />
<p>len：字符串的长度，避免重复计算浪费时间，典型的空间换时间做法。<br />
二、字符串的二进制安全<br />
学习过C语言的应该知道，字符串中除了最后一个字符外不允许含有\0，否则会被认为是字符串的结束字符，这就导致了C语言的字符串有很多的限制，比如不存储图片、文件等二进制数据。但是PHP就没有这样的限制，它的字符串可以存储二进制数据，并不会出现任何报错，而PHP的这种能力就叫做字符串的二进制安全。</p><br />
<br />
<p>C语言代码如下：</p><br />
<br />
<p>Copy<br />
main() {<br />
    char a[] = “aaa\0b”;    /* 含有\0的字符串 <em>/<br />
    printf(“%d\n”, strlen(a));  /</em> 长度为3，\0后的b被忽略 */<br />
}<br />
PHP代码：</p><br />
<br />
<p>Copy<br />
&lt;?php<br />
    $a = “aaa\0b”;<br />
    echo strlen($a);    //输出5<br />
?&gt;<br />
但是PHP不是C语言写的吗？为什么PHP不会报错？我们再来回顾一下zend_string结构体，还记得成员变量len吗？它是实现二进制安全的关键，我们不需要像C一样通过\0来判定字符串是否被读取完成，而是通过长度len来判断，这样就保证了字符串的二进制安全。</p><br />
<br />
<p>三、zend_string API<br />
在了解了zend_string结构之后，我们来了解一下用来操作zend_string的函数集合。</p><br />
<br />
<p>函数	作用<br />
zend_interned_strings_init	初始化内部字符串存储哈希表，并把PHP的关键字等字符串信息写进去<br />
zend_new_interned_string	把一个zend_string写入CG(interned_strings)哈希表中<br />
zend_interned_strings_snapshot	将CG(interned_strings)哈希表中的字符串标记为永久字符串，这里标记的只有PHP关键字、内部函数名、内部方法名等<br />
zend_interned_strings_restore	销毁CG(interned_strings)哈希表中类型为非永久字符串的值，在php_request_shutdown阶段释放<br />
zend_interned_strings_dtor	销毁整个CG(interned_strings)哈希表，在php_module_shutdown阶段释放<br />
zend_string_hash_val	得到字符串的哈希值，没有则实时计算<br />
zend_string_forget_hash_val	将字符串的哈希值置为0<br />
zend_string_refcount	读取字符串的引用计数<br />
zend_string_addref	引用计数+1<br />
zend_string_delref	引用计数-1<br />
zend_string_alloc	分配内存及初始化字符串的值<br />
zend_string_init	初始化字符串并在最后追加\0<br />
zend_string_cop	使用引用计数方式复制字符串<br />
zend_string_dup	直接复制一个字符串<br />
zend_string_extend	扩容到len，保留原来的值<br />
zend_string_truncate	截断到len，保留开头到len的值<br />
zend_string_free	释放字符串内存<br />
zend_string_release	GC引用递减，直到为0时释放内存<br />
zend_string_equals	普通判等<br />
zend_string_equals_ci	基于二进制安全，两个zend_string类型字符串判等<br />
zend_string_equals_literal_ci	基于二进制安全，zend_string类型和char*字符串判等<br />
zend_inline_hash_func	计算字符串的哈希值<br />
zend_intern_known_strings	往zend_intern_known_strings全局数组写入str<br />
下面挑几个函数来介绍一下。</p><br />
<br />
<p>3.1、zend_string_init函数#<br />
zend_string_init函数主要负责把一个普通的字符串转化为zend_string结构体。</p><br />
<br />
<p>Copy<br />
static zend_always_inline zend_string *zend_string_init(const char *str, size_t len, int persistent)<br />
{<br />
	zend_string *ret = zend_string_alloc(len, persistent);</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>memcpy(ZSTR_VAL(ret), str, len);<br />
ZSTR_VAL(ret)[len] = '\0';<br />
return ret; } 申请一块连续的内存，这个在上文中已经提到，申请的内存大小是zend_string结构体大小+字符串长度+1。 指针偏移到val位置，开始字符串拷贝。 在zend_string.val结尾追加\0。 3.2、zend_string_extend函数# 该函数主要用于对字符串的扩容，注意这里扩容不会改变原来保存的值，只是把长度扩大到len。<br />
</code></pre></div></div><br />
<br />
<p>Copy<br />
static zend_always_inline zend_string *zend_string_extend(zend_string *s, size_t len, int persistent)<br />
{<br />
	zend_string *ret;</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZEND_ASSERT(len &gt;= ZSTR_LEN(s));<br />
if (!ZSTR_IS_INTERNED(s)) {<br />
	if (EXPECTED(GC_REFCOUNT(s) == 1)) {<br />
		ret = (zend_string *)perealloc(s, ZEND_MM_ALIGNED_SIZE(_ZSTR_STRUCT_SIZE(len)), persistent);<br />
		ZSTR_LEN(ret) = len;<br />
		zend_string_forget_hash_val(ret);<br />
		return ret;<br />
	} else {<br />
		GC_REFCOUNT(s)--;<br />
	}<br />
}<br />
ret = zend_string_alloc(len, persistent);<br />
memcpy(ZSTR_VAL(ret), ZSTR_VAL(s), ZSTR_LEN(s) + 1);<br />
return ret; } 如果不是内部字符串并且引用计数为1时，直接调用perealloc分配内存。 如果字符串的引用计数大于1或者是内部字符串时，就不能在原来的基础上扩容了，先通过zend_string_alloc申请一块新内存，让后将旧内容拷贝到新内存中。 3.3、zend_string_equals_ci函数# 主要基于二进制安全对两个字符串进行判等，我们来看下PHP是怎么比较两个字符串的。<br />
</code></pre></div></div><br />
<br />
<p>Copy<br />
#define zend_string_equals_ci(s1, s2) <br /><br />
	(ZSTR_LEN(s1) == ZSTR_LEN(s2) &amp;&amp; !zend_binary_strcasecmp(ZSTR_VAL(s1), ZSTR_LEN(s1), ZSTR_VAL(s2), ZSTR_LEN(s2)))</p><br />
<br />
<p>先比较两个字符串的长度是否相等，注意这里是通过zend_string中的len来比较的。<br />
zend_binary_strcasecmp函数在长度比较完成后，进行逐个字符进行比较。先遍历整个字符串数组，取出每个字符，转换为ASC码进行判等，如果不等则返回差值。循环完了还没发现差异的话就返回两者的长度差，如果长度相等就返回0。感觉这里做的有点多余，参数传进来之前就已经做了长度判等了。<br />
Copy<br />
ZEND_API int ZEND_FASTCALL zend_binary_strcasecmp(const char <em>s1, size_t len1, const char *s2, size_t len2) /</em> {{{ */<br />
{<br />
	size_t len;<br />
	int c1, c2;</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (s1 == s2) {<br />
	return 0;<br />
}<br />
<br />
len = MIN(len1, len2);<br />
while (len--) {<br />
	c1 = zend_tolower_ascii(*(unsigned char *)s1++);<br />
	c2 = zend_tolower_ascii(*(unsigned char *)s2++);<br />
	if (c1 != c2) {<br />
		return c1 - c2;<br />
	}<br />
}<br />
<br />
return (int)(len1 - len2); }<br />
</code></pre></div></div><br />
<br />
<p>https://www.cnblogs.com/pingyeaa/p/9688248.html</p><br />
<br />
<p>https://www.cnblogs.com/ITCM/articles/6943600.html</p><br />
<br />
<p>https://www.cnblogs.com/pingyeaa/p/9688248.html</p><br />
<br />
<p>https://blog.csdn.net/yuhezheg/article/details/105028172</p><br />
<br />
<p>https://www.cnblogs.com/yjf512/p/6108444.html</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category php
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>