<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">tideways + xhgui（+toolkit） php 性能分析</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-04-24T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Apr 24, 2019</time></p>
					</div>
					 <p>https://github.com/tideways/php-xhprof-extension<br />
1）PHP的xhprof扩展Facebook不再进行更新和维护，因为Faceboo已经全面使用HHVM，不再使用PHP zend引擎。<br />
2）xhprof不支持新版本的PHP（PHP7），tideways扩展是从xhprof项目fork下来继续进行维护的，目前支持PHP 7.2, 7.1, 7.0, 5.6 and 5.5 。<br />
3）tideways是开源项目，它收费的只是UI服务，其实 xhgui完全可以满足我们日常的需求<br />
<!-- more --><br />
2 功能<br />
tideways是用来测试PHP性能的扩展，它能获取PHP执行的整个过程中调用的函数、调用函数次数、执行时间、CPU时间、内存占用、内存峰值、总执行时间、总CPU时间、总内存占用、总内存峰值等数据，通过以上数据进行分析，找出PHP的性能瓶颈、分析PHP执行过程等。<br />
3 优点<br />
1）tideways是一个PHP扩展，结合xhgui，无需在PHP代码中进行埋点来监控代码<br />
2）可以设置执行频率（例如1/100），无需每个请求都生成执行日志，从而导致性能损失；也可以主动控制是否生成执行日志，通过请求参数来控制（debug=1）<br />
3）有简单直接的UI对数据进行转化<br />
4）可以自由的搭配条件进行数据筛选，例如分析某个特定的接口，分析某个时间段的接口请求情况等<br />
4 缺点<br />
1）虽然是非侵入式的，但是如果对每个接口生成执行日志，那么对CPU和内存的消耗是不可忽略的。<br />
2）如果在线上，header文件万一有错误改动等问题，那么将导致PHP请求无法无法正常运行。</p><br />
<br />
<ol><br />
  <li>实现原理</li><br />
</ol><br />
<br />
<p>tideways扩展负责生成运行日志<br />
nginx中通过配置fastcgi_param PHP_VALUE  auto_prepend_file，在请求开始之前执行auto_prepend_file配置的PHP文件，文件中利用register_shutdown_function方法，在PHP进程结束的时候调用tideways_disable来实现tideways的嵌入，然后将执行日志存入mongodb或者mysql或者文件中，通过xhgui分析之后进行展示，展示形式包括柱状图、瀑布流、火焰图。</p><br />
<br />
<ol><br />
  <li>配置</li><br />
</ol><br />
<br />
<p>nginx配置</p><br />
<br />
<p>server {<br />
  listen 80;<br />
  server_name site.localhost;<br />
  root /Users/markstory/Sites/awesome-thing/app/webroot/;<br />
  fastcgi_param PHP_VALUE “auto_prepend_file=/home/vagrant/code/xhgui-branch/external/header.php”;<br />
}</p><br />
<br />
<p>xhgui配置（生成日志的频率）</p><br />
<br />
<p>‘profiler.enable’ =&gt; function() {<br />
   // url 中包含debug=1则百分百捕获<br />
   if(!empty($_GET[‘debug’])){<br />
       return True;<br />
   }else{<br />
       // 1%采样<br />
       return rand(1, 100) === 42;<br />
   }<br />
}</p><br />
<br />
<p>如上代码，在xhgui的config/config.default.php中，可设置采样命中次数；<br />
return rand(1, 100) === 42; 为1%的采样率，改成return True;则标识每次都采样<br />
如果mongodb和xhgui不在同一台机器上的话，需要修改mongodb的配置，配置如下：<br />
// Can be either mongodb or file.<br />
   /*<br />
   ‘save.handler’ =&gt; ‘file’,<br />
   ‘save.handler.filename’ =&gt; dirname(<strong>DIR</strong>) . ‘/cache/’ . ‘xhgui.data.’ . microtime(true) . ‘<em>’ . substr(md5($url), 0, 6),<br />
   */<br />
   ‘save.handler’ =&gt; ‘mongodb’,<br />
   // Needed for file save handler. Beware of file locking. You can adujst this file path<br />
   // to reduce locking problems (eg uniqid, time …)<br />
   //’save.handler.filename’ =&gt; <strong>DIR</strong>.’/../data/xhgui</em>‘.date(‘Ymd’).’.dat’,<br />
   ‘db.host’ =&gt; ‘mongodb://127.0.0.1:27017’,<br />
   ‘db.db’ =&gt; ‘xhprof’,</p><br />
<br />
<p>mongodb配置</p><br />
<br />
<p>mongo</p><br />
<blockquote><br />
  <p>use xhprof<br />
db.results.ensureIndex( { ‘meta.SERVER.REQUEST_TIME’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().wt’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().mu’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().cpu’ : -1 } )<br />
db.results.ensureIndex( { ‘meta.url’ : 1 } )</p><br />
</blockquote><br />
<br />
<p>当我们发现生产环境的某个接口执行时间特别长时应该怎么做？直接登录线上机器单步调试？打大量的log然后分析？ 一般我们可以把分析流程拆分为如下几步操作：</p><br />
<br />
<p>分析开发环境下执行是否会慢；<br />
如果是代码问题，在开发环境下就能检测出来；</p><br />
<br />
<p>分析预发环境执行是否会慢；<br />
如果是数据库或者第三方扩展问题，在预发环境就能检查出来。</p><br />
<br />
<p>从生产环境摘一台机器，分析代码执行慢的原因；<br />
如果是机器的问题，在生产环境就能检查出来。</p><br />
<br />
<p>1，2，3步骤都需要去分析代码，看哪部分执行时间长。如果人工一句一句代码去排查，不但要耗费大量时间还会导致用户流失。大多时候我们会使用第三方的分析工具tideways或者xhprof来快速发现问题。选择哪一个工具比较好呢？xhprof虽然来自facebook但已经很久不更新，官方源已经显示This package is abandoned and no longer maintained（此包已废弃，不再维护）。tideways恰好相反，一直有商业公司在维护，并且积极的支持了PHP7。两个扩展都是开源的，综上所述我建议大家选择tideways来分析代码。</p><br />
<br />
<p>tideways扩展能把每条请求生成详细的执行日志，通过对日志做简单的分析就能看到程序哪部分耗时最长，这里可以使用xhprof的UI程序（xhprof生成的日志和tideways生成的日志格式通用），交互虽然不大友好但是够用了。如果想有更好的视觉效果，建议下载xhgui，一款基于Bootstrap的xhprof UI程序。</p><br />
<br />
<p>在开始搭建PHP非侵入式监控平台之前，我需要解释几个问题。</p><br />
<br />
<p>一. Tideways这家公司如何盈利？<br />
Tideways这家公司与Sentry的营销模式一样，都是卖存储服务和数据分析服务。</p><br />
<br />
<p>tideways.so扩展是开源的可以免费使用。但是tideways.so扩展只能生成日志文件，我们获得日志文件后还需要花很长时间去整理和分析。如果你购买了Tideways的服务，就能无缝的将日志存储到他们的服务器，登录他们提供的后台就能看到项目代码和服务器的运行状况。加上各种可视化的图表展示体验非常的好，有很多大公司愿意付费。</p><br />
<br />
<p>二. 安装扩展后代码改动会不会很大？<br />
tideways.so扩展提供的监控方式是非侵入式的监控，不会对当前项目有任何的影响。我们只需要在Nginx配置文件中加上一行配置即可：</p><br />
<br />
<p>fastcgi_param PHP_VALUE “auto_prepend_file=/home/admin/xhgui/external/header.php”;</p><br />
<br />
<p>代码的含义：在执行主程序前都运行我们指定的PHP脚本</p><br />
<br />
<p>具体如何安装这个服务，我在文章的下半部分会详细说明。现在仅需要知道『非侵入式的监控』不用改动一行项目代码。</p><br />
<br />
<p>三. 每个请求都生成日志会不会影响服务性能？<br />
用户的每次请求都生成执行日志对服务性能会有轻微的影响。虽然tideways.so扩展提供的监控方式是非侵入式的，但对CPU和内存的消耗是不可忽略的。为了减少对内存和CPU的消耗，我们可以控制生成日志的频率，还能编写生成日志的规则。默认频率为1%(每100个请求生成1条日志，这里的概率非绝对)。</p><br />
<br />
<p>如果有多台服务器，只需要对一台进行监控，机器比较多的话可以每个机房一台。</p><br />
<br />
<p>搭建非侵入式监控环境<br />
安装PHP mongodb扩展；</p><br />
<br />
<p>sudo pecl install mongodb</p><br />
<br />
<p>pecl是php自带命令，全局如果找不到，请到php的安装目录bin下查看。</p><br />
<br />
<p>安装PHP tideaways扩展；</p><br />
<br />
<p>tideaways的文档写的非常详细，安装tideaways扩展（官方文档） 这里我用Centos举例。</p><br />
<br />
<p>$ echo “[tideways]<br />
name = Tideways<br />
baseurl = https://s3-eu-west-1.amazonaws.com/qafoo-profiler/rpm” &gt; /etc/yum.repos.d/tideways.repo</p><br />
<br />
<p>$ rpm –import https://s3-eu-west-1.amazonaws.com/qafoo-profiler/packages/EEB5E8F4.gpg</p><br />
<br />
<p>$ yum makecache –disablerepo=* –enablerepo=tideways</p><br />
<br />
<p>$ yum install tideways-php tideways-cli tideways-daemon<br />
PS: MarkDown的语法转换可能存在问题，容易把中划线转没了，建议安装时从官网COPY命令，安装tideaways扩展</p><br />
<br />
<p>修改php.ini文件；</p><br />
<br />
<p>我们需要在php.ini文件中引入扩展</p><br />
<br />
<p>[mongodb]<br />
extension=mongodb.so<br />
[tideways]<br />
extension=tideways.so<br />
;不需要自动加载，在程序中控制就行<br />
tideways.auto_prepend_library=0<br />
;频率设置为100，在程序调用时能改<br />
tideways.sample_rate=100<br />
安装mongodb-server（可选择安装mongodb客户端）;</p><br />
<br />
<p>我们需要在系统中安装mongodb-server，用来存储tideways扩展生成的日志。多台服务器也只需要安装一个mongodb-server，用来做日志归拢。如果有单独的mongodb机器，可以跳过这一步。</p><br />
<br />
<p>Centos下安装MongoDB服务：</p><br />
<br />
<p>sudo yum install mongodb-server</p><br />
<br />
<p>启动服务：</p><br />
<br />
<p>sudo service mongod start</p><br />
<br />
<p>Centos下安装MongoDB客户端：</p><br />
<br />
<p>sudo yum install mongodb</p><br />
<br />
<p>安装xhgui；</p><br />
<br />
<p>git clone https://github.com/laynefyc/xhgui-branch.git<br />
cd xhgui-branch<br />
php install.php<br />
你也可以通过Composer去安装，composer require laynefyc/xhgui-chinese。</p><br />
<br />
<p>PS: xhgui官方版本已经很久不更新，很多符号和单位都不适合中国用户。为了方便使用我单独维护了一个汉化的版本，并且坚持在更新。安装这个版本，将有更好的体验。如果你一定要安装原版请执行下面的命令</p><br />
<br />
<p>git clone https://github.com/perftools/xhgui<br />
cd xhgui<br />
php install.php<br />
修改配置文件，如果你的MongoDB安装在当前机器可以不用修改xhgui的配置文件，否则你需要在配置文件中修改MongoDB的连接ip和域名，路径如下：xhgui/config/config.default.php</p><br />
<br />
<p>// Can be either mongodb or file.<br />
   /*<br />
   ‘save.handler’ =&gt; ‘file’,<br />
   ‘save.handler.filename’ =&gt; dirname(<strong>DIR</strong>) . ‘/cache/’ . ‘xhgui.data.’ . microtime(true) . ‘_’ . substr(md5($url), 0, 6),<br />
   */<br />
   ‘save.handler’ =&gt; ‘mongodb’,</p><br />
<br />
<p>// Needed for file save handler. Beware of file locking. You can adujst this file path<br />
   // to reduce locking problems (eg uniqid, time …)<br />
   //’save.handler.filename’ =&gt; <strong>DIR</strong>.’/../data/xhgui_‘.date(‘Ymd’).’.dat’,<br />
   ‘db.host’ =&gt; ‘mongodb://127.0.0.1:27017’,<br />
   ‘db.db’ =&gt; ‘xhprof’,<br />
测试MongoDB连接情况并优化索引；</p><br />
<br />
<p>当前机器安装过mongo客户端才能调用mongo命令，mongo客户端的安装方法第四步有详细说明。</p><br />
<br />
<p>$ mongo</p><br />
<blockquote><br />
  <p>use xhprof<br />
db.results.ensureIndex( { ‘meta.SERVER.REQUEST_TIME’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().wt’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().mu’ : -1 } )<br />
db.results.ensureIndex( { ‘profile.main().cpu’ : -1 } )<br />
db.results.ensureIndex( { ‘meta.url’ : 1 } )<br />
配置Nginx；</p><br />
</blockquote><br />
<br />
<p>Nginx需要加入两处配置，一是添加PHP_VALUE，告诉PHP程序在执行前要调用服务：</p><br />
<br />
<p>server {<br />
  listen 80;<br />
  server_name site.localhost;<br />
  root /Users/markstory/Sites/awesome-thing/app/webroot/;<br />
  fastcgi_param PHP_VALUE “auto_prepend_file=/Users/markstory/Sites/xhgui/external/header.php”;<br />
}<br />
另一个是需要配置一个路径指向5中安装的xhgui的webroot目录，如下配置是通过单独的域名来访问：</p><br />
<br />
<p>server {<br />
    listen       80;<br />
    server_name  blog110.it2048.cn;<br />
    root  /home/admin/xhgui/webroot;</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>location / {<br />
    index  index.php;<br />
    if (!-e $request_filename) {<br />
        rewrite . /index.php last;<br />
    }<br />
}<br />
<br />
location ~ \.php$ {<br />
    fastcgi_pass   127.0.0.1:9001;<br />
    fastcgi_index  index.php;<br />
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;<br />
    include        fastcgi_params;<br />
} }<br />
</code></pre></div></div><br />
<br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category php
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>