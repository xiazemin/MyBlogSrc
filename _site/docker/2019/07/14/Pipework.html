<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">Pipework、Weave、Flannel</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-07-14T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jul 14, 2019</time></p>
					</div>
					 <p>Docker跨主机容器间网络通信实现的工具有Pipework、Flannel、Weave、Open vSwitch（虚拟交换机）、Calico<br />
<!-- more --><br />
Weave的思路<br />
在每个宿主机上布置一个特殊的route的容器，不同宿主机的route容器连接起来。 route拦截所有普通容器的ip请求，并通过udp包发送到其他宿主机上的普通容器。这样在跨机的多个容器端看到的就是同一个扁平网络。 weave解决了网络问题，不过部署依然是单机的。</p><br />
<br />
<p>Flannel的思路<br />
Flannel是CoreOS团队针对Kubernetes设计的一个网络规划服务，简单来说，它的功能是让集群中的不同节点主机创建的Docker容器都具有全集群唯一的虚拟IP地址。但在默认的Docker配置中，每个节点上的Docker服务会分别负责所在节点容器的IP分配。这样导致的一个问题是，不同节点上容器可能获得相同的内外IP地址。并使这些容器之间能够之间通过IP地址相互找到，也就是相互ping通。Flannel设计目的就是为集群中所有节点重新规划IP地址的使用规则，从而使得不同节点上的容器能够获得”同属一个内网”且”不重复的”IP地址，并让属于不同节点上的容器能够直接通过内网IP通信。</p><br />
<br />
<p>Flannel实质上是一种”覆盖网络(overlay network)”，即表示运行在一个网上的网（应用层网络），并不依靠ip地址来传递消息，而是采用一种映射机制，把ip地址和identifiers做映射来资源定位。也就是将TCP数据包装在另一种网络包里面进行路由转发和通信，目前已经支持UDP、VxLAN、AWS VPC和GCE路由等数据转发方式。</p><br />
<br />
<p>Flannel 使用etcd存储配置数据和子网分配信息。flannel 启动之后，后台进程首先检索配置和正在使用的子网列表，然后选择一个可用的子网，然后尝试去注册它。etcd也存储这个每个主机对应的ip。flannel 使用etcd的watch机制监视/coreos.com/network/subnets下面所有元素的变化信息，并且根据它来维护一个路由表。为了提高性能，flannel优化了Universal TAP/TUN设备，对TUN和UDP之间的ip分片做了代理。</p><br />
<br />
<p>Flannel工作原理<br />
每个主机配置一个ip段和子网个数。例如，可以配置一个覆盖网络使用 10.100.0.0/16段，每个主机/24个子网。因此主机a可以接受10.100.5.0/24，主机B可以接受10.100.18.0/24的包。flannel使用etcd来维护分配的子网到实际的ip地址之间的映射。对于数据路径，flannel 使用udp来封装ip数据报，转发到远程主机。选择UDP作为转发协议是因为他能穿透防火墙。例如，AWS Classic无法转发IPoIP or GRE 网络包，是因为它的安全组仅仅支持TCP/UDP/ICMP。 Flannel工作原理流程图如下 (默认的节点间数据通信方式是UDP转发;  flannel默认使用8285端口作为UDP封装报文的端口，VxLan使用8472端口)</p><br />
<br />
<p>对上图的简单说明 (Flannel的工作原理可以解释如下)：<br />
-&gt; 数据从源容器中发出后，经由所在主机的docker0虚拟网卡转发到flannel0虚拟网卡，这是个P2P的虚拟网卡，flanneld服务监听在网卡的另外一端。<br />
-&gt; Flannel通过Etcd服务维护了一张节点间的路由表，该张表里保存了各个节点主机的子网网段信息。<br />
-&gt; 源主机的flanneld服务将原本的数据内容UDP封装后根据自己的路由表投递给目的节点的flanneld服务，数据到达以后被解包，然后直接进入目的节点的flannel0虚拟网卡，然后被转发到目的主机的docker0虚拟网卡，最后就像本机容器通信一样的由docker0路由到达目标容器。</p><br />
<br />
<p>这样整个数据包的传递就完成了，这里需要解释三个问题：<br />
1) UDP封装是怎么回事？<br />
在UDP的数据内容部分其实是另一个ICMP（也就是ping命令）的数据包。原始数据是在起始节点的Flannel服务上进行UDP封装的，投递到目的节点后就被另一端的Flannel服务<br />
还原成了原始的数据包，两边的Docker服务都感觉不到这个过程的存在。</p><br />
<br />
<p>2) 为什么每个节点上的Docker会使用不同的IP地址段？<br />
这个事情看起来很诡异，但真相十分简单。其实只是单纯的因为Flannel通过Etcd分配了每个节点可用的IP地址段后，偷偷的修改了Docker的启动参数。<br />
在运行了Flannel服务的节点上可以查看到Docker服务进程运行参数（ps aux|grep docker|grep “bip”），例如“–bip=182.48.25.1/24”这个参数，它限制了所在节<br />
点容器获得的IP范围。这个IP范围是由Flannel自动分配的，由Flannel通过保存在Etcd服务中的记录确保它们不会重复。</p><br />
<br />
<p>3) 为什么在发送节点上的数据会从docker0路由到flannel0虚拟网卡，在目的节点会从flannel0路由到docker0虚拟网卡？<br />
例如现在有一个数据包要从IP为172.17.18.2的容器发到IP为172.17.46.2的容器。根据数据发送节点的路由表，它只与172.17.0.0/16匹配这条记录匹配，因此数据从docker0<br />
出来以后就被投递到了flannel0。同理在目标节点，由于投递的地址是一个容器，因此目的地址一定会落在docker0对于的172.17.46.0/24这个记录上，自然的被投递到了docker0网卡。</p><br />
<br />
<p>pipework的思路<br />
pipework是一个单机的工具，组合了brctl等工具，可以认为pipework解决的是宿主机上的设置容器的虚拟网卡、网桥、ip等，可以配合其他网络使用。</p><br />
<br />
<p>如果容器数量不多，想简单的组一个大的3层网络，可以考虑weave<br />
如果容器数量很多，而且你们的环境复杂,需要多个子网，可以考虑open vswitch或者fannel<br />
weave的总体网络性能表现欠佳， flannel VXLAN 能满足要求，一般推荐用flannel</p><br />
<br />
<p>Flannel环境部署记录</p><br />
<br />
<p>1）机器环境（centos7系统）</p><br />
<br />
<p>1<br />
2<br />
182.48.115.233     部署etcd，flannel，docker      主机名：node-1   主控端（通过etcd）<br />
182.48.115.235     部署flannel，docker            主机名：node-2   被控端<br />
2）node-1（182.48.115.233）机器操作<br />
设置主机名及绑定hosts<br />
[root@node-1 ~]# hostnamectl –static set-hostname  node-1<br />
[root@node-1 ~]# vim /etc/hosts<br />
182.48.115.233    node-1<br />
182.48.115.233    etcd<br />
182.48.115.235    node-2</p><br />
<br />
<p>关闭防火墙，如果开启防火墙，则最好打开2379和4001端口<br />
[root@node-1 ~]# systemctl disable firewalld.service<br />
[root@node-1 ~]# systemctl stop firewalld.service</p><br />
<br />
<p>先安装docker环境<br />
[root@node-1 ~]# yum install -y docker</p><br />
<br />
<p>安装etcd<br />
k8s运行依赖etcd，需要先部署etcd，下面采用yum方式安装：<br />
[root@node-1 ~]# yum install etcd -y</p><br />
<br />
<p>yum安装的etcd默认配置文件在/etc/etcd/etcd.conf，编辑配置文件：<br />
[root@node-1 ~]# cp /etc/etcd/etcd.conf /etc/etcd/etcd.conf.bak<br />
[root@node-1 ~]# cat /etc/etcd/etcd.conf<br />
#[member]<br />
ETCD_NAME=master                                            #节点名称<br />
ETCD_DATA_DIR=”/var/lib/etcd/default.etcd”                  #数据存放位置<br />
#ETCD_WAL_DIR=””<br />
#ETCD_SNAPSHOT_COUNT=”10000”<br />
#ETCD_HEARTBEAT_INTERVAL=”100”<br />
#ETCD_ELECTION_TIMEOUT=”1000”<br />
#ETCD_LISTEN_PEER_URLS=”http://0.0.0.0:2380”<br />
ETCD_LISTEN_CLIENT_URLS=”http://0.0.0.0:2379,http://0.0.0.0:4001”             #监听客户端地址<br />
#ETCD_MAX_SNAPSHOTS=”5”<br />
#ETCD_MAX_WALS=”5”<br />
#ETCD_CORS=””<br />
#<br />
#[cluster]<br />
#ETCD_INITIAL_ADVERTISE_PEER_URLS=”http://localhost:2380”</p><br />
<h1 id="if-you-use-different-etcd_name-eg-test-set-etcd_initial_cluster-value-for-this-name-ie-testhttp">if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. “test=http://…”</h1><br />
<p>#ETCD_INITIAL_CLUSTER=”default=http://localhost:2380”<br />
#ETCD_INITIAL_CLUSTER_STATE=”new”<br />
#ETCD_INITIAL_CLUSTER_TOKEN=”etcd-cluster”<br />
ETCD_ADVERTISE_CLIENT_URLS=”http://etcd:2379,http://etcd:4001”           #通知客户端地址<br />
#ETCD_DISCOVERY=””<br />
#ETCD_DISCOVERY_SRV=””<br />
#ETCD_DISCOVERY_FALLBACK=”proxy”<br />
#ETCD_DISCOVERY_PROXY=””</p><br />
<br />
<p>启动etcd并验证状态<br />
[root@node-1 ~]# systemctl start etcd</p><br />
<br />
<p>[root@node-1 ~]# ps -ef|grep etcd<br />
etcd     28145     1  1 14:38 ?        00:00:00 /usr/bin/etcd –name=master –data-dir=/var/lib/etcd/default.etcd –listen-client-urls=http://0.0.0.0:2379,http://0.0.0.0:4001<br />
root     28185 24819  0 14:38 pts/1    00:00:00 grep –color=auto etcd<br />
[root@node-1 ~]# lsof -i:2379<br />
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME<br />
etcd    28145 etcd    6u  IPv6 1283822      0t0  TCP *:2379 (LISTEN)<br />
etcd    28145 etcd   18u  IPv6 1284133      0t0  TCP localhost:53203-&gt;localhost:2379 (ESTABLISHED)<br />
……..</p><br />
<br />
<p>[root@node-1 ~]# etcdctl set testdir/testkey0 0<br />
0<br />
[root@node-1 ~]# etcdctl get testdir/testkey0<br />
0<br />
[root@node-1 ~]# etcdctl -C http://etcd:4001 cluster-health<br />
member 8e9e05c52164694d is healthy: got healthy result from http://etcd:2379<br />
cluster is healthy<br />
[root@node-1 ~]# etcdctl -C http://etcd:2379 cluster-health<br />
member 8e9e05c52164694d is healthy: got healthy result from http://etcd:2379<br />
cluster is healthy</p><br />
<br />
<p>安装覆盖网络Flannel<br />
[root@node-1 ~]# yum install flannel</p><br />
<br />
<p>配置Flannel<br />
[root@node-1 ~]# cp /etc/sysconfig/flanneld /etc/sysconfig/flanneld.bak<br />
[root@node-1 ~]# vim /etc/sysconfig/flanneld</p><br />
<h1 id="flanneld-configuration-options">Flanneld configuration options</h1><br />
<br />
<h1 id="etcd-url-location--point-this-to-the-server-where-etcd-runs">etcd url location.  Point this to the server where etcd runs</h1><br />
<p>FLANNEL_ETCD_ENDPOINTS=”http://etcd:2379”</p><br />
<br />
<h1 id="etcd-config-key--this-is-the-configuration-key-that-flannel-queries">etcd config key.  This is the configuration key that flannel queries</h1><br />
<h1 id="for-address-range-assignment">For address range assignment</h1><br />
<p>FLANNEL_ETCD_PREFIX=”/atomic.io/network”</p><br />
<br />
<h1 id="any-additional-options-that-you-want-to-pass">Any additional options that you want to pass</h1><br />
<p>#FLANNEL_OPTIONS=””</p><br />
<br />
<p>配置etcd中关于flannel的key（这个只在安装了etcd的机器上操作）<br />
Flannel使用Etcd进行配置，来保证多个Flannel实例之间的配置一致性，所以需要在etcd上进行如下配置（’/atomic.io/network/config’这个key与上文/etc/sysconfig/flannel中的配置项FLANNEL_ETCD_PREFIX是相对应的，错误的话启动就会出错）：<br />
[root@node-1 ~]# etcdctl mk /atomic.io/network/config ‘{ “Network”: “182.48.0.0/16” }’<br />
{ “Network”: “182.48.0.0/16” }</p><br />
<br />
<p>温馨提示：上面flannel设置的ip网段可以任意设定，随便设定一个网段都可以。容器的ip就是根据这个网段进行自动分配的，ip分配后，容器一般是可以对外联网的（网桥模式，只要宿主机能上网就可以）</p><br />
<br />
<p>启动Flannel<br />
[root@node-1 ~]# systemctl enable flanneld.service<br />
[root@node-1 ~]# systemctl start flanneld.service<br />
[root@node-1 ~]# ps -ef|grep flannel<br />
root      9305  9085  0 09:12 pts/2    00:00:00 grep –color=auto flannel<br />
root     28876     1  0 May15 ?        00:00:07 /usr/bin/flanneld -etcd-endpoints=http://etcd:2379 -etcd-prefix=/atomic.io/network</p><br />
<br />
<p>启动Flannel后，一定要记得重启docker，这样Flannel配置分配的ip才能生效，即docker0虚拟网卡的ip会变成上面flannel设定的ip段<br />
[root@node-1 ~]# systemctl restart docker<br />
3）node-2（182.48.115.235）机器操作<br />
设置主机名及绑定hosts<br />
[root@node-2 ~]# hostnamectl –static set-hostname  node-2<br />
[root@node-2 ~]# vim /etc/hosts<br />
182.48.115.233    node-1<br />
182.48.115.233    etcd<br />
182.48.115.235    node-2</p><br />
<br />
<p>关闭防火墙，如果开启防火墙，则最好打开2379和4001端口<br />
[root@node-2 ~]# systemctl disable firewalld.service<br />
[root@node-2 ~]# systemctl stop firewalld.service</p><br />
<br />
<p>先安装docker环境<br />
[root@node-2 ~]# yum install -y docker</p><br />
<br />
<p>安装覆盖网络Flannel<br />
[root@node-2 ~]# yum install flannel</p><br />
<br />
<p>配置Flannel<br />
[root@node-2 ~]# cp /etc/sysconfig/flanneld /etc/sysconfig/flanneld.bak<br />
[root@node-2 ~]# vim /etc/sysconfig/flanneld</p><br />
<h1 id="flanneld-configuration-options-1">Flanneld configuration options</h1><br />
<br />
<h1 id="etcd-url-location--point-this-to-the-server-where-etcd-runs-1">etcd url location.  Point this to the server where etcd runs</h1><br />
<p>FLANNEL_ETCD_ENDPOINTS=”http://etcd:2379”</p><br />
<br />
<h1 id="etcd-config-key--this-is-the-configuration-key-that-flannel-queries-1">etcd config key.  This is the configuration key that flannel queries</h1><br />
<h1 id="for-address-range-assignment-1">For address range assignment</h1><br />
<p>FLANNEL_ETCD_PREFIX=”/atomic.io/network”</p><br />
<br />
<h1 id="any-additional-options-that-you-want-to-pass-1">Any additional options that you want to pass</h1><br />
<p>#FLANNEL_OPTIONS=””</p><br />
<br />
<p>启动Flannel<br />
[root@node-2 ~]# systemctl enable flanneld.service<br />
[root@node-2 ~]# systemctl start flanneld.service<br />
[root@node-2 ~]# ps -ef|grep flannel<br />
root      3841  9649  0 09:11 pts/0    00:00:00 grep –color=auto flannel<br />
root     28995     1  0 May15 ?        00:00:07 /usr/bin/flanneld -etcd-endpoints=http://etcd:2379 -etcd-prefix=/atomic.io/network</p><br />
<br />
<p>启动Flannel后，一定要记得重启docker，这样Flannel配置分配的ip才能生效，即docker0虚拟网卡的ip会变成上面flannel设定的ip段<br />
[root@node-2 ~]# systemctl restart docker<br />
4）创建容器，验证跨主机容器之间的网络联通性<br />
首先在node-1（182.48.115.233）上容器容器，如下，登陆容器发现已经按照上面flannel配置的分配了一个ip段（每个宿主机都会分配一个182.48.0.0/16的网段）</p><br />
<br />
<p>[root@node-1 ~]# docker run -ti -d –name=node-1.test docker.io/nginx /bin/bash<br />
5e403bf93857fa28b42c9e2abaa5781be4e2bc118ba0c25cb6355b9793dd107e<br />
[root@node-1 ~]# docker exec -ti node-1.test /bin/bash<br />
root@5e403bf93857:/# ip addr<br />
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default<br />
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br />
    inet 127.0.0.1/8 scope host lo<br />
       valid_lft forever preferred_lft forever<br />
    inet6 ::1/128 scope host<br />
       valid_lft forever preferred_lft forever<br />
2953: eth0@if2954: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1472 qdisc noqueue state UP group default<br />
    link/ether 02:42:b6:30:19:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br />
    inet 182.48.25.4/24 scope global eth0<br />
       valid_lft forever preferred_lft forever<br />
    inet6 fe80::42:b6ff:fe30:1904/64 scope link<br />
       valid_lft forever preferred_lft forever</p><br />
<br />
<p>接着在node-2（182.48.115.233）上容器容器<br />
[root@node-2 ~]# docker exec -ti node-2.test /bin/bash<br />
root@052a6a2a4a19:/# ip addr<br />
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default<br />
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br />
    inet 127.0.0.1/8 scope host lo<br />
       valid_lft forever preferred_lft forever<br />
    inet6 ::1/128 scope host<br />
       valid_lft forever preferred_lft forever<br />
10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1472 qdisc noqueue state UP group default<br />
    link/ether 02:42:b6:30:43:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0<br />
    inet 182.48.67.3/24 scope global eth0<br />
       valid_lft forever preferred_lft forever<br />
    inet6 fe80::42:b6ff:fe30:4303/64 scope link<br />
       valid_lft forever preferred_lft forever</p><br />
<br />
<p>root@052a6a2a4a19:/# ping 182.48.25.4<br />
PING 182.48.25.4 (182.48.25.4): 56 data bytes<br />
64 bytes from 182.48.25.4: icmp_seq=0 ttl=60 time=2.463 ms<br />
64 bytes from 182.48.25.4: icmp_seq=1 ttl=60 time=1.211 ms<br />
…….</p><br />
<br />
<p>root@052a6a2a4a19:/# ping www.baidu.com<br />
PING www.a.shifen.com (14.215.177.37): 56 data bytes<br />
64 bytes from 14.215.177.37: icmp_seq=0 ttl=51 time=39.404 ms<br />
64 bytes from 14.215.177.37: icmp_seq=1 ttl=51 time=39.437 ms<br />
…….</p><br />
<br />
<p>发现，在两个宿主机的容器内，互相ping对方容器的ip，是可以ping通的！也可以直接连接外网（桥接模式）</p><br />
<br />
<p>查看两台宿主机的网卡信息，发现docker0虚拟网卡的ip（相当于容器的网关）也已经变成了flannel配置的ip段，并且多了flannel0的虚拟网卡信息<br />
[root@node-1 ~]# ifconfig<br />
docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1472<br />
        inet 182.48.25.1  netmask 255.255.255.0  broadcast 0.0.0.0<br />
        inet6 fe80::42:31ff:fe0f:cf0f  prefixlen 64  scopeid 0x20<link /><br />
        ether 02:42:31:0f:cf:0f  txqueuelen 0  (Ethernet)<br />
        RX packets 48  bytes 2952 (2.8 KiB)<br />
        RX errors 0  dropped 0  overruns 0  frame 0<br />
        TX packets 31  bytes 2286 (2.2 KiB)<br />
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p><br />
<br />
<p>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500<br />
        inet 182.48.115.233  netmask 255.255.255.224  broadcast 182.48.115.255<br />
        inet6 fe80::5054:ff:fe34:782  prefixlen 64  scopeid 0x20<link /><br />
        ether 52:54:00:34:07:82  txqueuelen 1000  (Ethernet)<br />
        RX packets 10759798  bytes 2286314897 (2.1 GiB)<br />
        RX errors 0  dropped 40  overruns 0  frame 0<br />
        TX packets 21978639  bytes 1889026515 (1.7 GiB)<br />
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p><br />
<br />
<p>flannel0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1472<br />
        inet 182.48.25.0  netmask 255.255.0.0  destination 182.48.25.0<br />
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)<br />
        RX packets 12  bytes 1008 (1008.0 B)<br />
        RX errors 0  dropped 0  overruns 0  frame 0<br />
        TX packets 12  bytes 1008 (1008.0 B)<br />
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p><br />
<br />
<p>通过下面命令，可以查看到本机的容器的ip所在的范围<br />
[root@node-1 ~]# ps aux|grep docker|grep “bip”<br />
root      2080  0.0  1.4 796864 28168 ?        Ssl  May15   0:18 /usr/bin/dockerd-current –add-runtime docker-runc=/usr/libexec/docker/docker-runc-current –default-runtime=docker-runc –exec-opt native.cgroupdriver=systemd –userland-proxy-path=/usr/libexec/docker/docker-proxy-current –insecure-registry registry:5000 –bip=182.48.25.1/24 –ip-masq=true –mtu=1472</p><br />
<br />
<p>这里面的“–bip=182.48.25.1/24”这个参数，它限制了所在节点容器获得的IP范围。<br />
这个IP范围是由Flannel自动分配的，由Flannel通过保存在Etcd服务中的记录确保它们不会重复。<br />
==========================================================================<br />
温馨提示：<br />
如上面操作后，发现各容器内分配的ip之间相互ping不通，基本就是由于防火墙问题引起的！<br />
可是明明已经在前面部署的时候，通过”systemctl stop firewalld.service”关闭了防火墙，为什么还有防火墙问题？？<br />
这是因为linux还有底层的iptables，所以解决办法是在各节点上执行下面操作：</p><br />
<br />
<p>[root@node-1 ~]# iptables -P INPUT ACCEPT<br />
[root@node-1 ~]# iptables -P FORWARD ACCEPT<br />
[root@node-1 ~]# iptables -F<br />
[root@node-1 ~]# iptables -L -n</p><br />
<br />
<p>执行上面操作后，基本各容器间就能相互ping通了。<br />
docker通过Flannel可以实现各容器间的相互通信，即宿主机和容器，容器和容器之间都能相互通信。</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category docker
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>