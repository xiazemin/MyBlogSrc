<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">MINIT、RINIT、RSHUTDOWN、MSHUTDOWN加载顺序</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2020-01-07T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Jan 7, 2020</time></p>
					</div>
					 <p>php扩展里 <br />
PHP_MINIT_FUNCTION， <br />
PHP_MSHUTDOWN_FUNCTION，<br />
PHP_RINIT_FUNCTION<br />
PHP_RSHUTDOWN_FUNCTION 这4个函数的。<br />
发现在 php-fpm里执行的过程是这样的。</p><br />
<br />
<p>假设 一个静态变量 count_s ＝ 2；以上函数执行时会将值+1并打印到文件里。</p><br />
<br />
<p>(1) php-fpm 启动的时候 会执行PHP_MINIT_FUNCTION(3),然后执行PHP_MSHUTDOWN_FUNCTION(4)。</p><br />
<br />
<p>(2) 当一个请求来的时候，假设处理的是进程1，会执行 PHP_RINIT_FUNCTION(4), 然后执行PHP_RSHUTDOWN_FUNCTION(5).</p><br />
<br />
<p>(3) 如果第二请求来了，假设处理的是进程2，命中了另外一个进程则执行PHP_RINIT_FUNCTION(4), 然后执行PHP_RSHUTDOWN_FUNCTION(5).</p><br />
<br />
<p>(4) 第三个请求来了，如果处理的是进程1，则执行 PHP_RINIT_FUNCTION(6), 然后执行PHP_RSHUTDOWN_FUNCTION(7). 此时如果这个进程到达max_request 设置的最大请求数，则会消亡。此时会再次执行一个PHP_MSHUTDOWN_FUNCTION(8)。</p><br />
<br />
<p>(5) 如果手动执行 killall php-fpm 干掉php-fpm进程，则会执行一次PHP_MSHUTDOWN_FUNCTION(4)。<br />
<!-- more --><br />
PHP开始执行以后会经过两个主要的阶段：<br />
处理请求之前的开始阶段</p><br />
<br />
<p>请求之后的结束阶段</p><br />
<br />
<p>开始阶段有两个过程：</p><br />
<br />
<p>第一个过程是模块初始化阶段（MINIT）， 在整个SAPI生命周期内（例如Apache启动以后的整个生命周期内或者命令行程序整个执行过程中）， 该过程只进行一次。</p><br />
<br />
<p>第二个过程是模块激活阶段（RINIT），该过程发生在请求阶段， 例如通过url请求某个页面，则在每次请求之前都会进行模块激活（RINIT请求开始）。 例如PHP注册了一些扩展模块，则在MINIT阶段会回调所有模块的MINIT函数。 模块在这个阶段可以进行一些初始化工作，例如注册常量，定义模块使用的类等等。</p><br />
<br />
<p>模块在实现时可以通过如下宏来实现这些回调函数：</p><br />
<br />
<p>PHP_MINIT_FUNCTION(myphpextension)<br />
{<br />
    // 注册常量或者类等初始化操作<br />
    return SUCCESS; <br />
}<br />
请求到达之后PHP初始化执行脚本的基本环境，例如创建一个执行环境，包括保存PHP运行过程中变量名称和值内容的符号表， 以及当前所有的函数以及类等信息的符号表。然后PHP会调用所有模块的RINIT函数， 在这个阶段各个模块也可以执行一些相关的操作，模块的RINIT函数和MINIT回调函数类似：</p><br />
<br />
<p>PHP_RINIT_FUNCTION(myphpextension)<br />
{<br />
    // 例如记录请求开始时间<br />
    // 随后在请求结束的时候记录结束时间。这样我们就能够记录下处理请求所花费的时间了<br />
    return SUCCESS; <br />
}<br />
请求处理完后就进入了结束阶段，一般脚本执行到末尾或者通过调用exit()或die()函数， PHP都将进入结束阶段。和开始阶段对应，结束阶段也分为两个环节，一个在请求结束后停用模块(RSHUTDOWN，对应RINIT)， 一个在SAPI生命周期结束（Web服务器退出或者命令行脚本执行完毕退出）时关闭模块(MSHUTDOWN，对应MINIT)。</p><br />
<br />
<p>PHP_RSHUTDOWN_FUNCTION(myphpextension)<br />
{<br />
    // 例如记录请求结束时间，并把相应的信息写入到日至文件中。<br />
    return SUCCESS; <br />
}</p><br />
<br />
<p>PHP开始执行以后会经过两个主要的阶段：<br />
处理请求之前的开始阶段</p><br />
<br />
<p>请求之后的结束阶段</p><br />
<br />
<p>开始阶段有两个过程：</p><br />
<br />
<p>第一个过程是模块初始化阶段（MINIT）， 在整个SAPI生命周期内（例如Apache启动以后的整个生命周期内或者命令行程序整个执行过程中）， 该过程只进行一次。</p><br />
<br />
<p>第二个过程是模块激活阶段（RINIT），该过程发生在请求阶段， 例如通过url请求某个页面，则在每次请求之前都会进行模块激活（RINIT请求开始）。 例如PHP注册了一些扩展模块，则在MINIT阶段会回调所有模块的MINIT函数。 模块在这个阶段可以进行一些初始化工作，例如注册常量，定义模块使用的类等等。</p><br />
<br />
<p>模块在实现时可以通过如下宏来实现这些回调函数：</p><br />
<br />
<p>PHP_MINIT_FUNCTION(myphpextension)</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 注册常量或者类等初始化操作<br />
<br />
return SUCCESS; <br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>请求到达之后PHP初始化执行脚本的基本环境，例如创建一个执行环境，包括保存PHP运行过程中变量名称和值内容的符号表， 以及当前所有的函数以及类等信息的符号表。然后PHP会调用所有模块的RINIT函数， 在这个阶段各个模块也可以执行一些相关的操作，模块的RINIT函数和MINIT回调函数类似：</p><br />
<br />
<p>PHP_RINIT_FUNCTION(myphpextension)</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 例如记录请求开始时间<br />
<br />
// 随后在请求结束的时候记录结束时间。这样我们就能够记录下处理请求所花费的时间了<br />
<br />
return SUCCESS; <br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>请求处理完后就进入了结束阶段，一般脚本执行到末尾或者通过调用exit()或die()函数， PHP都将进入结束阶段。和开始阶段对应，结束阶段也分为两个环节，一个在请求结束后停用模块(RSHUTDOWN，对应RINIT)， 一个在SAPI生命周期结束（Web服务器退出或者命令行脚本执行完毕退出）时关闭模块(MSHUTDOWN，对应MINIT)。</p><br />
<br />
<p>PHP_RSHUTDOWN_FUNCTION(myphpextension)</p><br />
<br />
<p>{</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// 例如记录请求结束时间，并把相应的信息写入到日至文件中。<br />
<br />
return SUCCESS; <br />
</code></pre></div></div><br />
<br />
<p>}</p><br />
<br />
<p>PHP程序的启动可以看作有两个概念上的启动，终止也有两个概念上的终止。 其中一个是 PHP 作为Apache(拿它举例，板砖勿扔)的一个模块的启动与终止， 这次启动 PHP 会初始化一些必要数据，比如与宿主 Apache 有关的，并且这些数据是常驻内存的，终止与之相对。还有一个概念上的启动就是当 Apache 分配一个页面请求过来的时候，PHP会有一次启动与终止，这也是我们最常讨论的一种。 现在我们主要来看一个 PHP 扩展的生命旅程是怎样走完这四个过程的。 在最初初始化的时候，就是 PHP 随着 Apache 的启动而诞生在内存里的时候，它会把自己所有已加载扩展的 MINIT 方法(全称 Module Initialization，是由每个模块自己定义的函数)都执行一遍。在这个时间里，扩展可以定义一些自己的常量、类、资源等所有会被用户端的 PHP 脚本用到的东西。但你要记住，这里定义的东西都会随着 Apache 常驻内存，可以被所有请求使用，直到 Apache 卸载掉 PHP 模块。 内核中预置了 PHP_MINIT_FUNCTION 宏函数，来帮助我们实现这个功能：<br />
1<br />
//抛弃作者那个例子，书才看两页整那样的例子太复杂了!<br />
2<br />
//walu是我扩展的名称<br />
3<br />
int time_of_minit; // 在MINIT()中初始化，在每次页面请求中输出，看看是否变化<br />
4<br />
PHP_MINIT_FUNCTION(walu)<br />
5<br />
{<br />
6<br />
    time_of_minit=time(NULL); //我们在MINIT启动中对它初始化<br />
7<br />
    return SUCCESS; //返回SUCCESS代表正常，返回FALIURE就不会加载这个扩展了。<br />
8<br />
}<br />
当一个页面请求到来时候，PHP 会迅速开辟一个新的环境，并重新扫描自己的各个扩展，遍历执行它们各自的RINIT 方法(俗称 Request Initialization)，这时候一个扩展可能会初始化在本次请求中会使用到的变量等， 还会初始化用户端（即 PHP 脚本）中的变量之类的，内核预置了 PHP_RINIT_FUNCTION() 这个宏函数来帮我们实现这个功能：<br />
1<br />
int time_of_rinit; //在RINIT里初始化，看看每次页面请求的时候是否变化。<br />
2<br />
PHP_RINIT_FUNCTION(walu)<br />
3<br />
{<br />
4<br />
    time_of_rinit=time(NULL);<br />
5<br />
    return SUCCESS;<br />
6<br />
}<br />
好了，现在这个页面请求执行的差不多了，可能是顺利的走到了自己文件的最后，也可能是出师未捷，半道被用户给 die 或者 exit 了， 这时候 PHP 便会启动回收程序，收拾这个请求留下的烂摊子。它这次会执行所有已加载扩展的 RSHUTDOWN（俗称 Request Shutdown）方法， 这时候扩展可以抓紧利用内核中的变量表之类的做一些事情， 因为一旦 PHP 把所有扩展的 RSHUTDOWN 方法执行完， 便会释放掉这次请求使用过的所有东西， 包括变量表的所有变量、所有在这次请求中申请的内存等等。 内核预置了 PHP_RSHUTDOWN_FUNCTION 宏函数来帮助我们实现这个功能<br />
1<br />
PHP_RSHUTDOWN_FUNCTION(walu)<br />
2<br />
{<br />
3<br />
    FILE *fp=fopen(“time_rshutdown.txt”,”a+”);<br />
4<br />
    fprintf(fp,”%ld\n”,time(NULL)); //让我们看看是不是每次请求结束都会在这个文件里追加数据<br />
5<br />
    fclose(fp);<br />
6<br />
    return SUCCESS;<br />
7<br />
}<br />
前面该启动的也启动了，该结束的也结束了，现在该 Apache 老人家歇歇的时候，当 Apache 通知 PHP 自己要 Stop 的时候，PHP 便进入 MSHUTDOWN（俗称Module Shutdown）阶段。这时候 PHP 便会给所有扩展下最后通牒，如果哪个扩展还有未了的心愿，就放在自己 MSHUTDOWN 方法里，这可是最后的机会了，一旦 PHP 把扩展的 MSHUTDOWN 执行完，便会进入自毁程序，这里一定要把自己擅自申请的内存给释放掉，否则就杯具了。 内核中预置了 PHP_MSHUTDOWN_FUNCTION 宏函数来帮助我们实现这个功能：<br />
1<br />
PHP_MSHUTDOWN_FUNCTION(walu)<br />
2<br />
{<br />
3<br />
    FILE *fp=fopen(“time_mshutdown.txt”,”a+”);<br />
4<br />
    fprintf(fp,”%ld\n”,time(NULL));<br />
5<br />
    return SUCCESS;<br />
6<br />
}<br />
这四个宏都是在 walu.c 里完成最终实现的，而他们的则是在 /main/php.h 里被定义的(其实也是调用的别的宏，本节最后我把这几个宏给展开了，供有需要的人查看)。 好了，现在我们本节内容说完了，下面我们把所有的代码合在一起，并预测一下应该出现的结果：<br />
1<br />
//这些代码都在walu.c里面，不在.h里<br />
2<br />
​<br />
3<br />
int time_of_minit; //在MINIT中初始化，在每次页面请求中输出，看看是否变化<br />
4<br />
PHP_MINIT_FUNCTION(walu)<br />
5<br />
{<br />
6<br />
    time_of_minit=time(NULL); //我们在MINIT启动中对他初始化<br />
7<br />
    return SUCCESS;<br />
8<br />
}<br />
9<br />
​<br />
10<br />
int time_of_rinit;//在RINIT里初始化，看看每次页面请求的时候是否变化。<br />
11<br />
PHP_RINIT_FUNCTION(walu)<br />
12<br />
{<br />
13<br />
    time_of_rinit=time(NULL);<br />
14<br />
    return SUCCESS;<br />
15<br />
}<br />
16<br />
​<br />
17<br />
PHP_RSHUTDOWN_FUNCTION(walu)<br />
18<br />
{<br />
19<br />
    FILE *fp=fopen(“/cnan/www/erzha/time_rshutdown.txt”,”a+”); //请确保文件可写，否则apache会莫名崩溃<br />
20<br />
    fprintf(fp,”%d\n”,time(NULL)); //让我们看看是不是每次请求结束都会在这个文件里追加数据<br />
21<br />
    fclose(fp);<br />
22<br />
    return SUCCESS;<br />
23<br />
}<br />
24<br />
​<br />
25<br />
PHP_MSHUTDOWN_FUNCTION(walu)<br />
26<br />
{<br />
27<br />
    FILE *fp=fopen(“/cnan/www/erzha/time_mshutdown.txt”,”a+”); //请确保文件可写，否则apache会莫名崩溃<br />
28<br />
    fprintf(fp,”%d\n”,time(NULL));<br />
29<br />
    return SUCCESS;<br />
30<br />
}<br />
31<br />
​<br />
32<br />
//我们在页面里输出time_of_minit和time_of_rinit的值<br />
33<br />
PHP_FUNCTION(walu_test)<br />
34<br />
{<br />
35<br />
    php_printf(“%d&lt;br /&gt;“,time_of_minit);<br />
36<br />
    php_printf(“%d&lt;br /&gt;“,time_of_rinit);<br />
37<br />
    return;<br />
38<br />
}<br />
time_of_minit 的值每次请求都不变。<br />
time_of_rinit 的值每次请求都改变。<br />
每次页面请求结束都会往 time_rshutdown.txt 中写入数据。<br />
只有在 Apache 结束后 time_mshutdown.txt 才写入有数据。<br />
启动模式<br />
一个 PHP 实例，无论通过 HTTP 请求调用的，还是从命令行启动的，都会依次进行 Module init、Request init、Request Shutdown、Module shutdown 四个过程， 当然之间还会执行脚本自己的逻辑。 那么两种 init 和两种 shutdown 各会执行多少次、各自的执行频率有多少呢？这取决于 PHP 是用什么 SAPI 与宿主通信的。最常见的四种方式如下所列：<br />
直接以 CLI/CGI 模式调用<br />
多进程模式<br />
多线程模式<br />
Embedded(嵌入式，在自己的 C 程序中调用 Zend Engine)<br />
CLI/CGI<br />
CLI 和 CGI 的 SAPI 是相当特殊的，因为这时 PHP 的生命周期完全在一个单独的请求中完成。虽然简单，不过我们以前提过的两种 init 和两种 shutdown 仍然都会被执行。下图展示了PHP在这种模式下是怎么工作的：<br />
<img src="https://xiazemin.github.io/MyBlog/img/clicgi.jpeg" /></p><br />
<br />
<p>多进程模式<br />
ps:书是2006年出版的，所以你应该理解作者说多进程是主流<br />
PHP 最常见的工作方式便是编译成为 Apache2 的 Pre-fork MPM 或者 Apache1 的 APXS 模式，其它 Web 服务器也大多用相同的方式工作，在本书后面，把这种方式统一叫做多进程方式。给它起这个名字是有原因的，不是随便拍拍屁股拍拍脑袋定下来的。当 Apache 启动的时候，会立即把自己 fork 出好几个子进程，每一个进程都有自己独立的内存空间， 也就代表了有自己独立的变量、函数等。在每个进程里的PHP的工作方式如下图所示<br />
<img src="https://xiazemin.github.io/MyBlog/img/multiprocess.jpeg" /></p><br />
<br />
<p>因为是 fork 出来的，所以各个进程间的数据是彼此独立，不会受到外界的干扰（ps：fork 后可以用管道等方式实现进程间通信）。这是一片独立天地，它允许每个子进程做任何事情<br />
多线程模式<br />
随着时代的进步，PHP 越来越多地在多线程模式下工作，就像 IIS 的 isapi 和 Apache MPM worker（支持混合的多线程多进程的多路处理模块）。在这种模式下，只有一个服务器进程在运行着，但会同时运行很多线程，这样可以减少一些资源开销，像 Module init 和 Module shutdown 就只需要运行一次就行了，一些全局变量也只需要初始化一次，因为线程独具的特质，使得各个请求之间方便的共享一些数据成为可能。<br />
https://xueyuanjun.com/link/7152#bkmrk-%E5%85%B6%E5%AE%9E%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B8%8E-minit%E3%80%81mshutdo</p><br />
<br />
<p>其实多线程与 MINIT、MSHUTDOWN 只执行一次并没有什么联系，多进程模式下一样可以实现。</p><br />
<br />
<p>Embed<br />
Embed SAPI 是一种比较特殊的 SAPI，容许你在 C/C++ 语言中调用 PHP/ZE 提供的函数。并且这种 SAPI 和上面的三种一样，按 Module Init、Request Init、Rshutdown、mshutdown 的流程执行着。 当然，这只是其中一种情况。因为特定的应用有自己特殊的需求，只是在处理 PHP 脚本这个环节基本一致。 真正令 Emebed 模式独特的是因为它可能随时嵌入到某个程序里面去(比如你的 test.exe 里)， 然后被当作脚本的一部分在一个请求的时候执行。控制权在 PHP 和原程序间来回传递。关于嵌入式的 PHP 在第20章会有应用，到时我们再用实例介绍这个不经常使用的 SAPI。</p><br />
<br />
<p>看过PHP源码或者扩展开发相关资料的都知道PHP扩展的几个关键函数，或者叫生命周期<br />
PHP_MINIT<br />
PHP_RINIT<br />
PHP_RSHUTDOWN<br />
PHP_MSHUTDOWN</p><br />
<br />
<p>其中PHP_MINIT 是php启动的时候加载扩展的时候会调用的函数 ， 这个宏展开后其实真的就是定义了一个这样的C函数</p><br />
<br />
<p>zm_startup_##module(…){…}</p><br />
<br />
<p>那么这个在扩展的代码里定义的C函数是如何被执行的呢? 接下来，我们还会发现，每个扩展都有一个zend_module_entry 的结构体定义</p><br />
<br />
<p>例如swoole的扩展 zend_module_entry 定义如下</p><br />
<br />
<p>zend_module_entry swoole_module_entry =<br />
{<br />
#if ZEND_MODULE_API_NO &gt;= 20050922<br />
    STANDARD_MODULE_HEADER_EX,<br />
    NULL,<br />
    NULL,<br />
#else<br />
    STANDARD_MODULE_HEADER,<br />
#endif<br />
    “swoole”,<br />
    swoole_functions,<br />
    PHP_MINIT(swoole),<br />
    PHP_MSHUTDOWN(swoole),<br />
    PHP_RINIT(swoole),     //RINIT<br />
    PHP_RSHUTDOWN(swoole), //RSHUTDOWN<br />
    PHP_MINFO(swoole),<br />
    PHP_SWOOLE_VERSION,<br />
    STANDARD_MODULE_PROPERTIES<br />
};<br />
定义这么一个结构体就加载了吗？ 显然是不能的，php源码在编写的时候又不知道你要定义什么扩展。 关键点就在下面的代码，每个扩展还会有这么一句代码</p><br />
<br />
<p>ZEND_GET_MODULE(swoole)</p><br />
<br />
<p>//上面这个宏展开后其实是个函数 ， 以swoole为例，这个函数就是返回上面定义的 swoole_module_entry  这个结构体<br />
zend_module_entry *get_module(void) { return &amp;name##_module_entry; }<br />
大概总结下流程<br />
1.扩展会提供一个 get_module(void)的方法拿到扩展的 zend_module_entry 结构体的定义</p><br />
<br />
<p>扩展被编译成so文件后，在php.ini文件中配置 xxx.so， 表示加载扩展<br />
php 启动的时候会读php.ini 文件，并做解析<br />
4.在linux下 通过 dlopen()打开扩展的xxx.so库文件<br />
通过系统的 dlsym()获取动态库中get_module()函数的地址，执行每个扩展的get_module方法拿到 zend_module_entry 结构体<br />
把zend_module_entry 结构体注册到php的 extension_lists 扩展列表中<br />
7.在php的生生命周期中执行各个扩展定义的PHP_MINIT<br />
上面是个执行流程的总结，下面进行源码求证</p><br />
<br />
<p>看源码很容易在php启动的时候找到这个函数执行 php_module_startup()</p><br />
<br />
<p>int php_module_startup(sapi_module_struct *sf, zend_module_entry *additional_modules, uint num_additional_modules)<br />
{<br />
    …<br />
    //根据php.ini注册扩展<br />
    php_ini_register_extensions();</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>... } 动态库就是在php_ini_register_extensions()这个函数中完成的注册：<br />
</code></pre></div></div><br />
<br />
<p>//main/php_ini.c<br />
void php_ini_register_extensions(void)<br />
{<br />
    //注册zend扩展<br />
    zend_llist_apply(&amp;extension_lists.engine, php_load_zend_extension_cb);<br />
    //注册php扩展<br />
    zend_llist_apply(&amp;extension_lists.functions, php_load_php_extension_cb);</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zend_llist_destroy(&amp;extension_lists.engine);<br />
zend_llist_destroy(&amp;extension_lists.functions); } extension_lists是一个链表，保存着根据php.ini中定义的extension=xxx.so取到的全部扩展名称，其中engine是zend扩展，functions为php扩展，依次遍历这两个数组然后调用php_load_php_extension_cb()或php_load_zend_extension_cb()进行各个扩展的加载：<br />
</code></pre></div></div><br />
<br />
<p>static void php_load_php_extension_cb(void <em>arg)<br />
{<br />
#ifdef HAVE_LIBDL<br />
    php_load_extension(</em>((char **) arg), MODULE_PERSISTENT, 0);<br />
#endif<br />
}<br />
HAVE_LIBDL这个宏根据dlopen()函数是否存在设置的：</p><br />
<br />
<p>#Zend/Zend.m4<br />
AC_DEFUN([LIBZEND_LIBDL_CHECKS],[<br />
AC_CHECK_LIB(dl, dlopen, [LIBS=”-ldl $LIBS”])<br />
AC_CHECK_FUNC(dlopen,[AC_DEFINE(HAVE_LIBDL, 1,[ ])])<br />
])<br />
接着就是最关键的操作了，php_load_extension()：</p><br />
<br />
<p>//ext/standard/dl.c<br />
PHPAPI int php_load_extension(char <em>filename, int type, int start_now)<br />
{<br />
    void *handle;<br />
    char *libpath;<br />
    zend_module_entry *module_entry;<br />
    zend_module_entry *(</em>get_module)(void);<br />
    …<br />
    //调用dlopen打开指定的动态连接库文件：xx.so<br />
    handle = DL_LOAD(libpath); <br />
    …<br />
    //调用dlsym获取get_module的函数指针<br />
    get_module = (zend_module_entry <em>(</em>)(void)) DL_FETCH_SYMBOL(handle, “get_module”); <br />
    …<br />
    //调用扩展的get_module()函数<br />
    module_entry = get_module();<br />
    …<br />
    //检查扩展使用的zend api是否与当前php版本一致<br />
    if (module_entry-&gt;zend_api != ZEND_MODULE_API_NO) {<br />
        DL_UNLOAD(handle);<br />
        return FAILURE;<br />
    }<br />
    …<br />
    module_entry-&gt;type = type;<br />
    //为扩展编号<br />
    module_entry-&gt;module_number = zend_next_free_module();<br />
    module_entry-&gt;handle = handle;</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ((module_entry = zend_register_module_ex(module_entry)) == NULL) {<br />
    DL_UNLOAD(handle);<br />
    return FAILURE;<br />
}<br />
... } DL_LOAD()、DL_FETCH_SYMBOL()这两个宏在linux下展开后就是：dlopen()、dlsym()，所以上面过程的实现就比较直观了<br />
</code></pre></div></div><br />
<br />
<p>PHP的最多的两种运行模式是WEB模式、CLI模式。<br />
无论哪种模式，PHP工作原理都是一样的，作为一种SAPI运行。<br />
1、当我们在终端敲入php这个命令的时候，它使用的是CLI。<br />
它就像一个web服务器一样来支持php完成这个请求，请求完成后再重新把控制权交给终端。</p><br />
<br />
<p>2、当使用Apache作为宿主时，当一个请求到来时，PHP会来支持完成这个请求。</p><br />
<br />
<p>main/php.h中定义了以下几个宏</p><br />
<br />
<p>#define PHP_MINIT_FUNCTION		ZEND_MODULE_STARTUP_D<br />
#define PHP_MSHUTDOWN_FUNCTION	ZEND_MODULE_SHUTDOWN_D<br />
#define PHP_RINIT_FUNCTION		ZEND_MODULE_ACTIVATE_D<br />
#define PHP_RSHUTDOWN_FUNCTION	ZEND_MODULE_DEACTIVATE_D<br />
#define PHP_MINFO_FUNCTION		ZEND_MODULE_INFO_D<br />
#define PHP_GINIT_FUNCTION		ZEND_GINIT_FUNCTION<br />
#define PHP_GSHUTDOWN_FUNCTION	ZEND_GSHUTDOWN_FUNCTION</p><br />
<br />
<p>对应的作用是<br />
PHP_MINIT_FUNCTION	初始化module时运行<br />
PHP_MSHUTDOWN_FUNCTION	当module被卸载时运行<br />
PHP_RINIT_FUNCTION	当一个REQUEST请求初始化时运行<br />
PHP_RSHUTDOWN_FUNCTION	当一个REQUEST请求结束时运行<br />
PHP_MINFO_FUNCTION	这个是设置phpinfo中这个模块的信息<br />
PHP_GINIT_FUNCTION	初始化全局变量时<br />
PHP_GSHUTDOWN_FUNCTION	释放全局变量时</p><br />
<br />
<p>看一个自定义扩展案例片段：<br />
int minit_time;<br />
PHP_MINIT_FUNCTION(test)<br />
{<br />
	minit_time = time(NULL);<br />
	return SUCCESS;<br />
}</p><br />
<br />
<p>PHP_MSHUTDOWN_FUNCTION(test)<br />
{<br />
	FILE *fp=fopen(“mshutdown.txt”,”a+”);<br />
	fprintf(fp,”%ld\n”,time(NULL));//让我们看看是不是每次请求结束都会在这个文件里追加数据<br />
	fclose(fp);<br />
	return SUCCESS;<br />
}</p><br />
<br />
<p>int rinit_time;<br />
PHP_RINIT_FUNCTION(test)<br />
{<br />
	rinit_time = time(NULL);<br />
	return SUCCESS;<br />
}</p><br />
<br />
<p>PHP_RSHUTDOWN_FUNCTION(test)<br />
{<br />
	FILE *fp=fopen(“rshutdown.txt”,”a+”);<br />
	fprintf(fp,”%ld\n”,time(NULL));//让我们看看是不是每次请求结束都会在这个文件里追加数据<br />
	fclose(fp);<br />
	return SUCCESS;<br />
}</p><br />
<br />
<p>PHP_MINFO_FUNCTION(test)<br />
{<br />
	php_info_print_table_start();//调用php_write输出HTML标签<br />
	php_info_print_table_header(2, “module info”, “enabled”);<br />
	php_info_print_table_end();//调用php_write输出HTML标签</p><br />
<br />
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* Remove comments if you have entries in php.ini<br />
DISPLAY_INI_ENTRIES();<br />
*/ }<br />
</code></pre></div></div><br />
<br />
<p>//定义PHP中可以调用的函数test(),让它在页面里输出minit_time和rinit_time的值<br />
PHP_FUNCTION(test)<br />
{<br />
	php_printf(“%d<br />“,time_of_minit);<br />
	php_printf(“%d<br />“,time_of_rinit);<br />
	return;<br />
}</p><br />
<br />
<p>以Apache为例，<br />
如果在多线程的模式下工作：<br />
在这种模式下，只有一个服务器进程在运行着，但会同时运行很多线程，这样可以减少一些资源开销，向Module init和Module shutdown就只需要运行一遍就行了，一些全局变量也只需要初始化一次，因为线程独具的特质，使得各个请求之间方便的共享一些数据成为可能。</p><br />
<br />
<p>如果在多进程的模式下工作：</p><br />
<br />
<p>minit_time、rinit_time的值每次请求都在变。<br />
每次页面请求结束都会往time_rshutdown.txt、time_mshutdown.txt中写入数据。</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category lang
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>