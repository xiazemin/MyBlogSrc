<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">pid 文件作用</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2019-05-26T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 26, 2019</time></p>
					</div>
					 <p>打开系统(Linux) 的 “/var/run/” 目录可以看到有很多已 “.pid” 为结尾的文件<br />
这些文件只有一行，它记录的是相应进程的 pid，即进程号。所以通过 pid 文件可以很方便的得到一个进程的 pid，然后做相应的操作，比如检测、关闭。<br />
重要的作用，那就是防止进程启动多个副本。通过文件锁，可以保证一时间内只有一个进程能持有这个文件的写权限，所以在程序启动的检测逻辑中加入获取pid 文件锁并写pid文件的逻辑就可以防止重复启动进程的多个副本了。<br />
<!-- more --><br />
/var/run是干什么用的<br />
根据linux的文件系统分层结构标准（FHS）中的定义：</p><br />
<br />
<p>/var/run 目录中存放的是自系统启动以来描述系统信息的文件。<br />
比较常见的用途是daemon进程将自己的pid保存到这个目录。<br />
标准要求这个文件夹中的文件必须是在系统启动的时候清空，以便建立新的文件。<br />
为了达到这个要求，linux中/var/run使用的是tmpfs文件系统，这是一种存储在内存中的临时文件系统，当机器关闭的时候，文件系统自然就被清空了。使用df -Th命令能看到类似的输出结果:</p><br />
<br />
<p>文件系统    类型    容量  已用  可用 已用%% 挂载点<br />
none         tmpfs    990M  384K  989M   1% /var/run<br />
none         tmpfs    990M     0  990M   0% /var/lock<br />
当然/var/run除了保存进程的pid之外也有其他的作用，比如utmp文件，就是用来记录机器的启动时间以及当前登陆用户的。</p><br />
<br />
<p>linux系统中/var/run/目录下的*.pid文件是一个文本文件，其内容只有一行，即某个进程的PID。.pid文件的作用是防止进程启动多个副本，只有获得特定pid文件（固定路径和文件名）的写入权限（F_WRLCK）的进程才能正常启动并将自身的进程PID写入该文件，其它同一程序的多余进程则自动退出。</p><br />
<br />
<p>编程实现：</p><br />
<br />
<p>调用fcntl()系统调用设置指定的pid文件为F_WRLCK锁状态，如果锁成功则写入当前进程的PID，进程继续往下执行；如果上锁失败则说明已经有同样的进程在运行了，当前进程退出。<br />
#define PID_FILE “/var/run/xxxx.pid”<br />
int lock_file(int fd)<br />
{<br />
  struct flock fl;<br />
  fl.l_type = F_WRLCK;<br />
  fl.l_start = 0;<br />
  fl.l_whence = SEEK_SET;<br />
  fl.l_len = 0;<br />
  return (fcntl(fd, F_SETLK, &amp;fl));<br />
}<br />
int alone_runnind(void)<br />
{<br />
  int fd;<br />
  char buf[16];<br />
  fd = open(PID_FILE, O_RDWR | O_CREAT, 0666);<br />
  if (fd &lt; 0)<br />
  {<br />
    perror(“open”);<br />
    exit(1);<br />
  }<br />
  if (lock_file(fd) &lt; 0)<br />
  {<br />
    if (errno == EACCESS || errno == EAGAIN)<br />
    {<br />
      close(fd);<br />
      printf(“alone runnind\n”);<br />
      return -1;<br />
    }<br />
    printf(“can’t lock %s: %s\n”, PID_FILE, strerror(errno));<br />
  }<br />
  ftruncate(fd, 0);  //设置文件的大小为0<br />
  sprintf(buf, “%ld”, (long)getpid());<br />
  write(fd, buf, strlen(buf) + 1);<br />
  return 0;<br />
}<br />
需要注意：</p><br />
<br />
<p>1.程退出后该进程加的锁自动失效；<br />
2.进程关闭了该文件描述符fd，则加的锁失效。（所以整个进程生命周期内不能关闭该fd）；<br />
3.锁的状态不会被子进程继承，如果进程关闭则失效而不管子进程是否运行。</p><br />
<br />
<p>下面介绍下Linux下/var/run目录下的pid文件作用</p><br />
<br />
<p>在Linux系统的目录/var/run下面一般我们都会看到很多的*.pid文件。而且往往新安装的程序在运行后也会在/var/run目录下面产生自己的pid文件。那么这些pid文件有什么作用呢？它的内容又是什么呢？</p><br />
<br />
<p>(1) pid文件的内容：pid文件为文本文件，内容只有一行, 记录了该进程的ID。</p><br />
<br />
<p>用cat命令可以看到。</p><br />
<br />
<p>(2) pid文件的作用：防止进程启动多个副本。只有获得pid文件(固定路径固定文件名)写入权限(F_WRLCK)的进程才能正常启动并把自身的PID写入该文件中。其它同一个程序的多余进程则自动退出。</p><br />
<br />
<p>(3) 编程技巧：</p><br />
<br />
<p>调用fcntl设置pid文件的锁定F_SETLK状态，其中锁定的标志位F_WRLCK。</p><br />
<br />
<p>如果成功锁定，则写入进程当前PID，进程继续往下执行。</p><br />
<br />
<p>如果锁定不成功，说明已经有同样的进程在运行了，当前进程结束退出。<br />
lock.l_type = F_WRLCK;<br />
 lock.l_whence = SEEK_SET;</p><br />
<br />
<p>if (fcntl(fd, F_SETLK, &amp;lock) &lt; 0){<br />
  //锁定不成功, 退出……<br />
 }<br />
sprintf (buf, “%d\n”, (int) pid);<br />
 pidsize = strlen(buf);<br />
 if ((tmp = write (fd, buf, pidsize)) != (int)pidsize){<br />
  //写入不成功, 退出……<br />
 }<br />
 (4) 一些注意事项：</p><br />
<br />
<p>i) 如果进程退出，则该进程加的锁自动失效。<br />
ii) 如果进程关闭了该文件描述符fd， 则加的锁失效。(整个进程运行期间不能关闭此文件描述符)<br />
iii) 锁的状态不会被子进程继承。如果进程关闭则锁失效而不管子进程是否在运行。</p><br />
<br />
<p>l在linux系统的目录/var/run下面一般我们都会看到很多的*.pid文件。而且往往新安装的程序在运行后也会在/var/run目录下面产生自己的pid文件。那么这些pid文件有什么作用呢？它的内容又是什么呢？</p><br />
<br />
<p>(1) pid文件的内容：pid文件为文本文件，内容只有一行, 记录了该进程的ID。 <br />
用cat命令可以看到。 <br />
(2) pid文件的作用：防止进程启动多个副本。只有获得pid文件(固定路径固定文件名)写入权限(F_WRLCK)的进程才能正常启动并把自身的PID写入该文件中。其它同一个程序的多余进程则自动退出。</p><br />
<br />
<p>(3) 编程技巧： <br />
    调用fcntl设置pid文件的锁定F_SETLK状态，其中锁定的标志位F_WRLCK。 <br />
    如果成功锁定，则写入进程当前PID，进程继续往下执行。 <br />
    如果锁定不成功，说明已经有同样的进程在运行了，当前进程结束退出。</p><br />
<br />
<p>============ <br />
C代码  收藏代码<br />
lock.l_type = F_WRLCK;<br /><br />
lock.l_whence = SEEK_SET;</p><br />
<br />
<p>if (fcntl(fd, F_SETLK, &amp;lock) &lt; 0){<br /><br />
    //锁定不成功, 退出……<br /><br />
}<br /><br />
sprintf (buf, “%d\n”, (int) pid);<br /><br />
pidsize = strlen(buf);<br /><br />
if ((tmp = write (fd, buf, pidsize)) != (int)pidsize){<br /><br />
    //写入不成功, 退出……<br /><br />
}</p><br />
<br />
<p>(4) 一些注意事项： <br />
    i) 如果进程退出，则该进程加的锁自动失效。 <br />
    ii) 如果进程关闭了该文件描述符fd， 则加的锁失效。(整个进程运行期间不能关闭此文件描述符) <br />
    iii) 锁的状态不会被子进程继承。如果进程关闭则锁失效而不管子进程是否在运行。 <br />
(Locks are associated with processes. A process can only have one kind of lock set for each byte of a given file. When any file descriptor for that file is closed by the process, all of the locks that process holds on that file are released, even if the locks were made using other descriptors that remain open. Likewise, locks are released when a process exits, and are not inherited by child processes created using fork.)</p><br />
<br />
<p>(5) 参考资料： <br />
fcntl(文件锁) <br />
表头文件 #include <unistd.h> <br />
#include <fcntl.h> <br />
函数定义int fcntl(int fd, int cmd, struct flock *lock); <br />
函数解释fd:文件描写符 <br />
设置的文件描写符，参数cmd代表欲垄断的号召 <br />
F_DUPFD <br />
复制参数fd的文件描写符，厉行获胜则归来新复制的文件描写符， <br />
F_GETFD <br />
获得close-on-exec符号，若些符号的FD_CLOEXEC位为0，代表在调用 <br />
exec()相干函数时文件将不会关闭 <br />
F_SETFD 设置close-on-exec符号，该符号以参数arg的 FD_CLOEXEC位定夺 <br />
F_GETFL获得open()设置的符号 <br />
F_SETFL改换open()设置的符号 <br />
F_GETLK获得文件锁定的事态，依据lock的描写，定夺是否上文件锁 <br />
F_SETLK设置文件锁定的事态，此刻flcok，构造的l_tpye值定然是F_RDLCK、F_WRLCK或F_UNLCK， <br />
万一无法发生锁定，则归来-1 <br />
F_SETLKW 是F_SETLK的阻塞版本，在无法获得锁时会进去睡眠事态，万一能够获得锁可能捉拿到信号则归来 <br />
参数lock指针为flock构造指针定义如下 <br />
struct flock { <br />
... <br />
short l_typejngaoy.com; <br />
short l_whence; <br />
off_t l_start; 锁定区域的开关位置 <br />
off_t l_len; 锁定区域的大小 <br />
pid_t l_pid; 锁定动作的历程 <br />
... <br />
}; <br />
1_type有三种事态： <br />
F_RDLCK读取锁（分享锁） <br />
F_WRLCK写入锁（排斥锁） <br />
F_UNLCK解锁 <br />
l_whence也有三种措施 <br />
SEEK_SET以文件开始为锁定的起始位置 <br />
SEEK_CUR以现在文件读写位置为锁定的起始位置 <br />
SEEK_END以文件尾为锁定的起始位置 <br />
归来值 获胜则归来0，若有讹谬则归来-1 <br />
l_len:加锁区的长度 <br />
l_pid:具有阻塞目前历程的锁，其持有历程的历程号储藏在l_pid中，由F_GETLK归来 <br />
等闲是将l_start设置为0,l_whence设置为SEEK_SET,l_len设置为0</fcntl.h></unistd.h></p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category linux
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>