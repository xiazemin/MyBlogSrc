<!DOCTYPE html>
<html>

  <head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Sci blog jekyll theme">
    <meta name="author" content="AIR RAYA Group">
    <link href='/MyBlog/img/favicon.ico' type='image/icon' rel='shortcut icon'/>

    <title>泽民博客 | Jekyll theme</title>

    <link rel="stylesheet" href="/MyBlog/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="/MyBlog/css/font-awesome.min.css">
    <link href="/MyBlog/css/simple-sidebar.css" rel="stylesheet">
	<link href="/MyBlog/css/classic-10_7.css" rel="stylesheet" type="text/css">
    <!-- Custom CSS -->
    <link href="/MyBlog/css/style.css" rel="stylesheet">
    <link href="/MyBlog/css/pygments.css" rel="stylesheet">
    <!-- Fonts -->
 <link href="/MyBlog/css/front.css" rel="stylesheet" type="text/css">
 <link href="/MyBlog/css/Josefin_Slab.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Architects_Daughter.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Schoolbell.css" rel="stylesheet" type="text/css">
<link href="/MyBlog/css/Codystar.css" rel="stylesheet" type="text/css">

 <script type="text/javascript" src="/MyBlog/js/jquery-1.12.0.min.js"></script>	

<link href="/MyBlog/css/calendar/common.css" type="text/css"  rel="stylesheet">
<script type="text/javascript" src="/MyBlog/js/calendar/calendar.js"></script>
	<!-- share this -->
	<script type="text/javascript">var switchTo5x=true;</script>
	<script type="text/javascript" src="/MyBlog/js/buttons.js"></script>
	<script type="text/javascript">stLight.options({publisher: "b28464c3-d287-4257-ad18-058346dd35f7", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="/MyBlog/js/html5shiv.js"></script>
        <script src="/MyBlog/js/respond.min.js"></script>
    <![endif]-->
   
   <!--百度统计-->
    <script>
    var _hmt = _hmt || [];
    (function() {
    var hm = document.createElement("script");
    hm.src = "https://hm.baidu.com/hm.js?e965cab8c73512b8b23939e7051d93bd";
    var s = document.getElementsByTagName("script")[0]; 
    s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="/MyBlog/katex/katex.js"></script>
    <link rel="stylesheet" href="/MyBlog/katex/katex.css">

    <!--轮播图片-->
    <!--script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="https://xiazemin.github.io/MyBlog/js/jquery.stripesrotator.js"></script>
    <script type="text/javascript">
                    $(document).ready(function() {
                    alert($('#rotator_xzm'));
                     alert($('#rotator_xzm').fn);
                    $('#rotator_xzm').stripesRotator({ images: [ "https://xiazemin.github.io/MyBlog/img/BPlusTree.png", "https://xiazemin.github.io/MyBlog/img/linuxMMap.jpeg"] });
                    });
    </script-->

    <!--水印-->
    <script type="text/javascript" src="/MyBlog/js/waterMark.js"></script>
    <script type="text/javascript">
    $(document).ready(function(){
    watermark({watermark_txt0:'泽民博客',watermark_txt1:'zemin',watermark_txt2:(new Date()).Format("yyyy-MM-dd hh:mm:ss.S")});
    })
    </script>
     <!--水印-->
     <!--adscene-->
    <script data-ad-client="ca-pub-6672721494777557" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>

 <body>
<div id="wrapper">
 <!-- Navigation -->
    <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="/MyBlog">
                        Home
                    </a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
                <li>
                    <a href="#">Portfolio</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">Blog</a>
                </li>
                <li>
                    <a href="#">FAQ</a>
                </li>
                <li>
                    <a href="#">Contact</a>
                </li>
            </ul>
        </div>


    <header class="intro-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="heading text-center">
                        <a href="https://xiazemin.github.io/MyBlog/" style="color: #fff; font-size: 4em; font-family: 'Schoolbell', cursive;">泽民博客</a>
                        <a href="#menu-toggle" class="btn btn-default sciblog" id="menu-toggle" style="font-weight: bold;">&#9776; Menu</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

     <script async src="/MyBlog/js/busuanzi.pure.mini.js"></script>

    <script type="text/javascript" src="/MyBlog/js/jquery.js"></script>
    <script type="text/javascript" src="/MyBlog/js/jquery.stripesrotator.js"></script>


 <div class="container">
	<div class="row">
        <div class="box">
                <div class="col-lg-12">
                    <div class="intro-text text-center">
					<h1 class="post-title" itemprop="name headline">linux cgroup</h1>
					<p class="post-meta"> <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">by 夏泽民</span></span> <time datetime="2018-04-29T00:00:00+08:00" itemprop="datePublished"><i class="fa fa-calendar"></i> Apr 29, 2018</time></p>
					</div>
					 <p>Namespace解决的问题主要是环境隔离的问题，这只是虚拟化中最最基础的一步，我们还需要解决对计算机资源使用上的隔离。也就是说，虽然你通过Namespace把我Jail到一个特定的环境中去了，但是我在其中的进程使用用CPU、内存、磁盘等这些计算资源其实还是可以随心所欲的。所以，我们希望对进程进行资源利用上的限制或控制。这就是Linux CGroup出来了的原因。<br />
Linux CGroup全称Linux Control Group， 是Linux内核的一个功能，用来限制，控制与分离一个进程组群的资源（如CPU、内存、磁盘输入输出等）。这个项目最早是由Google的工程师在2006年发起（主要是Paul Menage和Rohit Seth），最早的名称为进程容器（process containers）。在2007年时，因为在Linux内核中，容器（container）这个名词太过广泛，为避免混乱，被重命名为cgroup，并且被合并到2.6.24版的内核中去。然后，其它开始了他的发展。<br />
Linux CGroupCgroup 可​​​让​​​您​​​为​​​系​​​统​​​中​​​所​​​运​​​行​​​任​​​务​​​（进​​​程​​​）的​​​用​​​户​​​定​​​义​​​组​​​群​​​分​​​配​​​资​​​源​​​ — 比​​​如​​​ CPU 时​​​间​​​、​​​系​​​统​​​内​​​存​​​、​​​网​​​络​​​带​​​宽​​​或​​​者​​​这​​​些​​​资​​​源​​​的​​​组​​​合​​​。​​​您​​​可​​​以​​​监​​​控​​​您​​​配​​​置​​​的​​​ cgroup，拒​​​绝​​​ cgroup 访​​​问​​​某​​​些​​​资​​​源​​​，甚​​​至​​​在​​​运​​​行​​​的​​​系​​​统​​​中​​​动​​​态​​​配​​​置​​​您​​​的​​​ cgroup。<br />
主要提供了如下功能：<br />
Resource limitation: 限制资源使用，比如内存使用上限以及文件系统的缓存限制。<br />
Prioritization: 优先级控制，比如：CPU利用和磁盘IO吞吐。<br />
Accounting: 一些审计或一些统计，主要目的是为了计费。<br />
Control: 挂起进程，恢复执行进程。<br />
使​​​用​​​ cgroup，系​​​统​​​管​​​理​​​员​​​可​​​更​​​具​​​体​​​地​​​控​​​制​​​对​​​系​​​统​​​资​​​源​​​的​​​分​​​配​​​、​​​优​​​先​​​顺​​​序​​​、​​​拒​​​绝​​​、​​​管​​​理​​​和​​​监​​​控​​​。​​​可​​​更​​​好​​​地​​​根​​​据​​​任​​​务​​​和​​​用​​​户​​​分​​​配​​​硬​​​件​​​资​​​源​​​，提​​​高​​​总​​​体​​​效​​​率​​​。<br />
在实践中，系统管理员一般会利用CGroup做下面这些事（有点像为某个虚拟机分配资源似的）：<br />
隔离一个进程集合（比如：nginx的所有进程），并限制他们所消费的资源，比如绑定CPU的核。<br />
为这组进程 分配其足够使用的内存<br />
为这组进程分配相应的网络带宽和磁盘存储限制<br />
限制访问某些设备（通过设置设备的白名单）<br />
<!-- more --><br />
Linux把CGroup这个事实现成了一个file system，你可以mount。在我的Ubuntu 14.04下，你输入以下命令你就可以看到cgroup已为你mount好了。<br />
 $ mount -t cgroup<br />
cgroup on /sys/fs/cgroup/cpuset type cgroup (rw,relatime,cpuset)<br />
cgroup on /sys/fs/cgroup/cpu type cgroup (rw,relatime,cpu)<br />
cgroup on /sys/fs/cgroup/cpuacct type cgroup (rw,relatime,cpuacct)<br />
cgroup on /sys/fs/cgroup/memory type cgroup (rw,relatime,memory)<br />
cgroup on /sys/fs/cgroup/devices type cgroup (rw,relatime,devices)<br />
cgroup on /sys/fs/cgroup/freezer type cgroup (rw,relatime,freezer)<br />
cgroup on /sys/fs/cgroup/blkio type cgroup (rw,relatime,blkio)<br />
cgroup on /sys/fs/cgroup/net_prio type cgroup (rw,net_prio)<br />
cgroup on /sys/fs/cgroup/net_cls type cgroup (rw,net_cls)<br />
cgroup on /sys/fs/cgroup/perf_event type cgroup (rw,relatime,perf_event)<br />
cgroup on /sys/fs/cgroup/hugetlb type cgroup (rw,relatime,hugetlb)<br />
或者使用lssubsys命令：<br />
$ lssubsys  -m<br />
cpuset /sys/fs/cgroup/cpuset<br />
cpu /sys/fs/cgroup/cpu<br />
cpuacct /sys/fs/cgroup/cpuacct<br />
memory /sys/fs/cgroup/memory<br />
devices /sys/fs/cgroup/devices<br />
freezer /sys/fs/cgroup/freezer<br />
blkio /sys/fs/cgroup/blkio<br />
net_cls /sys/fs/cgroup/net_cls<br />
net_prio /sys/fs/cgroup/net_prio<br />
perf_event /sys/fs/cgroup/perf_event<br />
hugetlb /sys/fs/cgroup/hugetlb<br />
我们可以看到，在/sys/fs下有一个cgroup的目录，这个目录下还有很多子目录，比如： cpu，cpuset，memory，blkio……这些，这些都是cgroup的子系统。分别用于干不同的事的。<br />
如果你没有看到上述的目录，你可以自己mount，下面给了一个示例：<br />
mkdir cgroup<br />
mount -t tmpfs cgroup_root ./cgroup<br />
mkdir cgroup/cpuset<br />
mount -t cgroup -ocpuset cpuset ./cgroup/cpuset/<br />
mkdir cgroup/cpu<br />
mount -t cgroup -ocpu cpu ./cgroup/cpu/<br />
mkdir cgroup/memory<br />
mount -t cgroup -omemory memory ./cgroup/memory/<br />
一旦mount成功，你就会看到这些目录下就有好文件了，比如，如下所示的cpu和cpuset的子系统：<br />
 $ ls /sys/fs/cgroup/cpu /sys/fs/cgroup/cpuset/<br />
/sys/fs/cgroup/cpu:<br />
cgroup.clone_children  cgroup.sane_behavior  cpu.shares         release_agent<br />
cgroup.event_control   cpu.cfs_period_us     cpu.stat           tasks<br />
cgroup.procs           cpu.cfs_quota_us      notify_on_release  user<br />
/sys/fs/cgroup/cpuset/:<br />
cgroup.clone_children  cpuset.mem_hardwall             cpuset.sched_load_balance<br />
cgroup.event_control   cpuset.memory_migrate           cpuset.sched_relax_domain_level<br />
cgroup.procs           cpuset.memory_pressure          notify_on_release<br />
cgroup.sane_behavior   cpuset.memory_pressure_enabled  release_agent<br />
cpuset.cpu_exclusive   cpuset.memory_spread_page       tasks<br />
cpuset.cpus            cpuset.memory_spread_slab       user<br />
cpuset.mem_exclusive   cpuset.mems<br />
你可以到/sys/fs/cgroup的各个子目录下去make个dir，你会发现，一旦你创建了一个子目录，这个子目录里又有很多文件了。<br />
hchen@ubuntu:/sys/fs/cgroup/cpu$ sudo mkdir haoel<br />
[sudo] password for hchen: <br />
~:/sys/fs/cgroup/cpu$ ls ./haoel<br />
cgroup.clone_children  cgroup.procs       cpu.cfs_quota_us  cpu.stat           tasks<br />
cgroup.event_control   cpu.cfs_period_us  cpu.shares        notify_on_release<br />
好了，我们来看几个示例。<br />
CPU 限制<br />
假设，我们有一个非常吃CPU的程序，叫deadloop，其源码如下：<br />
DEADLOOP.C<br />
int main(void)<br />
{<br />
    int i = 0;<br />
    for(;;) i++;<br />
    return 0;<br />
}<br />
用sudo执行起来后，毫无疑问，CPU被干到了100%（下面是top命令的输出）<br />
PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND   <br /><br />
3529 root      20   0    4196    736    656 R 99.6  0.1   0:23.13 deadloop<br />
然后，我们这前不是在/sys/fs/cgroup/cpu下创建了一个haoel的group。我们先设置一下这个group的cpu利用的限制：<br />
 # cat /sys/fs/cgroup/cpu/haoel/cpu.cfs_quota_us <br />
-1<br />
 # echo 20000 &gt; /sys/fs/cgroup/cpu/haoel/cpu.cfs_quota_us<br />
我们看到，这个进程的PID是3529，我们把这个进程加到这个cgroup中：</p><br />
<h1 id="echo-3529-sysfscgroupcpuhaoeltasks">echo 3529 » /sys/fs/cgroup/cpu/haoel/tasks</h1><br />
<p>然后，就会在top中看到CPU的利用立马下降成20%了。（前面我们设置的20000就是20%的意思）<br />
PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND   <br /><br />
3529 root      20   0    4196    736    656 R 19.9  0.1   8:06.11 deadloop<br />
然后，在我们另外一边：</p><br />
<h1 id="创建memory-cgroup">创建memory cgroup</h1><br />
<p>$ mkdir /sys/fs/cgroup/memory/haoel<br />
$ echo 64k &gt; /sys/fs/cgroup/memory/haoel/memory.limit_in_bytes</p><br />
<h1 id="把上面的进程的pid加入这个cgroup">把上面的进程的pid加入这个cgroup</h1><br />
<p>$ echo [pid] &gt; /sys/fs/cgroup/memory/haoel/tasks<br />
你会看到，一会上面的进程就会因为内存问题被kill掉了。<br />
磁盘I/O限制<br />
我们先看一下我们的硬盘IO，我们的模拟命令如下：（从/dev/sda1上读入数据，输出到/dev/null上）<br />
sudo dd if=/dev/sda1 of=/dev/null<br />
我们通过iotop命令我们可以看到相关的IO速度是55MB/s（虚拟机内）：<br />
TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND        <br /><br />
8128 be/4 root       55.74 M/s    0.00 B/s  0.00 % 85.65 % dd if=/de~=/dev/null…<br />
然后，我们先创建一个blkio（块设备IO）的cgroup<br />
mkdir /sys/fs/cgroup/blkio/haoel<br />
并把读IO限制到1MB/s，并把前面那个dd命令的pid放进去（注：8:0 是设备号，你可以通过ls -l /dev/sda1获得）：<br />
 # echo ‘8:0 1048576’  &gt; /sys/fs/cgroup/blkio/haoel/blkio.throttle.read_bps_device <br />
 # echo 8128 &gt; /sys/fs/cgroup/blkio/haoel/tasks<br />
再用iotop命令，你马上就能看到读速度被限制到了1MB/s左右。<br />
TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO&gt;    COMMAND        <br /><br />
8128 be/4 root      973.20 K/s    0.00 B/s  0.00 % 94.41 % dd if=/de~=/dev/null…<br />
CGroup的子系统<br />
好了，有了以上的感性认识我们来，我们来看看control group有哪些子系统：<br />
blkio — 这​​​个​​​子​​​系​​​统​​​为​​​块​​​设​​​备​​​设​​​定​​​输​​​入​​​/输​​​出​​​限​​​制​​​，比​​​如​​​物​​​理​​​设​​​备​​​（磁​​​盘​​​，固​​​态​​​硬​​​盘​​​，USB 等​​​等​​​）。<br />
cpu — 这​​​个​​​子​​​系​​​统​​​使​​​用​​​调​​​度​​​程​​​序​​​提​​​供​​​对​​​ CPU 的​​​ cgroup 任​​​务​​​访​​​问​​​。​​​<br />
cpuacct — 这​​​个​​​子​​​系​​​统​​​自​​​动​​​生​​​成​​​ cgroup 中​​​任​​​务​​​所​​​使​​​用​​​的​​​ CPU 报​​​告​​​。​​​<br />
cpuset — 这​​​个​​​子​​​系​​​统​​​为​​​ cgroup 中​​​的​​​任​​​务​​​分​​​配​​​独​​​立​​​ CPU（在​​​多​​​核​​​系​​​统​​​）和​​​内​​​存​​​节​​​点​​​。​​​<br />
devices — 这​​​个​​​子​​​系​​​统​​​可​​​允​​​许​​​或​​​者​​​拒​​​绝​​​ cgroup 中​​​的​​​任​​​务​​​访​​​问​​​设​​​备​​​。​​​<br />
freezer — 这​​​个​​​子​​​系​​​统​​​挂​​​起​​​或​​​者​​​恢​​​复​​​ cgroup 中​​​的​​​任​​​务​​​。​​​<br />
memory — 这​​​个​​​子​​​系​​​统​​​设​​​定​​​ cgroup 中​​​任​​​务​​​使​​​用​​​的​​​内​​​存​​​限​​​制​​​，并​​​自​​​动​​​生​​​成​​​​​内​​​存​​​资​​​源使用​​​报​​​告​​​。​​​<br />
net_cls — 这​​​个​​​子​​​系​​​统​​​使​​​用​​​等​​​级​​​识​​​别​​​符​​​（classid）标​​​记​​​网​​​络​​​数​​​据​​​包​​​，可​​​允​​​许​​​ Linux 流​​​量​​​控​​​制​​​程​​​序​​​（tc）识​​​别​​​从​​​具​​​体​​​ cgroup 中​​​生​​​成​​​的​​​数​​​据​​​包​​​。​​​<br />
net_prio — 这个子系统用来设计网络流量的优先级<br />
hugetlb — 这个子系统主要针对于HugeTLB系统进行限制，这是一个大页文件系统。<br />
注意，你可能在Ubuntu 14.04下看不到net_cls和net_prio这两个cgroup，你需要手动mount一下：<br />
$ sudo modprobe cls_cgroup<br />
$ sudo mkdir /sys/fs/cgroup/net_cls<br />
$ sudo mount -t cgroup -o net_cls none /sys/fs/cgroup/net_cls <br />
$ sudo modprobe netprio_cgroup<br />
$ sudo mkdir /sys/fs/cgroup/net_prio<br />
$ sudo mount -t cgroup -o net_prio none /sys/fs/cgroup/net_prio<br />
关于各个子系统的参数细节，以及更多的Linux CGroup的文档，你可以看看下面的文档：<br />
Linux Kernel的官方文档<br />
Redhat的官方文档<br />
CGroup的术语<br />
CGroup有下述术语：<br />
任务（Tasks）：就是系统的一个进程。<br />
控制组（Control Group）：一组按照某种标准划分的进程，比如官方文档中的Professor和Student，或是WWW和System之类的，其表示了某进程组。Cgroups中的资源控制都是以控制组为单位实现。一个进程可以加入到某个控制组。而资源的限制是定义在这个组上，就像上面示例中我用的haoel一样。简单点说，cgroup的呈现就是一个目录带一系列的可配置文件。<br />
层级（Hierarchy）：控制组可以组织成hierarchical的形式，既一颗控制组的树（目录结构）。控制组树上的子节点继承父结点的属性。简单点说，hierarchy就是在一个或多个子系统上的cgroups目录树。<br />
子系统（Subsystem）：一个子系统就是一个资源控制器，比如CPU子系统就是控制CPU时间分配的一个控制器。子系统必须附加到一个层级上才能起作用，一个子系统附加到某个层级以后，这个层级上的所有控制族群都受到这个子系统的控制。Cgroup的子系统可以有很多，也在不断增加中。<br />
下一代的CGroup<br />
上面，我们可以看到，CGroup的一些常用方法和相关的术语。一般来说，这样的设计在一般情况下还是没什么问题的，除了操作上的用户体验不是很好，但基本满足我们的一般需求了。<br />
不过，对此，有个叫Tejun Heo的同学非常不爽，他在Linux社区里对cgroup吐了一把槽，还引发了内核组的各种讨论。<br />
对于Tejun Heo同学来说，cgroup设计的相当糟糕。他给出了些例子，大意就是说，如果有多种层级关系，也就是说有多种对进程的分类方式，比如，我们可以按用户来分，分成Professor和Student，同时，也有按应用类似来分的，比如WWW和NFS等。那么，当一个进程即是Professor的，也是WWW的，那么就会出现多层级正交的情况，从而出现对进程上管理的混乱。另外，一个case是，如果有一个层级A绑定cpu，而层级B绑定memory，还有一个层级C绑定cputset，而有一些进程有的需要AB，有的需要AC，有的需要ABC，管理起来就相当不易。<br />
层级操作起来比较麻烦，而且如果层级变多，更不易于操作和管理，虽然那种方式很好实现，但是在使用上有很多的复杂度。你可以想像一个图书馆的图书分类问题，你可以有各种不同的分类，分类和图书就是一种多对多的关系。<br />
所以，在Kernel 3.16后，引入了unified hierarchy的新的设计，这个东西引入了一个叫__DEVEL__sane_behavior的特性（这个名字很明显意味目前还在开发试验阶段），它可以把所有子系统都挂载到根层级下，只有叶子节点可以存在tasks，非叶子节点只进行资源控制。<br />
我们mount一下看看：<br />
$ sudo mount -t cgroup -o __DEVEL__sane_behavior cgroup ./cgroup<br />
$ ls ./cgroup<br />
cgroup.controllers  cgroup.procs  cgroup.sane_behavior  cgroup.subtree_control <br />
$ cat ./cgroup/cgroup.controllers<br />
cpuset cpu cpuacct memory devices freezer net_cls blkio perf_event net_prio hugetlb<br />
我们可以看到有四个文件，然后，你在这里mkdir一个子目录，里面也会有这四个文件。上级的cgroup.subtree_control控制下级的cgroup.controllers。<br />
cgroup只有上线控制下级，无法传递到下下级。所以，C和D中没有memory的限制，E中没有blkio和memory的限制。而本层的cgroup.controllers文件是个只读的，其中的内容就看上级的subtree_control里有什么了。<br />
任何被配置过subtree_control的目录都不能绑定进程，根结点除外。所以，A,C,D,E可以绑上进程，但是B不行。<br />
我们可以看到，这种方式干净的区分开了两个事，一个是进程的分组，一个是对分组的资源控制（以前这两个事完全混在一起），在目录继承上增加了些限制，这样可以避免一些模棱两可的情况。<br />
当然，这个事还在演化中，cgroup的这些问题这个事目前由cgroup的吐槽人Tejun Heo和华为的Li Zefan同学负责解决中。总之，这是一个系统管理上的问题，而且改变会影响很多东西，但一旦方案确定，老的cgroup方式将一去不复返。<br />
Cgroup是进行分组化管理的Linux内核功能，具体的资源管理是通过子系统来完成的。可以理解为子系统就是资源控制器，每种子系统就是一个资源的分配器，比如cpu子系统是控制cpu时间分配的，使用方式如下<br />
安装（ubuntu）<br />
#apt-get install cgroup-bin<br />
基本命令<br />
cgclassify – cgclassify命令是用来将运行的任务移动到一个或者多个cgroup。<br />
cgclear – cgclear 命令是用来删除层级中的所有cgroup。<br />
cgconfig.conf – 在cgconfig.conf文件中定义cgroup。<br />
cgconfigparser – cgconfigparser命令解析cgconfig.conf文件和并挂载层级。<br />
cgcreate – cgcreate在层级中创建新cgroup。<br />
cgdelete – cgdelete命令删除指定的cgroup。<br />
cgexec – cgexec命令在指定的cgroup中运行任务。<br />
cgget – cgget命令显示cgroup参数。<br />
cgred.conf – cgred.conf是cgred服务的配置文件。<br />
cgrules.conf – cgrules.conf 包含用来决定何时任务术语某些 cgroup的规则。<br />
cgrulesengd – cgrulesengd 在 cgroup 中发布任务。<br />
cgset – cgset 命令为 cgroup 设定参数。<br />
lscgroup – lscgroup 命令列出层级中的 cgroup。<br />
lssubsys – lssubsys 命令列出包含指定子系统的层级<br />
子系统说明<br />
可以使用lssubsys -a来列出系统支持多少种子系统，和：比如cpu是控制cpu时间片的，memory是控制内存使用的<br />
#lssubsys -a<br />
cpuset<br />
cpu,cpuacct<br />
memory<br />
devices<br />
freezer<br />
net_cls,net_prio<br />
blkio<br />
perf_event<br />
hugetlb<br />
主要的几种子系统说明如下：<br />
blkio 这个子系统设置限制每个块设备的输入输出控制。例如:磁盘，光盘以及usb等等。<br />
cpu 这个子系统使用调度程序为cgroup任务提供cpu的访问。<br />
cpuacct 产生cgroup任务的cpu资源报告。<br />
cpuset 如果是多核心的cpu，这个子系统会为cgroup任务分配单独的cpu和内存。<br />
devices 允许或拒绝cgroup任务对设备的访问。<br />
freezer 暂停和恢复cgroup任务。<br />
memory 设置每个cgroup的内存限制以及产生内存资源报告。<br />
net_cls 标记每个网络包以供cgroup方便使用。<br />
ns 名称空间子系统<br />
perf_event: 增加了对每group的监测跟踪的能力，即可以监测属于某个特定的group的所有线程以及运行在特定CPU上的线程<br />
要为Cgroup分配限制的资源,首先要挂载子系统，然后才有控制组，比如想要对目标程序进行内存限制，那就需要挂载memory子系统<br />
使用lssubsys -am来显示已经挂载的子系统<br />
#lssubsys -am<br />
cpuset /sys/fs/cgroup/cpuset<br />
cpu,cpuacct /sys/fs/cgroup/cpu,cpuacct<br />
memory /sys/fs/cgroup/memory<br />
devices /sys/fs/cgroup/devices<br />
freezer /sys/fs/cgroup/freezer<br />
net_cls,net_prio /sys/fs/cgroup/net_cls,net_prio<br />
blkio /sys/fs/cgroup/blkio<br />
perf_event /sys/fs/cgroup/perf_event<br />
hugetlb /sys/fs/cgroup/hugetlb<br />
可以手动挂载或者卸载子系统，如执行umount /sys/fs/cgroup/memory，memory子系统就被卸载了，这时候手动执行# mount -t cgroup -o memory memory /sys/fs/cgroup/memory就又挂载上了。 <br />
要确保需要的子系统都挂上了，不然创建控制组的时候会报错 is not mounted<br />
#cgcreate -g memory,cpu:/hzmali_test<br />
cgcreate: can’t create cgroup /hzmali_test: Cgroup one of the needed subsystems is not mounted<br />
如何创建control group（即需要资源管理的组）呢, 这里用cgcreate命令，当然也有其他方法, 如cgconfig.conf等<br />
#cgcreate -g memory,cpu:/hzmali_test<br />
这里有个重要特性：一个组可以同时做多个资源的限制，如这里我同时限制了memory和cpu，然后memory和cpu子系统目录下会自动生成这个组的目录和些文件，如memory<br />
#/sys/fs/cgroup/memory/hzmali_test$ ls -lrt<br />
文件很多，选几个重要的讲下：<br />
tasks 可以将想要限制资源的进程都加到这个文件中<br />
memory.max_usage_in_bytes内存的最大使用量，用来限制资源 <br />
-memory.soft_limit_in_bytes 和 memory.limit_in_bytes 的差异是，这个限制并不会阻止进程使用超过限额的内存，只是在系统内存不足时，会优先回收超过限额的进程占用的内存，使之向限定值靠拢。<br />
memory.oom_control <br />
包含一个标志（0或1）来开启或者关闭cgroup的OOM killer。如果开启（1），任务如果尝试申请内存超过允许，就会被系统OOM killer终止。OOM killer在每个使用cgroup内存子系统中都是默认开启的。如果需要关闭，则可以向memory.oom_control文件写入1：<br />
 # echo 1 &gt; /sys/fs/cgroup/memory.oom_control <br />
如果OOM killer关闭，那么进程尝试申请的内存超过允许，那么它就会被暂停，直到额外的内存被释放<br />
memory.mem.usage_in_bytes 当前进程内存用量，因为现在还没有进程加到组里，就是0了<br />
memory.mem.failcnt显示内存达到限制值的次数<br />
Cgroup文档<br />
Cgroup的使用细节，子系统和参数设置都可以可以在https://www.kernel.org/doc/Documentation/cgroups/中找到，继承等特性由于篇幅所限，可以看下文档<br />
Cgroup实战<br />
内存限制测试<br />
用控制组限制目标程序内存使用为1000000 byte，当然，需要root执行 <br />
echo “1000000” &gt;memory.limit_in_bytes<br />
一般更推荐用cgset来设置数值<br />
cgset -r memory.limit_in_bytes=1000000 hzmali_test<br />
然后构造一个吃内存的程序，每运行一次内存使用就大幅增加<br />
如果我不想把机器跑死，这里想要限制组里的进程的CPU使用，有2种做法 <br />
1.在cpu子系统中控制cpu调度的配额 <br />
先看下当前cpu分配情况<br />
cat /sys/fs/cgroup/cpu/hzmali_test/cpu.cfs_quota_us<br />
-1<br />
cat /sys/fs/cgroup/cpu/hzmali_test/cpu.cfs_period_us<br />
100000<br />
-1表示无限制，这里改为50000，即相对于cpu.cfs_period_us 来说为50000/100000约占1个核50%的cpu时间<br />
 #./cpu_test.sh &amp;<br />
[1] 17709<br />
 # echo 17709 &gt;/sys/fs/cgroup/cpu/hzmali_test/tasks<br />
或者直接使用命令cgexec执行<br />
cgexec -g cpu:hzmali_test ./cpu_test.sh<br />
top了下基本上就是在50%的cpu占用<br />
%Cpu0 : 50.5 us, 0.0 sy, 0.0 ni, 49.5 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st<br />
%Cpu1 : 0.0 us, 0.3 sy, 0.0 ni, 99.7 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st<br />
PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 17709 root 20 0 25368 2020 1764 R 50.2 0.1 1:14.74 bash<br />
2.在cpuset控制物理cpu的分配 <br />
当前使用了上面的方法后，我们发现进程的CPU使用都在Cpu0上，这次希望只用Cpu1来跑这个小程序 <br />
所以把控制组也加到cpuset<br />
 # cgcreate -g cpuset:/hzmali_test<br />
看一下现在使用的cpu的设置<br />
 # cat /sys/fs/cgroup/cpuset/hzmali_test/cpuset.cpus<br />
0-1<br />
改为只用Cpu1，输入以下命令<br />
 # echo 1 &gt; /sys/fs/cgroup/cpuset/hzmali_test/cpuset.cpus<br />
 # echo 17709 &gt; /sys/fs/cgroup/cpuset/hzmali_test/tasks<br />
或用命令<br />
 # cgset -r cpuset.cpus=’1’ hzmali_test<br />
 # cgclassify -g cpu,cpuset:hzmali_test 17709<br />
top一下，内存的使用从CPU0到CPU1了<br />
%Cpu0 : 0.0 us, 0.0 sy, 0.0 ni, 99.7 id, 0.0 wa, 0.0 hi, 0.3 si, 0.0 st<br />
%Cpu1 : 50.3 us, 0.0 sy, 0.0 ni, 49.7 id, 0.0 wa, 0.0 hi, 0.0 si, 0.0 st<br />
PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND<br />
17709 root 20 0 25368 2108 2076 R 50.1 0.1 8:56.78 bash<br />
IO限制测试<br />
用dd对硬盘进行写操作<br />
 # dd if=/dev/sda of=/dev/null &amp;<br />
打开iotop看下IO速度<br />
Total DISK READ : 100.37 M/s | Total DISK WRITE : 0.00 B/s<br />
Actual DISK READ: 100.37 M/s | Actual DISK WRITE: 0.00 B/s<br />
TID PRIO USER DISK READ DISK WRITE SWAPIN IO&gt; COMMAND<br />
18081 be/4 root 100.37 M/s 0.00 B/s 0.00 % 1.34 % dd if=/dev/sda of=/dev/null<br />
为了控制IO速度，在blkio上创建控制组<br />
 # cgcreate -g blkio:/hzmali_test<br />
查看下硬盘号<br />
 # ls -l /dev/sda<br />
brw-rw—- 1 root disk 8, 0 Jul 25 22:46 /dev/sda<br />
设置硬盘号和对应的读取速度限制，然后执行同样的命令<br />
 # cgset -r blkio.throttle.read_bps_device=”8:0 1000000” hzmali_test<br />
 # cgexec -g blkio:hzmali_test “dd if=/dev/sda of=/dev/null”<br />
用iotop查看下，速度果然就降到1M以下</p><br />

					 <span class='st_sharethis_large' displayText='ShareThis'></span>
						<span class='st_facebook_large' displayText='Facebook'></span>
						<span class='st_twitter_large' displayText='Tweet'></span>
						<span class='st_linkedin_large' displayText='LinkedIn'></span>
						<span class='st_pinterest_large' displayText='Pinterest'></span>
						<span class='st_email_large' displayText='Email'></span>
                </div>
                Category linux
        </div>
	</div>
  
  
       <!--赞-->
    	  <div class="row">
            <div class="col-lg-6">
                <img src="https://xiazemin.github.io/MyBlog/img/webwxgetmsgimg.jpeg"  height="400" width="auto" />
            </div>
          </div>

        <div class="row">
                <div class="col-md-12">
			<div id="disqus_thread"></div>

<div id="gitmentContainer"></div>
<link rel="stylesheet" href="/MyBlog/css/default.css">
<script src="/MyBlog/js/gitment.browser.js"></script>
<script type="text/javascript" src="/MyBlog/js/json2.js"></script>
<script>
var gitment = new Gitment({
    owner: 'xiazemin',
    repo: 'MyBlogComment',
    oauth: {
        client_id: '981ba8c916c262631ea0',
        client_secret: 'a52260ef92de69011ccd1cf355b973ef11d6da0e',
    },
});

var MyGitmentContainer=gitment.render('gitmentContainer');
window.setTimeout(MyGitMentBtnclick,1000); 
//document.ready(function(){ 
//window.onload=function(){}

function MyGitMentBtnclick(){
//var MyGitmentContainer=document.getElementById('gitmentContainer');
	var ele=[],all=MyGitmentContainer.getElementsByTagName("*");
	for(var i=0;i<all.length;i++){
	  if(all[i].className=='gitment-comments-init-btn'){
		MyGitMentBtn=all[i];
		console.log(MyGitMentBtn);
		MyGitMentBtn.click();
	  }
	}
}

</script>



			<!--script>
			/**
			* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
			* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
			*/
			/*
			var disqus_config = function () {
			this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
			this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
			};
			*/
			(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//airrayagroup.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
			})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
			<script id="dsq-count-scr" src="//airrayagroup.disqus.com/count.js" async></script-->
          </div>
       </div>

</div>
<hr>
     <footer>
        <div class="container">
             <a href="/MyBlog/" style="color: green; font-size: 2em; font-family: 'Schoolbell', cursive;">首页</a>
            <div class="row">
                <div class="col-lg-6">
                    <p>Copyright &copy; 2017 465474307@qq.com <p>
                </div>
                <div class="col-lg-6">
                    <p style="float: right;">Jekyll theme by <a href="https://github.com/xiazemin/">夏泽民</a></p>
                </div>
            </div>
        </div>
    </footer>
	
    <!-- jQuery -->
    <script src="/MyBlog/js/jquery-1.12.0.min.js"></script>
    <script src="/MyBlog/js/jquery-migrate-1.2.1.min.js"></script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="/MyBlog/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <!-- Menu Toggle Script -->
    <script>
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    </script>
    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"6","bdPos":"right","bdTop":"100"},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/MyBlog/shareapi/js/share.js?v=89860593.js?'];</script>


<!-- 2d  -->
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.0.min.js"></script>
<script type="text/javascript" charset="utf-8"  src="/MyBlog/js/L2Dwidget.min.js"></script>
<script type="text/javascript">
 setTimeout(()=> {
/*L2Dwidget.init({"display": {
        "superSample": 2,
        "width": 200,
        "height": 400,
             "position": "right",
                 "hOffset": 0,
        "vOffset": 0
          }
     });
*/
 L2Dwidget
        .on('*', (name) => {
          console.log('%c EVENT ' + '%c -> ' + name, 'background: #222; color: yellow', 'background: #fff; color: #000')
        })
        .init({
          dialog: {
            // 开启对话框
            enable: true,
            script: {
              // 每空闲 10 秒钟，显示一条一言
              'every idle 10s': '$hitokoto$',
              // 当触摸到星星图案
              'hover .star': '星星在天上而你在我心里 (*/ω＼*)',
              // 当触摸到角色身体
              'tap body': '哎呀！别碰我！',
              // 当触摸到角色头部
              'tap face': '人家已经不是小孩子了！'
            }
          }
        });

})
</script>



    <!--html xmlns:wb="http://open.weibo.com/wb">
    <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
    <wb:follow-button uid="2165491993" type="red_1" width="67" height="24" ></wb:follow-button-->

      <!--本文来自-->
     <script type="text/javascript">
      /* 仅IE
     document.body.oncopy = function(){
        setTimeout( 
            function () { 
        var text =window.clipboardData.getData("text"); 
        if (text) { 
            text = text + "/r/n本篇文章来源于 xiazemin 的 泽民博客|https://xiazemin.github.io/MyBlog/index.html 原文链接："+location.href; clipboardData.setData("text", text); 
          }
       },
     100 )
    }
     */
     //绑定在了body上，也可以绑定在其他可用元素行，但是不是所有元素都支持copy和past事件。

     /*
$(document.body).bind({
    copy: function(event) {//copy事件
        //var cpTxt = "复制的数据";
        var clipboardData = window.clipboardData; //for IE
        if (!clipboardData) { // for chrome
            clipboardData = event.originalEvent.clipboardData;
        }

        if (event.clipboardData != null/false/undefined) { //ignore the incorrectness of the truncation
        clipboarddata = event.clipboardData;
        } else if (window.clipboardData != null/false/undefined) {
         clipboarddata = window.clipboardData;
        } else { //default to the last option even if it is null/false/undefined
         clipboarddata = event.originalEvent.clipboardData;
        }

        //e.clipboardData.getData('text');//可以获取用户选中复制的数据
        //clipboardData.setData('Text', cpTxt);
        alert(clipboarddata.getData('text'));
        //$('#message').text('Copy Data : ' + cpTxt);
        return false;//否则设不生效
    },paste: function(e) {//paste事件
        var eve = e.originalEvent
        var cp = eve.clipboardData;
        var data = null;
        var clipboardData = window.clipboardData; // IE
        if (!clipboardData) { //chrome
            clipboardData = e.originalEvent.clipboardData
        }
        data = clipboardData.getData('Text');
        //$('#message').html(data);
    }
});     
*/
function addLink() {
    var body_element = document.getElementsByTagName('body')[0];
    var selection;
    selection = window.getSelection();
    var pagelink = "<br /><br />本文来源：xiazemin 的 泽民博客 <a href='"+document.location.href+"'>"+document.location.href+"</a>";
//+document.location.href+当前页面链接
    var copy_text = selection + pagelink;
    console.log(copy_text);
    var new_div = document.createElement('div');
    new_div.style.left='-99999px';
    new_div.style.position='absolute';
    body_element.appendChild(new_div );
    new_div.innerHTML = copy_text ;
    selection.selectAllChildren(new_div );
    window.setTimeout(function() {
        body_element.removeChild(new_div );
    },0);
}
document.oncopy = addLink;
     </script>
    <!--本文来自-->

</div>
  </body>

</html>