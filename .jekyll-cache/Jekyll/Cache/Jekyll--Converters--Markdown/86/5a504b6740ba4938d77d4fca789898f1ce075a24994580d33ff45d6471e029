I"†e<p>https://pracucci.com/linux-tcp-rto-min-max-and-tcp-retries2.html
TCP retransmits an unacknowledged packet up to tcp_retries2 sysctl setting times (defaults to 15) using an exponential backoff timeout for which each retransmission timeout is between TCP_RTO_MIN (200 ms) and TCP_RTO_MAX (120 seconds). Once the 15th retry expires (by default), the TCP stack will notify the layers above (ie. app) of a broken connection.</p>

<p>The value of TCP_RTO_MIN and TCP_RTO_MAX is hardcoded in the Linux kernel and defined by the following constants:</p>

<p>#define TCP_RTO_MAX ((unsigned)(120*HZ))
#define TCP_RTO_MIN ((unsigned)(HZ/5))
<!-- more -->
http://perthcharles.github.io/2015/09/06/wiki-rtt-estimator/</p>

<p>http://perthcharles.github.io/2015/09/07/wiki-tcp-retries/</p>

<p>Linuxä¸­ç¡®å®å®šä¹‰äº†ä¸¤ä¸ªå‚æ•°æ¥é™å®šè¶…æ—¶é‡ä¼ çš„æ¬¡æ•°çš„ï¼Œä»¥ä¸‹æ˜¯æºç ä¸­Documentation/networking/ip-sysctl.txtæ–‡æ¡£ä¸­çš„æè¿°</p>

<p>tcp_retries1 - INTEGER
    This value influences the time, after which TCP decides, that
    something is wrong due to unacknowledged RTO retransmissions,
    and reports this suspicion to the network layer.
    See tcp_retries2 for more details.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RFC 1122 recommends at least 3 retransmissions, which is the
default.
</code></pre></div></div>

<p>tcp_retries2 - INTEGER
    This value influences the timeout of an alive TCP connection,
    when RTO retransmissions remain unacknowledged.
    Given a value of N, a hypothetical TCP connection following
    exponential backoff with an initial RTO of TCP_RTO_MIN would
    retransmit N times before killing the connection at the (N+1)th RTO.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The default value of 15 yields a hypothetical timeout of 924.6
seconds and is a lower bound for the effective timeout.
TCP will effectively time out at the first RTO which exceeds the
hypothetical timeout.

RFC 1122 recommends at least 100 seconds for the timeout,
which corresponds to a value of at least 8. å°±æ˜¯è¿™æ ·ä¸€æ®µè¯ï¼Œå¯èƒ½ç”±äºè¿‡äºæ¦‚æ‹¬ï¼Œä¼šä»¤äººäº§ç”Ÿå¾ˆå¤šç–‘é—®ï¼Œç”šè‡³äº§ç”Ÿä¸€äº›è¯¯è§£ã€‚ æ¯”å¦‚å¸¸è§çš„é—®é¢˜æœ‰ï¼š a. è¶…è¿‡tcp_retries1è¿™ä¸ªé˜ˆå€¼åï¼Œåˆ°åº•æ˜¯reportäº†æ€æ ·ä¸€ç§suspicionå‘¢ï¼Ÿ b. tcp_retries1å’Œtcp_retries2çš„æ•°å­—æ˜¯è¡¨ç¤ºRTOé‡ä¼ çš„æ¬¡æ•°ä¸Šé™ï¼Œå¯¹å—ï¼Ÿ c. æ–‡æ¡£ä¸­æåˆ°ï¼Œ924.6s is a lower bound for the effective timeoutã€‚ è¿™é‡Œçš„effective timeoutæ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ ä¸ºä»€ä¹ˆæ˜¯lower boundï¼Œtcp_retries2ä¸åº”è¯¥æ˜¯é™åˆ¶é‡ä¼ æ¬¡æ•°çš„upper boundå—ï¼Ÿ
</code></pre></div></div>

<p>// RTO timerçš„å¤„ç†å‡½æ•°æ˜¯tcp_retransmit_timer()ï¼Œä¸tcp_retries1ç›¸å…³çš„ä»£ç è°ƒç”¨å…³ç³»å¦‚ä¸‹<br />
tcp_retransmit_timer()
    =&gt; tcp_write_timeout()  // åˆ¤æ–­æ˜¯å¦é‡ä¼ äº†è¶³å¤Ÿçš„ä¹…
        =&gt; retransmit_timed_out(sk, sysctl_tcp_retries1, 0, 0)  // åˆ¤æ–­æ˜¯å¦è¶…è¿‡äº†é˜ˆå€¼</p>

<p>// tcp_write_timeout()çš„å…·ä½“ç›¸å…³å†…å®¹<br />
â€¦
if ((1 Â«Â sk-&gt;sk_state) &amp; (TCPF_SYN_SENT | TCPF_SYN_RECV)) {
    // å¦‚æœè¶…æ—¶å‘ç”Ÿåœ¨ä¸‰æ¬¡æ¡æ‰‹æœŸé—´ï¼Œæ­¤æ—¶æœ‰ä¸“é—¨çš„tcp_syn_retriesæ¥è´Ÿè´£é™å®šé‡ä¼ æ¬¡æ•°
    â€¦
} else {    // å¦‚æœè¶…æ—¶å‘ç”Ÿåœ¨æ•°æ®å‘é€æœŸé—´
    // è¿™ä¸ªå‡½æ•°è´Ÿè´£åˆ¤æ–­é‡ä¼ æ˜¯å¦è¶…è¿‡é˜ˆå€¼ï¼Œè¿”å›çœŸè¡¨ç¤ºè¶…è¿‡ã€‚åç»­ä¼šè¯¦ç»†åˆ†æè¿™ä¸ªå‡½æ•°<br />
    if (retransmits_timed_out(sk, sysctl_tcp_retries1, 0, 0)) { 
        /* Black hole detection */
        tcp_mtu_probing(icsk, sk);  // å¦‚æœå¼€å¯tcp_mtu_probing(é»˜è®¤å…³é—­)äº†ï¼Œåˆ™æ‰§è¡ŒPMTU</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    dst_negative_advice(sk);    // æ›´æ–°è·¯ç”±ç¼“å­˜
}
... } ä»ä»¥ä¸Šçš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ—¦é‡ä¼ è¶…è¿‡é˜ˆå€¼tcp_retries1ï¼Œä¸»è¦çš„åŠ¨ä½œå°±æ˜¯æ›´æ–°è·¯ç”±ç¼“å­˜ã€‚ ç”¨ä»¥é¿å…ç”±äºè·¯ç”±é€‰è·¯å˜åŒ–å¸¦æ¥çš„é—®é¢˜ã€‚
</code></pre></div></div>

<p>é‡ä¼ è¶…è¿‡tcp_retries2ä¼šæ€æ ·
ä¼šç›´æ¥æ”¾å¼ƒé‡ä¼ ï¼Œå…³é—­TCPæµ</p>

<p>// ä¾ç„¶è¿˜æ˜¯åœ¨tcp_write_timeout()ä¸­ï¼Œretry_untilä¸€èˆ¬æ˜¯tcp_retries2
â€¦
if (retransmits_timed_out(sk, retry_until, syn_set ? 0 : icsk-&gt;icsk_user_timeout, syn_set)) {
    /* Has it gone just too far? */
    tcp_write_err(sk);      // è°ƒç”¨tcp_doneå…³é—­TCPæµ
    return 1;
}
retriesé™åˆ¶çš„é‡ä¼ æ¬¡æ•°å—
å’‹ä¸€çœ‹æ–‡æ¡£ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°retriesçš„æ•°å­—å°±æ˜¯é™å®šçš„é‡ä¼ çš„æ¬¡æ•°ï¼Œç”šè‡³æºç ä¸­å¯¹äºretrieså¸¸é‡æ³¨é‡Šä¸­éƒ½å†™ç€â€This is how many retries it doesâ€¦â€</p>

<p>#define TCP_RETR1       3   /*
                             * This is how many retries it does before it
                             * tries to figure out if the gateway is
                             * down. Minimal RFC value is 3; it corresponds
                             * to ~3sec-8min depending on RTO.
                             */</p>

<p>#define TCP_RETR2       15  /*
                             * This should take at least
                             * 90 minutes to time out.
                             * RFC1122 says that the limit is 100 sec.
                             * 15 is ~13-30min depending on RTO.
                             */
é‚£å°±å°±æ¥çœ‹çœ‹retransmits_timed_outçš„å…·ä½“å®ç°ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯ä¸æ˜¯é™åˆ¶çš„é‡ä¼ æ¬¡æ•°</p>

<p>/* This function calculates a â€œtimeoutâ€ which is equivalent to the timeout of a</p>
<ul>
  <li>TCP connection after â€œboundaryâ€ unsuccessful, exponentially backed-off</li>
  <li>retransmissions with an initial RTO of TCP_RTO_MIN or TCP_TIMEOUT_INIT if</li>
  <li>
    <p>syn_set flag is set.
 */
static bool retransmits_timed_out(struct sock *sk,
                           unsigned int boundary,
                           unsigned int timeout,
                           bool syn_set)
{
 unsigned int linear_backoff_thresh, start_ts;
 // å¦‚æœæ˜¯åœ¨ä¸‰æ¬¡æ¡æ‰‹é˜¶æ®µï¼Œsyn_setä¸ºçœŸ
 unsigned int rto_base = syn_set ? TCP_TIMEOUT_INIT : TCP_RTO_MIN;</p>

    <p>if (!inet_csk(sk)-&gt;icsk_retransmits)
         return false;</p>

    <p>// retrans_stampè®°å½•çš„æ˜¯æ•°æ®åŒ…ç¬¬ä¸€æ¬¡å‘é€çš„æ—¶é—´ï¼Œåœ¨tcp_retransmit_skb()ä¸­è®¾ç½®
 if (unlikely(!tcp_sk(sk)-&gt;retrans_stamp))
         start_ts = TCP_SKB_CB(tcp_write_queue_head(sk))-&gt;when;
 else
         start_ts = tcp_sk(sk)-&gt;retrans_stamp;</p>

    <p>// å¦‚æœç”¨æˆ·æ€æœªæŒ‡å®štimeoutï¼Œåˆ™ç®—ä¸€ä¸ªå‡ºæ¥
 if (likely(timeout == 0)) {
         /* ä¸‹é¢çš„è®¡ç®—è¿‡ç¨‹ï¼Œå…¶å®å°±æ˜¯ç®—ä¸€ä¸‹å¦‚æœä»¥rto_baseä¸ºç¬¬ä¸€æ¬¡é‡ä¼ é—´éš”ï¼Œ
          * é‡ä¼ boundaryæ¬¡éœ€è¦å¤šé•¿æ—¶é—´
          */
         linear_backoff_thresh = ilog2(TCP_RTO_MAX/rto_base);</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     if (boundary &lt;= linear_backoff_thresh)
             timeout = ((2 &lt;&lt; boundary) - 1) * rto_base;
     else
             timeout = ((2 &lt;&lt; linear_backoff_thresh) - 1) * rto_base +
                     (boundary - linear_backoff_thresh) * TCP_RTO_MAX;  }  // å¦‚æœæ•°æ®åŒ…ç¬¬ä¸€æ¬¡å‘é€çš„æ—¶é—´è·ç¦»ç°åœ¨çš„æ—¶é—´é—´éš”ï¼Œè¶…è¿‡äº†timeoutå€¼ï¼Œåˆ™è®¤ä¸ºé‡ä¼ è¶…äºé˜ˆå€¼äº†  return (tcp_time_stamp - start_ts) &gt;= timeout; } ä»ä»¥ä¸Šçš„ä»£ç åˆ†æå¯ä»¥çœ‹åˆ°ï¼ŒçœŸæ­£èµ·åˆ°é™åˆ¶é‡ä¼ æ¬¡æ•°çš„å¹¶ä¸æ˜¯çœŸæ­£çš„é‡ä¼ æ¬¡æ•°ã€‚ è€Œæ˜¯ä»¥tcp_retries1æˆ–tcp_retries2ä¸ºboundaryï¼Œä»¥rto_base(å¦‚TCP_RTO_MIN 200ms)ä¸ºåˆå§‹RTOï¼Œè®¡ç®—å¾—åˆ°ä¸€ä¸ªtimeoutå€¼å‡ºæ¥ã€‚å¦‚æœé‡ä¼ é—´éš”è¶…è¿‡è¿™ä¸ªtimeoutï¼Œåˆ™è®¤ä¸ºè¶…è¿‡äº†é˜ˆå€¼ã€‚ ä¸Šé¢è¿™æ®µè¯å¤ªç»•äº†ï¼Œä¸‹é¢ä¸¾ä¸¤ä¸ªä¸ªä¾‹å­æ¥è¯´æ˜
</code></pre></div>    </div>
  </li>
</ul>

<p>ä»¥åˆ¤æ–­æ˜¯å¦æ”¾å¼ƒTCPæµä¸ºä¾‹ï¼Œå¦‚æœtcp_retries2=15ï¼Œé‚£ä¹ˆè®¡ç®—å¾—åˆ°çš„timeout=924600msã€‚</p>

<ol>
  <li>
    <p>å¦‚æœRTTæ¯”è¾ƒå°ï¼Œé‚£ä¹ˆRTOåˆå§‹å€¼å°±çº¦ç­‰äºä¸‹é™200ms
ç”±äºtimeoutæ€»æ—¶é•¿æ˜¯924600msï¼Œè¡¨ç°å‡ºæ¥çš„ç°è±¡åˆšå¥½å°±æ˜¯é‡ä¼ äº†15æ¬¡ï¼Œè¶…è¿‡äº†timeoutå€¼ï¼Œä»è€Œæ”¾å¼ƒTCPæµ</p>
  </li>
  <li>
    <p>å¦‚æœRTTè¾ƒå¤§ï¼Œæ¯”å¦‚RTOåˆå§‹å€¼è®¡ç®—å¾—åˆ°çš„æ˜¯1000ms
é‚£ä¹ˆæ ¹æœ¬ä¸éœ€è¦é‡ä¼ 15æ¬¡ï¼Œé‡ä¼ æ€»é—´éš”å°±ä¼šè¶…è¿‡924600msã€‚
æ¯”å¦‚æˆ‘æµ‹è¯•çš„ä¸€ä¸ªRTT=400msçš„æƒ…å†µï¼Œå½“tcp_retries2=10æ—¶ï¼Œä»…é‡ä¼ äº†3æ¬¡å°±æ”¾å¼ƒäº†TCPæµ
å¦å¤–å‡ ä¸ªå°é—®é¢˜
ç†è§£äº†Linuxå†³å®šé‡ä¼ æ¬¡æ•°çš„çœŸå®æœºåˆ¶ï¼Œå°±ä¸éš¾å›ç­”ä¸€ä¸‹å‡ ä¸ªé—®é¢˜äº†</p>
  </li>
</ol>

<blockquote>
  <blockquote>
    <p>effective timeoutæŒ‡çš„æ˜¯ä»€ä¹ˆï¼Ÿ<br />
Â«Â å°±æ˜¯retransmits_timed_outè®¡ç®—å¾—åˆ°çš„timeoutå€¼</p>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <p>924.6sæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ
Â«Â 924.6s = (( 2 Â«Â 9) -1) * 200ms + (15 - 9) * 120s</p>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <p>ä¸ºä»€ä¹ˆ924.6sæ˜¯lower boundï¼Ÿ
Â«Â é‡ä¼ æ€»é—´éš”å¿…é¡»å¤§äºtimeoutå€¼ï¼Œå³ (tcp_time_stamp - start_ts) &gt;= timeout</p>
  </blockquote>
</blockquote>

<blockquote>
  <blockquote>
    <p>é‚£RTOè¶…æ—¶çš„é—´éš”åˆ°åº•æ˜¯ä¸æ˜¯æºç æ³¨é‡Šçš„â€15 is ~13-30min depending on RTO.â€å‘¢ï¼Ÿ<br />
Â«Â æ˜¾ç„¶ä¸æ˜¯! è™½ç„¶924.6s(15min)æ˜¯ä¸€ä¸ªlower boundï¼Œä½†æ˜¯å®ƒåŒæ—¶ä¹Ÿæ˜¯ä¸€ä¸ªupper bound!
   æ€ä¹ˆç†è§£ï¼Ÿä¸¾ä¾‹è¯´æ˜<br />
        1. å¦‚æœæŸä¸ªRTOå€¼å¯¼è‡´ï¼Œåœ¨å·²ç»é‡ä¼ äº†14æ¬¡åï¼Œæ€»é‡ä¼ é—´éš”å¼€é”€æ˜¯924s
        é‚£ä¹ˆå®ƒè¿˜éœ€è¦é‡ä¼ ç¬¬15æ¬¡ï¼Œå³ä½¿ç¦»924.6såªå·®0.6sã€‚è¿™å°±æ˜¯å‘æŒ¥äº†lower boundçš„ä½œç”¨
        2. å¦‚æœæŸä¸ªRTOå€¼å¯¼è‡´ï¼Œåœ¨é‡ä¼ äº†10æ¬¡åï¼Œæ€»é‡ä¼ é—´éš”å¼€é”€æ˜¯924s
        é‡ä¼ ç¬¬11æ¬¡åï¼Œç¬¬12æ¬¡è¶…æ—¶è§¦å‘æ—¶è®¡ç®—å¾—åˆ°çš„æ€»é—´éš”å˜ä¸º1044sï¼Œè¶…è¿‡924.6s
        é‚£ä¹ˆæ­¤æ—¶ä¼šæ”¾å¼ƒç¬¬12æ¬¡é‡ä¼ ï¼Œè¿™å°±æ˜¯924.6så‘æŒ¥äº†upper boundçš„ä½œç”¨
   æ€»çš„æ¥è¯´ï¼Œåœ¨Linux3.10ä¸­ï¼Œå¦‚æœtcp_retres2è®¾ç½®ä¸º15ã€‚æ€»é‡ä¼ è¶…æ—¶å‘¨æœŸåº”è¯¥åœ¨å¦‚ä¸‹èŒƒå›´å†…
        [924.6s, 1044.6s)
æ‰€ä»¥ç»¼åˆä¸Šè¿°ï¼ŒLinuxå¹¶ä¸æ˜¯ç›´æ¥æ‹¿tcp_retries1å’Œtcp_retries2æ¥é™åˆ¶é‡ä¼ æ¬¡æ•°çš„ï¼Œè€Œæ˜¯ç”¨è®¡ç®—å¾—åˆ°
çš„ä¸€ä¸ªtimeoutå€¼æ¥åˆ¤æ–­æ˜¯å¦è¦æ”¾å¼ƒé‡ä¼ çš„ã€‚çœŸæ­£çš„é‡ä¼ æ¬¡æ•°åŒæ—¶ä¸RTTç›¸å…³ã€‚</p>
  </blockquote>
</blockquote>

<p>/proc/sys/netç›®å½•
ã€€ã€€æ‰€æœ‰çš„TCP/IPå‚æ•°éƒ½ä½äº/proc/sys/netç›®å½•ä¸‹ï¼ˆè¯·æ³¨æ„ï¼Œå¯¹/proc/sys/netç›®å½•ä¸‹å†…å®¹çš„ä¿®æ”¹éƒ½æ˜¯ä¸´æ—¶çš„ï¼Œä»»ä½•ä¿®æ”¹åœ¨ç³»ç»Ÿé‡å¯åéƒ½ä¼šä¸¢å¤±ï¼‰ï¼Œä¾‹å¦‚ä¸‹é¢è¿™äº›é‡è¦çš„å‚æ•°ï¼š</p>

<p>å‚æ•°ï¼ˆè·¯å¾„+æ–‡ä»¶ï¼‰</p>

<p>æè¿°</p>

<p>é»˜è®¤å€¼</p>

<p>ä¼˜åŒ–å€¼</p>

<p>/proc/sys/net/core/rmem_default</p>

<p>é»˜è®¤çš„TCPæ•°æ®æ¥æ”¶çª—å£å¤§å°ï¼ˆå­—èŠ‚ï¼‰ã€‚</p>

<p>229376</p>

<p>256960</p>

<p>/proc/sys/net/core/rmem_max</p>

<p>æœ€å¤§çš„TCPæ•°æ®æ¥æ”¶çª—å£ï¼ˆå­—èŠ‚ï¼‰ã€‚</p>

<p>131071</p>

<p>513920</p>

<p>/proc/sys/net/core/wmem_default</p>

<p>é»˜è®¤çš„TCPæ•°æ®å‘é€çª—å£å¤§å°ï¼ˆå­—èŠ‚ï¼‰ã€‚</p>

<p>229376</p>

<p>256960</p>

<p>/proc/sys/net/core/wmem_max</p>

<p>æœ€å¤§çš„TCPæ•°æ®å‘é€çª—å£ï¼ˆå­—èŠ‚ï¼‰ã€‚</p>

<p>131071</p>

<p>513920</p>

<p>/proc/sys/net/core/netdev_max_backlog</p>

<p>åœ¨æ¯ä¸ªç½‘ç»œæ¥å£æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿç‡æ¯”å†…æ ¸å¤„ç†è¿™äº›åŒ…çš„é€Ÿç‡å¿«æ—¶ï¼Œå…è®¸é€åˆ°é˜Ÿåˆ—çš„æ•°æ®åŒ…çš„æœ€å¤§æ•°ç›®ã€‚</p>

<p>1000</p>

<p>2000</p>

<p>/proc/sys/net/core/somaxconn</p>

<p>å®šä¹‰äº†ç³»ç»Ÿä¸­æ¯ä¸€ä¸ªç«¯å£æœ€å¤§çš„ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè¿™æ˜¯ä¸ªå…¨å±€çš„å‚æ•°ã€‚</p>

<p>128</p>

<p>2048</p>

<p>/proc/sys/net/core/optmem_max</p>

<p>è¡¨ç¤ºæ¯ä¸ªå¥—æ¥å­—æ‰€å…è®¸çš„æœ€å¤§ç¼“å†²åŒºçš„å¤§å°ã€‚</p>

<p>20480</p>

<p>81920</p>

<p>/proc/sys/net/ipv4/tcp_mem</p>

<p>ç¡® å®šTCPæ ˆåº”è¯¥å¦‚ä½•åæ˜ å†…å­˜ä½¿ç”¨ï¼Œæ¯ä¸ªå€¼çš„å•ä½éƒ½æ˜¯å†…å­˜é¡µï¼ˆé€šå¸¸æ˜¯4KBï¼‰ã€‚ç¬¬ä¸€ä¸ªå€¼æ˜¯å†…å­˜ä½¿ç”¨çš„ä¸‹é™ï¼›ç¬¬äºŒä¸ªå€¼æ˜¯å†…å­˜å‹åŠ›æ¨¡å¼å¼€å§‹å¯¹ç¼“å†²åŒºä½¿ç”¨åº”ç”¨å‹åŠ› çš„ä¸Šé™ï¼›ç¬¬ä¸‰ä¸ªå€¼æ˜¯å†…å­˜ä½¿ç”¨çš„ä¸Šé™ã€‚åœ¨è¿™ä¸ªå±‚æ¬¡ä¸Šå¯ä»¥å°†æŠ¥æ–‡ä¸¢å¼ƒï¼Œä»è€Œå‡å°‘å¯¹å†…å­˜çš„ä½¿ç”¨ã€‚å¯¹äºè¾ƒå¤§çš„BDPå¯ä»¥å¢å¤§è¿™äº›å€¼ï¼ˆæ³¨æ„ï¼Œå…¶å•ä½æ˜¯å†…å­˜é¡µè€Œä¸æ˜¯å­— èŠ‚ï¼‰ã€‚</p>

<p>94011  125351  188022</p>

<p>131072  262144  524288</p>

<p>/proc/sys/net/ipv4/tcp_rmem</p>

<p>ä¸º è‡ªåŠ¨è°ƒä¼˜å®šä¹‰socketä½¿ç”¨çš„å†…å­˜ã€‚ç¬¬ä¸€ä¸ªå€¼æ˜¯ä¸ºsocketæ¥æ”¶ç¼“å†²åŒºåˆ†é…çš„æœ€å°‘å­—èŠ‚æ•°ï¼›ç¬¬äºŒä¸ªå€¼æ˜¯é»˜è®¤å€¼ï¼ˆè¯¥å€¼ä¼šè¢«rmem_defaultè¦† ç›–ï¼‰ï¼Œç¼“å†²åŒºåœ¨ç³»ç»Ÿè´Ÿè½½ä¸é‡çš„æƒ…å†µä¸‹å¯ä»¥å¢é•¿åˆ°è¿™ä¸ªå€¼ï¼›ç¬¬ä¸‰ä¸ªå€¼æ˜¯æ¥æ”¶ç¼“å†²åŒºç©ºé—´çš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆè¯¥å€¼ä¼šè¢«rmem_maxè¦†ç›–ï¼‰ã€‚</p>

<p>4096  87380  4011232</p>

<p>8760  256960  4088000</p>

<p>/proc/sys/net/ipv4/tcp_wmem</p>

<p>ä¸º è‡ªåŠ¨è°ƒä¼˜å®šä¹‰socketä½¿ç”¨çš„å†…å­˜ã€‚ç¬¬ä¸€ä¸ªå€¼æ˜¯ä¸ºsocketå‘é€ç¼“å†²åŒºåˆ†é…çš„æœ€å°‘å­—èŠ‚æ•°ï¼›ç¬¬äºŒä¸ªå€¼æ˜¯é»˜è®¤å€¼ï¼ˆè¯¥å€¼ä¼šè¢«wmem_defaultè¦† ç›–ï¼‰ï¼Œç¼“å†²åŒºåœ¨ç³»ç»Ÿè´Ÿè½½ä¸é‡çš„æƒ…å†µä¸‹å¯ä»¥å¢é•¿åˆ°è¿™ä¸ªå€¼ï¼›ç¬¬ä¸‰ä¸ªå€¼æ˜¯å‘é€ç¼“å†²åŒºç©ºé—´çš„æœ€å¤§å­—èŠ‚æ•°ï¼ˆè¯¥å€¼ä¼šè¢«wmem_maxè¦†ç›–ï¼‰ã€‚</p>

<p>4096  16384  4011232</p>

<p>8760  256960  4088000</p>

<p>/proc/sys/net/ipv4/tcp_keepalive_time</p>

<p>TCPå‘é€keepaliveæ¢æµ‹æ¶ˆæ¯çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œç”¨äºç¡®è®¤TCPè¿æ¥æ˜¯å¦æœ‰æ•ˆã€‚</p>

<p>7200</p>

<p>1800</p>

<p>/proc/sys/net/ipv4/tcp_keepalive_intvl</p>

<p>æ¢æµ‹æ¶ˆæ¯æœªè·å¾—å“åº”æ—¶ï¼Œé‡å‘è¯¥æ¶ˆæ¯çš„é—´éš”æ—¶é—´ï¼ˆç§’ï¼‰ã€‚</p>

<p>75</p>

<p>30</p>

<p>/proc/sys/net/ipv4/tcp_keepalive_probes</p>

<p>åœ¨è®¤å®šTCPè¿æ¥å¤±æ•ˆä¹‹å‰ï¼Œæœ€å¤šå‘é€å¤šå°‘ä¸ªkeepaliveæ¢æµ‹æ¶ˆæ¯ã€‚</p>

<p>9</p>

<p>3</p>

<p>/proc/sys/net/ipv4/tcp_sack</p>

<p>å¯ç”¨æœ‰é€‰æ‹©çš„åº”ç­”ï¼ˆ1è¡¨ç¤ºå¯ç”¨ï¼‰ï¼Œé€šè¿‡æœ‰é€‰æ‹©åœ°åº”ç­”ä¹±åºæ¥æ”¶åˆ°çš„æŠ¥æ–‡æ¥æé«˜æ€§èƒ½ï¼Œè®©å‘é€è€…åªå‘é€ä¸¢å¤±çš„æŠ¥æ–‡æ®µï¼Œï¼ˆå¯¹äºå¹¿åŸŸç½‘é€šä¿¡æ¥è¯´ï¼‰è¿™ä¸ªé€‰é¡¹åº”è¯¥å¯ç”¨ï¼Œä½†æ˜¯ä¼šå¢åŠ å¯¹CPUçš„å ç”¨ã€‚</p>

<p>1</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_fack</p>

<p>å¯ç”¨è½¬å‘åº”ç­”ï¼Œå¯ä»¥è¿›è¡Œæœ‰é€‰æ‹©åº”ç­”ï¼ˆSACKï¼‰ä»è€Œå‡å°‘æ‹¥å¡æƒ…å†µçš„å‘ç”Ÿï¼Œè¿™ä¸ªé€‰é¡¹ä¹Ÿåº”è¯¥å¯ç”¨ã€‚</p>

<p>1</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_timestamps</p>

<p>TCPæ—¶é—´æˆ³ï¼ˆä¼šåœ¨TCPåŒ…å¤´å¢åŠ 12ä¸ªå­—èŠ‚ï¼‰ï¼Œä»¥ä¸€ç§æ¯”é‡å‘è¶…æ—¶æ›´ç²¾ç¡®çš„æ–¹æ³•ï¼ˆå‚è€ƒRFC 1323ï¼‰æ¥å¯ç”¨å¯¹RTT çš„è®¡ç®—ï¼Œä¸ºå®ç°æ›´å¥½çš„æ€§èƒ½åº”è¯¥å¯ç”¨è¿™ä¸ªé€‰é¡¹ã€‚</p>

<p>1</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_window_scaling</p>

<p>å¯ç”¨RFC 1323å®šä¹‰çš„window scalingï¼Œè¦æ”¯æŒè¶…è¿‡64KBçš„TCPçª—å£ï¼Œå¿…é¡»å¯ç”¨è¯¥å€¼ï¼ˆ1è¡¨ç¤ºå¯ç”¨ï¼‰ï¼ŒTCPçª—å£æœ€å¤§è‡³1GBï¼ŒTCPè¿æ¥åŒæ–¹éƒ½å¯ç”¨æ—¶æ‰ç”Ÿæ•ˆã€‚</p>

<p>1</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_syncookies</p>

<p>è¡¨ç¤ºæ˜¯å¦æ‰“å¼€TCPåŒæ­¥æ ‡ç­¾ï¼ˆsyncookieï¼‰ï¼Œå†…æ ¸å¿…é¡»æ‰“å¼€äº†CONFIG_SYN_COOKIESé¡¹è¿›è¡Œç¼–è¯‘ï¼ŒåŒæ­¥æ ‡ç­¾å¯ä»¥é˜²æ­¢ä¸€ä¸ªå¥—æ¥å­—åœ¨æœ‰è¿‡å¤šè¯•å›¾è¿æ¥åˆ°è¾¾æ—¶å¼•èµ·è¿‡è½½ã€‚</p>

<p>1</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_tw_reuse</p>

<p>è¡¨ç¤ºæ˜¯å¦å…è®¸å°†å¤„äºTIME-WAITçŠ¶æ€çš„socketï¼ˆTIME-WAITçš„ç«¯å£ï¼‰ç”¨äºæ–°çš„TCPè¿æ¥ ã€‚</p>

<p>0</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_tw_recycle</p>

<p>èƒ½å¤Ÿæ›´å¿«åœ°å›æ”¶TIME-WAITå¥—æ¥å­—ã€‚</p>

<p>0</p>

<p>1</p>

<p>/proc/sys/net/ipv4/tcp_fin_timeout</p>

<p>å¯¹äºæœ¬ç«¯æ–­å¼€çš„socketè¿æ¥ï¼ŒTCPä¿æŒåœ¨FIN-WAIT-2çŠ¶æ€çš„æ—¶é—´ï¼ˆç§’ï¼‰ã€‚å¯¹æ–¹å¯èƒ½ä¼šæ–­å¼€è¿æ¥æˆ–ä¸€ç›´ä¸ç»“æŸè¿æ¥æˆ–ä¸å¯é¢„æ–™çš„è¿›ç¨‹æ­»äº¡ã€‚</p>

<p>60</p>

<p>30</p>

<p>/proc/sys/net/ipv4/ip_local_port_range</p>

<p>è¡¨ç¤ºTCP/UDPåè®®å…è®¸ä½¿ç”¨çš„æœ¬åœ°ç«¯å£å·</p>

<p>32768  61000</p>

<p>1024  65000</p>

<p>/proc/sys/net/ipv4/tcp_max_syn_backlog</p>

<p>å¯¹äºè¿˜æœªè·å¾—å¯¹æ–¹ç¡®è®¤çš„è¿æ¥è¯·æ±‚ï¼Œå¯ä¿å­˜åœ¨é˜Ÿåˆ—ä¸­çš„æœ€å¤§æ•°ç›®ã€‚å¦‚æœæœåŠ¡å™¨ç»å¸¸å‡ºç°è¿‡è½½ï¼Œå¯ä»¥å°è¯•å¢åŠ è¿™ä¸ªæ•°å­—ã€‚</p>

<p>2048</p>

<p>2048</p>

<p>/proc/sys/net/ipv4/tcp_low_latency</p>

<p>å…è®¸TCP/IPæ ˆé€‚åº”åœ¨é«˜ååé‡æƒ…å†µä¸‹ä½å»¶æ—¶çš„æƒ…å†µï¼Œè¿™ä¸ªé€‰é¡¹åº”è¯¥ç¦ç”¨ã€‚</p>

<p>0</p>

<p>/proc/sys/net/ipv4/tcp_westwood</p>

<p>å¯ç”¨å‘é€è€…ç«¯çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œå®ƒå¯ä»¥ç»´æŠ¤å¯¹ååé‡çš„è¯„ä¼°ï¼Œå¹¶è¯•å›¾å¯¹å¸¦å®½çš„æ•´ä½“åˆ©ç”¨æƒ…å†µè¿›è¡Œä¼˜åŒ–ï¼Œå¯¹äºWAN é€šä¿¡æ¥è¯´åº”è¯¥å¯ç”¨è¿™ä¸ªé€‰é¡¹ã€‚</p>

<p>0</p>

<p>/proc/sys/net/ipv4/tcp_bic</p>

<p>ä¸ºå¿«é€Ÿé•¿è·ç¦»ç½‘ç»œå¯ç”¨Binary Increase Congestionï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°åˆ©ç”¨ä»¥GBé€Ÿåº¦è¿›è¡Œæ“ä½œçš„é“¾æ¥ï¼Œå¯¹äºWANé€šä¿¡åº”è¯¥å¯ç”¨è¿™ä¸ªé€‰é¡¹ã€‚</p>

<p>1</p>

<p>/etc/sysctl.confæ–‡ä»¶</p>

<p>ã€€ã€€/etc /sysctl.confæ˜¯ä¸€ä¸ªå…è®¸ä½ æ”¹å˜æ­£åœ¨è¿è¡Œä¸­çš„Linuxç³»ç»Ÿçš„æ¥å£ã€‚å®ƒåŒ…å«ä¸€äº›TCP/IPå †æ ˆå’Œè™šæ‹Ÿå†…å­˜ç³»ç»Ÿçš„é«˜çº§é€‰é¡¹ï¼Œå¯ç”¨æ¥æ§åˆ¶ Linuxç½‘ç»œé…ç½®ï¼Œç”±äº/proc/sys/netç›®å½•å†…å®¹çš„ä¸´æ—¶æ€§ï¼Œå»ºè®®æŠŠTCPIPå‚æ•°çš„ä¿®æ”¹æ·»åŠ åˆ°/etc/sysctl.confæ–‡ä»¶, ç„¶åä¿å­˜æ–‡ä»¶ï¼Œä½¿ç”¨å‘½ä»¤â€œ/sbin/sysctl â€“pâ€ä½¿ä¹‹ç«‹å³ç”Ÿæ•ˆã€‚å…·ä½“ä¿®æ”¹æ–¹æ¡ˆå‚ç…§ä¸Šæ–‡ï¼š</p>

<p>net.core.rmem_default = 256960</p>

<p>net.core.rmem_max = 513920</p>

<p>net.core.wmem_default = 256960</p>

<p>net.core.wmem_max = 513920</p>

<p>net.core.netdev_max_backlog = 2000</p>

<p>net.core.somaxconn = 2048</p>

<p>net.core.optmem_max = 81920</p>

<p>net.ipv4.tcp_mem = 131072  262144  524288</p>

<p>net.ipv4.tcp_rmem = 8760  256960  4088000</p>

<p>net.ipv4.tcp_wmem = 8760  256960  4088000</p>

<p>net.ipv4.tcp_keepalive_time = 1800</p>

<p>net.ipv4.tcp_keepalive_intvl = 30</p>

<p>net.ipv4.tcp_keepalive_probes = 3</p>

<p>net.ipv4.tcp_sack = 1</p>

<p>net.ipv4.tcp_fack = 1</p>

<p>net.ipv4.tcp_timestamps = 1</p>

<p>net.ipv4.tcp_window_scaling = 1</p>

<p>net.ipv4.tcp_syncookies = 1</p>

<p>net.ipv4.tcp_tw_reuse = 1</p>

<p>net.ipv4.tcp_tw_recycle = 1</p>

<p>net.ipv4.tcp_fin_timeout = 30</p>

<p>net.ipv4.ip_local_port_range = 1024  65000</p>

<p>net.ipv4.tcp_max_syn_backlog = 2048</p>

<p>Doc2ï¼š</p>

<p>å¯è°ƒä¼˜çš„å†…æ ¸å˜é‡å­˜åœ¨ä¸¤ç§ä¸»è¦æ¥å£ï¼šsysctlå‘½ä»¤å’Œ/procæ–‡ä»¶ç³»ç»Ÿï¼Œprocä¸­ä¸è¿›ç¨‹æ— å…³çš„æ‰€æœ‰ä¿¡æ¯éƒ½è¢«ç§»æ¤åˆ°sysfsä¸­ã€‚IPV4åè®®æ ˆçš„ sysctlå‚æ•°ä¸»è¦æ˜¯sysctl.net.coreã€sysctl.net.ipv4ï¼Œå¯¹åº”çš„/procæ–‡ä»¶ç³»ç»Ÿæ˜¯/proc/sys/net /ipv4å’Œ/proc/sys/net/coreã€‚åªæœ‰å†…æ ¸åœ¨ç¼–è¯‘æ—¶åŒ…å«äº†ç‰¹å®šçš„å±æ€§ï¼Œè¯¥å‚æ•°æ‰ä¼šå‡ºç°åœ¨å†…æ ¸ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯¹äºå†…æ ¸å‚æ•°åº”è¯¥è°¨æ…è°ƒèŠ‚ï¼Œè¿™äº›å‚æ•°é€šå¸¸ä¼šå½±å“åˆ°ç³»ç»Ÿçš„æ•´ä½“æ€§èƒ½ã€‚å†…æ ¸åœ¨å¯åŠ¨æ—¶ä¼šæ ¹æ®ç³»ç»Ÿçš„èµ„æºæƒ…å†µæ¥åˆå§‹åŒ–ç‰¹å®šçš„å˜é‡ï¼Œè¿™ç§åˆå§‹åŒ–çš„è°ƒèŠ‚ä¸€èˆ¬ä¼šæ»¡è¶³é€šå¸¸çš„æ€§èƒ½éœ€æ±‚ã€‚

åº”ç”¨ç¨‹åºé€šè¿‡socketç³»ç»Ÿè°ƒç”¨å’Œè¿œç¨‹ä¸»æœºè¿›è¡Œé€šè®¯ï¼Œæ¯ä¸€ä¸ªsocketéƒ½æœ‰ä¸€ä¸ªè¯»å†™ç¼“å†²åŒºã€‚è¯»ç¼“å†²åŒºä¿å­˜äº†è¿œç¨‹ä¸»æœºå‘é€è¿‡æ¥çš„æ•°æ®ï¼Œå¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œ åˆ™æ•°æ®ä¼šè¢«ä¸¢å¼ƒï¼Œå†™ç¼“å†²æœŸä¿å­˜äº†è¦å‘é€åˆ°è¿œç¨‹ä¸»æœºçš„æ•°æ®ï¼Œå¦‚æœå†™ç¼“å†²åŒºå·²æ…¢ï¼Œåˆ™ç³»ç»Ÿçš„åº”ç”¨ç¨‹åºåœ¨å†™å…¥æ•°æ®æ—¶ä¼šé˜»å¡ã€‚å¯çŸ¥ï¼Œç¼“å†²åŒºæ˜¯æœ‰å¤§å°çš„ã€‚
</code></pre></div></div>

<p>socketç¼“å†²åŒºé»˜è®¤å¤§å°ï¼š
/proc/sys/net/core/rmem_default     å¯¹åº”net.core.rmem_default
/proc/sys/net/core/wmem_default     å¯¹åº”net.core.wmem_default
    ä¸Šé¢æ˜¯å„ç§ç±»å‹socketçš„é»˜è®¤è¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œç„¶è€Œå¯¹äºç‰¹å®šç±»å‹çš„socketåˆ™å¯ä»¥è®¾ç½®ç‹¬ç«‹çš„å€¼è¦†ç›–é»˜è®¤å€¼å¤§å°ã€‚ä¾‹å¦‚tcpç±»å‹çš„socketå°±å¯ä»¥ç”¨/proc/sys/net/ipv4/tcp_rmemå’Œtcp_wmemæ¥è¦†ç›–ã€‚</p>

<p>socketç¼“å†²åŒºæœ€å¤§å€¼ï¼š
/proc/sys/net/core/rmem_max        å¯¹åº”net.core.rmem_max
/proc/sys/net/core/wmem_max        å¯¹åº”net.core.wmem_max</p>

<p>/proc/sys/net/core/netdev_max_backlog    å¯¹åº” net.core.netdev_max_backlog
    è¯¥å‚æ•°å®šä¹‰äº†å½“æ¥å£æ”¶åˆ°åŒ…çš„é€Ÿç‡å¤§äºå†…æ ¸å¤„ç†åŒ…çš„é€Ÿç‡æ—¶ï¼Œè®¾å¤‡çš„è¾“å…¥é˜Ÿåˆ—ä¸­çš„æœ€å¤§æŠ¥æ–‡æ•°ã€‚</p>

<p>/proc/sys/net/core/somaxconn        å¯¹åº” net.core.somaxconn
    é€šè¿‡listenç³»ç»Ÿè°ƒç”¨å¯ä»¥æŒ‡å®šçš„æœ€å¤§accepté˜Ÿåˆ—backlogï¼Œå½“æ’é˜Ÿçš„è¯·æ±‚è¿æ¥å¤§äºè¯¥å€¼æ—¶ï¼Œåç»­è¿›æ¥çš„è¯·æ±‚è¿æ¥ä¼šè¢«ä¸¢å¼ƒã€‚</p>

<p>/proc/sys/net/core/optmem_max          å¯¹åº” net.core.optmem_max
    æ¯ä¸ªsocketçš„å‰¯ç¼“å†²åŒºå¤§å°ã€‚</p>

<p>TCP/IPV4å†…æ ¸å‚æ•°ï¼š
    åœ¨åˆ›å»ºsocketçš„æ—¶å€™ä¼šæŒ‡å®šsockeåè®®å’Œåœ°å€ç±»å‹ã€‚TCP socketç¼“å†²åŒºå¤§å°æ˜¯ä»–è‡ªå·±æ§åˆ¶è€Œä¸æ˜¯ç”±coreå†…æ ¸ç¼“å†²åŒºæ§åˆ¶ã€‚
/proc/sys/net/ipv4/tcp_rmem     å¯¹åº”net.ipv4.tcp_rmem
/proc/sys/net/ipv4/tcp_wmem     å¯¹åº”net.ipv4.tcp_wmem
    ä»¥ä¸Šæ˜¯TCP socketçš„è¯»å†™ç¼“å†²åŒºçš„è®¾ç½®ï¼Œæ¯ä¸€é¡¹é‡Œé¢éƒ½æœ‰ä¸‰ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªå€¼æ˜¯ç¼“å†²åŒºæœ€å°å€¼ï¼Œä¸­é—´å€¼æ˜¯ç¼“å†²åŒºçš„é»˜è®¤å€¼ï¼Œæœ€åä¸€ä¸ªæ˜¯ç¼“å†²åŒºçš„æœ€å¤§å€¼ï¼Œè™½ç„¶ç¼“å†²åŒºçš„å€¼ä¸å—coreç¼“å†²åŒºçš„å€¼çš„é™åˆ¶ï¼Œä½†æ˜¯ç¼“å†²åŒºçš„æœ€å¤§å€¼ä»æ—§å—é™äºcoreçš„æœ€å¤§å€¼ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_mem<br />
    è¯¥å†…æ ¸å‚æ•°ä¹Ÿæ˜¯åŒ…æ‹¬ä¸‰ä¸ªå€¼ï¼Œç”¨æ¥å®šä¹‰å†…å­˜ç®¡ç†çš„èŒƒå›´ï¼Œç¬¬ä¸€ä¸ªå€¼çš„æ„æ€æ˜¯å½“pageæ•°ä½äºè¯¥å€¼æ—¶ï¼ŒTCPå¹¶ä¸è®¤ä¸ºä»–ä¸ºå†…å­˜å‹åŠ›ï¼Œç¬¬äºŒä¸ªå€¼æ˜¯è¿›å…¥å†…å­˜çš„å‹åŠ›åŒº åŸŸæ—¶æ‰€è¾¾åˆ°çš„é¡µæ•°ï¼Œç¬¬ä¸‰ä¸ªå€¼æ˜¯æ‰€æœ‰TCP socketsæ‰€å…è®¸ä½¿ç”¨çš„æœ€å¤§pageæ•°ï¼Œè¶…è¿‡è¯¥å€¼åï¼Œä¼šä¸¢å¼ƒåç»­æŠ¥æ–‡ã€‚pageæ˜¯ä»¥é¡µé¢ä¸ºå•ä½çš„ï¼Œä¸ºç³»ç»Ÿä¸­socketå…¨å±€åˆ†é…çš„å†…å­˜å®¹é‡ã€‚</p>

<p>socketçš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>

<p>/proc/sys/net/ipv4/tcp_window_scaling      å¯¹åº”net.ipv4.tcp_window_scaling
    ç®¡ç†TCPçš„çª—å£ç¼©æ”¾ç‰¹æ€§ï¼Œå› ä¸ºåœ¨tcpå¤´éƒ¨ä¸­å£°æ˜æ¥æ”¶ç¼“å†²åŒºçš„é•¿åº¦ä¸º26ä½ï¼Œå› æ­¤çª—å£ä¸èƒ½å¤§äº64Kï¼Œå¦‚æœå¤§äº64Kï¼Œå°±è¦æ‰“å¼€çª—å£ç¼©æ”¾ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_sack    å¯¹åº”net.ipv4.tcp_sack
    ç®¡ç†TCPçš„é€‰æ‹©æ€§åº”ç­”ï¼Œå…è®¸æ¥æ”¶ç«¯å‘å‘é€ç«¯ä¼ é€’å…³äºå­—èŠ‚æµä¸­ä¸¢å¤±çš„åºåˆ—å·ï¼Œå‡å°‘äº†æ®µä¸¢å¤±æ—¶éœ€è¦é‡ä¼ çš„æ®µæ•°ç›®ï¼Œå½“æ®µä¸¢å¤±é¢‘ç¹æ—¶ï¼Œsackæ˜¯å¾ˆæœ‰ç›Šçš„ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_dsack   å¯¹åº”net.ipv4.tcp_dsack
    æ˜¯å¯¹sackçš„æ”¹è¿›ï¼Œèƒ½å¤Ÿæ£€æµ‹ä¸å¿…è¦çš„é‡ä¼ ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_fack    å¯¹åº”net.ipv4.tcp_fack
    å¯¹sackåè®®åŠ ä»¥å®Œå–„ï¼Œæ”¹è¿›tcpçš„æ‹¥å¡æ§åˆ¶æœºåˆ¶ã€‚</p>

<p>TCPçš„è¿æ¥ç®¡ç†ï¼š
/proc/sys/net/ipv4/tcp_max_syn_backlog    å¯¹åº”net.ipv4.tcp_max_syn_backlog
    æ¯ä¸€ä¸ªè¿æ¥è¯·æ±‚(SYNæŠ¥æ–‡)éƒ½éœ€è¦æ’é˜Ÿï¼Œç›´è‡³æœ¬åœ°æœåŠ¡å™¨æ¥æ”¶ï¼Œè¯¥å˜é‡å°±æ˜¯æ§åˆ¶æ¯ä¸ªç«¯å£çš„ TCP SYNé˜Ÿåˆ—é•¿åº¦çš„ã€‚å¦‚æœè¿æ¥è¯·æ±‚å¤šä½™è¯¥å€¼ï¼Œåˆ™è¯·æ±‚ä¼šè¢«ä¸¢å¼ƒã€‚</p>

<p>/proc/sys/net/ipv4/tcp_syn_retries    å¯¹åº”net.ipv4.tcp_syn_retries
    æ§åˆ¶å†…æ ¸å‘æŸä¸ªè¾“å…¥çš„SYN/ACKæ®µé‡æ–°å‘é€ç›¸åº”çš„æ¬¡æ•°ï¼Œä½å€¼å¯ä»¥æ›´å¥½çš„æ£€æµ‹åˆ°è¿œç¨‹ä¸»æœºçš„è¿æ¥å¤±è´¥ã€‚å¯ä»¥ä¿®æ”¹ä¸º3</p>

<p>/proc/sys/net/ipv4/tcp_retries1    å¯¹åº”net.ipv4.tcp_retries1
    è¯¥å˜é‡è®¾ç½®æ”¾å¼ƒå›åº”ä¸€ä¸ªtcpè¿æ¥è¯·æ±‚å‰ï¼Œéœ€è¦è¿›è¡Œå¤šå°‘æ¬¡é‡è¯•ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_retries2    å¯¹åº”net.ipv4.tcp_retries2
    æ§åˆ¶å†…æ ¸å‘å·²ç»å»ºç«‹è¿æ¥çš„è¿œç¨‹ä¸»æœºé‡æ–°å‘é€æ•°æ®çš„æ¬¡æ•°ï¼Œä½å€¼å¯ä»¥æ›´æ—©çš„æ£€æµ‹åˆ°ä¸è¿œç¨‹ä¸»æœºå¤±æ•ˆçš„è¿æ¥ï¼Œå› æ­¤æœåŠ¡å™¨å¯ä»¥æ›´å¿«çš„é‡Šæ”¾è¯¥è¿æ¥ï¼Œå¯ä»¥ä¿®æ”¹ä¸º5</p>

<p>TCPè¿æ¥çš„ä¿æŒï¼š
/proc/sys/net/ipv4/tcp_keepalive_time        å¯¹åº”net.ipv4.tcp_keepalive_time
    å¦‚æœåœ¨è¯¥å‚æ•°æŒ‡å®šçš„ç§’æ•°å†…è¿æ¥å§‹ç»ˆå¤„äºç©ºé—²çŠ¶æ€ï¼Œåˆ™å†…æ ¸å‘å®¢æˆ·ç«¯å‘èµ·å¯¹è¯¥ä¸»æœºçš„æ¢æµ‹</p>

<p>/proc/sys/net/ipv4/tcp_keepalive_intvl    å¯¹åº”net.ipv4.tcp_keepalive_intvl
    è¯¥å‚æ•°ä»¥ç§’ä¸ºå•ä½ï¼Œè§„å®šå†…æ ¸å‘è¿œç¨‹ä¸»æœºå‘é€æ¢æµ‹æŒ‡é’ˆçš„æ—¶é—´é—´éš”</p>

<p>/proc/sys/net/ipv4/tcp_keepalive_probes   å¯¹åº”net.ipv4.tcp_keepalive_probes
    è¯¥å‚æ•°è§„å®šå†…æ ¸ä¸ºäº†æ£€æµ‹è¿œç¨‹ä¸»æœºçš„å­˜æ´»è€Œå‘é€çš„æ¢æµ‹æŒ‡é’ˆçš„æ•°é‡ï¼Œå¦‚æœæ¢æµ‹æŒ‡é’ˆçš„æ•°é‡å·²ç»ä½¿ç”¨å®Œæ¯•ä»æ—§æ²¡æœ‰å¾—åˆ°å®¢æˆ·ç«¯çš„å“åº”ï¼Œå³æ–­å®šå®¢æˆ·ç«¯ä¸å¯è¾¾ï¼Œå…³é—­ä¸è¯¥å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œé‡Šæ”¾ç›¸å…³èµ„æºã€‚</p>

<p>/proc/sys/net/ipv4/ip_local_port_range   å¯¹åº”net.ipv4.ip_local_port_range
    è§„å®šäº†tcp/udpå¯ç”¨çš„æœ¬åœ°ç«¯å£çš„èŒƒå›´ã€‚</p>

<p>TCPè¿æ¥çš„å›æ”¶ï¼š
/proc/sys/net/ipv4/tcp_max_tw_buckets     å¯¹åº”net.ipv4.tcp_max_tw_buckets
   è¯¥å‚æ•°è®¾ç½®ç³»ç»Ÿçš„TIME_WAITçš„æ•°é‡ï¼Œå¦‚æœè¶…è¿‡é»˜è®¤å€¼åˆ™ä¼šè¢«ç«‹å³æ¸…é™¤ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_tw_reuse           å¯¹åº”net.ipv4.tcp_tw_reuse
   è¯¥å‚æ•°è®¾ç½®TIME_WAITé‡ç”¨ï¼Œå¯ä»¥è®©å¤„äºTIME_WAITçš„è¿æ¥ç”¨äºæ–°çš„tcpè¿æ¥</p>

<p>/proc/sys/net/ipv4/tcp_tw_recycle         å¯¹åº”net.ipv4.tcp_tw_recycle
   è¯¥å‚æ•°è®¾ç½®tcpè¿æ¥ä¸­TIME_WAITçš„å¿«é€Ÿå›æ”¶ã€‚</p>

<p>/proc/sys/net/ipv4/tcp_fin_timeout       å¯¹åº”net.ipv4.tcp_fin_timeout
   è®¾ç½®TIME_WAIT2è¿›å…¥CLOSEDçš„ç­‰å¾…æ—¶é—´ã€‚</p>

<p>/proc/sys/net/ipv4/route/max_size
   å†…æ ¸æ‰€å…è®¸çš„æœ€å¤§è·¯ç”±æ•°ç›®ã€‚</p>

<p>/proc/sys/net/ipv4/ip_forward
   æ¥å£é—´è½¬å‘æŠ¥æ–‡</p>

<p>/proc/sys/net/ipv4/ip_default_ttl
   æŠ¥æ–‡å¯ä»¥ç»è¿‡çš„æœ€å¤§è·³æ•°</p>

<p>è™šæ‹Ÿå†…å­˜å‚æ•°ï¼š
/proc/sys/vm/</p>

<p>åœ¨linux kernel 2.6.25ä¹‹å‰é€šè¿‡ulimit -n(setrlimit(RLIMIT_NOFILE))è®¾ç½®æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§æ‰“å¼€æ–‡ä»¶å¥æŸ„æ•°ä¸èƒ½è¶…è¿‡NR_OPEN(1024*1024),ä¹Ÿå°±æ˜¯ 100å¤šw(é™¤éé‡æ–°ç¼–è¯‘å†…æ ¸)ï¼Œè€Œåœ¨25ä¹‹åï¼Œå†…æ ¸å¯¼å‡ºäº†ä¸€ä¸ªsysæ¥å£å¯ä»¥ä¿®æ”¹è¿™ä¸ªæœ€å¤§å€¼/proc/sys/fs/nr_openã€‚shellé‡Œä¸ èƒ½ç›´æ¥æ›´æ”¹ï¼Œæ˜¯å› ä¸ºç™»å½•çš„æ—¶å€™pamå·²ç»ä»limits.confä¸­è®¾ç½®äº†ä¸Šé™ï¼Œulimitå‘½ä»¤åªèƒ½åœ¨ä½äºä¸Šé™çš„èŒƒå›´å†…å‘æŒ¥äº†ã€‚</p>

<p>Linuxä¸­æŸ¥çœ‹socketçŠ¶æ€ï¼š
cat /proc/net/sockstat #ï¼ˆè¿™ä¸ªæ˜¯ipv4çš„ï¼‰</p>

<p>sockets: used 137
TCP: inuse 49 orphan 0 tw 3272 alloc 52 mem 46
UDP: inuse 1 mem 0
RAW: inuse 0
FRAG: inuse 0 memory 0
è¯´æ˜ï¼š
sockets: usedï¼šå·²ä½¿ç”¨çš„æ‰€æœ‰åè®®å¥—æ¥å­—æ€»é‡
TCP: inuseï¼šæ­£åœ¨ä½¿ç”¨ï¼ˆæ­£åœ¨ä¾¦å¬ï¼‰çš„TCPå¥—æ¥å­—æ•°é‡ã€‚å…¶å€¼â‰¤ netstat â€“lnt | grep ^tcp | wc â€“l
TCP: orphanï¼šæ— ä¸»ï¼ˆä¸å±äºä»»ä½•è¿›ç¨‹ï¼‰çš„TCPè¿æ¥æ•°ï¼ˆæ— ç”¨ã€å¾…é”€æ¯çš„TCP socketæ•°ï¼‰
TCP: twï¼šç­‰å¾…å…³é—­çš„TCPè¿æ¥æ•°ã€‚å…¶å€¼ç­‰äºnetstat â€“ant | grep TIME_WAIT | wc â€“l
TCPï¼šalloc(allocated)ï¼šå·²åˆ†é…ï¼ˆå·²å»ºç«‹ã€å·²ç”³è¯·åˆ°sk_buffï¼‰çš„TCPå¥—æ¥å­—æ•°é‡ã€‚å…¶å€¼ç­‰äºnetstat â€“ant | grep ^tcp | wc â€“l
TCPï¼šmemï¼šå¥—æ¥å­—ç¼“å†²åŒºä½¿ç”¨é‡ï¼ˆå•ä½ä¸è¯¦ã€‚ç”¨scpå®æµ‹ï¼Œé€Ÿåº¦åœ¨4803.9kB/sæ—¶ï¼šå…¶å€¼=11ï¼Œnetstat â€“ant ä¸­ç›¸åº”çš„22ç«¯å£çš„Recv-Qï¼0ï¼ŒSend-Qâ‰ˆ400ï¼‰
UDPï¼šinuseï¼šæ­£åœ¨ä½¿ç”¨çš„UDPå¥—æ¥å­—æ•°é‡
RAWï¼š
FRAGï¼šä½¿ç”¨çš„IPæ®µæ•°é‡</p>

<p>https://stackoverflow.com/questions/5907527/application-control-of-tcp-retransmission-on-linux</p>

<p>https://access.redhat.com/solutions/726753</p>

:ET