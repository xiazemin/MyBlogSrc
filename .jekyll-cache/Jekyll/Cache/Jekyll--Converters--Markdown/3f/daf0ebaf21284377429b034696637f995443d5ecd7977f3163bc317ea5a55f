I"¸,<p>Lex &amp; yacc å’Œ antlr çš„åè¯é˜¶æ®µï¼Œæœ€è¿‘çœ‹äº†go-zeroçš„apiè§£æå™¨ï¼Œè§‰å¾—ç”šå¥½ï¼Œæ˜¯æ—¶å€™èŠ±æ—¶é—´å­¦ä¹ ä¸€ä¸‹äº†ã€‚</p>

<p>ç®€å•çœ‹äº†go-zeroå‘ç°æ˜¯è‡ªå·±å®ç°äº†è¯æ³•åˆ†æã€è¯­æ³•è§£æï¼Œè¿™ä¸ç¬¦åˆæˆ‘çš„ä¸€è´¯å·æ‡’ä½œé£ï¼Œæ‰€ä»¥å¹¶æœªå…¶æºç å¼€å§‹å­¦ä¹ ã€‚æ—¢ç„¶ç”¨golangé‚£ä¹ˆä»–è‡ªå¸¦çš„goyaccå°±æ˜¯æˆ‘å­¦ä¹ çš„ä¸äºŒä¹‹é€‰ã€‚å½“ç„¶ä½ å¯èƒ½ä¼šå¬è¯´Lex&amp;yacc å·²ç»å¾ˆå¤è€äº†ï¼Œantlræ›´å…ˆè¿›ä¸€ç‚¹ã€‚ä½†æ˜¯æ—¢ç„¶goyaccèƒ½æˆä¸ºgolangå®˜æ–¹å·¥å…·ï¼Œé‚£ä¹ˆè‚¯å®šè¿˜æ˜¯å€¼å¾—ä½ å­¦ä¹ çš„ã€‚
<!-- more -->
https://mp.weixin.qq.com/s/N1BOJKUZZ0hFyEAwuPn83w</p>

<p>https://studygolang.com/articles/30971</p>

<p>ä¸€ä¸ªç³»ç»Ÿä¸­å­˜åœ¨ç€å¤§é‡çš„è°ƒåº¦ä»»åŠ¡ï¼ŒåŒæ—¶è°ƒåº¦ä»»åŠ¡å­˜åœ¨æ—¶é—´çš„æ»åæ€§ï¼Œè€Œå¤§é‡çš„è°ƒåº¦ä»»åŠ¡å¦‚æœæ¯ä¸€ä¸ªéƒ½ä½¿ç”¨è‡ªå·±çš„è°ƒåº¦å™¨æ¥ç®¡ç†ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸçš„è¯ï¼Œæµªè´¹cpuçš„èµ„æºè€Œä¸”å¾ˆä½æ•ˆã€‚æœ¬æ–‡æ¥ä»‹ç» go-zero ä¸­ å»¶è¿Ÿæ“ä½œï¼Œå®ƒå¯èƒ½è®©å¼€å‘è€…è°ƒåº¦å¤šä¸ªä»»åŠ¡æ—¶ï¼Œåªéœ€å…³æ³¨å…·ä½“çš„ä¸šåŠ¡æ‰§è¡Œå‡½æ•°å’Œæ‰§è¡Œæ—¶é—´ã€Œç«‹å³æˆ–è€…å»¶è¿Ÿã€ã€‚è€Œ å»¶è¿Ÿæ“ä½œï¼Œé€šå¸¸å¯ä»¥é‡‡ç”¨ä¸¤ä¸ªæ–¹æ¡ˆï¼š</p>

<p>Timerï¼šå®šæ—¶å™¨ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œåˆ°æ—¶é—´ç‚¹æ‰§è¡Œï¼Œç„¶åæŠŠéœ€è¦æ‰§è¡Œçš„ task å­˜å‚¨åœ¨ map ä¸­
collection ä¸­çš„ timingWheel ï¼Œç»´æŠ¤ä¸€ä¸ªå­˜æ”¾ä»»åŠ¡ç»„çš„æ•°ç»„ï¼Œæ¯ä¸€ä¸ªæ§½éƒ½ç»´æŠ¤ä¸€ä¸ªå­˜å‚¨taskçš„åŒå‘é“¾è¡¨ã€‚å¼€å§‹æ‰§è¡Œæ—¶ï¼Œè®¡æ—¶å™¨æ¯éš”æŒ‡å®šæ—¶é—´æ‰§è¡Œä¸€ä¸ªæ§½é‡Œé¢çš„tasksã€‚</p>

<p>æ–¹æ¡ˆ2æŠŠç»´æŠ¤taskä» ä¼˜å…ˆé˜Ÿåˆ— O(nlog(n)) é™åˆ° åŒå‘é“¾è¡¨ O(1)ï¼Œè€Œæ‰§è¡Œtaskä¹Ÿåªè¦è½®è¯¢ä¸€ä¸ªæ—¶é—´ç‚¹çš„tasks O(N)ï¼Œä¸éœ€è¦åƒä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ”¾å…¥å’Œåˆ é™¤å…ƒç´  O(nlog(n))ã€‚
æˆ‘ä»¬å…ˆçœ‹çœ‹ go-zero ä¸­è‡ªå·±å¯¹ timingWheel çš„ä½¿ç”¨ ï¼š
cache ä¸­çš„ timingWheel
é¦–å…ˆæˆ‘ä»¬å…ˆæ¥åœ¨ collection çš„ cache ä¸­å…³äº timingWheel çš„ä½¿ç”¨ï¼š
timingWheel, err := NewTimingWheel(time.Second, slots, func(k, v interface{}) {
  key, ok := k.(string)
  if !ok {
    return
  }
  cache.Del(key)
})
if err != nil {
  return nil, err
}</p>

<p>cache.timingWheel = timingWheel
å¤åˆ¶ä»£ç 
è¿™æ˜¯ cache åˆå§‹åŒ–ä¸­ä¹ŸåŒæ—¶åˆå§‹åŒ– timingWheel åškeyçš„è¿‡æœŸå¤„ç†ï¼Œå‚æ•°ä¾æ¬¡ä»£è¡¨ï¼š</p>

<p>intervalï¼šæ—¶é—´åˆ’åˆ†åˆ»åº¦
numSlotsï¼šæ—¶é—´æ§½
executeï¼šæ—¶é—´ç‚¹æ‰§è¡Œå‡½æ•°</p>

<p>åœ¨ cache ä¸­æ‰§è¡Œå‡½æ•°åˆ™æ˜¯ åˆ é™¤è¿‡æœŸkeyï¼Œè€Œè¿™ä¸ªè¿‡æœŸåˆ™ç”± timingWheel æ¥æ§åˆ¶æ¨è¿›æ—¶é—´ã€‚
æ¥ä¸‹æ¥ï¼Œå°±é€šè¿‡ cache å¯¹ timingWheel çš„ä½¿ç”¨æ¥è®¤è¯†ã€‚
åˆå§‹åŒ–
// çœŸæ­£åšåˆå§‹åŒ–
func newTimingWheelWithClock(interval time.Duration, numSlots int, execute Execute, ticker timex.Ticker) (
    <em>TimingWheel, error) {
    tw := &amp;TimingWheel{
        interval:      interval,                     // å•ä¸ªæ—¶é—´æ ¼æ—¶é—´é—´éš”
        ticker:        ticker,                       // å®šæ—¶å™¨ï¼Œåšæ—¶é—´æ¨åŠ¨ï¼Œä»¥intervalä¸ºå•ä½æ¨è¿›
        slots:         make([]</em>list.List, numSlots), // æ—¶é—´è½®
        timers:        NewSafeMap(),                 // å­˜å‚¨task{key, value}çš„map [æ‰§è¡Œexecuteæ‰€éœ€è¦çš„å‚æ•°]
        tickedPos:     numSlots - 1,                 // at previous virtual circle
        execute:       execute,                      // æ‰§è¡Œå‡½æ•°
        numSlots:      numSlots,                     // åˆå§‹åŒ– slots num
        setChannel:    make(chan timingEntry),       // ä»¥ä¸‹å‡ ä¸ªchannelæ˜¯åštaskä¼ é€’çš„
        moveChannel:   make(chan baseEntry),
        removeChannel: make(chan interface{}),
        drainChannel:  make(chan func(key, value interface{})),
        stopChannel:   make(chan lang.PlaceholderType),
    }
    // æŠŠ slot ä¸­å­˜å‚¨çš„ list å…¨éƒ¨å‡†å¤‡å¥½
    tw.initSlots()
    // å¼€å¯å¼‚æ­¥åç¨‹ï¼Œä½¿ç”¨ channel æ¥åštaské€šä¿¡å’Œä¼ é€’
    go tw.run()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return tw, nil } å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ä»¥ä¸Šæ¯”è¾ƒç›´è§‚å±•ç¤º timingWheel çš„ â€œæ—¶é—´è½®â€ï¼Œåé¢ä¼šå›´ç»•è¿™å¼ å›¾è§£é‡Šå…¶ä¸­æ¨è¿›çš„ç»†èŠ‚ã€‚
 go tw.run() å¼€ä¸€ä¸ªåç¨‹åšæ—¶é—´æ¨åŠ¨ï¼š
func (tw *TimingWheel) run() {
    for {
        select {
      // å®šæ—¶å™¨åšæ—¶é—´æ¨åŠ¨ -&gt; scanAndRunTasks()
        case &lt;-tw.ticker.Chan():
            tw.onTick()
      // add task ä¼šå¾€ setChannel è¾“å…¥task
        case task := &lt;-tw.setChannel:
            tw.setTask(&amp;task)
        â€¦
        }
    }
}
å¤åˆ¶ä»£ç 
å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±å¼€å§‹äº† timer æ‰§è¡Œï¼Œå¹¶ä»¥internalæ—¶é—´æ®µè½¬åŠ¨ï¼Œç„¶ååº•å±‚ä¸åœçš„è·å–æ¥è‡ª slot ä¸­çš„  list çš„taskï¼Œäº¤ç»™ execute æ‰§è¡Œã€‚</p>

<p>Task Operation
cache åˆå§‹åŒ–å®Œï¼Œç´§æ¥ç€å°±æ˜¯ set cache key ï¼š
func (c *Cache) Set(key string, value interface{}) {
    c.lock.Lock()
    _, ok := c.data[key]
    c.data[key] = value
    c.lruCache.add(key)
    c.lock.Unlock()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>expiry := c.unstableExpiry.AroundDuration(c.expire)
if ok {
    c.timingWheel.MoveTimer(key, expiry)
} else {
    c.timingWheel.SetTimer(key, value, expiry)
} } å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>å…ˆçœ‹åœ¨ data map ä¸­æœ‰æ²¡æœ‰å­˜åœ¨è¿™ä¸ªkey
å­˜åœ¨ï¼Œåˆ™æ›´æ–° expire   -&gt; MoveTimer()
ç¬¬ä¸€æ¬¡è®¾ç½®key   -&gt;   SetTimer()</p>

<p>æ‰€ä»¥å¯¹äº timingWheel çš„ä½¿ç”¨ä¸Šå°±æ¸…æ™°äº†ï¼Œå¼€å‘è€…æ ¹æ®éœ€æ±‚å¯ä»¥ add æˆ–æ˜¯ updateã€‚
åŒæ—¶æˆ‘ä»¬è·Ÿæºç è¿›å»ä¼šå‘ç°ï¼šSetTimer() MoveTimer() éƒ½æ˜¯å°†taskè¾“é€åˆ°channelï¼Œç”± run() ä¸­å¼€å¯çš„åç¨‹ä¸æ–­å–å‡º channel çš„taskæ“ä½œã€‚</p>

<p>SetTimer() -&gt; setTask()ï¼š</p>

<p>not exist taskï¼šgetPostion -&gt; pushBack to list -&gt; setPosition
exist taskï¼šget from timers -&gt; moveTask()</p>

<p>MoveTimer() -&gt; moveTask()</p>

<p>ç”±ä¸Šé¢çš„è°ƒç”¨é“¾ï¼Œæœ‰ä¸€ä¸ªéƒ½ä¼šè°ƒç”¨çš„å‡½æ•°ï¼šmoveTask()
func (tw *TimingWheel) moveTask(task baseEntry) {
    // timers: Map =&gt; é€šè¿‡keyè·å– [positionEntryã€Œpos, taskã€]
    val, ok := tw.timers.Get(task.key)
    if !ok {
        return
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>timer := val.(*positionEntry)
// {delay &lt; interval} =&gt; å»¶è¿Ÿæ—¶é—´æ¯”ä¸€ä¸ªæ—¶é—´æ ¼é—´éš”è¿˜å°ï¼Œæ²¡æœ‰æ›´å°çš„åˆ»åº¦ï¼Œè¯´æ˜ä»»åŠ¡åº”è¯¥ç«‹å³æ‰§è¡Œ
if task.delay &lt; tw.interval {
    threading.GoSafe(func() {
        tw.execute(timer.item.key, timer.item.value)
    })
    return
}
// å¦‚æœ &gt; intervalï¼Œåˆ™é€šè¿‡ å»¶è¿Ÿæ—¶é—´delay è®¡ç®—å…¶å‡ºæ—¶é—´è½®ä¸­çš„ new pos, circle
pos, circle := tw.getPositionAndCircle(task.delay)
if pos &gt;= timer.pos {
    timer.item.circle = circle
// è®°å½•å‰åçš„ç§»åŠ¨offsetã€‚ä¸ºäº†åé¢è¿‡ç¨‹é‡æ–°å…¥é˜Ÿ
    timer.item.diff = pos - timer.pos
} else if circle &gt; 0 {
    // è½¬ç§»åˆ°ä¸‹ä¸€å±‚ï¼Œå°† circle è½¬æ¢ä¸º diff ä¸€éƒ¨åˆ†
    circle--
    timer.item.circle = circle
    // å› ä¸ºæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œè¦åŠ ä¸Š numSlots [ä¹Ÿå°±æ˜¯ç›¸å½“äºè¦èµ°åˆ°ä¸‹ä¸€å±‚]
    timer.item.diff = tw.numSlots + pos - timer.pos
} else {
    // å¦‚æœ offset æå‰äº†ï¼Œæ­¤æ—¶ task ä¹Ÿè¿˜åœ¨ç¬¬ä¸€å±‚
    // æ ‡è®°åˆ é™¤è€çš„ taskï¼Œå¹¶é‡æ–°å…¥é˜Ÿï¼Œç­‰å¾…è¢«æ‰§è¡Œ
    timer.item.removed = true
    newItem := &amp;timingEntry{
        baseEntry: task,
        value:     timer.item.value,
    }
    tw.slots[pos].PushBack(newItem)
    tw.setTimerPosition(pos, newItem)
} } å¤åˆ¶ä»£ç  ä»¥ä¸Šè¿‡ç¨‹æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š
</code></pre></div></div>

<p>delay &lt; internalï¼šå› ä¸º &lt; å•ä¸ªæ—¶é—´ç²¾åº¦ï¼Œè¡¨ç¤ºè¿™ä¸ªä»»åŠ¡å·²ç»è¿‡æœŸï¼Œéœ€è¦é©¬ä¸Šæ‰§è¡Œ
é’ˆå¯¹æ”¹å˜çš„ delayï¼š
new &gt;= oldï¼š&lt;newPos, newCircle, diff&gt;
newCircle &gt; 0ï¼šè®¡ç®—diffï¼Œå¹¶å°† circle è½¬æ¢ä¸º ä¸‹ä¸€å±‚ï¼Œæ•…diff + numslots
å¦‚æœåªæ˜¯å•çº¯å»¶è¿Ÿæ—¶é—´ç¼©çŸ­ï¼Œåˆ™å°†è€çš„taskæ ‡è®°åˆ é™¤ï¼Œé‡æ–°åŠ å…¥listï¼Œç­‰å¾…ä¸‹ä¸€è½®loopè¢«execute</p>

<p>Execute
ä¹‹å‰åœ¨åˆå§‹åŒ–ä¸­ï¼Œrun() ä¸­å®šæ—¶å™¨çš„ä¸æ–­æ¨è¿›ï¼Œæ¨è¿›çš„è¿‡ç¨‹ä¸»è¦å°±æ˜¯æŠŠ listä¸­çš„ task ä¼ ç»™æ‰§è¡Œçš„ execute funcã€‚æˆ‘ä»¬ä»å®šæ—¶å™¨çš„æ‰§è¡Œå¼€å§‹çœ‹ï¼š
// å®šæ—¶å™¨ ã€Œæ¯éš” internal ä¼šæ‰§è¡Œä¸€æ¬¡ã€
func (tw *TimingWheel) onTick() {
  // æ¯æ¬¡æ‰§è¡Œæ›´æ–°ä¸€ä¸‹å½“å‰æ‰§è¡Œ tick ä½ç½®
    tw.tickedPos = (tw.tickedPos + 1) % tw.numSlots
  // è·å–æ­¤æ—¶ tickä½ç½® ä¸­çš„å­˜å‚¨taskçš„åŒå‘é“¾è¡¨
    l := tw.slots[tw.tickedPos]
    tw.scanAndRunTasks(l)
}
å¤åˆ¶ä»£ç 
ç´§æ¥ç€æ˜¯å¦‚ä½•å»æ‰§è¡Œ executeï¼š
func (tw *TimingWheel) scanAndRunTasks(l *list.List) {
    // å­˜å‚¨ç›®å‰éœ€è¦æ‰§è¡Œçš„task{key, value}  [executeæ‰€éœ€è¦çš„å‚æ•°ï¼Œä¾æ¬¡ä¼ é€’ç»™executeæ‰§è¡Œ]
    var tasks []timingTask</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for e := l.Front(); e != nil; {
    task := e.Value.(*timingEntry)
// æ ‡è®°åˆ é™¤ï¼Œåœ¨ scan ä¸­åšçœŸæ­£çš„åˆ é™¤ ã€Œåˆ é™¤mapçš„dataã€
    if task.removed {
        next := e.Next()
        l.Remove(e)
        tw.timers.Del(task.key)
        e = next
        continue
    } else if task.circle &gt; 0 {
        // å½“å‰æ‰§è¡Œç‚¹å·²ç»è¿‡æœŸï¼Œä½†æ˜¯åŒæ—¶ä¸åœ¨ç¬¬ä¸€å±‚ï¼Œæ‰€ä»¥å½“å‰å±‚å³ç„¶å·²ç»å®Œæˆäº†ï¼Œå°±ä¼šé™åˆ°ä¸‹ä¸€å±‚
  // ä½†æ˜¯å¹¶æ²¡æœ‰ä¿®æ”¹ pos
        task.circle--
        e = e.Next()
        continue
    } else if task.diff &gt; 0 {
        // å› ä¸ºä¹‹å‰å·²ç»æ ‡æ³¨äº†diffï¼Œéœ€è¦å†è¿›å…¥é˜Ÿåˆ—
        next := e.Next()
        l.Remove(e)
        pos := (tw.tickedPos + task.diff) % tw.numSlots
        tw.slots[pos].PushBack(task)
        tw.setTimerPosition(pos, task)
        task.diff = 0
        e = next
        continue
    }
    // ä»¥ä¸Šçš„æƒ…å†µéƒ½æ˜¯ä¸èƒ½æ‰§è¡Œçš„æƒ…å†µï¼Œèƒ½å¤Ÿæ‰§è¡Œçš„ä¼šè¢«åŠ å…¥tasksä¸­
    tasks = append(tasks, timingTask{
        key:   task.key,
        value: task.value,
    })
    next := e.Next()
    l.Remove(e)
    tw.timers.Del(task.key)
    e = next
}
// for range tasksï¼Œç„¶åæŠŠæ¯ä¸ª task-&gt;execute æ‰§è¡Œå³å¯
tw.runTasks(tasks) } å¤åˆ¶ä»£ç  å…·ä½“çš„åˆ†æ”¯æƒ…å†µåœ¨æ³¨é‡Šä¸­è¯´æ˜äº†ï¼Œåœ¨çœ‹çš„æ—¶å€™å¯ä»¥å’Œå‰é¢çš„ moveTask() ç»“åˆèµ·æ¥ï¼Œå…¶ä¸­ circle ä¸‹é™ï¼Œdiff çš„è®¡ç®—æ˜¯å…³è”ä¸¤ä¸ªå‡½æ•°çš„é‡ç‚¹ã€‚ è‡³äº diff è®¡ç®—å°±æ¶‰åŠåˆ° pos, circle çš„è®¡ç®—ï¼š // interval: 4min, d: 60min, numSlots: 16, tickedPos = 15 // step = 15, pos = 14, circle = 0 func (tw *TimingWheel) getPositionAndCircle(d time.Duration) (pos int, circle int) {
steps := int(d / tw.interval)
pos = (tw.tickedPos + steps) % tw.numSlots
circle = (steps - 1) / tw.numSlots
return } å¤åˆ¶ä»£ç 
</code></pre></div></div>

<p>ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥ç®€åŒ–æˆä¸‹é¢ï¼š
steps = d / interval
pos = step % numSlots - 1
circle = (step - 1) / numSlots
å¤åˆ¶ä»£ç </p>

<p>æ€»ç»“</p>

<p>timingWheel é å®šæ—¶å™¨æ¨åŠ¨ï¼Œæ—¶é—´å‰è¿›çš„åŒæ—¶ä¼šå–å‡ºå½“å‰æ—¶é—´æ ¼ä¸­ listã€ŒåŒå‘é“¾è¡¨ã€çš„taskï¼Œä¼ é€’åˆ° execute ä¸­æ‰§è¡Œã€‚å› ä¸ºæ˜¯æ˜¯é  internal å›ºå®šæ—¶é—´åˆ»åº¦æ¨è¿›ï¼Œå¯èƒ½å°±ä¼šå‡ºç°ï¼šä¸€ä¸ª 60s çš„taskï¼Œinternal = 1sï¼Œè¿™æ ·å°±ä¼šç©ºè·‘59æ¬¡loopã€‚</p>

<p>è€Œåœ¨æ‰©å±•æ—¶é—´ä¸Šï¼Œé‡‡å– circle åˆ†å±‚ï¼Œè¿™æ ·å°±å¯ä»¥ä¸æ–­å¤ç”¨åŸæœ‰çš„ numSlots ï¼Œå› ä¸ºå®šæ—¶å™¨åœ¨ä¸æ–­ loopï¼Œè€Œæ‰§è¡Œå¯ä»¥æŠŠä¸Šå±‚çš„ slot ä¸‹é™åˆ°ä¸‹å±‚ï¼Œåœ¨ä¸æ–­ loop ä¸­å°±å¯ä»¥æ‰§è¡Œåˆ°ä¸Šå±‚çš„taskã€‚è¿™æ ·çš„è®¾è®¡å¯ä»¥åœ¨ä¸åˆ›é€ é¢å¤–çš„æ•°æ®ç»“æ„ï¼Œçªç ´é•¿æ—¶é—´çš„é™åˆ¶ã€‚</p>

<p>åŒæ—¶åœ¨ go-zero ä¸­è¿˜æœ‰å¾ˆå¤šå®ç”¨çš„ç»„ä»¶å·¥å…·ï¼Œç”¨å¥½å·¥å…·å¯¹äºæå‡æœåŠ¡æ€§èƒ½å’Œå¼€å‘æ•ˆç‡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¸Œæœ›æœ¬ç¯‡æ–‡ç« èƒ½ç»™å¤§å®¶å¸¦æ¥ä¸€äº›æ”¶è·ã€‚</p>

<p>https://juejin.im/post/6881158526668898311</p>

:ET