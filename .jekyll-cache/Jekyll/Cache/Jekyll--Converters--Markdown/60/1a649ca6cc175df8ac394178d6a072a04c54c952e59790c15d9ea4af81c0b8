I"ıÛ<p>åœ¨mysqlå·¥ä½œä¸­æ¥è§¦æœ€å¤šçš„å°±æ˜¯mysql replicationï¼Œmysqlåœ¨å¤åˆ¶æ–¹é¢è¿˜æ˜¯ä¼šæœ‰ä¸€äº›å¸¸è§„é—®é¢˜ï¼Œæ¯”å¦‚ä¸»åº“å®•æœºæˆ–è€…ä»åº“å®•æœºæœ‰å¯èƒ½ä¼šå¯¼è‡´å¤åˆ¶ä¸­æ–­ï¼Œé€šå¸¸éœ€è¦è¿›è¡Œäººä¸ºä¿®å¤ï¼Œæˆ–è€…å¾ˆå¤šæ—¶å€™éœ€è¦æŠŠä¸€ä¸ªä»åº“æå‡ä¸ºä¸»åº“ï¼Œä½†å¯¹ä»åº“å’Œä¸»åº“çš„æ•°æ®ä¸€è‡´æ€§ä¸èƒ½ä¿è¯ä¸€æ ·ã€‚è¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ä½¿ç”¨percona-toolkitå·¥å…·çš„pt-table-checksumç»„ä»¶æ¥æ£€æŸ¥ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼›å¦‚æœå‘ç°ä¸ä¸€è‡´çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡pt-table-syncä¿®å¤ï¼›è¿˜å¯ä»¥é€šè¿‡pt-heartbeatç›‘æ§ä¸»ä»å¤åˆ¶å»¶è¿Ÿã€‚å½“ç„¶å¦‚æœæ•°æ®é‡å°ï¼Œslaveåªæ˜¯å½“åšä¸€ä¸ªå¤‡ä»½ä½¿ç”¨ï¼Œé‚£ä¹ˆå‡ºç°æ•°æ®ä¸ä¸€è‡´å®Œå…¨å¯ä»¥é‡åšï¼Œæˆ–è€…é€šè¿‡å…¶ä»–æ–¹æ³•è§£å†³ã€‚å¦‚æœæ•°æ®é‡éå¸¸å¤§ï¼Œé‡åšå°±æ˜¯éå¸¸è›‹ç¢çš„ä¸€ä»¶äº‹æƒ…äº†ã€‚æ¯”å¦‚è¯´ï¼Œçº¿ä¸Šæ•°æ®åº“åšäº†ä¸»ä»åŒæ­¥ç¯å¢ƒï¼Œæ•°æ®åº“åœ¨è¿›è¡Œäº†è¿ç§»åï¼Œéœ€è¦å¯¹mysqlè¿ç§»ï¼ˆReplicationï¼‰åçš„æ•°æ®ä¸€è‡´æ€§è¿›è¡Œæ ¡éªŒï¼Œä½†åˆä¸èƒ½å¯¹ç”Ÿäº§ç¯å¢ƒä½¿ç”¨é€ æˆå½±å“ï¼Œpt-table-checksumæˆä¸ºäº†ç»ä½³ä¹Ÿæ˜¯å”¯ä¸€çš„æ£€æŸ¥å·¥å…·ã€‚</p>

<p>percona-toolkitä»‹ç»
percona-toolkitæ˜¯ä¸€ç»„é«˜çº§å‘½ä»¤è¡Œå·¥å…·çš„é›†åˆï¼Œç”¨æ¥æ‰§è¡Œå„ç§é€šè¿‡æ‰‹å·¥æ‰§è¡Œéå¸¸å¤æ‚å’Œéº»çƒ¦çš„mysqlå’Œç³»ç»Ÿä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡åŒ…æ‹¬ï¼š
   1ï¼‰æ£€æŸ¥masterå’Œslaveæ•°æ®çš„ä¸€è‡´æ€§
   2ï¼‰æœ‰æ•ˆåœ°å¯¹è®°å½•è¿›è¡Œå½’æ¡£
   3ï¼‰æŸ¥æ‰¾é‡å¤çš„ç´¢å¼•
   4ï¼‰å¯¹æœåŠ¡å™¨ä¿¡æ¯è¿›è¡Œæ±‡æ€»
   5ï¼‰åˆ†ææ¥è‡ªæ—¥å¿—å’Œtcpdumpçš„æŸ¥è¯¢
   6ï¼‰å½“ç³»ç»Ÿå‡ºé—®é¢˜çš„æ—¶å€™æ”¶é›†é‡è¦çš„ç³»ç»Ÿä¿¡æ¯
percona-toolkitæºè‡ªMaatkitå’ŒAspersaå·¥å…·ï¼Œè¿™ä¸¤ä¸ªå·¥å…·æ˜¯ç®¡ç†mysqlçš„æœ€æœ‰åçš„å·¥å…·ã€‚ä¸è¿‡ï¼Œç°åœ¨Maatkitå·¥å…·å·²ç»ä¸ç»´æŠ¤äº†ï¼Œæ‰€ä»¥ä»¥åæ¨èè¿˜æ˜¯ä½¿ç”¨percona-toolkitå·¥å…·ï¼
è¿™äº›å·¥å…·ä¸»è¦åŒ…æ‹¬å¼€å‘ã€æ€§èƒ½ã€é…ç½®ã€ç›‘æ§ã€å¤åˆ¶ã€ç³»ç»Ÿã€å®ç”¨å…­å¤§ç±»ï¼Œä½œä¸ºä¸€ä¸ªä¼˜ç§€çš„DBAï¼Œé‡Œé¢æœ‰çš„å·¥å…·éå¸¸æœ‰ç”¨ï¼Œå¦‚æœèƒ½æŒæ¡å¹¶åŠ ä»¥çµæ´»åº”ç”¨ï¼Œå°†èƒ½æå¤§çš„æé«˜å·¥ä½œæ•ˆç‡ã€‚</p>

<p>percona-toolkitå·¥å…·ä¸­æœ€ä¸»è¦çš„ä¸‰ä¸ªç»„ä»¶åˆ†åˆ«æ˜¯ï¼š
   1ï¼‰pt-table-checksum è´Ÿè´£ç›‘æµ‹mysqlä¸»ä»æ•°æ®ä¸€è‡´æ€§
   2ï¼‰pt-table-sync è´Ÿè´£å½“ä¸»ä»æ•°æ®ä¸ä¸€è‡´æ—¶ä¿®å¤æ•°æ®ï¼Œè®©å®ƒä»¬ä¿å­˜æ•°æ®çš„ä¸€è‡´æ€§
   3ï¼‰pt-heartbeat è´Ÿè´£ç›‘æ§mysqlä¸»ä»åŒæ­¥å»¶è¿Ÿ
ä¸‹é¢å°±å¯¹è¿™ä¸‰ä¸ªç»„ä»¶çš„ä½¿ç”¨åšä¸€è®°å½•ï¼Œå½“ç„¶percona-toolkitå·¥å…·ä¹Ÿæœ‰å¾ˆå¤šå…¶ä»–ç»„ä»¶ï¼Œåé¢ä¼šä¸€ä¸€è¯´æ˜ã€‚</p>

<p>percona-toolkitå·¥å…·å®‰è£…ï¼ˆå»ºè®®ä¸»åº“å’Œä»åº“æœåŠ¡å™¨ä¸Šéƒ½å®‰è£…ï¼‰
è½¯ä»¶ä¸‹è½½å¹¶åœ¨ä¸»åº“æœåŠ¡å™¨ä¸Šå®‰è£… [ç™¾åº¦äº‘ç›˜ä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1bp1OOgf   ï¼ˆæå–å¯†ç ï¼šy462ï¼‰]
[root@master-server src]# wget https://www.percona.com/downloads/percona-toolkit/2.2.7/RPM/percona-toolkit-2.2.7-1.noarch.rpm
[root@master-server src]# rpm -ivh percona-toolkit-2.2.7-1.noarch.rpm     //å®‰è£…åï¼Œpercona-toolkitå·¥å…·çš„å„ä¸ªç»„ä»¶å‘½ä»¤å°±æœ‰æœ‰äº†ï¼ˆè¾“å…¥ht-ï¼ŒæŒ‰TABé”®å°±ä¼šæ˜¾ç¤ºï¼‰</p>

<p>å®‰è£…è¯¥å·¥å…·ä¾èµ–çš„è½¯ä»¶åŒ…
[root@master-server src]# yum install perl-IO-Socket-SSL perl-DBD-MySQL perl-Time-HiRes perl perl-DBI -y</p>

<p>ä¸€ã€pt-table-checksumä½¿ç”¨æ¢³ç†
pt-table-checksum æ˜¯ Percona-Toolkitçš„ç»„ä»¶ä¹‹ä¸€ï¼Œç”¨äºæ£€æµ‹MySQLä¸»ã€ä»åº“çš„æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚å…¶åŸç†æ˜¯åœ¨ä¸»åº“æ‰§è¡ŒåŸºäºstatementçš„sqlè¯­å¥æ¥ç”Ÿæˆä¸»åº“æ•°æ®å—çš„checksumï¼ŒæŠŠç›¸åŒçš„sqlè¯­å¥ä¼ é€’åˆ°ä»åº“æ‰§è¡Œï¼Œå¹¶åœ¨ä»åº“ä¸Šè®¡ç®—ç›¸åŒæ•°æ®å—çš„checksumï¼Œæœ€åï¼Œæ¯”è¾ƒä¸»ä»åº“ä¸Šç›¸åŒæ•°æ®å—çš„checksumå€¼ï¼Œç”±æ­¤åˆ¤æ–­ä¸»ä»æ•°æ®æ˜¯å¦ä¸€è‡´ã€‚æ£€æµ‹è¿‡ç¨‹æ ¹æ®å”¯ä¸€ç´¢å¼•å°†è¡¨æŒ‰rowåˆ‡åˆ†ä¸ºå—ï¼ˆchunkï¼‰ï¼Œä»¥ä¸ºå•ä½è®¡ç®—ï¼Œå¯ä»¥é¿å…é”è¡¨ã€‚æ£€æµ‹æ—¶ä¼šè‡ªåŠ¨åˆ¤æ–­å¤åˆ¶å»¶è¿Ÿã€ masterçš„è´Ÿè½½ï¼Œ è¶…è¿‡é˜€å€¼åä¼šè‡ªåŠ¨å°†æ£€æµ‹æš‚åœï¼Œå‡å°å¯¹çº¿ä¸ŠæœåŠ¡çš„å½±å“ã€‚
pt-table-checksum é»˜è®¤æƒ…å†µä¸‹å¯ä»¥åº”å¯¹ç»å¤§éƒ¨åˆ†åœºæ™¯ï¼Œå®˜æ–¹è¯´ï¼Œå³ä½¿ä¸Šåƒä¸ªåº“ã€ä¸Šä¸‡äº¿çš„è¡Œï¼Œå®ƒä¾ç„¶å¯ä»¥å¾ˆå¥½çš„å·¥ä½œï¼Œè¿™æºè‡ªäºè®¾è®¡å¾ˆç®€å•ï¼Œä¸€æ¬¡æ£€æŸ¥ä¸€ä¸ªè¡¨ï¼Œä¸éœ€è¦å¤ªå¤šçš„å†…å­˜å’Œå¤šä½™çš„æ“ä½œï¼›å¿…è¦æ—¶ï¼Œpt-table-checksum ä¼šæ ¹æ®æœåŠ¡å™¨è´Ÿè½½åŠ¨æ€æ”¹å˜ chunk å¤§å°ï¼Œå‡å°‘ä»åº“çš„å»¶è¿Ÿã€‚</p>

<p>ä¸ºäº†å‡å°‘å¯¹æ•°æ®åº“çš„å¹²é¢„ï¼Œpt-table-checksumè¿˜ä¼šè‡ªåŠ¨ä¾¦æµ‹å¹¶è¿æ¥åˆ°ä»åº“ï¼Œå½“ç„¶å¦‚æœå¤±è´¥ï¼Œå¯ä»¥æŒ‡å®šâ€“recursion-methodé€‰é¡¹æ¥å‘Šè¯‰ä»åº“åœ¨å“ªé‡Œã€‚å®ƒçš„æ˜“ç”¨æ€§è¿˜ä½“ç°åœ¨ï¼Œå¤åˆ¶è‹¥æœ‰å»¶è¿Ÿï¼Œåœ¨ä»åº“ checksum ä¼šæš‚åœç›´åˆ°èµ¶ä¸Šä¸»åº“çš„è®¡ç®—æ—¶é—´ç‚¹ï¼ˆä¹Ÿé€šè¿‡é€‰é¡¹â€“è®¾å®šä¸€ä¸ªå¯å®¹å¿çš„å»¶è¿Ÿæœ€å¤§å€¼ï¼Œè¶…è¿‡è¿™ä¸ªå€¼ä¹Ÿè®¤ä¸ºä¸ä¸€è‡´ï¼‰ã€‚</p>

<p>ä¸ºäº†ä¿è¯ä¸»æ•°æ®åº“æœåŠ¡çš„å®‰å…¨ï¼Œè¯¥å·¥å…·å®ç°äº†è®¸å¤šä¿æŠ¤æªæ–½ï¼š
    1ï¼‰è‡ªåŠ¨è®¾ç½® innodb_lock_wait_timeout ä¸º1sï¼Œé¿å…å¼•èµ·
    2ï¼‰é»˜è®¤å½“æ•°æ®åº“æœ‰25ä¸ªä»¥ä¸Šçš„å¹¶å‘æŸ¥è¯¢æ—¶ï¼Œpt-table-checksumä¼šæš‚åœã€‚å¯ä»¥è®¾ç½® â€“max-load é€‰é¡¹æ¥è®¾ç½®è¿™ä¸ªé˜€å€¼
    3ï¼‰å½“ç”¨ Ctrl+C åœæ­¢ä»»åŠ¡åï¼Œå·¥å…·ä¼šæ­£å¸¸çš„å®Œæˆå½“å‰ chunk æ£€æµ‹ï¼Œä¸‹æ¬¡ä½¿ç”¨ â€“resume é€‰é¡¹å¯åŠ¨å¯ä»¥æ¢å¤ç»§ç»­ä¸‹ä¸€ä¸ª chunk</p>

<p>pt-table-checksum [OPTIONS] [DSN]
pt-table-checksumï¼šåœ¨ä¸»ï¼ˆmasterï¼‰ä¸Šé€šè¿‡æ‰§è¡Œæ ¡éªŒçš„æŸ¥è¯¢å¯¹å¤åˆ¶çš„ä¸€è‡´æ€§è¿›è¡Œæ£€æŸ¥ï¼Œå¯¹æ¯”ä¸»ä»çš„æ ¡éªŒå€¼ï¼Œä»è€Œäº§ç”Ÿç»“æœã€‚DSNæŒ‡å‘çš„æ˜¯ä¸»çš„åœ°å€ï¼Œè¯¥å·¥å…·çš„é€€å‡ºçŠ¶æ€ä¸ä¸ºé›¶ï¼Œå¦‚æœå‘ç°æœ‰ä»»ä½•å·®åˆ«ï¼Œæˆ–è€…å¦‚æœå‡ºç°ä»»ä½•è­¦å‘Šæˆ–é”™è¯¯ã€‚æ³¨æ„ï¼šç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™éœ€è¦åŠ ä¸Šâ€“create-replicate-tableå‚æ•°ï¼Œç”Ÿæˆchecksumsè¡¨ï¼ï¼å¦‚æœä¸åŠ è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå°±éœ€è¦åœ¨å¯¹åº”åº“ä¸‹æ‰‹å·¥æ·»åŠ è¿™å¼ è¡¨äº†,è¡¨ç»“æ„SQLå¦‚ä¸‹ï¼š
CREATE TABLE checksums (
   db             char(64)     NOT NULL,
   tbl            char(64)     NOT NULL,
   chunk          int          NOT NULL,
   chunk_time     float            NULL,
   chunk_index    varchar(200)     NULL,
   lower_boundary text             NULL,
   upper_boundary text             NULL,
   this_crc       char(40)     NOT NULL,
   this_cnt       int          NOT NULL,
   master_crc     char(40)         NULL,
   master_cnt     int              NULL,
   ts             timestamp    NOT NULL,
   PRIMARY KEY (db, tbl, chunk),
   INDEX ts_db_tbl (ts, db, tbl)
) ENGINE=InnoDB;
å¸¸ç”¨å‚æ•°è§£é‡Šï¼š
â€“nocheck-replication-filters ï¼šä¸æ£€æŸ¥å¤åˆ¶è¿‡æ»¤å™¨ï¼Œå»ºè®®å¯ç”¨ã€‚åé¢å¯ä»¥ç”¨â€“databasesæ¥æŒ‡å®šéœ€è¦æ£€æŸ¥çš„æ•°æ®åº“ã€‚
â€“no-check-binlog-format : ä¸æ£€æŸ¥å¤åˆ¶çš„binlogæ¨¡å¼ï¼Œè¦æ˜¯binlogæ¨¡å¼æ˜¯ROWï¼Œåˆ™ä¼šæŠ¥é”™ã€‚
â€“replicate-check-only :åªæ˜¾ç¤ºä¸åŒæ­¥çš„ä¿¡æ¯ã€‚
â€“replicate= ï¼šæŠŠchecksumçš„ä¿¡æ¯å†™å…¥åˆ°æŒ‡å®šè¡¨ä¸­ï¼Œå»ºè®®ç›´æ¥å†™åˆ°è¢«æ£€æŸ¥çš„æ•°æ®åº“å½“ä¸­ã€‚
â€“databases= ï¼šæŒ‡å®šéœ€è¦è¢«æ£€æŸ¥çš„æ•°æ®åº“ï¼Œå¤šä¸ªåˆ™ç”¨é€—å·éš”å¼€ã€‚
â€“tables= ï¼šæŒ‡å®šéœ€è¦è¢«æ£€æŸ¥çš„è¡¨ï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€
h= ï¼šMasterçš„åœ°å€
u= ï¼šç”¨æˆ·å
p=ï¼šå¯†ç 
P= ï¼šç«¯å£</p>

<p>æœ€é‡è¦çš„ä¸€ç‚¹å°±æ˜¯ï¼š
è¦åœ¨ä¸»åº“ä¸Šæˆæƒï¼Œèƒ½è®©ä¸»åº“ipè®¿é—®ã€‚è¿™ä¸€ç‚¹ä¸èƒ½å¿˜è®°ï¼ï¼ˆå®éªŒè¯æ˜ä»åº“ä¸Šå¯ä»¥ä¸æˆæƒï¼Œä½†æœ€å¥½è¿˜æ˜¯ä»åº“ä¹Ÿæˆæƒï¼‰
æ³¨æ„ï¼š
1ï¼‰æ ¹æ®æµ‹è¯•ï¼Œéœ€è¦ä¸€ä¸ªå³èƒ½ç™»å½•ä¸»åº“ï¼Œä¹Ÿèƒ½ç™»å½•ä»åº“çš„è´¦å·ï¼›
2ï¼‰åªèƒ½æŒ‡å®šä¸€ä¸ªhostï¼Œå¿…é¡»ä¸ºä¸»åº“çš„IPï¼›
3ï¼‰åœ¨æ£€æŸ¥æ—¶ä¼šå‘è¡¨åŠ Sé”ï¼›
4ï¼‰è¿è¡Œä¹‹å‰éœ€è¦ä»åº“çš„åŒæ­¥IOå’ŒSQLè¿›ç¨‹æ˜¯YESçŠ¶æ€ã€‚</p>

<p>ä¾‹å¦‚ï¼šï¼ˆæœ¬æ–‡ä¾‹å­ä¸­ï¼š192.168.1.101æ˜¯ä¸»åº“ipï¼Œ192.168.1.102æ˜¯ä»åº“ipï¼‰
åœ¨ä¸»åº“æ‰§è¡Œæˆæƒï¼ˆä¸€å®šè¦å¯¹ä¸»åº“ipæˆæƒï¼Œæˆæƒçš„ç”¨æˆ·åå’Œå¯†ç å¯ä»¥è‡ªè¡Œå®šä¹‰ï¼Œä¸è¿‡è¦ä¿è¯è¿™ä¸ªæƒé™èƒ½åŒæ—¶ç™»é™†ä¸»åº“å’Œä»åº“ï¼‰
mysql&gt; GRANT SELECT, PROCESS, SUPER, REPLICATION SLAVE,CREATE,DELETE,INSERT,UPDATE ON <em>.</em> TO â€˜rootâ€™@â€™192.168.1.101â€™ identified by â€˜123456â€™;
mysql&gt; flush privileges;</p>

<p>åœ¨ä»åº“ä¸Šæ‰§è¡Œæˆæƒ
mysql&gt; GRANT SELECT, PROCESS, SUPER, REPLICATION SLAVE ON <em>.</em> TO â€˜rootâ€™@â€™192.168.1.101â€™ IDENTIFIED BY â€˜123456â€™;
mysql&gt; flush privileges;</p>

<p>å¦‚ä¸‹ï¼Œåœ¨ä¸»åº“ä¸Šæ‰§è¡Œçš„ä¸€ä¸ªæ£€æŸ¥ä¸»ä»æ•°æ®ä¸€è‡´æ€§çš„å‘½ä»¤ï¼ˆåˆ«å¿˜äº†ç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™éœ€è¦æ·»åŠ â€“create-replicate-tableå‚æ•°ï¼Œåç»­å†è¿è¡Œæ—¶å°±ä¸éœ€è¦åŠ äº†ï¼‰ï¼š
ä¸‹é¢å‘½ä»¤ä¸­çš„192.168.1.101æ˜¯ä¸»åº“ip
æ£€æŸ¥çš„æ˜¯huanqiuåº“ä¸‹çš„hahaè¡¨çš„æ•°æ®ï¼ˆå½“ç„¶ï¼Œå‘½ä»¤ä¸­ä¹Ÿå¯ä»¥ä¸è·Ÿè¡¨ï¼Œç›´æ¥æ£€æŸ¥æŸæ•´ä¸ªåº“çš„æ•°æ®ï¼›å¦‚ä¸‹å»æ‰â€“tables=hahaè¡¨ï¼Œç›´æ¥æ£€æŸ¥huanqiuåº“çš„æ•°æ®ï¼‰
[root@master-server ~]# pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanqiu.checksums â€“create-replicate-table â€“databases=huanqiu â€“tables=haha h=192.168.1.101,u=root,p=123456,P=3306
Diffs cannot be detected because no slaves were found.  Please read the â€“recursion-method documentation for information.
            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
01-08T04:04:54      0      0        4       1       0   0.009 huanqiu.haha
ä¸Šé¢æœ‰æŠ¥é”™ï¼š
Diffs cannot be detected because no slaves were found. Please read the â€“recursion-method documentation for information
ä¸Šé¢çš„æç¤ºä¿¡æ¯å¾ˆæ¸…æ¥šï¼Œå› ä¸ºæ‰¾ä¸åˆ°ä»ï¼Œæ‰€ä»¥æ‰§è¡Œå¤±è´¥ï¼Œæç¤ºç”¨å‚æ•°â€“recursion-method å¯ä»¥æŒ‡å®šæ¨¡å¼è§£å†³ã€‚
å…¶å®æ˜¯å› ä¸ºä»åº“çš„slaveå…³é—­äº†ã€‚
åœ¨ä¸»åº“ä¸Šæ‰§è¡Œï¼š
mysql&gt; show processlist;
+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”-+â€”â€”â€”â€”â€”â€”+
| Id | User | Host      | db   | Command | Time | State | Info             |
+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”-+â€”â€”â€”â€”â€”â€”+
| 10 | root | localhost | NULL | Query   |    0 | init  | show processlist |
+â€”-+â€”â€”+â€”â€”â€”â€“+â€”â€”+â€”â€”â€”+â€”â€”+â€”â€”-+â€”â€”â€”â€”â€”â€”+
å‘ç°æ²¡æœ‰slaveåœ¨è¿è¡Œã€‚</p>

<p>åœ¨ä»åº“ä¸Šå¼€å¯slave
mysql&gt; start slave;
mysql&gt; show slave status\G;</p>

<p>å†åœ¨ä¸»åº“ä¸Šæ‰§è¡Œï¼š
mysql&gt; show processlist;
+â€”-+â€”â€”-+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+
| Id | User  | Host                | db   | Command     | Time | State                                                                 | Info             |
+â€”-+â€”â€”-+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+
| 10 | root  | localhost           | NULL | Query       |    0 | init                                                                  | show processlist |
| 18 | slave | 192.168.1.102:37115 | NULL | Binlog Dump |    5 | Master has sent all binlog to slave; waiting for binlog to be updated | NULL             |
+â€”-+â€”â€”-+â€”â€”â€”â€”â€”â€”â€”+â€”â€”+â€”â€”â€”â€”-+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€”â€”+
å‘ç°å·²æœ‰slaveåœ¨è¿è¡Œã€‚</p>

<p>å†æ¬¡æ‰§è¡Œæ£€æŸ¥å‘½ä»¤ï¼š
[root@master-server ~]# pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanqiu.checksums â€“databases=huanqiu â€“tables=haha h=192.168.1.101,u=root,p=123456,P=3306
            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
01-08T04:11:03      0      0        4       1       0   1.422 huanqiu.haha
è§£é‡Šï¼š
TS ï¼šå®Œæˆæ£€æŸ¥çš„æ—¶é—´ã€‚
ERRORS ï¼šæ£€æŸ¥æ—¶å€™å‘ç”Ÿé”™è¯¯å’Œè­¦å‘Šçš„æ•°é‡ã€‚
DIFFS ï¼š0è¡¨ç¤ºä¸€è‡´ï¼Œ1è¡¨ç¤ºä¸ä¸€è‡´ã€‚å½“æŒ‡å®šâ€“no-replicate-checkæ—¶ï¼Œä¼šä¸€ç›´ä¸º0ï¼Œå½“æŒ‡å®šâ€“replicate-check-onlyä¼šæ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯ã€‚
ROWS ï¼šè¡¨çš„è¡Œæ•°ã€‚
CHUNKS ï¼šè¢«åˆ’åˆ†åˆ°è¡¨ä¸­çš„å—çš„æ•°ç›®ã€‚
SKIPPED ï¼šç”±äºé”™è¯¯æˆ–è­¦å‘Šæˆ–è¿‡å¤§ï¼Œåˆ™è·³è¿‡å—çš„æ•°ç›®ã€‚
TIME ï¼šæ‰§è¡Œçš„æ—¶é—´ã€‚
TABLE ï¼šè¢«æ£€æŸ¥çš„è¡¨åã€‚</p>

<p>äºŒã€pt-table-syncç”¨æ³•æ¢³ç†
å¦‚æœé€šè¿‡pt-table-checksum æ£€æŸ¥æ‰¾åˆ°äº†ä¸ä¸€è‡´çš„æ•°æ®è¡¨ï¼Œé‚£ä¹ˆå¦‚ä½•åŒæ­¥æ•°æ®å‘¢ï¼Ÿå³å¦‚ä½•ä¿®å¤MySQLä¸»ä»ä¸ä¸€è‡´çš„æ•°æ®ï¼Œè®©ä»–ä»¬ä¿æŒä¸€è‡´æ€§å‘¢ï¼Ÿ
è¿™æ—¶å€™å¯ä»¥åˆ©ç”¨å¦å¤–ä¸€ä¸ªå·¥å…·pt-table-syncã€‚
ä½¿ç”¨æ–¹æ³•ï¼š
pt-table-sync: é«˜æ•ˆçš„åŒæ­¥MySQLè¡¨ä¹‹é—´çš„æ•°æ®ï¼Œä»–å¯ä»¥åšå•å‘å’ŒåŒå‘åŒæ­¥çš„è¡¨æ•°æ®ã€‚ä»–å¯ä»¥åŒæ­¥å•ä¸ªè¡¨ï¼Œä¹Ÿå¯ä»¥åŒæ­¥æ•´ä¸ªåº“ã€‚å®ƒä¸åŒæ­¥è¡¨ç»“æ„ã€ç´¢å¼•ã€æˆ–ä»»ä½•å…¶ä»–æ¨¡å¼å¯¹è±¡ã€‚æ‰€ä»¥åœ¨ä¿®å¤ä¸€è‡´æ€§ä¹‹å‰éœ€è¦ä¿è¯ä»–ä»¬è¡¨å­˜åœ¨ã€‚</p>

<p>å‡å¦‚ä¸Šé¢æ£€æŸ¥æ•°æ®æ—¶å‘ç°ä¸»ä»ä¸ä¸€è‡´
[root@master-server ~]# pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanqiu.checksums â€“databases=huanqiu â€“tables=haha h=192.168.1.101,u=root,p=123456,P=3306
            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
01-08T04:18:07      0      1        4       1       0   0.843 huanqiu.haha
ç°åœ¨éœ€è¦DIFFSä¸º1å¯çŸ¥ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œéœ€è¦ä¿®å¤ï¼ä¿®å¤å‘½ä»¤å¦‚ä¸‹ï¼š
å…ˆmasterçš„ipï¼Œç”¨æˆ·ï¼Œå¯†ç ï¼Œç„¶åæ˜¯slaveçš„ipï¼Œç”¨æˆ·ï¼Œå¯†ç 
[root@master-server ~]# pt-table-sync â€“replicate=huanqiu.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“print
REPLACE INTO <code class="language-plaintext highlighter-rouge">huanqiu</code>.<code class="language-plaintext highlighter-rouge">haha</code>(<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">name</code>) VALUES (â€˜1â€™, â€˜wangshiboâ€™) /<em>percona-toolkit src_db:huanqiu src_tbl:haha src_dsn:h=192.168.1.101,p=â€¦,u=root dst_db:huanqiu dst_tbl:haha dst_dsn:h=192.168.1.102,p=â€¦,u=root lock:1 transaction:1 changing_src:huanqiu.checksums replicate:huanqiu.checksums bidirectional:0 pid:23676 user:root host:master-server</em>/;
REPLACE INTO <code class="language-plaintext highlighter-rouge">huanqiu</code>.<code class="language-plaintext highlighter-rouge">haha</code>(<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">name</code>) VALUES (â€˜2â€™, â€˜wangshikuiâ€™) /<em>percona-toolkit src_db:huanqiu src_tbl:haha src_dsn:h=192.168.1.101,p=â€¦,u=root dst_db:huanqiu dst_tbl:haha dst_dsn:h=192.168.1.102,p=â€¦,u=root lock:1 transaction:1 changing_src:huanqiu.checksums replicate:huanqiu.checksums bidirectional:0 pid:23676 user:root host:master-server</em>/;
REPLACE INTO <code class="language-plaintext highlighter-rouge">huanqiu</code>.<code class="language-plaintext highlighter-rouge">haha</code>(<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">name</code>) VALUES (â€˜3â€™, â€˜limengâ€™) /<em>percona-toolkit src_db:huanqiu src_tbl:haha src_dsn:h=192.168.1.101,p=â€¦,u=root dst_db:huanqiu dst_tbl:haha dst_dsn:h=192.168.1.102,p=â€¦,u=root lock:1 transaction:1 changing_src:huanqiu.checksums replicate:huanqiu.checksums bidirectional:0 pid:23676 user:root host:master-server</em>/;
REPLACE INTO <code class="language-plaintext highlighter-rouge">huanqiu</code>.<code class="language-plaintext highlighter-rouge">haha</code>(<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">name</code>) VALUES (â€˜4â€™, â€˜wanghiâ€™) /<em>percona-toolkit src_db:huanqiu src_tbl:haha src_dsn:h=192.168.1.101,p=â€¦,u=root dst_db:huanqiu dst_tbl:haha dst_dsn:h=192.168.1.102,p=â€¦,u=root lock:1 transaction:1 changing_src:huanqiu.checksums replicate:huanqiu.checksums bidirectional:0 pid:23676 user:root host:master-server</em>/;
å‚æ•°è§£é‡Šï¼š
â€“replicate= ï¼šæŒ‡å®šé€šè¿‡pt-table-checksumå¾—åˆ°çš„è¡¨ï¼Œè¿™2ä¸ªå·¥å…·å·®ä¸å¤šéƒ½ä¼šä¸€ç›´ç”¨ã€‚
â€“databases= : æŒ‡å®šæ‰§è¡ŒåŒæ­¥çš„æ•°æ®åº“ã€‚
â€“tables= ï¼šæŒ‡å®šæ‰§è¡ŒåŒæ­¥çš„è¡¨ï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€ã€‚
â€“sync-to-master ï¼šæŒ‡å®šä¸€ä¸ªDSNï¼Œå³ä»çš„IPï¼Œä»–ä¼šé€šè¿‡show processlistæˆ–show slave status å»è‡ªåŠ¨çš„æ‰¾ä¸»ã€‚
h= ï¼šæœåŠ¡å™¨åœ°å€ï¼Œå‘½ä»¤é‡Œæœ‰2ä¸ªipï¼Œç¬¬ä¸€æ¬¡å‡ºç°çš„æ˜¯Masterçš„åœ°å€ï¼Œç¬¬2æ¬¡æ˜¯Slaveçš„åœ°å€ã€‚
u= ï¼šå¸å·ã€‚
p= ï¼šå¯†ç ã€‚
â€“print ï¼šæ‰“å°ï¼Œä½†ä¸æ‰§è¡Œå‘½ä»¤ã€‚
â€“execute ï¼šæ‰§è¡Œå‘½ä»¤ã€‚</p>

<p>ä¸Šé¢å‘½ä»¤ä»‹ç»å®Œäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ‰§è¡Œä¿®å¤ï¼š
é€šè¿‡ï¼ˆâ€“printï¼‰æ‰“å°å‡ºæ¥äº†ä¿®å¤æ•°æ®çš„sqlè¯­å¥ï¼Œå¯ä»¥æ‰‹åŠ¨çš„åœ¨slaveä»åº“ä¸Šæ‰§è¡Œï¼Œè®©ä»–ä»¬æ•°æ®ä¿æŒä¸€è‡´æ€§ï¼Œè¿™æ ·æ¯”è¾ƒéº»çƒ¦ï¼
å¯ä»¥ç›´æ¥åœ¨masterä¸»åº“ä¸Šæ‰§è¡Œä¿®å¤æ“ä½œï¼Œé€šè¿‡â€“executeå‚æ•°ï¼Œå¦‚ä¸‹ï¼š
[root@master-server ~]# pt-table-sync â€“replicate=huanqiu.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“execute</p>

<p>å¦‚ä¸Šä¿®å¤åï¼Œå†æ¬¡æ£€æŸ¥ï¼Œå‘ç°ä¸»ä»åº“æ•°æ®å·²ç»ä¸€è‡´äº†ï¼
[root@master-server ~]# pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanqiu.checksums â€“databases=huanqiu â€“tables=haha h=192.168.1.101,u=root,p=123456,P=3306
            TS ERRORS  DIFFS     ROWS  CHUNKS SKIPPED    TIME TABLE
01-08T04:36:43      0      0        4       1       0   0.040 huanqiu.haha
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“
å»ºè®®:
ä¿®å¤æ•°æ®çš„æ—¶å€™ï¼Œæœ€å¥½è¿˜æ˜¯ç”¨â€“printæ‰“å°å‡ºæ¥çš„å¥½ï¼Œè¿™æ ·å°±å¯ä»¥çŸ¥é“é‚£äº›æ•°æ®æœ‰é—®é¢˜ï¼Œå¯ä»¥äººä¸ºçš„å¹²é¢„ä¸‹ã€‚
ä¸ç„¶ç›´æ¥æ‰§è¡Œäº†ï¼Œå‡ºç°é—®é¢˜ä¹‹åæ›´ä¸å¥½å¤„ç†ã€‚æ€»ä¹‹è¿˜æ˜¯åœ¨å¤„ç†ä¹‹å‰åšå¥½æ•°æ®çš„å¤‡ä»½å·¥ä½œã€‚</p>

<p>æ³¨æ„ï¼šè¦æ˜¯è¡¨ä¸­æ²¡æœ‰å”¯ä¸€ç´¢å¼•æˆ–åˆ™ä¸»é”®åˆ™ä¼šæŠ¥é”™ï¼š
Canâ€™t make changes on the master because no unique index exists at /usr/local/bin/pt-table-sync line 10591.
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“
ä¸ºäº†ç¡®ä¿ä¸»ä»æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¯ä»¥ç¼–å†™ç›‘æ§è„šæœ¬ï¼Œå®šæ—¶æ£€æŸ¥ã€‚å½“æ£€æŸ¥åˆ°ä¸»ä»æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œå¼ºåˆ¶ä¿®å¤æ•°æ®ã€‚
[root@master-server ~]# cat /root/pt_huanqiu.sh
#!/bin/bash
NUM=$(/usr/bin/pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanqiu.checksums â€“databases=huanqiu  h=192.168.1.101,u=root,p=123456,P=3306|awk -Fâ€ â€œ â€˜{print $3}â€™|sed -n â€˜2pâ€™)
if [ $NUM -eq 1 ];then
  /usr/bin/pt-table-sync â€“replicate=huanqiu.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“print
  /usr/bin/pt-table-sync â€“replicate=huanqiu.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“execute
else
  echo â€œdata is okâ€
fi
[root@master-server ~]# cat /root/pt_huanpc.sh 
#!/bin/bash
NUM=$(/usr/bin/pt-table-checksum â€“nocheck-replication-filters â€“no-check-binlog-format â€“replicate=huanpc.checksums â€“databases=huanpc  h=192.168.1.101,u=root,p=123456,P=3306|awk -Fâ€ â€œ â€˜{print $3}â€™|sed -n â€˜2pâ€™)
if [ $NUM -eq 1 ];then
  /usr/bin/pt-table-sync â€“replicate=huanpc.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“print
  /usr/bin/pt-table-sync â€“replicate=huanpc.checksums h=192.168.1.101,u=root,p=123456 h=192.168.1.102,u=root,p=123456 â€“execute
else
  echo â€œdata is okâ€
fi
[root@master-server ~]# crontab -l
#æ£€æŸ¥ä¸»ä»huanqiuåº“æ•°æ®ä¸€è‡´æ€§</p>
<ul>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 10;/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 20;/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 30;/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 40;/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 50;/bin/bash -x /root/pt_huanqiu.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>#æ£€æŸ¥ä¸»ä»huanpcåº“æ•°æ®ä¸€è‡´æ€§</p>
<ul>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>/bin/bash -x /root/root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 10;/bin/bash -x /root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 20;/bin/bash -x /root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 30;/bin/bash -x /root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 40;/bin/bash -x /root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <ul>
      <li>
        <ul>
          <li>
            <ul>
              <li>
                <ul>
                  <li>sleep 50;/bin/bash -x /root/pt_huanpc.sh &gt; /dev/null 2&gt;&amp;1</li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<hr />
<p>æœ€åæ€»ç»“ï¼š
pt-table-checksumå’Œpt-table-syncå·¥å…·å¾ˆç»™åŠ›ï¼Œå·¥ä½œä¸­å¸¸å¸¸åœ¨ä½¿ç”¨ã€‚æ³¨æ„ä½¿ç”¨è¯¥å·¥å…·éœ€è¦æˆæƒï¼Œä¸€èˆ¬SELECT, PROCESS, SUPER, REPLICATION SLAVEç­‰æƒé™å°±å·²ç»è¶³å¤Ÿäº†ã€‚</p>

<hr />
<p>å¦å¤–è¯´ä¸€ä¸ªé—®é¢˜ï¼š
åœ¨ä¸Šé¢çš„æ“ä½œä¸­ï¼Œåœ¨ä¸»åº“é‡Œæ·»åŠ pt-table-checksumæ£€æŸ¥çš„æƒé™ï¼ˆä»åº“å¯ä»¥ä¸æˆæƒï¼‰åï¼Œè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æ“ä½œï¼Œä¼šåœ¨æ“ä½œçš„åº“ï¼ˆå®ä¾‹ä¸­æ˜¯huanqiuã€huanpcï¼‰ä¸‹äº§ç”Ÿä¸€ä¸ªchecksumsè¡¨ï¼
è¿™å¼ checksumsè¡¨æ˜¯pt-table-checksumæ£€æŸ¥è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ã€‚è¿™å¼ è¡¨ä¸€æ—¦äº§ç”Ÿäº†ï¼Œé»˜è®¤æ˜¯åˆ é™¤ä¸äº†çš„ï¼Œå¹¶ä¸”è¿™å¼ è¡¨æ‰€åœ¨çš„åº“ä¹Ÿé»˜è®¤åˆ é™¤ä¸äº†ï¼Œåˆ é™¤åè¿‡ä¸€ä¼šå„¿å°±åˆä¼šå‡ºæ¥ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼Œchecksumsè¡¨ä¸€æ—¦äº§ç”Ÿï¼Œä¸ä»…è¿™å¼ è¡¨é»˜è®¤åˆ é™¤ä¸äº†ï¼Œè¿åŒå®ƒæ‰€åœ¨çš„åº“ï¼Œè¦æ˜¯æƒ³åˆ é™¤å®ƒä»¬ï¼Œåªèƒ½å¦‚ä¸Šæ“ä½œå…ˆæ’¤é”€æƒé™ã€‚</p>

<p>ä¸‰ã€pt-heartbeatç›‘æ§mysqlä¸»ä»å¤åˆ¶å»¶è¿Ÿæ¢³ç†</p>

<p>å¯¹äºMySQLæ•°æ®åº“ä¸»ä»å¤åˆ¶å»¶è¿Ÿçš„ç›‘æ§ï¼Œå¯ä»¥å€ŸåŠ©perconaçš„æœ‰åŠ›æ­¦å™¨pt-heartbeatæ¥å®ç°ã€‚
pt-heartbeatçš„å·¥ä½œåŸç†é€šè¿‡ä½¿ç”¨æ—¶é—´æˆ³æ–¹å¼åœ¨ä¸»åº“ä¸Šæ›´æ–°ç‰¹å®šè¡¨ï¼Œç„¶ååœ¨ä»åº“ä¸Šè¯»å–è¢«æ›´æ–°çš„æ—¶é—´æˆ³ç„¶åä¸æœ¬åœ°ç³»ç»Ÿæ—¶é—´å¯¹æ¯”æ¥å¾—å‡ºå…¶å»¶è¿Ÿã€‚å…·ä½“æµç¨‹ï¼š
   1ï¼‰åœ¨ä¸»ä¸Šåˆ›å»ºä¸€å¼ heartbeatè¡¨ï¼ŒæŒ‰ç…§ä¸€å®šçš„æ—¶é—´é¢‘ç‡æ›´æ–°è¯¥è¡¨çš„å­—æ®µï¼ˆæŠŠæ—¶é—´æ›´æ–°è¿›å»ï¼‰ã€‚ç›‘æ§æ“ä½œè¿è¡Œåï¼Œheartbeatè¡¨èƒ½ä¿ƒä½¿ä¸»ä»åŒæ­¥ï¼
   2ï¼‰è¿æ¥åˆ°ä»åº“ä¸Šæ£€æŸ¥å¤åˆ¶çš„æ—¶é—´è®°å½•ï¼Œå’Œä»åº“çš„å½“å‰ç³»ç»Ÿæ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œå¾—å‡ºæ—¶é—´çš„å·®å¼‚ã€‚</p>

<p>ä½¿ç”¨æ–¹æ³•ï¼ˆä¸»ä»å’Œä»åº“ä¸Šéƒ½å¯ä»¥æ‰§è¡Œç›‘æ§æ“ä½œï¼‰ï¼š
pt-heartbeat [OPTIONS] [DSN] â€“update|â€“monitor|â€“check|â€“stop
æ³¨æ„ï¼šéœ€è¦æŒ‡å®šçš„å‚æ•°è‡³å°‘æœ‰ â€“stopï¼Œâ€“updateï¼Œâ€“monitorï¼Œâ€“checkã€‚
å…¶ä¸­â€“updateï¼Œâ€“monitorå’Œâ€“checkæ˜¯äº’æ–¥çš„ï¼Œâ€“daemonizeå’Œâ€“checkä¹Ÿæ˜¯äº’æ–¥ã€‚
â€“ask-pass     éšå¼è¾“å…¥MySQLå¯†ç 
â€“charset     å­—ç¬¦é›†è®¾ç½®
â€“check      æ£€æŸ¥ä»çš„å»¶è¿Ÿï¼Œæ£€æŸ¥ä¸€æ¬¡å°±é€€å‡ºï¼Œé™¤éæŒ‡å®šäº†â€“recurseä¼šé€’å½’çš„æ£€æŸ¥æ‰€æœ‰çš„ä»æœåŠ¡å™¨ã€‚
â€“check-read-only    å¦‚æœä»æœåŠ¡å™¨å¼€å¯äº†åªè¯»æ¨¡å¼ï¼Œè¯¥å·¥å…·ä¼šè·³è¿‡ä»»ä½•æ’å…¥ã€‚
â€“create-table    åœ¨ä¸»ä¸Šåˆ›å»ºå¿ƒè·³ç›‘æ§çš„è¡¨ï¼Œå¦‚æœè¯¥è¡¨ä¸å­˜åœ¨ï¼Œå¯ä»¥è‡ªå·±æ‰‹åŠ¨å»ºç«‹ï¼Œå»ºè®®å­˜å‚¨å¼•æ“æ”¹æˆmemoryã€‚é€šè¿‡æ›´æ–°è¯¥è¡¨çŸ¥é“ä¸»ä»å»¶è¿Ÿçš„å·®è·ã€‚
CREATE TABLE heartbeat (
  ts                    varchar(26) NOT NULL,
  server_id             int unsigned NOT NULL PRIMARY KEY,
  file                  varchar(255) DEFAULT NULL,
  position              bigint unsigned DEFAULT NULL,
  relay_master_log_file varchar(255) DEFAULT NULL,
  exec_master_log_pos   bigint unsigned DEFAULT NULL
);
heratbeat   è¡¨ä¸€ç›´åœ¨æ›´æ”¹tså’Œposition,è€Œtsæ˜¯æˆ‘ä»¬æ£€æŸ¥å¤åˆ¶å»¶è¿Ÿçš„å…³é”®ã€‚
â€“daemonize   æ‰§è¡Œæ—¶ï¼Œæ”¾å…¥åˆ°åå°æ‰§è¡Œ
â€“user=-uï¼Œ   è¿æ¥æ•°æ®åº“çš„å¸å·
â€“database=-Dï¼Œ    è¿æ¥æ•°æ®åº“çš„åç§°
â€“host=-hï¼Œ     è¿æ¥çš„æ•°æ®åº“åœ°å€
â€“password=-pï¼Œ     è¿æ¥æ•°æ®åº“çš„å¯†ç 
â€“port=-Pï¼Œ     è¿æ¥æ•°æ®åº“çš„ç«¯å£
â€“socket=-Sï¼Œ    è¿æ¥æ•°æ®åº“çš„å¥—æ¥å­—æ–‡ä»¶
â€“file ã€â€“file=output.txtã€‘   æ‰“å°â€“monitoræœ€æ–°çš„è®°å½•åˆ°æŒ‡å®šçš„æ–‡ä»¶ï¼Œå¾ˆå¥½çš„é˜²æ­¢æ»¡å±å¹•éƒ½æ˜¯æ•°æ®çš„çƒ¦æ¼ã€‚
â€“frames ã€â€“frames=1m,2m,3mã€‘  åœ¨â€“monitoré‡Œè¾“å‡ºçš„[]é‡Œçš„è®°å½•æ®µï¼Œé»˜è®¤æ˜¯1m,5m,15mã€‚å¯ä»¥æŒ‡å®š1ä¸ªï¼Œå¦‚ï¼šâ€“frames=1sï¼Œå¤šä¸ªç”¨é€—å·éš”å¼€ã€‚å¯ç”¨å•ä½æœ‰ç§’ï¼ˆsï¼‰ã€åˆ†é’Ÿï¼ˆmï¼‰ã€å°æ—¶ï¼ˆhï¼‰ã€å¤©ï¼ˆdï¼‰ã€‚
â€“interval   æ£€æŸ¥ã€æ›´æ–°çš„é—´éš”æ—¶é—´ã€‚é»˜è®¤æ˜¯è§æ˜¯1sã€‚æœ€å°çš„å•ä½æ˜¯0.01sï¼Œæœ€å¤§ç²¾åº¦ä¸ºå°æ•°ç‚¹åä¸¤ä½ï¼Œå› æ­¤0.015å°†è°ƒæ•´è‡³0.02ã€‚
â€“log    å¼€å¯daemonizedæ¨¡å¼çš„æ‰€æœ‰æ—¥å¿—å°†ä¼šè¢«æ‰“å°åˆ°åˆ¶å®šçš„æ–‡ä»¶ä¸­ã€‚
â€“monitor    æŒç»­ç›‘æ§ä»çš„å»¶è¿Ÿæƒ…å†µã€‚é€šè¿‡â€“intervalæŒ‡å®šçš„é—´éš”æ—¶é—´ï¼Œæ‰“å°å‡ºä»çš„å»¶è¿Ÿä¿¡æ¯ï¼Œé€šè¿‡â€“fileåˆ™å¯ä»¥æŠŠè¿™äº›ä¿¡æ¯æ‰“å°åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚
â€“master-server-id    æŒ‡å®šä¸»çš„server_idï¼Œè‹¥æ²¡æœ‰æŒ‡å®šåˆ™è¯¥å·¥å…·ä¼šè¿åˆ°ä¸»ä¸ŠæŸ¥æ‰¾å…¶server_idã€‚
â€“print-master-server-id    åœ¨â€“monitorå’Œâ€“check æ¨¡å¼ä¸‹ï¼ŒæŒ‡å®šè¯¥å‚æ•°åˆ™æ‰“å°å‡ºä¸»çš„server_idã€‚
â€“recurse    å¤šçº§å¤åˆ¶çš„æ£€æŸ¥æ·±åº¦ã€‚æ¨¡å¼M-S-Sâ€¦ä¸æ˜¯æœ€åçš„ä¸€ä¸ªä»éƒ½éœ€è¦å¼€å¯log_slave_updatesï¼Œè¿™æ ·æ‰èƒ½æ£€æŸ¥åˆ°ã€‚
â€“recursion-method     æŒ‡å®šå¤åˆ¶æ£€æŸ¥çš„æ–¹å¼,é»˜è®¤ä¸ºprocesslist,hostsã€‚
â€“update    æ›´æ–°ä¸»ä¸Šçš„å¿ƒè·³è¡¨ã€‚
â€“replace     ä½¿ç”¨â€“replaceä»£æ›¿â€“updateæ¨¡å¼æ›´æ–°å¿ƒè·³è¡¨é‡Œçš„æ—¶é—´å­—æ®µï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸ç”¨ç®¡è¡¨é‡Œæ˜¯å¦æœ‰è¡Œã€‚
â€“stop    åœæ­¢è¿è¡Œè¯¥å·¥å…·ï¼ˆâ€“daemonizeï¼‰ï¼Œåœ¨/tmp/ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªâ€œpt-heartbeat-sentinelâ€ æ–‡ä»¶ã€‚åé¢æƒ³é‡æ–°å¼€å¯åˆ™éœ€è¦æŠŠè¯¥ä¸´æ—¶æ–‡ä»¶åˆ é™¤ï¼Œæ‰èƒ½å¼€å¯ï¼ˆâ€“daemonizeï¼‰ã€‚
â€“table   æŒ‡å®šå¿ƒè·³è¡¨åï¼Œé»˜è®¤heartbeatã€‚
å®ä¾‹è¯´æ˜ï¼š
masterï¼š192.168.1.101
slaveï¼š192.168.1.102
åŒæ­¥çš„åº“ï¼šhuanqiuã€huanpc
ä¸»ä»åº“éƒ½èƒ½ä½¿ç”¨rootè´¦å·ã€å¯†ç 123456ç™»å½•</p>

<p>å…ˆæ“ä½œé’ˆå¯¹huanqiuåº“çš„æ£€æŸ¥ï¼Œå…¶ä»–åŒæ­¥çš„åº“çš„æ£€æŸ¥æ“ä½œç±»ä¼¼ï¼
mysql&gt; use huanqiu;                 <br />
Database changed</p>

<p>mysql&gt; CREATE TABLE heartbeat (            //ä¸»åº“ä¸Šçš„å¯¹åº”åº“ä¸‹åˆ›å»ºheartbeatè¡¨ï¼Œä¸€èˆ¬åˆ›å»ºåä»åº“ä¼šåŒæ­¥è¿™å¼ è¡¨ï¼ˆä¸åŒæ­¥çš„è¯ï¼Œå°±åœ¨ä»åº“é‚£è¾¹æ‰‹åŠ¨ä¹Ÿæ‰‹åŠ¨åˆ›å»ºï¼‰
    -&gt;   ts                    varchar(26) NOT NULL,
    -&gt;   server_id             int unsigned NOT NULL PRIMARY KEY,
    -&gt;   file                  varchar(255) DEFAULT NULL,
    -&gt;   position              bigint unsigned DEFAULT NULL,
    -&gt;   relay_master_log_file varchar(255) DEFAULT NULL,
    -&gt;   exec_master_log_pos   bigint unsigned DEFAULT NULL
    -&gt; );
Query OK, 0 rows affected (0.02 sec)
æ›´æ–°ä¸»åº“ä¸Šçš„heartbeat,â€“interval=1è¡¨ç¤º1ç§’é’Ÿæ›´æ–°ä¸€æ¬¡ï¼ˆæ³¨æ„è¿™ä¸ªå¯åŠ¨æ“ä½œè¦åœ¨ä¸»åº“æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰
[root@master-server ~]# pt-heartbeat â€“user=root â€“ask-pass â€“host=192.168.1.101 â€“create-table -D huanqiu â€“interval=1 â€“update â€“replace â€“daemonize
Enter password: 
[root@master-server ~]# 
[root@master-server ~]# ps -ef|grep pt-heartbeat
root 15152 1 0 19:49 ? 00:00:00 perl /usr/bin/pt-heartbeat â€“user=root â€“ask-pass â€“host=192.168.1.101 â€“create-table -D huanqiu â€“interval=1 â€“update â€“replace â€“daemonize
root 15154 14170 0 19:49 pts/3 00:00:00 grep pt-heartbeat</p>

<p>åœ¨ä¸»åº“è¿è¡Œç›‘æµ‹åŒæ­¥å»¶è¿Ÿï¼š
<!-- more -->
å¦‚ä½•å…³é—­ä¸Šé¢åœ¨ä¸»åº“ä¸Šæ‰§è¡Œçš„heartbeatæ›´æ–°è¿›ç¨‹å‘¢ï¼Ÿ
æ–¹æ³•ä¸€ï¼šå¯ä»¥ç”¨å‚æ•°â€“stopå»å…³é—­
[root@master-server ~]# ps -ef|grep heartbeat
root 15152 1 0 19:49 ? 00:00:02 perl /usr/bin/pt-heartbeat â€“user=root â€“ask-pass â€“host=192.168.1.101 â€“create-table -D huanqiu â€“interval=1 â€“update â€“replace â€“daemonize
root 15310 1 0 19:59 ? 00:00:01 perl /usr/bin/pt-heartbeat -D huanqiu â€“table=heartbeat â€“monitor â€“host=192.168.1.102 â€“user=root â€“password=123456 â€“log=/opt/master-slave.txt â€“daemonize
root 15555 31932 0 20:13 pts/2 00:00:00 grep heartbeat
[root@master-server ~]# pt-heartbeat â€“stop
Successfully created file /tmp/pt-heartbeat-sentinel
[root@master-server ~]# ps -ef|grep heartbeat
root 15558 31932 0 20:14 pts/2 00:00:00 grep heartbeat
[root@master-server ~]#</p>

<p>è¿™æ ·å°±æŠŠåœ¨ä¸»ä¸Šå¼€å¯çš„è¿›ç¨‹æ€æ‰äº†ã€‚
ä½†æ˜¯åç»­è¦ç»§ç»­å¼€å¯åå°è¿›è¡Œçš„è¯ï¼Œè®°ä½ä¸€å®šè¦å…ˆæŠŠ/tmp/pt-heartbeat-sentinel æ–‡ä»¶åˆ é™¤ï¼Œå¦åˆ™å¯åŠ¨ä¸äº†</p>

<p>æ–¹æ³•äºŒï¼šç›´æ¥killæ‰è¿›ç¨‹pidï¼ˆæ¨èè¿™ç§æ–¹æ³•ï¼‰
[root@master-server ~]# ps -ef|grep heartbeat
root 15152 1 0 19:49 ? 00:00:02 perl /usr/bin/pt-heartbeat â€“user=root â€“ask-pass â€“host=192.168.1.101 â€“create-table -D huanqiu â€“interval=1 â€“update â€“replace â€“daemonize
root 15310 1 0 19:59 ? 00:00:01 perl /usr/bin/pt-heartbeat -D huanqiu â€“table=heartbeat â€“monitor â€“host=192.168.1.102 â€“user=root â€“password=123456 â€“log=/opt/master-slave.txt â€“daemonize
root 15555 31932 0 20:13 pts/2 00:00:00 grep heartbeat
[root@master-server ~]# kill -9 15152
[root@master-server ~]# ps -ef|grep heartbeat
root 15558 31932 0 20:14 pts/2 00:00:00 grep heartbeat</p>

<p>æœ€åæ€»ç»“ï¼š
é€šè¿‡pt-heartbeartå·¥å…·å¯ä»¥å¾ˆå¥½çš„å¼¥è¡¥é»˜è®¤ä¸»ä»å»¶è¿Ÿçš„é—®é¢˜ï¼Œä½†éœ€è¦ææ¸…æ¥šè¯¥å·¥å…·çš„åŸç†ã€‚
é»˜è®¤çš„Seconds_Behind_Masterå€¼æ˜¯é€šè¿‡å°†æœåŠ¡å™¨å½“å‰çš„æ—¶é—´æˆ³ä¸äºŒè¿›åˆ¶æ—¥å¿—ä¸­çš„äº‹ä»¶æ—¶é—´æˆ³ç›¸å¯¹æ¯”å¾—åˆ°çš„ï¼Œæ‰€ä»¥åªæœ‰åœ¨æ‰§è¡Œäº‹ä»¶æ—¶æ‰èƒ½æŠ¥å‘Šå»¶æ—¶ã€‚å¤‡åº“å¤åˆ¶çº¿ç¨‹æ²¡æœ‰è¿è¡Œï¼Œä¹Ÿä¼šæŠ¥å»¶è¿Ÿnullã€‚
è¿˜æœ‰ä¸€ç§æƒ…å†µï¼šå¤§äº‹åŠ¡ï¼Œä¸€ä¸ªäº‹åŠ¡æ›´æ–°æ•°æ®é•¿è¾¾ä¸€ä¸ªå°æ—¶ï¼Œæœ€åæäº¤ã€‚è¿™æ¡æ›´æ–°å°†æ¯”å®ƒå®é™…å‘ç”Ÿæ—¶é—´è¦æ™šä¸€ä¸ªå°æ—¶æ‰è®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ä¸­ã€‚å½“å¤‡åº“æ‰§è¡Œè¿™æ¡è¯­å¥æ—¶ï¼Œä¼šä¸´æ—¶åœ°æŠ¥å‘Šå¤‡åº“å»¶è¿Ÿä¸ºä¸€ä¸ªå°æ—¶ï¼Œæ‰§è¡Œå®Œååˆå¾ˆå¿«å˜æˆ0ã€‚</p>

<p>â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”percona-toolkitå…¶ä»–ç»„ä»¶å‘½ä»¤ç”¨æ³•â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-</p>

<p>ä¸‹é¢è¿™äº›å·¥å…·æœ€å¥½ä¸è¦ç›´æ¥åœ¨çº¿ä¸Šä½¿ç”¨ï¼Œåº”è¯¥ä½œä¸ºä¸Šçº¿è¾…åŠ©æˆ–æ•…éšœåç¦»çº¿åˆ†æçš„å·¥å…·ï¼Œä¹Ÿå¯ä»¥åšæ€§èƒ½æµ‹è¯•çš„æ—¶å€™é…åˆç€ä½¿ç”¨ã€‚</p>

<p>1ï¼‰pt-online-schema-change
åŠŸèƒ½ä»‹ç»ï¼š
åŠŸèƒ½ä¸º:åœ¨alteræ“ä½œæ›´æ”¹è¡¨ç»“æ„çš„æ—¶å€™ä¸ç”¨é”å®šè¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œalterçš„æ—¶å€™ä¸ä¼šé˜»å¡å†™å’Œè¯»å–æ“ä½œï¼Œæ³¨æ„æ‰§è¡Œè¿™ä¸ªå·¥å…·çš„æ—¶å€™å¿…é¡»åšå¥½å¤‡ä»½ï¼Œæ“ä½œä¹‹å‰æœ€å¥½è¦å……åˆ†äº†è§£å®ƒçš„åŸç†ã€‚
å·¥ä½œåŸç†æ˜¯:åˆ›å»ºä¸€ä¸ªå’Œä½ è¦æ‰§è¡Œalteræ“ä½œçš„è¡¨ä¸€æ ·çš„ç©ºè¡¨ç»“æ„ï¼Œæ‰§è¡Œè¡¨ç»“æ„ä¿®æ”¹ï¼Œç„¶åä»åŸè¡¨ä¸­copyåŸå§‹æ•°æ®åˆ°è¡¨ç»“æ„ä¿®æ”¹åçš„è¡¨ï¼Œå½“æ•°æ®copyå®Œæˆä»¥åå°±ä¼šå°†åŸè¡¨ç§»èµ°ï¼Œç”¨æ–°è¡¨ä»£æ›¿åŸè¡¨ï¼Œé»˜è®¤åŠ¨ä½œæ˜¯å°†åŸè¡¨dropæ‰ã€‚åœ¨copyæ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•åœ¨åŸè¡¨çš„æ›´æ–°æ“ä½œéƒ½ä¼šæ›´æ–°åˆ°æ–°è¡¨ï¼Œå› ä¸ºè¿™ä¸ªå·¥å…·åœ¨ä¼šåœ¨åŸè¡¨ä¸Šåˆ›å»ºè§¦å‘å™¨ï¼Œè§¦å‘å™¨ä¼šå°†åœ¨åŸè¡¨ä¸Šæ›´æ–°çš„å†…å®¹æ›´æ–°åˆ°æ–°è¡¨ã€‚å¦‚æœè¡¨ä¸­å·²ç»å®šä¹‰äº†è§¦å‘å™¨è¿™ä¸ªå·¥å…·å°±ä¸èƒ½å·¥ä½œäº†ã€‚</p>

<p>ç”¨æ³•ä»‹ç»ï¼š
pt-online-schema-change [OPTIONS] DSN
optionså¯ä»¥è‡ªè¡ŒæŸ¥çœ‹helpï¼ˆæˆ–åŠ â€“helpæŸ¥çœ‹æœ‰å“ªäº›é€‰é¡¹ï¼‰ï¼ŒDNSä¸ºä½ è¦æ“ä½œçš„æ•°æ®åº“å’Œè¡¨ã€‚
æœ‰ä¸¤ä¸ªå‚æ•°éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š
â€“dry-run è¿™ä¸ªå‚æ•°ä¸å»ºç«‹è§¦å‘å™¨ï¼Œä¸æ‹·è´æ•°æ®ï¼Œä¹Ÿä¸ä¼šæ›¿æ¢åŸè¡¨ã€‚åªæ˜¯åˆ›å»ºå’Œæ›´æ”¹æ–°è¡¨ã€‚
â€“execute è¿™ä¸ªå‚æ•°çš„ä½œç”¨å’Œå‰é¢å·¥ä½œåŸç†çš„ä»‹ç»çš„ä¸€æ ·ï¼Œä¼šå»ºç«‹è§¦å‘å™¨ï¼Œæ¥ä¿è¯æœ€æ–°å˜æ›´çš„æ•°æ®ä¼šå½±å“è‡³æ–°è¡¨ã€‚æ³¨æ„ï¼šå¦‚æœä¸åŠ è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå·¥å…·ä¼šåœ¨æ‰§è¡Œä¸€äº›æ£€æŸ¥åé€€å‡ºã€‚è¿™ä¸€ä¸¾æªæ˜¯ä¸ºäº†è®©ä½¿ç”¨è¿™å……åˆ†äº†è§£äº†è¿™ä¸ªå·¥å…·çš„åŸç†ã€‚</p>

<p>3ï¼‰pt-slave-find
åŠŸèƒ½ä»‹ç»ï¼š
æŸ¥æ‰¾å’Œæ‰“å°mysqlæ‰€æœ‰ä»æœåŠ¡å™¨å¤åˆ¶å±‚çº§å…³ç³»
ç”¨æ³•ä»‹ç»ï¼š
pt-slave-find [OPTIONâ€¦] MASTER-HOST
åŸç†ï¼šè¿æ¥mysqlä¸»æœåŠ¡å™¨å¹¶æŸ¥æ‰¾å…¶æ‰€æœ‰çš„ä»ï¼Œç„¶åæ‰“å°å‡ºæ‰€æœ‰ä»æœåŠ¡å™¨çš„å±‚çº§å…³ç³»ã€‚
4ï¼‰pt-show-grants
åŠŸèƒ½ä»‹ç»ï¼š
è§„èŒƒåŒ–å’Œæ‰“å°mysqlæƒé™ï¼Œè®©ä½ åœ¨å¤åˆ¶ã€æ¯”è¾ƒmysqlæƒé™ä»¥åŠè¿›è¡Œç‰ˆæœ¬æ§åˆ¶çš„æ—¶å€™æ›´æœ‰æ•ˆç‡ï¼
ç”¨æ³•ä»‹ç»ï¼š
pt-show-grants [OPTIONâ€¦] [DSN]
é€‰é¡¹è‡ªè¡Œç”¨helpæŸ¥çœ‹ï¼ŒDSNé€‰é¡¹ä¹Ÿè¯·æŸ¥çœ‹helpï¼Œé€‰é¡¹åŒºåˆ†å¤§å°å†™ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
æŸ¥çœ‹æŒ‡å®šmysqlçš„æ‰€æœ‰ç”¨æˆ·æƒé™ï¼š
5ï¼‰pt-upgrade
åŠŸèƒ½ä»‹ç»ï¼š
è¿™ä¸ªå·¥å…·ç”¨æ¥æ£€æŸ¥åœ¨æ–°ç‰ˆæœ¬ä¸­è¿è¡Œçš„SQLæ˜¯å¦ä¸è€ç‰ˆæœ¬ä¸€æ ·ï¼Œè¿”å›ç›¸åŒçš„ç»“æœï¼Œæœ€å¥½çš„åº”ç”¨åœºæ™¯å°±æ˜¯æ•°æ®è¿ç§»çš„æ—¶å€™ã€‚è¿™åœ¨å‡çº§æœåŠ¡å™¨çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å…ˆå®‰è£…å¹¶å¯¼æ•°æ®åˆ°æ–°çš„æœåŠ¡å™¨ä¸Šï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå·¥å…·è·‘ä¸€ä¸‹sqlçœ‹çœ‹æœ‰ä»€ä¹ˆä¸åŒï¼Œå¯ä»¥æ‰¾å‡ºä¸åŒç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-upgrade [OPTIONâ€¦] DSN [DSNâ€¦] [FILE]
æ¯”è¾ƒæ–‡ä»¶ä¸­æ¯ä¸€ä¸ªæŸ¥è¯¢è¯­å¥åœ¨æ¯å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„ç»“æœï¼ˆä¸»è¦æ˜¯é’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„æ‰§è¡Œç»“æœï¼‰ã€‚ï¼ˆâ€“helpæŸ¥çœ‹é€‰é¡¹ï¼‰
ä½¿ç”¨ç¤ºä¾‹ï¼š
æŸ¥çœ‹æŸä¸ªsqlæ–‡ä»¶åœ¨ä¸¤ä¸ªæœåŠ¡å™¨çš„è¿è¡Œç»“æœèŒƒä¾‹ï¼š
6ï¼‰pt-index-usage
åŠŸèƒ½ä»‹ç»ï¼š
è¿™ä¸ªå·¥å…·ä¸»è¦æ˜¯ç”¨æ¥åˆ†ææ…¢æŸ¥è¯¢çš„ç´¢å¼•ä½¿ç”¨æƒ…å†µã€‚ä»logæ–‡ä»¶ä¸­è¯»å–æ’å™è¯­å¥ï¼Œå¹¶ç”¨explainåˆ†æä»–ä»¬æ˜¯å¦‚ä½•åˆ©ç”¨ç´¢å¼•ã€‚å®Œæˆåˆ†æä¹‹åä¼šç”Ÿæˆä¸€ä»½å…³äºç´¢å¼•æ²¡æœ‰è¢«æŸ¥è¯¢ä½¿ç”¨è¿‡çš„æŠ¥å‘Šã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-index-usage [OPTIONâ€¦] [FILEâ€¦]
å¯ä»¥ç›´æ¥ä»æ…¢æŸ¥è¯¢ä¸­è·å–sqlï¼ŒFILEæ–‡ä»¶ä¸­çš„sqlæ ¼å¼å¿…é¡»å’Œæ…¢æŸ¥è¯¢ä¸­ä¸ªæ˜¯ä¸€è‡´ï¼Œå¦‚æœä¸æ˜¯ä¸€ç›´éœ€è¦ç”¨pt-query-digestè½¬æ¢ä¸€ä¸‹ã€‚ä¹Ÿå¯ä»¥ä¸ç”ŸæˆæŠ¥å‘Šç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“ä¸­ï¼Œå…·ä½“çš„è§åé¢çš„ç¤ºä¾‹
æ³¨æ„ï¼šä½¿ç”¨è¿™ä¸ªå·¥å…·éœ€è¦MySQLå¿…é¡»è¦æœ‰å¯†ç ï¼Œå¦å¤–è¿è¡Œæ—¶å¯èƒ½æŠ¥æ‰¾ä¸åˆ°/var/lib/mysql/mysql.sockçš„é”™ï¼Œç®€å•çš„ä»mysqlå¯åŠ¨åçš„sockæ–‡ä»¶åšä¸€ä¸ªè½¯é“¾æ¥å³å¯ã€‚
é‡ç‚¹è¦è¯´æ˜çš„æ˜¯pt-index-usageåªèƒ½åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œæ‰€ä»¥å¦‚æœæƒ³å…¨é¢åˆ†ææ‰€æœ‰æŸ¥è¯¢çš„ç´¢å¼•ä½¿ç”¨æƒ…å†µå°±å¾—å°†slow_launch_timeè®¾ç½®ä¸º0ï¼Œå› æ­¤è¯·è°¨æ…ä½¿ç”¨è¯¥å·¥å…·ï¼Œçº¿ä¸Šä½¿ç”¨çš„è¯æœ€å¥½åœ¨å‡Œæ™¨è¿›è¡Œåˆ†æï¼Œå°¤å…¶åˆ†æå¤§é‡æ—¥å¿—çš„æ—¶å€™æ˜¯å¾ˆè€—CPUçš„ã€‚
æ•´ä½“æ¥è¯´è¿™ä¸ªå·¥å…·æ˜¯ä¸æ¨èä½¿ç”¨çš„ï¼Œè¦æƒ³å®ç°ç±»ä¼¼çš„åˆ†æå¯ä»¥è€ƒè™‘ä¸€äº›å…¶ä»–ç¬¬ä¸‰æ–¹çš„å·¥å…·ï¼Œæ¯”å¦‚ï¼šmysqlidxchx, userstatå’Œcheck-unused-keysã€‚ç½‘ä¸Šæ¯”è¾ƒæ¨èçš„æ˜¯userstatï¼Œä¸€ä¸ªGoogleè´¡çŒ®çš„patchã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
ä»æ»¡æŸ¥è¯¢ä¸­çš„sqlæŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µèŒƒä¾‹ï¼š
[root@master-server ~]# pt-index-usage â€“host=localhost â€“user=root â€“password=123456 /data/mysql/data/mysql-slow.log
å°†åˆ†æç»“æœä¿å­˜åˆ°æ•°æ®åº“èŒƒä¾‹ï¼š
[root@master-server ~]# pt-index-usage â€“host=localhost â€“user=root â€“password=123456 /data/mysql/data/mysql-slow.log  â€“no-report â€“create-save-results-database
7ï¼‰pt-visual-explain
åŠŸèƒ½ä»‹ç»ï¼š
æ ¼å¼åŒ–explainå‡ºæ¥çš„æ‰§è¡Œè®¡åˆ’æŒ‰ç…§treeæ–¹å¼è¾“å‡ºï¼Œæ–¹ä¾¿é˜…è¯»ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-visual-explain [OPTIONâ€¦] [FILEâ€¦]
8ï¼‰pt-config-diff
åŠŸèƒ½ä»‹ç»ï¼š
æ¯”è¾ƒmysqlé…ç½®æ–‡ä»¶å’ŒæœåŠ¡å™¨å‚æ•°
ç”¨æ³•ä»‹ç»ï¼š
pt-config-diff [OPTIONâ€¦] CONFIG CONFIG [CONFIGâ€¦]
CONFIGå¯ä»¥æ˜¯æ–‡ä»¶ä¹Ÿå¯ä»¥æ˜¯æ•°æ®æºåç§°ï¼Œæœ€å°‘å¿…é¡»æŒ‡å®šä¸¤ä¸ªé…ç½®æ–‡ä»¶æºï¼Œå°±åƒunixä¸‹é¢çš„diffå‘½ä»¤ä¸€æ ·ï¼Œå¦‚æœé…ç½®å®Œå…¨ä¸€æ ·å°±ä¸ä¼šè¾“å‡ºä»»ä½•ä¸œè¥¿ã€‚
9ï¼‰pt-mysql-summary
åŠŸèƒ½ä»‹ç»ï¼š
ç²¾ç»†åœ°å¯¹mysqlçš„é…ç½®å’Œsatausä¿¡æ¯è¿›è¡Œæ±‡æ€»ï¼Œæ±‡æ€»åä½ ç›´æ¥çœ‹ä¸€çœ¼å°±èƒ½çœ‹æ˜ç™½ã€‚
å·¥ä½œåŸç†ï¼šè¿æ¥mysqlåæŸ¥è¯¢å‡ºstatuså’Œé…ç½®ä¿¡æ¯ä¿å­˜åˆ°ä¸´æ—¶ç›®å½•ä¸­ï¼Œç„¶åç”¨awkå’Œå…¶ä»–çš„è„šæœ¬å·¥å…·è¿›è¡Œæ ¼å¼åŒ–ã€‚OPTIONSå¯ä»¥æŸ¥é˜…å®˜ç½‘çš„ç›¸å…³é¡µé¢ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-mysql-summary [OPTIONS] [â€“ MYSQL OPTIONS]
10ï¼‰pt-deadlock-logger
åŠŸèƒ½ä»‹ç»ï¼š
æå–å’Œè®°å½•mysqlæ­»é”çš„ç›¸å…³ä¿¡æ¯
ç”¨æ³•ä»‹ç»ï¼š
pt-deadlock-logger [OPTIONâ€¦] SOURCE_DSN
æ”¶é›†å’Œä¿å­˜mysqlä¸Šæœ€è¿‘çš„æ­»é”ä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æ‰“å°æ­»é”ä¿¡æ¯å’Œå­˜å‚¨æ­»é”ä¿¡æ¯åˆ°æ•°æ®åº“ä¸­ï¼Œæ­»é”ä¿¡æ¯åŒ…æ‹¬å‘ç”Ÿæ­»é”çš„æœåŠ¡å™¨ã€æœ€è¿‘å‘ç”Ÿæ­»é”çš„æ—¶é—´ã€æ­»é”çº¿ç¨‹idã€æ­»é”çš„äº‹åŠ¡idã€å‘ç”Ÿæ­»é”æ—¶äº‹åŠ¡æ‰§è¡Œäº†å¤šé•¿æ—¶é—´ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
æŸ¥çœ‹æœ¬åœ°mysqlçš„æ­»é”ä¿¡æ¯
[root@master-server ~]# pt-deadlock-logger  â€“user=root â€“password=123456 h=localhost D=test,t=deadlocks
server ts thread txn_id txn_time user hostname ip db tbl idx lock_type lock_mode wait_hold victim query
localhost 2017-01-11T11:00:33 188 0 0 root  192.168.1.101 huanpc checksums PRIMARY RECORD X w 1 REPLACE INTO <code class="language-plaintext highlighter-rouge">huanpc</code>.<code class="language-plaintext highlighter-rouge">checksums</code> (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT â€˜huanpcâ€™, â€˜heiheiâ€™, â€˜1â€™, NULL, NULL, NULL, COUNT(<em>) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(â€˜#â€™, <code class="language-plaintext highlighter-rouge">member</code>, <code class="language-plaintext highlighter-rouge">city</code>)) AS UNSIGNED)), 10, 16)), 0) AS crc FROM <code class="language-plaintext highlighter-rouge">huanpc</code>.<code class="language-plaintext highlighter-rouge">heihei</code> /</em>checksum table<em>/
localhost 2017-01-11T11:00:33 198 0 0 root  192.168.1.101 huanpc checksums PRIMARY RECORD X w 0 REPLACE INTO <code class="language-plaintext highlighter-rouge">huanpc</code>.<code class="language-plaintext highlighter-rouge">checksums</code> (db, tbl, chunk, chunk_index, lower_boundary, upper_boundary, this_cnt, this_crc) SELECT â€˜huanpcâ€™, â€˜heiheiâ€™, â€˜1â€™, NULL, NULL, NULL, COUNT(</em>) AS cnt, COALESCE(LOWER(CONV(BIT_XOR(CAST(CRC32(CONCAT_WS(â€˜#â€™, <code class="language-plaintext highlighter-rouge">member</code>, <code class="language-plaintext highlighter-rouge">city</code>)) AS UNSIGNED)), 10, 16)), 0) AS crc FROM <code class="language-plaintext highlighter-rouge">huanpc</code>.<code class="language-plaintext highlighter-rouge">heihei</code> /<em>checksum table</em>/
11ï¼‰pt-mext
åŠŸèƒ½ä»‹ç»ï¼š
å¹¶è¡ŒæŸ¥çœ‹SHOW GLOBAL STATUSçš„å¤šä¸ªæ ·æœ¬çš„ä¿¡æ¯ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-mext [OPTIONS] â€“ COMMAND
åŸç†ï¼špt-mextæ‰§è¡Œä½ æŒ‡å®šçš„COMMANDï¼Œå¹¶æ¯æ¬¡è¯»å–ä¸€è¡Œç»“æœï¼ŒæŠŠç©ºè¡Œåˆ†å‰²çš„å†…å®¹ä¿å­˜åˆ°ä¸€ä¸ªä¸€ä¸ªçš„ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œæœ€åç»“åˆè¿™äº›ä¸´æ—¶æ–‡ä»¶å¹¶è¡ŒæŸ¥çœ‹ç»“æœã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
æ¯éš”10sæ‰§è¡Œä¸€æ¬¡SHOW GLOBAL STATUSï¼Œå¹¶å°†ç»“æœåˆå¹¶åˆ°ä¸€èµ·æŸ¥çœ‹</p>

<p>1
[root@master-server ~]# pt-mext  â€“ mysqladmin ext -uroot -p123456  -i10 -c3
12ï¼‰pt-query-digest
åŠŸèƒ½ä»‹ç»ï¼š
åˆ†ææŸ¥è¯¢æ‰§è¡Œæ—¥å¿—ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªæŸ¥è¯¢æŠ¥å‘Šï¼Œä¸ºMySQLã€PostgreSQLã€ memcachedè¿‡æ»¤ã€é‡æ”¾æˆ–è€…è½¬æ¢è¯­å¥ã€‚
pt-query-digestå¯ä»¥ä»æ™®é€šMySQLæ—¥å¿—ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—ä»¥åŠäºŒè¿›åˆ¶æ—¥å¿—ä¸­åˆ†ææŸ¥è¯¢ï¼Œç”šè‡³å¯ä»¥ä»SHOW PROCESSLISTå’ŒMySQLåè®®çš„tcpdumpä¸­è¿›è¡Œåˆ†æï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šæ–‡ä»¶ï¼Œå®ƒä»æ ‡å‡†è¾“å…¥æµï¼ˆSTDINï¼‰ä¸­è¯»å–æ•°æ®ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-query-digest [OPTIONâ€¦] [FILE]
è§£æå’Œåˆ†æmysqlæ—¥å¿—æ–‡ä»¶
æ•´ä¸ªè¾“å‡ºåˆ†ä¸ºä¸‰å¤§éƒ¨åˆ†ï¼š
1ï¼‰æ•´ä½“æ¦‚è¦ï¼ˆOverallï¼‰
è¿™ä¸ªéƒ¨åˆ†æ˜¯ä¸€ä¸ªå¤§è‡´çš„æ¦‚è¦ä¿¡æ¯(ç±»ä¼¼loadrunnerç»™å‡ºçš„æ¦‚è¦ä¿¡æ¯)ï¼Œé€šè¿‡å®ƒå¯ä»¥å¯¹å½“å‰MySQLçš„æŸ¥è¯¢æ€§èƒ½åšä¸€ä¸ªåˆæ­¥çš„è¯„ä¼°ï¼Œæ¯”å¦‚å„ä¸ªæŒ‡æ ‡çš„æœ€å¤§å€¼(max)ï¼Œå¹³å‡å€¼(min)ï¼Œ95%åˆ†å¸ƒå€¼ï¼Œä¸­ä½æ•°(median)ï¼Œæ ‡å‡†åå·®(stddev)ã€‚
è¿™äº›æŒ‡æ ‡æœ‰æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´ï¼ˆExec timeï¼‰ï¼Œé”å ç”¨çš„æ—¶é—´ï¼ˆLock timeï¼‰ï¼ŒMySQLæ‰§è¡Œå™¨éœ€è¦æ£€æŸ¥çš„è¡Œæ•°ï¼ˆRows examineï¼‰ï¼Œæœ€åè¿”å›ç»™å®¢æˆ·ç«¯çš„è¡Œæ•°ï¼ˆRows sentï¼‰ï¼ŒæŸ¥è¯¢çš„å¤§å°ã€‚</p>

<p>2ï¼‰æŸ¥è¯¢çš„æ±‡æ€»ä¿¡æ¯ï¼ˆProfileï¼‰
è¿™ä¸ªéƒ¨åˆ†å¯¹æ‰€æœ‰â€œé‡è¦â€çš„æŸ¥è¯¢(é€šå¸¸æ˜¯æ¯”è¾ƒæ…¢çš„æŸ¥è¯¢)åšäº†ä¸ªä¸€è§ˆè¡¨ã€‚
æ¯ä¸ªæŸ¥è¯¢éƒ½æœ‰ä¸€ä¸ªQuery IDï¼Œè¿™ä¸ªIDé€šè¿‡Hashè®¡ç®—å‡ºæ¥çš„ã€‚pt-query-digestæ˜¯æ ¹æ®è¿™ä¸ªæ‰€è°“çš„Fingerprintæ¥group byçš„ã€‚
Rankæ•´ä¸ªåˆ†æä¸­è¯¥â€œè¯­å¥â€çš„æ’åï¼Œä¸€èˆ¬ä¹Ÿå°±æ˜¯æ€§èƒ½æœ€å¸¸çš„ã€‚
Response time  â€œè¯­å¥â€çš„å“åº”æ—¶é—´ä»¥åŠæ•´ä½“å æ¯”æƒ…å†µã€‚
Calls è¯¥â€œè¯­å¥â€çš„æ‰§è¡Œæ¬¡æ•°ã€‚
R/Call æ¯æ¬¡æ‰§è¡Œçš„å¹³å‡å“åº”æ—¶é—´ã€‚
V/M å“åº”æ—¶é—´çš„å·®å¼‚å¹³å‡å¯¹æ¯”ç‡ã€‚
åœ¨å°¾éƒ¨æœ‰ä¸€è¡Œè¾“å‡ºï¼Œæ˜¾ç¤ºäº†å…¶ä»–2ä¸ªå æ¯”è¾ƒä½è€Œä¸å€¼å¾—å•ç‹¬æ˜¾ç¤ºçš„æŸ¥è¯¢çš„ç»Ÿè®¡æ•°æ®ã€‚</p>

<p>3ï¼‰è¯¦ç»†ä¿¡æ¯
è¿™ä¸ªéƒ¨åˆ†ä¼šåˆ—å‡ºProfileè¡¨ä¸­æ¯ä¸ªæŸ¥è¯¢çš„è¯¦ç»†ä¿¡æ¯ï¼š
åŒ…æ‹¬Overallä¸­æœ‰çš„ä¿¡æ¯ã€æŸ¥è¯¢å“åº”æ—¶é—´çš„åˆ†å¸ƒæƒ…å†µä»¥åŠè¯¥æŸ¥è¯¢â€å…¥æ¦œâ€çš„ç†ç”±ã€‚
pt-query-digestè¿˜æœ‰å¾ˆå¤šå¤æ‚çš„æ“ä½œï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€ä»‹ç»äº†ã€‚æ¯”å¦‚ï¼šä»PROCESSLISTä¸­æŸ¥è¯¢æŸä¸ªMySQLä¸­æœ€æ…¢çš„æŸ¥è¯¢ï¼š
ä»tcpdumpä¸­åˆ†æï¼š
[root@master-server ~]# tcpdump -s 65535 -x -nn -q -tttt -i any -c 1000 port 3306 &gt; mysql.tcp.txt
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes</p>

<p>ç„¶åæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯çª—å£ï¼š
[root@master-server ~]# pt-query-digest â€“type tcpdump mysql.tcp.txt
Pipeline process 3 (TcpdumpParser) caused an error: substr outside of string at /usr/bin/pt-query-digest line 3628, &lt;&gt; chunk 93.
Will retry pipeline process 2 (TcpdumpParser) 100 more times.</p>

<h1 id="320ms-user-time-20ms-system-time-2493m-rss-20484m-vsz">320ms user time, 20ms system time, 24.93M rss, 204.84M vsz</h1>
<h1 id="current-date-mon-jan-16-132450-2017">Current date: Mon Jan 16 13:24:50 2017</h1>
<h1 id="hostname-master-server">Hostname: master-server</h1>
<h1 id="files-mysqltcptxt">Files: mysql.tcp.txt</h1>
<h1 id="overall-31-total-4-unique-443-qps-000x-concurrency-_______">Overall: 31 total, 4 unique, 4.43 QPS, 0.00x concurrency <strong>__</strong><strong>__</strong>___</h1>
<h1 id="time-range-2017-01-16-132443000380-to-132450001205">Time range: 2017-01-16 13:24:43.000380 to 13:24:50.001205</h1>
<h1 id="attribute----------total-----min-----max-----avg-----95--stddev--median">Attribute          total     min     max     avg     95%  stddev  median</h1>
<h1 id="-----------">============     ======= ======= ======= ======= ======= ======= =======</h1>
<h1 id="exec-time-----------30ms----79us-----5ms---967us-----4ms-----1ms---159us">Exec time           30ms    79us     5ms   967us     4ms     1ms   159us</h1>
<h1 id="rows-affecte----------14-------0-------2----045----196----082-------0">Rows affecte          14       0       2    0.45    1.96    0.82       0</h1>
<h1 id="query-size---------185k------17-----200---6116--19276---7225---1765">Query size         1.85k      17     200   61.16  192.76   72.25   17.65</h1>
<p>â€¦â€¦â€¦
13ï¼‰pt-slave-delay
åŠŸèƒ½ä»‹ç»ï¼š
è®¾ç½®ä»æœåŠ¡å™¨è½åäºä¸»æœåŠ¡å™¨æŒ‡å®šæ—¶é—´ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-slave-delay [OPTIONâ€¦] SLAVE-HOST [MASTER-HOST]
åŸç†ï¼šé€šè¿‡å¯åŠ¨å’Œåœæ­¢å¤åˆ¶sqlçº¿ç¨‹æ¥è®¾ç½®ä»è½åäºä¸»æŒ‡å®šæ—¶é—´ã€‚é»˜è®¤æ˜¯åŸºäºä»ä¸Šrelayæ—¥å¿—çš„äºŒè¿›åˆ¶æ—¥å¿—çš„ä½ç½®æ¥åˆ¤æ–­ï¼Œå› æ­¤ä¸éœ€è¦è¿æ¥åˆ°ä¸»æœåŠ¡å™¨ï¼Œå¦‚æœIOè¿›ç¨‹ä¸è½åä¸»æœåŠ¡å™¨å¤ªå¤šçš„è¯ï¼Œè¿™ä¸ªæ£€æŸ¥æ–¹å¼å·¥ä½œå¾ˆå¥½ï¼Œå¦‚æœç½‘ç»œé€šç•…çš„è¯ï¼Œä¸€èˆ¬IOçº¿ç¨‹è½åä¸»é€šå¸¸éƒ½æ˜¯æ¯«ç§’çº§åˆ«ã€‚ä¸€èˆ¬æ˜¯é€šè¿‡â€“delay and â€“delayâ€+â€â€“intervalæ¥æ§åˆ¶ã€‚â€“intervalæ˜¯æŒ‡å®šæ£€æŸ¥æ˜¯å¦å¯åŠ¨æˆ–è€…åœæ­¢ä»ä¸Šsqlçº¿ç¨‹çš„é¢‘ç¹åº¦ï¼Œé»˜è®¤çš„æ˜¯1åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
èŒƒä¾‹1ï¼šä½¿ä»è½åä¸»1åˆ†é’Ÿï¼Œå¹¶æ¯éš”1åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ï¼Œè¿è¡Œ10åˆ†é’Ÿ
[root@master-server ~]# pt-slave-delay â€“user=root â€“password=123456 â€“delay 1m â€“run-time 10m â€“host=192.168.1.102
2017-01-16T13:32:31 slave running 0 seconds behind
2017-01-16T13:32:31 STOP SLAVE until 2017-01-16T13:33:31 at master position mysql-bin.000005/102554361
èŒƒä¾‹2ï¼šä½¿ä»è½åä¸»1åˆ†é’Ÿï¼Œå¹¶æ¯éš”15ç§’é’Ÿæ£€æµ‹ä¸€æ¬¡ï¼Œè¿è¡Œ10åˆ†é’Ÿï¼š
[root@master-server ~]# pt-slave-delay â€“user=root â€“password=123456 â€“delay 1m â€“interval 15s â€“run-time 10m â€“host=192.168.1.102
2017-01-16T13:38:22 slave running 0 seconds behind
2017-01-16T13:38:22 STOP SLAVE until 2017-01-16T13:39:22 at master position mysql-bin.000005/102689359
14ï¼‰pt-slave-restart
åŠŸèƒ½ä»‹ç»ï¼š
ç›‘è§†mysqlå¤åˆ¶é”™è¯¯ï¼Œå¹¶å°è¯•é‡å¯mysqlå¤åˆ¶å½“å¤åˆ¶åœæ­¢çš„æ—¶å€™
ç”¨æ³•ä»‹ç»ï¼š
pt-slave-restart [OPTIONâ€¦] [DSN]
ç›‘è§†ä¸€ä¸ªæˆ–è€…å¤šä¸ªmysqlå¤åˆ¶é”™è¯¯ï¼Œå½“ä»åœæ­¢çš„æ—¶å€™å°è¯•é‡æ–°å¯åŠ¨å¤åˆ¶ã€‚ä½ å¯ä»¥æŒ‡å®šè·³è¿‡çš„é”™è¯¯å¹¶è¿è¡Œä»åˆ°æŒ‡å®šçš„æ—¥å¿—ä½ç½®ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
èŒƒä¾‹1ï¼šç›‘è§†192.168.1.101çš„ä»ï¼Œè·³è¿‡1ä¸ªé”™è¯¯
[root@master-server ~]# pt-slave-restart â€“user=root â€“password=123456 â€“host=192.168.1.101 â€“skip-count=1
èŒƒä¾‹2ï¼šç›‘è§†192.168.1.101çš„ä»ï¼Œè·³è¿‡é”™è¯¯ä»£ç ä¸º1062çš„é”™è¯¯ã€‚
[root@master-server ~]# pt-slave-restart â€“user=root â€“password=123456 â€“host=192.168.1.101 â€“error-numbers=1062
15ï¼‰pt-diskstats
åŠŸèƒ½ä»‹ç»ï¼š
æ˜¯ä¸€ä¸ªå¯¹GUN/LINUXçš„äº¤äº’å¼ç›‘æ§å·¥å…·
ç”¨æ³•ä»‹ç»ï¼š
pt-diskstats [OPTIONâ€¦] [FILES]
ä¸ºGUN/LINUXæ‰“å°ç£ç›˜ioç»Ÿè®¡ä¿¡æ¯ï¼Œå’Œiostatæœ‰ç‚¹åƒï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·æ˜¯äº¤äº’å¼å¹¶ä¸”æ¯”iostatæ›´è¯¦ç»†ã€‚å¯ä»¥åˆ†æä»è¿œç¨‹æœºå™¨æ”¶é›†çš„æ•°æ®ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
èŒƒä¾‹1ï¼šæŸ¥çœ‹æœ¬æœºæ‰€æœ‰çš„ç£ç›˜çš„çŠ¶æ€æƒ…å†µï¼š
[root@master-server ~]# pt-diskstats
èŒƒä¾‹2ï¼šåªæŸ¥çœ‹æœ¬æœºsdc1ç£ç›˜çš„çŠ¶æ€æƒ…å†µï¼š
[root@master-server ~]# pt-diskstats  â€“devices-regex vdc1
  #ts device    rd_s rd_avkb rd_mb_s rd_mrg rd_cnc   rd_rt    wr_s wr_avkb wr_mb_s wr_mrg wr_cnc   wr_rt busy in_prg    io_s  qtime stime
  0.9 vdc1       0.0     0.0     0.0     0%    0.0     0.0     5.9     4.0     0.0     0%    0.0     1.0   0%      0     5.9    0.6   0.4
  1.0 vdc1       0.0     0.0     0.0     0%    0.0     0.0     2.0     6.0     0.0    33%    0.0     0.7   0%      0     2.0    0.0   0.7
16ï¼‰pt-summary
åŠŸèƒ½ä»‹ç»ï¼š
å‹å¥½åœ°æ”¶é›†å’Œæ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯æ¦‚å†µï¼Œæ­¤å·¥å…·å¹¶ä¸æ˜¯ä¸€ä¸ªè°ƒä¼˜æˆ–è€…è¯Šæ–­å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·ä¼šäº§ç”Ÿä¸€ä¸ªå¾ˆå®¹æ˜“è¿›è¡Œæ¯”è¾ƒå’Œå‘é€é‚®ä»¶çš„æŠ¥å‘Šã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-summary
åŸç†ï¼šæ­¤å·¥å…·ä¼šè¿è¡Œå’Œå¤šå‘½ä»¤å»æ”¶é›†ç³»ç»ŸçŠ¶æ€å’Œé…ç½®ä¿¡æ¯ï¼Œå…ˆä¿å­˜åˆ°ä¸´æ—¶ç›®å½•çš„æ–‡ä»¶ä¸­å»ï¼Œç„¶åè¿è¡Œä¸€äº›unixå‘½ä»¤å¯¹è¿™äº›ç»“æœåšæ ¼å¼åŒ–ï¼Œæœ€å¥½æ˜¯ç”¨rootç”¨æˆ·æˆ–è€…æœ‰æƒé™çš„ç”¨æˆ·è¿è¡Œæ­¤å‘½ä»¤ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
æŸ¥çœ‹æœ¬åœ°ç³»ç»Ÿä¿¡æ¯æ¦‚å†µ
[root@master-server ~]# pt-summary
17ï¼‰pt-stalk
åŠŸèƒ½ä»‹ç»ï¼š
å‡ºç°é—®é¢˜çš„æ—¶å€™æ”¶é›†mysqlçš„ç”¨äºè¯Šæ–­çš„æ•°æ®
ç”¨æ³•ä»‹ç»ï¼š
pt-stalk [OPTIONS] [â€“ MYSQL OPTIONS]
pt-stalkç­‰å¾…è§¦å‘æ¡ä»¶è§¦å‘ï¼Œç„¶åæ”¶é›†æ•°æ®å¸®åŠ©é”™è¯¯è¯Šæ–­ï¼Œå®ƒè¢«è®¾è®¡æˆä½¿ç”¨rootæƒé™è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ï¼Œå› æ­¤ä½ å¯ä»¥è¯Šæ–­é‚£äº›ä½ ä¸èƒ½ç›´æ¥è§‚å¯Ÿçš„é—´æ­‡æ€§é—®é¢˜ã€‚é»˜è®¤çš„è¯Šæ–­è§¦å‘æ¡ä»¶ä¸ºSHOW GLOBAL STATUSã€‚ä¹Ÿå¯ä»¥æŒ‡å®šprocesslistä¸ºè¯Šæ–­è§¦å‘æ¡ä»¶ ï¼Œä½¿ç”¨â€“functionå‚æ•°æŒ‡å®šã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š
èŒƒä¾‹1ï¼šæŒ‡å®šè¯Šæ–­è§¦å‘æ¡ä»¶ä¸ºstatusï¼ŒåŒæ—¶è¿è¡Œè¯­å¥è¶…è¿‡20çš„æ—¶å€™è§¦å‘ï¼Œæ”¶é›†çš„æ•°æ®å­˜æ”¾åœ¨ç›®æ ‡ç›®å½•/tmp/testä¸‹ï¼š
[root@master-server ~]# pt-stalk  â€“function status â€“variable Threads_running â€“threshold 20 â€“dest /tmp/test  â€“ -uroot -p123456  -h192.168.1.101
èŒƒä¾‹2ï¼šæŒ‡å®šè¯Šæ–­è§¦å‘æ¡ä»¶ä¸ºprocesslistï¼Œè¶…è¿‡20ä¸ªçŠ¶æ€ä¸ºstatisticsè§¦å‘ï¼Œæ”¶é›†çš„æ•°æ®å­˜æ”¾åœ¨/tmp/testç›®å½•ä¸‹ï¼š
[root@master-server ~]# pt-stalk  â€“function processlist â€“variable State â€“match statistics â€“threshold 20 â€“dest /tmp/test â€“ -uroot -p123456  -h192.168.1.101
â€¦â€¦.
2017_01_15_17_31_49-hostname
2017_01_15_17_31_49-innodbstatus1
2017_01_15_17_31_49-innodbstatus2
2017_01_15_17_31_49-interrupts
2017_01_15_17_31_49-log_error
2017_01_15_17_31_49-lsof
2017_01_15_17_31_49-meminfo
18ï¼‰pt-archiver
åŠŸèƒ½ä»‹ç»ï¼š
å°†mysqlæ•°æ®åº“ä¸­è¡¨çš„è®°å½•å½’æ¡£åˆ°å¦å¤–ä¸€ä¸ªè¡¨æˆ–è€…æ–‡ä»¶
ç”¨æ³•ä»‹ç»ï¼š
pt-archiver [OPTIONâ€¦] â€“source DSN â€“where WHERE
è¿™ä¸ªå·¥å…·åªæ˜¯å½’æ¡£æ—§çš„æ•°æ®ï¼Œä¸ä¼šå¯¹çº¿ä¸Šæ•°æ®çš„OLTPæŸ¥è¯¢é€ æˆå¤ªå¤§å½±å“ï¼Œä½ å¯ä»¥å°†æ•°æ®æ’å…¥å¦å¤–ä¸€å°æœåŠ¡å™¨çš„å…¶ä»–è¡¨ä¸­ï¼Œä¹Ÿå¯ä»¥å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿ä½¿ç”¨sourceå‘½ä»¤å¯¼å…¥æ•°æ®ã€‚å¦å¤–ä½ è¿˜å¯ä»¥ç”¨å®ƒæ¥æ‰§è¡Œdeleteæ“ä½œã€‚ç‰¹åˆ«æ³¨æ„ï¼šè¿™ä¸ªå·¥å…·é»˜è®¤çš„ä¼šåˆ é™¤æºä¸­çš„æ•°æ®ï¼ï¼
19ï¼‰pt-find
åŠŸèƒ½ä»‹ç»ï¼š
æŸ¥æ‰¾mysqlè¡¨å¹¶æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œå’Œgnuçš„findå‘½ä»¤ç±»ä¼¼ã€‚
ç”¨æ³•ä»‹ç»ï¼š
pt-find [OPTIONâ€¦] [DATABASEâ€¦]
é»˜è®¤åŠ¨ä½œæ˜¯æ‰“å°æ•°æ®åº“åå’Œè¡¨å
20ï¼‰pt-kill
åŠŸèƒ½ä»‹ç»ï¼š
Killæ‰ç¬¦åˆæŒ‡å®šæ¡ä»¶mysqlè¯­å¥
ç”¨æ³•ä»‹ç»ï¼š
pt-kill [OPTIONS]
åŠ å…¥æ²¡æœ‰æŒ‡å®šæ–‡ä»¶çš„è¯pt-killè¿æ¥åˆ°mysqlå¹¶é€šè¿‡SHOW PROCESSLISTæ‰¾åˆ°æŒ‡å®šçš„è¯­å¥ï¼Œåä¹‹pt-killä»åŒ…å«SHOW PROCESSLISTç»“æœçš„æ–‡ä»¶ä¸­è¯»å–mysqlè¯­å¥</p>

<p>Maatkitæ˜¯ä¸€ä¸ªå¼€æºçš„å·¥å…·åŒ…ï¼Œä¸ºmySQLæ—¥å¸¸ç®¡ç†æä¾›äº†å¸®åŠ©ï¼Œå®ƒåŒ…å«å¾ˆå¤šå·¥å…·ï¼Œè¿™é‡Œä¸»è¦è¯´ä¸‹é¢ä¸¤ä¸ªï¼š
1ï¼‰mk-table-checksum                     ç”¨æ¥æ£€æµ‹masterå’Œslaveä¸Šçš„è¡¨ç»“æ„å’Œæ•°æ®æ˜¯å¦ä¸€è‡´çš„ï¼›
2ï¼‰mk-table-sync                             åœ¨ä¸»ä»æ•°æ®ä¸ä¸€è‡´æ—¶ï¼Œç”¨æ¥ä¿®å¤æ•°æ®çš„ï¼›å…ˆä¸»åä»æœ‰æ•ˆä¿è¯è¡¨ä¸€è‡´çš„å·¥å…·ï¼Œä¸å¿…é‡è½½ä»è¡¨è€Œèƒ½å¤Ÿä¿è¯ä¸€è‡´ã€‚ 
ä¸Šé¢ä¸¤ä¸ªperlè„šæœ¬åœ¨è¿è¡Œæ—¶éƒ½ä¼šé”è¡¨ï¼Œè¡¨çš„å¤§å°å–å†³äºæ‰§è¡Œçš„å¿«æ…¢ï¼Œå‹¿åœ¨é«˜å³°æœŸé—´è¿è¡Œï¼Œå¯é€‰æ‹©å‡Œæ™¨ã€‚
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“</p>

<p>ä¸‹é¢è®°å½•äº†è¿™ä¸€æ“ä½œè¿‡ç¨‹ï¼š
åŸºæœ¬ä¿¡æ¯ï¼š
masterï¼š192.168.1.101
slaveï¼š192.168.1.102
ç‰ˆæœ¬ï¼šmysql5.6
åŒæ­¥çš„åº“ï¼šhuanqiuã€huanpc</p>

<p>Maatkitå®‰è£…è¿‡ç¨‹ï¼šï¼ˆä¸»åº“å’Œä»åº“æœåŠ¡å™¨ä¸Šéƒ½å¯ä»¥å®‰è£…ï¼Œå› ä¸ºæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æ“ä½œåœ¨ä¸»åº“æˆ–ä»åº“æœºå™¨ä¸Šéƒ½å¯ä»¥è¿è¡Œï¼›å»ºè®®ä¸»ä»æœºå™¨ä¸Šéƒ½å®‰è£…ï¼‰
1ï¼‰å®‰è£…è¯¥å·¥å…·ä¾èµ–çš„è½¯ä»¶åŒ…
[root@master-server src]# yum install perl-IO-Socket-SSL perl-DBD-MySQL perl-Time-HiRes perl perl-DBI -y</p>

<p>2ï¼‰maatkitä¸‹è½½å®‰è£…    [éœ€è¦FQåˆ°å®˜ç½‘ä¸‹è½½ï¼šhttps://code.google.com/archive/p/maatkit/downloads]
ç™¾åº¦äº‘ç›˜ä¸‹è½½åœ°å€ï¼šhttps://pan.baidu.com/s/1c1AufW8    ï¼ˆæå–å¯†ç ï¼švbi1ï¼‰
[root@master-server ~]# tar -zvxf maatkit-7540.tar.gz  &amp;&amp; cd maatkit-7540 
[root@master-server maatkit-7540]# perl Makefile.PL
ä½¿ç”¨mk-table-checksumæ£€æŸ¥ä¸»ä»æ•°æ®ä¸€è‡´æ€§
1ï¼‰åœ¨ä¸»åº“æœåŠ¡å™¨ä¸Šè¿è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æ“ä½œï¼ˆä¹Ÿå¯ä»¥åœ¨ä»åº“æœåŠ¡å™¨ä¸Šè¿›è¡Œæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥æ“ä½œï¼Œå‘½ä»¤è·Ÿä¸‹é¢ä¸€æ ·ï¼‰
[root@master-server ~]# mk-table-checksum h=192.168.1.101,u=data_check,p=check@123,P=3306 h=192.168.1.102,u=data_check,p=check@123,P=3306
ä½¿ç”¨mk-table-syncä¿®å¤ä¸»ä»ä¸åŒæ­¥çš„æ•°æ®
é¡¾åæ€ä¹‰ï¼Œmk-table-syncç”¨æ¥ä¿®å¤å¤šä¸ªå®ä¾‹ä¹‹é—´æ•°æ®çš„ä¸ä¸€è‡´ã€‚å®ƒå¯ä»¥è®©ä¸»ä»çš„æ•°æ®ä¿®å¤åˆ°æœ€ç»ˆä¸€è‡´ï¼Œä¹Ÿå¯ä»¥ä½¿é€šè¿‡åº”ç”¨åŒå†™æˆ–å¤šå†™çš„å¤šä¸ªä¸ç›¸å…³çš„æ•°æ®åº“å®ä¾‹ä¿®å¤åˆ°ä¸€è‡´ã€‚åŒæ—¶å®ƒè¿˜å†…éƒ¨é›†æˆäº†pt-table-checksumçš„æ ¡éªŒåŠŸèƒ½ï¼Œå¯ä»¥ä¸€è¾¹æ ¡éªŒä¸€è¾¹ä¿®å¤ï¼Œä¹Ÿå¯ä»¥åŸºäºpt-table-checksumçš„è®¡ç®—ç»“æœæ¥è¿›è¡Œä¿®å¤ã€‚
mk-table-syncå·¥ä½œåŸç†
1ï¼‰å•è¡Œæ•°æ®checksumå€¼çš„è®¡ç®—
è®¡ç®—é€»è¾‘ä¸pt-table-checksumä¸€æ ·ï¼Œä¹Ÿæ˜¯å…ˆæ£€æŸ¥è¡¨ç»“æ„ï¼Œå¹¶è·å–æ¯ä¸€åˆ—çš„æ•°æ®ç±»å‹ï¼ŒæŠŠæ‰€æœ‰æ•°æ®ç±»å‹éƒ½è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œç„¶åç”¨concat_ws()å‡½æ•°è¿›è¡Œè¿æ¥ï¼Œç”±æ­¤è®¡ç®—å‡ºè¯¥è¡Œçš„checksumå€¼ã€‚checksumé»˜è®¤é‡‡ç”¨crc32è®¡ç®—ã€‚</p>

<p>2ï¼‰æ•°æ®å—checksumå€¼çš„è®¡ç®—
åŒpt-table-checksumå·¥å…·ä¸€æ ·ï¼Œpt-table-syncä¼šæ™ºèƒ½åˆ†æè¡¨ä¸Šçš„ç´¢å¼•ï¼Œç„¶åæŠŠè¡¨çš„æ•°æ®splitæˆè‹¥å¹²ä¸ªchunkï¼Œè®¡ç®—çš„æ—¶å€™ä»¥chunkä¸ºå•ä½ã€‚å¯ä»¥ç†è§£ä¸ºæŠŠchunkå†…æ‰€æœ‰è¡Œçš„æ•°æ®æ‹¼æ¥èµ·æ¥ï¼Œå†è®¡ç®—crc32çš„å€¼ï¼Œå³å¾—åˆ°è¯¥chunkçš„checksumå€¼ã€‚</p>

<p>3ï¼‰åå—æ£€æµ‹å’Œä¿®å¤
å‰é¢ä¸¤æ­¥ï¼Œpt-table-syncä¸pt-table-checksumçš„ç®—æ³•å’ŒåŸç†ä¸€æ ·ã€‚å†å¾€ä¸‹ï¼Œå°±å¼€å§‹æœ‰æ‰€ä¸åŒï¼š
pt-table-checksumåªæ˜¯æ ¡éªŒï¼Œæ‰€ä»¥å®ƒæŠŠchecksumç»“æœå­˜å‚¨åˆ°ç»Ÿè®¡è¡¨ï¼Œç„¶åæŠŠæ‰§è¡Œè¿‡çš„sqlè¯­å¥è®°å½•åˆ°binlogä¸­ï¼Œä»»åŠ¡å°±ç®—å®Œæˆã€‚è¯­å¥çº§çš„å¤åˆ¶æŠŠè®¡ç®—é€»è¾‘ä¼ é€’åˆ°ä»åº“ï¼Œå¹¶åœ¨ä»åº“æ‰§è¡Œç›¸åŒçš„è®¡ç®—ã€‚pt-table-checksumçš„ç®—æ³•æœ¬èº«å¹¶ä¸åœ¨æ„ä»åº“çš„å»¶è¿Ÿï¼Œå»¶è¿Ÿå¤šå°‘éƒ½ä¸€æ ·è®¡ç®—(æœ‰åŒäº‹å¯¹æ­¤ä¸ç†è§£ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å‰ä¸€ç¯‡æ–‡ç« )ï¼Œä¸ä¼šå½±å“è®¡ç®—ç»“æœçš„æ­£ç¡®æ€§(ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¼šæ£€æµ‹å»¶è¿Ÿï¼Œå› ä¸ºå»¶è¿Ÿå¤ªå¤šä¼šå½±å“ä¸šåŠ¡ï¼Œæ‰€ä»¥æ€»æ˜¯è¦åŠ ä¸Šâ€”max-lagæ¥é™æµ)ã€‚ 
pt-table-syncåˆ™ä¸åŒã€‚å®ƒé¦–å…ˆè¦å®Œæˆchunkçš„checksumå€¼çš„è®¡ç®—ï¼Œä¸€æ—¦å‘ç°ä¸»ä»ä¸ŠåŒæ ·çš„chunkçš„checksumå€¼ä¸åŒï¼Œå°±æ·±å…¥åˆ°è¯¥chunkå†…éƒ¨ï¼Œé€è¡Œæ¯”è¾ƒå¹¶ä¿®å¤æœ‰é—®é¢˜çš„è¡Œã€‚å…¶è®¡ç®—é€»è¾‘æè¿°å¦‚ä¸‹(ä»¥ä¿®å¤ä¸»ä»ç»“æ„çš„æ•°æ®ä¸ä¸€è‡´ä¸ºä¾‹ï¼Œä¸šåŠ¡åŒå†™çš„æƒ…å†µä¿®å¤èµ·æ¥æ›´å¤æ‚â€”å› ä¸ºæ¶‰åŠåˆ°å†²çªè§£å†³å’ŒåŸºå‡†é€‰æ‹©çš„é—®é¢˜ï¼Œé™äºç¯‡å¹…ï¼Œè¿™é‡Œä¸ä»‹ç»)ï¼š
    1ï¼‰å¯¹æ¯ä¸€ä¸ªä»åº“ï¼Œæ¯ä¸€ä¸ªè¡¨ï¼Œå¾ªç¯è¿›è¡Œå¦‚ä¸‹æ ¡éªŒå’Œä¿®å¤è¿‡ç¨‹ã€‚
    2ï¼‰å¯¹æ¯ä¸€ä¸ªchunkï¼Œåœ¨æ ¡éªŒæ—¶åŠ ä¸Šfor updateé”ã€‚ä¸€æ—¦è·å¾—é”ï¼Œå°±è®°å½•ä¸‹å½“å‰ä¸»åº“çš„show master statuså€¼ã€‚
    3ï¼‰åœ¨ä»åº“ä¸Šæ‰§è¡Œselect master_pos_wait()å‡½æ•°ï¼Œç­‰å¾…ä»åº“sqlçº¿ç¨‹æ‰§è¡Œåˆ°show master statuså¾—åˆ°çš„ä½ç½®ã€‚ä»¥æ­¤ä¿è¯ï¼Œä¸»ä»ä¸Šå…³äºè¿™ä¸ªchunkçš„å†…å®¹å‡ä¸å†æ”¹å˜ã€‚
    4ï¼‰å¯¹è¿™ä¸ªchunkæ‰§è¡Œchecksumï¼Œç„¶åä¸ä¸»åº“çš„checksumè¿›è¡Œæ¯”è¾ƒã€‚
    5ï¼‰å¦‚æœchecksumç›¸åŒï¼Œè¯´æ˜ä¸»ä»æ•°æ®ä¸€è‡´ï¼Œå°±ç»§ç»­ä¸‹ä¸€ä¸ªchunkã€‚
    6ï¼‰å¦‚æœchecksumä¸åŒï¼Œè¯´æ˜è¯¥chunkæœ‰ä¸ä¸€è‡´ã€‚æ·±å…¥chunkå†…éƒ¨ï¼Œé€è¡Œè®¡ç®—checksumå¹¶æ¯”è¾ƒ(å•è¡Œchecksumæ¯”è¾ƒè¿‡ç¨‹ä¸chunkçš„æ¯”è¾ƒè¿‡ç¨‹ä¸€æ ·ï¼Œå•è¡Œå®é™…æ˜¯chunkçš„sizeä¸º1çš„ç‰¹ä¾‹)ã€‚
    7ï¼‰å¦‚æœå‘ç°æŸè¡Œä¸ä¸€è‡´ï¼Œåˆ™æ ‡è®°ä¸‹æ¥ã€‚ç»§ç»­æ£€æµ‹å‰©ä½™è¡Œï¼Œç›´åˆ°è¿™ä¸ªchunkç»“æŸã€‚
    8ï¼‰å¯¹æ‰¾åˆ°çš„ä¸»ä»ä¸ä¸€è‡´çš„è¡Œï¼Œé‡‡ç”¨replace intoè¯­å¥ï¼Œåœ¨ä¸»åº“æ‰§è¡Œä¸€éä»¥ç”Ÿæˆè¯¥è¡Œå…¨é‡çš„binlogï¼Œå¹¶åŒæ­¥åˆ°ä»åº“ï¼Œè¿™ä¼šä»¥ä¸»åº“æ•°æ®ä¸ºåŸºå‡†æ¥ä¿®å¤ä»åº“ï¼›å¯¹äºä¸»åº“æœ‰çš„è¡Œè€Œä»åº“æ²¡æœ‰çš„è¡Œï¼Œé‡‡ç”¨replaceåœ¨ä¸»åº“ä¸Šæ’å…¥(å¿…é¡»ä¸èƒ½æ˜¯insert)ï¼›å¯¹äºä»åº“æœ‰è€Œä¸»åº“æ²¡æœ‰çš„è¡Œï¼Œé€šè¿‡åœ¨ä¸»åº“æ‰§è¡Œdeleteæ¥åˆ é™¤(pt-table-syncå¼ºçƒˆå»ºè®®æ‰€æœ‰çš„æ•°æ®ä¿®å¤éƒ½åªåœ¨ä¸»åº“è¿›è¡Œï¼Œè€Œä¸å»ºè®®ç›´æ¥ä¿®æ”¹ä»åº“æ•°æ®ï¼›ä½†æ˜¯ä¹Ÿæœ‰ç‰¹ä¾‹ï¼Œåé¢ä¼šè®²åˆ°)ã€‚
    9ï¼‰ç›´åˆ°ä¿®å¤è¯¥chunkæ‰€æœ‰ä¸ä¸€è‡´çš„è¡Œã€‚ç»§ç»­æ£€æŸ¥å’Œä¿®å¤ä¸‹ä¸€ä¸ªchunkã€‚
   10ï¼‰ç›´åˆ°è¿™ä¸ªä»åº“ä¸Šæ‰€æœ‰çš„è¡¨ä¿®å¤ç»“æŸã€‚å¼€å§‹ä¿®å¤ä¸‹ä¸€ä¸ªä»åº“ã€‚</p>

<p>é‡è¦é€‰é¡¹
â€“print                    æ˜¾ç¤ºåŒæ­¥éœ€è¦æ‰§è¡Œçš„è¯­å¥
â€“execute               æ‰§è¡Œæ•°æ®åŒæ­¥
â€“charset=utf8        è®¾ç½®å­—ç¬¦é›†ï¼Œé¿å…ä»åº“ä¹±ç ã€‚</p>

<p>å®ä¾‹è¯´æ˜ï¼š
mk-table-syncçš„å·¥ä½œæ–¹å¼æ˜¯ï¼šå…ˆä¸€è¡Œä¸€è¡Œæ£€æŸ¥ä¸»ä»åº“çš„è¡¨æ˜¯å¦ä¸€æ ·ï¼Œå¦‚æœå“ªé‡Œä¸ä¸€æ ·ï¼Œå°±æ‰§è¡Œåˆ é™¤ï¼Œæ›´æ–°ï¼Œæ’å…¥ç­‰æ“ä½œï¼Œä½¿å…¶è¾¾åˆ°ä¸€è‡´ã€‚
é€šè¿‡ä¸Šé¢mk-table-checksumçš„æ£€æŸ¥ç»“æœå¯ä»¥çœ‹å‡ºï¼ŒåŒæ­¥çš„ä¸¤ä¸ªåº“huanqiuå’Œhuanpcçš„æ•°æ®å¹¶ä¸ä¸€è‡´ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨mk-table-syncè¿›è¡Œæ•°æ®ä¿®å¤äº†ã€‚</p>

<p>æ•°æ®ä¿®å¤å‘½ä»¤å¦‚ä¸‹ï¼šï¼ˆå¦‚æœmysqlç«¯å£æ˜¯é»˜è®¤çš„3306ï¼Œåˆ™ä¸‹é¢å‘½ä»¤ä¸­çš„P=3306å¯ä»¥çœç•¥ï¼‰
ç”±äºä¸Šé¢åœ¨mk-table-checksumæ£€æŸ¥æ—¶ç”¨çš„data_checkåªæœ‰selectæƒé™ï¼Œæƒé™å¤ªå°ï¼Œä¸èƒ½ç”¨äºmk-table-syncä¿®å¤æ•°æ®åªç”¨ã€‚
æ‰€ä»¥è¿˜éœ€è¦åœ¨ä¸»åº“å’Œä»åº“æ•°æ®åº“é‡Œåˆ›å»ºç”¨äºmk-table-syncä¿®å¤æ•°æ®ä¹‹ç”¨çš„è´¦å·æƒé™</p>

:ET