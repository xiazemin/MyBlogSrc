I" M<p>https://github.com/micro/go-micro
https://www.kancloud.cn/linimbus/go-micro/529018
go-microæ˜¯åŸºäºGoè¯­è¨€å®ç°çš„æ’ä»¶åŒ–RPCå¾®æœåŠ¡æ¡†æ¶ï¼Œä¸go-kitï¼Œkiteç­‰å¾®æœåŠ¡æ¡†æ¶ç›¸æ¯”ï¼Œå®ƒå…·æœ‰æ˜“ä¸Šæ‰‹ã€éƒ¨ç½²ç®€å•ã€å·¥å…·æ’ä»¶åŒ–ç­‰ä¼˜ç‚¹ã€‚</p>

<p>go-microæ¡†æ¶æä¾›äº†æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€åŒæ­¥ä¼ è¾“ã€å¼‚æ­¥é€šä¿¡ä»¥åŠäº‹ä»¶é©±åŠ¨ç­‰æœºåˆ¶ï¼Œå®ƒå°è¯•å»ç®€åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿé—´çš„é€šä¿¡ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä¸“æ³¨äºè‡ªèº«ä¸šåŠ¡é€»è¾‘çš„å¼€å‘ã€‚æ‰€ä»¥å¯¹äºæ–°æ‰‹è€Œè¨€ï¼Œgo-microæ˜¯ä¸ªä¸é”™çš„å¾®æœåŠ¡å®è·µçš„å¼€å§‹ã€‚
<!-- more -->
go-microæ˜¯ç»„ä»¶åŒ–çš„æ¡†æ¶ï¼Œæ¯ä¸€ä¸ªåŸºç¡€åŠŸèƒ½éƒ½æ˜¯ä¸€ä¸ªinterfaceï¼Œæ–¹ä¾¿æ‰©å±•ã€‚åŒæ—¶ï¼Œç»„ä»¶åˆæ˜¯åˆ†å±‚çš„ï¼Œä¸Šå±‚åŸºäºä¸‹å±‚åŠŸèƒ½å‘ä¸Šæä¾›æœåŠ¡ï¼Œæ•´ä½“æ„æˆgo-microæ¡†æ¶ã€‚
go-microçš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>

<p>Registryç»„ä»¶ï¼šæœåŠ¡å‘ç°ç»„ä»¶ï¼Œæä¾›æœåŠ¡å‘ç°æœºåˆ¶ï¼šè§£ææœåŠ¡åå­—è‡³æœåŠ¡åœ°å€ã€‚ç›®å‰æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒæœ‰consulã€etcdã€ zookeeperã€dnsã€gossipç­‰
Selectorç»„ä»¶ï¼šæ„å»ºåœ¨Registryä¹‹ä¸Šçš„å®¢æˆ·ç«¯æ™ºèƒ½è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼Œç”¨äºClientç»„ä»¶å¯¹Registryè¿”å›çš„æœåŠ¡è¿›è¡Œæ™ºèƒ½é€‰æ‹©ã€‚
Brokerç»„ä»¶ï¼šå‘å¸ƒ/è®¢é˜…ç»„ä»¶ï¼ŒæœåŠ¡ä¹‹é—´åŸºäºæ¶ˆæ¯ä¸­é—´ä»¶çš„å¼‚æ­¥é€šä¿¡æ–¹å¼ï¼Œé»˜è®¤ä½¿ç”¨httpæ–¹å¼ï¼Œçº¿ä¸Šé€šå¸¸ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå¦‚Kafkaã€RabbitMQç­‰ã€‚
Transportç»„ä»¶ï¼šæœåŠ¡ä¹‹é—´åŒæ­¥é€šä¿¡æ–¹å¼ã€‚
Codecç»„ä»¶ï¼šæœåŠ¡ä¹‹é—´æ¶ˆæ¯çš„ç¼–ç /è§£ç ã€‚
Serverç»„ä»¶ï¼šæœåŠ¡ä¸»ä½“ï¼Œè¯¥ç»„ä»¶åŸºäºä¸Šé¢çš„Registry/Selector/Transport/Brokerç»„ä»¶ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æœåŠ¡è¯·æ±‚å…¥å£ã€‚
Clientç»„ä»¶ï¼šæä¾›è®¿é—®å¾®æœåŠ¡çš„å®¢æˆ·ç«¯ã€‚ç±»ä¼¼Serverç»„ä»¶ï¼Œå®ƒä¹Ÿæ˜¯é€šè¿‡Registry/Selector/Transport/Brokerç»„ä»¶å®ç°æŸ¥æ‰¾æœåŠ¡ã€è´Ÿè½½å‡è¡¡ã€åŒæ­¥é€šä¿¡ã€å¼‚æ­¥æ¶ˆæ¯ç­‰åŠŸèƒ½ã€‚
æ‰€æœ‰ä»¥ä¸Šç»„ä»¶åŠŸèƒ½å…±åŒæ„æˆä¸€ä¸ªgo-microå¾®æœåŠ¡ã€‚</p>

<p>clientä¸serverä¹‹é—´æˆ‘ä»¬ä½¿ç”¨ç‚¹å¯¹ç‚¹çš„åŒæ­¥æ–¹å¼ï¼ˆTransportï¼‰ï¼Œå³æ— éœ€æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆBrokerï¼‰ï¼Œæ³¨å†Œä¸­å¿ƒé‡‡ç”¨consulç³»ç»Ÿã€‚</p>

<p>3.1 å®‰è£…consul - æ³¨å†Œä¸­å¿ƒ
æœåŠ¡æ³¨å†Œä¸­å¿ƒæˆ‘ä»¬é€‰æ‹©consulï¼š</p>

<p>macï¼šbrew install consul
windowsï¼šç›´æ¥å®˜ç½‘ä¸‹è½½consul.exeå¯æ‰§è¡Œç¨‹åº
è¿è¡Œconsulï¼šå¯åŠ¨Consul agentçš„å¼€å‘æ¨¡å¼ï¼š</p>

<p>consul agent -dev</p>

<p>è¯¥å‘½ä»¤å¿«é€Ÿå¯åŠ¨ä¸€ä¸ªå•èŠ‚ç‚¹çš„consulï¼Œä¸”ä¸ºé›†ç¾¤çš„é¢†è¢–</p>

<p>æŸ¥çœ‹Consulé›†ç¾¤çš„æˆå‘˜ï¼šæ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œï¼š</p>

<p>consul members</p>

<p>åœæ­¢Agentï¼šä½¿ç”¨ Ctrl-Cï¼Œä¼˜é›…çš„å…³é—­Agent</p>

<p>ä¹Ÿå¯ä»¥é€šè¿‡WebUIæ¥æŸ¥çœ‹å„serviceçŠ¶æ€ï¼šhttp://localhost:8500/</p>

<p>3.2 å®‰è£…microï¼šå¾®æœåŠ¡ç®¡ç†å·¥å…·
microæ˜¯ä»¥go-microæ¡†æ¶ä¸ºæ ¸å¿ƒçš„å¾®æœåŠ¡ç®¡ç†å·¥å…·ï¼Œé€šè¿‡å®ƒå¯ä»¥æ–¹ä¾¿æŸ¥çœ‹go-microæœåŠ¡æƒ…å†µã€‚</p>

<p>åœ¨$GOPATHç›®å½•ä¸‹ï¼Œæ‰§è¡Œgo get github.com/micro/microï¼Œè¯¥å‘½ä»¤ä¼šåœ¨binç›®å½•ï¼ˆ$GOBINï¼‰ä¸‹ç”Ÿæˆmicro(.exe)å·¥å…·
microå‘½ä»¤è¡Œå·¥å…·å¯ä»¥æä¾›è¯¸å¦‚æœåŠ¡åˆ—è¡¨æŸ¥çœ‹ã€æœåŠ¡è¯¦æƒ…æŸ¥çœ‹ã€è°ƒç”¨æœåŠ¡æ¥å£ç­‰åŠŸèƒ½ã€‚</p>

<p>3.3 å®‰è£…goprotobufç›¸å…³å·¥å…·ï¼šGRPCç›¸å…³å·¥å…·
protocï¼šProtobufï¼ˆProtocol Buffers - Googleâ€™s data interchange formatï¼‰ç¼–è¯‘å™¨ï¼š</p>

<p>windowsä¸‹ç›´æ¥ä¸‹è½½ ç›¸å…³winçš„zipå‹ç¼©æ–‡ä»¶ï¼ˆå†…å«protoc.exeï¼‰
macï¼š brew install protobuf
protoc-gen-goï¼šgoprotobuf æä¾›çš„ Protobuf æ’ä»¶ï¼šåœ¨$GOPATHç›®å½•ä¸‹æ‰§è¡Œgo get github.com/micro/protobuf/{proto,protoc-gen-go}ï¼Œè¯¥å‘½ä»¤ä¼šåœ¨binç›®å½•ä¸‹ç”Ÿæˆprotoc-gen-go(.exe)å·¥å…·ï¼Œprotocç¼–è¯‘å™¨åˆ©ç”¨protoc-gen-goæ’ä»¶å°†.protoæ–‡ä»¶è½¬æ¢ä¸ºGolangæºæ–‡ä»¶
protoc-gen-microï¼ˆProtobuf code generation for microï¼‰ï¼šåœ¨$GOPATHç›®å½•ä¸‹æ‰§è¡Œgo get github.com/micro/protoc-gen-microï¼Œè¯¥å‘½ä»¤ä¼šåœ¨binç›®å½•ä¸‹ç”Ÿæˆprotoc-gen-micro(.exe)ï¼Œprotocç¼–è¯‘å™¨åˆ©ç”¨protoc-gen-microæ’ä»¶å°†.protoæ–‡ä»¶è½¬æ¢ä¸ºmicroä»£ç é£æ ¼æ–‡ä»¶
goprotobufç¼–è¯‘å‚æ•°ï¼š</p>

<p>-Iå‚æ•°ï¼šæŒ‡å®šimportè·¯å¾„ï¼Œå¯ä»¥æŒ‡å®šå¤šä¸ª-Iå‚æ•°ï¼Œç¼–è¯‘æ—¶æŒ‰ç…§é¡ºåºæŸ¥æ‰¾ï¼Œä¸æŒ‡å®šæ—¶é»˜è®¤æŸ¥æ‰¾å½“å‰ç›®å½•
â€“go_outï¼šGolangç¼–è¯‘æ”¯æŒï¼Œæ”¯æŒä»¥ä¸‹å‚æ•°</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">plugins=plugin1+plugin2</code>ï¼šæŒ‡å®šæ’ä»¶ï¼Œæ”¯æŒgrpc/microï¼Œå³ï¼šplugins=grpc+micro</li>
  <li><code class="language-plaintext highlighter-rouge">M</code>å‚æ•°ï¼šæŒ‡å®šå¯¼å…¥çš„.protoæ–‡ä»¶è·¯å¾„ç¼–è¯‘åå¯¹åº”çš„goalngåŒ…åï¼ˆä¸æŒ‡å®šé»˜è®¤.protoæ–‡ä»¶ä¸­importè¯­å¥è·¯å¾„ï¼‰</li>
  <li><code class="language-plaintext highlighter-rouge">import_prefix=xxx</code>ï¼šä¸ºæ‰€æœ‰importè·¯å¾„æ·»åŠ å‰ç¼€ï¼Œä¸»è¦ç”¨äºç¼–è¯‘å­ç›®å½•å†…çš„å¤šä¸ªprotoæ–‡ä»¶</li>
  <li><code class="language-plaintext highlighter-rouge">import_path=foo/bar</code>ï¼šæŒ‡å®šæœªå£°æ˜packageæˆ–go_packageçš„æ–‡ä»¶çš„åŒ…åï¼Œæœ€å³è¾¹çš„æ–œçº¿å‰çš„å­—ç¬¦ä¼šè¢«å¿½ç•¥
3.4 ç¼–å†™ä¸€ä¸ªç®€å•çš„HelloæœåŠ¡
è‡³æ­¤ï¼Œgo-microæ¡†æ¶çš„ç¼–ç¨‹ç¯å¢ƒå·²åŸºæœ¬æ­å»ºå¥½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å†™ä»£ç äº†ã€‚</li>
</ul>

<p>ä¸‹é¢å®ç°ä¸€ä¸ªHelloæœåŠ¡ï¼šå®ƒæ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹å‚æ•°è¯·æ±‚ï¼Œè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²é—®å€™è¯­ï¼šHello ã€å‚æ•°å€¼ã€ã€‚
1ï¼‰å®šä¹‰API</p>

<p>åˆ›å»ºproto/hello.protoæ–‡ä»¶ï¼š
ä½¿ç”¨protobufæ–‡ä»¶æ¥å®šä¹‰æœåŠ¡APIæ¥å£</p>

<p>syntax = â€œproto3â€;
service Hello {
    rpc Ping(Request) returns (Response) {}
}
message Request {
    string name = 1;
}
message Response {
    string msg = 1;
}
æ‰§è¡Œprotocå‘½ä»¤ï¼Œç”Ÿæˆå½“å‰pbæ–‡ä»¶çš„goå®ç°ï¼š</p>

<p>protoc â€“go_out=plugins=micro:. ./proto/hello.proto
2ï¼‰åˆ›å»ºservice</p>

<p>åˆ›å»ºservices/hello.goæ–‡ä»¶ï¼š</p>

<p>package main</p>

<p>import (
    â€œcontextâ€
    â€œfmtâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proto "winmicro/proto"

micro "github.com/micro/go-micro" )
</code></pre></div></div>

<p>type Hello struct{}</p>

<p>func (h *Hello) Ping(ctx context.Context, req *proto.Request, res *proto.Response) error {
    res.Msg = â€œHello â€œ + req.Name
    return nil
}
func main() {
    service := micro.NewService(
        micro.Name(â€œhelloooâ€), // æœåŠ¡åç§°
    )
    service.Init()
    proto.RegisterHelloHandler(service.Server(), new(Hello))
    if err := service.Run(); err != nil {
        fmt.Println(err)
    }
}
3)æ¨¡æ‹Ÿclient</p>

<p>åˆ›å»ºClients/helloclient.goæ–‡ä»¶ï¼š</p>

<p>package main</p>

<p>import (
    â€œcontextâ€
    â€œfmtâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proto "winmicro/proto"

micro "github.com/micro/go-micro" )
</code></pre></div></div>

<p>func main() {
    service := micro.NewService(micro.Name(â€œhello.clientâ€)) // å®¢æˆ·ç«¯æœåŠ¡åç§°
    service.Init()
    helloservice := proto.NewHelloService(â€œhelloooâ€, service.Client())
    res, err := helloservice.Ping(context.TODO(), &amp;proto.Request{Name: â€œWorld ^_^â€})
    if err != nil {
        fmt.Println(err)
    }
    fmt.Println(res.Msg)
}
3.5 è¿è¡ŒHelloæœåŠ¡
å¯åŠ¨consulä¹‹å
æ‰§è¡Œmicro list services æŸ¥çœ‹å½“å‰å·²æœ‰æœåŠ¡ï¼š</p>

<blockquote>
  <p>micro list services
consul
æ‰§è¡Œgo run services/hello.goå‘½ä»¤ï¼Œå¯åŠ¨helloooæœåŠ¡ï¼š</p>
</blockquote>

<blockquote>
  <p>go run services/hello.go
2018/11/29 20:18:08 Listening on [::]:61463
2018/11/29 20:18:08 Broker Listening on [::]:61464
2018/11/29 20:18:08 Registering node: hellooo-74122f56-4728-4449-a9d4-6c3c85ba2fcb
â€¦.
å†æ¬¡æ‰§è¡Œmicro list services æŸ¥çœ‹å½“å‰å·²æœ‰æœåŠ¡ï¼š</p>
</blockquote>

<blockquote>
  <p>micro list services
consul
hellooo
å³helloooæœåŠ¡å·²å¯åŠ¨</p>
</blockquote>

<p>æ³¨ é€šè¿‡WebUIæ¥æŸ¥çœ‹å„serviceä¿¡æ¯ï¼šhttp://localhost:8500/</p>

<p>è¯·æ±‚æœåŠ¡
æ‰§è¡Œgo run clients/helloclient.goå‘½ä»¤ï¼Œå‘helloooæœåŠ¡å‘èµ·è¯·æ±‚ï¼š</p>

<blockquote>
  <p>go run clients/helloclient.go
Hello World ^_^</p>
</blockquote>

<p>go-microæ˜¯goè¯­è¨€ä¸‹çš„ä¸€ä¸ªå¾ˆå¥½çš„rpcå¾®æœåŠ¡æ¡†æ¶ï¼ŒåŠŸèƒ½å¾ˆå®Œå–„ï¼Œè€Œä¸”æˆ‘å…³å¿ƒçš„å‡ ä¸ªé—®é¢˜ä¹Ÿè§£å†³çš„å¾ˆå¥½ï¼š</p>

<p>ä¸€ï¼šæœåŠ¡é—´ä¼ è¾“æ ¼å¼ä¸ºprotobufï¼Œæ•ˆç‡ä¸Šæ²¡çš„è¯´ï¼Œéå¸¸çš„å¿«ï¼Œä¹Ÿå¾ˆå®‰å…¨ã€‚</p>

<p>äºŒï¼šgo-microçš„æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯å¤šç§å¤šæ ·çš„ã€‚æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢etcdv3çš„æœåŠ¡æœåŠ¡å‘ç°å’Œæ³¨å†Œã€‚</p>

<p>ä¸‰ï¼šä¸»è¦çš„åŠŸèƒ½éƒ½æœ‰ç›¸åº”çš„æ¥å£ï¼Œåªè¦å®ç°ç›¸åº”çš„æ¥å£ï¼Œå°±å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è®¢åˆ¶æ’ä»¶ã€‚</p>

<p>Serverç›‘å¬å®¢æˆ·ç«¯çš„è°ƒç”¨ï¼Œå’ŒBrockeræ¨é€è¿‡æ¥çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ã€‚å¹¶ä¸”Serverç«¯éœ€è¦å‘Registeræ³¨å†Œè‡ªå·±çš„å­˜åœ¨æˆ–æ¶ˆäº¡ï¼Œè¿™æ ·Clientæ‰èƒ½çŸ¥é“è‡ªå·±çš„çŠ¶æ€ã€‚</p>

<p>RegisteræœåŠ¡çš„æ³¨å†Œçš„å‘ç°ã€‚</p>

<p>Clientç«¯ä»Registerä¸­å¾—åˆ°Serverçš„ä¿¡æ¯ï¼Œç„¶åæ¯æ¬¡è°ƒç”¨éƒ½æ ¹æ®ç®—æ³•é€‰æ‹©ä¸€ä¸ªçš„Serverè¿›è¡Œé€šä¿¡ï¼Œå½“ç„¶é€šä¿¡æ˜¯è¦ç»è¿‡ç¼–ç /è§£ç ï¼Œé€‰æ‹©ä¼ è¾“åè®®ç­‰ä¸€ç³»åˆ—è¿‡ç¨‹çš„ã€‚</p>

<p>å¦‚æœæœ‰éœ€è¦é€šçŸ¥æ‰€æœ‰çš„Serverç«¯å¯ä»¥ä½¿ç”¨Brockerè¿›è¡Œä¿¡æ¯çš„æ¨é€ã€‚</p>

<p>Brocker ä¿¡æ¯é˜Ÿåˆ—è¿›è¡Œä¿¡æ¯çš„æ¥æ”¶å’Œå‘å¸ƒã€‚</p>

<p>go-microä¹‹æ‰€ä»¥å¯ä»¥é«˜åº¦è®¢åˆ¶å’Œä»–çš„æ¡†æ¶ç»“æ„æ˜¯åˆ†ä¸å¼€çš„ï¼Œgo-microç”±8ä¸ªå…³é”®çš„interfaceç»„æˆï¼Œæ¯ä¸€ä¸ªinterfaceéƒ½å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚é‡æ–°å®ç°ï¼Œè¿™8ä¸ªä¸»è¦çš„intefaceä¹Ÿæ„æˆäº†go-microçš„æ¡†æ¶ç»“æ„ã€‚</p>

<p>Transort
æœåŠ¡ä¹‹é—´é€šä¿¡çš„æ¥å£ã€‚ä¹Ÿå°±æ˜¯æœåŠ¡å‘é€å’Œæ¥æ”¶çš„æœ€ç»ˆå®ç°æ–¹å¼ï¼Œæ˜¯ç”±è¿™äº›æ¥å£å®šåˆ¶çš„ã€‚</p>

<p>æºç ï¼š</p>

<p>type Socket interface {
    Recv(<em>Message) error
    Send(</em>Message) error
    Close() error
}</p>

<p>type Client interface {
    Socket
}</p>

<p>type Listener interface {
    Addr() string
    Close() error
    Accept(func(Socket)) error
}</p>

<p>type Transport interface {
    Dial(addr string, opts â€¦DialOption) (Client, error)
    Listen(addr string, opts â€¦ListenOption) (Listener, error)
    String() string
}
Transport çš„Listenæ–¹æ³•æ˜¯ä¸€èˆ¬æ˜¯Serverç«¯è¿›è¡Œè°ƒç”¨çš„ï¼Œä»–ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯è°ƒç”¨ã€‚</p>

<p>Transport çš„Dialå°±æ˜¯å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥æœåŠ¡çš„æ–¹æ³•ã€‚ä»–è¿”å›ä¸€ä¸ªClientæ¥å£ï¼Œè¿™ä¸ªæ¥å£è¿”å›ä¸€ä¸ªClientæ¥å£ï¼Œè¿™ä¸ªClientåµŒå…¥äº†Socketæ¥å£ï¼Œè¿™ä¸ªæ¥å£çš„æ–¹æ³•å°±æ˜¯å…·ä½“å‘é€å’Œæ¥æ”¶é€šä¿¡çš„ä¿¡æ¯ã€‚</p>

<p>httpä¼ è¾“æ˜¯go-microé»˜è®¤çš„åŒæ­¥é€šä¿¡æœºåˆ¶ã€‚å½“ç„¶è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ’ä»¶ï¼šgrpc,nats,tcp,udp,rabbitmq,natsï¼Œéƒ½æ˜¯ç›®å‰å·²ç»å®ç°äº†çš„æ–¹å¼ã€‚åœ¨go-pluginsé‡Œä½ éƒ½å¯ä»¥æ‰¾åˆ°ã€‚</p>

<p>Codec
æœ‰äº†ä¼ è¾“æ–¹å¼ï¼Œä¸‹é¢è¦è§£å†³çš„å°±æ˜¯ä¼ è¾“ç¼–ç å’Œè§£ç é—®é¢˜ï¼Œgo-microæœ‰å¾ˆå¤šç§ç¼–ç è§£ç æ–¹å¼ï¼Œé»˜è®¤çš„å®ç°æ–¹å¼æ˜¯protobuf,å½“ç„¶ä¹Ÿæœ‰å…¶ä»–çš„å®ç°æ–¹å¼ï¼Œjsonã€protobufã€jsonrpcã€mercuryç­‰ç­‰ã€‚</p>

<p>type Codec interface {
    ReadHeader(<em>Message, MessageType) error
    ReadBody(interface{}) error
    Write(</em>Message, interface{}) error
    Close() error
    String() string
}</p>

<p>type Message struct {
    Id     uint64
    Type   MessageType
    Target string
    Method string
    Error  string
    Header map[string]string
}
Codecæ¥å£çš„Writeæ–¹æ³•å°±æ˜¯ç¼–ç è¿‡ç¨‹ï¼Œä¸¤ä¸ªReadæ˜¯è§£ç è¿‡ç¨‹ã€‚</p>

<p>Registry
æœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ï¼Œç›®å‰å®ç°çš„consul,mdns, etcd,etcdv3,zookeeper,kubernetes.ç­‰ç­‰ï¼Œ</p>

<p>type Registry interface {
    Register(<em>Service, â€¦RegisterOption) error
    Deregister(</em>Service) error
    GetService(string) ([]<em>Service, error)
    ListServices() ([]</em>Service, error)
    Watch(â€¦WatchOption) (Watcher, error)
    String() string
    Options() Options
}
ç®€å•æ¥è¯´ï¼Œå°±æ˜¯Service è¿›è¡ŒRegisterï¼Œæ¥è¿›è¡Œæ³¨å†Œï¼ŒClient ä½¿ç”¨watchæ–¹æ³•è¿›è¡Œç›‘æ§ï¼Œå½“æœ‰æœåŠ¡åŠ å…¥æˆ–è€…åˆ é™¤æ—¶è¿™ä¸ªæ–¹æ³•ä¼šè¢«è§¦å‘ï¼Œä»¥æé†’å®¢æˆ·ç«¯æ›´æ–°Serviceä¿¡æ¯ã€‚</p>

<p>é»˜è®¤çš„æ˜¯æœåŠ¡æ³¨å†Œå’Œå‘ç°æ˜¯consul</p>

<p>Selector
ä»¥Registryä¸ºåŸºç¡€ï¼ŒSelector æ˜¯å®¢æˆ·ç«¯çº§åˆ«çš„è´Ÿè½½å‡è¡¡ï¼Œå½“æœ‰å®¢æˆ·ç«¯å‘æœåŠ¡å‘é€è¯·æ±‚æ—¶ï¼Œ selectoræ ¹æ®ä¸åŒçš„ç®—æ³•ä»Registeryä¸­çš„ä¸»æœºåˆ—è¡¨ï¼Œå¾—åˆ°å¯ç”¨çš„ServiceèŠ‚ç‚¹ï¼Œè¿›è¡Œé€šä¿¡ã€‚ç›®å‰å®ç°çš„æœ‰å¾ªç¯ç®—æ³•å’Œéšæœºç®—æ³•ï¼Œé»˜è®¤çš„æ˜¯éšæœºç®—æ³•ã€‚</p>

<p>æºç ï¼š</p>

<p>type Selector interface {
    Init(opts â€¦Option) error
    Options() Options
    // Select returns a function which should return the next node
    Select(service string, opts â€¦SelectOption) (Next, error)
    // Mark sets the success/error against a node
    Mark(service string, node *registry.Node, err error)
    // Reset returns state back to zero for a service
    Reset(service string)
    // Close renders the selector unusable
    Close() error
    // Name of the selector
    String() string
}
é»˜è®¤çš„æ˜¯å®ç°æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œå½“
å‰å®ç°çš„æœ‰blacklist,label,namedç­‰æ–¹å¼ã€‚</p>

<p>Broker
Brokeræ˜¯æ¶ˆæ¯å‘å¸ƒå’Œè®¢é˜…çš„æ¥å£ã€‚å¾ˆç®€å•çš„ä¸€ä¸ªä¾‹å­ï¼Œå› ä¸ºæœåŠ¡çš„èŠ‚ç‚¹æ˜¯ä¸å›ºå®šçš„ï¼Œå¦‚æœæœ‰éœ€è¦ä¿®æ”¹æ‰€æœ‰æœåŠ¡è¡Œä¸ºçš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿æœåŠ¡è®¢é˜…æŸä¸ªä¸»é¢˜ï¼Œå½“æœ‰ä¿¡æ¯å‘å¸ƒæ—¶ï¼Œæ‰€æœ‰çš„ç›‘å¬æœåŠ¡éƒ½ä¼šæ”¶åˆ°ä¿¡æ¯ï¼Œæ ¹æ®ä½ çš„éœ€è¦åšç›¸åº”çš„è¡Œä¸ºã€‚</p>

<p>æºç </p>

<p>type Broker interface {
    Options() Options
    Address() string
    Connect() error
    Disconnect() error
    Init(â€¦Option) error
    Publish(string, *Message, â€¦PublishOption) error
    Subscribe(string, Handler, â€¦SubscribeOption) (Subscriber, error)
    String() string
}
Brokeré»˜è®¤çš„å®ç°æ–¹å¼æ˜¯httpæ–¹å¼ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒç”¨ã€‚go-pluginsé‡Œæœ‰å¾ˆå¤šæˆç†Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°æ–¹å¼ï¼Œæœ‰kafkaã€nsqã€rabbitmqã€redisï¼Œç­‰ç­‰ã€‚</p>

<p>Client
Clientæ˜¯è¯·æ±‚æœåŠ¡çš„æ¥å£ï¼Œä»–å°è£…Transportå’ŒCodecè¿›è¡Œrpcè°ƒç”¨ï¼Œä¹Ÿå°è£…äº†Brockerè¿›è¡Œä¿¡æ¯çš„å‘å¸ƒã€‚</p>

<p>æºç </p>

<p>type Client interface {
    Init(â€¦Option) error
    Options() Options
    NewMessage(topic string, msg interface{}, opts â€¦MessageOption) Message
    NewRequest(service, method string, req interface{}, reqOpts â€¦RequestOption) Request
    Call(ctx context.Context, req Request, rsp interface{}, opts â€¦CallOption) error
    Stream(ctx context.Context, req Request, opts â€¦CallOption) (Stream, error)
    Publish(ctx context.Context, msg Message, opts â€¦PublishOption) error
    String() string
}
å½“ç„¶ä»–ä¹Ÿæ”¯æŒåŒå·¥é€šä¿¡ Stream è¿™äº›å…·ä½“çš„å®ç°æ–¹å¼å’Œä½¿ç”¨æ–¹å¼ï¼Œä»¥åä¼šè¯¦ç»†è§£è¯´ã€‚</p>

<p>é»˜è®¤çš„æ˜¯rpcå®ç°æ–¹å¼ï¼Œä»–è¿˜æœ‰grpcå’Œhttpæ–¹å¼ï¼Œåœ¨go-pluginsé‡Œå¯ä»¥æ‰¾åˆ°</p>

<p>Server
Serverçœ‹åå­—å¤§å®¶ä¹ŸçŸ¥é“æ˜¯åšä»€ä¹ˆçš„äº†ã€‚ç›‘å¬ç­‰å¾…rpcè¯·æ±‚ã€‚ç›‘å¬brokerçš„è®¢é˜…ä¿¡æ¯ï¼Œç­‰å¾…ä¿¡æ¯é˜Ÿåˆ—çš„æ¨é€ç­‰ã€‚</p>

<p>æºç </p>

<p>type Server interface {
    Options() Options
    Init(â€¦Option) error
    Handle(Handler) error
    NewHandler(interface{}, â€¦HandlerOption) Handler
    NewSubscriber(string, interface{}, â€¦SubscriberOption) Subscriber
    Subscribe(Subscriber) error
    Register() error
    Deregister() error
    Start() error
    Stop() error
    String() string
}
é»˜è®¤çš„æ˜¯rpcå®ç°æ–¹å¼ï¼Œä»–è¿˜æœ‰grpcå’Œhttpæ–¹å¼ï¼Œåœ¨go-pluginsé‡Œå¯ä»¥æ‰¾åˆ°</p>

<p>Service
Serviceæ˜¯Clientå’ŒServerçš„å°è£…ï¼Œä»–åŒ…å«äº†ä¸€ç³»åˆ—çš„æ–¹æ³•ä½¿ç”¨åˆå§‹å€¼å»åˆå§‹åŒ–Serviceå’ŒClientï¼Œä½¿æˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„åˆ›å»ºä¸€ä¸ªrpcæœåŠ¡ã€‚</p>

<p>æºç ï¼š</p>

<p>type Service interface {
    Init(â€¦Option)
    Options() Options
    Client() client.Client
    Server() server.Server
    Run() error
    String() string
}</p>

<p>Microç”±å¼€æºçš„åº“ä¸å·¥å…·ç»„æˆï¼Œæ—¨åœ¨è¾…åŠ©å¾®æœåŠ¡å¼€å‘ã€‚</p>

<p>go-micro - åŸºäºGoè¯­è¨€çš„å¯æ’æ‹”RPCå¾®æœåŠ¡å¼€å‘æ¡†æ¶ï¼›åŒ…å«æœåŠ¡å‘ç°ã€RPCå®¢æˆ·/æœåŠ¡ç«¯ã€å¹¿æ’­/è®¢é˜…æœºåˆ¶ç­‰ç­‰ã€‚
go-plugins - go-microçš„æ’ä»¶æœ‰etcdã€kubernetesã€natsã€rabbitmqã€grpcç­‰ç­‰ã€‚
micro - å¾®æœåŠ¡å·¥å…·é›†åŒ…å«ä¼ ç»Ÿçš„å…¥å£ç‚¹ï¼ˆentry pointï¼‰ï¼›API ç½‘å…³ã€CLIã€Slack Botã€ä»£ç†åŠWeb UIã€‚</p>

<p>å¯ä»¥é€šè¿‡microå·¥å…·é›†çš„cliï¼Œweb uiï¼Œslackï¼Œæˆ–è€…apiç½‘å…³ï¼ˆapi gatewayï¼‰æ¥è®¿é—®æ“æ§åŠ¡ã€‚</p>

<p>é™¤äº†Consulï¼Œå¯ä»¥ä½¿ç”¨å…¶å®ƒçš„æ³¨å†Œä¸­å¿ƒå—
å½“ç„¶æ˜¯å¯ä»¥çš„ï¼ŒæœåŠ¡çš„æ³¨å†Œå‘ç°çš„å®ç°æœºåˆ¶æ˜¯å¯æ’æ‹”çš„ï¼Œä¹‹æ‰€ä»¥ä½¿ç”¨Consulæ˜¯å› ä¸ºå®ƒæ‹¥æœ‰çš„ç‰¹æ€§ä»¥åŠå®ƒè¶³å¤Ÿç®€å•ã€‚ æ¯”å¦‚ï¼š</p>

<p>Etcd
å¦‚æœä½ æƒ³ä½¿ç”¨etcdé‚£ä½ åªéœ€è¦å¼•ç”¨etcdåŒ…ï¼Œç„¶ååœ¨å¯åŠ¨çš„æ³¨å†Œæ–¹å¼ä¸Šæ ‡æ˜ä½¿ç”¨çš„æ˜¯etcdå°±è¡Œäº†ã€‚</p>

<p>import (
        _ â€œgithub.com/micro/go-plugins/registry/etcdâ€
)</p>

<p>service â€“registry=etcd â€“registry_address=127.0.0.1:2379</p>

<p>é›¶ä¾èµ–
microä¸“é—¨ä¸ºé›¶ä¾èµ–é…ç½®å†…ç½®æœ‰ä¸€ä¸ªå¤šè·¯å¹¿æ’­DNSæœåŠ¡æ³¨å†Œä¸­å¿ƒã€‚</p>

<p>å¦‚æœè¦ä½¿ç”¨ï¼Œåªéœ€è¦åœ¨ç¨‹åºå¯åŠ¨æŒ‡ä»¤ä¸Šä¼ ä¸Šâ€“registry=mdnsæˆ–è€…MICRO_REGISTRY=mdnsã€‚</p>

<p>Microå¯ä»¥åœ¨å“ªäº›ç¯å¢ƒè¿è¡Œ
microå¯¹è¿è¡Œç¯å¢ƒä¸æŒ‘é£Ÿã€‚åªè¦ä½ å–œæ¬¢ï¼Œåœ¨å“ªéƒ½è¡Œï¼Œè£¸æœº, äºšé©¬é€ŠAWSæˆ–è€…Google Cloudï¼Œä¹Ÿå¯ä»¥è¿è¡Œåœ¨ä½ å–œæ¬¢çš„å®¹å™¨ç¼–æ’ç³»ç»Ÿä¸­æ¯”å¦‚ï¼šMesosã€Kubernetesã€‚</p>

<p>å³è¾¹çš„è¿™ä¸ªé“¾æ¥ä¸­æœ‰å…³äºå¦‚ä½•ä½¿ç”¨K8sæ¥å¼€å‘microæœåŠ¡çš„micro kubernetes demo</p>

<p>Microæ”¯æŒgRPCå—
æ”¯æŒã€‚è¿™å„¿æœ‰å‡ ä¸ªæ’ä»¶ï¼štransportã€clientã€serverã€‚</p>

<p>å¯ä»¥æŸ¥çœ‹micro/go-plugins.</p>

<p>æˆ‘ä»¬ä¹Ÿæä¾›äº†golangç‰ˆæœ¬çš„gRPCå¿«é€Ÿä¸Šæ‰‹demoï¼šmicro/go-grpc.</p>

<p>Microä¸Go-Kitæ¯”è¾ƒ
è¿™ä¸ªé—®é¢˜ç»å¸¸å‡ºç°ï¼Œé‚£äºŒè€…çš„åŒºåˆ«æœ‰å“ªäº›å‘¢ï¼Ÿ</p>

<p>Go-kitå£°ç§°è‡ªå·±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„æ ‡å‡†åº“ã€‚åƒGOä¸€æ ·ï¼Œgo-kitæä¾›ç‹¬ç«‹çš„åŒ…ï¼Œé€šè¿‡è¿™äº›åŒ…ï¼Œå¼€å‘è€…å¯ä»¥ç”¨æ¥ç»„å»ºè‡ªå·±çš„åº”ç”¨ç¨‹åºã€‚Go-kitéå¸¸ä¸é”™ï¼ŒåŸºäºGo-kitï¼Œä½ å¯ä»¥å®Œå…¨æŒæ§ä½ å®šä¹‰çš„æœåŠ¡ã€‚</p>

<p>Go-microåˆ™æ˜¯ä¸€ä¸ªé¢å‘å¾®æœåŠ¡çš„å¯æ’æ‹”RPCæ¡†æ¶ã€‚go-microæ˜¯ä¸€ä¸ªåªåœ¨ç‰¹æ®Šæ–¹å‘ä¸ŠåŠªåŠ›çš„æ¡†æ¶ï¼Œå®ƒå°è¯•ç®€åŒ–åˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´çš„é€šä¿¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥èŠ±æ›´å¤šçš„æ—¶é—´åœ¨æˆ‘ä»¬éœ€è¦å…³æ³¨çš„ä¸šåŠ¡é€»è¾‘ä¸Šã€‚å¯¹äºæƒ³å¿«é€Ÿå¯åŠ¨ï¼ŒæŠŠç¨‹åºè·‘èµ·æ¥ï¼ŒåŒæ—¶ç”¨æ‹¥æœ‰ä¸€äº›å¯æ’æ‹”çš„èƒ½åŠ›ä»åŸºç¡€æ¶æ„ä¸­æ–­å¼€çš„èƒ½åŠ›ï¼Œè€Œä¸ç”¨ä¿®æ”¹ä»£ç ï¼Œé‚£ä¹ˆgo-microä¹Ÿå¾ˆä¸é”™ã€‚</p>

<p>Microä½œä¸ºä¸€ä¸ªå¾®æœåŠ¡å·¥å…·åº“ï¼Œå¥½æ¯”ä¸€æŠŠç‘å£«å†›åˆ€ï¼Œåœ¨æˆ‘ä»¬æ„å»ºå¾®æœåŠ¡æ—¶ï¼Œå¯ä»¥æä¾›ä¼ ç»Ÿçš„æ¥å…¥ç‚¹ï¼Œæ¯”å¦‚http api gatewayï¼Œweb uiï¼Œcliï¼Œslack botç­‰ç­‰ã€‚Microä½¿ç”¨å·¥å…·æ¥å¼•å¯¼æ¶æ„å…³æ³¨ç‚¹ä¹‹é—´é€»è¾‘ä¸Šçš„éš”ç¦»ï¼Œæ¨åŠ¨å¼€å‘è€…åˆ›å»ºAPIå±‚çš„æœåŠ¡æ¥æš´éœ²å¯¹å¤–çš„APIæ¥å£ï¼Œå¹¶ä¸”åˆ›å»ºéš”ç¦»äºå¯¹å¤–APIçš„Webå±‚å¾®æœåŠ¡ã€‚</p>

<p>å¦‚æœæƒ³å…¨ç›˜æŒæ§ï¼Œé‚£ä¹ˆä½¿ç”¨go-kitï¼›ä½†æ˜¯å¦‚æœæƒ³å¼„ä¸€ä¸ªæœ‰æƒ³æ³•æ¡†æ¶ï¼Œä½¿ç”¨go-microã€‚</p>

<p>https://micro.mu/docs/users.html</p>

<p>https://github.com/micro/examples/tree/master/greeter</p>

<p>https://github.com/asim/kubernetes</p>

<p>Go kit æ˜¯ä¸€ç³»åˆ—ç”± Go çš„åŒ…ç»„æˆçš„å·¥å…·é›†ï¼Œå¹¶ä¸”æ˜¯ç”Ÿäº§çº§åˆ«çš„ï¼Œå®Œå…¨é€‚åº”äºä»»ä½•å…¬å¸ä¸ç»„ç»‡çš„ä¸šåŠ¡ã€‚</p>

<p>æ¶æ„ï¼šä¸‰ä¸ªå±‚æ¬¡
Transport layerï¼šé€šä¿¡å±‚ï¼Œè¿™é‡Œå¯ä»¥ç”¨å„ç§ä¸åŒçš„é€šä¿¡æ–¹å¼ï¼Œå¦‚ HTTP REST æ¥å£æˆ–è€… gRPC æ¥å£ï¼ˆè¿™æ˜¯ä¸ªå¾ˆå¤§çš„ä¼˜ç‚¹ï¼Œæ–¹ä¾¿åˆ‡æ¢æˆä»»ä½•é€šä¿¡åè®®ï¼‰ï¼›
Endpoint layerï¼šç»ˆç«¯å±‚ï¼Œç±»ä¼¼äº Controllerï¼Œé‡Œé¢ä¸»è¦å®ç°å„ç§æ¥å£çš„ handlerï¼Œè´Ÿè´£ reqï¼resp æ ¼å¼çš„è½¬æ¢ï¼ˆåŒæ—¶ä¹Ÿæ˜¯è¢«åæ§½ç¹æ‚çš„åŸå› æ‰€åœ¨ï¼‰ï¼›
Service layerï¼šæœåŠ¡å±‚ï¼Œä¹Ÿå°±æ˜¯å®ç°ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼›
ä»ä¸‹é¢çš„æ¶æ„å›¾æ¥çœ‹ï¼Œå®ƒå…¶å®å¾ˆç®€å•æ˜äº†ã€‚å…¶ä¸­å¯ä»¥æ³¨æ„ä¸‹ä¸­é—´ä»¶ï¼šç±»ä¼¼äºå¸¸è§æ¡†æ¶ä¸­çš„ä¸­é—´ä»¶æ¨¡å¼ï¼Œé€šå¸¸ç”¨æ¥è®°å½•æ—¥å¿—ã€é™åˆ¶é¢‘ç‡ã€è´Ÿè½½å‡è¡¡ä»¥åŠåˆ†å¸ƒå¼è¿½è¸ªç­‰ç­‰ï¼Œä¸»è¦åœ¨ Endpoint ä»¥åŠ Service ä¸­å®ç°ã€‚</p>

<p>å„ä¸ªæ¨¡å—ä¹‹é—´åº”è¯¥æ˜¯ ä½è€¦åˆï¼Œé«˜å†…èšï¼Œäºæ˜¯ï¼ŒGo kit é¼“åŠ±ä½ åœ¨ main å‡½æ•°é‡Œé¢å®ç°æ‰€æœ‰çš„ç»„è£…ï¼Œæ‰€æœ‰çš„æ¨¡å—çš„ä¾èµ–éƒ½éœ€è¦é€šè¿‡å‚æ•°ä¼ å…¥å…¶å®ƒæ¨¡å—ï¼Œå‡å°‘ç”šè‡³æ¶ˆç­æ‰€æœ‰å…¨å±€çŠ¶æ€ï¼Œä»æ ¹æœ¬ä¸Šé¿å…æŠ€æœ¯å€ºåŠ¡ã€‚</p>

<p>åŒæ—¶è¿˜æœ‰ä¸ªå¾ˆå¤§çš„å¥½å¤„ï¼šä¾¿äºæµ‹è¯•ï¼Œåªè¦ mock ä¼ å…¥çš„ä¾èµ–å‚æ•°å³å¯ã€‚</p>

<p>Eyal Posener è¿™ä½è€å“¥åœ¨ä»–çš„åšå®¢ ä¸ºä»€ä¹ˆæˆ‘å»ºè®®ä¸è¦ä½¿ç”¨ go-kit ä¸­å†™åˆ°ä¸‰ç‚¹åŸå› ï¼š</p>

<p>æ¡†æ¶å¤ªç¹çï¼Œæ¯ä¸ªæ¥å£çš„ä»£ç å¤ªå¤šï¼Œå¤ªå•°å—¦ï¼›
éš¾ç†è§£ï¼Œä¸»è¦ä½“ç°åœ¨ Go kit çš„ä¸‰å±‚æ¨¡å‹ï¼›
interface{} API å¤ªè›‹ç–¼ï¼Œåœ¨ Endpoint å±‚ï¼Œæ¯ä¸ª endpoint éƒ½éœ€è¦é‡å¤ç±»ä¼¼çš„è½¬æ¢ä»£ç ï¼›</p>
:ET