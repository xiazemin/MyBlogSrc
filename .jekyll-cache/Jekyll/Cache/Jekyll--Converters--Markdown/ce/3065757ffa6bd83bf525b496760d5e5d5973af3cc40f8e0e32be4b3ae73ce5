I"B<p>https://tonybai.com/2019/10/12/uber-go-style-guide/</p>

<p>https://eng.uber.com/</p>

<p>https://github.com/uber-go/guide</p>

<p>https://golang.org/doc/effective_go.html</p>

<p>https://github.com/golang/go/wiki/CodeReviewComments</p>

<p>https://learnku.com/go/wikis/38426</p>

<p>https://github.com/xxjwxc/uber_go_guide_cn
<!-- more -->
é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„
é›¶å€¼ sync.Mutex å’Œ sync.RWMutex æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æŒ‡å‘ mutex çš„æŒ‡é’ˆåŸºæœ¬æ˜¯ä¸å¿…è¦çš„ã€‚</p>

<p>Bad	
mu := new(sync.Mutex)
mu.Lock()</p>

<p>Good
var mu sync.Mutex
mu.Lock()
å¦‚æœä½ ä½¿ç”¨ç»“æ„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æ„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æ¥åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚ å¦‚æœæ˜¯ç§æœ‰ç»“æ„ä½“ç±»å‹æˆ–æ˜¯è¦å®ç° Mutex æ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•</p>

<p>ä¼ªä»£ç å£°æ˜:è¯·æ— è§†ä¸€äº›æ‹¼å†™é”™è¯¯
mutexå®ä¾‹æ— éœ€å®ä¾‹åŒ–ï¼Œå£°æ˜å³å¯ä½¿ç”¨
func add(){
    var mutex sync.Mutex
    mutex.Lock()
    defer mutex.Unlock()
    fmtPrintln(â€œtest lockâ€)
}</p>

<p>mutexåœ¨ä¼ é€’ç»™å¤–éƒ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œéœ€è¦ä¼ æŒ‡é’ˆ,ä¸ç„¶ä¼ çš„æ˜¯æ‹·è´ï¼Œä¼šå¼•èµ·é”å¤±è´¥ã€‚å¹¶ä¸”æŒ‡é’ˆçš„mutexæ˜¯ä¸€å®šè¦å®ä¾‹åŒ–è¿‡çš„ã€‚
func add() *sync.Mutex{
    var m = &amp;sync.Mutex{}
    return m
}</p>

<p>å¯¹åŒä¸€ä¸ªé”ï¼Œè¿›è¡Œå¤šæ¬¡é”ï¼Œä¼šæ­»é”
func a(){
    var mutex sync.Mutex
    mutex.Lock()
    mutex.Lock() // dead lock
}</p>

<p>å¯¹ä¸€ä¸ªRWLockè¿›è¡ŒåŒæ—¶Lock()å’ŒRLock()ä¼šæ­»é”.
func a(){
    var mutex sync.RWMutex
    mutex.RLock()
    mutex.Lock() // dead lock
}</p>

<p>è¿™æ„å‘³ç€å¦‚æœä¸€ä¸ªæ“ä½œå‡½æ•°é‡ŒåŒæ—¶åŒ…å«å†™å’Œè¯»ï¼Œåƒä¸‡ä¸è¦è¿™ä¹ˆå†™</p>

<p>type Object struct{
    Data []interface{}
    L  sync.RWMutex
}
func WR(o Object){
    o.L.Lock()
    defer o.L.UnLock()
    o.Data = append(o.Data, 1)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>o.L.RLock()
defer o.L.RUnLock()
fmt.Println(o.Data[len(o.Data)-1]) }
</code></pre></div></div>

<p>å› ä¸ºdeferæ˜¯åœ¨returnå‰æ‰§è¡Œï¼Œè¯¥æ®µé€»è¾‘çš„é”é¡ºåºå®é™…ä¸Šæ˜¯ Lock(), RLock(), UnLock(),RUnLock() æ­»é”äº†
å¯ä»¥æ”¹æˆ:</p>

<p>func WR(o Object){
    func(){
        o.L.Lock()
        defer o.L.UnLock()
        o.Data = append(o.Data, 1)
    }()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func(){
    o.L.RLock()
    defer o.L.RUnLock()
    fmt.Println(o.Data[len(o.Data)-1])
}() }
</code></pre></div></div>

<p>æŠ›å¼€ä¸šåŠ¡æ¥ç†è§£è¯»å†™é”ï¼Œå®ƒçš„æœ¬è´¨æ˜¯:
Lock()æ—¶ï¼Œä¼šé˜»å¡å¦ä¸€ä¸ªåç¨‹Rlock()å’ŒLock()
Rlockæ—¶ï¼Œä¸ä¼šé˜»å¡å¦ä¸€ä¸ªåç¨‹Lock()å’ŒRlock()
è¯»çš„æ—¶å€™åŠ è¯»é”ï¼Œå†™çš„æ—¶å€™åŠ å†™é”ï¼Œåªæ˜¯æ°å¥½æ»¡è¶³äº†æˆ‘ä»¬å¤§å¤šæ•°åœºæ™¯çš„éœ€æ±‚ï¼Œå¦‚æœè¦çœŸæ­£ç†è§£é”ï¼Œå¯ä»¥é—®é—®è‡ªå·±ä¸‹é¢ä¸¤ä¸ªé—®é¢˜:</p>

<p>â‘ .å‡å®šæœ‰ä¸€ä¸ªdataï¼Œæ€ä¹ˆåšåˆ°ï¼Œè®©ä»–åœ¨è¯»æ—¶ï¼Œä¸è®©å†™ï¼Œå†™æ—¶è®©è¯»?</p>

<p>å¾ˆç®€å•è¯»å–çš„æ—¶å€™åŠ å†™é”ï¼Œå†™çš„æ—¶å€™åŠ è¯»é”ã€‚</p>

<p>// å› ä¸ºè¯»å–å‡½æ•°çš„Lockä¼šä½¿å¾—Rlocké˜»å¡ï¼Œæ‰€ä»¥å°±åšåˆ°äº†ï¼Œè¯»å–çš„æ—¶å€™ä¸è®©å†™ï¼Œå†™çš„æ—¶å€™æ—¶è¯»é”ï¼Œä¸å½±å“readDataçš„è°ƒç”¨ã€‚
var m sync.Mutex
var data = 5
func readData() int {
    m.Lock()
    defer m.Unlock()
    return data
}</p>

<p>func writeData() {
   m.Rlock()
   defer m.RUnlock()
   data =6
}</p>

<p>â‘¡æ€ä¹ˆåšåˆ°å†™çš„æ—¶å€™ä¸è®©è¯»ï¼Œè¯»çš„æ—¶å€™ä¹Ÿä¸è®©å†™
ç­”æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œè¯»å†™æ—¶éƒ½åŠ å†™é”ã€‚</p>

<p>å…³äºä¸åŒé”äº¤å‰
ä¸åŒçš„é”äº¤å‰ï¼Œæ˜¯å…è®¸çš„ï¼Œä½†æ˜¯è¦æ·±å…¥ç†è§£äº†é”çš„å¦ä¸€ä¸ªåŸåˆ™ï¼Œæ‰èƒ½ç”¨çš„å®‰å…¨ã€‚
å‡è®¾ï¼Œæœ‰data1ï¼Œdata2ï¼Œdata3ï¼Œä»–ä»¬å¯¹åº”æœ‰l1,l2, l3 ä¸‰ä¸ªè¯»å†™é”ã€‚
å¦‚æœï¼Œä½ æƒ³è¦åœ¨æ“ä½œä¸€ä¸ªå˜é‡æ—¶ï¼Œé˜»å¡æ‰ä»–ä»¬ä¸‰ä¸ªçš„è¯»å†™ï¼Œä½ å¯èƒ½ä¼šå°è£…ä¸€ä¸ªè¿™æ ·çš„å‡½æ•°:
var l1,l2,l3 sync.RWMutex
var data1,data2,data3 int
var count int</p>

<p>func Glock() {
    l1.Lock()
    l2.Lock()
    l3.Lock()
}</p>

<p>func GUnlock() {
    l1.Unlock()
    l2.Unlock()
    l3.Unlcok()
}
func CountIncr() {
   Glock()
   count ++
   Gunlock 
}</p>

<p>å¥½äº†ï¼Œä½ æƒ³äº†æƒ³ï¼ŒGlockæ—¶ï¼Œç¡®å®æŠŠdata1,data2,data3çš„è¯»å†™æ“ä½œéƒ½é”ä½äº†ï¼Œä½ ä»¥ä¸ºæ²¡é—®é¢˜å¯ä»¥äº¤å·äº†ï¼Œé‚£å°±å¤§é”™ç‰¹é”™äº†ã€‚</p>

<p>å•çº¯è¿™ä¸€éƒ¨åˆ†ä»£ç ç¡®å®ä¸ä¼šæ­»é”ï¼Œé‚£ä¹ˆï¼Œæˆ‘å†æä¸‹ä¸€ä¸ªéœ€æ±‚ï¼Œä½ å†æ“ä½œä¸€ä¸‹è¯•è¯•ã€‚</p>

<p>ç°åœ¨ï¼Œéœ€è¦å°†data1çš„å€¼ï¼Œèµ‹äºˆç»™data3,ä½ ç†æ‰€åº”å½“åœ°å†™é“</p>

<p>func F() {
   var tmp int
   l3.lock()
   l1.RLock()
   data3 = data1
   l1.RUnlock()
   l3.Unlock()
}</p>

<p>å¥½äº†ï¼Œä½ æƒ³äº†æƒ³ï¼Œè¯»å–data1çš„å€¼ï¼Œèµ‹äºˆdata3ï¼Œæ‰€ä»¥è¯»é”l1ï¼Œå†™é”l3ï¼Œå®Œç¾ã€‚</p>

<p>æ­»é”äº†ï¼</p>

<p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
Glocké‡Œï¼Œl3çš„lockå†l1ä¹‹åï¼Œå°±æ˜¯è¯´ï¼Œå¯èƒ½æœ‰æŸä¸€ä¸ªåç¨‹ï¼Œl1Lock()é€šäº†ï¼Œèµ°åˆ°l3æ—¶ï¼Œç­‰å¾…å¦ä¸€ä¸ªåç¨‹çš„l3 Unlockæ—¶ï¼Œä»–æ‰èƒ½èµ°å¾—é€šl3.Lock()ï¼Œä¹Ÿå°±æ˜¯ï¼Œl1åœ¨ç­‰å¾…l3æ”¾é”ï¼Œä»–æ‰èƒ½èµ°åˆ°ä¸‹é¢çš„l1.Unlock()ï¼Œå¦åˆ™å°†æ°¸ä¹…é˜»å¡ï¼Œèµ°ä¸åˆ°l1.Unlock().</p>

<p>è€Œï¼Œä¸‹é¢çš„ä»£ç é‡Œï¼Œl3åœ¨lockä¹‹åï¼Œå¿…é¡»è¦ç­‰l1.Rlock()é€šè¡Œï¼Œæ‰èƒ½èµ°åˆ°åé¢çš„l3.Unlock()ï¼Œåªè¦l1Rlockä¸€ç›´é˜»å¡ï¼Œå°†æ°¸ä¹…é˜»å¡ã€‚å³l3åœ¨ç­‰å¾…l1è§£é”ã€‚</p>

<p>é‚£ä¹ˆå°±å¿…ç„¶ï¼Œæœ‰æ¦‚ç‡ï¼Œèµ°åˆ°ä¸€ä¸ªaåç¨‹é‡Œï¼Œl1åœ¨ç­‰l3ï¼Œbåç¨‹é‡Œl3åœ¨ç­‰l1ã€‚ç»“æœä½ è¯´å‘¢ï¼Œå¿…å°†æ­»é”ã€‚</p>

<p>ç°åœ¨ç†è§£äº†é”æŠŠï¼Œ é‚£ä¹ˆæ€è€ƒä¸€ä¸‹ï¼Œæ€ä¹ˆè§£å†³ä¸Šé¢çš„é—®é¢˜å‘¢ï¼Ÿ</p>

<p>å¾ˆç®€å•ï¼Œæœ€ç¬¨çš„æ–¹æ³•æ˜¯ï¼Œé¿å…é”äº¤å‰ï¼Œå°†ç¬¬äºŒä»½ä»£ç é‡Œçš„äº¤å‰é”ï¼Œåˆ†å¼€ï¼Œå‡è®¾dataéƒ½æ˜¯mapç±»å‹</p>

<p>var tmp = make(map[string]string,0)
l1.RLock()
for k,v:=range data1 {
    tmp[k] = v
}
l1.RUnlock()</p>

<p>l3.Lock()
for k,v:=range tmp {
    data3[k] = v
}
l3.Unlock()</p>

<p>ä½ ç§ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯é¿å…äº†é”äº¤å‰ï¼Œåªè¦ä¸è¿›è¡Œé”äº¤å‰ï¼Œå°±æ°¸è¿œä¸å­˜åœ¨Aç­‰Bçš„åœºæ™¯ã€‚</p>

<p>ä½†ï¼Œä¸ºä»€ä¹ˆè¯´è¿™æ˜¯ä¸€ä¸ªè ¢åŠæ³•å‘¢ï¼Ÿ
å› ä¸ºï¼Œgoé‡Œï¼Œä¸åŒçš„é”å¯¹è±¡æ˜¯å…è®¸äº¤å‰çš„ã€‚ä½ æƒ³æƒ³ï¼Œå¦‚æœæ¯ä¸€æ¬¡è¯»å†™ï¼Œéƒ½éœ€è¦è¿­ä»£ä¸€éï¼Œç”¨ä¸€ä¸ªå¤åˆ¶ä½“æ¥é¿å…äº¤å‰ï¼Œè¿™å¾—å¤šæµªè´¹è¿­ä»£çš„å¤æ‚åº¦å’Œç©ºé—´å•Šã€‚æ¯•ç«Ÿmapæ˜¯ä¸€ä¸ªO(1)çš„ç»“æ„ï¼Œè¢«ä½ ç©æˆäº†O(n)</p>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œgoé‡Œç»å¸¸æŠ¥cricle importï¼Œå¾ªç¯å¼•ç”¨ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯å±‚çº§å…³ç³»ã€‚package A ä½œä¸ºä¸Šå±‚ï¼Œå¯ä»¥importB, Bä½œä¸ºä¸‹å±‚ï¼Œæ°¸è¿œä¸èƒ½importä¸Šå±‚çš„é¢ä¸œè¥¿ã€‚ä¿æŒè§„èŒƒï¼Œå°±èƒ½é¿å…å¾ªç¯å¼•ç”¨ã€‚</p>

<p>åŒç†ï¼Œlockäº¤å‰ä¹Ÿå…è®¸ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦æ°¸è¿œä¿è¯ï¼ŒAç­‰å¾…Bï¼Œè€ŒBä¸èƒ½ç­‰å¾…Aï¼Œå°±ä¸ä¼šæ­»é”äº†
ç¬¬ä¸€æ­¥ï¼š</p>

<p>func Glock() {
    l1.Lock()
	    l2.Lock()
    		l3.Lock()
}</p>

<p>func GUnlock() {
   			l3.Unlcok()
    	l2.Unlock()
    l1.Unlcok()
}</p>

<p>æˆ‘ä»¬çº¦æŸï¼Œl1æ˜¯ä¸Šå±‚é”ï¼Œå…è®¸l1ï¼Œç­‰å¾…l2ï¼Œå’Œl3ï¼ŒåŒæ—¶æ‰€ä»¥æ”¾é”é¡ºåºï¼Œå°±å¿…é¡»å…ˆæ”¾l3,å†æ”¾l2ï¼Œåœ¨æ”¾l1</p>

<p>å…¶æ¬¡ï¼Œåœ¨äº¤å‰é‡Œï¼Œä¹Ÿæ˜¯l1ç­‰l3</p>

<p>func F() {
   var tmp int
   l1.RLock()
	   l3.lock()
		   data3 = data1
	   l3.Unlock()
   l1.RUnlock()</p>

<p>Goä¸­syncåŒ…ä¸‹æœ‰2ç§mutexå®ç°ï¼š</p>

<p>sync.Mutex</p>

<p>sync.RWMutex</p>

<p>Mutexåº•å±‚åŸºäºsync/atomicå®ç°äº† Compare and Swap. ç”±äºè¯¥ç®—æ³•é€»è¾‘åªéœ€è¦ä¸€æ¡æ±‡ç¼–å°±å¯ä»¥å®ç°ï¼Œåœ¨å•æ ¸CPUä¸Šè¿è¡Œæ˜¯å¯ä»¥ä¿è¯åŸå­æ€§çš„ï¼Œä½†å¤š æ ¸CPUä¸Šè¿è¡Œæ—¶ï¼Œéœ€è¦åŠ ä¸ŠLOCKå‰ç¼€æ¥å¯¹æ€»çº¿åŠ é”ï¼Œä»è€Œä¿è¯äº†è¯¥æŒ‡ä»¤çš„åŸå­æ€§ï¼š</p>

<p>// src/sync/atomic/asm_amd64.s#L35
TEXT Â·CompareAndSwapInt32(SB),NOSPLIT,$0-17
    JMP    Â·CompareAndSwapUint32(SB)</p>

<p>TEXT Â·CompareAndSwapUint32(SB),NOSPLIT,$0-17
  // åˆå§‹åŒ–å‚æ•°
    MOVQ    addr+0(FP), BP
    MOVL    old+8(FP), AX
    MOVL    new+12(FP), CX
  // é”æ€»çº¿
    LOCK
  // æ‰§è¡ŒCompare and Exchange
    CMPXCHGL    CX, 0(BP)
  // å¤„ç†è¿”å›å€¼
    SETEQ    swapped+16(FP)
    RET
sync.Mutexå®ç°äº†sync.Lockeræ¥å£ï¼Œä¸»è¦æœ‰Lock()/Unlock()2ä¸ªmethodï¼Œå€¼å¾—æ³¨æ„ çš„æ˜¯ï¼Œä¸èƒ½é‡å¤çš„å¯¹å·²ç»è§£é”çš„mutexè§£é”ï¼Œå¦åˆ™ä¼španic.</p>

<p>sync.Mutexé˜»å¡è¿›ç¨‹çš„æ–¹å¼å…¶å®æ˜¯è®©è¿›ç¨‹ä¸æ–­çš„è½®è¯¢.</p>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯Mutexçš„zero valueæ˜¯ä¸€ä¸ªunlocked mutex:</p>

<p>// A Mutex is a mutual exclusion lock.
// Mutexes can be created as part of other structures;
// the zero value for a Mutex is an unlocked mutex.
//
// A Mutex must not be copied after first use.
åœ¨åŠ é”å’Œè§£é”çš„æ—¶å€™ï¼Œéƒ½ä¼šæ£€æŸ¥æ˜¯å¦enabled raceï¼Œå…è®¸æŠ¢å å¯èƒ½ä¼šé€ æˆä¸å¯é¢„çŸ¥çš„é—®é¢˜ çœ‹èµ·æ¥åªæœ‰åœ¨sync.RWMutexå’Œsync.WaitGroupé‡Œé¢æ‰ä½¿ç”¨äº†race.Enable()ï¼Œç›®å‰ è¿˜ä¸æ¸…æ¥šè¿™ä¸ªä¸œè¥¿çš„ä½œç”¨æ˜¯ä»€ä¹ˆ.</p>

<p>Go1.6ä¸­å¼•å…¥äº†æ›´å¯é çš„ç«äº‰æ£€æµ‹æœºåˆ¶ï¼Œ Introducing the Go Race Detector. åªè¦æ‰§è¡ŒGo Commandçš„æ—¶å€™å¸¦ä¸Š-raceå³å¯ï¼š</p>

<p>ä¾‹ 1 e4_1.go åœ¨æ²¡æœ‰åŠ é”çš„æƒ…å†µä¸‹å­˜åœ¨å¤šä¸ªgoroutineåŒæ—¶è¯»å†™å…¬æœ‰æ•°æ®</p>

<p>go run -race e4_1.go</p>

<p>â€¦
Found 2 data race(s)
å¦å¤–, sync.RWMutexï¼ŒåŒæ ·å®ç°äº†sync.Lockeræ¥å£ï¼Œæä¾›äº†æ›´çµæ´»çš„é”æœºåˆ¶ï¼š</p>

<p>// An RWMutex is a reader/writer mutual exclusion lock.
// The lock can be held by an arbitrary number of readers or a single writer.
// RWMutexes can be created as part of other structures;
// the zero value for a RWMutex is an unlocked mutex.
//
// An RWMutex must not be copied after first use.
//
// If a goroutine holds a RWMutex for reading, it must not expect this or any
// other goroutine to be able to also take the read lock until the first read
// lock is released. In particular, this prohibits recursive read locking.
// This is to ensure that the lock eventually becomes available;
// a blocked Lock call excludes new readers from acquiring the lock.
æœ‰æ„æ€çš„æ˜¯ï¼Œsync.RWMutexä¼šæ£€æµ‹å…¬æœ‰æ•°æ®çš„ä¿®æ”¹ï¼› ä¾‹ 2 e4_2.goä¸­æ¨¡æ‹Ÿäº†2ç»„goroutineï¼Œä¸€ç»„ä¸“é—¨è¯»æ•°æ®ï¼Œä¸€ç»„ä¸“é—¨ å†™æ•°æ®ï¼›å…¶ä¸­è¯»æ•°æ®çš„é€Ÿåº¦éå¸¸å¿«ï¼Œå†™æ•°æ®ä¼šæ¯”è¾ƒæ…¢ï¼ˆåŠ äº†éšæœºå»¶è¿Ÿï¼‰ï¼š</p>

<p>package main</p>

<p>import (
    â€œmath/randâ€
    â€œsyncâ€
    â€œtimeâ€
)</p>

<p>var shared = struct {
    *sync.RWMutex
    count int
}{}</p>

<p>var wg *sync.WaitGroup</p>

<p>const N = 10</p>

<p>func main() {
    rand.Seed(time.Now().Unix())
    shared.RWMutex = new(sync.RWMutex)
    wg = new(sync.WaitGroup)
    wg.Add(2 * N)
    defer wg.Wait()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i := 0; i &lt; N; i++ {
    // write goroutines
    go func(ii int) {
        shared.Lock()
        duration := rand.Intn(5)
        // shared.Lock()
        time.Sleep(time.Duration(duration) * time.Second)
        shared.count++
        println(ii, "write --- shared.count =&gt;", shared.count)
        // shared.Unlock()
        shared.Unlock()

        wg.Done()
    }(i)

    // read goroutines
    go func(ii int) {
        shared.RLock()
        println(ii, "read --- shared.count =&gt;", shared.count)
        shared.RUnlock()

        wg.Done()
    }(i)

} } è¯»å†™é”çš„æ•ˆæœå°±æ˜¯ï¼Œåœ¨å†™é”é”å®šçš„æ—¶å€™ï¼Œä¼šé˜»å¡æ‰€æœ‰çš„è¯»é”ï¼Œ ä¾‹4.2é‡Œé¢è¯»æ“ä½œéå¸¸å¿«ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡å†™æ“ä½œå®Œæˆä¹‹åï¼Œ æ‰€æœ‰çš„è¯»æ“ä½œå°±ä¸€æ¬¡å®Œæˆäº†ï¼Œåé¢çš„å°±åªæœ‰è¯»æ“ä½œäº†
</code></pre></div></div>

<p>ä¾‹ 3 e4_3.go å»æ‰äº†å…¬æœ‰æ•°æ®çš„è¯»å†™æ“ä½œï¼Œ æ¨¡æ‹Ÿäº†ä¾‹4.2é‡Œé¢çš„å»¶è¿Ÿå’Œé”ï¼›æœ¬æ¥ä»¥ä¸ºé”ä¼šæ£€æŸ¥é€»è¾‘é‡Œé¢çš„æ•°æ®ä¿®æ”¹ï¼Œå‘ç°å¹¶ä¸æ˜¯ï¼› çœ‹èµ·æ¥å†™é”å¯¹è¯»é”çš„é˜»å¡æ˜¯å…¨å±€çš„ï¼Œåªè¦ä¸€ä¸ªè¿›ç¨‹å†…çš„å†™é”å°±ä¼šé˜»å¡æ‰€æœ‰çš„è¯»é”ï¼›</p>

<p>ä»åº•å±‚å®ç°ä¸Šæ¥çœ‹ï¼Œä¸Šé¢çš„åˆ¤æ–­åº”è¯¥æ˜¯å‡†ç¡®çš„:</p>

<p>// src/sync/rwmutex.go#L35
// RLock locks rw for reading.
func (rw *RWMutex) RLock() {
    if race.Enabled {
        _ = rw.w.state
        race.Disable()
    }
    if atomic.AddInt32(&amp;rw.readerCount, 1) &lt; 0 {
        // A writer is pending, wait for it.
        runtime_Semacquire(&amp;rw.readerSem)
    }
    if race.Enabled {
        race.Enable()
        race.Acquire(unsafe.Pointer(&amp;rw.readerSem))
    }
}
æ“ä½œç³»ç»Ÿåªå¯¹goroutineå®é™…ä½¿ç”¨çš„ç³»ç»Ÿçº¿ç¨‹åˆ†é…èµ„æºï¼Œè€Œä¸”goroutineå®ç°äº†è¿›ç¨‹ä¸­ ä¸Šçº¿æ–‡åˆ‡æ¢æœºåˆ¶ï¼Œæ¯”æ“ä½œç³»ç»Ÿçº§åˆ‡æ¢ç³»ç»Ÿçº¿ç¨‹ä¸Šä¸‹æ–‡é«˜æ•ˆï¼›å°½ç®¡è¿™æ ·ï¼Œå¹¶å‘è¿‡é«˜çš„æƒ…å†µä¸‹ goroutineä¹‹é—´ä¸Šä¸‹æ–‡åˆ‡æ¢ä¹Ÿä¼šå¯¹ç¨‹åºæ€§èƒ½å¸¦æ¥æ¯”è¾ƒå¤§çš„å½±å“;</p>

<p>https://studygolang.com/topics/2145</p>

<p>https://youtrack.jetbrains.com/issue/GO-5764</p>

<p>https://mozillazg.com/2019/04/notes-about-go-lock-mutex.html</p>

<p>package main</p>

<p>import â€œsyncâ€</p>

<p>type Test struct{</p>

<p>}</p>

<p>func (t*Test)getLock()sync.RWMutex  {
   var mu sync.RWMutex
   return mu
}</p>

<p>func (t<em>Test)getLockPtr()</em>sync.RWMutex  {
	return new(sync.RWMutex)
}</p>

<p>func testMutex(mu sync.RWMutex){
	mu.Lock()
}</p>

<p>func testMutexPtr(mu *sync.RWMutex)  {
	mu.Lock()
}</p>

<p>func main()  {
	var t *Test
	mu1:=t.getLock()
	mu2:=t.getLock()
	mu2.Lock()
	mu1.Lock()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mu3:=t.getLockPtr()
mu4:=t.getLockPtr()
mu3.Lock()
mu4.Lock()
//mu3.Lock() /*
mu5:=mu2
mu5.Lock()  */ /*
mu6:=mu4
mu6.Lock()  */
//testMutex(mu1)
//testMutexPtr(&amp;mu1) }
</code></pre></div></div>

<p>go vet main.go</p>
<h1 id="command-line-arguments">command-line-arguments</h1>
<p>./main.go:11:11: return copies lock value: sync.RWMutex
./main.go:18:19: testMutex passes lock by value: sync.RWMutex</p>

<p>fatal error: all goroutines are asleep - deadlock!</p>

<p>goroutine 1 [semacquire]:
sync.runtime_SemacquireMutex(0xc00001c0a4, 0x0, 0x1)
        /usr/local/Cellar/go/1.15.3/libexec/src/runtime/sema.go:71 +0x47
sync.(<em>Mutex).lockSlow(0xc00001c0a0)
        /usr/local/Cellar/go/1.15.3/libexec/src/sync/mutex.go:138 +0x105
sync.(</em>Mutex).Lock(â€¦)
        /usr/local/Cellar/go/1.15.3/libexec/src/sync/mutex.go:81</p>

<p>https://blog.lpflpf.cn/passages/golang-noCopy/</p>

<p>åœ¨æˆ‘çš„æŸäº›å°è±¡ä¸­æˆ‘æ›¾ç»è®°å¾—ï¼Œä½¿ç”¨é”ä¸ç”³æ˜ä¸ºæŒ‡é’ˆæ˜¯ä¸€ä¸ªä»£ç è§„èŒƒç±»ä¼¼çš„ä¸œè¥¿
å¤§å¤šæ•°çš„ï¼ˆæˆ‘çœ‹è¿‡çš„ä¸€äº›ï¼‰æºç ä¸­ï¼Œæ²¡æœ‰è§è¿‡å°†é”ç”³æ˜ä¸ºæŒ‡é’ˆçš„ç”¨æ³•
ä½†æ˜¯å½“æ—¶æˆ‘æ²¡æœ‰åŠæ³•å›ç­”è¿™ä¸ª PRï¼Œä½ æ€»ä¸èƒ½è¯´æˆ‘æ˜¯ä¸€å¢æƒ…æ„¿å§â€¦éœ€è¦ä¸€ä¸ªæ›´åŠ åˆç†çš„è§£é‡Š
ä»”ç»†åˆ†æ
ä¸Šç½‘æœç´¢ä¸€ç•ª
https://www.reddit.com/r/golang/comments/6uyf16/confusion_about_mutex_and_reference/</p>

<p>å¾ˆå¤šç±»ä¼¼çš„é—®é¢˜éƒ½åœ¨é—®ï¼ˆä½ ä¸ç”¨ç‚¹å¼€ï¼Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼‰</p>

<p>é—®é¢˜å…³é”®
sync.Mutex è¿™ä¸ªä¸œè¥¿ä¸èƒ½è¢« copyï¼ï¼ˆè¿™ä¸ªæˆ‘ä¹‹å‰ä¹Ÿæ˜¯çŸ¥é“çš„ï¼Œæ¯•ç«Ÿéƒ½åˆ†æè¿‡æºç äº†ï¼‰</p>

<p>åˆ¨æ ¹é—®åº•
è™½ç„¶è¿™ä¸ªé”ä¸èƒ½è¢«æ‹·è´ï¼Œé‚£ä¹ˆå°±åº”è¯¥è¢«ç”³æ˜ä¸ºæŒ‡é’ˆé˜²æ­¢æ‹·è´å‡ºç°é—®é¢˜å—ï¼Ÿ</p>

<p>åˆ«æ…Œï¼Œå…ˆå†™ä¸ªä¾‹å­æµ‹æµ‹çœ‹</p>

<p>package main</p>

<p>import (
	â€œfmtâ€
	â€œsyncâ€
)</p>

<p>type Config1 struct {
	sync.Mutex
	Name string
}</p>

<p>type Config2 struct {
	*sync.Mutex
	Name string
}</p>

<p>func main() {
	c1 := Config1{Name: â€œ1â€}
	cc1 := c1
	fmt.Println(cc1.Name)
	cc1.Lock()
	cc1.Unlock()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c2 := Config2{
	Mutex: &amp;sync.Mutex{},
	Name:  "2",
}
cc2 := c2
fmt.Println(cc2.Name)
cc2.Lock()
cc2.Unlock() } ä¸Šé¢è¿™ä¸ªè·‘èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨æŒ‡é’ˆï¼Œä½ å°±å¿…é¡»å¯¹å®ƒåˆå§‹åŒ–ï¼Œå¦åˆ™ä¼šç©ºæŒ‡é’ˆã€‚
</code></pre></div></div>

<p>çœ‹èµ·æ¥å¥½åƒ copy æ²¡é—®é¢˜å•Šï¼Ÿéš¾é“ï¼Ÿè®©æˆ‘ vet çœ‹çœ‹</p>

<p>æœç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºæœ‰æ‹·è´ã€‚</p>

<p>ä½†æ˜¯ç»“è®ºæˆ‘è®¤ä¸ºæ°æ°ç›¸åï¼ï¼</p>

<p>æˆ‘çš„ç»“è®º
å°±åº”è¯¥ä¸åº”è¯¥ç”³æ˜ä¸ºæŒ‡é’ˆ</p>

<p>åŸå›  1
å‡è®¾ä½ ç”³æ˜ä¸ºäº†æŒ‡é’ˆï¼Œgo vet å°±ä¸ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆå…¶å®ä½ åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä½ å°±ä¼šâ€œå¤åˆ¶â€è¿™ä¸ªé”</p>

<p>åŸå›  2
åœ¨ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨é”å‘¢ï¼Ÿä¸€èˆ¬æ˜¯ä¸æ˜¯æœ‰ä¸€ä¸ªå•ä¾‹å¯¹è±¡è¦æ§åˆ¶ï¼Œè¿™ä¸ªå¯¹è±¡æˆ–è€…æŸä¸ªæ“ä½œè¦æ§åˆ¶å¹¶å‘çš„æ—¶å€™ç”¨å¯¹å§ã€‚</p>

<p>é‚£ä»€ä¹ˆæ—¶å€™ä¼šå¤åˆ¶å¯¹è±¡å‘¢ï¼Ÿé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¸€å®šå°±ä¸æ˜¯ä¸ªå•ä¾‹å¯¹ä¸å¯¹ï¼Ÿï¼ˆæ³¨æ„è¿™é‡Œæ˜¯å¤åˆ¶å¯¹è±¡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæŒ‡é’ˆå¯¹è±¡ä»è€Œå¤åˆ¶æŒ‡é’ˆï¼‰</p>

<p>c2 := Config2{
   Mutex: &amp;sync.Mutex{},
   Name:  â€œ2â€,
}
cc2 := c2
è¿™ä¸ªå†™æ³•å°±å·²ç»å¾ˆå¤æ€ªäº†ï¼Œä½ å¤åˆ¶äº†è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ç”¨äº†åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š</p>

<p>ä½ çš„æƒ³æ³•ç©¶ç«Ÿæ˜¯ cc2 é”çš„æ—¶å€™ c2 ä¹Ÿè¦è¢«é”ä½ï¼Ÿ=&gt; å¦‚æœæ˜¯è¿™ä¸€ç§ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥å°†é”ç”³æ˜åœ¨å¯¹è±¡å†…éƒ¨ã€‚</p>

<p>è¿˜æ˜¯ cc2 é”çš„æ—¶å€™ c2 ä¸è¦è¢«é”ä½ï¼Ÿ=&gt; å¦‚æœæ˜¯è¿™ä¸€ç§ï¼Œæ—¢ä¸èƒ½å°†é”ç”³æ˜ä¸ºæŒ‡é’ˆï¼Œä¹Ÿèƒ½è¿›è¡Œæ‹·è´ï¼Œè€Œåº”è¯¥é‡æ–°ç”³æ˜ä¸€ä¸ªå¯¹è±¡ï¼Œè¿›è¡Œå¯¹è±¡å…¶ä»–å€¼çš„èµ‹å€¼æ“ä½œã€‚</p>

<p>ç»“è®º
æ‰€ä»¥æˆ‘çš„ç»“è®ºå¾ˆæ˜æ˜¾ï¼Œä¸åº”è¯¥ç”³æ˜ä¸ºæŒ‡é’ˆï¼Œç”³æ˜æŒ‡é’ˆå®¹æ˜“åœ¨ä¸ç»æ„é—´å¯¼è‡´æ„å¤–ã€‚</p>

<p>å¦‚æœæ‹…å¿ƒæ‹·è´é”çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ go vet è¿›è¡Œåˆ†æï¼Œç°åœ¨å¾ˆå¤š go çš„ä»£ç é™æ€åˆ†æå·¥å…·ä¹Ÿéƒ½æä¾›äº†è¿™ä¸ªåŠŸèƒ½çš„ï¼Œå…¶ä»–çš„ä¹Ÿå¯ä»¥ã€‚</p>

<p>https://www.linkinstar.wiki/2020/07/18/golang/basic/mutex-use-point-or-not/</p>

<p>https://www.xiayinchang.top/post/6b348626.html</p>

<p>ç»“è®ºï¼šsync.Mutex ä¸èƒ½copyï¼Œæ‰€ä»¥æœ€å¥½ä¸è¦ç”¨æŒ‡é’ˆï¼Œå› ä¸ºç”¨æŒ‡é’ˆgo vet æ£€æµ‹ä¸å‡ºæ¥</p>

:ET