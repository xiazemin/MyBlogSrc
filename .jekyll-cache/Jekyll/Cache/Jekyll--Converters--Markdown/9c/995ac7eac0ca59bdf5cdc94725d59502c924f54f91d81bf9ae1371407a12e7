I"$<p>https://github.com/c-ares/c-ares
æ˜¯ä¸€ä¸ªCè¯­è¨€å®ç°çš„å¼‚æ­¥è¯·æ±‚DNSçš„å®ç°ã€‚å¾ˆå¤šçŸ¥å è½¯ä»¶(curlã€seastarã€geventã€Nodejsç­‰ç­‰)éƒ½ä½¿ç”¨äº†è¯¥è½¯ä»¶ã€‚</p>

<!-- more -->
<p>ä½¿ç”¨ c-ares
æ—¶é€šå¸¸åªéœ€è¦å¼•ç”¨ ares.h
å¤´æ–‡ä»¶å³å¯ï¼Œè¯¥åº“çš„ç›¸å…³å¤´æ–‡ä»¶éƒ½åŒ…å«åœ¨å†…ã€‚</p>

<p>ä»¥ä¸‹å…ˆä»‹ç»å‡ ä¸ªè¯¥åº“åˆå§‹åŒ–ç›¸å…³çš„å‡½æ•°</p>

<p>init
ares_library_init(ARES_LIB_INIT_ALL)</p>

<p>åœ¨å®ä¾‹åˆå§‹åŒ–æ—¶ï¼Œåº”è¯¥å…ˆè°ƒç”¨è¯¥å‡½æ•°å¯¹è¯¥åº“ç›¸å…³å†…éƒ¨æ¨¡å—(å…¶å®è¯¥åˆå§‹åŒ–å‡½æ•°åªåœ¨win32å¹³å°ä¸Šæœ‰å®é™…åŠ¨ä½œ)ã€‚</p>

<p>ares_library_cleanup()</p>

<p>åœ¨å®ä¾‹é”€æ¯æ—¶è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œååˆå§‹åŒ–ã€‚ä¸ ares_library_init(ARES_LIB_INIT_ALL)
å‘å¯¹åº”ã€‚</p>

<p>ares_library_init_mem</p>

<p>åˆå§‹åŒ–æ—¶æŒ‡å®šè¯¥åº“å†…éƒ¨å†…å­˜åˆ†é…çš„ malloc
/ free
/ realloc
å‡½æ•°(å¦‚ä¸æŒ‡å®šåˆ™é»˜è®¤ä½¿ç”¨glibcæä¾›çš„)ã€‚ ç„¶åè°ƒç”¨ ares_library_init
ã€‚</p>

<p>ares_channel
c-ares
ä»¥ ares_channel
ä½œä¸ºæ•´ä¸ªå¼‚æ­¥è¯·æ±‚çš„ä¸Šä¸‹æ–‡(context)ï¼Œä¸è¯·æ±‚ç›¸å…³çš„å‡½æ•°ç”¨ ares_channel
è´¯ç©¿èµ·æ¥è°ƒç”¨ã€‚å› æ­¤å‘èµ·ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œåº”è¯¥å…ˆåˆå§‹åŒ– ares_channel
ã€‚</p>

<p>ares_channel
éœ€è¦é€šè¿‡ ares_init_options
æˆ–è€… ares_init
è¿›è¡Œåˆå§‹åŒ–ï¼ŒåŒºåˆ«æ˜¯ ares_init
ä½¿ç”¨é»˜è®¤ å‚æ•°ï¼Œ ares_init_options
æ”¯æŒè‡ªå®šä¹‰å‚æ•°ï¼Œè‡ªå®šä¹‰å‚æ•°ä¸º struct ares_options
å’Œ int optmask
ã€‚ optmask
ç”¨äºå†³å®šä½¿ç”¨ struct ares_options
ä¸­çš„é‚£äº›å­—æ®µã€‚ optmask
çš„å®šä¹‰å¯¹ç…§ struct ares_options
ä¸­çš„å­—æ®µå¯¹ç…§ ä¸€çœ‹å°±èƒ½æ˜ç™½ï¼Œå…¶å€¼æœ‰(ä¹Ÿå¯ä»¥å‚çœ‹ æ–‡æ¡£
:</p>

<p>#define ARES_OPT_FLAGS          (1 Â«Â 0)
#define ARES_OPT_TIMEOUT        (1 Â«Â 1)
#define ARES_OPT_TRIES          (1 Â«Â 2)
#define ARES_OPT_NDOTS          (1 Â«Â 3)
#define ARES_OPT_UDP_PORT       (1 Â«Â 4)
#define ARES_OPT_TCP_PORT       (1 Â«Â 5)
#define ARES_OPT_SERVERS        (1 Â«Â 6)
#define ARES_OPT_DOMAINS        (1 Â«Â 7)
#define ARES_OPT_LOOKUPS        (1 Â«Â 8)
#define ARES_OPT_SOCK_STATE_CB  (1 Â«Â 9)
#define ARES_OPT_SORTLIST       (1 Â«Â 10)
#define ARES_OPT_SOCK_SNDBUF    (1 Â«Â 11)
#define ARES_OPT_SOCK_RCVBUF    (1 Â«Â 12)
#define ARES_OPT_TIMEOUTMS      (1 Â«Â 13)
#define ARES_OPT_ROTATE         (1 Â«Â 14)
#define ARES_OPT_EDNSPSZ        (1 Â«Â 15)
#define ARES_OPT_NOROTATE       (1 Â«Â 16)
struct ares_options {
  int flags;   // å‚è§ä¸‹æ®µæè¿°
  int timeout; /* in seconds or milliseconds, depending on options */ // è¯·æ±‚è¶…æ—¶çš„æ—¶é—´ã€é»˜è®¤æ˜¯5s
  int tries;   // é»˜è®¤è·Ÿæ¯ä¸ªnameserveré‡è¯•è¯·æ±‚çš„æ¬¡æ•°
  int ndots;
  unsigned short udp_port; // nameserver udp port
  unsigned short tcp_port; // nameserver tcp port
  int socket_send_buffer_size;
  int socket_receive_buffer_size;
  struct in_addr *servers; // nameserver list
  int nservers;            // servers count
  char **domains;// å¼ºåˆ¶è¿›è¡ŒdnsæŸ¥è¯¢çš„åŸŸï¼Œä¸æŒ‰ç…§hostsã€resolve.confå†…æŒ‡å®š
  int ndomains;  // domains count
  char *lookups; // é»˜è®¤æŸ¥æ‰¾çš„èŒƒå›´ â€˜bâ€™ ä»£è¡¨èµ°DNSæŸ¥è¯¢ã€â€™fâ€™ä»£è¡¨æŸ¥è¯¢<code class="language-plaintext highlighter-rouge">hosts</code>æ–‡ä»¶ï¼Œé»˜è®¤å¯ä»¥å¡«â€™fbâ€™
  ares_sock_state_cb sock_state_cb;  // socket çŠ¶æ€å˜æ›´æ—¶çš„å›è°ƒ
  void *sock_state_cb_data;          // å›è°ƒçš„ç§æœ‰æ•°æ®
  struct apattern *sortlist;
  int nsort;
  int ednspsz;
};
ares_optionsä¸­çš„flagsçš„æœ‰æ•ˆå­—æ®µï¼š</p>

<p>#define ARES_FLAG_USEVC         (1 Â«Â 0) // æ€»æ˜¯ä½¿ç”¨tcpè¿›è¡ŒdnsæŸ¥è¯¢
#define ARES_FLAG_PRIMARY       (1 Â«Â 1)
#define ARES_FLAG_IGNTC         (1 Â«Â 2)
#define ARES_FLAG_NORECURSE     (1 Â«Â 3)
#define ARES_FLAG_STAYOPEN      (1 Â«Â 4)
#define ARES_FLAG_NOSEARCH      (1 Â«Â 5)
#define ARES_FLAG_NOALIASES     (1 Â«Â 6)
#define ARES_FLAG_NOCHECKRESP   (1 Â«Â 7)
#define ARES_FLAG_EDNS          (1 Â«Â 8)
ares_channel
åˆ›å»ºå¹¶åˆå§‹åŒ–åï¼Œå¯ä»¥å¯¹å…¶å†è¿›è¡Œä¸€äº›è®¾ç½®ã€‚å¸¸è§çš„è®¾ç½®å‡½æ•°æœ‰ï¼š</p>

<p>// è®¾ç½®è¯·æ±‚æ—¶çš„æœ¬åœ°ip
void ares_set_local_ip4(ares_channel channel, unsigned int local_ip);
void ares_set_local_ip6(ares_channel channel, const unsigned char* local_ip6);</p>

<p>// è®¾ç½®è¯·æ±‚æ—¶è·Ÿå“ªä¸ªç½‘å¡ç»‘å®šåœ¨ä¸€èµ·ï¼Œå½“æœ‰å¤šä¸ªç½‘å¡éƒ½å¯¹å¤–å¯è¾¾æ—¶ï¼Œå¯ä»¥ç”¨æ­¤å‡½æ•°é€‰å–ç»‘å®šä¸€ä¸ªç½‘å¡
void ares_set_local_dev(ares_channel channel, const char* local_dev_name);</p>

<p>// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“c-ares socketè¢«åˆ›å»ºåï¼Œé…ç½®å®Œæˆä¸€äº›c-aresé»˜è®¤é…ç½®åï¼Œä¼šè§¦å‘è¯¥å›è°ƒã€‚å½“éœ€è¦å†è‡ªå®šä¹‰
// ä¸€äº›è®¾ç½®æ—¶ï¼Œå¯ä»¥åœ¨æ­¤å®ç°ã€‚
void ares_set_socket_configure_callback(ares_channel channel, ares_sock_config_callback callback, void *user_data);</p>

<p>// æ³¨å†Œä¸€ä¸ªå›è°ƒï¼Œå½“c-ares socketè°ƒç”¨connectåï¼Œä¼šè§¦å‘è¯¥å›è°ƒã€‚å¦‚æœéœ€è¦åœ¨åˆ›å»ºè¿æ¥ååšä¸€äº›è‡ªå®šä¹‰è®¾ç½®æ—¶ï¼Œ
// å¯ä»¥åœ¨æ­¤å®ç°ï¼Œä¾‹å¦‚tcpçš„keepaliveç­‰
void ares_set_socket_callback(ares_channel channel, ares_sock_create_callback callback, void *user_data);</p>

<p>// å½“ç”¨æˆ·éœ€è¦hook/hack ç½‘å¡IOæ—¶ï¼Œç”¨æˆ·å¯ä»¥æ³¨å†Œsocketç›¸å…³çš„å›è°ƒã€‚å›è°ƒä¸­çš„å‡ ä¸ªå‡½æ•°åˆ†åˆ«å¯¹åº”
// socketã€closeã€connectã€recvfromã€sendvå‡ ä¸ªç³»ç»Ÿå›è°ƒã€‚å½“ç”¨æˆ·æ³¨å†Œåï¼Œc-aresçš„è·Ÿç½‘ç»œIOæœ‰å…³
// ç³»çš„æ“ä½œä¼šè°ƒç”¨è¯¥å›è°ƒä¸­çš„æ–¹æ³•ï¼Œè€Œä¸ä¼šè°ƒç”¨é»˜è®¤çš„ç³»ç»Ÿè°ƒç”¨äº†ã€‚
struct ares_socket_functions {
   ares_socket_t(<em>asocket)(int, int, int, void *);
   int(</em>aclose)(ares_socket_t, void <em>);
   int(</em>aconnect)(ares_socket_t, const struct sockaddr <em>, socklen_t, void *);
   ssize_t(</em>arecvfrom)(ares_socket_t, void <em>, size_t, int, struct sockaddr *, socklen_t *, void *);
   ssize_t(</em>asendv)(ares_socket_t, const struct iovec *, int, void *);
};</p>

<p>void ares_set_socket_functions(ares_channel channel, const struct ares_socket_functions *funcs, void *user_data);
process
c-ares
æ•´ä¸ªè¯·æ±‚çš„å¼‚æ­¥é€»è¾‘éƒ½å°è£…åœ¨è¯¥åº“å†…éƒ¨ï¼Œä½†æ˜¯å†…éƒ¨å¹¶ä¸é©±åŠ¨è¿™äº›é€»è¾‘è¿è½¬ï¼Œ c-ares
å°†é€»è¾‘é©±åŠ¨æš´éœ²ç»™ç”¨æˆ·è°ƒç”¨ï¼Œ è®©ç”¨æˆ·é©±åŠ¨æ•´ä¸ªé€»è¾‘çš„è¿è½¬ï¼Œæ–¹ä¾¿å°†å…¶åµŒå…¥å„ç§äº‹ä»¶æ¡†æ¶ä¸­å»ã€‚</p>

<p>ç›¸å…³çš„å‡½æ•°æœ‰:</p>

<p>int ares_fds(ares_channel channel, fd_set *read_fds, fd_set *write_fds);</p>

<p>int ares_getsock(ares_channel channel, ares_socket_t *socks, int numsocks);</p>

<p>struct timeval *ares_timeout(ares_channel channel, struct timeval *maxtv, struct timeval *tv);</p>

<p>void ares_process(ares_channel channel, fd_set *read_fds, fd_set *write_fds);</p>

<p>void ares_process_fd(ares_channel channel, ares_socket_t read_fd, ares_socket_t write_fd);
æ•´ä¸ªè¯·æ±‚çš„å¤„ç†è¿‡ç¨‹å°†åœ¨ä¾‹å­ä¸­ç»™å‡ºã€‚</p>

<p>error
å½“å‡½æ•°è¿”å›é”™è¯¯æ—¶ï¼Œå¯ä»¥è°ƒç”¨ const char *ares_strerror(int code)
è·å–é”™è¯¯ç å¯¹åº”çš„é”™è¯¯åŸå› ã€‚</p>

<p>util
c-ares
è¿˜æä¾›ä¸€äº›utilå‡½æ•°ï¼Œé€šå¸¸æ˜¯ä¸€äº›å°è£…ï¼Œæä¾›è·¨å¹³å°çš„èƒ½åŠ›ã€‚è¿™äº›å‡½æ•°ååŒlinuxä¸­glibcæä¾›çš„api å‘½åç›¸ä¼¼ï¼ŒåŠŸèƒ½ä¹Ÿç›¸ä¼¼</p>

<p>const char *ares_inet_ntop(int af, const void *src, char *dst, ares_socklen_t size);
int ares_inet_pton(int af, const char *src, void *dst);</p>
:ET