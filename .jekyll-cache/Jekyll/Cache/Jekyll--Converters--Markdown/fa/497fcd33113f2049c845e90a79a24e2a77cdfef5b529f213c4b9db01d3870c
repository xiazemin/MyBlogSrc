I"	<p>type hchan struct {
    qcount   uint           // total data in the queue å½“å‰é˜Ÿåˆ—ä¸­çš„æ•°æ®çš„ä¸ªæ•°
    dataqsiz uint           // size of the circular queue   channelç¯å½¢é˜Ÿåˆ—çš„å¤§å°
    buf      unsafe.Pointer // points to an array of dataqsiz elements  å­˜æ”¾æ•°æ®çš„ç¯å½¢é˜Ÿåˆ—çš„æŒ‡é’ˆ
    elemsize uint16     // channel ä¸­å­˜æ”¾çš„æ•°æ®ç±»å‹çš„å¤§å°|å³æ¯ä¸ªå…ƒç´ çš„å¤§å°
    closed   uint32     // channel æ˜¯å¦å…³é—­çš„æ ‡ç¤º
    elemtype *_type // element type channelä¸­å­˜æ”¾çš„å…ƒç´ çš„ç±»å‹
    sendx    uint   // send index   å½“å‰å‘é€å…ƒç´ æŒ‡å‘channelç¯å½¢é˜Ÿåˆ—çš„ä¸‹æ ‡æŒ‡é’ˆ
    recvx    uint   // receive index å½“å‰æ¥æ”¶å…ƒç´ æŒ‡å‘channelç¯å½¢é˜Ÿåˆ—çš„ä¸‹æ ‡æŒ‡é’ˆ
    recvq    waitq  // list of recv waiters ç­‰å¾…æ¥æ”¶å…ƒç´ çš„goroutineé˜Ÿåˆ—
    sendq    waitq  // list of send waiters  ç­‰å¾…å‘é€å…ƒç´ çš„goroutineé˜Ÿåˆ—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// lock protects all fields in hchan, as well as several
// fields in sudogs blocked on this channel.
//
// Do not change another G's status while holding this lock
// (in particular, do not ready a G), as this can deadlock
// with stack shrinking.
// ä¿æŒæ­¤é”å®šæ—¶ä¸è¦æ›´æ”¹å¦ä¸€ä¸ªGçš„çŠ¶æ€ï¼ˆç‰¹åˆ«æ˜¯ï¼Œæ²¡æœ‰å‡†å¤‡å¥½Gï¼‰ï¼Œå› ä¸ºè¿™å¯èƒ½ä¼šå› å †æ ˆæ”¶ç¼©è€Œæ­»é”ã€‚
lock mutex } &lt;!-- more --&gt; https://studygolang.com/articles/20714 send/recvçš„ç»†åŒ–æ“ä½œ æ³¨æ„ï¼šç¼“å­˜é“¾è¡¨ä¸­ä»¥ä¸Šæ¯ä¸€æ­¥çš„æ“ä½œï¼Œéƒ½æ˜¯éœ€è¦åŠ é”æ“ä½œçš„ï¼
</code></pre></div></div>

<p>æ¯ä¸€æ­¥çš„æ“ä½œçš„ç»†èŠ‚å¯ä»¥ç»†åŒ–ä¸ºï¼š</p>

<p>ç¬¬ä¸€ï¼ŒåŠ é”
ç¬¬äºŒï¼ŒæŠŠæ•°æ®ä»goroutineä¸­copyåˆ°â€œé˜Ÿåˆ—â€ä¸­(æˆ–è€…ä»é˜Ÿåˆ—ä¸­copyåˆ°goroutineä¸­ï¼‰ã€‚
ç¬¬ä¸‰ï¼Œé‡Šæ”¾é”</p>

<p>channelä¸»è¦æ˜¯ä¸ºäº†å®ç°goçš„å¹¶å‘ç‰¹æ€§ï¼Œç”¨äºå¹¶å‘é€šä¿¡çš„ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸åŒçš„åç¨‹å•å…ƒgoroutineä¹‹é—´åŒæ­¥é€šä¿¡ã€‚</p>

<p>ä¸‹é¢ä¸»è¦ä»ä¸‰ä¸ªæ–¹é¢æ¥è®²è§£ï¼š</p>

<p>make channelï¼Œä¸»è¦ä¹Ÿå°±æ˜¯hchançš„æ•°æ®ç»“æ„åŸå‹ï¼›
å‘é€å’Œæ¥æ”¶æ•°æ®æ—¶ï¼Œgoroutineä¼šæ€ä¹ˆè°ƒåº¦ï¼›
è®¾è®¡æ€è€ƒï¼›
1.1 make channel
æˆ‘ä»¬åˆ›å»ºchannelæ—¶å€™æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å¸¦ç¼“å†²çš„channelä¸€ç§æ˜¯ä¸å¸¦ç¼“å†²çš„channelã€‚åˆ›å»ºæ–¹å¼åˆ†åˆ«å¦‚ä¸‹ï¼š</p>

<p>// buffered
ch := make(chan Task, 3)
// unbuffered
ch := make(chan int)</p>

<p>å½“æˆ‘ä»¬å‘channelé‡Œé¢å†™å…¥æ•°æ®æ—¶å€™ï¼Œä¼šç›´æ¥æŠŠæ•°æ®å­˜å…¥circular queue(send)ã€‚</p>

<p>å½“æˆ‘ä»¬æ–°å»ºchannelçš„æ—¶å€™ï¼Œåº•å±‚åˆ›å»ºçš„hchanæ•°æ®ç»“æ„æ˜¯åœ¨å“ªé‡Œåˆ†é…å†…å­˜çš„å‘¢ï¼Ÿå…¶å®Section2é‡Œé¢æºç åˆ†ææ—¶å€™å·²ç»åšäº†åˆ†æï¼Œhchanæ˜¯åœ¨heapé‡Œé¢åˆ†é…çš„ã€‚</p>

<p>å½“æˆ‘ä»¬ä½¿ç”¨makeå»åˆ›å»ºä¸€ä¸ªchannelçš„æ—¶å€™ï¼Œå®é™…ä¸Šè¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡å‘channelçš„pointerï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸åŒçš„functionä¹‹é—´ç›´æ¥ä¼ é€’channelå¯¹è±¡ï¼Œè€Œä¸ç”¨é€šè¿‡æŒ‡å‘channelçš„æŒ‡é’ˆã€‚</p>

<p>å…ˆè·å–å…¨å±€é”ï¼›
ç„¶åenqueueå…ƒç´ (é€šè¿‡ç§»åŠ¨æ‹·è´çš„æ–¹å¼)ï¼›
é‡Šæ”¾é”</p>

<p>é™¤äº†hchanæ•°æ®ç»“æ„å¤–ï¼Œä¸è¦é€šè¿‡å…±äº«å†…å­˜å»é€šä¿¡ï¼›è€Œæ˜¯é€šè¿‡é€šä¿¡(å¤åˆ¶)å®ç°å…±äº«å†…å­˜ã€‚</p>

<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>G2è°ƒç”¨ t:=&lt;-ch è·å–ä¸€ä¸ªå…ƒç´ ï¼›
ä»channelçš„bufferé‡Œé¢å–å‡ºä¸€ä¸ªå…ƒç´ task1ï¼›
ä»senderç­‰å¾…é˜Ÿåˆ—é‡Œé¢popä¸€ä¸ªsudogï¼›
å°†task4å¤åˆ¶bufferä¸­task1çš„ä½ç½®ï¼Œç„¶åæ›´æ–°bufferçš„sendxå’Œrecvxç´¢å¼•å€¼ï¼›
è¿™æ—¶å€™éœ€è¦å°†G1ç½®ä¸ºRunableçŠ¶æ€ï¼Œè¡¨ç¤ºG1å¯ä»¥æ¢å¤è¿è¡Œ</p>

<p>ä¼šåˆ›å»ºä¸€ä¸ªsudogï¼Œå°†ä»£è¡¨G2çš„sudogå­˜å…¥recvqç­‰å¾…é˜Ÿåˆ—ã€‚ç„¶åG2ä¼šè°ƒç”¨goparkå‡½æ•°è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œè®©å‡ºOS threadï¼Œç„¶åG2è¿›å…¥é˜»å¡æ€ã€‚</p>

<p>è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæœ‰ä¸€ä¸ªG1æ‰§è¡Œè¯»å–æ“ä½œï¼Œæœ€ç›´è§‚çš„æµç¨‹å°±æ˜¯ï¼š</p>

<p>å°†recvqä¸­çš„taskå­˜å…¥bufferï¼›
goready(G2) å”¤é†’G2ï¼›
ä½†æ˜¯æˆ‘ä»¬æœ‰æ›´åŠ æ™ºèƒ½çš„æ–¹æ³•ï¼šdirect send; å…¶å®ä¹Ÿå°±æ˜¯G1ç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°G2ä¸­çš„elemä¸­ï¼Œè¿™æ ·å°±ä¸ç”¨èµ°G2ä¸­çš„elemå¤åˆ¶åˆ°bufferä¸­ï¼Œå†ä»bufferå¤åˆ¶ç»™G1ã€‚</p>

<p>https://blog.csdn.net/u010853261/article/details/85231944</p>

<p>channelæ˜¯æ¶ˆæ¯ä¼ é€’çš„æœºåˆ¶ï¼Œç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒä¸‹lock free synchronization.
å®ƒåŒæ—¶å…·å¤‡2ä¸ªç‰¹æ€§ï¼š</p>
<ol>
  <li>æ¶ˆæ¯ä¼ é€’</li>
  <li>åŒæ­¥</li>
</ol>

<p>golangé‡Œçš„channelçš„æ€§èƒ½ï¼Œå¯ä»¥å‚è€ƒå‰ä¸€ç¯‡ï¼šhttp://blog.sina.com.cn/s/blog_630c58cb01016xur.html
æ­¤å¤–ï¼Œè‡ªå¸¦çš„runtime packageé‡Œå·²ç»æä¾›äº†benchmarkä»£ç ï¼Œå¯ä»¥è¿è¡Œä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹å…¶æ€§èƒ½ï¼š
go test -v -test.bench=â€.*â€ runtime</p>

<p>åœ¨æˆ‘çš„pcä¸Šçš„ç»“æœæ˜¯ï¼š
BenchmarkChanUncontended        50000000            67.3 ns/op
BenchmarkChanContended          50000000            67.7 ns/op
BenchmarkChanSync               10000000           181 ns/op
BenchmarkChanProdCons0          10000000           198 ns/op
BenchmarkChanProdCons10         20000000            98.2 ns/op
BenchmarkChanProdCons100        50000000            73.4 ns/op
BenchmarkChanProdConsWork0      1000000          1874 ns/op
BenchmarkChanProdConsWork10     1000000          1805 ns/op
BenchmarkChanProdConsWork100    1000000          1771 ns/op
BenchmarkChanCreation           10000000           195 ns/op
BenchmarkChanSem                50000000            66.3 ns/op</p>

<p>channelçš„å®ç°ï¼Œéƒ½åœ¨$GOROOT/src/pkg/runtime/chan.cé‡Œ</p>

<p>å®ƒæ˜¯é€šè¿‡å…±äº«å†…å­˜å®ç°çš„
struct Hchan {
}</p>

<p>ch := make(chan interface{}, 5)
å…·ä½“çš„å®ç°æ˜¯chan.cé‡Œçš„ Hchan* runtimeÂ·makechan_c(ChanType *t, int64 hint)
æ­¤æ—¶ï¼Œhint=5, t=interface{}</p>

<p>å®ƒå®Œæˆçš„ä»»åŠ¡å°±æ˜¯ï¼š
åˆ†é…hint * sizeof(t) + sizeof(Hchan)çš„å†…å­˜ç©ºé—´ï¼»ä¹Ÿå°±æ˜¯è¯´ï¼Œbuffered chançš„bufferè¶Šå¤§ï¼Œå ç”¨
å†…å­˜è¶Šå¤§ï¼½</p>

<p>ch &lt;- 5
å°±ä¼šè°ƒç”¨ void runtimeÂ·chansend(ChanType *t, Hchan *chan, byte *ep, bool *pres)
    lock(chan)
    å¦‚æœchanæ˜¯buffer chan {
        æ¯”è¾ƒå½“å‰å·²ç»æ”¾å…¥bufferé‡Œçš„æ•°æ®æ˜¯å¦æ»¡äº†A
        å¦‚æœæ²¡æœ‰æ»¡ {
            æŠŠep(è¦æ”¾å…¥åˆ°chané‡Œçš„æ•°æ®)æ‹·è´åˆ°chançš„å†…å­˜åŒºåŸŸ (æ­¤åŒºåŸŸæ˜¯sender/recverå…±äº«çš„)
            æ‰¾åˆ°receiver goroutine, make it ready, and schedule it to recv
        } else {
            å·²ç»æ»¡äº†
            æŠŠå½“å‰goroutineçŠ¶æ€è®¾ç½®ä¸ºGwaiting
            yield
        }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>} else {
    // è¿™æ˜¯blocked chan
    æ‰¾åˆ°receiver goroutine (channelçš„éšå–»å°±æ˜¯ä¸€å®šå­˜åœ¨å¤šä¸ªgoroutine)
    è®©è¯¥goroutineå˜æˆready (ä¹‹å‰æ˜¯Gwaiting), ä»è€Œå‚ä¸scheduleï¼Œè·å¾—æ§åˆ¶æƒ
    å…·ä½“æ‰§è¡Œä»€ä¹ˆï¼Œè¦çœ‹chanrecvçš„å®ç°
}
</code></pre></div></div>

<p>https://www.jianshu.com/p/7c84ae381711
https://segmentfault.com/a/1190000018875154?utm_source=tag-newest</p>

<p>https://www.cnblogs.com/wdliu/p/9272220.html</p>

<p>https://www.jianshu.com/p/24ede9e90490</p>

<p>https://studygolang.com/articles/21586?fr=sidebar
https://studygolang.com/articles/19755
https://www.jianshu.com/p/a118eae8774e
https://www.jianshu.com/p/4d8d3cf04d37</p>
:ET