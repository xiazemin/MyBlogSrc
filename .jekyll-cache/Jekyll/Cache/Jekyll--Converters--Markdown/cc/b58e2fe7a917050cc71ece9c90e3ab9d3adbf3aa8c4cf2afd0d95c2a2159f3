I"›<p>è°ƒç”¨Activateæ–¹æ³•å¯åŠ¨httpmockç¯å¢ƒ
é€šè¿‡httpmock.RegisterResponderæ–¹æ³•è¿›è¡Œmockè§„åˆ™æ³¨å†Œã€‚
è¿™æ—¶å€™å†é€šè¿‡http clientå‘èµ·çš„è¯·æ±‚å°±éƒ½ä¼šè¢«httpmockæ‹¦æˆªï¼Œå¦‚æœåŒ¹é…åˆ°åˆšåˆšæ³¨å†Œçš„è§„åˆ™å°±ä¼šæŒ‰ç…§æ³¨å†Œçš„å†…å®¹è¿”å›å¯¹åº”responseã€‚ â€” è¿™é‡Œæ„Ÿè§‰httpmockæœ‰ä¸€ç‚¹ä¸å¤ªå¥½ç”¨ï¼Œé‚£å°±æ˜¯å¦‚æœè¯·æ±‚æ²¡æœ‰å‘½ä¸­è§„åˆ™å°±ä¼šé”™è¯¯è¿”å›ï¼Œè€Œä¸æ˜¯èµ°çœŸå®è¯·æ±‚ã€‚éœ€è¦æŠŠæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠåˆ°çš„æ‰€æœ‰è¯·æ±‚éƒ½æ³¨å†Œä¸Šå»ã€‚
åœ¨deferé‡Œé¢è°ƒç”¨DeactivateAndResetç»“æŸmock
<!-- more -->
httpmockåŸç†è§£æ
Activateå‡½æ•°ä¸­é€šè¿‡http.DefaultTransport = DefaultTransportä¿®æ”¹äº†æ‰€æœ‰é€šè¿‡http/netåŒ…å‘é€çš„è¯·æ±‚çš„transport
DefaultTransporté€šè¿‡è°ƒç”¨NewMockTransportæ–¹æ³•å®ä¾‹åŒ–äº†ä¸€ä¸ªMockTransportæ¥ä»£æ›¿DefaultTransportã€‚è¿™ä¸ªMockTransportå®ç°äº†httpåŒ…ä¸­çš„RoundTripperæ¥å£ã€‚transportæºç 
å†æ¥çœ‹ä¸€ä¸‹MockTransportçš„ç»“æ„ä½“å’ŒRegisterResponderæ³¨å†Œå‡½æ•°ï¼š</p>

<p>type MockTransport struct {
    mu               sync.RWMutex
    responders       map[internal.RouteKey]Responder
    regexpResponders []regexpResponder
    noResponder      Responder
    callCountInfo    map[internal.RouteKey]int
    totalCallCount   int
}</p>

<p>func (m *MockTransport) RegisterResponder(method, url string, responder Responder) {
    if isRegexpURL(url) {
        m.registerRegexpResponder(regexpResponder{
            origRx:    url,
            method:    method,
            rx:        regexp.MustCompile(url[2:]),
            responder: responder,
        })
        return
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>key := internal.RouteKey{
    Method: method,
    URL:    url,
}

m.mu.Lock()
m.responders[key] = responder
m.callCountInfo[key] = 0
m.mu.Unlock() }
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯åœ¨MockTransportä¸­ç»´æŠ¤ä¸€ç»„map</p>

<p>keyæ˜¯æ­£åˆ™åŒ¹é…çš„è·¯ç”±
valueæ˜¯åˆ™æ˜¯type Responder func(http.Request) (http.Response, error)
ç„¶åRegisterResponderçš„æ—¶å€™å°±æ˜¯å¾€è¿™ä¸ªmapé‡Œé¢å¡å†…å®¹</p>

<p>https://www.jianshu.com/p/545963b593de</p>

<p>https://github.com/jarcoal/httpmock
https://zhuanlan.zhihu.com/p/320135253</p>
:ET