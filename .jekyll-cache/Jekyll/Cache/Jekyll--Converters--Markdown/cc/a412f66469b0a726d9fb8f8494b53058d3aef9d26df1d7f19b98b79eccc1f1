I"<p>deferã€€ã€€</p>

<p>ã€€ã€€deferæ˜¯goæä¾›çš„ä¸€ç§èµ„æºå¤„ç†çš„æ–¹å¼ã€‚deferçš„ç”¨æ³•éµå¾ª3ä¸ªåŸåˆ™</p>

<p>åœ¨deferè¡¨è¾¾å¼è¢«è¿ç®—çš„åŒæ—¶ï¼Œdeferå‡½æ•°çš„å‚æ•°ä¹Ÿä¼šè¢«è¿ç®—ã€‚å¦‚ä¸‹deferçš„è¡¨è¾¾å¼printlnè¿ç®—çš„åŒæ—¶ï¼Œå…¶å…¥å‚iä¹Ÿä¼šè¢«è¿ç®—ï¼Œç»“æœä¸ºåˆå§‹åŒ–å€¼0ï¼Œæ•…deferè°ƒç”¨ä¸­ä¼šæ‰“å°â€œ0â€
1
2
3
4
5
6
1 func a() {
2     i := 0
3     defer fmt.Println(i)
4     i++
5     return
6 }
deferå‡½æ•°åœ¨ä¸€ä¸ªå‡½æ•°returnä¹‹åéµå¾ªåè¿›å…ˆå‡ºçš„è°ƒç”¨åŸåˆ™ï¼Œå¦‚ä¸‹æ‰“å°ç»“æœä¸º3210
1
2
3
4
5
func b() {
    for i := 0; i &lt; 4; i++ {
        defer fmt.Print(i)
    }
}
deferå‡½æ•°å¯èƒ½ä¼šè¯»å–å¹¶èµ‹å€¼ç»™æ‰€åœ¨å‡½æ•°çš„è¿”å›å€¼ï¼Œå¦‚ä¸‹è¿”å›å€¼ä¸º2
1
2
3
4
func c() (i int) {
    defer func() { i++ }()
    return 1
}
ã€€ã€€</p>

<p>é’ˆå¯¹ä¸Šè¿°çš„ç¬¬ä¸‰ç‚¹æœ‰å¦‚ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>

<p>1
2
3
4
5
6
ä¾‹1ï¼š<br />func f() (result int) {
    defer func() {
        result++
    }()
    return 0
}
1
2
3
4
5
6
7
ä¾‹2ï¼š<br />func f() (r int) {
     t := 5
     defer func() {
       t = t + 5
     }()
     return t
}
1
2
3
4
5
6
ä¾‹3ï¼š<br />func f() (r int) {
    defer func(r int) {
          r = r + 5
    }(r)
    return 1
}
å‡½æ•°è¿”å›çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šå…ˆç»™è¿”å›å€¼èµ‹å€¼ï¼Œç„¶åå†è°ƒç”¨deferè¡¨è¾¾å¼ï¼Œæœ€åæ‰æ˜¯è¿”å›åˆ°è°ƒç”¨å‡½æ•°ä¸­</p>

<p>å…ˆçœ‹ä¾‹1ï¼Œå®ƒå¯ä»¥æ”¹å†™æˆè¿™æ ·ï¼š</p>

<p>1
2
3
4
5
6
7
func f() (result int) {
     result = 0  //returnè¯­å¥ä¸æ˜¯ä¸€æ¡åŸå­è°ƒç”¨ï¼Œreturn xxxå…¶å®æ˜¯èµ‹å€¼ï¼‹retæŒ‡ä»¤
     func() {    //deferè¢«æ’å…¥åˆ°returnä¹‹å‰æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯èµ‹è¿”å›å€¼å’ŒretæŒ‡ä»¤ä¹‹é—´
         result++
     }()
     return
}
æ‰€ä»¥è¿™ä¸ªè¿”å›å€¼æ˜¯1ã€‚</p>

<p>å†çœ‹ä¾‹2ï¼Œå®ƒå¯ä»¥æ”¹å†™æˆè¿™æ ·ï¼š</p>

<p>1
2
3
4
5
6
7
8
func f() (r int) {
     t := 5
     r = t     //èµ‹å€¼æŒ‡ä»¤
     func() {  //deferè¢«æ’å…¥åˆ°èµ‹å€¼ä¸è¿”å›ä¹‹é—´æ‰§è¡Œï¼Œè¿™ä¸ªä¾‹å­ä¸­è¿”å›å€¼ræ²¡è¢«ä¿®æ”¹è¿‡
         t = t + 5
     }
     return    //ç©ºçš„returnæŒ‡ä»¤
}
æ‰€ä»¥è¿™ä¸ªçš„ç»“æœæ˜¯5ã€‚</p>

<p>æœ€åçœ‹ä¾‹3ï¼Œå®ƒæ”¹å†™åå˜æˆï¼š</p>

<p>1
2
3
4
5
6
7
func f() (r int) {
     r = 1         //ç»™è¿”å›å€¼èµ‹å€¼
     func(r int) { //è¿™é‡Œæ”¹çš„ræ˜¯ä¼ å€¼ä¼ è¿›å»çš„rï¼Œä¸ä¼šæ”¹å˜è¦è¿”å›çš„é‚£ä¸ªrå€¼
          r = r + 5
     }(r)
     return        //ç©ºçš„return
}
ã€€ã€€æ‰€ä»¥è¿™ä¸ªä¾‹å­çš„ç»“æœæ˜¯1ã€‚</p>

<p>panicå’Œrecover</p>

<p>panicå’Œrecoverçš„ä½¿ç”¨éœ€è¦éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š</p>

<p>defer éœ€è¦æ”¾åœ¨ panic ä¹‹å‰å®šä¹‰ï¼Œå¦å¤–recoveråªæœ‰åœ¨ defer è°ƒç”¨çš„å‡½æ•°ä¸­æ‰æœ‰æ•ˆã€‚
recoverå¤„ç†å¼‚å¸¸åï¼Œé€»è¾‘å¹¶ä¸ä¼šæ¢å¤åˆ° panic é‚£ä¸ªç‚¹å»ï¼Œå‡½æ•°è·‘åˆ° defer ä¹‹åçš„é‚£ä¸ªç‚¹.
å¤šä¸ª defer ä¼šå½¢æˆ defer æ ˆï¼Œåå®šä¹‰çš„ defer è¯­å¥ä¼šè¢«æœ€å…ˆè°ƒç”¨
ä½¿ç”¨recoveræ•è·ç¨‹åºä¸­çš„é”™è¯¯çš„ç”¨æ³•å¦‚ä¸‹</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
package main</p>

<p>import (
    â€œfmtâ€
    â€œtimeâ€
)</p>

<p>func main() {
    f()
    fmt.Println(â€œendâ€)
}</p>

<p>func f() {
ã€€ã€€defer func() { ã€€ã€€ã€€ã€€ã€€//å¿…é¡»è¦å…ˆå£°æ˜deferï¼Œå¦åˆ™ä¸èƒ½æ•è·åˆ°panicå¼‚å¸¸
ã€€ã€€ã€€ã€€fmt.Println(â€œdefer startâ€)
ã€€ã€€ã€€ã€€if err := recover(); err != nil {
ã€€ã€€ã€€ã€€ã€€ã€€fmt.Println(err) //è¿™é‡Œçš„errå…¶å®å°±æ˜¯panicä¼ å…¥çš„å†…å®¹ï¼Œâ€bugâ€
ã€€ã€€ã€€ã€€}
ã€€ã€€ã€€ã€€fmt.Println(â€œdefer endâ€)
ã€€ã€€}()
ã€€ã€€for {
ã€€ã€€ã€€ã€€fmt.Println(â€œfunc beginâ€)
ã€€ã€€ã€€ã€€a := []string{â€œaâ€, â€œbâ€}
ã€€ã€€ã€€ã€€fmt.Println(a[3]) ã€€ã€€   // è¶Šç•Œè®¿é—®ï¼Œè‚¯å®šå‡ºç°å¼‚å¸¸
ã€€ã€€ã€€ã€€panic(â€œbugâ€)  ã€€ã€€ã€€     // ä¸Šé¢å·²ç»å‡ºç°å¼‚å¸¸äº†,æ‰€ä»¥è‚¯å®šèµ°ä¸åˆ°è¿™é‡Œäº†ã€‚
ã€€ã€€ã€€ã€€fmt.Println(â€œfunc endâ€) // ä¸ä¼šè¿è¡Œçš„.
ã€€ã€€ã€€ã€€time.Sleep(1 * time.Second)
ã€€ã€€}
}
è¾“å‡ºç»“æœå¦‚ä¸‹</p>

<p>1 func begin
2 defer start
3 runtime error: index out of range
4 defer end
5 end
<!-- more --></p>
:ET