I"µ<p>TCMallocçš„å…¨ç§°ä¸ºThread-Caching Mallocï¼Œæ˜¯è°·æ­Œå¼€å‘çš„å¼€æºå·¥å…·google-perftoolsä¸­çš„ä¸€ä¸ªæˆå‘˜ã€‚ä¸æ ‡å‡†çš„glibcåº“çš„Mallocç›¸æ¯”ï¼ŒTCMallocåº“åœ¨å†…å­˜åˆ†é…æ•ˆç‡å’Œé€Ÿåº¦ä¸Šè¦é«˜å¾ˆå¤šï¼Œè¿™åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šæé«˜äº†æœåŠ¡å™¨åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹çš„æ€§èƒ½ï¼Œä»è€Œé™ä½äº†ç³»ç»Ÿçš„è´Ÿè½½ã€‚</p>

<p>1.å®‰è£…libunwindåº“
Â å¯ä»¥ä»http://download.savannah.gnu.org/releases/libunwindä¸‹è½½ç›¸åº”çš„libunwindç‰ˆæœ¬
#wget http://ftp.twaren.net/Unix/NonGNU//libunwind/libunwind-1.1.tar.gz
#tar zxvf libunwind-1.1.tar.gz
#cd libunwind-1.1
#CFLAGS=-fPIC ./configureÂ 
#make CFLAGS=-fPICÂ 
#make CFLAGS=-fPIC install</p>

<p>Â </p>

<p>2.å®‰è£…google-perftools
#wget http://gperftools.googlecode.com/files/gperftools-2.1.tar.gz
#tar zxvf gperftools-2.1.tar.gz
#cd gperftools-2.1</p>
<h1 id="configure">./configureÂ </h1>
<p>#make &amp;&amp; make installÂ 
#echo â€œ/usr/local/libâ€ &gt; /etc/ld.so.conf.d/usr_local_lib.confÂ </p>
<h1 id="ldconfig">ldconfig</h1>

<p>Â </p>

<p>3.ç¼–è¯‘å®‰è£…nginx</p>

<h1 id="wget-httpnginxorgdownloadnginx-142targz">wget http://nginx.org/download/nginx-1.4.2.tar.gz</h1>

<h1 id="tar--zvxf-nginx-142targz">tar -zvxf nginx-1.4.2.tar.gz</h1>

<h1 id="cd-nginx-142">cd ./nginx-1.4.2</h1>

<p>æ³¨æ„éœ€è¦æ·»åŠ â€“with-google_perftools_module</p>

<p>#./configure â€“with-google_perftools_module â€“prefix=/usr/local/nginxÂ </p>

<p>å‚è€ƒï¼šLinuxç¯å¢ƒNginxå®‰è£…ä¸è°ƒè¯•(Nginx+PHP/phpfpm)</p>

<p>#make</p>

<p>#make install</p>

<p>Â </p>

<p>4.ä¿®æ”¹Nginxä¸»é…ç½®æ–‡ä»¶</p>

<p>ä¿®æ”¹nginx.confæ–‡ä»¶ï¼Œåœ¨pidè¿™è¡Œçš„ä¸‹é¢æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
#pidÂ Â Â Â Â Â Â  logs/nginx.pid;Â 
google_perftools_profiles /tmp/tcmalloc;</p>

<p>åŒæ—¶æˆ‘ä»¬è®¾ç½®nginxå¯åŠ¨2ä¸ªå·¥ä½œè¿›ç¨‹</p>

<p>worker_processesÂ  2;
daemon on;
master_processÂ  on;</p>

<p>Â </p>

<p>5.ä¸ºgoogle-perftoolsæ·»åŠ çº¿ç¨‹ç›®å½•</p>

<p>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç›®å½•ï¼Œå°†æ–‡ä»¶æ”¾åœ¨/tmp/tcmallocä¸‹ã€‚</p>

<p>#mkdir /tmp/tcmalloc
#chmod 0777 /tmp/tcmalloc</p>

<p>Â </p>

<p>6.å¯åŠ¨Nginx</p>

<p>#/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</p>

<p>Â </p>

<p>7.éªŒè¯è¿è¡ŒçŠ¶æ€
ä¸ºäº†éªŒè¯google-perftoolså·²ç»æ­£å¸¸åŠ è½½ï¼Œå¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<h1 id="lsof--n--grep-tcmalloc">lsof -n | grep tcmallocÂ </h1>

<p>Â </p>

<p>8.å®‰è£…redis</p>

<p>Rediså¹¶æ²¡æœ‰è‡ªå·±å®ç°å†…å­˜æ± ï¼Œæ²¡æœ‰åœ¨æ ‡å‡†çš„ç³»ç»Ÿå†…å­˜åˆ†é…å™¨ä¸Šå†åŠ ä¸Šè‡ªå·±çš„ä¸œè¥¿ã€‚æ‰€ä»¥ç³»ç»Ÿå†…å­˜åˆ†é…å™¨çš„æ€§èƒ½åŠç¢ç‰‡ç‡ä¼šå¯¹Redisé€ æˆä¸€äº›æ€§èƒ½ä¸Šçš„å½±å“ã€‚</p>

<p>åœ¨Redisçš„ zmalloc.c æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>

<p>/* Explicitly override malloc/free etc when using tcmalloc. */
#if defined(USE_TCMALLOC)
#define malloc(size) tc_malloc(size)
#define calloc(count,size) tc_calloc(count,size)
#define realloc(ptr,size) tc_realloc(ptr,size)
#define free(ptr) tc_free(ptr)
#elif defined(USE_JEMALLOC)
#define malloc(size) je_malloc(size)
#define calloc(count,size) je_calloc(count,size)
#define realloc(ptr,size) je_realloc(ptr,size)
#define free(ptr) je_free(ptr)
#endif</p>

<p>æ³¨æ„ï¼šredis-2.4ä»¥ä¸Šè‡ªå¸¦jemallocï¼Œä½ ä¸éœ€è¦åŠ ä»»ä½•å‚æ•°ï¼Œé€šè¿‡zmalloc.cæºç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRedisåœ¨ç¼–è¯‘æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦ä½¿ç”¨tcmallocï¼Œå¦‚æœæ˜¯ï¼Œä¼šç”¨tcmallocå¯¹åº”çš„å‡½æ•°æ›¿æ¢æ‰æ ‡å‡†çš„libcä¸­çš„å‡½æ•°å®ç°ã€‚å…¶æ¬¡ä¼šåˆ¤æ–­jemallocæ˜¯å¦ä½¿å¾—ï¼Œæœ€åå¦‚æœéƒ½æ²¡æœ‰ä½¿ç”¨æ‰ä¼šç”¨æ ‡å‡†çš„libcä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°ã€‚æ‰€ä»¥ç”¨tcmallocä¼˜åŒ–è¯·è°¨æ…ä½¿ç”¨ï¼Œè¿™ä¸¤ç€åˆ†é…å™¨ç¢ç‰‡ç‡ç›¸å·®ä¸å¤§ï¼Œå»ºè®®ç”¨è‡ªå¸¦jemallocã€‚</p>

<p>å¦‚æœè¦å®‰è£…tcmallocå¯ä»¥è¿™æ ·ï¼š</p>

<p>æ³¨æ„éœ€è¦åˆ é™¤åŸå…ˆçš„redisçš„è§£å‹æ–‡ä»¶ï¼Œä¸ç„¶å®‰è£…æ— æ•ˆï¼</p>

<h1 id="make-use_tcmallocyes">make USE_TCMALLOC=yes</h1>

<h1 id="make-install">make install</h1>

<p>æ£€æµ‹tcmallä¿¡æ¯</p>

<p>ä½¿ç”¨infoå‘½ä»¤æŸ¥çœ‹å†…å­˜ä¿¡æ¯ï¼š
<!-- more -->
rediså†…å­˜ç®¡ç†æ–¹å¼ï¼šæ”¯æŒtcmallocï¼Œjemallocï¼Œmallocä¸‰ç§å†…å­˜åˆ†é…</p>

<p>rediså¹¶æ²¡æœ‰è‡ªå·±å®ç°å†…å­˜æ± ï¼Œæ²¡æœ‰åœ¨æ ‡å‡†çš„ç³»ç»Ÿå†…å­˜åˆ†é…å™¨ä¸Šå†åŠ ä¸Šè‡ªå·±çš„ä¸œè¥¿ã€‚æ‰€ä»¥ç³»ç»Ÿå†…å­˜åˆ†é…å™¨çš„æ€§èƒ½åŠç¢ç‰‡ç‡ä¼šå¯¹redisé€ æˆä¸€äº›æ€§èƒ½ä¸Šçš„å½±å“ã€‚</p>

<p>ä¸€ã€é‚£redisæ˜¯å¦‚ä½•é¿å…å†…å­˜åˆ†é…å™¨çš„æ€§èƒ½å’Œç¢ç‰‡çš„é—®é¢˜çš„å‘¢ï¼Ÿ</p>

<p>åœ¨Redisçš„ zmalloc.c æºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>

<p>48 /* Explicitly override malloc/free etc when using tcmalloc. */
 49 #if defined(USE_TCMALLOC)
 50 #define malloc(size) tc_malloc(size)
 51 #define calloc(count,size) tc_calloc(count,size)
 52 #define realloc(ptr,size) tc_realloc(ptr,size)
 53 #define free(ptr) tc_free(ptr)
 54 #elif defined(USE_JEMALLOC)
 55 #define malloc(size) je_malloc(size)
 56 #define calloc(count,size) je_calloc(count,size)
 57 #define realloc(ptr,size) je_realloc(ptr,size)
 58 #define free(ptr) je_free(ptr)
 59 #endif
    ä»ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRedisåœ¨ç¼–è¯‘æ—¶ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦ä½¿ç”¨tcmallocï¼Œå¦‚æœæ˜¯ï¼Œä¼šç”¨tcmallocå¯¹åº”çš„å‡½æ•°æ›¿æ¢æ‰æ ‡å‡†çš„libcä¸­çš„å‡½æ•°å®ç°ã€‚å…¶æ¬¡ä¼šåˆ¤æ–­jemallocæ˜¯å¦ä½¿å¾—ï¼Œæœ€åå¦‚æœéƒ½æ²¡æœ‰ä½¿ç”¨æ‰ä¼šç”¨æ ‡å‡†çš„libcä¸­çš„å†…å­˜ç®¡ç†å‡½æ•°ã€‚
    è€Œåœ¨æœ€æ–°çš„Redis2.4.4ç‰ˆæœ¬ä¸­ï¼Œjemallocå·²ç»ä½œä¸ºæºç åŒ…çš„ä¸€éƒ¨åˆ†åŒ…å«åœ¨æºç åŒ…ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è¢«ä½¿ç”¨ã€‚è€Œå¦‚æœä½ è¦ä½¿ç”¨tcmallocçš„è¯ï¼Œæ˜¯éœ€è¦è‡ªå·±å®‰è£…çš„ã€‚</p>

<p>äºŒã€å¯¹äºtcmallocï¼Œjemallocå’Œlibcå¯¹åº”çš„ä¸‰ä¸ªå†…å­˜åˆ†é…å™¨ã€‚å…¶æ€§èƒ½å’Œç¢ç‰‡ç‡å¦‚ä½•å‘¢ï¼Ÿ
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•æµ‹è¯•ç»“æœï¼Œä½¿ç”¨Redisè‡ªå¸¦çš„redis-benchmarkå†™å…¥ç­‰é‡æ•°æ®è¿›è¡Œæµ‹è¯•ï¼Œæ•°æ®æ‘˜è‡ªé‡‡ç”¨ä¸åŒåˆ†é…å™¨æ—¶Redis infoä¿¡æ¯ã€‚
æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé‡‡ç”¨tcmallocæ—¶ç¢ç‰‡ç‡æ˜¯æœ€ä½çš„ï¼Œä¸º1.01ï¼Œjemallocä¸º1.02ï¼Œè€Œlibcçš„åˆ†é…å™¨ç¢ç‰‡ç‡ä¸º1.31ï¼Œå¦‚ä¸‹æ‰€æœªï¼š
used_memory:708391440
used_menory_human:675.57M
used_memory_rss:715169792
used_memory_peak:708814040
used_memory_peak_human:675.98M
mem_fragmentation_ratio:1.01
mem_allocator:tcmalloc-1.7 
used_memory:708381168
used_menory_human:675.56M
used_memory_rss:723587072
used_memory_peak:708803768
used_memory_peak_human:675.97M
mem_fragmentation_ratio:1.02
mem_allocator:jemalloc-2.2.1 
used_memory:869000400
used_menory_human:828.74M
used_memory_rss:1136689152
used_memory_peak:868992208
used_memory_peak_human:828.74M
mem_fragmentation_ratio:1.31
mem_allocator:libc 
ä¸Šé¢çš„æµ‹è¯•æ•°æ®éƒ½æ˜¯å°æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´å•æ¡æ•°æ®å¹¶ä¸å¤§ï¼Œä¸‹é¢æˆ‘ä»¬å°è¯•è®¾ç½®benchmarkçš„-då‚æ•°ï¼Œå°†valueå€¼è°ƒæ•´ä¸º1kå¤§å°ï¼Œæµ‹è¯•ç»“æœå‘ç”Ÿäº†ä¸€äº›å˜åŒ–ï¼š
used_memory:830573680
used_memory_human:792.10M
used_memory_rss:849068032
used_memory_peak:831436048
used_memory_peak_human:792.92M
mem_fragmentation_ratio:1.02
mem_allocator:tcmalloc-1.7 
used_memory:915911024
used_memory_human:873.48M
used_memory_rss:927047680
used_memory_peak:916773392
used_memory_peak_human:874.30M
mem_fragmentation_ratio:1.01
mem_allocator:jemalloc-2.2.1 
used_memory:771963304
used_memory_human:736.20M
used_memory_rss:800583680
used_memory_peak:772784056
used_memory_peak_human:736.98M
mem_fragmentation_ratio:1.04
mem_allocator:libc 
å¯ä»¥çœ‹å‡ºï¼Œåœ¨åˆ†é…å¤§å—å†…å­˜å’Œå°å—å†…å­˜ä¸Šï¼Œå‡ ç§åˆ†é…å™¨çš„ç¢ç‰‡ç‡å·®è·è¿˜æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå¤§å®¶åœ¨ä½¿ç”¨Redisçš„æ—¶å€™ï¼Œè¿˜æ˜¯å°½é‡ç”¨è‡ªå·±çœŸå®çš„æ•°æ®å»åšæµ‹è¯•ï¼Œä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±æ•°æ®çš„åˆ†é…å™¨ã€‚</p>

<p>ä¸‰ã€memcachedçš„slabså†…å­˜åˆ†é…å™¨ï¼›</p>

<p>slabså†…å­˜åˆ†é…å™¨ç®—æ³•é™å®šäº†å•ä¸ªitemæœ€å¤§èƒ½å­˜å‚¨çš„ç©ºé—´æ˜¯1Mï¼›</p>

<p>slabså†…å­˜åˆ†é…å™¨å°†å†…å­˜åˆ†æˆå¤§å°ç›¸ç­‰çš„slabsï¼Œç„¶åæ¯ä¸ªslabè¢«åˆ†æˆå¤§å°ç›¸ç­‰çš„chunkï¼Œä½†æ˜¯ä¸åŒçš„slabä¸­çš„chunkå¤§å°æ˜¯ä¸åŒçš„ã€‚chunkä»ä¸€ä¸ªæœ€å°å€¼æŒ‰ç…§ä¸€ä¸ªå› å­å¢é•¿åˆ°æœ€å¤§å€¼ï¼ˆslabs.c:POWER_BLOCKï¼‰ã€‚slabä¸­chunkçš„å€¼è¶Šå¤§ï¼Œå®ƒå’Œå‰é¢slabä¸­chunkçš„é—´éš™å°±è¶Šå¤§ã€‚</p>

<p>åœ¨å¾€memcachedä¸­æ”¾ä¸€ä¸ªitemæ—¶ï¼Œmemcachedæ‰¾ä¸€ä¸ªå’Œvalueå¤§å°åŒ¹é…è¾ƒå¥½çš„chunkå­˜æ”¾ï¼Œå› ä¸ºå®šé•¿ï¼Œæ‰€ä»¥å†…å­˜ä¼šæœ‰ä¸€å®šçš„æµªè´¹ã€‚</p>

<p>mallocå’Œfreeçš„ç¼ºé™·ï¼š
1ã€é¢‘ç¹è°ƒç”¨mallocï¼Œfreeä¼šé€ æˆå¤§é‡å†…å­˜ç¢ç‰‡ï¼Œæ— æ³•å›æ”¶é‡æ–°åˆ©ç”¨ï¼Œé€ æˆå†…å­˜ä½¿ç”¨ç‡ä½ï¼›
2ã€ä½œä¸ºç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ç³»ç»Ÿå¼€é”€è¿œè¿œå¤§äºä¸€èˆ¬å‡½æ•°ã€‚</p>
:ET