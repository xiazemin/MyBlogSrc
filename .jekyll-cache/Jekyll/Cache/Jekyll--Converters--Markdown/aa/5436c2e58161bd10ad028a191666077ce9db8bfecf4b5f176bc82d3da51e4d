I"üØ<p>Spring Dataä¹‹@DomainEventsæ³¨è§£
èƒŒæ™¯
åœ¨å¯¹ä¸€ä¸ªEntityè¿›è¡Œsaveæ“ä½œæ—¶ï¼Œå¾€å¾€éœ€è¦è§¦å‘åç»­çš„ä¸šåŠ¡æµç¨‹ï¼Œé€šå¸¸é‡‡ç”¨å¦‚ä¸‹åšæ³•</p>

<p>public void saveUser(){
	User user = â€¦
	user = repository.save(user);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>doSomething(user); }
</code></pre></div></div>

<p>public void action(){
	User user = â€¦
	saveUser(user);
	doSomething(user);
}</p>

<p>å…¶ä¸­æœ‰ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œä¾‹å¦‚</p>

<p>doSomethingä¸saveUseråœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œéœ€è¦è€ƒè™‘doSomethingä¸­çš„å¼‚å¸¸å¯¹repository.save(user)çš„å½±å“
doSomethingä¸saveUserä¸åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œé‚£ä¹ˆåœ¨doSomethingä¸­æŸ¥è¯¢useræ—¶å°†æŸ¥è¯¢ä¸åˆ°ï¼Œå› ä¸ºsaveUserçš„äº‹åŠ¡è¿˜æœªæäº¤ã€‚
è¿™ç§æƒ…å†µåˆ™éœ€è¦å°†doSomethingä¸Šç§»åˆ°è°ƒç”¨saveUseråŒçº§çš„åœ°æ–¹è°ƒç”¨è¿™ç§æƒ…å†µåˆ™éœ€è¦å°†doSomethingä¸Šç§»åˆ°è°ƒç”¨saveUseråŒçº§çš„åœ°æ–¹è°ƒç”¨
DomainEvents
è¿‘æ—¥åœ¨Spring Dataçš„å®˜æ–¹æ‰‹å†Œä¸­çœ‹åˆ°@DomainEventsçš„ä»‹ç»ã€‚å®˜æ–¹è§£é‡Šæ˜¯ç”±Repositotyç®¡ç†çš„Entityæ˜¯æºäºèšåˆæ ¹ï¼ˆ aggregate rootsï¼‰çš„ï¼Œåœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡èšåˆæ ¹å‘å‡ºé¢†åŸŸäº‹ä»¶ã€‚åœ¨Spring Dataä¸­å¯ä»¥é€šè¿‡@DomainEventsæ³¨è§£åœ¨èšåˆæ ¹çš„æ–¹æ³•ä¸Šï¼Œä»è€Œå¯ä»¥ç®€å•å¿«æ·çš„å‘å‡ºäº‹ä»¶ã€‚ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹ï¼ŒDomainEventsçš„å…·ä½“ä½¿ç”¨æ•ˆæœã€‚
é¦–å…ˆå®šä¹‰ä¸€ä¸ªæ™®é€šçš„Entity</p>

<p>@Data
@Entity
@Table(name = â€œt_userâ€)
@AllArgsConstructor
@NoArgsConstructor
public class User {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Id
@GeneratedValue(strategy = GenerationType.IDENTITY)
private Long id;

private String firstName;

private String lastName;

private Integer age;

//è¯¥æ–¹æ³•ä¼šåœ¨userRepository.save()è°ƒç”¨æ—¶è¢«è§¦å‘è°ƒç”¨
@DomainEvents
Collection&lt;UserSaveEvent&gt; domainEvents() {
    return Arrays.asList(new UserSaveEvent(this.id));
}
</code></pre></div></div>

<p>}</p>

<p>å…¶ä¸­UserSaveEventçš„å®šä¹‰å¦‚ä¸‹</p>

<p>@Data
@AllArgsConstructor
public class UserSaveEvent {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private Long id;
</code></pre></div></div>

<p>}
1
2
3
4
5
6
7
å†å®šä¹‰ä¸€ä¸ªUserServiceæ¶ˆè´¹å‘å‡ºçš„äº‹ä»¶</p>

<p>@Service
public class UserService {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Autowired
private UserRepository userRepository;

//æ¥å—Userå‘å‡ºçš„ç±»å‹ä¸ºUserSaveEventçš„DomainEventsäº‹ä»¶
@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
public void event(UserSaveEvent event){
    System.out.println(userRepository.getOne(event.getId()));
}
</code></pre></div></div>

<p>}</p>

<p>å…¶ä¸­@TransactionalEventListeneræ³¨è§£çš„phaseæœ‰å¤šä¸ªé€‰é¡¹</p>

<p>BEFORE_COMMIT
AFTER_COMMIT
AFTER_ROLLBACK
AFTER_COMPLETION
çœ‹åå­—å°±çŸ¥é“å®ƒä»¬çš„ä½œç”¨å’ŒåŒºåˆ«äº†ï¼Œå› ä¸ºäº‹ä»¶æ˜¯repository.saveå‘å‡ºçš„ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº†äº‹åŠ¡ã€‚é€šè¿‡phaseçš„ä¸åŒé€‰é¡¹ï¼Œå°±èƒ½é€‰æ‹©æ˜¯åœ¨äº‹åŠ¡æäº¤å‰è·å–äº‹ä»¶ï¼Œè¿˜æ˜¯æäº¤åï¼Œæˆ–è€…æ··æ»šçš„æ—¶å€™ã€‚</p>

<p>è¿è¡Œä¸€ä¸‹å•å…ƒæµ‹è¯•</p>

<p>@Before
public void before(){</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>userRepository.saveAll(Arrays.asList(
        new User(null,"åˆ˜","ä¸€", 20),
        new User(null,"é™ˆ","äºŒ", 20),
        new User(null,"å¼ ","ä¸‰", 20),
        new User(null,"æ","å››", 20),
        new User(null,"ç‹","äº”", 20),
        new User(null,"èµµ","å…­", 20),
        new User(null,"å­™","ä¸ƒ", 20),
        new User(null,"å‘¨","å…«", 20)
)); }
</code></pre></div></div>

<p>æ§åˆ¶å°è¾“å‡º</p>

<p>Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
User(id=1, firstName=åˆ˜, lastName=ä¸€, age=20)
User(id=2, firstName=é™ˆ, lastName=äºŒ, age=20)
User(id=3, firstName=å¼ , lastName=ä¸‰, age=20)
User(id=4, firstName=æ, lastName=å››, age=20)</p>

<p>ä¸Šé¢æ˜¯ä½¿ç”¨çš„phase = TransactionPhase.AFTER_COMMITï¼Œå³äº‹åŠ¡æäº¤åå“åº”äº‹ä»¶ï¼Œæ‰€ä»¥userRepository.getOne(event.getId())èƒ½æŸ¥è¯¢åˆ°userå¯¹è±¡ã€‚å¦‚æœæ”¹æˆTransactionPhase.BEFORE_COMMITå‘¢</p>

<p>@TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
public void event(UserSaveEvent event){
    System.out.println(userRepository.getOne(event.getId()));
}</p>

<p>å…¶å®æ•ˆæœæ˜¯ä¸€æ ·çš„ä¹Ÿèƒ½æŸ¥è¯¢åˆ°userï¼Œéš¾é“BEFORE_COMMITæ²¡èµ·ä½œç”¨ï¼Ÿæ²¡æäº¤äº‹åŠ¡å‰æŒ‰ç†æ˜¯æŸ¥è¯¢ä¸åˆ°çš„æ‰å¯¹ã€‚
å…¶å®æ˜¯å› ä¸ºsessionçš„ç¼“å­˜ï¼Œå› ä¸ºeventæ–¹æ³•å¹¶æ²¡æœ‰æ·»åŠ @Asyncæ³¨è§£å¼‚æ­¥ï¼Œä¹Ÿæ²¡æœ‰@Transactional(value = Transactional.TxType.REQUIRES_NEW)å¼€å¯æ–°äº‹åŠ¡ï¼Œæ‰€ä»¥è¿™æ—¶ä¸å‘é€äº‹ä»¶çš„repository.saveè¿˜åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ã€‚</p>

<p>å¦‚æœç»™eventæ–¹æ³•å¼€å¯æ–°äº‹åŠ¡</p>

<p>@TransactionalEventListener(phase = TransactionPhase.BEFORE_COMMIT)
@Transactional(value = Transactional.TxType.REQUIRES_NEW)
public void event(UserSaveEvent event){
    System.out.println(userRepository.getOne(event.getId()));
}</p>

<p>è¿™æ ·æŸ¥è¯¢å°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæŸ¥ä¸åˆ°äº†</p>

<p>org.springframework.orm.jpa.JpaObjectRetrievalFailureException: Unable to find com.learn.data.entity.User with id 1; nested exception is javax.persistence.EntityNotFoundException: Unable to find com.learn.data.entity.User with id 1
1
å†å°†phaseæ”¹æˆTransactionPhase.AFTER_COMMITè¯•è¯•</p>

<p>@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
@Transactional(value = Transactional.TxType.REQUIRES_NEW)
public void event(UserSaveEvent event){
    System.out.println(userRepository.getOne(event.getId()));
}</p>

<p>æ§åˆ¶è¾“å‡º</p>

<p>Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: insert into t_user (id, age, first_name, last_name) values (null, ?, ?, ?)
Hibernate: select user0<em>.id as id1_0_0</em>, user0<em>.age as age2_0_0</em>, user0<em>.first_name as first_na3_0_0</em>, user0<em>.last_name as last_nam4_0_0</em> from t_user user0_ where user0<em>.id=?
User(id=1, firstName=åˆ˜, lastName=ä¸€, age=20)
Hibernate: select user0</em>.id as id1<em>0_0</em>, user0<em>.age as age2_0_0</em>, user0<em>.first_name as first_na3_0_0</em>, user0<em>.last_name as last_nam4_0_0</em> from t_user user0_ where user0<em>.id=?
User(id=2, firstName=é™ˆ, lastName=äºŒ, age=20)
Hibernate: select user0</em>.id as id1<em>0_0</em>, user0<em>.age as age2_0_0</em>, user0<em>.first_name as first_na3_0_0</em>, user0<em>.last_name as last_nam4_0_0</em> from t_user user0_ where user0<em>.id=?
User(id=3, firstName=å¼ , lastName=ä¸‰, age=20)
Hibernate: select user0</em>.id as id1<em>0_0</em>, user0<em>.age as age2_0_0</em>, user0<em>.first_name as first_na3_0_0</em>, user0<em>.last_name as last_nam4_0_0</em> from t_user user0_ where user0_.id=?
User(id=4, firstName=æ, lastName=å››, age=20)</p>

<p>ç°åœ¨èƒ½æŸ¥è¯¢åˆ°äº†ï¼Œä½†æ§åˆ¶å°é‡Œé¢çš„æŸ¥è¯¢æ‰“å‡ºäº†selectè¯­å¥ï¼Œä¸æ²¡æœ‰æ·»åŠ @Transactionalæ—¶æ˜¯ä¸ä¸€æ ·äº†ï¼Œæ²¡æœ‰@Transactionalæ³¨è§£æ—¶æ˜¯æ²¡æœ‰selectè¯­å¥çš„ï¼Œè¯´æ˜JPAæŸ¥è¯¢çš„æ˜¯seesionç¼“å­˜å¹¶æ²¡æœ‰çœŸæ­£æ‰§è¡ŒæŸ¥è¯¢ã€‚</p>

<p>ç»“æŸ
@DomainEventså’Œ@TransactionalEventListenerçš„ç»„åˆä½¿ç”¨ï¼Œç»™æˆ‘ä»¬å¤„ç†å®ä½“ä¿å­˜åè§¦å‘äº‹ä»¶ã€‚ç‰¹åˆ«æ˜¯å¼‚æ­¥äº‹ä»¶ï¼ˆç»™eventæ–¹æ³•åŠ ä¸Š@Asyncï¼ŒåŒæ—¶å¼€å¯@EnableAsyncï¼‰æ˜¯éå¸¸ç®€ä¾¿çš„ï¼Œå®ƒæ˜¯ä¸€ç§é¢†åŸŸé©±åŠ¨çš„æ€æƒ³ï¼Œè®©ä»£ç æ˜¾å¾—æ›´åŠ çš„å†…èšã€‚
<!-- more -->
https://www.cnblogs.com/daxnet/archive/2012/12/27/2836372.html</p>

<p>åœ¨æœ€è¿‘çš„ä¸€æ¬¡ä»£ç ç­¾å…¥ä¸­ï¼ŒByteart Retailå·²ç»å¯ä»¥æ”¯æŒé¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰çš„å®šä¹‰å’Œå¤„ç†äº†ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è¯¦ç»†ä»‹ç»é¢†åŸŸäº‹ä»¶æœºåˆ¶åœ¨Byteart Retailæ¡ˆä¾‹ä¸­çš„å…·ä½“å®ç°ã€‚</p>

<p>åœ¨è¿›è¡Œé¢†åŸŸå»ºæ¨¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å·²ç»çŸ¥é“ä¿è¯é¢†åŸŸæ¨¡å‹çº¯å‡€åº¦çš„å¿…è¦æ€§ã€‚ç®€è€Œè¨€ä¹‹ï¼Œé¢†åŸŸæ¨¡å‹ä¸­çš„å„ä¸ªå¯¹è±¡éƒ½åº”è¯¥æ˜¯POCOï¼ˆPOJOï¼‰å¯¹è±¡ï¼Œè€Œä¸åº”å‘å…¶æ·»åŠ ä»»ä½•ä¸æŠ€æœ¯æ¶æ„ç›¸å…³çš„å†…å®¹ã€‚Udi Dahanæ›¾ç»è¯´è¿‡ï¼šâ€œThe main assertion being that you do <em>not</em> need to inject anything into your domain entities. Not services. Not repositories. Nothing.â€ã€‚å› æ­¤ï¼Œåœ¨ä¹‹å‰æœ‰æœ‹å‹æå‡ºè¿‡ï¼Œæ˜¯å¦å¯ä»¥åœ¨Domain Modelä¸­è®¿é—®ä»“å‚¨ï¼Ÿç°åœ¨çœ‹æ¥ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚é‚£ä¹ˆDomain Serviceå‘¢ï¼Ÿå½“ç„¶ä¹Ÿä¸è¡Œã€‚é¡ºä¾¿æä¸€ä¸‹ï¼Œåœ¨å½“å‰ç‰ˆæœ¬çš„Byteart Retailä¸­çš„Domain Serviceè®¿é—®äº†ä»“å‚¨ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¤ªåˆç†çš„åšæ³•ï¼Œåœ¨ä¸‹ä¸ªç‰ˆæœ¬ä¸­æˆ‘å°†è¿›è¡Œæ”¹è¿›ã€‚é‚£ä¹ˆï¼Œå¦‚æœåœ¨æŸäº›ä¸šåŠ¡éœ€æ±‚ä¸‹ï¼Œéœ€è¦è®¿é—®è¿™äº›æŠ€æœ¯å±‚é¢çš„ä¸œè¥¿ï¼Œåˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ¯”å¦‚å½“ç³»ç»Ÿç®¡ç†å‘˜å®Œæˆé”€å”®è®¢å•çš„å‘è´§æ“ä½œæ—¶ï¼Œå¸Œæœ›å‘å®¢æˆ·å‘é€ä¸€ä»½ç”µå­é‚®ä»¶ã€‚æ­¤æ—¶å°±è¦ç”¨åˆ°é¢†åŸŸäº‹ä»¶ã€‚</p>

<p>é¢†åŸŸäº‹ä»¶æ˜¯åº”ç”¨ç³»ç»Ÿä¸­ä¼—å¤šäº‹ä»¶çš„ä¸€ç§åˆ†ç±»ã€‚ä¼ä¸šçº§åº”ç”¨ç¨‹åºäº‹ä»¶å¤§è‡´å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šç³»ç»Ÿäº‹ä»¶ã€åº”ç”¨äº‹ä»¶å’Œé¢†åŸŸäº‹ä»¶ã€‚é¢†åŸŸäº‹ä»¶çš„è§¦å‘ç‚¹åœ¨é¢†åŸŸæ¨¡å‹ï¼ˆDomain Modelï¼‰ä¸­ï¼Œæ•…ä»¥æ­¤å¾—åã€‚é€šè¿‡ä½¿ç”¨é¢†åŸŸäº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°é¢†åŸŸæ¨¡å‹å¯¹è±¡çŠ¶æ€çš„å¼‚æ­¥æ›´æ–°ã€å¤–éƒ¨ç³»ç»Ÿæ¥å£çš„å§”æ‰˜è°ƒç”¨ï¼Œä»¥åŠé€šè¿‡äº‹ä»¶æ´¾å‘æœºåˆ¶å®ç°ç³»ç»Ÿé›†æˆã€‚åœ¨è¿›è¡Œå®é™…ä¸šåŠ¡åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåœ¨é€šç”¨è¯­è¨€ä¸­å­˜åœ¨â€œå½“aå‘ç”Ÿæ—¶ï¼Œæˆ‘ä»¬å°±éœ€è¦åšåˆ°bã€‚â€è¿™æ ·çš„æè¿°ï¼Œåˆ™è¡¨æ˜aå¯ä»¥å®šä¹‰æˆä¸€ä¸ªé¢†åŸŸäº‹ä»¶ã€‚é¢†åŸŸäº‹ä»¶çš„å‘½åä¸€èˆ¬ä¹Ÿå°±æ˜¯â€œäº§ç”Ÿäº‹ä»¶çš„å¯¹è±¡åç§°+å®Œæˆçš„åŠ¨ä½œçš„è¿‡å»å¼â€çš„å½¢å¼ï¼Œæ¯”å¦‚ï¼šè®¢å•å·²ç»å‘è´§çš„äº‹ä»¶ï¼ˆOrderDispatchedEventï¼‰ã€è®¢å•å·²è¢«æ”¶è´§å’Œç¡®è®¤çš„äº‹ä»¶ï¼ˆOrderConfirmedEventï¼‰ç­‰ã€‚åœ¨å½“å‰çš„Byteart Retailæ¡ˆä¾‹çš„æºä»£ç ä¸­ï¼Œå°±å¼•å…¥äº†è¿™ä¸¤ç§é¢†åŸŸäº‹ä»¶ã€‚äº‹å®ä¸Šé’ˆå¯¹è¯¥æ¡ˆä¾‹è€Œè¨€ï¼Œè¿˜æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥ä½¿ç”¨é¢†åŸŸäº‹ä»¶ï¼Œæ¯”å¦‚å½“å®¢æˆ·åœ°å€å˜æ›´æ—¶ï¼Œå¯ä»¥é€šè¿‡äº‹ä»¶å¤„ç†å™¨æ¥æ›´æ–°æ‰€æœ‰è¯¥äº‹ä»¶å‘ç”Ÿå‰æ‰€æœ‰æœªå‘è´§è®¢å•çš„å®¢æˆ·æ”¶è´§åœ°å€ç­‰ã€‚å½“ç„¶ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæ¡ˆä¾‹ä»…æ¼”ç¤ºäº†ä¸Šè¿°ä¸¤ç§äº‹ä»¶ã€‚</p>

<p>å¦å¤–ï¼Œé¢†åŸŸäº‹ä»¶æœ¬èº«å…·æœ‰è‡ªæè¿°æ€§ã€‚å®ƒä¸ä»…èƒ½å¤Ÿè¡¨è¿°ç³»ç»Ÿå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œè€Œä¸”è¿˜èƒ½å¤Ÿæè¿°å‘ç”Ÿäº‹ä»¶çš„åŠ¨æœºã€‚ä¾‹å¦‚AddressChangedEventå¯ä»¥è¡ç”Ÿå‡ºä¸¤ä¸ªæ´¾ç”Ÿç±»ï¼šContactMovedEventå’ŒAddressCorrectedEventï¼Œè™½ç„¶è¿™ä¸¤ç§äº‹ä»¶éƒ½ä¼šå¯¼è‡´åœ°å€ä¿¡æ¯çš„å˜æ›´ï¼Œä½†å®ƒä»¬æ‰€è¡¨è¿°çš„åŠ¨æœºæ˜¯ä¸åŒçš„ï¼šå‰è€…ä½“ç°äº†åœ°å€å˜æ›´æ˜¯å› ä¸ºè”ç³»äººçš„åœ°å€å‘ç”Ÿäº†æ”¹å˜ï¼Œè€Œåè€…åˆ™ä½“ç°äº†åœ°å€å˜æ›´æ˜¯å› ä¸ºåœ°å€ä¿¡æ¯åŸæœ¬æ˜¯é”™çš„ï¼Œç°åœ¨è¢«æ›´æ­£è¿‡æ¥äº†ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å¼€å§‹é€æ­¥è®¨è®ºé¢†åŸŸäº‹ä»¶åœ¨Byteart Retailæ¡ˆä¾‹ä¸­çš„å®ç°æ–¹å¼ã€‚</p>

<p>å®šä¹‰ä¸€ä¸ªé¢†åŸŸäº‹ä»¶
é€šå¸¸ï¼Œæˆ‘ä»¬ä¼šä¸ºé¢†åŸŸäº‹ä»¶å®šä¹‰ä¸€ä¸ªæ¥å£ï¼ˆIDomainEventæ¥å£ï¼‰ï¼Œæ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ç±»å‹éƒ½è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªé¢†åŸŸäº‹ä»¶çš„ç±»å‹ã€‚ä¸ºäº†èƒ½å¤Ÿå‘äº‹ä»¶å¤„ç†å™¨ç­‰äº‹ä»¶ç®¡ç†æœºæ„æä¾›å®Œå–„çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ¥å£ä¸­è®¾ç½®ä¸€äº›å±æ€§ï¼Œæ¯”å¦‚äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³ã€äº‹ä»¶æ¥æºä»¥åŠäº‹ä»¶çš„IDå€¼ç­‰ç­‰ï¼Œå½“ç„¶è¿™äº›å†…å®¹éƒ½æ˜¯æ ¹æ®å…·ä½“çš„é¡¹ç›®éœ€æ±‚è€Œå®šçš„ã€‚åœ¨Byteart Retailæ¡ˆä¾‹ä¸­ï¼Œåˆå®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡ç±»ï¼ˆDomainEventç±»ï¼‰ï¼Œè¯¥ç±»å®ç°äº†IDomainEventæ¥å£ï¼ŒåŒæ—¶åœ¨è¿™ä¸ªç±»ä¸­æä¾›äº†ä¸€ä¸ªå¸¦å‚æ„é€ å‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªä»£è¡¨äº‹ä»¶æ¥æºï¼ˆEvent Sourceï¼‰çš„é¢†åŸŸå®ä½“ä½œä¸ºå‚æ•°ï¼Œå› æ­¤ï¼Œåœ¨æ•´ä¸ªByteart Retailä¸­çº¦å®šï¼Œæ‰€æœ‰é¢†åŸŸäº‹ä»¶ç±»å‹éƒ½ç»§æ‰¿äºDomainEventç±»å‹ï¼Œä»¥ä¾¿å¼ºåˆ¶æ¯ä¸ªç±»å‹éƒ½éœ€è¦æä¾›ä¸€ä¸ªç›¸åŒå‚æ•°ç±»å‹çš„å¸¦å‚æ„é€ å‡½æ•°ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œæ¯å½“å¼€å‘äººå‘˜åˆå§‹åŒ–ä¸€ä¸ªé¢†åŸŸäº‹ä»¶ï¼Œéƒ½å¿…é¡»è®¾ç½®å…¶äº§ç”Ÿçš„äº‹ä»¶æ¥æºï¼Œåœ¨å¼€å‘ä¸Šè¾¾æˆäº†ä¸€ç§å¥‘çº¦ï¼Œæœ‰æ•ˆåœ°é™ä½äº†é”™è¯¯çš„äº§ç”Ÿã€‚</p>

<p>æ¯”å¦‚ï¼Œä¸Šæ–‡æ‰€æåˆ°çš„OrderDispatchedEventå®šä¹‰å¦‚ä¸‹ï¼š</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
/// &lt;summary&gt;
/// è¡¨ç¤ºå½“é’ˆå¯¹æŸé”€å”®è®¢å•è¿›è¡Œå‘è´§æ—¶æ‰€äº§ç”Ÿçš„é¢†åŸŸäº‹ä»¶ã€‚
/// &lt;/summary&gt;
public class OrderDispatchedEvent : DomainEvent
{
    #region Ctor
    /// &lt;summary&gt;
    /// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„<c>OrderDispatchedEvent</c>ç±»å‹çš„å®ä¾‹ã€‚
    /// &lt;/summary&gt;
    /// <param name="source" />äº§ç”Ÿé¢†åŸŸäº‹ä»¶çš„äº‹ä»¶æºå¯¹è±¡ã€‚&lt;/param&gt;
    public OrderDispatchedEvent(IEntity source) : base(source) { }
    #endregion</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#region Public Properties
/// &lt;summary&gt;
/// è·å–æˆ–è®¾ç½®è®¢å•å‘è´§çš„æ—¥æœŸã€‚
/// &lt;/summary&gt;
public DateTime DispatchedDate { get; set; }
#endregion } åœ¨è¿™ä¸ªäº‹ä»¶å®šä¹‰ä¸­ï¼Œæ„é€ å‡½æ•°æ¥å—ä¸€ä¸ªIEntityç±»å‹çš„å‚æ•°ï¼Œä»¥è¡¨ç¤ºäº§ç”Ÿå½“å‰äº‹ä»¶çš„å®ä½“å¯¹è±¡ï¼Œæ­¤å¤–ï¼Œå®ƒè¿˜åŒ…å«äº†è®¢å•å‘è´§çš„æ—¥æœŸä¿¡æ¯ã€‚
</code></pre></div></div>

<p>é¢†åŸŸäº‹ä»¶çš„æ´¾å‘å’Œå¤„ç†
å¤„ç†é¢†åŸŸäº‹ä»¶çš„æœºåˆ¶ç§°ä¸ºâ€œäº‹ä»¶å¤„ç†å™¨ï¼ˆEvent Handlerï¼‰â€ï¼Œè€Œé¢†åŸŸäº‹ä»¶çš„æ´¾å‘ï¼Œæˆ‘ä»¬åˆ™æ˜¯é€šè¿‡â€œäº‹ä»¶èšåˆå™¨ï¼ˆEvent Aggregatorï¼‰â€å®ç°çš„ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¨è®ºè¿™ä¸¤ä¸ªéƒ¨åˆ†çš„å…·ä½“å®ç°è¿‡ç¨‹ã€‚</p>

<p>äº‹ä»¶å¤„ç†å™¨ï¼ˆEvent Handlerï¼‰
äº‹ä»¶å¤„ç†å™¨çš„ä»»åŠ¡æ˜¯å¤„ç†æ•è·çš„äº‹ä»¶ï¼Œå®ƒçš„èŒè´£æ˜¯ç›¸å¯¹å•ä¸€çš„ï¼šåªéœ€è¦å¯¹ä¼ å…¥çš„ä¿¡æ¯è¿›è¡Œå¤„ç†å³å¯ã€‚å› æ­¤ï¼Œåœ¨å®ç°ä¸Šæˆ‘ä»¬å¯ä»¥å°†å…¶å®šä¹‰ä¸ºä¸€ä¸ªæ³›å‹æ¥å£ï¼Œä¾‹å¦‚åœ¨Byteart Retailä¸­ï¼Œå®ƒè¢«å®šä¹‰ä¸ºIDomainEventHandler<TDomainEvent>æ¥å£ï¼ŒTDomainEventç±»å‹å‚æ•°æŒ‡å®šäº†äº‹ä»¶å¤„ç†å™¨æ‰€èƒ½å¤Ÿå¤„ç†çš„é¢†åŸŸäº‹ä»¶çš„ç±»å‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯¥æ¥å£åªæä¾›ä¸€ä¸ªHandleæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸€ä¸ªç±»å‹ä¸ºTDomainEventçš„å¯¹è±¡ï¼ˆå³é¢†åŸŸäº‹ä»¶å®ä¾‹ï¼‰ä½œä¸ºå‚æ•°ã€‚æ‰€æœ‰å®ç°äº†è¯¥æ¥å£çš„ç±»å‹éƒ½è¢«è®¤ä¸ºæ˜¯èƒ½å¤Ÿå¤„ç†ç‰¹å®šç±»å‹é¢†åŸŸäº‹ä»¶çš„äº‹ä»¶å¤„ç†å™¨ã€‚ä¸é¢†åŸŸäº‹ä»¶çš„è®¾è®¡ç›¸åŒï¼Œåœ¨Byteart Retailä¸­ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªåä¸ºDomainEventHandler<TDomainEvent>çš„æ³›å‹æŠ½è±¡ç±»ï¼Œè¯¥ç±»ç›´æ¥å®ç°äº†IDomainEventHandler<TDomainEvent>æ¥å£ï¼ŒåŒæ—¶å®ç°äº†ä¸€ä¸ªå¼‚æ­¥äº‹ä»¶å¤„ç†çš„æ–¹æ³•ï¼šHandleAsyncã€‚åŒç†ï¼Œä¸ºäº†è¾¾æˆå¼€å‘è§„èŒƒï¼Œåœ¨Byteart Retailä¸­ï¼Œæ‰€æœ‰é¢†åŸŸäº‹ä»¶å¤„ç†å™¨éƒ½åº”è¯¥ç»§æ‰¿äºDomainEventHandler<TDomainEvent>æŠ½è±¡ç±»ï¼Œå¹¶å®ç°å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•ï¼šHandleæ–¹æ³•ã€‚ç”±äºæ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æ”¯æŒï¼Œå¼€å‘äººå‘˜æ— éœ€è€ƒè™‘å¼‚æ­¥äº‹ä»¶å¤„ç†çš„å®ç°ï¼ˆå³HandleAsyncæ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ªç”¨äºå¼‚æ­¥ä»»åŠ¡å¤„ç†çš„Taskå¯¹è±¡ï¼Œæ¥æ‰§è¡ŒHandleæ–¹æ³•æ‰€å®šä¹‰çš„æ“ä½œï¼‰ã€‚</TDomainEvent></TDomainEvent></TDomainEvent></TDomainEvent></p>

<p>æ­¤å¤–ï¼Œä¸ºäº†ç®€åŒ–ç¼–ç¨‹æ¨¡å‹ï¼ŒByteart Retailè¿˜æ”¯æŒåŸºäºå§”æ‰˜çš„äº‹ä»¶å¤„ç†å™¨ã€‚è¿™ä¸ªè®¾è®¡å…¶å®å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œä½†åœ¨Byteart Retailä¸­ï¼Œä¸ºäº†ç®€åŒ–äº‹ä»¶è®¢é˜…çš„æ“ä½œï¼Œè¿˜æ˜¯å¼•å…¥äº†è¿™æ ·ä¸€ç§åŸºäºå§”æ‰˜çš„äº‹ä»¶å¤„ç†å™¨ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œäº‹ä»¶å¤„ç†é€»è¾‘ä¼šæ¯”è¾ƒç®€å•ï¼Œæ¯”å¦‚ä»…ä»…æ˜¯åœ¨æ•è·åˆ°æŸä¸ªäº‹ä»¶æ—¶æ›´æ–°é¢†åŸŸå¯¹è±¡çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºè¿™æ ·ä¸€äº›åº”ç”¨åœºæ™¯ï¼Œå¼€å‘äººå‘˜å°±æ— éœ€ä¸ºæ¯ä¸€ä¸ªç›¸å¯¹ç®€å•çš„äº‹ä»¶å¤„ç†é€»è¾‘å®šä¹‰ä¸€ä¸ªå•ç‹¬çš„äº‹ä»¶å¤„ç†å™¨ç±»å‹ï¼Œè€Œåªéœ€è¦è®©å§”æ‰˜çš„åŒ¿åæ–¹æ³•æ¥è®¢é˜…å’Œå¤„ç†äº‹ä»¶å³å¯ï¼Œè¿™æ ·åšä¸ä»…ç®€æ´è€Œä¸”ä¾¿äºå•ä½“æµ‹è¯•ã€‚æœ‰å…³äº‹ä»¶å¤„ç†å™¨å¦‚ä½•å»è®¢é˜…é¢†åŸŸäº‹ä»¶ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€å°èŠ‚â€œäº‹ä»¶èšåˆå™¨â€ä¸­è®¨è®ºã€‚è¿˜æ˜¯å…ˆè®©æˆ‘ä»¬æ¥çœ‹çœ‹Byteart Retailä¸­æ˜¯å¦‚ä½•å®ç°è¿™ç§åŸºäºå§”æ‰˜çš„äº‹ä»¶å¤„ç†å™¨çš„ã€‚</p>

<p>åœ¨Byteart Retailä¸­ï¼Œæœ‰ä¸€ä¸ªç‰¹æ®Šçš„é¢†åŸŸäº‹ä»¶å¤„ç†å™¨ï¼Œå®ƒä¸å…¶å®ƒé¢†åŸŸäº‹ä»¶å¤„ç†å™¨ä¸€æ ·ï¼Œä¹Ÿç»§æ‰¿äºDomainEventHandler<TDomainEvent>æ³›å‹æŠ½è±¡ç±»ï¼Œä½†å®ƒçš„ç‰¹æ®Šæ€§åœ¨äºï¼Œå®ƒä¼šåœ¨æ„é€ å‡½æ•°ä¸­æ¥å—ä¸€ä¸ªAction<TDomainEvent>ç±»å‹çš„å§”æ‰˜ä½œä¸ºå‚æ•°ï¼Œäºæ˜¯ï¼Œé€šè¿‡ä¸€ç§ç±»ä¼¼è£…é¥°å™¨æ¨¡å¼çš„æ–¹å¼ï¼Œå°†Action<TDomainEvent>å§”æ‰˜â€œè£…é¥°â€æˆDomainEventHandler<TDomainEvent>ç±»å‹çš„å¯¹è±¡ï¼š</TDomainEvent></TDomainEvent></TDomainEvent></TDomainEvent></p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
/// &lt;summary&gt;
/// è¡¨ç¤ºä»£ç†ç»™å®šçš„é¢†åŸŸäº‹ä»¶å¤„ç†å§”æ‰˜çš„é¢†åŸŸäº‹ä»¶å¤„ç†å™¨ã€‚
/// &lt;/summary&gt;
/// <typeparam name="TEvent"></typeparam>
internal sealed class ActionDelegatedDomainEventHandler<TEvent> : DomainEventHandler<TEvent>
    where TEvent : class, IDomainEvent
{
    #region Private Fields
    private readonly Action<TEvent> eventHandlerDelegate;
    #endregion</TEvent></TEvent></TEvent></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#region Ctor
/// &lt;summary&gt;
/// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„&lt;c&gt;ActionDelegatedDomainEventHandler{TEvent}&lt;/c&gt;å®ä¾‹ã€‚
/// &lt;/summary&gt;
/// &lt;param name="eventHandlerDelegate"&gt;ç”¨äºå½“å‰é¢†åŸŸäº‹ä»¶å¤„ç†å™¨æ‰€ä»£ç†çš„äº‹ä»¶å¤„ç†å§”æ‰˜ã€‚&lt;/param&gt;
public ActionDelegatedDomainEventHandler(Action&lt;TEvent&gt; eventHandlerDelegate)
{
    this.eventHandlerDelegate = eventHandlerDelegate;
}
#endregion
 
// å…¶å®ƒå‡½æ•°å’Œå±æ€§æš‚æ—¶å¿½ç•¥ } åœ¨æ­¤ç±»ä¸­Handleæ–¹æ³•çš„å®ç°å°±éå¸¸ç®€å•äº†ï¼š
</code></pre></div></div>

<p>1
2
3
4
5
6
7
8
/// &lt;summary&gt;
/// å¤„ç†ç»™å®šçš„äº‹ä»¶ã€‚
/// &lt;/summary&gt;
/// <param name="evnt" />éœ€è¦å¤„ç†çš„äº‹ä»¶ã€‚&lt;/param&gt;
public override void Handle(TEvent evnt)
{
    this.eventHandlerDelegate(evnt);
}
è¿™ç§åšæ³•çš„ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥å°†åŸºäºå§”æ‰˜çš„äº‹ä»¶å¤„ç†å™¨å½“æˆæ˜¯æ™®é€šçš„äº‹ä»¶å¤„ç†å™¨ç±»å‹ï¼Œä»è€Œç»Ÿä¸€äº†äº‹ä»¶è®¢é˜…å’Œäº‹ä»¶æ´¾å‘çš„æ¥å£å®šä¹‰ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºActionDelegatedDomainEventHandlerè€Œè¨€ï¼Œå®ä¾‹ä¹‹é—´çš„ç›¸ç­‰æ€§å¹¶ä¸æ˜¯ç”±å®ä¾‹æœ¬èº«å†³å®šçš„ï¼Œè€Œæ˜¯ç”±å…¶æ‰€ä»£ç†çš„å§”æ‰˜å†³å®šçš„ï¼Œè¿™å¯¹äºäº‹ä»¶å¤„ç†å™¨å¯¹äº‹ä»¶çš„è®¢é˜…ï¼Œä»¥åŠäº‹ä»¶èšåˆå™¨å¯¹äº‹ä»¶çš„æ´¾å‘ï¼Œéƒ½æœ‰ç€é‡è¦çš„å½±å“ã€‚æ ¹æ®è¿™ä¸ªåˆ†æï¼Œæˆ‘ä»¬å°±éœ€è¦é‡è½½Equalsæ–¹æ³•ï¼Œä½¿ç”¨Delegate.Equalsæ–¹æ³•æ¥åˆ¤å®šä¸¤ä¸ªå§”æ‰˜çš„ç›¸ç­‰æ€§ã€‚åœ¨Byteart Retailä¸­ï¼ŒIDomainEventHandler<TDomainEvent>æ¥å£è¿˜å®ç°äº†IEquatableæ¥å£ï¼Œå› æ­¤ï¼Œåªéœ€è¦é‡è½½IEquatableæ¥å£ä¸­å®šä¹‰çš„Equalsæ–¹æ³•å³å¯ï¼š</TDomainEvent></p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
/// &lt;summary&gt;
/// è·å–ä¸€ä¸ª<see cref="Boolean"></see>å€¼ï¼Œè¯¥å€¼è¡¨ç¤ºå½“å‰å¯¹è±¡æ˜¯å¦ä¸ç»™å®šçš„ç±»å‹ç›¸åŒçš„å¦ä¸€å¯¹è±¡ç›¸ç­‰ã€‚
/// &lt;/summary&gt;
/// <param name="other" />éœ€è¦æ¯”è¾ƒçš„ä¸å½“å‰å¯¹è±¡ç±»å‹ç›¸åŒçš„å¦ä¸€å¯¹è±¡ã€‚&lt;/param&gt;
/// <returns>å¦‚æœä¸¤è€…ç›¸ç­‰ï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚</returns>
public override bool Equals(IDomainEventHandler<TEvent> other)
{
    if (ReferenceEquals(this, other))
        return true;
    if ((object)other == (object)null)
        return false;
    ActionDelegatedDomainEventHandler<TEvent> otherDelegate = 
        other as ActionDelegatedDomainEventHandler<TEvent>;
    if ((object)otherDelegate == (object)null)
        return false;
    // ä½¿ç”¨Delegate.Equalsæ–¹æ³•åˆ¤å®šä¸¤ä¸ªå§”æ‰˜æ˜¯å¦æ˜¯ä»£ç†çš„åŒä¸€æ–¹æ³•ã€‚
    return Delegate.Equals(this.eventHandlerDelegate, otherDelegate.eventHandlerDelegate);
}
ç°åœ¨æˆ‘ä»¬å·²ç»å®šä¹‰å¥½äº†äº‹ä»¶å¤„ç†å™¨æ¥å£ä»¥åŠç›¸å…³çš„ç±»ï¼ŒåŒæ—¶ä¹Ÿæ ¹æ®éœ€è¦å®ç°äº†å‡ ä¸ªç®€å•çš„äº‹ä»¶å¤„ç†å™¨ï¼ˆå…·ä½“ä»£ç è¯·å‚è€ƒByteart Retailæ¡ˆä¾‹ä¸­ByteartRetail.Domain.Events.Handlerså‘½åç©ºé—´ä¸‹çš„ç±»ï¼‰ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®©é¢†åŸŸæ¨¡å‹èƒ½å¤Ÿåœ¨ä¸šåŠ¡éœ€è¦çš„åœ°æ–¹è§¦å‘é¢†åŸŸäº‹ä»¶ï¼Œå¹¶è®©è¿™äº›äº‹ä»¶å¤„ç†å™¨èƒ½å¤Ÿå¯¹è·å¾—çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚åœ¨Byteart Retailæ¡ˆä¾‹ä¸­ï¼Œè¿™éƒ¨åˆ†å†…å®¹æ˜¯ä½¿ç”¨â€œäº‹ä»¶èšåˆå™¨â€å®ç°çš„ã€‚</TEvent></TEvent></TEvent></p>

<p>äº‹ä»¶èšåˆå™¨ï¼ˆEvent Aggregatorï¼‰
äº‹ä»¶èšåˆå™¨æ˜¯ä¸€ç§ä¼ä¸šåº”ç”¨æ¶æ„æ¨¡å¼ï¼Œå…¶ä½œç”¨ä¸»è¦æ˜¯èšåˆé¢†åŸŸæ¨¡å‹ä¸­çš„äº‹ä»¶å¤„ç†å™¨ï¼Œä»¥ä¾¿äº‹ä»¶åœ¨è§¦å‘çš„æ—¶å€™ï¼Œè¢«èšåˆçš„äº‹ä»¶å¤„ç†å™¨èƒ½å¤Ÿå¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚åœ¨Byteart Retailä¸­ï¼Œäº‹ä»¶èšåˆå™¨çš„ç»“æ„å¦‚ä¸‹ï¼š</p>

<p>image</p>

<p>åœ¨è¿™ä¸ªè®¾è®¡ä¸­ï¼Œäº‹ä»¶èšåˆå™¨æä¾›äº†ä¸‰ç§æ¥å£ï¼šPublishã€Subscribeå’ŒUnsubscribeã€‚Subscribeæ¥å£çš„ä¸»è¦ä½œç”¨æ˜¯ï¼Œå‘äº‹ä»¶èšåˆå™¨æ³¨å†ŒæŒ‡å®šç±»å‹äº‹ä»¶çš„å¤„ç†å™¨ï¼Œé‚£ä¹ˆå¯¹äºäº‹ä»¶å¤„ç†å™¨è€Œè¨€ï¼Œå®ƒå°±æ˜¯åœ¨ä¾¦å¬ï¼ˆè®¢é˜…ï¼‰æŸä¸ªäº‹ä»¶çš„å‘ç”Ÿï¼›è€ŒUnsubscribeçš„ä½œç”¨åˆ™æ­£å¥½ç›¸åï¼šå®ƒä¼šè§£é™¤æŸä¸ªäº‹ä»¶å¤„ç†å™¨å¯¹æŒ‡å®šç±»å‹äº‹ä»¶çš„ä¾¦å¬ï¼Œä¹Ÿå°±æ˜¯å½“äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œä¸å†ä¾¦å¬è¯¥äº‹ä»¶çš„äº‹ä»¶å¤„ç†å™¨å°†ä¸ä¼šæ‰§è¡Œå¤„ç†ä»»åŠ¡ï¼›è‡³äºPublishæ¥å£å°±éå¸¸ç®€å•äº†ï¼šé¢†åŸŸæ¨¡å‹ä½¿ç”¨Publishæ¥å£ç›´æ¥å‘äº‹ä»¶èšåˆå™¨æ´¾å‘äº‹ä»¶ï¼Œäº‹ä»¶èšåˆå™¨åœ¨è§‚å¯Ÿåˆ°äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°†å¤„ç†æƒè½¬äº¤ç»™ä¾¦å¬äº†è¯¥äº‹ä»¶çš„å¤„ç†å™¨ã€‚äº‹ä»¶èšåˆå™¨çš„å¼•å…¥ï¼Œä½¿å¾—äº‹ä»¶èƒ½å¤Ÿè¢«ä¸€æ¬¡æ´¾å‘ï¼Œå¤šå¤„å¤„ç†ï¼Œä¸ºåº”ç”¨ç¨‹åºçš„é¢†åŸŸäº‹ä»¶å¤„ç†æ¶æ„æä¾›äº†æ‰©å±•æ€§çš„åŒæ—¶ï¼Œä¹Ÿç®€åŒ–äº†äº‹ä»¶è®¢é˜…è¿‡ç¨‹ã€‚</p>

<p>åœ¨Byteart Retailä¸­ï¼Œäº‹ä»¶èšåˆå™¨æ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œä¹‹æ‰€ä»¥ä¸è®¾è®¡æˆå®ä¾‹ç±»ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•å°†å…¶ä»¥ä»»ä½•å½¢å¼æ³¨å°„åˆ°é¢†åŸŸæ¨¡å‹ä¸­ï¼Œæ›´ä¸å¯èƒ½è®©é¢†åŸŸå¯¹è±¡æä¾›ä¸€ä¸ªå‚æ•°ä¸ºEventAggregatorç±»å‹çš„æ„é€ å‡½æ•°ã€‚è¿™ä¸€ç‚¹ä¸ä¿æŒé¢†åŸŸæ¨¡å‹çš„çº¯å‡€åº¦æœ‰å…³ã€‚Event Aggregatorçš„å…·ä½“å®ç°ä»£ç ï¼Œè¯·å‚è€ƒByteartRetail.Domain.Eventså‘½åç©ºé—´ä¸‹çš„DomainEventAggregatorç±»ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é¢†åŸŸäº‹ä»¶çš„äº§ç”Ÿã€è®¢é˜…ã€æ´¾å‘å’Œå¤„ç†çš„è¿‡ç¨‹æ€»ç»“ä¸€ä¸‹ã€‚</p>

<p>é¢†åŸŸäº‹ä»¶çš„è®¢é˜…ã€æ´¾å‘å’Œå¤„ç†
é¦–å…ˆï¼Œåœ¨é¢†åŸŸæ¨¡å‹å‚ä¸ä¸šåŠ¡é€»è¾‘ä¹‹å‰ï¼Œåº”ç”¨ç¨‹åºæ¶æ„éœ€è¦å¯¹æ‰€éœ€å¤„ç†çš„é¢†åŸŸäº‹ä»¶è¿›è¡Œè®¢é˜…ã€‚å›é¡¾ä¸€ä¸‹ï¼Œé¢å‘DDDçš„ç»å…¸åˆ†å±‚æ¶æ„ä¸­ï¼Œåº”ç”¨å±‚çš„èŒè´£æ˜¯åè°ƒå„ç»„ä»¶ï¼ˆæ¯”å¦‚äº‹åŠ¡ã€ä»“å‚¨ã€é¢†åŸŸæ¨¡å‹ç­‰ï¼‰çš„ä»»åŠ¡æ‰§è¡Œï¼Œå› æ­¤é¢†åŸŸäº‹ä»¶çš„è®¢é˜…ä¹Ÿåº”è¯¥åœ¨åº”ç”¨å±‚æœåŠ¡è¢«åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œã€‚å…·ä½“åˆ°Byteart Retailæ¡ˆä¾‹ä¸­ï¼Œå°±æ˜¯åœ¨åº”ç”¨æœåŠ¡ï¼ˆApplication Serviceï¼‰çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œã€‚</p>

<p>ä»¥OrderServiceImplç±»å‹ï¼ˆè¯¥ç±»å‹ä½äºByteartRetail.Application.Implementationå‘½åç©ºé—´ä¸‹ï¼‰ä¸ºä¾‹ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­æˆ‘ä»¬æ‰©å±•äº†ä¸€ä¸ªå‚æ•°ï¼šä¸€ä¸ªIDomainEventHandler<OrderDispatchedEvent>ç±»å‹çš„æ•°ç»„ï¼Œè¿›è€Œåœ¨æ„é€ å‡½æ•°ä¸­ï¼Œé€šè¿‡ä½¿ç”¨DomainEventAggregatorç±»ï¼Œå¯¹ä¼ å…¥çš„äº‹ä»¶å¤„ç†å™¨è¿›è¡Œè®¢é˜…æ“ä½œï¼š</OrderDispatchedEvent></p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
public OrderServiceImpl(IRepositoryContext context,
    IShoppingCartRepository shoppingCartRepository,
    IShoppingCartItemRepository shoppingCartItemRepository,
    IProductRepository productRepository,
    IUserRepository customerRepository,
    ISalesOrderRepository salesOrderRepository,
    IDomainService domainService,
    IDomainEventHandler<OrderDispatchedEvent>[] orderDispatchedDomainEventHandlers)
    :base(context)
{
    this.shoppingCartRepository = shoppingCartRepository;
    this.shoppingCartItemRepository = shoppingCartItemRepository;
    this.productRepository = productRepository;
    this.userRepository = customerRepository;
    this.salesOrderRepository = salesOrderRepository;
    this.domainService = domainService;
    this.orderDispatchedDomainEventHandlers.AddRange(orderDispatchedDomainEventHandlers);</OrderDispatchedEvent></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreach (var handler in this.orderDispatchedDomainEventHandlers)
    DomainEventAggregator.Subscribe&lt;OrderDispatchedEvent&gt;(handler);
DomainEventAggregator.Subscribe&lt;OrderConfirmedEvent&gt;(orderConfirmedEventHandlerAction);
DomainEventAggregator.Subscribe&lt;OrderConfirmedEvent&gt;(orderConfirmedEventHandlerAction2); } æ„é€ å‡½æ•°ä¸­æœ€åä¸¤è¡Œæ˜¯å¯¹ä¸OrderConfirmedEventç›¸å…³çš„äº‹ä»¶å¤„ç†å§”æ‰˜è¿›è¡Œè®¢é˜…ï¼Œä»¥æ¼”ç¤ºåŸºäºå§”æ‰˜çš„äº‹ä»¶å¤„ç†å™¨çš„å®ç°æ–¹å¼ã€‚è¿™ä¸¤ä¸ªå§”æ‰˜åœ¨OrderServiceImplç±»å‹ä¸­ï¼Œä»¥åªè¯»å­—æ®µï¼ˆreadonly fieldï¼‰çš„å½¢å¼è¿›è¡Œå®šä¹‰ï¼š
</code></pre></div></div>

<p>1
2
3
4
5
6
7
8
9
10
11
private readonly Action<OrderConfirmedEvent> orderConfirmedEventHandlerAction = e =&gt;
    {
        SalesOrder salesOrder = e.Source as SalesOrder;
        salesOrder.DateDelivered = e.ConfirmedDate;
        salesOrder.Status = SalesOrderStatus.Delivered;
    };</OrderConfirmedEvent></p>

<p>private readonly Action<OrderConfirmedEvent> orderConfirmedEventHandlerAction2 = _ =&gt;
    {</OrderConfirmedEvent></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}; orderConfirmedEventHandlerAction2çš„å®šä¹‰æ— éä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¼”ç¤ºè€Œå·²ï¼ˆæ¼”ç¤ºæ¥ä¸‹æ¥è¦è®¨è®ºçš„äº‹ä»¶å¤„ç†å™¨é€€è®¢ï¼‰ï¼Œå› æ­¤æˆ‘ä¹Ÿæ²¡æœ‰åœ¨è¿™ä¸ªåŒ¿åæ–¹æ³•é‡Œå¡«å†™ä»»ä½•å¤„ç†é€»è¾‘ã€‚è‡³äºæ„é€ å‡½æ•°çš„IDomainEventHandler&lt;OrderDispatchedEvent&gt;æ•°ç»„å‚æ•°ï¼Œåˆ™æ˜¯é€šè¿‡Unityæ³¨å…¥çš„ï¼Œä¿®æ”¹ä¸€ä¸‹æœåŠ¡ç«¯çš„web.configæ–‡ä»¶å³å¯ï¼š
</code></pre></div></div>

<p>SNAGHTMLbb5949e</p>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨åº”ç”¨å±‚å®Œæˆæ“ä½œåï¼Œéœ€è¦è§£é™¤äº‹ä»¶å¤„ç†å™¨å¯¹äº‹ä»¶çš„è®¢é˜…ï¼ˆå³é€€è®¢ï¼‰ï¼Œä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä¿®æ”¹äº†IApplicationServiceContractçš„æ¥å£å®šä¹‰ï¼Œå¹¶è®©ApplicationServiceç±»ç»§æ‰¿äºDisposableObjectç±»ï¼Œä¹‹åï¼Œåœ¨WCFæœåŠ¡ä¸Šï¼Œè®¾ç½®å…¶InstanceContextModeä¸ºPerSessionï¼Œä¹Ÿå°±æ˜¯æ¯å½“WCFå®¢æˆ·ç«¯å»ºç«‹ä¸€æ¬¡ä¸æœåŠ¡ç«¯çš„è¿æ¥æ—¶ï¼Œåˆ›å»ºä¸€æ¬¡æœåŠ¡å®ä¾‹ï¼Œè€Œå½“å®¢æˆ·ç«¯å…³é—­å¹¶æ’¤é”€è¿æ¥æ—¶ï¼Œé”€æ¯æœåŠ¡å®ä¾‹ã€‚äºæ˜¯ï¼Œåœ¨å®Œæˆäº†è¿™äº›ç»“æ„è°ƒæ•´åï¼Œæ¯å½“ä¸€æ¬¡WCFä¼šè¯å®Œæˆåï¼ŒApplicationServiceçš„Disposeæ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚é‚£ä¹ˆæ¯ä¸ªåº”ç”¨å±‚æœåŠ¡çš„å…·ä½“å®ç°ï¼ˆOrderServiceImplã€ProductServiceImplã€UserServiceImplã€PostbackServiceImplï¼‰åªéœ€æ ¹æ®è‡ªå·±çš„éœ€è¦é‡è½½Disposeæ–¹æ³•ï¼Œå³å¯åœ¨Disposeæ–¹æ³•ä¸­è§£é™¤äº‹ä»¶å¤„ç†å™¨å¯¹äº‹ä»¶çš„è®¢é˜…ï¼š</p>

<p>1
2
3
4
5
6
7
8
9
10
protected override void Dispose(bool disposing)
{
    if (disposing)
    {
        foreach (var handler in this.orderDispatchedDomainEventHandlers)
            DomainEventAggregator.Unsubscribe<OrderDispatchedEvent>(handler);
        DomainEventAggregator.Unsubscribe<OrderConfirmedEvent>(orderConfirmedEventHandlerAction);
        DomainEventAggregator.Unsubscribe<OrderConfirmedEvent>(orderConfirmedEventHandlerAction2);
    }
}
æœ€åï¼Œé¢†åŸŸäº‹ä»¶çš„è§¦å‘å°±éå¸¸ç®€å•äº†ï¼šç›´æ¥è°ƒç”¨DomainEventAggregator.Publishå³å¯ã€‚æ•´ä¸ªè¿‡ç¨‹å¤§è‡´å¯ä»¥ç”¨ä¸‹é¢çš„åºåˆ—å›¾æè¿°ï¼š</OrderConfirmedEvent></OrderConfirmedEvent></OrderDispatchedEvent></p>

<p>image</p>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å¤§è‡´äº†è§£äº†Byteart Retailæ¡ˆä¾‹ä¸­é¢†åŸŸäº‹ä»¶éƒ¨åˆ†çš„è®¾è®¡ä¸å®ç°ï¼Œå›é¡¾ä¸€ä¸‹ï¼Œè¿™äº›å†…å®¹åŒ…æ‹¬ï¼šé¢†åŸŸäº‹ä»¶çš„å®šä¹‰ã€äº‹ä»¶å¤„ç†å™¨ã€äº‹ä»¶èšåˆå™¨ï¼Œä»¥åŠè¿™äº›ç»„ä»¶ä¹‹é—´çš„ç›¸äº’åä½œå…³ç³»ã€‚è¯»è€…æœ‹å‹å¦‚æœèƒ½å¤Ÿä»”ç»†é˜…è¯»æœ¬æ¡ˆä¾‹çš„æºä»£ç ï¼Œç›¸ä¿¡è¿˜èƒ½äº†è§£åˆ°æ›´å¤šæ·±å±‚æ¬¡çš„ç»†èŠ‚é—®é¢˜ã€‚ç„¶è€Œï¼Œäº‹æƒ…è¿˜æ²¡æœ‰ç»“æŸï¼Œæˆ‘ä»¬è¿˜éœ€è¦æŠŠè®¨è®ºèŒƒå›´æ‰©å¤§åˆ°ä¸€ä¸ªæ›´é«˜çš„å±‚æ¬¡ï¼šåº”ç”¨äº‹ä»¶ï¼ˆApplication Eventï¼‰ã€‚è™½ç„¶å®ƒå·²ç»è¶…å‡ºé¢†åŸŸäº‹ä»¶çš„èŒƒå›´ï¼Œä½†æˆ‘è¿˜æ˜¯è¦åœ¨æœ¬æ–‡ä¸­å¯¹å…¶è¿›è¡Œä»‹ç»ï¼Œå› ä¸ºè¿™ä¸ªæ¦‚å¿µå¾ˆå®¹æ˜“é€ æˆå¼€å‘äººå‘˜å¯¹äº‹ä»¶ç±»åˆ«çš„æ··æ·†ã€‚</p>

<p>è¿˜æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ
åœ¨æœ¬æ–‡æœ€å¼€å§‹çš„æ—¶å€™æå‡ºäº†ä¸€ä¸ªç®€å•çš„åº”ç”¨åœºæ™¯ï¼šâ€œå½“ç³»ç»Ÿç®¡ç†å‘˜å®Œæˆé”€å”®è®¢å•çš„å‘è´§æ“ä½œæ—¶ï¼Œå¸Œæœ›å‘å®¢æˆ·å‘é€ä¸€ä»½ç”µå­é‚®ä»¶â€ï¼Œè¿™ç§éœ€æ±‚æ˜¯æœ€å¸¸è§ä¸è¿‡çš„äº†ã€‚è™½ç„¶â€œå®Œæˆé”€å”®è®¢å•çš„å‘è´§â€è¢«å®šä¹‰æˆä¸€ä¸ªé¢†åŸŸäº‹ä»¶ï¼ˆäº‹å®ä¸Šå®ƒä¹Ÿå°±æ˜¯ä¸€ä¸ªé¢†åŸŸäº‹ä»¶ï¼‰ï¼Œä½†å¤„ç†ç”µå­é‚®ä»¶å‘é€çš„é€»è¾‘ï¼Œå´å¹¶ä¸æ˜¯é¢†åŸŸäº‹ä»¶å¤„ç†å™¨çš„ä»»åŠ¡ã€‚é€šè¿‡åˆ†æä¸éš¾å¾—çŸ¥ï¼Œé¢†åŸŸäº‹ä»¶å¤„ç†å™¨å¯¹é¢†åŸŸäº‹ä»¶çš„å¤„ç†ï¼Œåœ¨äºæ•´ä¸ªäº‹åŠ¡è¢«æäº¤ä¹‹å‰ã€‚é¢†åŸŸäº‹ä»¶å¤„ç†å™¨å¯ä»¥ä»¥ä¸€ç§æ›´ä¸ºå¤æ‚çš„æ–¹å¼æ¥è·å–æˆ–è®¾ç½®é¢†åŸŸå¯¹è±¡çš„çŠ¶æ€ï¼Œä½†å¯¹äºä¸äº‹åŠ¡ç›¸å…³çš„äº‹ä»¶å¤„ç†è¿‡ç¨‹ï¼Œé¢†åŸŸäº‹ä»¶å¤„ç†å™¨å°±ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚è¯•æƒ³ï¼Œå¦‚æœåœ¨é¢†åŸŸäº‹ä»¶å¤„ç†å™¨ä¸­å°†ç”µå­é‚®ä»¶å‘é€å‡ºå»äº†ï¼Œè€Œæ¥ä¸‹æ¥çš„äº‹åŠ¡æäº¤å´å¤±è´¥äº†ï¼Œäºæ˜¯å°±é€ æˆäº†å®¢æˆ·æ‰€æ”¶åˆ°çš„è®¢å•çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¸ç¬¦çš„æƒ…å½¢ã€‚</p>

<p>æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ï¼Œåœ¨é¢†åŸŸäº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œå°†å…¶è®°å½•ä¸‹æ¥ï¼Œå½“æ‰§è¡Œäº‹åŠ¡æäº¤æ—¶ï¼Œå°†å·²è®°å½•çš„é¢†åŸŸäº‹ä»¶è½¬æ¢æˆåº”ç”¨äº‹ä»¶ï¼Œå¹¶æ´¾å‘åˆ°äº‹ä»¶æ€»çº¿ã€‚è¿™ä¸ªæ´¾å‘è¿‡ç¨‹å¯ä»¥æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥çš„ã€‚æ¥ä¸‹æ¥çš„ç”µå­é‚®ä»¶å‘é€é€»è¾‘å°±ç”±ä¾¦å¬è¯¥äº‹ä»¶æ€»çº¿çš„äº‹ä»¶å¤„ç†å™¨è´Ÿè´£æ‰§è¡Œã€‚è¿™é‡Œç‰µæ¶‰åˆ°ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„é—®é¢˜ã€‚å¯¹äºâ€œå‘é€ç”µå­é‚®ä»¶â€è¿™æ ·çš„åŠŸèƒ½ï¼Œæˆ‘æƒ³ï¼Œå¯¹åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„è¦æ±‚åº”è¯¥ä¹Ÿæ²¡æœ‰é‚£ä¹ˆæ˜æ˜¾ï¼šæ•°æ®åº“äº‹åŠ¡æäº¤æˆåŠŸåï¼Œç›´æ¥è®©åŸºç¡€ç»“æ„å±‚ç»„ä»¶å‘é€ç”µå­é‚®ä»¶å°±å¯ä»¥äº†ï¼Œå¦‚æœå‘é€ç”µå­é‚®ä»¶å¤±è´¥ï¼Œä¹Ÿå®Œå…¨æ— éœ€å›æ»šæ•°æ®åº“äº‹åŠ¡ã€‚å¤§ä¸äº†å®¢æˆ·æŠ±æ€¨è¯´æ²¡æœ‰æ”¶åˆ°é‚®ä»¶ï¼Œç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡äº‹ä»¶æ—¥å¿—å¯¹å‘é€é‚®ä»¶çš„åŠŸèƒ½è¿›è¡Œæ’é”™å³å¯ã€‚ä½†å¯¹äºæŸäº›åº”ç”¨äº‹ä»¶ï¼Œæ¯”å¦‚å®¢æˆ·è®¢æˆ¿æˆåŠŸåï¼Œç³»ç»Ÿå°±ä¼šå°†è®¢æˆ¿æˆåŠŸçš„äº‹ä»¶å‘é€åˆ°æ”¯ä»˜ç³»ç»Ÿï¼Œæ”¯ä»˜ç³»ç»Ÿåœ¨å¤šæ¬¡å°è¯•ä»˜æ¬¾å¤±è´¥åï¼Œå°±éœ€è¦å®Œæˆæˆ¿é—´é€€è®¢é€»è¾‘ï¼Œä»¥é˜²æ­¢æˆ¿é—´è¢«æ— é™åˆ¶å ç”¨ï¼Œåœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†å°±æœ‰ç€ä¸€å®šçš„å¿…é¡»æ€§ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥è¯´è®©æ”¯ä»˜ç³»ç»Ÿæ— é™åˆ¶åœ°é‡è¯•ï¼Œæˆ–è€…è¯´æ‰¾Sales Repè¿›è¡Œ7x24çš„è·Ÿè¸ªæ’é”™æ¥è§£å†³äº‹åŠ¡é—®é¢˜ï¼Œä½†æˆ‘ä»¬æš‚æ—¶å…ˆä¸è€ƒè™‘è¿™äº›è§£å†³æ–¹æ¡ˆï¼‰ã€‚</p>

<p>Byteart Retailè€ƒè™‘äº†è¿™äº›é—®é¢˜å­˜åœ¨çš„å¯èƒ½æ€§ï¼Œåœ¨äº‹ä»¶ç³»ç»Ÿå’Œä»“å‚¨éƒ¨åˆ†å¤§è‡´è¿›è¡Œäº†ä»¥ä¸‹æ”¹åŠ¨ï¼š</p>

<p>å¼•å…¥äº‹ä»¶æ€»çº¿ç³»ç»Ÿï¼ˆIBusæ¥å£ï¼‰ï¼Œåº”ç”¨äº‹ä»¶å¤„ç†å™¨å¯ä»¥ä¾¦å¬è¯¥æ¥å£æ¥æ¥æ”¶éœ€è¦å¤„ç†çš„åº”ç”¨äº‹ä»¶ï¼›åº”ç”¨å±‚åŒæ ·å¯ä»¥ä½¿ç”¨è¯¥æ¥å£æ¥æ´¾å‘åº”ç”¨äº‹ä»¶
å®ç°äº†ä¸€ä¸ªé¢å‘Event Dispatcherçš„äº‹ä»¶æ€»çº¿ï¼Œé€šè¿‡ä½¿ç”¨Event Dispatcherï¼ŒByteart Retailçš„äº‹ä»¶æ€»çº¿å¯ä»¥æ”¯æŒSequentialã€Parallelä»¥åŠParallelNoWaitä¸‰ç§ä¸åŒçš„äº‹ä»¶æ´¾å‘æ–¹å¼ï¼ˆè¯¦è§ä»£ç ä¸­çš„æ³¨é‡Šå†…å®¹ï¼‰
æ›´æ”¹äº†AggregateRootæŠ½è±¡ç±»çš„å®ç°ï¼Œå¼•å…¥äº†å­˜å‚¨é¢†åŸŸäº‹ä»¶çš„éƒ¨åˆ†
æ›´æ”¹äº†RepositoryContextæŠ½è±¡ç±»çš„å®ç°ï¼Œåœ¨Commitæ–¹æ³•ä¸­ï¼Œä¸ä»…æ‰§è¡Œäº†ä»“å‚¨æœ¬èº«çš„æäº¤äº‹åŠ¡ï¼ˆæ–°çš„DoCommitæ–¹æ³•ï¼‰ï¼Œè€Œä¸”è¿˜ä¼šå°†å­˜å‚¨åœ¨èšåˆæ ¹ä¸­çš„é¢†åŸŸäº‹ä»¶æ´¾å‘åˆ°äº‹ä»¶æ€»çº¿ã€‚äº‹ä»¶æ€»çº¿å®šä¹‰äº†å…¶æœ¬èº«æ˜¯å¦æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†ï¼ŒRepositoryContextä¼šæ ¹æ®è¿™ä¸ªè®¾ç½®æ¥å†³å®šæ˜¯å¦éœ€è¦å¯ç”¨Distributed Transaction Coordinatorï¼ˆä¸è¿‡è²Œä¼¼Message Queueçš„è§£å†³æ–¹æ¡ˆä¸­ï¼Œä¹Ÿåªæœ‰MSMQèƒ½å¤Ÿæ”¯æŒMS DTCï¼‰
è¯¦ç»†çš„å®ç°éƒ¨åˆ†ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œä¸€ä¸€å™è¿°äº†ï¼Œè¯·è¯»è€…æœ‹å‹ä»¬è‡ªå·±é˜…è¯»æœ¬æ¡ˆä¾‹çš„æºä»£ç ï¼Œå°¤å…¶æ˜¯ByteartRetail.Eventså’ŒByteartRetail.Events.Handlerså‘½åç©ºé—´ä¸‹çš„ç±»å‹ä»£ç ã€‚</p>

<p>æ‰§è¡Œæ•ˆæœ
æœ¬æ–‡æœ€åï¼Œå°±è®©æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹é¢†åŸŸäº‹ä»¶éƒ¨åˆ†çš„æ‰§è¡Œæ•ˆæœã€‚ä»¥ç³»ç»Ÿç®¡ç†å‘˜å‘è´§ä¸ºä¾‹ï¼ŒæŒ‰ç†ç³»ç»Ÿä¼šäº§ç”Ÿä¸€ä¸ªOrderDispatchedEventé¢†åŸŸäº‹ä»¶ï¼Œé¢†åŸŸæ¨¡å‹é€šè¿‡é¢†åŸŸäº‹ä»¶å¤„ç†å™¨æ›´æ–°è®¢å•çš„å‘è´§æ—¥æœŸå’ŒçŠ¶æ€ï¼Œä¸æ­¤åŒæ—¶ï¼Œä¼šå°†äº§ç”Ÿçš„é¢†åŸŸäº‹ä»¶æš‚å­˜åœ¨èšåˆæ ¹ä¸­ã€‚å½“è®¢å•æ›´æ–°è¢«æäº¤æ—¶ï¼Œè¢«ä¿å­˜çš„é¢†åŸŸäº‹ä»¶å°†è¢«æ´¾å‘åˆ°äº‹ä»¶æ€»çº¿ï¼Œè¿›è€Œé‚®ä»¶å‘é€å¤„ç†å™¨ä¼šæ•è·åˆ°è¿™ä¸ªäº‹ä»¶å¹¶å‘é€é‚®ä»¶ç»™å®¢æˆ·ã€‚</p>

<p>é¦–å…ˆï¼Œå¯åŠ¨Byteart Retailçš„WCFæœåŠ¡å’ŒASP.NET MVCåº”ç”¨ç¨‹åºï¼Œç”¨daxnet/daxnetè´¦æˆ·ç™»å½•ï¼Œå¹¶åœ¨è´¦æˆ·è®¾ç½®ä¸­ç¡®ä¿è¯¥è´¦æˆ·çš„ç”µå­é‚®ä»¶åœ°å€è®¾ç½®æ­£ç¡®ã€‚ç„¶åï¼Œä½¿ç”¨è¯¥è´¦æˆ·åœ¨ç³»ç»Ÿä¸­ä»»æ„è´­ä¹°ä¸€ä»¶å•†å“ï¼Œå®Œæˆä¸‹å•åï¼Œé€€å‡ºç³»ç»Ÿï¼Œå¹¶ç”¨admin/adminè´¦æˆ·ç™»å½•ï¼Œåœ¨â€œç®¡ç†â€-&gt;â€œé”€å”®è®¢å•ç®¡ç†â€é¡µé¢ä¸­ï¼Œæ‰¾åˆ°åˆšåˆšæ”¶åˆ°çš„è®¢å•ï¼Œå¹¶ç‚¹å‡»â€œå‘è´§â€æŒ‰é’®è¿›è¡Œå‘è´§å¤„ç†ï¼š</p>

<p>https://www.cnblogs.com/irocker/p/domain-events-pattern-example.html
æœ¬æ–‡å±•ç¤ºçš„æ˜¯ä¸€ä¸ªå…³äºç½‘ä¸Šè°ƒæŸ¥çš„é¡¹ç›®ã€‚æƒ³è±¡ä¸‹ï¼Œå½“ç”¨æˆ·å®Œæˆäº†ä¸€ä¸ªè°ƒæŸ¥ï¼Œæˆ‘ä»¬æƒ³é€šçŸ¥æ‰€æœ‰äººè°ƒæŸ¥å·²ç»ç»“æŸï¼Œåˆ†é…ä¸€ä¸ªäººå»æ£€æŸ¥è°ƒç”¨é—®å·ã€‚</p>

<p>é¢†åŸŸå¯¹è±¡
public class Survey
{
    public Guid Id { get; private set; }
    public DateTime EndTime { get; private set; }
    public string QualityChecker { get; set; }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public Survey()
{
    this.Id = Guid.NewGuid();
}

public void EndSurvey()
{
    EndTime = DateTime.Now;
    DomainEvent.Raise(new EndOfSurvey() { Survey = this });
} } è¿™ä¸ªé¢†åŸŸå¯¹è±¡éå¸¸ç®€å•ï¼Œåªæœ‰ä¸€ä¸ªè¡Œä¸ºï¼šEndSurvey().
</code></pre></div></div>

<p>é‚£ä¹ˆè¿™é‡Œçš„DomainEventæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿå®ƒæ˜¯ä¸€ä¸ªé™æ€ç±»ï¼Œå®ƒå‘å¸ƒäº†ä¸€ä¸ªEndOfSurveyäº‹ä»¶ã€‚ä»é¡¹ç›®æºç ä¸­å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„äº‹ä»¶éƒ½æ”¾åœ¨åä¸ºEventsçš„æ–‡ä»¶å¤¹ä¸‹é¢ã€‚é¢†åŸŸå¯¹è±¡æ”¾åœ¨Domainæ–‡ä»¶å¤¹ä¸‹é¢ã€‚</p>

<p>EndOfSurveyäº‹ä»¶
ç°åœ¨Surveyå¯¹è±¡å¸Œæœ›å‘å¸ƒä¸€ä¸ªEndOfSurveyäº‹ä»¶ã€‚è¿™ä¸ªäº‹ä»¶çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p>public class EndOfSurvey : IDomainEvent
{
    public Survey Survey { get; set; }
}
EndOfSurveyåŒ…å«ä¸€ä¸ªSurveyå®ä¾‹ã€‚å®ƒç»§æ‰¿è‡ªIDomainEventï¼Œè¿™æ ·æˆ‘ä»¬çŸ¥é“ä»–æ˜¯ä¸€ä¸ªé¢†åŸŸäº‹ä»¶ã€‚æœ¬ä¾‹ä¸­æ‰€æœ‰çš„äº‹ä»¶éƒ½è¦ç»§æ‰¿è‡ªIDomainEventã€‚ è¿™ä¸ªæ¥å£çš„å®šä¹‰å¾ˆç®€å•ï¼š</p>

<p>public interface IDomainEvent { }<br />
DomainEventç±»
public static class DomainEvent
{
    public static IEventDispatcher Dispatcher { get; set; }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void Raise&lt;T&gt;(T @event) where T : IDomainEvent
{
    Dispatcher.Dispatch(@event);
}
</code></pre></div></div>

<p>}
æºç ä¸­çš„DomainEventæ¯”è¿™ä¸ªè¦å¤æ‚ç‚¹ï¼Œä½†æœ€é‡è¦çš„ä¾¿æ˜¯ä¸Šé¢çš„ä»£ç äº†ã€‚</p>

<p>IEventDispatcheræ˜¯ä¸€ä¸ªiocå®¹å™¨ã€‚å®ƒè´Ÿè´£æ‰¾åˆ°æ­£ç¡®çš„handleræ¥å¤„ç†EndOfSurveyäº‹ä»¶ã€‚</p>

<p>public interface IEventDispatcher
{
    void Dispatch<TEvent>(TEvent eventToDispatch) where TEvent : IDomainEvent;
}
æ³›å‹æ–¹æ³•Raise<T>èƒ½è®©æˆ‘ä»¬å‘å¸ƒæ— æ•°çš„äº‹ä»¶ï¼ŒDispatcherè‡ªåŠ¨æ‰¾å‡ºå¯¹åº”çš„handlerã€‚</T></TEvent></p>

<p>ä¸‹é¢å®šä¹‰ä¸€ä¸ªå¤„ç†æ‰€æœ‰äº‹ä»¶çš„handleræ¥å£ï¼š</p>

<p>public interface IDomainHandler<T> where T : IDomainEvent
{
    void Handle(T @event);
}
æˆ‘å°†IEventDispatcher.cså’ŒIDomainHandler.cséƒ½æ”¾åœ¨ä¸€ä¸ªåä¸ºServicesçš„æ–‡ä»¶å¤¹ä¸‹é¢ã€‚å…¶ä»–çš„é¡¹ç›®å¿…é¡»æä¾›å…·ä½“çš„å®ç°ã€‚</T></p>

<p>domainç¨‹åºé›†çš„ä»£ç å°±æ˜¯è¿™äº›äº†ã€‚</p>

<p>å®šä¹‰domainäº‹ä»¶handler
æˆ‘åˆ›å»ºäº†å¦å¤–ä¸€ä¸ªé¡¹ç›®ç”¨æ¥å†™event handlerã€‚</p>

<p>EndOfSurveyHandlerç”¨æ¥å¤„ç†EndOfSurveyäº‹ä»¶ï¼š</p>

<p>public class EndOfSurveyHandler:IDomainHandler<EndOfSurvey>
{
    public void Handle(EndOfSurvey args)
    {
        args.Survey.QualityChecker = "Ivan Amalo";
        // å‘é€é‚®ä»¶ç»™Ivanï¼Œé€šçŸ¥ä»–æ¥æ£€æŸ¥è°ƒæŸ¥é—®å·
    }
}
å¦‚æœæƒ³ä½¿ç”¨repositoryè¿›è¡Œä¸€äº›æ•°æ®æŒç»­åŒ–çš„å·¥ä½œï¼Œæˆ–è€…ä½¿ç”¨ä¸€äº›å…¶ä»–çš„æœåŠ¡ï¼Œå¯ä»¥å°†è¿™äº›repositoryå’ŒæœåŠ¡é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥è¿›æ¥ã€‚</EndOfSurvey></p>

<p>EndOfSurveyHandlerå’ŒEndOfSurveyäº‹ä»¶æ˜¯æ€ä¹ˆè”ç³»èµ·æ¥çš„å‘¢ï¼Ÿ</p>

<p>å°†æ‰€æœ‰çš„ä»£ç é›†æˆèµ·æ¥
ä¸‹é¢è¦è®²Survey.FrontEndæ˜¯ä¸€ä¸ªMVC + WebApiåº”ç”¨ï¼Œè¿™ä¸ªåº”ç”¨å°†DomainEventï¼ŒDispatcherï¼ŒHandleréƒ½ç»“åˆäº†èµ·æ¥ã€‚</p>

<p>è¿™ä¸ªé¡¹ç›®ä¾èµ–äºNinject.MVC3ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬éœ€è¦æ¥å®ç°åœ¨ä¹‹å‰å®šä¹‰çš„IEventDispatcherã€‚</p>

<p>public class NinjectEventContainer : IEventDispatcher
{
    private readonly IKernel _kernel;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public NinjectEventContainer(IKernel kernel)
{
    _kernel = kernel;
}

public void Dispatch&lt;TEvent&gt;(TEvent eventToDispatch) where TEvent : IDomainEvent
{
    foreach (var handler in _kernel.GetAll&lt;IDomainHandler&lt;TEvent&gt;&gt;())
    {
        handler.Handle(eventToDispatch);
    }
} } Dispatchæ–¹æ³•ä½¿ç”¨kernelæ¥æŸ¥æ‰¾æ‰€æœ‰å®ç°äº†IDomainHandlerçš„handlerã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æŸ¥æ‰¾çš„æ˜¯EndOfSurveyHanlderï¼Œç„¶åæ‰§è¡Œå®ƒçš„Handle()æ–¹æ³•ã€‚
</code></pre></div></div>

<p>åœ¨NinjectWebCommon.csä¸­æˆ‘ä»¬å®šä¹‰äº†handlerå’Œeventçš„å¯¹åº”å…³ç³»ã€‚</p>

<p>private static void RegisterServices(IKernel kernel)
{
    DomainEvent.Dispatcher = new NinjectEventContainer(kernel);
    kernel.Bind&lt;IDomainHandler<EndOfSurvey>&gt;().To<EndOfSurveyHandler>();
}   
è¿™å°±æ˜¯æˆ‘ä»¬å°†æ‰€æœ‰ä¸œè¥¿é›†æˆèµ·æ¥éœ€è¦åšçš„äº‹æƒ…ã€‚</EndOfSurveyHandler></EndOfSurvey></p>

<p>æµ‹è¯•
æˆ‘åœ¨EndOfSurveyHandler.csä¸­å‘å¸ƒäº‹ä»¶çš„ä»£ç é‚£è®¾ç½®äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œæ¥æµ‹è¯•äº‹ä»¶å·²ç»å‘å¸ƒï¼Œå…¶å¯¹åº”çš„handlerä¹Ÿè¢«æ‰§è¡Œã€‚</p>

<p>æ§åˆ¶å™¨çš„ä»£ç éå¸¸ç®€å•ï¼Œå¦‚ä¸‹ï¼š</p>

<p>public ActionResult Index()
{
    var survey = new Core.Domain.Survey();
    survey.EndSurvey();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return View(survey); } æ‰§è¡Œè¿™ä¸ªactionï¼Œ Ivan Amaloåº”è¯¥è¢«åˆ†é…æˆä¸ºè¿™ä¸ªè°ƒæŸ¥é—®å·çš„æ£€æŸ¥è€…ï¼Œå¹¶ä¸”å°†EndDateè®¾ä¸ºå½“å‰æ—¶é—´
</code></pre></div></div>

<p>è¿™æ˜¯ä½¿ç”¨Axon Frameworkæ¢ç´¢CQRSæ¶æ„çš„ä¸€ç³»åˆ—å¸–å­ä¸­çš„å¸–å­ã€‚ å»ºè®®åœ¨ç»§ç»­é˜…è¯»æœ¬ç³»åˆ—ä¹‹å‰é˜…è¯»æœ¬ç³»åˆ—ä¸­çš„å‰å‡ ç¯‡æ–‡ç« ï¼Œå› ä¸ºè¿™æœ‰åŠ©äºå½¢æˆå›´ç»•æ‰€è®¨è®ºä¸»é¢˜çš„è¿ç»­æ€§çº¿ç´¢ã€‚ æ‚¨å¯ä»¥ä»ä½¿ç”¨Axon Frameworkæ¢ç´¢CQRSæ¶æ„å¼€å§‹ï¼šç®€ä»‹</p>

<p>æœ‰ä¸€ä¸ªGithubé¡¹ç›®ï¼ˆexploringCQRSwithAxonï¼‰ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œä¼´éšæœ¬ç³»åˆ—ä¸­çš„å¸–å­ã€‚ å®ƒæ˜¯ä¸€ä¸ªè¯´æ˜æ€§çš„åº”ç”¨ç¨‹åºï¼Œå…è®¸åœ¨ä¸¤ä¸ªè™šæ„è´¦æˆ·ä¹‹é—´è¿›è¡Œå€Ÿè®°ï¼Œè´·è®°å’Œè½¬è´¦ã€‚ å¾ˆæ˜æ˜¾è¿™æ˜¯ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œå®ƒæ˜¯æœ‰ç›®çš„çš„ã€‚ å…¶ç›®çš„ä¸æ˜¯æ•è·ä»»ä½•å¤æ‚çš„åŸŸï¼Œè€Œæ˜¯å¸®åŠ©è¯´æ˜CQRSä½“ç³»ç»“æ„çš„å„ä¸ªç»„ä»¶ä»¥åŠå¦‚ä½•ä½¿ç”¨Axon Frameworkæ„å»ºè¿™äº›ä¸åŒçš„ç»„ä»¶ã€‚</p>

<p>Following with the sample application.
è¦ä½¿é¡¹ç›®å¤„äºè¯´æ˜æ­¤å¸–ä¸­çš„äº‹ç‰©ä¸»é¢˜çš„çŠ¶æ€ï¼š</p>

<p>é¦–å…ˆä¸‹è½½é¡¹ç›®:</p>

<p>git clone git@github.com:dadepo/exploringCQRSwithAxon.git
1
ç„¶å check out æœ¬æ¬¡æäº¤çš„ commit hash:</p>

<p>git checkout 06411af499a8d9dab62e1697820ca1c696f766dd
1
æ‚¨å¯ä»¥é€šè¿‡æ‰§è¡Œmvn spring-bootæ¥æ£€æŸ¥å®ƒä¹‹åè¿è¡Œåº”ç”¨ç¨‹åºï¼šåœ¨æ ¹ç›®å½•ä¸­è¿è¡Œï¼Œå› ä¸ºåº”ç”¨ç¨‹åºæ˜¯ä½¿ç”¨Springå¯åŠ¨æ„å»ºçš„ã€‚</p>

<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨Axonçš„æ„å»ºå—æ¥å»ºç«‹ä¸€ä¸ªå­˜å‚¨åº“ï¼Œä»ä¸­æˆ‘ä»¬å¯ä»¥æ£€ç´¢æˆ‘ä»¬çš„èšåˆæ ¹ã€‚</p>

<p>æˆ‘ä»¬è¿˜æœ‰é€‚å½“çš„å‘½ä»¤å¤„ç†ç»„ä»¶ï¼Œä»¥ä¾¿æˆ‘ä»¬èƒ½å¤Ÿè°ƒåº¦æœ€ç»ˆæ”¹å˜åº”ç”¨ç¨‹åºçŠ¶æ€çš„å‘½ä»¤ã€‚ ä½†æ­£å¦‚è¯¥å¸–å­æœ«å°¾æ‰€è¿°ï¼Œå°½ç®¡æˆ‘ä»¬èƒ½å¤Ÿæ‹¥æœ‰æœ€ç»ˆå¯¼è‡´çŠ¶æ€å˜åŒ–çš„å‘½ä»¤ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰è§¦åŠCQRSçš„æ ¸å¿ƒã€‚</p>

<p>è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä»ç„¶ä½¿ç”¨ç›¸åŒçš„æ¨¡å‹å’ŒåŸºç¡€ç»“æ„æ¥æ‰§è¡Œå‘½ä»¤å¤„ç†å’ŒæŸ¥è¯¢ç»„ä»¶ã€‚ æ­£å¦‚åœ¨ä½¿ç”¨Axon Frameworkæ¢ç´¢CQRSæ¶æ„ä¸­æ‰€ä»‹ç»çš„é‚£æ ·ï¼šç®€ä»‹CQRSçš„æ ¸å¿ƒæ˜¯å…·æœ‰å¤„ç†å†™å…¥ï¼ˆå‘½ä»¤ï¼‰å’Œè¯»å–ï¼ˆæŸ¥è¯¢ï¼‰çš„ç‹¬ç‰¹ä¸”ç‹¬ç«‹çš„ç»„ä»¶ã€‚</p>

<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•ç†è§£CQRSçš„æ ¸å¿ƒå¹¶å°†å‘½ä»¤ç»„ä»¶ä¸æŸ¥è¯¢ç»„ä»¶åˆ†å¼€ï¼Ÿ ä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹æˆ‘ä»¬åœ¨ä»‹ç»æ€§å¸–å­ä¸­ä»‹ç»çš„CQRSæ¶æ„å›¾ï¼š</p>

<p>cqrs</p>

<p>åœ¨å›¾ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº‹ä»¶æ€»çº¿ä½äºä¸å‘½ä»¤/å†™å…¥æœ‰å…³çš„ä½“ç³»ç»“æ„çš„ä¸€ä¾§å’Œä¸è¯»å–/æŸ¥è¯¢æœ‰å…³çš„ä¸€ä¾§ã€‚ å› æ­¤ï¼Œä¸ºäº†å›ç­”æˆ‘ä»¬çš„é—®é¢˜ï¼Œæˆ‘ä»¬åˆ©ç”¨äº‹ä»¶æ€»çº¿æ¥å®ç°æˆ‘ä»¬æ‰€å¯»æ±‚çš„åˆ†ç¦»ã€‚</p>

<p>How does this work? It work thus:
åœ¨å†™å…¥æ–¹é¢ï¼Œå‘½ä»¤ä¼šå¯¼è‡´domainä¸­çš„çŠ¶æ€æ›´æ”¹
models/aggregates
domainä¸­çš„çŠ¶æ€æ›´æ”¹ä¼šå¯¼è‡´domain eventsæ•è·å·²æ›´æ”¹çš„å†…å®¹
domian äº‹ä»¶å‘å¸ƒåˆ°äº‹ä»¶æ€»çº¿ã€‚
åœ¨read/queryæ–¹é¢ï¼Œäº‹ä»¶å¤„ç†ç¨‹åºç›‘å¬è¿™äº›äº‹ä»¶å¹¶ä½¿ç”¨å®ƒä»¬ä¼ è¾¾çš„ä¿¡æ¯æ¥ç»´æŠ¤åº”ç”¨ç¨‹åºçŠ¶æ€çš„åæ˜ ã€‚ ç„¶åå°†æ­¤çŠ¶æ€ç”¨äºåº”ç”¨ç¨‹åºçš„è¯»å–ç«¯ã€‚
ä»åŸŸæ¨¡å‹ä¸­çš„æ›´æ”¹å‘å¸ƒçš„äº‹ä»¶åœ¨æŠ€æœ¯ä¸Šç§°ä¸ºåŸŸäº‹ä»¶ï¼ŒAxonå¸¦æœ‰å¿…è¦çš„åŸºç¡€ç»“æ„ï¼Œç”¨äºåœ¨åŸŸæ¨¡å‹ä¸­å‘ç”Ÿæ›´æ”¹æ—¶å‘å¸ƒè¿™äº›åŸŸäº‹ä»¶ã€‚</p>

<p>æœ¬æ–‡çš„ä¸‹ä¸€éƒ¨åˆ†å°†ä»‹ç»å¯¹å…¶ä»–ç¤ºä¾‹åº”ç”¨ç¨‹åºæ‰€åšçš„ä»£ç æ›´æ”¹ï¼Œä»¥ä¾¿è¿æ¥å¹¶ä½¿ç”¨å¿…è¦çš„Axonç»„ä»¶æ¥å®ç°å‘½ä»¤ç«¯ä¸æŸ¥è¯¢ç«¯çš„è¿™ç§åˆ†ç¦»ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸‹å›¾ä¸­çªå‡ºæ˜¾ç¤ºçš„ç»„ä»¶ï¼š</p>

<p>cqrs-event</p>

<p>Overview of code changes
Updating Init Script
ç”±äºæˆ‘ä»¬å°†ä¸ºæŸ¥è¯¢æä¾›å¦ä¸€ä¸ªmodel/storageï¼Œå› æ­¤æˆ‘ä»¬æ›´æ–°äº†å¯åŠ¨è„šæœ¬ä»¥åˆ›å»ºä¸€ä¸ªAccount_Viewè¡¨ï¼Œè¯¥è¡¨å°†ç”¨äºè¯»å–åº”ç”¨ç¨‹åºçš„çŠ¶æ€ã€‚ æˆ‘ä»¬è¿˜æ’å…¥äº†ä¸¤ä¸ªè™šæ‹Ÿè´¦å·ï¼šè¡¨ä¸­çš„acc-oneå’Œacc-twoã€‚ æ‰€ä»¥æˆ‘ä»¬çš„initï¼ˆï¼‰æ–¹æ³•ç°åœ¨çœ‹èµ·æ¥å¦‚æ­¤ï¼š</p>

<p>@PostConstruct
private void init(){
  // init the tables for commands
  TransactionTemplate transactionTmp = new TransactionTemplate(txManager);
  transactionTmp.execute(new TransactionCallbackWithoutResult() {
      @Override
      protected void doInTransactionWithoutResult(TransactionStatus status) {
          UnitOfWork uow = DefaultUnitOfWork.startAndGet();
          repository.add(new Account(â€œacc-oneâ€));
          repository.add(new Account(â€œacc-twoâ€));
          uow.commit();
      }
  });</p>

<p>// init the tables for query/view
 JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);
 jdbcTemplate
       .execute(â€œcreate table account_view (account_no VARCHAR , 
                                                      balance FLOAT )â€);</p>

<p>jdbcTemplate
       .update(â€œinsert into account_view (account_no, balance) values (?, ?)â€, 
                                              new Object[]{â€œacc-oneâ€, 0.0});</p>

<p>jdbcTemplate
       .update(â€œinsert into account_view (account_no, balance) values (?, ?)â€, 
                                             new Object[]{â€œacc-twoâ€, 0.0});
}</p>

<p>Add an Event Bus
æˆ‘ä»¬éœ€è¦ä¸€ä¸ª event busã€‚å®ƒçš„åŸºç¡€æ¶æ„å…è®¸å°†äº‹ä»¶è·¯ç”±åˆ°äº‹ä»¶å¤„ç†ç¨‹åºã€‚</p>

<p>æ‚¨ä¼šæ³¨æ„åˆ°äº‹ä»¶æ€»çº¿å¯èƒ½çœ‹èµ·æ¥ç±»ä¼¼äºå‘½ä»¤æ€»çº¿ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯æ¶ˆæ¯è°ƒåº¦åŸºç¡€ç»“æ„ã€‚å°±åŠŸèƒ½è€Œè¨€ï¼Œå®ƒä»¬åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸åŒçš„ã€‚</p>

<p>æ˜¯çš„ï¼Œå‘½ä»¤æ€»çº¿è°ƒåº¦å‘½ä»¤ï¼Œäº‹ä»¶æ€»çº¿è°ƒåº¦äº‹ä»¶ï¼Œä½†å‘½ä»¤æ€»çº¿ä½¿ç”¨çš„å‘½ä»¤ç”¨äºè¡¨ç¤ºåœ¨æœ€è¿‘çš„å°†æ¥éœ€è¦å‘ç”Ÿçš„äº‹æƒ…ï¼Œå¹¶ä¸”å®ƒæœŸæœ›æœ‰ä¸€ä¸ªä¸”åªæœ‰ä¸€ä¸ªå‘½ä»¤å¤„ç†ç¨‹åºå°†è§£é‡Šå¹¶æ‰§è¡Œå‘½ä»¤ä¸­æ•è·çš„æ„å›¾ã€‚</p>

<p>å¦ä¸€æ–¹é¢ï¼Œäº‹ä»¶æ€»çº¿ï¼Œè·¯ç”±äº‹ä»¶å’Œäº‹ä»¶æ˜¯è¿‡å»å‘ç”Ÿçš„äº‹æƒ…çš„è¡¨è¾¾ï¼Œå¹¶ä¸”äº‹ä»¶å¯èƒ½æœ‰é›¶ä¸ªæˆ–å¤šä¸ªäº‹ä»¶å¤„ç†ç¨‹åºã€‚</p>

<p>EventBusæ˜¯æè¿°äº‹ä»¶è°ƒåº¦ç»„ä»¶çš„Axonæ¥å£ã€‚ Axonå¸¦æœ‰å‡ ä¸ªå®ç°ï¼Œå¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SimpleEventBusã€‚å› æ­¤æˆ‘ä»¬å°†å…¶è¿æ¥ä¸ºSpring beanï¼š</p>

<p>/**</p>
<ul>
  <li>The simple command bus, an implementation of an EventBus</li>
  <li>mostly appropriate in a single JVM, single threaded use case.</li>
  <li>@return the {@link SimpleEventBus}
*/
@Bean
public SimpleEventBus eventBus() {
return new SimpleEventBus();
}</li>
</ul>

<p>æˆ‘ä»¬è¿˜éœ€è¦è¿æ¥AxonåŸºç¡€è®¾æ–½ï¼Œä»¥ä¾¿èƒ½å¤Ÿè½»æ¾çš„è®¾ç½®äº‹ä»¶å¤„ç†ç¨‹åºï¼Œä»¥å“åº”å‘å¸ƒåˆ°äº‹ä»¶æ€»çº¿çš„äº‹ä»¶ã€‚</p>

<p>Axon Frameworké™„å¸¦@EventHandleræ³¨é‡Šï¼Œå¯ç”¨äºå°†æ–¹æ³•æ ‡è®°ä¸ºäº‹ä»¶å¤„ç†ç¨‹åºã€‚ æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ–¹æ³•åº”å“åº”çš„äº‹ä»¶ç±»å‹ã€‚</p>

<p>AnnotationEventListenerBeanPostProcessoræ‰«æå…·æœ‰@EventHandleræ–¹æ³•çš„Spring beanï¼Œå¹¶è‡ªåŠ¨å°†å®ƒä»¬ä½œä¸ºäº‹ä»¶å¤„ç†ç¨‹åºæ³¨å†Œåˆ°äº‹ä»¶æ€»çº¿ã€‚</p>

<p>AnnotationEventListenerBeanPostProcessoræ˜¯AnnotationCommandHandlerBeanPostProcessorçš„äº‹ä»¶è®¡æ•°å™¨éƒ¨åˆ†ã€‚</p>

<p>æˆ‘ä»¬æ³¨å†ŒAnnotationEventListenerBeanPostProcessorï¼š</p>

<p>@Bean
AnnotationEventListenerBeanPostProcessor 
                 annotationEventListenerBeanPostProcessor() {
  /**</p>
<ul>
  <li>The AnnotationEventListenerBeanPostProcessor 
finds all beans that has methods annotated with @EventHandler</li>
  <li>and subscribe them to the eventbus.
   */
  AnnotationEventListenerBeanPostProcessor listener = 
                          new AnnotationEventListenerBeanPostProcessor();
  listener.setEventBus(eventBus());
  return listener;
}
1
2
3
4
5
6
7
8
9
10
11
12
13
[UPDATE]
ä»ç‰ˆæœ¬2.3å¼€å§‹ï¼ŒAxon Frameworkæä¾›äº†@AnnotationDrivenæ³¨é‡Šï¼Œå¯ä»¥é˜²æ­¢å¿…é¡»æ˜¾å¼å£°æ˜AnnotationEventListenerBeanPostProcessorç±»å‹çš„beanã€‚ è¦ä½¿ç”¨å®ƒï¼Œåªéœ€ä½¿ç”¨@AnnotationDrivenæ³¨é‡ŠSpring @Configurationç±»ï¼Œæ‰€æœ‰@ CommandHandlerå’Œ@EventHandlerå°†è‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œåˆ°å„è‡ªçš„æ€»çº¿ã€‚ éšé™„çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºå·²æ›´æ–°ï¼ˆä½¿ç”¨d6c9f18750f8f7d4c341c80a07bdf44c5a815783æäº¤ï¼‰ä»¥ä½¿ç”¨@ AnnotationDrivenã€‚</li>
</ul>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æˆ‘ä»¬çš„é…ç½®è¿›è¡Œçš„æœ€åæ›´æ–°æ˜¯ä¸ºGenericJpaReposirtoryæä¾›äº‹ä»¶æ€»çº¿ã€‚</p>

<p>Update the Repository with Event Bus
GenericJpaRepositoryéœ€è¦äº‹ä»¶æ€»çº¿ï¼Œå› ä¸ºå®ƒå°†åœ¨æˆ‘ä»¬çš„åŸŸå¯¹è±¡ä¸­å‘ç”Ÿæ›´æ”¹æ—¶å‘å¸ƒåŸŸäº‹ä»¶ã€‚ æˆ‘ä»¬åœ¨ä¸‹é¢çš„é…ç½®ä¸­æä¾›äº‹ä»¶æ€»çº¿ï¼š</p>

<p>@Bean
public GenericJpaRepository genericJpaRepository() {
  SimpleEntityManagerProvider entityManagerProvider = 
                      new SimpleEntityManagerProvider(entityManager);</p>

<p>GenericJpaRepository genericJpaRepository = 
                      new GenericJpaRepository(entityManagerProvider, 
                                                         Account.class);</p>

<p>/**</p>
<ul>
  <li>Configuring the repository with an event bus which allows the repository</li>
  <li>to be able to publish domain events
   */
  genericJpaRepository.setEventBus(eventBus());
  return genericJpaRepository;
}</li>
</ul>

<p>domain modelçš„æ›´æ”¹
ç„¶åæˆ‘ä»¬è½¬åˆ°Account.classï¼Œè¿™æ˜¯æˆ‘ä»¬çš„è®¾ç½®ä¸­çš„Aggregate Rootå’ŒAggregateã€‚ æˆ‘ä»¬æ·»åŠ äº†å…è®¸åœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶å‘å¸ƒdomain eventçš„ä»£ç ã€‚</p>

<p>æˆ‘ä»¬çš„debitæ–¹æ³•ç°åœ¨çœ‹èµ·æ¥å¦‚æ­¤ï¼š</p>

<p>public void debit(Double debitAmount) {</p>

<p>if (Double.compare(debitAmount, 0.0d) &gt; 0 &amp;&amp;
  this.balance - debitAmount &gt; -1) {
  this.balance -= debitAmount;</p>

<p>/**</p>
<ul>
  <li>A change in state of the Account has occurred which can</li>
  <li>be represented by an to an event: i.e.</li>
  <li>the account has been debited so an AccountDebitedEvent</li>
  <li>is created and registered.
  *</li>
  <li>When the repository stores this change in state, it will</li>
  <li>also publish the AccountDebitedEvent</li>
  <li>to the outside world.
  */
  AccountDebitedEvent accountDebitedEvent = 
          new AccountDebitedEvent(this.id, debitAmount, this.balance);
  registerEvent(accountDebitedEvent);</li>
</ul>

<p>} else {
  throw new IllegalArgumentException(â€œCannot debit with the amountâ€);
}</p>

<p>}</p>

<p>25
å’Œ credit æ–¹æ³•:</p>

<p>public void credit(Double creditAmount) {</p>

<p>if (Double.compare(creditAmount, 0.0d) &gt; 0 &amp;&amp;
       Double.compare(creditAmount, 1000000) &lt; 0) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   this.balance += creditAmount;
</code></pre></div></div>

<p>/**</p>
<ul>
  <li>A change in state of the Account has occurred which</li>
  <li>can be represented by an to an event: i.e.</li>
  <li>the account has been credited so an AccountCreditedEvent</li>
  <li>is created and registered.
  *</li>
  <li>When the repository stores this change in state, it will</li>
  <li>also publish the AccountCreditedEvent</li>
  <li>to the outside world.
  */
  AccountCreditedEvent accountCreditedEvent = 
          new AccountCreditedEvent(this.id, creditAmount, this.balance);
  registerEvent(accountCreditedEvent);
 } else {
  throw new IllegalArgumentException(â€œCannot credit with the amountâ€);
  }
}</li>
</ul>

<p>æˆ‘ä»¬åœ¨å…¶ä¸­åˆ›å»ºAccountDebitedEventæˆ–AccountCreditedEventå¹¶ä½¿ç”¨registerEvent()æ¥æ³¨å†Œåˆ›å»ºçš„äº‹ä»¶ã€‚</p>

<p>æˆ‘ä»¬ä¹‹æ‰€ä»¥æœ‰registerEvent()æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬çš„Accountç±»æ‰©å±•äº†AbstractAggregateRootã€‚</p>

<p>registerEvent()å…¬å¼€äº†Axonæœºåˆ¶ï¼Œç”¨äºåœ¨åŸŸå¯¹è±¡ä¿å­˜åˆ°å­˜å‚¨åº“æ—¶è·Ÿè¸ªéœ€è¦å‘å¸ƒåˆ°äº‹ä»¶æ€»çº¿çš„åŸŸäº‹ä»¶ã€‚</p>

<p>æˆ‘ä»¬æåˆ°AccountDebitEventå’ŒAccountCreditedEventä½œä¸ºè¡¨ç¤ºå¸æˆ·debited/creditçš„äº‹ä»¶ã€‚ å®ƒä»¬æ˜¯åŸŸäº‹ä»¶ã€‚ å› æ­¤ï¼Œä»£è¡¨è¿™äº›event çš„classå¦‚ä¸‹ï¼š</p>

<p>public class AccountCreditedEvent {</p>

<p>private final String accountNo;
  private final Double amountCredited;
  private final Double balance;</p>

<p>public AccountCreditedEvent(String accountNo, 
                 Double amountCredited, Double balance) {
      this.accountNo = accountNo;
      this.amountCredited = amountCredited;
      this.balance = balance;
  }</p>

<p>public String getAccountNo() {
      return accountNo;
  }</p>

<p>public Double getAmountCredited() {
      return amountCredited;
  }</p>

<p>public Double getBalance() {
      return balance;
  }
}</p>

<p>å’Œ</p>

<p>public class AccountDebitedEvent {
  private final String accountNo;
  private final Double amountDebited;
  private final Double balance;</p>

<p>public AccountDebitedEvent(String accountNo, 
                 Double amountDebited, Double balance) {
      this.accountNo = accountNo;
      this.amountDebited = amountDebited;
      this.balance = balance;
  }</p>

<p>public String getAccountNo() {
      return accountNo;
  }</p>

<p>public Double getAmountDebited() {
      return amountDebited;
  }</p>

<p>public Double getBalance() {
      return balance;
  }
}</p>

<p>åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬å–å¾—äº†ä»€ä¹ˆæˆæœï¼Ÿåœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹å®ƒã€‚</p>

<p>æˆ‘ä»¬ç°åœ¨æœ‰äº†åŸŸäº‹ä»¶ï¼ˆAccountCreditedEventå’ŒAccountDebitedEventï¼‰ï¼Œæˆ‘ä»¬æ›´æ–°äº†åŸŸå¯¹è±¡ä»¥å‘å¸ƒè¿™äº›åŸŸäº‹ä»¶ï¼Œå¹¶ä¸”æˆ‘ä»¬å·²ç»ä½¿ç”¨å¿…è¦çš„åŸºç¡€ç»“æ„æ›´æ–°äº†æˆ‘ä»¬çš„é…ç½®ï¼Œå…è®¸å‘å¸ƒåŸŸäº‹ä»¶ã€‚ æˆ‘ä»¬éœ€è¦æ·»åŠ çš„ä¸‹ä¸€ä»¶äº‹æ˜¯äº‹ä»¶å¤„ç†ç¨‹åºã€‚</p>

<p>Adding Event Handlers
æˆ‘ä»¬æ·»åŠ äº†ä¸¤ä¸ªäº‹ä»¶å¤„ç†ç¨‹åºï¼šAccountDebitedEventHandler</p>

<p>@Component
public class AccountDebitedEventHandler {</p>

<p>@Autowired
DataSource dataSource;</p>

<p>@EventHandler
public void handle AccountDebitedEvent(AccountDebitedEvent event) {</p>

<p>JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);</p>

<p>// Get the current states as reflected in the event
 String accountNo = event.getAccountNo();
 Double balance = event.getBalance();</p>

<p>// Update the view
 String updateQuery = â€œUPDATE account_view SET balance = ? 
                                             WHERE account_no = ?â€;
 jdbcTemplate.update(updateQuery, new Object[]{balance, accountNo});
 }
}</p>

<p>å’Œ AccountCreditedEventHandler</p>

<p>@Component
public class AccountCreditedEventHandler {</p>

<p>@Autowired
DataSource dataSource;</p>

<p>@EventHandler
public void handleAccountCreditedEvent(AccountCreditedEvent event, 
Message eventMessage, @Timestamp DateTime moment) {</p>

<p>JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);</p>

<p>// Get the current states as reflected in the event
String accountNo = event.getAccountNo();
Double balance = event.getBalance();</p>

<p>// Update the view
String updateQuery = â€œUPDATE account_view SET balance = ? 
                                           WHERE account_no = ?â€;
jdbcTemplate.update(updateQuery, new Object[]{balance, accountNo});</p>

<p>System.out.println(â€œEvents Handled With EventMessage â€œ + 
            eventMessage.toString() + â€œ at â€œ + moment.toString());
}
}</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œäº‹ä»¶å¤„ç†æ–¹æ³•ä½¿ç”¨@EventHandlerè¿›è¡Œæ³¨é‡Šã€‚ å®ƒä»¬å“åº”çš„äº‹ä»¶ç±»å‹ç”±å¸¦æ³¨é‡Šçš„æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡ç¤ºã€‚</p>

<p>ç”±äºæˆ‘ä»¬å·²åœ¨é…ç½®ä¸­æ³¨å†Œäº†AnnotationEventListenerBeanPostProcessorï¼Œå› æ­¤è¿™äº›ç±»å°†è¢«è®¢é˜…ä¸ºäº‹ä»¶æ€»çº¿çš„äº‹ä»¶å¤„ç†ç¨‹åºã€‚</p>

<p>é‚£ä¹ˆåœ¨è¿™äº›äº‹ä»¶å¤„ç†æ–¹æ³•ä¸­ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ æˆ‘ä»¬ä»å„ä¸ªäº‹ä»¶ä¸­æå–ä¿¡æ¯ï¼Œå¹¶ä½¿ç”¨JDBCæ›´æ–°Account_viewè¡¨ï¼Œè¯¥è¡¨æ˜¯ç”¨äºæŸ¥è¯¢/è¯»å–æ“ä½œçš„è¡¨ã€‚</p>

<p>åœ¨è¿™ä¸ªç»“ç‚¹ä¸Šéœ€è¦æ³¨æ„çš„ä¸€ä»¶é‡è¦äº‹æƒ…æ˜¯ï¼Œæˆ‘ä»¬å°†è§†å›¾æ•°æ®å­˜å‚¨åœ¨ä¸ç”¨äºå‘½ä»¤æ“ä½œçš„è¡¨ä¸åŒçš„è¡¨ä¸­ã€‚
æˆ‘ä»¬ä¹Ÿæ²¡æœ‰å¯¹è§†å›¾å±‚ä½¿ç”¨ä»»ä½•ORMæ˜ å°„ï¼ˆJPAç­‰ï¼‰ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„ç±»åœ¨æ˜ å°„å…¶çŠ¶æ€æ—¶ä¸ºAccountå»ºmodelã€‚ è¿™ç§ç‰¹æ€§æ˜¯CQRSçœ‹å¾…äº‹ç‰©çš„æ ¸å¿ƒã€‚ äº‹å®ä¸Šï¼Œä½¿ç”¨CQRSï¼Œæˆ‘ä»¬çš„æŸ¥è¯¢å±‚å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç®€åŒ–æŠ½è±¡å®ç°ï¼Œå¯ä»¥è½»æ¾åœ°é’ˆå¯¹æŸ¥è¯¢/è¯»å–æ“ä½œè¿›è¡Œä¼˜åŒ–ã€‚</p>

<p>handleAccountCreditedEvent()æ–¹æ³•å±•ç¤ºäº†Axonä¸ºäº‹ä»¶å¤„ç†æä¾›çš„ä¸€äº›é™„åŠ åŠŸèƒ½ã€‚ å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªé¢å¤–çš„å‚æ•°ã€‚ æ¶ˆæ¯eventMessageåŒ…å«äº‹ä»¶æ¶ˆæ¯ï¼šmetadataï¼Œidç­‰å’Œ@Timestamp DateTimeæ—¶åˆ»ï¼Œå®ƒæ˜¯åœ¨äº‹ä»¶å‘å¸ƒçš„æ—¶åˆ»æ³¨å…¥çš„ã€‚</p>

<p>æ¥ä¸‹æ¥è¦åšçš„æ˜¯æ›´æ–°æˆ‘ä»¬çš„è§†å›¾ï¼ˆViewController / Javascriptï¼‰ä»¥ä½¿ç”¨è¿™ä¸ªæ–°è®¾ç½®ã€‚</p>

<p>æ›´æ–°è§†å›¾
æˆ‘ä»¬æ›´æ–°ViewControllerçš„getAccountsæ–¹æ³•ä»¥ä½¿ç”¨æ™®é€šJDBCæ¥æŸ¥è¯¢å¸æˆ·çš„çŠ¶æ€ï¼š</p>

<p>@Controller
public class ViewController {</p>

<p>@Autowired
 private DataSource dataSource;</p>

<p>@RequestMapping(value = â€œ/viewâ€, 
                method = RequestMethod.GET, 
                produces = MediaType.APPLICATION_JSON_VALUE)
 @ResponseBody
 public List&lt;Map&lt;String, DoubleÂ» getAccounts() {</p>

<p>JdbcTemplate jdbcTemplate = new JdbcTemplate(dataSource);
   List&lt;Map&lt;String, DoubleÂ» queryResult = 
   jdbcTemplate.query(â€œSELECT * from account_view ORDER BY account_noâ€, 
                                                  (rs, rowNum) -&gt; {
   return new HashMap&lt;String, Double&gt;() {{
                           put(rs.getString(â€œACCOUNT_NOâ€),
                           rs.getDouble(â€œBALANCEâ€));
   }};
});</p>

<p>return queryResult;
 }
}</p>

<p>è½®è¯¢ /view endpoint çš„JavaScriptä»ç„¶å­˜åœ¨ã€‚</p>

<p>é€šè¿‡æ‰€æœ‰è¿™äº›æ›´æ”¹ï¼Œå½“æ‚¨è¿è¡Œåº”ç”¨ç¨‹åºæ—¶ï¼Œæ‚¨ä»ç„¶å¯ä»¥é€‰æ‹©ä¿¡ç”¨å¡æˆ–å€Ÿè®°å¡ï¼Œå¹¶åœ¨ä½™é¢éƒ¨åˆ†ä¸­åæ˜ ä½™é¢ã€‚ å°±åœ¨è¿™ä¸€æ¬¡ï¼Œå€Ÿè®°/è´·è®°æ˜¯é€šè¿‡ä¸ç”¨äºæŸ¥çœ‹è´¦æˆ·å½“å‰ä½™é¢çš„ç»„ä»¶ä¸åŒçš„ç»„ä»¶å®Œæˆçš„ã€‚</p>

<p>Overview of the Axon Building Blocks
åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è®¨è®ºäº†Axon Frameworkä¸­çš„ä¸€äº›æ–°æ„å»ºå—ã€‚ è®©æˆ‘ä»¬æ¥è¿…é€Ÿå›é¡¾ä¸€ä¸‹ï¼š</p>

<p>SimpleEventBus
AxonåŸºç¡€è®¾æ–½è´Ÿè´£äº‹ä»¶è·¯ç”±åˆ°äº‹ä»¶å¤„ç†ç¨‹åºã€‚</p>

<p>AnnotationEventListenerBeanPostProcessor
åœ¨Springåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æ‰‹åŠ¨æ–¹å¼ä½¿ç”¨Axonã€‚å®ƒæ‰«æå…·æœ‰@EventHandleræ³¨é‡Šçš„Spring beanï¼Œå¹¶è‡ªåŠ¨å°†å®ƒä»¬æ³¨å†Œä¸ºäº‹ä»¶å¤„ç†ç¨‹åºåˆ°äº‹ä»¶æ€»çº¿ã€‚</p>

<p>RegisterEvent method
å¯ä»¥é€šè¿‡åœ¨æ‰©å±•AbstractAggregateRootçš„åŸŸå¯¹è±¡ä¸­çš„æ–¹æ³•ï¼Œä»¥æ³¨å†Œç”¨äºå‘å¸ƒçš„åŸŸäº‹ä»¶ã€‚</p>

<p>æ¦‚è¦
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»èƒ½å¤Ÿä»¥CQRSçš„æ–¹å¼ï¼Œè®¾ç½®åº”ç”¨ç¨‹åºçš„ç»„ä»¶ã€‚</p>

<p>æ‚¨ä¼šæ³¨æ„åˆ°æˆ‘ä»¬åœ¨æ²¡æœ‰æåŠæˆ–ä½¿ç”¨äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰çš„æƒ…å†µä¸‹å®Œæˆäº†è¿™é¡¹å·¥ä½œï¼Œè¿™è¡¨æ˜å¦‚æœæ‚¨ä¸éœ€è¦å®ƒæ—¶ï¼Œæ‚¨å¯ä»¥åœ¨ä¸ä½¿ç”¨äº‹ä»¶æºçš„æƒ…å†µä¸‹æ„å»ºCQRSåº”ç”¨ç¨‹åºã€‚</p>

<p>ä½†æ˜¯å¦‚æœä½ æƒ³ä½¿ç”¨Event Sourcingæ€ä¹ˆåŠï¼Ÿ Axon Frameworkå¦‚ä½•æä¾›å¸®åŠ©ï¼Ÿ ä¸‹ä¸€ç¯‡æ–‡ç« æ¢ç´¢ä½¿ç”¨Axon Frameworkçš„CQRSï¼šåº”ç”¨äº‹ä»¶é‡‡è´­ç­”æ¡ˆï¼Œè¯¢é—®å¦‚ä½•ä½¿ç”¨Axon Frameworkåœ¨CQRSåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨äº‹ä»¶æº¯æºã€‚</p>

<p>https://blog.csdn.net/quguang65265/article/details/81382319</p>

<p>https://www.cnblogs.com/daxnet/archive/2013/04/30/3052029.html</p>

<p>http://www.360doc.com/content/13/1226/09/10504424_340184984.shtml
https://www.cnblogs.com/uoyo/p/12421553.html</p>

<p>https://www.jdon.com/eda.html
https://www.jdon.com/48068
https://blog.christianposta.com/microservices/why-microservices-should-be-event-driven-autonomy-vs-authority/</p>

<p>https://www.jdon.com/49113</p>

<p>https://www.jdon.com/eda.html
https://www.jdon.com/event.html</p>

<p>https://www.jdon.com/49081</p>
:ET