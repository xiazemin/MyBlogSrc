I"‘#<p>https://github.com/prometheus/mysqld_exporter
https://www.cnblogs.com/xiaobaozi-95/p/11453734.html
https://blog.csdn.net/allway2/article/details/106986309/</p>

<p>https://www.cnblogs.com/klvchen/p/10062754.html
https://www.cnblogs.com/xiangsikai/p/11289675.html</p>

<p>redis ç›‘æ§æ’ä»¶
https://github.com/oliver006/redis_exporter
<!-- more -->
Prometheus å·²ç»æˆä¸ºäº‘åŸç”Ÿåº”ç”¨ç›‘æ§è¡Œä¸šçš„æ ‡å‡†ï¼Œåœ¨å¾ˆå¤šæµè¡Œçš„ç›‘æ§ç³»ç»Ÿä¸­éƒ½å·²ç»å®ç°äº† Prometheusçš„ç›‘æ§æ¥å£ï¼Œä¾‹å¦‚ etcdã€Kubernetesã€CoreDNSç­‰ï¼Œå®ƒä»¬å¯ä»¥ç›´æ¥è¢«Prometheusç›‘æ§ï¼Œä½†å¤§å¤šæ•°ç›‘æ§å¯¹è±¡éƒ½æ²¡åŠæ³•ç›´æ¥æä¾›ç›‘æ§æ¥å£ï¼Œä¸»è¦åŸå› æœ‰ï¼š
ï¼ˆ1ï¼‰å¾ˆå¤šç³»ç»Ÿåœ¨Prometheusè¯ç”Ÿå‰çš„å¾ˆå¤šå¹´å°±å·²å‘å¸ƒï¼Œä¾‹å¦‚MySQLã€Redisç­‰ï¼›
ï¼ˆ2ï¼‰å®ƒä»¬æœ¬èº«ä¸æ”¯æŒ HTTP æ¥å£ï¼Œä¾‹å¦‚å¯¹äºç¡¬ä»¶æ€§èƒ½æŒ‡æ ‡ï¼Œæ“ä½œç³»ç»Ÿå¹¶æ²¡æœ‰åŸç”Ÿçš„HTTPæ¥å£å¯ä»¥è·å–ï¼›
ï¼ˆ3ï¼‰è€ƒè™‘åˆ°å®‰å…¨æ€§ã€ç¨³å®šæ€§åŠä»£ç è€¦åˆç­‰å› ç´ çš„å½±å“ï¼Œè½¯ä»¶ä½œè€…å¹¶ä¸æ„¿æ„å°†ç›‘æ§ä»£ç åŠ å…¥ç°æœ‰ä»£ç ä¸­ã€‚
è¿™äº›éƒ½å¯¼è‡´æ— æ³•é€šè¿‡ä¸€ä¸ªè§„èŒƒè§£å†³æ‰€æœ‰ç›‘æ§é—®é¢˜ã€‚åœ¨æ­¤èƒŒæ™¯ä¹‹ä¸‹ï¼ŒExporter åº”è¿è€Œç”Ÿã€‚Exporter æ˜¯ä¸€ä¸ªé‡‡é›†ç›‘æ§æ•°æ®å¹¶é€šè¿‡ Prometheus ç›‘æ§è§„èŒƒå¯¹å¤–æä¾›æ•°æ®çš„ç»„ä»¶ã€‚é™¤äº†å®˜æ–¹å®ç°çš„Exporterå¦‚Node Exporterã€HAProxy Exporterã€MySQLserver Exporterï¼Œè¿˜æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹å®ç°å¦‚Redis Exporterå’ŒRabbitMQ Exporterç­‰</p>

<p>Exporterè·å–ç›‘æ§æ•°æ®çš„æ–¹å¼
Exporter ä¸»è¦é€šè¿‡è¢«ç›‘æ§å¯¹è±¡æä¾›çš„ç›‘æ§ç›¸å…³çš„æ¥å£è·å–ç›‘æ§æ•°æ®ï¼Œä¸»è¦æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š
ï¼ˆ1ï¼‰HTTP/HTTPSæ–¹å¼ã€‚ä¾‹å¦‚ RabbitMQ exporteré€šè¿‡ RabbitMQçš„ HTTPSæ¥å£è·å–ç›‘æ§æ•°æ®ã€‚
ï¼ˆ2ï¼‰TCPæ–¹å¼ã€‚ä¾‹å¦‚Redis exporteré€šè¿‡Redisæä¾›çš„ç³»ç»Ÿç›‘æ§ç›¸å…³å‘½ä»¤è·å–ç›‘æ§æŒ‡æ ‡ï¼ŒMySQL server exporteré€šè¿‡MySQLå¼€æ”¾çš„ç›‘æ§ç›¸å…³çš„è¡¨è·å–ç›‘æ§æŒ‡æ ‡ã€‚
ï¼ˆ3ï¼‰æœ¬åœ°æ–‡ä»¶æ–¹å¼ã€‚ä¾‹å¦‚Node exporteré€šè¿‡è¯»å–procæ–‡ä»¶ç³»ç»Ÿä¸‹çš„æ–‡ä»¶ï¼Œè®¡ç®—å¾—å‡ºæ•´ä¸ªæ“ä½œç³»ç»Ÿçš„çŠ¶æ€ã€‚
ï¼ˆ4ï¼‰æ ‡å‡†åè®®æ–¹å¼ã€‚</p>

<p>https://www.jianshu.com/p/3029e58f7141</p>

<p>MySQLç›‘æ§æŒ‡æ ‡åŠé‡‡é›†æ–¹æ³•
ä¸€ã€ç”¨æˆ·ã€è¿æ¥ç±»
1ã€æŸ¥çœ‹æ¯ä¸ªå®¢æˆ·ç«¯IPè¿‡æ¥çš„è¿æ¥æ¶ˆè€—èµ„æºæƒ…å†µã€‚</p>

<p>select * from sys.host_summary;</p>

<p>2ã€æŸ¥çœ‹æ¯ä¸ªç”¨æˆ·æ¶ˆè€—èµ„æºæƒ…å†µ</p>

<p>select * from sys.user_summary;</p>

<p>3ã€æŸ¥çœ‹å½“å‰è¿æ¥æƒ…å†µï¼ˆæœ‰å¤šå°‘è¿æ¥å°±åº”è¯¥æœ‰å¤šå°‘è¡Œï¼‰</p>

<p>select host,current_connections,statements from sys.host_summary;</p>

<p>4ã€æŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„SQL</p>

<p>å’Œæ‰§è¡Œshow full processlistçš„ç»“æœå·®ä¸å¤š</p>

<p>select conn_id,pid,user,db,command,current_statement,last_statement,time,lock_latency from sys.session</p>

<p>äºŒã€SQL å’Œioç±»
1ã€æŸ¥çœ‹å‘ç”ŸIOè¯·æ±‚å‰5åçš„æ–‡ä»¶ã€‚</p>

<p>select * from sys.io_global_by_file_by_bytes order by total limit 5;</p>

<p>ä¸‰ã€buffer pool ã€å†…å­˜
1ã€æŸ¥çœ‹æ€»å…±åˆ†é…äº†å¤šå°‘å†…å­˜</p>

<p>select * from sys.memory_global_total;select * from sys.memory_global_by_current_bytes;</p>

<p>2ã€æ¯ä¸ªåº“ï¼ˆdatabaseï¼‰å ç”¨å¤šå°‘buffer pool</p>

<p>select * from sys.innodb_buffer_stats_by_schema order by allocated desc;</p>

<p>pagesæ˜¯æŒ‡åœ¨buffer poolä¸­çš„pageæ•°é‡ï¼›pages_oldæŒ‡åœ¨LUR åˆ—è¡¨ä¸­å¤„äºå37%ä½ç½®çš„pageã€‚</p>

<p>å½“å‡ºç°buffer pageä¸å¤Ÿç”¨æ—¶ï¼Œå°±ä¼šå¾ç”¨è¿™äº›pageæ‰€å çš„ç©ºé—´ã€‚37%æ˜¯é»˜è®¤ä½ç½®ï¼Œå…·ä½“å¯ä»¥è‡ªå®šä¹‰ã€‚</p>

<p>3ã€ç»Ÿè®¡æ¯å¼ è¡¨å…·ä½“åœ¨InnoDBä¸­å…·ä½“çš„æƒ…å†µï¼Œæ¯”å¦‚å å¤šå°‘é¡µï¼Ÿ</p>

<p>æ³¨æ„å’Œå‰é¢çš„pagesçš„æ€»æ•°éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œä¹Ÿå¯ä»¥å€Ÿç”¨sumï¼ˆpagesï¼‰è¿ç®—éªŒè¯ä¸€ä¸‹ã€‚</p>

<p>select * from sys.innodb_buffer_stats_by_table;</p>

<p>4ã€æŸ¥è¯¢æ¯ä¸ªè¿æ¥åˆ†é…äº†å¤šå°‘å†…å­˜</p>

<p>åˆ©ç”¨sessionè¡¨å’Œmemory_by_thread_by_current_bytesåˆ†é…è¡¨è¿›è¡Œå…³è”æŸ¥è¯¢ã€‚</p>

<p>SELECT b.USER, current_count_used, current_allocated, current_avg_alloc, current_max_alloc, total_allocated, current_statement FROM sys.memory_by_thread_by_current_bytes a, sys.SESSION b WHERE a.thread_id = b.thd_id;</p>

<p>å››ã€å­—æ®µã€ç´¢å¼•ã€é”
1ã€æŸ¥çœ‹è¡¨è‡ªå¢å­—æ®µæœ€å¤§å€¼å’Œå½“å‰å€¼ï¼Œæœ‰æ—¶å€™åšæ•°æ®å¢é•¿çš„ç›‘æ§ï¼Œå¯ä»¥ä½œä¸ºå‚è€ƒã€‚</p>

<p>select * from sys.schema_auto_increment_columns;</p>

<p>2ã€MySQLç´¢å¼•ä½¿ç”¨æƒ…å†µç»Ÿè®¡</p>

<p>select * from sys.schema_index_statistics order by rows_selected desc;</p>

<p>3ã€MySQLä¸­æœ‰å“ªäº›å†—ä½™ç´¢å¼•å’Œæ— ç”¨ç´¢å¼•</p>

<p>è‹¥åº“ä¸­å±•ç¤ºæ²¡æœ‰å†—ä½™ç´¢å¼•ï¼Œåˆ™æ²¡æœ‰æ•°æ®ï¼›å½“æœ‰è”åˆç´¢å¼•idx_abc(a,b,c)å’Œidx_a(a)ï¼Œé‚£ä¹ˆidx_aå°±ç®—å†—ä½™ç´¢å¼•äº†ã€‚</p>

<p>select * from sys.schema_redundant_indexes;</p>

<p>4ã€æŸ¥çœ‹INNODB é”ä¿¡æ¯</p>

<p>åœ¨æœªæ¥çš„ç‰ˆæœ¬å°†è¢«ç§»é™¤ï¼Œå¯ä»¥é‡‡ç”¨å…¶ä»–æ–¹å¼</p>

<p>select * from sys.innodb_lock_waits</p>

<p>5ã€æŸ¥çœ‹åº“çº§åˆ«çš„é”ä¿¡æ¯ï¼Œè¿™ä¸ªéœ€è¦å…ˆæ‰“å¼€MDLé”çš„ç›‘æ§ï¼š</p>

<p>â€“æ‰“å¼€MDLé”ç›‘æ§update performance_schema.setup_instruments set enabled=â€™YESâ€™,TIMED=â€™YESâ€™ where name=â€™wait/lock/metadata/sql/mdlâ€™;select * from sys.schema_table_lock_waits;</p>

<p>äº”ã€çº¿ç¨‹ç±»
1ã€MySQLå†…éƒ¨æœ‰å¤šä¸ªçº¿ç¨‹åœ¨è¿è¡Œï¼Œçº¿ç¨‹ç±»å‹åŠæ•°é‡</p>

<p>select user,count(*) from sys.<code class="language-plaintext highlighter-rouge">processlist</code> group by user;</p>

<p>å…­ã€ä¸»é”®è‡ªå¢
æŸ¥çœ‹MySQLè‡ªå¢idçš„ä½¿ç”¨æƒ…å†µ</p>

<p>SELECT table_schema, table_name, ENGINE, Auto_increment FROM information_schema.TABLES WHERE TABLE_SCHEMA NOT IN ( â€œINFORMATION_SCHEMAâ€, â€œPERFORMANCE_SCHEMAâ€, â€œMYSQLâ€, â€œSYSâ€ )</p>

<p>èƒŒæ™¯ï¼šçº¿ä¸Šç”Ÿäº§ç¯å¢ƒMySQLçš„æ¶æ„æ˜¯ä¸€ä¸»åŒä»ï¼Œä¸ºäº†æ›´å¥½äº†è§£MySQLé›†ç¾¤è¿è¡ŒçŠ¶å†µï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä»¥ä¸‹æŒ‡æ ‡è¿›è¡Œç›‘æ§ï¼</p>

<p>ä¸€ã€å¯¹æ•°æ®åº“æœåŠ¡å¯ç”¨æ€§è¿›è¡Œç›‘æ§</p>

<p>æ€è·¯ï¼š</p>

<p>1.1 é€šè¿‡æµ‹è¯•è´¦å·pingå‘½ä»¤è¿”å›çš„ä¿¡æ¯åˆ¤æ–­æ•°æ®åº“å¯ä»¥é€šè¿‡ç½‘ç»œè¿æ¥</p>

<p>[root@host-39-108-217-12 scripts]# /usr/bin/mysqladmin -uroot -p123456 ping</p>

<p>mysqld is alive</p>

<p>1.2 ç¡®è®¤æ•°æ®åº“æ˜¯å¦å¯è¯»å†™</p>

<p>a.æ£€æŸ¥æ•°æ®åº“çš„read_onlyå‚æ•°æ˜¯å¦ä¸ºoff</p>

<table>
  <tbody>
    <tr>
      <td>[root@host-47-106-141-17 scripts]# mysql -uroot -p123456 -P3306 -e â€œshow global variables like â€˜read_onlyâ€™â€</td>
      <td>grep read_only</td>
    </tr>
  </tbody>
</table>

<p>read_only OFF</p>

<p>b.æ‰§è¡Œç®€å•çš„æ•°æ®åº“æŸ¥è¯¢ï¼Œå¦‚ï¼šselect @@version;</p>

<table>
  <tbody>
    <tr>
      <td>[root@host-47-106-141-17 scripts]# mysql -uroot -p123456 -P3306 -e â€œselect @@versionâ€</td>
      <td>grep MariaDB</td>
    </tr>
  </tbody>
</table>

<p>5.5.56-MariaDB</p>

<p>äºŒã€å¯¹æ•°æ®åº“æ€§èƒ½è¿›è¡Œç›‘æ§</p>

<p>2.1 ç›‘æ§æ•°æ®åº“è¿æ¥æ•°å¯ç”¨æ€§</p>

<p>a.æ•°æ®åº“æœ€å¤§è¿æ¥æ•°</p>

<p>[root@host-47-106-141-17 scripts]# mysql -uroot -p123456 -e â€œshow variables like â€˜max_connectionsâ€™â€</p>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<table>
  <tbody>
    <tr>
      <td>Variable_name</td>
      <td>Value</td>
    </tr>
  </tbody>
</table>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<table>
  <tbody>
    <tr>
      <td>max_connections</td>
      <td>151</td>
    </tr>
  </tbody>
</table>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<p>b.æ•°æ®åº“å½“å‰æ‰“å¼€çš„è¿æ¥æ•°</p>

<table>
  <tbody>
    <tr>
      <td>[root@host-47-106-141-17 scripts]# mysqladmin -uroot -p123456 extended-status</td>
      <td>grep -w â€œThreads_connectedâ€</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>Threads_connected</td>
      <td>1</td>
    </tr>
  </tbody>
</table>

<p>æ³¨ï¼šå¦‚ä½•è®¡ç®—å½“å‰æ‰“å¼€çš„è¿æ¥æ•°å ç”¨æœ€å¤§è¿æ¥æ•°çš„æ¯”ä¾‹å‘¢ï¼Ÿ</p>

<p>result=Threads_connected/max_connections,åœ¨åšç›‘æ§æŠ¥è­¦æˆ–å¯è§†åŒ–ç›‘æ§æ—¶èƒ½å¤Ÿå¾ˆå¥½çš„æ ¹æ®è¿™ä¸ªæ¯”ä¾‹åŠæ—¶è°ƒæ•´æœ€å¤§è¿æ¥æ•°ã€‚</p>

<p>2.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§</p>

<p>a.QPS:æ¯ç§’çš„æŸ¥è¯¢æ•°</p>

<p>QPSè®¡ç®—æ–¹æ³•</p>

<p>Questions = SHOW GLOBAL STATUS LIKE â€˜Questionsâ€™;</p>

<p>Uptime = SHOW GLOBAL STATUS LIKE â€˜Uptimeâ€™;</p>

<p>QPS=Questions/Uptime</p>

<p>b.TPS:æ¯ç§’çš„äº‹ç‰©é‡ï¼ˆcommitä¸rollbackçš„ä¹‹å’Œï¼‰</p>

<p>TPSè®¡ç®—æ–¹æ³•</p>

<p>Com_commit = SHOW GLOBAL STATUS LIKE â€˜Com_commitâ€™;</p>

<p>Com_rollback = SHOW GLOBAL STATUS LIKE â€˜Com_rollbackâ€™;</p>

<p>Uptime = SHOW GLOBAL STATUS LIKE â€˜Uptimeâ€™;</p>

<p>TPS=(Com_commit + Com_rollback)/Uptime</p>

<p>2.3 æ•°æ®åº“å¹¶å‘è¯·æ±‚æ•°é‡</p>

<p>MariaDB [(none)]&gt; SHOW GLOBAL STATUS LIKE â€˜Threads_runningâ€™;</p>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<table>
  <tbody>
    <tr>
      <td>Variable_name</td>
      <td>Value</td>
    </tr>
  </tbody>
</table>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<table>
  <tbody>
    <tr>
      <td>Threads_running</td>
      <td>3</td>
    </tr>
  </tbody>
</table>

<p>+â€”â€”â€”â€”â€”â€“+â€”â€”-+</p>

<p>1 row in set (0.00 sec)</p>

<p>æ³¨ï¼šå¹¶å‘è¯·æ±‚æ•°é‡é€šå¸¸ä¼šè¿œå°äºåŒä¸€æ—¶é—´å†…è¿æ¥åˆ°æ•°æ®åº“çš„è¿æ¥æ•°æ•°é‡ã€‚</p>

<p>2.4 ç›‘æ§innodbé˜»å¡æƒ…å†µ</p>

<p>a. innodb</p>

<p>ä¸‰ã€å¯¹ä¸»ä»å¤åˆ¶è¿›è¡Œç›‘æ§</p>

<p>3.1 ä¸»ä»å¤åˆ¶é“¾è·¯çŠ¶æ€çš„ç›‘æ§</p>

<p>3.2 ä¸»ä»å¤åˆ¶å»¶è¿Ÿæ—¶é—´çš„ç›‘æ§</p>

<p>3.3 å®šæœŸç¡®è®¤ä¸»ä»å¤åˆ¶çš„æ•°æ®æ˜¯å¦ä¸€è‡´</p>

<p>https://www.cnblogs.com/wwcom123/p/10759494.html</p>

:ET