I"Á†<p>åœ¨çº¿æ•°æ®åº“çš„ç»´æŠ¤ä¸­ï¼Œæ€»ä¼šæ¶‰åŠåˆ°ç ”å‘ä¿®æ”¹è¡¨ç»“æ„çš„æƒ…å†µï¼Œä¿®æ”¹ä¸€äº›å°è¡¨å½±å“å¾ˆå°ï¼Œè€Œä¿®æ”¹å¤§è¡¨æ—¶ï¼Œå¾€å¾€å½±å“ä¸šåŠ¡çš„æ­£å¸¸è¿è½¬ï¼Œå¦‚è¡¨æ•°æ®é‡è¶…è¿‡500Wï¼Œ1000Wï¼Œç”šè‡³è¿‡äº¿æ—¶</p>

<p>åœ¨çº¿ä¿®æ”¹å¤§è¡¨çš„å¯èƒ½å½±å“
åœ¨çº¿ä¿®æ”¹å¤§è¡¨çš„è¡¨ç»“æ„æ‰§è¡Œæ—¶é—´å¾€å¾€ä¸å¯é¢„ä¼°ï¼Œä¸€èˆ¬æ—¶é—´è¾ƒé•¿
ç”±äºä¿®æ”¹è¡¨ç»“æ„æ˜¯è¡¨çº§é”ï¼Œå› æ­¤åœ¨ä¿®æ”¹è¡¨ç»“æ„æ—¶ï¼Œå½±å“è¡¨å†™å…¥æ“ä½œ
å¦‚æœé•¿æ—¶é—´çš„ä¿®æ”¹è¡¨ç»“æ„ï¼Œä¸­é€”ä¿®æ”¹å¤±è´¥ï¼Œç”±äºä¿®æ”¹è¡¨ç»“æ„æ˜¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå› æ­¤å¤±è´¥åä¼šè¿˜åŸè¡¨ç»“æ„ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è¡¨éƒ½æ˜¯é”ç€ä¸å¯å†™å…¥
ä¿®æ”¹å¤§è¡¨ç»“æ„å®¹æ˜“å¯¼è‡´æ•°æ®åº“CPUã€IOç­‰æ€§èƒ½æ¶ˆè€—ï¼Œä½¿MySQLæœåŠ¡å™¨æ€§èƒ½é™ä½
åœ¨çº¿ä¿®æ”¹å¤§è¡¨ç»“æ„å®¹æ˜“å¯¼è‡´ä¸»ä»å»¶æ—¶ï¼Œä»è€Œå½±å“ä¸šåŠ¡è¯»å–
pt-online-schema-changeä»‹ç»
pt-online-schema-changeæ˜¯perconaå…¬å¸å¼€å‘çš„ä¸€ä¸ªå·¥å…·ï¼Œåœ¨percona-toolkitåŒ…é‡Œé¢å¯ä»¥æ‰¾åˆ°è¿™ä¸ªåŠŸèƒ½ï¼Œå®ƒå¯ä»¥åœ¨çº¿ä¿®æ”¹è¡¨ç»“æ„</p>

<p>åŸç†:</p>

<p>é¦–å…ˆå®ƒä¼šæ–°å»ºä¸€å¼ ä¸€æ¨¡ä¸€æ ·çš„è¡¨ï¼Œè¡¨åä¸€èˆ¬æ˜¯_newåç¼€
ç„¶ååœ¨è¿™ä¸ªæ–°è¡¨æ‰§è¡Œæ›´æ”¹å­—æ®µæ“ä½œ
ç„¶ååœ¨åŸè¡¨ä¸ŠåŠ ä¸‰ä¸ªè§¦å‘å™¨ï¼ŒDELETE/UPDATE/INSERTï¼Œå°†åŸè¡¨ä¸­è¦æ‰§è¡Œçš„è¯­å¥ä¹Ÿåœ¨æ–°è¡¨ä¸­æ‰§è¡Œ
æœ€åå°†åŸè¡¨çš„æ•°æ®æ‹·è´åˆ°æ–°è¡¨ä¸­ï¼Œç„¶åæ›¿æ¢æ‰åŸè¡¨
ä½¿ç”¨pt-online-schema-changeæ‰§è¡ŒSQLçš„æ—¥å¿—
SQLè¯­å¥:
ALTER TABLE tmp_task_user ADD support tinyint(1) unsigned NOT NULL DEFAULT â€˜1â€™;</p>

<p>sh pt.sh tmp_task_user â€œADD COLUMN support tinyint(1) unsigned NOT NULL DEFAULT â€˜1â€™â€</p>

<p>tmp_task_user
ADD COLUMN support tinyint(1) unsigned NOT NULL DEFAULT â€˜1â€™
No slaves found.  See â€“recursion-method if host h=127.0.0.1,P=3306 has slaves.
Not checking slave lag because no slaves were found and â€“check-slave-lag was not specified.
Operation, tries, wait:
  analyze_table, 10, 1
  copy_rows, 10, 0.25
  create_triggers, 10, 1
  drop_triggers, 10, 1
  swap_tables, 10, 1
  update_foreign_keys, 10, 1
Altering <code class="language-plaintext highlighter-rouge">test_db</code>.<code class="language-plaintext highlighter-rouge">tmp_task_user</code>â€¦
Creating new tableâ€¦
Created new table test_db._tmp_task_user_new OK.
Altering new tableâ€¦
Altered <code class="language-plaintext highlighter-rouge">test_db</code>.<code class="language-plaintext highlighter-rouge">_tmp_task_user_new</code> OK.
2018-05-14T18:14:21 Creating triggersâ€¦
2018-05-14T18:14:21 Created triggers OK.
2018-05-14T18:14:21 Copying approximately 6 rowsâ€¦
2018-05-14T18:14:21 Copied rows OK.
2018-05-14T18:14:21 Analyzing new tableâ€¦
2018-05-14T18:14:21 Swapping tablesâ€¦
2018-05-14T18:14:21 Swapped original and new tables OK.
2018-05-14T18:14:21 Dropping old tableâ€¦
2018-05-14T18:14:21 Dropped old table <code class="language-plaintext highlighter-rouge">test_db</code>.<code class="language-plaintext highlighter-rouge">_tmp_task_user_old</code> OK.
2018-05-14T18:14:21 Dropping triggersâ€¦
2018-05-14T18:14:21 Dropped triggers OK.
Successfully altered <code class="language-plaintext highlighter-rouge">test_db</code>.<code class="language-plaintext highlighter-rouge">tmp_task_user</code>.
å¥½å¤„:</p>

<p>é™ä½ä¸»ä»å»¶æ—¶çš„é£é™©
å¯ä»¥é™é€Ÿã€é™èµ„æºï¼Œé¿å…æ“ä½œæ—¶MySQLè´Ÿè½½è¿‡é«˜
å»ºè®®:</p>

<p>åœ¨ä¸šåŠ¡ä½å³°æœŸåšï¼Œå°†å½±å“é™åˆ°æœ€ä½
<!-- more -->
pt-online-schema-changeå®‰è£…
1.å»å®˜ç½‘ä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼Œå®˜ç½‘ä¸‹è½½åœ°å€:https://www.percona.com/downlâ€¦</p>

<p>2.ä¸‹è½½è§£å‹ä¹‹åå°±å¯ä»¥çœ‹åˆ°pt-online-schema-change</p>

<p>clipboard.png</p>

<p>3.è¯¥å·¥å…·éœ€è¦ä¸€äº›ä¾èµ–åŒ…ï¼Œç›´æ¥æ‰§è¡Œä¸æˆåŠŸæ—¶ä¸€èˆ¬ä¼šæœ‰æç¤ºï¼Œè¿™é‡Œå¯ä»¥æå‰yumå®‰è£…</p>

<p>yum install perl-DBI
yum install perl-DBD-MySQL
yum install perl-Time-HiRes
yum install perl-IO-Socket-SSL
pt-online-schema-changeä½¿ç”¨
1.å‚æ•°
./bin/pt-online-schema-change â€“help å¯ä»¥æŸ¥çœ‹å‚æ•°çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬åªæ˜¯è¦ä¿®æ”¹ä¸ªè¡¨ç»“æ„ï¼Œåªéœ€è¦çŸ¥é“å‡ ä¸ªç®€å•çš„å‚æ•°å°±å¯ä»¥äº†</p>

<p>â€“user=        è¿æ¥mysqlçš„ç”¨æˆ·å
â€“password=    è¿æ¥mysqlçš„å¯†ç 
â€“host=        è¿æ¥mysqlçš„åœ°å€
P=3306         è¿æ¥mysqlçš„ç«¯å£å·
D=             è¿æ¥mysqlçš„åº“å
t=             è¿æ¥mysqlçš„è¡¨å
â€“alter        ä¿®æ”¹è¡¨ç»“æ„çš„è¯­å¥
â€“execute      æ‰§è¡Œä¿®æ”¹è¡¨ç»“æ„
â€“charset=utf8 ä½¿ç”¨utf8ç¼–ç ï¼Œé¿å…ä¸­æ–‡ä¹±ç 
â€“no-version-check  ä¸æ£€æŸ¥ç‰ˆæœ¬ï¼Œåœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸­ä¸€èˆ¬åŠ å…¥æ­¤å‚æ•°ï¼Œå¦åˆ™ä¼šæŠ¥é”™
2.ä¸ºé¿å…æ¯æ¬¡éƒ½è¦è¾“å…¥ä¸€å †å‚æ•°ï¼Œå†™ä¸ªè„šæœ¬å¤ç”¨ä¸€ä¸‹ï¼Œpt.sh</p>

<p>#!/bin/bash
table=$1
alter_conment=$2</p>

<p>cnn_host=â€™127.0.0.1â€™
cnn_user=â€™userâ€™
cnn_pwd=â€™passwordâ€™
cnn_db=â€™database_nameâ€™</p>

<p>echo â€œ$tableâ€
echo â€œ$alter_conmentâ€
/root/percona-toolkit-2.2.19/bin/pt-online-schema-change â€“charset=utf8 â€“no-version-check â€“user=${cnn_user} â€“password=${cnn_pwd} â€“host=${cnn_host}  P=3306,D=${cnn_db},t=$table â€“alter 
â€œ${alter_conment}â€ â€“execute
3.æ·»åŠ è¡¨å­—æ®µ
å¦‚æ·»åŠ è¡¨å­—æ®µSQLè¯­å¥ä¸º:
ALTER TABLE tb_test ADD COLUMN column1 tinyint(4) DEFAULT NULL;
é‚£ä¹ˆä½¿ç”¨pt-online-schema-changeåˆ™å¯ä»¥è¿™æ ·å†™
sh pt.sh tb_test â€œADD COLUMN column1 tinyint(4) DEFAULT NULLâ€</p>

<p>4.ä¿®æ”¹è¡¨å­—æ®µ
SQLè¯­å¥ï¼š
ALTER TABLE tb_test MODIFY COLUMN num int(11) unsigned NOT NULL DEFAULT â€˜0â€™;</p>

<p>pt-online-schema-changeå·¥å…·:
sh pt.sh tb_test â€œMODIFY COLUMN num int(11) unsigned NOT NULL DEFAULT â€˜0â€™â€</p>

<p>5.ä¿®æ”¹è¡¨å­—æ®µå
SQLè¯­å¥:
ALTER TABLE tb_test CHANGE COLUMN age adress varchar(30);</p>

<p>pt-online-schema-changeå·¥å…·:
sh pt.sh tb_test â€œCHANGE COLUMN age address varchar(30)â€</p>

<p>6.æ·»åŠ ç´¢å¼•
SQLè¯­å¥:
ALTER TABLE tb_test ADD INDEX idx_address(address);
pt-online-schema-changeå·¥å…·:
sh pt.sh tb_test â€œADD INDEX idx_address(address)â€</p>

<p>å…¶ä»–
pt-online-schema-changeå·¥å…·è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å‚æ•°ï¼Œå¯ä»¥æœ‰å¾ˆå¤šé™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶CPUã€çº¿ç¨‹æ•°é‡ã€ä»åº“çŠ¶æ€ç­‰ç­‰ï¼Œä¸è¿‡æˆ‘åšè¿‡ä¸€ä¸ªè¶…è¿‡6000Wè¡¨çš„ç»“æ„ä¿®æ”¹ï¼Œå‘ç°å‡ ä¹ä¸å½±å“æ€§èƒ½ï¼Œå¾ˆç¨³å®šå¾ˆæµç•…çš„å°±ä¿®æ”¹äº†è¡¨ç»“æ„ï¼Œæ‰€ä»¥ï¼Œå¯¹ä»¥ä¸Šå¸¸è§„å‚æ•°çš„ä½¿ç”¨åŸºæœ¬èƒ½æ»¡è¶³ä¸šåŠ¡
ä¸€å®šè¦åœ¨ä¸šåŠ¡ä½å³°æœŸåšï¼Œè¿™æ ·æ‰èƒ½ç¡®ä¿ä¸‡æ— ä¸€å¤±</p>

<p>MySQL ddl çš„é—®é¢˜ç°çŠ¶</p>

<p>åœ¨ è¿ç»´mysqlæ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬æ€»ä¼šå¯¹æ•°æ®è¡¨è¿›è¡Œddl å˜æ›´ï¼Œä¿®æ”¹æ·»åŠ å­—æ®µæˆ–è€…ç´¢å¼•ï¼Œå¯¹äºmysql è€Œå·²ï¼Œddl æ˜¾ç„¶æ˜¯ä¸€ä¸ªä»¤æ‰€æœ‰MySQL dba è¯Ÿç—…çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºåœ¨MySQLä¸­åœ¨å¯¹è¡¨è¿›è¡Œddlæ—¶ï¼Œä¼šé”è¡¨ï¼Œå½“è¡¨æ¯”è¾ƒå°æ¯”å¦‚å°äº1wä¸Šæ—¶ï¼Œå¯¹å‰ç«¯å½±å“è¾ƒå°ï¼Œå½“æ—¶é‡åˆ°åƒä¸‡çº§åˆ«çš„è¡¨ å°±ä¼šå½±å“å‰ç«¯åº”ç”¨å¯¹è¡¨çš„å†™æ“ä½œã€‚</p>

<p>å·¥ä½œåŸç†ï¼š</p>

<p>1ã€å¦‚æœå­˜åœ¨å¤–é”®ï¼Œæ ¹æ®alter-foreign-keys-methodå‚æ•°çš„å€¼ï¼Œæ£€æµ‹å¤–é”®ç›¸å…³çš„è¡¨ï¼Œåšç›¸åº”è®¾ç½®çš„å¤„ç†ã€‚æ²¡æœ‰ä½¿ç”¨ â€“alter-foreign-keys-method=rebuild_constraints æŒ‡å®šç‰¹å®šçš„å€¼ï¼Œè¯¥å·¥å…·ä¸äºˆæ‰§è¡Œ
2ã€åˆ›å»ºä¸€ä¸ªå’Œæºè¡¨è¡¨ç»“æ„ä¸€æ ·çš„ä¸´æ—¶è¡¨(_tablename_new)ï¼Œæ‰§è¡Œalterä¿®æ”¹ä¸´æ—¶è¡¨è¡¨ç»“æ„ã€‚
3ã€åœ¨åŸè¡¨ä¸Šåˆ›å»º3ä¸ªäºinser delete updateå¯¹åº”çš„è§¦å‘å™¨. ï¼ˆç”¨äºcopy æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œåœ¨åŸè¡¨çš„æ›´æ–°æ“ä½œ æ›´æ–°åˆ°æ–°è¡¨.ï¼‰</p>

<p>4ã€ä»åŸè¡¨æ‹·è´æ•°æ®åˆ°ä¸´æ—¶è¡¨ï¼Œæ‹·è´è¿‡ç¨‹ä¸­åœ¨åŸè¡¨è¿›è¡Œçš„å†™æ“ä½œéƒ½ä¼šæ›´æ–°åˆ°æ–°å»ºçš„ä¸´æ—¶è¡¨
5ã€ä¿®æ”¹å¤–é”®ç›¸å…³çš„å­è¡¨ï¼Œæ ¹æ®ä¿®æ”¹åçš„æ•°æ®ï¼Œä¿®æ”¹å¤–é”®å…³è”çš„å­è¡¨ã€‚
6ã€renameæºæ•°æ®è¡¨ä¸ºoldè¡¨ï¼ŒæŠŠæ–°è¡¨renameä¸ºæºè¡¨åï¼Œå¹¶å°†oldè¡¨åˆ é™¤ã€‚
7ã€åˆ é™¤è§¦å‘å™¨ã€‚</p>

<p>æ‰§è¡Œæ¡ä»¶ï¼š</p>

<p>1ï¼æ“ä½œçš„è¡¨å¿…é¡»æœ‰ä¸»é”®æˆ–åˆ™å”¯ä¸€ç´¢å¼•ï¼Œå¦åˆ™æŠ¥å¦‚ä¸‹é”™è¯¯ã€‚</p>

<p>Cannot chunk the original table <code class="language-plaintext highlighter-rouge">test</code>.<code class="language-plaintext highlighter-rouge">t_driver_allowance_test</code>: There is no good index and the table is oversized. at /usr/local/bin/pt-online-schema-change line 5486.</p>

<p>2 . è¯¥è¡¨ä¸èƒ½å®šä¹‰è§¦å‘å™¨ï¼Œå¦åˆ™æŠ¥å¦‚ä¸‹é”™è¯¯ã€‚</p>

<p>The table <code class="language-plaintext highlighter-rouge">taotao</code>.<code class="language-plaintext highlighter-rouge">tttt</code> has triggers.  This tool needs to create its own triggers, so the table cannot already have triggers.</p>

<p>ç”¨æ³•ä»‹ç»ï¼š</p>

<p>pt-online-schema-change â€“help  æŸ¥çœ‹å‚æ•°é€‰é¡¹</p>

<p>è¿™é‡Œæœ‰å‡ ä¸ªå‚æ•°éœ€è¦ä»‹ç»ä¸€ä¸‹ï¼š</p>

<p>â€“dry-run  è¿™ä¸ªå‚æ•°ä¸å»ºç«‹è§¦å‘å™¨ï¼Œä¸æ‹·è´æ•°æ®ï¼Œä¹Ÿä¸ä¼šæ›¿æ¢åŸè¡¨ã€‚åªæ˜¯åˆ›å»ºå’Œæ›´æ”¹æ–°è¡¨ã€‚</p>

<p>â€“execute  è¿™ä¸ªå‚æ•°çš„ä½œç”¨å’Œå‰é¢å·¥ä½œåŸç†çš„ä»‹ç»çš„ä¸€æ ·ï¼Œä¼šå»ºç«‹è§¦å‘å™¨ï¼Œæ¥ä¿è¯æœ€æ–°å˜æ›´çš„æ•°æ®ä¼šå½±å“è‡³æ–°è¡¨ã€‚æ³¨æ„ï¼šå¦‚æœä¸åŠ è¿™ä¸ªå‚æ•°ï¼Œè¿™ä¸ªå·¥å…·ä¼šåœ¨æ‰§è¡Œä¸€äº›æ£€æŸ¥åé€€å‡ºã€‚</p>

<p>â€“critical-load  æ¯æ¬¡chunkæ“ä½œå‰åï¼Œä¼šæ ¹æ®show global statusç»Ÿè®¡æŒ‡å®šçš„çŠ¶æ€é‡çš„å˜åŒ–ï¼Œé»˜è®¤æ˜¯ç»Ÿè®¡Thread_runningã€‚ç›®çš„æ˜¯ä¸ºäº†å®‰å…¨ï¼Œé˜²æ­¢åŸå§‹è¡¨ä¸Šçš„è§¦å‘å™¨å¼•èµ·è´Ÿè½½è¿‡é«˜ã€‚è¿™ä¹Ÿæ˜¯ä¸ºäº†é˜²æ­¢åœ¨çº¿DDLå¯¹çº¿ä¸Šçš„å½±å“ã€‚è¶…è¿‡è®¾ç½®çš„é˜€å€¼ï¼Œå°±ä¼šç»ˆæ­¢æ“ä½œï¼Œåœ¨çº¿DDLå°±ä¼šä¸­æ–­ã€‚æç¤ºçš„å¼‚å¸¸å¦‚ä¸ŠæŠ¥é”™ä¿¡æ¯ã€‚</p>

<p>â€“max-load é€‰é¡¹å®šä¹‰ä¸€ä¸ªé˜€å€¼ï¼Œåœ¨æ¯æ¬¡chunkæ“ä½œåï¼ŒæŸ¥çœ‹show global statusçŠ¶æ€å€¼æ˜¯å¦é«˜äºæŒ‡å®šçš„é˜€å€¼ã€‚è¯¥å‚æ•°æ¥å—ä¸€ä¸ªmysql statusçŠ¶æ€å˜é‡ä»¥åŠä¸€ä¸ªé˜€å€¼ï¼Œå¦‚æœæ²¡æœ‰ç»™å®šé˜€å€¼ï¼Œåˆ™å®šä¹‰ä¸€ä¸ªé˜€å€¼ä¸ºä¸ºé«˜äºå½“å‰å€¼çš„20%ã€‚æ³¨æ„è¿™ä¸ªå‚æ•°ä¸ä¼šåƒâ€“critical-loadç»ˆæ­¢æ“ä½œï¼Œè€Œåªæ˜¯æš‚åœæ“ä½œã€‚å½“statuså€¼ä½äºé˜€å€¼æ—¶ï¼Œåˆ™ç»§ç»­å¾€ä¸‹æ“ä½œã€‚æ˜¯æš‚åœè¿˜æ˜¯ç»ˆæ­¢æ“ä½œè¿™æ˜¯â€“max-loadå’Œâ€“critical-loadçš„å·®åˆ«ã€‚</p>

<p>â€“charset=utf8è¿æ¥åˆ°MySQLåè¿è¡ŒSET NAMES UTF8</p>

<p>â€“check-replication-filters æ£€æŸ¥å¤åˆ¶ä¸­æ˜¯å¦è®¾ç½®äº†è¿‡æ»¤æ¡ä»¶ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œç¨‹åºå°†é€€å‡º</p>

<p>â€“nocheck-replication-filters ä¸æ£€æŸ¥å¤åˆ¶ä¸­æ˜¯å¦è®¾ç½®äº†è¿‡æ»¤æ¡ä»¶</p>

<p>â€“set-vars è®¾ç½®mysqlçš„å˜é‡å€¼</p>

<p>â€“check-slave-lag æ£€æŸ¥ä¸»ä»å»¶è¿Ÿ</p>

<p>ä¾‹å­ï¼š</p>

<p>æ·»åŠ å­—æ®µ
pt-online-schema-change -u root  -p 123456  â€“alter=â€™add column vid int â€˜ â€“execute D=taotao,t=tttt â€“max-load=Threads_connected:650 â€“critical-load=Threads_running=550 â€“charset=utf8  â€“nocheck-replication-filters â€“set-vars innodb_lock_wait_timeout=30000</p>

<p>åˆ é™¤å­—æ®µ
pt-online-schema-change -u root  -p 123456  â€“alter=â€™drop column vid  â€˜  â€“execute D=taotao,t=tttt â€“max-load=Threads_connected:650 â€“critical-load=Threads_running=550 â€“charset=utf8  â€“nocheck-replication-filters â€“set-vars innodb_lock_wait_timeout=30000</p>

<p>ä¿®æ”¹å­—æ®µ
pt-online-schema-change -u root  -p 123456  â€“alter=â€™modify  column sid bigint(25) â€˜  â€“execute D=taotao,t=tttt â€“max-load=Threads_connected:650 â€“critical-load=Threads_running=550 â€“charset=utf8  â€“nocheck-replication-filters â€“set-vars innodb_lock_wait_timeout=30000</p>

<p>æ·»åŠ ç´¢å¼•
pt-online-schema-change -u root  -p 123456  â€“alter=â€™ add key indx_sid(sid) â€˜  â€“execute D=taotao,t=tttt â€“max-load=Threads_connected:650 â€“critical-load=Threads_running=550 â€“charset=utf8  â€“nocheck-replication-filters â€“set-vars innodb_lock_wait_timeout=30000</p>

<p>åˆ é™¤ç´¢å¼•
pt-online-schema-change -u root  -p 123456  â€“alter=â€™ drop  key indx_sid â€˜  â€“execute D=taotao,t=tttt â€“max-load=Threads_connected:650 â€“critical-load=Threads_running=550 â€“charset=utf8  â€“nocheck-replication-filters â€“set-vars innodb_lock_wait_timeout=30000</p>

<p>pt-online-schema-change â€“user=dba_user â€“password=msds007 -S /app/mysqldata/3306/mysql.sock  â€“charset=utf8 â€“no-check-replication-filters â€“alter â€œmodify HomeworkID bigint(20) AUTO_INCREMENTâ€ â€“no-drop-old-table D=test,t=wx_edu_homework â€“alter-foreign-keys-method=rebuild_constraints â€“print â€“execute</p>

<p>è€ƒè™‘ä»åº“å»¶è¿Ÿæƒ…å†µ ï¼Œæ„å‘³è¿™è¦æ³¨æ„è¿™å‡ ä¸ªé€‰é¡¹çš„è®¾ç½®</p>

<p>â€“max-lag
â€“check-interval
â€“recursion-method
â€“check-slave-lag</p>

<p>pt-online-schema-change â€“user=dba_user â€“password=msds007 -S /app/mysqldata/3306/mysql.sock  â€“charset=utf8 â€“no-check-replication-filters â€“alter â€œmodify HomeworkID bigint(20) AUTO_INCREMENTâ€ â€“no-drop-old-table D=test,t=wx_edu_homework â€“alter-foreign-keys-method=rebuild_constraints â€“print â€“execute â€“max-lag=1s â€“check-interval=10s â€“check-slave-lag=h=192.168.1.121,u=root,p=msds007,P=3306</p>

<p>pt-online-schema-change â€“user=dba_user â€“password=msds007 -S /app/mysqldata/3306/mysql.sock  â€“charset=utf8 â€“no-check-replication-filters â€“alter â€œmodify HomeworkID bigint(20) AUTO_INCREMENTâ€ â€“no-drop-old-table D=test,t=wx_edu_homework â€“alter-foreign-keys-method=rebuild_constraints â€“print â€“execute â€“max-lag=1s â€“check-interval=10s â€“recursion-method=processlist</p>

<p>æµç¨‹ï¼š</p>

<p>1.åˆ¤æ–­å„ç§å‚æ•°</p>

<p>2.æ ¹æ®åŸè¡¨â€tâ€,åˆ›å»ºä¸€ä¸ªåç§°ä¸ºâ€_t_newâ€çš„æ–°è¡¨</p>

<p>3.æ‰§è¡ŒALTER TABLEè¯­å¥ä¿®æ”¹æ–°è¡¨â€_t_newâ€</p>

<p>4.åˆ›å»º3ä¸ªè§¦å‘å™¨,åç§°æ ¼å¼ä¸ºpt_osc_åº“å_è¡¨å_æ“ä½œç±»å‹,æ¯”å¦‚</p>

<p>CREATE TRIGGER <code class="language-plaintext highlighter-rouge">pt_osc_dba_t_del</code> AFTER DELETE ON <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">t</code> FOR EACH ROW DELETE IGNORE FROM <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">_t_new</code> WHERE <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">_t_new</code>.<code class="language-plaintext highlighter-rouge">id</code> &lt;=&gt; OLD.<code class="language-plaintext highlighter-rouge">id</code></p>

<p>CREATE TRIGGER <code class="language-plaintext highlighter-rouge">pt_osc_dba_t_upd</code> AFTER UPDATE ON <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">t</code> FOR EACH ROW REPLACE INTO <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">_t_new</code> (<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, <code class="language-plaintext highlighter-rouge">c1</code>) VALUES (NEW.<code class="language-plaintext highlighter-rouge">id</code>, NEW.<code class="language-plaintext highlighter-rouge">a</code>, NEW.<code class="language-plaintext highlighter-rouge">b</code>, NEW.<code class="language-plaintext highlighter-rouge">c1</code>)</p>

<p>CREATE TRIGGER <code class="language-plaintext highlighter-rouge">pt_osc_dba_t_ins</code> AFTER INSERT ON <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">t</code> FOR EACH ROW REPLACE INTO <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">_t_new</code> (<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, <code class="language-plaintext highlighter-rouge">c1</code>) VALUES (NEW.<code class="language-plaintext highlighter-rouge">id</code>, NEW.<code class="language-plaintext highlighter-rouge">a</code>, NEW.<code class="language-plaintext highlighter-rouge">b</code>, NEW.<code class="language-plaintext highlighter-rouge">c1</code>)</p>

<p>5.å¼€å§‹å¤åˆ¶æ•°æ®,æ¯”å¦‚</p>

<p>INSERT LOW_PRIORITY IGNORE INTO <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">_t_new</code> (<code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, <code class="language-plaintext highlighter-rouge">c1</code>) SELECT <code class="language-plaintext highlighter-rouge">id</code>, <code class="language-plaintext highlighter-rouge">a</code>, <code class="language-plaintext highlighter-rouge">b</code>, <code class="language-plaintext highlighter-rouge">c1</code> FROM <code class="language-plaintext highlighter-rouge">dba</code>.<code class="language-plaintext highlighter-rouge">t</code> LOCK IN SHARE MODE /<em>pt-online-schema-change 28014 copy table</em>/</p>

<p>æ³¨æ„ï¼šå¯¹åŸè¡¨åŠ å…±äº«é”ï¼Œä¼šé˜»å¡æ‰€æœ‰æ’ä»–é”</p>

<p>6.å¤åˆ¶å®Œæˆå,äº¤äº’åŸè¡¨å’Œæ–°è¡¨,æ‰§è¡ŒRENAMEå‘½ä»¤,å¦‚ RENAME TABLE t to _t_old, _t_new to t;</p>

<p>7.åˆ é™¤è€è¡¨,_t_old</p>

<p>8.åˆ é™¤è§¦å‘å™¨</p>

<p>9.ä¿®æ”¹å®Œæˆ</p>

<p>æ³¨æ„ï¼šå¦‚æœå¼‚å¸¸ç»ˆæ­¢ç¨‹åºï¼Œè§¦å‘å™¨ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœè¦åˆ é™¤æ–°è¡¨ï¼Œé‚£ä¹ˆè¦å…ˆåˆ é™¤è§¦å‘å™¨ï¼Œå¦åˆ™å‘è€è¡¨æ’å…¥æ•°æ®ä¼šå› ä¸ºæ‰¾ä¸åˆ°æ–°è¡¨è€ŒæŠ¥é”™</p>

<p>æ³¨æ„äº‹é¡¹ï¼š</p>

<p>pt-online-schema-change åœ¨çº¿DDLå·¥å…·ï¼Œè™½ç„¶è¯´ä¸ä¼šé”è¡¨ï¼Œä½†æ˜¯å¯¹æ€§èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„å½±å“ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹å…¨è¡¨åšä¸€æ¬¡selectã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šå°†buffer_cacheä¸­æ´»è·ƒæ•°æ®å…¨éƒ¨äº¤æ¢ä¸€éï¼Œè¿™å°±å¯¼è‡´æ´»è·ƒæ•°æ®çš„è¯·æ±‚éƒ½è¦ä»ç£ç›˜è·å–ï¼Œå¯¼è‡´æ…¢SQLå¢å¤šï¼Œfile_readså¢å¤§ã€‚æ‰€ä»¥å¯¹äºå¤§è¡¨åº”åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œè¯¥æ“ä½œ
æ‰§è¡Œ RENAME æ—¶ï¼Œä½ ä¸èƒ½æœ‰ä»»ä½•é”å®šçš„è¡¨æˆ–æ´»åŠ¨çš„äº‹åŠ¡ã€‚ä½ åŒæ ·ä¹Ÿå¿…é¡»æœ‰å¯¹åŸåˆè¡¨çš„ ALTER å’Œ DROP æƒé™ï¼Œä»¥åŠå¯¹æ–°è¡¨çš„ CREATE å’Œ INSERT æƒé™ã€‚å½“ä¸šåŠ¡é‡è¾ƒå¤§æ—¶ï¼Œä¿®æ”¹æ“ä½œä¼šç­‰å¾…æ²¡æœ‰æ•°æ®ä¿®æ”¹åï¼Œæ‰§è¡Œæœ€åçš„renameæ“ä½œã€‚å› æ­¤ï¼Œåœ¨ä¿®æ”¹è¡¨ç»“æ„æ—¶ï¼Œåº”è¯¥å°½é‡é€‰æ‹©åœ¨ä¸šåŠ¡ç›¸å¯¹ç©ºé—²æ—¶ï¼Œè‡³å°‘ä¿®æ”¹è¡¨ä¸Šçš„æ•°æ®æ“ä½œè¾ƒä½æ—¶ï¼Œæ‰§è¡Œè¾ƒä¸ºå¦¥å½“ã€‚å¦‚æœåœ¨å¤šè¡¨æ›´åä¸­ï¼ŒMySQL é­é‡åˆ°ä»»ä½•é”™è¯¯ï¼Œå®ƒå°†å¯¹æ‰€æœ‰è¢«æ›´åçš„è¡¨è¿›è¡Œå€’é€€æ›´åï¼Œå°†æ¯ä»¶äº‹ç‰©é€€å›åˆ°æœ€åˆçŠ¶æ€ã€‚
å¯¹è¡¨çš„æ…¢æŸ¥è¯¢æ“ä½œï¼Œæ…¢æŸ¥è¯¢è¿˜æœªç»“æŸæ‰§è¡Œoscæ“ä½œï¼Œä¼šæŠ¥é”™ï¼Œè¶…æ—¶é”™è¯¯ï¼Œåœ¨åˆ›å»ºè§¦å‘å™¨çš„æ—¶å€™é€€å‡ºã€‚
å¯¹äºä¸»ä»å¤åˆ¶æ¶æ„ã€‚ è€ƒè™‘åˆ°ä¸»ä»çš„ä¸€è‡´æ€§ï¼Œåº”è¯¥åœ¨ä¸»åº“ä¸Šæ‰§è¡Œpt-online-schema-changeæ“ä½œã€‚
psï¼šå¦‚æœåœ¨è¯¯åœ¨ä»åº“ä¸Šæ‰§è¡Œäº†pt-online-schema-changeæ“ä½œï¼Œæœªæ‰§è¡Œå®Œæˆä¸è¦å–æ¶ˆï¼Œç­‰åˆ°æ‰§è¡Œå®Œæˆäº†ï¼Œåœ¨ä¿®æ”¹æˆåŸæ¥çš„çŠ¶æ€ã€‚</p>

<p>å¦‚æœåœ¨è¯¯åœ¨ä»åº“ä¸Šæ‰§è¡Œäº†pt-online-schema-changeæ“ä½œï¼Œæœªæ‰§è¡Œå®Œæˆå–æ¶ˆçš„è¯ï¼Œåˆ é™¤æœ‰ pt-online-schema-changeåœ¨ä»åº“ä¸Šåˆ›å»ºçš„ä¸´æ—¶è¡¨å’Œè§¦å‘å™¨å³å¯ã€‚</p>

<p>####################################################################</p>

<p>åœ¨åŸè¡¨ä¸Šå»ºç«‹ä¸‰ä¸ªè§¦å‘å™¨ï¼Œå¦‚ä¸‹ï¼š
ï¼ˆ1ï¼‰CREATETRIGGER mk_osc_del AFTER DELETE ON $table â€ â€œFOR EACH ROW â€
â€œDELETE IGNORE FROM $new_table â€œâ€WHERE$new_table.$chunk_column = OLD.$chunk_columnâ€;
ï¼ˆ2ï¼‰CREATETRIGGER mk_osc_ins AFTER INSERT ON $table â€ â€œFOR EACH ROW â€
â€œREPLACEINTO $new_table ($columns) â€ â€œVALUES($new_values)â€;
ï¼ˆ3ï¼‰CREATETRIGGER mk_osc_upd AFTER UPDATE ON $table â€ â€œFOR EACH ROW â€
â€œREPLACE INTO $new_table ($columns) â€œâ€VALUES ($new_values)â€;</p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸‰ä¸ªè§¦å‘å™¨åˆ†åˆ«å¯¹åº”äºINSERTã€UPDATEã€DELETEä¸‰ç§æ“ä½œï¼š
ï¼ˆ1ï¼‰mk_osc_delï¼ŒDELETEæ“ä½œï¼Œæˆ‘ä»¬æ³¨æ„åˆ°DELETEIGNOREï¼Œå½“æ–°æœ‰æ•°æ®æ—¶ï¼Œæˆ‘ä»¬æ‰è¿›è¡Œæ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“åœ¨åç»­å¯¼å…¥è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåˆ é™¤çš„è¿™ä¸ªæ•°æ®è¿˜æœªå¯¼å…¥åˆ°æ–°è¡¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä¸åœ¨æ–°è¡¨æ‰§è¡Œæ“ä½œï¼Œå› ä¸ºåœ¨ä»¥åçš„å¯¼å…¥è¿‡ç¨‹ä¸­ï¼ŒåŸè¡¨ä¸­æ”¹è¡Œæ•°æ®å·²ç»è¢«åˆ é™¤ï¼Œå·²ç»æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆä»–ä¹Ÿå°±ä¸ä¼šå¯¼å…¥åˆ°æ–°è¡¨ä¸­ï¼›
ï¼ˆ2ï¼‰mk_osc_insï¼ŒINSERTæ“ä½œï¼Œæ‰€æœ‰çš„INSERT INTOå…¨éƒ¨è½¬æ¢ä¸ºREPLACEINTOï¼Œä¸ºäº†ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå½“æœ‰æ–°æ•°æ®æ’å…¥åˆ°åŸè¡¨æ—¶ï¼Œå¦‚æœè§¦å‘å™¨è¿˜æœªæŠŠåŸè¡¨æ•°æ®æœªåŒæ­¥åˆ°æ–°è¡¨ï¼Œè¿™æ¡æ•°æ®å·²ç»è¢«å¯¼å…¥åˆ°æ–°è¡¨äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨replaceintoè¿›è¡Œè¦†ç›–ï¼Œè¿™æ ·æ•°æ®ä¹Ÿæ˜¯ä¸€è‡´çš„
ï¼ˆ3ï¼‰mk_osc_upd UPDATEæ“ä½œï¼Œæ‰€æœ‰çš„UPDATEä¹Ÿè½¬æ¢ä¸ºREPLACEINTOï¼Œå› ä¸ºå½“è·Ÿæ–°çš„æ•°æ®çš„è¡Œè¿˜æœªåŒæ­¥åˆ°æ–°è¡¨æ—¶ï¼Œæ–°è¡¨æ˜¯ä¸å­˜åœ¨è¿™æ¡è®°å½•çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åªèƒ½æ’å…¥è¯¥æ¡æ•°æ®ï¼Œå¦‚æœå·²ç»åŒæ­¥åˆ°æ–°è¡¨äº†ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥è¿›è¡Œè¦†ç›–æ’å…¥ï¼Œæ‰€æœ‰æ•°æ®ä¸åŸè¡¨ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼›
æˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºä¸Šè¿°çš„ç²¾é«“ä¹Ÿå°±è¿™è¿™å‡ æ¡replaceintoæ“ä½œï¼Œæ­£æ˜¯å› ä¸ºè¿™å‡ æ¡replaceintoæ‰èƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§
4ã€æ‹·è´åŸè¡¨æ•°æ®åˆ°ä¸´æ—¶è¡¨ä¸­ï¼Œåœ¨è„šæœ¬ä¸­ä½¿ç”¨å¦‚ä¸‹è¯­å¥
INSERT IGNORE INTO $to_table ($columns) â€ â€œSELECT $columns FROM $from_table â€œâ€WHERE ($chunks-&gt;[$chunkno])â€ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°ä»–æ˜¯é€šè¿‡ä¸€äº›æŸ¥è¯¢ï¼ˆåŸºæœ¬ä¸ºä¸»é”®ã€å”¯ä¸€é”®å€¼ï¼‰åˆ†æ‰¹æŠŠæ•°æ®å¯¼å…¥åˆ°æ–°çš„è¡¨ä¸­ï¼Œåœ¨å¯¼å…¥å‰ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡å‚æ•°â€“chunk-sizeå¯¹æ¯æ¬¡å¯¼å…¥è¡Œæ•°è¿›è¡Œæ§åˆ¶ï¼Œå·²å‡å°‘å¯¹åŸè¡¨çš„é”å®šæ—¶é—´ï¼Œå¹¶ä¸”åœ¨å¯¼å…¥æ—¶ï¼Œæˆ‘ä»¬èƒ½é€šè¿‡â€”sleepå‚æ•°æ§åˆ¶ï¼Œåœ¨æ¯ä¸ªchunkå¯¼å…¥åä¸ä¸‹ä¸€æ¬¡chunkå¯¼å…¥å¼€å§‹å‰sleepä¸€ä¼šï¼Œsleepæ—¶é—´è¶Šé•¿ï¼Œå¯¹äºç£ç›˜IOçš„å†²å‡»å°±è¶Šå°
5ã€Rename åŸè¡¨åˆ°oldè¡¨ä¸­ï¼Œåœ¨æŠŠä¸´æ—¶è¡¨Renameä¸ºåŸè¡¨ï¼Œ
â€œRENAME TABLE <code class="language-plaintext highlighter-rouge">$db</code>.<code class="language-plaintext highlighter-rouge">$tmp_tbl</code>TO <code class="language-plaintext highlighter-rouge">$db</code>.<code class="language-plaintext highlighter-rouge">$tbl</code>â€; åœ¨renameè¿‡ç¨‹ï¼Œå…¶å®æˆ‘ä»¬è¿˜æ˜¯ä¼šå¯¼è‡´å†™å…¥è¯»å–å µå¡çš„ï¼Œæ‰€ä»¥ä»ä¸¥æ ¼æ„æ€ä¸Šè¯´ï¼Œæˆ‘ä»¬çš„OSCä¹Ÿä¸æ˜¯å¯¹çº¿ä¸Šç¯å¢ƒæ²¡æœ‰ä¸€ç‚¹å½±å“ï¼Œä½†ç”±äºrenameæ“ä½œåªæ˜¯ä¸€ä¸ªä¿®æ”¹åå­—çš„è¿‡ç¨‹ï¼Œä¹Ÿåªä¼šä¿®æ”¹ä¸€äº›è¡¨çš„ä¿¡æ¯ï¼ŒåŸºæœ¬æ˜¯ç¬é—´ç»“æŸï¼Œæ•…å¯¹çº¿ä¸Šå½±å“ä¸å¤ªå¤§
6ã€æ¸…ç†ä»¥ä¸Šè¿‡ç¨‹ä¸­çš„ä¸å†ä½¿ç”¨çš„æ•°æ®ï¼Œå¦‚OLDè¡¨</p>

<p>https://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html</p>

<p>https://www.percona.com/downloads/percona-toolkit/LATEST/</p>

<p>https://www.percona.com/doc/percona-toolkit/3.0/pt-online-schema-change.html</p>

<p>https://www.percona.com/downloads/percona-toolkit/LATEST/</p>

<p>åœ¨è¿ç»´mysqlæ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬æ€»ä¼šå¯¹æ•°æ®è¡¨è¿›è¡Œddl å˜æ›´ï¼Œä¿®æ”¹æ·»åŠ å­—æ®µæˆ–è€…ç´¢å¼•ï¼Œå¯¹äºmysql è€Œå·²ï¼Œddl æ˜¾ç„¶æ˜¯ä¸€ä¸ªä»¤æ‰€æœ‰MySQL dba è¯Ÿç—…çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå› ä¸ºåœ¨MySQLä¸­åœ¨å¯¹è¡¨è¿›è¡Œddlæ—¶ï¼Œä¼šé”è¡¨ï¼Œå½“è¡¨æ¯”è¾ƒå°æ¯”å¦‚å°äº1wä¸Šæ—¶ï¼Œå¯¹å‰ç«¯å½±å“è¾ƒå°ï¼Œå½“æ—¶é‡åˆ°åƒä¸‡çº§åˆ«çš„è¡¨ å°±ä¼šå½±å“å‰ç«¯åº”ç”¨å¯¹è¡¨çš„å†™æ“ä½œã€‚</p>

<p>perconal æ¨å‡ºä¸€ä¸ªå·¥å…· pt-online-schema-change ï¼Œå…¶ç‰¹ç‚¹æ˜¯ä¿®æ”¹è¿‡ç¨‹ä¸­ä¸ä¼šé€ æˆè¯»å†™é˜»å¡ã€‚</p>

<p>åŸç†ï¼š</p>

<p>1.å»ºç«‹ä¸€ä¸ªä¸éœ€è¦æ“ä½œçš„è¡¨ç›¸åŒè¡¨ç»“æ„çš„ç©ºè¡¨</p>

<p>2.ç»™ç©ºè¡¨æ‰§è¡Œè¡¨ç»“æ„ä¿®æ”¹</p>

<p>3.åœ¨åŸè¡¨ä¸Šå¢åŠ delete/update/insertçš„after trigger</p>

<p>4.copyæ•°æ®åˆ°æ–°è¡¨</p>

<p>5.å°†åŸè¡¨æ”¹åï¼Œå¹¶å°†æ–°è¡¨æ”¹æˆåŸè¡¨å</p>

<p>6.åˆ é™¤åŸè¡¨</p>

<p>7.åˆ é™¤trigger</p>

<p>pt-oscé™åˆ¶æ¡ä»¶ï¼š</p>

<p>1.è¡¨è¦æœ‰ä¸»é”®ï¼Œå¦åˆ™ä¼šæŠ¥é”™;</p>

<p>2.è¡¨ä¸èƒ½æœ‰trigger;</p>

<p>ä½¿ç”¨æ–¹æ³•ï¼š</p>

<p>1.ä¸‹è½½</p>

<p>wget percona.com/get/percona-toolkit.tar.gz</p>

<p>2.å®‰è£…</p>

<p>tar -zxvf percona-toolkit.tar.gz</p>

<p>cd percona-toolkit-3.0.4</p>

<p>perl Makefile.PL</p>

<p>(è‹¥æ‰§è¡ŒMakefileå‡ºé”™ åˆ™éœ€å…ˆæ‰§è¡Œyum install perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker)</p>

<p>make</p>

<p>make test</p>

<p>make install</p>

<p>3.ä½¿ç”¨æ–¹æ³•</p>

<p>pt-online-schema-change â€“help å¯æŸ¥çœ‹å‚æ•°å¸®åŠ©</p>

<p>è‹¥æŸ¥çœ‹å‚æ•°æç¤ºCanâ€™t locate Digest/MD5.pm in @INCé”™è¯¯ åˆ™éœ€æ‰§è¡Œyum -y install perl-Digest-MD5å®‰è£…ç›¸å…³ç»„ä»¶</p>

<p>æç¤ºç¼ºå°‘perl-DBIæ¨¡å—ï¼Œé‚£ä¹ˆç›´æ¥ yum install perl-DBI</p>

<p>åœºæ™¯1ï¼šå¢åŠ åˆ—</p>

<p>pt-online-schema-change â€“host=192.168.0.0 -uroot -pyourpassword â€“alter â€œadd column age int(11) default nullâ€ D=test,t=â€™test_tbâ€™ â€“execute â€“print â€“statistics â€“no-check-alter</p>

<p>åœºæ™¯2ï¼šåˆ é™¤åˆ—</p>

<p>pt-online-schema-change â€“host=192.168.0.0 -uroot -pyourpassword â€“alter â€œdrop column ageâ€ D=test,t=â€™test_tbâ€™ â€“execute â€“print â€“statistics â€“no-check-alter</p>

<p>åœºæ™¯3ï¼šæ›´æ”¹åˆ—</p>

<p>pt-online-schema-change â€“host=192.168.0.0 -uroot -pyourpassword â€“alter â€œCHANGE id id_num int(20)â€ D=test,t=â€™test_tbâ€™ â€“execute â€“print â€“statistics â€“no-check-alter</p>

<p>åœºæ™¯4ï¼šåˆ›å»ºç´¢å¼•</p>

<p>pt-online-schema-change â€“host=192.168.0.0 -uroot -pyourpassword â€“alter â€œadd index indx_ukid(address_ukid)â€ D=test,t=â€™address_tbâ€™ â€“execute â€“print â€“statistics â€“no-check-alter</p>

<p>pt-online-schema-change æ˜¯ä»€ä¹ˆï¼Ÿ
pt-online-schema-changeæ˜¯Perconaå·¥å…·åŒ…çš„ä¸€å‘˜ï¼Œç”¨äºä¿®æ”¹è¡¨è€Œä¸ä¼šé€ æˆè¯»é”æˆ–è€…å†™é”ï¼›</p>

<p>pt-online-schema-changeè¯¦ç»†æè¿°ï¼š
pt-online-schema-changeå·¥ä½œåœ¨ä¸€ä¸ªå‰¯æœ¬ä¸Šï¼Œæ‰€ä»¥åŸè¡¨æ²¡æœ‰è¢«lockï¼Œclientå¯ä»¥ç»§ç»­è¿›è¡Œreadå’Œwriteæ“ä½œï¼›pt-online-schema-changeä¼šåˆ›å»ºä¸€ä¸ªç©ºè¡¨ï¼Œç„¶åæ ¹æ®éœ€è¦å¯¹ç©ºè¡¨è¿›è¡Œmodifyï¼Œä¹‹åå°†åŸè¡¨æ•°æ®å¤åˆ¶åˆ°æ–°è¡¨ï¼Œå¤åˆ¶å®Œæˆåå°±ç”¨RENAMEå°†æ–°è¡¨æ›¿æ¢åŸè¡¨ï¼Œå®Œæˆå drop åŸè¡¨ï¼›</p>

<p>pt-online-schema-changeä¿®æ”¹ä»¥å—ä¸ºå•ä½ï¼Œä¿®æ”¹ä¸­æ ¹æ®æƒ…å†µè‡ªè¡Œè°ƒæ•´å—å¤§å°ï¼ˆç±»ä¼¼checksumï¼‰</p>

<p>ä¸ºäº†å®‰å…¨ï¼Œå¦‚æœæ²¡æ‰§è¡Œâ€“executeï¼Œåˆ™ä¸ä¼šå‘ç”Ÿä¿®æ”¹ï¼›å·¥å…·ä¼šæœ‰å¤šç§æªæ–½ï¼Œé˜²æ­¢ä¸å¿…è¦çš„è´Ÿè½½ï¼Œå¦‚ï¼š</p>

<p>1ï¼Œ å¤šæ•°æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰PRIMARY KEYæˆ–è€…UNIQUE KEYï¼Œåˆ™æ‹’ç»æ“ä½œï¼ˆâ€“alterï¼‰</p>

<p>2ï¼Œ å¦‚æœæ£€æµ‹åˆ°replication filtersï¼Œåˆ™æ‹’ç»æ“ä½œï¼ˆâ€“[no]check-replication-filtersï¼‰</p>

<p>3ï¼Œ å¦‚æœæœ‰è¾ƒå¤§çš„å»¶æ—¶ï¼Œåˆ™æš‚åœæ“ä½œï¼ˆâ€â€“max-lagâ€ï¼‰</p>

<p>4ï¼Œ å¦‚æœæœ‰è¾ƒå¤§çš„è´Ÿè½½åˆ™æš‚åœæˆ–æ”¾å¼ƒæ“ä½œï¼ˆâ€â€“max-loadâ€ and â€œâ€“critical-loadï¼‰</p>

<p>5ï¼Œ å·¥å…·ä¼šè®¾ç½®è‡ªå·±ä¼šè¯çš„é”è¶…æ—¶æ—¶é—´â€innodb_lock_wait_timeout=1â€lock_wait_timeout=60ï¼Œæ‰€ä»¥ä¼šæ›´å°‘ åœ°å½±å“å…¶ä»–äº‹ç‰©ï¼ˆä¿®æ”¹æ—¶é—´â€â€“set-varsâ€ï¼‰</p>

<p>6ï¼Œ é»˜è®¤å¦‚æœæœ‰å¤–é”®çº¦æŸåˆ™æ‹’ç»ä¿®æ”¹ï¼ˆå¿½ç•¥çº¦æŸâ€â€“alter-foreign-keys-methodâ€ï¼‰</p>

<p>7ï¼Œ ä¸æ”¯æŒPercona XtraDB Clusterï¼ˆPerconaé«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼‰</p>

<p>å·¥å…·ä¼šå¿½ç•¥mysql 5.7+ç‰ˆæœ¬çš„â€GENERATEDâ€åˆ—ï¼Œå› ä¸ºå®ƒæ ¹æ®è¡¨è¾¾å¼è®¡ç®—åˆ—å€¼</p>

<p>è¾“å‡ºä¿¡æ¯ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¤åˆ¶è¡¨çš„æ—¶å€™ä¼šæ˜¾ç¤ºè¿›åº¦ï¼Œ å¦‚æœè¦æ˜¾ç¤ºé¢å¤–ä¿¡æ¯ï¼Œåˆ™--print, å¦‚æœæŒ‡å®š--statistics æœ€åä¼šæ˜¾ç¤ºè®¡æ•°ä¿¡æ¯
</code></pre></div></div>

<p>é€‰é¡¹OPTIONS
â€“alter</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ä¸éœ€è¦åŠ alter tableå…³é”®å­—ï¼Œå¦‚pt-online-schema-change  --alter "ADD COLUMN c2 INT" D=apple,t=a 

 é™åˆ¶ï¼š 

 1ï¼Œ å¿…é¡»è¦æœ‰PRIMARY KEYæˆ–è€…UNIQUE KEYï¼Œå› ä¸ºå®ƒä¼šåœ¨ç¨‹åºè¿›è¡Œçš„æ—¶å€™åˆ›å»ºDELETE è§¦å‘å™¨ï¼Œæ¥ä¿è¯æ–°è¡¨è·Ÿç€è€è¡¨ä¸€èµ·æ›´æ–°ï¼›

 2ï¼Œ RENAMEä¸ä¼šè¢«é‡‡ç”¨å»RENAME TABLE

 3ï¼Œ å¦‚æœå¢åŠ åˆ—çš„æ—¶å€™æŒ‡å®šNOT NULLï¼Œå¹¶ä¸”æœªæä¾›é»˜è®¤å€¼ï¼Œåˆ™å¤±è´¥ï¼›

 4ï¼Œ å¦‚æœè¦åˆ é™¤å¤–é”®ï¼Œéœ€è¦æŒ‡å®š "_constraint_name"è€Œä¸æ˜¯ "constraint_name"

 5ï¼Œ å¦‚æœè¦å°†MYISAMè¡¨ä¿®æ”¹ä¸ºInnodbä¼šæŠ¥é”™
</code></pre></div></div>

<p>â€“[no]analyze-before-swap  å½“æ–°è¡¨ä¸åŸè¡¨äº¤æ¢çš„å‰æ‰§è¡Œanalyze tableï¼›</p>

<p>â€“ask-pass è¿æ¥çš„æ—¶å€™ä¼šè¦æ±‚æä¾›å¯†ç </p>

<p>â€“charset é»˜è®¤å­—ç¬¦é›†</p>

<p>â€“[no]check-alter   å¯¹äºå±é™©çš„æ“ä½œä¼šäº§ç”Ÿå‘Šè­¦ï¼Œå¦‚åˆ é™¤ä¸»é”®æˆ–è€…é‡å‘½ååˆ—ï¼›</p>

<p>â€“check-interval   å½“ä¸»ä»å»¶æ—¶ä¸ºâ€“max-lag ç§’çš„æ—¶å€™ï¼Œæ£€æŸ¥sleepçš„æ—¶é—´ï¼›ä¾‹å¦‚è®¾ç½®ä¸º10çš„æ—¶å€™ï¼Œä¸»ä»å»¶æ—¶äº§ç”Ÿï¼Œåˆ™æš‚åœ10ç§’ï¼Œå†æ£€æŸ¥å»¶æ—¶ï¼Œå¦‚æœä¾ç„¶æœ‰æœ‰å»¶æ—¶ï¼Œåœæ­¢10så†æ£€æŸ¥ï¼› é»˜è®¤1s</p>

<p>â€“[no]check-plan   æ˜¯å¦åœ¨æ‰§è¡Œå‰ç”¨EXPLAINæ£€æŸ¥è¯­å¥</p>

<p>â€“[no]check-replication-filters  æ˜¯å¦æ£€æŸ¥è¿‡æ»¤å™¨ï¼Œå¦‚æœæœ‰ä»»ä½•è¿‡æ»¤å™¨çš„æ—¶å€™ï¼Œæ“ä½œéƒ½ä¼šè¢«æ”¾å¼ƒï¼›ï¼ˆå¦‚ï¼šbinlog_ignore_db  replicate_do_dbï¼‰</p>

<p>â€“check-slave-lag  å¦‚æœslaveçš„æ—¶é—´æˆ³ä½äºâ€â€“max-lagâ€çš„æ—¶å€™åˆ™æš‚åœæ“ä½œ</p>

<p>â€“chunk-index  æŒ‡å®šchunkçš„ç´¢å¼•ï¼Œå·¥å…·é»˜è®¤ä¼šé€‰æ‹©æœ€åˆé€‚çš„ç´¢å¼•ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®š</p>

<p>â€“chunk-index-columns æœ‰å¤åˆç´¢å¼•çš„æ—¶å€™ï¼ŒæŒ‡å®šç´¢å¼•åˆ—</p>

<p>â€“chunk-size   chunkçš„è¡Œæ•°ï¼Œé»˜è®¤1000</p>

<p>â€“chunk-size-limit   é»˜è®¤4ï¼Œchunkè¶…è¿‡åº”æœ‰å€¼çš„4å€å¤§å°åˆ™è·³è¿‡ã€‚å¦‚æœæ²¡æœ‰å”¯ä¸€ç´¢å¼•ï¼Œåˆ™chunk å¤§å°æ˜¯ä¸ç²¾ç¡®çš„ï¼Œå·¥å…·ä¼šç”¨EXPLAINè¯„ä¼°å¤§å°ï¼Œå¦‚æœè¶…è¿‡éœ€è¦chunkå¤§å°çš„nå€ï¼Œåˆ™è·³è¿‡è¯¥chunkï¼›</p>

<p>â€“chunk-time é»˜è®¤0.5ï¼Œ å·¥å…·ä¼šæ ¹æ®æ¯æ¬¡å¤åˆ¶æ•°æ®èŠ±è´¹çš„æ—¶é—´è‡ªåŠ¨è°ƒæ•´chunkå¤§å°ï¼Œå°½å¯èƒ½ä½¿æ¯æ¬¡æ—¶é—´éƒ½ç›¸åŒï¼›=0åˆ™ä¸è°ƒèŠ‚</p>

<p>â€“config  è¯»å–é…ç½®æ–‡ä»¶ï¼Œå¤šä¸ªæ–‡ä»¶é€—å·åˆ†éš”ï¼›å¦‚æœæŒ‡å®šåˆ™å¿…é¡»æ˜¯ç¬¬ä¸€ä¸ªå‚æ•°</p>

<p>â€“critical-load  é»˜è®¤Threads_running=50ï¼›  æ¯æ¬¡chunkæ‰§è¡Œåä¼šè‡ªåŠ¨ç”¨SHOW GLOBAL STATUSæ£€æŸ¥è´Ÿè½½æƒ…å†µï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼åˆ™æ”¾å¼ƒï¼›</p>

<p>â€“database -D æŒ‡å®šåº“</p>

<p>â€“default-engine è¯¥é€‰é¡¹å°†å¯¼è‡´æ–°è¡¨ä½¿ç”¨ç³»ç»Ÿé»˜è®¤å¼•æ“ï¼›   è€Œä¸æ˜¯åŸæœ‰è¡¨ä¸€è‡´çš„å¼•æ“</p>

<p>â€“data-dir  v 5.6+ åœ¨ä¸åŒçš„åˆ†åŒºä¸Šåˆ›å»ºæ–°è¡¨</p>

<p>â€“remove-data-dir å¦‚æœåŸè¡¨å·²é€šè¿‡â€“data-dir åˆ›å»ºï¼Œè¯¥å‚æ•°ä¼šåˆ é™¤å®ƒå¹¶åœ¨é»˜è®¤datadirä¸‹åˆ›å»ºæ–°è¡¨</p>

<p>â€“defaults-file   ä»æ–‡ä»¶ä¸­è¯»å–é€‰é¡¹</p>

<p>â€“[no]drop-new-table å¦‚æœå¤åˆ¶åŸè¡¨å¤±è´¥åˆ™åˆ é™¤æ–°è¡¨ï¼› ä¹Ÿå¯ä»¥no-xxxæ¥ä¿ç•™æ–°è¡¨</p>

<p>â€“[no]drop-old-table  renameæ–°è¡¨ådropæ—§è¡¨ï¼Œå¯ä»¥no-xxxæ¥ä¿ç•™æ—§è¡¨</p>

<p>â€“[no]drop-triggers  åˆ é™¤æ—§è¡¨çš„è§¦å‘å™¨ï¼›â€â€“no-drop-triggersâ€ forces â€œâ€“no-drop-old-tableâ€.</p>

<p>â€“dry-run åˆ›å»ºå¹¶ä¿®æ”¹æ–°è¡¨ï¼Œä½†ä¸åˆ›å»ºè§¦å‘å™¨ï¼Œä¹Ÿä¸å¤åˆ¶è¡¨ï¼Œæˆ–è€…æ›¿æ¢åŸè¡¨ï¼Œä¸â€“executeäº’æ–¥</p>

<p>â€“execute æ‰§è¡Œæ“ä½œ ä¸ â€“dry-runäº’æ–¥</p>

<p>â€“[no]check-unique-key-change  å¦‚æœâ€“alterå°è¯•å¢åŠ å”¯ä¸€ç´¢å¼•çš„çš„è¯ï¼Œåˆ™å·¥å…·ä¸ä¼šè¿è¡Œï¼› å› ä¸ºå¢åŠ å”¯ä¸€ç´¢å¼•å¦‚æœåˆ—æœ‰é‡å¤å€¼ï¼Œä¼šå‘ç”Ÿä¸¢å¤±æ•°æ®çš„æƒ…å†µï¼›å› ä¸ºINSERTçš„æ—¶å€™é»˜è®¤é‡‡ç”¨â€INSERT IGNOREâ€</p>

<p>â€“force  å¼ºåˆ¶è¿è¡Œï¼Œå¯èƒ½æ‰“ç ´å¤–é”®çº¦æŸ</p>

<p>â€“help å¸®åŠ©
â€“host | -h  æŒ‡å®šhost</p>

<p>â€“max-lag é»˜è®¤1sï¼Œ å¦‚æœä¸»ä»å»¶æ—¶çš„æ—¶é—´è¶…è¿‡è¿™ä¸ªå€¼ï¼Œåˆ™å¤åˆ¶ä¼šæš‚åœâ€â€“check-intervalâ€ç§’æ—¶é—´ï¼›ç„¶åå†æ£€æŸ¥ï¼Œç›´åˆ°ä¸»ä»å»¶æ—¶å°äºè¯¥å€¼ï¼›å¦‚æœæŒ‡å®šäº† â€œâ€“check-slave-lagâ€ï¼Œåˆ™åªä¼šæ£€æŸ¥æŒ‡å®šslaveå»¶æ—¶ï¼Œè€Œä¸æ˜¯æ£€æŸ¥æ‰€æœ‰slave;å¦‚æœæœ‰ä»»ä½•SLAVE stopäº†ï¼Œé‚£ä¹ˆå·¥å…·ä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ï¼›æ¯æ¬¡åœæ­¢çš„æ—¶å€™éƒ½ä¼šæ‰“å°æŠ¥å‘Š</p>

<p>â€“max-load é»˜è®¤ : Threads_running=25</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    æ¯æ¬¡å¤åˆ¶chunkåæ£€æŸ¥è´Ÿè½½ï¼Œå¦‚æœè¶…è¿‡è¯¥å€¼åˆ™æš‚åœï¼›ç±»ä¼¼--critical-load
</code></pre></div></div>

<p>â€“preserve-triggers     ä¿ç•™åŸè¡¨çš„è§¦å‘å™¨ï¼Œä¸åˆ é™¤</p>

<p>â€“new-table-name   æŒ‡å®šæ–°è¡¨çš„åå­—ï¼Œé»˜è®¤æ˜¯ tablename_new</p>

<p>â€“null-to-not-null  ä¿®æ”¹å…è®¸nullå€¼ä¸ºnot null</p>

<p>â€“password æŒ‡å®šå¯†ç </p>

<p>â€“pause-file æ”¹å‚æ•°æŒ‡å®šçš„æ–‡ä»¶å­˜åœ¨çš„æ—¶ï¼Œæ“ä½œå°†ä¼šæš‚åœ</p>

<p>â€“pid æ–°å»ºpidæ–‡ä»¶</p>

<p>â€“port æŒ‡å®šè¿æ¥ç«¯å£</p>

<p>â€“print  å°†ä¼šæ˜¾ç¤ºå·¥å…·æ‰§è¡Œçš„å‘½ä»¤</p>

<p>â€“progress æ˜¾ç¤ºè¿›åº¦ï¼Œé»˜è®¤ï¼š  time,30</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ä¸¤éƒ¨åˆ†ç»„æˆï¼Œç¬¬ä¸€éƒ¨åˆ†percentage,timeæˆ–è€…iterationsï¼›  ç¬¬äºŒéƒ¨åˆ†å¤šä¹…æ›´æ–°ä¸€æ¬¡
</code></pre></div></div>

<p>â€“quiet    -q</p>

<p>ä¸æ‰“å°æ¶ˆæ¯åˆ°å±å¹•ï¼› ç¦ç”¨â€“progress,  ERRORå’Œå‘Šè­¦è¿˜æ˜¯ä¼šæ‰“å°</p>

<p>â€“recurse</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å½“å‘ç°æœ‰slaveçš„æ—¶å€™ï¼ŒæŒ‡å®šé€’å½’çš„å±‚æ•° ï¼Œ intå€¼
</code></pre></div></div>

<p>â€“recursion-method     æŸ¥æ‰¾Slaveçš„é€’å½’æ–¹æ³•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            METHOD       USES
         ===========  ==================
         processlist  SHOW PROCESSLIST
         hosts        SHOW SLAVE HOSTS
         dsn=DSN      DSNs from a table
         none         Do not find slaves  
</code></pre></div></div>

<p>â€“skip-check-slave-lag  æ£€æŸ¥SLAVEçš„æ—¶å€™ï¼ŒæŒ‡å®šè¯¥SLAVEè·³è¿‡ï¼›</p>

<p>â€“slave-user    è®¾ç½®è¿æ¥slaveçš„ç”¨æˆ·ï¼›å¯ä»¥æŒ‡å®šç”¨æ›´å°‘æƒé™çš„ç”¨æˆ·è¿æ¥SLAVEï¼Œä½†æ˜¯æ‰€æœ‰slaveéƒ½å¿…é¡»æœ‰è¯¥è´¦æˆ·</p>

<p>â€“slave-password    â€“slave-user çš„å¯†ç </p>

<p>â€“set-vars  é»˜è®¤ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          wait_timeout=10000
          innodb_lock_wait_timeout=1
          lock_wait_timeout=60
</code></pre></div></div>

<p>â€“sleep  å¤åˆ¶æ¯ä¸ªchunkçš„æ—¶å€™æš‚åœå¤šå°‘sï¼Œé»˜è®¤0</p>

<p>â€“socket æŒ‡å®šè¿æ¥socket</p>

<p>â€“statistics   æ‰“å°è®¡æ•°å™¨çš„æ•°æ®ï¼Œå½“æœ‰å‘Šè­¦çš„æ—¶å€™è¿™ä¸ªå‚æ•°æ¯”è¾ƒæœ‰ç”¨</p>

<p>-[no]swap-tables  æŒ‡å®šæ˜¯å¦æ›¿æ¢æ—§è¡¨</p>

<p>â€“tries  é‡è¯•æ¬¡æ•°ï¼›</p>

<p>â€“user è¿æ¥ç”¨æˆ·å</p>

<p>â€“version  ç‰ˆæœ¬</p>

<p>â€“[no]version-check æ£€æŸ¥Percona Toolkitçš„æœ€æ–°ç‰ˆæœ¬</p>

<p>[root@localhost tmp]# pt-online-schema-change  â€“alter â€œADD COLUMN c3 INTâ€ D=apple,t=a -u root -h localhost -p password â€“execute
No slaves found.  See â€“recursion-method if host localhost.localdomain has slaves.
Not checking slave lag because no slaves were found and â€“check-slave-lag was not specified.</p>

<h1 id="a-software-update-is-available">A software update is available:</h1>
<p>Operation, tries, wait:
  analyze_table, 10, 1
  copy_rows, 10, 0.25
  create_triggers, 10, 1
  drop_triggers, 10, 1
  swap_tables, 10, 1
  update_foreign_keys, 10, 1
Altering <code class="language-plaintext highlighter-rouge">apple</code>.<code class="language-plaintext highlighter-rouge">a</code>â€¦
Creating new tableâ€¦
Created new table apple._a_new OK.
Altering new tableâ€¦
Altered <code class="language-plaintext highlighter-rouge">apple</code>.<code class="language-plaintext highlighter-rouge">_a_new</code> OK.
2018-09-05T12:57:33 Creating triggersâ€¦
2018-09-05T12:57:33 Created triggers OK.
2018-09-05T12:57:33 Copying approximately 2 rowsâ€¦
2018-09-05T12:57:33 Copied rows OK.
2018-09-05T12:57:33 Analyzing new tableâ€¦
2018-09-05T12:57:33 Swapping tablesâ€¦
2018-09-05T12:57:34 Swapped original and new tables OK.
2018-09-05T12:57:34 Dropping old tableâ€¦
2018-09-05T12:57:34 Dropped old table <code class="language-plaintext highlighter-rouge">apple</code>.<code class="language-plaintext highlighter-rouge">_a_old</code> OK.
2018-09-05T12:57:34 Dropping triggersâ€¦
2018-09-05T12:57:34 Dropped triggers OK.</p>
:ET