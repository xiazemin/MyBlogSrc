I"à.<p>ä¸­é—´ä»¶ï¼ˆé€šå¸¸ï¼‰æ˜¯ä¸€å°æ®µä»£ç ï¼Œå®ƒä»¬æ¥æ”¶ä¸€ä¸ªè¯·æ±‚ï¼Œå¯¹å…¶è¿›è¡Œå¤„ç†ï¼Œæ¯ä¸ªä¸­é—´ä»¶åªå¤„ç†ä¸€ä»¶äº‹æƒ…ï¼Œå®Œæˆåå°†å…¶ä¼ é€’ç»™å¦ä¸€ä¸ªä¸­é—´ä»¶æˆ–æœ€ç»ˆå¤„ç†ç¨‹åºï¼Œè¿™æ ·å°±åšåˆ°äº†ç¨‹åºçš„è§£è€¦ã€‚å¦‚æœæ²¡æœ‰ä¸­é—´ä»¶é‚£ä¹ˆæˆ‘ä»¬å¿…é¡»åœ¨æœ€ç»ˆçš„å¤„ç†ç¨‹åºä¸­æ¥å®Œæˆè¿™äº›å¤„ç†æ“ä½œï¼Œè¿™æ— ç–‘ä¼šé€ æˆå¤„ç†ç¨‹åºçš„è‡ƒè‚¿å’Œä»£ç å¤ç”¨ç‡ä¸é«˜çš„é—®é¢˜ã€‚ä¸­é—´ä»¶çš„ä¸€äº›å¸¸è§ç”¨ä¾‹æ˜¯è¯·æ±‚æ—¥å¿—è®°å½•ï¼Œ Headeræ“çºµã€ HTTPè¯·æ±‚è®¤è¯å’Œ ResponseWriteråŠ«æŒç­‰ç­‰ã€‚
<!-- more -->
https://mp.weixin.qq.com/s/3DwHTa-9Bjxei9woi1qeCw
https://mp.weixin.qq.com/s?__biz=MzUzNTY5MzU2MA==&amp;mid=2247483692&amp;idx=1&amp;sn=fa20c127b08a8d35feb4420b09470adf&amp;chksm=fa80d0bbcdf759ad9659f3b6e5ffc4e67217af4059ccadc4053f77ed1148bc783c365c29e4bf&amp;token=140743472&amp;lang=zh_CN&amp;scene=21#wechat_redirect</p>

<p>åˆ›å»ºä¸­é—´ä»¶
æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨ Goåˆ›å»ºä¸­é—´ä»¶ï¼Œä¸­é—´ä»¶åªå°† http.HandlerFuncä½œä¸ºå…¶å‚æ•°ï¼Œåœ¨ä¸­é—´ä»¶é‡Œå°†å…¶åŒ…è£…å¹¶è¿”å›æ–°çš„ http.HandlerFuncä¾›æœåŠ¡å™¨æœåŠ¡å¤ç”¨å™¨è°ƒç”¨ã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹ Middlewareï¼Œè¿™ä¼šè®©æœ€åä¸€èµ·é“¾å¼è°ƒç”¨å¤šä¸ªä¸­é—´ä»¶å˜çš„æ›´ç®€å•ã€‚</p>

<p>type 
Middleware
 func
(
http
.
HandlerFunc
)
 http
.
HandlerFunc</p>

<p>ä¸‹é¢çš„ä¸­é—´ä»¶é€šç”¨ä»£ç æ¨¡æ¿è®©æˆ‘ä»¬å¹³æ—¶ç¼–å†™ä¸­é—´ä»¶å˜å¾—æ›´å®¹æ˜“ã€‚</p>

<p>ä¸­é—´ä»¶ä»£ç æ¨¡æ¿
ä¸­é—´ä»¶æ˜¯ä½¿ç”¨è£…é¥°å™¨æ¨¡å¼å®ç°çš„ï¼Œä¸‹é¢çš„ä¸­é—´ä»¶é€šç”¨ä»£ç æ¨¡æ¿è®©æˆ‘ä»¬å¹³æ—¶ç¼–å†™ä¸­é—´ä»¶å˜å¾—æ›´å®¹æ˜“ï¼Œæˆ‘ä»¬åœ¨è‡ªå·±å†™ä¸­é—´ä»¶çš„æ—¶å€™åªéœ€è¦å¾€æ ·æ¿é‡Œå¡«å……éœ€è¦çš„ä»£ç é€»è¾‘å³å¯ã€‚</p>

<p>func createNewMiddleware
()</p>

<p>Middleware</p>

<p>{</p>

<p>// åˆ›å»ºä¸€ä¸ªæ–°çš„ä¸­é—´ä»¶</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>middleware  :=  func ( next  http . HandlerFunc )  http . HandlerFunc
</code></pre></div></div>

<p>{</p>

<p>// åˆ›å»ºä¸€ä¸ªæ–°çš„handleråŒ…è£¹next</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    handler  :=  func ( w http . ResponseWriter ,  r  * http . Request )
</code></pre></div></div>

<p>{</p>

<p>// ä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘</p>

<p>â€¦â€¦</p>

<p>// è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è€…æœ€ç»ˆçš„handlerå¤„ç†ç¨‹åº</p>

<p>next
(
w
,
 r
)</p>

<p>}</p>

<p>// è¿”å›æ–°å»ºçš„åŒ…è£…handler</p>

<p>return
 handler</p>

<p>}</p>

<p>// è¿”å›æ–°å»ºçš„ä¸­é—´ä»¶</p>

<p>return
 middleware</p>

<p>}</p>

<p>ä½¿ç”¨ä¸­é—´ä»¶
æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªä¸­é—´ä»¶ï¼Œä¸€ä¸ªç”¨äºè®°å½•ç¨‹åºæ‰§è¡Œçš„æ—¶é•¿ï¼Œå¦å¤–ä¸€ä¸ªç”¨äºéªŒè¯è¯·æ±‚ç”¨çš„æ˜¯å¦æ˜¯æŒ‡å®šçš„ HTTPMethodï¼Œåˆ›å»ºå®Œåå†ç”¨å®šä¹‰çš„ Chainå‡½æ•°æŠŠ http.HandlerFuncå’Œåº”ç”¨åœ¨å…¶ä¸Šçš„ä¸­é—´ä»¶é“¾èµ·æ¥ï¼Œä¸­é—´ä»¶ä¼šæŒ‰æ·»åŠ é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œæœ€åæ‰§è¡Œåˆ°å¤„ç†å‡½æ•°ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œfmtâ€</p>

<p>â€œlogâ€</p>

<p>â€œnet/httpâ€</p>

<p>â€œtimeâ€</p>

<p>)</p>

<p>type 
Middleware
 func
(
http
.
HandlerFunc
)
 http
.
HandlerFunc</p>

<p>// è®°å½•æ¯ä¸ªURLè¯·æ±‚çš„æ‰§è¡Œæ—¶é•¿</p>

<p>func 
Logging
()</p>

<p>Middleware</p>

<p>{</p>

<p>// åˆ›å»ºä¸­é—´ä»¶</p>

<p>return
 func
(
f http
.
HandlerFunc
)
 http
.
HandlerFunc</p>

<p>{</p>

<p>// åˆ›å»ºä¸€ä¸ªæ–°çš„handleråŒ…è£…http.HandlerFunc</p>

<p>return
 func
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<p>// ä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        start  :=  time . Now ()

        defer func ()
</code></pre></div></div>

<p>{
 log
.
Println
(
r
.
URL
.
Path
,
 time
.
Since
(
start
))</p>

<p>}()</p>

<p>// è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è€…æœ€ç»ˆçš„handlerå¤„ç†ç¨‹åº</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        f ( w ,  r )
</code></pre></div></div>

<p>}</p>

<p>}</p>

<p>}</p>

<p>// éªŒè¯è¯·æ±‚ç”¨çš„æ˜¯å¦æ˜¯æŒ‡å®šçš„HTTP Methodï¼Œä¸æ˜¯åˆ™è¿”å› 400 Bad Request</p>

<p>func 
Method
(
m 
string
)</p>

<p>Middleware</p>

<p>{</p>

<p>return
 func
(
f http
.
HandlerFunc
)
 http
.
HandlerFunc</p>

<p>{</p>

<p>return
 func
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<p>if
 r
.
Method</p>

<p>!=
 m 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            http . Error ( w ,  http . StatusText ( http . StatusBadRequest ),  http . StatusBadRequest )
</code></pre></div></div>

<p>return</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        f ( w ,  r )
</code></pre></div></div>

<p>}</p>

<p>}</p>

<p>}</p>

<p>// æŠŠåº”ç”¨åˆ°http.HandlerFuncå¤„ç†å™¨çš„ä¸­é—´ä»¶</p>

<p>// æŒ‰ç…§å…ˆåé¡ºåºå’Œå¤„ç†å™¨æœ¬èº«é“¾èµ·æ¥ä¾›http.HandleFuncè°ƒç”¨</p>

<p>func 
Chain
(
f http
.
HandlerFunc
,
 middlewares 
â€¦
Middleware
)
 http
.
HandlerFunc</p>

<p>{</p>

<p>for
 _
,
 m 
:=
 range middlewares 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    f  =  m ( f )
</code></pre></div></div>

<p>}</p>

<p>return
 f</p>

<p>}</p>

<p>// æœ€ç»ˆçš„å¤„ç†è¯·æ±‚çš„http.HandlerFunc</p>

<p>func 
Hello
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Fprintln ( w ,
</code></pre></div></div>

<p>â€œhello worldâ€
)</p>

<p>}</p>

<p>func main
()</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http . HandleFunc ( "/" ,
</code></pre></div></div>

<p>Chain
(
Hello
,</p>

<p>Method
(
â€œGETâ€
),</p>

<p>Logging
()))</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http . ListenAndServe ( ":8080" ,
</code></pre></div></div>

<p>nil
)</p>

<p>}</p>

<p>è¿è¡Œç¨‹åºåä¼šæ‰“å¼€æµè§ˆå™¨è®¿é—® http://localhost:8080ä¼šæœ‰å¦‚ä¸‹è¾“å‡ºï¼š</p>

<p>2020
/
02
/
07</p>

<p>21
:
07
:
52</p>

<p>/</p>

<p>359.503
Âµ
s</p>

<p>2020
/
02
/
07</p>

<p>21
:
09
:
17</p>

<p>/</p>

<p>34.727
Âµ
s</p>

<p>åˆ°è¿™é‡Œæ€ä¹ˆç”¨ Goç¼–å†™å’Œä½¿ç”¨ä¸­é—´ä»¶å°±è®²å®Œï¼Œä¹Ÿå°±ååˆ†é’Ÿå§ã€‚ä¸è¿‡è¿™é‡Œæ›´å¤šçš„æ˜¯æ¢ç©¶å®ç°åŸç†ï¼Œé‚£ä¹ˆåœ¨ç”Ÿäº§ç¯å¢ƒæ€ä¹ˆè‡ªå·±ä½¿ç”¨ç¼–å†™çš„è¿™äº›ä¸­é—´ä»¶å‘¢ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ã€‚</p>

<p>ä½¿ç”¨ gorilla/muxåº”ç”¨ä¸­é—´ä»¶
ä¸Šé¢æˆ‘ä»¬æ¢è®¨äº†å¦‚ä½•åˆ›å»ºä¸­é—´ä»¶ï¼Œä½†æ˜¯ä½¿ç”¨ä¸Šæ¯æ¬¡ç”¨ Chainå‡½æ•°é“¾æ¥å¤šä¸ªä¸­é—´ä»¶å’Œå¤„ç†ç¨‹åºè¿˜æ˜¯æœ‰äº›ä¸æ–¹ä¾¿ï¼Œè€Œä¸”åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»å¼€å§‹ä½¿ç”¨ gorilla/muxæä¾›çš„ Routerä½œä¸ºè·¯ç”±å™¨äº†ã€‚å¥½åœ¨ gorrila.muxæ”¯æŒå‘è·¯ç”±å™¨æ·»åŠ ä¸­é—´ä»¶ï¼Œå¦‚æœå‘ç°åŒ¹é…é¡¹ï¼Œåˆ™æŒ‰ç…§æ·»åŠ ä¸­é—´ä»¶çš„é¡ºåºæ‰§è¡Œä¸­é—´ä»¶ï¼ŒåŒ…æ‹¬å…¶å­è·¯ç”±å™¨ä¹Ÿæ”¯æŒæ·»åŠ ä¸­é—´ä»¶ã€‚</p>

<p>gorrila.muxè·¯ç”±å™¨ä½¿ç”¨ Useæ–¹æ³•ä¸ºè·¯ç”±å™¨æ·»åŠ ä¸­é—´ä»¶ï¼Œ Useæ–¹æ³•çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<p>func 
(
r 
*
Router
)</p>

<p>Use
(
mwf 
â€¦
MiddlewareFunc
)</p>

<p>{</p>

<p>for
 _
,
 fn 
:=
 range mwf 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    r . middlewares  =  append ( r . middlewares ,  fn )
</code></pre></div></div>

<p>}</p>

<p>}</p>

<p>å®ƒå¯ä»¥æ¥å—å¤šä¸ª mux.MiddlewareFuncç±»å‹çš„å‚æ•°ï¼Œ mux.MiddlewareFuncçš„ç±»å‹å£°æ˜ä¸ºï¼š</p>

<p>type 
MiddlewareFunc
 func
(
http
.
Handler
)
 http
.
Handler</p>

<p>è·Ÿæˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ Middlewareç±»å‹å¾ˆåƒä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œä¸è¿‡å‡½æ•°çš„å‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯ http.Handleræ¥å£ï¼Œåœ¨ã€Šæ·±å…¥å­¦ä¹ ç”¨ Go ç¼–å†™ HTTP æœåŠ¡å™¨ã€‹ä¸­æˆ‘ä»¬è¯¦ç»†è®²è¿‡ http.Handlerå®ƒ æ˜¯ net/httpä¸­å®šä¹‰çš„æ¥å£ç”¨æ¥è¡¨ç¤ºå¤„ç† HTTP è¯·æ±‚çš„å¯¹è±¡ï¼Œå…¶å¯¹è±¡å¿…é¡»å®ç° ServeHTTPæ–¹æ³•ã€‚æˆ‘ä»¬æŠŠä¸Šé¢è¯´çš„ä¸­é—´ä»¶æ¨¡æ¿ç¨å¾®æ›´æ”¹ä¸‹å°±èƒ½åˆ›å»ºç¬¦åˆ gorrila.muxè¦æ±‚çš„ä¸­é—´ä»¶ï¼š</p>

<p>func 
CreateMuxMiddleware
()
 mux
.
MiddlewareFunc</p>

<p>{</p>

<p>// åˆ›å»ºä¸­é—´ä»¶</p>

<p>return
 func
(
f http
.
Handler
)
 http
.
Handler</p>

<p>{</p>

<p>// åˆ›å»ºä¸€ä¸ªæ–°çš„handleråŒ…è£…http.HandlerFunc</p>

<p>return
 http
.
HandlerFunc
(
func
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<p>// ä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘</p>

<p>â€¦â€¦</p>

<p>// è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è€…æœ€ç»ˆçš„handlerå¤„ç†ç¨‹åº</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        f . ServeHTTP ( w ,  r )
</code></pre></div></div>

<p>})</p>

<p>}</p>

<p>}</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠä¸Šé¢è‡ªå®šä¹‰çš„ä¸¤ä¸ªä¸­é—´ä»¶è¿›è¡Œæ”¹é€ ï¼Œç„¶ååº”ç”¨åˆ°æˆ‘ä»¬ä¸€ç›´åœ¨ä½¿ç”¨çš„ http_demoé¡¹ç›®ä¸Šï¼Œä¸ºäº†ä¾¿äºç®¡ç†åœ¨é¡¹ç›®ä¸­æ–°å»º middlewareç›®å½•ï¼Œä¸¤ä¸ªä¸­é—´ä»¶åˆ†åˆ«æ”¾åœ¨ log.goå’Œ http_method.goä¸­</p>

<p>//middleware/log.go</p>

<p>func 
Logging
()
 mux
.
MiddlewareFunc</p>

<p>{</p>

<p>// åˆ›å»ºä¸­é—´ä»¶</p>

<p>return
 func
(
f http
.
Handler
)
 http
.
Handler</p>

<p>{</p>

<p>// åˆ›å»ºä¸€ä¸ªæ–°çš„handleråŒ…è£…http.HandlerFunc</p>

<p>return
 http
.
HandlerFunc
(
func
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<p>// ä¸­é—´ä»¶çš„å¤„ç†é€»è¾‘</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        start  :=  time . Now ()

        defer func ()
</code></pre></div></div>

<p>{
 log
.
Println
(
r
.
URL
.
Path
,
 time
.
Since
(
start
))</p>

<p>}()</p>

<p>// è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ–è€…æœ€ç»ˆçš„handlerå¤„ç†ç¨‹åº</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        f . ServeHTTP ( w ,  r )
</code></pre></div></div>

<p>})</p>

<p>}</p>

<p>}</p>

<p>// middleware/http_demo.go</p>

<p>func 
Method
(
m 
string
)
 mux
.
MiddlewareFunc</p>

<p>{</p>

<p>return
 func
(
f http
.
Handler
)
 http
.
Handler</p>

<p>{</p>

<p>return
 http
.
HandlerFunc
(
func
(
w http
.
ResponseWriter
,
 r 
*
http
.
Request
)</p>

<p>{</p>

<p>if
 r
.
Method</p>

<p>!=
 m 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            http . Error ( w ,  http . StatusText ( http . StatusBadRequest ),  http . StatusBadRequest )
</code></pre></div></div>

<p>return</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        f . ServeHTTP ( w ,  r )
</code></pre></div></div>

<p>})</p>

<p>}</p>

<p>}</p>

<p>ç„¶ååœ¨æˆ‘ä»¬çš„è·¯ç”±å™¨ä¸­è¿›è¡Œå¼•ç”¨ï¼š</p>

<p>func 
RegisterRoutes
(
r 
*
mux
.
Router
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r . Use ( middleware . Logging ()) // å…¨å±€åº”ç”¨

indexRouter  :=  r . PathPrefix ( "/index" ). Subrouter ()

indexRouter . Handle ( "/" ,
</code></pre></div></div>

<p>&amp;
handler
.
HelloHandler
{})</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>userRouter  :=  r . PathPrefix ( "/user" ). Subrouter ()

userRouter . HandleFunc ( "/names/{name}/countries/{country}" ,  handler . ShowVisitorInfo )

userRouter . Use ( middleware . Method ( "GET" )) //ç»™å­è·¯ç”±å™¨åº”ç”¨
</code></pre></div></div>

<p>}</p>

<p>å†æ¬¡ç¼–è¯‘å¯åŠ¨è¿è¡Œç¨‹åºåè®¿é—®</p>

<p>http
:
//localhost:8080/user/names/James/countries/NewZealand</p>

<p>ä»æ§åˆ¶å°é‡Œå¯ä»¥çœ‹åˆ°ï¼Œè®°å½•äº†è¿™ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é•¿ï¼š</p>

<p>2020
/
02
/
08</p>

<p>09
:
29
:
50</p>

<p>Starting
 HTTP server
â€¦</p>

<p>2020
/
02
/
08</p>

<p>09
:
55
:
20</p>

<p>/
user
/
names
/
James
/
countries
/
NewZealan</p>

<p>51.157
Âµ
s</p>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬æ¢ç©¶å®Œäº†ç¼–å†™Webä¸­é—´ä»¶çš„è¿‡ç¨‹å’ŒåŸç†ï¼Œåœ¨å®é™…å¼€å‘ä¸­åªéœ€è¦æ ¹æ®è‡ªå·±çš„éœ€æ±‚æŒ‰ç…§æˆ‘ä»¬ç»™çš„ä¸­é—´ä»¶ä»£ç æ¨¡æ¿ç¼–å†™ä¸­é—´ä»¶å³å¯ï¼Œåœ¨ç¼–å†™ä¸­é—´ä»¶çš„æ—¶å€™ä¹Ÿè¦æ³¨æ„ä»–ä»¬çš„èŒè´£èŒƒå›´ï¼Œä¸è¦æ‰€æœ‰é€»è¾‘éƒ½å¾€é‡Œæ”¾ã€‚</p>
:ET