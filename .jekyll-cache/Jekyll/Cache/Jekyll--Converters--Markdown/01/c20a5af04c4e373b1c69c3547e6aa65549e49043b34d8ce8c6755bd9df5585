I"ƒ<p>1 PHP_MINIT å®
é¦–å…ˆæ˜¯å®å±•å¼€
PHP_MINIT(moule) ç­‰ä»·äº zm_startup_moule
å…·ä½“çš„å®æ›¿æ¢å¦‚ä¸‹</p>

<p>#define PHP_MINIT       ZEND_MODULE_STARTUP_N</p>

<p>#define ZEND_MODULE_STARTUP_N(module)       zm_startup_##module
2 ## æ“ä½œç¬¦
å¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ä¸ªé“¾æ¥</p>

<p>https://gcc.gnu.org/onlinedocs/cpp/Variadic-Macros.html#Variadic-Macros</p>

<p>https://www.cprogramming.com/reference/preprocessor/token-pasting-operator.html</p>

<p>åœ¨ä¸Šé¢å¯ä»¥çœ‹åˆ° zm_startup_##moduleï¼Œå…¶ä¸­## æ˜¯ä¸€ä¸ªè¿æ¥ç¬¦å·
ä¾‹å­</p>

<p>#define type i##nt
type a; // same as int a; since i##nt pastes together to â€œintâ€
<!-- more --></p>

<p>3 php mainå‡½æ•°
main å‡½æ•°</p>

<p>phpå¯ä»¥æœ‰å¤šä¸ªè¿è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬ç°åœ¨ä»¥php-fpm ä½œä¸ºä¾‹å­ï¼Œä»–ä½äº
/sapi/fpm/fpm/fpm_main.c</p>

<p>å…¶ä¸­mainå‡½æ•°ä½äº 1600 è¡Œå·¦å³</p>

<p>æ‰©å±•åŠ è½½æ­¥éª¤</p>

<p>1 main å‡½æ•°ï¼ˆc è¯­è¨€éƒ½æ˜¯ä»¥main å‡½æ•°ä¸ºå¼€å¤´ï¼‰
2 è°ƒç”¨ cgi_sapi_moduleçš„ startup å³ php_cgi_startup
    if (cgi_sapi_module.startup(&amp;cgi_sapi_module)   == FAILURE) {`
å…¶ä¸­ cgi_sapi_moule æ˜¯ ä¸€ä¸ªé™æ€å˜é‡</p>

<p>//  /sapi/fpm/fpm/fpm_main.c   870 è¡Œ
static sapi_module_struct cgi_sapi_module = {
    â€œfpm-fcgiâ€,         /* name <em>/
    php_cgi_startup,    /</em> startup <em>/
    â€¦
};
3 ç„¶å php_cgi_startup è°ƒç”¨ php_cgi_startup
static int php_cgi_startup(sapi_module_struct *sapi_module) /</em> {{{ */
{
    if (php_module_startup(sapi_module, &amp;cgi_module_entry, 1) == FAILURE) {
        return FAILURE;
    }
    return SUCCESS;
}
å…¶ä¸­ php_module_startup åœ¨ /main/main.c ä¸­</p>

<p>è°ƒç”¨ zend_startup_modules
int php_module_startup(sapi_module_struct <em>sf, zend_module_entry *additional_modules, uint num_additional_modules)
{
    â€¦
    /</em> load and startup extensions compiled as shared objects (aka DLLs)
       as requested by php.ini entries
       these are loaded after initialization of internal extensions
       as extensions <em>might</em> rely on things from ext/standard
       which is always an internal extension and to be initialized
       ahead of all other internals
     */
    php_ini_register_extensions();
    zend_startup_modules();
    â€¦
å…¶ä¸­ zend_startup_modules</p>

<p>ZEND_API int zend_startup_modules(void) /* {{{ */
{
    zend_hash_sort_ex(&amp;module_registry, zend_sort_modules, NULL, 0);  // å¯¹æ‰©å±•è¿›è¡Œæ’åº
    zend_hash_apply(&amp;module_registry, zend_startup_module_zval);      // è°ƒç”¨minitå¼€å§‹å‡½æ•°
    return SUCCESS;
}
ç„¶åçœ‹ zend_hash_apply</p>

<p>/* This is used to recurse elements and selectively delete certain entries</p>
<ul>
  <li>from a hashtable. apply_func() receives the data and decides if the entry</li>
  <li>should be deleted or recursion should be stopped. The following three</li>
  <li>return codes are possible:</li>
  <li>ZEND_HASH_APPLY_KEEP   - continue</li>
  <li>ZEND_HASH_APPLY_STOP   - stop iteration</li>
  <li>ZEND_HASH_APPLY_REMOVE - delete the element, combineable with the former
 */</li>
</ul>

<p>ZEND_API void ZEND_FASTCALL zend_hash_apply(HashTable *ht, apply_func_t apply_func)
{
    uint32_t idx;
    Bucket *p;
    int result;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IS_CONSISTENT(ht);

HASH_PROTECT_RECURSION(ht);
for (idx = 0; idx &lt; ht-&gt;nNumUsed; idx++) {
    p = ht-&gt;arData + idx;
    if (UNEXPECTED(Z_TYPE(p-&gt;val) == IS_UNDEF)) continue;
    result = apply_func(&amp;p-&gt;val);

    if (result &amp; ZEND_HASH_APPLY_REMOVE) {
        HT_ASSERT(GC_REFCOUNT(ht) == 1);
        _zend_hash_del_el(ht, HT_IDX_TO_HASH(idx), p);
    }
    if (result &amp; ZEND_HASH_APPLY_STOP) {
        break;
    }
}
HASH_UNPROTECT_RECURSION(ht); } å‡½æ•° zend_hash_apply(HashTable *ht, apply_func_t apply_func) çš„ç¬¬äºŒä¸ªå‚æ•°ç±»å‹æ˜¯ apply_func_t æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ
</code></pre></div></div>

<p>//    /Zend/zend_hash.h
typedef int (<em>apply_func_t)(zval *pDest);
å›åˆ° åˆšæ‰çš„ zend_startup_modules ,
åœ¨ zend_startup_modules ä¸­è°ƒç”¨äº† zend_hash_apply
è¿™ä¸ªå‡½æ•°ä¼šéå†hashtable é‡Œé¢çš„å€¼å¹¶è°ƒç”¨å…¶ä¸­çš„åˆå§‹åŒ–å‡½æ•°ä¹Ÿå°±æ˜¯è°ƒç”¨PHP_MINIT(modules)ï¼Œzend_hash_apply ç¬¬äºŒä¸ªå‚æ•°æ˜¯ ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ zend_startup_module_zval
ZEND_API int zend_startup_modules(void) /</em> {{{ */
{
    zend_hash_sort_ex(&amp;module_registry, zend_sort_modules, NULL, 0);  // å¯¹æ‰©å±•è¿›è¡Œæ’åº
    zend_hash_apply(&amp;module_registry, zend_startup_module_zval);      // è°ƒç”¨minitå¼€å§‹å‡½æ•°
    return SUCCESS;
}
æ ¸å¿ƒå‡½æ•° zend_startup_module_zval</p>

<p>//  /Zend/zend_API.c
static int zend_startup_module_zval(zval <em>zv) /</em> {{{ */
{
    zend_module_entry *module = Z_PTR_P(zv);  // è·å¾—æ¨¡å—å®ä¾‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return (zend_startup_module_ex(module) == SUCCESS) ? ZEND_HASH_APPLY_KEEP : ZEND_HASH_APPLY_REMOVE;    // è°ƒç”¨init å‡½æ•° } /* }}} */ ä¹‹åæ˜¯ zend_startup_module_ex,å…¶ä¸­é‡è¦çš„å‡½æ•°æ˜¯ module_startup_func
</code></pre></div></div>

<p>//////////////////   åŠ è½½æ‰©å±•
ZEND_API int zend_startup_module_ex(zend_module_entry <em>module) /</em> {{{ */
{
â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (module-&gt;module_startup_func) {
    EG(current_module) = module;   // execute_group 
    if (module-&gt;module_startup_func(module-&gt;type, module-&gt;module_number)==FAILURE) {  // æ³¨å†Œå¤±è´¥åˆ™æ‰“å°
        zend_error_noreturn(E_CORE_ERROR,"Unable to start %s module", module-&gt;name);  
        EG(current_module) = NULL;  // æ¸…ç©º
        return FAILURE;
    }
    EG(current_module) = NULL;
}
return SUCCESS; } /* }}} */ ç„¶åæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å˜é‡module çš„ç±»å‹zend_module_entry
</code></pre></div></div>

<p>typedef struct _zend_module_entry zend_module_entry;
ç„¶å ç»“æ„ _zend_module_entry åŒ…å«äº†æ‰©å±•çš„æ‰€æœ‰çš„å›è°ƒï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦æ˜¯è¦çœ‹
int (*module_startup_func)(INIT_FUNC_ARGS);</p>

<p>struct _zend_module_entry {
    â€¦
    const struct _zend_function_entry <em>functions;
    int (</em>module_startup_func)(INIT_FUNC_ARGS);
    int (<em>module_shutdown_func)(SHUTDOWN_FUNC_ARGS);
    int (</em>request_startup_func)(INIT_FUNC_ARGS);
    int (<em>request_shutdown_func)(SHUTDOWN_FUNC_ARGS);
    void (</em>info_func)(ZEND_MODULE_INFO_FUNC_ARGS);
    â€¦
};
è€Œå½“ä½ å†™æ‰©å±•çš„æ—¶å€™ä¼šæ³¨å†Œä¸€ä¸ª zend_module_entry,ä¾‹å¦‚bz2 æ‰©å±•çš„
PHP_MINIT(bz2),</p>

<p>zend_module_entry bz2_module_entry = {
    STANDARD_MODULE_HEADER,
    â€œbz2â€,
    bz2_functions,
    PHP_MINIT(bz2),
    PHP_MSHUTDOWN(bz2),
    NULL,
    NULL,
    PHP_MINFO(bz2),
    PHP_BZ2_VERSION,
    STANDARD_MODULE_PROPERTIES
};</p>

:ET