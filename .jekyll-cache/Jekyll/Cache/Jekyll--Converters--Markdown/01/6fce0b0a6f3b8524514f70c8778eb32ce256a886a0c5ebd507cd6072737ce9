I"7<p>WaitGroupï¼Œå¯ç†è§£ä¸ºWait-Goroutine-Groupï¼Œå³ç­‰å¾…ä¸€ç»„goroutineç»“æŸã€‚æ¯”å¦‚æŸä¸ªgoroutineéœ€è¦ç­‰å¾…å…¶ä»–å‡ ä¸ªgoroutineå…¨éƒ¨å®Œæˆï¼Œé‚£ä¹ˆä½¿ç”¨WaitGroupå¯ä»¥è½»æ¾å®ç°ã€‚</p>

<p>ä¸‹é¢ç¨‹åºå±•ç¤ºäº†ä¸€ä¸ªgoroutineç­‰å¾…å¦å¤–ä¸¤ä¸ªgoroutineç»“æŸçš„ä¾‹å­ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œtimeâ€
    â€œsyncâ€
)</p>

<p>func main() {
    var wg sync.WaitGroup</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wg.Add(2) //è®¾ç½®è®¡æ•°å™¨ï¼Œæ•°å€¼å³ä¸ºgoroutineçš„ä¸ªæ•°
go func() {
    //Do some work
    time.Sleep(1*time.Second)

    fmt.Println("Goroutine 1 finished!")
    wg.Done() //goroutineæ‰§è¡Œç»“æŸåå°†è®¡æ•°å™¨å‡1
}()

go func() {
    //Do some work
    time.Sleep(2*time.Second)

    fmt.Println("Goroutine 2 finished!")
    wg.Done() //goroutineæ‰§è¡Œç»“æŸåå°†è®¡æ•°å™¨å‡1
}()

wg.Wait() //ä¸»goroutineé˜»å¡ç­‰å¾…è®¡æ•°å™¨å˜ä¸º0
fmt.Printf("All Goroutine finished!") } ç®€å•çš„è¯´ï¼Œä¸Šé¢ç¨‹åºä¸­wgå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼š
</code></pre></div></div>

<p>å¯åŠ¨goroutineå‰å°†è®¡æ•°å™¨é€šè¿‡Add(2)å°†è®¡æ•°å™¨è®¾ç½®ä¸ºå¾…å¯åŠ¨çš„goroutineä¸ªæ•°ã€‚
å¯åŠ¨goroutineåï¼Œä½¿ç”¨Wait()æ–¹æ³•é˜»å¡è‡ªå·±ï¼Œç­‰å¾…è®¡æ•°å™¨å˜ä¸º0ã€‚
æ¯ä¸ªgoroutineæ‰§è¡Œç»“æŸé€šè¿‡Done()æ–¹æ³•å°†è®¡æ•°å™¨å‡1ã€‚
è®¡æ•°å™¨å˜ä¸º0åï¼Œé˜»å¡çš„goroutineè¢«å”¤é†’ã€‚
å…¶å®WaitGroupä¹Ÿå¯ä»¥å®ç°ä¸€ç»„goroutineç­‰å¾…å¦ä¸€ç»„goroutineï¼Œè¿™æœ‰ç‚¹åƒç©æ‚æŠ€ï¼Œå¾ˆå®¹å‡ºé”™ï¼Œå¦‚æœä¸äº†è§£å…¶å®ç°åŸç†æ›´æ˜¯å¦‚æ­¤ã€‚å®é™…ä¸Šï¼ŒWaitGroupçš„å®ç°æºç éå¸¸ç®€å•ã€‚</p>

<p>2 åŸºç¡€çŸ¥è¯†
2.1 ä¿¡å·é‡
ä¿¡å·é‡æ˜¯Unixç³»ç»Ÿæä¾›çš„ä¸€ç§ä¿æŠ¤å…±äº«èµ„æºçš„æœºåˆ¶ï¼Œç”¨äºé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æŸä¸ªèµ„æºã€‚</p>

<p>å¯ç®€å•ç†è§£ä¸ºä¿¡å·é‡ä¸ºä¸€ä¸ªæ•°å€¼ï¼š</p>

<p>å½“ä¿¡å·é‡&gt;0æ—¶ï¼Œè¡¨ç¤ºèµ„æºå¯ç”¨ï¼Œè·å–ä¿¡å·é‡æ—¶ç³»ç»Ÿè‡ªåŠ¨å°†ä¿¡å·é‡å‡1ï¼›
å½“ä¿¡å·é‡==0æ—¶ï¼Œè¡¨ç¤ºèµ„æºæš‚ä¸å¯ç”¨ï¼Œè·å–ä¿¡å·é‡æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šè¿›å…¥ç¡çœ ï¼Œå½“ä¿¡å·é‡ä¸ºæ­£æ—¶è¢«å”¤é†’ï¼›
ç”±äºWaitGroupå®ç°ä¸­ä¹Ÿä½¿ç”¨äº†ä¿¡å·é‡ï¼Œåœ¨æ­¤åšä¸ªç®€å•ä»‹ç»ã€‚
<!-- more -->
3 WaitGroup
3.1 æ•°æ®ç»“æ„
æºç åŒ…ä¸­src/sync/waitgroup.go:WaitGroupå®šä¹‰äº†å…¶æ•°æ®ç»“æ„ï¼š</p>

<p>type WaitGroup struct {
	state1 [3]uint32
}
state1æ˜¯ä¸ªé•¿åº¦ä¸º3çš„æ•°ç»„ï¼Œå…¶ä¸­åŒ…å«äº†stateå’Œä¸€ä¸ªä¿¡å·é‡ï¼Œè€Œstateå®é™…ä¸Šæ˜¯ä¸¤ä¸ªè®¡æ•°å™¨ï¼š</p>

<p>counterï¼š å½“å‰è¿˜æœªæ‰§è¡Œç»“æŸçš„goroutineè®¡æ•°å™¨
waiter count: ç­‰å¾…goroutine-groupç»“æŸçš„goroutineæ•°é‡ï¼Œå³æœ‰å¤šå°‘ä¸ªç­‰å€™è€…
semaphore: ä¿¡å·é‡
è€ƒè™‘åˆ°å­—èŠ‚æ˜¯å¦å¯¹é½ï¼Œä¸‰è€…å‡ºç°çš„ä½ç½®ä¸åŒï¼Œä¸ºç®€å•èµ·è§ï¼Œä¾ç…§å­—èŠ‚å·²å¯¹é½æƒ…å†µä¸‹
<img src="https://xiazemin.github.io/MyBlog/img/waitgroup.jpg" />
WaitGroupå¯¹å¤–æä¾›ä¸‰ä¸ªæ¥å£ï¼š</p>

<p>Add(delta int): å°†deltaå€¼åŠ åˆ°counterä¸­
Wait()ï¼š waiteré€’å¢1ï¼Œå¹¶é˜»å¡ç­‰å¾…ä¿¡å·é‡semaphore
Done()ï¼š counteré€’å‡1ï¼ŒæŒ‰ç…§waiteræ•°å€¼é‡Šæ”¾ç›¸åº”æ¬¡æ•°ä¿¡å·é‡
ä¸‹é¢åˆ†åˆ«ä»‹ç»è¿™ä¸‰ä¸ªå‡½æ•°çš„å®ç°ç»†èŠ‚ã€‚</p>

<p>3.2 Add(delta int)
Add()åšäº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯æŠŠdeltaå€¼ç´¯åŠ åˆ°counterä¸­ï¼Œå› ä¸ºdeltaå¯ä»¥ä¸ºè´Ÿå€¼ï¼Œä¹Ÿå°±æ˜¯è¯´counteræœ‰å¯èƒ½å˜æˆ0æˆ–è´Ÿå€¼ï¼Œæ‰€ä»¥ç¬¬äºŒä»¶äº‹å°±æ˜¯å½“counterå€¼å˜ä¸º0æ—¶ï¼Œè·Ÿæ®waiteræ•°å€¼é‡Šæ”¾ç­‰é‡çš„ä¿¡å·é‡ï¼ŒæŠŠç­‰å¾…çš„goroutineå…¨éƒ¨å”¤é†’ï¼Œå¦‚æœcounterå˜ä¸ºè´Ÿå€¼ï¼Œåˆ™panic.</p>

<p>Add()ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>

<p>func (wg *WaitGroup) Add(delta int) {
    statep, semap := wg.state() //è·å–stateå’Œsemaphoreåœ°å€æŒ‡é’ˆ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>state := atomic.AddUint64(statep, uint64(delta)&lt;&lt;32) //æŠŠdeltaå·¦ç§»32ä½ç´¯åŠ åˆ°stateï¼Œå³ç´¯åŠ åˆ°counterä¸­
v := int32(state &gt;&gt; 32) //è·å–counterå€¼
w := uint32(state)      //è·å–waiterå€¼

if v &lt; 0 {              //ç»è¿‡ç´¯åŠ åcounterå€¼å˜ä¸ºè´Ÿå€¼ï¼Œpanic
    panic("sync: negative WaitGroup counter")
}

//ç»è¿‡ç´¯åŠ åï¼Œæ­¤æ—¶ï¼Œcounter &gt;= 0
//å¦‚æœcounterä¸ºæ­£ï¼Œè¯´æ˜ä¸éœ€è¦é‡Šæ”¾ä¿¡å·é‡ï¼Œç›´æ¥é€€å‡º
//å¦‚æœwaiterä¸ºé›¶ï¼Œè¯´æ˜æ²¡æœ‰ç­‰å¾…è€…ï¼Œä¹Ÿä¸éœ€è¦é‡Šæ”¾ä¿¡å·é‡ï¼Œç›´æ¥é€€å‡º
if v &gt; 0 || w == 0 {
    return
}

//æ­¤æ—¶ï¼Œcounterä¸€å®šç­‰äº0ï¼Œè€Œwaiterä¸€å®šå¤§äº0ï¼ˆå†…éƒ¨ç»´æŠ¤waiterï¼Œä¸ä¼šå‡ºç°å°äº0çš„æƒ…å†µï¼‰ï¼Œ
//å…ˆæŠŠcounterç½®ä¸º0ï¼Œå†é‡Šæ”¾waiterä¸ªæ•°çš„ä¿¡å·é‡
*statep = 0
for ; w != 0; w-- {
    runtime_Semrelease(semap, false) //é‡Šæ”¾ä¿¡å·é‡ï¼Œæ‰§è¡Œä¸€æ¬¡é‡Šæ”¾ä¸€ä¸ªï¼Œå”¤é†’ä¸€ä¸ªç­‰å¾…è€…
} } 3.3 Wait() Wait()æ–¹æ³•ä¹Ÿåšäº†ä¸¤ä»¶äº‹ï¼Œä¸€æ˜¯ç´¯åŠ waiter, äºŒæ˜¯é˜»å¡ç­‰å¾…ä¿¡å·é‡
</code></pre></div></div>

<p>func (wg *WaitGroup) Wait() {
    statep, semap := wg.state() //è·å–stateå’Œsemaphoreåœ°å€æŒ‡é’ˆ
    for {
        state := atomic.LoadUint64(statep) //è·å–stateå€¼
        v := int32(stateÂ Â» 32)            //è·å–counterå€¼
        w := uint32(state)                 //è·å–waiterå€¼
        if v == 0 {                        //å¦‚æœcounterå€¼ä¸º0ï¼Œè¯´æ˜æ‰€æœ‰goroutineéƒ½é€€å‡ºäº†ï¼Œä¸éœ€è¦å¾…å¾…ï¼Œç›´æ¥è¿”å›
            return
        }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // ä½¿ç”¨CASï¼ˆæ¯”è¾ƒäº¤æ¢ç®—æ³•ï¼‰ç´¯åŠ waiterï¼Œç´¯åŠ å¯èƒ½ä¼šå¤±è´¥ï¼Œå¤±è´¥åé€šè¿‡for loopä¸‹æ¬¡é‡è¯•
    if atomic.CompareAndSwapUint64(statep, state, state+1) {
        runtime_Semacquire(semap) //ç´¯åŠ æˆåŠŸåï¼Œç­‰å¾…ä¿¡å·é‡å”¤é†’è‡ªå·±
        return
    }
} } è¿™é‡Œç”¨åˆ°äº†CASç®—æ³•ä¿è¯æœ‰å¤šä¸ªgoroutineåŒæ—¶æ‰§è¡ŒWait()æ—¶ä¹Ÿèƒ½æ­£ç¡®ç´¯åŠ waiterã€‚
</code></pre></div></div>

<p>3.4 Done()
Done()åªåšä¸€ä»¶äº‹ï¼Œå³æŠŠcounterå‡1ï¼Œæˆ‘ä»¬çŸ¥é“Add()å¯ä»¥æ¥å—è´Ÿå€¼ï¼Œæ‰€ä»¥Doneå®é™…ä¸Šåªæ˜¯è°ƒç”¨äº†Add(-1)ã€‚</p>

<p>æºç å¦‚ä¸‹ï¼š</p>

<p>func (wg *WaitGroup) Done() {
	wg.Add(-1)
}
Done()çš„æ‰§è¡Œé€»è¾‘å°±è½¬åˆ°äº†Add()ï¼Œå®é™…ä¸Šä¹Ÿæ­£æ˜¯æœ€åä¸€ä¸ªå®Œæˆçš„goroutineæŠŠç­‰å¾…è€…å”¤é†’çš„ã€‚</p>

<p>4 ç¼–ç¨‹Tips
Add()æ“ä½œå¿…é¡»æ—©äºWait(), å¦åˆ™ä¼španic
Add()è®¾ç½®çš„å€¼å¿…é¡»ä¸å®é™…ç­‰å¾…çš„goroutineä¸ªæ•°ä¸€è‡´ï¼Œå¦åˆ™ä¼španic</p>

<p>// unsafe.Pointerå…¶å®å°±æ˜¯ç±»ä¼¼Cçš„void <em>ï¼Œåœ¨golangä¸­æ˜¯ç”¨äºå„ç§æŒ‡é’ˆç›¸äº’è½¬æ¢çš„æ¡¥æ¢ã€‚
// uintptræ˜¯golangçš„å†…ç½®ç±»å‹ï¼Œæ˜¯èƒ½å­˜å‚¨æŒ‡é’ˆçš„æ•´å‹ï¼Œuintptrçš„åº•å±‚ç±»å‹æ˜¯intï¼Œå®ƒå’Œunsafe.Pointerå¯ç›¸äº’è½¬æ¢ã€‚
// uintptrå’Œunsafe.Pointerçš„åŒºåˆ«å°±æ˜¯ï¼šunsafe.Pointeråªæ˜¯å•çº¯çš„é€šç”¨æŒ‡é’ˆç±»å‹ï¼Œç”¨äºè½¬æ¢ä¸åŒç±»å‹æŒ‡é’ˆï¼Œå®ƒä¸å¯ä»¥å‚ä¸æŒ‡é’ˆè¿ç®—ï¼›
// è€Œuintptræ˜¯ç”¨äºæŒ‡é’ˆè¿ç®—çš„ï¼ŒGC ä¸æŠŠ uintptr å½“æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ uintptr æ— æ³•æŒæœ‰å¯¹è±¡ï¼Œuintptrç±»å‹çš„ç›®æ ‡ä¼šè¢«å›æ”¶ã€‚
// state()å‡½æ•°å¯ä»¥è·å–åˆ°wg.state1æ•°ç»„ä¸­å…ƒç´ ç»„æˆçš„äºŒè¿›åˆ¶å¯¹åº”çš„åè¿›åˆ¶çš„å€¼
func (wg *WaitGroup) state() *uint64 {
	if uintptr(unsafe.Pointer(&amp;wg.state1))%8 == 0 {
		return (</em>uint64)(unsafe.Pointer(&amp;wg.state1))
	} else {
		return (*uint64)(unsafe.Pointer(&amp;wg.state1[4]))
	}
}</p>
:ET