I"Í<p>https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/
åè®®
https://github.com/grpc/grpc-proto/blob/master/grpc/health/v1/health.proto
https://github.com/grpc/grpc/blob/v1.15.0/doc/health-checking.md
https://github.com/grpc-ecosystem/grpc-health-probe/
https://github.com/grpc/grpc-proto/blob/master/grpc/health/v1/health.proto</p>

<p>Kubernetes å¥åº·æ£€æŸ¥ ï¼ˆliveness and readiness probesï¼‰å°±æ˜¯è®©æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨æ‚¨ç¡è§‰æ—¶ä¿æŒå¯ç”¨çš„åŸå› ã€‚
httpGet probe: ä¸èƒ½ä¸gRPCåŸç”Ÿä½¿ç”¨ã€‚æ‚¨éœ€è¦é‡æ„æ‚¨çš„åº”ç”¨ç¨‹åºä»¥åŒæ—¶æä¾›gRPCå’ŒHTTP / 1.1åè®®ï¼ˆåœ¨ä¸åŒçš„ç«¯å£å·ä¸Šï¼‰ã€‚
tcpSocket probe: æ‰“å¼€å¥—æ¥å­—åˆ°gRPCæœåŠ¡å™¨æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºå®ƒæ— æ³•è¯»å–å“åº”æ­£æ–‡ã€‚
exec probe: è¿™ä¼šå®šæœŸè°ƒç”¨å®¹å™¨ç”Ÿæ€ç³»ç»Ÿä¸­çš„ç¨‹åºã€‚å¯¹äºgRPCï¼Œè¿™æ„å‘³ç€æ‚¨è‡ªå·±å®ç°å¥åº·RPCï¼Œç„¶åä½¿ç”¨ç¼–å†™å®¢æˆ·ç«¯å·¥å…·ï¼Œå¹¶å°†å®¢æˆ·ç«¯ å·¥å…· ä¸å®¹å™¨æ‰“åŒ…åˆ°ä¸€èµ·ã€‚
<!-- more -->
gRPCæœ‰ä¸€ä¸ª æ ‡å‡†çš„å¥åº·æ£€æŸ¥åè®® ã€‚å®ƒå¯ä»¥ä»ä»»ä½•è¯­è¨€è½»æ¾ä½¿ç”¨ã€‚ç”Ÿæˆçš„ä»£ç å’Œç”¨äºè®¾ç½®è¿è¡ŒçŠ¶å†µçš„å®ç”¨ç¨‹åºå‡ ä¹éƒ½åœ¨gRPCçš„æ‰€æœ‰è¯­è¨€å®ç°ä¸­æä¾›ã€‚</p>

<p>å¦‚æœåœ¨gRPCåº”ç”¨ç¨‹åºä¸­å®ç°æ­¤è¿è¡ŒçŠ¶å†µæ£€æŸ¥åè®®ï¼Œåˆ™å¯ä»¥ä½¿ç”¨æ ‡å‡†/é€šç”¨å·¥å…·è°ƒç”¨æ­¤Checkï¼ˆï¼‰æ–¹æ³•æ¥ç¡®å®š æœåŠ¡å™¨ çŠ¶æ€ã€‚</p>

<p>ä½¿ç”¨æ­¤å·¥å…·ï¼Œæ‚¨å¯ä»¥åœ¨æ‰€æœ‰gRPCåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨ç›¸åŒçš„è¿è¡ŒçŠ¶å†µæ£€æŸ¥é…ç½®ã€‚è¿™ç§æ–¹æ³•éœ€è¦ä½ ï¼š</p>

<p>é€‰æ‹©æ‚¨å–œæ¬¢çš„è¯­è¨€æ‰¾åˆ°gRPCâ€œhealthâ€æ¨¡å—å¹¶å¼€å§‹ä½¿ç”¨å®ƒï¼ˆä¾‹å¦‚ Goåº“ ï¼‰ã€‚
å°†grpc_health_probeäºŒè¿›åˆ¶æ–‡ä»¶æ‰“åˆ°å®¹å™¨ä¸­ã€‚
é…ç½®Kubernetesâ€œexecâ€æ¢é’ˆä»¥è°ƒç”¨å®¹å™¨ä¸­çš„â€œgrpc_health_probeâ€å·¥å…·ã€‚
ç¤ºä¾‹
æ‚¨å¯ä»¥å°†é™æ€ç¼–è¯‘çš„grpc_health_probeæ‰“åœ¨å®¹å™¨æ˜ åƒä¸­ã€‚é€‰æ‹©äºŒè¿›åˆ¶ç‰ˆæœ¬å¹¶å°†å…¶ä¸‹è½½åˆ°Dockerfileä¸­ï¼š</p>

<p>RUN GRPC_HEALTH_PROBE_VERSION=v0.2.0 &amp;&amp; <br />
    wget -qO/bin/grpc_health_probe https://github.com/grpc-ecosystem/grpc-health-probe/releases/download/${GRPC_HEALTH_PROBE_VERSION}/grpc_health_probe-linux-amd64 &amp;&amp; <br />
    chmod +x /bin/grpc_health_probe</p>

<p>åœ¨ä½ çš„ Kubernetes Pod manifestä¸­,æŒ‡å®šå®¹å™¨çš„ livenessProbe and/or readinessProbe ã€‚</p>

<p>spec:
  containers:</p>
<ul>
  <li>name: server
image: â€œ[YOUR-DOCKER-IMAGE]â€
ports:
    <ul>
      <li>containerPort: 5000
readinessProbe:
exec:
  command: [â€œ/bin/grpc_health_probeâ€, â€œ-addr=:5000â€]
initialDelaySeconds: 5
livenessProbe:
exec:
  command: [â€œ/bin/grpc_health_probeâ€, â€œ-addr=:5000â€]
initialDelaySeconds: 10</li>
    </ul>
  </li>
</ul>

<p>æœåŠ¡å™¨å¥åº·æ£€æŸ¥çš„ä»£ç å®ç°ï¼Œä¸»è¦éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>

<p>hsrv := health.NewServer()
    hsrv.SetServingStatus(â€œâ€, healthpb.HealthCheckResponse_SERVING)
    healthpb.RegisterHealthServer(s, hsrv)</p>

<p>https://www.codercto.com/a/64490.html
https://blog.csdn.net/weixin_33188832/article/details/115930691</p>

<p>https://studygolang.com/articles/18609
https://www.ucloud.cn/yun/33135.html
https://kubernetes.io/zh/blog/2018/10/01/%E5%9C%A8-kubernetes-%E4%B8%8A%E5%AF%B9-grpc-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%9B%E8%A1%8C%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5/
https://zhuanlan.zhihu.com/p/136112161
https://blog.csdn.net/liuliuzi_hz/article/details/78810599</p>
:ET