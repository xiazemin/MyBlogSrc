I"ÕR<p>https://xargin.com/debugger/
å¸¸è§çš„å·¥ç¨‹è¯­è¨€å¯åˆ†ä¸ºè§£é‡Šå‹å’Œç¼–è¯‘å‹ä¸¤ç§ï¼Œæ¯”å¦‚å†™ php çš„ï¼Œä¸€èˆ¬å°±ä¸æ€ä¹ˆåœ¨ä¹ debugger ä¹‹ç±»çš„ä¸œè¥¿ã€‚ä¸ºä»€ä¹ˆï¼Ÿ<del>å¦‚æœçœŸå‡ºäº†é—®é¢˜ï¼Œæˆ‘å¯ä»¥ä¸´æ—¶æŠŠå‡ºé—®é¢˜çš„æœåŠ¡æœºå™¨ä»çº¿ä¸ŠæœåŠ¡ä¸­æ‘˜é™¤å‡ºæ¥ï¼Œç”šè‡³ç”³è¯·ä¸€ä¸ªè¾ƒé«˜çš„æƒé™å»ä¿®æ”¹ä»£ç ï¼Œç„¶ååˆ°å¤„å» die/echoã€‚è™½ç„¶æœ‰äººè¯´è¿™ä¹ˆåšä¸å¤ªå¥½ï¼Œæˆ–è€…ä¸€èˆ¬å…¬å¸ä¹Ÿä¸ç»™å¼€æƒé™ã€‚ä¸è¿‡ç€æ€¥çš„æ—¶å€™ï¼Œè¿™ä¸ªè‚¯å®šæ˜¯å¯è¡Œçš„ã€‚</del>ç„¶è€Œåƒ java/go è¿™ç§ç¼–è¯‘å‹çš„å°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚çº¿ä¸Šä¸€èˆ¬åªæœ‰ç¨‹åºçš„è¿è¡Œç¯å¢ƒè€Œæ²¡æœ‰ç¼–è¯‘ç¯å¢ƒã€‚å°±ç®—æ˜¯åœ¨çº¿ä¸‹ï¼Œæ¯æ¬¡å»åŠ ä¸€è¡Œ fmt.Println æˆ–è€… System.out.println éƒ½å»ç¼–è¯‘ä¸€éä»£ç ä¹Ÿæ˜¯ä¼šæ˜æ˜¾é™ä½å¹¸ç¦æ„Ÿçš„äº‹æƒ…(å½“ç„¶è¿™é‡Œæœ‰äººè¯´ç°åœ¨ java æ”¯æŒ hotswap ä¹‹ç±»çš„åŠŸèƒ½ï¼Œä¸è¿‡ä½ æ€»è¿˜æ˜¯ä¼šé‡åˆ°éœ€è¦é‡æ–°ç¼–è¯‘çš„åœºæ™¯ã€‚go ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé¡¹ç›®å¤§äº†ï¼Œç¼–è¯‘æ—¶é—´è¿˜æ˜¯å¯èƒ½ä¼šæœ‰ä¸ªäº”å…­ä¸ƒå…«ç§’çš„ã€‚æƒ³è¦è¿…é€Ÿåœ°è¿˜åŸ bug çš„ç°åœºï¼Œé‚£è¿˜æ˜¯èƒ½ç”¨ debugger ä¸ºä¸Šã€‚</p>

<p>é™¤äº†æ‹¿ debugger æ¥ debugã€‚è¿˜å¯ä»¥ç”¨ debugger æ¥äº†è§£äº†è§£ç¨‹åºè¿è¡Œçš„æœºåˆ¶ï¼Œæˆ–è€…ç”¨ disass æ¥æŸ¥çœ‹ç¨‹åºè¿è¡Œçš„æ±‡ç¼–ç ã€‚è¿™ä¸€ç‚¹ä¹Ÿå¾ˆé‡è¦ã€‚åº”ç”¨å±‚çš„è¯­è¨€å¾ˆå¤šæ—¶å€™å› ä¸º runtime äº‹æ— å·¨ç»†çš„å°è£…ï¼Œå·²ç»ä¸æ˜¯æ‰€è§å³æ‰€å¾—çš„ä¸œè¥¿äº†ï¼Œç‰¹åˆ«æ˜¯åƒ go è¿™æ ·ï¼Œä½ å†™ä¸€ä¸ª var a = 1 å´è¿æœ€ç»ˆè¿™ä¸ªå˜é‡ä¼šè¢«åˆ†é…åˆ°å †ä¸Šè¿˜æ˜¯æ ˆä¸Šéƒ½ä¸çŸ¥é“ã€‚è€Œåƒåº”ç”¨å±‚çš„ç©º interface å’Œéç©ºçš„ interface å®é™…çš„æ•°æ®ç»“æ„å®Œå…¨ä¸ä¸€æ ·ï¼Œè¿™äº›å¦‚æœä½ æƒ³çŸ¥é“çš„è¯ä¸€æ–¹é¢å¯ä»¥é€šè¿‡é˜…è¯»æºä»£ç ï¼Œä½† go çš„æºä»£ç åˆ°ä½ çš„ä»£ç ä¹‹é—´å§‹ç»ˆè¿˜æ˜¯æœ‰ä¸€ä¸ªè½¬æ¢è¿‡ç¨‹ã€‚å¦‚æœä½ å¯ä»¥é€šè¿‡æ±‡ç¼–ç›´æ¥æŸ¥çœ‹è¿è¡Œæ—¶çš„ç»“æ„æ˜¾ç„¶è¦æ›´ä¸ºç›´è§‚ã€‚
<!-- more -->
è¿™ç¯‡æ–‡ç« ä¹Ÿä¸å‡†å¤‡å†™å¾—å¤§è€Œå…¨ï¼Œå°±ç®€å•åœ°ä¸¾ä¸€äº›å¯ä»¥é  debugger æ¥å¸®æˆ‘ä»¬æ›´æ¸…æ¥šåœ°è®¤è¯†é—®é¢˜çš„åœºæ™¯å§ã€‚</p>

<p>var a = new(T) å’Œ var a = &amp;T{} è¿™ä¸¤ç§è¯­æ³•æœ‰åŒºåˆ«ä¹ˆï¼Ÿ
å†™ä¸¤ä¸ªå·®ä¸å¤šçš„ç¨‹åºï¼Œç„¶åå¸¦ä¸Š gcflags=â€-N -lâ€ æ¥ go build</p>

<p>-&gt; 5   	func main() {</p>

<p>di`main.main:
-&gt;  0x104f400 &lt;+0&gt;:  sub    rsp, 0x28
    0x104f404 &lt;+4&gt;:  mov    qword ptr [rsp + 0x20], rbp
    0x104f409 &lt;+9&gt;:  lea    rbp, [rsp + 0x20]</p>

<p>** 6   		var a = &amp;T{}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104f40e &lt;+14&gt;: mov    qword ptr [rsp], 0x0
0x104f416 &lt;+22&gt;: lea    rax, [rsp]
0x104f41a &lt;+26&gt;: mov    qword ptr [rsp + 0x18], rax
0x104f41f &lt;+31&gt;: test   al, byte ptr [rax]
0x104f421 &lt;+33&gt;: mov    qword ptr [rsp], 0x0
0x104f429 &lt;+41&gt;: mov    rax, qword ptr [rsp + 0x18]
0x104f42e &lt;+46&gt;: mov    qword ptr [rsp + 0x10], rax
</code></pre></div></div>

<p>** 7   		a.age += 1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104f433 &lt;+51&gt;: test   al, byte ptr [rax]
0x104f435 &lt;+53&gt;: mov    rax, qword ptr [rax]
0x104f438 &lt;+56&gt;: mov    qword ptr [rsp + 0x8], rax
0x104f43d &lt;+61&gt;: mov    rcx, qword ptr [rsp + 0x10]
0x104f442 &lt;+66&gt;: test   al, byte ptr [rcx]
0x104f444 &lt;+68&gt;: inc    rax
0x104f447 &lt;+71&gt;: mov    qword ptr [rcx], rax -&gt; 5   	func main() {
</code></pre></div></div>

<p>di2`main.main:
-&gt;  0x104f400 &lt;+0&gt;:  sub    rsp, 0x20
    0x104f404 &lt;+4&gt;:  mov    qword ptr [rsp + 0x18], rbp
    0x104f409 &lt;+9&gt;:  lea    rbp, [rsp + 0x18]</p>

<p>** 6   		var a = new(T)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104f40e &lt;+14&gt;: mov    qword ptr [rsp], 0x0
0x104f416 &lt;+22&gt;: lea    rax, [rsp]
0x104f41a &lt;+26&gt;: mov    qword ptr [rsp + 0x10], rax
</code></pre></div></div>

<p>** 7   		a.age += 1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104f41f &lt;+31&gt;: test   al, byte ptr [rax]
0x104f421 &lt;+33&gt;: mov    rax, qword ptr [rsp]
0x104f425 &lt;+37&gt;: mov    qword ptr [rsp + 0x8], rax
0x104f42a &lt;+42&gt;: mov    rcx, qword ptr [rsp + 0x10]
0x104f42f &lt;+47&gt;: test   al, byte ptr [rcx]
0x104f431 &lt;+49&gt;: inc    rax
0x104f434 &lt;+52&gt;: mov    qword ptr [rcx], rax ä¸¤ç§ä»£ç åç¼–è¯‘å‡ºæ¥çš„æ±‡ç¼–ä¸ä¸€è‡´ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ç§æ¯”ç¬¬äºŒç§å¤šè¦äº† 8 ä¸ªå­—èŠ‚çš„æ ˆç©ºé—´ã€‚å¯ä»¥çŒœæµ‹å®é™…ä¸Šç¬¬ä¸€ç§å†™æ³•æ˜¯åˆ†ä¸¤éƒ¨èµ°ï¼š
</code></pre></div></div>

<p>T{}ï¼›2.&amp; å–åœ°å€
go build ä¸å¸¦ gcflags å‚æ•°æ—¶ï¼Œä¸¤è€…å‡ºæ¥çš„æ±‡ç¼–ä»£ç å°±æ˜¯å®Œå…¨ä¸€è‡´çš„äº†ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒéªŒè¯ã€‚</p>

<p>æŸ¥çœ‹ go çš„ interface çš„æ•°æ®ç»“æ„
go çš„ interface ä¸€ç›´æ˜¯ä¸€ä¸ªæ¯”è¾ƒè®©äººçº ç»“çš„æ•°æ®ç»“æ„ï¼Œå®˜æ–¹å’Œä¿¡å¾’ä»¬ä» 14 å¹´å°±ä¸€ç›´åœ¨èŠ±ä¸å°‘ç¯‡å¹…è·Ÿä½ è®²ï¼Œæ€ä¹ˆåˆ¤æ–­ interface å’Œ nilï¼Œæˆ‘ä»¬è¿™ä¸ªè®¾è®¡æ˜¯è¿™æ ·çš„ blablaã€‚ä¸è¿‡æˆ‘å§‹ç»ˆè§‰å¾— go çš„ interface è®¾è®¡æ˜¯æœ‰ç‚¹é—®é¢˜çš„ï¼Œåªä¸è¿‡è¿™å¸® unix è€å¤è‘£ä»¬ä¸æƒ³æ‰¿è®¤ã€‚ã€‚ã€‚</p>

<p>å…ˆæ¥çœ‹ä¸€äº›ä¾‹å­å§ï¼š</p>

<p>package main</p>

<p>import (
	â€œbytesâ€
	â€œfmtâ€
	â€œioâ€
)</p>

<p>var (
	a *bytes.Buffer = nil
	b io.Writer
)</p>

<p>func set(v *bytes.Buffer) {
	if v == nil {
		fmt.Println(â€œv is nilâ€)
	}
	b = v
}</p>

<p>func get() {
	if b == nil {
		fmt.Println(â€œb is nilâ€)
	} else {
		fmt.Println(â€œb is not nilâ€)
	}
}</p>

<p>func main() {
	set(nil)
	get()
}</p>

<p>ä¾‹å­äºŒ(æ¥è‡ªæ¨è€å¸ˆæŸæ¬¡åˆ†äº«)ï¼š</p>

<p>package main</p>

<p>import (
	â€œfmtâ€
	â€œioâ€
	â€œosâ€
	â€œunsafeâ€
)</p>

<p>var (
	v  interface{}
	r  io.Reader
	f  *os.File
	fn os.File
)</p>

<p>func main() {
	fmt.Println(v == nil)
	fmt.Println(r == nil)
	fmt.Println(f == nil)
	v = r
	fmt.Println(v == nil)
	v = fn
	fmt.Println(v == nil)
	v = f
	fmt.Println(v == nil)
	r = f
	fmt.Println(r == nil)
}
å¯ä»¥è‡ªå·±è¿è¡Œä¸€ä¸‹çœ‹çœ‹ç»“æœã€‚æœ‰å¾ˆå¤šæ–‡ç« ä¼šè®²ï¼Œinterface åŒ…å«æœ‰ type å’Œ data ä¸¤ä¸ªå…ƒç´ ï¼Œåªæœ‰ä¸¤è€…å‡ä¸º nil çš„æ—¶å€™æ‰æ˜¯çœŸçš„ nilï¼Œç„¶åå†ç»™ä½ çŒè¾“äº†å¾ˆå¤šç†ç”±ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ã€‚ç”šè‡³è¿˜æ´å¼•äº† Rob Pike çš„æŸä¸ª pptã€‚</p>

<p>å¯¹è®¾è®¡çš„åæ§½å…ˆæ‰“ä½ï¼Œæˆ‘ä»¬çœ‹çœ‹ interface åœ¨è¿è¡ŒæœŸåˆ°åº•æ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„ä¸œè¥¿ï¼š</p>

<p>(lldb) p v
(interface {}) main.v = {
  _type = 0x0000000000000000
  data = 0x0000000000000000
}
(lldb) p r
(io.Reader) main.r = {
  tab = 0x0000000000000000
  data = 0x0000000000000000
}
(lldb) p f
(<em>os.File) main.f = 0x0000000000000000
è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨ golang ä¸­ç©º interface å’Œéç©º interface åœ¨æ•°æ®ç»“æ„ä¸Šä¹Ÿæ˜¯æœ‰å·®åˆ«çš„ã€‚ç©º interface å°±åªæœ‰ runtime._type å’Œ void</em> æŒ‡é’ˆç»„æˆã€‚è€Œéç©º interface åˆ™æ˜¯ runtime.itab å’Œ void* æŒ‡é’ˆç»„æˆã€‚</p>

<p>æŠŠ *os.File åˆ†åˆ«èµ‹å€¼ç»™ç©º interface å’Œ io.Reader ç±»å‹çš„æ¥å£å˜é‡ä¹‹åã€‚æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ª runtime._type å’Œ runtime.itab éƒ½å˜æˆä»€ä¹ˆæ ·äº†ï¼š</p>

<p>(lldb) p v
(interface {}) main.v = {
  _type = 0x00000000010be0a0
  data = 0x0000000000000000
}</p>

<p>(lldb) p *r.tab
(runtime.itab) *tab = {
  inter = 0x00000000010ad520
  _type = 0x00000000010be0a0
  link = 0x0000000000000000
  hash = 871609668
  bad = false
  inhash = true
  unused = ([0] = 0, [1] = 0)
  fun = ([0] = 0x000000000106d610)
}
éç©º interface çš„ _type æ˜¯å­˜å‚¨åœ¨ tab å­—æ®µé‡Œäº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œéç©º interface æœ¬èº«çš„ç±»å‹(è¿™é‡Œæ˜¯ io.Reader)å­˜å‚¨åœ¨ inter å­—æ®µä¸­ï¼š</p>

<p>(runtime.interfacetype) *inter = {
  typ = {
    size = 0x0000000000000010
    ptrdata = 0x0000000000000010
    hash = 3769182245
    tflag = 7
    align = 8
    fieldalign = 8
    kind = 20
    alg = 0x000000000113cd80
    gcdata = 0x00000000010d55f6
    str = 12137
    ptrToThis = 45152
  }
  pkgpath = {
    bytes = 0x0000000001094538
  }
  mhdr = (len 1, cap 1) {
    [0] = (name = 1236, ityp = 90528)
  }
}
æ­¤å¤–ï¼Œéç©º interface è¿˜ä¼šåœ¨ itab çš„ fun æ•°ç»„é‡Œå­˜å‚¨å‡½æ•°åˆ—è¡¨ã€‚</p>

<p>è¿™é‡Œä¼šæœ‰ä¸€ä¸ªéå¸¸è›‹ç–¼çš„åœ°æ–¹ï¼Œå¦‚æœä½ æŠŠä¸€ä¸ªéç©º interface ç±»å‹çš„ nil å€¼çš„ interface å˜é‡èµ‹å€¼ç»™ä¸€ä¸ªç©º interface ç±»å‹çš„å˜é‡ï¼Œé‚£ä¹ˆå°±ä¼šå¾—åˆ°ä¸€ä¸ªéç©ºç±»å‹çš„éç©º interface å˜é‡ã€‚</p>

<p>è¿™ç»å¯¹æ˜¯ go çš„è®¾è®¡ç¼ºé™·ã€‚ã€‚ã€‚</p>

<p>ç°åœ¨ä¸ºäº†é¿å…åˆ¤æ–­æ—¶å€™çš„å¤±è¯¯ï¼Œä¹Ÿæœ‰äººä¼šç”¨ reflect.ValueOf(v) æ¥åˆ¤æ–­ä¸€ä¸ª interface æ˜¯å¦ä¸º nilã€‚ä½†ä¹Ÿä¼šæ¯”è¾ƒåˆ«æ‰­ã€‚</p>

<p>å­¦ä¹  go çš„ channel
æ¥ä¸€ä¸ªç®€å•çš„ demoï¼š</p>

<p>package main</p>

<p>func main() {
	var a = make(chan int, 4)
	a &lt;- 1
	a &lt;- 1
	a &lt;- 1
	a &lt;- 1
	close(a)
	println()
}
æ‰“ä¸Šæ–­ç‚¹ï¼ŒæŸ¥çœ‹ a çš„ç»“æ„ï¼š</p>

<ul>
  <li>thread #1, stop reason = step over
  frame #0: 0x000000000104c354 normal_example`main.main at normal_example.go:5
 2
 3   	func main() {
 4   		var a = make(chan int, 4)
-&gt; 5   		a &lt;- 1
 6   		a &lt;- 1
 7   		a &lt;- 1
 8   		a &lt;- 1
Target 0: (normal_example) stopped.
(lldb) p a
(chan int) a = 0x000000c42007a000
(lldb) p *a
(hchan<int>) *a = {
qcount = 0
dataqsiz = 4
buf = 0x000000c42007a060
elemsize = 8
closed = 0
elemtype = 0x0000000001055ee0
sendx = 0
recvx = 0
recvq = {
  first = 0x0000000000000000
  last = 0x0000000000000000
}
sendq = {
  first = 0x0000000000000000
  last = 0x0000000000000000
}
lock = (key = 0x0000000000000000)
}
a.buf æ˜¯ void* ç±»å‹ï¼Œç±»ä¼¼ c/cè‰¹ï¼Œè¿™ç§ç±»å‹éœ€è¦ç”¨ x æŒ‡ä»¤æ¥è¯»å–å†…å®¹ï¼š</int></li>
</ul>

<p>(lldb) n
Process 21186 stopped</p>
<ul>
  <li>thread #1, stop reason = step over
  frame #0: 0x000000000104c369 normal_example`main.main at normal_example.go:6
 3   	func main() {
 4   		var a = make(chan int, 4)
 5   		a &lt;- 1
-&gt; 6   		a &lt;- 1
 7   		a &lt;- 1
 8   		a &lt;- 1
 9   		close(a)
Target 0: (normal_example) stopped.
(lldb) p a.buf
(void *) buf = 0x000000c42007a060
(lldb) x a.buf
0xc42007a060: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  â€¦â€¦â€¦â€¦â€¦.
0xc42007a070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  â€¦â€¦â€¦â€¦â€¦.
å¯ä»¥çœ‹åˆ°å‘ channel ä¸­å†™å…¥ä¸€ä¸ª 1 ä¹‹åï¼Œa.buf ä¸­çš„å†…å®¹å‘ç”Ÿäº†å˜åŒ–ã€‚åŒæ—¶ï¼Œa ä¸­çš„ sendx å’Œ qcount ä¹Ÿéƒ½å‘ç”Ÿäº†å˜åŒ–ï¼š</li>
</ul>

<p>(lldb) p *a
(hchan<int>) *a = {
  qcount = 1 // è¿™é‡Œè¿™é‡Œ
  dataqsiz = 4
  buf = 0x000000c42007a060
  elemsize = 8
  closed = 0
  elemtype = 0x0000000001055ee0
  sendx = 1 // è¿™é‡Œè¿™é‡Œ
  recvx = 0
  recvq = {
    first = 0x0000000000000000
    last = 0x0000000000000000
  }
  sendq = {
    first = 0x0000000000000000
    last = 0x0000000000000000
  }
  lock = (key = 0x0000000000000000)
}
è¿™æ ·å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ç»“åˆä»£ç ï¼Œè§‚å¯Ÿ channel çš„å‘é€å’Œæ¥æ”¶è¡Œä¸ºã€‚å…¶å®ä» debugger é‡Œå¾—åˆ°çš„ä¿¡æ¯éƒ½éå¸¸çš„ç›´è§‚ï¼Œæ¯”çœ‹å›¾è¡¨è¦ç›´è§‚å¾—å¤šã€‚æ¯”å¦‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœ‹åˆ° lock å­—æ®µã€‚è¿™ä¹Ÿè¯´æ˜ channel æœ¬èº«ä¸ºäº†å¹¶å‘å®‰å…¨æ˜¯å¸¦é”çš„ã€‚</int></p>

<p>recvq å’Œ sendq æ˜¯ç”¨æ¥ç»´æŠ¤å‘é€æ¥æ”¶æ—¶è¢«é˜»å¡éœ€è¦ä¼‘çœ çš„ goroutine åˆ—è¡¨ã€‚</p>

<p>elemtype æ˜¯ runtime._type ç±»å‹ï¼Œå¯ä»¥çœ‹åˆ° channel ä¸­çš„å…ƒç´ ç±»å‹ä¿¡æ¯ã€‚</p>

<p>close(a) ä»¥åå†çœ‹çœ‹ç»“æ„ï¼š</p>

<p>(chan int) a = 0x000000c42007a000
(lldb) p *a
(hchan<int>) *a = {
  qcount = 4
  dataqsiz = 4
  buf = 0x000000c42007a060
  elemsize = 8
  closed = 1 // é‡ç‚¹åœ¨è¿™é‡Œ
  elemtype = 0x0000000001055ee0
  sendx = 0
  recvx = 0
  recvq = {
    first = 0x0000000000000000
    last = 0x0000000000000000
  }
  sendq = {
    first = 0x0000000000000000
    last = 0x0000000000000000
  }
  lock = (key = 0x0000000000000000)
}
æ¯”ç”»ä¸€å †å›¾ä¸çŸ¥é“é«˜åˆ°å“ªé‡Œå»äº†ã€‚</int></p>

<p>å†å°è¯•åœ¨ a ä¸Šé˜»å¡å‡ ä¸ª goroutineï¼š</p>

<p>(lldb) p a.recvq
(waitq<int>) recvq = {
  first = 0x000000c42007c000
  last = 0x000000c42007c060
}
(lldb) p a.recvq.first
(*sudog<int>) first = 0x000000c42007c000
(lldb) p *a.recvq.first
(sudog<int>) *first = {
  g = 0x000000c420000f00
  isSelect = false
  next = 0x000000c42007c060
  prev = 0x0000000000000000
  elem = 0x0000000000000000
  acquiretime = 0
  releasetime = 0
  ticket = 0
  parent = 0x0000000000000000
  waitlink = 0x0000000000000000
  waittail = 0x0000000000000000
  c = 0x000000c42007a000
}
å¯ä»¥çœ‹åˆ°ï¼Œchannel çš„ recvq å’Œ sendq å°±æ˜¯ä¸ª sudog çš„åŒå‘é“¾è¡¨ï¼Œæ²¡æœ‰ä»€ä¹ˆéš¾ç†è§£çš„~</int></int></int></p>

<p>ç¡®è®¤ panic çš„ç°åœº
ç¨‹åºé‡Œæœ‰æ—¶å€™ä¼šæœ‰è¿™ç§ä»£ç ï¼š</p>

<p>someFunction(r.A, *r.B, *r.C, *r.D, r.E, *r.F)
ç„¶ååœ¨è¿™é‡Œ panic äº†ã€‚ä½†æ˜¯ go åªä¼šå‘Šè¯‰ä½  nil pointer deferenceï¼Œå´ä¸ä¼šå‘Šè¯‰ä½ æ˜¯å“ªä¸ª nil pointer deferenceã€‚ç€å®è›‹ç–¼ã€‚</p>

<p>è¿™ä¸ªå°±æ˜¯ç”¨ debugger æœ€åŸºæœ¬æ–­ç‚¹åŠŸèƒ½äº†ã€‚å¦‚æœæ˜¯ç”¨ delveï¼Œæ–­ç‚¹å¯ä»¥ç”¨å¾ˆå¤šç§æ–¹æ³•æ¥è®¾ç½®ï¼Œæ¯”å¦‚ function+è¡Œå·ï¼Œæ–‡ä»¶å+è¡Œå·ï¼Œå¦‚æœæœ‰æ­§ä¹‰ï¼Œdelve ä¹Ÿä¼šå‘Šè¯‰ä½ å…·ä½“è¦æ€ä¹ˆæ¥æ¶ˆé™¤æ­§ä¹‰ã€‚</p>

<p>(lldb) n
Process 22595 stopped</p>
<ul>
  <li>thread #1, stop reason = step over
  frame #0: 0x000000000104c344 nilPointer`main.main at nilPointer.go:16
 13  	}
 14
 15  	func main() {
-&gt; 16  		var t = T{A: 1}
 17  		test(t.A, *t.B, *t.C, *t.D, t.E, *t.F)
 18  	}
Target 0: (nilPointer) stopped.
(lldb) n
Process 22595 stopped</li>
  <li>thread #1, stop reason = step over
  frame #0: 0x000000000104c365 nilPointer`main.main at nilPointer.go:17
 14
 15  	func main() {
 16  		var t = T{A: 1}
-&gt; 17  		test(t.A, *t.B, *t.C, *t.D, t.E, *t.F)
 18  	}
Target 0: (nilPointer) stopped.
(lldb) p t
(main.T) t = {
A = 1
B = 0x0000000000000000
C = 0x0000000000000000
D = 0x0000000000000000
E = 0
F = 0x0000000000000000
}
å“ªé‡Œæ˜¯ nil ä¸€ç›®äº†ç„¶~</li>
</ul>

<p>string å’Œ byte ä¹‹é—´åˆ°åº•æœ‰æ²¡æœ‰è¿›è¡Œç›¸äº’è½¬æ¢
ä¾‹å­ï¼š</p>

<p>package main</p>

<p>func main() {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var str = "abcde"
var b = []byte("defg")

println(str)
println(string(b))
</code></pre></div></div>

<p>}</p>

<p>è¿˜æ˜¯çœ‹åç¼–è¯‘çš„ç»“æœï¼š</p>

<p>** 6   		var b = []byte(â€œdefgâ€)
   7</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104cf17 &lt;+71&gt;:  lea    rax, [rsp + 0x30]
0x104cf1c &lt;+76&gt;:  mov    qword ptr [rsp], rax
0x104cf20 &lt;+80&gt;:  lea    rax, [rip + 0x1c95b]      ; go.string.* + 210
0x104cf27 &lt;+87&gt;:  mov    qword ptr [rsp + 0x8], rax
0x104cf2c &lt;+92&gt;:  mov    qword ptr [rsp + 0x10], 0x4
0x104cf35 &lt;+101&gt;: call   0x1038390                 ; runtime.stringtoslicebyte at string.go:146
0x104cf3a &lt;+106&gt;: mov    rax, qword ptr [rsp + 0x20]
0x104cf3f &lt;+111&gt;: mov    rcx, qword ptr [rsp + 0x18]
0x104cf44 &lt;+116&gt;: mov    rdx, qword ptr [rsp + 0x28]
0x104cf49 &lt;+121&gt;: mov    qword ptr [rsp + 0xa0], rcx
0x104cf51 &lt;+129&gt;: mov    qword ptr [rsp + 0xa8], rax
0x104cf59 &lt;+137&gt;: mov    qword ptr [rsp + 0xb0], rdx é‡ç‚¹åœ¨è¿™é‡Œçš„

0x104cf35 &lt;+101&gt;: call   0x1038390                 ; runtime.stringtoslicebyte at string.go:146 runtime é‡Œè¿˜æœ‰ä¸€ä¸ªå¯¹åº”çš„ï¼š

0x104c624 &lt;+196&gt;: call   0x10378c0                 ; runtime.slicebytetostring at string.go:72 æœ‰äº†è¿™æ ·çš„æ‰‹æ®µï¼Œå¦‚æœåˆ«äººå’Œä½ è¯´ go ä¼šä¼˜åŒ– string å’Œ []byte ä¹‹é—´çš„è½¬æ¢ã€‚ä½ å°±å¯ä»¥éšæ—¶æå‡º debugger æ¥æ‰“ä»–çš„è„¸äº†ã€‚
</code></pre></div></div>

<p>æˆ‘ç¨‹åºçš„ select åˆ°åº•è¢«ç¿»è¯‘æˆä»€ä¹ˆæ ·çš„æ‰§è¡Œè¿‡ç¨‹äº†
select æ˜¯ golang æä¾›çš„ä¸€ç§ç‰¹æƒè¯­æ³•ï¼Œå®ç°çš„åŠŸèƒ½æ¯”è¾ƒç¥å¥‡ã€‚å…ˆä¸è¯´è¡Œä¸ºæ€ä¹ˆæ ·ã€‚è¿™ç§ç‰¹æƒè¯­æ³•å®é™…ä¸Šæœ€ç»ˆä¸€å®šä¼šè¢«ç¿»è¯‘æˆæŸç§æ±‡ç¼–æŒ‡ä»¤æˆ–è€… runtime çš„å†…ç½®å‡½æ•°ã€‚</p>

<p>ç”¨åæ±‡ç¼–æ¥çœ‹ä¸€çœ¼ã€‚</p>

<p>-&gt; 6   		select {</p>

<p>-&gt;  0x104e3d5 &lt;+117&gt;: mov    qword ptr [rsp + 0x38], 0x0
    0x104e3de &lt;+126&gt;: lea    rdi, [rsp + 0x40]
    0x104e3e3 &lt;+131&gt;: xorps  xmm0, xmm0
    0x104e3e6 &lt;+134&gt;: lea    rdi, [rdi - 0x10]
    0x104e3ea &lt;+138&gt;: mov    qword ptr [rsp - 0x10], rbp
    0x104e3ef &lt;+143&gt;: lea    rbp, [rsp - 0x10]
    0x104e3f4 &lt;+148&gt;: call   0x1048d5a                 ; runtime.duffzero + 250 at duff_amd64.s:87
    0x104e3f9 &lt;+153&gt;: mov    rbp, qword ptr [rbp]
    0x104e3fd &lt;+157&gt;: lea    rax, [rsp + 0x38]
    0x104e402 &lt;+162&gt;: mov    qword ptr [rsp], rax
    0x104e406 &lt;+166&gt;: mov    qword ptr [rsp + 0x8], 0xb8
    0x104e40f &lt;+175&gt;: mov    dword ptr [rsp + 0x10], 0x3
    0x104e417 &lt;+183&gt;: call   0x10305d0                 ; runtime.newselect at select.go:60</p>

<p>** 6   		select {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104e425 &lt;+197&gt;: mov    rax, qword ptr [rsp + 0x30]
</code></pre></div></div>

<p>** 6   		select {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104e445 &lt;+229&gt;: mov    rax, qword ptr [rsp + 0x28]
</code></pre></div></div>

<p>** 6   		select {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x104e46a &lt;+266&gt;: lea    rax, [rsp + 0x38]
0x104e46f &lt;+271&gt;: mov    qword ptr [rsp], rax
0x104e473 &lt;+275&gt;: call   0x1030b10                 ; runtime.selectgo at select.go:202
0x104e478 &lt;+280&gt;: mov    rax, qword ptr [rsp + 0x8]
0x104e47d &lt;+285&gt;: mov    qword ptr [rsp + 0x20], rax çœ‹èµ·æ¥ select è¢«ç¿»è¯‘æˆäº†å¤šæ®µæ±‡ç¼–ä»£ç ã€‚è¯´æ˜è¿™ä¸ªå‡½æ•°ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä¸è¿‡åæ±‡ç¼–è¿‡ç¨‹å·²ç»å¸®æˆ‘ä»¬å®šä½åˆ°äº† select è¢«ç¿»è¯‘æˆçš„å‡½æ•°çš„ä½ç½®ã€‚
</code></pre></div></div>

<p>å®é™…ä¸Š select çš„æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š
newselect-&gt;selectsend/selectrecv-&gt;selectgo è¿™å‡ ä¸ªè¿‡ç¨‹ã€‚å¦‚æœä½ çš„ç¨‹åºæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p>

<p>for {
  select {
     case &lt;-ch:
     case ch2&lt;-1:
     default:
  }
}
åœ¨æ¯æ¬¡è¿›å…¥ for å¾ªç¯çš„æ—¶å€™ï¼Œruntime é‡Œçš„ hselect ç»“æ„éƒ½ä¼šé‡æ–°åˆ›å»ºã€‚ä¹Ÿå°±æ˜¯è¯´å†™ä¸€ä¸ªæœ‰ default case çš„æ— é™å¾ªç¯ï¼Œä¸ä»…ä»…æ˜¯ä½ çŸ¥é“çš„ cpu å ç”¨çˆ†ç‚¸ï¼Œå®é™…ä¸Šè¿˜åœ¨ä¸æ–­åœ°åœ¨å †ä¸Šåˆ†é…ã€é‡Šæ”¾ã€åˆ†é…ã€é‡Šæ”¾ç©ºé—´ã€‚æ„Ÿè§‰è¿™é‡Œå®˜æ–¹åº”è¯¥æ˜¯å¯ä»¥åšä¸€äº›ä¼˜åŒ–çš„ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆé€»è¾‘è¿™ä¹ˆåŸå§‹ã€‚(å½“ç„¶ï¼Œåœ¨ go è¯­è¨€å­¦ä¹ ç¬”è®°é‡Œçœ‹åˆ°é›¨ç—•è€å¸ˆä¹Ÿåæ§½ä»–ä»¬çš„ä»£ç å†™å¾—æ¸£å“ˆå“ˆå“ˆã€‚</p>

<p>æ­£åœ¨è¿è¡Œçš„ goroutine åˆ°åº•æ˜¯é˜»å¡åœ¨ä»€ä¹ˆåœ°æ–¹äº†
golang ä¸­å¸¸è§çš„å†…å­˜æ³„éœ²å¥—è·¯æ˜¯è¿™æ ·çš„ï¼š</p>

<p>func main() {</p>

<p>var ch chan int
   go func() {
      select {
         case &lt;-ch:
      }
   }()
}
ç›‘å¬äº†ä¸€ä¸ªæ°¸è¿œé˜»å¡çš„ channelï¼Œæˆ–è€…å‘ä¸€ä¸ªæ²¡æœ‰æ¥æ”¶æ–¹çš„ channel å‘æ•°æ®ï¼Œå¦‚æœè¿™äº›äº‹æƒ…æ²¡æœ‰å‘ç”Ÿåœ¨ä¸» goroutine é‡Œçš„è¯ï¼Œåœ¨ runtime çš„ checkdead å‡½æ•°ä¸­ä¸ä¼šè®¤ä¸ºè¿™æ˜¯ä¸ª deadlockã€‚è€Œè¿™æ ·çš„ goroutine åˆ›å»ºè¿‡ç¨‹å¾€å¾€åœ¨ for å¾ªç¯é‡Œã€‚</p>

<p>å…¬å¸å†…çš„æŸä¸ªç¨‹åºå°±æ›¾ç»åœ¨çº¿ä¸‹ debug çš„æ—¶å€™å‘ç°æ¯æ¬¡æ¥ä¸€ä¸ªè¯·æ±‚ï¼Œå°±ä¼šå¯¼è‡´ goroutine æ€»æ•° +1ã€‚è¿™æ˜¾ç„¶æ˜¯ä¸æ­£å¸¸çš„ã€‚åœ¨ goroutine è¾¾åˆ°ä¸€å®šæ•°é‡ä¹‹åï¼Œå¯ä»¥é€‚ç”¨ delve attach åˆ°ä½ çš„è¿›ç¨‹ï¼Œç„¶åè¿è¡Œï¼š</p>

<p>goroutines
ä¸€ä¸‹å°±çœ‹åˆ°ä½ æ³„éœ²çš„ goroutine éƒ½æ˜¯å¡åœ¨ä»€ä¹ˆåœ°æ–¹äº†ã€‚</p>

<p>å½“ç„¶ï¼Œå¦‚æœä½ çš„ç¨‹åºå¼€äº† pprofï¼Œé‚£é€šè¿‡ç½‘é¡µæ¥çœ‹å€’æ˜¯æ›´ä¸ºæ–¹ä¾¿ã€‚</p>

<p>ä¹‹å‰å…¬å¸å†…çš„æŸä¸ªåº“åœ¨æ‰¾ä¸åˆ° disf çš„ ip çš„æ—¶å€™å°±ä¼šé˜»å¡åœ¨ lib çš„ channel ä¸Šã€‚ç”¨è¿™ä¸ªåŠæ³•å¯ä»¥éå¸¸å¿«çš„æ‰¾åˆ°é—®é¢˜æ ¹ç»“ã€‚ä¸ç”¨åƒæŸäº›ç¨‹åºå‘˜ä¸€æ ·åˆ°å¤„åŠ  fmt.Println äº†ã€‚</p>

<p>ç¨‹åºçš„ cpu å ç”¨éå¸¸é«˜ï¼Œä¼¼ä¹åœ¨å“ªé‡Œæœ‰æ­»å¾ªç¯
è¿™ä¸ªé—®é¢˜æœ‰ä¸¤ä¸ªå·¥å…·å¯ä»¥ç”¨ï¼Œä¸€ä¸ªæ˜¯ perfï¼Œä¸€ä¸ªæ˜¯ debuggerã€‚</p>

<p>sudo perf top
å¯ä»¥æ‰¾åˆ°æ­»å¾ªç¯æ‰€å¤„çš„ä½ç½®ï¼Œè¿™ä¸ªåœ¨ä¹‹å‰å†™çš„æ–‡ç« ä¸­æœ‰è¿‡æ¶‰åŠäº†ã€‚è¿™é‡Œå°±ä¸å†èµ˜è¿°ã€‚</p>

<p>è¿˜æœ‰ä¸€ç§æ­»å¾ªç¯ï¼Œä½†æ˜¯ç¨‹åºæœ¬èº«æ²¡æ­»æ‰çš„ï¼Œé‚£å°±å¯ä»¥ç›´æ¥ç”¨ dlv attach è¿›å»äº†ï¼ŒåŸºæœ¬ä¸Šåˆ‡æ¢è‡³å¯ç–‘çš„ goroutineï¼Œè·Ÿä¸ªåå‡ æ­¥å°±å¯ä»¥æ‰¾åˆ°é—®é¢˜æ‰€åœ¨ï¼Œå½“ç„¶ï¼Œç»“åˆ perf æ¥çœ‹æ›´é«˜æ•ˆã€‚è¿™ä¸ªå¯ä»¥å‚è€ƒä¹‹å‰å®šä½ jsoniter çš„ä¸€ä¸ªé—®é¢˜çš„æ—¶å€™çš„æ­¥éª¤ï¼šhttps://github.com/gin-gonic/gin/issues/1086ã€‚</p>

<p>æ€ä¹ˆä¸€ç›´è§‚å¯ŸæŸä¸€ä¸ªå˜é‡çš„å˜åŒ–è¿‡ç¨‹
ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨å¸Œæœ›è§‚å¯Ÿçš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œå¦‚æœæ–­ç‚¹ id æ˜¯ 13ï¼Œé‚£ä¹ˆç”¨ delve çš„ on å‘½ä»¤ï¼š</p>

<p>on 13 print xxx
å³å¯</p>

<p>(dlv) n</p>
<blockquote>
  <p>main.main() ./for.go:6 (hits goroutine(1):11 total:11) (PC: 0x44d694)
	count: 45
     1:	package main
     2:
     3:	func main() {
     4:		count:=0
     5:		for i:=0;i&lt;10000;i++ {
=&gt;   6:			count+=i
     7:		}
     8:		println(count)
     9:	}
(dlv) n
æˆ‘çš„ç¨‹åºåªæœ‰è¿è¡Œåˆ° for å¾ªç¯çš„ç¬¬ 1000 æ¬¡å ä»£çš„æ—¶å€™æ‰ä¼šå‡º bugï¼Œæˆ‘æ€ä¹ˆåœ¨ç¬¬ 1000 æ¬¡å¾ªç¯çš„æ—¶å€™æ‰è®¾ç½®è¿™ä¸ªæ–­ç‚¹
ç”¨ delve å¾ˆç®€å•ï¼š</p>
</blockquote>

<p>ubuntu@ubuntu-xenial:~$ dlv exec ./for
Type â€˜helpâ€™ for list of commands.
(dlv) b for.go:6
Breakpoint 1 set at 0x44d694 for main.main() ./for.go:6
(dlv) cond 1 i==1000 ////// =&gt; é‡ç‚¹åœ¨è¿™é‡Œ
(dlv) r
Process restarted with PID 29024
(dlv) c</p>
<blockquote>
  <p>main.main() ./for.go:6 (hits goroutine(1):1 total:1) (PC: 0x44d694)
     1:	package main
     2:
     3:	func main() {
     4:		count:=0
     5:		for i:=0;i&lt;10000;i++ {
=&gt;   6:			count+=i
     7:		}
     8:		println(count)
     9:	}
(dlv) p i
1000
(dlv) p count
499500</p>
</blockquote>
:ET