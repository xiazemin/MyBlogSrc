I"’<p>By default, for every client connection the MySQL server spawns a separate thread which will process all statements for this connection. This is the â€˜one-thread-per-connectionâ€™ model.</p>

<p>There are several implementations of the Thread Pool model:
â€“ Commercial: Oracle/MySQL provides thread_pool plugin as part of the Enterprise subscription
â€“ Open Source: The MariaDB thread_pool developed by Vladislav Vaintroub</p>

<p>https://www.percona.com/blog/2014/01/23/percona-server-improve-scalability-percona-thread-pool/
https://www.percona.com/blog/2019/02/25/mysql-challenge-100k-connections/</p>

<p>Step 1. 10,000 connections
This one is very easy, as there is not much to do to achieve this. We can do this with only one client. But you may face the following error on the client side:</p>

<p>FATAL: error 2004: Canâ€™t create TCP/IP socket (24)</p>

<p>This is caused by the open file limit, which is also a limit of TCP/IP sockets. This can be fixed by setting   ulimit -n 100000  on the client.</p>

<p>Step 2. 25,000 connections
With 25,000 connections, we hit an error on MySQL side:</p>

<p>Canâ€™t create a new thread (errno 11); if you are not out of available memory, you can consult the manual for a possible OS-dependent bug</p>

<p>Step 3. 50,000 connections
This is where we encountered the biggest challenge. At first, trying to get 50,000 connections in sysbench we hit the following error:</p>

<p>FATAL: error 2003: Canâ€™t connect to MySQL server on â€˜139.178.82.47â€™ (99)</p>

<p>Error (99) is cryptic and it means: Cannot assign requested address.</p>

<p>It comes from the limit of ports an application can open. By default on my system it is</p>

<p>cat /proc/sys/net/ipv4/ip_local_port_range : 32768   60999</p>

<p>This says there are only 28,231 available ports â€” 60999 minus 32768 â€” or the limit of TCP connections you can establish from or to the given IP address.</p>

<p>You can extend this using a wider range, on both the client and the server:</p>

<p>echo 4000 65000 &gt; /proc/sys/net/ipv4/ip_local_port_range</p>

<p>Step 4. 100,000 connections
There is nothing eventful to achieve75k and 100k connections. We just spin up an additional server and start sysbench. For 100,000 connections we need four servers for sysbench, each shows:</p>

<p>Shell
[ 101s] threads: 25000, tps: 0.00, reads: 8033.83, writes: 0.00, response time: 3320.21ms (95%), errors: 0.00, reconnects:  0.00
[ 102s] threads: 25000, tps: 0.00, reads: 8065.02, writes: 0.00, response time: 3405.77ms (95%), errors: 0.00, reconnects:  0.00
1
2
[ 101s] threads: 25000, tps: 0.00, reads: 8033.83, writes: 0.00, response time: 3320.21ms (95%), errors: 0.00, reconnects:  0.00
[ 102s] threads: 25000, tps: 0.00, reads: 8065.02, writes: 0.00, response time: 3405.77ms (95%), errors: 0.00, reconnects:  0.00
So we have the same throughput (8065*4=32260 tps in total) with 3405ms 95% response time.
<!-- more -->
MySQLçº¿ç¨‹ç”¨å®Œï¼Œæ–°è¿æ¥æ— æ³•è¿æ¥è§£å†³
å¦‚æœæœåŠ¡å™¨æœ‰å¤§é‡çš„é—²ç½®è¿æ¥ï¼Œè¿™æ ·å°±ä¼šç™½ç™½çš„æµªè´¹å†…å­˜ï¼Œä¸”å¦‚æœä¸€ç›´åœ¨ç´¯åŠ è€Œä¸æ–­å¼€çš„è¯ï¼Œå°±ä¼šè¾¾åˆ°è¿æ¥ä¸Šé™ï¼ŒæŠ¥â€too many connectionsâ€çš„é”™è¯¯ã€‚å¯é€šè¿‡å‘½ä»¤â€show process listâ€æŸ¥çœ‹ï¼Œè‹¥å‘ç°åå°æœ‰å¤§é‡çš„sleepçº¿ç¨‹ï¼Œæ­¤æ—¶å°±éœ€è¦è°ƒæ•´ä¸Šè¿°å‚æ•°äº†ã€‚</p>

<p>show variables like â€˜%max_connections%â€™;  â€“æŸ¥è¯¢å½“å‰è¿æ¥
å¯ä»¥åœ¨/etc/my.cnfé‡Œé¢è®¾ç½®æ•°æ®åº“çš„æœ€å¤§è¿æ¥æ•°
[mysqld]
max_connections = 1000
mysql&gt; show status like â€˜Threads%â€™;
+â€”â€”â€”â€”â€”â€”-+â€”â€”-+
| Variable_name     | Value |
+â€”â€”â€”â€”â€”â€”-+â€”â€”-+
| Threads_cached    | 58    |
| Threads_connected | 57    |   ###è¿™ä¸ªæ•°å€¼æŒ‡çš„æ˜¯æ‰“å¼€çš„è¿æ¥æ•°
| Threads_created   | 3676  |
| Threads_running   | 4     |   ###è¿™ä¸ªæ•°å€¼æŒ‡çš„æ˜¯æ¿€æ´»çš„è¿æ¥æ•°ï¼Œè¿™ä¸ªæ•°å€¼ä¸€èˆ¬è¿œä½äºconnectedæ•°å€¼</p>

<p>https://blog.51cto.com/renzhiyuan/1861841</p>

<p>https://www.kancloud.cn/thinkphp/mysql-faq/47447</p>

<p>MySQL Threads Running
Threads_running	MySQL
0 - 10	Normalï¼šå‡ ä¹æ‰€æœ‰ç¡¬ä»¶éƒ½æ²¡é—®é¢˜
10 - 30	Busyï¼šå¤§å¤šæ•°ç¡¬ä»¶é€šå¸¸éƒ½å¯ä»¥ï¼Œå› ä¸ºæœåŠ¡å™¨å¤šæ ¸
30 - 50	Highï¼šå¾ˆå°‘æœ‰å·¥ä½œè´Ÿè½½éœ€è¦è¿è¡Œè¿™ä¹ˆå¤šçº¿ç¨‹ã€‚å®ƒå¯ä»¥çŸ­æœŸçˆ†å‘ï¼ˆ&lt;5minï¼‰ï¼Œä½†å¦‚æœæŒç»­æ—¶é—´è¾ƒé•¿ï¼Œåˆ™å“åº”æ—¶é—´å¾ˆå¯èƒ½å¾ˆæ…¢
50 - 100	Overloadedï¼šæŸäº›ç¡¬ä»¶å¯ä»¥å¤„ç†æ­¤é—®é¢˜ï¼Œä½†æ˜¯ä¸èƒ½æœŸæœ›åœ¨æ­¤èŒƒå›´å†…æˆåŠŸè¿è¡Œã€‚å¯¹äºæˆ‘ä»¬çš„æœ¬åœ°éƒ¨ç½²ç¡¬ä»¶è€Œè¨€ï¼Œæ­¤èŒƒå›´å†…çš„ç¬æ—¶çªå‘ï¼ˆ&lt;5sï¼‰é€šå¸¸æ˜¯å¯ä»¥çš„ã€‚</p>
<blockquote>
  <p>100	Failingï¼šåœ¨æå°‘æ•°æƒ…å†µä¸‹ï¼ŒMySQLå¯ä»¥è¿è¡Œå¤§äº100ä¸ªçº¿ç¨‹ï¼Œä½†åœ¨æ­¤èŒƒå›´å†…å¯èƒ½ä¼šå¤±è´¥
â€‚â€‚â€‚â€‚å»ºè®®æŒ‡å¯¼å€¼ï¼š</p>
</blockquote>

<p>Threads_running &lt; 50
1:1000 Threads_runningï¼šQPS</p>

<p>è®©æˆ‘ä»¬æ¢ä¸ªè§’åº¦æ¥é˜æ˜ä¸€ä¸ªé‡è¦çš„é—®é¢˜ï¼šMySQLçº¿ç¨‹æ˜¯ä¸€ä¸ªæ•°æ®åº“è¿æ¥ã€‚Threads_runningæ˜¯æ´»åŠ¨æŸ¥è¯¢çš„æ•°æ®åº“è¿æ¥æ•°ã€‚è¯·è®°ä½ï¼Œæ¯ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹éƒ½æœ‰å…¶è‡ªå·±çš„æ•°æ®åº“è¿æ¥æ± ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ã€‚å› æ­¤ï¼Œæœ€å¤§å¯èƒ½çš„è¿æ¥ï¼ˆçº¿ç¨‹ï¼‰ä¸ºï¼š</p>

<p>â€‚â€‚â€‚â€‚è¿æ¥æ± å¤§å°ä¸º100æ˜¯åˆç†çš„ï¼Œä½†æ˜¯å¦‚æœå°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ°5ä¸ªåº”ç”¨ç¨‹åºå®ä¾‹ï¼Œåˆ™å¯èƒ½æœ‰500ä¸ªæ•°æ®åº“è¿æ¥ã€‚é€šå¸¸æ˜¯è¿™æ ·ï¼šåº”ç”¨ç¨‹åºé€šå¸¸å…·æœ‰æ•°ç™¾ä¸ªç©ºé—²æ•°æ®åº“è¿æ¥ï¼Œè¿™æ˜¯è¿æ¥æ± çš„ç”¨é€”ã€‚ï¼ˆå¯¹è¿æ¥çš„çº¿ç¨‹ï¼ŒMySQLä¹Ÿæœ‰ä¸€ä¸ªå°ºåº¦ï¼‰ç›´åˆ°åŒæ—¶è¿è¡Œè¿‡å¤šçš„è¿æ¥ï¼ˆçº¿ç¨‹ï¼‰ï¼Œè¿™æ‰æˆä¸ºé—®é¢˜ã€‚
â€‚â€‚â€‚â€‚ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸æ­¢ä¸€æ¬¡è¢«æ‰©å±•ï¼ˆå³éƒ¨ç½²æ›´å¤šçš„åº”ç”¨ç¨‹åºå®ä¾‹ï¼‰ä»¥å¤„ç†æ›´å¤šçš„è¯·æ±‚ï¼Œä½†è¿™æ ·åšä¼šä½¿æ•°æ®åº“è¿‡è½½ï¼Œè¿è¡Œçš„çº¿ç¨‹å¤ªå¤šã€‚æ²¡æœ‰å¿«é€Ÿæˆ–ç®€å•çš„è§£å†³æ–¹æ¡ˆæ¥è§£å†³è¿™ç§ç±»å‹çš„æ•°æ®åº“æ€§èƒ½é™åˆ¶ã€‚åŸå› å¾ˆç®€å•ï¼šå¦‚æœæ‚¨å¸Œæœ›MySQLåœ¨ç›¸åŒçš„æ—¶é—´ï¼ˆæ¯ç§’ï¼‰å†…æ‰§è¡Œæ›´å¤šçš„å·¥ä½œï¼ˆæŸ¥è¯¢ï¼‰ï¼Œåˆ™æ¯ä¸ªå·¥ä½œå¿…é¡»èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´ï¼Œå¦åˆ™æ— æ³•è¿›è¡Œè®¡ç®—ã€‚å¦‚æœæ¯ä¸ªæŸ¥è¯¢èŠ±è´¹100æ¯«ç§’ï¼Œåˆ™æ‰§è¡Œé€Ÿåº¦ä¸å¯èƒ½è¶…è¿‡10QPSã€‚
â€‚â€‚â€‚â€‚
â€‚â€‚â€‚â€‚https://blog.csdn.net/zsx0728/article/details/114536258
â€‚â€‚â€‚â€‚</p>

:ET