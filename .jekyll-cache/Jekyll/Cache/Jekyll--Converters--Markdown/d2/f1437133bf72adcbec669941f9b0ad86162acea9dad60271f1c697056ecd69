I"<ol>
  <li>spliceå‡½æ•°
 #include <fcntl.h>
ssize_t splice(int fd_in, loff_t *off_in, int fd_out, loff_t *off_out, size_t len, unsigned int flags);</fcntl.h></li>
</ol>

<p>spliceç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œ ä¹Ÿæ˜¯é›¶æ‹·è´ã€‚
fd_inå‚æ•°æ˜¯å¾…è¾“å…¥æè¿°ç¬¦ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œåˆ™off_inå¿…é¡»è®¾ç½®ä¸ºNULLï¼›å¦åˆ™off_inè¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å–ï¼Œæ­¤æ—¶è‹¥ä¸ºNULLï¼Œåˆ™ä»è¾“å…¥æ•°æ®æµçš„å½“å‰åç§»ä½ç½®è¯»å…¥ã€‚</p>

<p>fd_out/off_outä¸ä¸Šè¿°ç›¸åŒï¼Œä¸è¿‡æ˜¯ç”¨äºè¾“å‡ºã€‚</p>

<p>lenå‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦ã€‚</p>

<p>flagså‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼š</p>

<p>SPLICE_F_NONBLOCKï¼šsplice æ“ä½œä¸ä¼šè¢«é˜»å¡ã€‚ç„¶è€Œï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦æ²¡æœ‰è¢«è®¾ç½®ä¸ºä¸å¯è¢«é˜»å¡æ–¹å¼çš„ I/O ï¼Œé‚£ä¹ˆè°ƒç”¨ splice æœ‰å¯èƒ½ä»ç„¶è¢«é˜»å¡ã€‚
SPLICE_F_MOREï¼šå‘ŠçŸ¥æ“ä½œç³»ç»Ÿå†…æ ¸ä¸‹ä¸€ä¸ª splice ç³»ç»Ÿè°ƒç”¨å°†ä¼šæœ‰æ›´å¤šçš„æ•°æ®ä¼ æ¥ã€‚
SPLICE_F_MOVEï¼šå¦‚æœè¾“å‡ºæ˜¯æ–‡ä»¶ï¼Œè¿™ä¸ªå€¼åˆ™ä¼šä½¿å¾—æ“ä½œç³»ç»Ÿå†…æ ¸å°è¯•ä»è¾“å…¥ç®¡é“ç¼“å†²åŒºç›´æ¥å°†æ•°æ®è¯»å…¥åˆ°è¾“å‡ºåœ°å€ç©ºé—´ï¼Œè¿™ä¸ªæ•°æ®ä¼ è¾“è¿‡ç¨‹æ²¡æœ‰ä»»ä½•æ•°æ®æ‹·è´æ“ä½œå‘ç”Ÿã€‚</p>
<ol>
  <li>ä½¿ç”¨spliceæ—¶ï¼Œ fd_inå’Œfd_outä¸­å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
</ol>

<p>è°ƒç”¨æˆåŠŸæ—¶è¿”å›ç§»åŠ¨çš„å­—èŠ‚æ•°é‡ï¼›å®ƒå¯èƒ½è¿”å›0,è¡¨ç¤ºæ²¡æœ‰æ•°æ®éœ€è¦ç§»åŠ¨ï¼Œè¿™é€šå¸¸å‘ç”Ÿåœ¨ä»ç®¡é“ä¸­è¯»æ•°æ®æ—¶è€Œè¯¥ç®¡é“æ²¡æœ‰è¢«å†™å…¥çš„æ—¶å€™ã€‚</p>

<p>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®errno</p>
<ol>
  <li>ä»£ç ï¼šé€šè¿‡spliceå°†å®¢æˆ·ç«¯çš„å†…å®¹è¯»å…¥åˆ°ç®¡é“ä¸­ï¼Œ å†ä»ç®¡é“ä¸­è¯»å‡ºåˆ°å®¢æˆ·ç«¯ï¼Œä»è€Œå®ç°é«˜æ•ˆç®€å•çš„å›æ˜¾æœåŠ¡ã€‚æ•´ä¸ªè¿‡ç¨‹æœªæ‰§è¡Œrecv/sendï¼Œå› æ­¤ä¹Ÿæœªæ¶‰åŠç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ç©ºé—´çš„æ•°æ®æ‹·è´ã€‚</li>
</ol>

<p>//ä½¿ç”¨spliceå®ç°çš„å›æ˜¾æœåŠ¡å™¨
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;arpa/inet.h&gt;
#include <assert.h>
#include <errno.h>
#include <string.h>
#include <fcntl.h></fcntl.h></string.h></errno.h></assert.h></unistd.h></stdlib.h></stdio.h></p>

<p>int main(int argc, char **argv)
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (argc &lt;= 2) {
	printf("usage: %s ip port\n", basename(argv[0]));
	return 1;
}

const char *ip = argv[1];
int port = atoi(argv[2]);
 
struct sockaddr_in address;
bzero(&amp;address, sizeof(address));
address.sin_family = AF_INET;
address.sin_port = htons(port);
inet_pton(AF_INET, ip, &amp;address.sin_addr);
 
int sock = socket(PF_INET, SOCK_STREAM, 0);
assert(sock &gt;= 0);

int reuse = 1;
setsockopt(sock, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, sizeof(reuse));
 
int ret = bind(sock, (struct sockaddr*)&amp;address, sizeof(address));
assert(ret != -1);
 
ret = listen(sock, 5);
assert(ret != -1);

struct sockaddr_in client;
socklen_t client_addrlength = sizeof(client);

int connfd = accept(sock, (struct sockaddr*)&amp;client, &amp;client_addrlength);
if (connfd &lt; 0) {
	printf("errno is: %s\n", strerror(errno));
}
else {
	int pipefd[2];
			
	ret = pipe(pipefd);  //åˆ›å»ºç®¡é“
	assert(ret != -1);
	
            //å°†connfdä¸Šçš„å®¢æˆ·ç«¯æ•°æ®å®šå‘åˆ°ç®¡é“ä¸­
	ret = splice(connfd, NULL, pipefd[1], NULL,
					32768, SPLICE_F_MORE | SPLICE_F_MOVE);
	assert(ret != -1);
	
            //å°†ç®¡é“çš„è¾“å‡ºå®šå‘åˆ°connfdä¸Š
	ret = splice(pipefd[0], NULL, connfd, NULL,
					32768, SPLICE_F_MORE | SPLICE_F_MOVE);
	assert(ret != -1);				
	
	close(connfd);
}
 

close(sock);
 
 
 
 
return 0;
</code></pre></div></div>

<!-- more -->
:ET