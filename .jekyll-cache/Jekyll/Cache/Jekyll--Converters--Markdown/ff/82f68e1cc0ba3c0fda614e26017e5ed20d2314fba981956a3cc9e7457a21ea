I"¶<p>https://www.cnblogs.com/driftcloudy/p/3296525.html
https://www.cnblogs.com/driftcloudy/p/5400994.html</p>

<p>åªæ¢è®¨çº¯ç²¹çš„å‡½æ•°ï¼Œå¹¶ä¸åŒ…å«æ–¹æ³•ã€‚å¯¹äºæ–¹æ³•ï¼Œä¼šæ”¾åˆ°ç±»ã€å¯¹è±¡ä¸­ä¸€èµ·ç ”ç©¶ã€‚</p>

<p>æƒ³è®²æ¸…æ¥šåœ¨zend vmä¸­ï¼Œå‡½æ•°å¦‚ä½•è¢«æ­£ç¡®çš„ç¼–è¯‘æˆopæŒ‡ä»¤ã€å¦‚ä½•å‘ç”Ÿå‚æ•°ä¼ é€’ã€å¦‚ä½•æ¨¡æ‹Ÿè°ƒç”¨æ ˆã€å¦‚ä½•åˆ‡æ¢ä½œç”¨åŸŸç­‰ç­‰ï¼Œçš„ç¡®æ˜¯ä¸€ä¸ªå¾ˆå¤§èŒƒç•´çš„è¯é¢˜ã€‚ä½†ä¸ºäº†å¼„æ˜ç™½phpçš„åŸç†ï¼Œå¿…é¡»è¦æ”»å…‹å®ƒã€‚</p>

<p>å¯¹å‡½æ•°çš„ç ”ç©¶ï¼Œå¤§è‡´å¯ä»¥åˆ†æˆä¸¤å—ã€‚ç¬¬ä¸€å—æ˜¯å‡½æ•°ä½“çš„ç¼–è¯‘ï¼Œä¸»è¦æ¶‰åŠåˆ°å¦‚ä½•å°†å‡½æ•°è½¬åŒ–æˆzend_opæŒ‡ä»¤ã€‚ç¬¬äºŒå—æ˜¯ç ”ç©¶å‡½æ•°çš„è°ƒç”¨ï¼Œæ¶‰åŠåˆ°å‡½æ•°è°ƒç”¨è¯­å¥çš„ç¼–è¯‘ï¼Œä»¥åŠå‡½æ•°å¦‚ä½•è¢«æ‰§è¡Œç­‰topicã€‚è¿™é‡Œå…ˆæ¥çœ‹çœ‹å‡½æ•°å¦‚ä½•è¢«ç¼–è¯‘ï¼Œæˆ‘ä»¬ä¸‹ä¸€ç¯‡å†è®²å‡½æ•°çš„è°ƒç”¨ã€‚
<!-- more -->
å‡½æ•°çš„ç¼–è¯‘
å¯¹å‡½æ•°è¿›è¡Œç¼–è¯‘ï¼Œæœ€ç»ˆç›®çš„æ˜¯ä¸ºäº†ç”Ÿæˆä¸€ä»½å¯¹åº”çš„zend opæŒ‡ä»¤é›†ï¼Œé™¤äº†zend opæŒ‡ä»¤é›†ï¼Œç¼–è¯‘å‡½æ•°è¿˜ä¼šäº§ç”Ÿå…¶ä»–ä¸€äº›ç›¸å…³çš„æ•°æ®ï¼Œæ¯”å¦‚è¯´å‡½æ•°åç§°ã€å‚æ•°åˆ—è¡¨ä¿¡æ¯ã€compiled variablesï¼Œç”šè‡³å‡½æ•°æ‰€åœ¨æ–‡ä»¶ã€èµ·å§‹è¡Œæ•°ç­‰ç­‰ã€‚è¿™äº›ä¿¡æ¯ä½œä¸ºç¼–è¯‘çš„äº§å‡ºï¼Œéƒ½éœ€è¦ä¿å­˜èµ·æ¥ã€‚</p>

<p>ä¿å­˜è¿™äº›ç¼–è¯‘äº§å‡ºçš„æ•°æ®ç»“æ„ï¼Œæ­£æ˜¯ä¸Šä¸€èŠ‚ä¸­æ‰€æè¿°çš„zend_op_arrayã€‚åœ¨è¿™ä¸ªç³»åˆ—çš„æ–‡ç« ä¸­ï¼Œå‡ä¼šä»¥op_arrayä½œä¸ºç®€ç§°ã€‚</p>

<p>ä¸‹é¢åˆ—å‡ºäº†ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<p>&lt;?php
function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
foo($bar);
è¿™æ®µä»£ç åŒ…å«äº†ä¸€ä¸ªæœ€ç®€å•çš„å‡½æ•°ç¤ºä¾‹ã€‚</p>

<p>åœ¨è¿™æ ·ä¸€ä»½phpè„šæœ¬ä¸­ï¼Œæœ€ç»ˆå…¶å®ä¼šäº§ç”Ÿä¸¤ä¸ªop_arrayã€‚ä¸€ä¸ªæ˜¯ç”±å‡½æ•°fooç¼–è¯‘è€Œæ¥ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯ç”±é™¤å»å‡½æ•°fooä¹‹å¤–ä»£ç ç¼–è¯‘ç”Ÿæˆçš„ã€‚åŒç†å¯ä»¥æ¨å‡ºï¼Œå‡å¦‚ä¸€ä»½phpè„šæœ¬å…¶ä¸­åŒ…å«æœ‰2ä¸ªå‡½æ•°å’Œè‹¥å¹²è¯­å¥ï¼Œåˆ™æœ€ç»ˆä¼šäº§ç”Ÿ3ä¸ªop_arrayã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå‡½æ•°æœ€ç»ˆéƒ½ä¼šè¢«ç¼–è¯‘æˆä¸€ä¸ªå¯¹åº”çš„op_arrayã€‚</p>

<p>åˆšæ‰æåˆ°ï¼Œop_arrayä¸­æœ‰ä¸€äº›å­—æ®µæ˜¯å’Œå‡½æ•°æ¯æ¯ç›¸å…³çš„ã€‚æ¯”å¦‚function_nameä»£è¡¨ç€å‡½æ•°çš„åç§°ï¼Œæ¯”å¦‚num_argsä»£è¡¨äº†å‡½æ•°çš„å‚æ•°ä¸ªæ•°ï¼Œæ¯”å¦‚required_num_argsä»£è¡¨äº†å¿…é¡»çš„å‚æ•°ä¸ªæ•°ï¼Œæ¯”å¦‚arg_infoä»£è¡¨ç€å‡½æ•°çš„å‚æ•°ä¿¡æ¯â€¦etcã€‚</p>

<p>ä¸‹é¢ä¼šç»§ç»­ç»“åˆè¿™æ®µä»£ç ï¼Œæ¥ç ”ç©¶fooå‡½æ•°è¯¦ç»†çš„ç¼–è¯‘è¿‡ç¨‹ã€‚</p>

<p>1ã€è¯­æ³•å®šä¹‰
ä»zend_language_parser.yæ–‡ä»¶ä¸­å¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°çš„è¯­æ³•åˆ†æå¤§è‡´æ¶‰åŠå¦‚ä¸‹å‡ ä¸ªæ¨å¯¼å¼ï¼š</p>

<p>top_statement:
        statement                          { zend_verify_namespace(TSRMLS_C); }
    |    function_declaration_statement    { zend_verify_namespace(TSRMLS_C); zend_do_early_binding(TSRMLS_C); }
    |    class_declaration_statement       { zend_verify_namespace(TSRMLS_C); zend_do_early_binding(TSRMLS_C); }
    â€¦</p>

<p>function_declaration_statement:
	unticked_function_declaration_statement	{ DO_TICKS(); }
;</p>

<p>unticked_function_declaration_statement:
	function is_reference T_STRING { zend_do_begin_function_declaration(&amp;$1, &amp;$3, 0, $2.op_type, NULL TSRMLS_CC); }
	â€˜(â€˜ parameter_list â€˜)â€™ â€˜{â€˜ inner_statement_list â€˜}â€™ { zend_do_end_function_declaration(&amp;$1 TSRMLS_CC); }
;</p>

<p>is_reference:
        /* empty */    { \(.op_type = ZEND_RETURN_VAL; }
    |    '&amp;'            {\).op_type = ZEND_RETURN_REF; }
;</p>

<p>parameter_list:
        non_empty_parameter_list
    |    /* empty */
;</p>

<p>non_empty_parameter_list:
		optional_class_type T_VARIABLE				{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$2, 0 TSRMLS_CC); \(.op_type = IS_CONST; Z_LVAL(\).u.constant)=1; Z_TYPE(\(.u.constant)=IS_LONG; INIT_PZVAL(&amp;\).u.constant); zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\(, NULL, &amp;$1, &amp;$2, 0 TSRMLS_CC); }
	|	optional_class_type '&amp;' T_VARIABLE			{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$3, 0 TSRMLS_CC);\).op_type = IS_CONST; Z_LVAL(\(.u.constant)=1; Z_TYPE(\).u.constant)=IS_LONG; INIT_PZVAL(&amp;\(.u.constant); zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\), NULL, &amp;$1, &amp;$3, 1 TSRMLS_CC); }
	|	optional_class_type â€˜&amp;â€™ T_VARIABLE â€˜=â€™ static_scalar	{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$3, 0 TSRMLS_CC); \(.op_type = IS_CONST; Z_LVAL(\).u.constant)=1; Z_TYPE(\(.u.constant)=IS_LONG; INIT_PZVAL(&amp;\).u.constant); zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\(, &amp;$5, &amp;$1, &amp;$3, 1 TSRMLS_CC); }
	|	optional_class_type T_VARIABLE '=' static_scalar	{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$2, 0 TSRMLS_CC);\).op_type = IS_CONST; Z_LVAL(\(.u.constant)=1; Z_TYPE(\).u.constant)=IS_LONG; INIT_PZVAL(&amp;\(.u.constant); zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\), &amp;$4, &amp;$1, &amp;$2, 0 TSRMLS_CC); }
	|	non_empty_parameter_list â€˜,â€™ optional_class_type T_VARIABLEã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$4, 0 TSRMLS_CC); \(=$1; Z_LVAL(\).u.constant)++; zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\(, NULL, &amp;$3, &amp;$4, 0 TSRMLS_CC); }
	|	non_empty_parameter_list ',' optional_class_type '&amp;' T_VARIABLEã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$5, 0 TSRMLS_CC);\)=$1; Z_LVAL(\(.u.constant)++; zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\), NULL, &amp;$3, &amp;$5, 1 TSRMLS_CC); }
	|	non_empty_parameter_list â€˜,â€™ optional_class_type â€˜&amp;â€™ T_VARIABLE	 â€˜=â€™ static_scalarã€€{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$5, 0 TSRMLS_CC); \(=$1; Z_LVAL(\).u.constant)++; zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\(, &amp;$7, &amp;$3, &amp;$5, 1 TSRMLS_CC); }
	|	non_empty_parameter_list ',' optional_class_type T_VARIABLE '=' static_scalarã€€ã€€ã€€ã€€{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$4, 0 TSRMLS_CC);\)=$1; Z_LVAL(\(.u.constant)++; zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\), &amp;$6, &amp;$3, &amp;$4, 0 TSRMLS_CC); }
;
è¿™é‡Œå¹¶æ²¡æœ‰æˆªå–å®Œæ•´ï¼Œä¸»è¦æ˜¯ç¼ºå°‘å‡½æ•°ä½“å†…è¯­å¥çš„è¯­æ³•åˆ†æï¼Œä½†å·²ç»è¶³å¤Ÿæˆ‘ä»¬å¼„æ¸…æ¥šç¼–è¯‘è¿‡ç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚ã€‚</p>

<p>å‡½æ•°ä½“å†…çš„è¯­å¥ï¼Œå…¶å¯¹åº”çš„è¯­æ³•ä¸ºinner_statement_listã€‚inner_statement_listå’Œå‡½æ•°ä½“ä¹‹å¤–ä¸€èˆ¬çš„è¯­å¥å¹¶æ— äºŒè‡´ï¼Œå¯ä»¥ç®€å•å½“æˆæ™®é€šçš„è¯­å¥æ¥ç¼–è¯‘ã€‚</p>

<p>æœ€é‡è¦çš„æ˜¯çœ‹ä¸‹unticked_function_declaration_statementï¼Œå®ƒå®šä¹‰äº†å‡½æ•°è¯­æ³•çš„éª¨æ¶ï¼ŒåŒæ—¶è¿˜å¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°ç¼–è¯‘ä¸­ä¼šæ‰§è¡Œzend_do_begin_function_declarationä»¥åŠzend_do_end_function_declarationã€‚è¿™ä¸¤æ­¥åˆ†åˆ«å¯¹åº”ç€ä¸‹æ–‡æåˆ°çš„å¼€å§‹ç¼–è¯‘å’Œç»“æŸç¼–è¯‘ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹zend_do_begin_function_declarationã€‚</p>

<p>2ã€å¼€å§‹ç¼–è¯‘
å½“zend vmçš„è¯­æ³•åˆ†æå™¨é‡åˆ°ä¸€æ®µå‡½æ•°å£°æ˜æ—¶ï¼Œä¼šå°è¯•å¼€å§‹ç¼–è¯‘å‡½æ•°ï¼Œè¿™æ˜¯é€šè¿‡æ‰§è¡Œzend_do_begin_function_declarationæ¥å®Œæˆçš„ã€‚</p>

<p>æœ‰ä¸¤ç‚¹ï¼š</p>

<p>1ï¼Œå‡½æ•°æ˜¯å¦è¿”å›å¼•ç”¨ï¼Œé€šè¿‡is_referenceåˆ¤æ–­ã€‚å¯ä»¥çœ‹åˆ°åœ¨å¯¹is_referenceè¿›è¡Œè¯­æ³•åˆ†ææ—¶ï¼Œå¯èƒ½ä¼šå°†op_typeèµ‹äºˆZEND_RETURN_VALæˆ–ZEND_RETURN_REFã€‚æ ¹æ®æˆ‘ä»¬æ–‡ç« å¼€å§‹ç»™å‡ºçš„phpä»£ç ç¤ºä¾‹ï¼Œå‡½æ•°fooå¹¶ä¸è¿”å›å¼•ç”¨ï¼Œå› æ­¤è¿™é‡Œ$2.op_typeä¸ºZEND_RETURN_VALã€‚</p>

<p>è¯è¯´ç”± function &amp; func_name() { â€¦ } è¿™ç§å½¢å¼æ¥å†³å®šæ˜¯å¦è¿”å›å¼•ç”¨ï¼Œå·²ç»å¾ˆå¤è€äº†ï¼Œè¿˜æ˜¯åœ¨CIæ¡†æ¶ä¸­è§è¿‡ï¼Œç°åœ¨å¾ˆå°‘è¿™ä¹ˆå†™ã€‚ä½†æ˜¯phpåšäº†å…¼å®¹ï¼Œæ‰€ä»¥å³ä½¿é‡‡ç”¨è¿™ç§å¾ˆé™ˆæ—§çš„è¯­æ³•ï¼Œä¹Ÿèƒ½å¤Ÿè¢«æ­£ç¡®è¯†åˆ«ã€‚</p>

<p>2ï¼Œzend_do_begin_function_declarationæ¥å—çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ˜¯å¯¹functionå­—é¢è¿›è¡Œè¯æ³•åˆ†æç”Ÿæˆçš„znodeã€‚è¿™ä¸ªznodeè¢«ä½¿ç”¨å¾—éå¸¸å·§å¦™ï¼Œå› ä¸ºåœ¨ç¼–è¯‘å‡½æ•°æ—¶ï¼Œzend vmå¿…é¡»å°†CG(active_op_array)åˆ‡æ¢æˆå‡½æ•°è‡ªå·±çš„op_arrayï¼Œä»¥ä¾¿äºå­˜å‚¨å‡½æ•°çš„ç¼–è¯‘ç»“æœï¼Œå½“å‡½æ•°ç¼–è¯‘å®Œæˆä¹‹åï¼Œzend vmåˆéœ€è¦å°†å°†CG(active_op_array)æ¢å¤æˆå‡½æ•°ä½“å¤–å±‚çš„op_arrayã€‚åˆ©ç”¨è¯¥znodeä¿å­˜å‡½æ•°ä½“å¤–çš„op_arrayï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨å‡½æ•°ç¼–è¯‘ç»“æŸæ—¶è¿›è¡ŒCG(active_op_array)æ¢å¤ï¼Œå…·ä½“åé¢ä¼šè®²åˆ°ã€‚</p>

<p>ç ”ç©¶ä¸‹zend_do_begin_function_declarationçš„å®ç°ï¼Œæ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†æ®µæ¥çœ‹ï¼š</p>

<p>// å£°æ˜å‡½æ•°ä¼šå˜ç¼–è¯‘æˆçš„op_array
zend_op_array op_array;</p>

<p>// å‡½æ•°åã€é•¿åº¦ã€èµ·å§‹è¡Œæ•°
char *name = function_name-&gt;u.constant.value.str.val;
int name_len = function_name-&gt;u.constant.value.str.len;
int function_begin_line = function_token-&gt;u.opline_num;
zend_uint fn_flags;
char *lcname;
zend_bool orig_interactive;
ALLOCA_FLAG(use_heap)</p>

<p>if (is_method) {
    â€¦
} else {
    fn_flags = 0;
}</p>

<p>// å¯¹å‡½æ•°æ¥è¯´ï¼Œfn_flagsæ²¡ç”¨ï¼Œå¯¹æ–¹æ³•æ¥è¯´ï¼Œfn_flagsæŒ‡å®šäº†æ–¹æ³•çš„ä¿®é¥°ç¬¦
if ((fn_flags &amp; ZEND_ACC_STATIC) &amp;&amp; (fn_flags &amp; ZEND_ACC_ABSTRACT) &amp;&amp; !(CG(active_class_entry)-&gt;ce_flags &amp; ZEND_ACC_INTERFACE)) {
    zend_error(E_STRICT, â€œStatic function %s%s%s() should not be abstractâ€, is_method ? CG(active_class_entry)-&gt;name : â€œâ€, is_method ? â€œ::â€ : â€œâ€, Z_STRVAL(function_name-&gt;u.constant));
}
è¿™æ®µä»£ç ä¸€å¼€å§‹å°±å°è¯äº†æˆ‘ä»¬å…ˆå‰çš„è¯´æ³•ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä»½è‡ªå·±çš„op_arrayã€‚æ‰€ä»¥ä¼šåœ¨å¼€å¤´å…ˆå£°æ˜ä¸€ä¸ªop_arrayå˜é‡ã€‚</p>

<p>// ç¬¬ä¸€ä¸ªznodeå‚æ•°çš„å¦™å¤„ï¼Œå®ƒè®°å½•äº†å½“å‰çš„CG(active_op_array)
function_token-&gt;u.op_array = CG(active_op_array);
lcname = zend_str_tolower_dup(name, name_len);</p>

<p>// å¯¹op_arrayè¿›è¡Œåˆå§‹åŒ–ï¼Œå¼ºåˆ¶op_array.fn_flagsä¼šè¢«åˆå§‹åŒ–ä¸º0
orig_interactive = CG(interactive);
CG(interactive) = 0;
init_op_array(&amp;op_array, ZEND_USER_FUNCTION, INITIAL_OP_ARRAY_SIZE TSRMLS_CC);
CG(interactive) = orig_interactive;</p>

<p>// å¯¹op_arrayçš„ä¸€äº›è®¾ç½®
op_array.function_name = name;
op_array.return_reference = return_reference;
op_array.fn_flags |= fn_flags;
op_array.pass_rest_by_reference = 0;
op_array.scope = is_method ? CG(active_class_entry):NULL;
op_array.prototype = NULL;
op_array.line_start = zend_get_compiled_lineno(TSRMLS_C);
function_tokenä¾¿æ˜¯å¯¹functionå­—é¢è¿›è¡Œè¯æ³•åˆ†æè€Œç”Ÿæˆçš„znodeã€‚è¿™æ®µä»£ç ä¸€å¼€å§‹ï¼Œå°±è®©å®ƒä¿å­˜å½“å‰çš„CG(active_op_array)ï¼Œå³å‡½æ•°ä½“ä¹‹å¤–çš„op_arrayã€‚ä¿å­˜å¥½CG(active_op_array)ä¹‹åï¼Œä¾¿ä¼šå¼€å§‹å¯¹å‡½æ•°è‡ªå·±çš„op_arrayè¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<table>
  <tbody>
    <tr>
      <td>op_array.fn_flagsæ˜¯ä¸ªå¤šåŠŸèƒ½å­—æ®µï¼Œè¿˜è®°å¾—ä¸Šä¸€ç¯‡ä¸­æåˆ°çš„äº¤äº’å¼ä¹ˆï¼Œå¦‚æœphpä»¥äº¤äº’å¼æ‰“å¼€ï¼Œåˆ™op_array.fn_flagsä¼šè¢«åˆå§‹åŒ–ä¸ºZEND_ACC_INTERACTIVEï¼Œå¦åˆ™ä¼šè¢«åˆå§‹åŒ–ä¸º0ã€‚è¿™é‡Œåœ¨init_op_arrayä¹‹å‰è®¾ç½®CG(interactive) = 0ï¼Œä¾¿æ˜¯ç¡®ä¿op_array.fn_flagsåˆå§‹åŒ–ä¸º0ã€‚éšåä¼šè¿›ä¸€æ­¥æ‰§è¡Œop_array.fn_flags</td>
      <td>= fn_flagsï¼Œå¦‚æœæ˜¯åœ¨æ–¹æ³•ä¸­ï¼Œåˆ™op_array.fn_flagså«ä¹‰ä¸ºstaticã€abstractã€finalç­‰ä¿®é¥°ç¬¦ï¼Œå¯¹å‡½æ•°æ¥è®²ï¼Œop_array.fn_flagsä¾ç„¶æ˜¯0ã€‚</td>
    </tr>
  </tbody>
</table>

<p>zend_op *opline = get_next_op(CG(active_op_array) TSRMLS_CC);</p>

<p>// å¦‚æœå¤„äºå‘½åç©ºé—´ï¼Œåˆ™å‡½æ•°åè¿˜éœ€è¦åŠ ä¸Šå‘½åç©ºé—´
if (CG(current_namespace)) {
    /* Prefix function name with current namespace name */
    znode tmp;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tmp.u.constant = *CG(current_namespace);
zval_copy_ctor(&amp;tmp.u.constant);
zend_do_build_namespace_name(&amp;tmp, &amp;tmp, function_name TSRMLS_CC);
op_array.function_name = Z_STRVAL(tmp.u.constant);
efree(lcname);
name_len = Z_STRLEN(tmp.u.constant);
lcname = zend_str_tolower_dup(Z_STRVAL(tmp.u.constant), name_len); }
</code></pre></div></div>

<p>// è®¾ç½®opline
opline-&gt;opcode = ZEND_DECLARE_FUNCTION;
// ç¬¬ä¸€ä¸ªæ“ä½œæ•°
opline-&gt;op1.op_type = IS_CONST;
build_runtime_defined_function_key(&amp;opline-&gt;op1.u.constant, lcname, name_len TSRMLS_CC);
// ç¬¬äºŒä¸ªæ“ä½œæ•°
opline-&gt;op2.op_type = IS_CONST;
opline-&gt;op2.u.constant.type = IS_STRING;
opline-&gt;op2.u.constant.value.str.val = lcname;
opline-&gt;op2.u.constant.value.str.len = name_len;
Z_SET_REFCOUNT(opline-&gt;op2.u.constant, 1);
opline-&gt;extended_value = ZEND_DECLARE_FUNCTION;</p>

<p>// åˆ‡æ¢CG(active_op_array)æˆå‡½æ•°è‡ªå·±çš„op_array
zend_hash_update(CG(function_table), opline-&gt;op1.u.constant.value.str.val, opline-&gt;op1.u.constant.value.str.len, &amp;op_array, sizeof(zend_op_array), (void **) &amp;CG(active_op_array));
ä¸Šé¢è¿™æ®µä»£ç å¾ˆå…³é”®ã€‚æœ‰å‡ ç‚¹è¦è¯´æ˜çš„ï¼š</p>

<p>1ï¼Œå¦‚æœå‡½æ•°æ˜¯å¤„äºå‘½åç©ºé—´ä¸­ï¼Œåˆ™å…¶åç§°ä¼šè¢«æ‰©å±•æˆå‘½åç©ºé—´\å‡½æ•°åã€‚æ¯”å¦‚ï¼š</p>

<p>&lt;?php
namespace MyProject;</p>

<p>function foo($arg1, $arg2 = 100)
{
    print($arg1);
}
åˆ™ä¼šå°†å‡½æ•°åæ”¹ä¸ºMyProject\fooã€‚æ‰©å±•å·¥ä½œç”±zend_do_build_namespace_nameæ¥å®Œæˆã€‚</p>

<p>2ï¼Œbuild_runtime_defined_function_keyä¼šç”Ÿæˆä¸€ä¸ªâ€œkeyâ€ã€‚é™¤äº†ç”¨åˆ°å‡½æ•°åç§°ä¹‹å¤–ï¼Œè¿˜ç”¨åˆ°äº†å‡½æ•°æ‰€åœ¨æ–‡ä»¶è·¯å¾„ã€ä»£ç åœ¨å†…å­˜ä¸­çš„åœ°å€ç­‰ç­‰ã€‚å…·ä½“çš„å®ç°å¯ä»¥è‡ªè¡Œé˜…è¯»ã€‚å°†å‡½æ•°æ”¾è¿›CG(function_table)æ—¶ï¼Œç”¨çš„é”®ä¾¿æ˜¯è¿™ä¸ªâ€œkeyâ€ã€‚</p>

<p>ä»¥æˆ‘çš„æœºå™¨ä¸ºä¾‹ï¼Œä¸Šè¿°å‡½æ•°fooç”Ÿæˆçš„keyä¸ºï¼š</p>

<p>00foo/home/work/foo.php00ABEBBF
ä»è¿™ä¸ªkeyä¸­èƒ½ç›´è§‚çš„çœ‹å‡ºå‡½æ•°åï¼Œæ‰€åœ¨æ–‡ä»¶è·¯å¾„è¿™ä¸¤ä¸ªä¿¡æ¯ã€‚</p>

<p>3ï¼Œä»£ç ä¸­çš„op_lineè·å–æ—¶ï¼Œå°šæœªå‘ç”ŸCG(active_op_array)çš„åˆ‡æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œop_lineä¾ç„¶æ˜¯å¤–å±‚op_arrayçš„ä¸€æ¡æŒ‡ä»¤ã€‚è¯¥æŒ‡ä»¤å…·ä½“ä¸ºZEND_DECLARE_FUNCTIONï¼Œæœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼Œç¬¬ä¸€ä¸ªæ“ä½œæ•°ä¿å­˜äº†ç¬¬äºŒç‚¹ä¸­æåˆ°çš„â€œkeyâ€ï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°åˆ™ä¿å­˜äº†å½¢å¦‚â€myproject\fooâ€è¿™æ ·çš„å‡½æ•°åï¼ˆå°å†™ï¼‰ã€‚</p>

<p>4ï¼Œè¿™æ®µä»£ç çš„æœ€åï¼Œå°†å‡½æ•°è‡ªèº«å¯¹åº”çš„op_arrayå­˜æ”¾è¿›äº†CG(function_table)ï¼ŒåŒæ—¶ï¼Œå®Œæˆäº†CG(active_op_array)çš„åˆ‡æ¢ã€‚ä»è¿™æ¡è¯­å¥å¼€å§‹ï¼ŒCG(active_op_array)ä¾¿å¼€å§‹æŒ‡å‘å‡½æ•°è‡ªå·±çš„op_arrayï¼Œè€Œä¸å†æ˜¯å‡½æ•°ä½“å¤–å±‚çš„op_arrayäº†ã€‚</p>

<p>ç»§ç»­æ¥çœ‹zend_do_begin_function_declarationçš„æœ€åä¸€æ®µï¼š</p>

<p>// éœ€è¦debuginfoï¼Œåˆ™å‡½æ•°ä½“å†…çš„ç¬¬ä¸€æ¡zend_opï¼Œä¸ºZEND_EXT_NOP
if (CG(compiler_options) &amp; ZEND_COMPILE_EXTENDED_INFO) {
    zend_op *opline = get_next_op(CG(active_op_array) TSRMLS_CC);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opline-&gt;opcode = ZEND_EXT_NOP;
opline-&gt;lineno = function_begin_line;
SET_UNUSED(opline-&gt;op1);
SET_UNUSED(opline-&gt;op2); }
</code></pre></div></div>

<p>// æ§åˆ¶switchå’Œforeachå†…å£°æ˜çš„å‡½æ•°
{
    /* Push a seperator to the switch and foreach stacks */
    zend_switch_entry switch_entry;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>switch_entry.cond.op_type = IS_UNUSED;
switch_entry.default_case = 0;
switch_entry.control_var = 0;

zend_stack_push(&amp;CG(switch_cond_stack), (void *) &amp;switch_entry, sizeof(switch_entry));

{
    /* Foreach stack separator */
    zend_op dummy_opline;

    dummy_opline.result.op_type = IS_UNUSED;
    dummy_opline.op1.op_type = IS_UNUSED;

    zend_stack_push(&amp;, (void *) &amp;dummy_opline, sizeof(zend_op));
} }
</code></pre></div></div>

<p>// ä¿å­˜å‡½æ•°çš„æ³¨é‡Šè¯­å¥
if (CG(doc_comment)) {
    CG(active_op_array)-&gt;doc_comment = CG(doc_comment);
    CG(active_op_array)-&gt;doc_comment_len = CG(doc_comment_len);
    CG(doc_comment) = NULL;
    CG(doc_comment_len) = 0;
}</p>

<p>// ä½œç”¨å’Œä¸Šé¢switchï¼Œforeachæ˜¯ä¸€æ ·çš„ï¼Œå‡½æ•°ä½“å†…çš„è¯­å¥å¹¶ä¸å±äºå‡½æ•°ä½“å¤–çš„label
zend_stack_push(&amp;CG(labels_stack), (void <em>) &amp;CG(labels), sizeof(HashTable</em>));
CG(labels) = NULL;
å¯èƒ½åˆå­¦è€…ä¼šå¯¹CG(switch_cond_stack)ï¼ŒCG(foreach_copy_stack)ï¼ŒCG(labels_stack)ç­‰å­—æ®µæœ‰ç–‘æƒ‘ã€‚å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ã€‚ä»¥CG(labels_stack)ä¸ºä¾‹ï¼Œç”±äºè¿›å…¥å‡½æ•°ä½“å†…ä¹‹åï¼Œop_arrayå‘ç”Ÿäº†åˆ‡æ¢ï¼Œå¤–å±‚çš„CG(active_op_array)è¢«ä¿å­˜åˆ°function znodeçš„u.op_arrayä¸­ï¼ˆå¦‚æœè®°ä¸æ¸…æ¥šäº†å›å¤´çœ‹ä¸Šæ–‡:-)ï¼‰ã€‚å› æ­¤å‡½æ•°å¤–å±‚å·²ç»è¢«parseå‡ºçš„ä¸€äº›labelä¹Ÿéœ€è¦è¢«ä¿å­˜ä¸‹æ¥ï¼Œç”¨çš„æ­£æ˜¯CG(labels_stack)æ¥ä¿å­˜ã€‚å½“å‡½æ•°ä½“å®Œæˆç¼–è¯‘ä¹‹åï¼Œzend vmå¯ä»¥ä»CG(labels_stack)ä¸­æ¢å¤å‡ºåŸå…ˆçš„labelã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ</p>

<p>&lt;?php
label1:
function foo($arg1)
{
    print($arg1);
    goto label2;</p>

<p>label2:
    exit;
}</p>

<p>$bar = â€˜hello phpâ€™;
foo($bar);
è§£é‡Šå™¨åœ¨è¿›å…¥zend_do_begin_function_declarationæ—¶ï¼ŒCG(labels)ä¸­ä¿å­˜çš„æ˜¯â€œlabel1â€ã€‚å½“è§£é‡Šå™¨å¼€å§‹ç¼–è¯‘å‡½æ•°fooï¼Œåˆ™éœ€è¦å°†â€œlabel1â€ä¿å­˜åˆ°CG(labels_stack)ä¸­ï¼ŒåŒæ—¶æ¸…ç©ºCG(labels)ã€‚å› ä¸ºåœ¨ç¼–è¯‘fooçš„è¿‡ç¨‹ä¸­ï¼ŒCG(labels)ä¼šä¿å­˜â€œlabe2â€ã€‚å½“fooç¼–è¯‘å®Œæˆï¼Œä¼šåˆ©ç”¨CG(labels_stack)æ¥æ¢å¤CG(labels)ï¼Œåˆ™CG(labels)å†æ¬¡å˜æˆâ€œlabel1â€ã€‚</p>

<p>è‡³æ­¤ï¼Œæ•´ä¸ªzend_do_begin_function_declarationè¿‡ç¨‹å·²ç»å…¨éƒ¨åˆ†æå®Œæˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œä¸€æ—¦å®Œæˆzend_do_begin_function_declarationï¼ŒCG(active_op_array)å°±æŒ‡å‘äº†å‡½æ•°è‡ªèº«å¯¹åº”çš„op_arrayã€‚åŒæ—¶ï¼Œä¹Ÿåˆ©ç”¨ç”Ÿæˆçš„â€œkeyâ€åœ¨CG(function_table)ä¸­æ›¿å‡½æ•°å äº†ä¸€ä¸ªä½ã€‚</p>

<p>3ã€ç¼–è¯‘å‚æ•°åˆ—è¡¨
å‡½æ•°å¯ä»¥å®šä¹‰ä¸ºä¸æ¥å—ä»»ä½•å‚æ•°ï¼Œå¯¹äºå‚æ•°åˆ—è¡¨ä¸ºç©ºçš„æƒ…å†µï¼Œå…¶å®ä¸åšä»»ä½•å¤„ç†ã€‚æˆ‘ä»¬å‰æ–‡çš„ä¾‹å­fooå‡½æ•°ï¼Œæ¥å—äº†ä¸€ä¸ªå‚æ•°$arg1ï¼Œæˆ‘ä»¬ä¸‹é¢è¿˜æ˜¯åˆ†ææœ‰å‚æ•°çš„æƒ…å†µã€‚</p>

<p>æ ¹æ®è¯­æ³•æ¨å¯¼å¼non_empty_parameter_listçš„å®šä¹‰ï¼Œå‚æ•°åˆ—è¡¨ä¸€å…±æœ‰8ç§ï¼Œå‰4ç§å¯¹åº”çš„æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œå4ç§å¯¹åº”å¤šä¸ªå‚æ•°ã€‚æˆ‘ä»¬åªå…³å¿ƒå‰4ç§ï¼Œå4ç§ç¼–è¯‘çš„è¿‡ç¨‹ï¼Œä»…ä»…æ˜¯é‡å¤å‰4ç§çš„æ­¥éª¤è€Œå·²ã€‚</p>

<p>optional_class_type T_VARIABLE				{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$2, 0 TSRMLS_CC); \(.op_type = IS_CONST; Z_LVAL(\).u.constant)=1; Z_TYPE(\(.u.constant)=IS_LONG; INIT_PZVAL(&amp;\).u.constant); zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\(, NULL, &amp;$1, &amp;$2, 0 TSRMLS_CC); }
optional_class_type '&amp;' T_VARIABLE			{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$3, 0 TSRMLS_CC);\).op_type = IS_CONST; Z_LVAL(\(.u.constant)=1; Z_TYPE(\).u.constant)=IS_LONG; INIT_PZVAL(&amp;\(.u.constant); zend_do_receive_arg(ZEND_RECV, &amp;tmp, &amp;\), NULL, &amp;$1, &amp;$3, 1 TSRMLS_CC); }
optional_class_type â€˜&amp;â€™ T_VARIABLE â€˜=â€™ static_scalar	{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$3, 0 TSRMLS_CC); \(.op_type = IS_CONST; Z_LVAL(\).u.constant)=1; Z_TYPE(\(.u.constant)=IS_LONG; INIT_PZVAL(&amp;\).u.constant); zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\(, &amp;$5, &amp;$1, &amp;$3, 1 TSRMLS_CC); }
optional_class_type T_VARIABLE '=' static_scalar	{ znode tmp;  fetch_simple_variable(&amp;tmp, &amp;$2, 0 TSRMLS_CC);\).op_type = IS_CONST; Z_LVAL(\(.u.constant)=1; Z_TYPE(\).u.constant)=IS_LONG; INIT_PZVAL(&amp;\(.u.constant); zend_do_receive_arg(ZEND_RECV_INIT, &amp;tmp, &amp;\), &amp;$4, &amp;$1, &amp;$2, 0 TSRMLS_CC); }
å‰4ç§æƒ…å†µï¼Œå…·ä½“åˆå¯ä»¥åˆ†ä¸º2ç±»ï¼Œ1ç±»æ²¡æœ‰é»˜è®¤å€¼ï¼ŒåŒºåˆ«åªåœ¨äºå‚æ•°çš„ä¼ é€’æ˜¯å¦é‡‡ç”¨å¼•ç”¨ï¼Œè€Œå¦1ç±»ï¼Œéƒ½æœ‰é»˜è®¤å€¼â€œstatic_scalarâ€ã€‚</p>

<p>å®é™…ä¸ŠåŒºåˆ«å¹¶ä¸å¤§ï¼Œå®ƒä»¬çš„è¯­æ³•åˆ†æçš„å¤„ç†è¿‡ç¨‹ä¹Ÿå‡ ä¹ä¸€è‡´ã€‚éƒ½æ˜¯å…ˆè°ƒç”¨fetch_simple_variableï¼Œå†æ‰§è¡Œzend_do_receive_argã€‚æœ‰æ²¡æœ‰é»˜è®¤å€¼ï¼ŒåŒºåˆ«ä¹Ÿä»…ä»…åœ¨äºzend_do_receive_argçš„å‚æ•°ï¼Œä¼šä¸ä¼šå°†é»˜è®¤å€¼ä¼ é€’è¿›å»ã€‚å…ˆæ¥çœ‹fetch_simple_variableã€‚</p>

<p>3.1 fetch_simple_variable
fetch_simple_variableæ˜¯ç”¨æ¥è·å–compiled variablesç´¢å¼•çš„ã€‚compiled variablesè¢«è§†ä½œphpçš„æ€§èƒ½æå‡æ‰‹æ®µä¹‹ä¸€ï¼Œå› ä¸ºå®ƒåˆ©ç”¨æ•°ç»„å­˜å‚¨äº†å˜é‡ï¼Œè€Œå¹¶éå†…æ ¸ä¸­æ™®éä½¿ç”¨çš„HashTableã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå‡½æ•°çš„ä»»ä½•ä¸€ä¸ªå‚æ•°ï¼Œå‡ä¼šè¢«ç¼–è¯‘ä¸ºcompiled variablesï¼Œcompiled variablesè¢«ä¿å­˜åœ¨å‡½æ•°ä½“op_array-&gt;varsæ•°ç»„ä¸­ã€‚è™½ç„¶æ ¹æ®å˜é‡åç§°å»HashTableæŸ¥è¯¢ï¼Œæ•ˆç‡å¹¶ä¸ä½ã€‚ä½†æ˜¾ç„¶æ ¹æ®ç´¢å¼•å»op_array-&gt;varsæ•°ç»„ä¸­è·å–å˜é‡ï¼Œä¼šæ›´åŠ é«˜æ•ˆã€‚</p>

<p>void fetch_simple_variable_ex(znode <em>result, znode *varname, int bp, zend_uchar op TSRMLS_DC) /</em> {{{ */
{
    zend_op opline;
    â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (varname-&gt;op_type == IS_CONST) {
    if (Z_TYPE(varname-&gt;u.constant) != IS_STRING) {
        convert_to_string(&amp;varname-&gt;u.constant);
    }
    if (!zend_is_auto_global(varname-&gt;u.constant.value.str.val, varname-&gt;u.constant.value.str.len TSRMLS_CC) &amp;&amp;
        !(varname-&gt;u.constant.value.str.len == (sizeof("this")-1) &amp;&amp; !memcmp(varname-&gt;u.constant.value.str.val, "this", sizeof("this"))) &amp;&amp;
        (CG(active_op_array)-&gt;last == 0 || CG(active_op_array)-&gt;opcodes[CG(active_op_array)-&gt;last-1].opcode != ZEND_BEGIN_SILENCE)) {
        
        // èŠ‚ç‚¹çš„ç±»å‹ä¸ºIS_CVï¼Œè¡¨æ˜æ˜¯compiled variables
        result-&gt;op_type = IS_CV;
        
        // ç”¨u.varæ¥è®°å½•compiled variablesåœ¨CG(active_op_array)-&gt;varsä¸­çš„ç´¢å¼•
        result-&gt;u.var = lookup_cv(CG(active_op_array), varname-&gt;u.constant.value.str.val, varname-&gt;u.constant.value.str.len);
        result-&gt;u.EA.type = 0;
        varname-&gt;u.constant.value.str.val = CG(active_op_array)-&gt;vars[result-&gt;u.var].name;
        return;
    }
}
... } è¿™é‡Œä¸åšè¯¦ç»†çš„åˆ†æäº†ã€‚å½“fetch_simple_variableè·å–ç´¢å¼•ä¹‹åï¼Œznodeä¸­å°±ä¸å¿…å†ä¿å­˜å˜é‡çš„åç§°ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯å˜é‡åœ¨varsæ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå³znode-&gt;u.varï¼Œå…¶ç±»å‹ä¸ºintã€‚fetch_simple_variableå®Œæˆï¼Œä¼šè¿›å…¥zend_do_receive_argã€‚
</code></pre></div></div>

<p>3.2 zend_do_receive_arg
zend_do_receive_argç›®çš„æ˜¯ç”Ÿæˆä¸€æ¡zend opæŒ‡ä»¤ï¼Œå¯ä»¥ç§°ä½œRECVã€‚</p>

<p>ä¸€èˆ¬è€Œè¨€ï¼Œé™¤éå‡½æ•°ä¸å­˜åœ¨å‚æ•°ï¼Œå¦åˆ™RECVæ˜¯å‡½æ•°çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ï¼ˆè¿™é‡Œè¡¨è¿°ä¸å‡†ï¼Œæœ‰extend infoæ—¶ä¹Ÿä¸æ˜¯ç¬¬ä¸€æ¡ï¼‰ã€‚è¯¥æŒ‡ä»¤çš„opcodeå¯èƒ½ä¸ºZEND_RECVæˆ–è€…ZEND_RECV_INITï¼Œå–å†³äºæ˜¯å¦æœ‰é»˜è®¤å€¼ã€‚å¦‚æœå‚æ•°æ²¡æœ‰é»˜è®¤å€¼ï¼ŒæŒ‡ä»¤ç­‰äºZEND_RECVï¼Œæœ‰é»˜è®¤å€¼ï¼Œåˆ™ä¸ºZEND_RECV_INITã€‚zend_do_receive_argçš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå°±æ˜¯ä¸Šé¢æåˆ°çš„compiled variablesèŠ‚ç‚¹ã€‚</p>

<p>åˆ†æä¸‹zend_do_receive_argçš„æºç ï¼Œä¹Ÿæ˜¯åˆ†å‡ æ®µæ¥çœ‹ï¼š</p>

<p>zend_op *opline;
zend_arg_info *cur_arg_info;</p>

<p>// class_typeä¸»è¦ç”¨äºé™åˆ¶å‡½æ•°å‚æ•°çš„ç±»å‹
if (class_type-&gt;op_type == IS_CONST &amp;&amp; Z_TYPE(class_type-&gt;u.constant) == IS_STRING &amp;&amp; Z_STRLEN(class_type-&gt;u.constant) == 0) {
    /* Usage of namespace as class name not in namespace */
    zval_dtor(&amp;class_type-&gt;u.constant);
    zend_error(E_COMPILE_ERROR, â€œCannot use â€˜namespaceâ€™ as a class nameâ€);
    return;
}</p>

<p>// å¯¹é™æ€æ–¹æ³•æ¥è¯´ï¼Œå‚æ•°ä¸èƒ½ä¸ºthis
if (var-&gt;op_type == IS_CV &amp;&amp; var-&gt;u.var == CG(active_op_array)-&gt;this_var &amp;&amp; (CG(active_op_array)-&gt;fn_flags &amp; ZEND_ACC_STATIC) == 0) {
    zend_error(E_COMPILE_ERROR, â€œCannot re-assign $thisâ€);
} else if (var-&gt;op_type == IS_VAR &amp;&amp; CG(active_op_array)-&gt;scope &amp;&amp; ((CG(active_op_array)-&gt;fn_flags &amp; ZEND_ACC_STATIC) == 0) &amp;&amp; (Z_TYPE(varname-&gt;u.constant) == IS_STRING) &amp;&amp; (Z_STRLEN(varname-&gt;u.constant) == sizeof(â€œthisâ€)-1) &amp;&amp; (memcmp(Z_STRVAL(varname-&gt;u.constant), â€œthisâ€, sizeof(â€œthisâ€)) == 0)) {
    zend_error(E_COMPILE_ERROR, â€œCannot re-assign $thisâ€);
}</p>

<p>// CG(active_op_array)æ­¤æ—¶å·²ç»æ˜¯å‡½æ•°ä½“çš„op_arrayäº†ï¼Œè¿™é‡Œæ‹¿ä¸€æ¡æŒ‡ä»¤
opline = get_next_op(CG(active_op_array) TSRMLS_CC);
CG(active_op_array)-&gt;num_args++;
opline-&gt;opcode = op;
opline-&gt;result = *var;</p>

<p>// op1èŠ‚ç‚¹è¡¨æ˜æ˜¯ç¬¬å‡ ä¸ªå‚æ•°
opline-&gt;op1 = *offset;</p>

<p>// op2èŠ‚ç‚¹å¯èƒ½ä¸ºåˆå§‹å€¼ï¼Œä¹Ÿå¯èƒ½ä¸ºUNUSED
if (op == ZEND_RECV_INIT) {
    opline-&gt;op2 = *initialization;
} else {
    CG(active_op_array)-&gt;required_num_args = CG(active_op_array)-&gt;num_args;
    SET_UNUSED(opline-&gt;op2);
}
ä¸Šé¢è¿™æ®µä»£ç ï¼Œé¦–å…ˆé€šè¿‡get_next_op(CG(active_op_array) TSRMLS_CC)ä¸€å¥è·å–äº†oplineï¼Œoplineæ˜¯æœªè¢«ä½¿ç”¨çš„ä¸€æ¡zend_opæŒ‡ä»¤ã€‚ç´§æ¥ç€ï¼Œä¼šå¯¹oplineçš„å„ä¸ªå­—æ®µè¿›è¡Œè®¾ç½®ã€‚opline-&gt;op1è¡¨æ˜è¿™æ˜¯ç¬¬å‡ ä¸ªå‚æ•°ï¼Œopline-&gt;op2å¯èƒ½ä¸ºåˆå§‹å€¼ï¼Œä¹Ÿå¯èƒ½è¢«è®¾ç½®ä¸ºUNUSEDã€‚</p>

<p>å¦‚æœä¸€ä¸ªå‚æ•°æœ‰é»˜è®¤å€¼ï¼Œé‚£ä¹ˆåœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œå…¶å®æ˜¯å¯ä»¥ä¸ç”¨ä¼ é€’è¯¥å‚æ•°çš„ã€‚æ‰€ä»¥ï¼Œrequired_num_argsä¸ä¼šå°†è¿™ç±»éå¿…é¡»çš„å‚æ•°ç®—è¿›å»çš„ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨op == ZEND_RECV_INITè¿™æ®µé€»è¾‘åˆ†æ”¯ä¸­ï¼Œå¹¶æ²¡æœ‰å¤„ç†required_num_argsã€‚</p>

<p>ç»§ç»­æ¥çœ‹ï¼š</p>

<p>// è¿™é‡Œé‡‡ç”¨ereallocè¿›è¡Œåˆ†é…ï¼Œå› ä¸ºæœŸæœ›æœ€ç»ˆä¼šå½¢æˆä¸€ä¸ªå‚æ•°ä¿¡æ¯çš„æ•°ç»„
CG(active_op_array)-&gt;arg_info = erealloc(CG(active_op_array)-&gt;arg_info, sizeof(zend_arg_info)*(CG(active_op_array)-&gt;num_args));</p>

<p>// è®¾ç½®å½“å‰çš„zend_arg_info
cur_arg_info = &amp;CG(active_op_array)-&gt;arg_info[CG(active_op_array)-&gt;num_args-1];
cur_arg_info-&gt;name = estrndup(varname-&gt;u.constant.value.str.val, varname-&gt;u.constant.value.str.len);
cur_arg_info-&gt;name_len = varname-&gt;u.constant.value.str.len;
cur_arg_info-&gt;array_type_hint = 0;
cur_arg_info-&gt;allow_null = 1;
cur_arg_info-&gt;pass_by_reference = pass_by_reference;
cur_arg_info-&gt;class_name = NULL;
cur_arg_info-&gt;class_name_len = 0;</p>

<p>// å¦‚æœéœ€è¦å¯¹å‚æ•°åšç±»å‹é™å®š
if (class_type-&gt;op_type != IS_UNUSED) {
    cur_arg_info-&gt;allow_null = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// é™å®šä¸ºç±»
if (class_type-&gt;u.constant.type == IS_STRING) {
    if (ZEND_FETCH_CLASS_DEFAULT == zend_get_class_fetch_type(Z_STRVAL(class_type-&gt;u.constant), Z_STRLEN(class_type-&gt;u.constant))) {
        zend_resolve_class_name(class_type, &amp;opline-&gt;extended_value, 1 TSRMLS_CC);
    }
    cur_arg_info-&gt;class_name = class_type-&gt;u.constant.value.str.val;
    cur_arg_info-&gt;class_name_len = class_type-&gt;u.constant.value.str.len;
    
    // å¦‚æœé™å®šä¸ºç±»ï¼Œåˆ™å‚æ•°çš„é»˜è®¤å€¼åªèƒ½ä¸ºNULL
    if (op == ZEND_RECV_INIT) {
        if (Z_TYPE(initialization-&gt;u.constant) == IS_NULL || (Z_TYPE(initialization-&gt;u.constant) == IS_CONSTANT &amp;&amp; !strcasecmp(Z_STRVAL(initialization-&gt;u.constant), "NULL"))) {
            cur_arg_info-&gt;allow_null = 1;
        } else {
            zend_error(E_COMPILE_ERROR, "Default value for parameters with a class type hint can only be NULL");
        }
    }
}
// é™å®šä¸ºæ•°ç»„
else {
    // å°†array_type_hintè®¾ç½®ä¸º1
    cur_arg_info-&gt;array_type_hint = 1;
    cur_arg_info-&gt;class_name = NULL;
    cur_arg_info-&gt;class_name_len = 0;
    
    // å¦‚æœé™å®šä¸ºæ•°ç»„ï¼Œåˆ™å‚æ•°çš„é»˜è®¤å€¼åªèƒ½ä¸ºæ•°ç»„æˆ–NULL
    if (op == ZEND_RECV_INIT) {
        if (Z_TYPE(initialization-&gt;u.constant) == IS_NULL || (Z_TYPE(initialization-&gt;u.constant) == IS_CONSTANT &amp;&amp; !strcasecmp(Z_STRVAL(initialization-&gt;u.constant), "NULL"))) {
            cur_arg_info-&gt;allow_null = 1;
        } else if (Z_TYPE(initialization-&gt;u.constant) != IS_ARRAY &amp;&amp; Z_TYPE(initialization-&gt;u.constant) != IS_CONSTANT_ARRAY) {
            zend_error(E_COMPILE_ERROR, "Default value for parameters with array type hint can only be an array or NULL");
        }
    }
} } opline-&gt;result.u.EA.type |= EXT_TYPE_UNUSED; è¿™éƒ¨åˆ†ä»£ç å†™çš„å¾ˆæ¸…æ™°ã€‚æ³¨æ„ï¼Œå¯¹äºé™å®šä¸ºæ•°ç»„çš„æƒ…å†µï¼Œclass_typeçš„op_typeä¼šè¢«è®¾ç½®ä¸ºIS_CONSTï¼Œè€Œu.constant.typeä¼šè¢«è®¾ç½®ä¸ºIS_NULLï¼š
</code></pre></div></div>

<p>optional_class_type:
		/* empty */			{ \(.op_type = IS_UNUSED; }
	|	fully_qualified_class_name	{\) = $1; }
	|	T_ARRAY				{ \(.op_type = IS_CONST; Z_TYPE(\).u.constant)=IS_NULL;}
å› æ­¤ï¼Œzend_do_receive_argä¸­åŒºåˆ†é™å®šä¸ºç±»è¿˜æ˜¯æ•°ç»„ï¼Œæ˜¯åˆ©ç”¨class_type-&gt;u.constant.type == IS_STRINGæ¥åˆ¤æ–­çš„ã€‚å¦‚æœç±»å‹é™å®šä¸ºæ•°ç»„ï¼Œåˆ™cur_arg_info-&gt;array_type_hintä¼šè¢«è®¾ç½®ä¸º1ã€‚</p>

<p>è¿˜æœ‰å¦ä¸€ä¸ªåœ°æ–¹éœ€è¦äº†è§£ï¼Œzend_resolve_class_nameå‡½æ•°ä¼šä¿®æ­£ç±»åã€‚ä¸¾ä¾‹æ¥è¯´ï¼š</p>

<p>&lt;?php
namespace A;
class B { }
function foo(B $arg1, $arg2 = 100)
{
    print($arg1);
}
æˆ‘ä»¬æœŸæœ›å‚æ•°arg1çš„ç±»å‹ä¸ºBï¼Œclass_typeä¸­ä¹Ÿä¿å­˜äº†Bã€‚ä½†æ˜¯å› ä¸ºä½äºå‘½åç©ºé—´Aä¸‹ï¼Œæ‰€ä»¥ï¼Œzend_resolve_class_nameä¼šå°†class_typeä¸­ä¿å­˜çš„ç±»åBï¼Œä¿®æ­£ä¸ºA\Bã€‚</p>

<p>OKï¼Œåˆ°è¿™é‡Œï¼Œzend_do_receive_argå·²ç»å…¨éƒ¨åˆ†æå®Œã€‚zend vmåœ¨åˆ†æå‡½æ•°å‚æ•°æ—¶ï¼Œæ¯é‡è§ä¸€ä¸ªå‚æ•°ï¼Œä¾¿ä¼šè°ƒç”¨ä¸€æ¬¡zend_do_receive_argï¼Œç”Ÿæˆä¸€æ¡RECVæŒ‡ä»¤ã€‚å› æ­¤ï¼Œå‡½æ•°æœ‰å‡ ä¸ªå‚æ•°ï¼Œå°±ä¼šç¼–è¯‘å‡ºå‡ æ¡RECVæŒ‡ä»¤ã€‚</p>

<p>4ã€ç¼–è¯‘å‡½æ•°ä½“
å½“ç¼–è¯‘å®Œå‚æ•°åˆ—è¡¨ï¼Œzend vmä¾¿ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨äº†ã€‚å‡½æ•°ä½“çš„ç¼–è¯‘å…¶å®å’Œæ­£å¸¸è¯­å¥çš„ç¼–è¯‘ä¸€æ ·ã€‚zend vmåªéœ€è¦å°†å‡½æ•°ä½“å†…éƒ¨çš„phpè¯­å¥ï¼ŒæŒ‰ç…§æ­£å¸¸çš„statmentï¼Œè¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†ææ¥å¤„ç†ï¼Œæœ€ç»ˆå½¢æˆä¸€æ¡æ¡zend_opæŒ‡ä»¤ã€‚</p>

<p>æ¥çœ‹ä¸‹è¯­æ³•æ–‡ä»¶ï¼š</p>

<p>unticked_function_declaration_statement:
	function is_reference T_STRING { zend_do_begin_function_declaration(&amp;$1, &amp;$3, 0, $2.op_type, NULL TSRMLS_CC); }
	â€˜(â€˜ parameter_list â€˜)â€™ â€˜{â€˜ inner_statement_list â€˜}â€™ { zend_do_end_function_declaration(&amp;$1 TSRMLS_CC); }
;
å‡½æ•°ä½“å†…éƒ¨çš„è¯­å¥ï¼Œè¡¨ç¤ºä¸ºinner_statement_listã€‚</p>

<p>inner_statement_list:
		inner_statement_list  { zend_do_extended_info(TSRMLS_C); } inner_statement { HANDLE_INTERACTIVE(); }
	|	/* empty */
;
è€Œinner_statmentæ­£æ˜¯ç”±è¯­å¥ã€å‡½æ•°å£°æ˜ã€ç±»å£°æ˜ç»„æˆçš„ã€‚</p>

<p>inner_statement:
		statement
	|	function_declaration_statement
	|	class_declaration_statement
	|	T_HALT_COMPILER â€˜(â€˜ â€˜)â€™ â€˜;â€™   { zend_error(E_COMPILE_ERROR, â€œ__HALT_COMPILER() can only be used from the outermost scopeâ€); }
;
inner_statementå¹¶éä¸“é—¨ç”¨äºå‡½æ•°ï¼Œå…¶ä»–è­¬å¦‚foreachï¼Œwhileå¾ªç¯ç­‰æœ‰blockè¯­å¥å—ä¸­ï¼Œéƒ½ä¼šè¢«è¯†åˆ«ä¸ºinner_statementã€‚ä»è¿™é‡Œå…¶å®è¿˜èƒ½çœ‹åˆ°ä¸€äº›æœ‰æ„æ€çš„è¯­æ³•ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°é‡Œå£°æ˜ä¸€ä¸ªç±»ã€‚inner_statementå°±ä¸å±•å¼€å™è¿°äº†ï¼Œå¦åˆ™ç›¸å½“äºå°†æ•´ä¸ªphpçš„è¯­æ³•æ‹ä¸€éï¼Œæƒ…å†µå¤ªå¤šäº†ã€‚</p>

<p>5ã€ç»“æŸç¼–è¯‘
æˆ‘ä»¬æœ€åæ¥çœ‹ä¸‹ç»“æŸç¼–è¯‘çš„è¿‡ç¨‹ã€‚ç»“æŸå‡½æ•°ç¼–è¯‘æ˜¯é€šè¿‡zend_do_end_function_declarationæ¥å®Œæˆçš„ã€‚</p>

<p>zend_do_end_function_declarationæ¥æ”¶çš„å‚æ•°function_tokenï¼Œå…¶å®å°±æ˜¯å‰é¢æåˆ°è¿‡çš„functionå­—é¢å¯¹åº”çš„znodeã€‚æ ¹æ®æˆ‘ä»¬åœ¨â€œå¼€å§‹ç¼–è¯‘â€ä¸€èŠ‚æ‰€è¿°ï¼Œfunction_tokenä¸­ä¿ç•™äº†å‡½æ•°ä½“ä¹‹å¤–çš„op_arrayã€‚</p>

<p>char lcname[16];
int name_len;</p>

<p>zend_do_extended_info(TSRMLS_C);</p>

<p>// è¿”å›NULL
zend_do_return(NULL, 0 TSRMLS_CC);</p>

<p>// é€šè¿‡opæŒ‡ä»¤è®¾ç½®å¯¹åº”çš„handlerå‡½æ•°
pass_two(CG(active_op_array) TSRMLS_CC);</p>

<p>// é‡Šæ”¾å½“å‰å‡½æ•°çš„CG(labels)ï¼Œå¹¶ä»CG(labels_stack)ä¸­è¿˜åŸä¹‹å‰çš„CG(labels)
zend_release_labels(TSRMLS_C);</p>

<p>if (CG(active_class_entry)) {
    // æ£€æŸ¥é­”æœ¯æ–¹æ³•çš„å‚æ•°æ˜¯å¦åˆæ³•
    zend_check_magic_method_implementation(CG(active_class_entry), (zend_function<em>)CG(active_op_array), E_COMPILE_ERROR TSRMLS_CC);
} else {
    /</em> we donâ€™t care if the function name is longer, in fact lowercasing only 
     * the beginning of the name speeds up the check process <em>/
    name_len = strlen(CG(active_op_array)-&gt;function_name);
    zend_str_tolower_copy(lcname, CG(active_op_array)-&gt;function_name, MIN(name_len, sizeof(lcname)-1));
    lcname[sizeof(lcname)-1] = â€˜\0â€™; /</em> zend_str_tolower_copy wonâ€™t necessarily set the zero byte */</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ£€æŸ¥__autoloadå‡½æ•°çš„å‚æ•°æ˜¯å¦åˆæ³•
if (name_len == sizeof(ZEND_AUTOLOAD_FUNC_NAME) - 1 &amp;&amp; !memcmp(lcname, ZEND_AUTOLOAD_FUNC_NAME, sizeof(ZEND_AUTOLOAD_FUNC_NAME)) &amp;&amp; CG(active_op_array)-&gt;num_args != 1) {
    zend_error(E_COMPILE_ERROR, "%s() must take exactly 1 argument", ZEND_AUTOLOAD_FUNC_NAME);
}         }
</code></pre></div></div>

<p>CG(active_op_array)-&gt;line_end = zend_get_compiled_lineno(TSRMLS_C);</p>

<p>// å¾ˆå…³é”®ï¼å°†CG(active_op_array)è¿˜åŸæˆå‡½æ•°å¤–å±‚çš„op_array
CG(active_op_array) = function_token-&gt;u.op_array;</p>

<p>/* Pop the switch and foreach seperators */
zend_stack_del_top(&amp;CG(switch_cond_stack));
zend_stack_del_top(&amp;CG(foreach_copy_stack));
æœ‰3å¤„å€¼å¾—æ³¨æ„ï¼š</p>

<p>1ï¼Œzend_do_end_function_declarationä¸­ä¼šå¯¹CG(active_op_array)è¿›è¡Œè¿˜åŸã€‚ç”¨çš„æ­£æ˜¯function_token-&gt;u.op_arrayã€‚ä¸€æ—¦zend_do_end_function_declarationå®Œæˆï¼Œå‡½æ•°çš„æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹å°±å·²ç»ç»“æŸäº†ã€‚zend vmä¼šç»§ç»­çœ‹æ¥ä¸‹æ¥å‡½æ•°ä¹‹å¤–çš„ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å°†CG(active_op_array)åˆ‡æ¢æˆåŸå…ˆçš„ã€‚</p>

<p>2ï¼Œzend_do_returnè´Ÿè´£åœ¨å‡½æ•°æœ€åæ·»åŠ ä¸Šä¸€æ¡RETURNæŒ‡ä»¤ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ è¿›å»çš„æ˜¯NULLï¼Œæ‰€ä»¥è¿™æ¡RETURNæŒ‡ä»¤çš„æ“ä½œæ•°è¢«å¼ºåˆ¶è®¾ç½®ä¸ºUNUSEDã€‚æ³¨æ„ï¼Œä¸ç®¡å‡½æ•°æœ¬èº«æ˜¯å¦æœ‰returnè¯­å¥ï¼Œæœ€åè¿™æ¡RETURNæŒ‡ä»¤æ˜¯å¿…ç„¶å­˜åœ¨çš„ã€‚å‡å¦‚å‡½æ•°æœ‰returnè¯­å¥ï¼Œreturnè¯­å¥ä¹Ÿä¼šäº§ç”Ÿä¸€æ¡RETURNæŒ‡ä»¤ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´å¯èƒ½å‡ºç°å¤šæ¡RETURNæŒ‡ä»¤ã€‚ä¸¾ä¾‹æ¥è¯´ï¼š</p>

<p>function foo()
{
    return true;
}
ç¼–è¯‘å‡ºæ¥çš„OPæŒ‡ä»¤æœ€åä¸¤æ¡å¦‚ä¸‹ï¼š</p>

<p>RETURN        true
 RETURN        null
æˆ‘ä»¬å¯ä»¥å¾ˆæ˜æ˜¾åœ¨æœ€åçœ‹åˆ°ä¸¤æ¡RETURNã€‚ä¸€æ¡æ˜¯é€šè¿‡return trueç¼–è¯‘å‡ºæ¥çš„ã€‚å¦ä¸€æ¡ï¼Œå°±æ˜¯åœ¨zend_do_end_function_declarationé˜¶æ®µï¼Œå¼ºåˆ¶æ’å…¥çš„RETURNã€‚</p>

<p>3ï¼Œæˆ‘ä»¬åˆšæ‰è®²è§£çš„æ‰€æœ‰æ­¥éª¤ä¸­ï¼Œéƒ½åªæ˜¯è®¾ç½®äº†æ¯æ¡æŒ‡ä»¤çš„opcodeï¼Œè€Œå¹¶æ²¡æœ‰è®¾ç½®è¿™æ¡æŒ‡ä»¤å…·ä½“çš„handleå‡½æ•°ã€‚pass_twoä¼šè´Ÿè´£éå†æ¯æ¡zend_opæŒ‡ä»¤ï¼Œæ ¹æ®opcodeï¼Œä»¥åŠæ“ä½œæ•°op1å’Œop2ï¼Œå»æŸ¥æ‰¾å¹¶ä¸”è®¾ç½®å¯¹åº”çš„handleå‡½æ•°ã€‚è¿™é¡¹å·¥ä½œï¼Œæ˜¯é€šè¿‡ZEND_VM_SET_OPCODE_HANDLER(opline)å®æ¥å®Œæˆçš„ã€‚</p>

<p>#define ZEND_VM_SET_OPCODE_HANDLER(opline) zend_vm_set_opcode_handler(opline)
zend_vm_set_opcode_handlerçš„å®ç°å¾ˆç®€å•ï¼š</p>

<p>void zend_init_opcodes_handlers(void)
{
    // è¶…å¤§çš„æ•°ç»„ï¼Œé‡Œé¢å­˜æ”¾äº†æ‰€æœ‰çš„handler
    static const opcode_handler_t labels[] = {
        ZEND_NOP_SPEC_HANDLER,
        ZEND_NOP_SPEC_HANDLER,
        ZEND_NOP_SPEC_HANDLER,
        ZEND_NOP_SPEC_HANDLER,
        ZEND_NOP_SPEC_HANDLER,
        ZEND_NOP_SPEC_HANDLER,
        â€¦
    };
    zend_opcode_handlers = (opcode_handler_t*)labels;
}</p>

<p>static opcode_handler_t zend_vm_get_opcode_handler(zend_uchar opcode, zend_op* op)
{
        static const int zend_vm_decode[] = {
            _UNUSED_CODE, /* 0              <em>/
            _CONST_CODE,  /</em> 1 = IS_CONST   <em>/
            _TMP_CODE,    /</em> 2 = IS_TMP_VAR <em>/
            _UNUSED_CODE, /</em> 3              <em>/
            _VAR_CODE,    /</em> 4 = IS_VAR     <em>/
            _UNUSED_CODE, /</em> 5              <em>/
            _UNUSED_CODE, /</em> 6              <em>/
            _UNUSED_CODE, /</em> 7              <em>/
            _UNUSED_CODE, /</em> 8 = IS_UNUSED  <em>/
            _UNUSED_CODE, /</em> 9              <em>/
            _UNUSED_CODE, /</em> 10             <em>/
            _UNUSED_CODE, /</em> 11             <em>/
            _UNUSED_CODE, /</em> 12             <em>/
            _UNUSED_CODE, /</em> 13             <em>/
            _UNUSED_CODE, /</em> 14             <em>/
            _UNUSED_CODE, /</em> 15             <em>/
            _CV_CODE      /</em> 16 = IS_CV     */
        };</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // å»handleræ•°ç»„é‡Œæ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°
    return zend_opcode_handlers[opcode * 25 + zend_vm_decode[op-&gt;op1.op_type] * 5 + zend_vm_decode[op-&gt;op2.op_type]]; }
</code></pre></div></div>

<p>ZEND_API void zend_vm_set_opcode_handler(zend_op* op)
{
    // ç»™zend opè®¾ç½®å¯¹åº”çš„handlerå‡½æ•°
    op-&gt;handler = zend_vm_get_opcode_handler(zend_user_opcodes[op-&gt;opcode], op);
}
æ‰€æœ‰çš„opcodeéƒ½å®šä¹‰åœ¨zend_vm_opcodes.hé‡Œï¼Œä»php5.3-php5.6ï¼Œå¤§æ¦‚ä»150å¢é•¿åˆ°170ä¸ªopcodeã€‚ä¸Šé¢å¯ä»¥çœ‹åˆ°é€šè¿‡opcodeæŸ¥æ‰¾handlerçš„å‡†ç¡®ç®—æ³•ï¼š</p>

<p>zend_opcode_handlers[opcode * 25 + zend_vm_decode[op-&gt;op1.op_type] * 5 + zend_vm_decode[op-&gt;op2.op_type]
ä¸è¿‡zend_opcode_handlersæ•°ç»„å¤ªå¤§äº†â€¦æ‰¾èµ·æ¥å¾ˆéº»çƒ¦ã€‚</p>

<p>ä¸‹é¢å›åˆ°æ–‡ç« å¼€å§‹çš„é‚£æ®µphpä»£ç ï¼Œæˆ‘ä»¬å°†å‡½æ•°fooè¿›è¡Œç¼–è¯‘ï¼Œæœ€ç»ˆå¾—åˆ°çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œå› ä¸ºfooæŒ‡æ¥å—ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œåªæœ‰ä¸€æ¡RECVæŒ‡ä»¤ã€‚</p>

<p>printè¯­å¥çš„å‚æ•°ä¸º!0ï¼Œ!0æ˜¯ä¸€ä¸ªcompiled variablesï¼Œå…¶å®å°±æ˜¯å‚æ•°ä¸­çš„arg1ã€‚0ä»£è¡¨ç€ç´¢å¼•ï¼Œå›å¿†ä¸€ä¸‹ï¼Œå‡½æ•°çš„op_arrayæœ‰ä¸€ä¸ªæ•°ç»„ä¸“é—¨ç”¨äºä¿å­˜compiled variablesï¼Œ0è¡¨æ˜arg1ä½äºè¯¥æ•°ç»„çš„å¼€ç«¯ã€‚</p>

<p>printè¯­å¥æœ‰è¿”å›å€¼ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨ä¸€ä¸ªä¸´æ—¶å˜é‡ä¿å­˜å…¶è¿”å›å€¼ï¼Œå³~0ã€‚ç”±äºæˆ‘ä»¬åœ¨å‡½æ•°ä¸­å¹¶æœªä½¿ç”¨~0ï¼Œæ‰€ä»¥éšå³ä¾¿ä¼šæœ‰ä¸€æ¡FREEæŒ‡ä»¤å¯¹å…¶è¿›è¡Œé‡Šæ”¾ã€‚</p>

<p>åœ¨å‡½æ•°çš„æœ€åï¼Œæ˜¯ä¸€æ¡RETURNæŒ‡ä»¤ã€‚</p>

<p>6ã€ç»‘å®š
å‡½æ•°ç¼–è¯‘å®Œæˆä¹‹åï¼Œè¿˜éœ€è¦è¿›è¡Œçš„ä¸€æ­¥æ˜¯ç»‘å®šã€‚zend vmé€šè¿‡zend_do_early_bindingæ¥å®ç°ç»‘å®šã€‚è¿™ä¸ªåå­—å®¹æ˜“è®©äººäº§ç”Ÿç–‘æƒ‘ï¼Œå…¶å®åªæœ‰åœ¨æ¶‰åŠåˆ°ç±»å’Œæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰ä¼šæœ‰æ—©æœŸç»‘å®šï¼Œä¸ä¹‹ç›¸å¯¹çš„æ˜¯å»¶è¿Ÿç»‘å®šï¼Œæˆ–è€…å«åæœŸç»‘å®šã€‚çº¯ç²¹å‡½æ•°è°ˆä¸ä¸Šè¿™ç§æ¦‚å¿µï¼Œä¸è¿‡zend_do_early_bindingæ˜¯å¤šåŠŸèƒ½çš„ï¼Œå¹¶éä»…ä»…ä¸ºç»‘å®šæ–¹æ³•è€Œå®ç°ã€‚</p>

<p>æ¥çœ‹ä¸‹zend_do_early_bindingï¼š</p>

<p>// æ‹¿åˆ°çš„æ˜¯æœ€è¿‘ä¸€æ¡zend opï¼Œå¯¹äºå‡½æ•°æ¥è¯´ï¼Œå°±æ˜¯ZEND_DECLARE_FUNCTION
zend_op *opline = &amp;CG(active_op_array)-&gt;opcodes[CG(active_op_array)-&gt;last-1];
HashTable *table;</p>

<p>while (opline-&gt;opcode == ZEND_TICKS &amp;&amp; opline &gt; CG(active_op_array)-&gt;opcodes) {
    oplineâ€“;
}</p>

<p>switch (opline-&gt;opcode) {
    case ZEND_DECLARE_FUNCTION:
        // çœŸæ­£ç»‘å®šå‡½æ•°
        if (do_bind_function(opline, CG(function_table), 1) == FAILURE) {
            return;
        }
        table = CG(function_table);
        break;
    case ZEND_DECLARE_CLASS:
        â€¦
    case ZEND_DECLARE_INHERITED_CLASS:
        â€¦
}</p>

<p>// op1ä¸­ä¿å­˜çš„æ˜¯å‡½æ•°çš„keyï¼Œè¿™é‡Œå…¶ä»å°†CG(function_table)ä¸­åˆ é™¤
zend_hash_del(table, opline-&gt;op1.u.constant.value.str.val, opline-&gt;op1.u.constant.value.str.len);
zval_dtor(&amp;opline-&gt;op1.u.constant);
zval_dtor(&amp;opline-&gt;op2.u.constant);</p>

<p>// oplineç½®ä¸ºNOP
MAKE_NOP(opline);
è¿™ä¸ªå‡½æ•°å®ç°ä¹Ÿå¾ˆç®€å•ï¼Œä¸»è¦å°±æ˜¯è°ƒç”¨äº†do_bind_functionã€‚</p>

<p>ZEND_API int do_bind_function(zend_op <em>opline, HashTable *function_table, zend_bool compile_time) /</em> {{{ */
{
    zend_function *function;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ‰¾å‡ºå‡½æ•°
zend_hash_find(function_table, opline-&gt;op1.u.constant.value.str.val, opline-&gt;op1.u.constant.value.str.len, (void *) &amp;function);

// ä»¥å‡½æ•°åç§°ä½œä¸ºkeyï¼Œé‡æ–°åŠ å…¥function_table
if (zend_hash_add(function_table, opline-&gt;op2.u.constant.value.str.val, opline-&gt;op2.u.constant.value.str.len+1, function, sizeof(zend_function), NULL)==FAILURE) {
    int error_level = compile_time ? E_COMPILE_ERROR : E_ERROR;
    zend_function *old_function;

    // åŠ å…¥å¤±è´¥ï¼Œå¯èƒ½å‘ç”Ÿé‡å¤å®šä¹‰äº†
    if (zend_hash_find(function_table, opline-&gt;op2.u.constant.value.str.val, opline-&gt;op2.u.constant.value.str.len+1, (void *) &amp;old_function)==SUCCESS
        &amp;&amp; old_function-&gt;type == ZEND_USER_FUNCTION
        &amp;&amp; old_function-&gt;op_array.last &gt; 0) {
        zend_error(error_level, "Cannot redeclare %s() (previously declared in %s:%d)",
                    function-&gt;common.function_name, old_function-&gt;op_array.filename, old_function-&gt;op_array.opcodes[0].lineno);
    } else {
        zend_error(error_level, "Cannot redeclare %s()", function-&gt;common.function_name);
    }
    return FAILURE;
} else {
    (*function-&gt;op_array.refcount)++;
    function-&gt;op_array.static_variables = NULL; /* NULL out the unbound function */
    return SUCCESS;
} } åœ¨è¿›å…¥do_bind_functionä¹‹å‰ï¼Œå…¶å®CG(function_table)ä¸­å·²ç»æœ‰äº†å‡½æ•°çš„op_arrayã€‚ä¸è¿‡ç”¨çš„é”®å¹¶éå‡½æ•°åï¼Œè€Œæ˜¯build_runtime_defined_function_keyç”Ÿæˆçš„â€œkeyâ€ï¼Œè¿™ç‚¹åœ¨å‰é¢â€œå¼€å§‹ç¼–è¯‘â€ä¸€èŠ‚ä¸­æœ‰è¿‡ä»‹ç»ã€‚do_bind_functionæ‰€åšçš„äº‹æƒ…ï¼Œæ­£æ˜¯åˆ©ç”¨è¿™ä¸ªâ€œkeyâ€ï¼Œå°†å‡½æ•°æŸ¥æ‰¾å‡ºæ¥ï¼Œå¹¶ä¸”ä»¥çœŸæ­£çš„å‡½æ•°åä¸ºé”®ï¼Œé‡æ–°æ’å…¥åˆ°CG(function_table)ä¸­ã€‚
</code></pre></div></div>

<p>å› æ­¤å½“do_bind_functionå®Œæˆæ—¶ï¼Œfunction_tableä¸­æœ‰2ä¸ªé”®å¯ä»¥æŸ¥è¯¢åˆ°è¯¥å‡½æ•°ã€‚ä¸€ä¸ªæ˜¯â€œkeyâ€ä¸ºç´¢å¼•çš„ï¼Œå¦ä¸€ä¸ªæ˜¯ä»¥å‡½æ•°åä¸ºç´¢å¼•çš„ã€‚åœ¨zend_do_early_bindingçš„æœ€åï¼Œä¼šé€šè¿‡zend_hash_delæ¥åˆ é™¤â€œkeyâ€ï¼Œä»è€Œä¿è¯function_tableä¸­ï¼Œè¯¥å‡½æ•°åªèƒ½å¤Ÿä»¥å‡½æ•°åä¸ºé”®å€¼æŸ¥è¯¢åˆ°ã€‚</p>

<p>7ã€æ€»ç»“
è¿™ç¯‡å…¶å®ä¸»è¦æ˜¯ä¸ºäº†å¼„æ¸…æ¥šï¼Œå‡½æ•°å¦‚ä½•è¢«ç¼–è¯‘æˆop_arrayã€‚ä¸€äº›å…³é”®çš„æ­¥éª¤å¦‚ä¸‹å›¾ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/func_opcode.png" />
ä»¬å‰é¢çš„ç« èŠ‚å¼„æ˜ç™½äº†å‡½æ•°ä½“ä¼šè¢«ç¼–è¯‘ç”Ÿæˆå“ªäº›zend_opæŒ‡ä»¤ï¼Œæœ¬ç« ä¼šç ”ç©¶å‡½æ•°è°ƒç”¨è¯­å¥ä¼šç”Ÿæˆå“ªäº›zend_opæŒ‡ï¼Œç­‰åé¢çš„ç« èŠ‚å†æ ¹æ®è¿™äº›opæŒ‡ä»¤ï¼Œæ¥å‰–æphpè¿è¡Œæ—¶çš„ç»†èŠ‚ã€‚</p>

<p>æºç ä¾ç„¶å–è‡ªphp5.3.29ã€‚</p>

<p>å‡½æ•°è°ƒç”¨
å›é¡¾ä¹‹å‰ç”¨çš„phpä»£ç ç¤ºä¾‹ï¼š</p>

<p>&lt;?php
function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
foo($bar);
åœ¨å‡½æ•°ç¼–è¯‘ä¸€ç« é‡Œå·²ç»åˆ†æè¿‡ï¼Œå‡½æ•°fooæœ€ç»ˆä¼šç¼–è¯‘ç”Ÿæˆå¯¹åº”çš„zend_functionï¼Œå­˜æ”¾äºå‡½æ•°è¡¨(CG(function_table))ä¸­ã€‚</p>

<p>ç°åœ¨å¼€å§‹çœ‹ foo($bar); ä¸€å¥ï¼Œè¿™åº”è¯¥æ˜¯æœ€ç®€å•çš„å‡½æ•°è°ƒç”¨è¯­å¥äº†ã€‚å…¶ä»–è¿˜æœ‰ä¸€äº›å½¢å¼æ›´ä¸ºå¤æ‚çš„å‡½æ•°è°ƒç”¨ï¼Œä¾‹å¦‚ä»¥å¯å˜å˜é‡ä½œä¸ºå‡½æ•°åï¼Œä¾‹å¦‚å¯¼å…¥çš„å‡½æ•°ä»¥åˆ«åè¿›è¡Œè°ƒç”¨ï¼ˆæ¶‰åŠåˆ°å‘½åç©ºé—´ï¼‰ï¼Œå†ä¾‹å¦‚ä»¥å¼•ç”¨ä½œä¸ºå‚æ•°ï¼Œä»¥è¡¨è¾¾å¼ä½œä¸ºå‚æ•°ï¼Œä»¥å‡½æ•°è°ƒç”¨æœ¬èº«ä½œä¸ºå‚æ•°ç­‰ç­‰ã€‚</p>

<p>æˆ‘ä»¬ä»ç®€å•çš„æ¥å…¥æ‰‹ï¼Œå¼„æ¸…æ¥šè°ƒç”¨è¯­å¥çš„ç¼–è¯‘è¿‡ç¨‹åŠäº§å‡ºï¼Œå¯¹äºå¤æ‚çš„ä¸€äº›è°ƒç”¨ï¼Œä¸‹æ–‡ä¹Ÿäº‰å–éƒ½èƒ½è°ˆåˆ°ä¸€äº›ã€‚</p>

<p>1ã€è¯­æ³•æ¨å¯¼
å°± foo($bar); è€Œè¨€ï¼Œå…¶ä¸»è¦éƒ¨åˆ†è¯­æ³•æ ‘ä¸º
<img src="https://xiazemin.github.io/MyBlog/img/func_call_opcode.png" />
ç»¿è‰²çš„èŠ‚ç‚¹è¡¨ç¤ºæœ€åå¯¹åº”åˆ°phpä»£ç ä¸­çš„å­—é¢ã€‚çº¢è‰²çš„éƒ¨åˆ†æ˜¯è¯­æ³•æ¨å¯¼è¿‡ç¨‹ä¸­æœ€é‡è¦çš„å‡ æ­¥ï¼Œç‰¹åˆ«æ˜¯function_callã€‚</p>

<p>æˆ‘ä»¬ä»è¯­æ³•åˆ†ææ–‡ä»¶zend_language_parser.yä¸­æŒ‘å‡ºç›¸å…³çš„ï¼š</p>

<p>function_call:
		namespace_name â€˜(â€˜ { $2.u.opline_num = zend_do_begin_function_call(&amp;$1, 1 TSRMLS_CC); }
				function_call_parameter_list
				â€˜)â€™ { zend_do_end_function_call(&amp;$1, &amp;\(, &amp;$4, 0, $2.u.opline_num TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C); }
	|	T_NAMESPACE T_NS_SEPARATOR namespace_name '(' { $1.op_type = IS_CONST; ZVAL_EMPTY_STRING(&amp;$1.u.constant);  zend_do_build_namespace_name(&amp;$1, &amp;$1, &amp;$3 TSRMLS_CC); $4.u.opline_num = zend_do_begin_function_call(&amp;$1, 0 TSRMLS_CC); }
				function_call_parameter_list
				')' { zend_do_end_function_call(&amp;$1, &amp;\), &amp;$6, 0, $4.u.opline_num TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C); }
	|	T_NS_SEPARATOR namespace_name â€˜(â€˜ { $3.u.opline_num = zend_do_begin_function_call(&amp;$2, 0 TSRMLS_CC); }
				function_call_parameter_list
				â€˜)â€™ { zend_do_end_function_call(&amp;$2, &amp;\(, &amp;$5, 0, $3.u.opline_num TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C); }
	|	class_name T_PAAMAYIM_NEKUDOTAYIM T_STRING '(' { $4.u.opline_num = zend_do_begin_class_member_function_call(&amp;$1, &amp;$3 TSRMLS_CC); }
			function_call_parameter_list
			')' { zend_do_end_function_call($4.u.opline_num?NULL:&amp;$3, &amp;\), &amp;$6, $4.u.opline_num, $4.u.opline_num TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
	|	class_name T_PAAMAYIM_NEKUDOTAYIM variable_without_objects â€˜(â€˜ { zend_do_end_variable_parse(&amp;$3, BP_VAR_R, 0 TSRMLS_CC); zend_do_begin_class_member_function_call(&amp;$1, &amp;$3 TSRMLS_CC); }
			function_call_parameter_list
			â€˜)â€™ { zend_do_end_function_call(NULL, &amp;\(, &amp;$6, 1, 1 TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
	|	variable_class_name T_PAAMAYIM_NEKUDOTAYIM T_STRING '(' { zend_do_begin_class_member_function_call(&amp;$1, &amp;$3 TSRMLS_CC); }
			function_call_parameter_list
			')' { zend_do_end_function_call(NULL, &amp;\), &amp;$6, 1, 1 TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
	|	variable_class_name T_PAAMAYIM_NEKUDOTAYIM variable_without_objects â€˜(â€˜ { zend_do_end_variable_parse(&amp;$3, BP_VAR_R, 0 TSRMLS_CC); zend_do_begin_class_member_function_call(&amp;$1, &amp;$3 TSRMLS_CC); }
			function_call_parameter_list
			â€˜)â€™ { zend_do_end_function_call(NULL, &amp;\(, &amp;$6, 1, 1 TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
	|	variable_without_objects  '(' { zend_do_end_variable_parse(&amp;$1, BP_VAR_R, 0 TSRMLS_CC); zend_do_begin_dynamic_function_call(&amp;$1, 0 TSRMLS_CC); }
			function_call_parameter_list ')'
			{ zend_do_end_function_call(&amp;$1, &amp;\), &amp;$4, 0, 1 TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
;</p>

<p>function_call_parameter_list:
        non_empty_function_call_parameter_list    { \(= $1; }
    |    /* empty */                ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€{ Z_LVAL(\).u.constant) = 0; }
;</p>

<p>non_empty_function_call_parameter_list:
        expr_without_variable    { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$1, ZEND_SEND_VAL, Z_LVAL(\).u.constant) TSRMLS_CC); }
    |    variable                { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$1, ZEND_SEND_VAR, Z_LVAL(\).u.constant) TSRMLS_CC); }
    |    â€˜&amp;â€™ w_variable          { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$2, ZEND_SEND_REF, Z_LVAL(\).u.constant) TSRMLS_CC); }
    |    non_empty_function_call_parameter_list â€˜,â€™ expr_without_variable    { Z_LVAL(\(.u.constant)=Z_LVAL($1.u.constant)+1;  zend_do_pass_param(&amp;$3, ZEND_SEND_VAL, Z_LVAL(\).u.constant) TSRMLS_CC); }
    |    non_empty_function_call_parameter_list â€˜,â€™ variable                 { Z_LVAL(\(.u.constant)=Z_LVAL($1.u.constant)+1;  zend_do_pass_param(&amp;$3, ZEND_SEND_VAR, Z_LVAL(\).u.constant) TSRMLS_CC); }
    |    non_empty_function_call_parameter_list â€˜,â€™ â€˜&amp;â€™ w_variable           { Z_LVAL(\(.u.constant)=Z_LVAL($1.u.constant)+1;  zend_do_pass_param(&amp;$4, ZEND_SEND_REF, Z_LVAL(\).u.constant) TSRMLS_CC); }
;
å…¶ç»“æ„å¹¶ä¸å¤æ‚ï¼š</p>

<p>1ï¼‰function_callè¿™æ¡æ¨å¯¼ï¼Œä»£è¡¨äº†ä¸€ä¸ªå®Œæ•´çš„å‡½æ•°è°ƒç”¨ã€‚</p>

<p>2ï¼‰namespace_nameæ˜¯æŒ‡ç»è¿‡å‘½åç©ºé—´ä¿®é¥°è¿‡ä¹‹åçš„å‡½æ•°åï¼Œç”±äºæˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå‡½æ•°fooå¹¶æ²¡æœ‰å¤„äºä»»ä½•ä¸€ä¸ªå‘½åç©ºé—´é‡Œï¼Œæ‰€ä»¥namespace_nameå…¶å®å°±æ˜¯fooã€‚å¦‚æœæˆ‘ä»¬çš„å‡½æ•°å®šä¹‰åœ¨å‘½åç©ºé—´ä¸­ï¼Œåˆ™namespace_nameæ˜¯ä¸€ä¸ªç±»ä¼¼â€œå…¨è·¯å¾„â€çš„fullnameã€‚</p>

<p>namespace MyProject
{
function foo($arg1)
{
    print($arg1);
}
}</p>

<p>namespace
{
$bar = â€˜hello phpâ€™;
MyProject\foo($bar);// ä»¥ç±»ä¼¼â€œå…¨è·¯å¾„â€çš„fullnameæ¥è°ƒç”¨å‡½æ•°ï¼Œåˆ™namespace_nameä¸ºMyProject\foo 
}
3ï¼‰function_call_parameter_listæ˜¯å‡½æ•°çš„å‚æ•°åˆ—è¡¨ï¼Œè€Œnon_empty_function_call_parameter_liståˆ™ä»£è¡¨äº†éç©ºå‚æ•°åˆ—è¡¨ã€‚</p>

<p>4ï¼‰ä»è¿™äº›æ¨å¯¼äº§ç”Ÿå¼é‡Œï¼Œæˆ‘ä»¬è¿˜èƒ½çœ‹å‡ºç¼–è¯‘æ—¶çš„æ‰€è¿ç”¨çš„ä¸€äº›å…³é”®å¤„ç†ï¼š</p>

<p>zend_do_begin_function_callâ€“&gt;zend_do_pass_paramâ€“&gt;zend_do_end_function_call</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    å¼€å§‹                        è§£æå‚æ•°                     ç»“æŸ å’Œç¼–è¯‘functionè¯­å¥å—æ—¶çš„å‡ æ­¥ï¼ˆzend_do_begin_function_declaration-&gt;zend_do_receive_arg-&gt;zend_do_end_function_declarationç­‰ï¼‰é¡ºåºä¸Šæ¯”è¾ƒç±»ä¼¼ã€‚
</code></pre></div></div>

<p>ä¸Šé¢æåˆ°è¯­æ³•æ ‘æˆ‘ä»¬ä»…ä»…ç”»äº†ä¸€éƒ¨åˆ†ï¼Œå‡†ç¡®è®²ï¼Œæ²¡æœ‰å°†namespaceä»¥åŠfunction_call_parameter_listä»¥ä¸‹çš„æ¨å¯¼è¿‡ç¨‹è¿›ä¸€æ­¥ç”»å‡ºæ¥ã€‚åŸå› ä¸€æ˜¯namespaceçš„æ¨å¯¼æ¯”è¾ƒç®€å•ã€‚ç¬¬äºŒï¼Œç”±äºfunction_call_parameter_listâ€“&gt;variableè¿™æ­¥ä¼šå›åˆ°variableä¸Šï¼Œè€Œvariableç»è¿‡è‹¥å¹²æ­¥ä¸€ç›´åˆ°äº§ç”Ÿå˜é‡$barçš„æ¨å¯¼æ¯”è¾ƒå¤æ‚ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸ä¸€è¿›æ­¥æ¢ç©¶äº†ã€‚</p>

<p>2ã€å¼€å§‹ç¼–è¯‘
çœ‹ä¸‹function_callçš„æ¨å¯¼å¼ï¼Œä¸€å¼€å§‹ï¼Œzend vmä¼šæ‰§è¡Œzend_do_begin_function_callåšä¸€äº›å‡½æ•°è°ƒç”¨çš„å‡†å¤‡ã€‚</p>

<p>2.1ã€ zend_do_begin_function_call
ä»£ç æ³¨è§£å¦‚ä¸‹ï¼š</p>

<p>zend_function *function;
char *lcname;
char *is_compound = memchr(Z_STRVAL(function_name-&gt;u.constant), â€˜\â€™, Z_STRLEN(function_name-&gt;u.constant));</p>

<p>// å°†å‡½æ•°åè¿›è¡Œä¿®æ­£ï¼Œä¾‹å¦‚å¸¦ä¸Šå‘½åç©ºé—´ä½œä¸ºå‰ç¼€ç­‰
zend_resolve_non_class_name(function_name, check_namespace TSRMLS_CC);</p>

<p>// èƒ½è¿›å…¥è¯¥åˆ†æ”¯ï¼Œè¯´æ˜åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸‹ä»¥shortnameè°ƒç”¨å‡½æ•°ï¼Œä¼šç”Ÿæˆä¸€æ¡DO_FCALL_BY_NAMEæŒ‡ä»¤
if (check_namespace &amp;&amp; CG(current_namespace) &amp;&amp; !is_compound) {
        /* We assume we call function from the current namespace
        if it is not prefixed. */</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /* In run-time PHP will check for function with full name and
    internal function with short name */
    zend_do_begin_dynamic_function_call(function_name, 1 TSRMLS_CC);
    return 1; } 
</code></pre></div></div>

<p>// è½¬æˆå°å†™ï¼Œå› ä¸ºCG(function_table)ä¸­çš„å‡½æ•°åéƒ½æ˜¯å°å†™
lcname = zend_str_tolower_dup(function_name-&gt;u.constant.value.str.val, function_name-&gt;u.constant.value.str.len);</p>

<p>// å¦‚æœfunction_tableä¸­æ‰¾ä¸åˆ°è¯¥å‡½æ•°ï¼Œåˆ™ä¹Ÿå°è¯•ç”ŸæˆDO_FCALL_BY_NAMEæŒ‡ä»¤
if ((zend_hash_find(CG(function_table), lcname, function_name-&gt;u.constant.value.str.len+1, (void <em>*) &amp;function) == FAILURE) ||
    ((CG(compiler_options) &amp; ZEND_COMPILE_IGNORE_INTERNAL_FUNCTIONS) &amp;&amp; (function-&gt;type == ZEND_INTERNAL_FUNCTION))) {
        zend_do_begin_dynamic_function_call(function_name, 0 TSRMLS_CC);
        efree(lcname);
        return 1; /</em> Dynamic */
} 
efree(function_name-&gt;u.constant.value.str.val);
function_name-&gt;u.constant.value.str.val = lcname;</p>

<p>// å‹å…¥CG(function_call_stack)
zend_stack_push(&amp;CG(function_call_stack), (void *) &amp;function, sizeof(zend_function *));
zend_do_extended_fcall_begin(TSRMLS_C);
return 0;
æœ‰å‡ ç‚¹éœ€è¦ç†è§£çš„ï¼š</p>

<p>1ï¼Œzend_resolve_non_class_nameã€‚ç”±äºphpæ”¯æŒå‘½åç©ºé—´ã€ä¹Ÿæ”¯æŒåˆ«å/å¯¼å…¥ç­‰ç‰¹æ€§ï¼Œå› æ­¤é¦–å…ˆè¦åšçš„æ˜¯å°†å‡½æ•°åç§°è¿›è¡Œä¿®æ­£ï¼Œå¦åˆ™åœ¨CG(function_table)ä¸­æ‰¾ä¸åˆ°ã€‚ä¾‹å¦‚ï¼Œå‡½æ•°å¤„äºä¸€ä¸ªå‘½åç©ºé—´ä¸­ï¼Œåˆ™å¯èƒ½éœ€è¦å°†å‡½æ•°åæ·»åŠ ä¸Šå‘½åç©ºé—´ä½œä¸ºå‰ç¼€ï¼Œæœ€ç»ˆå½¢æˆå®Œæ•´çš„å‡½æ•°åï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰æ–‡æåˆ°çš„ä»¥ä¸€ç§ç±»ä¼¼â€œå…¨è·¯å¾„â€çš„fullnameä½œä¸ºå‡½æ•°åã€‚å†ä¾‹å¦‚ï¼Œå‡½æ•°ååªæ˜¯ä¸€ä¸ªè®¾ç½®çš„åˆ«åï¼Œå®ƒå®é™…æŒ‡å‘äº†å¦ä¸€ä¸ªå‘½åç©ºé—´ä¸­çš„æŸä¸ªå‡½æ•°ï¼Œåˆ™éœ€è¦å°†å…¶æ”¹å†™æˆçœŸæ­£è¢«è°ƒç”¨å‡½æ•°çš„åç§°ã€‚è¿™äº›å·¥ä½œï¼Œå‡ç”±zend_resolve_non_class_nameå®Œæˆã€‚å‘½åç©ºé—´æ·»åŠ äº†ä¸å°‘å¤æ‚åº¦ï¼Œä¸‹é¢æ˜¯ä¸€äº›ç®€å•çš„ä¾‹å­ï¼š</p>

<p>&lt;?php
namespace MyProject;</p>

<p>function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;</p>

<p>foo($bar);                 // zend_resolve_non_class_nameä¼šå°†fooå¤„ç†æˆMyProject\foo
namespace\foo($bar);       // åœ¨è¿›å…¥zend_do_begin_function_callä¹‹å‰ï¼Œå‡½æ•°åå·²ç»è¢«æ‰©å±•æˆ\MyProject\fooï¼Œå†ç»è¿‡zend_resolve_non_class_nameï¼Œå°†\MyProject\fooå¤„ç†æˆMyProject\foo
\MyProject\foo($bar);      // zend_resolve_non_class_nameä¼šå°†\MyProject\fooå¤„ç†æˆMyProject\foo
æ€»ä¹‹ï¼Œzend_resolve_non_class_nameæ˜¯åŠ›å›¾ç”Ÿæˆä¸€ä¸ªæœ€ç²¾ç¡®ã€æœ€å®Œæ•´çš„å‡½æ•°åã€‚</p>

<p>2ï¼ŒCG(current_namespace)å­˜å‚¨äº†å½“å‰çš„å‘½åç©ºé—´ã€‚check_namespaceå’Œ!is_compoundä¸€èµ·è¯´æ˜è¢«è°ƒç”¨å‡½æ•°åœ¨å½“å‰å‘½åç©ºé—´ä¸‹çš„ï¼Œå¹¶ä¸”ä»¥shortnameåç§°è¢«è°ƒç”¨ã€‚æ‰€è°“shortnameï¼Œæ˜¯å’Œä¸Šè¿°çš„fullnameç›¸å¯¹ï¼Œshornameçš„å‡½æ•°åï¼Œä¸å­˜åœ¨â€"ã€‚</p>

<p>å°±åƒä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨MyProjectå‘½åç©ºé—´ä¸‹ï¼Œä»¥fooä¸ºå‡½æ•°åæ¥è°ƒç”¨ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œcheck_namespace=1ï¼Œis_compound = NULLï¼ŒCG(current_namespace) = MyProjectã€‚å› æ­¤ï¼Œä¼šèµ°åˆ°zend_do_begin_dynamic_function_callé‡Œè¿›ä¸€æ­¥å¤„ç†ã€‚zend_do_begin_dynamic_function_callæˆ‘ä»¬ä¸‹é¢å†å…·ä½“æè¿°ã€‚</p>

<p>&lt;?php
namespace MyProject\sub;</p>

<p>function foo($arg1)
{
    print($arg1);
}</p>

<p>namespace MyProject;
$bar = â€˜hello phpâ€™;
sub\foo($bar);      // ä»¥sub\fooè°ƒç”¨å‡½æ•°ï¼Œå¹¶ä¸ç®—shortnameï¼Œå› ä¸ºå­˜åœ¨<br />
æ³¨æ„ä¸Šè¿°ä¾‹å­ï¼Œæˆ‘ä»¬ä»¥sub\fooæ¥è°ƒç”¨å‡½æ•°ã€‚zend_resolve_non_class_nameä¼šå°†å‡½æ•°åå¤„ç†æˆMyProject\sub\fooã€‚ä¸è¿‡is_compoundæ˜¯åœ¨zend_resolve_non_class_nameä¹‹å‰ç®—çš„ï¼Œç”±äºsub\fooå­˜åœ¨â€"ï¼Œæ‰€ä»¥is_compoundä¸ºâ€\fooâ€ï¼Œ!is_compoundæ˜¯falseï¼Œå› è€Œä¸èƒ½è¿›å…¥zend_do_begin_dynamic_function_callã€‚</p>

<p>3ï¼ŒåŒæ ·ï¼Œå¦‚æœCG(function_table)ä¸­æ‰¾ä¸åˆ°å‡½æ•°ï¼Œä¹Ÿä¼šè¿›å…¥zend_do_begin_dynamic_function_callè¿›ä¸€æ­¥å¤„ç†ã€‚ä¸ºä»€ä¹ˆåœ¨å‡½æ•°è¡¨ä¸­æ‰¾ä¸åˆ°å‡½æ•°ï¼Œå› ä¸ºphpå…è®¸æˆ‘ä»¬å…ˆè°ƒç”¨ï¼Œå†å»å®šä¹‰å‡½æ•°ã€‚ä¾‹å¦‚ï¼š</p>

<p>&lt;?php
$bar = â€˜hello phpâ€™;</p>

<p>// å…ˆè°ƒç”¨
foo($bar);</p>

<p>// åå®šä¹‰
function foo($arg1)
{
    print($arg1);
}
4ï¼Œåœ¨zend_do_begin_function_callçš„æœ€åï¼Œæˆ‘ä»¬å°†å‡½æ•°å‹å…¥CG(function_call_stack)ã€‚è¿™æ˜¯ä¸€ä¸ªæ ˆï¼Œå› ä¸ºåœ¨åç»­å¯¹ä¼ å‚çš„ç¼–è¯‘ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦ç”¨åˆ°å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œå°†å…¶å‹äºšå…¥æ ˆä¸­ï¼Œæ–¹ä¾¿åé¢è·å–ä½¿ç”¨ã€‚ä¹‹æ‰€ä»¥ç”¨æ ˆï¼Œæ˜¯å› ä¸ºè°ƒç”¨å‡½æ•°ä¼ é€’çš„å‚æ•°ï¼Œå¯èƒ½æ˜¯å¦ä¸€æ¬¡å‡½æ•°è°ƒç”¨ã€‚ä¸ºäº†ç¡®ä¿å‚æ•°æ€»æ˜¯èƒ½æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°ï¼Œæ‰€ä»¥ç”¨æ ˆã€‚</p>

<p>&lt;?php
function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
foo(strlen($bar));   // é¦–å…ˆfooå…¥æ ˆï¼Œç„¶ååˆ†æå‚æ•°strlen($bar)ï¼Œå‘ç°ä¾ç„¶æ˜¯ä¸ªå‡½æ•°ï¼Œäºæ˜¯strlenå…¥æ ˆï¼Œå†åˆ†æå‚æ•°$barï¼Œæ­¤æ—¶å¼¹å‡ºå¯¹åº”çš„å‡½æ•°æ­£å¥½ä¸ºstrlenã€‚
2.2ã€ zend_do_begin_dynamic_function_call
å‰é¢æåˆ°ï¼Œæ­£å¸¸çš„è°ƒç”¨ï¼Œä¼šå…ˆæ‰§è¡Œzend_do_begin_function_callï¼Œåœ¨zend_do_begin_function_callä¸­æœ‰ä¸¤ç§æƒ…å†µä¼šè¿›ä¸€æ­¥è°ƒç”¨zend_do_begin_dynamic_function_callæ¥å¤„ç†ã€‚</p>

<p>ä¸€æ˜¯ï¼Œåœ¨å‘½åç©ºé—´ä¸­ï¼Œä»¥shortnameè°ƒç”¨å‡½æ•°ï¼›</p>

<p>äºŒæ˜¯ï¼Œåœ¨è°ƒç”¨å‡½æ•°æ—¶ï¼Œå°šæœªå®šä¹‰å‡½æ•°ã€‚</p>

<p>å…¶å®è¿˜æœ‰ç¬¬ä¸‰ç§æƒ…å†µä¼šèµ°åˆ°zend_do_begin_dynamic_function_callï¼Œå°±æ˜¯å½“æˆ‘ä»¬è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå‡½æ•°åå¹¶éç›´æ¥å†™æˆå­—é¢ï¼Œè€Œæ˜¯é€šè¿‡å˜é‡ç­‰å½¢å¼æ¥é—´æ¥ç¡®å®šã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œzend vmä¼šç›´æ¥æ‰§è¡Œzend_do_begin_dynamic_function_callã€‚</p>

<p>ä¸¾ä¾‹1ï¼š</p>

<p>&lt;?php
function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
$func = â€˜fooâ€™;
$func($bar);          // æˆ‘ä»¬ä»¥å˜é‡$funcä½œä¸ºå‡½æ•°åï¼Œè¯•å›¾è°ƒç”¨å‡½æ•°fooï¼Œ$funcç±»å‹æ˜¯IS_CV
æ­¤æ—¶ï¼Œ $func($bar) å¯¹åº”function_callè¯­æ³•æ¨å¯¼å¼çš„æœ€åä¸€æ¡ï¼š</p>

<p>function_call:
        â€¦
	|	variable_without_objects  â€˜(â€˜ { zend_do_end_variable_parse(&amp;$1, BP_VAR_R, 0 TSRMLS_CC); zend_do_begin_dynamic_function_call(&amp;$1, 0 TSRMLS_CC); }
			function_call_parameter_list â€˜)â€™
			{ zend_do_end_function_call(&amp;$1, &amp;$$, &amp;$4, 0, 1 TSRMLS_CC); zend_do_extended_fcall_end(TSRMLS_C);}
æ¨å¯¼å¼ä¸­çš„variable_without_objectså¯¹åº”çš„å°±æ˜¯å˜é‡ $func ã€‚$funcå…¶å®æ˜¯ä¸€ä¸ªcompiled_variableï¼Œå¹¶ä¸”åœ¨op_array-&gt;varsæ•°ç»„ä¸­ç´¢å¼•ä¸º1ï¼Œç´¢å¼•ä¸º0çš„æ˜¯åœ¨å®ƒä¹‹å‰å®šä¹‰çš„å˜é‡ $bar ã€‚</p>

<p>ä¸¾ä¾‹2ï¼š</p>

<p>function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
$func = â€˜fooâ€™;
$ref_func = â€˜funcâ€™;
\(ref_func($bar); // ä»¥å¯å˜å˜é‡çš„å½¢å¼æ¥è°ƒç”¨å‡½æ•°ï¼Œ\)ref_funcç±»å‹æ˜¯IS_VAR
è¯¥ä¾‹æ˜¯ä»¥å¯å˜å˜é‡æ¥è°ƒç”¨å‡½æ•°ï¼Œå’Œä¾‹1ä¸€æ ·ï¼Œ \(ref_func($bar)ä¹Ÿæ˜¯å¯¹åº”function_callè¯­æ³•æ¨å¯¼å¼çš„æœ€åä¸€æ¡ï¼Œæ‰€ä»¥ä¸ä¼šèµ°è¿›zend_do_begin_function_callï¼Œè€Œæ˜¯ç›´æ¥è¿›å…¥zend_do_begin_dynamic_function_callã€‚ä¸åŒçš„ç‚¹åœ¨äº\)ref_func èŠ‚ç‚¹ç±»å‹ä¸å†æ˜¯compiled_variableï¼Œè€Œæ˜¯æ™®é€šçš„variableï¼Œæ ‡è¯†ä¸ºIS_VARã€‚</p>

<p>ä¸‹é¢çš„å›¾ç”»å‡ºäº†5ç§caseï¼Œç¬¬1ç§ä¸ç»è¿‡zend_do_begin_dynamic_function_callï¼Œè€Œå4ç§ä¼šè°ƒç”¨zend_do_begin_dynamic_function_callå¤„ç†ï¼Œæ³¨æ„æœ€å2ç§ä¸ç»è¿‡zend_do_begin_function_callï¼š
<img src="https://xiazemin.github.io/MyBlog/img/begin_func_opcode.png" /></p>

<p>å…·ä½“çœ‹ä¸‹zend_do_begin_dynamic_function_callçš„ä»£ç ï¼š</p>

<p>void zend_do_begin_dynamic_function_call(znode <em>function_name, int ns_call TSRMLS_DC) /</em> {{{ */
{
    unsigned char *ptr = NULL;
    zend_op *opline, *opline2;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// æ‹¿ä¸€æ¡zend_op
opline = get_next_op(CG(active_op_array) TSRMLS_CC);

// å‚æ•°ns_callè¡¨åæ˜¯å¦ä»¥shortnameåœ¨å‘½åç©ºé—´ä¸­è°ƒç”¨å‡½æ•°
if (ns_call) {
    char *slash;
    int prefix_len, name_len;
    /* In run-time PHP will check for function with full name and
       internal function with short name */
    
    // ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ZEND_INIT_NS_FCALL_BY_NAME
    opline-&gt;opcode = ZEND_INIT_NS_FCALL_BY_NAME;
    opline-&gt;op2 = *function_name;
    opline-&gt;extended_value = 0;
    opline-&gt;op1.op_type = IS_CONST;
    Z_TYPE(opline-&gt;op1.u.constant) = IS_STRING;
    Z_STRVAL(opline-&gt;op1.u.constant) = zend_str_tolower_dup(Z_STRVAL(opline-&gt;op2.u.constant), Z_STRLEN(opline-&gt;op2.u.constant));
    Z_STRLEN(opline-&gt;op1.u.constant) = Z_STRLEN(opline-&gt;op2.u.constant);
    opline-&gt;extended_value = zend_hash_func(Z_STRVAL(opline-&gt;op1.u.constant), Z_STRLEN(opline-&gt;op1.u.constant) + 1);
    
    // å†æ‹¿ä¸€æ¡zend_opï¼ŒæŒ‡ä»¤ä¸ºZEND_OP_DATA
    slash = zend_memrchr(Z_STRVAL(opline-&gt;op1.u.constant), '\\', Z_STRLEN(opline-&gt;op1.u.constant));
    prefix_len = slash-Z_STRVAL(opline-&gt;op1.u.constant)+1;
    name_len = Z_STRLEN(opline-&gt;op1.u.constant)-prefix_len;
    opline2 = get_next_op(CG(active_op_array) TSRMLS_CC);
    opline2-&gt;opcode = ZEND_OP_DATA;
    opline2-&gt;op1.op_type = IS_CONST;
    Z_TYPE(opline2-&gt;op1.u.constant) = IS_LONG;
    if(!slash) {
        zend_error(E_CORE_ERROR, "Namespaced name %s should contain slash", Z_STRVAL(opline-&gt;op1.u.constant));
    }
    /* this is the length of namespace prefix */
    Z_LVAL(opline2-&gt;op1.u.constant) = prefix_len;
    /* this is the hash of the non-prefixed part, lowercased */
    opline2-&gt;extended_value = zend_hash_func(slash+1, name_len+1);
    SET_UNUSED(opline2-&gt;op2);
} else {
    // ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯ZEND_INIT_FCALL_BY_NAME
    opline-&gt;opcode = ZEND_INIT_FCALL_BY_NAME;
    opline-&gt;op2 = *function_name;
    
    // å…ˆè°ƒç”¨ï¼Œå†å®šä¹‰
    if (opline-&gt;op2.op_type == IS_CONST) {
        opline-&gt;op1.op_type = IS_CONST;
        Z_TYPE(opline-&gt;op1.u.constant) = IS_STRING;
        Z_STRVAL(opline-&gt;op1.u.constant) = zend_str_tolower_dup(Z_STRVAL(opline-&gt;op2.u.constant), Z_STRLEN(opline-&gt;op2.u.constant));
        Z_STRLEN(opline-&gt;op1.u.constant) = Z_STRLEN(opline-&gt;op2.u.constant);
        opline-&gt;extended_value = zend_hash_func(Z_STRVAL(opline-&gt;op1.u.constant), Z_STRLEN(opline-&gt;op1.u.constant) + 1);
    }
    // ä»¥å˜é‡å½“å‡½æ•°åæ¥è°ƒç”¨
    else {
        opline-&gt;extended_value = 0;
        SET_UNUSED(opline-&gt;op1);
    }
}

// å°†NULLå‹å…¥CG(function_call_stack)
zend_stack_push(&amp;CG(function_call_stack), (void *) &amp;ptr, sizeof(zend_function *));
zend_do_extended_fcall_begin(TSRMLS_C); } ns_callå‚æ•°å–å€¼ä¸º0æˆ–è€…1ã€‚å¦‚æœåœ¨å‘½åç©ºé—´ä¸­ï¼Œä»¥shortnameè°ƒç”¨å‡½æ•°ï¼Œåˆ™ns_call = 1ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ2æ¡æŒ‡ä»¤ã€‚å¦‚æœæ˜¯å…ˆè°ƒç”¨å†å®šä¹‰ï¼Œæˆ–è€…ä»¥å˜é‡ä½œå‡½æ•°åï¼Œåˆ™ns_call = 0ï¼Œå¹¶ä¸”åªä¼šç”Ÿæˆ1æ¡æŒ‡ä»¤ã€‚
</code></pre></div></div>

<p>ä»¥ns_call = 1ä¸ºä¾‹ï¼š</p>

<p>&lt;?php
namespace MyProject;</p>

<p>function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
foo($bar);
 ç”Ÿæˆçš„opæŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š
<img src="https://xiazemin.github.io/MyBlog/img/begin_func_opcode_1.png" />
ä»¥ns_call = 0ï¼Œå…ˆè°ƒç”¨å†å®šä¹‰ä¸ºä¾‹ï¼š</p>

<p>&lt;?php
$bar = â€˜hello phpâ€™;
foo($bar);</p>

<p>function foo($arg1)
{
    print($arg1);
}
ç”Ÿæˆçš„opæŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>ä»¥ns_call = 0ï¼Œå˜é‡ä½œä¸ºå‡½æ•°åä¸ºä¾‹ï¼š</p>

<p>&lt;?php
function foo($arg1)
{
    print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
$func = â€˜fooâ€™;
$func($bar);
ç”Ÿæˆçš„opæŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>ä¸Šé¢ä¸€å…±æ–°å‡ºç°äº†3æ¡opæŒ‡ä»¤ï¼šZEND_INIT_NS_FCALL_BY_NAMEã€ZEND_OP_DATAä»¥åŠZEND_INIT_FCALL_BY_NAMEã€‚</p>

<p>å…¶ä¸­ï¼ŒZEND_INIT_NS_FCALL_BY_NAMEå’ŒZEND_INIT_FCALL_BY_NAMEéƒ½æ˜¯åœ¨è¿è¡Œæ—¶ä»å‡½æ•°è¡¨ä¸­å–å‡ºçœŸæ­£è¢«è°ƒç”¨çš„å‡½æ•°ã€‚ZEND_OP_DATAåœ¨æœ¬caseä¸­å¹¶ä¸èµ·ä½œç”¨ï¼Œç¬¬5ç« ä¸­ä¼šå…·ä½“åˆ†æZEND_OP_DATAã€‚</p>

<p>å›åˆ°zend_do_begin_dynamic_function_callï¼Œåœ¨ä»£ç çš„æœ€åå‘CG(function_call_stack)å‹å…¥äº†ä¸€ä¸ªNULLã€‚CG(function_call_stack)åœ¨éšåçš„zend_do_pass_paramä¸­ä¼šæœ‰ä½œç”¨ï¼Œè¿™é‡Œå‹å…¥NULLï¼Œæ„å‘³ç€éšåzend_do_pass_paramä¸­ä¼šå–å‡ºNULLï¼Œè¡¨æ˜æ— æ³•ä»å‡½æ•°å®šä¹‰ä¸­åˆ¤æ–­å…¶å‚æ•°çš„å±æ€§(æ˜¯å¦ä¸ºå¼•ç”¨ä¼ é€’ç­‰)ã€‚</p>

<p>3ã€ç¼–è¯‘ä¼ å‚
ä»å‰é¢è¯­æ³•æ¨å¯¼å¼é‡Œå¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨å‡½æ•°æ—¶çš„ä¼ å‚ï¼Œæœ€ç»ˆç”±zend_do_pass_paramæ¥å®Œæˆã€‚å…·ä½“å‚æ•°è¯¥æ€ä¹ˆä¼ ï¼Œå®é™…æƒ…å†µæ˜¯å¾ˆå¤æ‚çš„ã€‚phpè¯­æ³•æ¯”è¾ƒæ¾æ•£ï¼Œå¯ä»¥ä¼ é€’æ­£å¸¸çš„å˜é‡ï¼Œä¹Ÿå¯ä»¥ä¼ é€’è¡¨è¾¾å¼ï¼Œå¯ä»¥ä¼ é€’å¼•ç”¨ï¼Œç”šè‡³å¯ä»¥ä¼ é€’å¦ä¸€ä¸ªå‡½æ•°è°ƒç”¨ã€‚</p>

<p>ä½†æ— è®ºæ˜¯å“ªç§æƒ…å†µï¼Œæœ€ç»ˆä¼ å‚é€»è¾‘éƒ½ä¼šç¼–è¯‘æˆç±»ä¼¼SEND_VARï¼ŒSEND_VALï¼ŒSEND_REFï¼ŒZEND_SEND_VAR_NO_REFç­‰æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤å’Œå‡½æ•°ä¸­çš„RECVæŒ‡ä»¤æ˜¯å¯¹åº”çš„ã€‚å…·ä½“æ¥è¯´ï¼Œzend vmè¿›å…¥æ‰§è¡ŒæœŸä¹‹åï¼Œä¸€èˆ¬éƒ½æ˜¯ä¼šé€šè¿‡SEND_XXXç­‰æŒ‡ä»¤å‘é€å‚æ•°ï¼Œç„¶åæ‰§è¡ŒDO_FCALL/DO_FCALL_BY_NAMEç­‰æŒ‡ä»¤å¼€å§‹è°ƒç”¨å‡½æ•°ã€‚è¿›å…¥å‡½æ•°ä½“å†…ä¹‹åï¼Œå†æ‰§è¡ŒRECVå®Œæˆå‚æ•°çš„æ¥æ”¶ã€‚ç¬¬2ç« ä¸­æˆ‘ä»¬å…·ä½“è®²è§£äº†RECVæŒ‡ä»¤ï¼Œé™¤éå‡½æ•°ä¸æ¥å—å‚æ•°ï¼Œå¦åˆ™RECVå¿…å®šæ˜¯å‡½æ•°ä½“å†…çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚</p>

<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
 <img src="https://xiazemin.github.io/MyBlog/img/begin_func_opcode_2.png" />
 ä»¬ç»™å‡ºçš„ç¤ºä¾‹æ˜¯ä¸€ç§æœ€ç®€å•çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ä¼ é€’ä¸€ä¸ªæ­£å¸¸çš„å˜é‡ã€‚</p>

<p>æ¥çœ‹ä¸‹zend_do_pass_paramçš„å®ç°ï¼š</p>

<p>void zend_do_pass_param(znode <em>param, zend_uchar op, int offset TSRMLS_DC) /</em> {{{ */
{
    zend_op *opline;
    int original_op = op;
    zend_function **function_ptr_ptr, *function_ptr;
    int send_by_reference;
    int send_function = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ä»CG(function_call_stack)è·å–å½“å‰å‡½æ•°ï¼Œæ³¨æ„å¯èƒ½æ‹¿å‡ºçš„æ˜¯NULL
zend_stack_top(&amp;CG(function_call_stack), (void **) &amp;function_ptr_ptr);
function_ptr = *function_ptr_ptr;

// è°ƒç”¨çš„åœ°æ–¹ä»¥å¼•ç”¨ä¼ å‚ï¼Œä½†æ˜¯php.iniä¸­é…ç½®ä¸å…è®¸è¿™æ ·ï¼Œåˆ™æŠ›é”™
if (original_op == ZEND_SEND_REF &amp;&amp; !CG(allow_call_time_pass_reference)) {
    if (function_ptr &amp;&amp;
            function_ptr-&gt;common.function_name &amp;&amp;
            function_ptr-&gt;common.type == ZEND_USER_FUNCTION &amp;&amp;
            !ARG_SHOULD_BE_SENT_BY_REF(function_ptr, (zend_uint) offset)) {
        zend_error(E_DEPRECATED,
                    "Call-time pass-by-reference has been deprecated; "
                    "If you would like to pass it by reference, modify the declaration of %s().  "
                    "If you would like to enable call-time pass-by-reference, you can set "
                    "allow_call_time_pass_reference to true in your INI file", function_ptr-&gt;common.function_name);
    } else {
        zend_error(E_DEPRECATED, "Call-time pass-by-reference has been deprecated");
    }
} 1ï¼Œé¦–å…ˆæ˜¯ä»CG(function_call_stack)ä¸­è·å–å½“å‰å‚æ•°å¯¹åº”çš„å‡½æ•°ã€‚æ³¨æ„ï¼Œå¯èƒ½æ‹¿åˆ°çš„åªæ˜¯ä¸€ä¸ªNULLã€‚å› ä¸ºphpçš„è¯­æ³•å…è®¸æˆ‘ä»¬å…ˆå‡½æ•°è°ƒç”¨ï¼Œå†æ¥ç€å¯¹å‡½æ•°è¿›è¡Œå®šä¹‰ã€‚å¦‚å‰æ–‡æ‰€è¿°ï¼Œè¿™ç§æƒ…å†µä¸‹zend_do_begin_function_callä¸­ä¼šå‘CG(function_call_stack)ä¸­å‹å…¥NULLï¼ŒåŒæ—¶ä¼šäº§ç”ŸDO_FCALL_BY_NAMEæŒ‡ä»¤ã€‚
</code></pre></div></div>

<p>2ï¼Œåœ¨ä¼ å‚çš„è¯­æ³•æ¨å¯¼å¼ä¸­ï¼Œopå¯èƒ½ä¼šæœ‰3ç§ï¼Œåˆ†åˆ«æ˜¯ZEND_SEND_VALã€ZEND_SEND_VARã€ZEND_SEND_REFã€‚</p>

<p>expr_without_variable    { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$1, ZEND_SEND_VAL, Z_LVAL(\).u.constant) TSRMLS_CC); }
variable                 { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$1, ZEND_SEND_VAR, Z_LVAL(\).u.constant) TSRMLS_CC); }
â€˜&amp;â€™ w_variable           { Z_LVAL(\(.u.constant) = 1;  zend_do_pass_param(&amp;$2, ZEND_SEND_REF, Z_LVAL(\).u.constant) TSRMLS_CC); }
è¿™ä¸‰ç§opåˆ†åˆ«å¯¹åº”çš„è¯­æ³•æ˜¯expr_without_variableã€variableã€â€™&amp;â€™w_variableï¼Œç®€å•æ¥è¯´å°±æ˜¯â€œä¸å«å˜é‡çš„è¡¨è¾¾å¼â€ã€â€œå˜é‡â€ã€â€œå¼•ç”¨â€ã€‚</p>

<p>zend_do_pass_paramä¼šåˆ¤æ–­ï¼Œå¦‚æœç”¨æˆ·ä¼ é€’çš„æ˜¯å¼•ç”¨ï¼Œä½†åŒæ—¶åœ¨php.INIä¸­é…ç½®äº†å½¢å¦‚ allow_call_time_pass_reference = Off ï¼Œåˆ™éœ€è¦äº§ç”Ÿä¸€æ¡E_DEPRECATEDé”™è¯¯ä¿¡æ¯ï¼Œå‘ŠçŸ¥ç”¨æˆ·ä¼ é€’çš„æ—¶å€™ä¸å»ºè®®å¼ºåˆ¶å†™æˆå¼•ç”¨ã€‚</p>

<p>å…¶å®ï¼Œè¿˜æœ‰ç¬¬4ç§ä¼ å‚çš„opcodeï¼Œå³ZEND_SEND_VAR_NO_REFã€‚æˆ‘ä»¬æ¥ä¸‹æ¥ä¼šæåˆ°ã€‚</p>

<p>// å‡½æ•°å·²å®šä¹‰ï¼Œåˆ™æ ¹æ®å‡½æ•°çš„å®šä¹‰ï¼Œæ¥å†³å®šsend_by_referenceæ˜¯å¦ä¼ å¼•ç”¨
if (function_ptr) {
    if (ARG_MAY_BE_SENT_BY_REF(function_ptr, (zend_uint) offset)) {
        â€¦
    } else {
        // è¦ä¹ˆä¸º0ï¼Œè¦ä¹ˆä¸ºZEND_ARG_SEND_BY_REF
        send_by_reference = ARG_SHOULD_BE_SENT_BY_REF(function_ptr, (zend_uint) offset) ? ZEND_ARG_SEND_BY_REF : 0;
    }
}
// å‡½æ•°ä¸ºå®šä¹‰ï¼Œå…ˆç»Ÿä¸€å°†send_by_referenceç½®ä¸º0
else {
    send_by_reference = 0;
}</p>

<p>// å¦‚æœç”¨æˆ·ä¼ é€’çš„å‚æ•°ï¼Œæœ¬èº«å°±æ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œåˆ™å°†opæ”¹æˆZEND_SEND_VAR_NO_REF
if (op == ZEND_SEND_VAR &amp;&amp; zend_is_function_or_method_call(param)) {
    /* Method call */
    op = ZEND_SEND_VAR_NO_REF;
    send_function = ZEND_ARG_SEND_FUNCTION;
}
// å¦‚æœç”¨æˆ·ä¼ é€’çš„å‚æ•°ï¼Œæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¹¶ä¸”ç»“æœä¼šäº§ç”Ÿä¸­é—´å˜é‡ï¼Œåˆ™ä¹Ÿå°†opæ”¹æˆZEND_SEND_VAR_NO_REF
else if (op == ZEND_SEND_VAL &amp;&amp; (param-&gt;op_type &amp; (IS_VAR|IS_CV))) {
    op = ZEND_SEND_VAR_NO_REF;
}
1ï¼Œsend_by_referenceè¡¨ç¤ºæ ¹æ®å‡½æ•°çš„å®šä¹‰ï¼Œå‚æ•°æ˜¯ä¸æ˜¯å¼•ç”¨ã€‚ARG_MAY_BE_SENT_BY_REFå’ŒARG_SHOULD_BE_SENT_BY_REFä¸¤ä¸ªå®è¿™é‡Œå°±ä¸å…·ä½“å™è¿°äº†ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è‡ªå·±é˜…è¯»ä»£ç ã€‚</p>

<p>2ï¼Œop == ZEND_SEND_VARå¯¹åº”çš„æ˜¯variableï¼Œå‡å¦‚å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œä¹Ÿå¯èƒ½ä¼šè¢«ç¼–è¯‘æˆvariableï¼Œä½†æ˜¯å‡½æ•°è°ƒç”¨å¹¶ä¸å­˜åœ¨æ˜¾å¼å®šä¹‰çš„å˜é‡ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ç¼–è¯‘æˆSEND_VARæŒ‡ä»¤ï¼Œå› æ­¤è¿™é‡Œå°±æ¶‰åŠåˆ°äº†ä¸Šæ–‡æåˆ°çš„ç¬¬4ç§opcodeï¼Œå³ZEND_SEND_VAR_NO_REFã€‚ä¾‹å¦‚ï¼š</p>

<p>3ï¼Œop == ZEND_SEND_VALå¯¹åº”çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå¦‚æœè¯¥è¡¨è¾¾å¼äº§ç”Ÿäº†ä¸€ä¸ªå˜é‡ä½œä¸ºç»“æœï¼Œåˆ™ä¹Ÿéœ€è¦å°†opæ”¹æˆZEND_SEND_VAR_NO_REFã€‚ä¾‹å¦‚ï¼š</p>

<p>ç»§ç»­æ¥çœ‹zend_do_pass_paramï¼š</p>

<p>// å¦‚æœæ ¹æ®å‡½æ•°å®šä¹‰éœ€è¦ä¼ é€’å¼•ç”¨ï¼Œä¸”å®é™…ä¼ é€’çš„å‚æ•°æ˜¯å˜é‡ï¼Œåˆ™å°†opæ”¹æˆZEND_SEND_REF
if (op!=ZEND_SEND_VAR_NO_REF &amp;&amp; send_by_reference==ZEND_ARG_SEND_BY_REF) {
    /* change to passing by reference */
    switch (param-&gt;op_type) {
        case IS_VAR:
        case IS_CV:
            op = ZEND_SEND_REF;
            break;
        default:
            zend_error(E_COMPILE_ERROR, â€œOnly variables can be passed by referenceâ€);
            break;
    }
}</p>

<p>// å¦‚æœå®é™…ä¼ é€’çš„å‚æ•°æ˜¯å˜é‡ï¼Œè°ƒç”¨zend_do_end_variable_parseå¤„ç†é“¾å¼è°ƒç”¨
if (original_op == ZEND_SEND_VAR) {
    switch (op) {
        case ZEND_SEND_VAR_NO_REF:
            zend_do_end_variable_parse(param, BP_VAR_R, 0 TSRMLS_CC);
            break;
        case ZEND_SEND_VAR:
            if (function_ptr) {
                zend_do_end_variable_parse(param, BP_VAR_R, 0 TSRMLS_CC);
            } else {
                zend_do_end_variable_parse(param, BP_VAR_FUNC_ARG, offset TSRMLS_CC);
            }
            break;
        case ZEND_SEND_REF:
            zend_do_end_variable_parse(param, BP_VAR_W, 0 TSRMLS_CC);
            break;
    }
}
è¿™é‡Œæ³¨æ„param-&gt;op_typeæ˜¯ä¼ é€’çš„å‚æ•°ç»è¿‡ç¼–è¯‘å¾—åˆ°znodeçš„op_typeï¼Œå¦‚æœä¸å±äºå˜é‡ï¼ˆIS_VARã€IS_CVï¼‰ï¼Œå°±ç›´æ¥æŠ¥é”™äº†ã€‚ä¸¾ä¾‹æ¥è¯´ï¼š</p>

<p>function foo(&amp;$a)
{
    print($a);
}</p>

<p>foo($bar == 1);  // æŠ›é”™ â€œOnly variables can be passed by referenceâ€
ä¸Šé¢ $bar == 1 è¡¨è¾¾å¼çš„ç¼–è¯‘ç»“æœï¼Œop_typeä¸ºIS_TMP_VARï¼Œå¯ä»¥çœ‹åšä¸€ç§ä¸´æ—¶çš„ä¸­é—´ç»“æœï¼Œå¹¶éIS_VARï¼ŒIS_CVï¼Œå› æ­¤æ— æ³•ç¼–è¯‘æˆåŠŸã€‚çœ‹ç€é€»è¾‘æœ‰ç‚¹ç»•ï¼Œå…¶å®å¾ˆå¥½ç†è§£ã€‚å› ä¸ºæˆ‘ä»¬ä¼ é€’å¼•ç”¨ï¼Œå®é™…ç›®çš„æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨å‡½æ•°ä¸­ï¼Œå¯¹è¿™ä¸ªå‚æ•°çš„å€¼è¿›è¡Œä¿®æ”¹ï¼Œéœ€è¦å‚æ•°æ˜¯å¯å†™çš„ã€‚ç„¶è€Œ $bar == 1 äº§ç”Ÿçš„ä¸­é—´ç»“æœï¼Œæˆ‘ä»¬æ— æ³•åšå‡ºä¿®æ”¹ï¼Œæ˜¯åªè¯»çš„ã€‚</p>

<p>æ¥çœ‹zend_do_pass_paramçš„æœ€åä¸€æ®µï¼š</p>

<p>// è·å–ä¸‹ä¸€æ¡zend opæŒ‡ä»¤
opline = get_next_op(CG(active_op_array) TSRMLS_CC);</p>

<p>// extended_valueåŠ ä¸Šä¸åŒçš„é™„åŠ ä¿¡æ¯
if (op == ZEND_SEND_VAR_NO_REF) {
    if (function_ptr) {
        opline-&gt;extended_value = ZEND_ARG_COMPILE_TIME_BOUND | send_by_reference | send_function;
    } else {
        opline-&gt;extended_value = send_function;
    }
} else {
    if (function_ptr) {
        opline-&gt;extended_value = ZEND_DO_FCALL;
    } else {
        opline-&gt;extended_value = ZEND_DO_FCALL_BY_NAME;
    }
}</p>

<p>// è®¾ç½®opcodeã€op1ã€op2ç­‰
opline-&gt;opcode = op;
opline-&gt;op1 = *param;
opline-&gt;op2.u.opline_num = offset;
SET_UNUSED(opline-&gt;op2);
ä¸Šé¢è¿™æ®µä»£ç ç”Ÿæˆäº†ä¸€æ¡SENDæŒ‡ä»¤ã€‚å¦‚æœæˆ‘ä»¬è°ƒç”¨å‡½æ•°æ—¶å€™ä¼ é€’äº†å¤šä¸ªå‚æ•°ï¼Œåˆ™ä¼šè°ƒç”¨å¤šæ¬¡zend_do_pass_paramï¼Œæœ€ç»ˆä¼šç”Ÿæˆå¤šæ¡SENDæŒ‡ä»¤ã€‚</p>

<p>è‡³äºæŒ‡ä»¤å…·ä½“æ˜¯SEND_VARï¼ŒSEND_VALï¼Œè¿˜æ˜¯SEND_REï¼Œäº¦æˆ–æ˜¯ZEND_SEND_VAR_NO_REFï¼Œåˆ™ä¾é zend_do_pass_paramä¸­çš„åˆ¤æ–­ã€‚zend_do_pass_paramä¸­çš„é€»è¾‘åˆ†æ”¯æ¯”è¾ƒå¤šï¼Œä¸€ä¸‹å­ä¸èƒ½å¼„æ˜ç™½æ‰€æœ‰åˆ†æ”¯ä¹Ÿæ²¡å…³ç³»ï¼Œæœ€é‡è¦çš„æ˜¯çŸ¥é“å®ƒä¼šæ ¹æ®å‡½æ•°çš„å®šä¹‰ä»¥åŠå®é™…ä¼ é€’çš„å‚æ•°ï¼Œäº§ç”Ÿæœ€åˆé€‚çš„SENDæŒ‡ä»¤ã€‚</p>

<p>è¿˜æ˜¯å›åˆ°æˆ‘ä»¬å¼€å§‹çš„ä¾‹å­ï¼Œå¯¹äº foo($bar) ï¼Œåˆ™ç»è¿‡zend_do_pass_paramä¹‹åï¼Œäº§ç”Ÿçš„SENDæŒ‡ä»¤ç»†èŠ‚å¦‚ä¸‹ï¼š</p>

<p>4ã€ç»“æŸç¼–è¯‘
ç»“æŸå‡½æ•°è°ƒç”¨æ˜¯é€šè¿‡zend_do_end_function_callæ¥å®Œæˆçš„ã€‚æ ¹æ®å‰æ–‡æ‰€è¿°ï¼Œzend_do_begin_function_callå¹¶ä¸äº§ç”Ÿä¸€æ¡å®é™…çš„è°ƒç”¨æŒ‡ä»¤ï¼Œä½†å®ƒç¡®å®šäº†æœ€ç»ˆå‡½æ•°è°ƒç”¨èµ°çš„æ˜¯DO_FCALLè¿˜æ˜¯DO_FCALL_BY_NAMEï¼Œå¹¶ä¸”æ®æ­¤æ¥ç”ŸæˆZEND_INIT_NS_FCALL_BY_NAMEæˆ–ZEND_INIT_FCALL_BY_NAMEæŒ‡ä»¤ã€‚</p>

<p>å®é™…çš„è°ƒç”¨æŒ‡ä»¤æ˜¯æ”¾åœ¨zend_do_end_function_callä¸­æ¥ç”Ÿæˆçš„ã€‚</p>

<p>å…·ä½“åˆ†æä¸‹zend_do_end_function_callï¼š</p>

<p>zend_op *opline;</p>

<p>// è¿™æ®µé€»è¾‘åˆ†æ”¯ç°åœ¨å·²ç»èµ°ä¸åˆ°äº†
if (is_method &amp;&amp; function_name &amp;&amp; function_name-&gt;op_type == IS_UNUSED) {
    /* clone */
    if (Z_LVAL(argument_list-&gt;u.constant) != 0) {
        zend_error(E_WARNING, â€œClone method does not require argumentsâ€);
    }
    opline = &amp;CG(active_op_array)-&gt;opcodes[Z_LVAL(function_name-&gt;u.constant)];
} else {
    opline = get_next_op(CG(active_op_array) TSRMLS_CC);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å‡½æ•°ï¼Œåç§°ç¡®å®šï¼Œédynamic_fcallï¼Œå‡½æ•°åˆ™ç”ŸæˆZEND_DO_FCALLæŒ‡ä»¤
if (!is_method &amp;&amp; !is_dynamic_fcall &amp;&amp; function_name-&gt;op_type==IS_CONST) {
    opline-&gt;opcode = ZEND_DO_FCALL;
    opline-&gt;op1 = *function_name;
    ZVAL_LONG(&amp;opline-&gt;op2.u.constant, zend_hash_func(Z_STRVAL(function_name-&gt;u.constant), Z_STRLEN(function_name-&gt;u.constant) + 1));
}
// å¦åˆ™ç”ŸæˆZEND_DO_FCALL_BY_NAMEæŒ‡ä»¤
else {
    opline-&gt;opcode = ZEND_DO_FCALL_BY_NAME;
    SET_UNUSED(opline-&gt;op1);
} }
</code></pre></div></div>

<p>// ç”Ÿæˆä¸´æ—¶å˜é‡ç´¢å¼•ï¼Œå‡½æ•°çš„è°ƒç”¨ï¼Œè¿”å›çš„znodeå¿…ç„¶æ˜¯IS_VAR
opline-&gt;result.u.var = get_temporary_variable(CG(active_op_array));
opline-&gt;result.op_type = IS_VAR;
*result = opline-&gt;result;
SET_UNUSED(opline-&gt;op2);</p>

<p>// ä»CG(function_call_stack)å¼¹å‡ºå½“å‰è¢«è°ƒç”¨çš„å‡½æ•°
zend_stack_del_top(&amp;CG(function_call_stack));</p>

<p>// ä¼ å‚ä¸ªæ•°
opline-&gt;extended_value = Z_LVAL(argument_list-&gt;u.constant);
å…¶ä¸­æœ‰ä¸€æ®µifé€»è¾‘åˆ†æ”¯å·²ç»èµ°ä¸åˆ°äº†ï¼Œå¯ä»¥å¿½ç•¥ã€‚</p>

<p>å…·ä½“è€ƒæ®ï¼šè¿™æ®µé€»è¾‘åœ¨462eff3ä¸­è¢«æ·»åŠ ï¼Œä¸»è¦ç”¨äºå½“è°ƒç”¨__cloneé­”æœ¯æ–¹æ³•æ—¶ä¼ å‚è¿›è¡ŒæŠ›é”™ï¼Œä½†åœ¨8e30d96ä¸­ï¼Œå·²ç»ä¸å…è®¸ç›´æ¥è°ƒç”¨__cloneæ–¹æ³•äº†ï¼Œåœ¨è¿›å…¥zend_do_end_function_callä¹‹å‰ä¾¿ä¼šç»ˆæ­¢ç¼–è¯‘ï¼Œæ‰€ä»¥å®é™…ä¸Šå·²ç»å†ä¹Ÿèµ°ä¸åˆ°è¯¥åˆ†æ”¯äº†ã€‚</p>

<p>ç›´æ¥çœ‹elseéƒ¨åˆ†ï¼Œelseç”Ÿæˆäº†ä¸€æ¡zend opæŒ‡ä»¤ã€‚å¦‚æœå‡½æ•°åç¡®å®šï¼Œå‡½æ•°å·²è¢«å®šä¹‰ï¼Œå¹¶ä¸”ä¸å±äºåŠ¨æ€è°ƒç”¨ç­‰ï¼Œåˆ™ç”Ÿæˆçš„opæŒ‡ä»¤ä¸ºZEND_DO_FCALLï¼Œå¦åˆ™ç”ŸæˆZEND_DO_FCALL_BY_NAMEã€‚å¯¹äºZEND_DO_FCALLæŒ‡ä»¤ï¼Œå…¶æ“ä½œæ•°æ¯”è¾ƒæ˜ç¡®ï¼Œä¸ºå‡½æ•°åï¼Œä½†æ˜¯å¯¹äºZEND_DO_FCALL_BY_NAMEæ¥è¯´ï¼Œç”±äºè¢«è°ƒçš„å‡½æ•°å°šæœªæ˜ç¡®ï¼Œæ‰€ä»¥å°†æ“ä½œæ•°ç½®ä¸ºUNUSEDã€‚</p>

<p>5ã€æ€»ç»“
ç”¨ä¸€å¼ å›¾æ€»ç»“ä¸€ä¸‹å‡½æ•°è°ƒç”¨å¤§è‡´çš„ç¼–è¯‘æµç¨‹ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/begin_func_opcode_3.png" /></p>
:ET