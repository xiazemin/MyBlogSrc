I"›E<p>FastCGIæ˜¯WebæœåŠ¡å™¨(å¦‚ï¼šNginxã€Apache)å’Œå¤„ç†ç¨‹åºä¹‹é—´çš„ä¸€ç§é€šä¿¡åè®®ï¼Œå®ƒæ˜¯ä¸Httpç±»ä¼¼çš„ä¸€ç§åº”ç”¨å±‚é€šä¿¡åè®®ï¼Œæ³¨æ„ï¼šå®ƒåªæ˜¯ä¸€ç§åè®®ï¼
<!-- more -->
PHPåªæ˜¯ä¸€ä¸ªè„šæœ¬è§£æå™¨ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œè¾“å…¥æ˜¯PHPè„šæœ¬ã€‚è¾“å‡ºæ˜¯æ‰§è¡Œç»“æœï¼Œå‡å¦‚æˆ‘ä»¬æƒ³ç”¨PHPä»£æ›¿shellï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å†™ä¸€ä¸ªç¨‹åºæ¥åµŒå…¥PHPè§£æå™¨ï¼Œè¿™å°±æ˜¯cliæ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹PHPå°±æ˜¯æ™®é€šçš„ä¸€ä¸ªå‘½ä»¤å·¥å…·ã€‚æ¥ç€æˆ‘ä»¬åˆæƒ³ï¼šèƒ½ä¸èƒ½è®©PHPå¤„ç†httpè¯·æ±‚å‘¢ï¼Ÿè¿™æ—¶å°±æ¶‰åŠåˆ°äº†ç½‘ç»œå¤„ç†ï¼ŒPHPéœ€è¦æ¥æ”¶è¯·æ±‚ã€è§£æåè®®ï¼Œç„¶åå¤„ç†å®Œæˆè¿”å›è¯·æ±‚ã€‚åœ¨ç½‘ç»œåº”ç”¨åœºæ™¯ä¸‹ï¼ŒPHPå¹¶æ²¡æœ‰åƒGolangé‚£æ ·å®ç°httpç½‘ç»œåº“ï¼Œè€Œæ˜¯å®ç°äº†FastCGIåè®®ï¼Œç„¶åä¸webæœåŠ¡å™¨é…åˆå®ç°äº†httpçš„å¤„ç†ï¼ŒwebæœåŠ¡å™¨æ¥å¤„ç†httpè¯·æ±‚ï¼Œç„¶åå°†è§£æçš„ç»“æœå†é€šè¿‡FastCGIåè®®è½¬å‘ç»™å¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºå¤„ç†å®Œæˆåå°†ç»“æœè¿”å›ç»™webæœåŠ¡å™¨ï¼ŒwebæœåŠ¡å™¨å†è¿”å›ç»™ç”¨æˆ·ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>

<p>PHPå®ç°äº†FastCGIåè®®çš„è§£æï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…·ä½“å®ç°ç½‘ç»œå¤„ç†ï¼Œä¸€èˆ¬çš„å¤„ç†æ¨¡å‹ï¼šå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ï¼Œå¤šè¿›ç¨‹æ¨¡å‹é€šå¸¸æ˜¯ä¸»è¿›ç¨‹åªè´Ÿè´£ç®¡ç†å­è¿›ç¨‹ï¼Œè€ŒåŸºæœ¬çš„ç½‘ç»œäº‹ä»¶ç”±å„ä¸ªå­è¿›ç¨‹å¤„ç†ï¼Œnginxã€fpmå°±æ˜¯è¿™ç§æ¨¡å¼ï¼›å¦ä¸€ç§å¤šçº¿ç¨‹æ¨¡å‹ä¸å¤šè¿›ç¨‹ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ˜¯çº¿ç¨‹ç²’åº¦ï¼Œé€šå¸¸ä¼šç”±ä¸»çº¿ç¨‹ç›‘å¬ã€æ¥æ”¶è¯·æ±‚ï¼Œç„¶åäº¤ç”±å­çº¿ç¨‹å¤„ç†ï¼Œmemcachedå°±æ˜¯è¿™ç§æ¨¡å¼ï¼Œæœ‰çš„ä¹Ÿæ˜¯é‡‡ç”¨å¤šè¿›ç¨‹é‚£ç§æ¨¡å¼ï¼šä¸»çº¿ç¨‹åªè´Ÿè´£ç®¡ç†å­çº¿ç¨‹ä¸å¤„ç†ç½‘ç»œäº‹ä»¶ï¼Œå„ä¸ªå­çº¿ç¨‹ç›‘å¬ã€æ¥æ”¶ã€å¤„ç†è¯·æ±‚ï¼Œmemcachedä½¿ç”¨udpåè®®æ—¶é‡‡ç”¨çš„æ˜¯è¿™ç§æ¨¡å¼ã€‚</p>

<p>1.3.2 åŸºæœ¬å®ç°
æ¦‚æ‹¬æ¥è¯´ï¼Œfpmçš„å®ç°å°±æ˜¯åˆ›å»ºä¸€ä¸ªmasterè¿›ç¨‹ï¼Œåœ¨masterè¿›ç¨‹ä¸­åˆ›å»ºå¹¶ç›‘å¬socketï¼Œç„¶åforkå‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œè¿™äº›å­è¿›ç¨‹å„è‡ªacceptè¯·æ±‚ï¼Œå­è¿›ç¨‹çš„å¤„ç†éå¸¸ç®€å•ï¼Œå®ƒåœ¨å¯åŠ¨åé˜»å¡åœ¨acceptä¸Šï¼Œæœ‰è¯·æ±‚åˆ°è¾¾åå¼€å§‹è¯»å–è¯·æ±‚æ•°æ®ï¼Œè¯»å–å®Œæˆåå¼€å§‹å¤„ç†ç„¶åå†è¿”å›ï¼Œåœ¨è¿™æœŸé—´æ˜¯ä¸ä¼šæ¥æ”¶å…¶å®ƒè¯·æ±‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´fpmçš„å­è¿›ç¨‹åŒæ—¶åªèƒ½å“åº”ä¸€ä¸ªè¯·æ±‚ï¼Œåªæœ‰æŠŠè¿™ä¸ªè¯·æ±‚å¤„ç†å®Œæˆåæ‰ä¼šacceptä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™ä¸€ç‚¹ä¸nginxçš„äº‹ä»¶é©±åŠ¨æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œnginxçš„å­è¿›ç¨‹é€šè¿‡epollç®¡ç†å¥—æ¥å­—ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚æ•°æ®è¿˜æœªå‘é€å®Œæˆåˆ™ä¼šå¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œå³ä¸€ä¸ªè¿›ç¨‹ä¼šåŒæ—¶è¿æ¥å¤šä¸ªè¯·æ±‚ï¼Œå®ƒæ˜¯éé˜»å¡çš„æ¨¡å‹ï¼Œåªå¤„ç†æ´»è·ƒçš„å¥—æ¥å­—ã€‚</p>

<p>fpmçš„masterè¿›ç¨‹ä¸workerè¿›ç¨‹ä¹‹é—´ä¸ä¼šç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œmasteré€šè¿‡å…±äº«å†…å­˜è·å–workerè¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚workerè¿›ç¨‹å½“å‰çŠ¶æ€ã€å·²å¤„ç†è¯·æ±‚æ•°ç­‰ï¼Œå½“masterè¿›ç¨‹è¦æ€æ‰ä¸€ä¸ªworkerè¿›ç¨‹æ—¶åˆ™é€šè¿‡å‘é€ä¿¡å·çš„æ–¹å¼é€šçŸ¥workerè¿›ç¨‹ã€‚</p>

<p>fpmå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£å¯¹åº”ä¸€ä¸ªworker poolï¼Œè€Œæ¯ä¸ªpoolä¸‹å¯¹åº”å¤šä¸ªworkerè¿›ç¨‹ï¼Œç±»ä¼¼nginxä¸­serveræ¦‚å¿µã€‚</p>

<p>åœ¨php-fpm.confä¸­é€šè¿‡[pool name]å£°æ˜ä¸€ä¸ªworker poolï¼š</p>

<p>[web1]
listen = 127.0.0.1:9000
â€¦</p>

<p>[web2]
listen = 127.0.0.1:9001
â€¦
å¯åŠ¨fpmåæŸ¥çœ‹è¿›ç¨‹ï¼šps -aux|grep fpm</p>

<p>root 27155 0.0 0.1 144704 2720 ? Ss 15:16 0:00 php-fpm: master process (/usr/local/php7/etc/php-fpm.conf)
nobody 27156 0.0 0.1 144676 2416 ? S 15:16 0:00 php-fpm: pool web1
nobody 27157 0.0 0.1 144676 2416 ? S 15:16 0:00 php-fpm: pool web1
nobody 27159 0.0 0.1 144680 2376 ? S 15:16 0:00 php-fpm: pool web2
nobody 27160 0.0 0.1 144680 2376 ? S 15:16 0:00 php-fpm: pool web2
å…·ä½“å®ç°ä¸Šworker poolé€šè¿‡fpm_worker_pool_sè¿™ä¸ªç»“æ„è¡¨ç¤ºï¼Œå¤šä¸ªworker poolç»„æˆä¸€ä¸ªå•é“¾è¡¨ï¼š</p>

<p>struct fpm_worker_pool_s {
struct fpm_worker_pool_s next; //æŒ‡å‘ä¸‹ä¸€ä¸ªworker pool
struct fpm_worker_pool_config_s config; //confé…ç½®:pmã€max_childrenã€start_serversâ€¦
int listening_socket; //ç›‘å¬çš„å¥—æ¥å­—
â€¦</p>

<p>//ä»¥ä¸‹è¿™ä¸ªå€¼ç”¨äºmasterå®šæ—¶æ£€æŸ¥ã€è®°å½•workeræ•°
struct fpm_child_s *children; //å½“å‰poolçš„workeré“¾è¡¨
int running_children; //å½“å‰poolçš„workerè¿è¡Œæ€»æ•°
int idle_spawn_rate;
int warn_max_children;</p>

<p>struct fpm_scoreboard_s *scoreboard; //è®°å½•workerçš„è¿è¡Œä¿¡æ¯ï¼Œæ¯”å¦‚ç©ºé—²ã€å¿™ç¢Œworkeræ•°
â€¦
}
1.3.3 FPMçš„åˆå§‹åŒ–
æ¥ä¸‹æ¥çœ‹ä¸‹fpmçš„å¯åŠ¨æµç¨‹ï¼Œä»main()å‡½æ•°å¼€å§‹ï¼š</p>

<p>//sapi/fpm/fpm/fpm_main.c
int main(int argc, char *argv[])
{
â€¦
//æ³¨å†ŒSAPI:å°†å…¨å±€å˜é‡sapi_moduleè®¾ç½®ä¸ºcgi_sapi_module
sapi_startup(&amp;cgi_sapi_module);
â€¦
//æ‰§è¡Œphp_module_starup()
if (cgi_sapi_module.startup(&amp;cgi_sapi_module) == FAILURE) {
return FPM_EXIT_SOFTWARE;
}
â€¦
//åˆå§‹åŒ–
if(0 &gt; fpm_init(â€¦)){
â€¦
}
â€¦
fpm_is_running = 1;</p>

<p>fcgi_fd = fpm_run(&amp;max_requests);//åé¢éƒ½æ˜¯workerè¿›ç¨‹çš„æ“ä½œï¼Œmasterè¿›ç¨‹ä¸ä¼šèµ°åˆ°ä¸‹é¢
parent = 0;
â€¦
}
fpm_init()ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®æ“ä½œï¼š</p>

<p>(1)fpm_conf_init_main():</p>

<p>è§£æphp-fpm.confé…ç½®æ–‡ä»¶ï¼Œåˆ†é…worker poolå†…å­˜ç»“æ„å¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡ä¸­ï¼šfpm_worker_all_poolsï¼Œå„worker poolé…ç½®è§£æåˆ°fpm_worker_pool_s-&gt;configä¸­ã€‚</p>

<p>(2)fpm_scoreboard_init_main(): åˆ†é…ç”¨äºè®°å½•workerè¿›ç¨‹è¿è¡Œä¿¡æ¯çš„å…±äº«å†…å­˜ï¼ŒæŒ‰ç…§worker poolçš„æœ€å¤§workerè¿›ç¨‹æ•°åˆ†é…ï¼Œæ¯ä¸ªworker poolåˆ†é…ä¸€ä¸ªfpm_scoreboard_sç»“æ„ï¼Œpoolä¸‹å¯¹åº”çš„æ¯ä¸ªworkerè¿›ç¨‹åˆ†é…ä¸€ä¸ªfpm_scoreboard_proc_sç»“æ„ï¼Œå„ç»“æ„çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾ã€‚</p>

<p>(3)fpm_signals_init_main():</p>

<p>static int sp[2];</p>

<p>int fpm_signals_init_main()
{
struct sigaction act;</p>

<p>//åˆ›å»ºä¸€ä¸ªå…¨åŒå·¥ç®¡é“
if (0 &gt; socketpair(AF_UNIX, SOCK_STREAM, 0, sp)) {
    return -1;
}
//æ³¨å†Œä¿¡å·å¤„ç†handler
act.sa_handler = sig_handler;
sigfillset(&amp;act.sa_mask);
if (0 &gt; sigaction(SIGTERM,  &amp;act, 0) ||
    0 &gt; sigaction(SIGINT,   &amp;act, 0) ||
    0 &gt; sigaction(SIGUSR1,  &amp;act, 0) ||
    0 &gt; sigaction(SIGUSR2,  &amp;act, 0) ||
    0 &gt; sigaction(SIGCHLD,  &amp;act, 0) ||
    0 &gt; sigaction(SIGQUIT,  &amp;act, 0)) {
    return -1;
}
return 0;
}
è¿™é‡Œä¼šé€šè¿‡socketpair()åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè¿™ä¸ªç®¡é“å¹¶ä¸æ˜¯ç”¨äºmasterä¸workerè¿›ç¨‹é€šä¿¡çš„ï¼Œå®ƒåªåœ¨masterè¿›ç¨‹ä¸­ä½¿ç”¨ï¼Œå…·ä½“ç”¨é€”åœ¨ç¨åä»‹ç»eventäº‹ä»¶å¤„ç†æ—¶å†ä½œè¯´æ˜ã€‚å¦å¤–è®¾ç½®masterçš„ä¿¡å·å¤„ç†handlerï¼Œå½“masteræ”¶åˆ°SIGTERMã€SIGINTã€SIGUSR1ã€SIGUSR2ã€SIGCHLDã€SIGQUITè¿™äº›ä¿¡å·æ—¶å°†è°ƒç”¨sig_handler()å¤„ç†ï¼š</p>

<p>static void sig_handler(int signo)
{
static const char sig_chars[NSIG + 1] = {
[SIGTERM] = â€˜Tâ€˜,
[SIGINT] = â€˜Iâ€˜,
[SIGUSR1] = â€˜1â€˜,
[SIGUSR2] = â€˜2â€˜,
[SIGQUIT] = â€˜Qâ€˜,
[SIGCHLD] = â€˜Câ€˜
};
char s;
â€¦
s = sig_chars[signo];
//å°†ä¿¡å·é€šçŸ¥å†™å…¥ç®¡é“sp[1]ç«¯
write(sp[1], &amp;s, sizeof(s));
â€¦
}
(4)fpm_sockets_init_main()</p>

<p>åˆ›å»ºæ¯ä¸ªworker poolçš„socketå¥—æ¥å­—ã€‚</p>

<p>(5)fpm_event_init_main():</p>

<p>å¯åŠ¨masterçš„äº‹ä»¶ç®¡ç†ï¼Œfpmå®ç°äº†ä¸€ä¸ªäº‹ä»¶ç®¡ç†å™¨ç”¨äºç®¡ç†IOã€å®šæ—¶äº‹ä»¶ï¼Œå…¶ä¸­IOäº‹ä»¶é€šè¿‡kqueueã€epollã€pollã€selectç­‰ç®¡ç†ï¼Œå®šæ—¶äº‹ä»¶å°±æ˜¯å®šæ—¶å™¨ï¼Œä¸€å®šæ—¶é—´åè§¦å‘æŸä¸ªäº‹ä»¶ã€‚</p>

<p>åœ¨fpm_init()åˆå§‹åŒ–å®Œæˆåæ¥ä¸‹æ¥å°±æ˜¯æœ€å…³é”®çš„fpm_run()æ“ä½œäº†ï¼Œæ­¤ç¯èŠ‚å°†forkå­è¿›ç¨‹ï¼Œå¯åŠ¨è¿›ç¨‹ç®¡ç†å™¨ï¼Œå¦å¤–masterè¿›ç¨‹å°†ä¸ä¼šå†è¿”å›ï¼Œåªæœ‰å„workerè¿›ç¨‹ä¼šè¿”å›ï¼Œä¹Ÿå°±æ˜¯è¯´fpm_run()ä¹‹åçš„æ“ä½œå‡æ˜¯workerè¿›ç¨‹çš„ã€‚</p>

<p>int fpm_run(int max_requests)
{
struct fpm_worker_pool_s wp;
for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
//è°ƒç”¨fpm_children_make() forkå­è¿›ç¨‹
is_parent = fpm_children_create_initial(wp);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (!is_parent) {
    goto run_child;
} } //masterè¿›ç¨‹å°†è¿›å…¥eventå¾ªç¯ï¼Œä¸å†å¾€ä¸‹èµ° fpm_event_loop(0); run_child: //åªæœ‰workerè¿›ç¨‹ä¼šåˆ°è¿™é‡Œ
</code></pre></div></div>

<p>*max_requests = fpm_globals.max_requests;
return fpm_globals.listening_socket; //è¿”å›ç›‘å¬çš„å¥—æ¥å­—
}
åœ¨forkåworkerè¿›ç¨‹è¿”å›äº†ç›‘å¬çš„å¥—æ¥å­—ç»§ç»­main()åé¢çš„å¤„ç†ï¼Œè€Œmasterå°†æ°¸è¿œé˜»å¡åœ¨fpm_event_loop()ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç»masterã€workerè¿›ç¨‹çš„åç»­æ“ä½œã€‚</p>

<p>1.3.4 è¯·æ±‚å¤„ç†
fpm_run()æ‰§è¡Œåå°†forkå‡ºworkerè¿›ç¨‹ï¼Œworkerè¿›ç¨‹è¿”å›main()ä¸­ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œåé¢çš„æµç¨‹å°±æ˜¯workerè¿›ç¨‹ä¸æ–­acceptè¯·æ±‚ï¼Œç„¶åæ‰§è¡ŒPHPè„šæœ¬å¹¶è¿”å›ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>

<p>(1)ç­‰å¾…è¯·æ±‚ï¼š workerè¿›ç¨‹é˜»å¡åœ¨fcgi_accept_request()ç­‰å¾…è¯·æ±‚ï¼›
(2)è§£æè¯·æ±‚ï¼š fastcgiè¯·æ±‚åˆ°è¾¾åè¢«workeræ¥æ”¶ï¼Œç„¶åå¼€å§‹æ¥æ”¶å¹¶è§£æè¯·æ±‚æ•°æ®ï¼Œç›´åˆ°requestæ•°æ®å®Œå…¨åˆ°è¾¾ï¼›
(3)è¯·æ±‚åˆå§‹åŒ–ï¼š æ‰§è¡Œphp_request_startup()ï¼Œæ­¤é˜¶æ®µä¼šè°ƒç”¨æ¯ä¸ªæ‰©å±•çš„ï¼šPHP_RINIT_FUNCTION()ï¼›
(4)ç¼–è¯‘ã€æ‰§è¡Œï¼š ç”±php_execute_script()å®ŒæˆPHPè„šæœ¬çš„ç¼–è¯‘ã€æ‰§è¡Œï¼›
(5)å…³é—­è¯·æ±‚ï¼š è¯·æ±‚å®Œæˆåæ‰§è¡Œphp_request_shutdown()ï¼Œæ­¤é˜¶æ®µä¼šè°ƒç”¨æ¯ä¸ªæ‰©å±•çš„ï¼šPHP_RSHUTDOWN_FUNCTION()ï¼Œç„¶åè¿›å…¥æ­¥éª¤(1)ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚
int main(int argc, char *argv[])
{
â€¦
fcgi_fd = fpm_run(&amp;max_requests);
parent = 0;</p>

<p>//åˆå§‹åŒ–fastcgiè¯·æ±‚
request = fpm_init_request(fcgi_fd);</p>

<p>//workerè¿›ç¨‹å°†é˜»å¡åœ¨è¿™ï¼Œç­‰å¾…è¯·æ±‚
while (EXPECTED(fcgi_accept_request(request) &gt;= 0)) {
    SG(server_context) = (void *) request;
    init_request_info();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è¯·æ±‚å¼€å§‹
if (UNEXPECTED(php_request_startup() == FAILURE)) {
    ...
}
...

fpm_request_executing();
//ç¼–è¯‘ã€æ‰§è¡ŒPHPè„šæœ¬
php_execute_script(&amp;file_handle);
...
//è¯·æ±‚ç»“æŸ
php_request_shutdown((void *) 0);
... } ... //workerè¿›ç¨‹é€€å‡º php_module_shutdown(); ... } workerè¿›ç¨‹ä¸€æ¬¡è¯·æ±‚çš„å¤„ç†è¢«åˆ’åˆ†ä¸º5ä¸ªé˜¶æ®µï¼š
</code></pre></div></div>

<p>FPM_REQUEST_ACCEPTING: ç­‰å¾…è¯·æ±‚é˜¶æ®µ
FPM_REQUEST_READING_HEADERS: è¯»å–fastcgiè¯·æ±‚headeré˜¶æ®µ
FPM_REQUEST_INFO: è·å–è¯·æ±‚ä¿¡æ¯é˜¶æ®µï¼Œæ­¤é˜¶æ®µæ˜¯å°†è¯·æ±‚çš„methodã€query stirngã€request uriç­‰ä¿¡æ¯ä¿å­˜åˆ°å„workerè¿›ç¨‹çš„fpm_scoreboard_proc_sç»“æ„ä¸­ï¼Œæ­¤æ“ä½œéœ€è¦åŠ é”ï¼Œå› ä¸ºmasterè¿›ç¨‹ä¹Ÿä¼šæ“ä½œæ­¤ç»“æ„
FPM_REQUEST_EXECUTING: æ‰§è¡Œè¯·æ±‚é˜¶æ®µ
FPM_REQUEST_END: æ²¡æœ‰ä½¿ç”¨
FPM_REQUEST_FINISHED: è¯·æ±‚å¤„ç†å®Œæˆ
workerå¤„ç†åˆ°å„ä¸ªé˜¶æ®µæ—¶å°†ä¼šæŠŠå½“å‰é˜¶æ®µæ›´æ–°åˆ°fpm_scoreboard_proc_s-&gt;request_stageï¼Œmasterè¿›ç¨‹æ­£æ˜¯é€šè¿‡è¿™ä¸ªæ ‡è¯†åˆ¤æ–­workerè¿›ç¨‹æ˜¯å¦ç©ºé—²çš„ã€‚</p>

<p>1.3.5 è¿›ç¨‹ç®¡ç†
è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸‹masteræ˜¯å¦‚ä½•ç®¡ç†workerè¿›ç¨‹çš„ï¼Œé¦–å…ˆä»‹ç»ä¸‹ä¸‰ç§ä¸åŒçš„è¿›ç¨‹ç®¡ç†æ–¹å¼ï¼š</p>

<p>static: è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåœ¨å¯åŠ¨æ—¶masteræŒ‰ç…§pm.max_childrené…ç½®forkå‡ºç›¸åº”æ•°é‡çš„workerè¿›ç¨‹ï¼Œå³workerè¿›ç¨‹æ•°æ˜¯å›ºå®šä¸å˜çš„
dynamic: åŠ¨æ€è¿›ç¨‹ç®¡ç†ï¼Œé¦–å…ˆåœ¨fpmå¯åŠ¨æ—¶æŒ‰ç…§pm.start_serversåˆå§‹åŒ–ä¸€å®šæ•°é‡çš„workerï¼Œè¿è¡ŒæœŸé—´å¦‚æœmasterå‘ç°ç©ºé—²workeræ•°ä½äºpm.min_spare_serversé…ç½®æ•°(è¡¨ç¤ºè¯·æ±‚æ¯”è¾ƒå¤šï¼Œworkerå¤„ç†ä¸è¿‡æ¥äº†)åˆ™ä¼šfork workerè¿›ç¨‹ï¼Œä½†æ€»çš„workeræ•°ä¸èƒ½è¶…è¿‡pm.max_childrenï¼Œå¦‚æœmasterå‘ç°ç©ºé—²workeræ•°è¶…è¿‡äº†pm.max_spare_servers(è¡¨ç¤ºé—²ç€çš„workerå¤ªå¤šäº†)åˆ™ä¼šæ€æ‰ä¸€äº›workerï¼Œé¿å…å ç”¨è¿‡å¤šèµ„æºï¼Œmasteré€šè¿‡è¿™4ä¸ªå€¼æ¥æ§åˆ¶workeræ•°
ondemand: è¿™ç§æ–¹å¼ä¸€èˆ¬å¾ˆå°‘ç”¨ï¼Œåœ¨å¯åŠ¨æ—¶ä¸åˆ†é…workerè¿›ç¨‹ï¼Œç­‰åˆ°æœ‰è¯·æ±‚äº†åå†é€šçŸ¥masterè¿›ç¨‹fork workerè¿›ç¨‹ï¼Œæ€»çš„workeræ•°ä¸è¶…è¿‡pm.max_childrenï¼Œå¤„ç†å®Œæˆåworkerè¿›ç¨‹ä¸ä¼šç«‹å³é€€å‡ºï¼Œå½“ç©ºé—²æ—¶é—´è¶…è¿‡pm.process_idle_timeoutåå†é€€å‡º
å‰é¢ä»‹ç»åˆ°åœ¨fpm_run()masterè¿›ç¨‹å°†è¿›å…¥fpm_event_loop()ï¼š</p>

<p>void fpm_event_loop(int err)
{
//åˆ›å»ºä¸€ä¸ªio readçš„ç›‘å¬äº‹ä»¶ï¼Œè¿™é‡Œç›‘å¬çš„å°±æ˜¯åœ¨fpm_init()é˜¶æ®µä¸­é€šè¿‡socketpair()åˆ›å»ºç®¡é“sp[0]
//å½“sp[0]å¯è¯»æ—¶å°†å›è°ƒfpm_got_signal()
fpm_event_set(&amp;signal_fd_event, fpm_signals_get_fd(), FPM_EV_READ, &amp;fpm_got_signal, NULL);
fpm_event_add(&amp;signal_fd_event, 0);</p>

<p>//å¦‚æœåœ¨php-fpm.confé…ç½®äº†request_terminate_timeoutåˆ™å¯åŠ¨å¿ƒè·³æ£€æŸ¥
if (fpm_globals.heartbeat &gt; 0) {
    fpm_pctl_heartbeat(NULL, 0, NULL);
}
//å®šæ—¶è§¦å‘è¿›ç¨‹ç®¡ç†
fpm_pctl_perform_idle_server_maintenance_heartbeat(NULL, 0, NULL);</p>

<p>//è¿›å…¥äº‹ä»¶å¾ªç¯ï¼Œmasterè¿›ç¨‹å°†é˜»å¡åœ¨æ­¤
while (1) {
    â€¦
    //ç­‰å¾…IOäº‹ä»¶
    ret = module-&gt;wait(fpm_event_queue_fd, timeout);
    â€¦
    //æ£€æŸ¥å®šæ—¶å™¨äº‹ä»¶
    â€¦
}
}
è¿™å°±æ˜¯masteræ•´ä½“çš„å¤„ç†ï¼Œå…¶è¿›ç¨‹ç®¡ç†ä¸»è¦ä¾èµ–æ³¨å†Œçš„å‡ ä¸ªäº‹ä»¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†åˆ†æä¸‹è¿™å‡ ä¸ªäº‹ä»¶çš„åŠŸèƒ½ã€‚</p>

<p>(1)sp[1]ç®¡é“å¯è¯»äº‹ä»¶ï¼š</p>

<p>åœ¨fpm_init()é˜¶æ®µmasteræ›¾åˆ›å»ºäº†ä¸€ä¸ªå…¨åŒå·¥çš„ç®¡é“ï¼šspï¼Œç„¶ååœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªsp[0]å¯è¯»çš„äº‹ä»¶ï¼Œå½“sp[0]å¯è¯»æ—¶å°†äº¤ç”±fpm_got_signal()å¤„ç†ï¼Œå‘sp[1]å†™æ•°æ®æ—¶sp[0]æ‰ä¼šå¯è¯»ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶æœºä¼šå‘sp[1]å†™æ•°æ®å‘¢ï¼Ÿå‰é¢å·²ç»æåˆ°äº†ï¼šå½“masteræ”¶åˆ°æ³¨å†Œçš„é‚£å‡ ç§ä¿¡å·æ—¶ä¼šå†™å…¥sp[1]ç«¯ï¼Œè¿™ä¸ªæ—¶å€™å°†è§¦å‘sp[0]å¯è¯»äº‹ä»¶ã€‚</p>

<p>è¿™ä¸ªäº‹ä»¶æ˜¯masterç”¨äºå¤„ç†ä¿¡å·çš„ï¼Œæˆ‘ä»¬æ ¹æ®masteræ³¨å†Œçš„ä¿¡å·é€ä¸ªçœ‹ä¸‹ä¸åŒç”¨é€”ï¼š</p>

<p>SIGINT/SIGTERM/SIGQUIT: é€€å‡ºfpmï¼Œåœ¨masteræ”¶åˆ°é€€å‡ºä¿¡å·åå°†å‘æ‰€æœ‰çš„workerè¿›ç¨‹å‘é€é€€å‡ºä¿¡å·ï¼Œç„¶åmasteré€€å‡º
SIGUSR1: é‡æ–°åŠ è½½æ—¥å¿—æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¼šå¯¹æ—¥å¿—è¿›è¡Œåˆ‡å‰²ï¼Œåˆ‡å‰²åä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚æœfpmä¸é‡æ–°åŠ è½½å°†æ— æ³•ç»§ç»­å†™å…¥æ—¥å¿—ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å‘masterå‘é€ä¸€ä¸ªUSR1çš„ä¿¡å·
SIGUSR2: é‡å¯fpmï¼Œé¦–å…ˆmasterä¹Ÿæ˜¯ä¼šå‘æ‰€æœ‰çš„workerè¿›ç¨‹å‘é€é€€å‡ºä¿¡å·ï¼Œç„¶åmasterä¼šè°ƒç”¨execvp()é‡æ–°å¯åŠ¨fpmï¼Œæœ€åæ—§çš„masteré€€å‡º
SIGCHLD: è¿™ä¸ªä¿¡å·æ˜¯å­è¿›ç¨‹é€€å‡ºæ—¶æ“ä½œç³»ç»Ÿå‘é€ç»™çˆ¶è¿›ç¨‹çš„ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå†…æ ¸å°†å­è¿›ç¨‹ç½®ä¸ºåƒµå°¸çŠ¶æ€ï¼Œè¿™ä¸ªè¿›ç¨‹ç§°ä¸ºåƒµå°¸è¿›ç¨‹ï¼Œå®ƒåªä¿ç•™æœ€å°çš„ä¸€äº›å†…æ ¸æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿çˆ¶è¿›ç¨‹æŸ¥è¯¢å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼Œåªæœ‰å½“çˆ¶è¿›ç¨‹è°ƒç”¨waitæˆ–è€…waitpidå‡½æ•°æŸ¥è¯¢å­è¿›ç¨‹é€€å‡ºçŠ¶æ€åå­è¿›ç¨‹æ‰å‘Šç»ˆæ­¢ï¼Œfpmä¸­å½“workerè¿›ç¨‹å› ä¸ºå¼‚å¸¸åŸå› (æ¯”å¦‚coredumpäº†)é€€å‡ºè€Œémasterä¸»åŠ¨æ€æ‰æ—¶masterå°†å—åˆ°æ­¤ä¿¡å·ï¼Œè¿™ä¸ªæ—¶å€™çˆ¶è¿›ç¨‹å°†è°ƒç”¨waitpid()æŸ¥ä¸‹å­è¿›ç¨‹çš„é€€å‡ºï¼Œç„¶åæ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯éœ€è¦é‡æ–°forkæ–°çš„worker
å…·ä½“å¤„ç†é€»è¾‘åœ¨fpm_got_signal()å‡½æ•°ä¸­ï¼Œè¿™é‡Œä¸å†ç½—åˆ—ã€‚</p>

<p>(2)fpm_pctl_perform_idle_server_maintenance_heartbeat():</p>

<p>è¿™æ˜¯è¿›ç¨‹ç®¡ç†å®ç°çš„ä¸»è¦äº‹ä»¶ï¼Œmasterå¯åŠ¨äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš”1sè§¦å‘ä¸€æ¬¡ï¼Œä¸»è¦ç”¨äºdynamicã€ondemandæ¨¡å¼ä¸‹çš„workerç®¡ç†ï¼Œmasterä¼šå®šæ—¶æ£€æŸ¥å„worker poolçš„workerè¿›ç¨‹æ•°ï¼Œé€šè¿‡æ­¤å®šæ—¶å™¨å®ç°workeræ•°é‡çš„æ§åˆ¶ï¼Œå¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>

<p>static void fpm_pctl_perform_idle_server_maintenance(struct timeval now)
{
for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
struct fpm_child_s last_idle_child = NULL; //ç©ºé—²æ—¶é—´æœ€ä¹…çš„worker
int idle = 0; //ç©ºé—²workeræ•°
int active = 0; //å¿™ç¢Œworkeræ•°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (child = wp-&gt;children; child; child = child-&gt;next) {
    //æ ¹æ®workerè¿›ç¨‹çš„fpm_scoreboard_proc_s-&gt;request_stageåˆ¤æ–­
    if (fpm_request_is_idle(child)) {
        //æ‰¾ç©ºé—²æ—¶é—´æœ€ä¹…çš„worker
        ...
        idle++;
    }else{
        active++;
    }
}
...
//ondemandæ¨¡å¼
if (wp-&gt;config-&gt;pm == PM_STYLE_ONDEMAND) {
    if (!last_idle_child) continue;

    fpm_request_last_activity(last_idle_child, &amp;last);
    fpm_clock_get(&amp;now);
    if (last.tv_sec &lt; now.tv_sec - wp-&gt;config-&gt;pm_process_idle_timeout) {
        //å¦‚æœç©ºé—²æ—¶é—´æœ€é•¿çš„workerç©ºé—²æ—¶é—´è¶…è¿‡äº†process_idle_timeoutåˆ™æ€æ‰è¯¥worker
        last_idle_child-&gt;idle_kill = 1;
        fpm_pctl_kill(last_idle_child-&gt;pid, FPM_PCTL_QUIT);
    } 
    continue;
}
//dynamic
if (wp-&gt;config-&gt;pm != PM_STYLE_DYNAMIC) continue;
if (idle &gt; wp-&gt;config-&gt;pm_max_spare_servers &amp;&amp; last_idle_child) {
    //ç©ºé—²workerå¤ªå¤šäº†ï¼Œæ€æ‰
    last_idle_child-&gt;idle_kill = 1;
    fpm_pctl_kill(last_idle_child-&gt;pid, FPM_PCTL_QUIT);
    wp-&gt;idle_spawn_rate = 1;
    continue;
}
if (idle &lt; wp-&gt;config-&gt;pm_min_spare_servers) {
    //ç©ºé—²workerå¤ªå°‘äº†ï¼Œå¦‚æœæ€»workeræ•°æœªè¾¾åˆ°maxæ•°åˆ™fork
    ...
} } } (3)fpm_pctl_heartbeat():
</code></pre></div></div>

<p>è¿™ä¸ªäº‹ä»¶æ˜¯ç”¨äºé™åˆ¶workerå¤„ç†å•ä¸ªè¯·æ±‚æœ€å¤§è€—æ—¶çš„ï¼Œphp-fpm.confä¸­æœ‰ä¸€ä¸ªrequest_terminate_timeoutçš„é…ç½®é¡¹ï¼Œå¦‚æœworkerå¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ€»æ—¶é•¿è¶…è¿‡äº†è¿™ä¸ªå€¼é‚£ä¹ˆmasterå°†ä¼šå‘æ­¤workerè¿›ç¨‹å‘é€kill -TERMä¿¡å·æ€æ‰workerè¿›ç¨‹ï¼Œæ­¤é…ç½®å•ä½ä¸ºç§’ï¼Œé»˜è®¤å€¼ä¸º0è¡¨ç¤ºå…³é—­æ­¤æœºåˆ¶ï¼Œå¦å¤–fpmæ‰“å°çš„slow logä¹Ÿæ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚</p>

<p>static void fpm_pctl_check_request_timeout(struct timeval now)
{
struct fpm_worker_pool_s wp;</p>

<p>for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
    int terminate_timeout = wp-&gt;config-&gt;request_terminate_timeout;
    int slowlog_timeout = wp-&gt;config-&gt;request_slowlog_timeout;
    struct fpm_child_s *child;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (terminate_timeout || slowlog_timeout) { 
    for (child = wp-&gt;children; child; child = child-&gt;next) {
        //æ£€æŸ¥å½“å‰å½“å‰workerå¤„ç†çš„è¯·æ±‚æ˜¯å¦è¶…æ—¶
        fpm_request_check_timed_out(child, now, terminate_timeout, slowlog_timeout);
    }
} } } é™¤äº†ä¸Šé¢è¿™å‡ ä¸ªäº‹ä»¶å¤–è¿˜æœ‰ä¸€ä¸ªæ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ondemandæ¨¡å¼ä¸‹masterç›‘å¬çš„æ–°è¯·æ±‚åˆ°è¾¾çš„äº‹ä»¶ï¼Œå› ä¸ºondemandæ¨¡å¼ä¸‹fpmå¯åŠ¨æ—¶æ˜¯ä¸ä¼šé¢„åˆ›å»ºworkerçš„ï¼Œæœ‰è¯·æ±‚æ—¶æ‰ä¼šç”Ÿæˆå­è¿›ç¨‹ï¼Œæ‰€ä»¥è¯·æ±‚åˆ°è¾¾æ—¶éœ€è¦é€šçŸ¥masterè¿›ç¨‹ï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯åœ¨fpm_children_create_initial()æ—¶æ³¨å†Œçš„ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°ä¸ºfpm_pctl_on_socket_accept()
</code></pre></div></div>
:ET