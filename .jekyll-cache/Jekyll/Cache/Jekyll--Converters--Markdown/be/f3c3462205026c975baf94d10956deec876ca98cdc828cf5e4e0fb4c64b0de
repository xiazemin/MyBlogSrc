I"¤<p>https://github.com/golang-migrate/migrate</p>

<p>https://github.com/golang-migrate/migrate/tree/master/database/mysql</p>

<p>https://github.com/rubenv/sql-migrate
<!-- more -->
https://www.ctolib.com/sql-migrate.html
sql-migrate æ˜¯ä¸€ä¸ª Go è¯­è¨€çš„æ•°æ®åº“ Schema ç§»æ¤å·¥å…·ã€‚</p>

<p>ç‰¹æ€§ï¼š</p>

<p>å¯ä½œä¸º CLI å‘½ä»¤è¡Œå·¥å…·æˆ–è€…å¼€å‘åº“ä½¿ç”¨</p>

<p>æ”¯æŒ SQLite, PostgreSQL, MySQL, MSSQL å’Œ Oracle æ•°æ®åº“ (ä½¿ç”¨ gorp)</p>

<p>å¯åµŒå…¥åˆ°åº”ç”¨ç¨‹åº</p>

<p>ä½¿ç”¨ SQL å®šä¹‰ç§»æ¤è¿‡ç¨‹</p>

<p>åŸå­è¿ç§»</p>

<p>å¯å¯¹ç§»æ¤è¿‡ç¨‹è¿›è¡Œæ’¤å›</p>

<p>åœ¨ä¸€ä¸ªé¡¹ç›®ä¸­æ”¯æŒå¤šç§æ•°æ®åº“ç±»å‹</p>

<p>å®‰è£… go-bindata 
go get -u github.com/jteeuwen/go-bindata/â€¦
This package converts any file into managable Go source code. Useful for embedding binary data into a go program. The file data is optionally gzip compressed before being converted to a raw byte slice.</p>

<p>è¿™é‡Œæˆ‘å€ŸåŠ©go-bindata æŠŠæˆ‘å†™å¥½çš„sqlæ–‡ä»¶ï¼Œç”Ÿæˆgoæºç ï¼ŒåŠ å…¥åˆ°å·¥ç¨‹ä¸­</p>

<p>å®‰è£… sql-migrate</p>

<p>go get -v github.com/rubenv/sql-migrate/â€¦</p>

<p>sql-migrate
SQL Schema migration tool for Go. Based on gorp and goose.</p>

<p>è¿™é‡Œæˆ‘å€ŸåŠ©å®ƒ åœ¨æ•°æ®åº“ä¸­ åˆå§‹åŒ–ä¸€äº›æˆ‘éœ€è¦çš„è¡¨æ ¼ ç´¢å¼•ç­‰</p>

<p>åˆ›å»º postgres ç”¨æˆ·åŠ æ•°æ®åº“</p>

<p>postgres=# CREATE USER dbuser WITH PASSWORD â€˜123456â€™;
CREATE ROLE
postgres=# CREATE DATABASE exampledb OWNER dbuser;
CREATE DATABASE
postgres=# GRANT ALL PRIVILEGES ON DATABASE exampledb TO dbuser;
GRANT</p>

<p>æ–°å»º migrations ç›®å½•ï¼Œæ–°å»ºä¸€ä¸ªsqlæ–‡ä»¶</p>

<p>~/go/gopath/src/wjs/learnSqlMigrations $ ls
main.go  migrations
~/go/gopath/src/wjs/learnSqlMigrations/migrations $ ls
1_init.sql</p>

<p>sql å†…å®¹ï¼Œåˆ›å»ºstudent å’Œ people è¡¨æ ¼ï¼Œ</p>

<p>~/go/gopath/src/wjs/learnSqlMigrations/migrations $ cat 1_init.sql 
â€“ +migrate Up
create table student (
	id text primary key,
	name varchar(100) unique not null,
	description text not null
);</p>

<p>CREATE TABLE people (id int);</p>

<p>â€“ +migrate Down
drop table student;
drop table people;</p>

<p>æ–°å»º main.go æ–‡ä»¶</p>

<p>//go:generate go-bindata -prefix migrations -pkg bdata -o bdata/migrations_gen.go migrations
package main</p>

<p>import (
	â€œfmtâ€
	â€œtimeâ€
	â€œwjs/learnSqlMigrations/bdataâ€
	â€œgithub.com/pkg/errorsâ€
	migrate â€œgithub.com/rubenv/sql-migrateâ€
	log â€œgithub.com/sirupsen/logrusâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"github.com/jmoiron/sqlx"
_ "github.com/lib/pq" )
</code></pre></div></div>

<p>var g_db *sqlx.DB</p>

<p>// OpenDatabase opens the database and performs a ping to make sure the
// database is up.
func OpenDatabase(dsn string) (*sqlx.DB, error) {
	db, err := sqlx.Open(â€œpostgresâ€, dsn)
	if err != nil {
		return nil, fmt.Errorf(â€œdatabase connection error: %sâ€, err)
	}
	for {
		if err := db.Ping(); err != nil {
			log.Errorf(â€œping database error, will retry in 2s: %sâ€, err)
			time.Sleep(2 * time.Second)
		} else {
			break
		}
	}
	return db, nil
}</p>

<p>func setPostgreSQLConnection() error {
	log.Info(â€œconnecting to postgresqlâ€)
	db, err := OpenDatabase(â€œpostgres://dbuser:123456@localhost/exampledb?sslmode=disableâ€)
	if err != nil {
		return errors.Wrap(err, â€œdatabase connection errorâ€)
	}
	g_db = db
	return nil
}</p>

<p>func runDatabaseMigrations() error {
	log.Info(â€œapplying database migrationsâ€)
	m := &amp;migrate.AssetMigrationSource{
		Asset:    bdata.Asset,
		AssetDir: bdata.AssetDir,
		Dir:      â€œâ€,
	}
	n, err := migrate.Exec(g_db.DB, â€œpostgresâ€, m, migrate.Up)
	if err != nil {
		return errors.Wrap(err, â€œapplying migrations failedâ€)
	}
	log.WithField(â€œcountâ€, n).Info(â€œmigrations appliedâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return nil }
</code></pre></div></div>

<p>func main() {
	setPostgreSQLConnection()
	err := runDatabaseMigrations()
	if err != nil {
		log.Error(err)
	}
}
è¿è¡Œ go generate</p>

<p>å°±ä¼šç”Ÿæˆ migrations_gen.go æ–‡ä»¶ï¼Œé‡Œé¢ä¿å­˜äº† 1_init.sql æ–‡ä»¶çš„å†…å®¹</p>

<p>æˆ‘ä»¬æ¥çœ‹  main.go ç¬¬ä¸€è¡Œ</p>

<p>//go:generate go-bindata -prefix migrations -pkg bdata -o bdata/migrations_gen.go migrations</p>

<p>-pkg æŒ‡å®šäº†ç”Ÿæˆçš„bindataæ–‡ä»¶åŒ…åæ˜¯ bdata</p>

<p>-o bdata/migrations_gen.go æŒ‡å®šäº†ç”Ÿæˆbindataæ–‡ä»¶çš„ä½ç½®</p>

<p>-prefix migrations  å¦‚æœå¾…è½¬æ¢æ–‡ä»¶è·¯å¾„å‰ç¼€æœ‰ migrations åˆ™ï¼Œå»æ‰è¿™ä¸ªå‰ç¼€, å‚è€ƒç”Ÿæˆçš„migrations_gen.goæºç </p>

<p>è¿è¡Œ go run main.go</p>

<p>exampledb=&gt; \d
 public | gorp_migrations | table | dbuser
 public | people          | table | dbuser</p>

<p>https://blog.csdn.net/wangjunsheng/article/details/80901895</p>

:ET