I"Ä+<p>Nginx åœ¨ 1.13.10 ä¸­ï¼Œæ–°å¢äº†å¯¹gRPCçš„åŸç”Ÿæ”¯æŒï¼ŒNginx 1.14.0 ä¸»çº¿ç‰ˆå·²ç»å‘å¸ƒ</p>

<p>Nginx ä¸­çš„ gRPC æœåŠ¡ã€‚gRPC æœåŠ¡åšä¸ºä¸€ä¸ª TCP æœåŠ¡ï¼Œé…ç½®æ–¹å¼ä¸ HTTP/HTPTS ç±»ä¼¼ã€‚</p>

<p>Nginxç‰ˆæœ¬è¦æ±‚ï¼š1.13.10+ã€‚gRPCå¿…é¡»ä½¿ç”¨ HTTP/2 ä¼ è¾“æ•°æ®ï¼Œæ”¯æŒæ˜æ–‡å’ŒTLSåŠ å¯†æ•°æ®ï¼Œæ”¯æŒæµæ•°æ®çš„äº¤äº’ã€‚è¿™æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨ HTTP/2 è¿æ¥çš„å¤šè·¯å¤ç”¨å’Œæµå¼ç‰¹æ€§ã€‚æ‰€ä»¥åœ¨å®‰è£…éƒ¨ç½²nginxæ—¶éœ€è¦å®‰è£…http/2ã€‚ä½¿ç”¨æºç å®‰è£…ï¼Œç¼–è¯‘æ—¶éœ€è¦åŠ å…¥http_sslå’Œhttp_v2æ¨¡å—ï¼š</p>

<p>$ auto/configure â€“with-http_ssl_module â€“with-http_v2_module
<!-- more -->
ä»¥æ˜æ–‡çš„æ–¹å¼å‘å¸ƒgRPCæœåŠ¡ã€‚
nginxæ˜¯ä½¿ç”¨httpæœåŠ¡å™¨ç›‘å¬gRPCçš„è¯·æ±‚ã€‚</p>

<p>http {
  server {
    listen 80 http2;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>access_log logs/access.log main;

location / {
  # The 'grpc://' prefix is optional; unencrypted gRPC is the default   
  grpc_pass grpc://localhost:50051;
}   } }
</code></pre></div></div>

<p>æŒ‡ä»¤grpc_passç”¨æ¥æŒ‡å®šä»£ç†çš„gRPCæœåŠ¡å™¨åœ°å€ï¼Œå‰ç¼€åè®®æœ‰ä¸¤ç§ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     (adsbygoogle = window.adsbygoogle || []).push({}); 
</code></pre></div></div>

<p>grpc://ï¼šä¸gRPCæœåŠ¡å™¨ç«¯äº¤äº’æ˜¯ä»¥æ˜æ–‡çš„æ–¹å¼
grpcs://ï¼šä¸gRPCæœåŠ¡å™¨ç«¯äº¤äº’å¼ä»¥TLSåŠ å¯†æ–¹å¼
gRPCæœåŠ¡å™¨åœ°å€çš„å‰ç¼€â€œgrpc://â€æ˜¯å¯ä»¥å¿½ç•¥ï¼Œé»˜è®¤å°±æ˜¯æ˜æ–‡äº¤äº’æ–¹å¼ã€‚</p>

<p>æ­¤ç¤ºä¾‹é‡Œnginxä»¥æ˜æ–‡çš„æ–¹å¼åœ¨80ç«¯å£å‘å¸ƒgRPCï¼Œå…¶ä¸­ä»£ç†çš„gRPCåœ¨åç«¯ä¹Ÿæ˜¯ä»¥æ˜æ–‡çš„æ–¹å¼äº¤äº’ã€‚</p>

<p>æ³¨æ„ï¼šNginxæ˜¯ä¸æ”¯æŒåœ¨æ˜æ–‡çš„ç«¯å£ä¸ŠåŒæ—¶æ”¯æŒhttp1å’Œhttp2çš„ï¼ˆæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿï¼‰ã€‚å¦‚æœè¦æ”¯æŒè¿™ä¸¤ç§çš„httpåè®®ï¼Œéœ€è¦è®¾ç½®ä¸ºä¸åŒçš„ç«¯å£ã€‚</p>

<p>server {
  listen 1443 ssl http2;</p>

<p>ssl_certificate ssl/cert.pem;
  ssl_certificate_key ssl/key.pem;</p>

<p>location / {
      grpc_pass grpc://localhost:50051;
  }
}</p>

<p>ä»£ç†åŠ å¯†çš„gRPC
å¦‚æœNginxå†…éƒ¨ä»£ç†çš„gRPCä¹Ÿéœ€è¦ä»¥åŠ å¯†çš„æ–¹å¼äº¤äº’ï¼Œè¿™ç§æƒ…å†µå°±éœ€è¦æŠŠæ˜æ–‡ä»£ç†åè®®grpc://æ›¿æ¢ä¸ºgrpcs://ã€‚è¿™é¦–å…ˆè¦gRPCæœåŠ¡å™¨æ˜¯ä»¥åŠ å¯†çš„æ–¹å¼å‘å¸ƒæœåŠ¡çš„ã€‚Nginxå±‚ä¿®æ”¹å¦‚ä¸‹ï¼š</p>

<p>grpc_pass grpcs://localhost:50051;</p>

<p>nginxè·¯ç”±gRPCè¯·æ±‚
å¦‚æœåç«¯æœ‰å¤šä¸ªgRPCæœåŠ¡ç«¯ï¼Œå…¶ä¸­æ¯ä¸ªæœåŠ¡ç«¯éƒ½æ˜¯æä¾›ä¸åŒçš„gRPCæœåŠ¡ã€‚è¿™ç§æƒ…å†µå¯ä»¥ä½¿ç”¨ä¸€ä¸ªnginxæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œç„¶åæ ¹æ®ä¸åŒçš„è·¯å¾„åˆ†å‘è·¯ç”±åˆ°æŒ‡å®šçš„gRPCæœåŠ¡å™¨ã€‚ä½¿ç”¨locationåŒºåˆ†ï¼š</p>

<p>location /helloworld.Greeter {
  grpc_pass grpc://192.168.20.11:50051;
}</p>

<p>location /helloworld.Dispatcher {
  grpc_pass grpc://192.168.20.21:50052;
}</p>

<p>location / {
  root html;
  index index.html index.htm;
}</p>

<p>å¯¹gRPCè¯·æ±‚åšè´Ÿè½½å‡è¡¡
åœ¨åç«¯æœ‰å¤šä¸ªgRPCæœåŠ¡å™¨ï¼Œå®ƒä»¬éƒ½æ˜¯åŒä¸€ä¸ªgRPCæœåŠ¡ï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç»“åˆnginxçš„upstreamå¯ä»¥å¯¹gRPCçš„è¯·æ±‚åšè´Ÿè½½å‡è¡¡ã€‚</p>

<p>upstream grpcservers {
  server 192.168.20.21:50051;
  server 192.168.20.22:50052;
}</p>

<p>server {
  listen 1443 ssl http2;</p>

<p>ssl_certificate   ssl/certificate.pem;
  ssl_certificate_key ssl/key.pem;</p>

<p>location /helloworld.Greeter {
    grpc_pass grpc://grpcservers;
    error_page 502 = /error502grpc;
  }</p>

<p>location = /error502grpc {
    internal;
    default_type application/grpc;
    add_header grpc-status 14;
    add_header grpc-message â€œunavailableâ€;
    return 204;
  }
}
å…¶ä¸­upstreamæŒ‡å®šå®šä¹‰äº†ç»Ÿä¸€gRPCæœåŠ¡çš„æœåŠ¡å™¨ç»„ã€‚åœ¨grpc_passæŒ‡å®šçš„gRPCæœåŠ¡å™¨åœ°å€ä½¿ç”¨upstreamå®šä¹‰çš„æœåŠ¡å™¨ç»„ã€‚</p>

<p>https://cloud.tencent.com/developer/article/1375974</p>

<p>æŸ¥çœ‹nginx erroré”™è¯¯ï¼Œå‘ç°ä¸Šä¼ æ¥å£æŠ¥ä»¥ä¸‹é”™ï¼š</p>

<p>2019/10/10 19:58:25 [error] 299784#0: *5967188 readv() failed (104: Connection reset by peer) while reading upstream, client: 59.34.155.7, server: xxxxxxxx, request: â€œPOST /stream/tracking/file HTTP/1.1â€, upstream: â€œhttp://xxxxxxxx/stream/tracking/fileâ€, host: â€œxxxxxxxxâ€</p>

<p>è¿™ç§é”™è¯¯æ—¥å¿—ä¸å¤šï¼Œç¬¬ä¸€æ„Ÿè§‰å°±æ˜¯ä¸Šä¼ æ–‡ä»¶è¿‡å¤§ï¼Œä¼ è¾“æ—¶é—´è¿‡é•¿ï¼Œç„¶åè¿æ¥è¢«ä¸­æ–­ã€‚</p>

<p>å½“ä½¿ç”¨nginxä½œä¸ºåå‘ä»£ç†æ—¶ï¼Œä¸ºäº†æ”¯æŒé•¿è¿æ¥ï¼Œéœ€è¦åšåˆ°ä¸¤ç‚¹ï¼š</p>

<p>ä»clientåˆ°nginxçš„è¿æ¥æ˜¯é•¿è¿æ¥ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œnginxé•¿è¿æ¥æ˜¯é»˜è®¤å¼€å¯çš„ã€‚
ä»nginxåˆ°serverçš„è¿æ¥æ˜¯é•¿è¿æ¥ï¼Œéœ€è¦è‡ªå·±å¼€å¯</p>

<p>upstream bigdata {<br />
    server 10.0.20.xx:18018;<br />
    server 10.0.20.xx:18018;<br />
    server 10.0.20.xx:18018;<br />
    server 10.0.20.xx:18018;<br />
    keepalive 100;   //æ ¹æ®qpsæ¥è°ƒæ•´<br />
}</p>

<p>location ~ / {<br />
ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚çœç•¥ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚<br />
    proxy_connect_timeout      120;   //åŠ å¤§120<br />
    proxy_send_timeout         120;   //åŠ å¤§120<br />
    proxy_read_timeout         120;   //åŠ å¤§120<br />
    proxy_http_version 1.1;    //å¼€å¯åç«¯ï¼Œé•¿è¿æ¥<br />
    proxy_set_header Connection â€œâ€;  //å¼€å¯åç«¯ï¼Œé•¿è¿æ¥<br />
}<br />
æ³¨æ„ï¼škeepaliveæŒ‡å®šçš„æ•°å€¼æ˜¯Nginxæ¯ä¸ªworkerè¿æ¥åç«¯çš„æœ€å¤§é•¿è¿æ¥æ•°ï¼Œè€Œä¸æ˜¯æ•´ä¸ªNginxçš„.</p>

<p>http://blog.51yip.com/apachenginx/2203.html</p>

<p>Nginx proxy_http_versioné»˜è®¤å€¼å¼•å‘çš„é—®é¢˜
2021/06/01 15:24:27 [error] 3986#0: *990083 upstream sent invalid chunked response while reading upstream, client: xxx.xxx.xx.x, server: xxx.xxx.xx, request: â€œGET /api/server/download?fileKey=990aa1bc5e HTTP/1.1â€, upstream: â€œhttp://xx.xxx.xxx.x:8080/api/server/download?fileKey=990aa1bc5eâ€, host: â€œxxxx.xxx.xxâ€</p>

<p>æŠ“å–ä»¥ä¸‹å…³é”®é”™è¯¯ä¿¡æ¯ï¼š
upstream sent invalid chunked response while reading upstream
HTTP/1.1</p>

<p>é€šè¿‡ç½‘ä¸ŠæŸ¥æ‰¾å‘ç°é—®é¢˜ï¼Œnginxåœ¨ä»£ç†æ˜¯é»˜è®¤httpç‰ˆæœ¬ä¸º1.0ï¼Œç”±äºæ–‡ä»¶çš„ä¸‹è½½æ¶‰åŠåˆ°ä½¿ç”¨åˆ†å—ä¼ é€’ï¼Œä½†http1.0æ˜¯ä¸æ”¯æŒè¿™ä¸ªç‰¹æ€§çš„ã€‚æ‰€ä»¥æœåŠ¡ç«¯ä¸º1.1ç‰ˆæœ¬æ— æ³•è¿›è¡Œè½¬å‘</p>

<p>è§£å†³æ–¹æ¡ˆï¼š
åªè¦åœ¨nginxé…ç½®çš„locationæ¨¡å—é‡Œé¢åŠ ä¸Šproxy_http_version 1.1å°±å¯ä»¥äº†
https://blog.csdn.net/qq_38531706/article/details/117448200</p>

<p>https://chromium.googlesource.com/external/github.com/grpc/grpc/+/refs/heads/chromium-deps/2016-06-09/doc/PROTOCOL-HTTP2.md</p>

<p>NGINXæœåŠ¡å™¨çš„åå‘ä»£ç†PROXY_PASSé…ç½®æ–¹æ³•è®²è§£
Nginxçš„é…ç½®è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå¦‚ï¼š
location ~ /* 
{
proxy_pass http://127.0.0.1:8008;
}</p>

<p>https://www.cnblogs.com/lianxuan1768/p/8383804.html</p>

<p>nginxåå‘ä»£ç†http2
ç¼–è¯‘æ—¶æ·»åŠ http2ï¼Œé…ç½®åŠ å…¥proxy_http_version 2;
å½“å‰ç«¯è¯·æ±‚éå¸¸å¤§ï¼Œnginxåˆ°åç«¯æœåŠ¡çš„tcpæ²¡æœ‰å¤„ç†å®Œè€Œå ç”¨çš„æ—¶å€™ï¼Œå°±ä¼šå ç”¨ä¸€ä¸ªç«¯å£ã€‚ä¸€å°æœåŠ¡å™¨65535ä¸ªç«¯å£ï¼Œé™¤æ‰ç³»ç»Ÿå ç”¨çš„ã€‚é‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´nginxå’Œåç«¯æœåŠ¡æœ€å¤§å¹¶å‘æ˜¯6W+ä¸ªè¯·æ±‚ã€‚</p>

<p>ä½¿ç”¨http2åˆå¹¶ï¼ˆæ”¶æ•›ï¼‰tcpè¯·æ±‚åœ¨ä¸€å®šåœºæ™¯ä¸‹æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>

<p>https://www.zhihu.com/question/268666424/answer/347026835
http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_http_version</p>

<p>https://www.cnblogs.com/willpower-chen/p/5567223.html</p>

<p>Nginx è´Ÿè½½å‡è¡¡è¯¦è§£
åœ¨æ–‡ç« Nginx é…ç½®è¯¦è§£ä¸­æˆ‘è¯´å•¦nginxæœ‰å“ªäº›ä¸­è´Ÿè½½å‡è¡¡ç®—æ³•ã€‚è¿™ä¸€ç»“æˆ‘å°±ç»™å¦‚ä½•æ“ä½œé…ç½®çš„ç»™å¤§å®¶åšè¯¦ç»†è¯´æ˜ä¸‹ã€‚</p>

<p>é¦–å…ˆç»™å¤§å®¶è¯´ä¸‹upstreamè¿™ä¸ªé…ç½®çš„ï¼Œè¿™ä¸ªé…ç½®æ˜¯å†™ä¸€ç»„è¢«ä»£ç†çš„æœåŠ¡å™¨åœ°å€ï¼Œç„¶åé…ç½®è´Ÿè½½å‡è¡¡çš„ç®—æ³•ã€‚è¿™é‡Œçš„è¢«ä»£ç†æœåŠ¡å™¨åœ°å€æœ‰ä¸¤ç§å†™æ³•ã€‚</p>

<p>upstream mysvr { 
    server 192.168.10.121:3333;
    server 192.168.10.122:3333;
}
server {
    â€¦.
    location  ~*^.+$ {       <br />
        proxy_pass  http://mysvr;  #è¯·æ±‚è½¬å‘mysvr å®šä¹‰çš„æœåŠ¡å™¨åˆ—è¡¨       <br />
    }
}</p>

<p>ç„¶åï¼Œå°±æ¥ç‚¹å®æˆ˜çš„ä¸œè¥¿ã€‚</p>

<p>1ã€çƒ­å¤‡ï¼šå¦‚æœä½ æœ‰2å°æœåŠ¡å™¨ï¼Œå½“ä¸€å°æœåŠ¡å™¨å‘ç”Ÿäº‹æ•…æ—¶ï¼Œæ‰å¯ç”¨ç¬¬äºŒå°æœåŠ¡å™¨ç»™æä¾›æœåŠ¡ã€‚æœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„é¡ºåºï¼šAAAAAAçªç„¶AæŒ‚å•¦ï¼ŒBBBBBBBBBBBBBBâ€¦..</p>

<p>upstream mysvr { 
    server 127.0.0.1:7878; 
    server 192.168.10.121:3333 backup;  #çƒ­å¤‡   <br />
}
2ã€è½®è¯¢ï¼šnginxé»˜è®¤å°±æ˜¯è½®è¯¢å…¶æƒé‡éƒ½é»˜è®¤ä¸º1ï¼ŒæœåŠ¡å™¨å¤„ç†è¯·æ±‚çš„é¡ºåºï¼šABABABABABâ€¦.</p>

<p>upstream mysvr { 
    server 127.0.0.1:7878;
    server 192.168.10.121:3333;     <br />
}
3ã€åŠ æƒè½®è¯¢ï¼šè·Ÿæ®é…ç½®çš„æƒé‡çš„å¤§å°è€Œåˆ†å‘ç»™ä¸åŒæœåŠ¡å™¨ä¸åŒæ•°é‡çš„è¯·æ±‚ã€‚å¦‚æœä¸è®¾ç½®ï¼Œåˆ™é»˜è®¤ä¸º1ã€‚ä¸‹é¢æœåŠ¡å™¨çš„è¯·æ±‚é¡ºåºä¸ºï¼šABBABBABBABBABBâ€¦.</p>

<p>upstream mysvr { 
    server 127.0.0.1:7878 weight=1;
    server 192.168.10.121:3333 weight=2;
}
4ã€ip_hash:nginxä¼šè®©ç›¸åŒçš„å®¢æˆ·ç«¯ipè¯·æ±‚ç›¸åŒçš„æœåŠ¡å™¨ã€‚</p>

<p>upstream mysvr { 
    server 127.0.0.1:7878; 
    server 192.168.10.121:3333;
    ip_hash;
}</p>

<p>å…³äºnginxè´Ÿè½½å‡è¡¡é…ç½®çš„å‡ ä¸ªçŠ¶æ€å‚æ•°è®²è§£ã€‚</p>

<p>downï¼Œè¡¨ç¤ºå½“å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½å‡è¡¡ã€‚</p>

<p>backupï¼Œé¢„ç•™çš„å¤‡ä»½æœºå™¨ã€‚å½“å…¶ä»–æ‰€æœ‰çš„ébackupæœºå™¨å‡ºç°æ•…éšœæˆ–è€…å¿™çš„æ—¶å€™ï¼Œæ‰ä¼šè¯·æ±‚backupæœºå™¨ï¼Œå› æ­¤è¿™å°æœºå™¨çš„å‹åŠ›æœ€è½»ã€‚</p>

<p>max_failsï¼Œå…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œé»˜è®¤ä¸º1ã€‚å½“è¶…è¿‡æœ€å¤§æ¬¡æ•°æ—¶ï¼Œè¿”å›proxy_next_upstream æ¨¡å—å®šä¹‰çš„é”™è¯¯ã€‚</p>

<p>fail_timeoutï¼Œåœ¨ç»å†äº†max_failsæ¬¡å¤±è´¥åï¼Œæš‚åœæœåŠ¡çš„æ—¶é—´ã€‚max_failså¯ä»¥å’Œfail_timeoutä¸€èµ·ä½¿ç”¨ã€‚</p>

<p>upstream mysvr { 
    server 127.0.0.1:7878 weight=2 max_fails=2 fail_timeout=2;
    server 192.168.10.121:3333 weight=1 max_fails=2 fail_timeout=1;  <br />
}</p>

<p>https://www.runoob.com/w3cnote/nginx-proxy-balancing.html</p>

<p>server {
        listen       443 ssl http2;
        server_name  localhost;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ssl_certificate     server.crt;
    ssl_certificate_key  server.key;Â  Â  Â  Â  location / {Â  Â  Â  Â  Â  Â  #add_header 'Access-Control-Allow-Origin' '*';Â  Â  Â  Â  Â  Â  add_header 'Access-Control-Allow-Headers' 'X-Requested-With';Â  Â  Â  Â  Â  Â  add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS';Â  Â  Â  Â  Â  Â  proxy_pass   http://127.0.0.1:80;Â  Â  Â  Â }    }
</code></pre></div></div>

<p>https://www.cnblogs.com/bugutian/p/6628455.html</p>

<p>çœ‹æ˜¯å¦å®‰è£…äº†with-http_v2_moduleï¼Œè¿™é‡Œçœ‹åˆ°æ²¡æœ‰å®‰è£…è¦å®‰è£…</p>

<p>http_ssl_moduleçœ‹åˆ°å·²ç»å®‰è£…äº†ï¼Œè‹¥æ²¡æœ‰å®‰è£…ä¹Ÿè¦å®‰è£…ä¸‹</p>

<p>https://blog.csdn.net/lzxlfly/article/details/90119543</p>

<p>goè¯·æ±‚Nginxçš„Grpcåå‘ä»£ç†åï¼Œå‡ºç° code = Unavailable desc = the connection is draining</p>

<p>The ConfigMap already supports http2-max-field-size and http2-max-header-size, so it should be relatively trivial to add support for http2-max-requests.</p>

<p>https://www.cnblogs.com/gao88/p/12006634.html</p>

<p>â€˜there is no connection availableâ€™ and â€˜the connection is drainingâ€™ when using nginx #2205</p>

<p>https://github.com/grpc/grpc-go/issues/2205</p>

<p>http://nginx.org/en/docs/http/ngx_http_v2_module.html#http2_max_requests</p>

<p>https://zhuanlan.zhihu.com/p/380121731</p>

<p>TIME_WAITå’ŒCLOSE_WAITçŠ¶æ€åŒºåˆ«
https://www.cnblogs.com/gao88/category/988969.html</p>
:ET