I"Ş*<p>https://github.com/emicklei/go-restful
kubernetesæºç çš„æ—¶å€™å‘ç°å†…éƒ¨ä½¿ç”¨çš„æ˜¯ go-restfulå®ç°çš„</p>

<p>REST
RESTè¦æ±‚å¼€å‘è€…æ˜¾å¼åœ°ä½¿ç”¨HTTPæ–¹æ³•ï¼Œå¹¶ä¸HTTPåè®®çš„å®šä¹‰ä¿æŒä¸€è‡´ã€‚RESTçš„åŸºæœ¬è®¾è®¡åŸåˆ™æ˜¯å†åˆ›å»ºã€è¯»å–ã€æ›´æ–°å’Œåˆ é™¤ï¼ˆCRUDï¼‰æ“ä½œå’ŒHTTPæ–¹æ³•ä¹‹é—´å»ºç«‹èµ·ä¸€å¯¹ä¸€çš„æ˜ å°„ã€‚æ ¹æ®è¯¥æ˜ å°„ï¼š</p>

<p>GET = æ£€ç´¢èµ„æºçš„è¡¨ç¤º
POST = åˆ›å»ºï¼Œä½¿ç”¨æŸç§æœåŠ¡å™¨ç«¯çš„ç®—æ³•å°†å†…å®¹å‘é€åˆ°æœåŠ¡å™¨ä»¥åˆ›å»ºæŒ‡å®šèµ„æºæˆ–èµ„æºçš„é›†åˆ
PUT = åˆ›å»ºï¼Œå¦‚æœå‘é€æŒ‡å®šURIçš„å®Œæ•´å†…å®¹
PUT = æ›´æ–°ï¼Œå¦‚æœè¦æ›´æ–°æŒ‡å®šURIçš„å®Œæ•´å†…å®¹
DELETE = åˆ é™¤ï¼Œå¦‚æœè¦è¯·æ±‚æœåŠ¡å™¨åˆ é™¤æŒ‡å®šçš„èµ„æº
PATCH = æ›´æ–°ï¼Œæ›´æ–°æŸä¸ªèµ„æºçš„éƒ¨åˆ†å†…å®¹
OPTIONS = è·å–è¯·æ±‚URIç›¸å…³çš„é€šä¿¡é€‰é¡¹çš„ä¿¡æ¯
go-restfulåº“çš„ç‰¹å¾
è·¯ç”±è¯·æ±‚ï¼šæ”¯æŒå‡½æ•°æ˜ å°„åˆ°è·¯å¾„å‚æ•°ï¼ˆä¾‹å¦‚{id}ï¼‰
è·¯ç”±å¯é…ç½®
ï¼ˆé»˜è®¤ï¼‰å¿«é€Ÿè·¯ç”±ç®—æ³•ï¼Œå…è®¸URLè·¯å¾„ä¸Šå‡ºç°é™æ€å…ƒç´ ã€æ­£åˆ™è¡¨è¾¾å¼ã€åŠ¨æ€å‚æ•°ã€‚æ¯”å¦‚ /meetings/{id} æˆ–è€… /static/{subpath:*}
JSR311è§„èŒƒå®ç°çš„è·¯ç”±ç®—æ³•
æä¾›äº†Request APIç”¨äºä»JSON/XMLè¯»å–ç»“æ„å’Œè®¿é—®å„ç§å‚æ•°ï¼ˆè·¯å¾„å‚æ•°ã€æŸ¥è¯¢å‚æ•°ã€å¤´éƒ¨å‚æ•°ï¼‰
æä¾›äº†Response APIç”¨äºå°†ç»“æ„ï¼ˆstructï¼‰å†™å…¥åˆ°JSON/XMLä»¥åŠè®¾ç½®å¤´éƒ¨
æ”¯æŒä½¿ç”¨EntityReaderWriteræ³¨å†Œçš„è‡ªå®šä¹‰ç¼–ç 
æ”¯æŒåœ¨æœåŠ¡çº§æˆ–è·¯ç”±çº§å¯¹è¯·æ±‚åˆ°å“åº”æµçš„è¿‡æ»¤å’Œæ‹¦æˆª
æ”¯æŒä½¿ç”¨å±æ€§æ¥å®šä¹‰è¯·æ±‚èŒƒå›´çš„å˜é‡
å®¹å™¨Containeræ”¯æŒä¸åŒHTTPç«¯ç‚¹ä¸Šçš„WebService
è¯·æ±‚å’Œå“åº”çš„æœ‰æ•ˆè´Ÿè½½ä¸Šçš„å†…å®¹ç¼–ç (gzip,deflate)
ï¼ˆä½¿ç”¨è¿‡æ»¤å™¨ï¼‰è‡ªåŠ¨å“åº”OPTIONSè¯·æ±‚
ï¼ˆä½¿ç”¨è¿‡æ»¤å™¨ï¼‰è‡ªåŠ¨å¤„ç†CORSè¯·æ±‚
æ”¯æŒSwagger UIç¼–å†™çš„APIæ–‡æ¡£å£°æ˜ï¼ˆé˜…è¯»go-restful-openapiå’Œgo-restful-swagger12ï¼‰
é’ˆå¯¹HTTP 500çŠ¶æ€ç çš„ææ…Œæ¢å¤ï¼Œä½¿ç”¨RecoverHandler(â€¦)è‡ªå®šä¹‰å¤„ç†
è·¯ç”±é”™è¯¯äº§ç”ŸHTTP 404/405/406/415ç­‰é”™è¯¯ï¼Œä½¿ç”¨ServiceErrorHandler(â€¦)è‡ªå®šä¹‰å¤„ç†
å¯é…ç½®çš„æ—¥å¿—è·Ÿè¸ª
ä½¿ç”¨CompressorProvideræ³¨å†Œè‡ªå®šä¹‰gzip/deflateçš„è¯»å…¥å™¨å’Œè¾“å‡ºå™¨
<!-- more -->
package main</p>

<p>import (
    â€œgithub.com/emicklei/go-restfulâ€
    â€œgithub.com/emicklei/go-restful-swagger12â€
    â€œioâ€
    â€œlogâ€
    â€œnet/httpâ€
)</p>

<p>func main(){
    wsContainer := restful.NewContainer()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è·¨åŸŸè¿‡æ»¤å™¨
cors := restful.CrossOriginResourceSharing{
    ExposeHeaders:  []string{"X-My-Header"},
    AllowedHeaders: []string{"Content-Type", "Accept"},
    AllowedMethods: []string{"GET", "POST"},
    CookiesAllowed: false,
    Container:      wsContainer}
wsContainer.Filter(cors.Filter)

// Add container filter to respond to OPTIONS
wsContainer.Filter(wsContainer.OPTIONSFilter)



config := swagger.Config{
    WebServices:    restful.DefaultContainer.RegisteredWebServices(), // you control what services are visible
    WebServicesUrl: "http://localhost:8080",
    ApiPath:        "/apidocs.json",
    ApiVersion:     "V1.0",
    // Optionally, specify where the UI is located
    SwaggerPath:     "/apidocs/",
    SwaggerFilePath: "D:/gowork/src/doublegao/experiment/restful/dist"}
swagger.RegisterSwaggerService(config, wsContainer)
//swagger.InstallSwaggerService(config)


u := UserResource{}
u.RegisterTo(wsContainer)

log.Print("start listening on localhost:8080")
server := &amp;http.Server{Addr: ":8080", Handler: wsContainer}
defer server.Close()
log.Fatal(server.ListenAndServe())
</code></pre></div></div>

<p>}</p>

<p>type UserResource struct{}</p>

<p>func (u UserResource) RegisterTo(container <em>restful.Container) {
    ws := new(restful.WebService)
    //è®¾ç½®åŒ¹é…çš„schemaå’Œè·¯å¾„
    ws.Path(â€œ/userâ€).Consumes(â€œ</em>/<em>â€).Produces(â€œ</em>/*â€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è®¾ç½®ä¸åŒmethodå¯¹åº”çš„æ–¹æ³•ï¼Œå‚æ•°ä»¥åŠå‚æ•°æè¿°å’Œç±»å‹
//å‚æ•°:åˆ†ä¸ºè·¯å¾„ä¸Šçš„å‚æ•°,queryå±‚é¢çš„å‚æ•°,Headerä¸­çš„å‚æ•°
ws.Route(ws.GET("/{id}").
    To(u.result).
    Doc("æ–¹æ³•æè¿°ï¼šè·å–ç”¨æˆ·").
    Param(ws.PathParameter("id", "å‚æ•°æè¿°:ç”¨æˆ·ID").DataType("string")).
    Param(ws.QueryParameter("name", "ç”¨æˆ·åç§°").DataType("string")).
    Param(ws.HeaderParameter("token", "è®¿é—®ä»¤ç‰Œ").DataType("string")).
    Do(returns200, returns500))
ws.Route(ws.POST("").To(u.result))
ws.Route(ws.PUT("/{id}").To(u.result))
ws.Route(ws.DELETE("/{id}").To(u.result))

container.Add(ws) }
</code></pre></div></div>

<p>func (UserResource) SwaggerDoc() map[string]string {
    return map[string]string{
        â€œâ€:         â€œAddress docâ€,//ç©ºè¡¨ç¤ºç»“æ„æœ¬çœçš„æè¿°
        â€œcountryâ€:  â€œCountry docâ€,
        â€œpostcodeâ€: â€œPostCode docâ€,
    }
}</p>

<p>func (u UserResource) result(request *restful.Request, response *restful.Response) {
    io.WriteString(response.ResponseWriter, â€œthis would be a normal responseâ€)
}</p>

<p>func returns200(b *restful.RouteBuilder) {
    b.Returns(http.StatusOK, â€œOKâ€, â€œsuccessâ€)
}</p>

<p>func returns500(b *restful.RouteBuilder) {
    b.Returns(http.StatusInternalServerError, â€œBummer, something went wrongâ€, nil)
}</p>

<p>äºŒã€è¯¦è§£
1ã€WebServices and Routes
WebServiceæ‹¥æœ‰ä¸€ä¸ªRouteå¯¹è±¡çš„é›†åˆï¼Œè¿™äº›Routeå¯¹è±¡è´Ÿè´£åˆ†å‘å³å°†åˆ°æ¥çš„HTTPè¯·æ±‚åˆ°ç›¸åº”çš„å‡½æ•°è°ƒç”¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒWebServiceæœ‰ä¸€ä¸ªrootæ ¹è·¯å¾„ï¼ˆä¾‹å¦‚ï¼š/usersï¼‰ï¼Œè¿˜ä¸ºè·¯ç”±å®šä¹‰äº†å¸¸è§çš„MIMEç±»å‹ã€‚WebServiceå¿…é¡»æ·»åŠ åˆ°æŸä¸ªå®¹å™¨ä»¥ä¾¿èƒ½ä»æœåŠ¡å™¨å¤„ç†HTTPè¯·æ±‚ã€‚</p>

<p>Routeæ˜¯æ ¹æ®HTTPåˆ†å‘ã€URLè·¯å¾„å’ŒMIMEç±»å‹æ‰€å®šä¹‰çš„ã€‚</p>

<p>æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…è·¯ç”±
è·¯ç”±å‚æ•°å¯ä»¥ä½¿ç”¨æ ¼å¼â€œuri/{var[:regexp]}â€æˆ–æŒ‡å®šç‰ˆæœ¬çš„â€œuri/{var:*}â€åŒ¹é…è·¯å¾„å°¾éƒ¨è¿›è¡ŒæŒ‡å®šã€‚ä¾‹å¦‚ï¼Œ/persons/{name:[A-Z][A-Z]} å¯ç”¨æ¥é™åˆ¶nameå‚æ•°çš„å€¼åªèƒ½åŒ…å«å¤§å†™å­—æ¯ã€‚æ­£åˆ™è¡¨è¾¾å¼å¿…é¡»ä½¿ç”¨regexpåŒ…ä¸­çš„æ ‡å‡†Goè¯­æ³•è¿›è¡Œæè¿°ã€‚https://code.google.com/p/re2/wiki/Syntaxï¼Œæ­¤åŠŸèƒ½éœ€è¦ä½¿ç”¨CurlyRouterã€‚</p>

<p>2ã€å®¹å™¨ï¼ˆContainerï¼‰
å®¹å™¨å¯ä»¥holdä½ä¸€å¥—WebServiceçš„é›†åˆã€è¿‡æ»¤å™¨ã€ä¸€ä¸ªç”¨äºhttpè¯·æ±‚å¤šè·¯å¤ç”¨çš„http.ServeMuxã€‚ä½¿ç”¨è¯­å¥â€œrestful.Add(â€¦)â€å’Œâ€œrestful.Filter(â€¦)â€ï¼Œå‰è€…å¯ä»¥åœ¨å®¹å™¨æ³¨å†Œä¸€ä¸ªWebServiceï¼Œåè€…å¯ä»¥è¿‡æ»¤ã€‚go-restfulé»˜è®¤çš„å®¹å™¨ä½¿ç”¨http.DefaultServeMuxã€‚ç”¨æˆ·å¯ä»¥åˆ›å»ºè‡ªå·±çš„å®¹å™¨ï¼Œä»¥åŠä¸ºæŒ‡å®šçš„å®¹å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„http.Serverã€‚</p>

<p>container := restful.NewContainer()
server := &amp;http.Server{Addr: â€œ:8081â€, Handler: container}
1
2
3ã€è¿‡æ»¤å™¨ï¼ˆFilterï¼‰
è¿‡æ»¤å™¨å¯ä»¥åŠ¨æ€æ‹¦æˆªè¯·æ±‚å’Œå“åº”ï¼Œä»¥åŠè½¬æ¢æˆ–ä½¿ç”¨è¯·æ±‚å’Œå“åº”ä¸­åŒ…å«çš„ä¿¡æ¯ã€‚ç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨æ¥æ‰§è¡Œå¸¸è§„çš„æ—¥å¿—è®°å½•ã€æµ‹é‡ã€éªŒè¯ã€é‡å®šå‘ã€è®¾ç½®å“åº”å¤´éƒ¨Headerç­‰ã€‚restfulåŒ…ä¸­æœ‰ä¸‰ä¸ªé’ˆå¯¹è¯·æ±‚ã€å“åº”æµçš„é’©å­ï¼Œè¿˜å¯ä»¥æ·»åŠ è¿‡æ»¤å™¨ã€‚æ¯ä¸ªè¿‡æ»¤å™¨å¿…é¡»å®šä¹‰ä¸€ä¸ªFilterFunctionï¼š</p>

<p>func(req *restful.Request, resp *restful.Response, chain *restful.FilterChain)
1
ä½¿ç”¨å¦‚ä¸‹è¯­å¥ä¼ é€’è¯·æ±‚/å“åº”å¯¹åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æˆ–RouteFunctionï¼š</p>

<p>chain.ProcessFilter(req, resp)
1
4ã€å®¹å™¨è¿‡æ»¤å™¨ï¼ˆContainer Filterï¼‰
åœ¨æ³¨å†ŒWebServiceä¹‹å‰å¤„ç†ï¼š</p>

<p>// å®‰è£…ä¸€ä¸ªï¼ˆå…¨å±€çš„ï¼‰è¿‡æ»¤å™¨åˆ°é»˜è®¤çš„å®¹å™¨
restful.Filter(globalLogging)
1
2
5ã€WebServiceè¿‡æ»¤å™¨ï¼ˆWebService Filterï¼‰
åœ¨è·¯ç”±WebServiceä¹‹å‰å¤„ç†ï¼š</p>

<p>// å®‰è£…ä¸€ä¸ªWebServiceè¿‡æ»¤å™¨
ws.Filter(webserviceLogging).Filter(measureTime)
1
2
6ã€è·¯ç”±è¿‡æ»¤å™¨ï¼ˆRoute Filterï¼‰
åœ¨è°ƒç”¨è·¯ç”±Routeç›¸å…³çš„å‡½æ•°ä¹‹å‰å¤„ç†ï¼š</p>

<p>// å®‰è£…2ä¸ªé“¾å¼çš„è·¯ç”±è¿‡æ»¤å™¨
ws.Route(ws.GET(â€œ/{user-id}â€).Filter(routeLogging).Filter(NewCountFilter().routeCounter))
1
2
ä¾‹å­å¯è§ï¼šhttps://github.com/emicklei/go-restful/blob/master/examples/restful-filters.go</p>

<p>7ã€å“åº”ç¼–ç ï¼ˆResponse Encodingï¼‰
æ”¯æŒä¸¤ç§å“åº”ç¼–ç ï¼šgzipå’Œdeflateã€‚è¦ä¸ºæ‰€æœ‰çš„å“åº”å¯ç”¨å®ƒä»¬ï¼š</p>

<p>restful.DefaultContainer.EnableContentEncoding(true)
1
å¦‚æœæŸä¸ªHttpè¯·æ±‚åŒ…å«äº†Accept-Encodingå¤´éƒ¨ï¼Œé‚£ä¹ˆå“åº”å†…å®¹å¿…é¡»ä½¿ç”¨æŒ‡å®šçš„ç¼–ç è¿›è¡Œå‹ç¼©ã€‚æˆ–è€…ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªè¿‡æ»¤å™¨æ‰§è¡Œç¼–ç å¹¶å®‰è£…å®ƒåˆ°æ¯ä¸€ä¸ªWebServiceå’ŒRouteã€‚</p>

<p>è§ä¾‹å­ï¼šhttps://github.com/emicklei/go-restful/blob/master/examples/restful-encoding-filter.go</p>

<p>8ã€OPTIONSæ”¯æŒ
é€šè¿‡å®‰è£…é¢„å®šä¹‰çš„å®¹å™¨è¿‡æ»¤å™¨ï¼Œä½ çš„WebServiceå¯ä»¥å“åº”HTTP OPTIONSè¯·æ±‚ã€‚</p>

<p>Filter(OPTIONSFilter())
1
9ã€CORS
é€šè¿‡å®‰è£…CrossOriginResourceSharingè¿‡æ»¤å™¨ï¼Œä½ çš„WebServiceå¯ä»¥å¤„ç†CORSè¯·æ±‚ã€‚</p>

<p>cors := CrossOriginResourceSharing{ExposeHeaders: []string{â€œX-My-Headerâ€}, CookiesAllowed: false, Container: DefaultContainer}
Filter(cors.Filter)
1
2
10ã€å¼‚å¸¸å¤„ç†
æ„æƒ³ä¸åˆ°çš„äº‹æƒ…å‘ç”Ÿã€‚å¦‚æœå› ä¸ºæ•…éšœè€Œä¸èƒ½å¤„ç†è¯·æ±‚ï¼ŒæœåŠ¡ç«¯éœ€è¦é€šè¿‡å“åº”å‘Šè¯‰å®¢æˆ·ç«¯å‘ç”Ÿäº†ä»€ä¹ˆå’Œä¸ºä»€ä¹ˆã€‚å› æ­¤ä½¿ç”¨HTTPçŠ¶æ€ç ï¼Œæ›´é‡è¦çš„æ˜¯è¦æ­£ç¡®çš„ä½¿ç”¨çŠ¶æ€ç ã€‚</p>

<p>400: Bad Request
å¦‚æœè·¯å¾„æˆ–æŸ¥è¯¢å‚æ•°æ— æ•ˆï¼ˆå†…å®¹æˆ–ç±»å‹ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨http.StatusBadRequestã€‚</p>

<p>404: Not Found
å°½ç®¡URIæœ‰æ•ˆï¼Œä½†è¯·æ±‚çš„èµ„æºå¯èƒ½ä¸å¯ç”¨ã€‚</p>

<p>500: Internal Server Error
å¦‚æœåº”ç”¨ç¨‹åºé€»è¾‘æ— æ³•å¤„ç†è¯·æ±‚ï¼ˆæˆ–ç¼–å†™å“åº”ï¼‰ï¼Œåˆ™ä½¿ç”¨http.StatusInternalServerErrorã€‚</p>

<p>405: Method Not Allowed
è¯·æ±‚çš„URLæ˜¯æœ‰æ•ˆçš„ï¼Œä½†è¯·æ±‚ä½¿ç”¨çš„HTTPæ–¹æ³•ï¼ˆGETï¼ŒPUTï¼ŒPOSTï¼Œâ€¦ï¼‰æ˜¯ä¸å…è®¸çš„ã€‚</p>

<p>406: Not Acceptable
è¯·æ±‚çš„å¤´éƒ¨æ²¡æœ‰æˆ–è®¾ç½®äº†æœªçŸ¥Accept Headerã€‚</p>

<p>415: Unsupported Media Type
è¯·æ±‚çš„å¤´éƒ¨æ²¡æœ‰æˆ–è®¾ç½®äº†æœªçŸ¥çš„Content-TypeæŠ¥å¤´ã€‚</p>

<p>11ã€ServiceError
é™¤äº†è®¾ç½®HTTPçŠ¶æ€ç ï¼Œè¿˜åº”è¯¥ä¸ºå“åº”é€‰æ‹©å†™é€‚å½“çš„ServiceErroræ¶ˆæ¯ã€‚</p>

<p>12ã€æ€§èƒ½é€‰é¡¹ï¼ˆPerformance Optionsï¼‰
è¿™ä¸ªåŒ…æœ‰å‡ ä¸ªé€‰é¡¹ï¼Œå®ƒä»¬å¯èƒ½ä¼šå½±å“æœåŠ¡çš„æ€§èƒ½ã€‚é‡è¦çš„æ˜¯è¦ç†è§£è¿™äº›é€‰é¡¹ï¼Œæ­£ç¡®åœ°è®¾ç½®å®ƒä»¬ã€‚</p>

<p>restful.DefaultContainer.DoNotRecover(false)
DoNotRecoveræ§åˆ¶æ˜¯å¦å› è¿”å›HTTP 500çŠ¶æ€ç è€Œï¼ˆææ…Œï¼‰åœæ­¢æœåŠ¡ã€‚å¦‚æœè®¾ç½®ä¸ºfalseï¼Œé‚£ä¹ˆå®¹å™¨Containerä¼šæ¢å¤æœåŠ¡ã€‚é»˜è®¤å€¼ä¸ºtrueã€‚</p>

<p>restful.SetCompressorProvider(NewBoundedCachedCompressors(20, 20))
å¦‚æœå¯ç”¨äº†å†…å®¹ç¼–ç ï¼Œé‚£ä¹ˆè·å¾—æ–°gzip/zlibè¾“å‡ºå™¨ï¼ˆwriterï¼‰å’Œè¯»å…¥å™¨ï¼ˆreaderï¼‰çš„é»˜è®¤ç­–ç•¥æ˜¯ä½¿ç”¨sync.Poolã€‚ç”±äºè¾“å‡ºå™¨writeræ˜¯æ˜‚è´µçš„ç»“æ„ï¼Œå½“ä½¿ç”¨é¢„åŠ è½½ç¼“å­˜æ—¶æ€§èƒ½æé«˜éå¸¸æ˜æ˜¾ã€‚ä½ ä¹Ÿå¯ä»¥æ³¨å…¥è‡ªå·±çš„å®ç°ã€‚</p>

<p>13ã€æ•…éšœæ’é™¤ï¼ˆTrouble shootingï¼‰
è¿™ä¸ªåŒ…å¯ä»¥å¯¹å®Œæ•´çš„Httpè¯·æ±‚çš„åŒ¹é…è¿‡ç¨‹å’Œè¿‡æ»¤å™¨è°ƒç”¨äº§ç”Ÿè¯¦ç»†çš„æ—¥å¿—è®°å½•ã€‚å¯ç”¨æ­¤åŠŸèƒ½éœ€è¦ä½ è®¾ç½®restful.StdLoggerçš„å®ç°ï¼Œä¾‹å¦‚log.Loggerï¼š</p>

<p>restful.TraceLogger(log.New(os.Stdout, â€œ[restful] â€œ, log.LstdFlags|logs.Lshortfile))
1
ä½¿ç”¨æ¡ˆä¾‹
https://github.com/emicklei/mora
https://github.com/emicklei/landskape</p>

:ET