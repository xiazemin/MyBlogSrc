I"<p>https://github.com/tkrajina/go-reflector
æºç åˆ†æç³»åˆ—æ–‡ç« å·²ç»å¼€æºåˆ°githubï¼Œåœ°å€å¦‚ä¸‹ï¼š
githubï¼š
https://github.com/farmer-hutao/k8s-source-code-analysis
gitbookï¼š
https://farmer-hutao.github.io/k8s-source-code-analysis
<!-- more -->
reflector
å‰é¢è¯´åˆ° Store è¦ç»™ Reflector æœåŠ¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ Reflector çš„å®šä¹‰ï¼š</p>

<p>tools/cache/reflector.go:47</p>

<p>type Reflector struct {
   name string
   metrics *reflectorMetrics
   expectedType reflect.Type
   // The destination to sync up with the watch source
   store Store
   // listerWatcher is used to perform lists and watches.
   listerWatcher ListerWatcher
  // â€¦â€¦
}
Copy
Reflector è¦åšçš„äº‹æƒ…æ˜¯ watch ä¸€ä¸ªæŒ‡å®šçš„èµ„æºï¼Œç„¶åå°†è¿™ä¸ªèµ„æºçš„å˜åŒ–åå°„åˆ°ç»™å®šçš„storeä¸­ã€‚å¾ˆæ˜æ˜¾è¿™é‡Œçš„ä¸¤ä¸ªå±æ€§ listerWatcher å’Œ store å°±æ˜¯è¿™äº›é€»è¾‘çš„å…³é”®ã€‚</p>

<p>æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹å¾€ store ä¸­æ·»åŠ æ•°æ®çš„ä»£ç ï¼š</p>

<p>tools/cache/reflector.go:324</p>

<p>switch event.Type {
case watch.Added:
   err := r.store.Add(event.Object)
   // â€¦â€¦
case watch.Modified:
   err := r.store.Update(event.Object)
   // â€¦â€¦
case watch.Deleted:
   // â€¦â€¦
   err := r.store.Delete(event.Object)
Copy
è¿™ä¸ª store ä¸€èˆ¬ç”¨çš„æ˜¯ DeltaFIFOï¼Œåˆ°è¿™é‡Œå¤§æ¦‚å°±çŸ¥é“ Refactor ä» API Server watch èµ„æºï¼Œç„¶åå†™å…¥ DeltaFIFO çš„è¿‡ç¨‹äº†ï¼Œå¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ï¼š</p>

<p>1555420426565</p>

<p>ç„¶åæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ DeltaFIFO çš„ knownObjects å±æ€§ï¼Œåœ¨åˆ›å»ºä¸€ä¸ª DeltaFIFO å®ä¾‹çš„æ—¶å€™æœ‰è¿™æ ·çš„é€»è¾‘ï¼š</p>

<p>tools/cache/delta_fifo.go:59</p>

<p>func NewDeltaFIFO(keyFunc KeyFunc, knownObjects KeyListerGetter) *DeltaFIFO {
   f := &amp;DeltaFIFO{
      items:        map[string]Deltas{},
      queue:        []string{},
      keyFunc:      keyFunc,
      knownObjects: knownObjects,
   }
   f.cond.L = &amp;f.lock
   return f
}
Copy
è¿™é‡Œæ¥æ”¶äº† KeyListerGetter ç±»å‹çš„ knownObjectsï¼Œç»§ç»­å¾€å‰è·Ÿå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å‰é¢æåˆ°çš„ SharedIndexInformer çš„åˆå§‹åŒ–é€»è¾‘ä¸­å°† indexer å¯¹è±¡å½“ä½œäº†è¿™é‡Œçš„ knownObjects çš„å®å‚ï¼š</p>

<p>tools/cache/shared_informer.go:192</p>

<p>fifo := NewDeltaFIFO(MetaNamespaceKeyFunc, s.indexer)
Copy
s.indexer æ¥è‡ªäºï¼šNewSharedIndexInformer() å‡½æ•°çš„é€»è¾‘ï¼š</p>

<p>func NewSharedIndexInformer(lw ListerWatcher, objType runtime.Object, defaultEventHandlerResyncPeriod time.Duration, indexers Indexers) SharedIndexInformer {
   realClock := &amp;clock.RealClock{}
   sharedIndexInformer := &amp;sharedIndexInformer{
      processor:                       &amp;sharedProcessor{clock: realClock},
      indexer:                         NewIndexer(DeletionHandlingMetaNamespaceKeyFunc, indexers),
      listerWatcher:                   lw,
      objectType:                      objType,
      resyncCheckPeriod:               defaultEventHandlerResyncPeriod,
      defaultEventHandlerResyncPeriod: defaultEventHandlerResyncPeriod,
      cacheMutationDetector:           NewCacheMutationDetector(fmt.Sprintf(â€œ%Tâ€, objType)),
      clock:                           realClock,
   }
   return sharedIndexInformer
}
Copy
è¿™é‡Œçš„ NewIndexer() å‡½æ•°ä¸­å°±å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å‰é¢æåˆ°çš„ Indexer æ¥å£çš„å®ç° cache å¯¹è±¡äº†ï¼š</p>

<p>!FILENMAE tools/cache/store.go:239</p>

<p>func NewIndexer(keyFunc KeyFunc, indexers Indexers) Indexer {
   return &amp;cache{
      cacheStorage: NewThreadSafeStore(indexers, Indices{}),
      keyFunc:      keyFunc,
   }
}</p>

:ET