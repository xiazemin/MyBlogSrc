I"ôy<p>phpæ‰©å±•å®è·µzend_execute_exå±‚è·å–å®å‚
å…¶å®åœ¨å®ç°çš„ php å‡½æ•°é‡Œé¢æ˜¯å¾ˆå®¹æ˜“è·å–åˆ°çš„ï¼Œå‚è€ƒ php çš„ builtin å‡½æ•° func_get_args() å°±å¯ä»¥çŸ¥é“äº†ã€‚
void **p;
int arg_count;
int i;
zend_execute_data *ex = EG(current_execute_data);</p>

<p>if (!ex || !ex-&gt;function_state.arguments) {
    RETURN_FALSE;
}</p>

<p>p = ex-&gt;function_state.arguments;
arg_count = (int)(zend_uintptr_t) *p;</p>

<p>for (i = 0; i &lt; arg_count; i++) {
    zval *element, *arg;
    arg = *((zval **) (p - (arg_count - i)));
    php_var_dump(&amp;arg, 1 TSRMLS_CC);
}</p>

<p>ä½†æ˜¯åœ¨ zend_execute_ex ä¸­ï¼Œæ˜¯ä¸èƒ½ä½¿ç”¨ function_state.arguments æ¥è·å–å‚æ•°çš„ï¼Œéœ€è¦ä» argument_stack ä¸­è·å–è°ƒç”¨å‡½æ•°çš„å®å‚ã€‚</p>

<p>static void (*old_zend_execute_ex) (zend_execute_data *execute_data TSRMLS_DC);</p>

<p>ZEND_API void learn_execute_ex (zend_execute_data *execute_data TSRMLS_DC)
{
    php_printf(â€œ====== extension debug start ======\nâ€);
    php_printf(â€œfunction name: %s\nâ€, get_active_function_name(TSRMLS_C));</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>old_zend_execute_ex(execute_data TSRMLS_CC);

int stacked = 0;
void **top;
void **bottom;
zval *arguments;
smart_str buf = {0};

array_init(arguments);

top = zend_vm_stack_top(TSRMLS_C) - 1;
if (top) {
    stacked = (int)(zend_uintptr_t) *top; // argc
    if (stacked) {
        bottom = zend_vm_stack_top(TSRMLS_C);
        EG(argument_stack)-&gt;top = top + 1;
        if (zend_copy_parameters_array(stacked, arguments TSRMLS_CC) == SUCCESS) {
            php_json_encode(&amp;buf, arguments, 0 TSRMLS_CC);
        }
        EG(argument_stack)-&gt;top = bottom;
    }
}

smart_str_0(&amp;buf);

php_printf("%s\n", buf.c);

smart_str_free(&amp;buf);
zval_dtor(arguments);

php_printf("====== extension debug end ======\n"); }
</code></pre></div></div>

<p>PHP_MINIT_FUNCTION(learn)
{
    old_zend_execute_ex = zend_execute_ex;
    zend_execute_ex = learn_execute_ex;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return SUCCESS; }
</code></pre></div></div>

<p>PHP_MSHUTDOWN_FUNCTION(learn)
{
    zend_execute_ex = old_zend_execute_ex;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return SUCCESS; } 2015-11-04 00:38 æ›´æ–° åæ¥çœ‹åˆ°ï¼Œå…¶å®ä¸ç”¨ä¸Šé¢è¿™ä¸­æ–¹æ³•å°±å¯ä»¥å®ç°, php 5.5ä¹‹åè¦ä» prev é‡Œé¢å»å–
</code></pre></div></div>

<p>/**</p>
<ul>
  <li>php_var_dump defined in this head file.
 */
#include â€œext/standard/php_var.hâ€</li>
</ul>

<p>zend_execute_data *real_execute_data = execute_data-&gt;prev_execute_data;</p>

<p>void **p = real_execute_data-&gt;function_state.arguments;
int arg_count = (int) (zend_uintptr_t) * p;
zval *argument_element;
int i;
// zval *obj = real_execute_data-&gt;object;
unsigned long start = mach_absolute_time();
for (i = 0; i &lt; arg_count; i++) {
    argument_element = *(p - (arg_count - i));
    php_var_dump(&amp;argument_element, 1);
}
<!-- more -->
å­—èŠ‚ç åœ¨ Zend è™šæ‹Ÿæœºä¸­çš„è§£é‡Šæ‰§è¡Œ ä¹‹ æ¦‚è¿°</p>

<p>execute_ex
æˆ‘ä»¬æ¥çœ‹çœ‹æ‰§è¡Œä¸€ä¸ªç®€å•çš„è„šæœ¬ test.php çš„è°ƒç”¨æ ˆ</p>

<p>execute_ex @ zend_vm_execute.h : 411
zend_execute @ zend_vm_execute.h : 474
php_execute_script @ zend.c : 1474
do_cli @ php_cli.c : 993
main @ php_cli.c : 1381 
ç”±äºæ˜¯æ‰§è¡Œè„šæœ¬æ–‡ä»¶ï¼Œæ‰€ä»¥ do_cli è°ƒç”¨äº† php_execute_script å‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨ execute_ex å‡½æ•°ï¼š</p>

<p>ZEND_API void execute_ex(zend_execute_data *ex)
{
    DCL_OPLINE</p>

<p>#ifdef ZEND_VM_IP_GLOBAL_REG
    const zend_op *orig_opline = opline;
#endif
#ifdef ZEND_VM_FP_GLOBAL_REG
    zend_execute_data *orig_execute_data = execute_data;
    execute_data = ex;
#else
    zend_execute_data *execute_data = ex;
#endif</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOAD_OPLINE();
ZEND_VM_LOOP_INTERRUPT_CHECK();

while (1) { #if !defined(ZEND_VM_FP_GLOBAL_REG) || !defined(ZEND_VM_IP_GLOBAL_REG)
        int ret; #endif #if defined(ZEND_VM_FP_GLOBAL_REG) &amp;&amp; defined(ZEND_VM_IP_GLOBAL_REG)
    ((opcode_handler_t)OPLINE-&gt;handler)(ZEND_OPCODE_HANDLER_ARGS_PASSTHRU);
    if (UNEXPECTED(!OPLINE)) { #else
    if (UNEXPECTED((ret = ((opcode_handler_t)OPLINE-&gt;handler)www.90168.org(ZEND_OPCODE_HANDLER_ARGS_PASSTHRU)) != 0)) { #endif #ifdef ZEND_VM_FP_GLOBAL_REG
        execute_data = orig_execute_data; # ifdef ZEND_VM_IP_GLOBAL_REG
        opline = orig_opline; # endif
        return; #else
        if (EXPECTED(ret &gt; 0)) {
            execute_data = EG(current_execute_data);
            ZEND_VM_LOOP_INTERRUPT_CHECK();
        } else { # ifdef ZEND_VM_IP_GLOBAL_REG
            opline = orig_opline; # endif
            return;
        } #endif
    }

}
zend_error_noreturn(E_CORE_ERROR, "Arrived at end of main loop which shouldn't happen"); } å’Œå…¶å®ƒ C è¯­è¨€ç¼–å†™çš„ç³»ç»Ÿè½¯ä»¶ç±»ä¼¼ï¼Œå‡½æ•°ä¸­ä½¿ç”¨äº†å¤§é‡çš„å®å®šä¹‰ï¼Œé€šè¿‡å®å®šä¹‰çš„åå­—è¿˜æ˜¯èƒ½å¤§æ¦‚çœ‹å‡ºå…¶ç”¨é€”
</code></pre></div></div>

<p>DCL_OPLINEï¼Œå˜é‡å£°æ˜</p>

<p>LOAD_OPLINE()ï¼ŒåŠ è½½æŒ‡ä»¤å­—èŠ‚ç </p>

<p>ZEND_VM_LOOP_INTERRUPT_CHECK()ï¼Œinterrupt æ£€æµ‹</p>

<p>è§£é‡Šå™¨å¼•æ“æœ€ç»ˆæ‰§è¡Œopçš„å‡½æ•°æ˜¯zend_executeï¼Œå®é™…ä¸Šzend_executeæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œåœ¨å¼•æ“åˆå§‹åŒ–çš„æ—¶å€™zend_executeé»˜è®¤æŒ‡å‘äº†execute,è¿™ä¸ªexecuteå®šä¹‰åœ¨{PHPSRC}/Zend/zend_vm_execute.hï¼š</p>

<p>Zendå¼•æ“ä¸»è¦åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šç¼–è¯‘ã€æ‰§è¡Œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æ‰§è¡Œé˜¶æ®µä¸»è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„ï¼š

      opcodeï¼š phpä»£ç ç¼–è¯‘äº§ç”Ÿçš„zendè™šæ‹Ÿæœºå¯è¯†åˆ«çš„æŒ‡ä»¤ï¼Œphp7æœ‰173ä¸ªopcodeï¼Œå®šä¹‰åœ¨ zend_vm_opcodes.hPHPä¸­çš„æ‰€æœ‰è¯­æ³•å®ç°éƒ½æ˜¯ç”±è¿™äº›opcodeç»„æˆçš„ã€‚
</code></pre></div></div>

<p>å¤åˆ¶ä»£ç 
struct _zend_op {
    const void *handler; //å¯¹åº”æ‰§è¡Œçš„Cè¯­è¨€functionï¼Œå³æ¯æ¡opcodeéƒ½æœ‰ä¸€ä¸ªC functionå¤„ç†
    znode_op op1;   //æ“ä½œæ•°1
    znode_op op2;   //æ“ä½œæ•°2
    znode_op result; //è¿”å›å€¼
    uint32_t extended_value; 
    uint32_t lineno; 
    zend_uchar opcode;  //opcodeæŒ‡ä»¤
    zend_uchar op1_type; //æ“ä½œæ•°1ç±»å‹
    zend_uchar op2_type; //æ“ä½œæ•°2ç±»å‹
    zend_uchar result_type; //è¿”å›å€¼ç±»å‹
};
å¤åˆ¶ä»£ç 
         zend_op_array : zendå¼•æ“æ‰§è¡Œé˜¶æ®µçš„è¾“å…¥æ•°æ®ç»“æ„ï¼Œæ•´ä¸ªæ‰§è¡Œé˜¶æ®µéƒ½æ˜¯æ“ä½œè¿™ä¸ªæ•°æ®ç»“æ„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ã€€ã€€ã€€ã€€ã€€ã€€ zend_op_arrayæœ‰ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šopcodeæŒ‡ä»¤(å¯¹åº”cçš„æŒ‡ä»¤)

                                               å­—é¢é‡å­˜å‚¨(å˜é‡åˆå§‹å€¼ã€è°ƒç”¨çš„å‡½æ•°åç§°ã€ç±»åç§°ã€å¸¸é‡åç§°ç­‰ç­‰ç§°ä¹‹ä¸ºå­—é¢é‡)

                                               å˜é‡åˆ†é…çš„æƒ…å†µ (å½“å‰arrayå®šä¹‰çš„å˜é‡ ä¸´æ—¶å˜é‡çš„æ•°é‡ ç¼–å·ï¼Œæ‰§è¡Œåˆå§‹åŒ–ä¸€æ¬¡æ€§åˆ†é…zvalï¼Œä½¿ç”¨æ—¶å®Œå…¨æŒ‰ç…§æ ‡å·ç´¢å¼•ä¸æ˜¯æ ¹æ®å˜é‡å)

     

       zend_executor_globals     PHPæ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªç»“æ„ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨mainæ‰§è¡Œå‰åˆ†é…(éZTSä¸‹)ï¼Œç›´åˆ°PHPé€€å‡ºï¼Œå®ƒè®°å½•ç€å½“å‰è¯·æ±‚å…¨éƒ¨çš„ä¿¡æ¯ï¼Œç»å¸¸è§åˆ°çš„ä¸€ä¸ªå®EGæ“ä½œçš„å°±æ˜¯è¿™ä¸ªç»“æ„ã€‚

                            å®šä¹‰åœ¨zend_globals.hä¸­ï¼š

 

                               

 

            

           zend_execute_data  æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªç»“æ„ï¼Œæ¯æ¬¡å‡½æ•°çš„è°ƒç”¨ã€include/requireã€evalç­‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œå®ƒè¡¨ç¤ºå½“å‰çš„ä½œç”¨åŸŸã€ä»£ç çš„æ‰§è¡Œä½ç½®ä»¥åŠå±€éƒ¨å˜é‡çš„åˆ†é…ç­‰ç­‰ï¼Œç­‰åŒäºæœºå™¨ç æ‰§è¡Œè¿‡ç¨‹ä¸­stackçš„è§’è‰²ï¼Œåé¢åˆ†æå…·ä½“æ‰§è¡Œæµç¨‹çš„æ—¶å€™ä¼šè¯¦ç»†åˆ†æå…¶ä½œç”¨ã€‚ 

          zend_execute_dataä¸zend_op_arrayçš„å…³è”å…³ç³»ï¼š
</code></pre></div></div>

<p>2.æ‰§è¡Œè¿‡ç¨‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Zendçš„executorä¸linuxäºŒè¿›åˆ¶ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚

    åœ¨Cç¨‹åºæ‰§è¡Œæ—¶æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ebpã€espåˆ†åˆ«æŒ‡å‘å½“å‰ä½œç”¨æ ˆçš„æ ˆé¡¶ã€æ ˆåº•ï¼Œå±€éƒ¨å˜é‡å…¨éƒ¨åˆ†é…åœ¨å½“å‰æ ˆï¼Œå‡½æ•°è°ƒç”¨ã€è¿”å›é€šè¿‡callã€retæŒ‡ä»¤å®Œæˆï¼Œè°ƒç”¨æ—¶callå°†å½“å‰æ‰§è¡Œä½ç½®å‹å…¥æ ˆä¸­ï¼Œè¿”å›æ—¶retå°†ä¹‹å‰æ‰§è¡Œä½ç½®å‡ºæ ˆï¼Œè·³å›æ—§çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚

    Zend VMä¸­zend_execute_dataå°±æ‰®æ¼”äº†è¿™ä¸¤ä¸ªè§’è‰²ï¼Œzend_execute_data.prev_execute_dataä¿å­˜çš„æ˜¯è°ƒç”¨æ–¹çš„ä¿¡æ¯ï¼Œå®ç°äº†call/retï¼Œzend_execute_dataåé¢ä¼šåˆ†é…é¢å¤–çš„å†…å­˜ç©ºé—´ç”¨äºå±€éƒ¨å˜é‡çš„å­˜å‚¨ï¼Œå®ç°äº†ebp/espçš„ä½œç”¨ã€‚

                a. ä¸ºå½“å‰ä½œç”¨åŸŸåˆ†é…ä¸€å—å†…å­˜ï¼Œå……å½“è¿è¡Œæ ˆï¼Œzend_execute_dataç»“æ„ã€æ‰€æœ‰å±€éƒ¨å˜é‡ã€ä¸­é—´å˜é‡ç­‰ç­‰éƒ½åœ¨æ­¤å†…å­˜ä¸Šåˆ†é…

                b.åˆå§‹åŒ–å…¨å±€å˜é‡ç¬¦å·è¡¨ï¼Œç„¶åå°†å…¨å±€æ‰§è¡Œä½ç½®æŒ‡é’ˆEG(current_execute_data)æŒ‡å‘æ­¥éª¤aæ–°åˆ†é…çš„zend_execute_dataï¼Œç„¶åå°†zend_execute_data.oplineæŒ‡å‘op_arrayçš„èµ·å§‹ä½ç½®

                c.ä»EX(opline)å¼€å§‹è°ƒç”¨å„opcodeçš„Cå¤„ç†handler(å³_zend_op.handler)ï¼Œæ¯æ‰§è¡Œå®Œä¸€æ¡opcodeå°†EX(opline)++ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œç›´åˆ°æ‰§è¡Œå®Œå…¨éƒ¨opcode

                            ifè¯­å¥å°†æ ¹æ®æ¡ä»¶çš„æˆç«‹ä¸å¦å†³å®šEX(opline) + offsetæ‰€åŠ çš„åç§»é‡ï¼Œå®ç°è·³è½¬

                            å¦‚æœæ˜¯å‡½æ•°è°ƒç”¨ï¼Œåˆ™é¦–å…ˆä»EG(function_table)ä¸­æ ¹æ®function_nameå–å‡ºæ­¤functionå¯¹åº”çš„ç¼–è¯‘å®Œæˆçš„zend_op_arrayï¼Œç„¶ååƒæ­¥éª¤aä¸€æ ·æ–°åˆ†é…ä¸€ä¸ªzend_execute_dataç»“æ„ï¼Œå°†EG(current_execute_data)èµ‹å€¼ç»™æ–°ç»“æ„çš„prev_execute_dataï¼Œå†å°†EG(current_execute_data)æŒ‡å‘æ–°çš„zend_execute_dataï¼Œæœ€åä»æ–°çš„zend_execute_data.oplineå¼€å§‹æ‰§è¡Œï¼Œåˆ‡æ¢åˆ°å‡½æ•°å†…éƒ¨ï¼Œå‡½æ•°æ‰§è¡Œå®Œä»¥åå°†EG(current_execute_data)é‡æ–°æŒ‡å‘EX(prev_execute_data)ï¼Œé‡Šæ”¾åˆ†é…çš„è¿è¡Œæ ˆï¼Œé”€æ¯å±€éƒ¨å˜é‡ï¼Œç»§ç»­ä»åŸæ¥å‡½æ•°è°ƒç”¨çš„ä½ç½®æ‰§è¡Œ

                            ç±»æ–¹æ³•çš„è°ƒç”¨ä¸å‡½æ•°åŸºæœ¬ç›¸åŒ

                d.å…¨éƒ¨opcodeæ‰§è¡Œå®Œæˆåå°†æ­¥éª¤aåˆ†é…çš„å†…å­˜é‡Šæ”¾ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå°†æ‰€æœ‰çš„å±€éƒ¨å˜é‡"é”€æ¯"ï¼Œæ‰§è¡Œé˜¶æ®µç»“æŸ

                                

 

                          é¦–å…ˆæ ¹æ®zend_execute_dataã€å½“å‰zend_op_arrayä¸­å±€éƒ¨/ä¸´æ—¶å˜é‡æ•°è®¡ç®—éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œç¼–è¯‘é˜¶æ®µzend_op_arrayçš„ç»“æœï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å·²ç»ç¡®å®šå½“å‰ä½œç”¨åŸŸä¸‹æœ‰å¤šå°‘ä¸ªå±€éƒ¨å˜é‡(func-&gt;op_array.last_var)ã€ä¸´æ—¶/ä¸­é—´/æ— ç”¨å˜é‡(func-&gt;op_array.T)ï¼Œä»è€Œåœ¨æ‰§è¡Œä¹‹åˆå°±å°†ä»–ä»¬å…¨éƒ¨åˆ†é…å®Œæˆã€‚
</code></pre></div></div>

<p>PHP xhprof æ‰©å±•åŸç†
ç”±äºå…¬å¸é¡¹ç›®ï¼Œæœ€è¿‘éœ€è¦åˆ†æåç«¯PHPæ¥å£çš„æ€§èƒ½æ•°æ®ï¼Œå°±é‡‡ç”¨äº†FACEBOOKä¹‹å‰å¼€æºçš„ä¸€ä¸ªæ‰©å±•ï¼Œç°åœ¨å¸‚é¢ä¸Šå¾ˆå¤šåˆ†æ”¯éƒ½æ˜¯åŸºäºFBæœ€å¼€å§‹çš„çº¿å¼€å‘çš„ï¼Œä½†æ˜¯ç”±äºFBå·²ç»åœæ­¢ç»´æŠ¤ï¼Œæ‰€ä»¥ç°åœ¨å…¶ä»–çº¿éƒ½æ˜¯è‡ªå·±ä¸ªäººåœ¨ç»´æŠ¤ã€‚</p>

<p>ä»Šå¤©æˆ‘åˆ†æçš„è¿™ä¸ªåˆ†æ”¯æ˜¯å…¼å®¹PHP7+çš„ç‰ˆæœ¬æ”¶é›†æ€§èƒ½æ•°æ®ï¼Œå…ˆè´´å‡ºGITHUBçš„é“¾æ¥Â Â https://github.com/longxinH/xhprof</p>

<p>æ‰©å±•çš„å®‰è£…æ–¹å¼å’ŒPHPè°ƒç”¨çš„APIç”¨æ³•åœ¨githubä¸Šreadme.mdä¸Šæœ‰è¯¦ç»†è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒï¼Œæˆ‘ç°åœ¨åšçš„é¡¹ç›®å°±æ˜¯ç”¨è¿™ä¸ªæ¥æ”¶é›†çš„ï¼Œå› ä¸ºæ˜¯ç§äººç»´æŠ¤çš„ï¼Œä¸æ•¢ä¿è¯ä»¥åä¼šä¸ä¼šå¯ç”¨ï¼Œæ‰€ä»¥å…ˆè‡ªå·±äº†è§£ä¸‹XHPROFæ‰©å±•æºç ï¼Œé˜²æ­¢åé¢ç»´æŠ¤äººä¸ç»´æŠ¤ï¼Œå¯ä»¥è‡ªå·±åœ¨ç»§ç»­ç»´æŠ¤èµ·æ¥ã€‚</p>

<p>Â </p>

<p>åˆ†æï¼š</p>

<p>èµ·å§‹å¤–éƒ¨æ‰©å±•å°±æ˜¯ç›¸å½“äºå†…æ ¸ä¸€ä¸ªæ¨¡å—ï¼Œéƒ½æ˜¯zend_module_entryç»“æ„ä½“, æ”¶é›†æ€§èƒ½æ•°æ®çš„åŸç†ï¼Œå°±æ˜¯åœ¨æ¨¡å—åˆå§‹åŒ–çš„æ—¶å€™ä»£ç†äº†è¿™ä¸ªï¼Œä»£ç†äº†è¿™ä¸ªç¼–è¯‘å’Œæ‰§è¡ŒOPCODE çš„å‡½æ•°ï¼Œè¦†ç›–äº†ä¸€å±‚ï¼ŒåŠ äº†è‡ªå·±çš„å¤„ç†ï¼Œè‡ªå·±çš„å¤„ç†å°±æ˜¯Cä»£ç çš„æ‰§è¡Œæ—¶é—´å’ŒPHPç”³è¯·å †å†…å­˜çš„è®¡ç®—ã€‚</p>

<p>/* Replace zend_compile with our proxy */</p>

<p>_zend_compile_file = zend_compile_file;</p>

<p>zend_compile_file = hp_compile_file;</p>

<p>/* Replace zend_compile_string with our proxy */</p>

<p>_zend_compile_string = zend_compile_string;</p>

<p>zend_compile_string = hp_compile_string;</p>

<p>/* Replace zend_execute with our proxy */</p>

<p>_zend_execute_ex = zend_execute_ex;</p>

<p>zend_execute_ex = hp_execute_ex;
è¿™æ˜¯zend_module_entryï¼Œç¬¬ä¸‰æ–¹æ‰©å±•éƒ½éœ€è¦å®ç°è¿™ä¸ªç»“æ„ä½“ï¼Œç”¨æ¥ä¿å­˜æ‰©å±•çš„åŸºæœ¬ä¿¡æ¯ï¼Œç±»ä¼¼è®¾è®¡æ¨¡å¼é‡Œé¢çš„å®ç°æ¥å£
/* Callback functions for the xhprof extension <em>/
zend_module_entry xhprof_module_entry = {
#if ZEND_MODULE_API_NO &gt;= 20010901
        STANDARD_MODULE_HEADER,
#endif
        â€œxhprofâ€,                        /</em> Name of the extension <em>/
        xhprof_functions,                /</em> List of functions exposed <em>/
        PHP_MINIT(xhprof),               /</em> Module init callback <em>/
        PHP_MSHUTDOWN(xhprof),           /</em> Module shutdown callback <em>/
        PHP_RINIT(xhprof),               /</em> Request init callback <em>/
        PHP_RSHUTDOWN(xhprof),           /</em> Request shutdown callback <em>/
        PHP_MINFO(xhprof),               /</em> Module info callback */
#if ZEND_MODULE_API_NO &gt;= 20010901
        XHPROF_VERSION,
#endif
        STANDARD_MODULE_PROPERTIES
};
Â </p>

<p>/* Xhprofâ€™s global state.
 *</p>
<ul>
  <li>This structure is instantiated once.  Initialize defaults for attributes in</li>
  <li>hp_init_profiler_state() Cleanup/free attributes in</li>
  <li>
    <p>hp_clean_profiler_state() */
å­˜å‚¨æ‰©å±•æ€§èƒ½æ•°æ®ï¼Œæ˜¯å¦å¼€å¯ï¼Œç­‰ä¿¡æ¯çš„ç»“æ„ä½“
ZEND_BEGIN_MODULE_GLOBALS(xhprof)</p>

    <p>/*       â€”â€”â€”-   Global attributes:  â€”â€”â€”â€“       */</p>

    <p>/* Indicates if xhprof is currently enabled */
 int              enabled;</p>

    <p>/* Indicates if xhprof was ever enabled during this request */
 int              ever_enabled;</p>

    <p>/* Holds all the xhprof statistics */
 zval            stats_count;</p>

    <p>/* Indicates the current xhprof mode or level */
 int              profiler_level;</p>

    <p>/* Top of the profile stack */
 hp_entry_t      *entries;</p>

    <p>/* freelist of hp_entry_t chunks for reuseâ€¦ */
 hp_entry_t      *entry_free_list;</p>

    <p>/* Callbacks for various xhprof modes */
 hp_mode_cb       mode_cb;</p>

    <p>/*       â€”â€”â€”-   Mode specific attributes:  â€”â€”â€”â€“       */</p>

    <p>/* Global to track the time of the last sample in time and ticks <em>/
 struct timeval   last_sample_time;
 uint64           last_sample_tsc;
 /</em> XHPROF_SAMPLING_INTERVAL in ticks <em>/
 long             sampling_interval;
 uint64           sampling_interval_tsc;
 int              sampling_depth;
 /</em> XHProf flags */
 uint32 xhprof_flags;</p>

    <p>char *root;</p>

    <p>/* counter table indexed by hash value of function names. */
 uint8  func_hash_counters[256];</p>

    <p>HashTable *trace_callbacks;</p>

    <p>/* Table of ignored function names and their filter */
 hp_ignored_functions *ignored_functions;</p>
  </li>
</ul>

<p>ZEND_END_MODULE_GLOBALS(xhprof)
/**
static const zend_ini_entry_def ini_entries[] = {
    { xhprof.output_dir, NULL, arg1, arg2, arg3, â€˜â€™, displayer, 7, sizeof(name)-1, sizeof(â€˜â€™)-1 },
    { xhprof.collect_additional_info, NULL, arg1, arg2, arg3, â€˜0â€™, displayer, 7, sizeof(name)-1, sizeof(â€˜â€™)-1 },
    { xhprof.sampling_interval, NULL, arg1, arg2, arg3, â€˜100000â€™, displayer, 7, sizeof(name)-1, sizeof(â€˜â€™)-1 },
    { xhprof.sampling_depth, NULL, arg1, arg2, arg3, â€˜100000â€™, displayer, 7, sizeof(name)-1, sizeof(â€˜â€™)-1 },
    { NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, 0, 0}</p>

<p>}
 */
è¿™æ˜¯æ³¨å†Œxhprofæ‰©å±•æ‰€æœ‰çš„php.inié…ç½®é¡¹
PHP_INI_BEGIN()</p>

<p>/* output directory:</p>
<ul>
  <li>Currently this is not used by the extension itself.</li>
  <li>But some implementations of iXHProfRuns interface might</li>
  <li>choose to save/restore XHProf profiler runs in the</li>
  <li>directory specified by this ini setting.
 */
PHP_INI_ENTRY(â€œxhprof.output_dirâ€, â€œâ€, PHP_INI_ALL, NULL)</li>
</ul>

<p>/*</p>
<ul>
  <li>collect_additional_info</li>
  <li>Collect mysql_query, curl_exec internal info. The default is 0.
 */
PHP_INI_ENTRY(â€œxhprof.collect_additional_infoâ€, â€œ0â€, PHP_INI_ALL, NULL)</li>
</ul>

<p>/* sampling_interval:</p>
<ul>
  <li>Sampling interval to be used by the sampling profiler, in microseconds.
 */
#define STRINGIFY_(X) #X
#define STRINGIFY(X) STRINGIFY_(X)</li>
</ul>

<p>STD_PHP_INI_ENTRY(â€œxhprof.sampling_intervalâ€, STRINGIFY(XHPROF_DEFAULT_SAMPLING_INTERVAL), PHP_INI_ALL, OnUpdateLong, sampling_interval, zend_xhprof_globals, xhprof_globals)</p>

<p>/* sampling_depth:</p>
<ul>
  <li>Depth to trace call-chain by the sampling profiler
 */
STD_PHP_INI_ENTRY(â€œxhprof.sampling_depthâ€, STRINGIFY(INT_MAX), PHP_INI_ALL, OnUpdateLong, sampling_depth, zend_xhprof_globals, xhprof_globals)
PHP_INI_END()
/**</li>
  <li>Module init callback.
 *</li>
  <li>
    <p>@author cjiang
 */
æ¨¡å—åˆå§‹åŒ–çš„è°ƒç”¨çš„å‡½æ•°
//int zm_startup_xhprof(xhprof)(int type, int module_number)
PHP_MINIT_FUNCTION(xhprof)
{
 ZEND_INIT_MODULE_GLOBALS(xhprof, php_xhprof_init_globals, NULL);</p>

    <p>REGISTER_INI_ENTRIES();</p>

    <p>hp_register_constants(INIT_FUNC_ARGS_PASSTHRU);</p>

    <p>/* Replace zend_compile with our proxy */
 _zend_compile_file = zend_compile_file;
 zend_compile_file  = hp_compile_file;</p>

    <p>/* Replace zend_compile_string with our proxy */
 _zend_compile_string = zend_compile_string;
 zend_compile_string = hp_compile_string;</p>

    <p>/* Replace zend_execute with our proxy */
 _zend_execute_ex = zend_execute_ex;
 zend_execute_ex  = hp_execute_ex;</p>

    <p>/* Replace zend_execute_internal with our proxy */
 _zend_execute_internal = zend_execute_internal;
 zend_execute_internal = hp_execute_internal;</p>
  </li>
</ul>

<p>#if defined(DEBUG)
    /* To make it random number generator repeatable to ease testing. */
    srand(0);
#endif
    return SUCCESS;
}</p>

<p>/**</p>
<ul>
  <li>
    <p>Module shutdown callback.
 <em>/
æ¨¡å—å…³é—­çš„è°ƒç”¨çš„å‡½æ•°
//int zm_shutdown_xhprof(xhprof)(int type, int module_number)
PHP_MSHUTDOWN_FUNCTION(xhprof)
{
 /</em> free any remaining items in the free list */
 hp_free_the_free_list();</p>

    <p>/* Remove proxies, restore the originals */
 zend_execute_ex       = _zend_execute_ex;
 zend_execute_internal = _zend_execute_internal;
 zend_compile_file     = _zend_compile_file;
 zend_compile_string   = _zend_compile_string;</p>

    <p>UNREGISTER_INI_ENTRIES();</p>

    <p>return SUCCESS;
}</p>
  </li>
</ul>

<p>/**</p>
<ul>
  <li>
    <p>Request init callback. Nothing to do yet!
 */
è¯·æ±‚åˆå§‹åŒ–çš„è°ƒç”¨çš„å‡½æ•°
//int zm_activate_xhprof(xhprof)(int type, int module_number)
PHP_RINIT_FUNCTION(xhprof)
{
#if defined(ZTS) &amp;&amp; defined(COMPILE_DL_XHPROF)
 ZEND_TSRMLS_CACHE_UPDATE();
#endif</p>

    <p>return SUCCESS;
}</p>
  </li>
</ul>

<p>/**</p>
<ul>
  <li>Request shutdown callback. Stop profiling and return.
 */
//int zm_deactivate_xhprof(xhprof)(int type, int module_number)
è¯·æ±‚å®Œæˆçš„è°ƒç”¨çš„å‡½æ•°
PHP_RSHUTDOWN_FUNCTION(xhprof)
{
 hp_end();
 return SUCCESS;
}</li>
</ul>

<p>/**</p>
<ul>
  <li>Module info callback. Returns the xhprof version.
 */
phpinfoæ˜¾ç¤ºæ¨¡å—åŸºæœ¬ä¿¡æ¯è°ƒç”¨çš„å‡½æ•°
//int zm_info_xhprof(xhprof)(zend_module_entry *zend_module)
PHP_MINFO_FUNCTION(xhprof)
{
 php_info_print_table_start();
 php_info_print_table_header(2, â€œxhprof supportâ€, â€œenabledâ€);
 php_info_print_table_row(2, â€œVersionâ€, XHPROF_VERSION);
 php_info_print_table_end();
 DISPLAY_INI_ENTRIES();
}</li>
</ul>

<p>/**</p>
<ul>
  <li>Start XHProf profiling in hierarchical mode.
 *</li>
  <li>@param  long $flags  flags for hierarchical mode</li>
  <li>@return void</li>
  <li>
    <p>@author kannan
 <em>/
PHPè¯­è¨€ä¸­ xhprof_enableå‡½æ•°
//zif_xhprof_enable(zend_execute_data *execute_data, zval *return_value)
PHP_FUNCTION(xhprof_enable)
{
 long  xhprof_flags = 0;              /</em> XHProf flags <em>/
 zval *optional_array = NULL;         /</em> optional array arg: for future use */</p>

    <p>if (zend_parse_parameters(ZEND_NUM_ARGS(), â€œ|lzâ€, &amp;xhprof_flags, &amp;optional_array) == FAILURE) {
     return;
 }</p>

    <p>hp_get_ignored_functions_from_arg(optional_array);</p>

    <p>hp_begin(XHPROF_MODE_HIERARCHICAL, xhprof_flags);
}</p>
  </li>
</ul>

<p>/**</p>
<ul>
  <li>Stops XHProf from profiling in hierarchical mode anymore and returns the</li>
  <li>profile info.
 *</li>
  <li>@param  void</li>
  <li>@return array  hash-array of XHProfâ€™s profile info</li>
  <li>@author kannan, hzhao
 <em>/
PHPè¯­è¨€ä¸­ xhprof_disableå‡½æ•°
//zif_xhprof_disable(zend_execute_data *execute_data, zval *return_value)
PHP_FUNCTION(xhprof_disable)
{
 if (XHPROF_G(enabled)) {
     hp_stop();
     RETURN_ZVAL(&amp;XHPROF_G(stats_count), 1, 0);
 }
 /</em> else null is returned */
}</li>
</ul>

<p>/**</p>
<ul>
  <li>Start XHProf profiling in sampling mode.
 *</li>
  <li>@return void</li>
  <li>@author cjiang
 <em>/
PHPè¯­è¨€ä¸­ xhprof_sample_enableå‡½æ•°
//zif_xhprof_sample_enable(zend_execute_data *execute_data, zval *return_value)
PHP_FUNCTION(xhprof_sample_enable)
{
 long xhprof_flags = 0;    /</em> XHProf flags */
 hp_get_ignored_functions_from_arg(NULL);
 hp_begin(XHPROF_MODE_SAMPLED, xhprof_flags);
}</li>
</ul>

<p>/**</p>
<ul>
  <li>Stops XHProf from profiling in sampling mode anymore and returns the profile</li>
  <li>info.
 *</li>
  <li>@param  void</li>
  <li>@return array  hash-array of XHProfâ€™s profile info</li>
  <li>@author cjiang
 <em>/
PHPè¯­è¨€ä¸­ xhprof_sample_disableå‡½æ•°
//zif_xhprof_sample_disable(zend_execute_data *execute_data, zval *return_value)
PHP_FUNCTION(xhprof_sample_disable)
{
 if (XHPROF_G(enabled)) {
     hp_stop();
     RETURN_ZVAL(&amp;XHPROF_G(stats_count), 1, 0);
 }
  /</em> else null is returned */
}
è¿™ä¸ªæ‰©å±•çš„åŸºæœ¬æ¥å£å°±æ˜¯ä¸Šé¢è¿™äº›ä»£ç ï¼Œæ¥ä¸‹æ¥ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼Œæ€ä¹ˆæ”¶é›†æ€§èƒ½æ•°æ®çš„ã€‚</li>
</ul>

<p>è´´å‡ºä¸€æ®µPHPä»£ç </p>

<p>&lt;?php
//phpinfo();</p>

<table>
  <tbody>
    <tr>
      <td>xhprof_enable(XHPROF_FLAGS_NO_BUILTINS</td>
      <td>XHPROF_FLAGS_CPU</td>
      <td>XHPROF_FLAGS_MEMORY);</td>
    </tr>
  </tbody>
</table>

<p>aaa();</p>

<p>$xhprof_data = xhprof_disable();</p>

<p>print_r($xhprof_data);</p>

<p>function aaa()
{
	bbb();
}</p>

<p>function bbb()
{</p>

<p>}
æ”¶é›†æ•°æ®çš„è¿‡ç¨‹å…¶å®é’ˆå¯¹å‡½æ•°åµŒå¥—è°ƒç”¨é€’å½’æ”¶é›†çš„è¿‡ç¨‹ï¼Œxhprof_enableå¼€å¯çš„è¿™ä¸€è¡Œè§£ææˆ OPCODEï¼Œç„¶åæ‰§è¡Œä¹‹å‰ä»£ç†çš„hp_execute_exå‡½æ•°ï¼Œåˆå§‹åŒ–mainèŠ‚ç‚¹ï¼Œä¸‹é¢å°±ä»¥å›¾çš„å½¢å¼æ¥çœ‹ä¸‹å…·ä½“ç”Ÿæˆçš„ç»“æ„ï¼Œå’Œè°ƒç”¨é“¾ã€‚</p>

<p>åœ¨xhprof_enableÂ å’ŒÂ Â xhprof_disableÂ ä¹‹å‰çš„PHPä»£ç ï¼Œæ¯ä¸€è¡Œéƒ½ä¼šè¢«ç¿»è¯‘æˆOPCODEï¼Œéƒ½ä¼šæ‰§è¡Œhp_execute_exå‡½æ•°ã€‚</p>

<p>æ‰€ä»¥æ¯æ¬¡å¦‚æœæ‰§è¡Œçš„æ˜¯å‡½æ•°å°±ä¼šæ”¶é›†å¯¹åº”çš„æ€§èƒ½æ•°æ®
ZEND_DLEXPORT void hp_execute_ex (zend_execute_data *execute_data)
{
    if (!XHPROF_G(enabled)) {
        _zend_execute_ex(execute_data);
        return;
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char *func = NULL;
int hp_profile_flag = 1;
 
func = hp_get_function_name(execute_data);
 
if (!func) {
    _zend_execute_ex(execute_data);
    return;
}
 
zend_execute_data *real_execute_data = execute_data-&gt;prev_execute_data;
 
BEGIN_PROFILING(&amp;XHPROF_G(entries), func, hp_profile_flag, real_execute_data);
 
_zend_execute_ex(execute_data);
 
if (XHPROF_G(entries)) {
    END_PROFILING(&amp;XHPROF_G(entries), hp_profile_flag);
}
 
efree(func); } è¾“å‡ºï¼š
</code></pre></div></div>

<p>Array
(
    [aaa==&gt;bbb] =&gt; Array
        (
            [ct] =&gt; 1
            [wt] =&gt; 23
            [cpu] =&gt; 29
            [mu] =&gt; 832
            [pmu] =&gt; 0
        )</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[main()==&gt;aaa] =&gt; Array
    (
        [ct] =&gt; 1
        [wt] =&gt; 88
        [cpu] =&gt; 89
        [mu] =&gt; 1408
        [pmu] =&gt; 0
    )
 
[main()] =&gt; Array
    (
        [ct] =&gt; 1
        [wt] =&gt; 99
        [cpu] =&gt; 99
        [mu] =&gt; 1976
        [pmu] =&gt; 0
    )
</code></pre></div></div>

<p>)
xhprof_enable(XHPROF_FLAGS_NO_BUILTINS  | XHPROF_FLAGS_CPU | XHPROF_FLAGS_MEMORY);
è¿™ä¸ªå‡½æ•°ç›¸å½“äºæ‰§è¡Œäº†æ‰©å±•é‡Œé¢çš„ï¼Œè¿™ä¸ªå‡½æ•°ç›¸å½“è‡ªå·±é€ äº†ä¸€ä¸ªè™šæ‹Ÿçš„ main()èŠ‚ç‚¹ï¼Œ
æ¥å­˜å½“å‰è°ƒç”¨PHPå‡½æ•°çš„æ€§èƒ½æ•°æ®  ct wt mu pmuç­‰æ•°æ®</p>

<p>PHP_FUNCTION(xhprof_enable)
{
    long  xhprof_flags = 0;              /* XHProf flags <em>/
    zval *optional_array = NULL;         /</em> optional array arg: for future use */</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS(), "|lz", &amp;xhprof_flags, &amp;optional_array) == FAILURE) {
    return;
}
 
hp_get_ignored_functions_from_arg(optional_array);
//ä»¥mainä¸ºæ ¹èŠ‚ç‚¹å­˜å‚¨æ€§èƒ½æ•°æ®
hp_begin(XHPROF_MODE_HIERARCHICAL, xhprof_flags); }
</code></pre></div></div>

<p>static void hp_begin(long level, long xhprof_flags)
{
    if (!XHPROF_G(enabled)) {
        int hp_profile_flag = 1;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    XHPROF_G(enabled)      = 1;
    XHPROF_G(xhprof_flags) = (uint32)xhprof_flags;
    //å…ˆç»‘å®šæ¯ä¸ªå‡½æ•°å¼€å§‹ï¼Œç»“æŸçš„å›è°ƒå‡½æ•°ï¼Œç”¨æ¥è®°å½•å½“æ—¶çš„æ€§èƒ½ç‚¹æ•°æ®
    /* Initialize with the dummy mode first Having these dummy callbacks saves
     * us from checking if any of the callbacks are NULL everywhere. */
    XHPROF_G(mode_cb).init_cb     = hp_mode_dummy_init_cb;
    XHPROF_G(mode_cb).exit_cb     = hp_mode_dummy_exit_cb;
    XHPROF_G(mode_cb).begin_fn_cb = hp_mode_dummy_beginfn_cb;
    XHPROF_G(mode_cb).end_fn_cb   = hp_mode_dummy_endfn_cb;
 
    /* Register the appropriate callback functions Override just a subset of
    * all the callbacks is OK. */
    switch (level) {
        case XHPROF_MODE_HIERARCHICAL:
            XHPROF_G(mode_cb).begin_fn_cb = hp_mode_hier_beginfn_cb;
            XHPROF_G(mode_cb).end_fn_cb   = hp_mode_hier_endfn_cb;
            break;
        case XHPROF_MODE_SAMPLED:
            XHPROF_G(mode_cb).init_cb     = hp_mode_sampled_init_cb;
            XHPROF_G(mode_cb).begin_fn_cb = hp_mode_sampled_beginfn_cb;
            XHPROF_G(mode_cb).end_fn_cb   = hp_mode_sampled_endfn_cb;
            break;
    }
 
    /* one time initializations */
    hp_init_profiler_state(level);
 
    /* start profiling from fictitious main() */
    XHPROF_G(root) = estrdup(ROOT_SYMBOL);
 
    /* start profiling from fictitious main() */
    BEGIN_PROFILING(&amp;XHPROF_G(entries), XHPROF_G(root), hp_profile_flag, NULL);
} }
</code></pre></div></div>

<p>#define BEGIN_PROFILING(entries, symbol, profile_curr, execute_data)        <br />
do {                                                                     <br />
    /* Use a hash code to filter most of the string comparisons. <em>/     <br />
    uint8 hash_code  = hp_inline_hash(symbol);                          <br />
    profile_curr = !hp_ignore_entry_work(hash_code, symbol);                 <br />
    if (profile_curr) {                                                 <br />
        if (execute_data != NULL) {                                     <br />
            symbol = hp_get_trace_callback(symbol, execute_data); <br />
        }                                                               <br />
        hp_entry_t *cur_entry = hp_fast_alloc_hprof_entry();            <br />
        (cur_entry)-&gt;hash_code = hash_code;                             <br />
        (cur_entry)-&gt;name_hprof = symbol;                               <br />
        (cur_entry)-&gt;prev_hprof = (</em>(entries));                         <br />
        /* Call the universal callback <em>/                               <br />
        hp_mode_common_beginfn((entries), (cur_entry));                 <br />
        /</em> Call the modeâ€™s beginfn callback <em>/                          <br />
        XHPROF_G(mode_cb).begin_fn_cb((entries), (cur_entry));         <br />
        /</em> Update entries linked list <em>/                                <br />
        (</em>(entries)) = (cur_entry);                                     <br />
    }                                                               <br />
} while (0)</p>

<p>begin_fn_cb
||   è¿™ä¸ªå°±æ˜¯è®°å½•å½“å‰å‡½æ•°å¼€å§‹ï¼Œè®°å½•çš„CPUå’Œå†…å­˜å¤§å°
void hp_mode_hier_beginfn_cb(hp_entry_t <em>*entries, hp_entry_t  *current)
{
    /</em> Get start tsc counter */
    current-&gt;tsc_start = cycle_timer();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* Get CPU usage */
if (XHPROF_G(xhprof_flags) &amp; XHPROF_FLAGS_CPU) {
    current-&gt;cpu_start = cpu_timer();
}
 
/* Get memory usage */
if (XHPROF_G(xhprof_flags) &amp; XHPROF_FLAGS_MEMORY) {
    current-&gt;mu_start_hprof  = zend_memory_usage(0);
    current-&gt;pmu_start_hprof = zend_memory_peak_usage(0);
} } Â 
</code></pre></div></div>

<p>$xhprof_data = xhprof_disable(); ç»“æŸæ”¶é›†æ•°æ®
PHPè¿™ä¸ªå‡½æ•°å¯¹åº”çš„å°±æ˜¯æ‰©å±•é‡Œä¸‹é¢çš„è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯ç”¨æ¥åœæ­¢æ”¶é›†ï¼Œå¹¶ä¸”RETURN_ZVAL(&amp;XHPROF_G(stats_count), 1, 0); 
è¿”å›å·²ç»æ”¶é›†åˆ°çš„æ•°æ®ï¼Œ
æ•°æ®æ ¼å¼åœ¨å†…æ ¸é‡Œé¢æ˜¯ä¸€ä¸ªäºŒçº§HASHTABLEï¼Œå¯¹åº”PHPæ˜¯ä¸€ä¸ªäºŒç»´æ•°ç»„</p>

<p>è¿™ä¸ªç»“æŸè¿‡ç¨‹æ˜¯å¯¹åº”è¿™ä¹‹å‰xhprof_enableçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯å¯¹mainè™šæ‹Ÿçš„èŠ‚ç‚¹åšå›æºå¤„ç†ã€‚
//zif_xhprof_disable(zend_execute_data <em>execute_data, zval *return_value)
PHP_FUNCTION(xhprof_disable)
{
    if (XHPROF_G(enabled)) {
        hp_stop();
        RETURN_ZVAL(&amp;XHPROF_G(stats_count), 1, 0);
    }
    /</em> else null is returned */
}</p>

<p>static void hp_stop()
{
    int   hp_profile_flag = 1;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* End any unfinished calls */
while (XHPROF_G(entries)) {
    END_PROFILING(&amp;XHPROF_G(entries), hp_profile_flag);
}
 
if (XHPROF_G(root)) {
    efree(XHPROF_G(root));
    XHPROF_G(root) = NULL;
}
 
/* Stop profiling */
XHPROF_G(enabled) = 0; } GDBè°ƒè¯•çš„è¿‡ç¨‹
</code></pre></div></div>

<p>(gdb) p *xhprof_globals.entries
$33 = {name_hprof = 0x7ffff1279230 â€œbbbâ€, rlvl_hprof = 0, tsc_start = 594813346976, cpu_start = 56435, mu_start_hprof = 390296, pmu_start_hprof = 427056, prev_hprof = 0x1aad3b0, hash_code = 224 â€˜\340â€™}
(gdb) p *xhprof_globals.entries-&gt;prev_hprof
$34 = {name_hprof = 0x7ffff12791e0 â€œaaaâ€, rlvl_hprof = 0, tsc_start = 594308864680, cpu_start = 55591, mu_start_hprof = 390216, pmu_start_hprof = 427056, prev_hprof = 0x1aad360, hash_code = 104 â€˜hâ€™}
(gdb) p *xhprof_globals.entries-&gt;prev_hprof-&gt;prev_hprof
$35 = {name_hprof = 0x7ffff1202058 â€œmain()â€, rlvl_hprof = 0, tsc_start = 594156065161, cpu_start = 54939, mu_start_hprof = 390136, pmu_start_hprof = 427056, prev_hprof = 0x0, hash_code = 32 â€˜ â€˜}</p>

<p>(gdb) p *xhprof_globals.entries-&gt;prev_hprof-&gt;prev_hprof-&gt;prev_hprof</p>
:ET