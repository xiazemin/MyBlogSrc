I"w<p>./configure â€“with-php-config=/usr/local/bin/php-config ./configure â€“enable-debug</p>

<p>checking for bison versionâ€¦ ./configure: line 5574: -z: command not found
2.3
configure: error: bison 3.0.0 or later is required to generate PHP parsers (excluded versions: none).
localhost:php-src didi$ git branch</p>

<p>brew install bison</p>

<p>checking for bison versionâ€¦ ./configure: line 5574: -z: command not found
3.6.2 (ok)
checking for re2câ€¦ no
configure: error: re2c 0.13.4 is required to generate PHP lexers.</p>

<p>brew install re2c</p>

<p>ç”Ÿæˆäº†Zend/zend_config.h</p>

<p>/Users/didi/PhpstormProjects/c/php-src/Zend/zend_config.w32.h:23:10: fatal error: â€˜../main/config.w32.hâ€™ file not found
#include &lt;../main/config.w32.h&gt;</p>

<p>In file included from /usr/include/php/main/php.h:35:</p>

<p>/usr/include/php/Zend/zend.h:51:11: fatal error: â€˜zend_config.hâ€™ file not found</p>

<h1 id="include-">include <zend_config.h></zend_config.h></h1>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      ^
</code></pre></div></div>

<p>1 error generated.</p>

<p>make: *** [redis.lo] Error 1
ä¸¤ä¸ªé—®é¢˜éƒ½è§£å†³äº†</p>

<p>cd ext/alae/cmake-build-debug/</p>

<p>make</p>

<p>/Users/didi/PhpstormProjects/c/php-src/Zend/zend_virtual_cwd.h:22:10: fatal error: â€˜TSRM.hâ€™ file not found
#include â€œTSRM.hâ€
<!-- more -->
https://l1905.github.io/php/2020/02/28/macos-pecl-xdebug-mongodb/</p>

<p>CMakefileList.txtåŠ ä¸Š</p>

<p>include_directories(${PHP_SOURCE}/TSRM)
é—®é¢˜è§£å†³</p>

<p>ld: symbol(s) not found for architecture x86_64
clang: error: linker command failed with exit code 1 (use -v to see invocation)
make[2]: <em>** [alae] Error 1
make[1]: **</em> [CMakeFiles/alae.dir/all] Error 2
make: *** [all] Error 2</p>

<p>https://blog.51cto.com/peterxu/1795036</p>

<p>SET(CMAKE_C_COMPILER g++)</p>

<p>SET(CMAKE_MODULE_LINKER_FLAGS â€œ-lstdc++.8â€)</p>

<p>SET(CMAKE_SHARED_LINKER_FLAGS â€œ-lstdc++.8â€)
SET(CMAKE_EXE_LINKER_FLAGS â€œ-lstdc++.8â€)
SET(CMAKE_STATIC_LINKER_FLAGS â€œ-lstdc++.8â€)</p>

<p>https://blog.csdn.net/esrrhs/article/details/52700332
https://blog.csdn.net/m0_38130105/article/details/84234774</p>

<p>32 warnings and 5 errors generated.
make[2]: <em>** [CMakeFiles/alae.dir/alae.c.o] Error 1
make[1]: **</em> [CMakeFiles/alae.dir/all] Error 2
make: *** [all] Error 2</p>

<p>/Users/didi/PhpstormProjects/c/php-src/ext/alae/alae.c:624:21: error: use of undeclared identifier â€˜EX_CONSTANTâ€™</p>

<p>7.2ä¸å†æ”¯æŒ7.1çš„è¿™ä¸ªå®</p>

<p>/* constant in currently executed function */
#define EX_CONSTANT(node) <br />
	RT_CONSTANT_EX(EX_LITERALS(), node)</p>

<p>/* run-time constant */</p>
<h1 id="define-rt_constant_exbase-node-">define RT_CONSTANT_EX(base, node) \</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>((zval*)(((char*)(base)) + (node).constant))
</code></pre></div></div>

<h1 id="define-ex_literals-">define EX_LITERALS() \</h1>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EX(literals)
</code></pre></div></div>

<p>error: no member named â€˜literalsâ€™ in â€˜_zend_execute_dataâ€™
    dim = EX_CONSTANT(opline-&gt;op2);</p>

<p>1ã€zend_execute_data:opcodeæ‰§è¡ŒæœŸé—´éå¸¸é‡è¦çš„ä¸€ä¸ªç»“æ„ï¼Œè®°å½•ç€å½“å‰æ‰§è¡Œçš„zend_opã€è¿”å›å€¼ã€æ‰€å±å‡½æ•°/å¯¹è±¡æŒ‡é’ˆã€ç¬¦å·è¡¨ç­‰
struct _zend_execute_data {
    const zend_op       <em>opline;           /</em> executed opline æŒ‡å‘ç¬¬ä¸€æ¡opcode <em>/
    zend_execute_data   *call;             /</em> current call                   <em>/
    zval                *return_value;
    zend_function       *func;             /</em> executed op_array              */
    zval                 This;
#if ZEND_EX_USE_RUN_TIME_CACHE
    void               **run_time_cache;
#endif
#if ZEND_EX_USE_LITERALS
    zval                *literals;
#endif
    zend_class_entry    *called_scope;
    zend_execute_data   *prev_execute_data;
    zend_array          *symbol_table;
};</p>

<p>2ã€zend_op:zendæŒ‡ä»¤
//zend.compile.h
struct _zend_op {
    const void *handler;  //è¯¥æŒ‡ä»¤è°ƒç”¨çš„å¤„ç†å‡½æ•°
    znode_op op1; //æ“ä½œæ•°1
    znode_op op2; //æ“ä½œæ•°2
    znode_op result; 
    uint32_t extended_value;
    uint32_t lineno;
    zend_uchar opcode; //opcodeæŒ‡ä»¤ç¼–å·
    zend_uchar op1_type; //æ“ä½œæ•°1ç±»å‹
    zend_uchar op2_type; 
    zend_uchar result_type;
};</p>

<p>7.1æœ‰è¿™ä¸ªç»“æ„7.2æ²¡æœ‰äº†</p>

<h1 id="define-ex_literals">define EX_LITERALS()</h1>

<p>error: cannot initialize a parameter of type â€˜zend_object *â€™
      (aka â€˜_zend_object *â€™) with an lvalue of type â€˜zval *â€™ (aka â€˜_zval_struct *â€™)</p>

<p>https://segmentfault.com/a/1190000004340427
https://wiki.jikexueyuan.com/project/extending-embedding-php/2.html</p>

<p>åœ¨PHPæºç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è§åˆ°è¯¸å¦‚PHPAPI ZEND_API TSRM_APIç­‰xxx_API(å½“ç„¶è¿˜æœ‰å…¶ä»–æ ¼å¼çš„)è¿™æ ·çš„å®</p>

<p>å…³äºå®ƒä»¬çš„å®šä¹‰éƒ½æ˜¯ç±»ä¼¼äº</p>

<p>#if defined(<strong>GNUC</strong>) &amp;&amp; <strong>GNUC</strong> &gt;= 4</p>
<h1 id="define-zend_api-attribute-visibilitydefault">define ZEND_API <strong>attribute</strong> ((visibility(â€œdefaultâ€)))</h1>
<p>#else</p>
<h1 id="define-zend_api">define ZEND_API</h1>
<p>#endif</p>

<p>ä¸€ã€é¢„å®šä¹‰__GNUC__å®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1 __GNUC__ æ˜¯gccç¼–è¯‘å™¨ç¼–è¯‘ä»£ç æ—¶é¢„å®šä¹‰çš„ä¸€ä¸ªå®ã€‚éœ€è¦é’ˆå¯¹gccç¼–å†™ä»£ç æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨è¯¥å®è¿›è¡Œæ¡ä»¶ç¼–è¯‘ã€‚

2 __GNUC__ çš„å€¼è¡¨ç¤ºgccçš„ç‰ˆæœ¬ã€‚éœ€è¦é’ˆå¯¹gccç‰¹å®šç‰ˆæœ¬ç¼–å†™ä»£ç æ—¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥å®è¿›è¡Œæ¡ä»¶ç¼–è¯‘ã€‚

3 __GNUC__ çš„ç±»å‹æ˜¯â€œintâ€ï¼Œè¯¥å®è¢«æ‰©å±•åï¼Œ å¾—åˆ°çš„æ˜¯æ•´æ•°å­—é¢å€¼ã€‚å¯ä»¥é€šè¿‡ä»…é¢„å¤„ç†ï¼ŒæŸ¥çœ‹å®æ‰©å±•åçš„æ–‡æœ¬ã€‚
</code></pre></div></div>

<p>æ‰€ä»¥æˆ‘ä»¬çŸ¥é“ZEND_APIå®šä¹‰ä¸ºï¼š</p>

<p>å¦‚æœç¼–è¯‘å™¨ä½¿ç”¨çš„æ˜¯gccä¸”GNUCçš„ç‰ˆæœ¬å¤§äºç­‰äº4,åˆ™å®šä¹‰ZEND_APIä¸º <strong>attribute</strong> ((visibility(â€œdefaultâ€)))</p>

<p>é‚£__attribute__åˆ°åº•æ˜¯å¹²å˜›çš„ï¼Œæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p>

<p>æŸ¥é˜…å…³äºCçš„ç›¸å…³èµ„æ–™å¾—å‡ºç»“è®º:</p>

<p><strong>attribute</strong> ((visibility(â€œdefaultâ€)))å®šä¹‰çš„å‡½æ•°éƒ½æ˜¯å¯è§çš„</p>

<p>GCC æœ‰ä¸ªvisibilityå±æ€§, è¯¥å±æ€§æ˜¯è¯´, å¯ç”¨è¿™ä¸ªå±æ€§:</p>

<ol>
  <li>å½“-fvisibility=hiddenæ—¶</li>
</ol>

<p>åŠ¨æ€åº“ä¸­çš„å‡½æ•°é»˜è®¤æ˜¯è¢«éšè—çš„å³ hidden. é™¤éæ˜¾ç¤ºå£°æ˜ä¸º__attribute__((visibility(â€œdefaultâ€))).</p>

<ol>
  <li>å½“-fvisibility=defaultæ—¶</li>
</ol>

<p>Â åŠ¨æ€åº“ä¸­çš„å‡½æ•°é»˜è®¤æ˜¯å¯è§çš„.é™¤éæ˜¾ç¤ºå£°æ˜ä¸º__attribute__((visibility(â€œhiddenâ€))).</p>

<p>$ /Library/Developer/CommandLineTools/usr/bin/ld -v
@(#)PROGRAM:ld  PROJECT:ld64-274.2
configured to support archs: armv6 armv7 armv7s arm64 i386 x86_64 x86_64h armv6m armv7k armv7m armv7em (tvOS)
LTO support using: LLVM version 8.0.0, (clang-800.0.42.1)
TAPI support using: Apple TAPI version 1.30</p>

:ET