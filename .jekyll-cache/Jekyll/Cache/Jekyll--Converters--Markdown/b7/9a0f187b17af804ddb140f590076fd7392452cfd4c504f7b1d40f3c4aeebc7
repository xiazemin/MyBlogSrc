I"Î?<p>è®°åˆ†æ¿æ˜¯ä¿å­˜FPMæ± åŠå…¶å·¥ä½œçº¿ç¨‹çŠ¶æ€çš„ç»“æ„ã€‚å®ƒæ˜¯åœ¨å…±äº«å†…å­˜ä¸­åˆ›å»ºçš„ï¼Œå¦‚æœæ— æ³•åˆ†é…è¯¥å†…å­˜ï¼Œåˆ™ä¼šè®°å½•é”™è¯¯ã€‚</p>

<p>ä»€ä¹ˆæ˜¯fpmé”™è¯¯æ—¥å¿—ä¸­çš„php-fpmè­¦å‘Šâ€œæ— æ³•è·å–è®°åˆ†ç‰Œâ€ï¼Ÿä»¥åŠå¦‚ä½•è§£å†³ï¼Ÿ</p>

<p>tail -f /var/log/php-fpm.log
[08-Oct-2014 03:36:36] WARNING: failed to acquire scoreboard</p>

<p>http://blog.morysky.info/2016/php-fpm/
https://stackoverflow.com/questions/26255739/what-is-php-fpm-warning-failed-to-acquire-scoreboard
<!-- more --></p>

<p>pm_scoreboard(ä»¥ä¸‹ç®€ç§°scoreboardæ¨¡å—)æ˜¯PHP-FPMæ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œæºç ä½äºsapi/fpm/fpm_scoreboard.cã€‚ä»å­—é¢æ„æ€ç†è§£æ˜¯ä¸€ä¸ªâ€è®°åˆ†å™¨â€ï¼Œå®é™…ä¸Šï¼Œæ˜¯FPMå†…ç½®çš„ä¸€ä¸ªworkerè¿›ç¨‹ç»Ÿè®¡åŠŸèƒ½æ¨¡å—ã€‚ç½‘ä¸Šå…³äºè¿™æ–¹é¢çš„ä»‹ç»èµ„æ–™ç¨€ç¼ºï¼Œåœ¨é˜…è¯»è¿™å—åŠŸèƒ½çš„æºç è¿‡ç¨‹ä¸­ä¸€æ³¢ä¸‰æŠ˜ã€‚ç»è¿‡é•¿æ—¶é—´åœ°åå¤é˜…è¯»åŠæ¨æ•²ï¼Œè„‘æµ·ä¸­å·²ç»æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è½®å»“ã€‚</p>

<p>scoreboardæ¨¡å—å®šä¹‰fpm_scoreboard_så’Œfpm_scoreboard_proc_sä¸¤ç§æ•°æ®ç»“æ„ã€‚</p>

<p>struct fpm_scoreboard_s {
    union {
        atomic_t lock;
        char dummy[16];
    };//é”çŠ¶æ€
    char pool[32];//å®ä¾‹åç§° ä¾‹å¦‚ï¼š[www]
    int pm; //PMè¿è¡Œæ¨¡å¼
    time_t start_epoch; //å¼€å§‹æ—¶é—´
    int idle;//procsçš„ç©ºé—²æ•°
    int active;//procsçš„ä½¿ç”¨æ•°
    int active_max; //æœ€å¤§procsä½¿ç”¨æ•°
    unsigned long int requests;
    unsigned int max_children_reached; //åˆ°è¾¾æœ€å¤§è¿›ç¨‹æ•°é™åˆ¶çš„æ¬¡æ•°
    int lq; //å½“å‰listen queueçš„è¯·æ±‚æ•°(acceptæ“ä½œï¼Œå¯ä»¥è¿‡tcpi_unackedæˆ–getsocketoptè·å–)
    int lq_max;//listen queueå¤§å°
    unsigned int lq_len;
    unsigned int nprocs; //procsæ€»æ•°
    int free_proc; //ä»procsåˆ—è¡¨éå†ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„å¼€å§‹ä¸‹æ ‡
    struct fpm_scoreboard_proc_s <em>procs[]; //åˆ—è¡¨
};
struct fpm_scoreboard_proc_s {
    union {
        atomic_t lock;
        char dummy[16];
    };//é”çŠ¶æ€
    int used; //ä½¿ç”¨æ ‡è¯† 0=æœªä½¿ç”¨ 1=æ­£åœ¨ä½¿ç”¨
    time_t start_epoch; //ä½¿ç”¨å¼€å§‹æ—¶é—´
    pid_t pid; //è¿›ç¨‹id
    unsigned long requests; //å¤„ç†è¯·æ±‚æ¬¡æ•°
    enum fpm_request_stage_e request_stage; //å¤„ç†è¯·æ±‚é˜¶æ®µ
    struct timeval accepted; //acceptè¯·æ±‚æ—¶é—´
    struct timeval duration; //è„šæœ¬æ€»æ‰§è¡Œæ—¶é—´
    time_t accepted_epoch;//acceptè¯·æ±‚æ—¶é—´æˆ³(ç§’)
    struct timeval tv; //æ´»è·ƒæ—¶é—´
    char request_uri[128]; //è¯·æ±‚è·¯å¾„
    char query_string[512]; //è¯·æ±‚å‚æ•°
    char request_method[16]; //è¯·æ±‚æ–¹å¼
    size_t content_length; //è¯·æ±‚å†…å®¹é•¿åº¦ /</em> used with POST only */
    char script_filename[256];//è„šæœ¬åç§°
    char auth_user[32];
#ifdef HAVE_TIMES
    struct tms cpu_accepted;
    struct timeval cpu_duration;
    struct tms last_request_cpu;
    struct timeval last_request_cpu_duration;
#endif
    size_t memory;//è„šæœ¬å ç”¨çš„å†…å­˜å¤§å°
};</p>

<p>fpm_scoreboard_sç»“æ„è®°å½•FPMæ‰€æœ‰workerè¿›ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå…¶ä¸­*procsæ•°ç»„ç»“æ„ä¿å­˜å„workerè¿›ç¨‹ç»Ÿè®¡å•å…ƒã€‚fpm_scoreboard_proc_sè®°å½•workerè¿›ç¨‹çš„è¿è¡ŒçŠ¶æ€ä¿¡æ¯(åæ–‡ç§°ä¸ºç»Ÿè®¡å•å…ƒ)ã€‚</p>

<p>æ ¹æ®ä¸Šé¢ä»£ç çš„æ³¨é‡Šå¯ä»¥å¾ˆå®¹æ˜“åœ°ç†è§£å…¶å±æ€§çš„å«ä¹‰ï¼Œåœ¨è¿™å°±ä¸å†é€ä¸€è¯´æ˜ã€‚</p>

<p>ä¸‹é¢å°†é‡ç‚¹ä»‹ç»scoreboardçš„è¿è¡Œæµç¨‹ã€‚</p>

<p>scoreboardæ¨¡å—åˆå§‹åŒ–</p>

<p>FPMå†…éƒ¨é€šè¿‡æ‰§è¡Œfpm_init()-&gt;fpm_scoreboard_init_main()æ¥å®Œæˆscoreboardæ¨¡å—çš„æ“ä½œã€‚</p>

<p>int fpm_scoreboard_init_main()
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    wp-&gt;scoreboard = fpm_shm_alloc(sizeof(struct fpm_scoreboard_s) + (wp-&gt;config-&gt;pm_max_children - 1) * sizeof(struct fpm_scoreboard_proc_s *));
    if (!wp-&gt;scoreboard) {
        return -1;
    }
    wp-&gt;scoreboard-&gt;nprocs = wp-&gt;config-&gt;pm_max_children;
    for (i = 0; i &lt; wp-&gt;scoreboard-&gt;nprocs; i++) {
        wp-&gt;scoreboard-&gt;procs[i] = fpm_shm_alloc(sizeof(struct fpm_scoreboard_proc_s));
        if (!wp-&gt;scoreboard-&gt;procs[i]) {
            return -1;
        }
        memset(wp-&gt;scoreboard-&gt;procs[i], 0, sizeof(struct fpm_scoreboard_proc_s));
    }
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
}</p>

<p>fpm_scoreboard_init_main()å‡½æ•°è°ƒç”¨fpm_shm_alloc()ä¸º wp-&gt;scoreboard åˆ†é…ç©ºé—´ï¼Œå¤§å°æ ¹æ® wp-&gt;config-&gt;pm_max_children å‚æ•°è®¡ç®—ã€‚wp-&gt;config-&gt;pm_max_childrenå‚æ•°å¯¹åº”php-fpm.confçš„pm.max_childrené…ç½®é¡¹ï¼Œè¡¨ç¤ºFPMå…è®¸å¯åŠ¨çš„æœ€å¤§workerè¿›ç¨‹æ•°ã€‚ä»è€Œä¿è¯æ¯ä¸ªworkerè¿›ç¨‹éƒ½èƒ½åˆ†é…åˆ°ä¸€ä¸ªå¯ç”¨çš„ç»Ÿè®¡å•å…ƒã€‚ç„¶åå†å¯¹wp-&gt;scoreboard-&gt;procsçš„æ¯ä¸ªç»Ÿè®¡å•å…ƒè¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<p>ä¸Šé¢å·²ç»åˆå§‹åŒ–ç»Ÿè®¡å•å…ƒåˆ—è¡¨ã€‚é‚£è¿™äº›ç»Ÿè®¡å•å…ƒæ˜¯å¦‚ä½•åˆ†é…ç»™æ¯ä¸€ä¸ªworkerè¿›ç¨‹ï¼Ÿ</p>

<p>scoreboardç»Ÿè®¡å•å…ƒåˆ†é…</p>

<p>ä»æºç (fpm_children.c)å¯ä»¥çœ‹åˆ°ï¼ŒFPMæ¯æ¬¡è°ƒç”¨fork()æ–°workerè¿›ç¨‹ä¹‹å‰ï¼Œç³»ç»Ÿéƒ½ä¼šæ‰§è¡Œfpm_resources_prepare()å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>

<p>static struct fpm_child_s *fpm_resources_prepare(struct fpm_worker_pool_s *wp)
{
    struct fpm_child_s *c;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c = fpm_child_alloc();
//...çœç•¥éƒ¨åˆ†ä»£ç ...
//æ­¤æ—¶c-&gt;scoreboard_i=-1
if (0 &gt; fpm_scoreboard_proc_alloc(wp-&gt;scoreboard, &amp;c-&gt;scoreboard_i)) {
    fpm_stdio_discard_pipes(c);
    fpm_child_free(c);
    return 0;
}
return c; }
</code></pre></div></div>

<p>fpm_resources_prepare()å‡½æ•°ï¼šé¦–å…ˆï¼Œåˆå§‹åŒ–childå¯¹è±¡ï¼›ç„¶åè°ƒç”¨fpm_scoreboard_proc_alloc()å‡½æ•°ã€‚ç»§ç»­è¿½è¸ªfpm_scoreboard_proc_alloc()å‡½æ•°ä»£ç ã€‚</p>

<p>int fpm_scoreboard_proc_alloc(struct fpm_scoreboard_s *scoreboard, int *child_index)
{
    int i = -1;
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    if (scoreboard-&gt;free_proc &gt;= 0 &amp;&amp; scoreboard-&gt;free_proc &lt; scoreboard-&gt;nprocs) {
        if (scoreboard-&gt;procs[scoreboard-&gt;free_proc] &amp;&amp; !scoreboard-&gt;procs[scoreboard-&gt;free_proc]-&gt;used) {
            i = scoreboard-&gt;free_proc;
        }
    }
    if (i &lt; 0) { 
        for (i = 0; i &lt; scoreboard-&gt;nprocs; i++) {
            if (scoreboard-&gt;procs[i] &amp;&amp; !scoreboard-&gt;procs[i]-&gt;used) {
                break;
            }
        }
    }
    if (i &lt; 0 || i &gt;= scoreboard-&gt;nprocs) {
        return -1;
    }
    //æ‰“ä¸Šâ€œä½¿ç”¨â€æ ‡è®°
    scoreboard-&gt;procs[i]-&gt;used = 1;
    *child_index = i;
    //é‡ç½®å¯»æ‰¾ä¸‹ä¸€ä¸ªç©ºé—²å•å…ƒçš„èµ·å§‹ä¸‹æ ‡
    if (i + 1 &gt;= scoreboard-&gt;nprocs) {
        scoreboard-&gt;free_proc = 0;
    } else {
        scoreboard-&gt;free_proc = i + 1;
    }
    return 0;
}</p>

<p>fpm_scoreboard_proc_alloc()å‡½æ•°çš„ä»£ç æ¯”è¾ƒå®¹æ˜“è¯»æ‡‚ã€‚é¦–å…ˆåˆ¤æ–­scoreboard-&gt;free_procä½ç½®å¯¹åº”çš„å…ƒç´ æ˜¯å¦å¯ç”¨ï¼›å¦‚æœä¸å¯ç”¨ï¼Œåˆ™ç»§ç»­éå†scoreboard-&gt;nprocsæŸ¥æ‰¾å¯ç”¨çš„å…ƒç´ ï¼›å¦‚æœæ‰¾åˆ°ï¼Œåˆ™ä¿®æ”¹è¯¥å…ƒç´ çš„usedæ ‡è¯†ï¼Œå¹¶é‡ç½®scoreboard-&gt;free_procå±æ€§å€¼ã€‚</p>

<p>ç»“åˆä¸Šé¢ä¸¤ä¸ªå‡½æ•°ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºfpm_resources_prepare()çš„åŠŸèƒ½æ˜¯ä¸ºæ¯ä¸ªæ–°çš„workerè¿›ç¨‹åˆ†é…ä¸€ä¸ªå¯ç”¨çš„ç»Ÿè®¡å•å…ƒã€‚</p>

<p>æˆ‘ä»¬å·²ç»çŸ¥é“workerè¿›ç¨‹ç»Ÿè®¡å•å…ƒçš„åˆ†é…æµç¨‹ï¼Œé‚£è¿™äº›ç»Ÿè®¡å•å…ƒåœ¨workerè¿›ç¨‹æ˜¯å¦‚ä½•è¿ç”¨çš„ï¼Ÿæœ‰å“ªäº›åŠŸèƒ½æˆ–è€…æ¨¡å—å·²ä½¿ç”¨ï¼Ÿ</p>

<p>scoreboardç»Ÿè®¡å•å…ƒè¿ç”¨</p>

<p>åœ¨ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£scoreboardæ¨¡å—çš„fpm_scoreboard_update()ã€fpm_scoreboard_proc_acquire()ã€fpm_scoreboard_proc_release()ä¸‰ä¸ªå‡½æ•°çš„åŠŸèƒ½ã€‚</p>

<p>void fpm_scoreboard_update(int idle, int active, int lq, int lq_len, int requests, int max_children_reached, int action, struct fpm_scoreboard_s *scoreboard)
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    fpm_spinlock(&amp;scoreboard-&gt;lock, 0);
    if (action == FPM_SCOREBOARD_ACTION_SET) {
        if (idle &gt;= 0) {
            scoreboard-&gt;idle = idle;
        }
        if (active &gt;= 0) {
            scoreboard-&gt;active = active;
        }
        //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    } else {
        if (scoreboard-&gt;idle + idle &gt; 0) {
            scoreboard-&gt;idle += idle;
        } else {
            scoreboard-&gt;idle = 0;
        }
        if (scoreboard-&gt;active + active &gt; 0) {
            scoreboard-&gt;active += active;
        } else {
            scoreboard-&gt;active = 0;
        }
        //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    }
    if (scoreboard-&gt;active &gt; scoreboard-&gt;active_max) {
        scoreboard-&gt;active_max = scoreboard-&gt;active;
    }
    fpm_unlock(scoreboard-&gt;lock);
}</p>

<p>fpm_scoreboard_update()ï¼šä¿®æ”¹wp-&gt;scoreboardå„å±æ€§å€¼ï¼Œè¯¥å‡½æ•°å†…éƒ¨å¼•ç”¨â€é”â€æœºåˆ¶æ¥ä¿è¯æ•°æ®çš„åŸå­æ€§ã€‚actionæœ‰ä¸¤ä¸ªå€¼FPM_SCOREBOARD_ACTION_SETå’ŒFPM_SCOREBOARD_ACTION_INCã€‚å½“action=FPM_SCOREBOARD_ACTION_SET,è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé‡ç½®æ“ä½œã€‚å½“action=FPM_SCOREBOARD_ACTION_INCæ—¶ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªæ±‚å’Œæ“ä½œã€‚</p>

<p>struct fpm_scoreboard_proc_s *fpm_scoreboard_proc_acquire(struct fpm_scoreboard_s *scoreboard, int child_index, int nohang)
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc = fpm_scoreboard_proc_get(scoreboard, child_index);
    if (!proc) {
        return NULL;
    }
    //è¯·æ±‚é”
    if (!fpm_spinlock(&amp;proc-&gt;lock, nohang)) {
        return NULL;
    }
    return proc;
}
struct fpm_scoreboard_proc_s *fpm_scoreboard_proc_get(struct fpm_scoreboard_s *scoreboard, int child_index)
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    return scoreboard-&gt;procs[child_index];
}</p>

<p>fpm_scoreboard_proc_acquire()ï¼šè·å–ç»Ÿè®¡å•å…ƒ(wp-&gt;scoreboard-&gt;procs[i]),å¹¶è¯·æ±‚å¯¹è±¡é”ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œçš„â€é”â€ä¸`fpm_scoreboard_update()çš„â€é”â€ä¸æ˜¯åŒä¸€ä¸ªã€‚</p>

<p>//é‡Šæ”¾å¯¹è±¡é”
void fpm_scoreboard_proc_release(struct fpm_scoreboard_proc_s <em>proc) /</em> {{{ */
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc-&gt;lock = 0;
}</p>

<p>fpm_scoreboard_proc_release()ï¼šé‡Šæ”¾å¯¹è±¡é”ã€‚</p>

<p>å›åˆ°åˆšæ‰é‚£ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ç»§ç»­åˆ†æã€‚workerè¿›ç¨‹å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„å®Œæ•´æµç¨‹å…±åˆ†ä¸º5ä¸ªé˜¶æ®µã€‚å¦‚ä¸‹ã€‚</p>

<p>é˜¶æ®µ	å¤‡æ³¨
FPM_REQUEST_ACCEPTING	ç©ºé—²çŠ¶æ€(ç­‰å¾…è¯·æ±‚)
FPM_REQUEST_READING_HEADERS	è¯»å–å¤´ä¿¡æ¯
FPM_REQUEST_INFO	è·å–è¯·æ±‚ä¿¡æ¯
FPM_REQUEST_EXECUTING	æ‰§è¡ŒçŠ¶æ€
FPM_REQUEST_END	è¯·æ±‚ç»“æŸçŠ¶æ€</p>
<ol>
  <li>æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚é˜¶æ®µ,æ‰§è¡Œæµç¨‹ï¼šfpm_request_accepting().</li>
</ol>

<p>void fpm_request_accepting(){
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc = fpm_scoreboard_proc_acquire(NULL, -1, 0);
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc-&gt;request_stage = FPM_REQUEST_ACCEPTING;
    proc-&gt;tv = now;
    fpm_scoreboard_proc_release(proc);
    /* idle++, activeâ€“ */
    fpm_scoreboard_update(1, -1, 0, 0, 0, 0, FPM_SCOREBOARD_ACTION_INC, NULL);
}</p>

<p>fpm_scoreboard_proc_acquire()å¾—åˆ°ç®¡ç†è¯¥workerè¿›ç¨‹çŠ¶æ€çš„ç»Ÿè®¡å•å…ƒï¼Œç„¶åä¿®æ”¹ç»Ÿè®¡å•å…ƒ(wp-&gt;scoreboard-&gt;procs[i])çš„request_stageåŠtvå±æ€§å€¼ï¼Œæœ€åè°ƒç”¨fpm_scoreboard_updateä¿®æ”¹wp-&gt;scoreboardç»Ÿè®¡ä¿¡æ¯ã€‚</p>
<ol>
  <li>ä»FASTCGIè¯»å–å®¢æˆ·ç«¯è¯·æ±‚å¤´é˜¶æ®µ,æ‰§è¡Œæµç¨‹ï¼šfpm_request_reading_headers().</li>
</ol>

<p>void fpm_request_reading_headers()
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc = fpm_scoreboard_proc_acquire(NULL, -1, 0);
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc-&gt;request_stage = FPM_REQUEST_READING_HEADERS;
    //è®°å½•å½“å‰æ—¶é—´
    proc-&gt;tv = now;
    proc-&gt;accepted = now;
    proc-&gt;accepted_epoch = now_epoch;
#ifdef HAVE_TIMES
    proc-&gt;cpu_accepted = cpu;
#endif
    proc-&gt;requests++;
    proc-&gt;request_uri[0] = â€˜\0â€™;
    proc-&gt;request_method[0] = â€˜\0â€™;
    proc-&gt;script_filename[0] = â€˜\0â€™;
    proc-&gt;query_string[0] = â€˜\0â€™;
    proc-&gt;query_string[0] = â€˜\0â€™;
    proc-&gt;auth_user[0] = â€˜\0â€™;
    proc-&gt;content_length = 0;
    fpm_scoreboard_proc_release(proc);
    /* idleâ€“, active++, request++ */
    fpm_scoreboard_update(-1, 1, 0, 0, 1, 0, FPM_SCOREBOARD_ACTION_INC, NULL);
}</p>

<p>è¯¥é˜¶æ®µé‡ç½®request_stageä¸ºFPM_REQUEST_READING_HEADERS,ç„¶ååˆ†åˆ«ä¿®æ”¹tvã€acceptedã€accepted_epochã€requestså€¼ï¼Œå¹¶é‡ç½®ç»Ÿè®¡å•å…ƒè¯·æ±‚å¤´å±æ€§(request_uriã€request_methodã€script_filenameç­‰)æ•°æ®ã€‚æœ€åè°ƒç”¨fpm_scoreboard_update()ä¿®æ”¹wp-&gt;scoreboardçš„idleã€activeã€requestå±æ€§ã€‚</p>
<ol>
  <li>FPMè·å–è¯·æ±‚ä¿¡æ¯é˜¶æ®µï¼Œæ‰§è¡Œä»£ç ï¼šfpm_request_info().</li>
</ol>

<p>void fpm_request_info()
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc = fpm_scoreboard_proc_acquire(NULL, -1, 0);
    if (proc == NULL) {
        zlog(ZLOG_WARNING, â€œfailed to acquire proc scoreboardâ€);
        return;
    }
    proc-&gt;request_stage = FPM_REQUEST_INFO;
    proc-&gt;tv = now;
    //è¯·æ±‚åœ°å€
    if (request_uri) {
        strlcpy(proc-&gt;request_uri, request_uri, sizeof(proc-&gt;request_uri));
    }
    //è¯·æ±‚æ–¹æ³•
    if (request_method) {
        strlcpy(proc-&gt;request_method, request_method, sizeof(proc-&gt;request_method));
    }
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    fpm_scoreboard_proc_release(proc);
}</p>

<p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œè¯¥é˜¶æ®µåªæ˜¯å°†è¯·æ±‚ä¿¡æ¯ä¿å­˜åœ¨è¯¥workerè¿›ç¨‹çš„ç»Ÿè®¡å•å…ƒä¸­ã€‚ä¸å‰ä¸¤è€…ä¸åŒçš„æ˜¯ï¼Œæ­¤é˜¶æ®µæ— éœ€è°ƒç”¨fpm_scoreboard_update()ä¿®æ”¹wp-&gt;scoreboardå±æ€§å€¼ã€‚</p>
<ol>
  <li>zendæ‰§è¡Œè„šæœ¬é˜¶æ®µï¼Œæ‰§è¡Œä»£ç ï¼šfpm_request_executing().</li>
</ol>

<p>void fpm_request_executing() 
{
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    proc = fpm_scoreboard_proc_acquire(NULL, -1, 0);
    if (proc == NULL) {
        zlog(ZLOG_WARNING, â€œfailed to acquire proc scoreboardâ€);
        return;
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>proc-&gt;request_stage = FPM_REQUEST_EXECUTING;
proc-&gt;tv = now;
fpm_scoreboard_proc_release(proc); }
</code></pre></div></div>

<p>æ­¤é˜¶æ®µå°†request_stageå±æ€§å€¼ä¿®æ”¹ä¸ºFPM_REQUEST_EXECUTINGã€‚</p>
<ol>
  <li>è¯·æ±‚ç»“æŸé˜¶æ®µï¼Œæ‰§è¡Œä»£ç ï¼šfpm_request_end().</li>
</ol>

<p>void fpm_request_end(TSRMLS_D)
{
    //â€¦çœç•¥ä»£ç â€¦
    proc = fpm_scoreboard_proc_acquire(NULL, -1, 0);
    if (proc == NULL) {
        zlog(ZLOG_WARNING, â€œfailed to acquire proc scoreboardâ€);
        return;
    }
    proc-&gt;request_stage = FPM_REQUEST_FINISHED;
    proc-&gt;tv = now;
    timersub(&amp;now, &amp;proc-&gt;accepted, &amp;proc-&gt;duration);
#ifdef HAVE_TIMES
    timersub(&amp;proc-&gt;tv, &amp;proc-&gt;accepted, &amp;proc-&gt;cpu_duration);
    proc-&gt;last_request_cpu.tms_utime = cpu.tms_utime - proc-&gt;cpu_accepted.tms_utime;
    proc-&gt;last_request_cpu.tms_stime = cpu.tms_stime - proc-&gt;cpu_accepted.tms_stime;
    proc-&gt;last_request_cpu.tms_cutime = cpu.tms_cutime - proc-&gt;cpu_accepted.tms_cutime;
    proc-&gt;last_request_cpu.tms_cstime = cpu.tms_cstime - proc-&gt;cpu_accepted.tms_cstime;
#endif
    proc-&gt;memory = memory;
    fpm_scoreboard_proc_release(proc);
}</p>

<p>æ­¤é˜¶æ®µè®¡ç®—ç¨‹åºè¿è¡Œçš„æ—¶é—´åŠå ç”¨çš„å†…å­˜å¤§å°ï¼Œåˆ†åˆ«ä¿å­˜åœ¨ç»Ÿè®¡å•å…ƒçš„durationå’Œmemoryå±æ€§ã€‚</p>

<p>scoreboardç»Ÿè®¡å®šæ—¶æ›´æ–°
FPMå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªfpm_pctl_perform_idle_server_maintenance_heartbeatå®šæ—¶å™¨,å…¶å†…éƒ¨ä¼šè¿›è¡Œç»Ÿè®¡workerè¿›ç¨‹çš„idleã€activeç­‰æ•°æ®ï¼Œç„¶åè°ƒç”¨fpm_scoreboard_update()åŠŸèƒ½è¿›è¡Œæ›´æ–°wp-&gt;scoreboardä¿¡æ¯ã€‚</p>

<p>static void fpm_pctl_perform_idle_server_maintenance(struct timeval <em>now) /</em> {{{ */
{
    struct fpm_worker_pool_s *wp;
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
        for (child = wp-&gt;children; child; child = child-&gt;next) {
            if (fpm_request_is_idle(child)) {
                if (last_idle_child == NULL) {
                    last_idle_child = child;
                } else {
                    if (timercmp(&amp;child-&gt;started, &amp;last_idle_child-&gt;started, &lt;)) {
                        last_idle_child = child;
                    }
                }
                idle++;
            } else {
                active++;
            }
        }
        fpm_scoreboard_update(idle, active, cur_lq, -1, -1, -1, FPM_SCOREBOARD_ACTION_SET, wp-&gt;scoreboard);
        //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
    }
    //â€¦çœç•¥éƒ¨åˆ†ä»£ç â€¦
}
ä»¥ä¸Šå°±æ˜¯PHP-FPM scoreboardæ¨¡å—ä»‹ç»çš„å…¨éƒ¨å†…å®¹ã€‚é€šè¿‡è¿™ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿåœ°æŒæ¡PHP-FPMå„ä¸ªworkerè¿›ç¨‹è¿è¡ŒçŠ¶æ€ã€‚</p>

<p>https://blog.csdn.net/Mijar2016/article/details/53414402</p>

:ET