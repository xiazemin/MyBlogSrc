I"ÅS<p>https://github.com/xiazemin/php7-internal/blob/master/1/fpm.md</p>

<p>https://github.com/xiazemin/php-fpm-code-analysis</p>

<p>php-fpmæ˜¯ä¸€ä¸ªå†…ç½®phpè§£æå™¨ï¼Œé‡‡ç”¨prefork+å¼‚æ­¥IO æ¨¡å‹çš„é«˜æ€§èƒ½æœåŠ¡å™¨ç¨‹åº
php-fpmä»php5.3.3å¼€å§‹å·²ç»è¿›å…¥åˆ°phpæºä»£ç åŒ…ï¼Œä¹‹å‰æ˜¯ä½œä¸ºpatchå­˜åœ¨çš„
php-fpm é‡‡ç”¨ preforkçš„æ–¹å¼ ï¼ˆlistenåŒä¸€ä¸ªåœ°å€ï¼Œç„¶åforkå‡ºè‹¥å¹²å­è¿›ç¨‹)
åœ¨å­è¿›ç¨‹é‡Œé¢ï¼Œé‡‡ç”¨å¼‚æ­¥IOå¤„ç†å®¢æˆ·ç«¯è¯·æ±‚
eventæ¨¡å‹å¯ä»¥åœ¨php-fpm.confä¸­é…ç½®
; Specify the event mechanism FPM will use. The following 
is available:
; - select     (any POSIX os)
; - poll       (any POSIX os)
; - epoll      (linux &gt;= 2.5.44)
; - kqueue     (FreeBSD &gt;= 4.1, OpenBSD &gt;= 2.9, NetBSD &gt;= 2.0)
; - /dev/poll  (Solaris &gt;= 7)
; - port       (Solaris &gt;= 10)
; Default Value: not set (auto detection)
;events.mechanism = epoll
<!-- more -->
åœ¨linuxæœåŠ¡å™¨ä¸Šï¼Œå¦‚æœä¸è®¾ç½®events.mechanism,é‚£ä¹ˆé»˜è®¤å°±æ˜¯é‡‡ç”¨epollï¼Œæ‰€ä»¥</p>

<p>php-fpmçš„IOæ¨¡å‹&amp;å¹¶å‘å¤„ç†èƒ½åŠ›å’Œnginxæ˜¯å®Œå…¨ä¸€è‡´</p>

<p>nginxä»¥æ€§èƒ½å“è¶Šé—»åï¼Œå¤§éƒ¨åˆ†ç¨‹åºå‘˜éƒ½è®¤ä¸ºphpæ•ˆç‡ä½ä¸‹ï¼Œçœ‹äº†æºä»£ç ï¼Œæ‰çŸ¥é“è¿™æ˜¯ä¼ å¥‡å•Š</p>

<p>åœ¨é«˜æ€§èƒ½éƒ¨ç½²çš„æ—¶å€™ï¼Œå¤§å®¶å¾€å¾€ä¼šé’ˆå¯¹æ€§çš„ä¼˜åŒ–nginx ã€‚æˆ‘è‡ªå·±ä¹‹å‰éƒ¨ç½²phpç¨‹åºä¹ŸçŠ¯äº†é”™è¯¯ï¼Œ8Gå†…å­˜çš„serverï¼Œphp-fpmçš„max childrenéƒ½ä¼šè®¾ç½®128+ï¼Œç°åœ¨çœ‹æ¥å¤ªå¤šäº†ï¼Œå‚è€ƒnginxçš„éƒ¨ç½²:
nginxçš„worker_processä¸€èˆ¬è®¾ç½®ä¸º 2 * cpu-core
php-fpmé…ç½®ä¸º 3å€ cpu core numberå°±å¯ä»¥äº†</p>

<p>php-fpmç¨³å®šæ€§æ¯”nginxç¨å·®
è¿™æ˜¯å› ä¸ºphp-fpmå†…ç½®äº†ä¸€ä¸ªphpè§£æå™¨,php-fpmè¿›ç¨‹å°±å’Œphpç¨‹åºæ†ç»‘äº†ï¼Œå¦‚æœphpè„šæœ¬å†™çš„ä¸å¥½ï¼Œæœ‰æ­»å¾ªç¯æˆ–è€…é˜»å¡åœ¨æŸä¸ªè¿œç«¯èµ„æºä¸Šï¼Œä¼šæ‹–ç´¯åŠ è½½å®ƒçš„php-fpmè¿›ç¨‹</p>

<p>è€Œnginxå’Œåç«¯åº”ç”¨æœåŠ¡å™¨ä¹‹é—´é€šè¿‡ç½‘ç»œè¿æ¥ï¼Œå¯ä»¥è®¾ç½®timeoutï¼Œä¸å®¹æ˜“å µæ­»çš„</p>

<p>php-fpmçš„fastcgiæ˜¯çŸ­è¿æ¥
æˆ‘åŸä»¥ä¸ºæ˜¯é•¿è¿æ¥çš„ï¼Œçœ‹äº†ä»£ç æ‰çŸ¥é“ä¹Ÿæ˜¯çŸ­è¿æ¥ï¼Œå¤„ç†ä¸€ä¸ªrequestå°±å…³é—­æ‰</p>

<p>php-fpmæ¥å£é‡‡ç”¨fastcgi
éå¸¸é—æ†¾ï¼Œphp-fpmå’Œfastcgiå®Œå…¨ç»‘å®šäº†ï¼Œæ— æ³•ç‹¬ç«‹ä½¿ç”¨ ã€‚åªèƒ½éƒ¨ç½²åœ¨æ”¯æŒhttp-fcgiåè®®è½¬æ¢ç¨‹åºèƒŒå(nginxï¼‰ã€‚å…¶å®å¯ä»¥è€ƒè™‘åœ¨php-fpmä»£ç åŒ…é‡Œé¢å¼•å…¥httpåè®®æ”¯æŒï¼Œè¿™æ ·php-fpmå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œè®©nodejsæ— è¯å¯è¯´</p>

<p>php-fpmç­‰åŒäºOpenResty
OpenRestyæ˜¯ä¸€ä¸ªå›½äººå¼€å‘çš„nginxæ¨¡å—ï¼Œå°±æ˜¯åœ¨nginxå¼•å…¥luaè§£é‡Šå™¨. å®é™…ä¸Šï¼Œå®ƒå’Œphp-fpmçš„å”¯ä¸€å·®åˆ«å°±æ˜¯ä¸€ä¸ªé‡‡ç”¨phpè¯­æ³•ï¼Œä¸€ä¸ªç”¨luaï¼Œæ‰€ä»¥OpenRestyè¦ä½œä¸ºnginxå¢å¼ºåŒ…ä½¿ç”¨è¿˜å¯ä»¥ï¼Œè¦é€‰æ‹©å®ƒä½œä¸ºä¸€ä¸ªä¸»è¦ç¼–ç¨‹å·¥å…·ï¼Œæ²¡æœ‰ä»»ä½•å¿…è¦</p>

<p>ä»æ¶æ„ä¸Šæ¥è¯´ï¼Œphp-fpmå·²ç»åšåˆ°æœ€å¥½</p>

<p>PHP åªæ˜¯ä¸€ä¸ªè„šæœ¬è§£æå™¨ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªæ™®é€šçš„å‡½æ•°ï¼Œè¾“å…¥æ˜¯ PHP è„šæœ¬ã€‚è¾“å‡ºæ˜¯æ‰§è¡Œç»“æœï¼Œå‡å¦‚æˆ‘ä»¬æƒ³ç”¨ PHP ä»£æ›¿ shellï¼Œåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£ä¹ˆå°±å¯ä»¥å†™ä¸€ä¸ªç¨‹åºæ¥åµŒå…¥ PHP è§£æå™¨ï¼Œè¿™å°±æ˜¯ cli æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹ PHP å°±æ˜¯æ™®é€šçš„ä¸€ä¸ªå‘½ä»¤å·¥å…·ã€‚æ¥ç€æˆ‘ä»¬åˆæƒ³ï¼šèƒ½ä¸èƒ½è®© PHP å¤„ç† http è¯·æ±‚å‘¢ï¼Ÿè¿™æ—¶å°±æ¶‰åŠåˆ°äº†ç½‘ç»œå¤„ç†ï¼ŒPHP éœ€è¦æ¥æ”¶è¯·æ±‚ã€è§£æåè®®ï¼Œç„¶åå¤„ç†å®Œæˆè¿”å›è¯·æ±‚ã€‚åœ¨ç½‘ç»œåº”ç”¨åœºæ™¯ä¸‹ï¼ŒPHP å¹¶æ²¡æœ‰åƒ Golang é‚£æ ·å®ç° http ç½‘ç»œåº“ï¼Œè€Œæ˜¯å®ç°äº† FastCGI åè®®ï¼Œç„¶åä¸ web æœåŠ¡å™¨é…åˆå®ç°äº† http çš„å¤„ç†ï¼Œweb æœåŠ¡å™¨æ¥å¤„ç† http è¯·æ±‚ï¼Œç„¶åå°†è§£æçš„ç»“æœå†é€šè¿‡ FastCGI åè®®è½¬å‘ç»™å¤„ç†ç¨‹åºï¼Œå¤„ç†ç¨‹åºå¤„ç†å®Œæˆåå°†ç»“æœè¿”å›ç»™ web æœåŠ¡å™¨ï¼Œweb æœåŠ¡å™¨å†è¿”å›ç»™ç”¨æˆ·</p>

<p>PHP å®ç°äº† FastCGI åè®®çš„è§£æï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å…·ä½“å®ç°ç½‘ç»œå¤„ç†ï¼Œä¸€èˆ¬çš„å¤„ç†æ¨¡å‹ï¼šå¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ï¼Œå¤šè¿›ç¨‹æ¨¡å‹é€šå¸¸æ˜¯ä¸»è¿›ç¨‹åªè´Ÿè´£ç®¡ç†å­è¿›ç¨‹ï¼Œè€ŒåŸºæœ¬çš„ç½‘ç»œäº‹ä»¶ç”±å„ä¸ªå­è¿›ç¨‹å¤„ç†ï¼Œnginxã€fpm å°±æ˜¯è¿™ç§æ¨¡å¼ï¼›å¦ä¸€ç§å¤šçº¿ç¨‹æ¨¡å‹ä¸å¤šè¿›ç¨‹ç±»ä¼¼ï¼Œåªæ˜¯å®ƒæ˜¯çº¿ç¨‹ç²’åº¦ï¼Œé€šå¸¸ä¼šç”±ä¸»çº¿ç¨‹ç›‘å¬ã€æ¥æ”¶è¯·æ±‚ï¼Œç„¶åäº¤ç”±å­çº¿ç¨‹å¤„ç†ï¼Œmemcached å°±æ˜¯è¿™ç§æ¨¡å¼ï¼Œæœ‰çš„ä¹Ÿæ˜¯é‡‡ç”¨å¤šè¿›ç¨‹é‚£ç§æ¨¡å¼ï¼šä¸»çº¿ç¨‹åªè´Ÿè´£ç®¡ç†å­çº¿ç¨‹ä¸å¤„ç†ç½‘ç»œäº‹ä»¶ï¼Œå„ä¸ªå­çº¿ç¨‹ç›‘å¬ã€æ¥æ”¶ã€å¤„ç†è¯·æ±‚ï¼Œmemcached ä½¿ç”¨ udp åè®®æ—¶é‡‡ç”¨çš„æ˜¯è¿™ç§æ¨¡å¼ã€‚</p>

<p>fpm çš„å®ç°å°±æ˜¯åˆ›å»ºä¸€ä¸ª master è¿›ç¨‹ï¼Œåœ¨ master è¿›ç¨‹ä¸­åˆ›å»ºå¹¶ç›‘å¬ socketï¼Œç„¶å fork å‡ºå¤šä¸ªå­è¿›ç¨‹ï¼Œè¿™äº›å­è¿›ç¨‹å„è‡ª accept è¯·æ±‚ï¼Œå­è¿›ç¨‹çš„å¤„ç†éå¸¸ç®€å•ï¼Œå®ƒåœ¨å¯åŠ¨åé˜»å¡åœ¨ accept ä¸Šï¼Œæœ‰è¯·æ±‚åˆ°è¾¾åå¼€å§‹è¯»å–è¯·æ±‚æ•°æ®ï¼Œè¯»å–å®Œæˆåå¼€å§‹å¤„ç†ç„¶åå†è¿”å›ï¼Œåœ¨è¿™æœŸé—´æ˜¯ä¸ä¼šæ¥æ”¶å…¶å®ƒè¯·æ±‚çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ fpm çš„å­è¿›ç¨‹åŒæ—¶åªèƒ½å“åº”ä¸€ä¸ªè¯·æ±‚ï¼Œåªæœ‰æŠŠè¿™ä¸ªè¯·æ±‚å¤„ç†å®Œæˆåæ‰ä¼š accept ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œè¿™ä¸€ç‚¹ä¸ nginx çš„äº‹ä»¶é©±åŠ¨æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œnginx çš„å­è¿›ç¨‹é€šè¿‡ epoll ç®¡ç†å¥—æ¥å­—ï¼Œå¦‚æœä¸€ä¸ªè¯·æ±‚æ•°æ®è¿˜æœªå‘é€å®Œæˆåˆ™ä¼šå¤„ç†ä¸‹ä¸€ä¸ªè¯·æ±‚ï¼Œå³ä¸€ä¸ªè¿›ç¨‹ä¼šåŒæ—¶è¿æ¥å¤šä¸ªè¯·æ±‚ï¼Œå®ƒæ˜¯éé˜»å¡çš„æ¨¡å‹ï¼Œåªå¤„ç†æ´»è·ƒçš„å¥—æ¥å­—ã€‚</p>

<p>fpm çš„ master è¿›ç¨‹ä¸ worker è¿›ç¨‹ä¹‹é—´ä¸ä¼šç›´æ¥è¿›è¡Œé€šä¿¡ï¼Œmaster é€šè¿‡å…±äº«å†…å­˜è·å– worker è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ worker è¿›ç¨‹å½“å‰çŠ¶æ€ã€å·²å¤„ç†è¯·æ±‚æ•°ç­‰ï¼Œå½“ master è¿›ç¨‹è¦æ€æ‰ä¸€ä¸ª worker è¿›ç¨‹æ—¶åˆ™é€šè¿‡å‘é€ä¿¡å·çš„æ–¹å¼é€šçŸ¥ worker è¿›ç¨‹ã€‚</p>

<p>fpm å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£ï¼Œæ¯ä¸ªç«¯å£å¯¹åº”ä¸€ä¸ª worker poolï¼Œè€Œæ¯ä¸ª pool ä¸‹å¯¹åº”å¤šä¸ª worker è¿›ç¨‹ï¼Œç±»ä¼¼ nginx ä¸­ server æ¦‚å¿µã€‚</p>

<p>åœ¨ php-fpm.conf ä¸­é€šè¿‡[pool name]å£°æ˜ä¸€ä¸ª worker poolï¼š</p>

<p>[web1]
listen = 127.0.0.1:9000
â€¦</p>

<p>[web2]
listen = 127.0.0.1:9001
â€¦</p>

<p>å…·ä½“å®ç°ä¸Š worker pool é€šè¿‡fpm_worker_pool_sè¿™ä¸ªç»“æ„è¡¨ç¤ºï¼Œå¤šä¸ª worker pool ç»„æˆä¸€ä¸ªå•é“¾è¡¨ï¼š</p>

<p>struct fpm_worker_pool_s {
    struct fpm_worker_pool_s *next; //æŒ‡å‘ä¸‹ä¸€ä¸ªworker pool
    struct fpm_worker_pool_config_s *config; //confé…ç½®:pmã€max_childrenã€start_serversâ€¦
    int listening_socket; //ç›‘å¬çš„å¥—æ¥å­—
    â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//ä»¥ä¸‹è¿™ä¸ªå€¼ç”¨äºmasterå®šæ—¶æ£€æŸ¥ã€è®°å½•workeræ•°
struct fpm_child_s *children; //å½“å‰poolçš„workeré“¾è¡¨
int running_children; //å½“å‰poolçš„workerè¿è¡Œæ€»æ•°
int idle_spawn_rate;
int warn_max_children;

struct fpm_scoreboard_s *scoreboard; //è®°å½•workerçš„è¿è¡Œä¿¡æ¯ï¼Œæ¯”å¦‚ç©ºé—²ã€å¿™ç¢Œworkeræ•°
... }
</code></pre></div></div>

<p>FPMçš„åˆå§‹åŒ–
æ¥ä¸‹æ¥çœ‹ä¸‹ fpm çš„å¯åŠ¨æµç¨‹ï¼Œä»main()å‡½æ•°å¼€å§‹ï¼š</p>

<p>//sapi/fpm/fpm/fpm_main.c
int main(int argc, char *argv[])
{
    â€¦
    //æ³¨å†ŒSAPI:å°†å…¨å±€å˜é‡sapi_moduleè®¾ç½®ä¸ºcgi_sapi_module
    sapi_startup(&amp;cgi_sapi_module);
    â€¦
    //æ‰§è¡Œphp_module_starup()
    if (cgi_sapi_module.startup(&amp;cgi_sapi_module) == FAILURE) {
        return FPM_EXIT_SOFTWARE;
    }
    â€¦
    //åˆå§‹åŒ–
    if(0 &gt; fpm_init(â€¦)){
        â€¦
    }
    â€¦
    fpm_is_running = 1;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fcgi_fd = fpm_run(&amp;max_requests);//åé¢éƒ½æ˜¯workerè¿›ç¨‹çš„æ“ä½œï¼Œmasterè¿›ç¨‹ä¸ä¼šèµ°åˆ°ä¸‹é¢
parent = 0;
... } fpm_init()ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®æ“ä½œï¼š
</code></pre></div></div>

<p>(1) fpm_conf_init_main():</p>

<p>è§£æ php-fpm.conf é…ç½®æ–‡ä»¶ï¼Œåˆ†é… worker pool å†…å­˜ç»“æ„å¹¶ä¿å­˜åˆ°å…¨å±€å˜é‡ä¸­ï¼šfpm_worker_all_poolsï¼Œå„ worker pool é…ç½®è§£æåˆ°fpm_worker_pool_s-&gt;configä¸­ã€‚</p>

<p>(2)fpm_scoreboard_init_main():</p>

<p>åˆ†é…ç”¨äºè®°å½• worker è¿›ç¨‹è¿è¡Œä¿¡æ¯çš„å…±äº«å†…å­˜ï¼ŒæŒ‰ç…§ worker pool çš„æœ€å¤§ worker è¿›ç¨‹æ•°åˆ†é…ï¼Œæ¯ä¸ª worker pool åˆ†é…ä¸€ä¸ªfpm_scoreboard_sç»“æ„ï¼Œpool ä¸‹å¯¹åº”çš„æ¯ä¸ª worker è¿›ç¨‹åˆ†é…ä¸€ä¸ªfpm_scoreboard_proc_sç»“æ„ï¼Œå„ç»“æ„çš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾ã€‚
<img src="https://xiazemin.github.io/MyBlog/img/fpm_worker_all_pools.png" />
(3)fpm_signals_init_main():</p>

<p>static int sp[2];</p>

<p>int fpm_signals_init_main()
{
    struct sigaction act;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//åˆ›å»ºä¸€ä¸ªå…¨åŒå·¥ç®¡é“
if (0 &gt; socketpair(AF_UNIX, SOCK_STREAM, 0, sp)) {
    return -1;
}
//æ³¨å†Œä¿¡å·å¤„ç†handler
act.sa_handler = sig_handler;
sigfillset(&amp;act.sa_mask);
if (0 &gt; sigaction(SIGTERM,  &amp;act, 0) ||
    0 &gt; sigaction(SIGINT,   &amp;act, 0) ||
    0 &gt; sigaction(SIGUSR1,  &amp;act, 0) ||
    0 &gt; sigaction(SIGUSR2,  &amp;act, 0) ||
    0 &gt; sigaction(SIGCHLD,  &amp;act, 0) ||
    0 &gt; sigaction(SIGQUIT,  &amp;act, 0)) {
    return -1;
}
return 0; } è¿™é‡Œä¼šé€šè¿‡socketpair()åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œè¿™ä¸ªç®¡é“å¹¶ä¸æ˜¯ç”¨äº master ä¸ worker è¿›ç¨‹é€šä¿¡çš„ï¼Œå®ƒåªåœ¨ master è¿›ç¨‹ä¸­ä½¿ç”¨ï¼Œå…·ä½“ç”¨é€”åœ¨ç¨åä»‹ç» event äº‹ä»¶å¤„ç†æ—¶å†ä½œè¯´æ˜ã€‚å¦å¤–è®¾ç½® master çš„ä¿¡å·å¤„ç† handlerï¼Œå½“ master æ”¶åˆ° SIGTERMã€SIGINTã€SIGUSR1ã€SIGUSR2ã€SIGCHLDã€SIGQUIT è¿™äº›ä¿¡å·æ—¶å°†è°ƒç”¨sig_handler()å¤„ç†ï¼š
</code></pre></div></div>

<p>static void sig_handler(int signo)
{
    static const char sig_chars[NSIG + 1] = {
        [SIGTERM] = â€˜Tâ€™,
        [SIGINT]  = â€˜Iâ€™,
        [SIGUSR1] = â€˜1â€™,
        [SIGUSR2] = â€˜2â€™,
        [SIGQUIT] = â€˜Qâ€™,
        [SIGCHLD] = â€˜Câ€™
    };
    char s;
    â€¦
    s = sig_chars[signo];
    //å°†ä¿¡å·é€šçŸ¥å†™å…¥ç®¡é“sp[1]ç«¯
    write(sp[1], &amp;s, sizeof(s));
    â€¦
}
(4)fpm_sockets_init_main()</p>

<p>åˆ›å»ºæ¯ä¸ª worker pool çš„ socket å¥—æ¥å­—ã€‚</p>

<p>(5)fpm_event_init_main():</p>

<p>å¯åŠ¨ master çš„äº‹ä»¶ç®¡ç†ï¼Œfpm å®ç°äº†ä¸€ä¸ªäº‹ä»¶ç®¡ç†å™¨ç”¨äºç®¡ç† IOã€å®šæ—¶äº‹ä»¶ï¼Œå…¶ä¸­ IO äº‹ä»¶é€šè¿‡ kqueueã€epollã€pollã€select ç­‰ç®¡ç†ï¼Œå®šæ—¶äº‹ä»¶å°±æ˜¯å®šæ—¶å™¨ï¼Œä¸€å®šæ—¶é—´åè§¦å‘æŸä¸ªäº‹ä»¶ã€‚</p>

<p>åœ¨fpm_init()åˆå§‹åŒ–å®Œæˆåæ¥ä¸‹æ¥å°±æ˜¯æœ€å…³é”®çš„fpm_run()æ“ä½œäº†ï¼Œæ­¤ç¯èŠ‚å°† fork å­è¿›ç¨‹ï¼Œå¯åŠ¨è¿›ç¨‹ç®¡ç†å™¨ï¼Œå¦å¤– master è¿›ç¨‹å°†ä¸ä¼šå†è¿”å›ï¼Œåªæœ‰å„ worker è¿›ç¨‹ä¼šè¿”å›ï¼Œä¹Ÿå°±æ˜¯è¯´fpm_run()ä¹‹åçš„æ“ä½œå‡æ˜¯ worker è¿›ç¨‹çš„ã€‚</p>

<p>int fpm_run(int *max_requests)
{
    struct fpm_worker_pool_s *wp;
    for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
        //è°ƒç”¨fpm_children_make() forkå­è¿›ç¨‹
        is_parent = fpm_children_create_initial(wp);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    if (!is_parent) {
        goto run_child;
    }
}
//masterè¿›ç¨‹å°†è¿›å…¥eventå¾ªç¯ï¼Œä¸å†å¾€ä¸‹èµ°
fpm_event_loop(0);
</code></pre></div></div>

<p>run_child: //åªæœ‰workerè¿›ç¨‹ä¼šåˆ°è¿™é‡Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*max_requests = fpm_globals.max_requests;
return fpm_globals.listening_socket; //è¿”å›ç›‘å¬çš„å¥—æ¥å­— } åœ¨ fork å worker è¿›ç¨‹è¿”å›äº†ç›‘å¬çš„å¥—æ¥å­—ç»§ç»­ main() åé¢çš„å¤„ç†ï¼Œè€Œ master å°†æ°¸è¿œé˜»å¡åœ¨fpm_event_loop()ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«ä»‹ç» masterã€worker è¿›ç¨‹çš„åç»­æ“ä½œã€‚
</code></pre></div></div>

<p>è¯·æ±‚å¤„ç†
fpm_run()æ‰§è¡Œåå°† fork å‡º worker è¿›ç¨‹ï¼Œworker è¿›ç¨‹è¿”å›main()ä¸­ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œåé¢çš„æµç¨‹å°±æ˜¯ worker è¿›ç¨‹ä¸æ–­ accept è¯·æ±‚ï¼Œç„¶åæ‰§è¡Œ PHP è„šæœ¬å¹¶è¿”å›ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>

<p>(1)ç­‰å¾…è¯·æ±‚ï¼š worker è¿›ç¨‹é˜»å¡åœ¨ fcgi_accept_request() ç­‰å¾…è¯·æ±‚ï¼›
(2)è§£æè¯·æ±‚ï¼š fastcgi è¯·æ±‚åˆ°è¾¾åè¢« worker æ¥æ”¶ï¼Œç„¶åå¼€å§‹æ¥æ”¶å¹¶è§£æè¯·æ±‚æ•°æ®ï¼Œç›´åˆ° request æ•°æ®å®Œå…¨åˆ°è¾¾ï¼›
(3)è¯·æ±‚åˆå§‹åŒ–ï¼š æ‰§è¡Œ php_request_startup()ï¼Œæ­¤é˜¶æ®µä¼šè°ƒç”¨æ¯ä¸ªæ‰©å±•çš„ï¼šPHP_RINIT_FUNCTION()ï¼›
(4)ç¼–è¯‘ã€æ‰§è¡Œï¼š ç”± php_execute_script() å®Œæˆ PHP è„šæœ¬çš„ç¼–è¯‘ã€æ‰§è¡Œï¼›
(5)å…³é—­è¯·æ±‚ï¼š è¯·æ±‚å®Œæˆåæ‰§è¡Œ php_request_shutdown()ï¼Œæ­¤é˜¶æ®µä¼šè°ƒç”¨æ¯ä¸ªæ‰©å±•çš„ï¼šPHP_RSHUTDOWN_FUNCTION()ï¼Œç„¶åè¿›å…¥æ­¥éª¤ (1) ç­‰å¾…ä¸‹ä¸€ä¸ªè¯·æ±‚ã€‚
int main(int argc, char *argv[])
{
    â€¦
    fcgi_fd = fpm_run(&amp;max_requests);
    parent = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//åˆå§‹åŒ–fastcgiè¯·æ±‚
request = fpm_init_request(fcgi_fd);

//workerè¿›ç¨‹å°†é˜»å¡åœ¨è¿™ï¼Œç­‰å¾…è¯·æ±‚
while (EXPECTED(fcgi_accept_request(request) &gt;= 0)) {
    SG(server_context) = (void *) request;
    init_request_info();
    
    //è¯·æ±‚å¼€å§‹
    if (UNEXPECTED(php_request_startup() == FAILURE)) {
        ...
    }
    ...

    fpm_request_executing();
    //ç¼–è¯‘ã€æ‰§è¡ŒPHPè„šæœ¬
    php_execute_script(&amp;file_handle);
    ...
    //è¯·æ±‚ç»“æŸ
    php_request_shutdown((void *) 0);
    ...
}
...
//workerè¿›ç¨‹é€€å‡º
php_module_shutdown();
... } worker è¿›ç¨‹ä¸€æ¬¡è¯·æ±‚çš„å¤„ç†è¢«åˆ’åˆ†ä¸º 5 ä¸ªé˜¶æ®µï¼š
</code></pre></div></div>

<p>FPM_REQUEST_ACCEPTING: ç­‰å¾…è¯·æ±‚é˜¶æ®µ
FPM_REQUEST_READING_HEADERS: è¯»å– fastcgi è¯·æ±‚ header é˜¶æ®µ
FPM_REQUEST_INFO: è·å–è¯·æ±‚ä¿¡æ¯é˜¶æ®µï¼Œæ­¤é˜¶æ®µæ˜¯å°†è¯·æ±‚çš„ methodã€query stirngã€request uri ç­‰ä¿¡æ¯ä¿å­˜åˆ°å„ worker è¿›ç¨‹çš„ fpm_scoreboard_proc_s ç»“æ„ä¸­ï¼Œæ­¤æ“ä½œéœ€è¦åŠ é”ï¼Œå› ä¸º master è¿›ç¨‹ä¹Ÿä¼šæ“ä½œæ­¤ç»“æ„
FPM_REQUEST_EXECUTING: æ‰§è¡Œè¯·æ±‚é˜¶æ®µ
FPM_REQUEST_END: æ²¡æœ‰ä½¿ç”¨
FPM_REQUEST_FINISHED: è¯·æ±‚å¤„ç†å®Œæˆ
worker å¤„ç†åˆ°å„ä¸ªé˜¶æ®µæ—¶å°†ä¼šæŠŠå½“å‰é˜¶æ®µæ›´æ–°åˆ°fpm_scoreboard_proc_s-&gt;request_stageï¼Œmaster è¿›ç¨‹æ­£æ˜¯é€šè¿‡è¿™ä¸ªæ ‡è¯†åˆ¤æ–­ worker è¿›ç¨‹æ˜¯å¦ç©ºé—²çš„ã€‚</p>

<p>è¿›ç¨‹ç®¡ç†
è¿™ä¸€èŠ‚æˆ‘ä»¬æ¥çœ‹ä¸‹ master æ˜¯å¦‚ä½•ç®¡ç† worker è¿›ç¨‹çš„ï¼Œé¦–å…ˆä»‹ç»ä¸‹ä¸‰ç§ä¸åŒçš„è¿›ç¨‹ç®¡ç†æ–¹å¼ï¼š</p>

<p>static: è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåœ¨å¯åŠ¨æ—¶ master æŒ‰ç…§pm.max_childrené…ç½® fork å‡ºç›¸åº”æ•°é‡çš„ worker è¿›ç¨‹ï¼Œå³ worker è¿›ç¨‹æ•°æ˜¯å›ºå®šä¸å˜çš„ï¼›
dynamic: åŠ¨æ€è¿›ç¨‹ç®¡ç†ï¼Œé¦–å…ˆåœ¨ fpm å¯åŠ¨æ—¶æŒ‰ç…§pm.start_serversåˆå§‹åŒ–ä¸€å®šæ•°é‡çš„ workerï¼Œè¿è¡ŒæœŸé—´å¦‚æœ master å‘ç°ç©ºé—² worker æ•°ä½äºpm.min_spare_serversé…ç½®æ•°ï¼ˆè¡¨ç¤ºè¯·æ±‚æ¯”è¾ƒå¤šï¼Œworker å¤„ç†ä¸è¿‡æ¥äº†ï¼‰åˆ™ä¼š fork worker è¿›ç¨‹ï¼Œä½†æ€»çš„ worker æ•°ä¸èƒ½è¶…è¿‡pm.max_childrenï¼Œå¦‚æœ master å‘ç°ç©ºé—² worker æ•°è¶…è¿‡äº†pm.max_spare_servers(è¡¨ç¤ºé—²ç€çš„ worker å¤ªå¤šäº†)åˆ™ä¼šæ€æ‰ä¸€äº› workerï¼Œé¿å…å ç”¨è¿‡å¤šèµ„æºï¼Œmaster é€šè¿‡è¿™ 4 ä¸ªå€¼æ¥æ§åˆ¶ worker æ•°ï¼›
ondemand: è¿™ç§æ–¹å¼ä¸€èˆ¬å¾ˆå°‘ç”¨ï¼Œåœ¨å¯åŠ¨æ—¶ä¸åˆ†é… worker è¿›ç¨‹ï¼Œç­‰åˆ°æœ‰è¯·æ±‚äº†åå†é€šçŸ¥ master è¿›ç¨‹ fork worker è¿›ç¨‹ï¼Œæ€»çš„ worker æ•°ä¸è¶…è¿‡pm.max_childrenï¼Œå¤„ç†å®Œæˆå worker è¿›ç¨‹ä¸ä¼šç«‹å³é€€å‡ºï¼Œå½“ç©ºé—²æ—¶é—´è¶…è¿‡pm.process_idle_timeoutåå†é€€å‡ºï¼›
å‰é¢ä»‹ç»åˆ°åœ¨fpm_run()ä¸­ master è¿›ç¨‹å°†è¿›å…¥fpm_event_loop()ï¼š</p>

<p>void fpm_event_loop(int err)
{
    //åˆ›å»ºä¸€ä¸ªio readçš„ç›‘å¬äº‹ä»¶ï¼Œè¿™é‡Œç›‘å¬çš„å°±æ˜¯åœ¨fpm_init()é˜¶æ®µä¸­é€šè¿‡socketpair()åˆ›å»ºç®¡é“sp[0]
    //å½“sp[0]å¯è¯»æ—¶å°†å›è°ƒfpm_got_signal()
    fpm_event_set(&amp;signal_fd_event, fpm_signals_get_fd(), FPM_EV_READ, &amp;fpm_got_signal, NULL);
    fpm_event_add(&amp;signal_fd_event, 0);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//å¦‚æœåœ¨php-fpm.confé…ç½®äº†request_terminate_timeoutåˆ™å¯åŠ¨å¿ƒè·³æ£€æŸ¥
if (fpm_globals.heartbeat &gt; 0) {
    fpm_pctl_heartbeat(NULL, 0, NULL);
}
//å®šæ—¶è§¦å‘è¿›ç¨‹ç®¡ç†
fpm_pctl_perform_idle_server_maintenance_heartbeat(NULL, 0, NULL);

//è¿›å…¥äº‹ä»¶å¾ªç¯ï¼Œmasterè¿›ç¨‹å°†é˜»å¡åœ¨æ­¤
while (1) {
    ...
    //ç­‰å¾…IOäº‹ä»¶
    ret = module-&gt;wait(fpm_event_queue_fd, timeout);
    ...
    //æ£€æŸ¥å®šæ—¶å™¨äº‹ä»¶
    ...
} } è¿™å°±æ˜¯ master æ•´ä½“çš„å¤„ç†ï¼Œå…¶è¿›ç¨‹ç®¡ç†ä¸»è¦ä¾èµ–æ³¨å†Œçš„å‡ ä¸ªäº‹ä»¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†åˆ†æä¸‹è¿™å‡ ä¸ªäº‹ä»¶çš„åŠŸèƒ½ã€‚
</code></pre></div></div>

<p>(1)sp[1]ç®¡é“å¯è¯»äº‹ä»¶ï¼š</p>

<p>åœ¨fpm_init()é˜¶æ®µ master æ›¾åˆ›å»ºäº†ä¸€ä¸ªå…¨åŒå·¥çš„ç®¡é“ï¼šspï¼Œç„¶ååœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª sp[0] å¯è¯»çš„äº‹ä»¶ï¼Œå½“ sp[0] å¯è¯»æ—¶å°†äº¤ç”±fpm_got_signal()å¤„ç†ï¼Œå‘ sp[1] å†™æ•°æ®æ—¶ sp[0] æ‰ä¼šå¯è¯»ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶æœºä¼šå‘ sp[1] å†™æ•°æ®å‘¢ï¼Ÿå‰é¢å·²ç»æåˆ°äº†ï¼šå½“ master æ”¶åˆ°æ³¨å†Œçš„é‚£å‡ ç§ä¿¡å·æ—¶ä¼šå†™å…¥ sp[1] ç«¯ï¼Œè¿™ä¸ªæ—¶å€™å°†è§¦å‘ sp[0] å¯è¯»äº‹ä»¶ã€‚</p>

<p>è¿™ä¸ªäº‹ä»¶æ˜¯ master ç”¨äºå¤„ç†ä¿¡å·çš„ï¼Œæˆ‘ä»¬æ ¹æ® master æ³¨å†Œçš„ä¿¡å·é€ä¸ªçœ‹ä¸‹ä¸åŒç”¨é€”ï¼š</p>

<p>SIGINT/SIGTERM/SIGQUIT: é€€å‡º fpmï¼Œåœ¨ master æ”¶åˆ°é€€å‡ºä¿¡å·åå°†å‘æ‰€æœ‰çš„ worker è¿›ç¨‹å‘é€é€€å‡ºä¿¡å·ï¼Œç„¶å master é€€å‡ºï¼›
SIGUSR1: é‡æ–°åŠ è½½æ—¥å¿—æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é€šå¸¸ä¼šå¯¹æ—¥å¿—è¿›è¡Œåˆ‡å‰²ï¼Œåˆ‡å‰²åä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚æœ fpm ä¸é‡æ–°åŠ è½½å°†æ— æ³•ç»§ç»­å†™å…¥æ—¥å¿—ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å‘ master å‘é€ä¸€ä¸ª USR1 çš„ä¿¡å·ï¼›
SIGUSR2: é‡å¯ fpmï¼Œé¦–å…ˆ master ä¹Ÿæ˜¯ä¼šå‘æ‰€æœ‰çš„ worker è¿›ç¨‹å‘é€é€€å‡ºä¿¡å·ï¼Œç„¶å master ä¼šè°ƒç”¨ execvp() é‡æ–°å¯åŠ¨ fpm ï¼Œæœ€åæ—§çš„ master é€€å‡ºï¼›
SIGCHLD: è¿™ä¸ªä¿¡å·æ˜¯å­è¿›ç¨‹é€€å‡ºæ—¶æ“ä½œç³»ç»Ÿå‘é€ç»™çˆ¶è¿›ç¨‹çš„ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶ï¼Œå†…æ ¸å°†å­è¿›ç¨‹ç½®ä¸ºåƒµå°¸çŠ¶æ€ï¼Œè¿™ä¸ªè¿›ç¨‹ç§°ä¸ºåƒµå°¸è¿›ç¨‹ï¼Œå®ƒåªä¿ç•™æœ€å°çš„ä¸€äº›å†…æ ¸æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿çˆ¶è¿›ç¨‹æŸ¥è¯¢å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ï¼Œåªæœ‰å½“çˆ¶è¿›ç¨‹è°ƒç”¨ wait æˆ–è€… waitpid å‡½æ•°æŸ¥è¯¢å­è¿›ç¨‹é€€å‡ºçŠ¶æ€åå­è¿›ç¨‹æ‰å‘Šç»ˆæ­¢ï¼Œ fpm ä¸­å½“ worker è¿›ç¨‹å› ä¸ºå¼‚å¸¸åŸå› ï¼ˆæ¯”å¦‚ coredump äº†ï¼‰é€€å‡ºè€Œé master ä¸»åŠ¨æ€æ‰æ—¶ master å°†å—åˆ°æ­¤ä¿¡å·ï¼Œè¿™ä¸ªæ—¶å€™çˆ¶è¿›ç¨‹å°†è°ƒç”¨ waitpid() æŸ¥ä¸‹å­è¿›ç¨‹çš„é€€å‡ºï¼Œç„¶åæ£€æŸ¥ä¸‹æ˜¯ä¸æ˜¯éœ€è¦é‡æ–° fork æ–°çš„ workerï¼›
å…·ä½“å¤„ç†é€»è¾‘åœ¨fpm_got_signal()å‡½æ•°ä¸­ï¼Œè¿™é‡Œä¸å†ç½—åˆ—ã€‚</p>

<p>(2)fpm_pctl_perform_idle_server_maintenance_heartbeat():</p>

<p>è¿™æ˜¯è¿›ç¨‹ç®¡ç†å®ç°çš„ä¸»è¦äº‹ä»¶ï¼Œmaster å¯åŠ¨äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œæ¯éš” 1s è§¦å‘ä¸€æ¬¡ï¼Œä¸»è¦ç”¨äº dynamicã€ondemand æ¨¡å¼ä¸‹çš„ worker ç®¡ç†ï¼Œmaster ä¼šå®šæ—¶æ£€æŸ¥å„ worker pool çš„ worker è¿›ç¨‹æ•°ï¼Œé€šè¿‡æ­¤å®šæ—¶å™¨å®ç° worker æ•°é‡çš„æ§åˆ¶ï¼Œå¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p>

<p>static void fpm_pctl_perform_idle_server_maintenance(struct timeval *now)
{
    for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
        struct fpm_child_s *last_idle_child = NULL; //ç©ºé—²æ—¶é—´æœ€ä¹…çš„worker
        int idle = 0; //ç©ºé—²workeræ•°
        int active = 0; //å¿™ç¢Œworkeræ•°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for (child = wp-&gt;children; child; child = child-&gt;next) {
        //æ ¹æ®workerè¿›ç¨‹çš„fpm_scoreboard_proc_s-&gt;request_stageåˆ¤æ–­
        if (fpm_request_is_idle(child)) {
            //æ‰¾ç©ºé—²æ—¶é—´æœ€ä¹…çš„worker
            ...
            idle++;
        }else{
            active++;
        }
    }
    ...
    //ondemandæ¨¡å¼
    if (wp-&gt;config-&gt;pm == PM_STYLE_ONDEMAND) {
        if (!last_idle_child) continue;

        fpm_request_last_activity(last_idle_child, &amp;last);
        fpm_clock_get(&amp;now);
        if (last.tv_sec &lt; now.tv_sec - wp-&gt;config-&gt;pm_process_idle_timeout) {
            //å¦‚æœç©ºé—²æ—¶é—´æœ€é•¿çš„workerç©ºé—²æ—¶é—´è¶…è¿‡äº†process_idle_timeoutåˆ™æ€æ‰è¯¥worker
            last_idle_child-&gt;idle_kill = 1;
            fpm_pctl_kill(last_idle_child-&gt;pid, FPM_PCTL_QUIT);
        } 
        continue;
    }
    //dynamic
    if (wp-&gt;config-&gt;pm != PM_STYLE_DYNAMIC) continue;
    if (idle &gt; wp-&gt;config-&gt;pm_max_spare_servers &amp;&amp; last_idle_child) {
        //ç©ºé—²workerå¤ªå¤šäº†ï¼Œæ€æ‰
        last_idle_child-&gt;idle_kill = 1;
        fpm_pctl_kill(last_idle_child-&gt;pid, FPM_PCTL_QUIT);
        wp-&gt;idle_spawn_rate = 1;
        continue;
    }
    if (idle &lt; wp-&gt;config-&gt;pm_min_spare_servers) {
        //ç©ºé—²workerå¤ªå°‘äº†ï¼Œå¦‚æœæ€»workeræ•°æœªè¾¾åˆ°maxæ•°åˆ™fork
        ...
    }
} } (3)fpm_pctl_heartbeat():
</code></pre></div></div>

<p>è¿™ä¸ªäº‹ä»¶æ˜¯ç”¨äºé™åˆ¶ worker å¤„ç†å•ä¸ªè¯·æ±‚æœ€å¤§è€—æ—¶çš„ï¼Œphp-fpm.conf ä¸­æœ‰ä¸€ä¸ªrequest_terminate_timeoutçš„é…ç½®é¡¹ï¼Œå¦‚æœ worker å¤„ç†ä¸€ä¸ªè¯·æ±‚çš„æ€»æ—¶é•¿è¶…è¿‡äº†è¿™ä¸ªå€¼é‚£ä¹ˆ master å°†ä¼šå‘æ­¤ worker è¿›ç¨‹å‘é€kill -TERMä¿¡å·æ€æ‰ worker è¿›ç¨‹ï¼Œæ­¤é…ç½®å•ä½ä¸ºç§’ï¼Œé»˜è®¤å€¼ä¸º 0 è¡¨ç¤ºå…³é—­æ­¤æœºåˆ¶ï¼Œå¦å¤– fpm æ‰“å°çš„ slow log ä¹Ÿæ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚</p>

<p>static void fpm_pctl_check_request_timeout(struct timeval *now)
{ <br />
    struct fpm_worker_pool_s *wp;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (wp = fpm_worker_all_pools; wp; wp = wp-&gt;next) {
    int terminate_timeout = wp-&gt;config-&gt;request_terminate_timeout;
    int slowlog_timeout = wp-&gt;config-&gt;request_slowlog_timeout;
    struct fpm_child_s *child;

    if (terminate_timeout || slowlog_timeout) { 
        for (child = wp-&gt;children; child; child = child-&gt;next) {
            //æ£€æŸ¥å½“å‰å½“å‰workerå¤„ç†çš„è¯·æ±‚æ˜¯å¦è¶…æ—¶
            fpm_request_check_timed_out(child, now, terminate_timeout, slowlog_timeout);
        }
    }
} } é™¤äº†ä¸Šé¢è¿™å‡ ä¸ªäº‹ä»¶å¤–è¿˜æœ‰ä¸€ä¸ªæ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ ondemand æ¨¡å¼ä¸‹ master ç›‘å¬çš„æ–°è¯·æ±‚åˆ°è¾¾çš„äº‹ä»¶ï¼Œå› ä¸º ondemand æ¨¡å¼ä¸‹ fpm å¯åŠ¨æ—¶æ˜¯ä¸ä¼šé¢„åˆ›å»º worker çš„ï¼Œæœ‰è¯·æ±‚æ—¶æ‰ä¼šç”Ÿæˆå­è¿›ç¨‹ï¼Œæ‰€ä»¥è¯·æ±‚åˆ°è¾¾æ—¶éœ€è¦é€šçŸ¥ master è¿›ç¨‹ï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯åœ¨fpm_children_create_initial()æ—¶æ³¨å†Œçš„ï¼Œäº‹ä»¶å¤„ç†å‡½æ•°ä¸ºfpm_pctl_on_socket_accept()ï¼Œå…·ä½“é€»è¾‘è¿™é‡Œä¸å†å±•å¼€ï¼Œæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚
</code></pre></div></div>
:ET