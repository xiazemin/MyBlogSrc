I"¦b<p>cd /Users/didi/PhpstormProjects/c/php-src
$git checkout -b xiazemin/function_record</p>

<p>å†™å®Œåè¿è¡Œæµ‹è¯•æ–‡ä»¶çš„è„šæœ¬
$ls run-tests.php
run-tests.php</p>

<p>æŸ¥çœ‹å†™æ‰©å±•çš„å¸®åŠ© README.EXT_SKEL</p>

<p>å¦‚æœä»…ä»…éœ€è¦æ·±æ²‰æ¡†æ¶ï¼Œè‡ªå·±å†™å‡½æ•°å®ç°
cd ext
./ext_skel â€“extname=module_name
<!-- more --></p>

<p>$ ./ext_skel â€“extname=emtyExt
Creating directory emtyExt
Creating basic files: config.m4 config.w32 .gitignore emtyExt.c php_emtyExt.h CREDITS EXPERIMENTAL tests/001.phpt emtyExt.php [done].</p>

<p>To use your new extension, you will have to execute the following steps:</p>

<ol>
  <li>$ cd ..</li>
  <li>$ vi ext/emtyExt/config.m4</li>
  <li>$ ./buildconf</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>$ ./configure â€“[with</td>
          <td>enable]-emtyExt</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>$ make</li>
  <li>$ ./sapi/cli/php -f ext/emtyExt/emtyExt.php</li>
  <li>$ vi ext/emtyExt/emtyExt.c</li>
  <li>$ make</li>
</ol>

<p>Repeat steps 3-6 until you are satisfied with ext/emtyExt/config.m4 and
step 6 confirms that your module is compiled into PHP. Then, start writing
code and repeat the last two steps as often as necessary.</p>

<p>cd emtyExt
$ls
CREDITS		config.m4	emtyExt.c	php_emtyExt.h
EXPERIMENTAL	config.w32	emtyExt.php	tests</p>

<p>$cd  ../..</p>

<p>$./buildconf
rebuilding aclocal.m4
rebuilding configure
rebuilding main/php_config.h.in</p>

<p>$cd ext/emptyExt
$phpize
Configuring for:
PHP Api Version:         20151012
Zend Module Api No:      20160303
Zend Extension Api No:   320160303</p>

<p>$./configure â€“with-php-config=/usr/local/php/man/man1/php-config.1 -with-php-config=/usr/local/bin/php-config</p>

<p>$make</p>

<p>Build complete.
Donâ€™t forget to run â€˜make testâ€™.</p>

<p>$make test</p>

<p>Build complete.
Donâ€™t forget to run â€˜make testâ€™.</p>

<p>=====================================================================
PHP         : /usr/local/bin/php
PHP_SAPI    : cli
PHP_VERSION : 7.2.0-dev
ZEND_VERSION: 3.1.0-dev
PHP_OS      : Darwin - Darwin localhost 15.0.0 Darwin Kernel Version 15.0.0: Sat Sep 19 15:53:46 PDT 2015; root:xnu-3247.10.11~1/RELEASE_X86_64 x86_64
INI actual  : /Users/didi/PhpstormProjects/c/php-src/ext/emtyExt/tmp-php.ini
More .INIs  :
CWD         : /Users/didi/PhpstormProjects/c/php-src/ext/emtyExt</p>

<p>$make install
Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20160303/
cp: modules/<em>: No such file or directory
make: **</em> [install-modules] Error 1</p>

<p>$ls modules/
ç©ºçš„</p>

<p>README.EXT_SKEL
 Just remove 3 comments in your_module_name/config.m4,</p>

<p>config.m4
dnl Comments in this file start with the string â€˜dnlâ€™.
dnl Remove where necessary. This file will not work
dnl without editing.</p>

<p>##æŒ‡å®šPHPæ¨¡å—çš„å·¥ä½œæ–¹å¼ï¼ŒåŠ¨æ€ç¼–è¯‘é€‰é¡¹ï¼Œå¦‚æœæƒ³é€šè¿‡.soçš„æ–¹å¼æ¥å…¥æ‰©å±•ï¼Œè¯·å»æ‰å‰é¢çš„dnlæ³¨é‡Š
PHP_ARG_WITH(helloworld, for helloworld support,
Make sure that the comment is aligned:
[  â€“with-helloworld             Include helloworld support])</p>

<p>dnl Otherwise use enable:</p>

<p>##æŒ‡å®šPHPæ¨¡å—çš„å·¥ä½œæ–¹å¼ï¼Œé™æ€ç¼–è¯‘é€‰é¡¹ï¼Œå¦‚æœæƒ³é€šè¿‡enableçš„æ–¹å¼æ¥å¯ç”¨ï¼Œå»æ‰dnlæ³¨é‡Š
PHP_ARG_ENABLE(helloworld, whether to enable helloworld support,
Make sure that the comment is aligned:
[  â€“enable-helloworld           Enable helloworld support])</p>

<p>ä¿®æ”¹æˆè¿™æ ·
 PHP_ARG_WITH(emtyExt, for emtyExt support,
 Make sure that the comment is aligned:
  [  â€“with-emtyExt             Include emtyExt support])</p>

<p>é‡å¤ä¸Šè¿°æµç¨‹
 $make &amp;&amp; make install</p>

<p>Build complete.
Donâ€™t forget to run â€˜make testâ€™.</p>

<p>Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20160303/</p>

<p>$ls  /usr/local/lib/php/extensions/debug-non-zts-20160303/emtyExt.so
/usr/local/lib/php/extensions/debug-non-zts-20160303/emtyExt.so</p>

<p>vi /usr/local/lib/php.ini
extension=/usr/local/lib/php/extensions/debug-non-zts-20160303/emtyExt.so</p>

<p>$php -m |grep emtyExt
emtyExt</p>

<hr />
<p>å¦‚æœä½ æ¸…æ¥šçŸ¥é“å‡½æ•°çš„è¾“å…¥å’Œè¿”å›å€¼ï¼Œä½ éœ€è¦å®šä¹‰ä¸€ä¸ªå£°åæ–‡ä»¶ï¼Œç”Ÿæˆçš„æ—¶å€™æŒ‡å®šè¿™ä¸ªæ–‡ä»¶
 â€“proto=filename.</p>

<p>./ext_skel ç”Ÿæˆ â€˜module_name.câ€™ and â€˜php_module_name.hâ€™ as main source and header files.</p>

<p>ä¾‹1
module_name_function</p>

<p>ä¾‹2
 module_name_function(int arg1, int arg2 [, int arg3 [, int arg4]])</p>

<p>ä¾‹3
  bool module_name_drawtext(resource image, string text, resource font, int x, int y [, int color])</p>

<p>cd /Users/didi/PhpstormProjects/c/php-src/ext
$vi myExtIdl/getext.skel
string getext(string str)</p>

<p>$./ext_skel â€“extname=myText â€“proto=myExtIdl/getext.skel
Creating directory myText
awk: syntax error at source line 256 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs
 context is
					if (!stubs) print â€œâ€ &gt; extnameÂ Â»&gt;  â€œ/function_warningâ€ Â«&lt;
awk: illegal statement at source line 257 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs
awk: syntax error at source line 267 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs
Creating basic files: config.m4 config.w32 .gitignore myText.c php_myText.h CREDITS EXPERIMENTAL tests/001.phpt myText.phprm: function_entries: No such file or directory
rm: function_declarations: No such file or directory
rm: function_stubs: No such file or directory
 [done].</p>

<p>To use your new extension, you will have to execute the following steps:</p>

<ol>
  <li>$ cd ..</li>
  <li>$ vi ext/myText/config.m4</li>
  <li>$ ./buildconf</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>$ ./configure â€“[with</td>
          <td>enable]-myText</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>$ make</li>
  <li>$ ./sapi/cli/php -f ext/myText/myText.php</li>
  <li>$ vi ext/myText/myText.c</li>
  <li>$ make</li>
</ol>

<p>Repeat steps 3-6 until you are satisfied with ext/myText/config.m4 and
step 6 confirms that your module is compiled into PHP. Then, start writing
code and repeat the last two steps as often as necessary.</p>

<p>$ls myText/
CREDITS		config.m4	myText.c	php_myText.h
EXPERIMENTAL	config.w32	myText.php	tests</p>

<p>$vi myText/config.m4
 PHP_ARG_WITH(myText, for myText support,
 Make sure that the comment is aligned:
 [  â€“with-myText             Include myText support])</p>

<p>$cd myText/</p>

<p>ä¿®æ”¹å‡½æ•°ä½“
PHP_FUNCTION(confirm_myText_compiled)
vi myText.c</p>

<p>$phpize
Configuring for:
PHP Api Version:         20151012
Zend Module Api No:      20160303
Zend Extension Api No:   320160303</p>

<p>$./configure â€“with-php-config=/usr/local/php/man/man1/php-config.1 -with-php-config=/usr/local/bin/php-config</p>

<p>$make &amp; make install</p>

<p>Donâ€™t forget to run â€˜make testâ€™.</p>

<p>Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20160303/
[1]+  Done                    make</p>

<p>$ls  /usr/local/lib/php/extensions/debug-non-zts-20160303/myText.so
/usr/local/lib/php/extensions/debug-non-zts-20160303/myText.so</p>

<p>$vi /usr/local/lib/php.ini
extension=/usr/local/lib/php/extensions/debug-non-zts-20160303/myText.so</p>

<p>$php -m |grep myText
myText</p>

<p>$php -r â€˜var_dump(getext(â€œ1234â€));â€™
PHP Fatal error:  Uncaught Error: Call to undefined function getext() in Command line code:1</p>

<p>$vi myText.c
æ‰¾åˆ°
const zend_function_entry myText_functions[] = {
        PHP_FE(confirm_myText_compiled, NULL)           /* For testing, remove later. <em>/
        PHP_FE_END      /</em> Must be the last line in myText_functions[] */
};</p>

<p>ä¿®æ”¹æˆ
const zend_function_entry myText_functions[] = {
        PHP_FE(confirm_myText_compiled, NULL)           /* For testing, remove later. <em>/
        PHP_FE(getext,NULL)
        PHP_FE_END      /</em> Must be the last line in myText_functions[] */
};</p>

<p>æ‰¾åˆ°PHP_FUNCTION(confirm_say_compiled)ï¼Œåœ¨å…¶ä¸Šé¢å¢åŠ å¦‚ä¸‹ä»£ç ï¼š
PHP_FUNCTION(getext)
{
    zend_string *strg;
    strg = strpprintf(0, â€œxiazemin hello wordâ€);
    RETURN_STR(strg);
}</p>

<p>make &amp; make install
$make install
Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20160303/</p>

<p>$php -r â€˜var_dump(getext(â€œ1234â€));â€™
string(19) â€œxiazemin hello wordâ€</p>

<p>æˆåŠŸäº†</p>

<p>https://www.jb51.net/article/132860.htm
https://www.jb51.net/article/170578.htm</p>

<p>https://blog.csdn.net/u011957758/article/details/72456298</p>

<p>https://blog.csdn.net/u011730334/article/details/80688870</p>

<p>https://blog.csdn.net/21aspnet/article/details/7345650
https://blog.csdn.net/p_Tsui/article/details/51918298</p>

<p>https://blog.csdn.net/u011957758/article/details/72456298</p>

<p>æ‰§è¡Œ./ext_skel  â€“extname=myText â€“proto=myExtIdl/getext.skel
æŠ¥é”™ ï¼š</p>

<p>awk: syntax error at source line 256 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs
 context is
					if (!stubs) print â€œâ€ &gt; extnameÂ Â»&gt;  â€œ/function_warningâ€ Â«&lt;
awk: illegal statement at source line 257 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs
awk: syntax error at source line 267 source file /Users/didi/PhpstormProjects/c/php-src/ext/skeleton/create_stubs</p>

<p>æ–‡ä»¶å¤¹æ˜¯èƒ½ç”Ÿæˆçš„ ä½†æ˜¯ç”Ÿäº§çš„æ–‡ä»¶é‡Œå¹¶æ²¡æœ‰Cæ‰©å±•å®šä¹‰çš„å‡½æ•° æ‰€ä»¥è¿™è¾¹çš„æŠ¥é”™åº”è¯¥è¿˜æ˜¯é€ æˆäº†å½±å“</p>

<p>https://segmentfault.com/q/1010000004493105/a-1020000004493268
ä¿®æ”¹ä¸€ä¸‹ ext/skeleton/create_stubs æ–‡ä»¶ä¸­ä¸‰å¤„ï¼š
256è¡Œ
æŠŠ</p>

<p>if (!stubs) print â€œâ€ &gt; extname â€œ/function_warningâ€
æ”¹ä¸º</p>

<p>if (!stubs) print â€œâ€ &gt; ( extname â€œ/function_warningâ€ )
è¿˜æœ‰267ã€268è¡Œï¼Œç›¸åŒã€‚</p>

<p>https://stackoverflow.com/questions/26798063/extension-php-with-c-creating-the-first-environment-i-got-awk-syntax-error-usin</p>

<p>é—®é¢˜è§£å†³äº†</p>

<p>$./ext_skel  â€“extname=myTextAwk â€“proto=myExtIdl/getext.skel
Creating directory myTextAwk
Creating basic files: config.m4 config.w32 .gitignore myTextAwk.c php_myTextAwk.h CREDITS EXPERIMENTAL tests/001.phpt myTextAwk.php [done].</p>

<p>To use your new extension, you will have to execute the following steps:</p>

<ol>
  <li>$ cd ..</li>
  <li>$ vi ext/myTextAwk/config.m4</li>
  <li>$ ./buildconf</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>$ ./configure â€“[with</td>
          <td>enable]-myTextAwk</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>$ make</li>
  <li>$ ./sapi/cli/php -f ext/myTextAwk/myTextAwk.php</li>
  <li>$ vi ext/myTextAwk/myTextAwk.c</li>
  <li>$ make</li>
</ol>

<p>Repeat steps 3-6 until you are satisfied with ext/myTextAwk/config.m4 and
step 6 confirms that your module is compiled into PHP. Then, start writing
code and repeat the last two steps as often as necessary.</p>

<p>vi myTextAwk.cå‘ç°å·²ç»ç”Ÿæˆäº†æ–‡ä»¶å®šä¹‰</p>

<p>/* {{{ proto string getext(string str)
    */
PHP_FUNCTION(getext)
{
	char *str = NULL;
	int argc = ZEND_NUM_ARGS();
	size_t str_len;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(argc, "s", &amp;str, &amp;str_len) == FAILURE) 
	return;

php_error(E_WARNING, "getext: not yet implemented"); } /* }}} */
</code></pre></div></div>

<p>https://wiki.jikexueyuan.com/project/extending-embedding-php/12.4.html</p>

<p>https://blog.csdn.net/linkaisheng101990/article/details/45625103</p>

<p>https://blog.csdn.net/u011957758/article/details/72456298
https://www.php.net/manual/zh/internals2.buildsys.skeleton.php</p>

<p>https://www.laruence.com/2009/04/28/719.html</p>

<p>ä¸ºäº†è·å¾—å‡½æ•°ä¼ é€’çš„å‚æ•°ï¼Œå¯ä»¥ä½¿ç”¨zend_parse_parameters()APIå‡½æ•°ã€‚
ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¼ é€’ç»™å‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚é€šå¸¸çš„åšæ³•æ˜¯ä¼ ç»™å®ƒZEND_NUM_ARGS()ã€‚è¿™æ˜¯ä¸€ä¸ªè¡¨ç¤ºä¼ é€’ç»™å‡½æ•°å‚æ•°æ€»ä¸ªæ•°çš„å®ã€‚ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸ºäº†çº¿ç¨‹å®‰å…¨ï¼Œæ€»æ˜¯ä¼ é€’TSRMLS_CCå®ï¼Œåé¢ä¼šè®²åˆ°ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ŒæŒ‡å®šäº†å‡½æ•°æœŸæœ›çš„å‚æ•°ç±»å‹ï¼Œåé¢ç´§è·Ÿç€éœ€è¦éšå‚æ•°å€¼æ›´æ–°çš„å˜é‡åˆ—è¡¨ã€‚å› ä¸ºPHPé‡‡ç”¨æ¾æ•£çš„å˜é‡å®šä¹‰å’ŒåŠ¨æ€çš„ç±»å‹åˆ¤æ–­ï¼Œè¿™æ ·åšå°±ä½¿å¾—æŠŠä¸åŒç±»å‹çš„å‚æ•°è½¬åŒ–ä¸ºæœŸæœ›çš„ç±»å‹æˆä¸ºå¯èƒ½ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·ä¼ é€’ä¸€ä¸ªæ•´æ•°å˜é‡ï¼Œå¯å‡½æ•°éœ€è¦ä¸€ä¸ªæµ®ç‚¹æ•°ï¼Œé‚£ä¹ˆzend_parse_parameters()å°±ä¼šè‡ªåŠ¨åœ°æŠŠæ•´æ•°è½¬æ¢ä¸ºç›¸åº”çš„æµ®ç‚¹æ•°ã€‚å¦‚æœå®é™…å€¼æ— æ³•è½¬æ¢æˆæœŸæœ›ç±»å‹ï¼ˆæ¯”å¦‚æ•´å½¢åˆ°æ•°ç»„å½¢ï¼‰ï¼Œä¼šè§¦å‘ä¸€ä¸ªè­¦å‘Šã€‚</p>

<p>séœ€è¦ä¸¤ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ é€’å‚è€ƒchar * å’Œ int (str å’Œ str_len)ç»™zend_parse_parameters()å‡½æ•°ã€‚æ— è®ºä»€ä¹ˆæ—¶å€™ï¼Œè®°å¾—æ€»æ˜¯åœ¨ä»£ç ä¸­ä½¿ç”¨å­—ç¬¦ä¸²é•¿åº¦str_lenæ¥ç¡®ä¿å‡½æ•°å·¥ä½œåœ¨äºŒè¿›åˆ¶å®‰å…¨çš„ç¯å¢ƒä¸­ã€‚ä¸è¦ä½¿ç”¨strlen()å’Œstrcpy()ï¼Œé™¤éä½ ä¸ä»‹æ„å‡½æ•°åœ¨äºŒè¿›åˆ¶å­—ç¬¦ä¸²ä¸‹ä¸èƒ½å·¥ä½œã€‚äºŒè¿›åˆ¶å­—ç¬¦ä¸²æ˜¯åŒ…å«æœ‰nullsçš„å­—ç¬¦ä¸²ã€‚äºŒè¿›åˆ¶æ ¼å¼åŒ…æ‹¬å›¾è±¡æ–‡ä»¶ï¼Œå‹ç¼©æ–‡ä»¶ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å’Œæ›´å¤šçš„å…¶ä»–æ–‡ä»¶ã€‚â€lâ€ åªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼ é€’ç»™å®ƒnçš„å¼•ç”¨ã€‚å°½ç®¡ä¸ºäº†æ¸…æ™°èµ·è§ï¼Œéª¨æ¶è„šæœ¬ç”Ÿæˆçš„Cå˜é‡åä¸åœ¨å‡½æ•°åŸå‹å®šä¹‰æ–‡ä»¶ä¸­çš„å‚æ•°åä¸€æ ·ï¼›è¿™æ ·åšä¸æ˜¯å¿…é¡»çš„ï¼Œå°½ç®¡åœ¨å®è·µä¸­é¼“åŠ±è¿™æ ·åšã€‚
å›åˆ°è½¬æ¢è§„åˆ™ä¸­æ¥ã€‚ä¸‹é¢ä¸‰ä¸ªå¯¹self_concat()å‡½æ•°çš„è°ƒç”¨ä½¿str, str_lenå’Œnå¾—åˆ°åŒæ ·çš„å€¼ï¼š</p>

<p>self_concat(â€œ321â€, 5);
self_concat(321, â€œ5â€);
self_concat(â€œ321â€, â€œ5â€);
str points to the string â€œ321â€, str_len equals 3, and n equals 5.
str æŒ‡å‘å­—ç¬¦ä¸²â€321â€ï¼Œstr_lenç­‰äº3ï¼Œnç­‰äº5ã€‚
åœ¨æˆ‘ä»¬ç¼–å†™ä»£ç æ¥å®ç°è¿æ¥å­—ç¬¦ä¸²è¿”å›ç»™PHPçš„å‡½æ•°å‰ï¼Œè¿˜å¾—è°ˆè°ˆä¸¤ä¸ªé‡è¦çš„è¯é¢˜ï¼šå†…å­˜ç®¡ç†ã€ä»PHPå†…éƒ¨è¿”å›å‡½æ•°å€¼æ‰€ä½¿ç”¨çš„APIã€‚</p>

<p>ç”¨äºä»å †ä¸­åˆ†é…å†…å­˜çš„PHP APIå‡ ä¹å’Œæ ‡å‡†C APIä¸€æ ·ã€‚åœ¨ç¼–å†™æ‰©å±•çš„æ—¶å€™ï¼Œä½¿ç”¨ä¸‹é¢ä¸Cå¯¹åº”ï¼ˆå› æ­¤ä¸å¿…å†è§£é‡Šï¼‰çš„APIå‡½æ•°ï¼š</p>

<p>emalloc(size_t size);
efree(void *ptr);
ecalloc(size_t nmemb, size_t size);
erealloc(void *ptr, size_t size);
estrdup(const char *s);
estrndup(const char *s, unsigned int length);</p>

<p>æ ‡å‡†Cæ²¡æœ‰strndup()ï¼Ÿâ€æ˜¯çš„ï¼Œè¿™æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºGNUæ‰©å±•é€šå¸¸åœ¨Linuxä¸‹å¯ç”¨ã€‚estrndup()åªæ˜¯PHPä¸‹çš„ä¸€ä¸ªç‰¹æ®Šå‡½æ•°ã€‚å®ƒçš„è¡Œä¸ºä¸estrdup()ç›¸ä¼¼ï¼Œä½†æ˜¯å¯ä»¥æŒ‡å®šå­—ç¬¦ä¸²é‡å¤çš„æ¬¡æ•°ï¼ˆä¸éœ€è¦ç»“æŸç©ºå­—ç¬¦ï¼‰ï¼ŒåŒæ—¶æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ã€‚è¿™æ˜¯æ¨èä½¿ç”¨estrndup()è€Œä¸æ˜¯estrdup()çš„åŸå› ã€‚</p>

<p>æœ‰ä¸€äº›æƒ…å†µï¼Œå³æ‰©å±•éœ€è¦åˆ†é…åœ¨è¯·æ±‚ä¸­æ°¸ä¹…å­˜åœ¨çš„å†…å­˜ï¼Œä»è€Œä¸å¾—ä¸ä½¿ç”¨malloc()ï¼Œä½†æ˜¯é™¤éä½ çŸ¥é“ä½ åœ¨åšä»€ä¹ˆï¼Œä½ åº”è¯¥å§‹ç»ˆä½¿ç”¨ä»¥ä¸Šçš„å‡½æ•°ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨è¿™äº›å†…å­˜å‡½æ•°ï¼Œè€Œç›¸åä½¿ç”¨æ ‡å‡†Cå‡½æ•°åˆ†é…çš„å†…å­˜è¿”å›ç»™è„šæœ¬å¼•æ“ï¼Œé‚£ä¹ˆPHPä¼šå´©æºƒã€‚
è¿™äº›å‡½æ•°çš„ä¼˜ç‚¹æ˜¯ï¼šä»»ä½•åˆ†é…çš„å†…å­˜åœ¨å¶ç„¶æƒ…å†µä¸‹å¦‚æœæ²¡æœ‰è¢«é‡Šæ”¾ï¼Œåˆ™ä¼šåœ¨é¡µé¢è¯·æ±‚çš„æœ€åè¢«é‡Šæ”¾ã€‚å› æ­¤ï¼ŒçœŸæ­£çš„å†…å­˜æ³„æ¼ä¸ä¼šäº§ç”Ÿã€‚ç„¶è€Œï¼Œä¸è¦ä¾èµ–è¿™ä¸€æœºåˆ¶ï¼Œä»è°ƒè¯•å’Œæ€§èƒ½ä¸¤ä¸ªåŸå› æ¥è€ƒè™‘ï¼Œåº”å½“ç¡®ä¿é‡Šæ”¾åº”è¯¥é‡Šæ”¾çš„å†…å­˜ã€‚å‰©ä¸‹çš„ä¼˜ç‚¹æ˜¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ€§èƒ½çš„æé«˜ï¼Œè°ƒè¯•æ¨¡å¼ä¸‹æ£€æµ‹å†…å­˜é”™è¯¯ç­‰ã€‚</p>

<p>ä»PHPå‡½æ•°ä¸­è¿”å›å€¼
æ‰©å±•APIåŒ…å«ä¸°å¯Œçš„ç”¨äºä»å‡½æ•°ä¸­è¿”å›å€¼çš„å®ã€‚è¿™äº›å®æœ‰ä¸¤ç§ä¸»è¦é£æ ¼ï¼šç¬¬ä¸€ç§æ˜¯RETVAL_type()å½¢å¼ï¼Œå®ƒè®¾ç½®äº†è¿”å›å€¼ä½†Cä»£ç ç»§ç»­æ‰§è¡Œã€‚è¿™é€šå¸¸ä½¿ç”¨åœ¨æŠŠæ§åˆ¶äº¤ç»™è„šæœ¬å¼•æ“å‰è¿˜å¸Œæœ›åšçš„ä¸€äº›æ¸…ç†å·¥ä½œçš„æ—¶å€™ä½¿ç”¨ï¼Œç„¶åå†ä½¿ç”¨Cçš„è¿”å›å£°æ˜ â€returnâ€ è¿”å›åˆ°PHPï¼›åä¸€ä¸ªå®æ›´åŠ æ™®éï¼Œå…¶å½¢å¼æ˜¯RETURN_type()ï¼Œä»–è®¾ç½®äº†è¿”å›ç±»å‹ï¼ŒåŒæ—¶è¿”å›æ§åˆ¶åˆ°PHPã€‚ä¸‹è¡¨è§£é‡Šäº†å¤§å¤šæ•°å­˜åœ¨çš„å®ã€‚</p>

<p>è®¾ç½®è¿”å›å€¼å¹¶ä¸”ç»“æŸå‡½æ•°	è®¾ç½®è¿”å›å€¼	å®è¿”å›ç±»å‹å’Œå‚æ•°
RETURN_LONG(l)	RETVAL_LONG(l)	æ•´æ•°
RETURN_BOOL(b)	RETVAL_BOOL(b)	å¸ƒå°”æ•°(1æˆ–0)
RETURN_NULL()	RETVAL_NULL()	NULL
RETURN_DOUBLE(d)	RETVAL_DOUBLE(d)	æµ®ç‚¹æ•°
RETURN_STRING(s, dup)	RETVAL_STRING(s, dup)	å­—ç¬¦ä¸²ã€‚å¦‚æœdupä¸º1ï¼Œå¼•æ“ä¼šè°ƒç”¨estrdup()é‡å¤sï¼Œä½¿ç”¨æ‹·è´ã€‚å¦‚æœdupä¸º0ï¼Œå°±ä½¿ç”¨s
RETURN_STRINGL(s, l, dup)	RETVAL_STRINGL(s, l, dup)	é•¿åº¦ä¸ºlçš„å­—ç¬¦ä¸²å€¼ã€‚ä¸ä¸Šä¸€ä¸ªå®ä¸€æ ·ï¼Œä½†å› ä¸ºsçš„é•¿åº¦è¢«æŒ‡å®šï¼Œæ‰€ä»¥é€Ÿåº¦æ›´å¿«ã€‚
RETURN_TRUE	RETVAL_TRUE	è¿”å›å¸ƒå°”å€¼trueã€‚æ³¨æ„åˆ°è¿™ä¸ªå®æ²¡æœ‰æ‹¬å·ã€‚
RETURN_FALSE	RETVAL_FALSE	è¿”å›å¸ƒå°”å€¼falseã€‚æ³¨æ„åˆ°è¿™ä¸ªå®æ²¡æœ‰æ‹¬å·ã€‚
RETURN_RESOURCE(r)	RETVAL_RESOURCE(r)	èµ„æºå¥æŸ„ã€‚</p>

<p>./ext_skel  â€“extname=myTextAwk â€“proto=myExtIdl/getext.skel</p>

<p>741   cd myTextAwk/
  742  phpize
  743  ./configure â€“with-php-config=/usr/local/php/man/man1/php-config.1 -with-php-config=/usr/local/bin/php-config
  744  make &amp; make install</p>

<p>Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20160303/
[1]+  Done</p>

<p>PHP Warning:  Function registration failed - duplicate name - getext in Unknown on line 0</p>

<p>Warning: Function registration failed - duplicate name - getext in Unknown on line 0
PHP Warning:  myTextAwk: Unable to register functions, unable to load in Unknown on line 0</p>

<p>Warning: myTextAwk: Unable to register functions, unable to load in Unknown on line 0
Segmentation fault: 11</p>

<p>åå­—å†²çªäº†ï¼Œå¹²æ‰å‰é¢é‚£ä¸ªæ‰©å±•
k$php -r â€˜var_dump(getext(â€œ1234â€,3));â€™
string(12) â€œ123412341234â€
[Wed May 27 20:28:17 2020]  Script:  â€˜-â€˜
/Users/didi/PhpstormProjects/c/php-src/ext/myTextAwk/myTextAwk.c(96) :  Freeing 0x00000001098620f0 (13 bytes), script=-
=== Total 1 memory leaks detected ===</p>

<p>åŒ…è£¹ç¬¬ä¸‰æ–¹çš„æ‰©å±•
æœ¬èŠ‚ä¸­ä½ å°†å­¦åˆ°å¦‚ä½•ç¼–å†™æ›´æœ‰ç”¨å’Œæ›´å®Œå–„çš„æ‰©å±•ã€‚è¯¥èŠ‚çš„æ‰©å±•åŒ…è£¹äº†ä¸€ä¸ªCåº“ï¼Œå±•ç¤ºäº†å¦‚ä½•ç¼–å†™ä¸€ä¸ªå«æœ‰å¤šä¸ªäº’ç›¸ä¾èµ–çš„PHPå‡½æ•°æ‰©å±•ã€‚</p>

<p>ä¹Ÿè®¸æœ€å¸¸è§çš„PHPæ‰©å±•æ˜¯é‚£äº›åŒ…è£¹ç¬¬ä¸‰æ–¹Cåº“çš„æ‰©å±•ã€‚è¿™äº›æ‰©å±•åŒ…æ‹¬MySQLæˆ–Oracleçš„æ•°æ®åº“æœåŠ¡åº“ï¼Œlibxml2çš„ XMLæŠ€æœ¯åº“ï¼ŒImageMagick æˆ–GDçš„å›¾å½¢æ“çºµåº“ã€‚
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ‰©å±•ï¼ŒåŒæ ·ä½¿ç”¨è„šæœ¬æ¥ç”Ÿæˆéª¨æ¶æ‰©å±•ï¼Œå› ä¸ºè¿™èƒ½èŠ‚çœè®¸å¤šå·¥ä½œé‡ã€‚è¿™ä¸ªæ‰©å±•åŒ…è£¹äº†æ ‡å‡†Cå‡½æ•°fopen(), fclose(), fread(), fwrite()å’Œ feof().
æ‰©å±•ä½¿ç”¨ä¸€ä¸ªè¢«å«åšèµ„æºçš„æŠ½è±¡æ•°æ®ç±»å‹ï¼Œç”¨äºä»£è¡¨å·²æ‰“å¼€çš„æ–‡ä»¶FILE*ã€‚ä½ ä¼šæ³¨æ„åˆ°å¤§å¤šæ•°å¤„ç†æ¯”å¦‚æ•°æ®åº“è¿æ¥ã€æ–‡ä»¶å¥æŸ„ç­‰çš„PHPæ‰©å±•ä½¿ç”¨äº†èµ„æºç±»å‹ï¼Œè¿™æ˜¯å› ä¸ºå¼•æ“è‡ªå·±æ— æ³•ç›´æ¥â€œç†è§£â€å®ƒä»¬ã€‚</p>

<p>ä»¥ä¸‹æ˜¯PHPé£æ ¼çš„APIï¼š</p>

<p>resource file_open(string filename, string mode)
file_open() //æ¥æ”¶ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼ˆæ–‡ä»¶åå’Œæ¨¡å¼ï¼‰ï¼Œè¿”å›ä¸€ä¸ªæ–‡ä»¶çš„èµ„æºå¥æŸ„ã€‚
bool file_close(resource filehandle)
file_close() //æ¥æ”¶ä¸€ä¸ªèµ„æºå¥æŸ„ï¼Œè¿”å›çœŸ/å‡æŒ‡ç¤ºæ˜¯å¦æ“ä½œæˆåŠŸã€‚</p>

<p>æˆ‘ä»¬çš„å‡½æ•°å®šä¹‰æ–‡ä»¶â€”â€”ä¿å­˜ä¸ºext/ç›®å½•ä¸‹çš„myfile.defâ€”â€”å†…å®¹å¦‚ä¸‹ï¼š</p>

<p>resource file_open(string filename, string mode)
bool file_close(resource filehandle)
string file_read(resource filehandle, int size)
bool file_write(resource filehandle, string buffer)
bool file_eof(resource filehandle)</p>

<p>$./ext_skel â€“extname=myFile â€“proto=myExtIdl/myFile.skel</p>

<p>èµ„æºæ˜¯ä¸€ä¸ªèƒ½å®¹çº³ä»»ä½•ä¿¡æ¯çš„æŠ½è±¡æ•°æ®ç»“æ„ã€‚æ­£å¦‚å‰é¢æåˆ°çš„ï¼Œè¿™ä¸ªä¿¡æ¯é€šå¸¸åŒ…æ‹¬ä¾‹å¦‚æ–‡ä»¶å¥æŸ„ã€æ•°æ®åº“è¿æ¥ç»“æ„å’Œå…¶ä»–ä¸€äº›å¤æ‚ç±»å‹çš„æ•°æ®ã€‚
ä½¿ç”¨èµ„æºçš„ä¸»è¦åŸå› æ˜¯å› ä¸ºï¼šèµ„æºè¢«ä¸€ä¸ªé›†ä¸­çš„é˜Ÿåˆ—æ‰€ç®¡ç†ï¼Œè¯¥é˜Ÿåˆ—å¯ä»¥åœ¨PHPå¼€å‘äººå‘˜æ²¡æœ‰åœ¨è„šæœ¬é‡Œé¢æ˜¾å¼åœ°é‡Šæ”¾æ—¶å¯ä»¥è‡ªåŠ¨åœ°è¢«é‡Šæ”¾ã€‚
ä¸¾ä¸ªä¾‹å­ï¼Œè€ƒè™‘åˆ°ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œåœ¨è„šæœ¬é‡Œè°ƒç”¨mysql_connect()æ‰“å¼€ä¸€ä¸ªMySQLè¿æ¥ï¼Œå¯æ˜¯å½“è¯¥æ•°æ®åº“è¿æ¥èµ„æºä¸å†ä½¿ç”¨æ—¶å´æ²¡æœ‰è°ƒç”¨mysql_close()ã€‚åœ¨PHPé‡Œï¼Œèµ„æºæœºåˆ¶èƒ½å¤Ÿæ£€æµ‹ä»€ä¹ˆæ—¶å€™è¿™ä¸ªèµ„æºåº”å½“è¢«é‡Šæ”¾ï¼Œç„¶ååœ¨å½“å‰è¯·æ±‚çš„ç»“å°¾æˆ–é€šå¸¸æƒ…å†µä¸‹æ›´æ—©åœ°é‡Šæ”¾èµ„æºã€‚è¿™å°±ä¸ºå‡å°‘å†…å­˜æ³„æ¼èµ‹äºˆäº†ä¸€ä¸ªâ€œé˜²å¼¹â€æœºåˆ¶ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·ä¸€ä¸ªæœºåˆ¶ï¼Œç»è¿‡å‡ æ¬¡webè¯·æ±‚åï¼ŒwebæœåŠ¡å™¨ä¹Ÿè®¸ä¼šæ½œåœ¨åœ°æ³„æ¼è®¸å¤šå†…å­˜èµ„æºï¼Œä»è€Œå¯¼è‡´æœåŠ¡å™¨å½“æœºæˆ–å‡ºé”™ã€‚</p>

<p>æ³¨å†Œèµ„æºç±»å‹
å¦‚ä½•ä½¿ç”¨èµ„æºï¼ŸZendå¼•æ“è®©ä½¿ç”¨èµ„æºå˜åœ°éå¸¸å®¹æ˜“ã€‚ä½ è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯æŠŠèµ„æºæ³¨å†Œåˆ°å¼•æ“ä¸­å»ã€‚ä½¿ç”¨è¿™ä¸ªAPIå‡½æ•°ï¼š</p>

<p>int zend_register_list_destructors_ex(rsrc_dtor_func_t ld, rsrc_dtor_func_t pld, char *type_name, int module_number)
è¿™ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªèµ„æºç±»å‹idï¼Œè¯¥idåº”å½“è¢«ä½œä¸ºå…¨å±€å˜é‡ä¿å­˜åœ¨æ‰©å±•é‡Œï¼Œä»¥ä¾¿åœ¨å¿…è¦çš„æ—¶å€™ä¼ é€’ç»™å…¶ä»–èµ„æºAPIã€‚ldï¼šè¯¥èµ„æºé‡Šæ”¾æ—¶è°ƒç”¨çš„å‡½æ•°ã€‚pldç”¨äºåœ¨ä¸åŒè¯·æ±‚ä¸­å§‹ç»ˆå­˜åœ¨çš„æ°¸ä¹…èµ„æºï¼Œæœ¬ç« ä¸ä¼šæ¶‰åŠã€‚type_nameæ˜¯ä¸€ä¸ªå…·æœ‰æè¿°æ€§ç±»å‹åç§°çš„å­—ç¬¦ä¸²ï¼Œmodule_numberä¸ºå¼•æ“å†…éƒ¨ä½¿ç”¨ï¼Œå½“æˆ‘ä»¬è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä¼ é€’ä¸€ä¸ªå·²ç»å®šä¹‰å¥½çš„module_numberå˜é‡</p>

<p>æ–°å»ºå’Œæ³¨å†Œæ–°èµ„æº æˆ‘ä»¬å‡†å¤‡å®ç°file_open()å‡½æ•°ã€‚å½“æˆ‘ä»¬æ‰“å¼€æ–‡ä»¶å¾—åˆ°ä¸€ä¸ªFILE *ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨èµ„æºæœºåˆ¶æ³¨å†Œå®ƒã€‚ä¸‹é¢çš„ä¸»è¦å®å®ç°æ³¨å†ŒåŠŸèƒ½ï¼š</p>

<p>ZEND_REGISTER_RESOURCE(rsrc_result, rsrc_pointer, rsrc_type);</p>

<p>å…¨å±€å˜é‡
ä½ å¯èƒ½å¸Œæœ›åœ¨æ‰©å±•é‡Œä½¿ç”¨å…¨å±€Cå˜é‡ï¼Œæ— è®ºæ˜¯ç‹¬è‡ªåœ¨å†…éƒ¨ä½¿ç”¨æˆ–è®¿é—®php.iniæ–‡ä»¶ä¸­çš„INIæ‰©å±•æ³¨å†Œæ ‡è®°ï¼ˆINIåœ¨ä¸‹ä¸€èŠ‚ä¸­è®¨è®ºï¼‰ã€‚å› ä¸ºPHPæ˜¯ä¸ºå¤šçº¿ç¨‹ç¯å¢ƒè€Œè®¾è®¡ï¼Œæ‰€ä»¥ä¸å¿…å®šä¹‰å…¨å±€å˜é‡ã€‚PHPæä¾›äº†ä¸€ä¸ªåˆ›å»ºå…¨å±€å˜é‡çš„æœºåˆ¶ï¼Œå¯ä»¥åŒæ—¶åº”ç”¨åœ¨çº¿ç¨‹å’Œéçº¿ç¨‹ç¯å¢ƒä¸­ã€‚æˆ‘ä»¬åº”å½“å§‹ç»ˆåˆ©ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œè€Œä¸è¦è‡ªä¸»åœ°å®šä¹‰å…¨å±€å˜é‡ã€‚ç”¨ä¸€ä¸ªå®è®¿é—®è¿™äº›å…¨å±€å˜é‡ï¼Œä½¿ç”¨èµ·æ¥å°±åƒæ™®é€šå…¨å±€å˜é‡ä¸€æ ·ã€‚
ç”¨äºç”Ÿæˆmyfileå·¥ç¨‹éª¨æ¶æ–‡ä»¶çš„ext_skelè„šæœ¬åˆ›å»ºäº†å¿…è¦çš„ä»£ç æ¥æ”¯æŒå…¨å±€å˜é‡ã€‚é€šè¿‡æ£€æŸ¥php_myfile.hæ–‡ä»¶ï¼Œä½ åº”å½“å‘ç°ç±»ä¼¼ä¸‹é¢çš„è¢«æ³¨é‡Šæ‰çš„ä¸€èŠ‚ï¼Œ</p>

<p>ZEND_BEGIN_MODULE_GLOBALS(myfile)
int global_value;
char *global_string;
ZEND_END_MODULE_GLOBALS(myfile)
ä½ å¯ä»¥æŠŠè¿™ä¸€èŠ‚çš„æ³¨é‡Šå»æ‰ï¼ŒåŒæ—¶æ·»åŠ ä»»ä½•å…¶ä»–å…¨å±€å˜é‡äºè¿™ä¸¤ä¸ªå®ä¹‹é—´ã€‚æ–‡ä»¶åéƒ¨çš„å‡ è¡Œï¼Œéª¨æ¶è„šæœ¬è‡ªåŠ¨åœ°å®šä¹‰ä¸€ä¸ªMYFILE_G(v)å®ã€‚è¿™ä¸ªå®åº”å½“è¢«ç”¨äºæ‰€æœ‰çš„ä»£ç ï¼Œä»¥ä¾¿è®¿é—®è¿™äº›å…¨å±€å˜é‡ã€‚è¿™å°±ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œè®¿é—®çš„å…¨å±€å˜é‡ä»…æ˜¯ä¸€ä¸ªçº¿ç¨‹çš„æ‹·è´ï¼Œè€Œä¸éœ€è¦äº’æ–¥çš„æ“ä½œã€‚</p>

<p>ä¸ºäº†ä½¿å…¨å±€å˜é‡æœ‰æ•ˆï¼Œæœ€åéœ€è¦åšçš„æ˜¯æŠŠmyfile.cï¼š</p>

<p>ZEND_DECLARE_MODULE_GLOBALS(myfile)
æ³¨é‡Šå»æ‰ã€‚</p>

<p>ä½ ä¹Ÿè®¸å¸Œæœ›åœ¨æ¯æ¬¡PHPè¯·æ±‚çš„å¼€å§‹åˆå§‹åŒ–å…¨å±€å˜é‡ã€‚å¦å¤–ï¼Œåšä¸ºä¸€ä¸ªä¾‹å­ï¼Œå…¨å±€å˜é‡å·²æŒ‡å‘äº†ä¸€ä¸ªå·²åˆ†é…çš„å†…å­˜ï¼Œåœ¨æ¯æ¬¡PHPè¯·æ±‚ç»“æŸæ—¶éœ€è¦é‡Šæ”¾å†…å­˜ã€‚ä¸ºäº†è¾¾åˆ°è¿™äº›ç›®çš„ï¼Œå…¨å±€å˜é‡æœºåˆ¶æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„å®ï¼Œç”¨äºæ³¨å†Œå…¨å±€å˜é‡çš„æ„é€ å’Œææ„å‡½æ•°ï¼ˆå‚è€ƒè¡¨å¯¹å®å‚æ•°çš„è¯´æ˜ï¼‰ï¼š</p>

<p>ZEND_INIT_MODULE_GLOBALS(module_name, globals_ctor, globals_dtor)</p>

<p>æ·»åŠ è‡ªå®šä¹‰INIæŒ‡ä»¤
INIæ–‡ä»¶(php.ini)çš„å®ç°ä½¿å¾—PHPæ‰©å±•æ³¨å†Œå’Œç›‘å¬å„è‡ªçš„INIæ¡ç›®ã€‚å¦‚æœè¿™äº›INIæ¡ç›®ç”±php.iniã€Apacheçš„htaccessæˆ–å…¶ä»–é…ç½®æ–¹æ³•æ¥èµ‹å€¼ï¼Œæ³¨å†Œçš„INIå˜é‡æ€»æ˜¯æ›´æ–°åˆ°æ­£ç¡®çš„å€¼ã€‚æ•´ä¸ªINIæ¡†æ¶æœ‰è®¸å¤šä¸åŒçš„é€‰é¡¹ä»¥å®ç°å…¶çµæ´»æ€§ã€‚æˆ‘ä»¬æ¶‰åŠä¸€äº›åŸºæœ¬çš„ï¼ˆä¹Ÿæ˜¯ä¸ªå¥½çš„å¼€ç«¯ï¼‰ï¼Œå€ŸåŠ©æœ¬ç« çš„å…¶ä»–ææ–™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåº”ä»˜æ—¥å¸¸å¼€å‘å·¥ä½œçš„éœ€è¦ã€‚
é€šè¿‡åœ¨PHP_INI_BEGIN()/PHP_INI_END()å®ä¹‹é—´çš„STD_PHP_INI_ENTRY()å®æ³¨å†ŒPHP INIæŒ‡ä»¤ã€‚ä¾‹å¦‚åœ¨æˆ‘ä»¬çš„ä¾‹å­é‡Œï¼Œmyfile.cä¸­çš„æ³¨å†Œè¿‡ç¨‹åº”å½“å¦‚ä¸‹ï¼š</p>

<p>PHP_INI_BEGIN()
STD_PHP_INI_ENTRY(â€œmyfile.global_valueâ€, â€œ42â€, PHP_INI_ALL, OnUpdateInt, global_value, zend_myfile_globals, myfile_globals)
STD_PHP_INI_ENTRY(â€œmyfile.global_stringâ€, â€œfoobarâ€, PHP_INI_ALL, OnUpdateString, global_string, zend_myfile_globals, myfile_globals)
PHP_INI_END()
é™¤äº†STD_PHP_INI_ENTRY()å…¶ä»–å®ä¹Ÿèƒ½å¤Ÿä½¿ç”¨ï¼Œä½†è¿™ä¸ªå®æ˜¯æœ€å¸¸ç”¨çš„ï¼Œå¯ä»¥æ»¡è¶³å¤§å¤šæ•°éœ€è¦ï¼ˆå‚çœ‹è¡¨å¯¹å®å‚æ•°çš„è¯´æ˜ï¼‰ï¼š</p>

<p>STD_PHP_INI_ENTRY(name, default_value, modifiable, on_modify, property_name, struct_type, struct_ptr)</p>

<p>çº¿ç¨‹å®‰å…¨èµ„æºç®¡ç†å®
ç°åœ¨ï¼Œä½ è‚¯å®šæ³¨æ„åˆ°ä»¥TSRMï¼ˆçº¿ç¨‹å®‰å…¨èµ„æºç®¡ç†å™¨ï¼‰å¼€å¤´çš„å®éšå¤„ä½¿ç”¨ã€‚è¿™äº›å®æä¾›ç»™æ‰©å±•æ‹¥æœ‰ç‹¬è‡ªçš„å…¨å±€å˜é‡çš„å¯èƒ½ï¼Œæ­£å¦‚å‰é¢æåˆ°çš„ã€‚
å½“ç¼–å†™PHPæ‰©å±•æ—¶ï¼Œæ— è®ºæ˜¯åœ¨å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œéƒ½æ˜¯ä¾é è¿™ä¸€æœºåˆ¶è®¿é—®æ‰©å±•è‡ªå·±çš„å…¨å±€å˜é‡ã€‚å¦‚æœä½¿ç”¨å…¨å±€å˜é‡è®¿é—®å®ï¼ˆä¾‹å¦‚MYFILE_G()å®ï¼‰ï¼Œéœ€è¦ç¡®ä¿TSRMä¸Šä¸‹æ–‡ä¿¡æ¯å‡ºç°åœ¨å½“å‰å‡½æ•°ä¸­ã€‚åŸºäºæ€§èƒ½çš„åŸå› ï¼ŒZendå¼•æ“è¯•å›¾æŠŠè¿™ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯ä½œä¸ºå‚æ•°ä¼ é€’åˆ°æ›´å¤šçš„åœ°æ–¹ï¼ŒåŒ…æ‹¬PHP_FUNCTION()çš„å®šä¹‰ã€‚æ­£å› ä¸ºè¿™æ ·ï¼Œåœ¨PHP_FUNCTION()å†…å½“ç¼–å†™çš„ä»£ç ä½¿ç”¨è®¿é—®å®ï¼ˆä¾‹å¦‚MYFILE_G()å®ï¼‰æ—¶ï¼Œä¸éœ€è¦åšä»»ä½•ç‰¹æ®Šçš„å£°æ˜ã€‚ç„¶è€Œï¼Œå¦‚æœPHPå‡½æ•°è°ƒç”¨å…¶ä»–éœ€è¦è®¿é—®å…¨å±€å˜é‡çš„Cå‡½æ•°ï¼Œè¦ä¹ˆæŠŠä¸Šä¸‹æ–‡ä½œä¸ºä¸€ä¸ªé¢å¤–çš„å‚æ•°ä¼ é€’ç»™Cå‡½æ•°ï¼Œè¦ä¹ˆæå–ä¸Šä¸‹æ–‡ï¼ˆè¦æ…¢ç‚¹ï¼‰ã€‚
åœ¨éœ€è¦è®¿é—®å…¨å±€å˜é‡çš„ä»£ç å—å¼€å¤´ä½¿ç”¨TSRMLS_FETCH()æ¥æå–ä¸Šä¸‹æ–‡ã€‚ä¾‹å¦‚ï¼š</p>

<p>void myfunc(){
     TSRMLS_FETCH();
     MYFILE_G(myglobal) = 2;
}</p>

<p>https://www.php.net/manual/en/internals2.ze1.zendapi.php</p>

:ET