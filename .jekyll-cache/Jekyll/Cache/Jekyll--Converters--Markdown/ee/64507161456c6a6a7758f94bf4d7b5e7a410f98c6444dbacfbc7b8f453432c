I"Ş<p>https://github.com/vishvananda/netlink
 æ·»åŠ ä¸€ä¸ªç½‘æ¡¥
 è®¾ç½®ç½‘æ¡¥åœ°å€ çŠ¶æ€
 å¾€ç½‘æ¡¥ä¸Šattachè®¾å¤‡
 è®¾ç½®iptables
 å°†vethè®¾å¤‡ä¸­çš„ä¸€ç«¯åŠ å…¥åˆ°æŸä¸ªnamespaceä¸­
 åˆ é™¤è®¾å¤‡
 https://www.jianshu.com/p/be7af63f666f?utm_campaign=maleskine&amp;utm_content=note&amp;utm_medium=seo_notes&amp;utm_source=recommendation
<!-- more -->
ä»€ä¹ˆæ˜¯netlinkï¼Ÿ</p>

<p>netlink æ˜¯ Linux ç³»ç»Ÿé‡Œç”¨æˆ·æ€ç¨‹åºã€å†…æ ¸æ¨¡å—ä¹‹é—´çš„ä¸€ç§ IPC æ–¹å¼ï¼Œç‰¹åˆ«æ˜¯ç”¨æˆ·æ€ç¨‹åºå’Œå†…æ ¸æ¨¡å—ä¹‹é—´çš„ IPC é€šä¿¡ã€‚æ¯”å¦‚åœ¨ Linux ç»ˆç«¯é‡Œå¸¸ç”¨çš„ ip å‘½ä»¤ï¼Œå°±æ˜¯ä½¿ç”¨ netlink å»è·Ÿå†…æ ¸è¿›è¡Œé€šä¿¡çš„ã€‚ä¾‹å¦‚æƒ³åœ¨golangä»£ç ä¸­å®ç°ip link add xxçš„æ•ˆæœï¼Œä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨execåŒ…æ‰§è¡Œå¯¹åº”çš„ipå‘½ä»¤ï¼Œå¦ä¸€ç§æ˜¯é‡‡ç”¨netlinkçš„æ–¹å¼ï¼Œä½†æ˜¯è‡ªå·±æ“ä½œnetlinkè¿˜æ˜¯æœ‰ç‚¹ç¹çã€‚</p>

<p>äºŒã€golang netlinkåº“</p>

<p>ç»™å¤§å®¶æ¨èä¸‹https://github.com/vishvananda/netlinkï¼Œä½¿å¾—åœ¨golangä¸­ä½¿ç”¨netlinkå˜çš„ç®€å•ï¼Œå¯¹ç¨‹åºå‘˜å°ä¼™ä¼´å¾ˆå‹å¥½ã€‚</p>

<p>netlink åŒ…ä¸º go æä¾›äº†ä¸€ä¸ªç®€å•çš„ netlink åº“ã€‚Netlink æ˜¯ linuxç”¨æˆ·æ€ç¨‹åºç”¨æ¥ä¸å†…æ ¸é€šä¿¡çš„æ¥å£ã€‚å®ƒå¯ç”¨äºæ·»åŠ å’Œåˆ é™¤æ¥å£ã€è®¾ç½® ip åœ°å€å’Œè·¯ç”±ä»¥åŠé…ç½® ipsecã€‚Netlink é€šä¿¡éœ€è¦æå‡æƒé™ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­¤ä»£ç éœ€è¦ä»¥ root èº«ä»½è¿è¡Œã€‚ç”±äºåº•å±‚ netlink æ¶ˆæ¯æ™¦æ¶©ä¸å¥½ç†è§£å’Œä½¿ç”¨ï¼Œå› æ­¤è¯¥åº“å°è¯•æä¾›ä¸€ä¸ªç®€æ˜“apiï¼Œè¯¥ API æ¨¡ä»¿äº† iproute2 æä¾›çš„ CLIã€‚è¯¸å¦‚ ip link add ä¹‹ç±»çš„æ“ä½œå°†é€šè¿‡ç±»ä¼¼å‘½åçš„å‡½æ•°ï¼ˆå¦‚ AddLink()ï¼‰æ¥å®Œæˆã€‚è¿™ä¸ªåº“æœ€åˆæ˜¯ docker/libcontainer ä¸­ netlink åŠŸèƒ½çš„ä¸€ä¸ªåˆ†æ”¯</p>

<p>https://blog.csdn.net/RA681t58CJxsgCkJ31/article/details/120714569</p>

<p>https://jishuin.proginn.com/p/763bfbd68ac8</p>

<p>https://vimsky.com/examples/detail/golang-ex-github.com.vishvananda.netlinkâ€”LinkSetMaster-function.html</p>

<p>https://segmentfault.com/a/1190000020360793
åŒæ—¶åœ¨ pkg/chaosdaemon åŒ…ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ° Chaos Daemon å¤„ç†è¯·æ±‚çš„æ–¹æ³•ã€‚</p>

<p>func (s <em>Server) SetNetem(ctx context.Context, in *pb.NetemRequest) (</em>empty.Empty, error) {    log.Info(â€œSet netemâ€, â€œRequestâ€, in)    pid, err := s.crClient.GetPidFromContainerID(ctx, in.ContainerId)    if err != nil {        return nil, status.Errorf(codes.Internal, â€œget pid from containerID error: %vâ€, err)    }    if err := Apply(in.Netem, pid); err != nil {        return nil, status.Errorf(codes.Internal, â€œnetem apply error: %vâ€, err)    }    return &amp;empty.Empty{}, nil}// Apply applies a netem on eth0 in pid related namespacefunc Apply(netem *pb.Netem, pid uint32) error {    log.Info(â€œApply netem on PIDâ€, â€œpidâ€, pid)    ns, err := netns.GetFromPath(GenNetnsPath(pid))    if err != nil {        log.Error(err, â€œfailed to find network namespaceâ€, â€œpidâ€, pid)        return errors.Trace(err)    }    defer ns.Close()    handle, err := netlink.NewHandleAt(ns)    if err != nil {        log.Error(err, â€œfailed to get handle at network namespaceâ€, â€œnetwork namespaceâ€, ns)        return err    }    link, err := handle.LinkByName(â€œeth0â€) // TODO: check whether interface name is eth0    if err != nil {        log.Error(err, â€œfailed to find eth0 interfaceâ€)        return errors.Trace(err)    }    netemQdisc := netlink.NewNetem(netlink.QdiscAttrs{        LinkIndex: link.Attrs().Index,        Handle:    netlink.MakeHandle(1, 0),        Parent:    netlink.HANDLE_ROOT,    }, ToNetlinkNetemAttrs(netem))    if err = handle.QdiscAdd(netemQdisc); err != nil {        if !strings.Contains(err.Error(), â€œfile existsâ€) {            log.Error(err, â€œfailed to add Qdiscâ€)            return errors.Trace(err)        }    }    return nil}
æœ€ç»ˆä½¿ç”¨ vishvananda/netlink[11] åº“æ“ä½œ Linux ç½‘ç»œæ¥å£æ¥å®Œæˆå·¥ä½œã€‚</p>

<p>è¿™é‡Œèƒ½å¤ŸçŸ¥é“ï¼ŒNetworkChaos æ··æ²Œç±»å‹ï¼Œæ“ä½œäº† Linux å®¿ä¸»æœºç½‘ç»œæ¥åˆ¶é€ æ··æ²Œï¼ŒåŒ…å« iptablesã€ipset ç­‰å·¥å…·ã€‚</p>

<p>https://cloud.tencent.com/developer/article/1895583
https://www.infoq.cn/article/vQFqtXzSZHUeY7slSUlA</p>
:ET