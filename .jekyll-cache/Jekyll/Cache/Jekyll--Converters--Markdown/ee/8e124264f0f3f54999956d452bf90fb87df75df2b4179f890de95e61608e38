I"yû<p>MySQL ä»5.0.3å¼€å§‹æ”¯æŒXAåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¸”åªæœ‰InnoDBå­˜å‚¨å¼•æ“æ”¯æŒã€‚MySQL Connector/J ä»5.0.0ç‰ˆæœ¬ä¹‹åå¼€å§‹ç›´æ¥æä¾›å¯¹XAçš„æ”¯æŒ
 åœ¨DTPæ¨¡å‹ä¸­ï¼Œmysqlå±äºèµ„æºç®¡ç†å™¨(RM)ã€‚è€Œä¸€ä¸ªå®Œæ•´çš„åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œä¸€èˆ¬ä¼šå­˜åœ¨å¤šä¸ªRMï¼Œç”±äº‹åŠ¡ç®¡ç†å™¨TMæ¥ç»Ÿä¸€è¿›è¡Œåè°ƒã€‚å› æ­¤ï¼Œè¿™é‡Œæ‰€è¯´çš„mysqlå¯¹XAåˆ†å¸ƒå¼äº‹åŠ¡çš„æ”¯æŒï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å•å°mysqlå®ä¾‹å¦‚ä½•æ‰§è¡Œè‡ªå·±çš„äº‹åŠ¡åˆ†æ”¯ã€‚
 MySQL XA äº‹åŠ¡SQLè¯­æ³•
https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html</p>

<p>XA {START|BEGIN} xid [JOIN|RESUME]   //å¼€å¯XAäº‹åŠ¡ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯XA STARTè€Œä¸æ˜¯XA BEGINï¼Œé‚£ä¹ˆä¸æ”¯æŒ[JOIN|RESUME]ï¼Œxidæ˜¯ä¸€ä¸ªå”¯ä¸€å€¼ï¼Œè¡¨ç¤ºäº‹åŠ¡åˆ†æ”¯æ ‡è¯†ç¬¦
XA END xid [SUSPEND [FOR MIGRATE]]   //ç»“æŸä¸€ä¸ªXAäº‹åŠ¡ï¼Œä¸æ”¯æŒ[SUSPEND [FOR MIGRATE]]
XA PREPARE xid å‡†å¤‡æäº¤
XA COMMIT xid [ONE PHASE] //æäº¤ï¼Œå¦‚æœä½¿ç”¨äº†ONE PHASEï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨ä¸€é˜¶æ®µæäº¤ã€‚ä¸¤é˜¶æ®µæäº¤åè®®ä¸­ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªRMå‚ä¸ï¼Œé‚£ä¹ˆå¯ä»¥ä¼˜åŒ–ä¸ºä¸€é˜¶æ®µæäº¤
XA ROLLBACK xid  //å›æ»š
XA RECOVER [CONVERT XID]  //åˆ—å‡ºæ‰€æœ‰å¤„äºPREPAREé˜¶æ®µçš„XAäº‹åŠ¡
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„msyql XAäº‹åŠ¡æ¡ˆä¾‹ï¼Œæ¼”ç¤ºäº†mysqlä½œä¸ºå…¨å±€äº‹åŠ¡ä¸­çš„ä¸€ä¸ªäº‹åŠ¡åˆ†æ”¯ï¼Œå°†ä¸€è¡Œè®°å½•æ’å…¥åˆ°ä¸€ä¸ªè¡¨ä¸­
mysql&gt; XA START â€˜xatestâ€™;  //å…¶ä¸­â€™xatestâ€™å°±æ˜¯xidçš„å€¼
Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql&gt; insert into user(name) values(â€œtianshozuhiâ€);
Query OK, 1 row affected (0.00 sec)</p>

<p>mysql&gt; XA END â€˜xatestâ€™;
Query OK, 0 rows affected (0.00 sec)</p>

<p>mysql&gt; XA PREPARE â€˜xatestâ€™;
Query OK, 0 rows affected (0.01 sec)</p>

<p>mysql&gt; XA COMMIT â€˜xatestâ€™;
Query OK, 0 rows affected (0.01 sec)</p>

<p>Mysql XAäº‹åŠ¡çŠ¶æ€
https://dev.mysql.com/doc/refman/5.7/en/xa-states.html</p>

<p>XAäº‹åŠ¡çš„çŠ¶æ€ï¼ŒæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡Œå±•å¼€</p>

<ol>
  <li>
    <p>ä½¿ç”¨XA STARTæ¥å¯åŠ¨ä¸€ä¸ªXAäº‹åŠ¡ï¼Œå¹¶æŠŠå®ƒç½®äºACTIVEçŠ¶æ€ã€‚</p>
  </li>
  <li>
    <p>å¯¹äºä¸€ä¸ªACTIVEçŠ¶æ€çš„ XAäº‹åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œæ„æˆäº‹åŠ¡çš„SQLè¯­å¥ï¼Œç„¶åå‘å¸ƒä¸€ä¸ªXA ENDè¯­å¥ã€‚XA ENDæŠŠäº‹åŠ¡æ”¾å…¥IDLEçŠ¶æ€ã€‚</p>
  </li>
  <li>
    <p>å¯¹äºä¸€ä¸ªIDLE çŠ¶æ€XAäº‹åŠ¡ï¼Œå¯ä»¥æ‰§è¡Œä¸€ä¸ªXA PREPAREè¯­å¥æˆ–ä¸€ä¸ªXA COMMITâ€¦ONE PHASEè¯­å¥ï¼š</p>
  </li>
</ol>

<p>XA PREPAREæŠŠäº‹åŠ¡æ”¾å…¥PREPAREDçŠ¶æ€ã€‚åœ¨æ­¤ç‚¹ä¸Šçš„XA RECOVERè¯­å¥å°†åœ¨å…¶è¾“å‡ºä¸­åŒ…æ‹¬äº‹åŠ¡çš„xidå€¼ï¼Œå› ä¸ºXA RECOVERä¼šåˆ—å‡ºå¤„äºPREPAREDçŠ¶æ€çš„æ‰€æœ‰XAäº‹åŠ¡ã€‚</p>

<p>XA COMMITâ€¦ONE PHASEç”¨äºé¢„å¤‡å’Œæäº¤äº‹åŠ¡ã€‚xidå€¼å°†ä¸ä¼šè¢«XA RECOVERåˆ—å‡ºï¼Œå› ä¸ºäº‹åŠ¡ç»ˆæ­¢ã€‚</p>

<ol>
  <li>å¯¹äºä¸€ä¸ªPREPAREDçŠ¶æ€çš„ XAäº‹åŠ¡ï¼Œæ‚¨å¯ä»¥å‘å¸ƒä¸€ä¸ªXA COMMITè¯­å¥æ¥æäº¤å’Œç»ˆæ­¢äº‹åŠ¡ï¼Œæˆ–è€…å‘å¸ƒXA ROLLBACKæ¥å›æ»šå¹¶ç»ˆæ­¢äº‹åŠ¡ã€‚</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é’ˆå¯¹ä¸€ä¸ªç»™å®šçš„å®¢æˆ·ç«¯è¿æ¥è€Œè¨€ï¼ŒXAäº‹åŠ¡å’ŒéXAäº‹åŠ¡(å³æœ¬åœ°äº‹åŠ¡)æ˜¯äº’æ–¥çš„ã€‚ä¾‹å¦‚ï¼Œå·²ç»æ‰§è¡Œäº†â€XA STARTâ€å‘½ä»¤æ¥å¼€å¯ä¸€ä¸ªXAäº‹åŠ¡ï¼Œåˆ™æœ¬åœ°äº‹åŠ¡ä¸ä¼šè¢«å¯åŠ¨ï¼Œç›´åˆ°XAäº‹åŠ¡å·²ç»è¢«æäº¤æˆ–è¢« å›æ»šä¸ºæ­¢ã€‚ç›¸åçš„ï¼Œå¦‚æœå·²ç»ä½¿ç”¨START TRANSACTIONå¯åŠ¨ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ï¼Œåˆ™XAè¯­å¥ä¸èƒ½è¢«ä½¿ç”¨ï¼Œç›´åˆ°è¯¥äº‹åŠ¡è¢«æäº¤æˆ–è¢« å›æ»šä¸ºæ­¢ã€‚

æœ€åï¼Œå¦‚æœä¸€ä¸ªXAäº‹åŠ¡å¤„äºACTIVEçŠ¶æ€ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¿›è¡Œæäº¤çš„ï¼Œå¦‚æœè¿™æ ·åšï¼Œmysqlä¼šæŠ›å‡ºå¼‚å¸¸ï¼š
</code></pre></div></div>

<p>ERROR 1399 (XAE07): XAER_RMFAIL: The command cannot be executed
when global transaction is in the ACTIVE state
3 å…³äºXIDçš„è¯´æ˜
mysqlä¸­ä½¿ç”¨xidæ¥ä½œä¸ºä¸€ä¸ªäº‹åŠ¡åˆ†æ”¯çš„æ ‡è¯†ç¬¦ã€‚äº‹å®ä¸Šxidä½œä¸ºäº‹åŠ¡åˆ†æ”¯æ ‡è¯†ç¬¦æ˜¯åœ¨XAè§„èŒƒä¸­å®šä¹‰çš„ï¼Œåœ¨Â«Â Distributed Transaction Processing: The XA SpecificationÂ» 4.2 èŠ‚ä¸­ï¼Œè§„å®šäº†ä¸€ä¸ªxidçš„ç»“æ„ï¼Œé€šè¿‡Cè¯­è¨€è¿›è¡Œæè¿°ï¼Œå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/âˆ—
âˆ— Transaction branch identification: XID and NULLXID:
âˆ—/
#define XIDDATASIZE 128  /âˆ— size in bytes âˆ—/
#define MAXGTRIDSIZE 64  /âˆ— maximum size in bytes of gtrid âˆ—/
#define MAXBQUALSIZE 64  /âˆ— maximum size in bytes of bqual âˆ—/
struct xid_t {
    long formatID;     /* format identifier */
    long gtrid_length; /* value 1-64 */
    long bqual_length; /* value 1-64 */
    char data[XIDDATASIZE];
    };
/âˆ—
âˆ— A value of -1 in formatID means that the XID is null.
âˆ—/
typedef struct xid_t XID;
/âˆ—
âˆ— Declarations of routines by which RMs call TMs:
âˆ—/
extern int ax_reg(int, XID âˆ—, long);
extern int ax_unreg(int, long); XAè§„èŒƒå®šä¹‰äº†ä¸€ä¸ªxidæœ‰4ä¸ªéƒ¨åˆ†ç»„æˆï¼š
</code></pre></div></div>

<p>gtridï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å…¨å±€äº‹åŠ¡æ ‡è¯†ç¬¦(global transaction identifier)ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡64å­—èŠ‚
</code></pre></div></div>

<p>bqualï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>åˆ†æ”¯é™å®šç¬¦(branch qualifier)ï¼Œæœ€å¤§ä¸èƒ½è¶…è¿‡64å­—èŠ‚
</code></pre></div></div>

<p>dataï¼š</p>

<p>xidçš„å€¼ï¼Œå…¶æ˜¯ gtridå’Œbqualæ‹¼æ¥åçš„å†…å®¹ã€‚å› ä¸ºgtridå’Œbqualæœ€å¤§éƒ½æ˜¯64ä¸ªå­—èŠ‚ï¼Œå› æ­¤dataçš„æœ€å¤§é•¿åº¦ä¸º128ã€‚ä¸è¿‡ï¼Œåœ¨xidçš„ç»“æ„ä½“ä¸­ï¼Œå¹¶æ²¡æœ‰gtridå’Œbqualï¼Œåªæœ‰gtrid_lengthã€bqual_lengthã€‚ç”±äºäºŒè€…çš„å†…å®¹éƒ½å­˜å‚¨åœ¨dataä¸­ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ ¹æ®dataåæ¨å‡ºgtridå’Œbqualã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå‡è®¾gtridä¸ºâ€g12345â€(5ä¸ªå­—èŠ‚)ï¼Œbqualä¸ºâ€b456â€(4ä¸ªå­—èŠ‚)ã€‚é‚£ä¹ˆåœ¨æ„é€ xidç»“æ„ä½“æ—¶ï¼Œgtrid_length=5ï¼Œbqual_length=4ï¼Œdata=â€g12345b456â€ï¼Œé‚£ä¹ˆåœ¨åæ¨çš„æ—¶å€™ï¼š</p>

<p>ä»data[0]åˆ°data[gtrid_length-1]ä¹‹é—´çš„éƒ¨åˆ†å°±æ˜¯gtridçš„å€¼ï¼›ä»data[gtrid_length]åˆ°data[gtrid_length+bqual_length-1]éƒ¨åˆ†å°±æ˜¯bqualçš„å€¼ã€‚</p>

<p>formatIdï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>è€ŒformatIdçš„ä½œç”¨å°±æ˜¯è®°å½•gtridã€bqualçš„æ ¼å¼ï¼Œç±»ä¼¼äºmemcachedä¸­flagså­—æ®µçš„ä½œç”¨ã€‚XAè§„èŒƒä¸­é€šè¿‡ä¸€ä¸ªç»“æ„ä½“çº¦å®šäº†xidçš„ç»„æˆéƒ¨åˆ†ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰è§„å®šdataä¸­å­˜å‚¨çš„gtridã€bqualå†…å®¹åˆ°åº•åº”è¯¥æ˜¯ä»€ä¹ˆæ ¼å¼ã€‚ä½ å¯ä»¥é€‰æ‹©ä½¿ç”¨æ•°å­—ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œåˆ°åº•é€‰æ‹©ä»€ä¹ˆç”±å¼€å‘è€…è‡ªè¡Œå†³å®šï¼Œåªè¦æœ€ç»ˆèƒ½ä¿è¯dataä¸­çš„å†…å®¹æ˜¯å…¨å±€å”¯ä¸€çš„å³å¯ã€‚XAè§„èŒƒå»ºè®®ä½¿ç”¨OSI CCRé£æ ¼æ¥ç»„ç»‡xidçš„å†…å®¹ï¼Œæ­¤æ—¶formatIdåº”è¯¥è®¾ç½®ä¸º0.
</code></pre></div></div>

<p>åœ¨mysqlå®˜æ–¹æ–‡æ¡£ä¸­ï¼Œå…³äºxidçš„ç»„æˆä¹Ÿæœ‰ç±»ä¼¼çš„è¯´æ˜ï¼š</p>

<p>xid: gtrid [, bqual [, formatID ]]
å…¶ä¸­ï¼Œbqualã€formatIDæ˜¯å¯é€‰çš„ã€‚è§£é‡Šå¦‚ä¸‹ï¼š</p>

<p>gtrid : æ˜¯ä¸€ä¸ªå…¨å±€äº‹åŠ¡æ ‡è¯†ç¬¦(global transaction identifier)ï¼Œ</p>

<p>bqual:æ˜¯ä¸€ä¸ªåˆ†æ”¯é™å®šç¬¦(branch qualifier)ï¼Œå¦‚æœæ²¡æœ‰æä¾›bqualï¼Œé‚£ä¹ˆé»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²â€™â€˜ã€‚</p>

<p>formatIDï¼šæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œç”¨äºæ ‡è®°gtridå’Œbqualå€¼çš„æ ¼å¼ï¼Œè¿™æ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°(unsigned integer)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€å°ä¸º0ã€‚å¦‚æœæ²¡æœ‰æä¾›formatIDï¼Œé‚£ä¹ˆå…¶é»˜è®¤å€¼ä¸º1ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œxidä½œä¸ºä¸€ä¸ªäº‹åŠ¡åˆ†æ”¯çš„æ ‡è¯†ç¬¦ï¼Œç†è®ºä¸Šåªè¦æœ‰åˆ†æ”¯é™å®šç¬¦(bqual)å°±å¯ä»¥äº†ï¼Œä¸ºä»€ä¹ˆè¦åŒ…å«å…¨å±€äº‹åŠ¡æ ‡è¯†ç¬¦(gtrid)ï¼Ÿè¿™ä¸»è¦æ˜¯ä¸ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œé€šè¿‡åŒ…å«è¿›xidï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„åˆ¤æ–­å‡ºè¿™ä¸ªäº‹åŠ¡åˆ†æ”¯å±äºå“ªä¸€ä¸ªå…¨å±€äº‹åŠ¡ã€‚ 

ä¾‹å¦‚ï¼Œå‰é¢æåˆ° XA RECOVERå‘½ä»¤çš„ä½œç”¨æ˜¯åˆ—å‡ºæ‰€æœ‰å¤„äºPREPAREé˜¶æ®µçš„XAäº‹åŠ¡ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªæ¡ˆä¾‹ï¼š

mysql&gt;  XA RECOVER;
+----------+--------------+--------------+--------------+
| formatID | gtrid_length | bqual_length | data         |
+----------+--------------+--------------+--------------+
|        1 |            6 |            6 | g12345b67890 |
+----------+--------------+--------------+--------------+ è¿™é‡Œåˆ—å‡ºçš„æ˜¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡xidçš„ç»„æˆä¿¡æ¯ï¼Œæ ¹æ®å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥æ¨æ–­å‡ºï¼š

gtridæ˜¯data[0]åˆ°data[gtrid_length-1]éƒ¨åˆ†çš„å†…å®¹ï¼Œå³data[0]åˆ°data[6-1=5]éƒ¨åˆ†çš„å†…å®¹ï¼Œç»“æœä¸ºg12345ï¼›

è€Œbqualæ˜¯data[gtrid_length]åˆ°data[gtrid_length+bqual_length-1]éƒ¨åˆ†çš„å†…å®¹ï¼Œå³data[6]åˆ°data[6+6-1=11]éƒ¨åˆ†çš„å†…å®¹ï¼Œç»“æœb67890ã€‚
</code></pre></div></div>

<p>å› æ­¤ï¼Œæ ¹æ®è¿™ä¸ªä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ¤æ–­å‡ºè¿™ä¸ªxidè¡¨ç¤ºçš„æ˜¯ï¼šå…¨å±€äº‹åŠ¡(g12345)ä¸­çš„äº‹åŠ¡åˆ†æ”¯(b67890)ã€‚</p>

<p>4ã€é€šè¿‡jdbcæ“ä½œmysql xaäº‹åŠ¡
    MySQL Connector/J ä»5.0.0ç‰ˆæœ¬ä¹‹åå¼€å§‹ç›´æ¥æä¾›å¯¹XAçš„æ”¯æŒï¼Œä¹Ÿå°±æ˜¯æä¾›äº†javaç‰ˆæœ¬XAæ¥å£çš„å®ç°ã€‚æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡javaä»£ç æ¥æ‰§è¡Œmysql xaäº‹åŠ¡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸šåŠ¡å¼€å‘äººå‘˜åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œä¸åº”è¯¥ç›´æ¥æ“ä½œè¿™äº›XAäº‹åŠ¡æ“ä½œçš„æ¥å£ã€‚å› ä¸ºåœ¨DTPæ¨¡å‹ä¸­ï¼ŒRMä¸Šçš„äº‹åŠ¡åˆ†æ”¯çš„å¼€å¯ã€ç»“æŸã€å‡†å¤‡ã€æäº¤ã€å›æ»šç­‰æ“ä½œï¼Œéƒ½åº”è¯¥æ˜¯ç”±äº‹åŠ¡ç®¡ç†å™¨TMæ¥ç»Ÿä¸€ç®¡ç†ã€‚

ç”±äºç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰æ¥è§¦åˆ°TMï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸å¦¨åšä¸€å›"äººè‚‰äº‹åŠ¡ç®¡ç†å™¨"ï¼Œç”¨ä½ æ™ºæ…§çš„å¤§è„‘ï¼Œæ¥æ§åˆ¶å¤šä¸ªmysqlå®ä¾‹ä¸Šxaäº‹åŠ¡åˆ†æ”¯çš„æ‰§è¡Œï¼Œæäº¤/å›æ»šã€‚é€šè¿‡ç›´æ¥æ“ä½œè¿™äº›æ¥å£ï¼Œä½ å°†å¯¹xaäº‹åŠ¡æœ‰æ›´æ·±åˆ»çš„è®¤è¯†ã€‚
</code></pre></div></div>

<p>import com.mysql.jdbc.jdbc2.optional.MysqlXAConnection;
import com.mysql.jdbc.jdbc2.optional.MysqlXid;
import javax.sql.XAConnection;
import javax.transaction.xa.XAException;
import javax.transaction.xa.XAResource;
import javax.transaction.xa.Xid;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
public class MysqlXAConnectionTest {
   public static void main(String[] args) throws SQLException {
      //trueè¡¨ç¤ºæ‰“å°XAè¯­å¥,ï¼Œç”¨äºè°ƒè¯•
      boolean logXaCommands = true;
      // è·å¾—èµ„æºç®¡ç†å™¨æ“ä½œæ¥å£å®ä¾‹ RM1
      Connection conn1 = DriverManager.getConnection(â€œjdbc:mysql://localhost:3306/testâ€, â€œrootâ€, â€œshxx12151022â€);
      XAConnection xaConn1 = new MysqlXAConnection((com.mysql.jdbc.Connection) conn1, logXaCommands);
      XAResource rm1 = xaConn1.getXAResource();
      // è·å¾—èµ„æºç®¡ç†å™¨æ“ä½œæ¥å£å®ä¾‹ RM2
      Connection conn2 = DriverManager.getConnection(â€œjdbc:mysql://localhost:3306/testâ€, â€œrootâ€,
            â€œshxx12151022â€);
      XAConnection xaConn2 = new MysqlXAConnection((com.mysql.jdbc.Connection) conn2, logXaCommands);
      XAResource rm2 = xaConn2.getXAResource();
      // APè¯·æ±‚TMæ‰§è¡Œä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼ŒTMç”Ÿæˆå…¨å±€äº‹åŠ¡id
      byte[] gtrid = â€œg12345â€.getBytes();
      int formatId = 1;
      try {
         // ==============åˆ†åˆ«æ‰§è¡ŒRM1å’ŒRM2ä¸Šçš„äº‹åŠ¡åˆ†æ”¯====================
         // TMç”Ÿæˆrm1ä¸Šçš„äº‹åŠ¡åˆ†æ”¯id
         byte[] bqual1 = â€œb00001â€.getBytes();
         Xid xid1 = new MysqlXid(gtrid, bqual1, formatId);
         // æ‰§è¡Œrm1ä¸Šçš„äº‹åŠ¡åˆ†æ”¯
         rm1.start(xid1, XAResource.TMNOFLAGS);//One of TMNOFLAGS, TMJOIN, or TMRESUME.
         PreparedStatement ps1 = conn1.prepareStatement(â€œINSERT into user(name) VALUES (â€˜tianshouzhiâ€™)â€);
         ps1.execute();
         rm1.end(xid1, XAResource.TMSUCCESS);
         // TMç”Ÿæˆrm2ä¸Šçš„äº‹åŠ¡åˆ†æ”¯id
         byte[] bqual2 = â€œb00002â€.getBytes();
         Xid xid2 = new MysqlXid(gtrid, bqual2, formatId);
         // æ‰§è¡Œrm2ä¸Šçš„äº‹åŠ¡åˆ†æ”¯
         rm2.start(xid2, XAResource.TMNOFLAGS);
         PreparedStatement ps2 = conn2.prepareStatement(â€œINSERT into user(name) VALUES (â€˜wangxiaoxiaoâ€™)â€);
         ps2.execute();
         rm2.end(xid2, XAResource.TMSUCCESS);
         // ===================ä¸¤é˜¶æ®µæäº¤================================
         // phase1ï¼šè¯¢é—®æ‰€æœ‰çš„RM å‡†å¤‡æäº¤äº‹åŠ¡åˆ†æ”¯
         int rm1_prepare = rm1.prepare(xid1);
         int rm2_prepare = rm2.prepare(xid2);
         // phase2ï¼šæäº¤æ‰€æœ‰äº‹åŠ¡åˆ†æ”¯
         boolean onePhase = false; //TMåˆ¤æ–­æœ‰2ä¸ªäº‹åŠ¡åˆ†æ”¯ï¼Œæ‰€ä»¥ä¸èƒ½ä¼˜åŒ–ä¸ºä¸€é˜¶æ®µæäº¤
         if (rm1_prepare == XAResource.XA_OK
               &amp;&amp; rm2_prepare == XAResource.XA_OK
               ) {//æ‰€æœ‰äº‹åŠ¡åˆ†æ”¯éƒ½prepareæˆåŠŸï¼Œæäº¤æ‰€æœ‰äº‹åŠ¡åˆ†æ”¯
            rm1.commit(xid1, onePhase);
            rm2.commit(xid2, onePhase);
         } else {//å¦‚æœæœ‰äº‹åŠ¡åˆ†æ”¯æ²¡æœ‰æˆåŠŸï¼Œåˆ™å›æ»š
            rm1.rollback(xid1);
            rm1.rollback(xid2);
         }
      } catch (XAException e) {
         // å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œä¹Ÿè¦è¿›è¡Œå›æ»š
         e.printStackTrace();
      }
   }
}
    åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæ¼”ç¤ºäº†2ä¸ªRMçš„æƒ…å†µä¸‹åˆ†å¸ƒå¼äº‹åŠ¡çš„å·¥ä½œæµç¨‹ã€‚å› ä¸ºæˆ‘ä»¬å……å½“äº†â€äººè‚‰äº‹åŠ¡ç®¡ç†å™¨â€TMï¼Œå› æ­¤å¾ˆå¤šæœ¬åº”è¯¥ç”±TMæ¥å¤„ç†çš„å·¥ä½œå¤„ç†ç»†èŠ‚ä¹Ÿç›´æ¥ä½“ç°åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œå¦‚:ç”Ÿæˆå…¨å±€äº‹åŠ¡idå’Œåˆ†æ”¯äº‹åŠ¡idã€åœ¨RMä¸Šå¼€å¯äº‹åŠ¡åˆ†æ”¯ã€ä¸¤é˜¶æ®µæäº¤ç­‰ã€‚è™½ç„¶æˆ‘ä»¬è‡ªå·±ä½œä¸ºâ€äººè‚‰äº‹åŠ¡ç®¡ç†å™¨â€æ˜¯å¾ˆä¸å¯é çš„ï¼Œä½†æ˜¯ä¸Šè¿°ä»£ç å¯ä»¥è®©æˆ‘ä»¬äº†è§£ä¸€ä¸ªTMå†…éƒ¨çš„ä¸»è¦å·¥ä½œæµç¨‹æ˜¯æ€æ ·çš„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>åœ¨å®é™…å¼€å‘ä¸­ï¼Œä»£ç ç»ä¸ä¼šåƒä¸Šè¡¨é¢é‚£æ ·å¤æ‚ï¼Œå› ä¸ºæˆ‘ä»¬é€šå¸¸éƒ½ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹æˆ–è€…å®¹å™¨æä¾›çš„TMåŠŸèƒ½ï¼Œå› æ­¤åœ¨æ“ä½œåˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œä»£ç å¯ä»¥å¾—åˆ°æå¤§çš„ç®€åŒ–ã€‚

æœ€åï¼Œç”±äºæˆ‘ä»¬è®¾ç½®äº†logXaCommands=trueï¼Œç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™å›æ‰“å°å‡ºæ‰§è¡Œçš„XAå‘½ä»¤ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š

Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA START 0x673132333435,0x623030303031,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA END 0x673132333435,0x623030303031,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA START 0x673132333435,0x623030303032,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA END 0x673132333435,0x623030303032,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA PREPARE 0x673132333435,0x623030303031,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA PREPARE 0x673132333435,0x623030303032,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA COMMIT 0x673132333435,0x623030303031,0x1
Fri Feb 02 18:09:29 CST 2018 DEBUG: Executing XA statement: XA COMMIT 0x673132333435,0x623030303032,0x1 5 MySQL Connector/J XAäº‹åŠ¡æ”¯æŒæºç ç®€å•åˆ†æ
æœ€åï¼Œæˆ‘ä»¬å¯¹ä¸Šè¿°æºç è¿›è¡Œä¸€ä¸‹ç®€å•çš„åˆ†æã€‚åœ¨å‰é¢ç›´æ¥ä½¿ç”¨mysqlå‘½ä»¤æ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡"XA START xidâ€ç­‰XAå‘½ä»¤æ¥æ‰§è¡ŒXAäº‹åŠ¡ã€‚è€Œåœ¨ä¸Šè¿°javaä»£ç ä¸­ï¼Œæˆ‘ä»¬æ˜¯è·å–äº†ä¸€ä¸ªæ™®é€šçš„é“¾æ¥Connectionä¹‹åï¼Œå°è£…æˆäº†MysqlXAConnectionã€‚å¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection</p>

<p>public class MysqlXAConnection extends MysqlPooledConnection implements XAConnection, XAResource {
  private com.mysql.jdbc.Connection underlyingConnection;
  private Log log;
  protected boolean logXaCommands;</p>

<p>//æ„é€ æ–¹æ³•
  public MysqlXAConnection(com.mysql.jdbc.Connection connection, boolean logXaCommands) throws SQLException {
    super(connection);
    this.underlyingConnection = connection;
    this.log = connection.getLog();
    this.logXaCommands = logXaCommands;
  }
â€¦
}
å¯ä»¥çœ‹åˆ°ï¼ŒMysqlXAConnectionæœ¬èº«å°±å®ç°äº†XAResourceæ¥å£ï¼Œå› æ­¤å½“è°ƒç”¨getXAResource()æ–¹æ³•æ—¶ï¼Œè¿”å›çš„å°±æ˜¯å…¶è‡ªå·±</p>

<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#getXAResource</p>

<p>public XAResource getXAResource() throws SQLException {
    return this;
}
ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨XAResourceçš„startæ–¹æ³•æ¥å¼€å¯XAäº‹åŠ¡ã€‚startæ–¹æ³•æºç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#start</p>

<p>public void start(Xid xid, int flags) throws XAException {
    //1ã€å°è£…XAå‘½ä»¤
    StringBuilder commandBuf = new StringBuilder(MAX_COMMAND_LENGTH);
    commandBuf.append(â€œXA START â€œ);
    appendXid(commandBuf, xid);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//2ã€æ·»åŠ flagæ ‡è®°
switch (flags) {
    case TMJOIN:
        commandBuf.append(" JOIN");
        break;
    case TMRESUME:
        commandBuf.append(" RESUME");
        break;
    case TMNOFLAGS:
        // no-op
        break;
    default:
        throw new XAException(XAException.XAER_INVAL);
}

//æ‰§è¡Œå‘½ä»¤
dispatchCommand(commandBuf.toString());
this.underlyingConnection.setInGlobalTx(true); }  å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬è°ƒç”¨MysqlXAConnectionçš„startæ–¹æ³•æ—¶ï¼Œå®é™…ä¸Šå°±æ˜¯æ‰§è¡Œäº†ä¸€ä¸ªâ€XA START xid [JOIN|RESUME]â€å‘½ä»¤è€Œå·²ï¼Œå’Œæˆ‘ä»¬ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­çš„æ“ä½œæ˜¯ä¸€æ ·ä¸€æ ·çš„ï¼Œåªä¸è¿‡é€šè¿‡å°è£…ç®€åŒ–äº†æˆ‘ä»¬çš„æ“ä½œã€‚
å¯¹äºMysqlXAConnectionçš„endã€prepareã€commitã€rollbackç­‰æ–¹æ³•ï¼Œä¹Ÿéƒ½æ˜¯æ˜¯ç±»ä¼¼çš„ï¼Œä¸å†èµ˜è¿°ã€‚

æœ€åæç¤ºï¼Œ MySQL Connector/J ä¸­æä¾›çš„XAæ“ä½œæ¥å£ï¼Œå¦‚ä¸Šé¢æåˆ°çš„XAConnectionã€XAResourceã€Xidç­‰ï¼Œå®é™…ä¸Šéƒ½éµå¾ªäº†JTAè§„èŒƒã€‚

mysql8.0æ–‡æ¡£ï¼šhttps://dev.mysql.com/doc/refman/8.0/en/xa-statements.htmlã€‚13.3.8.1 XA Transaction SQL Syntaxç« èŠ‚è®²è¿°äº†Mysqlå¯¹äºXAäº‹åŠ¡çš„è¯­æ³•ã€‚
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>XA {START</td>
      <td>BEGIN} xid [JOIN</td>
      <td>RESUME] XA END xid [SUSPEND [FOR MIGRATE]] XA PREPARE xid XA COMMIT xid [ONE PHASE] XA ROLLBACK xid XA RECOVER [CONVERT XID]</td>
    </tr>
  </tbody>
</table>

<p>é¦–å…ˆï¼Œæ ¹æ®DTPï¼ˆDistributed Transaction Processing: Reference Modelï¼‰å‚è€ƒæ¨¡å‹ä¸­ï¼ŒMysqlæ˜¯ä½œä¸ºèµ„æºç®¡ç†å™¨è¿™ä¸€ç»„ä»¶ã€‚æ‰€ä»¥Mysqlä¹Ÿä»…ä»…æ˜¯ä½œä¸ºXAè§„èŒƒä¸­çš„ä¸€ä¸ªç»„ä»¶è€Œå·²ï¼ŒMysqlå¯¹äºXAçš„æ”¯æŒï¼Œå…¶å®æ˜¯æä¾›äº†RMsä¸TMä¹‹é—´çš„æ¥å£äº¤äº’æ”¯æŒã€‚TMï¼ˆTransaction managerï¼‰æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„åè°ƒè€…ï¼Œåè°ƒä¼—å¤šçš„äº‹åŠ¡å‚ä¸è€…ã€‚æ˜ç™½äº†è¿™ä¸€ç‚¹ä»¥åï¼Œæˆ‘ä»¬å†æ¥çœ‹Mysqlä¸­ä½¿ç”¨XAäº‹åŠ¡çš„è¯­æ³•ï¼Œmysqlå®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæœ‰è¯¦ç»†çš„æè¿°ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢åˆ—ä¸¾ä¸€äºŒï¼Œå¦å¤–å…³äºmysqlæ”¯æŒXAæ˜¯ä»ä»€ä¹ˆç‰ˆæœ¬å¼€å§‹ï¼Œä»¥åŠjavaé©±åŠ¨åŒ…ä»€ä¹ˆç‰ˆæœ¬æ”¯æŒXAï¼Œè¯·è§ä»¥ä¸‹æ–‡æ¡£åŸæ–‡</p>

<p>Support for XA transactions is available for the</p>

<p>InnoDB</p>

<p>storage engine. The MySQL XA implementation is based on the X/Open CAE documentÂ Distributed Transaction Processing: The XA Specification. This document is published by The Open Group and available athttp://www.opengroup.org/public/pubs/catalog/c193.htm. Limitations of the current XA implementation are described in Section C.6, â€œRestrictions on XA Transactionsâ€.</p>

<p>innodbå­˜å‚¨å¼•æ“æ”¯æŒXAäº‹åŠ¡</p>

<p>Among the MySQL Connectors, MySQL Connector/J 5.0.0 and higher supports XA directly, by means of a class interface that handles the XA SQL statement interface for you.</p>

<p>5.0.0ç‰ˆæœ¬mysqlè¿æ¥é©±åŠ¨å¼€å§‹æ”¯æŒXA</p>

<p>XAäº‹åŠ¡å‘½ä»¤éƒ½æ˜¯XAå¼€å¤´çš„ï¼Œxa start å’Œ xa begin éƒ½å¯ä»¥å¼€å¯ä¸€ä¸ªxaäº‹åŠ¡ï¼Œä½†æ˜¯xa start ä¸æ”¯æŒjoin ã€resumeï¼Œè¿™ä¸¤ä¸ªæ˜¯ä»€ä¹ˆï¼Œæˆ‘æš‚æ—¶ä¸äº†è§£ï¼Œæš‚ä¸”ä¸ç®¡ï¼Œxa start è¿˜éœ€è¦è·Ÿä¸€ä¸ªxidï¼Œè¿™ä¸ªæ˜¯äº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ï¼Œå…³äºxidçš„æ„æˆï¼Œä¸‹é¢å†è¯¦è¿°ï¼Œè¿™é‡Œä»…éœ€è¦çŸ¥é“xidæ˜¯ä¸€ä¸ªäº‹åŠ¡çš„idæ ‡è¯†å³å¯ã€‚</p>

<p>xa end xidï¼Œå³å®Œæˆsql æ“ä½œåï¼Œè®©xaäº‹åŠ¡è¿›å…¥IDLEçŠ¶æ€çš„å‘½ä»¤ï¼ŒåŒæ ·è¦æŒ‡æ˜xidï¼Œæ“ä½œçš„æ˜¯å“ªä¸ªXAäº‹åŠ¡ï¼Œæ³¨æ„è¿™é‡Œxa endå¹¶ä¸æ˜¯è¦ç»“æŸxaäº‹åŠ¡ï¼Œåªæ˜¯è¿›å…¥åˆ°IDLEçŠ¶æ€ï¼Œåç»­è¿˜æœ‰ä¸¤é˜¶æ®µæäº¤è¿‡ç¨‹ï¼Œprepareå’Œcommitï¼›</p>

<p>xa prepare xid ï¼Œæ ‡è¯†ä¸¤é˜¶æ®µæäº¤çš„ç¬¬ä¸€ä¸ªæäº¤é˜¶æ®µï¼Œé€šçŸ¥èµ„æºç®¡ç†å™¨RMåšæäº¤å‰çš„å‡†å¤‡ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œä¹‹å‰è®¨è®ºä¸¤é˜¶æ®µæäº¤æ—¶å·²ç»è®²äº†ï¼Œè¿™ä¸ªé˜¶æ®µï¼Œmysqlå°±ä¼šè®°å½•ä¸‹è¿™ä¸ªäº‹åŠ¡çš„å„ç§æ—¥å¿—ï¼Œé˜²æ­¢ä¸¢å¤±ï¼Œå³ä½¿å®•æœºé‡å¯ä¹Ÿèƒ½æ¢å¤ã€‚prepareç»“æŸå°±å…·å¤‡äº†è¿™ç§æ¢å¤çš„èƒ½åŠ›ï¼ŒRM prepareå›å¤TMï¼ŒprepareæˆåŠŸåï¼ŒRMä¼šç­‰TMçš„commité€šçŸ¥ï¼Œè€ŒTMè¦ç­‰æ‰€æœ‰RMçš„æˆåŠŸæ¶ˆæ¯ï¼Œæ‰€æœ‰RMå›å¤æˆåŠŸï¼ŒTMå°±ä¸‹å‘commitç»™æ‰€æœ‰RMï¼›å¦‚æœéƒ¨åˆ†RMå›å¤ä¸æˆåŠŸï¼Œé‚£ä¹ˆTMå°±ä¸‹å‘rollbackç»™æ‰€æœ‰RMå›æ»šäº‹åŠ¡ã€‚</p>

<p>xa rollback xidå°±æ˜¯å›æ»šäº‹åŠ¡çš„æŒ‡ä»¤ï¼Œxa commit xidå°±æ˜¯æäº¤äº‹åŠ¡çš„æŒ‡ä»¤ï¼Œxa commit xid ONE PHASE æ˜¯æ˜ç¡®çŸ¥é“RMåªæœ‰ä¸€ä¸ªçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨ä¸€é˜¶æ®µæäº¤çš„æ–¹å¼ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¸éœ€è¦prepareé˜¶æ®µäº†ï¼Œxa endåå³å¯xa commit xid ONE PHASEäº†ã€‚</p>

<p>xa recover ï¼Œæ˜¯ç”¨æ¥æŸ¥çœ‹å“ªäº›xidå·²ç»å®Œæˆprepareçš„ï¼Œå¼‚å¸¸å®•æœºæƒ…å†µä¸‹ï¼Œxa recoverä¹Ÿèƒ½åˆ—å‡ºå®•æœºå‰å“ªäº›xaäº‹åŠ¡å®Œæˆprepareï¼Œç­‰å¾…commitçš„ã€‚</p>

<p>xid: gtrid [, bqual [, formatID ]]</p>

<p>ä»¥ä¸Šæ˜¯xidçš„æ„æˆï¼Œgtridå…¨å±€äº‹åŠ¡idæ ‡è¯†ï¼Œç„¶åbqual äº‹åŠ¡åˆ†æ”¯æ ‡è¯†ï¼ŒformatIDæ˜¯æ ¼å¼æ ‡è¯†ï¼Œå…·ä½“ä»€ä¹ˆç”¨å¤„æš‚æ—¶ä¸æ˜ç™½ã€‚bqualå’ŒformatIDéƒ½æ˜¯å¯é€‰ï¼Œå¦‚æœä¸ç»™å€¼æ—¶é»˜è®¤å€¼åˆ†åˆ«ä¸ºâ€å’Œ1.</p>

<p>gtrid å’Œ bqual éƒ½å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé•¿åº¦æ˜¯64byteï¼ŒformatIDæ˜¯æ— ç¬¦å·æ•´å‹ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸ªå®é™…ä¾‹å­</p>

<p>æˆ‘å»ºç«‹äº†ä¸€ä¸ªå…¨å±€äº‹åŠ¡aaaï¼Œä¸¤ä¸ªåˆ†æ”¯äº‹åŠ¡bbbå’Œcccã€‚ç„¶åä¸¤ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½è¿›å…¥äº†prepareï¼Œä»åˆ†æ”¯äº‹åŠ¡cccæˆªå›¾ä¸­xa recoverå¯ä»¥çœ‹å‡ºã€‚ä½†æ˜¯cccå›æ»šï¼Œbbbæäº¤ã€‚æœ€å¼€å§‹ç†è§£è¿™å—çš„æ—¶å€™ï¼Œæˆ‘è®¤ä¸ºæ—¢ç„¶ä¸€ä¸ªå…¨å±€äº‹åŠ¡ï¼Œé‚£ä¹ˆæ€ä¹ˆèƒ½å¤Ÿä¸€ä¸ªå›æ»šä¸€ä¸ªæäº¤å‘¢ï¼Ÿåæ¥ä»”ç»†ä¸€æƒ³ï¼Œè¿™ä¸ªè¿‡ç¨‹åº”è¯¥æ˜¯äº¤ç»™TMæ¥ç»Ÿä¸€çš„ï¼Œmysqlæ”¯æŒXAå¹¶ä¸ä½“ç°åœ¨æ§åˆ¶å…¨å±€äº‹åŠ¡ä¸‹æ‰€æœ‰å­äº‹åŠ¡ä¸€è‡´æäº¤ï¼Œè€Œæ˜¯æä¾›å’ŒTMäº¤äº’çš„æ¥å£ï¼Œç”±TMæœ€ç»ˆæ¥æ§åˆ¶ï¼Œé€šçŸ¥æ‰€æœ‰å­äº‹åŠ¡æäº¤ï¼Œæˆ–éƒ½å›æ»šï¼Œè€Œä¸ä¼šé€šçŸ¥éƒ¨åˆ†æäº¤ã€éƒ¨åˆ†å›æ»šã€‚</p>

<p>https://mp.weixin.qq.com/s/KeZId8WScnS-rlc0kedEzw
<!-- more -->
æ¯”å¦‚æˆ‘ä»¬ç°åœ¨æœ‰ä¸¤ä¸ªæ•°æ®åº“ï¼Œmysql3306å’Œmysql3307ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨dockeræ¥åˆ›å»ºè¿™ä¸¤ä¸ªå®ä¾‹ï¼š</p>

<h1 id="mysql3306åˆ›å»ºå‘½ä»¤">mysql3306åˆ›å»ºå‘½ä»¤</h1>

<h2 id="docker-run">docker run</h2>
<p>d 
-
p 
3306
:
3306</p>

<p>-
v 
/
Users
/
yjf
/
Documents
/
workspace
/
mysql
-
docker
/
my3306
.
cnf
:
/etc/
mysql
/
mysql
.
conf
.
d
/
mysqld
.
cnf 
-
v 
/
Users
/
yjf
/
Documents
/
workspace
/
mysql
-
docker
/
data3306
:
/var/
lib
/
mysql 
-
e MYSQL_ROOT_PASSWORD
=
123456</p>

<p>â€“
name mysql
-
3307
 mysql
:
5.7</p>

<h1 id="msyql3306çš„é…ç½®">msyql3306çš„é…ç½®ï¼š</h1>

<p>[
mysqld
]</p>

<h2 id="pid">pid</h2>
<p>file  <br />
=</p>

<p>/var/
run
/
mysqld
/
mysqld
.
pid</p>

<h1 id="socket">socket</h1>

<p>/var/
run
/
mysqld
/
mysqld
.
sock</p>

<h1 id="datadir">datadir</h1>

<p>/var/
lib
/
mysql</p>

<h2 id="server">server</h2>
<p>id 
=</p>

<p>1</p>

<h1 id="log_bin">log_bin</h1>
<p>mysql
-
bin</p>

<h1 id="binlog_format">binlog_format</h1>
<p>ROW</p>

<h1 id="expire_logs_days">expire_logs_days</h1>

<p>30</p>

<h1 id="mysql3307åˆ›å»ºå‘½ä»¤">mysql3307åˆ›å»ºå‘½ä»¤</h1>

<h2 id="docker-run-1">docker run</h2>
<p>d 
-
p 
3307
:
3306</p>

<p>-
v 
/
Users
/
yjf
/
Documents
/
workspace
/
mysql
-
docker
/
my3307
.
cnf
:
/etc/
mysql
/
mysql
.
conf
.
d
/
mysqld
.
cnf 
-
v 
/
Users
/
yjf
/
Documents
/
workspace
/
mysql
-
docker
/
data3307
:
/var/
lib
/
mysql 
-
e MYSQL_ROOT_PASSWORD
=
123456</p>

<p>â€“
name mysql
-
3307
 mysql
:
5.7</p>

<h1 id="msyql3307çš„é…ç½®">msyql3307çš„é…ç½®ï¼š</h1>

<p>[
mysqld
]</p>

<h2 id="pid-1">pid</h2>
<p>file  <br />
=</p>

<p>/var/
run
/
mysqld
/
mysqld
.
pid</p>

<h1 id="socket-1">socket</h1>

<p>/var/
run
/
mysqld
/
mysqld
.
sock</p>

<h1 id="datadir-1">datadir</h1>

<p>/var/
lib
/
mysql</p>

<h2 id="server-1">server</h2>
<p>id 
=</p>

<p>2</p>

<h1 id="log_bin-1">log_bin</h1>
<p>mysql
-
bin</p>

<h1 id="binlog_format-1">binlog_format</h1>
<p>ROW</p>

<h1 id="expire_logs_days-1">expire_logs_days</h1>

<p>30</p>

<p>åœ¨mysql3306ä¸­
æˆ‘ä»¬æœ‰ä¸€ä¸ªuserè¡¨</p>

<p>create table user 
(</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id  int ,

name varchar ( 10 ),

score  int
</code></pre></div></div>

<p>);</p>

<p>insert 
into
 user values
(
1
,</p>

<p>â€œfooâ€
,</p>

<p>10
)</p>

<p>åœ¨mysql3307ä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªwalletè¡¨ã€‚</p>

<p>create table wallet 
(</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id  int ,

money  float
</code></pre></div></div>

<p>);</p>

<p>insert 
into
 wallet values
(
1
,</p>

<p>10.1
)</p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œidä¸º1çš„ç”¨æˆ·åˆå§‹åˆ†æ•°ï¼ˆscoreï¼‰ä¸º10ï¼Œè€Œå®ƒçš„é’±ï¼Œåœ¨walletä¸­åˆå§‹é’±ï¼ˆmoneyï¼‰ä¸º10.1ã€‚</p>

<p>ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ“ä½œï¼Œéœ€è¦å¯¹è¿™ä¸ªç”¨æˆ·è¿›è¡Œæ“ä½œï¼šæ¯æ¬¡æ“ä½œå¢åŠ åˆ†æ•°2ï¼Œå¹¶ä¸”å¢åŠ é’±æ•°1.2ã€‚</p>

<p>è¿™ä¸ªæ“ä½œéœ€è¦å¾ˆå¼ºçš„ä¸€è‡´æ€§ã€‚</p>

<p>æ€è€ƒ
ä¸¤é˜¶æ®µæäº¤
è¿™é‡Œæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„æ¦‚å¿µï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨2PCçš„æ–¹æ³•è¿›è¡Œä¿è¯äº‹åŠ¡</p>

<p>2PCçš„æ¦‚å¿µå¦‚å›¾æ‰€ç¤ºï¼Œå¼•å…¥ä¸€ä¸ªèµ„æºåè°ƒè€…çš„æ¦‚å¿µï¼Œç”±è¿™ä¸ªèµ„æºåè°ƒè€…è¿›è¡Œäº‹åŠ¡åè°ƒã€‚</p>

<p>ç¬¬ä¸€é˜¶æ®µï¼Œç”±è¿™ä¸ªèµ„æºåè°ƒè€…å¯¹æ¯ä¸ªmysqlå®ä¾‹è°ƒç”¨prepareå‘½ä»¤ï¼Œè®©æ‰€æœ‰çš„mysqlå®ä¾‹å‡†å¤‡å¥½ï¼Œå¦‚æœå…¶ä¸­ç”±mysqlå®ä¾‹æ²¡æœ‰å‡†å¤‡å¥½ï¼Œåè°ƒè€…å°±è®©æ‰€æœ‰å®ä¾‹è°ƒç”¨rollbackå‘½ä»¤è¿›è¡Œå›æ»šã€‚å¦‚æœæ‰€æœ‰mysqléƒ½prepareå®Œæˆï¼Œé‚£ä¹ˆå°±è¿›å…¥ç¬¬äºŒé˜¶æ®µã€‚</p>

<p>ç¬¬äºŒé˜¶æ®µï¼Œèµ„æºåè°ƒè€…è®©æ¯ä¸ªmysqlå®ä¾‹éƒ½è°ƒç”¨commitæ–¹æ³•ï¼Œè¿›è¡Œæäº¤ã€‚</p>

<p>mysqlé‡Œé¢ä¹Ÿæä¾›äº†åˆ†å¸ƒå¼äº‹åŠ¡çš„è¯­å¥XAã€‚</p>

<p>ç”¨å•ä¸ªå®ä¾‹çš„äº‹åŠ¡è¡Œä¸è¡Œ
ç­‰ç­‰ï¼Œè¿™ä¸ªä¸¤é˜¶æ®µæäº¤å’Œæˆ‘ä»¬çš„äº‹åŠ¡æ„Ÿè§‰ä¹Ÿå·®ä¸å¤šï¼Œéƒ½æ˜¯è¿›è¡Œä¸€æ¬¡å¼€å§‹ï¼Œç„¶åæ‰§è¡Œï¼Œæœ€åcommitï¼Œmysqlä¸ºä»€ä¹ˆè¿˜è¦ä¸“é—¨å®šä¹‰ä¸€ä¸ªxaçš„å‘½ä»¤å‘¢ï¼Ÿäºæ˜¯æˆ‘é™·å…¥äº†æ€è€ƒâ€¦</p>

<p>æ€è€ƒä¸å¦‚å®æ“ï¼Œäºæ˜¯æˆ‘ç”¨golangå†™äº†ä¸€ä¸ªä½¿ç”¨mysqlçš„äº‹åŠ¡å®ç°çš„â€œä¸¤é˜¶æ®µæäº¤â€:</p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œdatabase/sqlâ€</p>

<p>â€œfmtâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"
</code></pre></div></div>

<p>â€œgithub.com/pkg/errorsâ€</p>

<p>)</p>

<p>func main
()</p>

<p>{</p>

<p>var
 err error</p>

<p>// db1çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3306)/hade1â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()
</code></pre></div></div>

<p>// db2çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3307)/hade2â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()
</code></pre></div></div>

<p>// å¼€å§‹å‰æ˜¾ç¤º</p>

<p>var
 score 
int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )
</code></pre></div></div>

<p>var
 money float64</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )



tx1 ,  err  :=  db1 . Begin ()
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tx2 ,  err  :=  db2 . Begin ()
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()
</code></pre></div></div>

<p>{</p>

<p>if
 err 
:=
 recover
();
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )

        fmt . Println ( "=== call rollback ====" )

        tx1 . Rollback ()

        tx2 . Rollback ()
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

    fmt . Println ( "user1 score:" ,  score )

    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

    fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}()</p>

<p>// DMLæ“ä½œ</p>

<p>if
 _
,
 err 
=
 tx1
.
Exec
(
â€œupdate user set score=score+2 where id =1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 tx2
.
Exec
(
â€œupdate wallet set money=money+1.2 where id=1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œcommit before errorâ€))</p>

<p>// commit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )

err  =  tx1 . Commit ()
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œcommit db2 before errorâ€))</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>err  =  tx2 . Commit ()
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )

db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}</p>

<p>æˆ‘è¿™é‡Œå·²ç»éå¸¸å°å¿ƒåœ°åœ¨deferä¸­recoveré”™è¯¯ä¿¡æ¯ï¼Œå¹¶ä¸”æ‰§è¡Œäº†rollbackå‘½ä»¤ã€‚</p>

<p>å¦‚æœæˆ‘åœ¨commitå‘½ä»¤ä¹‹å‰çš„ä»»æ„ä¸€ä¸ªåœ°æ–¹è°ƒç”¨äº† panic(errors.New(â€œcommit before errorâ€)) é‚£ä¹ˆå‘½ä»¤å°±ä¼šè¿›å…¥åˆ°äº†rollbackè¿™é‡Œï¼Œå°±ä¼šæŠŠä¸¤ä¸ªå®ä¾‹çš„äº‹åŠ¡éƒ½è¿›è¡Œå›æ»šã€‚</p>

<p>é€šè¿‡ç»“æœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆ†æ•°å’Œé’±æ•°éƒ½æ²¡æœ‰æ”¹å˜ã€‚è¿™ä¸ªæ˜¯okçš„ã€‚</p>

<p>ä½†æ˜¯å¦‚æœæˆ‘åœ¨db2çš„commitä¹‹å‰è§¦å‘äº†panicï¼Œé‚£ä¹ˆè¿™ä¸ªå‘½ä»¤è¿›å…¥åˆ°äº†rollbackä¸­ï¼Œä½†æ˜¯db1å·²ç»commitäº†ï¼Œdb2è¿˜æ²¡æœ‰commitï¼Œè¿™ä¸ªæ—¶å€™ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿ</p>

<p>éå¸¸å¯æƒœï¼Œæˆ‘ä»¬çœ‹åˆ°äº†è¿™é‡Œçš„scoreå¢é•¿äº†ï¼Œä½†æ˜¯moneyæ²¡æœ‰å¢é•¿ï¼Œè¿™ä¸ªå°±è¯´æ˜æ— æ³•åšåˆ°äº‹åŠ¡ä¸€è‡´æ€§äº†ã€‚</p>

<p>å›åˆ°mysqlçš„xa
é‚£ä¹ˆè¿˜è¦å›å½’åˆ°2PCï¼Œmysqlä¸º2PCçš„å®ç°å¢åŠ äº†xaå‘½ä»¤ï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬èƒ½ä¸èƒ½é¿å…è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>

<p>åŒæ ·ï¼Œæˆ‘ç”¨golangå†™äº†ä¸€ä¸ªä½¿ç”¨xaå‘½ä»¤çš„ä»£ç </p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œdatabase/sqlâ€</p>

<p>â€œfmtâ€</p>

<p>â€œstrconvâ€</p>

<p>â€œtimeâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"
</code></pre></div></div>

<p>â€œgithub.com/pkg/errorsâ€</p>

<p>)</p>

<p>func main
()</p>

<p>{</p>

<p>var
 err error</p>

<p>// db1çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3306)/hade1â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()
</code></pre></div></div>

<p>// db2çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3307)/hade2â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()
</code></pre></div></div>

<p>// å¼€å§‹å‰æ˜¾ç¤º</p>

<p>var
 score 
int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )
</code></pre></div></div>

<p>var
 money float64</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>// ç”Ÿæˆxid</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),
</code></pre></div></div>

<p>10
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"
</code></pre></div></div>

<p>+
 xid 
+</p>

<p>â€ ====â€
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()
</code></pre></div></div>

<p>{</p>

<p>if
 err 
:=
 recover
();
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )

        fmt . Println ( "=== call rollback ====" )

        db1 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))

        db2 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

    fmt . Println ( "user1 score:" ,  score )

    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

    fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}()</p>

<p>// XA å¯åŠ¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// DMLæ“ä½œ</p>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
â€œupdate user set score=score+2 where id =1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
â€œupdate wallet set money=money+1.2 where id=1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// XA end</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// prepare</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œdb2 prepare errorâ€))</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// commit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œdb2 commit errorâ€))</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )

db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}</p>

<p>é¦–å…ˆçœ‹æˆåŠŸçš„æƒ…å†µï¼š</p>

<p>ä¸€åˆ‡å®Œç¾ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬åœ¨prepareé˜¶æ®µæŠ›å‡ºpanicï¼Œé‚£ä¹ˆç»“æœå¦‚ä¸‹:</p>

<p>è¯æ˜åœ¨ç¬¬ä¸€é˜¶æ®µå‡ºç°å¼‚å¸¸æ˜¯å¯ä»¥å›æ»šçš„ã€‚</p>

<p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬åœ¨commité˜¶æ®µæŠ›å‡ºpanic:</p>

<p>æˆ‘ä»¬å‘ç°ï¼Œè¿™é‡Œçš„åˆ†æ•°å¢åŠ äº†ï¼Œä½†æ˜¯moneyå´æ²¡æœ‰å¢åŠ ã€‚</p>

<p>é‚£ä¹ˆè¿™ä¸ªxaå’Œå•ä¸ªäº‹åŠ¡æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿæˆ‘åˆé™·å…¥äº†æ·±æ·±çš„æ²‰æ€â€¦</p>

<p>xaçš„ç”¨æ³•ä¸å¯¹
ç»è¿‡åœ¨æŠ€æœ¯ç¾¤ï¼ˆå…¨æ ˆç¥ç›¾å±€ï¼‰è¯·æ•™ï¼Œè®¨è®ºä¹‹åï¼Œå‘ç°è¿™é‡Œå¯¹2pcçš„ä¸¤ä¸ªé˜¶æ®µç†è§£è¿˜æ²¡åˆ°ä½ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œæ˜¯å¼ºè°ƒçš„æ˜¯æ¯ä¸ªé˜¶æ®µéƒ½ä¼šæŒä¹…åŒ–ï¼Œå°±æ˜¯ç¬¬ä¸€ä¸ªé˜¶æ®µå®Œæˆäº†ä¹‹åï¼Œæ¯ä¸ªmysqlå®ä¾‹å°±æŠŠç¬¬ä¸€ä¸ªé˜¶æ®µçš„è¯·æ±‚å®ä¾‹åŒ–äº†ï¼Œè¿™ä¸ªæ—¶å€™ä¸ç®¡æ˜¯mysqlå®ä¾‹åœæ­¢äº†è¿˜æ˜¯å…¶ä»–é—®é¢˜ï¼Œæ¯æ¬¡é‡å¯çš„æ—¶å€™éƒ½ä¼šé‡æ–°å›å¤è¿™ä¸ªcommitã€‚</p>

<p>æˆ‘ä»¬æŠŠè¿™ä¸ªä»£ç çš„rollbackå»æ‰ï¼Œå‡è®¾commitå¿…é¡»æˆåŠŸã€‚</p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œdatabase/sqlâ€</p>

<p>â€œfmtâ€</p>

<p>â€œstrconvâ€</p>

<p>â€œtimeâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"
</code></pre></div></div>

<p>â€œgithub.com/pkg/errorsâ€</p>

<p>)</p>

<p>func main
()</p>

<p>{</p>

<p>var
 err error</p>

<p>// db1çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3306)/hade1â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()
</code></pre></div></div>

<p>// db2çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3307)/hade2â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()
</code></pre></div></div>

<p>// å¼€å§‹å‰æ˜¾ç¤º</p>

<p>var
 score 
int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )
</code></pre></div></div>

<p>var
 money float64</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>// ç”Ÿæˆxid</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),
</code></pre></div></div>

<p>10
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"
</code></pre></div></div>

<p>+
 xid 
+</p>

<p>â€ ====â€
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()
</code></pre></div></div>

<p>{</p>

<p>if
 err 
:=
 recover
();
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )

        fmt . Println ( "=== call rollback ====" )
</code></pre></div></div>

<p>// db1.Exec(fmt.Sprintf(â€œXA ROLLBACK â€˜%sâ€™â€, xid))</p>

<p>// db2.Exec(fmt.Sprintf(â€œXA ROLLBACK â€˜%sâ€™â€, xid))</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

    fmt . Println ( "user1 score:" ,  score )

    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

    fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}()</p>

<p>// XA å¯åŠ¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// DMLæ“ä½œ</p>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
â€œupdate user set score=score+2 where id =1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
â€œupdate wallet set money=money+1.2 where id=1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// XA end</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// prepare</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œdb2 prepare errorâ€))</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// commit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>panic ( errors . New ( "db2 commit error" ))
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )

db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}</p>

<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬åœæ‰ç¨‹åºï¼ˆåœæ‰mysqlçš„é“¾æ¥ï¼‰ï¼Œä½¿ç”¨ xa recoverå¯ä»¥å‘ç°ï¼Œdb2çš„xaäº‹åŠ¡è¿˜ç•™åœ¨db2ä¸­äº†ã€‚</p>

<p>æˆ‘ä»¬åœ¨æ§åˆ¶å°ç›´æ¥è°ƒç”¨ xa commitâ€™1585644880â€™ è¿˜èƒ½ç»§ç»­æŠŠè¿™ä¸ªxaäº‹åŠ¡è¿›è¡Œæäº¤ã€‚</p>

<p>è¿™ä¸‹moneyå°±è¿›è¡Œäº†æäº¤ï¼Œåˆæ¢å¤äº†ä¸€è‡´æ€§ã€‚</p>

<p>æ‰€ä»¥å‘¢ï¼Œæˆ‘ç¢ç£¨äº†ä¸€ä¸‹ï¼Œæˆ‘ä»¬å†™xaçš„ä»£ç åº”è¯¥å¦‚ä¸‹ï¼š</p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œdatabase/sqlâ€</p>

<p>â€œfmtâ€</p>

<p>â€œlogâ€</p>

<p>â€œstrconvâ€</p>

<p>â€œtimeâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_  "github.com/go-sql-driver/mysql"
</code></pre></div></div>

<p>â€œgithub.com/pkg/errorsâ€</p>

<p>)</p>

<p>func main
()</p>

<p>{</p>

<p>var
 err error</p>

<p>// db1çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3306)/hade1â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db1 . Close ()
</code></pre></div></div>

<p>// db2çš„è¿æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 ,  err  :=  sql . Open ( "mysql" ,
</code></pre></div></div>

<p>â€œroot:123456@tcp(127.0.0.1:3307)/hade2â€
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( err . Error ())
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer db2 . Close ()
</code></pre></div></div>

<p>// å¼€å§‹å‰æ˜¾ç¤º</p>

<p>var
 score 
int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )
</code></pre></div></div>

<p>var
 money float64</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>// ç”Ÿæˆxid</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xid  :=  strconv . FormatInt ( time . Now (). Unix (),
</code></pre></div></div>

<p>10
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== xid:"
</code></pre></div></div>

<p>+
 xid 
+</p>

<p>â€ ====â€
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func ()
</code></pre></div></div>

<p>{</p>

<p>if
 err 
:=
 recover
();
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Printf ( "%+v\n" ,  err )

        fmt . Println ( "=== call rollback ====" )

        db1 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))

        db2 . Exec ( fmt . Sprintf ( "XA ROLLBACK '%s'" ,  xid ))
</code></pre></div></div>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

    fmt . Println ( "user1 score:" ,  score )

    db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

    fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}()</p>

<p>// XA å¯åŠ¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call start ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA START â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// DMLæ“ä½œ</p>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
â€œupdate user set score=score+2 where id =1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
â€œupdate wallet set money=money+1.2 where id=1â€
);
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// XA end</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call end ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA END â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// prepare</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call prepare ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// panic(errors.New(â€œdb2 prepare errorâ€))</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA PREPARE â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    panic ( errors . WithStack ( err ))
</code></pre></div></div>

<p>}</p>

<p>// commit</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt . Println ( "=== call commit ====" )
</code></pre></div></div>

<p>if
 _
,
 err 
=
 db1
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<p>// TODO: å°è¯•é‡æ–°æäº¤COMMIT</p>

<p>// TODO: å¦‚æœè¿˜å¤±è´¥ï¼Œè®°å½•xidï¼Œè¿›å…¥æ•°æ®æ¢å¤é€»è¾‘ï¼Œç­‰å¾…æ•°æ®åº“æ¢å¤é‡æ–°æäº¤</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "xid:"
</code></pre></div></div>

<p>+
 xid
)</p>

<p>}</p>

<p>// panic(errors.New(â€œdb2 commit errorâ€))</p>

<p>if
 _
,
 err 
=
 db2
.
Exec
(
fmt
.
Sprintf
(
â€œXA COMMIT â€˜%sâ€™â€
,
 xid
));
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "xid:"
</code></pre></div></div>

<p>+
 xid
)</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db1 . QueryRow ( "select score from user where id = 1" ). Scan (&amp; score )

fmt . Println ( "user1 score:" ,  score )

db2 . QueryRow ( "select money from wallet where id = 1" ). Scan (&amp; money )

fmt . Println ( "wallet1 money:" ,  money )
</code></pre></div></div>

<p>}</p>

<p>å°±æ˜¯ç¬¬äºŒé˜¶æ®µçš„commitï¼Œæˆ‘ä»¬å¿…é¡»è®¾å®šå®ƒä¸€å®šä¼šâ€œæˆåŠŸâ€ï¼Œå¦‚æœæœ‰ä¸æˆåŠŸçš„æƒ…å†µï¼Œé‚£ä¹ˆå°±éœ€è¦è®°å½•ä¸‹ä¸æˆåŠŸçš„xidï¼Œæœ‰ä¸€ä¸ªæ•°æ®æ¢å¤é€»è¾‘ï¼Œé‡æ–°commitè¿™ä¸ªxidã€‚æ¥ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>

<p>binlog
å…¶å®æˆ‘ä»¬ä½¿ç”¨binlogä¹Ÿèƒ½çœ‹å‡ºä¸€äº›ç«¯å€ª</p>

<h1 id="è¿™é‡Œçš„mysql-bin0003æ›¿æ¢æˆä¸ºä½ å½“å‰çš„log">è¿™é‡Œçš„mysql-bin.0003æ›¿æ¢æˆä¸ºä½ å½“å‰çš„log</h1>

<p>SHOW BINLOG EVENTS 
in</p>

<p>â€˜mysql-bin.000003â€™
;</p>

<h2 id="xaçš„binlog">XAçš„binlog</h2>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1967</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Anonymous_Gtid</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2032</p>

<p>|
 SET 
@
@SESSION
.
GTID_NEXT
=</p>

<p>â€˜ANONYMOUSâ€™</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2032</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Query</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2138</p>

<p>|
 XA START X
â€˜31353835363338363233â€™
,
X
â€˜â€™
,
1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2138</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Table_map</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2190</p>

<p>|
 table_id
:</p>

<p>108</p>

<p>(
hade1
.
user
)</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2190</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Update_rows</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2252</p>

<p>|
 table_id
:</p>

<p>108
 flags
:
 STMT_END_F                                                  <br />
|</p>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2252</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Query</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2356</p>

<p>|
 XA 
END
 X
â€˜31353835363338363233â€™
,
X
â€˜â€™
,
1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2356</p>

<p>|
 XA_prepare   <br />
|</p>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2402</p>

<p>|
 XA PREPARE X
â€˜31353835363338363233â€™
,
X
â€˜â€™
,
1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2402</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Anonymous_Gtid</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2467</p>

<p>|
 SET 
@
@SESSION
.
GTID_NEXT
=</p>

<p>â€˜ANONYMOUSâ€™</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2467</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Query</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2574</p>

<p>|
 XA COMMIT X
â€˜31353835363338363233â€™
,
X
â€˜â€™
,
1</p>

<h2 id="éxaçš„äº‹åŠ¡">éxaçš„äº‹åŠ¡</h2>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2574</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Anonymous_Gtid</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2639</p>

<p>|
 SET 
@
@SESSION
.
GTID_NEXT
=</p>

<p>â€˜ANONYMOUSâ€™</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2639</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Query</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2712</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>BEGIN</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2712</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Table_map</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2764</p>

<p>|
 table_id
:</p>

<p>108</p>

<p>(
hade1
.
user
)</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2764</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Update_rows</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2826</p>

<p>|
 table_id
:</p>

<p>108
 flags
:
 STMT_END_F                                                  <br />
|</p>

<p>|
 mysql
-
bin
.
000003</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2826</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>Xid</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>1</p>

<table>
  <tbody>
    <tr>
    </tr>
  </tbody>
</table>

<p>2857</p>

<p>|
 COMMIT 
/* xid=67 */</p>

<p>æˆ‘ä»¬å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°ä¸¤é˜¶æ®µæäº¤ä¸­æ˜¯æœ‰ä¸¤ä¸ªGTIDçš„ï¼Œç”Ÿæˆä¸€ä¸ªGTIDå°±ä»£è¡¨å†…éƒ¨ç”Ÿæˆä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªé˜¶æ®µprepareç»“æŸä¹‹åï¼Œç¬¬äºŒä¸ªé˜¶æ®µcommitçš„æ—¶å€™å°±æŒä¹…åŒ–äº†ç¬¬ä¸€ä¸ªé˜¶æ®µçš„å†…å®¹ï¼Œå¹¶ä¸”ç”Ÿæˆäº†ç¬¬äºŒä¸ªäº‹åŠ¡ã€‚å½“commitå¤±è´¥çš„æ—¶å€™ï¼Œæœ€å¤šå°±æ˜¯ç¬¬äºŒä¸ªäº‹åŠ¡ä¸¢å¤±ï¼Œç¬¬ä¸€ä¸ªäº‹åŠ¡å®é™…ä¸Šå·²ç»ä¿å­˜èµ·æ¥äº†äº†ï¼ˆåªæ˜¯è¿˜æ²¡commitï¼‰ã€‚</p>

<p>è€Œéxaçš„äº‹åŠ¡ï¼Œåªæœ‰ä¸€ä¸ªGTIDï¼Œåœ¨commitä¹‹å‰ä»»æ„ä¸€ä¸ªé˜¶æ®µå‡ºç°é—®é¢˜ï¼Œæ•´ä¸ªäº‹åŠ¡å°±å…¨éƒ¨ä¸¢å¤±ï¼Œæ— æ³•æ‰¾å›äº†ã€‚æ‰€ä»¥è¿™å°±æ˜¯mysql xaå‘½ä»¤çš„æœºåˆ¶ã€‚</p>

<p>æ€»ç»“
çœ‹äº†ä¸€äº›èµ„æ–™ï¼ŒåŸæ¥mysqlä»5.7ä¹‹åæ‰çœŸæ­£å®ç°äº†ä¸¤é˜¶æ®µçš„xaã€‚å½“ç„¶è¿™ä¸ªä¸¤é˜¶æ®µæ–¹å¼åœ¨çœŸå®çš„å·¥ç¨‹ä¸­çš„ä½¿ç”¨å…¶å®å¾ˆå°‘çš„ï¼Œxaçš„ç¬¬ä¸€å®šå¾‹æ˜¯é¿å…ä½¿ç”¨xaã€‚å·¥ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤šæ–¹å¼æ¥é¿å…è¿™ç§åˆ†åº“çš„äº‹åŠ¡æƒ…å†µã€‚</p>

<p>ä¸è¿‡ï¼Œä¸å¦¨ç¢æŒæ¡äº†mysqlçš„xaï¼Œåœ¨ä¸€äº›ç‰¹å®šçš„åœºåˆï¼Œæˆ‘ä»¬ä¹Ÿèƒ½å®Œç¾è§£å†³é—®é¢˜</p>
:ET