I"‚J<p>Linux Namespace æ˜¯kernel çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œå®ƒå¯ä»¥éš”ç¦»ä¸€ç³»åˆ—ç³»ç»Ÿçš„èµ„æºï¼Œæ¯”å¦‚PID(Process ID)ï¼ŒUser ID, Networkç­‰ç­‰ã€‚ä¸€èˆ¬çœ‹åˆ°è¿™é‡Œï¼Œå¾ˆå¤šäººä¼šæƒ³åˆ°ä¸€ä¸ªå‘½ä»¤chrootï¼Œå°±åƒchrootå…è®¸æŠŠå½“å‰ç›®å½•å˜æˆæ ¹ç›®å½•ä¸€æ ·(è¢«éš”ç¦»å¼€æ¥çš„)ï¼ŒNamesapceä¹Ÿå¯ä»¥åœ¨ä¸€äº›èµ„æºä¸Šï¼Œå°†è¿›ç¨‹éš”ç¦»èµ·æ¥ï¼Œè¿™äº›èµ„æºåŒ…æ‹¬è¿›ç¨‹æ ‘ï¼Œç½‘ç»œæ¥å£ï¼ŒæŒ‚è½½ç‚¹ç­‰ç­‰ã€‚
<!-- more -->
ä½¿ç”¨Namespaceï¼Œ æˆ‘ä»¬å°±å¯ä»¥åšåˆ°UIDçº§åˆ«çš„éš”ç¦»ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥ä»¥UIDä¸ºnçš„ç”¨æˆ·ï¼Œè™šæ‹ŸåŒ–å‡ºæ¥ä¸€ä¸ªnamespaceï¼Œåœ¨è¿™ä¸ªnamespaceé‡Œé¢ï¼Œç”¨æˆ·æ˜¯å…·æœ‰rootæƒé™çš„ã€‚ä½†æ˜¯åœ¨çœŸå®çš„ç‰©ç†æœºå™¨ä¸Šï¼Œä»–è¿˜æ˜¯é‚£ä¸ªUIDä¸ºnçš„ç”¨æˆ·ï¼Œè¿™æ ·å°±è§£å†³äº†ç”¨æˆ·ä¹‹é—´éš”ç¦»çš„é—®é¢˜ã€‚å½“ç„¶è¿™ä¸ªåªæ˜¯Namespaceå…¶ä¸­ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ã€‚</p>

<p>é™¤äº†User Namespace ,PIDä¹Ÿæ˜¯å¯ä»¥è¢«è™šæ‹Ÿçš„ã€‚å‘½åç©ºé—´å»ºç«‹ç³»ç»Ÿçš„ä¸åŒè§†å›¾ï¼Œ å¯¹äºæ¯ä¸€ä¸ªå‘½åç©ºé—´ï¼Œä»ç”¨æˆ·çœ‹èµ·æ¥ï¼Œåº”è¯¥åƒä¸€å°å•ç‹¬çš„Linuxè®¡ç®—æœºä¸€æ ·ï¼Œæœ‰è‡ªå·±çš„initè¿›ç¨‹(PIDä¸º1)ï¼Œå…¶ä»–è¿›ç¨‹çš„PIDä¾æ¬¡é€’å¢ï¼ŒAå’ŒBç©ºé—´éƒ½æœ‰PIDä¸º1çš„initè¿›ç¨‹ï¼Œå­å®¹å™¨çš„è¿›ç¨‹æ˜ å°„åˆ°çˆ¶å®¹å™¨çš„è¿›ç¨‹ä¸Šï¼Œçˆ¶å®¹å™¨å¯ä»¥çŸ¥é“æ¯ä¸€ä¸ªå­å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ï¼Œè€Œå­å®¹å™¨ä¸å­å®¹å™¨ä¹‹é—´æ˜¯éš”ç¦»çš„ã€‚ä»å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿›ç¨‹3åœ¨çˆ¶å‘½åç©ºé—´é‡Œé¢PID ä¸º3ï¼Œä½†æ˜¯åœ¨å­å‘½åç©ºé—´å†…ï¼Œä»–å°±æ˜¯1.ä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·ä»å­å‘½åç©ºé—´ A å†…çœ‹è¿›ç¨‹3å°±åƒ init è¿›ç¨‹ä¸€æ ·ï¼Œä»¥ä¸ºè¿™ä¸ªè¿›ç¨‹æ˜¯è‡ªå·±çš„åˆå§‹åŒ–è¿›ç¨‹ï¼Œä½†æ˜¯ä»æ•´ä¸ª host æ¥çœ‹ï¼Œä»–å…¶å®åªæ˜¯3å·è¿›ç¨‹è™šæ‹ŸåŒ–å‡ºæ¥çš„ä¸€ä¸ªç©ºé—´è€Œå·²ã€‚</p>

<p>å½“å‰Linuxä¸€å…±å®ç°å…­ç§ä¸åŒç±»å‹çš„namespaceã€‚</p>

<p>Namespaceç±»å‹	ç³»ç»Ÿè°ƒç”¨å‚æ•°	å†…æ ¸ç‰ˆæœ¬
Mount namespaces	CLONE_NEWNS	2.4.19
UTS namespaces	CLONE_NEWUTS	2.6.19
IPC namespaces	CLONE_NEWIPC	2.6.19
PID namespaces	CLONE_NEWPID	2.6.24
Network namespaces	CLONE_NEWNET	2.6.29
User namespaces	CLONE_NEWUSER	3.8</p>

<p>Namesapce çš„APIä¸»è¦ä½¿ç”¨ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨</p>

<p>clone() - åˆ›å»ºæ–°è¿›ç¨‹ã€‚æ ¹æ®ç³»ç»Ÿè°ƒç”¨å‚æ•°æ¥åˆ¤æ–­å“ªç§ç±»å‹çš„namespaceè¢«åˆ›å»ºï¼Œè€Œä¸”å®ƒä»¬çš„å­è¿›ç¨‹ä¹Ÿä¼šè¢«åŒ…å«åˆ°namespaceä¸­
unshare() - å°†è¿›ç¨‹ç§»å‡ºæŸä¸ªnamespace
setns() - å°†è¿›ç¨‹åŠ å…¥åˆ°namespä¸­
UTS Namespace
UTS namespace ä¸»è¦éš”ç¦»nodenameå’Œdomainnameä¸¤ä¸ªç³»ç»Ÿæ ‡è¯†ã€‚åœ¨UTS namespaceé‡Œé¢ï¼Œæ¯ä¸ª namespace å…è®¸æœ‰è‡ªå·±çš„hostnameã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬å°†ä½¿ç”¨Goæ¥åšä¸€ä¸ªUTS Namespace çš„ä¾‹å­ã€‚å…¶å®å¯¹äº Namespace è¿™ç§ç³»ç»Ÿè°ƒç”¨ï¼Œä½¿ç”¨ C è¯­è¨€æ¥æè¿°æ˜¯æœ€å¥½çš„ï¼Œä½†æ˜¯æœ¬ä¹¦çš„ç›®çš„æ˜¯å»å®ç° dockerï¼Œç”±äº docker å°±æ˜¯ä½¿ç”¨ Go å¼€å‘çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ•´ä½“ä½¿ç”¨ Go æ¥è®²è§£ã€‚å…ˆæ¥çœ‹ä¸€ä¸‹ä»£ç ï¼Œéå¸¸ç®€å•ï¼š</p>

<p>package main</p>

<p>import (
    â€œos/execâ€
    â€œsyscallâ€
    â€œosâ€
    â€œlogâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS,
    }
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
} } è§£é‡Šä¸€ä¸‹ä»£ç ï¼Œexec.Command('sh') æ˜¯å»æŒ‡å®šå½“å‰å‘½ä»¤çš„æ‰§è¡Œç¯å¢ƒï¼Œæˆ‘ä»¬é»˜è®¤ä½¿ç”¨shæ¥æ‰§è¡Œã€‚ä¸‹é¢çš„å°±æ˜¯è®¾ç½®ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼Œåƒæˆ‘ä»¬å‰é¢è®²åˆ°çš„ä¸€æ ·ï¼Œä½¿ç”¨CLONE_NEWUTSè¿™ä¸ªæ ‡è¯†ç¬¦å»åˆ›å»ºä¸€ä¸ªUTS Namespaceã€‚Goå¸®æˆ‘ä»¬å°è£…äº†å¯¹äºclone()å‡½æ•°çš„è°ƒç”¨ï¼Œè¿™ä¸ªä»£ç æ‰§è¡Œåå°±ä¼šè¿›å…¥åˆ°ä¸€ä¸ªsh è¿è¡Œç¯å¢ƒä¸­ã€‚
</code></pre></div></div>

<p>æˆ‘ä»¬åœ¨ubuntu 14.04ä¸Šè¿è¡Œè¿™ä¸ªç¨‹åºï¼Œkernelç‰ˆæœ¬3.13.0-65-generic,go ç‰ˆæœ¬1.7.3ï¼Œæ‰§è¡Œgo run main.goï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªäº¤äº’å¼ç¯å¢ƒé‡Œé¢ä½¿ç”¨pstree -plæŸ¥çœ‹ä¸€ä¸‹ç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´çš„å…³ç³»</p>

<p>|-sshd(19820)â€”bash(19839)â€”go(19901)-+-main(19912)-+-sh(19915)â€”
    pstree(19916) <br />
ç„¶åæˆ‘ä»¬è¾“å‡ºä¸€ä¸‹å½“å‰çš„ PID</p>

<h1 id="echo-">echo $$</h1>
<p>19915
éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æ˜¯å¦ä¸åœ¨åŒä¸€ä¸ªUTS namespace</p>

<h1 id="readlink-proc19912nsuts">readlink /proc/19912/ns/uts</h1>
<p>uts:[4026531838]</p>
<h1 id="readlink-proc19915nsuts">readlink /proc/19915/ns/uts</h1>
<p>uts:[4026532193]
å¯ä»¥çœ‹åˆ°ä»–ä»¬ç¡®å®ä¸åœ¨åŒä¸€ä¸ªUTS namespaceã€‚ç”±äºUTS Namespaceæ˜¯å¯¹hostnameåšäº†éš”ç¦»ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨è¿™ä¸ªç¯å¢ƒå†…ä¿®æ”¹hostnameåº”è¯¥ä¸å½±å“å¤–éƒ¨ä¸»æœºï¼Œä¸‹é¢æˆ‘ä»¬æ¥åšä¸€ä¸‹å®éªŒã€‚</p>

<p>åœ¨è¿™ä¸ªshç¯å¢ƒå†…æ‰§è¡Œ</p>

<p>ä¿®æ”¹hostname ä¸ºbirdç„¶åæ‰“å°å‡ºæ¥</p>
<h1 id="hostname--b-bird">hostname -b bird</h1>
<h1 id="hostname">hostname</h1>
<p>bird  <br />
æˆ‘ä»¬å¦å¤–å¯åŠ¨ä¸€ä¸ªshellåœ¨å®¿ä¸»æœºä¸Šè¿è¡Œä¸€ä¸‹hostnameçœ‹ä¸€ä¸‹æ•ˆæœ</p>

<p>root@iZ254rt8xf1Z:~# hostname
iZ254rt8xf1Z
å¯ä»¥çœ‹åˆ°å¤–éƒ¨çš„ hostname å¹¶æ²¡æœ‰è¢«å†…éƒ¨çš„ä¿®æ”¹æ‰€å½±å“ï¼Œç”±æ­¤å°±äº†è§£äº†UTS Namespaceçš„ä½œç”¨ã€‚</p>

<p>IPC Namespace
IPC Namespace æ˜¯ç”¨æ¥éš”ç¦» System V IPC å’ŒPOSIX message queues.æ¯ä¸€ä¸ªIPC Namespaceéƒ½æœ‰ä»–ä»¬è‡ªå·±çš„System V IPC å’ŒPOSIX message queueã€‚</p>

<p>æˆ‘ä»¬åœ¨ä¸Šä¸€ç‰ˆæœ¬çš„åŸºç¡€ä¸Šç¨å¾®æ”¹åŠ¨äº†ä¸€ä¸‹ä»£ç </p>

<p>package main</p>

<p>import (
    â€œlogâ€
    â€œosâ€
    â€œos/execâ€
    â€œsyscallâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC,
    }
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
} } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä»…ä»…å¢åŠ syscall.CLONE_NEWIPCä»£è¡¨æˆ‘ä»¬å¸Œæœ›åˆ›å»ºIPC Namespaceã€‚ä¸‹é¢æˆ‘ä»¬éœ€è¦æ‰“å¼€ä¸¤ä¸ªshell æ¥æ¼”ç¤ºéš”ç¦»çš„æ•ˆæœã€‚
</code></pre></div></div>

<p>é¦–å…ˆåœ¨å®¿ä¸»æœºä¸Šæ‰“å¼€ä¸€ä¸ª shell</p>

<p>æŸ¥çœ‹ç°æœ‰çš„ipc Message Queues
root@iZ254rt8xf1Z:~# ipcs -q</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages</p>

<p>ä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªmessage queue
root@iZ254rt8xf1Z:~# ipcmk -Q
Message queue id: 0
ç„¶åå†æŸ¥çœ‹ä¸€ä¸‹ 
root@iZ254rt8xf1Z:~# ipcs -q</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages
0x5e8f3f1e 0          root       644        0            0
è¿™é‡Œæˆ‘ä»¬å‘ç°æ˜¯å¯ä»¥çœ‹åˆ°ä¸€ä¸ªqueueäº†ã€‚ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å¦å¤–ä¸€ä¸ªshellå»è¿è¡Œæˆ‘ä»¬çš„ç¨‹åºã€‚</p>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# go run main.go</p>
<h1 id="ipcs--q">ipcs -q</h1>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages
é€šè¿‡è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåœ¨æ–°åˆ›å»ºçš„Namespaceé‡Œé¢ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°å®¿ä¸»æœºä¸Šå·²ç»åˆ›å»ºçš„message queueï¼Œè¯´æ˜æˆ‘ä»¬çš„ IPC Namespace åˆ›å»ºæˆåŠŸï¼ŒIPC å·²ç»è¢«éš”ç¦»ã€‚</p>

<p>PID Namesapce
PID namespaceæ˜¯ç”¨æ¥éš”ç¦»è¿›ç¨‹ idã€‚åŒæ ·çš„ä¸€ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„ PID Namespace é‡Œé¢å¯ä»¥æ‹¥æœ‰ä¸åŒçš„ PIDã€‚è¿™æ ·å°±å¯ä»¥ç†è§£ï¼Œåœ¨ docker container é‡Œé¢ï¼Œæˆ‘ä»¬ä½¿ç”¨ps -ef ç»å¸¸èƒ½å‘ç°ï¼Œå®¹å™¨å†…åœ¨å‰å°è·‘ç€çš„é‚£ä¸ªè¿›ç¨‹çš„ PID æ˜¯1ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨å®¹å™¨å¤–ï¼Œä½¿ç”¨ps -efä¼šå‘ç°åŒæ ·çš„è¿›ç¨‹å´æœ‰ä¸åŒçš„ PIDï¼Œè¿™å°±æ˜¯PID namespace å¹²çš„äº‹æƒ…ã€‚</p>

<p>å†å‰é¢çš„ä»£ç åŸºç¡€ä¹‹ä¸Šï¼Œæˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ä»£ç ï¼Œæ·»åŠ äº†ä¸€ä¸ªsyscall.CLONE_NEWPID</p>

<p>package main</p>

<p>import (
    â€œlogâ€
    â€œosâ€
    â€œos/execâ€
    â€œsyscallâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID,
    }
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
} } æˆ‘ä»¬éœ€è¦æ‰“å¼€ä¸¤ä¸ª shellï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸Šçœ‹ä¸€ä¸‹è¿›ç¨‹æ ‘ï¼Œæ‰¾ä¸€ä¸‹æˆ‘ä»¬çš„è¿›ç¨‹çš„çœŸå® PID
</code></pre></div></div>

<p>root@iZ254rt8xf1Z:~# pstree -pl
 |-sshd(894)-+-sshd(9455)â€”bash(9475)â€”bash(19619)
    |           |-sshd(19715)â€”bash(19734)
    |           |-sshd(19853)â€”bash(19872)â€”go(20179)-+-main(20190)-+-sh(20193)
    |           |                                       |             |-{main}(20191)
    |           |                                       |             <code class="language-plaintext highlighter-rouge">-{main}(20192)
    |           |                                       |-{go}(20180)
    |           |                                       |-{go}(20181)
    |           |                                       |-{go}(20182)
    |           |                                       </code>-{go}(20186)
    |           `-sshd(20124)â€”bash(20144)â€”pstree(20196)
å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬çš„go main å‡½æ•°è¿è¡Œçš„pidä¸º 20190ã€‚ä¸‹é¢æˆ‘ä»¬æ‰“å¼€å¦å¤–ä¸€ä¸ª shell è¿è¡Œä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç </p>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# go run main.go</p>
<h1 id="echo--1">echo $$</h1>
<p>1
å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬æ‰“å°äº†å½“å‰namespaceçš„pidï¼Œå‘ç°æ˜¯1ï¼Œä¹Ÿå°±æ˜¯è¯´ã€‚è¿™ä¸ª20190 PID è¢«æ˜ å°„åˆ° namesapce é‡Œé¢çš„ PID ä¸º1.è¿™é‡Œè¿˜ä¸èƒ½ä½¿ç”¨ps æ¥æŸ¥çœ‹ï¼Œå› ä¸ºps å’Œ top ç­‰å‘½ä»¤ä¼šä½¿ç”¨/procå†…å®¹ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹é¢çš„mount namesapceè®²è§£ã€‚</p>

<p>Mount Namespace
mount namespace æ˜¯ç”¨æ¥éš”ç¦»å„ä¸ªè¿›ç¨‹çœ‹åˆ°çš„æŒ‚è½½ç‚¹è§†å›¾ã€‚åœ¨ä¸åŒnamespaceä¸­çš„è¿›ç¨‹çœ‹åˆ°çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡æ˜¯ä¸ä¸€æ ·çš„ã€‚åœ¨mount namespace ä¸­è°ƒç”¨mount()å’Œumount()ä»…ä»…åªä¼šå½±å“å½“å‰namespaceå†…çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œå¯¹å…¨å±€çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯æ²¡æœ‰å½±å“çš„ã€‚</p>

<p>çœ‹åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸å°±ä¼šæƒ³åˆ°chroot()ã€‚å®ƒä¹Ÿæ˜¯å°†æŸä¸€ä¸ªå­ç›®å½•å˜æˆæ ¹èŠ‚ç‚¹ã€‚ä½†æ˜¯mount namespaceä¸ä»…èƒ½å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œè€Œä¸”èƒ½ä»¥æ›´åŠ çµæ´»å’Œå®‰å…¨çš„æ–¹å¼å®ç°ã€‚</p>

<p>mount namespaceæ˜¯Linux ç¬¬ä¸€ä¸ªå®ç°çš„namesapce ç±»å‹ï¼Œå› æ­¤å®ƒçš„ç³»ç»Ÿè°ƒç”¨å‚æ•°æ˜¯NEWNS(new namespace çš„ç¼©å†™)ã€‚è²Œä¼¼å½“æ—¶äººä»¬æ²¡æœ‰æ„è¯†åˆ°ï¼Œä»¥åè¿˜ä¼šæœ‰å¾ˆå¤šç±»å‹çš„namespaceåŠ å…¥Linuxå¤§å®¶åº­ã€‚</p>

<p>æˆ‘ä»¬é’ˆå¯¹ä¸Šé¢çš„ä»£ç åšäº†ä¸€ç‚¹æ”¹åŠ¨ï¼Œå¢åŠ äº†NEWNS æ ‡è¯†ã€‚</p>

<p>package main</p>

<p>import (
    â€œlogâ€
    â€œosâ€
    â€œos/execâ€
    â€œsyscallâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS,
    }
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
} } é¦–å…ˆæˆ‘ä»¬è¿è¡Œä»£ç åï¼ŒæŸ¥çœ‹ä¸€ä¸‹/procçš„æ–‡ä»¶å†…å®¹ã€‚proc æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæä¾›é¢å¤–çš„æœºåˆ¶å¯ä»¥ä»å†…æ ¸å’Œå†…æ ¸æ¨¡å—å°†ä¿¡æ¯å‘é€ç»™è¿›ç¨‹ã€‚
</code></pre></div></div>

<h1 id="ls-proc">ls /proc</h1>
<p>1     14     19872  23  34   43  55   739  865        bus      filesystems  kpagecount     pagetypeinfo   sysvipc
10    145    2      24  348  44  57   75   866        cgroups      fs       kpageflags     partitions     timer_list
100   1472   20     25  35   45  58   76   869        cmdline      interrupts   latency_stats  sched_debug    timer_stats
11    1475   20124  26  353  47  59   77   894        consoles     iomem    loadavg        schedstat      tty
1174  15     20129  27  36   48  6    776  9          cpuinfo      ioports  locks          scsi       uptime
1192  154    20144  28  37   49  60   78   937        crypto       ipmi     mdstat         self       version
12    155    20215  29  38   5   607  796  945        devices      irq      meminfo        slabinfo       version_signature
1255  16     20226  3   39   50  61   8    9460       diskstats    kallsyms misc           softirqs       vmallocinfo
1277  17     20229  30  391  51  62   827  967        dma      kcore    modules        stat       vmstat
1296  18     20231  31  40   52  63   836  99         driver       key-users    mounts         swaps          xen
13    19     21     32  41   53  7    860  acpi       execdomains  keys     mtrr           sys        zoneinfo
1309  19853  22     33  42   54  733  862  buddyinfo  fb       kmsg     net        sysrq-trigger
å› ä¸ºè¿™é‡Œçš„/procè¿˜æ˜¯å®¿ä¸»æœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°é‡Œé¢ä¼šæ¯”è¾ƒä¹±ï¼Œä¸‹é¢æˆ‘ä»¬å°†/proc mountåˆ°æˆ‘ä»¬è‡ªå·±çš„namesapceä¸‹é¢æ¥ã€‚</p>

<h1 id="mount--t-proc-proc-proc">mount -t proc proc /proc</h1>
<h1 id="ls-proc-1">ls /proc</h1>
<p>1      consoles   execdomains  ipmi       kpagecount     misc      sched_debug  swaps          uptime
5      cpuinfo    fb       irq        kpageflags     modules       schedstat    sys        version
acpi       crypto     filesystems  kallsyms   latency_stats  mounts    scsi     sysrq-trigger  version_signature
buddyinfo  devices    fs       kcore      loadavg        mtrr      self     sysvipc        vmallocinfo
bus    diskstats  interrupts   key-users  locks      net       slabinfo timer_list     vmstat
cgroups    dma        iomem    keys       mdstat         pagetypeinfo  softirqs timer_stats    xen
cmdline    driver     ioports      kmsg       meminfo        partitions    stat     tty        zoneinfo
å¯ä»¥çœ‹åˆ°ï¼Œç¬é—´å°‘äº†å¥½å¤šå‘½ä»¤ã€‚ä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ ps æ¥æŸ¥çœ‹ç³»ç»Ÿçš„è¿›ç¨‹äº†ã€‚</p>

<h1 id="ps--ef">ps -ef</h1>
<p>UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 20:15 pts/4    00:00:00 sh
root         6     1  0 20:19 pts/4    00:00:00 ps -ef
å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å½“å‰namesapceé‡Œé¢ï¼Œæˆ‘ä»¬çš„sh è¿›ç¨‹æ˜¯PID ä¸º1 çš„è¿›ç¨‹ã€‚è¿™é‡Œå°±è¯´æ˜ï¼Œæˆ‘ä»¬å½“å‰çš„Mount namesapce é‡Œé¢çš„mount å’Œå¤–éƒ¨ç©ºé—´æ˜¯éš”ç¦»çš„ï¼Œmount æ“ä½œå¹¶æ²¡æœ‰å½±å“åˆ°å¤–éƒ¨ã€‚Docker volume ä¹Ÿæ˜¯åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§ã€‚</p>

<p>User Namesapce
User namespace ä¸»è¦æ˜¯éš”ç¦»ç”¨æˆ·çš„ç”¨æˆ·ç»„IDã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªè¿›ç¨‹çš„User ID å’ŒGroup ID åœ¨User namespace å†…å¤–å¯ä»¥æ˜¯ä¸åŒçš„ã€‚æ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ï¼Œåœ¨å®¿ä¸»æœºä¸Šä»¥ä¸€ä¸ªérootç”¨æˆ·è¿è¡Œåˆ›å»ºä¸€ä¸ªUser namespaceï¼Œç„¶ååœ¨User namespaceé‡Œé¢å´æ˜ å°„æˆroot ç”¨æˆ·ã€‚è¿™æ ·æ„å‘³ç€ï¼Œè¿™ä¸ªè¿›ç¨‹åœ¨User namespaceé‡Œé¢æœ‰rootæƒé™ï¼Œä½†æ˜¯åœ¨User namespaceå¤–é¢å´æ²¡æœ‰rootçš„æƒé™ã€‚ä»Linux kernel 3.8å¼€å§‹ï¼Œérootè¿›ç¨‹ä¹Ÿå¯ä»¥åˆ›å»ºUser namespace ,å¹¶ä¸”æ­¤è¿›ç¨‹åœ¨namespaceé‡Œé¢å¯ä»¥è¢«æ˜ å°„æˆ rootå¹¶ä¸”åœ¨ namespaceå†…æœ‰rootæƒé™ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬ç»§ç»­ä»¥ä¸€ä¸ªä¾‹å­æ¥æè¿°.</p>

<p>package main</p>

<p>import (
    â€œlogâ€
    â€œosâ€
    â€œos/execâ€
    â€œsyscallâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS |
            syscall.CLONE_NEWUSER,
    }
    cmd.SysProcAttr.Credential = &amp;syscall.Credential{Uid: uint32(1), Gid: uint32(1)}
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
}
os.Exit(-1) } æˆ‘ä»¬åœ¨åŸæ¥çš„åŸºç¡€ä¸Šå¢åŠ äº†syscall.CLONE_NEWUSERã€‚é¦–å…ˆæˆ‘ä»¬ä»¥rootæ¥è¿è¡Œè¿™ä¸ªç¨‹åºï¼Œè¿è¡Œå‰åœ¨å®¿ä¸»æœºä¸Šæˆ‘ä»¬çœ‹ä¸€ä¸‹å½“å‰ç”¨æˆ·å’Œç”¨æˆ·ç»„
</code></pre></div></div>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# id
uid=0(root) gid=0(root) groups=0(root)
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æ˜¯root ç”¨æˆ·ï¼Œæˆ‘ä»¬è¿è¡Œä¸€ä¸‹ç¨‹åº</p>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# go run main.go
$ id
uid=65534(nobody) gid=65534(nogroup) groups=65534(nogroup)
Network Namespace
Network namespace æ˜¯ç”¨æ¥éš”ç¦»ç½‘ç»œè®¾å¤‡ï¼ŒIPåœ°å€ç«¯å£ç­‰ç½‘ç»œæ ˆçš„namespaceã€‚Network namespace å¯ä»¥è®©æ¯ä¸ªå®¹å™¨æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘ç»œè®¾å¤‡ï¼ˆè™šæ‹Ÿçš„ï¼‰ï¼Œè€Œä¸”å®¹å™¨å†…çš„åº”ç”¨å¯ä»¥ç»‘å®šåˆ°è‡ªå·±çš„ç«¯å£ï¼Œæ¯ä¸ª namesapce å†…çš„ç«¯å£éƒ½ä¸ä¼šäº’ç›¸å†²çªã€‚åœ¨å®¿ä¸»æœºä¸Šæ­å»ºç½‘æ¡¥åï¼Œå°±èƒ½å¾ˆæ–¹ä¾¿çš„å®ç°å®¹å™¨ä¹‹é—´çš„é€šä¿¡ï¼Œè€Œä¸”æ¯ä¸ªå®¹å™¨å†…çš„åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç«¯å£ã€‚</p>

<p>åŒæ ·ï¼Œæˆ‘ä»¬åœ¨åŸæ¥çš„ä»£ç ä¸Šå¢åŠ ä¸€ç‚¹ã€‚æˆ‘ä»¬å¢åŠ äº†syscall.CLONE_NEWNET è¿™é‡Œæ ‡è¯†ç¬¦ã€‚</p>

<p>package main</p>

<p>import (
    â€œlogâ€
    â€œosâ€
    â€œos/execâ€
    â€œsyscallâ€
)</p>

<p>func main() {
    cmd := exec.Command(â€œshâ€)
    cmd.SysProcAttr = &amp;syscall.SysProcAttr{
        Cloneflags: syscall.CLONE_NEWUTS | syscall.CLONE_NEWIPC | syscall.CLONE_NEWPID | syscall.CLONE_NEWNS |
            syscall.CLONE_NEWUSER | syscall.CLONE_NEWNET,
    }
    cmd.SysProcAttr.Credential = &amp;syscall.Credential{Uid: uint32(1), Gid: uint32(1)}
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := cmd.Run(); err != nil {
    log.Fatal(err)
}
os.Exit(-1) } é¦–å…ˆæˆ‘ä»¬åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹ä¸€ä¸‹è‡ªå·±çš„ç½‘ç»œè®¾å¤‡ã€‚
</code></pre></div></div>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# ifconfig
docker0   Link encap:Ethernet  HWaddr 02:42:d7:5d:c3:b9
          inet addr:192.168.0.1  Bcast:0.0.0.0  Mask:255.255.240.0
          UP BROADCAST MULTICAST  MTU:1500  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</p>

<p>eth0      Link encap:Ethernet  HWaddr 00:16:3e:00:38:cc
          inet addr:10.170.174.187  Bcast:10.170.175.255  Mask:255.255.248.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:5605 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1819 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:7129227 (7.1 MB)  TX bytes:159780 (159.7 KB)</p>

<p>eth1      Link encap:Ethernet  HWaddr 00:16:3e:00:6d:4d
          inet addr:101.200.126.205  Bcast:101.200.127.255  Mask:255.255.252.0
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:15433 errors:0 dropped:0 overruns:0 frame:0
          TX packets:6888 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:13287762 (13.2 MB)  TX bytes:1787482 (1.7 MB)</p>

<p>lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)
å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®¿ä¸»æœºä¸Šæœ‰lo, eth0, eth1 ç­‰ç½‘ç»œè®¾å¤‡ï¼Œä¸‹é¢æˆ‘ä»¬è¿è¡Œä¸€ä¸‹ç¨‹åºå»Network namespce é‡Œé¢å»çœ‹çœ‹ã€‚</p>

<p>root@iZ254rt8xf1Z:~/gocode/src/book# go run main.go
$ ifconfig
$
æˆ‘ä»¬å‘ç°ï¼Œåœ¨Namespace é‡Œé¢ä»€ä¹ˆç½‘ç»œè®¾å¤‡éƒ½æ²¡æœ‰ã€‚è¿™æ ·å°±èƒ½å±•ç° Network namespace ä¸å®¿ä¸»æœºä¹‹é—´çš„ç½‘ç»œéš”ç¦»ã€‚</p>
:ET