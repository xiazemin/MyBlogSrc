I"–=<p>https://segmentfault.com/a/1190000022534841
golang Context çš„ä½¿ç”¨å’Œæ ‡å‡†åº“ä¸­çš„Contextçš„å®ç°ã€‚</p>

<p>golang context åŒ… ä¸€å¼€å§‹åªæ˜¯ Google å†…éƒ¨ä½¿ç”¨çš„ä¸€ä¸ª Golang åŒ…ï¼Œåœ¨ Golang 1.7çš„ç‰ˆæœ¬ä¸­æ­£å¼è¢«å¼•å…¥æ ‡å‡†åº“ã€‚
<!-- more -->
åœ¨å­¦ä¹  context åŒ…ä¹‹å‰ï¼Œå…ˆçœ‹å‡ ç§æ—¥å¸¸å¼€å‘ä¸­ç»å¸¸ä¼šç¢°åˆ°çš„ä¸šåŠ¡åœºæ™¯ï¼š</p>

<p>ä¸šåŠ¡éœ€è¦å¯¹è®¿é—®çš„æ•°æ®åº“ï¼ŒRPC ï¼Œæˆ–APIæ¥å£ï¼Œä¸ºäº†é˜²æ­¢è¿™äº›ä¾èµ–å¯¼è‡´æˆ‘ä»¬çš„æœåŠ¡è¶…æ—¶ï¼Œéœ€è¦é’ˆå¯¹æ€§çš„åšè¶…æ—¶æ§åˆ¶ã€‚
ä¸ºäº†è¯¦ç»†äº†è§£æœåŠ¡æ€§èƒ½ï¼Œè®°å½•è¯¦ç»†çš„è°ƒç”¨é“¾Logã€‚
ä¸Šé¢ä¸¤ç§åœºæ™¯åœ¨webä¸­æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œcontext åŒ…å°±æ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åº”å¯¹æ­¤ç±»åœºæ™¯è€Œä½¿ç”¨çš„ã€‚</p>

<p>æ¥ä¸‹æ¥, æˆ‘ä»¬é¦–å…ˆå­¦ä¹  context åŒ…æœ‰å“ªäº›æ–¹æ³•ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼›æ¥ç€ä¸¾ä¸€äº›ä¾‹å­ï¼Œä½¿ç”¨ context åŒ…åº”ç”¨åœ¨æˆ‘ä»¬ä¸Šè¿°åœºæ™¯ä¸­å»è§£å†³æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜ï¼›æœ€åä»æºç è§’åº¦å­¦ä¹  context å†…éƒ¨å®ç°ï¼Œäº†è§£ context çš„å®ç°åŸç†ã€‚</p>

<p>Context åŒ…
Context å®šä¹‰
context åŒ…ä¸­å®ç°äº†å¤šç§ Context å¯¹è±¡ã€‚Context æ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”¨æ¥æè¿°ä¸€ä¸ªç¨‹åºçš„ä¸Šä¸‹æ–‡ã€‚æ¥å£ä¸­æä¾›äº†å››ä¸ªæŠ½è±¡çš„æ–¹æ³•ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>

<p>type Context interface {
  Deadline() (deadline time.Time, ok bool)
  Done() &lt;-chan struct{}
  Err() error
  Value(key interface{}) interface{}
}
Deadline() è¿”å›çš„æ˜¯ä¸Šä¸‹æ–‡çš„æˆªè‡³æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰è®¾å®šï¼Œok ä¸º false
Done() å½“æ‰§è¡Œçš„ä¸Šä¸‹æ–‡è¢«å–æ¶ˆåï¼ŒDoneè¿”å›çš„chanå°±ä¼šè¢«closeã€‚å¦‚æœè¿™ä¸ªä¸Šä¸‹æ–‡ä¸ä¼šè¢«å–æ¶ˆï¼Œè¿”å›nil
Err() æœ‰å‡ ç§æƒ…å†µ:</p>

<p>å¦‚æœDone() è¿”å› chan æ²¡æœ‰å…³é—­ï¼Œè¿”å›nil
å¦‚æœDone() è¿”å›çš„chan å…³é—­äº†ï¼Œ Err è¿”å›ä¸€ä¸ªénilçš„å€¼ï¼Œè§£é‡Šä¸ºä»€ä¹ˆä¼šDone()</p>

<p>å¦‚æœCanceledï¼Œè¿”å› â€œCanceledâ€
å¦‚æœè¶…è¿‡äº† Deadlineï¼Œè¿”å› â€œDeadlineEsceededâ€
Value(key) è¿”å›ä¸Šä¸‹æ–‡ä¸­ key å¯¹åº”çš„ value å€¼
Context æ„é€ 
ä¸ºäº†ä½¿ç”¨ Contextï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ Context æ˜¯æ€ä¹ˆæ„é€ çš„ã€‚</p>

<p>Context æä¾›äº†ä¸¤ä¸ªæ–¹æ³•åšåˆå§‹åŒ–ï¼š</p>

<p>func Background() Context{}
func TODO() Context {}
ä¸Šé¢æ–¹æ³•å‡ä¼šè¿”å›ç©ºçš„ Contextï¼Œä½†æ˜¯ Background ä¸€èˆ¬æ˜¯æ‰€æœ‰ Context çš„åŸºç¡€ï¼Œæ‰€æœ‰ Context çš„æºå¤´éƒ½åº”è¯¥æ˜¯å®ƒã€‚TODO æ–¹æ³•ä¸€èˆ¬ç”¨äºå½“ä¼ å…¥çš„æ–¹æ³•ä¸ç¡®å®šæ˜¯å“ªç§ç±»å‹çš„ Context æ—¶ï¼Œä¸ºäº†é¿å… Context çš„å‚æ•°ä¸ºnilè€Œåˆå§‹åŒ–çš„ Contextã€‚</p>

<p>å…¶ä»–çš„ Context éƒ½æ˜¯åŸºäºå·²ç»æ„é€ å¥½çš„ Context æ¥å®ç°çš„ã€‚ä¸€ä¸ª Context å¯ä»¥æ´¾ç”Ÿå¤šä¸ªå­ contextã€‚åŸºäº Context æ´¾ç”Ÿæ–°Context çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>func WithCancel(parent Context) (ctx Context, cancel CancelFunc){}
func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {}
func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) {}
ä¸Šé¢ä¸‰ç§æ–¹æ³•æ¯”è¾ƒç±»ä¼¼ï¼Œå‡ä¼šåŸºäº parent Context ç”Ÿæˆä¸€ä¸ªå­ ctxï¼Œä»¥åŠä¸€ä¸ª Cancel æ–¹æ³•ã€‚å¦‚æœè°ƒç”¨äº†cancel æ–¹æ³•ï¼Œctx ä»¥åŠåŸºäº ctx æ„é€ çš„å­ context éƒ½ä¼šè¢«å–æ¶ˆã€‚ä¸åŒç‚¹åœ¨äº WithCancel å¿…éœ€è¦æ‰‹åŠ¨è°ƒç”¨ cancel æ–¹æ³•ï¼ŒWithDeadline
å¯ä»¥è®¾ç½®ä¸€ä¸ªæ—¶é—´ç‚¹ï¼ŒWithTimeout æ˜¯è®¾ç½®è°ƒç”¨çš„æŒç»­æ—¶é—´ï¼Œåˆ°æŒ‡å®šæ—¶é—´åï¼Œä¼šè°ƒç”¨ cancel åšå–æ¶ˆæ“ä½œã€‚</p>

<p>é™¤äº†ä¸Šé¢çš„æ„é€ æ–¹å¼ï¼Œè¿˜æœ‰ä¸€ç±»æ˜¯ç”¨æ¥åˆ›å»ºä¼ é€’ traceIdï¼Œ token ç­‰é‡è¦æ•°æ®çš„ Contextã€‚</p>

<p>func WithValue(parent Context, key, val interface{}) Context {}
withValue ä¼šæ„é€ ä¸€ä¸ªæ–°çš„contextï¼Œæ–°çš„context ä¼šåŒ…å«ä¸€å¯¹ Key-Value æ•°æ®ï¼Œå¯ä»¥é€šè¿‡Context.Value(Key) è·å–å­˜åœ¨ ctx ä¸­çš„ Value å€¼ã€‚</p>

<p>é€šè¿‡ä¸Šé¢çš„ç†è§£å¯ä»¥ç›´åˆ°ï¼ŒContext æ˜¯ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œä¸€ä¸ª Context å¯ä»¥æ´¾ç”Ÿå‡ºå¤šä¸ªä¸ä¸€æ ·çš„Contextã€‚æˆ‘ä»¬å¤§æ¦‚å¯ä»¥ç”»ä¸€ä¸ªå¦‚ä¸‹çš„æ ‘çŠ¶å›¾ï¼š</p>

<p>context_tree.jpg</p>

<p>ä¸€ä¸ªbackgroundï¼Œè¡ç”Ÿå‡ºä¸€ä¸ªå¸¦æœ‰traceIdçš„valueCtxï¼Œç„¶åvalueCtxè¡ç”Ÿå‡ºä¸€ä¸ªå¸¦æœ‰cancelCtx
çš„contextã€‚æœ€ç»ˆåœ¨ä¸€äº›dbæŸ¥è¯¢ï¼ŒhttpæŸ¥è¯¢ï¼Œrpcæ²™é€Šç­‰å¼‚æ­¥è°ƒç”¨ä¸­ä½“ç°ã€‚å¦‚æœå‡ºç°è¶…æ—¶ï¼Œç›´æ¥æŠŠè¿™äº›å¼‚æ­¥è°ƒç”¨å–æ¶ˆï¼Œå‡å°‘æ¶ˆè€—çš„èµ„æºï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨è°ƒç”¨æ—¶ï¼Œé€šè¿‡Value æ–¹æ³•æ‹¿åˆ°traceIdï¼Œå¹¶è®°å½•ä¸‹å¯¹åº”è¯·æ±‚çš„æ•°æ®ã€‚</p>

<p>å½“ç„¶ï¼Œé™¤äº†ä¸Šé¢çš„å‡ ç§ Context å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åŸºäºä¸Šè¿°çš„ Context æ¥å£å®ç°æ–°çš„Context.</p>

<p>ä½¿ç”¨æ–¹æ³•
ä¸‹é¢æˆ‘ä»¬ä¸¾å‡ ä¸ªä¾‹å­ï¼Œå­¦ä¹ ä¸Šé¢è®²åˆ°çš„æ–¹æ³•ã€‚</p>

<p>è¶…æ—¶æŸ¥è¯¢çš„ä¾‹å­
åœ¨åšæ•°æ®åº“æŸ¥è¯¢æ—¶ï¼Œéœ€è¦å¯¹æ•°æ®çš„æŸ¥è¯¢åšè¶…æ—¶æ§åˆ¶ï¼Œä¾‹å¦‚ï¼š</p>

<p>ctx = context.WithTimeout(context.Background(), time.Second)
rows, err := pool.QueryContext(ctx, â€œselect * from products where id = ?â€, 100)
ä¸Šé¢çš„ä»£ç åŸºäº Background æ´¾ç”Ÿå‡ºä¸€ä¸ªå¸¦æœ‰è¶…æ—¶å–æ¶ˆåŠŸèƒ½çš„ctxï¼Œä¼ å…¥å¸¦æœ‰contextæŸ¥è¯¢çš„æ–¹æ³•ä¸­ï¼Œå¦‚æœè¶…è¿‡1sæœªè¿”å›ç»“æœï¼Œåˆ™å–æ¶ˆæœ¬æ¬¡çš„æŸ¥è¯¢ã€‚ä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚ä¸ºäº†äº†è§£æŸ¥è¯¢å†…éƒ¨æ˜¯å¦‚ä½•åšåˆ°è¶…æ—¶å–æ¶ˆçš„ï¼Œæˆ‘ä»¬çœ‹çœ‹DBå†…éƒ¨æ˜¯å¦‚ä½•ä½¿ç”¨ä¼ å…¥çš„ctxçš„ã€‚</p>

<p>åœ¨æŸ¥è¯¢æ—¶ï¼Œéœ€è¦å…ˆä»poolä¸­è·å–ä¸€ä¸ªdbçš„é“¾æ¥ï¼Œä»£ç å¤§æ¦‚å¦‚ä¸‹ï¼š</p>

<p>// src/database/sql/sql.go
// func (db *DB) conn(ctx context.Context, strategy connReuseStrategy) *driverConn, error)</p>

<p>// é˜»å¡ä»reqä¸­è·å–é“¾æ¥ï¼Œå¦‚æœè¶…æ—¶ï¼Œç›´æ¥è¿”å›
select {
case &lt;-ctx.Done():
  // è·å–é“¾æ¥è¶…æ—¶äº†ï¼Œç›´æ¥è¿”å›é”™è¯¯
  // do something
  return nil, ctx.Err()
case ret, ok := &lt;-req:
  // æ‹¿åˆ°é“¾æ¥ï¼Œæ ¡éªŒå¹¶è¿”å›
  return ret.conn, ret.err
}
req ä¹Ÿæ˜¯ä¸€ä¸ªchanï¼Œæ˜¯ç­‰å¾…é“¾æ¥è¿”å›çš„chanï¼Œå¦‚æœDone() è¿”å›çš„chan å…³é—­åï¼Œåˆ™ä¸å†å…³å¿ƒreqçš„è¿”å›äº†ï¼Œæˆ‘ä»¬çš„æŸ¥è¯¢å°±è¶…æ—¶äº†ã€‚</p>

<p>åœ¨åšSQL Prepareã€SQL Query ç­‰æ“ä½œæ—¶ï¼Œä¹Ÿä¼šæœ‰ç±»ä¼¼æ–¹æ³•ï¼š</p>

<p>select {
default:
// æ ¡éªŒæ˜¯å¦å·²ç»è¶…æ—¶ï¼Œå¦‚æœè¶…æ—¶ç›´æ¥è¿”å›
case &lt;-ctx.Done():
  return nil, ctx.Err()
}
// å¦‚æœè¿˜æ²¡æœ‰è¶…æ—¶ï¼Œè°ƒç”¨é©±åŠ¨åšæŸ¥è¯¢
return queryer.Query(query, dargs)
ä¸Šé¢åœ¨åšæŸ¥è¯¢æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å·²ç»è¶…æ—¶äº†ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™ç›´æ¥è¿”å›é”™è¯¯ï¼Œå¦åˆ™æ‰è¿›è¡ŒæŸ¥è¯¢ã€‚</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ´¾ç”Ÿå‡ºçš„å¸¦æœ‰è¶…æ—¶å–æ¶ˆåŠŸèƒ½çš„ Context æ—¶ï¼Œå†…éƒ¨æ–¹æ³•åœ¨åšå¼‚æ­¥æ“ä½œï¼ˆæ¯”å¦‚è·å–é“¾æ¥ï¼ŒæŸ¥è¯¢ç­‰ï¼‰æ—¶ä¼šå…ˆæŸ¥çœ‹æ˜¯å¦å·²ç»
Doneäº†ï¼Œå¦‚æœDoneï¼Œè¯´æ˜è¯·æ±‚å·²è¶…æ—¶ï¼Œç›´æ¥è¿”å›é”™è¯¯ï¼›å¦åˆ™ç»§ç»­ç­‰å¾…ï¼Œæˆ–è€…åšä¸‹ä¸€æ­¥å·¥ä½œã€‚è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¦åšåˆ°è¶…æ—¶æ§åˆ¶ï¼Œéœ€è¦ä¸æ–­åˆ¤æ–­ Done() æ˜¯å¦å·²å…³é—­ã€‚</p>

<p>é“¾è·¯è¿½è¸ªçš„ä¾‹å­
åœ¨åšé“¾è·¯è¿½è¸ªæ—¶ï¼ŒContext ä¹Ÿæ˜¯éå¸¸é‡è¦çš„ã€‚ï¼ˆæ‰€è°“é“¾è·¯è¿½è¸ªï¼Œæ˜¯è¯´å¯ä»¥è¿½è¸ªæŸä¸€ä¸ªè¯·æ±‚æ‰€ä¾èµ–çš„æ¨¡å—ï¼Œæ¯”å¦‚dbï¼Œredisï¼Œrpcä¸‹æ¸¸ï¼Œæ¥å£ä¸‹æ¸¸ç­‰æœåŠ¡ï¼Œä»è¿™äº›ä¾èµ–æœåŠ¡ä¸­æ‰¾åˆ°è¯·æ±‚ä¸­çš„æ—¶é—´æ¶ˆè€—ï¼‰</p>

<p>ä¸‹é¢ä¸¾ä¸€ä¸ªé“¾è·¯è¿½è¸ªçš„ä¾‹å­ï¼š</p>

<p>// å»ºè®®æŠŠkey ç±»å‹ä¸å¯¼å‡ºï¼Œé˜²æ­¢è¢«è¦†ç›–
type traceIdKey struct{}{}</p>

<p>// å®šä¹‰å›ºå®šçš„Key
var TraceIdKey = traceIdKey{}</p>

<p>func ServeHTTP(w http.ResponseWriter, req *http.Request){
  // é¦–å…ˆä»è¯·æ±‚ä¸­æ‹¿åˆ°traceId
  // å¯ä»¥æŠŠtraceId æ”¾åœ¨headeré‡Œï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨bodyä¸­
  // è¿˜å¯ä»¥è‡ªå·±å»ºç«‹ä¸€ä¸ª ï¼ˆå¦‚æœè‡ªå·±æ˜¯è¯·æ±‚æºå¤´çš„è¯ï¼‰
  traceId := getTraceIdFromRequest(req)</p>

<p>// Key å­˜å…¥ ctx ä¸­
  ctx := context.WithValue(req.Context(), TraceIdKey, traceId)</p>

<p>// è®¾ç½®æ¥å£1s è¶…æ—¶
  ctx = context.WithTimeout(ctx, time.Second)</p>

<p>// query RPC æ—¶å¯ä»¥æºå¸¦ traceId
  repResp := RequestRPC(ctx, â€¦)</p>

<p>// query DB æ—¶å¯ä»¥æºå¸¦ traceId
  dbResp := RequestDB(ctx, â€¦)</p>

<p>// â€¦
}</p>

<p>func RequestRPC(ctx context.Context, â€¦) interface{} {
    // è·å–traceidï¼Œåœ¨è°ƒç”¨rpcæ—¶è®°å½•æ—¥å¿—
    traceId, _ := ctx.Value(TraceIdKey)
    // request</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// do log
return } ä¸Šè¿°ä»£ç ä¸­ï¼Œå½“æ‹¿åˆ°è¯·æ±‚åï¼Œæˆ‘ä»¬é€šè¿‡req è·å–traceIdï¼Œ å¹¶è®°å½•åœ¨ctxä¸­ï¼Œåœ¨è°ƒç”¨RPCï¼ŒDBç­‰æ—¶ï¼Œä¼ å…¥æˆ‘ä»¬æ„é€ çš„ctxï¼Œåœ¨åç»­ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ctxæ‹¿åˆ°æˆ‘ä»¬å­˜å…¥çš„traceIdï¼Œä½¿ç”¨traceId è®°å½•è¯·æ±‚çš„æ—¥å¿—ï¼Œæ–¹ä¾¿åç»­åšé—®é¢˜å®šä½ã€‚
</code></pre></div></div>

<p>å½“ç„¶ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œcontext ä¸ä¼šå•çº¯çš„ä»…ä»…æ˜¯ç”¨äº traceId çš„è®°å½•ï¼Œæˆ–è€…è¶…æ—¶çš„æ§åˆ¶ã€‚å¾ˆæœ‰å¯èƒ½äºŒè€…å…¼æœ‰ä¹‹ã€‚</p>

<p>å¦‚ä½•å®ç°
çŸ¥å…¶ç„¶ä¹Ÿéœ€çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚æƒ³è¦å……åˆ†åˆ©ç”¨å¥½ Contextï¼Œæˆ‘ä»¬è¿˜éœ€è¦å­¦ä¹  Context çš„å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬ä¸€èµ·å­¦ä¹ ä¸åŒçš„ Context æ˜¯å¦‚ä½•å®ç° Context æ¥å£çš„ï¼Œ</p>

<p>ç©ºä¸Šä¸‹æ–‡
Background(), Empty() å‡ä¼šè¿”å›ä¸€ä¸ªç©ºçš„ Context emptyCtxã€‚emptyCtx å¯¹è±¡åœ¨æ–¹æ³• Deadline(), Done(), Err(), Value(interface{}) ä¸­å‡ä¼šè¿”å›nilï¼ŒString() æ–¹æ³•ä¼šè¿”å›å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªå®ç°æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶ä¸è®¨è®ºã€‚</p>

<p>æœ‰å–æ¶ˆåŠŸèƒ½çš„ä¸Šä¸‹æ–‡
WithCancel æ„é€ çš„context æ˜¯ä¸€ä¸ªcancelCtxå®ä¾‹ï¼Œä»£ç å¦‚ä¸‹ã€‚</p>

<p>type cancelCtx struct {
  Context</p>

<p>// äº’æ–¥é”ï¼Œä¿è¯contextåç¨‹å®‰å…¨
  mu       sync.Mutex
  // cancel çš„æ—¶å€™ï¼Œclose è¿™ä¸ªchan
  done     chan struct{}
  // æ´¾ç”Ÿçš„context
  children map[canceler]struct{}
  err      error
}
WithCancel æ–¹æ³•é¦–å…ˆä¼šåŸºäº parent æ„å»ºä¸€ä¸ªæ–°çš„ Contextï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<p>func WithCancel(parent Context) (ctx Context, cancel CancelFunc) {
  c := newCancelCtx(parent)  // æ–°çš„ä¸Šä¸‹æ–‡
  propagateCancel(parent, &amp;c) // æŒ‚åˆ°parent ä¸Š
  return &amp;c, func() { c.cancel(true, Canceled) }
}
å…¶ä¸­ï¼ŒpropagateCancel æ–¹æ³•ä¼šåˆ¤æ–­ parent æ˜¯å¦å·²ç»å–æ¶ˆï¼Œå¦‚æœå–æ¶ˆï¼Œåˆ™ç›´æ¥è°ƒç”¨æ–¹æ³•å–æ¶ˆï¼›å¦‚æœæ²¡æœ‰å–æ¶ˆï¼Œä¼šåœ¨parentçš„children è¿½åŠ ä¸€ä¸ªchildã€‚è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºï¼Œcontext æ ‘çŠ¶ç»“æ„çš„å®ç°ã€‚ ä¸‹é¢æ˜¯propateCancel çš„å®ç°ï¼š</p>

<p>// æŠŠchild æŒ‚åœ¨åˆ°parent ä¸‹
func propagateCancel(parent Context, child canceler) {
  // å¦‚æœparent ä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›
  if parent.Done() == nil {
    return // parent is never canceled
  }</p>

<p>// è·å–parentç±»å‹
  if p, ok := parentCancelCtx(parent); ok {
    p.mu.Lock()
    if p.err != nil {
      // parent has already been canceled
      child.cancel(false, p.err)
    } else {
      if p.children == nil {
        p.children = make(map[canceler]struct{})
      }
      p.children[child] = struct{}{}
    }
    p.mu.Unlock()
  } else {
    // å¯åŠ¨goroutineï¼Œç­‰å¾…parent/child Done
    go func() {
      select {
      case &lt;-parent.Done():
        child.cancel(false, parent.Err())
      case &lt;-child.Done():
      }
    }()
  }
}
Done() å®ç°æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªchanï¼Œç­‰å¾…chan å…³é—­ã€‚å¯ä»¥çœ‹å‡º Done æ“ä½œæ˜¯åœ¨è°ƒç”¨æ—¶æ‰ä¼šæ„é€  chan doneï¼Œdone å˜é‡æ˜¯å»¶æ—¶åˆå§‹åŒ–çš„ã€‚</p>

<p>func (c *cancelCtx) Done() &lt;-chan struct{} {
  c.mu.Lock()
  if c.done == nil {
    c.done = make(chan struct{})
  }
  d := c.done
  c.mu.Unlock()
  return d
}
åœ¨æ‰‹åŠ¨å–æ¶ˆ Context æ—¶ï¼Œä¼šè°ƒç”¨ cancelCtx çš„ cancel æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>

<p>func (c *cancelCtx) cancel(removeFromParent bool, err error) {
  // ä¸€äº›åˆ¤æ–­,å…³é—­ ctx.done chan
  // â€¦
  if c.done == nil {
    c.done = closedchan
  } else {
    close(c.done)
  }</p>

<p>// å¹¿æ’­åˆ°æ‰€æœ‰çš„childï¼Œéœ€è¦cancel goroutine äº†
  for child := range c.children {
    // NOTE: acquiring the childâ€™s lock while holding parentâ€™s lock.
    child.cancel(false, err)
  }
  c.children = nil
  c.mu.Unlock()</p>

<p>// ç„¶åä»çˆ¶context ä¸­ï¼Œåˆ é™¤å½“å‰çš„context
  if removeFromParent {
    removeChild(c.Context, c)
  }
}
è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå½“æ‰§è¡Œcancelæ—¶ï¼Œé™¤äº†ä¼šå…³é—­å½“å‰çš„cancelå¤–ï¼Œè¿˜åšäº†ä¸¤ä»¶äº‹ï¼Œâ‘  æ‰€æœ‰çš„child éƒ½è°ƒç”¨cancelæ–¹æ³•ï¼Œâ‘¡ ç”±äºè¯¥ä¸Šä¸‹æ–‡å·²ç»å…³é—­ï¼Œéœ€è¦ä»çˆ¶ä¸Šä¸‹æ–‡ä¸­ç§»é™¤å½“å‰çš„ä¸Šä¸‹æ–‡ã€‚</p>

<p>å®šæ—¶å–æ¶ˆåŠŸèƒ½çš„ä¸Šä¸‹æ–‡
WithDeadline, WithTimeout æä¾›äº†å®ç°å®šæ—¶åŠŸèƒ½çš„ Context æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªtimerCtxç»“æ„ä½“ã€‚WithDeadline æ˜¯ç»™å®šäº†æ‰§è¡Œæˆªè‡³æ—¶é—´ï¼ŒWithTimeout æ˜¯å€’è®¡æ—¶æ—¶é—´ï¼ŒWithTImeout æ˜¯åŸºäºWithDeadlineå®ç°çš„ï¼Œå› æ­¤æˆ‘ä»¬ä»…çœ‹å…¶ä¸­çš„WithDeadline
å³å¯ã€‚WithDeadline å†…éƒ¨å®ç°æ˜¯åŸºäºcancelCtx çš„ã€‚ç›¸å¯¹äº cancelCtx å¢åŠ äº†ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå¹¶è®°å½•äº† Deadline æ—¶é—´ç‚¹ã€‚ä¸‹é¢æ˜¯timerCtx ç»“æ„ä½“ï¼š</p>

<p>type timerCtx struct {
  cancelCtx
  // è®¡æ—¶å™¨
  timer *time.Timer
  // æˆªæ­¢æ—¶é—´
  deadline time.Time
}
WithDeadline çš„å®ç°ï¼š</p>

<p>func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) {
  // è‹¥çˆ¶ä¸Šä¸‹æ–‡ç»“æŸæ—¶é—´æ—©äºchildï¼Œ
  // åˆ™childç›´æ¥æŒ‚è½½åœ¨parentä¸Šä¸‹æ–‡ä¸‹å³å¯
  if cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) {
    return WithCancel(parent)
  }</p>

<p>// åˆ›å»ºä¸ªtimerCtx, è®¾ç½®deadline
  c := &amp;timerCtx{
    cancelCtx: newCancelCtx(parent),
    deadline:  d,
  }</p>

<p>// å°†contextæŒ‚åœ¨parent ä¹‹ä¸‹
  propagateCancel(parent, c)</p>

<p>// è®¡ç®—å€’è®¡æ—¶æ—¶é—´
  dur := time.Until(d)
  if dur &lt;= 0 {
    c.cancel(true, DeadlineExceeded) // deadline has already passed
    return c, func() { c.cancel(false, Canceled) }
  }
  c.mu.Lock()
  defer c.mu.Unlock()
  if c.err == nil {
    // è®¾å®šä¸€ä¸ªè®¡æ—¶å™¨ï¼Œåˆ°æ—¶è°ƒç”¨cancel
    c.timer = time.AfterFunc(dur, func() {
      c.cancel(true, DeadlineExceeded)
    })
  }
  return c, func() { c.cancel(true, Canceled) }
}
æ„é€ æ–¹æ³•ä¸­ï¼Œå°†æ–°çš„context æŒ‚åœ¨åˆ°parentä¸‹ï¼Œå¹¶åˆ›å»ºäº†å€’è®¡æ—¶å™¨å®šæœŸè§¦å‘cancelã€‚</p>

<p>timerCtx çš„cancel æ“ä½œï¼Œå’ŒcancelCtx çš„cancel æ“ä½œæ˜¯éå¸¸ç±»ä¼¼çš„ã€‚åœ¨cancelCtx çš„åŸºç¡€ä¸Šï¼Œåšäº†å…³é—­å®šæ—¶å™¨çš„æ“ä½œ</p>

<p>func (c *timerCtx) cancel(removeFromParent bool, err error) {
  // è°ƒç”¨cancelCtx çš„cancel æ–¹æ³• å…³é—­chanï¼Œå¹¶é€šçŸ¥å­contextã€‚
  c.cancelCtx.cancel(false, err)
  // ä»parent ä¸­ç§»é™¤
  if removeFromParent {
    removeChild(c.cancelCtx.Context, c)
  }
  c.mu.Lock()
  // å…³æ‰å®šæ—¶å™¨
  if c.timer != nil {
    c.timer.Stop()
    c.timer = nil
  }
  c.mu.Unlock()
}
timeCtx çš„ Done æ“ä½œç›´æ¥å¤ç”¨äº†cancelCtx çš„ Done æ“ä½œï¼Œç›´æ¥å…³é—­ chan done æˆå‘˜ã€‚</p>

<p>ä¼ é€’å€¼çš„ä¸Šä¸‹æ–‡
WithValue æ„é€ çš„ä¸Šä¸‹æ–‡ä¸ä¸Šé¢å‡ ç§æœ‰åŒºåˆ«ï¼Œå…¶æ„é€ çš„context åŸå‹å¦‚ä¸‹ï¼š</p>

<p>type valueCtx struct {
  // ä¿ç•™äº†çˆ¶èŠ‚ç‚¹çš„context
  Context
  key, val interface{}
}
æ¯ä¸ªcontext åŒ…å«äº†ä¸€ä¸ªKey-Valueç»„åˆã€‚valueCtx ä¿ç•™äº†çˆ¶èŠ‚ç‚¹çš„Contextï¼Œä½†æ²¡æœ‰åƒcancelCtx ä¸€æ ·ä¿ç•™å­èŠ‚ç‚¹çš„Context. ä¸‹é¢æ˜¯valueCtxçš„æ„é€ æ–¹æ³•ï¼š</p>

<p>func WithValue(parent Context, key, val interface{}) Context {
  if key == nil {
    panic(â€œnil keyâ€)
  }
  // key å¿…é¡»æ˜¯è¯¾æ¯”è¾ƒçš„ï¼Œä¸ç„¶æ— æ³•è·å–Value
  if !reflect.TypeOf(key).Comparable() {
    panic(â€œkey is not comparableâ€)
  }
  return &amp;valueCtx{parent, key, val}
}
ç›´æ¥å°†Key-Valueèµ‹å€¼ç»™struct å³å¯å®Œæˆæ„é€ ã€‚ä¸‹é¢æ˜¯è·å–Value çš„æ–¹æ³•ï¼š</p>

<p>func (c *valueCtx) Value(key interface{}) interface{} {
  if c.key == key {
    return c.val
  }
  // ä»çˆ¶context ä¸­è·å–
  return c.Context.Value(key)
}
Value çš„è·å–æ˜¯é‡‡ç”¨é“¾å¼è·å–çš„æ–¹æ³•ã€‚å¦‚æœå½“å‰ Context ä¸­æ‰¾ä¸åˆ°ï¼Œåˆ™ä»çˆ¶Contextä¸­è·å–ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸€ä¸ªcontext å¤šæ”¾å‡ æ¡æ•°æ®æ—¶ï¼Œå¯ä»¥ä¿å­˜ä¸€ä¸ªmap æ•°æ®åˆ° context ä¸­ã€‚è¿™é‡Œä¸å»ºè®®å¤šæ¬¡æ„é€ contextæ¥å­˜æ”¾æ•°æ®ã€‚æ¯•ç«Ÿå–æ•°æ®çš„æˆæœ¬ä¹Ÿæ˜¯æ¯”è¾ƒé«˜çš„ã€‚</p>

<p>æ³¨æ„äº‹é¡¹
æœ€åï¼Œåœ¨ä½¿ç”¨ä¸­åº”è¯¥æ³¨æ„å¦‚ä¸‹å‡ ç‚¹ï¼š</p>

<p>context.Background ç”¨åœ¨è¯·æ±‚è¿›æ¥çš„æ—¶å€™ï¼Œæ‰€æœ‰å…¶ä»–context æ¥æºäºå®ƒã€‚
åœ¨ä¼ å…¥çš„conttext ä¸ç¡®å®šä½¿ç”¨çš„æ˜¯é‚£ç§ç±»å‹çš„æ—¶å€™ï¼Œä¼ å…¥TODO context ï¼ˆä¸åº”è¯¥ä¼ å…¥ä¸€ä¸ªnil çš„context)
context.Value ä¸åº”è¯¥ä¼ å…¥å¯é€‰çš„å‚æ•°ï¼Œåº”è¯¥æ˜¯æ¯ä¸ªè¯·æ±‚éƒ½ä¸€å®šä¼šè‡ªå¸¦çš„ä¸€äº›æ•°æ®ã€‚ï¼ˆæ¯”å¦‚è¯´traceIdï¼Œæˆæƒtoken ä¹‹ç±»çš„ï¼‰ã€‚åœ¨Value ä½¿ç”¨æ—¶ï¼Œå»ºè®®æŠŠKey å®šä¹‰ä¸ºå…¨å±€const å˜é‡ï¼Œå¹¶ä¸”key çš„ç±»å‹ä¸å¯å¯¼å‡ºï¼Œé˜²æ­¢æ•°æ®å­˜åœ¨å†²çªã€‚
context goroutines å®‰å…¨ã€‚</p>
:ET