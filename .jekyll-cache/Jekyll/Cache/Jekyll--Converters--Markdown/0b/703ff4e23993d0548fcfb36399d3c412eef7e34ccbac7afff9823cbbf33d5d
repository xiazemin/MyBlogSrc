I"‘K<p>dwarfè°ƒè¯•ä¿¡æ¯æ ¼å¼ï¼Œå†…å®¹åŒ…æ‹¬æœ‰å“ªäº›ç±»å‹çš„è°ƒè¯•ä¿¡æ¯ï¼Œè°ƒè¯•ä¿¡æ¯çš„å­˜æ”¾æ ¼å¼ã€æŸäº›è°ƒè¯•ä¿¡æ¯çš„ç¼–ç æ–¹æ³•ç­‰ã€‚
åœ¨ä½¿ç”¨gccç¼–è¯‘ç¨‹åºçš„æ—¶å€™ï¼ŒåŠ ä¸Š-gå‚æ•°ï¼Œé‚£ä¹ˆæœ€åç”Ÿæˆçš„ç›®æ ‡æ–‡ä»¶ä¸­ä¼šæœ‰è°ƒè¯•ä¿¡æ¯ï¼Œè°ƒè¯•ä¿¡æ¯æ ¼å¼ä½¿ç”¨dwarf2æ ¼å¼ã€‚ä½¿ç”¨readelfå·¥å…·åŠ ä¸Š-Så‚æ•°ï¼Œå¯ä»¥æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶ä¸­æœ‰å“ªäº›è°ƒè¯•ä¿¡æ¯section</p>

<p>ä¸€ä¸ªç¨‹åºçš„å®Œæˆè¿‡ç¨‹ä¸€èˆ¬æ˜¯ç¼–ç ã€ç¼–è¯‘ã€è¿è¡Œçš„è¿‡ç¨‹ï¼Œå½“ç„¶è¿™æ˜¯ä¸€ä¸ªç†æƒ³çš„è¿‡ç¨‹ï¼Œæ‰€æœ‰çš„å¼€å‘å‡ ä¹éƒ½ä¸å¯èƒ½æ˜¯ä¸€å¸†é£é¡ºçš„ï¼Œæ€»ä¼šæœ‰äº›æ„æƒ³ä¸åˆ°çš„é”™è¯¯ï¼Œè¿™æ—¶ä¾¿éœ€è¦è°ƒè¯•ï¼Œè‰¯å¥½çš„è°ƒè¯•å™¨åº”è¯¥æ¯ä¸€ä¸ªç¨‹åºå‘˜çš„å¿…å¤‡ã€‚
é‚£ä¹ˆè°ƒè¯•å™¨ä½¿ç”¨çš„è°ƒè¯•ä¿¡æ¯æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆç®€å•çš„å¾ˆï¼Œæ˜¯ä»ç¼–è¯‘åçš„æ–‡ä»¶ä¸­æ¥çš„(æ³¨æ„è¿™é‡Œç¼–è¯‘çš„æ—¶å€™è¦ä½¿ç”¨ç‰¹å®šçš„ç¼–è¯‘é€‰é¡¹ï¼Œå¦‚VCä½¿ç”¨debugæ¨¡å¼ï¼ŒGCCä½¿ç”¨â€-gâ€)ã€‚åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨ä¼šä»æºæ–‡ä»¶ä¸­æ”¶é›†å¤§é‡çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å˜é‡åã€å˜é‡ç±»å‹ã€å˜é‡æ‰€åœ¨è¡Œå·ã€å‡½æ•°åã€å‡½æ•°å‚æ•°ã€å‡½æ•°çš„åœ°å€èŒƒå›´ã€è¡Œå·å’Œåœ°å€çš„å¯¹åº”å…³ç³»ç­‰ç­‰ï¼Œç„¶åæŒ‰ç…§ä¸€ç§ç‰¹å®šçš„æ ¼å¼å†™å…¥åˆ°ç¼–è¯‘åçš„æ–‡ä»¶ä¸­ã€‚è°ƒè¯•çš„æ—¶å€™ï¼Œè°ƒè¯•å™¨ä¾¿ä»æ–‡ä»¶ä¸­è¯»å–å¹¶è§£æè¿™äº›ä¿¡æ¯ï¼Œä»¥äº§ç”Ÿäººä»¬å¯è¯»æ€§æ¯”è¾ƒå¼ºçš„ä¿¡æ¯ã€‚ç®€å•çš„è¯´ï¼Œè°ƒè¯•ä¿¡æ¯å°±æ˜¯åœ¨æœºå™¨ç å’Œå¯¹åº”çš„æºä»£ç ä¹‹é—´å»ºç«‹ä¸€åº§æ¡¥æ¢ï¼Œå¤§å¤§æ–¹ä¾¿å’Œæé«˜äº†è°ƒè¯•ç¨‹åºçš„èƒ½åŠ›ã€‚
è°ƒè¯•ä¿¡æ¯ä¸€èˆ¬éƒ½æ˜¯æŒ‰ç…§ä»€ä¹ˆæ ·çš„æ ¼å¼å­˜æ”¾çš„å‘¢ï¼Ÿä¸»è¦æœ‰ä¸‹é¢å‡ ç§ï¼šstabsï¼ŒCOFFï¼ŒPE-COFFï¼ŒOMFï¼ŒIEEE-695å’ŒDWARFã€‚å…¶ä¸­DWARFåœ¨Linuxä¸­è¢«æ™®éä½¿ç”¨ï¼Œæˆ‘ä»¬ä¸»è¦åˆ†æå®ƒã€‚
DWARFçš„å…¨ç§°æ˜¯â€Debugging With Attributed Record Formatsâ€ï¼Œéµä»GNU FDLæˆæƒã€‚ç°åœ¨å·²ç»æœ‰dwarf1ï¼Œdwarf2ï¼Œdwarf3ä¸‰ä¸ªç‰ˆæœ¬ã€‚
<!-- more -->
Dwarfæœ€åˆè¢«è´å°”å®éªŒå®¤è®¾è®¡ç”¨æ¥ä¾›Unix System Vçš„sdbè°ƒè¯•å™¨ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨1989å¹´è¢«Unixå›½é™…åŒ–éƒ¨é—¨çš„PLSIG (Programming Languages Special Interest Group)æ ‡å‡†åŒ–æˆä¸ºdwarf1.0ã€‚ä½†æ˜¯dwarf1æœ‰ç€å¾ˆå¤šæ˜æ˜¾çš„ç¼ºç‚¹ï¼Œäºæ˜¯PLSIGç»§ç»­å¼€å‘ï¼Œæ”¹æ­£äº†ç¼ºç‚¹ï¼Œå¹¶åŠ å…¥äº†å¯¹C++ç­‰è¯­è¨€çš„æ”¯æŒï¼Œå¹¶åœ¨1990å¹´æ­£å¼å…¬å¸ƒäº†dwarf2çš„æ ‡å‡†è‰æ¡ˆã€‚ä½†æ˜¯ç¨åç”±äºä¸€äº›åŸå› ï¼ŒPLSIGè¢«è§£æ•£ï¼Œdwarfçš„å¼€å‘é™·å…¥åˆ°å¤šä¸ªå¹¶ä¸åˆä½œçš„ç»„ç»‡ä¸­é—´ï¼Œé€ æˆdwarf2çš„ä¸€äº›å®ç°ç»†èŠ‚è¦å–å†³äºç‰¹å®šçš„ç¼–è¯‘å™¨ã€‚è¿™ç§æƒ…å†µä¸€ç›´æŒç»­åˆ°1999å¹´ï¼Œå¼€å‘å·¥ä½œå—åˆ°äº†æ¥è‡ªå®ç°å¯¹HP/Inter IA-64æ¶æ„æä¾›è¾ƒå¥½æ”¯æŒçš„æ¨åŠ¨ï¼Œæˆç«‹äº†dwarfå§”å‘˜ä¼šï¼Œdwarfçš„åŸä½œè€…æ‹…ä»»è´Ÿè´£äººï¼Œ
å¼€å§‹äº†dwarf3çš„å¼€å‘ï¼Œå¹¶äº2006å¹´1æœˆä»½æ¨å‡ºdwarf3.0ï¼ŒåŒæ—¶ä¸ºäº†è§£å†³åˆ†æ­§ï¼Œdwarfå§”å‘˜ä¼šåŠ å…¥äº†è‡ªç”±æ ‡å‡†ç»„ç»‡ï¼Œåœ¨è‡ªç”±æ ‡å‡†ç»„ç»‡ä¸æ¥è‡ªLinuxåŸºé‡‘ä¼šçš„OSDL(Open Source Development Labs)åˆå¹¶åï¼Œdwarfé‡è¿”ç‹¬ç«‹çŠ¶æ€å¹¶åˆ›å»ºäº†è‡ªå·±çš„ç½‘ç«™ï¼šdwarfstd.orgã€‚
è¿™ä¸‰ä¸ªç‰ˆæœ¬ä¸­ï¼Œdwarf2å¯¹dwarf1çš„æ”¹å˜å¾ˆå¤§ï¼Œdwarf3å¤§å¤šæ˜¯å¯¹dwarf2çš„æ‰©å……ã€‚
ç°åœ¨dwarfå·²ç»æ˜¯ä¸€ç§ç‹¬ç«‹çš„æ ‡å‡†ï¼Œå¯ä»¥æ”¯æŒCã€C++ã€JAVAã€Fortranç­‰è¯­è¨€ã€‚
åœ¨äº†è§£äº†dwarfçš„å†å²ä¹‹åï¼Œæ¥çœ‹ä¸€ä¸‹å¦‚ä½•æŸ¥çœ‹dwarfæ‰€åŒ…å«çš„è°ƒè¯•ä¿¡æ¯å†…å®¹ï¼Œå¹¶åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ä»‹ç»è¿™äº›å†…å®¹çš„å…·ä½“æ„æ€ã€‚æŸ¥çœ‹å†…å®¹çš„å·¥å…·å¸¸ç”¨çš„æœ‰å››ç§ï¼š</p>
<ol>
  <li>readelf
GNUæä¾›çš„äºŒè¿›åˆ¶å·¥å…·ï¼ŒåŠŸèƒ½å¾ˆå¤šï¼Œå¹¶ä¸é™äºè¯»dwarfä¿¡æ¯</li>
  <li>gdb
è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†å§ï¼Œ^_^</li>
  <li>drawfdump
æ˜¯ä¸€ä¸ªè¢«æ‰“åŒ…åœ¨libdwarfå†…çš„ç¨‹åº</li>
  <li>libdwarf
æ˜¯ä¸€ä¸ªå°è£…å¥½çš„Cåº“APIï¼Œç”¨æ¥è¯»å–dwarfä¿¡æ¯
åœ¨è¿™é‡Œæˆ‘ä»¬ä¸»è¦ä½¿ç”¨readelfå·¥å…·ã€‚
å…ˆå†™ä¸€ä¸ªç®€å•çš„Cç¨‹åºï¼Œå¦‚ä¸‹ï¼š
1:<br />
2: int add(int, int);
3:<br />
4: int main()
5: â€¦{
6: int i, j;
7:<br />
8: for(i = 0; i &lt; 100; i += 5, j = i * 5)
9: add(i, j);
10:<br />
11: return 0;
12: }
13:<br />
14: int add(int a, int b)
15: â€¦{
16: return a + b;
17: }
ç„¶åä½¿ç”¨gcc â€“g hello.c â€“o helloç¼–è¯‘ã€‚ç”Ÿæˆhelloæ–‡ä»¶ã€‚
Helloæ–‡ä»¶æ˜¯elfæ ¼å¼çš„ï¼Œelfä¸€èˆ¬ç”±å¤šä¸ªèŠ‚(section)ç»„æˆï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥çœ‹å‰é¢ä¸¤ç¯‡å…³äºelfæ–‡ä»¶æ ¼å¼çš„æ–‡ç« ã€‚è°ƒè¯•ä¿¡æ¯è¢«åŒ…å«åœ¨æŸå‡ ä¸ªèŠ‚ä¸­ï¼Œå¦‚æœæ˜¯ç”¨dwarf2æ ¼å¼ç¼–è¯‘çš„ï¼Œè¿™äº›èŠ‚çš„åå­—ä¸€èˆ¬æ˜¯ä»¥.debugå¼€å¤´ï¼Œå¦‚.debug_infoï¼Œ.debug_lineï¼Œ.debug_frameç­‰ï¼Œå¦‚æœæ˜¯ç”¨dwarf1æ ¼å¼ç¼–è¯‘çš„ï¼Œè¿™äº›èŠ‚çš„åå­—ä¸€èˆ¬æ˜¯.debugï¼Œ.lineç­‰ã€‚ç°åœ¨çš„ç¼–è¯‘å™¨é»˜è®¤å¤§å¤šæ•°æ˜¯dwarf2æ ¼å¼ç¼–è¯‘ï¼Œå½“ç„¶å¯ä»¥é€šè¿‡gccçš„ç¼–è¯‘é€‰é¡¹æ”¹å˜ã€‚
ç°åœ¨æ¥çœ‹helloæ–‡ä»¶éƒ½åŒ…å«äº†å“ªäº›è°ƒè¯•ä¿¡æ¯ã€‚
é¦–å…ˆæ¥çœ‹éƒ½åŒ…å«äº†å“ªäº›è°ƒè¯•èŠ‚ï¼Œä½¿ç”¨readelf â€“S helloå‘½ä»¤ï¼Œäº§ç”Ÿå¦‚ä¸‹è¾“å‡º(å·²åˆ ä¸€äº›æ— å…³å†…å®¹)ï¼š
[Nr] Name Type Addr Off Size</li>
</ol>

<p>[ 0] NULL 00000000 000000 000000</p>

<p>[ 1] .text PROGBITS 00008000 008000 0006c4</p>

<p>[ 2] .ARM.exidx ARM_EXIDX 000086c4 0086c4 000008</p>

<p>[ 3] .data PROGBITS 000086d0 0086d0 000520</p>

<p>[ 4] .bss NOBITS 00008bf0 008bf0 000020</p>

<p>[ 5] .debug_aranges PROGBITS 00000000 008bf0 000020</p>

<p>[ 6] .debug_pubnames PROGBITS 00000000 008c10 000023</p>

<p>[ 7] .debug_info PROGBITS 00000000 008c33 0000cc</p>

<p>[ 8] .debug_abbrev PROGBITS 00000000 008cff 00006b</p>

<p>[ 9] .debug_line PROGBITS 00000000 008d6a 00003e</p>

<p>[10] .debug_frame PROGBITS 00000000 008da8 000188</p>

<p>[11] .debug_loc PROGBITS 00000000 008f30 000054</p>

<p>[12] .ARM.attributes ARM_ATTRIBUTES 00000000 008f84 000010</p>

<p>[13] .comment PROGBITS 00000000 008f94 000032</p>

<p>[14] .shstrtab STRTAB 00000000 008fc6 0000ad</p>

<p>[15] .symtab SYMTAB 00000000 00931c 000780</p>

<p>[16] .strtab STRTAB 00000000 009a9c 000416</p>

<p>å¯è§ä¸€å…±åŒ…å«äº†17ä¸ªèŠ‚ï¼Œå…¶ä¸­7ä¸ªè°ƒè¯•ä¿¡æ¯çš„èŠ‚ã€‚
åœ¨æ¥çœ‹ä¸€ä¸‹å„ä¸ªè°ƒè¯•ä¿¡æ¯èŠ‚åŒ…å«çš„å†…å®¹ï¼Œä½¿ç”¨readelf â€“w* helloå‘½ä»¤ï¼Œ*æ˜¯è°ƒè¯•èŠ‚åçš„ç¬¬ä¸€ä¸ªå­—æ¯ï¼Œå¦‚-wiå°±æ˜¯æŸ¥çœ‹.debug_infoèŠ‚çš„å†…å®¹ï¼Œ-wlå°±æ˜¯æŸ¥çœ‹.debug_lineèŠ‚çš„å†…å®¹ã€‚
å¯¹äºä¸€ä¸ªè°ƒè¯•æ–‡ä»¶ï¼Œ.debug_infoå’Œ.debug_lineèŠ‚æ˜¯å¿…é¡»æœ‰çš„ï¼Œå…¶ä»–çš„ä¸è§å¾—ã€‚åŒæ—¶ä¹Ÿå¯ä»¥è‡ªå·±å†™é“¾æ¥è„šæœ¬å®ç°å¯¹æ‰€æœ‰èŠ‚(ä¸å±€é™äºè°ƒè¯•èŠ‚)çš„æ§åˆ¶ï¼Œå¦‚æŒ‡å®šæ¯ä¸ªèŠ‚çš„åŸºå€ç­‰ã€‚
.debug_infoåŸºæœ¬åŒ…å«äº†ä¸€ä¸ªæºæ–‡ä»¶å†…éƒ¨çš„å¤§éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚å‡½æ•°ã€å‚æ•°ã€å˜é‡ã€ç±»å‹ç­‰ç­‰ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„è¾“å‡ºï¼š
The section .debug_info contains:</p>

<p>Compilation Unit @ offset 0x0:</p>

<p>Length: 200</p>

<p>Version: 2</p>

<p>Abbrev Offset: 0</p>

<p>Pointer Size: 4</p>

<p>&lt;0&gt;<b>: Abbrev Number: 1 (DW_TAG_compile_unit)</b></p>

<p>DW_AT_stmt_list : 0</p>

<p>DW_AT_high_pc : 0x8248</p>

<p>DW_AT_low_pc : 0x81ac</p>

<p>DW_AT_producer : GNU C 4.1.1</p>

<p>DW_AT_language : 1 (ANSI C)</p>

<p>DW_AT_name : hello.c</p>

<p>DW_AT_comp_dir : C:\Program Files\CodeSourcery\Sourcery G++\bin</p>

<p>&lt;1&gt;&lt;5c&gt;: Abbrev Number: 2 (DW_TAG_subprogram)</p>

<p>DW_AT_sibling : &lt;92&gt;</p>

<p>DW_AT_external : 1</p>

<p>DW_AT_name : main</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 5</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_low_pc : 0x81ac</p>

<p>DW_AT_high_pc : 0x8214</p>

<p>DW_AT_frame_base : 0 (location list)</p>

<p>&lt;2&gt;&lt;79&gt;: Abbrev Number: 3 (DW_TAG_variable)</p>

<p>DW_AT_name : i</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 6</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_location : 2 byte block: 91 68 (DW_OP_fbreg: -24)</p>

<p>&lt;2&gt;&lt;85&gt;: Abbrev Number: 3 (DW_TAG_variable)</p>

<p>DW_AT_name : j</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 6</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_location : 2 byte block: 91 6c (DW_OP_fbreg: -20)</p>

<p>&lt;1&gt;&lt;92&gt;: Abbrev Number: 4 (DW_TAG_base_type)</p>

<p>DW_AT_name : int</p>

<p>DW_AT_byte_size : 4</p>

<p>DW_AT_encoding : 5 (signed)</p>

<p>&lt;1&gt;&lt;99&gt;: Abbrev Number: 5 (DW_TAG_subprogram)</p>

<p>DW_AT_external : 1</p>

<p>DW_AT_name : add</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 15</p>

<p>DW_AT_prototyped : 1</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_low_pc : 0x8214</p>

<p>DW_AT_high_pc : 0x8248</p>

<p>DW_AT_frame_base : 0x2a (location list)</p>

<p>&lt;2&gt;<b2>: Abbrev Number: 6 (DW_TAG_formal_parameter)</b2></p>

<p>DW_AT_name : a</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 14</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_location : 2 byte block: 91 6c (DW_OP_fbreg: -20)</p>

<p>&lt;2&gt;<be>: Abbrev Number: 6 (DW_TAG_formal_parameter)</be></p>

<p>DW_AT_name : b</p>

<p>DW_AT_decl_file : 1</p>

<p>DW_AT_decl_line : 14</p>

<p>DW_AT_type : &lt;92&gt;</p>

<p>DW_AT_location : 2 byte block: 91 68 (DW_OP_fbreg: -24)</p>

<p>.debug_lineåŒ…å«äº†æ‰€æœ‰åœ°å€å’Œæºæ–‡ä»¶è¡Œçš„å¯¹åº”ä¿¡æ¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<p>Dump of debug contents of section .debug_line:</p>

<p>Length: 58</p>

<p>DWARF Version: 2</p>

<p>Prologue Length: 30</p>

<p>Minimum Instruction Length: 2</p>

<p>Initial value of â€˜is_stmtâ€™: 1</p>

<p>Line Base: -5</p>

<p>Line Range: 14</p>

<p>Opcode Base: 13</p>

<p>Opcodes:</p>

<p>Opcode 1 has 0 args</p>

<p>Opcode 2 has 1 args</p>

<p>Opcode 3 has 1 args</p>

<p>Opcode 4 has 1 args</p>

<p>Opcode 5 has 1 args</p>

<p>Opcode 6 has 0 args</p>

<p>Opcode 7 has 0 args</p>

<p>Opcode 8 has 0 args</p>

<p>Opcode 9 has 1 args</p>

<p>Opcode 10 has 0 args</p>

<p>Opcode 11 has 0 args</p>

<p>Opcode 12 has 1 args</p>

<p>The Directory Table is empty.</p>

<p>The File Name Table:</p>

<p>Entry Dir Time Size Name</p>

<p>1 0 0 0 hello.c</p>

<p>Line Number Statements:</p>

<p>Extended opcode 2: set Address to 0x81ac</p>

<p>Special opcode 9: advance Address by 0 to 0x81ac and Line by 4 to 5</p>

<p>Special opcode 120: advance Address by 16 to 0x81bc and Line by 3 to 8</p>

<p>Special opcode 90: advance Address by 12 to 0x81c8 and Line by 1 to 9</p>

<p>Special opcode 88: advance Address by 12 to 0x81d4 and Line by -1 to 8</p>

<p>Advance PC by constant 34 to 0x81f6</p>

<p>Special opcode 78: advance Address by 10 to 0x8200 and Line by 3 to 11</p>

<p>Special opcode 34: advance Address by 4 to 0x8204 and Line by 1 to 12</p>

<p>Special opcode 120: advance Address by 16 to 0x8214 and Line by 3 to 15</p>

<p>Special opcode 174: advance Address by 24 to 0x822c and Line by 1 to 16</p>

<p>Special opcode 90: advance Address by 12 to 0x8238 and Line by 1 to 17</p>

<p>Advance PC by 16 to 0x8248</p>

<p>Extended opcode 1: End of Sequence</p>

<p>å¯ä»¥çœ‹åˆ°.debug_*éƒ½æ˜¯è°ƒè¯•ä¿¡æ¯çš„sectionï¼Œæ¯ä¸ªsectionä»£è¡¨ä¸åŒç±»å‹çš„è°ƒè¯•ä¿¡æ¯ï¼Œ
  ection</p>

<p>è¯´æ˜</p>

<p>.debug_info</p>

<p>è°ƒè¯•ä¿¡æ¯ä¸»è¦å†…å®¹ï¼Œå„ä¸ªDIE</p>

<p>.debug_abbrev</p>

<p>è°ƒè¯•ä¿¡æ¯ç¼©å†™è¡¨ï¼Œæ¯ä¸ªç¼–è¯‘å•å…ƒå¯¹åº”ä¸€ä¸ªç¼©å†™è¡¨ï¼Œæ¯ä¸ªç¼©å†™è¡¨åŒ…å«ä¸€ç³»åˆ—çš„ç¼©å†™å£°æ˜ï¼Œæ¯ä¸ªç¼©å†™å¯¹åº”ä¸€ä¸ªDIE</p>

<p>.debug_line</p>

<p>è¡Œå·ä¿¡æ¯</p>

<p>.debug_macinfo</p>

<p>å®ä¿¡æ¯ï¼Œç¼–è¯‘å™¨-g3å‚æ•°æ‰ä¼šäº§ç”Ÿå®ä¿¡æ¯</p>

<p>.debug_aranges</p>

<p>èŒƒå›´è¡¨ï¼Œæ¯ä¸ªç¼–è¯‘å•å…ƒå¯¹åº”ä¸€ä¸ªèŒƒå›´èŒƒå›´è¡¨ï¼Œè®°å½•äº†è¯¥ç¼–è¯‘å•å…ƒçš„æŸäº›ENTRYçš„textæˆ–è€…dataçš„èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œç”¨äºè·¨ç¼–è¯‘å•å…ƒçš„å¿«é€ŸæŸ¥è¯¢</p>

<p>.debug_pubnames</p>

<p>å…¨å±€ç¬¦å·æŸ¥è¯¢è¡¨ï¼Œä»¥ç¼–è¯‘å•å…ƒä¸ºå•ä½ï¼Œè®°å½•äº†æ¯ä¸ªç¼–è¯‘å•å…ƒçš„å…¨å±€ç¬¦å·çš„åç§°</p>

<p>.debug_frame</p>

<p>å‡½æ•°çš„å †æ ˆä¿¡æ¯</p>

<p>.debug_str</p>

<p>.debug_infoä¸­ä½¿ç”¨åˆ°çš„å­—ç¬¦ä¸²è¡¨</p>

<p>.debug_loc</p>

<p>Location list</p>

<p>3      Gdbä½¿ç”¨è°ƒè¯•ä¿¡æ¯
Gdbä¸­å®ç°æºç çº§åˆ«è°ƒè¯•ï¼Œä¸»è¦å®ç°åç§°ã€ä½ç½®çš„æ˜ å°„ã€‚è€Œè¿™äº›ä¿¡æ¯åœ¨gdbå†…éƒ¨é€šè¿‡symbolæ¥è®°å½•çš„ã€‚SymbolsæŒ‰ç…§ä¸€å®šçš„å…³ç³»ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆsymbol tableã€‚åœ¨gdbä¸­æœ‰ä¸‰ç±»ç¬¦å·è¡¨ã€‚</p>

<p>è¡¨æ ¼3â€‘1 gdbä¸­çš„ç¬¦å·è¡¨</p>

<p>ç¬¦å·è¡¨</p>

<p>è¯´æ˜</p>

<p>Minimal_symbol table</p>

<p>è¯¥ç¬¦å·è¡¨é€šè¿‡åˆ†æelfæ–‡ä»¶ä¸­çš„.symtab sectionå¾—æ¥ï¼Œè¯¥sectionä¸­è®°å½•çš„æ˜¯åœ¨elfæ–‡ä»¶çš„é“¾æ¥è¿‡ç¨‹ä¸­æ‰€å¿…é¡»çš„ä¸€äº›å…¨å±€çš„ç¬¦å·ã€‚è¯¥ç¬¦å·è¡¨åœ¨æ²¡æœ‰-gå‚æ•°çš„æ—¶å€™ä¹Ÿä¼šæœ‰ã€‚</p>

<p>Partial symboltable</p>

<p>é¡¾åæ€ä¹‰ï¼Œéƒ¨åˆ†ç¬¦å·è¡¨ï¼Œé‡Œé¢è®°å½•çš„æ˜¯éƒ¨åˆ†çš„ç¬¦å·çš„éƒ¨åˆ†çš„ä¿¡æ¯ï¼Œåœ¨gdbè¯»å…¥symbol fileçš„æ—¶å€™ä¼šåˆæ­¥åˆ†æè°ƒè¯•ä¿¡æ¯ï¼Œå»ºç«‹è¿™ä¹ˆä¸€å¼ partial symbol tableï¼Œå®ƒæœ‰ä¸¤ä¸ªä½œç”¨ï¼š1ï¼Œæ»¡è¶³ä¸€éƒ¨åˆ†çš„è°ƒè¯•éœ€æ±‚ï¼›2ï¼Œgdbå¯ä»¥æ ¹æ®partial symtabè¯»å…¥full  symtabã€‚</p>

<p>Full symbol table</p>

<p>å®Œæ•´ç¬¦å·è¡¨ï¼Œé‡Œé¢è®°å½•çš„æ˜¯å®Œæ•´çš„ç¬¦å·ä¿¡æ¯ï¼Œæºç çº§åˆ«è°ƒè¯•å®ç°çš„åŸºç¡€ã€‚ç”±äºå…¶ä¿¡æ¯å¾ˆå¤šï¼Œå çš„å†…å­˜ç©ºé—´å¾ˆå¤§ï¼Œæ‰€ä»¥gdbåœ¨ä¸€å¼€å§‹è¯»å…¥symbol fileçš„æ—¶å€™å¹¶ä¸ä¼šäº§ç”Ÿè¿™ä¹ˆä¸€ä¸ªfull symtabï¼Œè€Œæ˜¯åœ¨åç»­çš„è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰éœ€è¦å®Œæ•´ç¬¦å·è¡¨çš„åœ°æ–¹ï¼Œæ‰ä¼šæŠŠè¯¥cuçš„full symtabè¯»å…¥ï¼Œè¿™æ ·æ•ˆç‡è¾ƒé«˜ã€‚</p>

<p>Gdbè°ƒè¯•ä¸»è¦ä¾é è¿™ä¸‰ä¸ªç¬¦å·è¡¨å®ç°ï¼Œminimal symtabæ¯”è¾ƒç®€å•ï¼Œä¹Ÿä¸å±äºè°ƒè¯•ä¿¡æ¯åˆ†æçš„èŒƒç•´ï¼Œæœ¬æ–‡ä¸ä¼šå¯¹minimal symtabå¤šåŠ å™è¿°ã€‚Partial symtabå’Œfull symtabçš„å»ºç«‹æ˜¯æ ¹æ®è°ƒè¯•ä¿¡æ¯å®Œæˆçš„ã€‚ä¸‹é¢gdbå¯¹è°ƒè¯•ä¿¡æ¯çš„ä½¿ç”¨è¿‡ç¨‹ä¹Ÿæ˜¯è¿™ä¹ˆä¸¤å¼ ç¬¦å·è¡¨çš„å»ºç«‹çš„è¿‡ç¨‹ã€‚</p>

<p>3.1    Debug_infoâ€”â€”PartialSymtab
3.1.1     Partial symtabç®€ä»‹
åœ¨å±•å¼€partial symbolç›¸å…³çš„è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹partialsymbolæ˜¯ä»€ä¹ˆã€‚</p>

<p>åœ¨gdbä¸­ä½¿ç”¨structpartial_symbolï¼Œæ¥æè¿°ä¸€ä¸ªpartial symbolï¼Œå…¶ä¸­åŒ…å«çš„ä¿¡æ¯å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>

<p>è¡¨æ ¼3â€‘2 struct partial_symbol</p>

<p>æ•°æ®é¡¹</p>

<p>è¯´æ˜</p>

<p>Domain</p>

<p>è¯¥symbolçš„ç±»å‹ï¼šå˜é‡ã€å‡½æ•°ã€typeã€labelç­‰ã€‚</p>

<p>Address_class</p>

<p>è¯´æ˜è¯¥ç¬¦å·çš„åœ°å€ç±»å‹ï¼Œå³åœ¨ä»€ä¹ˆåœ°æ–¹å¯ä»¥æ‰¾åˆ°è¯¥ç¬¦å·ï¼šå¯„å­˜å™¨ã€arglistã€localå˜é‡ã€typedefç±»å‹ç­‰ã€‚</p>

<p>Struct general_symbol_info</p>

<p>æ‰€æœ‰ç±»å‹ç¬¦å·çš„åŸºç¡€ä¿¡æ¯ï¼šnameã€valueï¼ˆæ˜¯ä¸ªunionï¼Œå–å†³äºç¬¦å·çš„ç±»å‹ï¼‰ã€åœ¨å“ªä¸ªsectionç­‰ã€‚</p>

<p>Partial symbolä»¥ä¸€å®šçš„è§„åˆ™ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆpartial symtabï¼Œgdbä¸­ä»¥source fileä¸ºå•ä½ï¼Œæ¯ä¸ªsource fileå¯¹åº”ä¸€ä¸ªstruct partial_symtabï¼Œä¸€ä¸ªobjfileä¸­çš„æ‰€æœ‰çš„partial_symtabç»„æˆä¸€ä¸ªé“¾è¡¨ã€‚Partial symtabä¸­åªè®°å½•è¯¥fileä¸­staticç±»å‹çš„å’Œglobalç±»å‹çš„ä¸€äº›ç¬¦å·ã€‚Struct partial_symtabçš„åŒ…å«çš„ä¿¡æ¯å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>

<p>è¡¨æ ¼3â€‘3 struct  partial_symtab</p>

<p>æ•°æ®é¡¹</p>

<p>è¯´æ˜</p>

<p>Struct partial_symtab *next</p>

<p>Objfileçš„æ‰€æœ‰partial_symtabå½¢æˆä¸€ä¸ªé“¾è¡¨</p>

<p>Filenameã€fullnameã€dirname</p>

<p>æ–‡ä»¶åã€è·¯å¾„ç­‰ä¿¡æ¯</p>

<p>Struct objfile *objfile</p>

<p>å¯¹åº”æ˜¯å“ªä¸ªobjfile</p>

<p>Struct section_offsets</p>

<p>Objfileçš„å„ä¸ªsectionçš„offset</p>

<p>Textlowã€ texthigh</p>

<p>è¯¥fileçš„åœ°å€èŒƒå›´</p>

<p>Struct partial_symtab **dependencies</p>

<p>è¯¥fileä¾èµ–çš„æ–‡ä»¶ã€‚ä¾èµ–çš„æ„æ€æ˜¯åœ¨è¯»å…¥æœ¬fileçš„symbolä¹‹å‰ï¼Œè¦å…ˆå°†dependencyçš„symbolå…ˆè¯»å…¥ã€‚æ¯”å¦‚hello.cä¸­include hello.hï¼Œé‚£ä¹ˆhello.hçš„dependencyæ˜¯hello.cï¼Œä¸€ä¸ªæ–‡ä»¶å¯èƒ½æœ‰å¾ˆå¤šdependencyã€‚</p>

<p>Int global_offsetï¼Œ int n_gloabl_syms</p>

<p>è¯¥æ–‡ä»¶å¯¹åº”çš„å…¨å±€ç¬¦å·åœ¨objfile-&gt;global_psymbolsä¸­çš„åç§»å’Œä¸ªæ•°</p>

<p>Int static_offst, int  n_static_syms</p>

<p>åŒä¸Šï¼Œä¸è¿‡æ˜¯objfile-&gt;static_psymbols</p>

<p>Struct symtab *symtab</p>

<p>è¯¥fileå¯¹åº”çš„full symtab</p>

<p>Void(*read_symtab)ï¼ˆstruct partial_symtab *ï¼‰</p>

<p>è¯¥å‡½æ•°æŒ‡é’ˆç”¨æ¥æ ¹æ®è¯¥pstè¯»å–full symtab</p>

<p>Void *read_symtab_private</p>

<p>ä¸Šè¿°å‡½æ•°å»ºç«‹full symtabéœ€è¦ç”¨åˆ°çš„ä¸€äº›æ•°æ®</p>

<p>Unsigned char readin</p>

<p>æ ‡è¯†è¯¥pstå¯¹åº”çš„symtabæœ‰æ²¡æœ‰è¢«è¯»å…¥</p>

<p>3.1.2     Partial_symtabå»ºç«‹æµç¨‹
              æœ¬èŠ‚ä»‹ç»è¯»å–è°ƒè¯•ä¿¡æ¯ï¼Œå»ºç«‹partialsymtabçš„æµç¨‹ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          gdbå°±å¯ä»¥æ ¹æ®æ­¤ä½¿ç”¨ä¸€äº›file_staticå’Œglobalçš„ç¬¦å·ï¼Œè¿›è¡Œä¸€äº›åŸºæœ¬çš„æºç çº§åˆ«çš„è°ƒè¯•äº†ã€‚
</code></pre></div></div>

<p>è¯¥è¿‡ç¨‹åœ¨gdbå°†symbol fileæ·»åŠ è¿›æ¥çš„æ—¶å€™è¿›è¡Œã€‚ä¸åŒçš„objfileæ ¼å¼ï¼Œå®ç°çš„å‡½æ•°ä¸ä¸€æ ·ã€‚é’ˆå¯¹Elfæ–‡ä»¶ï¼Œå…·ä½“è°ƒç”¨å‡½æ•°elf_symfile_read()å‡½æ•°å®Œæˆã€‚è¯¥å‡½æ•°ä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š1ï¼Œè¯»å–objfileä¸­.symtabã€.dynsym(å¦‚æœæœ‰çš„è¯)çš„ç¬¦å·ï¼Œå»ºç«‹èµ·minimal symtabï¼›2ï¼Œè¯»å–åˆ†æè°ƒè¯•ä¿¡æ¯ï¼Œå»ºç«‹partial symtabã€‚</p>

<p>è§£å†³å› Dwarfç‰ˆæœ¬ä¸åŒ¹é…ï¼Œé€ æˆgdbæ— æ³•åŠ è½½è°ƒè¯•ä¿¡æ¯é”™è¯¯
å½“ç¨‹åºè·‘é£æ‰çš„æ—¶å€™ï¼Œå¦‚æœèƒ½ä»¤å…¶ç”Ÿæˆcoreæ–‡ä»¶é‚£è¯¥å¤šå¥½ã€‚ä½†å¦‚æœç”¨gdbè°ƒè¯•coreæ—¶ï¼Œæ²¡æœ‰è°ƒè¯•ä¿¡æ¯å‘¢ï¼ˆæ­¤å¤„è¯´çš„æ˜¯ï¼Œç¼–è¯‘æ—¶åŠ äº†-gé€‰é¡¹,æ²¡æœ‰ä½¿ç”¨-O0ä»¥ä¸Šçš„ç¼–è¯‘ä¼˜åŒ–ï¼Œä¹Ÿæ²¡æœ‰å¯¹å¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œstripå»æ‰ç¬¦å·ä¿¡æ¯ï¼‰ï¼Ÿ</p>

<p>warning: Canâ€™t read pathname for load map: Input/output error.
Reading symbols from /usr/local/lib/xxx.so.2â€¦Error while reading shared library symbols:
Dwarf Error: wrong version in compilation unit header (is 4, should be 2) [in module /usr/local/lib/xxx.so.2]
Reading symbols from /usr/lib64/libdl.so.2â€¦done.
Loaded symbols for /usr/lib64/libdl.so.2
Reading symbols from /usr/lib64/libstdc++.so.6â€¦done.
Loaded symbols for /usr/lib64/libstdc++.so.6
Reading symbols from /usr/lib64/libm.so.6â€¦BFD: /usr/lib64/libm.so.6: invalid relocation type 37
BFD: BFD (GNU Binutils) 2.18.50.20080226 assertion fail elf64-x86-64.c:278
BFD: /usr/lib64/libm.so.6: invalid relocation type 37
BFD: BFD (GNU Binutils) 2.18.50.20080226 assertion fail elf64-x86-64.c:278
BFD: /usr/lib64/libm.so.6: invalid relocation type 37
â€¦</p>

<p>ç”±æç¤ºä¿¡æ¯å¯çŸ¥ï¼Œå› ä¸ºgdbä½¿ç”¨çš„Dwarfæ˜¯2,è€Œgcc/g++ä½¿ç”¨çš„Dwarfæ˜¯4,ç‰ˆæœ¬ä¸åŒ¹é…ï¼Œé€ æˆè°ƒè¯•ç¬¦å·ä¿¡æ¯æ— æ³•åŠ è½½ã€‚æœ€åï¼ŒæŸ¥äº†ä¸€ä¸‹æˆ‘çš„gdbæ˜¯6.8.0çš„ç‰ˆæœ¬ï¼Œè€Œgcc/g++ æ˜¯4.8.2çš„ç‰ˆæœ¬ã€‚å‘ç°ä»gcc/g++ 4.5`ç‰ˆæœ¬å¼€å§‹ä¾èµ–å¾ˆå¤šDwarf 3å’ŒDwarf 4çš„ç‰¹æ€§ï¼Œä½†å‡çº§GCCæ—¶ï¼Œæ²¡æœ‰å‡çº§gdbæ‰€è‡´ã€‚å…·ä½“è§£å†³æ–¹æ¡ˆæœ‰ï¼š</p>

<p>ç¬¬ä¸€ç§ï¼š å‡çº§gdb</p>

<p>ç¬¬äºŒç§ï¼š è®©gcc/g++ç”Ÿå­˜Dwarf2ç‰ˆæœ¬çš„è°ƒè¯•ä¿¡æ¯ï¼š å¢åŠ gcc/g++ç¼–è¯‘é€‰é¡¹ -gdwarf-2 -gstrict-dwarf</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œç¼–è¯‘è¿‡çš„äºŒè¿›åˆ¶æ–‡ä»¶å·²ç»åŒ…å«äº† DWARFv3 è°ƒè¯•ä¿¡æ¯ï¼Œåªè¦ GDB7.1 ä»¥ä¸Šç‰ˆæœ¬éƒ½å¯ä»¥è¿›è¡Œè°ƒè¯•ã€‚ åœ¨OSXä¸‹ï¼Œå¦‚æ— æ³•æ‰§è¡Œè°ƒè¯•æŒ‡ä»¤ï¼Œå¯å°è¯•ç”¨sudoæ–¹å¼æ‰§è¡Œgdbã€‚</p>

<p>åˆ é™¤è°ƒè¯•ç¬¦å·ï¼šgo build -ldflags â€œ-s -wâ€</p>

<p>-s: å»æ‰ç¬¦å·ä¿¡æ¯ã€‚
-w: å»æ‰DWARFè°ƒè¯•ä¿¡æ¯ã€‚
å…³é—­å†…è”ä¼˜åŒ–ï¼šgo build -gcflags â€œ-N -lâ€</p>

<p>è°ƒè¯•ç›¸å…³å‡½æ•°ï¼š</p>

<p>runtime.Breakpoint()ï¼šè§¦å‘è°ƒè¯•å™¨æ–­ç‚¹ã€‚
runtime/debug.PrintStack()ï¼šæ˜¾ç¤ºè°ƒè¯•å †æ ˆã€‚
logï¼šé€‚åˆæ›¿ä»£ printæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ã€‚
GDB è°ƒè¯•æ”¯æŒï¼š</p>

<p>å‚æ•°è½½å…¥ï¼šgdb -d $GCROOT ã€‚
æ‰‹å·¥è½½å…¥ï¼šsource pkg/runtime/runtime-gdb.pyã€‚
æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è€ƒ: http://golang.org/doc/gdb</p>

<p>https://www.php.cn/manual/view/35171.html
import â€œdebug/dwarfâ€
Package dwarf æä¾›å¯¹ä»å¯æ‰§è¡Œæ–‡ä»¶åŠ è½½çš„ DWARFè°ƒè¯•ä¿¡æ¯çš„è®¿é—®ï¼Œè¿™äº›ä¿¡æ¯åœ¨ DWARF 2.0 æ ‡å‡†ä¸­å®šä¹‰ï¼Œhttp://dwarfstd.org/doc/dwarf-2.0.0.pdf</p>

<p>import â€œdebug/elfâ€
å°è£… ELF å®ç°äº†å¯¹ ELF å¯¹è±¡æ–‡ä»¶çš„è®¿é—®ã€‚</p>

<p>import â€œdebug/gosymâ€</p>

<p>gosym åŒ…å¯ä»¥è®¿é—®ç”± gc ç¼–è¯‘å™¨ç”Ÿæˆçš„ Go äºŒè¿›åˆ¶æ–‡ä»¶ä¸­åµŒå…¥çš„ Go ç¬¦å·å’Œè¡Œå·è¡¨ã€‚</p>

<p>import â€œdebug/peâ€
Package peå®ç°å¯¹ PEï¼ˆMicrosoft Windows Portable Executableï¼‰æ–‡ä»¶çš„è®¿é—®ã€‚</p>

<p>import â€œdebug/gosymâ€
gosym åŒ…å¯ä»¥è®¿é—®ç”± gc ç¼–è¯‘å™¨ç”Ÿæˆçš„ Go äºŒè¿›åˆ¶æ–‡ä»¶ä¸­åµŒå…¥çš„ Go ç¬¦å·å’Œè¡Œå·è¡¨ã€‚</p>

<p>import â€œdebug/plan9objâ€
Package plan9obj å®ç°å¯¹ Plan 9 a.out ç›®æ ‡æ–‡ä»¶çš„è®¿é—®ã€‚</p>
:ET