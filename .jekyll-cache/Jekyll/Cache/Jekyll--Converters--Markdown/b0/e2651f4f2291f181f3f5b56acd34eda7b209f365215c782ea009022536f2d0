I"ø&<p>å½“goè¯­è¨€å¼€å‘çš„serveråº”ç”¨å·²ç»åœ¨è¿è¡Œæ—¶ï¼Œå¦‚æœæ›´æ–°äº†ä»£ç ï¼Œç›´æ¥ç¼–è¯‘å¹¶è¿è¡Œï¼Œé‚£ä¹ˆä¸å¥½æ„æ€ï¼Œç«¯å£å·²ç»åœ¨ä½¿ç”¨ä¸­ï¼š</p>

<p>listen tcp :8000: bind: address already in use</p>

<p>çœ‹åˆ°è¿™æ ·çš„é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬é€šå¸¸éƒ½æ˜¯ä¸€é€šä¸‹æ„è¯†çš„æ“ä½œï¼š</p>

<p>lsof -i:8000
kill -9 â€¦</p>

<p>è¿™æ ·åšç«¯å£è¢«å ç”¨çš„é—®é¢˜æ˜¯è§£å†³äº†ï¼Œgoç¨‹åºä¹ŸæˆåŠŸæ›´æ–°äº†ã€‚ä½†æ˜¯è¿™é‡Œé¢è¿˜éšè—ç€ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<p>killç¨‹åºæ—¶å¯èƒ½æŠŠæ­£åœ¨å¤„ç†çš„ç”¨æˆ·è¯·æ±‚ç»™ä¸­æ–­äº†
ä»killåˆ°é‡æ–°è¿è¡Œç¨‹åºè¿™æ®µæ—¶é—´é‡Œæ²¡æœ‰åº”ç”¨åœ¨å¤„ç†ç”¨æˆ·è¯·æ±‚
å…³äºå¦‚ä½•è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œç½‘ä¸Šæœ‰å¤šç§è§£å†³æ–¹æ¡ˆï¼Œä»Šå¤©æˆ‘ä»¬è°ˆè°ˆendlessçš„è§£å†³æ–¹æ¡ˆã€‚
endless
endlessçš„githubåœ°å€ä¸ºï¼šhttps://github.com/fvbock/endless
å¥¹çš„è§£å†³æ–¹æ¡ˆæ˜¯forkä¸€ä¸ªè¿›ç¨‹è¿è¡Œæ–°ç¼–è¯‘çš„åº”ç”¨ï¼Œè¯¥å­è¿›ç¨‹æ¥æ”¶ä»çˆ¶è¿›ç¨‹ä¼ æ¥çš„ç›¸å…³æ–‡ä»¶æè¿°ç¬¦ï¼Œç›´æ¥å¤ç”¨socketï¼ŒåŒæ—¶çˆ¶è¿›ç¨‹å…³é—­socketã€‚çˆ¶è¿›ç¨‹ç•™åœ¨åå°å¤„ç†æœªå¤„ç†å®Œçš„ç”¨æˆ·è¯·æ±‚ï¼Œè¿™æ ·ä¸€æ¥é—®é¢˜1è§£å†³äº†ã€‚ä¸”å¤ç”¨soketä¹Ÿç›´æ¥è§£å†³äº†é—®é¢˜2ï¼Œå®ç°0åˆ‡æ¢æ—¶é—´å·®ã€‚å¤ç”¨socketå¯ä»¥è¯´æ˜¯endlessæ–¹æ¡ˆçš„æ ¸å¿ƒã€‚
<!-- more -->
endlesså¯ä»¥å¾ˆæ–¹ä¾¿çš„æ¥å…¥å·²ç»å†™å¥½çš„ç¨‹åºï¼Œå¯¹äºåŸç”Ÿapiï¼Œç›´æ¥æ›¿æ¢ListenAndServeä¸ºendlessçš„æ–¹æ³•ï¼Œå¦‚ä¸‹ã€‚å¹¶åœ¨ç¼–è¯‘å®Œæ–°çš„ç¨‹åºåï¼Œæ‰§è¡Œkill -1 æ—§è¿›ç¨‹idï¼Œæ—§è¿›ç¨‹ä¾¿ä¼šforkä¸€ä¸ªè¿›ç¨‹è¿è¡Œæ–°ç¼–è¯‘çš„ç¨‹åºã€‚æ³¨ï¼šæ­¤å¤„éœ€è¦ä¿è¯æ–°ç¼–è¯‘çš„ç¨‹åºçš„è·¯å¾„å’Œç¨‹åºåå’Œæ—§ç¨‹åºçš„ä¸€è‡´ã€‚</p>

<p>func handler(w http.ResponseWriter, r *http.Request) {
	w.Write([]byte(â€œWORLD!â€))
}</p>

<p>func main() {
	mux1 := mux.NewRouter()
	mux1.HandleFunc(â€œ/helloâ€, handler).
		Methods(â€œGETâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>err := endless.ListenAndServe("localhost:4242", mux1)
if err != nil {
	log.Println(err)
}
log.Println("Server on 4242 stopped")

os.Exit(0) } å¯¹äºä½¿ç”¨ginæ¡†æ¶çš„ç¨‹åºï¼Œå¯ä»¥ä»¥ä¸‹é¢çš„æ–¹å¼æ¥å…¥ï¼š

r := gin.New()
r.GET("/", func(c *gin.Context) {
	c.String(200, config.Config.Server.AppId)
})
s := endless.NewServer(":8080", r)
err := s.ListenAndServe()
if err != nil {
	log.Printf("server err: %v", err)
} åŸç† å…¶ä½¿ç”¨éå¸¸ç®€å•ï¼Œå®ç°ä»£ç ä¹Ÿå¾ˆå°‘ï¼Œä½†æ˜¯å¾ˆå¼ºå¤§ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹å¥¹çš„å®ç°ï¼š
</code></pre></div></div>

<p>kill -1
endlessçš„ä½¿ç”¨æ–¹æ³•æ˜¯å…ˆç¼–è¯‘æ–°ç¨‹åºï¼Œå¹¶æ‰§è¡Œâ€kill -1 æ—§è¿›ç¨‹idâ€ï¼Œæˆ‘ä»¬çœ‹çœ‹æ—§ç¨‹åºæ¥æ”¶åˆ°-1ä¿¡å·ä¹‹åä½œäº†ä»€ä¹ˆï¼š
func (srv *endlessServer) handleSignals() {
	â€¦
	for {
		sig = &lt;-srv.sigChan
		srv.signalHooks(PRE_SIGNAL, sig)
		switch sig {
		case syscall.SIGHUP:	//æ¥æ”¶åˆ°-1ä¿¡å·ä¹‹åï¼Œforkä¸€ä¸ªè¿›ç¨‹ï¼Œå¹¶è¿è¡Œæ–°ç¼–è¯‘çš„ç¨‹åº
			log.Println(pid, â€œReceived SIGHUP. forking.â€)
			err := srv.fork()
			if err != nil {
				log.Println(â€œFork err:â€, err)
			}
		â€¦
		default:
			log.Printf(â€œReceived %v: nothing i care aboutâ€¦\nâ€, sig)
		}
		srv.signalHooks(POST_SIGNAL, sig)
	}
}</p>

<p>func (srv *endlessServer) fork() (err error) {
	â€¦
	path := os.Args[0]	//è·å–å½“å‰ç¨‹åºçš„è·¯å¾„ï¼Œåœ¨å­è¿›ç¨‹æ‰§è¡Œã€‚æ‰€ä»¥è¦ä¿è¯æ–°ç¼–è¯‘çš„ç¨‹åºè·¯å¾„å’Œæ—§ç¨‹åºçš„ä¸€è‡´ã€‚
	var args []string
	if len(os.Args) &gt; 1 {
		args = os.Args[1:]
	}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cmd := exec.Command(path, args...)
cmd.Stdout = os.Stdout
cmd.Stderr = os.Stderr
cmd.ExtraFiles = files	//socketåœ¨æ­¤å¤„ä¼ ç»™å­è¿›ç¨‹ï¼Œwindowsç³»ç»Ÿä¸æ”¯æŒè·å–socketæ–‡ä»¶ï¼Œæ‰€ä»¥endlessæ— æ³•åœ¨windowsä¸Šç”¨ã€‚windowsè·å–socketæ–‡ä»¶æ—¶æŠ¥é”™ï¼šfile tcp [::]:9999: not supported by windowsã€‚
cmd.Env = env	//envæœ‰ä¸€ä¸ªENDLESS_SOCKET_ORDERå˜é‡å­˜å‚¨äº†socketä¼ é€’çš„é¡ºåºï¼ˆå¦‚æœæœ‰å¤šä¸ªsocketï¼‰
...

err = cmd.Start()	//è¿è¡Œæ–°ç¨‹åº
if err != nil {
	log.Fatalf("Restart: Failed to launch, error: %v", err)
}

return } æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ç¨‹åºå¯åŠ¨ä¹‹ååšäº†ä»€ä¹ˆã€‚ ListenAndServe æ–°è¿›ç¨‹å¯åŠ¨ä¹‹åä¼šæ‰§è¡ŒListenAndServeè¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦åšäº†ç³»ç»Ÿä¿¡å·ç›‘å¬ï¼Œå¹¶ä¸”åˆ¤æ–­è‡ªå·±æ‰€åœ¨è¿›ç¨‹æ˜¯å¦æ˜¯å­è¿›ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å‘é€ä¸­æ–­ä¿¡å·ç»™çˆ¶è¿›ç¨‹ï¼Œè®©å…¶é€€å‡ºã€‚æœ€åè°ƒç”¨Serveæ–¹æ³•ç»™socketæä¾›æ–°çš„æœåŠ¡ã€‚
</code></pre></div></div>

<p>func (srv *endlessServer) ListenAndServe() (err error) {
    â€¦
	go srv.handleSignals()
	l, err := srv.getListener(addr)
	if err != nil {
		log.Println(err)
		return
	}
	srv.EndlessListener = newEndlessListener(l, srv)
	if srv.isChild {
		syscall.Kill(syscall.Getppid(), syscall.SIGTERM)		//ç»™çˆ¶è¿›ç¨‹å‘å‡ºä¸­æ–­ä¿¡å·
	}
	â€¦
	return srv.Serve()	//ä¸ºsocketæä¾›æ–°çš„æœåŠ¡
}
å¤ç”¨socket
å‰é¢æåˆ°å¤ç”¨socketæ˜¯endlessçš„æ ¸å¿ƒï¼Œå¿…é¡»åœ¨Serveå‰å‡†å¤‡å¥½ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç«¯å£å·²ä½¿ç”¨çš„å¼‚å¸¸ã€‚å¤ç”¨socketçš„å®ç°åœ¨ä¸Šé¢çš„getListeneræ–¹æ³•ä¸­ï¼š</p>

<p>func (srv *endlessServer) getListener(laddr string) (l net.Listener, err error) {
	if srv.isChild {//å¦‚æœæ­¤æ–¹æ³•è¿è¡Œåœ¨å­è¿›ç¨‹ä¸­ï¼Œåˆ™å¤ç”¨socket
		var ptrOffset uint = 0
		runningServerReg.RLock()
		defer runningServerReg.RUnlock()
		if len(socketPtrOffsetMap) &gt; 0 {
			ptrOffset = socketPtrOffsetMap[laddr]//è·å–å’Œaddrç›¸å¯¹åº”çš„socketçš„ä½ç½®
		}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	f := os.NewFile(uintptr(3+ptrOffset), "")//åˆ›å»ºsocketæ–‡ä»¶æè¿°ç¬¦
	l, err = net.FileListener(f)//åˆ›å»ºsocketæ–‡ä»¶ç›‘å¬å™¨
	if err != nil {
		err = fmt.Errorf("net.FileListener error: %v", err)
		return
	}
} else {//å¦‚æœæ­¤æ–¹æ³•ä¸æ˜¯è¿è¡Œåœ¨å­è¿›ç¨‹ä¸­ï¼Œåˆ™æ–°å»ºä¸€ä¸ªsocket
	l, err = net.Listen("tcp", laddr)
	if err != nil {
		err = fmt.Errorf("net.Listen error: %v", err)
		return
	}
}
return ä½†æ˜¯çˆ¶è¿›ç¨‹å…³é—­socketå’Œå­è¿›ç¨‹ç»‘å®šsocketå¹¶ä¸å¯èƒ½åŒæ—¶è¿›è¡Œï¼Œå¦‚æœè¿™æ®µæ—¶é—´æœ‰è¯·æ±‚è¿›æ¥ï¼Œè¿™ä¸ªè¯·æ±‚ä¼šåˆ°å“ªé‡Œå»å‘¢ï¼Ÿå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘åšäº†ä¸ªå®éªŒï¼Œå®éªŒä»£ç å¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>func main() {
	isChild := os.Getenv(â€œchildâ€) != â€œâ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http.HandleFunc("/", func(writer http.ResponseWriter, request *http.Request) {
	writer.Write([]byte(fmt.Sprintf("hello world from child?  %v", isChild)))
})

var ln net.Listener
var err error

if isChild {
	f := os.NewFile(uintptr(3+0), "")//ç”±äºåªä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œæ‰€ä»¥æ­¤å¤„ç›´æ¥ä¸º3
	ln, err = net.FileListener(f)
} else {
	ln, err = net.Listen("tcp", ":9999")
}
if err != nil {
	fmt.Println("listener create", err)
	os.Exit(1)
}

go func() {
	c := make(chan os.Signal)
	signal.Notify(c, os.Interrupt)
	&lt;-c

	path := os.Args[0]
	var args []string
	if len(os.Args) &gt; 1 {
		args = os.Args[1:]
	}

	f, err := ln.(*net.TCPListener).File()
	if err != nil {
		fmt.Println("get socket file", err)
		os.Exit(1)
	}

	cmd := exec.Command(path, args...)
	cmd.Stdout = os.Stdout
	cmd.Stderr = os.Stderr
	cmd.ExtraFiles = []*os.File{f}
	cmd.Env = []string{"child=1"}

	err = cmd.Start()
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
}()

http.Serve(ln, nil) } åœ¨centos7ä¸Šè¯•éªŒç»“æœå¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>ç¬¬ä¸€ç§æƒ…å†µï¼šå¦‚æœæŸä¸ªç»ˆç«¯è·ŸæœåŠ¡å™¨å»ºç«‹äº†é•¿è¿æ¥ï¼ˆåº”è¯¥æ˜¯è®¾ç½®äº†keepaliveå±æ€§ï¼‰ï¼Œé‚£ä¹ˆè¯¥ç»ˆç«¯çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå‘åˆ°å»ºç«‹é•¿è¿æ¥çš„è¿›ç¨‹å»ï¼Œå¦‚ä¸‹ä¿¡æ¯ï¼Œæ‰€æœ‰computerNameçš„è¯·æ±‚éƒ½ä¼šè¢«è½¬å‘åˆ°çˆ¶è¿›ç¨‹å»ï¼ˆçˆ¶è¿›ç¨‹idä¸º13603ï¼‰ï¼š
[root@localhost care_watch_deploy]# lsof -i:9999
COMMAND PID USER FD TYPE DEVICE SIZE/OFF NODE NAME
care_watc 13603 root 3u IPv6 17537280 0t0 TCP *:distinct (LISTEN)
care_watc 13603 root 5u IPv6 17528589 0t0 TCP 10.100.21.105:distinct-&gt;computerName:58776 (ESTABLISHED)
care_watc 13603 root 6u IPv6 17528593 0t0 TCP 10.100.21.105:distinct-&gt;computerName:58780 (ESTABLISHED)
care_watc 13603 root 7u IPv6 17537280 0t0 TCP *:distinct (LISTEN)
care_watc 13617 root 3u IPv6 17537280 0t0 TCP *:distinct (LISTEN)
care_watc 13617 root 4u IPv6 17537280 0t0 TCP *:distinct (LISTEN)</p>

<p>ç¬¬äºŒç§æƒ…å†µï¼šå¦‚æœæœ‰æ–°çš„è¯·æ±‚è¿›æ¥ï¼Œä¼šéšæœºåˆ†é…åˆ°çˆ¶è¿›ç¨‹æˆ–è€…å­è¿›ç¨‹ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œæˆ‘å¤šæ¬¡è¯•éªŒçš„ç»“æœæ˜¯ï¼Œ20%çš„è¯·æ±‚ä¼šè¢«è½¬å‘åˆ°å­è¿›ç¨‹ï¼Œ80%çš„è¯·æ±‚ä¼šè¢«è½¬å‘åˆ°çˆ¶è¿›ç¨‹ã€‚æµ‹è¯•çš„pythonä»£ç å¦‚ä¸‹ï¼Œä¸ç®¡è¿è¡Œå‡ æ¬¡count_childçš„å€¼æ°¸è¿œéƒ½æ˜¯100å·¦å³ï¼š
import requests</p>

<p>count_child = 0</p>

<p>for i in range(500):
    resp = requests.get(â€œhttp://10.100.21.105:9999/â€)
    result = resp.content.decode(â€œutf8â€)
    if result == â€œhello world from child?  trueâ€:
        count_child += 1</p>

<p>print(count_child)
ç¬¬ä¸‰ç§æƒ…å†µï¼Œçˆ¶è¿›ç¨‹æˆ–è€…å­è¿›ç¨‹ä»»æ„ä¸€ä¸ªé€€å‡ºä¹‹åï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè½¬å‘åˆ°å¦ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚
ä»ä»¥ä¸Šä¸‰ç§æƒ…å†µçœ‹ï¼Œendlessçš„åšæ³•ä¸ä¼šè½ä¸‹ä»»ä½•è¯·æ±‚ï¼Œå› ä¸ºè¯·æ±‚ä¸æ˜¯è¢«çˆ¶è¿›ç¨‹å¤„ç†äº†å°±æ˜¯è¢«å­è¿›ç¨‹å¤„ç†äº†ï¼Œæ‰€ä»¥endlessæ˜¯ä¸ªå¯æ”¾å¿ƒä½¿ç”¨çš„çƒ­æ›´æ–°æ–¹æ¡ˆã€‚</p>

<p>æœ€ç»ˆendlessçš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹å¦‚å…¶æ—¥å¿—ï¼š</p>

<p>2015/03/22 20:04:10 2710 Received SIGHUP. forking.	//æ¥æ”¶åˆ°kill -1ä¿¡å·ï¼Œforkè¿›ç¨‹è¿è¡Œæ–°ç¨‹åº
2015/03/22 20:04:10 2710 Received SIGTERM.	//çˆ¶è¿›ç¨‹æ¥æ”¶åˆ°å­è¿›ç¨‹å‘å‡ºçš„ä¸­æ–­ä¿¡å·ï¼Œå…³é—­socketç›‘å¬å™¨
2015/03/22 20:04:10 2710 Waiting for connections to finishâ€¦	//çˆ¶è¿›ç¨‹ç­‰å¾…è¯·æ±‚å¤„ç†å®Œæˆ
2015/03/22 20:04:10 PID: 2726 localhost:4242	//æ–°è¿›ç¨‹å¯åŠ¨æœåŠ¡
2015/03/22 20:04:10 accept tcp 127.0.0.1:4242: use of closed network connection	//æ–°çš„ç”¨æˆ·è¯·æ±‚è¿›å…¥åˆ°æ–°ç¨‹åº
2015/03/22 20:04:10 Server on 4242 stopped	//çˆ¶è¿›ç¨‹å¤„ç†å®Œæ‰€æœ‰è¯·æ±‚å¹¶é€€å‡º
æ€»ç»“
å…¶å®linux kernel 3.9å¼€å§‹socketæ˜¯æ”¯æŒSO_REUSEPORTè®¾ç½®é¡¹çš„ï¼Œå³å¤šä¸ªè¿›ç¨‹å¯é€šçŸ¥ç»‘å®šä¸€ä¸ªsocketç«¯å£ï¼Œç”±å†…æ ¸åˆ†å‘è¯·æ±‚ï¼Œä½†æ˜¯ç›®å‰çš„Goï¼ˆ1.12ç‰ˆæœ¬ï¼‰ä¸æ”¯æŒsocketè®¾ç½®é¡¹ã€‚æ‰€ä»¥åœ¨ç›®å‰çš„æ¡ä»¶ä¸‹ï¼Œendlessç¡®å®å¦‚ä½œè€…æè¿°ï¼Œæ˜¯ä¸€ä¸ª0 down timeçš„éå¸¸å¥½çš„æ–¹æ¡ˆã€‚</p>
:ET