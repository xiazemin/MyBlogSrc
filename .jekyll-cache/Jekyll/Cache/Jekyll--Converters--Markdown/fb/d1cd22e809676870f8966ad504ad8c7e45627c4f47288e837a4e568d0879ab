I"¸#<p>https://github.com/jaegertracing/jaeger
https://www.jaegertracing.io/docs/1.14/getting-started/
https://github.com/jaegertracing/jaeger-client-go
<!-- more -->
trace
Microé€šè¿‡Wrapperå®ç°äº†ä¸‰ç§traceæ¥å£ï¼Œaswxray,opencensus,opentracing,è¿™é‡Œä¸»è¦å…³æ³¨opentracingï¼Œopentracingå·²æˆä¸ºè¡Œä¸šæ ‡å‡†ã€‚</p>

<p>opentracing
è¦å¼•å…¥OpenTracingæ–¹æ¡ˆï¼Œåªéœ€è¦opentracing.NewClientWrapperåŠ å…¥Clientæˆ–è€…Serverå³å¯ã€‚</p>

<p>func NewClientWrapper(ot opentracing.Tracer) client.Wrapper {
    return func(c client.Client) client.Client {
        return &amp;otWrapper{ot, c}
    }
}
opentracing.NewClientWrapperæ–¹æ³•å…¥å‚æ˜¯å®ç°OpenTracingçš„æ¥å£opentracing.Tracer</p>

<p>type Tracer interface {
    StartSpan(operationName string, opts â€¦StartSpanOption) Span
    Inject(sm SpanContext, format interface{}, carrier interface{}) error
    Extract(format interface{}, carrier interface{}) (SpanContext, error)
}
jaeger
éƒ¨ç½²ä¸€ä¸ªæµ‹è¯•çš„jaeger,æœåŠ¡å™¨åœ°å€:192.168.8.144ï¼ŒAgentçš„é»˜è®¤ç«¯å£æ˜¯5775ã€‚</p>

<p>/home/service/base/jaeger
[root@localhost jaeger]# ll
total 158444
-rwxr-xr-x 1 root root 14565068 Nov 16 19:35 example-hotrod
-rwxr-xr-x 1 root root 20387089 Nov 16 19:35 jaeger-agent
-rwxr-xr-x 1 root root 38456594 Nov 16 19:35 jaeger-all-in-one
-rwxr-xr-x 1 root root 29731462 Nov 16 19:35 jaeger-collector
-rwxr-xr-x 1 root root 25523281 Nov 16 19:35 jaeger-ingester
-rwxr-xr-x 1 root root 33563911 Nov 16 19:35 jaeger-query
-rwxr-xr-x 1 root root       43 Nov 16 19:36 run
-rw-râ€“râ€“ 1 root root     1939 Nov 16 19:36 x.log
[root@localhost jaeger]# cat run
nohup ./jaeger-all-in-one Â Â» x.log 2&gt;&amp;1 &amp;
jaegeræ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼çš„è¿½è¸ªç³»ç»Ÿï¼Œå®ç°äº†opentracingAPIæ ‡å‡†ï¼Œä¹Ÿæ˜¯Goç”Ÿæ€çš„ï¼Œæ˜¯CNCFæˆå‘˜ã€‚</p>

<p>func TestJaeger(t *testing.T) {
    cfg := config.Configuration{
        ServiceName: â€œMicroTestServiceâ€,//è‡ªå®šä¹‰æœåŠ¡åç§°
        Sampler: &amp;config.SamplerConfig{
            Type:  â€œconstâ€,
            Param: 1,
        },
        Reporter: &amp;config.ReporterConfig{
            LogSpans:            true,
            BufferFlushInterval: 1 * time.Second,
            LocalAgentHostPort:  â€œ192.168.8.144:5775â€,//jaeger agent
        },
    }
    tracer, closer, err := cfg.NewTracer()
    if err != nil {
        t.Error(err)
        return
    }
    defer closer.Close()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>r := mock.NewRegistry()
s := selector.NewSelector(selector.Registry(r))

c := client.NewClient(
    // set the selector
    client.Selector(s),
    // add the trace wrapper
    client.Wrap(NewClientWrapper(tracer)),
)

req := c.NewRequest("test.service", "Test.Method", map[string]string{
    "foo": "bar",
}, client.WithContentType("application/json"))

var rsp map[string]interface{}
c.Call(context.TODO(), req, rsp)
t.Log(rsp) } æµè§ˆå™¨è®¿é—®:http://192.168.8.144:16686/searchå¯ä»¥å‘ç°æœ‰æœåŠ¡MicroTestServiceçš„è®¿é—®è¿½è¸ªäº†
</code></pre></div></div>

<p>éšç€å…¬å¸çš„å‘å±•ï¼Œä¸šåŠ¡ä¸æ–­å¢åŠ ï¼Œæ¨¡å—ä¸æ–­æ‹†åˆ†ï¼Œç³»ç»Ÿé—´ä¸šåŠ¡è°ƒç”¨å˜å¾—è¶Šå¤æ‚ï¼Œå¯¹å®šä½çº¿ä¸Šæ•…éšœå¸¦æ¥å¾ˆå¤§å›°éš¾ã€‚æ•´ä¸ªè°ƒç”¨é“¾ä¸é€æ˜ï¼ŒçŠ¹å¦‚ç³»ç»Ÿè¢«è’™ä¸Šä¸€å—é»‘çº±ï¼Œå½“çº¿ä¸Šé‡åˆ°æ•…éšœæ—¶ï¼Œæ•´ä¸ªæŠ€æœ¯éƒ¨å°±é™·å…¥ç—›è‹¦çš„æ¼©æ¶¡ã€‚è¿™æ—¶å€™åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿåº”è¿è€Œç”Ÿï¼Œå¦‚æ­å¼€äº†é»‘çº±ï¼Œè®©é˜³å…‰ç…§è¿›é»‘æš—ã€‚</p>

<p>åˆ†å¸ƒå¼ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹
image</p>

<p>opentracing åè®®
â€ƒopentracingæ˜¯ä¸€å¥—åˆ†å¸ƒå¼è¿½è¸ªåè®®ï¼Œä¸å¹³å°ï¼Œè¯­è¨€æ— å…³ï¼Œç»Ÿä¸€æ¥å£ï¼Œæ–¹ä¾¿å¼€å‘æ¥å…¥ä¸åŒçš„åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿã€‚</p>

<p>image</p>

<p>ç®€å•ç†è§£opentracing
ä¸€ä¸ªå®Œæ•´çš„opentracingè°ƒç”¨é“¾åŒ…å« Trace + span + æ— é™æåˆ†ç±»</p>

<p>Traceï¼šè¿½è¸ªå¯¹è±¡ï¼Œä¸€ä¸ªTraceä»£è¡¨äº†ä¸€ä¸ªæœåŠ¡æˆ–è€…æµç¨‹åœ¨ç³»ç»Ÿä¸­çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå¦‚ï¼štest.comï¼Œredisï¼Œmysqlç­‰æ‰§è¡Œè¿‡ç¨‹ã€‚ä¸€ä¸ªTraceç”±å¤šä¸ªspanç»„æˆ
spanï¼šè®°å½•Traceåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çš„ä¿¡æ¯ï¼Œå¦‚ï¼šæŸ¥è¯¢çš„sqlï¼Œè¯·æ±‚çš„HTTPåœ°å€ï¼ŒRPCè°ƒç”¨ï¼Œå¼€å§‹ã€ç»“æŸã€é—´éš”æ—¶é—´ç­‰ã€‚
æ— é™æåˆ†ç±»ï¼šæœåŠ¡ä¸æœåŠ¡ä¹‹é—´ä½¿ç”¨æ— é™æåˆ†ç±»çš„æ–¹å¼ï¼Œé€šè¿‡HTTPå¤´éƒ¨æˆ–è€…è¯·æ±‚åœ°å€ä¼ è¾“åˆ°æœ€ä½å±‚ï¼Œä»è€ŒæŠŠæ•´ä¸ªè°ƒç”¨é“¾ä¸²èµ·æ¥ã€‚
ç›¸å…³æ–‡æ¡£
å®˜æ–¹æ–‡æ¡£
OpenTracingè¯­ä¹‰è§„èŒƒ(ä¸­æ–‡ç‰ˆ)
OpenTracingè¯­ä¹‰æƒ¯ä¾‹
opentracingæ–‡æ¡£ä¸­æ–‡ç‰ˆ ( ç¿»è¯‘ ) å´æ™Ÿ
åˆ†å¸ƒå¼è¿½è¸ªç³»ç»ŸJaeger
â€ƒJaegeræ˜¯Uberå¼€å‘çš„ä¸€å¥—åˆ†å¸ƒå¼è¿½è¸ªç³»ç»Ÿï¼Œå·²åœ¨Uberå¤§è§„æ¨¡ä½¿ç”¨ã€‚å¹¶åœ¨2017-9-13 åŠ å…¥CNCF å¼€æºç»„ç»‡ã€‚ä½¿ç”¨Jaegerå¯ä»¥éå¸¸ç›´è§‚çš„å±•ç¤ºæ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçš„è°ƒç”¨é“¾ï¼Œç”±æ­¤å¯ä»¥å¾ˆå¥½å‘ç°å’Œè§£å†³é—®é¢˜ï¼š</p>

<p>image</p>

<p>ä½œç”¨
åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¿¡æ¯ä¼ æ’­
åˆ†å¸ƒå¼äº¤æ˜“ç›‘æ§
å±•ç¤ºè·¨è¿›ç¨‹è°ƒç”¨é“¾
æ€§èƒ½ä¼˜åŒ–
å®šä½é—®é¢˜
ç‰¹æ€§
ä½¿ç”¨udpä¼ è¾“æ•°æ®ï¼Œç›¸å¯¹äºHTTPï¼Œä¼˜ç‚¹åœ¨äºï¼Œä¸ç”¨æ‹…å¿ƒJaegeræœåŠ¡å®•æœºæˆ–è€…ç½‘ç»œä¼ è¾“æœ‰é—®é¢˜è€Œå½±å“æ­£å¸¸çš„ä¸šåŠ¡ã€‚ç¼ºç‚¹å°±æ˜¯ä¸¢åŒ…ï¼Œå½±å“äº†æ•´æ¡è°ƒç”¨é“¾ã€‚
æ•°æ®é€šè¿‡Thriftè¿›è¡Œåºåˆ—åŒ–ï¼Œå’Œjsonå¯¹æ¯”
æ¥å£	Thrift/byte	json/byte	èŠ‚çœ
æ¥å£1	987	2396	çº¦1.5å€
æ¥å£2	1212	2916	çº¦1.4å€
æ¥å£3	12830	18893	çº¦40%
æ¥å£4	17158	22465	çº¦24%
æ¥å£5	11025	14282	çº¦23%
â€ƒä»ä¸­å¯ä»¥çœ‹å‡ºthriftç›¸å¯¹jsonå‡å°‘äº†ä¸å°‘ç©ºé—´ã€‚åœ¨æˆ‘ä»¬é‡‡é›†å…¬å¸æ¥å£çš„æ•°æ®å¤§å°éƒ½é›†ä¸­åœ¨10~20kï¼Œæ‰€ä»¥ä½¿ç”¨thriftä¼šæ›´æœ‰ä¼˜åŠ¿ã€‚</p>

<p>é‡‡é›†ç­–ç•¥
Jaeger å®˜æ–¹æä¾›äº†å¤šç§é‡‡é›†ç­–ç•¥ï¼Œä½¿ç”¨è€…å¯ä»¥æŒ‰éœ€é€‰æ‹©ä½¿ç”¨</p>

<p>ConstSamplerï¼Œå…¨é‡é‡‡é›†
ProbabilisticSampler ï¼Œæ¦‚ç‡é‡‡é›†ï¼Œé»˜è®¤ä¸‡ä»½ä¹‹ä¸€
RateLimitingSampler ï¼Œé™é€Ÿé‡‡é›†ï¼Œæ¯ç§’åªèƒ½é‡‡é›†ä¸€å®šé‡çš„æ•°æ®
RemotelyControlledSampler ï¼Œä¸€ç§åŠ¨æ€é‡‡é›†ç­–ç•¥ï¼Œæ ¹æ®å½“å‰ç³»ç»Ÿçš„è®¿é—®é‡è°ƒèŠ‚é‡‡é›†ç­–ç•¥
å®¢æˆ·ç«¯
Go
Java
node
python
php
å®˜æ–¹æä¾›äº† goï¼Œjavaï¼Œnodeï¼Œpythonå®¢æˆ·ç«¯ï¼Œå…¶ä»–å®¢æˆ·ç«¯è¿˜åœ¨å¼€æ”¾ä¸­ï¼Œphpå®¢æˆ·ç«¯ä¸ºä¸ªäººå¼€å‘ã€æ¬¢è¿starã€‘</p>

<p>éƒ¨ç½²
å¿«é€Ÿéƒ¨ç½² â€”â€” All in one Docker image
â€ƒall-in-one æ˜¯Uberå®˜æ–¹æ‰“åŒ…å¥½çš„é•œåƒï¼Œå¯ä»¥ç›´æ¥éƒ¨ç½²ä½¿ç”¨ï¼Œä½†æ˜¯åªèƒ½ç”¨äºæµ‹è¯•ç¯å¢ƒï¼Œä¸èƒ½ç”¨äºçº¿ä¸Šï¼Œå› ä¸ºå®ƒæŠŠæ•°æ®æ”¾å…¥äº†å†…å­˜ã€‚</p>

<p>docker run -d -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 -p5775:5775/udp -p6831:6831/udp -p6832:6832/udp <br />
  -p5778:5778 -p16686:16686 -p14268:14268 -p9411:9411 jaegertracing/all-in-one:latest
é€šè¿‡ http://localhost:16686 å¯ä»¥åœ¨æµè§ˆå™¨æŸ¥çœ‹ Jaegerçš„åå°</p>

<p>å®˜æ–¹æä¾›çš„ä½¿ç”¨ä¾‹å­ï¼Œéœ€è¦goç¯å¢ƒ
go get github.com/uber/jaeger
cd $GOPATH/src/github.com/uber/jaeger
make install_examples
cd examples/hotrod
go run ./main.go all
http://localhost:8080 æµè§ˆå™¨æ‰“å¼€æŸ¥çœ‹</p>

<p>cassandra + docker éƒ¨ç½²ï¼Œå•æœºæ¨¡å¼
docker run -itd <br />
â€“name=cassandra -p9042:9042 <br />
-v /data/cassandra:/var/lib/cassandra <br />
cassandra</p>

<p>è¿›å…¥å®¹å™¨å»ºç«‹è¡¨ç©ºé—´
æŒ‰ç…§å®˜æ–¹è„šæœ¬æ•´ç†äº†ä¸€ä»½å»ºè¡¨è¯­å¥jaeger_tablesï¼Œè¿›å…¥cassandraï¼Œæ‰§è¡Œè¯­å¥å³å¯åˆ›å»ºæ‰€éœ€çš„è¡¨ã€‚</p>

<p>keyspacesï¼šjaeger_v1_dc</p>

<p>è¿è¡Œ jaeger-query
docker run -itd â€“network=bridge <br />
â€“name=jaeger-query <br />
-p16686:16686 <br />
jaegertracing/jaeger-query <br />
/go/bin/query-linux <br />
â€“span-storage.type=cassandra <br />
â€“cassandra.keyspace=jaeger_v1_dc <br />
â€“cassandra.servers=:9042 <br />
â€“query.static-files=/go/jaeger-ui/</p>

<p>è¿è¡Œ jaeger-collector
docker run -itd â€“network=bridge <br />
â€“name=jaeger-collector <br />
-p14267:14267 <br />
-p14268:14268 <br />
-p9411:9411 <br />
jaegertracing/jaeger-collector <br />
/go/bin/collector-linux <br />
â€“span-storage.type=cassandra <br />
â€“cassandra.keyspace=jaeger_v1_dc <br />
â€“cassandra.servers=:9042</p>

<p>è¿è¡Œ jaeger-agent
docker run <br />
-itd â€“network=bridge <br />
â€“name=jaeger-agent <br />
-p5775:5775/udp <br />
-p6831:6831/udp <br />
-p6832:6832/udp <br />
-p5778:5778/tcp <br />
jaegertracing/jaeger-agent <br />
/go/bin/agent-linux â€“collector.host-port=:14267</p>

<p>è·¨è¯­è¨€è°ƒç”¨æ¡ˆä¾‹
php
Hprose
Goã€beegoã€‘
beego
install beego
go get github.com/astaxie/beego
Download trace_example
git clone git@github.com:jukylin/trace_example.git
cd  trace_example
bee run trace_example
PHP
install jaeger-php
Run Hprose.php
cd vendor/jukylin/jaeger-php/example
php Hprose.php</p>

<p>jaegeræ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰åçš„åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªç³»ç»Ÿï¼Œåº•å±‚ç”¨golangå®ç°ï¼Œå…¼å®¹opentracingæ ‡å‡†ï¼Œè¿™é‡Œåˆ©ç”¨å…¶go-clientæ¥å®ç°ä¸€ä¸ªæœ€ç®€å•çš„demoï¼Œä»…ä¾›å‚è€ƒã€‚</p>

<ol>
  <li>å®‰è£…å¿…è¦çš„åŒ…ï¼š</li>
</ol>

<p>â€œgithub.com/opentracing/opentracing-goâ€
â€œgithub.com/uber/jaeger-client-goâ€
â€œgithub.com/uber/jaeger-client-go/configâ€</p>
<ol>
  <li>å®‰è£…éƒ¨ç½²jaegeræ•´å¥—ï¼š</li>
</ol>

<p>è¿™é‡Œåˆ©ç”¨jaegeræä¾›çš„dockerï¼Œé›†æˆäº†æ•´å¥—ç¯å¢ƒï¼Œåˆ©ç”¨å†…å­˜å­˜å‚¨ï¼šdocker hubåœ°å€ï¼šhttps://hub.docker.com/r/jaegertracing/all-in-one</p>

<p>ç›´æ¥è¿è¡Œä¸€ä¸‹å‘½ä»¤å¯åŠ¨dockerï¼š</p>

<p>docker run -d â€“name jaeger <br />
  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 <br />
  -p 5775:5775/udp <br />
  -p 6831:6831/udp <br />
  -p 6832:6832/udp <br />
  -p 5778:5778 <br />
  -p 16686:16686 <br />
  -p 14268:14268 <br />
  -p 9411:9411 <br />
  jaegertracing/all-in-one:1.9</p>
:ET