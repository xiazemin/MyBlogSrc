I"í<p>https://github.com/edenhill/librdkafka
https://github.com/arnaud-lb/php-rdkafka
https://github.com/weiboad/kafka-php
<!-- more -->
ä¸€ã€å®‰è£…ä»¥åŠä½¿ç”¨shellå‘½ä»¤ç»ˆç«¯æ“ä½œkafka
ç¯å¢ƒé…ç½®
1ã€ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„kafkaï¼š kafka_2.11-1.0.0.tgz
http://mirrors.shu.edu.cn/apache/kafka/1.0.0/kafka_2.11-1.0.0.tgz</p>

<p>2ã€é…ç½®,è§£å‹åè¿›å…¥configç›®å½•
2.1ã€é…ç½®zookeeper.properties
é»˜è®¤ç›‘å¬ç«¯å£2181</p>

<p>2.2ã€é…ç½®server.properties
å¼€å¯ç›‘å¬ç«¯å£ï¼Œæ¯”å¦‚ç›‘å¬æœ¬åœ°
listeners=PLAINTEXT://10.168.1.99:9092</p>

<p>3ã€å¯åŠ¨
3.1ã€å¯åŠ¨zookeeper
./bin/zookeeper-server-start.sh config/zookeeper.properties</p>

<p>3.2ã€å¯åŠ¨server
./bin/kafka-server-start.sh config/server.properties</p>

<p>æ­¤å¤„å¯åŠ¨serveræ—¶æŠ¥é”™å†…å­˜ä¸è¶³ï¼Œè§£å†³æ–¹æ¡ˆè¦ä¹ˆåŠ å¤§ç³»ç»Ÿå†…å­˜ï¼Œè¦ä¹ˆè°ƒå°kafkaéœ€æ±‚å†…å­˜
æˆ‘è¿™æ˜¯è°ƒå°kafkaå¯åŠ¨æ‰€éœ€å†…å­˜å¤§å°
vim kafka-server-start.sh
æŠŠå…¶ä¸­:export KAFKA_HEAP_OPTS=â€-Xmx1G -Xms1Gâ€
æ”¹ä¸ºï¼šexport KAFKA_HEAP_OPTS=â€-Xmx512M -Xms512Mâ€</p>

<p>4ã€å¯åŠ¨æµ‹è¯•çš„æ¶ˆè´¹è€…ï¼Œå¹¶ç›‘å¬topicçš„test
./bin/kafka-console-consumer.sh â€“zookeeper 10.168.1.99:2181 â€“topic test â€“from-beginning</p>

<p>5ã€å¯åŠ¨æµ‹è¯•çš„ç”Ÿäº§è€…ï¼Œå¹¶ç›‘å¬topicçš„test
./bin/kafka-console-producer.sh â€“broker-list 10.168.1.99:9092 â€“topic test</p>

<p>æ­¤æ—¶ï¼Œåœ¨ç”Ÿäº§è€…ä¸­è¾“å…¥æ•°æ®åå›è½¦åï¼Œåœ¨æ¶ˆè´¹è€…ç»ˆç«¯å¯ä»¥çœ‹åˆ°ç”Ÿäº§è€…äº§ç”Ÿçš„ä¿¡æ¯</p>

<p>äºŒã€ä½¿ç”¨PHPæ“ä½œkafka</p>

<p>1ã€å®‰è£…kafkaçš„æ‰©å±•php-rdkafka
1.1ã€åœ¨å®‰è£…php-rdkafkaä¹‹å‰ï¼Œéœ€è¦å…ˆå®‰è£…librdkafka
git clone https://github.com/edenhill/librdkafka.git
./configure
make &amp;&amp; make install</p>

<p>1.2ã€å®‰è£…php-rdkafka
git clone https://github.com/arnaud-lb/php-rdkafka.git
cd php-rdkafka
phpize
./configure
make &amp;&amp; make install</p>

<p>2ã€ç¼–å†™kafkaç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ç±»</p>

<p>&lt;?php
/**</p>
<ul>
  <li>Kafka.php.</li>
  <li>User: lvfk</li>
  <li>Date: 2018/2/7 0007</li>
  <li>Time: 11:04</li>
  <li>Desc: KafkaæœåŠ¡
 */</li>
</ul>

<p>namespace app\models;</p>

<p>use yii\base\InvalidConfigException;</p>

<p>class Kafka
{
    public $broker_list = â€˜10.168.1.99:9092â€™;//é…ç½®kafkaï¼Œå¯ä»¥ç”¨é€—å·éš”å¼€å¤šä¸ªkafka
    public $topic = â€˜topicâ€™;
    public $partition = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protected $producer = null;
protected $consumer = null;
 
public function __construct()
{
    if (empty($this-&gt;broker_list)) {
        throw new InvalidConfigException("broker not config");
    }
    $rk = new \RdKafka\Producer();
    if (empty($rk)) {
        throw new InvalidConfigException("producer error");
    }
    $rk-&gt;setLogLevel(LOG_DEBUG);
    if (!$rk-&gt;addBrokers($this-&gt;broker_list)) {
        throw new InvalidConfigException("producer error");
    }
    $this-&gt;producer = $rk;
}
 
/**
 * ç”Ÿäº§è€…
 * @param array $messages
 * @return mixed
 */
public function send($messages = [])
{
    $topic = $this-&gt;producer-&gt;newTopic($this-&gt;topic);
    return $topic-&gt;produce(RD_KAFKA_PARTITION_UA, $this-&gt;partition, json_encode($messages));
}
 
/**
 * æ¶ˆè´¹è€…
 */
public function consumer($object, $callback){
    $conf = new \RdKafka\Conf();
    $conf-&gt;set('group.id', 0);
    $conf-&gt;set('metadata.broker.list', $this-&gt;broker_list);
 
    $topicConf = new \RdKafka\TopicConf();
    $topicConf-&gt;set('auto.offset.reset', 'smallest');
 
    $conf-&gt;setDefaultTopicConf($topicConf);
 
    $consumer = new \RdKafka\KafkaConsumer($conf);
 
    $consumer-&gt;subscribe([$this-&gt;topic]);
 
    echo "waiting for messages.....\n";
    while(true) {
        $message = $consumer-&gt;consume(120*1000);
        switch ($message-&gt;err) {
            case RD_KAFKA_RESP_ERR_NO_ERROR:
                echo "message payload....";
                $object-&gt;$callback($message-&gt;payload);
                break;
        }
        sleep(1);
    }
} }
</code></pre></div></div>

<p>3ã€é…ç½®
//é…ç½®kafkaç”Ÿäº§è€…
â€˜asyncLogâ€™ =&gt; [
    â€˜classâ€™ =&gt; â€˜\app\models\Kafkaâ€™,
    â€˜broker_listâ€™ =&gt; â€˜10.168.1.99:9092â€™,
    â€˜topicâ€™ =&gt; â€˜asynclogâ€™
]</p>

<p>4ã€åœ¨ä¸šåŠ¡ä»£ç ä¸­ç”Ÿäº§æ¶ˆæ¯
\Yii::$app-&gt;asyncLog-&gt;send([â€˜this is IndexController,â€™.date(â€˜y-md H:i:sâ€™,time())]);</p>

<p>5ã€åœ¨yiiçš„commandä¸­æ¶ˆè´¹</p>

<p>5.1ã€ç¼–å†™KafkaController.php</p>

<p>&lt;?php
/**</p>
<ul>
  <li>@link http://www.yiiframework.com/</li>
  <li>@copyright Copyright (c) 2008 Yii Software LLC</li>
  <li>@license http://www.yiiframework.com/license/
 */</li>
</ul>

<p>namespace app\commands;</p>

<p>use yii\console\Controller;</p>

<p>/**</p>
<ul>
  <li>This command echoes the first argument that you have entered.
 *</li>
  <li>This command is provided as an example for you to learn how to create console commands.
 *</li>
  <li>@author Qiang Xue <a href="mailto:qiang.xue@gmail.com">qiang.xue@gmail.com</a></li>
  <li>@since 2.0
 */
class KafkaController extends Controller
{
 /**
    <ul>
      <li>This command echoes what you have entered as the message.</li>
      <li>@param string $message the message to be echoed.
  */
 public function actionConsume()
 {
 \Yii::$app-&gt;asyncLog-&gt;consumer($this, â€˜callbackâ€™);</li>
    </ul>

    <p>}</p>

    <p>public function callback($message)
 {
     \Yii::info($message, â€˜testkafkaâ€™);
     \Yii::$app-&gt;log-&gt;setflushInterval(1);
 }</p>
  </li>
</ul>

<p>}</p>

<p>5.2ã€è¿è¡Œ:
./yii kafka/consume</p>

<p>6ã€å½“ç¬¬4æ­¥ä¸­ç”Ÿäº§æ•°æ®åï¼Œåœ¨ç¬¬5æ­¥çš„ç»ˆç«¯å¯ä»¥æ¶ˆè´¹æ•°æ®</p>
:ET