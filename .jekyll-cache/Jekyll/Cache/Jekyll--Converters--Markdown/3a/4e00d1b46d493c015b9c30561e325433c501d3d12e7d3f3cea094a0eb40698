I"›=<p>Thrift RPC æ¡†æ¶æŒ‡å—
è®¤è¯†Thriftæ¡†æ¶
thriftæ˜¯ä¸€ä¸ªè½¯ä»¶æ¡†æ¶ï¼Œç”¨æ¥è¿›è¡Œå¯æ‰©å±•ä¸”è·¨è¯­è¨€çš„æœåŠ¡çš„å¼€å‘ã€‚å®ƒç»“åˆäº†åŠŸèƒ½å¼ºå¤§çš„è½¯ä»¶å †æ ˆå’Œä»£ç ç”Ÿæˆå¼•æ“ï¼Œä»¥æ„å»ºåœ¨ C++, Java, Python, PHP, Ruby, Erlang, Perl, Haskell, C#, Cocoa, JavaScript, Node.js, Smalltalk, and OCaml è¿™äº›ç¼–ç¨‹è¯­è¨€é—´æ— ç¼ç»“åˆçš„ã€é«˜æ•ˆçš„æœåŠ¡ã€‚</p>

<p>thriftæœ€åˆç”±facebookå¼€å‘ï¼Œ07å¹´å››æœˆå¼€æ”¾æºç ï¼Œ08å¹´5æœˆè¿›å…¥apacheå­µåŒ–å™¨ã€‚
thriftå…è®¸å®šä¹‰ä¸€ä¸ªç®€å•çš„å®šä¹‰æ–‡ä»¶ä¸­çš„æ•°æ®ç±»å‹å’ŒæœåŠ¡æ¥å£ï¼Œä»¥ä½œä¸ºè¾“å…¥æ–‡ä»¶ï¼Œç¼–è¯‘å™¨ç”Ÿæˆä»£ç ç”¨æ¥æ–¹ä¾¿åœ°ç”ŸæˆRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡çš„æ— ç¼è·¨ç¼–ç¨‹è¯­è¨€ã€‚
ç±»ä¼¼Thriftçš„å·¥å…·ï¼Œè¿˜æœ‰Avroã€protocol buffer,ä½†ç›¸å¯¹äºThriftæ¥è®²ï¼Œéƒ½æ²¡æœ‰Thriftæ”¯æŒå…¨é¢å’Œä½¿ç”¨å¹¿æ³›ã€‚
Thriftè‡ªä¸‹åˆ°ä¸Šå¯ä»¥åˆ†ä¸º4å±‚
Server(single-threaded, event-driven etc)
æœåŠ¡å™¨è¿›ç¨‹è°ƒåº¦
Processor(compiler generated)
RPCæ¥å£å¤„ç†å‡½æ•°åˆ†å‘ï¼ŒIDLå®šä¹‰æ¥å£çš„å®ç°å°†æŒ‚æ¥åˆ°è¿™é‡Œé¢
Protocol (JSON, compact etc)
åè®®
Transport(raw TCP, HTTP etc)
ç½‘ç»œä¼ è¾“
Thriftå®é™…ä¸Šæ˜¯å®ç°äº†C/Sæ¨¡å¼ï¼Œé€šè¿‡ä»£ç ç”Ÿæˆå·¥å…·å°†æ¥å£å®šä¹‰æ–‡ä»¶ç”ŸæˆæœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ä»£ç ï¼ˆå¯ä»¥ä¸ºä¸åŒè¯­è¨€ï¼‰ï¼Œä»è€Œå®ç°æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯è·¨è¯­è¨€çš„æ”¯æŒã€‚ç”¨æˆ·åœ¨Thirftæè¿°æ–‡ä»¶ä¸­å£°æ˜è‡ªå·±çš„æœåŠ¡ï¼Œè¿™äº›æœåŠ¡ç»è¿‡ç¼–è¯‘åä¼šç”Ÿæˆç›¸åº”è¯­è¨€çš„ä»£ç æ–‡ä»¶ï¼Œç„¶åç”¨æˆ·å®ç°æœåŠ¡ï¼ˆå®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ï¼ŒæœåŠ¡å™¨ç«¯ææœåŠ¡ï¼‰ä¾¿å¯ä»¥äº†ã€‚å…¶ä¸­protocolï¼ˆåè®®å±‚, å®šä¹‰æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œå¯ä»¥ä¸ºäºŒè¿›åˆ¶æˆ–è€…XMLç­‰ï¼‰å’Œtransportï¼ˆä¼ è¾“å±‚ï¼Œå®šä¹‰æ•°æ®ä¼ è¾“æ–¹å¼ï¼Œå¯ä»¥ä¸ºTCP/IPä¼ è¾“ï¼Œå†…å­˜å…±äº«æˆ–è€…æ–‡ä»¶å…±äº«ç­‰ï¼‰è¢«ç”¨ä½œè¿è¡Œæ—¶åº“ã€‚</p>

<p>Thriftæ”¯æŒçš„ä¼ è¾“åŠæœåŠ¡æ¨¡å‹
æ”¯æŒçš„ä¼ è¾“æ ¼å¼ï¼š
å‚æ•°	æè¿°
TBinaryProtocol	äºŒè¿›åˆ¶æ ¼å¼
TCompactProtocol	å‹ç¼©æ ¼å¼
TJSONProtocol	JSONæ ¼å¼
TSimpleJSONProtocol	æä¾›JSONåªå†™åè®®, ç”Ÿæˆçš„æ–‡ä»¶å¾ˆå®¹æ˜“é€šè¿‡è„šæœ¬è¯­è¨€è§£æã€‚
TDebugProtocol	ä½¿ç”¨æ˜“æ‡‚çš„å¯è¯»çš„æ–‡æœ¬æ ¼å¼ï¼Œä»¥ä¾¿äºdebug
æ”¯æŒçš„æ•°æ®ä¼ è¾“æ–¹å¼ï¼š
å‚æ•°	æè¿°
TSocket	é˜»å¡å¼socker
TFramedTransport	ä»¥frameä¸ºå•ä½è¿›è¡Œä¼ è¾“ï¼Œéé˜»å¡å¼æœåŠ¡ä¸­ä½¿ç”¨ã€‚
TFileTransport	ä»¥æ–‡ä»¶å½¢å¼è¿›è¡Œä¼ è¾“ã€‚
TMemoryTransport	å°†å†…å­˜ç”¨äºI/O. javaå®ç°æ—¶å†…éƒ¨å®é™…ä½¿ç”¨äº†ç®€å•çš„ByteArrayOutputStreamã€‚
TZlibTransport	ä½¿ç”¨zlibè¿›è¡Œå‹ç¼©ï¼Œ ä¸å…¶ä»–ä¼ è¾“æ–¹å¼è”åˆä½¿ç”¨ã€‚å½“å‰æ— javaå®ç°ã€‚
æ”¯æŒçš„æœåŠ¡æ¨¡å‹ï¼š
å‚æ•°	æè¿°
TSimpleServer	ç®€å•çš„å•çº¿ç¨‹æœåŠ¡æ¨¡å‹ï¼Œå¸¸ç”¨äºæµ‹è¯•
TThreadPoolServer	å¤šçº¿ç¨‹æœåŠ¡æ¨¡å‹ï¼Œä½¿ç”¨æ ‡å‡†çš„é˜»å¡å¼IOã€‚
TNonblockingServer	å¤šçº¿ç¨‹æœåŠ¡æ¨¡å‹ï¼Œä½¿ç”¨éé˜»å¡å¼IOï¼ˆéœ€ä½¿ç”¨TFramedTransportæ•°æ®ä¼ è¾“æ–¹å¼ï¼‰
Thrift ä¸‹è½½åŠå®‰è£…
å¦‚ä½•è·å–Thrift
å®˜ç½‘ï¼šhttp://thrift.apache.org/
golangçš„ThriftåŒ…:
go get git.apache.org/thrift.git/lib/go/thrift
å¦‚ä½•å®‰è£…Thrift
macä¸‹å®‰è£…Thrift,å‚è€ƒä¸Šä¸€ç¯‡ä»‹ç» 
å…¶ä»–å¹³å°å®‰è£…è‡ªè¡ŒæŒ–æ˜,å‘µå‘µã€‚ 
å®‰è£…åé€šè¿‡</p>

<p>liuxinmingMacBook-Rro#:thrift -version
Thrift version 0.9.2 #çœ‹åˆ°è¿™ä¸€è¡Œè¡¨ç¤ºå®‰è£…æˆåŠŸ
Golangã€PHPé€šè¿‡Thriftè°ƒç”¨
å…ˆå‘ä¸ªå®˜æ–¹å„ç§è¯­è¨€DEMOåœ°å€ https://git1-us-west.apache.org/repos/asf?p=thrift.git;a=tree;f=tutorial;h=d69498f9f249afaefd9e6257b338515c0ea06390;hb=HEAD</p>

<p>Thriftçš„åè®®åº“IDLæ–‡ä»¶
è¯­æ³•å‚è€ƒ
å‚è€ƒèµ„æ–™
http://www.cnblogs.com/tianhuilove/archive/2011/09/05/2167669.html</p>

<p>http://my.oschina.net/helight/blog/195015
åŸºæœ¬ç±»å‹</p>

<p>bool: å¸ƒå°”å€¼ (true or false), one byte
byte: æœ‰ç¬¦å·å­—èŠ‚
i16: 16ä½æœ‰ç¬¦å·æ•´å‹
i32: 32ä½æœ‰ç¬¦å·æ•´å‹
i64: 64ä½æœ‰ç¬¦å·æ•´å‹
double: 64ä½æµ®ç‚¹å‹
string: Encoding agnostic text or binary string 
åŸºæœ¬ç±»å‹ä¸­åŸºæœ¬éƒ½æ˜¯æœ‰ç¬¦å·æ•°ï¼Œå› ä¸ºæœ‰äº›è¯­è¨€æ²¡æœ‰æ— ç¬¦å·æ•°ï¼Œæ‰€ä»¥Thriftä¸æ”¯æŒæ— ç¬¦å·æ•´å‹ã€‚
ç‰¹æ®Šç±»å‹</p>

<p>binary: Blob (byte array) a sequence of unencoded bytes 
è¿™æ˜¯stringç±»å‹çš„ä¸€ç§å˜å½¢ï¼Œä¸»è¦æ˜¯ä¸ºjavaä½¿ç”¨
structç»“æ„ä½“
thriftä¸­structæ˜¯å®šä¹‰ä¸ºä¸€ç§å¯¹è±¡ï¼Œå’Œé¢å‘å¯¹è±¡è¯­è¨€çš„classå·®ä¸å¤š.,ä½†æ˜¯structæœ‰ä»¥ä¸‹ä¸€äº›çº¦æŸï¼š 
structä¸èƒ½ç»§æ‰¿ï¼Œä½†æ˜¯å¯ä»¥åµŒå¥—ï¼Œä¸èƒ½åµŒå¥—è‡ªå·±ã€‚</p>
<ol>
  <li>å…¶æˆå‘˜éƒ½æ˜¯æœ‰æ˜ç¡®ç±»å‹</li>
  <li>æˆå‘˜æ˜¯è¢«æ­£æ•´æ•°ç¼–å·è¿‡çš„ï¼Œå…¶ä¸­çš„ç¼–å·ä½¿ä¸èƒ½é‡å¤çš„ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ç¼–ç ä½¿ç”¨ã€‚</li>
  <li>æˆå‘˜åˆ†å‰²ç¬¦å¯ä»¥æ˜¯é€—å·ï¼ˆ,ï¼‰æˆ–æ˜¯åˆ†å·ï¼ˆ;ï¼‰ï¼Œè€Œä¸”å¯ä»¥æ··ç”¨ï¼Œä½†æ˜¯ä¸ºäº†æ¸…æ™°æœŸé—´ï¼Œå»ºè®®åœ¨å®šä¹‰ä¸­åªä½¿ç”¨ä¸€ç§ï¼Œæ¯”å¦‚C++å­¦ä¹ è€…å¯ä»¥å°±ä½¿ç”¨åˆ†å·ï¼ˆ;ï¼‰ã€‚</li>
  <li>å­—æ®µä¼šæœ‰optionalå’Œrequiredä¹‹åˆ†å’Œprotobufä¸€æ ·ï¼Œä½†æ˜¯å¦‚æœä¸æŒ‡å®šåˆ™ä¸ºæ— ç±»å‹â€“å¯ä»¥ä¸å¡«å……è¯¥å€¼ï¼Œä½†æ˜¯åœ¨åºåˆ—åŒ–ä¼ è¾“çš„æ—¶å€™ä¹Ÿä¼šåºåˆ—åŒ–è¿›å»ï¼Œ 
optionalæ˜¯ä¸å¡«å……åˆ™éƒ¨åºåˆ—åŒ–ã€‚ 
requiredæ˜¯å¿…é¡»å¡«å……ä¹Ÿå¿…é¡»åºåˆ—åŒ–ã€‚</li>
  <li>æ¯ä¸ªå­—æ®µå¯ä»¥è®¾ç½®é»˜è®¤å€¼</li>
  <li>åŒä¸€æ–‡ä»¶å¯ä»¥å®šä¹‰å¤šä¸ªstructï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ä¸åŒçš„æ–‡ä»¶ï¼Œè¿›è¡Œincludeå¼•å…¥ã€‚</li>
</ol>

<p>struct Work {
  1: i32 num1 = 0,
  2: i32 num2,
  3: Operation op,
  4: optional string comment,
}
å®¹å™¨ï¼ˆContainersï¼‰
Thrift3ç§å¯ç”¨å®¹å™¨ç±»å‹ï¼š</p>

<p>list(t): å…ƒç´ ç±»å‹ä¸ºtçš„æœ‰åºè¡¨ï¼Œå®¹è®¸å…ƒç´ é‡å¤ã€‚
set(t):å…ƒç´ ç±»å‹ä¸ºtçš„æ— åºè¡¨ï¼Œä¸å®¹è®¸å…ƒç´ é‡å¤ã€‚å¯¹åº”c++ä¸­çš„setï¼Œjavaä¸­çš„HashSet,pythonä¸­çš„setï¼Œphpä¸­æ²¡æœ‰setï¼Œåˆ™è½¬æ¢ä¸ºlistç±»å‹ã€‚
map(t,t): é”®ç±»å‹ä¸ºtï¼Œå€¼ç±»å‹ä¸ºtçš„kvå¯¹ï¼Œé”®ä¸å®¹è®¸é‡å¤ã€‚å¯¹ç”¨c++ä¸­çš„map, Javaçš„HashMap, PHP å¯¹åº” array, Python/Ruby çš„dictionaryã€‚ 
å®¹å™¨ä¸­å…ƒç´ ç±»å‹å¯ä»¥æ˜¯é™¤äº†serviceå¤–çš„ä»»ä½•åˆæ³•Thriftç±»å‹ï¼ˆåŒ…æ‹¬ç»“æ„ä½“å’Œå¼‚å¸¸ï¼‰ã€‚ä¸ºäº†æœ€å¤§çš„å…¼å®¹æ€§ï¼Œmapçš„keyæœ€å¥½æ˜¯thriftçš„åŸºæœ¬ç±»å‹ï¼Œæœ‰äº›è¯­è¨€ä¸æ”¯æŒå¤æ‚ç±»å‹çš„keyï¼ŒJSONåè®®åªæ”¯æŒé‚£äº›åŸºæœ¬ç±»å‹çš„keyã€‚ 
å®¹å™¨éƒ½æ˜¯åŒæ„å®¹å™¨ï¼Œä¸å¤±å¼‚æ„å®¹å™¨ã€‚
å®ç°Thrift TDLæ–‡ä»¶
batu.thriftæ–‡ä»¶ï¼š</p>

<p>/**</p>
<ul>
  <li>BatuThrift TDL</li>
  <li>@author liuxinming</li>
  <li>@time 2015.5.13
 */</li>
</ul>

<p>namespace go batu.demo
namespace php batu.demo</p>

<p>/**</p>
<ul>
  <li>ç»“æ„ä½“å®šä¹‰
 */
struct Article{
 1: i32 id, 
 2: string title,
 3: string content,
 4: string author,
}</li>
</ul>

<p>const map&lt;string,string&gt; MAPCONSTANT = {â€˜helloâ€™:â€™worldâ€™, â€˜goodnightâ€™:â€™moonâ€™}</p>

<p>service batuThrift {      <br />
        list<string> CallBack(1:i64 callTime, 2:string name, 3:map&lt;string, string&gt; paramMap),
        void put(1: Article newArticle),
}
ç¼–è¯‘IDLæ–‡ä»¶ï¼Œç”Ÿæˆç›¸å…³ä»£ç 
thrift -r --gen go batu.thrift
thrift -r --gen php batu.thrift  
thrift -r --gen php:server batu.thrift #ç”ŸæˆPHPæœåŠ¡ç«¯æ¥å£ä»£ç æœ‰æ‰€ä¸ä¸€æ ·
Golang Service å®ç°
å…ˆæŒ‰ç…§golangçš„ThriftåŒ…</string></p>

<p>go get git.apache.org/thrift.git/lib/go/thrift</p>

<p>å°†Thriftç”Ÿæˆçš„å¼€å‘åº“å¤åˆ¶åˆ°GOPATHä¸­</p>

<p>cp -r /Users/liuxinming/wwwroot/testphp/gen-go/batu $GOPATH/src</p>

<p>å¼€å‘Go serverç«¯ä»£ç ï¼ˆåé¢çš„ä»£ç ï¼Œç›®å½•æˆ‘ä»¬æ”¾åœ¨$GOPATH/src/thrift ä¸­è¿è¡Œå’Œæ¼”ç¤ºï¼‰ 
test.goæ–‡ä»¶:</p>

<p>package main</p>

<p>import (
    â€œbatu/demoâ€ #æ³¨æ„å¯¼å…¥Thriftç”Ÿæˆçš„æ¥å£åŒ…
    â€œfmtâ€
    â€œgit.apache.org/thrift.git/lib/go/thriftâ€
    â€œosâ€
    â€œtimeâ€
)</p>

<p>const (
    NetworkAddr = â€œ127.0.0.1:9090â€ #ç›‘å¬åœ°å€&amp;ç«¯å£
)</p>

<p>type batuThrift struct {
}</p>

<p>func (this *batuThrift) CallBack(callTime int64, name string, paramMap map[string]string) (r []string, err error) {
    fmt.Println(â€œâ€“&gt;from client Call:â€, time.Unix(callTime, 0).Format(â€œ2006-01-02 15:04:05â€), name, paramMap)
    r = append(r, â€œkey:â€+paramMap[â€œaâ€]+â€    value:â€+paramMap[â€œbâ€])
    return
}</p>

<p>func (this *batuThrift) Put(s *demo.Article) (err error) {
    fmt.Printf(â€œArticleâ€”&gt;id: %d\tTitle:%s\tContent:%t\tAuthor:%d\nâ€, s.Id, s.Title, s.Content, s.Author)
    return nil
}</p>

<p>func main() {
    transportFactory := thrift.NewTFramedTransportFactory(thrift.NewTTransportFactory())
    protocolFactory := thrift.NewTBinaryProtocolFactoryDefault()
    //protocolFactory := thrift.NewTCompactProtocolFactory()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>serverTransport, err := thrift.NewTServerSocket(NetworkAddr)
if err != nil {
    fmt.Println("Error!", err)
    os.Exit(1)
}

handler := &amp;batuThrift{}
processor := demo.NewBatuThriftProcessor(handler)

server := thrift.NewTSimpleServer4(processor, serverTransport, transportFactory, protocolFactory)
fmt.Println("thrift server in", NetworkAddr)
server.Serve() } 4.è¿è¡ŒgoæœåŠ¡ç«¯(ç›‘å¬9090ç«¯å£)
</code></pre></div></div>

<p>liuxinmingdeMacBook-Pro:thrift liuxinming$ go run test.go 
thrift server in 127.0.0.1:9090</p>

<p>è‡³æ­¤Goçš„ThriftæœåŠ¡ç«¯OK.</p>

<p>Golang Client å®ç°
goClient.goæ–‡ä»¶ï¼š</p>

<p>package main</p>

<p>import (
    â€œbatu/demoâ€
    â€œfmtâ€
    â€œgit.apache.org/thrift.git/lib/go/thriftâ€
    â€œnetâ€
    â€œosâ€
    â€œstrconvâ€
    â€œtimeâ€
)</p>

<p>const (
    HOST = â€œ127.0.0.1â€
    PORT = â€œ9090â€
)</p>

<p>func main() {
    startTime := currentTimeMillis()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>transportFactory := thrift.NewTFramedTransportFactory(thrift.NewTTransportFactory())
protocolFactory := thrift.NewTBinaryProtocolFactoryDefault()

transport, err := thrift.NewTSocket(net.JoinHostPort(HOST, PORT))
if err != nil {
    fmt.Fprintln(os.Stderr, "error resolving address:", err)
    os.Exit(1)
}

useTransport := transportFactory.GetTransport(transport)
client := demo.NewBatuThriftClientFactory(useTransport, protocolFactory)
if err := transport.Open(); err != nil {
    fmt.Fprintln(os.Stderr, "Error opening socket to "+HOST+":"+PORT, " ", err)
    os.Exit(1)
}
defer transport.Close()

for i := 0; i &lt; 10; i++ {
    paramMap := make(map[string]string)
    paramMap["a"] = "batu.demo"
    paramMap["b"] = "test" + strconv.Itoa(i+1)
    r1, _ := client.CallBack(time.Now().Unix(), "go client", paramMap)
    fmt.Println("GOClient Call-&gt;", r1)
}

model := demo.Article{1, "Goç¬¬ä¸€ç¯‡æ–‡ç« ", "æˆ‘åœ¨è¿™é‡Œ", "liuxinming"}
client.Put(&amp;model)
endTime := currentTimeMillis()
fmt.Printf("æœ¬æ¬¡è°ƒç”¨ç”¨æ—¶:%d-%d=%dæ¯«ç§’\n", endTime, startTime, (endTime - startTime))
</code></pre></div></div>

<p>}</p>

<p>func currentTimeMillis() int64 {
    return time.Now().UnixNano() / 1000000
}
goClientè¿è¡Œåç»“æœï¼š</p>

<p>liuxinmingdeMacBook-Pro:thrift liuxinming$ go run goClient.go 
GOClient Call-&gt; [key:batu.demo value:test1] 
GOClient Call-&gt; [key:batu.demo value:test2] 
GOClient Call-&gt; [key:batu.demo value:test3] 
GOClient Call-&gt; [key:batu.demo value:test4] 
GOClient Call-&gt; [key:batu.demo value:test5] 
GOClient Call-&gt; [key:batu.demo value:test6] 
GOClient Call-&gt; [key:batu.demo value:test7] 
GOClient Call-&gt; [key:batu.demo value:test8] 
GOClient Call-&gt; [key:batu.demo value:test9] 
GOClient Call-&gt; [key:batu.demo value:test10] 
æœ¬æ¬¡è°ƒç”¨ç”¨æ—¶:1431583140857-1431583140855=2æ¯«ç§’</p>

<p>PHP Client å®ç°
é¦–å…ˆå»ä¸‹è½½Thriftï¼Œgitåº“åœ°å€ä¸ºï¼šhttps://github.com/apache/thrift
æ–°å»ºé¡¹ç›®ç›®å½•testphpï¼Œç„¶åæŠŠthrift/lib/php/libå¤åˆ¶åˆ°testphpç›®å½•ä¸‹é¢
å¤åˆ¶ç”Ÿæˆçš„gen-phpåˆ°testphpç›®å½•ä¸‹é¢
å®¢æˆ·ç«¯ä»£ç 
&lt;?php
/**</p>
<ul>
  <li>Thrift RPC - PHPClient</li>
  <li>@author liuxinming</li>
  <li>@time 2015.5.13
 */
namespace  batu\testDemo;
header(â€œContent-type: text/html; charset=utf-8â€);
$startTime = getMillisecond();//è®°å½•å¼€å§‹æ—¶é—´</li>
</ul>

<p>$ROOT_DIR = realpath(dirname(<strong>FILE</strong>).â€™/â€™);
$GEN_DIR = realpath(dirname(<strong>FILE</strong>).â€™/â€™).â€™/gen-phpâ€™;
require_once $ROOT_DIR . â€˜/Thrift/ClassLoader/ThriftClassLoader.phpâ€™;</p>

<p>use Thrift\ClassLoader\ThriftClassLoader;
use Thrift\Protocol\TBinaryProtocol;
use Thrift\Transport\TSocket;
use Thrift\Transport\TSocketPool;
use Thrift\Transport\TFramedTransport;
use Thrift\Transport\TBufferedTransport;</p>

<p>$loader = new ThriftClassLoader();
$loader-&gt;registerNamespace(â€˜Thriftâ€™,$ROOT_DIR);
$loader-&gt;registerDefinition(â€˜batu\demoâ€™, $GEN_DIR);
$loader-&gt;register();</p>

<p>$thriftHost = â€˜127.0.0.1â€™; //UserServeræ¥å£æœåŠ¡å™¨IP
$thriftPort = 9090;            //UserServerç«¯å£</p>

<p>$socket = new TSocket($thriftHost,$thriftPort);<br />
$socket-&gt;setSendTimeout(10000);#Sets the send timeout.
$socket-&gt;setRecvTimeout(20000);#Sets the receive timeout.
//$transport = new TBufferedTransport($socket); #ä¼ è¾“æ–¹å¼ï¼šè¿™ä¸ªè¦å’ŒæœåŠ¡å™¨ä½¿ç”¨çš„ä¸€è‡´ [goæä¾›åç«¯æœåŠ¡,è¿­ä»£10000æ¬¡2.6 ~ 3så®Œæˆ]
$transport = new TFramedTransport($socket); #ä¼ è¾“æ–¹å¼ï¼šè¿™ä¸ªè¦å’ŒæœåŠ¡å™¨ä½¿ç”¨çš„ä¸€è‡´[goæä¾›åç«¯æœåŠ¡,è¿­ä»£10000æ¬¡1.9 ~ 2.1så®Œæˆï¼Œæ¯”TBufferå¿«äº†ç‚¹]
$protocol = new TBinaryProtocol($transport);  #ä¼ è¾“æ ¼å¼ï¼šäºŒè¿›åˆ¶æ ¼å¼
$client = new \batu\demo\batuThriftClient($protocol);# æ„é€ å®¢æˆ·ç«¯</p>

<p>$transport-&gt;open();<br />
$socket-&gt;setDebug(TRUE);</p>

<p>for($i=1;$i&lt;11;$i++){
    $item = array();
    $item[â€œaâ€] = â€œbatu.demoâ€;
    $item[â€œbâ€] = â€œtestâ€+$i;
    $result = $client-&gt;CallBack(time(),â€php clientâ€,$item); # å¯¹æœåŠ¡å™¨å‘èµ·rpcè°ƒç”¨
    echo â€œPHPClient Call-&gt;â€.implode(â€˜â€™,$result).â€<br />â€;
}</p>

<p>$s = new \batu\demo\Article();
$s-&gt;id = 1;
$s-&gt;title = â€˜æ’å…¥ä¸€ç¯‡æµ‹è¯•æ–‡ç« â€™;
$s-&gt;content = â€˜æˆ‘å°±æ˜¯è¿™ç¯‡æ–‡ç« å†…å®¹â€™;
$s-&gt;author = â€˜liuxinmingâ€™;
$client-&gt;put($s);</p>

<p>$s-&gt;id = 2;
$s-&gt;title = â€˜æ’å…¥äºŒç¯‡æµ‹è¯•æ–‡ç« â€™;
$s-&gt;content = â€˜æˆ‘å°±æ˜¯è¿™ç¯‡æ–‡ç« å†…å®¹â€™;
$s-&gt;author = â€˜liuxinmingâ€™;
$client-&gt;put($s);</p>

<p>$endTime = getMillisecond();</p>

<p>echo â€œæœ¬æ¬¡è°ƒç”¨ç”¨æ—¶: :â€.$endTime.â€-â€œ.$startTime.â€=â€.($endTime-$startTime).â€æ¯«ç§’<br />â€;</p>

<p>function getMillisecond() {
    list($t1, $t2) = explode(â€˜ â€˜, microtime());
    return (float)sprintf(â€˜%.0fâ€™, (floatval($t1) + floatval($t2)) * 1000);
}</p>

<p>$transport-&gt;close();
PHPè¿è¡Œåç»“æœï¼š</p>

<p>PHPClient Call-&gt;key:batu.demo value:1 
PHPClient Call-&gt;key:batu.demo value:2 
PHPClient Call-&gt;key:batu.demo value:3 
PHPClient Call-&gt;key:batu.demo value:4 
PHPClient Call-&gt;key:batu.demo value:5 
PHPClient Call-&gt;key:batu.demo value:6 
PHPClient Call-&gt;key:batu.demo value:7 
PHPClient Call-&gt;key:batu.demo value:8 
PHPClient Call-&gt;key:batu.demo value:9 
PHPClient Call-&gt;key:batu.demo value:10 
æœ¬æ¬¡è°ƒç”¨ç”¨æ—¶: :1431582183296-1431582183290=6æ¯«ç§’</p>

<p>GoæœåŠ¡ç«¯çœ‹åˆ°æ‰“å°æ•°æ®ï¼š</p>

<p>â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:1] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:2] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:3] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:4] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:5] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:6] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:7] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[b:8 a:batu.demo] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:9] 
â€“&gt;from client Call: 2015-05-13 22:43:03 php client map[a:batu.demo b:10] 
Articleâ€”&gt;id: 1 Title:æ’å…¥ä¸€ç¯‡æµ‹è¯•æ–‡ç«  Content:æˆ‘å°±æ˜¯è¿™ç¯‡æ–‡ç« å†…å®¹ Author:liuxinming 
Articleâ€”&gt;id: 2 Title:æ’å…¥äºŒç¯‡æµ‹è¯•æ–‡ç«  Content:æˆ‘å°±æ˜¯è¿™ç¯‡æ–‡ç« å†…å®¹ Author:liuxinming</p>

<p>å®Œç»“ï¼Œè‡³æ­¤ä¸€ä¸ªGolangçš„ThriftæœåŠ¡ç«¯ å’Œ PHPçš„Thriftå®¢æˆ·ç«¯å®Œæˆï¼</p>
:ET