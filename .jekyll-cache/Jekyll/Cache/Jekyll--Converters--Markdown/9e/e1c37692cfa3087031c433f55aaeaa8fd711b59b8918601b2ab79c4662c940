I"€<p>https://mp.weixin.qq.com/s/qWfci0XCfuNCeAVBoCDW7A
å› ä¸ºTCPçš„ä¸‰æ¬¡æ¡æ‰‹ç­‰ç­‰åŸå› ï¼Œå»ºç«‹ä¸€ä¸ªè¿æ¥æ˜¯ä¸€ä»¶æˆæœ¬æ¯”è¾ƒé«˜çš„è¡Œä¸ºã€‚æ‰€ä»¥åœ¨ä¸€ä¸ªéœ€è¦å¤šæ¬¡ä¸ç‰¹å®šå®ä½“äº¤äº’çš„ç¨‹åºä¸­ï¼Œå°±éœ€è¦ç»´æŒä¸€ä¸ªè¿æ¥æ± ï¼Œé‡Œé¢æœ‰å¯ä»¥å¤ç”¨çš„è¿æ¥å¯ä¾›é‡å¤ä½¿ç”¨ã€‚
è€Œç»´æŒä¸€ä¸ªè¿æ¥æ± ï¼Œæœ€åŸºæœ¬çš„è¦æ±‚å°±æ˜¯è¦åšåˆ°ï¼šthread safeï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ï¼Œå°¤å…¶æ˜¯åœ¨Golangè¿™ç§ç‰¹æ€§æ˜¯goroutineçš„è¯­è¨€ä¸­ã€‚
<!-- more -->
å®ç°ç®€å•çš„è¿æ¥æ± 
type 
Pool</p>

<p>struct</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m sync . Mutex
</code></pre></div></div>

<p>//ä¿è¯å¤šä¸ªgoroutineè®¿é—®æ—¶å€™,closedçš„çº¿ç¨‹å®‰å…¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>res chan io . Closer
</code></pre></div></div>

<p>//è¿æ¥å­˜å‚¨çš„chan</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>factory func ()
</code></pre></div></div>

<p>(
io
.
Closer
,
error
)</p>

<p>//æ–°å»ºè¿æ¥çš„å·¥å‚æ–¹æ³•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>closed  bool
</code></pre></div></div>

<p>//è¿æ¥æ± å…³é—­æ ‡å¿—</p>

<p>}</p>

<p>è¿™ä¸ªç®€å•çš„è¿æ¥æ± ï¼Œæˆ‘ä»¬åˆ©ç”¨chanæ¥å­˜å‚¨æ± é‡Œçš„è¿æ¥ã€‚è€Œæ–°å»ºç»“æ„ä½“çš„æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼š</p>

<p>func 
New
(
fn func
()</p>

<p>(
io
.
Closer
,
 error
),
 size 
uint
)</p>

<p>(*
Pool
,
 error
)</p>

<p>{</p>

<p>if
 size 
&lt;=</p>

<p>0</p>

<p>{</p>

<p>return</p>

<p>nil
,
 errors
.
New
(
â€œsizeçš„å€¼å¤ªå°äº†ã€‚â€
)</p>

<p>}</p>

<p>return</p>

<p>&amp;
Pool
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    factory :  fn ,

    res :
 make ( chan io . Closer ,  size ),
</code></pre></div></div>

<p>},</p>

<p>nil</p>

<p>}</p>

<p>åªéœ€è¦æä¾›å¯¹åº”çš„å·¥å‚å‡½æ•°å’Œè¿æ¥æ± çš„å¤§å°å°±å¯ä»¥äº†ã€‚</p>

<p>è·å–è¿æ¥
é‚£ä¹ˆæˆ‘ä»¬è¦æ€ä¹ˆä»ä¸­è·å–èµ„æºå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬å†…éƒ¨å­˜å‚¨è¿æ¥çš„ç»“æ„æ˜¯chanï¼Œæ‰€ä»¥åªéœ€è¦ç®€å•çš„selectå°±å¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼š</p>

<p>//ä»èµ„æºæ± é‡Œè·å–ä¸€ä¸ªèµ„æº</p>

<p>func 
(
p 
*
Pool
)</p>

<p>Acquire
()</p>

<p>(
io
.
Closer
,
error
)</p>

<p>{</p>

<p>select</p>

<p>{</p>

<p>case
 r
,
ok 
:=</p>

<p>&lt;-
p
.
res
:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "Acquire:å…±äº«èµ„æº" )
</code></pre></div></div>

<p>if</p>

<p>!
ok 
{</p>

<p>return</p>

<p>nil
,
ErrPoolClosed</p>

<p>}</p>

<p>return
 r
,
nil</p>

<p>default
:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "Acquire:æ–°ç”Ÿæˆèµ„æº" )
</code></pre></div></div>

<p>return
 p
.
factory
()</p>

<p>}</p>

<p>}</p>

<p>æˆ‘ä»¬å…ˆä»è¿æ¥æ± çš„resè¿™ä¸ªchané‡Œé¢è·å–ï¼Œå¦‚æœæ²¡æœ‰çš„è¯æˆ‘ä»¬å°±åˆ©ç”¨æˆ‘ä»¬æ—©å·²ç»å‡†å¤‡å¥½çš„å·¥å‚å‡½æ•°è¿›è¡Œæ„é€ è¿æ¥ã€‚åŒæ—¶æˆ‘ä»¬åœ¨ä»resè·å–è¿æ¥çš„æ—¶å€™åˆ©ç”¨okå…ˆç¡®å®šäº†è¿™ä¸ªè¿æ¥æ± æ˜¯å¦å·²ç»å…³é—­ã€‚å¦‚æœå·²ç»å…³é—­çš„è¯æˆ‘ä»¬å°±è¿”å›æ—©å·²ç»å‡†å¤‡å¥½çš„è¿æ¥å·²å…³é—­é”™è¯¯ã€‚</p>

<p>å…³é—­è¿æ¥æ± 
é‚£ä¹ˆæ—¢ç„¶æåˆ°å…³é—­è¿æ¥æ± ï¼Œæˆ‘ä»¬æ˜¯æ€ä¹ˆæ ·å…³é—­è¿æ¥æ± çš„å‘¢ï¼Ÿ</p>

<p>//å…³é—­èµ„æºæ± ï¼Œé‡Šæ”¾èµ„æº</p>

<p>func 
(
p 
*
Pool
)</p>

<p>Close
()</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . m . Lock ()

defer p . m . Unlock ()
</code></pre></div></div>

<p>if
 p
.
closed 
{</p>

<p>return</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . closed  =
</code></pre></div></div>

<p>true</p>

<p>//å…³é—­é€šé“ï¼Œä¸è®©å†™å…¥äº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>close ( p . res )
</code></pre></div></div>

<p>//å…³é—­é€šé“é‡Œçš„èµ„æº</p>

<p>for
 r
:=
range p
.
res 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    r . Close ()
</code></pre></div></div>

<p>}</p>

<p>}</p>

<p>è¿™è¾¹æˆ‘ä»¬éœ€è¦å…ˆè¿›è¡Œp.m.Lock()<em>ä¸Šé”æ“ä½œï¼Œè¿™ä¹ˆåšæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å¯¹ç»“æ„ä½“é‡Œé¢çš„</em>closedè¿›è¡Œè¯»å†™ã€‚éœ€è¦å…ˆæŠŠè¿™ä¸ªæ ‡å¿—ä½è®¾å®šåï¼Œå…³é—­resè¿™ä¸ªchanï¼Œä½¿å¾—Acquireæ–¹æ³•æ— æ³•å†è·å–æ–°çš„è¿æ¥ã€‚æˆ‘ä»¬å†å¯¹resè¿™ä¸ªchané‡Œé¢çš„è¿æ¥è¿›è¡ŒCloseæ“ä½œã€‚</p>

<p>é‡Šæ”¾è¿æ¥
é‡Šæ”¾è¿æ¥é¦–å…ˆå¾—æœ‰ä¸ªå‰æï¼Œå°±æ˜¯è¿æ¥æ± è¿˜æ²¡æœ‰å…³é—­ã€‚å¦‚æœè¿æ¥æ± å·²ç»å…³é—­å†å¾€resé‡Œé¢é€è¿æ¥çš„è¯å°±å¥½è§¦å‘panicã€‚</p>

<p>func 
(
p 
*
Pool
)</p>

<p>Release
(
r io
.
Closer
){</p>

<p>//ä¿è¯è¯¥æ“ä½œå’ŒCloseæ–¹æ³•çš„æ“ä½œæ˜¯å®‰å…¨çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . m . Lock ()

defer p . m . Unlock ()
</code></pre></div></div>

<p>//èµ„æºæ± éƒ½å…³é—­äº†ï¼Œå°±çœè¿™ä¸€ä¸ªæ²¡æœ‰é‡Šæ”¾çš„èµ„æºäº†ï¼Œé‡Šæ”¾å³å¯</p>

<p>if
 p
.
closed 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    r . Close ()
</code></pre></div></div>

<p>return</p>

<p>}</p>

<p>select</p>

<p>{</p>

<p>case
 p
.
res 
&lt;-
 r
:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "èµ„æºé‡Šæ”¾åˆ°æ± å­é‡Œäº†" )
</code></pre></div></div>

<p>default
:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    log . Println ( "èµ„æºæ± æ»¡äº†ï¼Œé‡Šæ”¾è¿™ä¸ªèµ„æºå§" )

    r . Close ()
</code></pre></div></div>

<p>}</p>

<p>}</p>

<p>ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªç®€å•ä¸”çº¿ç¨‹å®‰å…¨çš„è¿æ¥æ± å®ç°æ–¹å¼äº†ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°çš„æ˜¯ï¼Œç°åœ¨è¿æ¥æ± è™½ç„¶å·²ç»å®ç°äº†ï¼Œä½†æ˜¯è¿˜æœ‰å‡ ä¸ªå°ç¼ºç‚¹:</p>

<p>æˆ‘ä»¬å¯¹è¿æ¥æœ€å¤§çš„æ•°é‡æ²¡æœ‰é™åˆ¶ï¼Œå¦‚æœçº¿ç¨‹æ± ç©ºçš„è¯éƒ½æˆ‘ä»¬é»˜è®¤å°±ç›´æ¥æ–°å»ºä¸€ä¸ªè¿æ¥è¿”å›äº†ã€‚ä¸€æ—¦å¹¶å‘é‡é«˜çš„è¯å°†ä¼šä¸æ–­æ–°å»ºè¿æ¥ï¼Œå¾ˆå®¹æ˜“ï¼ˆå°¤å…¶æ˜¯MySQLï¼‰é€ æˆ too many connectionsçš„æŠ¥é”™å‘ç”Ÿã€‚</p>

<p>æ—¢ç„¶æˆ‘ä»¬éœ€è¦ä¿è¯æœ€å¤§å¯è·å–è¿æ¥æ•°é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¸å¸Œæœ›æ•°é‡å®šçš„å¤ªæ­»ã€‚å¸Œæœ›ç©ºé—²çš„æ—¶å€™å¯ä»¥ç»´æŠ¤ä¸€å®šçš„ç©ºé—²è¿æ¥æ•°é‡idleNumï¼Œä½†æ˜¯åˆå¸Œæœ›æˆ‘ä»¬èƒ½é™åˆ¶æœ€å¤§å¯è·å–è¿æ¥æ•°é‡maxNumã€‚</p>

<p>ç¬¬ä¸€ç§æƒ…å†µæ˜¯å¹¶å‘è¿‡å¤šçš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚æœå¹¶å‘é‡è¿‡å°‘å‘¢ï¼Ÿç°åœ¨æˆ‘ä»¬åœ¨æ–°å»ºä¸€ä¸ªè¿æ¥å¹¶ä¸”å½’è¿˜åï¼Œæˆ‘ä»¬å¾ˆé•¿ä¸€æ®µæ—¶é—´ä¸å†ä½¿ç”¨è¿™ä¸ªè¿æ¥ã€‚é‚£ä¹ˆè¿™ä¸ªè¿æ¥å¾ˆæœ‰å¯èƒ½åœ¨å‡ ä¸ªå°æ—¶ç”šè‡³æ›´é•¿æ—¶é—´ä¹‹å‰å°±å·²ç»å»ºç«‹çš„äº†ã€‚é•¿æ—¶é—´é—²ç½®çš„è¿æ¥æˆ‘ä»¬å¹¶æ²¡æœ‰åŠæ³•ä¿è¯å®ƒçš„å¯ç”¨æ€§ã€‚ä¾¿æœ‰å¯èƒ½æˆ‘ä»¬ä¸‹æ¬¡è·å–çš„è¿æ¥æ˜¯å·²ç»å¤±æ•ˆçš„è¿æ¥ã€‚</p>

<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä»å·²ç»æˆç†Ÿä½¿ç”¨çš„MySQLè¿æ¥æ± åº“å’ŒRedisè¿æ¥æ± åº“ä¸­çœ‹çœ‹ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p>

<p>Golangæ ‡å‡†åº“çš„Sqlè¿æ¥æ± 
Golangçš„è¿æ¥æ± å®ç°åœ¨æ ‡å‡†åº“ database/sql/sql.goä¸‹ã€‚å½“æˆ‘ä»¬è¿è¡Œï¼š</p>

<p>db
,
 err 
:=
 sql
.
Open
(
â€œmysqlâ€
,</p>

<p>â€œxxxxâ€
)</p>

<p>çš„æ—¶å€™ï¼Œå°±ä¼šæ‰“å¼€ä¸€ä¸ªè¿æ¥æ± ã€‚æˆ‘ä»¬å¯ä»¥çœ‹çœ‹è¿”å›çš„dbçš„ç»“æ„ä½“ï¼š</p>

<p>type DB 
struct</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waitDuration int64  // Total time waited for new connections.

mu           sync . Mutex
</code></pre></div></div>

<p>// protects following fields</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>freeConn      []* driverConn

connRequests map [ uint64 ] chan connRequest

nextRequest  uint64  // Next key to use in connRequests.

numOpen       int
</code></pre></div></div>

<p>// number of opened and pending open connections</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Used to signal the need for new connections
</code></pre></div></div>

<p>// a goroutine running connectionOpener() reads on this chan and</p>

<p>// maybeOpenNewConnections sends on the chan (one send per needed connection)</p>

<p>// It is closed during db.Close(). The close tells the connectionOpener</p>

<p>// goroutine to exit.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openerCh          chan  struct {}

closed             bool

maxIdle            int
</code></pre></div></div>

<p>// zero means defaultMaxIdleConns; negative means 0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maxOpen            int
</code></pre></div></div>

<p>// &lt;= 0 means unlimited</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>maxLifetime       time . Duration
</code></pre></div></div>

<p>// maximum amount of time a connection may be reused</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cleanerCh         chan  struct {}

waitCount         int64  // Total number of connections waited for.

maxIdleClosed     int64  // Total number of connections closed due to idle.

maxLifetimeClosed int64  // Total number of connections closed due to max free limit.
</code></pre></div></div>

<p>}</p>

<p>ä¸Šé¢çœå»äº†ä¸€äº›æš‚æ—¶ä¸éœ€è¦å…³æ³¨çš„fieldã€‚æˆ‘ä»¬å¯ä»¥çœ‹çš„ï¼ŒDBè¿™ä¸ªè¿æ¥æ± å†…éƒ¨å­˜å‚¨è¿æ¥çš„ç»“æ„freeConnï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„chanï¼Œè€Œæ˜¯[]<em>driverConnï¼Œä¸€ä¸ªè¿æ¥åˆ‡ç‰‡ã€‚åŒæ—¶æˆ‘ä»¬è¿˜å¯ä»¥çœ‹åˆ°ï¼Œé‡Œé¢æœ‰maxIdleç­‰ç›¸å…³å˜é‡æ¥æ§åˆ¶ç©ºé—²è¿æ¥æ•°é‡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒDBçš„åˆå§‹åŒ–å‡½æ•°Openå‡½æ•°å¹¶æ²¡æœ‰æ–°å»ºæ•°æ®åº“è¿æ¥ã€‚è€Œæ–°å»ºè¿æ¥åœ¨å“ªä¸ªå‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨Queryæ–¹æ³•ä¸€è·¯å¾€å›æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ï¼š func(db</em>DB)conn(ctx context.Context,strategy connReuseStrategy)(*driverConn,error)ã€‚è€Œæˆ‘ä»¬ä»è¿æ¥æ± è·å–è¿æ¥çš„æ–¹æ³•ï¼Œå°±ä»è¿™é‡Œå¼€å§‹ï¼š</p>

<p>è·å–è¿æ¥
// conn returns a newly-opened or cached *driverConn.</p>

<p>func 
(
db 
*
DB
)
 conn
(
ctx context
.
Context
,
 strategy connReuseStrategy
)</p>

<p>(*
driverConn
,
 error
)</p>

<p>{</p>

<p>// å…ˆåˆ¤æ–­dbæ˜¯å¦å·²ç»å…³é—­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db . mu . Lock ()
</code></pre></div></div>

<p>if
 db
.
closed 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . mu . Unlock ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 errDBClosed</p>

<p>}</p>

<p>// æ³¨æ„æ£€æµ‹contextæ˜¯å¦å·²ç»è¢«è¶…æ—¶ç­‰åŸå› è¢«å–æ¶ˆã€‚</p>

<p>select</p>

<p>{</p>

<p>default
:</p>

<p>case</p>

<p>&lt;-
ctx
.
Done
():</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . mu . Unlock ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 ctx
.
Err
()</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lifetime  :=  db . maxLifetime
</code></pre></div></div>

<p>// è¿™è¾¹å¦‚æœåœ¨freeConnè¿™ä¸ªåˆ‡ç‰‡æœ‰ç©ºé—²è¿æ¥çš„è¯ï¼Œå°±left popä¸€ä¸ªå‡ºåˆ—ã€‚æ³¨æ„çš„æ˜¯ï¼Œè¿™è¾¹å› ä¸ºæ˜¯åˆ‡ç‰‡æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å‰é¢éœ€è¦åŠ é”ä¸”è·å–åè¿›è¡Œè§£é”æ“ä½œã€‚åŒæ—¶åˆ¤æ–­è¿”å›çš„è¿æ¥æ˜¯å¦å·²ç»è¿‡æœŸã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>numFree  :=  len ( db . freeConn )
</code></pre></div></div>

<p>if
 strategy 
==
 cachedOrNewConn 
&amp;&amp;
 numFree</p>
<blockquote>

</blockquote>

<p>0</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    conn  :=  db . freeConn [ 0 ]

    copy ( db . freeConn ,  db . freeConn [ 1 :])

    db . freeConn  =  db . freeConn [: numFree - 1 ]

    conn . inUse  =
</code></pre></div></div>

<p>true</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . mu . Unlock ()
</code></pre></div></div>

<p>if
 conn
.
expired
(
lifetime
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        conn . Close ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 driver
.
ErrBadConn</p>

<p>}</p>

<p>// Lock around reading lastErr to ensure the session resetter finished.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    conn . Lock ()

    err  :=  conn . lastErr

    conn . Unlock ()
</code></pre></div></div>

<p>if
 err 
==
 driver
.
ErrBadConn</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        conn . Close ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 driver
.
ErrBadConn</p>

<p>}</p>

<p>return
 conn
,</p>

<p>nil</p>

<p>}</p>

<p>// è¿™è¾¹å°±æ˜¯ç­‰å€™è·å–è¿æ¥çš„é‡ç‚¹äº†ã€‚å½“ç©ºé—²çš„è¿æ¥ä¸ºç©ºçš„æ—¶å€™ï¼Œè¿™è¾¹å°†ä¼šæ–°å»ºä¸€ä¸ªrequestï¼ˆçš„ç­‰å¾…è¿æ¥ çš„è¯·æ±‚ï¼‰å¹¶ä¸”å¼€å§‹ç­‰å¾…</p>

<p>if
 db
.
maxOpen</p>
<blockquote>

</blockquote>

<p>0</p>

<p>&amp;&amp;
 db
.
numOpen</p>
<blockquote>
  <p>=
 db
.
maxOpen 
{</p>
</blockquote>

<p>// ä¸‹é¢çš„åŠ¨ä½œç›¸å½“äºå¾€connRequestsè¿™ä¸ªmapæ’å…¥è‡ªå·±çš„å·ç ç‰Œã€‚</p>

<p>// æ’å…¥å·ç ç‰Œä¹‹åè¿™è¾¹å°±ä¸éœ€è¦é˜»å¡ç­‰å¾…ç»§ç»­å¾€ä¸‹èµ°é€»è¾‘ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    req  :=  make ( chan connRequest ,
</code></pre></div></div>

<p>1
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    reqKey  :=  db . nextRequestKeyLocked ()

    db . connRequests [ reqKey ]
</code></pre></div></div>

<p>=
 req</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . waitCount ++

    db . mu . Unlock ()



    waitStart  :=  time . Now ()
</code></pre></div></div>

<p>// Timeout the connection request with the context.</p>

<p>select</p>

<p>{</p>

<p>case</p>

<p>&lt;-
ctx
.
Done
():</p>

<p>// contextå–æ¶ˆæ“ä½œçš„æ—¶å€™ï¼Œè®°å¾—ä»connRequestsè¿™ä¸ªmapå–èµ°è‡ªå·±çš„å·ç ç‰Œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        db . mu . Lock ()
</code></pre></div></div>

<p>delete
(
db
.
connRequests
,
 reqKey
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        db . mu . Unlock ()



        atomic . AddInt64 (&amp; db . waitDuration ,  int64 ( time . Since ( waitStart )))
</code></pre></div></div>

<p>select</p>

<p>{</p>

<p>default
:</p>

<p>case
 ret
,
 ok 
:=</p>

<p>&lt;-
req
:</p>

<p>// è¿™è¾¹å€¼å¾—æ³¨æ„äº†ï¼Œå› ä¸ºç°åœ¨å·²ç»è¢«contextå–æ¶ˆäº†ã€‚ä½†æ˜¯åˆšåˆšæ”¾äº†è‡ªå·±çš„å·ç ç‰Œè¿›å»æ’é˜Ÿé‡Œé¢ã€‚æ„æ€æ˜¯è¯´ä¸å®šå·²ç»å‘äº†è¿æ¥äº†ï¼Œæ‰€ä»¥å¾—æ³¨æ„å½’è¿˜ï¼</p>

<p>if
 ok 
&amp;&amp;
 ret
.
conn 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                db . putConn ( ret . conn ,  ret . err ,
</code></pre></div></div>

<p>false
)</p>

<p>}</p>

<p>}</p>

<p>return</p>

<p>nil
,
 ctx
.
Err
()</p>

<p>case
 ret
,
 ok 
:=</p>

<p>&lt;-
req
:</p>

<p>// ä¸‹é¢æ˜¯å·²ç»è·å¾—è¿æ¥åçš„æ“ä½œäº†ã€‚æ£€æµ‹ä¸€ä¸‹è·å¾—è¿æ¥çš„çŠ¶å†µã€‚å› ä¸ºæœ‰å¯èƒ½å·²ç»è¿‡æœŸäº†ç­‰ç­‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        atomic . AddInt64 (&amp; db . waitDuration ,  int64 ( time . Since ( waitStart )))
</code></pre></div></div>

<p>if</p>

<p>!
ok 
{</p>

<p>return</p>

<p>nil
,
 errDBClosed</p>

<p>}</p>

<p>if
 ret
.
err 
==</p>

<p>nil</p>

<p>&amp;&amp;
 ret
.
conn
.
expired
(
lifetime
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            ret . conn . Close ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 driver
.
ErrBadConn</p>

<p>}</p>

<p>if
 ret
.
conn 
==</p>

<p>nil</p>

<p>{</p>

<p>return</p>

<p>nil
,
 ret
.
err</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        ret . conn . Lock ()

        err  :=  ret . conn . lastErr

        ret . conn . Unlock ()
</code></pre></div></div>

<p>if
 err 
==
 driver
.
ErrBadConn</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            ret . conn . Close ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 driver
.
ErrBadConn</p>

<p>}</p>

<p>return
 ret
.
conn
,
 ret
.
err</p>

<p>}</p>

<p>}</p>

<p>// ä¸‹é¢å°±æ˜¯å¦‚æœä¸Šé¢è¯´çš„é™åˆ¶æƒ…å†µä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»ºå…ˆè¿æ¥æ—¶å€™ï¼Œè¦åšçš„åˆ›å»ºè¿æ¥æ“ä½œäº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db . numOpen ++
</code></pre></div></div>

<p>// optimistically</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db . mu . Unlock ()

ci ,  err  :=  db . connector . Connect ( ctx )
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . mu . Lock ()

    db . numOpen --
</code></pre></div></div>

<p>// correct for earlier optimism</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . maybeOpenNewConnections ()

    db . mu . Unlock ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 err</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db . mu . Lock ()

dc  :=
</code></pre></div></div>

<p>&amp;
driverConn
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db :
    db ,

    createdAt :  nowFunc (),

    ci :
    ci ,

    inUse :
</code></pre></div></div>

<p>true
,</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db . addDepLocked ( dc ,  dc )

db . mu . Unlock ()
</code></pre></div></div>

<p>return
 dc
,</p>

<p>nil</p>

<p>}</p>

<p>å¤åˆ¶ä»£ç </p>

<p>ç®€å•æ¥è¯´ï¼ŒDBç»“æ„ä½“é™¤äº†ç”¨çš„æ˜¯sliceæ¥å­˜å‚¨è¿æ¥ï¼Œè¿˜åŠ äº†ä¸€ä¸ªç±»ä¼¼æ’é˜Ÿæœºåˆ¶çš„connRequestsæ¥è§£å†³è·å–ç­‰å¾…è¿æ¥çš„è¿‡ç¨‹ã€‚åŒæ—¶åœ¨åˆ¤æ–­è¿æ¥å¥åº·æ€§éƒ½æœ‰å¾ˆå¥½çš„å…¼é¡¾ã€‚é‚£ä¹ˆæ—¢ç„¶æœ‰äº†æ’é˜Ÿæœºåˆ¶ï¼Œå½’è¿˜è¿æ¥çš„æ—¶å€™æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿ</p>

<p>é‡Šæ”¾è¿æ¥
æˆ‘ä»¬å¯ä»¥ç›´æ¥æ‰¾åˆ° func(db<em>DB)putConnDBLocked(dc</em>driverConn,err error)boolè¿™ä¸ªæ–¹æ³•ã€‚å°±åƒæ³¨é‡Šè¯´çš„ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦çš„ç›®çš„æ˜¯ï¼š</p>

<p>Satisfy a connRequest or put the driverConn in the idle pool and return true or return false.</p>

<p>æˆ‘ä»¬ä¸»è¦æ¥çœ‹çœ‹é‡Œé¢é‡ç‚¹é‚£å‡ è¡Œï¼š</p>

<p>â€¦</p>

<p>// å¦‚æœå·²ç»è¶…è¿‡æœ€å¤§æ‰“å¼€æ•°é‡äº†ï¼Œå°±ä¸éœ€è¦åœ¨å›å½’pooläº†</p>

<p>if
 db
.
maxOpen</p>
<blockquote>

</blockquote>

<p>0</p>

<p>&amp;&amp;
 db
.
numOpen</p>
<blockquote>

  <p>db
.
maxOpen 
{</p>
</blockquote>

<p>return</p>

<p>false</p>

<p>}</p>

<p>// è¿™è¾¹æ˜¯é‡ç‚¹äº†ï¼ŒåŸºæœ¬æ¥è¯´å°±æ˜¯ä»connRequestè¿™ä¸ªmapé‡Œé¢éšæœºæŠ½ä¸€ä¸ªåœ¨æ’é˜Ÿç­‰ç€çš„è¯·æ±‚ã€‚å–å‡ºæ¥åå‘ç»™ä»–ã€‚å°±ä¸ç”¨å½’è¿˜æ± å­äº†ã€‚</p>

<p>if
 c 
:=
 len
(
db
.
connRequests
);
 c</p>
<blockquote>

</blockquote>

<p>0</p>

<p>{</p>

<p>var
 req chan connRequest</p>

<p>var
 reqKey uint64</p>

<p>for
 reqKey
,
 req 
=
 range db
.
connRequests 
{</p>

<p>break</p>

<p>}</p>

<p>delete
(
db
.
connRequests
,
 reqKey
)</p>

<p>// åˆ é™¤è¿™ä¸ªåœ¨æ’é˜Ÿçš„è¯·æ±‚ã€‚</p>

<p>if
 err 
==</p>

<p>nil</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        dc . inUse  =
</code></pre></div></div>

<p>true</p>

<p>}</p>

<p>// æŠŠè¿æ¥ç»™è¿™ä¸ªæ­£åœ¨æ’é˜Ÿçš„è¿æ¥ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    req  &lt;-  connRequest {

        conn :  dc ,

        err :   err ,
</code></pre></div></div>

<p>}</p>

<p>return</p>

<p>true</p>

<p>}</p>

<p>else</p>

<p>if
 err 
==</p>

<p>nil</p>

<p>&amp;&amp;</p>

<p>!
db
.
closed 
{</p>

<p>// æ—¢ç„¶æ²¡äººæ’é˜Ÿï¼Œå°±çœ‹çœ‹åˆ°äº†æœ€å¤§è¿æ¥æ•°ç›®æ²¡æœ‰ã€‚æ²¡åˆ°å°±å½’è¿˜ç»™freeConnã€‚</p>

<p>if
 db
.
maxIdleConnsLocked
()</p>

<blockquote>

  <p>len
(
db
.
freeConn
)</p>
</blockquote>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        db . freeConn  =  append ( db . freeConn ,  dc )

        db . startCleanerLocked ()
</code></pre></div></div>

<p>return</p>

<p>true</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    db . maxIdleClosed ++
</code></pre></div></div>

<p>}</p>

<p>â€¦</p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“å½’è¿˜è¿æ¥æ—¶å€™ï¼Œå¦‚æœæœ‰åœ¨æ’é˜Ÿè½®å€™çš„è¯·æ±‚å°±ä¸å½’è¿˜ç»™æ± å­ç›´æ¥å‘ç»™åœ¨è½®å€™çš„äººäº†ã€‚</p>

<p>ç°åœ¨åŸºæœ¬å°±è§£å†³å‰é¢è¯´çš„å°é—®é¢˜äº†ã€‚ä¸ä¼šå‡ºç°è¿æ¥å¤ªå¤šå¯¼è‡´æ— æ³•æ§åˆ¶too many connectionsçš„æƒ…å†µã€‚ä¹Ÿå¾ˆå¥½äº†ç»´æŒäº†è¿æ¥æ± çš„æœ€å°æ•°é‡ã€‚åŒæ—¶ä¹Ÿåšäº†ç›¸å…³å¯¹äºè¿æ¥å¥åº·æ€§çš„æ£€æŸ¥æ“ä½œã€‚</p>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½œä¸ºæ ‡å‡†åº“çš„ä»£ç ï¼Œç›¸å…³æ³¨é‡Šå’Œä»£ç éƒ½éå¸¸å®Œç¾ï¼ŒçœŸçš„å¯ä»¥çœ‹çš„ç¥æ¸…æ°”çˆ½ã€‚</p>

<p>redis Golangå®ç°çš„Rediså®¢æˆ·ç«¯
è¿™ä¸ªGolangå®ç°çš„Rediså®¢æˆ·ç«¯ï¼Œæ˜¯æ€ä¹ˆå®ç°è¿æ¥æ± çš„ã€‚è¿™è¾¹çš„æ€è·¯éå¸¸å¥‡å¦™ï¼Œè¿˜æ˜¯èƒ½å­¦ä¹ åˆ°ä¸å°‘å¥½æ€è·¯ã€‚å½“ç„¶äº†ï¼Œç”±äºä»£ç æ³¨é‡Šæ¯”è¾ƒå°‘ï¼Œå•ƒèµ·æ¥ç¬¬ä¸€ä¸‹è¿˜æ˜¯æœ‰ç‚¹è¿·ç³Šçš„ã€‚ç›¸å…³ä»£ç åœ°å€åœ¨https://github.com/go-redis/redis/blob/master/internal/pool/pool.go å¯ä»¥çœ‹åˆ°ã€‚</p>

<p>è€Œå®ƒçš„è¿æ¥æ± ç»“æ„å¦‚ä¸‹</p>

<p>type 
ConnPool</p>

<p>struct</p>

<p>{</p>

<p>â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>queue chan  struct {}



connsMu      sync . Mutex

conns         []* Conn

idleConns     []* Conn

poolSize      int

idleConnsLen  int



stats  Stats



_closed  uint32  // atomic

closedCh chan  struct {}
</code></pre></div></div>

<p>}</p>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é‡Œé¢å­˜å‚¨è¿æ¥çš„ç»“æ„è¿˜æ˜¯sliceã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é‡ç‚¹çœ‹çœ‹ queueï¼Œ connsï¼Œ idleConnsè¿™å‡ ä¸ªå˜é‡ï¼Œåé¢ä¼šæåŠåˆ°ã€‚ä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯ï¼æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ª[]*Connç»“æ„ï¼šconnsã€ idleConnsï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š</p>

<p>åˆ°åº•è¿æ¥å­˜åœ¨å“ªé‡Œï¼Ÿ</p>

<p>æ–°å»ºè¿æ¥æ± è¿æ¥
æˆ‘ä»¬å…ˆä»æ–°å»ºè¿æ¥æ± è¿æ¥å¼€å§‹çœ‹ï¼š</p>

<p>func 
NewConnPool
(
opt 
*
Options
)</p>

<p>*
ConnPool</p>

<p>{</p>

<p>â€¦.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . checkMinIdleConns ()
</code></pre></div></div>

<p>if
 opt
.
IdleTimeout</p>

<blockquote>

</blockquote>

<p>0</p>

<p>&amp;&amp;
 opt
.
IdleCheckFrequency</p>

<blockquote>

</blockquote>

<p>0</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    go p . reaper ( opt . IdleCheckFrequency )
</code></pre></div></div>

<p>}</p>

<p>â€¦.</p>

<p>}</p>

<p>åˆå§‹åŒ–è¿æ¥æ± çš„å‡½æ•°æœ‰ä¸ªå’Œå‰é¢ä¸¤ä¸ªä¸åŒçš„åœ°æ–¹ã€‚</p>

<p>checkMinIdleConnsæ–¹æ³•ï¼Œåœ¨è¿æ¥æ± åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šå¾€è¿æ¥æ± å¡«æ»¡ç©ºé—²çš„è¿æ¥ã€‚</p>

<p>go p.reaper(opt.IdleCheckFrequency)åˆ™ä¼šåœ¨åˆå§‹åŒ–è¿æ¥æ± çš„æ—¶å€™å°±ä¼šèµ·ä¸€ä¸ªgoç¨‹ï¼Œå‘¨æœŸæ€§çš„æ·˜æ±°è¿æ¥æ± é‡Œé¢è¦è¢«æ·˜æ±°çš„è¿æ¥ã€‚</p>

<p>è·å–è¿æ¥
func 
(
p 
*
ConnPool
)</p>

<p>Get
(
ctx context
.
Context
)</p>

<p>(*
Conn
,
 error
)</p>

<p>{</p>

<p>if
 p
.
closed
()</p>

<p>{</p>

<p>return</p>

<p>nil
,</p>

<p>ErrClosed</p>

<p>}</p>

<p>//è¿™è¾¹å’Œå‰é¢sqlè·å–è¿æ¥å‡½æ•°çš„æµç¨‹ä¸åŒã€‚sqlæ˜¯å…ˆçœ‹çœ‹è¿æ¥æ± æœ‰æ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œæœ‰çš„è¯å…ˆè·å–ä¸åˆ°å†æ’é˜Ÿã€‚è¿™è¾¹æ˜¯ç›´æ¥å…ˆæ’é˜Ÿè·å–ä»¤ç‰Œï¼Œæ’é˜Ÿå‡½æ•°åé¢ä¼šåˆ†æã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>err  :=  p . waitTurn ( ctx )
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<p>return</p>

<p>nil
,
 err</p>

<p>}</p>

<p>//å‰é¢æ²¡å‡ºerrorçš„è¯ï¼Œå°±å·²ç»æ’é˜Ÿè½®å€™åˆ°äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯è·å–çš„æµç¨‹ã€‚</p>

<p>for</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    p . connsMu . Lock ()
</code></pre></div></div>

<p>//ä»ç©ºé—²è¿æ¥é‡Œé¢å…ˆè·å–ä¸€ä¸ªç©ºé—²è¿æ¥ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    cn  :=  p . popIdle ()

    p . connsMu . Unlock ()
</code></pre></div></div>

<p>if
 cn 
==</p>

<p>nil</p>

<p>{</p>

<p>// æ²¡æœ‰ç©ºé—²è¿æ¥æ—¶å€™ç›´æ¥è·³å‡ºå¾ªç¯ã€‚</p>

<p>break</p>

<p>}</p>

<p>// åˆ¤æ–­æ˜¯å¦å·²ç»è¿‡æ—¶ï¼Œæ˜¯çš„è¯closeæ‰äº†ç„¶åç»§ç»­å–å‡ºã€‚</p>

<p>if
 p
.
isStaleConn
(
cn
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        _  =  p . CloseConn ( cn )
</code></pre></div></div>

<p>continue</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    atomic . AddUint32 (&amp; p . stats . Hits ,
</code></pre></div></div>

<p>1
)</p>

<p>return
 cn
,</p>

<p>nil</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>atomic . AddUint32 (&amp; p . stats . Misses ,
</code></pre></div></div>

<p>1
)</p>

<p>// å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥çš„è¯ï¼Œè¿™è¾¹å°±ç›´æ¥æ–°å»ºè¿æ¥äº†ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>newcn ,  err  :=  p . newConn ( ctx ,
</code></pre></div></div>

<p>true
)</p>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<p>// å½’è¿˜ä»¤ç‰Œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    p . freeTurn ()
</code></pre></div></div>

<p>return</p>

<p>nil
,
 err</p>

<p>}</p>

<p>return
 newcn
,</p>

<p>nil</p>

<p>}</p>

<p>æˆ‘ä»¬å¯ä»¥è¯•ç€å›ç­”å¼€å¤´é‚£ä¸ªé—®é¢˜ï¼šè¿æ¥åˆ°åº•å­˜åœ¨å“ªé‡Œï¼Ÿç­”æ¡ˆæ˜¯ä» cn:=p.popIdle()è¿™å¥è¯å¯ä»¥çœ‹å‡ºï¼Œè·å–è¿æ¥è¿™ä¸ªåŠ¨ä½œï¼Œæ˜¯ä» idleConnsé‡Œé¢è·å–çš„ï¼Œè€Œé‡Œé¢çš„å‡½æ•°ä¹Ÿè¯æ˜äº†è¿™ä¸€ç‚¹ã€‚åŒæ—¶æˆ‘çš„ç†è§£æ˜¯ï¼š</p>

<p>sqlçš„æ’é˜Ÿæ„å‘³ç€æˆ‘å¯¹è¿æ¥æ± ç”³è¯·è¿æ¥åï¼ŒæŠŠè‡ªå·±çš„ç¼–å·å‘Šè¯‰è¿æ¥æ± ã€‚è¿æ¥é‚£è¾¹ä¸€çœ‹åˆ°æœ‰ç©ºé—²äº†ï¼Œå°±å«æˆ‘çš„å·ã€‚æˆ‘ç­”åº”äº†ä¸€å£°ï¼Œç„¶åè¿æ¥æ± å°±ç›´æ¥ç»™ä¸ªè¿æ¥ç»™æˆ‘ã€‚æˆ‘å¦‚æœä¸å½’è¿˜ï¼Œè¿æ¥æ± å°±ä¸€ç›´ä¸å«ä¸‹ä¸€ä¸ªå·ã€‚</p>

<p>redisè¿™è¾¹çš„æ„æ€æ˜¯ï¼Œæˆ‘å»å’Œè¿æ¥æ± ç”³è¯·çš„ä¸æ˜¯è¿æ¥è€Œæ˜¯ä»¤ç‰Œã€‚æˆ‘å°±ä¸€ç›´æ’é˜Ÿç­‰ç€ï¼Œè¿æ¥æ± ç»™æˆ‘ä»¤ç‰Œäº†ï¼Œæˆ‘æ‰å»ä»“åº“é‡Œé¢æ‰¾ç©ºé—²è¿æ¥æˆ–è€…è‡ªå·±æ–°å»ºä¸€ä¸ªè¿æ¥ã€‚ç”¨å®Œäº†è¿æ¥é™¤äº†å½’è¿˜è¿æ¥å¤–ï¼Œè¿˜å¾—å½’è¿˜ä»¤ç‰Œã€‚å½“ç„¶äº†ï¼Œå¦‚æœæˆ‘è‡ªå·±æ–°å»ºè¿æ¥å‡ºé”™äº†ï¼Œæˆ‘å“ªæ€•æ‹¿ä¸åˆ°è¿æ¥å›å®¶ï¼Œæˆ‘ä¹Ÿå¾—æŠŠä»¤ç‰Œç»™å›è¿æ¥æ± ï¼Œä¸ç„¶è¿æ¥æ± çš„ä»¤ç‰Œæ•°å°‘äº†ï¼Œæœ€å¤§è¿æ¥æ•°ä¹Ÿä¼šå˜å°ã€‚</p>

<p>è€Œï¼š</p>

<p>func 
(
p 
*
ConnPool
)
 freeTurn
()</p>

<p>{</p>

<p>&lt;-
p
.
queue</p>

<p>}</p>

<p>func 
(
p 
*
ConnPool
)
 waitTurn
(
ctx context
.
Context
)
 error 
{</p>

<p>â€¦</p>

<p>case
 p
.
queue 
&lt;-</p>

<p>struct
{}{}:</p>

<p>return</p>

<p>nil</p>

<p>â€¦</p>

<p>}</p>

<p>å°±æ˜¯åœ¨é queueè¿™ä¸ªchanæ¥ç»´æŒä»¤ç‰Œæ•°é‡ã€‚</p>

<p>é‚£ä¹ˆ connsçš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹æ–°å»ºè¿æ¥è¿™ä¸ªå‡½æ•°ï¼š</p>

<p>æ–°å»ºè¿æ¥
func 
(
p 
*
ConnPool
)
 newConn
(
ctx context
.
Context
,
 pooled 
bool
)</p>

<p>(*
Conn
,
 error
)</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cn ,  err  :=  p . dialConn ( ctx ,  pooled )
</code></pre></div></div>

<p>if
 err 
!=</p>

<p>nil</p>

<p>{</p>

<p>return</p>

<p>nil
,
 err</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . connsMu . Lock ()

p . conns  =  append ( p . conns ,  cn )
</code></pre></div></div>

<p>if
 pooled 
{</p>

<p>// å¦‚æœè¿æ¥æ± æ»¡äº†ï¼Œä¼šåœ¨åé¢ç§»é™¤ã€‚</p>

<p>if
 p
.
poolSize</p>
<blockquote>
  <p>=
 p
.
opt
.
PoolSize</p>
</blockquote>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        cn . pooled  =
</code></pre></div></div>

<p>false</p>

<p>}</p>

<p>else</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        p . poolSize ++
</code></pre></div></div>

<p>}</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . connsMu . Unlock ()
</code></pre></div></div>

<p>return
 cn
,</p>

<p>nil</p>

<p>}</p>

<p>åŸºæœ¬é€»è¾‘å‡ºæ¥äº†ã€‚å°±æ˜¯å¦‚æœæ–°å»ºè¿æ¥çš„è¯ï¼Œæˆ‘å¹¶ä¸ä¼šç›´æ¥æ”¾åœ¨ idleConnsé‡Œé¢ï¼Œè€Œæ˜¯å…ˆæ”¾ connsé‡Œé¢ã€‚åŒæ—¶å…ˆçœ‹æ± å­æ»¡äº†æ²¡æœ‰ã€‚æ»¡çš„è¯åé¢å½’è¿˜çš„æ—¶å€™ä¼šæ ‡è®°ï¼Œåé¢ä¼šåˆ é™¤ã€‚é‚£ä¹ˆè¿™ä¸ªåé¢ä¼šåˆ é™¤ï¼ŒæŒ‡çš„æ˜¯ä»€ä¹ˆæ—¶å€™å‘¢ï¼Ÿé‚£å°±æ˜¯ä¸‹é¢è¯´çš„å½’è¿˜è¿æ¥çš„æ—¶å€™äº†ã€‚</p>

<p>å½’è¿˜è¿æ¥
func 
(
p 
*
ConnPool
)</p>

<p>Put
(
cn 
*
Conn
)</p>

<p>{</p>

<p>if
 cn
.
rd
.
Buffered
()</p>

<blockquote>

</blockquote>

<p>0</p>

<p>{</p>

<p>internal
.
Logger
.
Printf
(
â€œConn has unread dataâ€
)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    p . Remove ( cn ,
</code></pre></div></div>

<p>BadConnError
{})</p>

<p>return</p>

<p>}</p>

<p>//è¿™å°±æ˜¯æˆ‘ä»¬åˆšåˆšè¯´çš„åé¢äº†ï¼Œå‰é¢æ ‡è®°è¿‡ä¸è¦å…¥æ± çš„ï¼Œè¿™è¾¹å°±åˆ é™¤äº†ã€‚å½“ç„¶äº†ï¼Œé‡Œé¢ä¹Ÿä¼šè¿›è¡ŒfreeTurnæ“ä½œã€‚</p>

<p>if</p>

<p>!
cn
.
pooled 
{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    p . Remove ( cn ,
</code></pre></div></div>

<p>nil
)</p>

<p>return</p>

<p>}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . connsMu . Lock ()

p . idleConns  =  append ( p . idleConns ,  cn )

p . idleConnsLen ++

p . connsMu . Unlock ()
</code></pre></div></div>

<p>//æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆæ˜æ˜¾çš„è¿™ä¸ªå½’è¿˜å·ç ç‰Œçš„åŠ¨ä½œã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>p . freeTurn ()
</code></pre></div></div>

<p>}</p>

<p>å…¶å®å½’è¿˜çš„è¿‡ç¨‹ï¼Œå°±æ˜¯ä» connsè½¬ç§»åˆ° idleConnsçš„è¿‡ç¨‹ã€‚å½“ç„¶äº†ï¼Œå¦‚æœæ–°å»ºè¿™ä¸ªè¿æ¥æ—¶å€™å‘ç°å·²ç» è¶…å–äº†ï¼Œåé¢å½’è¿˜æ—¶å€™å°±ä¸è½¬ç§»ï¼Œç›´æ¥åˆ é™¤äº†ã€‚</p>

<p>ç­‰ç­‰ï¼Œä¸Šé¢çš„é€»è¾‘ä¼¼ä¹æœ‰ç‚¹ä¸å¯¹ï¼Ÿæˆ‘ä»¬æ¥ç†ä¸€ä¸‹è·å–è¿æ¥æµç¨‹ï¼š</p>

<p>å…ˆ waitTurnï¼Œæ‹¿åˆ°ä»¤ç‰Œã€‚è€Œä»¤ç‰Œæ•°é‡æ˜¯æ ¹æ®poolé‡Œé¢çš„ queueå†³å®šçš„ã€‚</p>

<p>æ‹¿åˆ°ä»¤ç‰Œäº†ï¼Œå»åº“æˆ¿ idleConnsé‡Œé¢æ‹¿ç©ºé—²çš„è¿æ¥ã€‚æ²¡æœ‰çš„è¯å°±è‡ªå·± newConnä¸€ä¸ªï¼Œå¹¶ä¸”æŠŠä»–è®°å½•åˆ° connsé‡Œé¢ã€‚</p>

<p>ç”¨å®Œäº†ï¼Œå°±è°ƒç”¨ putå½’è¿˜ï¼šä¹Ÿå°±æ˜¯ä» connsè½¬ç§»åˆ° idleConnsã€‚å½’è¿˜çš„æ—¶å€™å°±æ£€æŸ¥åœ¨ newConnæ—¶å€™æ˜¯ä¸æ˜¯å·²ç»åšäº†è¶…å–æ ‡è®°äº†ã€‚æ˜¯çš„è¯å°±ä¸è½¬ç§»åˆ° idleConnsã€‚</p>

<p>æˆ‘å½“æ—¶ç–‘æƒ‘äº†å¥½ä¹…ï¼Œæ—¢ç„¶å§‹ç»ˆéƒ½éœ€è¦è·å¾—ä»¤ç‰Œæ‰èƒ½å¾—åˆ°è¿æ¥ï¼Œä»¤ç‰Œæ•°é‡æ˜¯å®šçš„ã€‚ä¸ºä»€ä¹ˆè¿˜ä¼šè¶…å–å‘¢ï¼Ÿç¿»äº†ä¸€ä¸‹æºç ï¼Œæˆ‘çš„ç­”æ¡ˆæ˜¯ï¼š</p>

<p>è™½ç„¶ Getæ–¹æ³•è·å–è¿æ¥æ˜¯ newConnè¿™ä¸ªç§ç”¨æ–¹æ³•ï¼Œå—åˆ°ä»¤ç‰Œç®¡åˆ¶å¯¼è‡´ä¸ä¼šå‡ºç°è¶…å–ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ³•æ¥å—ä¼ å‚ï¼špooledboolã€‚æ‰€ä»¥æˆ‘çŒœæ˜¯æ‹…å¿ƒå…¶ä»–äººè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶å€™ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€å°±ä¼ äº†trueï¼Œå¯¼è‡´poolSizeè¶Šæ¥è¶Šå¤§ã€‚</p>

<p>æ€»çš„æ¥è¯´ï¼Œredisè¿™ä¸ªè¿æ¥æ± çš„è¿æ¥æ•°æ§åˆ¶ï¼Œè¿˜æ˜¯åœ¨ queueè¿™ä¸ªæˆ‘ç§°ä¸ºä»¤ç‰Œçš„chanè¿›è¡Œæ“ä½œã€‚</p>

<p>æ€»ç»“
ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿æ¥æ± çš„æœ€åŸºæœ¬çš„ä¿è¯ï¼Œå°±æ˜¯è·å–è¿æ¥æ—¶å€™çš„çº¿ç¨‹å®‰å…¨ã€‚ä½†æ˜¯åœ¨å®ç°è¯¸å¤šé¢å¤–ç‰¹æ€§æ—¶å€™å´åˆä»ä¸åŒè§’åº¦æ¥å®ç°ã€‚è¿˜æ˜¯éå¸¸æœ‰æ„æ€çš„ã€‚ä½†æ˜¯ä¸ç®¡å­˜å‚¨ç»“æ„æ˜¯ç”¨chanè¿˜æ˜¯è¿˜æ˜¯sliceï¼Œéƒ½å¯ä»¥å¾ˆå¥½çš„å®ç°è¿™ä¸€ç‚¹ã€‚å¦‚æœåƒsqlæˆ–è€…redisé‚£æ ·ç”¨sliceæ¥å­˜å‚¨è¿æ¥ï¼Œå°±å¾—ç»´æŠ¤ä¸€ä¸ªç»“æ„æ¥è¡¨ç¤ºæ’é˜Ÿç­‰å€™çš„æ•ˆæœã€‚</p>
:ET