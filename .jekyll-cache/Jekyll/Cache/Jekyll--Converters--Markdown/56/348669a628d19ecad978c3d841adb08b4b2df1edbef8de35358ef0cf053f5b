I"Õ1<p>myFile.so doesnâ€™t appear to be a valid Zend extension
åŸå› 
vi /home/xiaoju/php7/etc/php.ini
æŠŠ zend_extension=myFile.so
æ”¹æˆ
extension=myFile.so</p>

<p>é€šå¸¸åœ¨php.iniä¸­ï¼Œé€šè¿‡extension=<em>åŠ è½½çš„æ‰©å±•æˆ‘ä»¬ç§°ä¸ºPHPæ‰©å±•ï¼Œé€šè¿‡zend_extension=</em>åŠ è½½çš„æ‰©å±•æˆ‘ä»¬ç§°ä¸ºZendæ‰©å±•ï¼Œä½†ä»æºç çš„è§’åº¦æ¥è®²ï¼ŒPHPæ‰©å±•åº”è¯¥ç§°ä¸ºâ€œæ¨¡å—â€ï¼ˆæºç ä¸­ä»¥moduleå‘½åï¼‰ï¼Œè€ŒZendæ‰©å±•ç§°ä¸ºâ€œæ‰©å±•â€ï¼ˆæºç ä¸­ä»¥extensionå‘½åï¼‰ã€‚</p>

<p>ä¸¤è€…æœ€å¤§çš„åŒºåˆ«åœ¨äºå‘å¼•æ“æ³¨å†Œçš„é’©å­ã€‚å°‘æ•°çš„æ‰©å±•ï¼Œä¾‹å¦‚xdebugã€opcacheï¼Œæ—¢æ˜¯PHPæ‰©å±•ï¼Œä¹Ÿæ˜¯Zendæ‰©å±•ï¼Œä½†å®ƒä»¬åœ¨php.iniä¸­çš„åŠ è½½æ–¹å¼å¾—ç”¨zend_extension=*ï¼Œå…·ä½“åŸå› ä¸‹æ–‡ä¼šè¯´æ˜ã€‚
<!-- more --></p>

<p>å…ˆæ¥çœ‹çœ‹ä¸¤ç§ç±»å‹æ‰©å±•ä¸»è¦çš„æ•°æ®ç»“æ„ï¼š</p>

<p>PHPæ‰©å±•çš„ç»“æ„ä½“ï¼š</p>

<p>typedef struct _zend_module_entry zend_module_entry;
typedef struct _zend_module_dep zend_module_dep;</p>

<p>struct _zend_module_entry {
    unsigned short size;
    unsigned int zend_api;
    unsigned char zend_debug;
    unsigned char zts;
    const struct _zend_ini_entry <em>ini_entry;
    const struct _zend_module_dep *deps;
    const char *name;
    const struct _zend_function_entry *functions;          /</em> PHP Functions <em>/
    int (</em>module_startup_func)(INIT_FUNC_ARGS);             /* MINIT <em>/
    int (</em>module_shutdown_func)(SHUTDOWN_FUNC_ARGS);        /* MSHUTDOWN <em>/
    int (</em>request_startup_func)(INIT_FUNC_ARGS);            /* RINIT <em>/
    int (</em>request_shutdown_func)(SHUTDOWN_FUNC_ARGS);       /* RSHUTDOWN <em>/
    void (</em>info_func)(ZEND_MODULE_INFO_FUNC_ARGS);
    const char <em>version;
    size_t globals_size;
#ifdef ZTS
    ts_rsrc_id</em> globals_id_ptr;
#else
    void* globals_ptr;
#endif
    void (<em>globals_ctor)(void *global TSRMLS_DC);
    void (</em>globals_dtor)(void <em>global TSRMLS_DC);
    int (</em>post_deactivate_func)(void);
    int module_started;
    unsigned char type;
    void *handle;
    int module_number;
    const char *build_id;
};</p>

<p>struct _zend_module_dep {
    const char <em>name;       /</em> module name <em>/
    const char *rel;        /</em> version relationship: NULL (exists), lt|le|eq|ge|gt (to given version) <em>/
    const char *version;    /</em> version <em>/
    unsigned char type;     /</em> dependency type */
};
Zendæ‰©å±•çš„ç»“æ„ä½“ï¼š</p>

<p>/* Typedefâ€™s for zend_extension function pointers <em>/
typedef int (</em>startup_func_t)(zend_extension <em>extension);
typedef void (</em>shutdown_func_t)(zend_extension <em>extension);
typedef void (</em>activate_func_t)(void);
typedef void (*deactivate_func_t)(void);</p>

<p>typedef void (*message_handler_func_t)(int message, void *arg);</p>

<p>typedef void (*op_array_handler_func_t)(zend_op_array *op_array);</p>

<p>typedef void (<em>statement_handler_func_t)(zend_op_array *op_array);
typedef void (</em>fcall_begin_handler_func_t)(zend_op_array <em>op_array);
typedef void (</em>fcall_end_handler_func_t)(zend_op_array *op_array);</p>

<p>typedef void (<em>op_array_ctor_func_t)(zend_op_array *op_array);
typedef void (</em>op_array_dtor_func_t)(zend_op_array *op_array);</p>

<p>typedef struct _zend_extension {
    char *name;
    char *version;
    char *author;
    char *URL;
    char *copyright;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>startup_func_t startup;
shutdown_func_t shutdown;
activate_func_t activate;
deactivate_func_t deactivate;
 
message_handler_func_t message_handler;
 
op_array_handler_func_t op_array_handler;
 
statement_handler_func_t statement_handler;
fcall_begin_handler_func_t fcall_begin_handler;
fcall_end_handler_func_t fcall_end_handler;
 
op_array_ctor_func_t op_array_ctor;
op_array_dtor_func_t op_array_dtor;
 
int (*api_no_check)(int api_no);
int (*build_id_check)(const char* build_id);
void *reserved3;
void *reserved4;
void *reserved5;
void *reserved6;
void *reserved7;
void *reserved8;
 
DL_HANDLE handle;
int resource_number; } zend_extension;
</code></pre></div></div>

<p>typedef struct _zend_extension_version_info {
    int zend_extension_api_no;
    char *build_id;
} zend_extension_version_info;
ä»¥xdebug 2.4.0ä¸ºä¾‹ï¼Œæ¥è¯´æ˜ä¸ºä½•å…¶æ—¢æ˜¯PHPæ‰©å±•ï¼Œä¹Ÿæ˜¯Zendæ‰©å±•ã€‚</p>

<p>é¦–å…ˆçœ‹xdebug.cçš„2710è¡Œå¤„ï¼Œå®šä¹‰äº†ä¸€ä¸ªZendæ‰©å±•çš„ç»“æ„ä½“ï¼š</p>

<p>ZEND_DLEXPORT zend_extension zend_extension_entry = {
    XDEBUG_NAME,
    XDEBUG_VERSION,
    XDEBUG_AUTHOR,
    XDEBUG_URL_FAQ,
    XDEBUG_COPYRIGHT_SHORT,
    xdebug_zend_startup,
    xdebug_zend_shutdown,
    NULL,           /* activate_func_t <em>/
    NULL,           /</em> deactivate_func_t <em>/
    NULL,           /</em> message_handler_func_t <em>/
    NULL,           /</em> op_array_handler_func_t <em>/
    xdebug_statement_call, /</em> statement_handler_func_t <em>/
    NULL,           /</em> fcall_begin_handler_func_t <em>/
    NULL,           /</em> fcall_end_handler_func_t <em>/
    xdebug_init_oparray,   /</em> op_array_ctor_func_t <em>/
    NULL,           /</em> op_array_dtor_func_t */
    STANDARD_ZEND_EXTENSION_PROPERTIES
};
å› ä¸ºxdebugæä¾›äº†å•æ­¥è°ƒè¯•ã€æ€§èƒ½ä¼˜åŒ–ç­‰é«˜çº§åŠŸèƒ½ï¼Œè¿™äº›æ˜¯éœ€è¦hookåˆ°Zendå¼•æ“æ‰èƒ½åšåˆ°çš„ï¼Œè€Œzend_extensionè¿™ä¸ªç»“æ„ä½“å°±æä¾›äº†hookåˆ°Zendå¼•æ“çš„é’©å­ï¼Œä¾‹å¦‚xdebug_statement_callä¼šåœ¨æ¯ä¸€æ¡PHPè¯­å¥æ‰§è¡Œä¹‹åè°ƒç”¨ã€‚</p>

<p>å†çœ‹xdebug.cçš„160è¡Œå¤„ï¼Œå®šä¹‰äº†ä¸€ä¸ªPHPæ‰©å±•çš„ç»“æ„ä½“ï¼š</p>

<p>zend_module_entry xdebug_module_entry = {
    STANDARD_MODULE_HEADER,
    â€œxdebugâ€,
    xdebug_functions,
    PHP_MINIT(xdebug),
    PHP_MSHUTDOWN(xdebug),
    PHP_RINIT(xdebug),
    PHP_RSHUTDOWN(xdebug),
    PHP_MINFO(xdebug),
    XDEBUG_VERSION,
    NO_MODULE_GLOBALS,
    ZEND_MODULE_POST_ZEND_DEACTIVATE_N(xdebug),
    STANDARD_MODULE_PROPERTIES_EX
}
xdebugæä¾›äº†è®¸å¤šå‡½æ•°xdebug_enable()ã€xdebug_disable()ã€xdebug_call_class()â€¦â€¦ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯å®šä¹‰åœ¨xdebug_module_entryä¸­çš„xdebug_functionsã€‚</p>

<p>æ‰€ä»¥ï¼Œä»¥æˆ‘çš„ç†è§£ï¼Œå‘ç”¨æˆ·å±‚é¢æä¾›ä¸€äº›Cå®ç°çš„PHPå‡½æ•°ï¼Œéœ€è¦ç”¨åˆ°zend_module_entryï¼ˆå³ä½œä¸ºPHPæ‰©å±•ï¼‰ï¼Œè€Œéœ€è¦hookåˆ°Zendå¼•æ“çš„è¯ï¼Œå°±å¾—ç”¨åˆ°zend_extensionï¼ˆå³ä½œä¸ºZendæ‰©å±•ï¼‰ï¼Œxdebugåœ¨è¿™é‡Œä¸¤ç§éƒ½éœ€è¦ã€‚</p>

<p>ä½†æ˜¯xdebugæ˜¯é€šè¿‡Zendæ‰©å±•åŠ è½½çš„ï¼ˆzend_extension=*ï¼‰ï¼Œå…¶PHPæ‰©å±•éƒ¨åˆ†æ˜¯å¦‚ä½•è¢«åŠ è½½çš„å‘¢ï¼Ÿå…¶å®åœ¨Zendæ‰©å±•åŠ è½½çš„æ—¶å€™ä¼šè°ƒç”¨zend_extensionä¸­çš„startupï¼Œå³xdebugçš„xdebug_zend_startupå‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°ä¸­ï¼š</p>

<p>ZEND_DLEXPORT int xdebug_zend_startup(zend_extension <em>extension)
{
    /</em> Hook output handlers (header and output writer) */
    xdebug_hook_output_handlers();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zend_xdebug_initialised = 1;
                                                                                                                                                                                                           
return zend_startup_module(&amp;xdebug_module_entry);//å¯¹xdebug PHPæ‰©å±•çš„åŠ è½½ } åŠ è½½é¡ºåºåŒºåˆ« åˆ†æ¸…PHPæ‰©å±•å’ŒZendæ‰©å±•çš„å·®å¼‚åï¼Œæ¥ç€çœ‹çœ‹æ‰©å±•æ˜¯å¦‚ä½•åŠ è½½çš„ï¼Œå…¶åŠ è½½é¡ºåºå’Œä¾èµ–æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼š
</code></pre></div></div>

<p>ç›¸å…³çš„ä¸»è¦ä»£ç ç‰‡æ®µåœ¨main/main.cä¸­ï¼š</p>

<p>int php_module_startup(sapi_module_struct *sf, zend_module_entry *additional_modules, uint num_additional_modules)
{
    . . . . . .</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* this will read in php.ini, set up the configuration parameters,
   load zend extensions and register php function extensions
   to be loaded later */
if (php_init_config(TSRMLS_C) == FAILURE) {
    return FAILURE;
}

. . . . . .

/* startup extensions statically compiled in */
if (php_register_internal_extensions_func(TSRMLS_C) == FAILURE) {
    php_printf("Unable to start builtin modules\n");
    return FAILURE;
}

/* start additional PHP extensions */
php_register_extensions_bc(additional_modules, num_additional_modules TSRMLS_CC);

/* load and startup extensions compiled as shared objects (aka DLLs)
   as requested by php.ini entries
   theese are loaded after initialization of internal extensions
   as extensions *might* rely on things from ext/standard
   which is always an internal extension and to be initialized
   ahead of all other internals
 */
php_ini_register_extensions(TSRMLS_C);
zend_startup_modules(TSRMLS_C);

/* start Zend extensions */
zend_startup_extensions();

. . . . . . } 1ã€php_init_configè§£æphp.iniæ–‡ä»¶ï¼Œè·å–éœ€è¦åŠ è½½çš„PHPæ‰©å±•å’ŒZendæ‰©å±•
</code></pre></div></div>

<p>2ã€php_register_internal_extensions_funcåŠ è½½é™æ€ç¼–è¯‘çš„æ‰©å±•ï¼Œé™æ€ç¼–è¯‘è¿›PHPä¸­çš„æ‰©å±•ï¼Œä¾‹å¦‚dateã€eregã€pcreç­‰ï¼Œè¿™äº›æ‰©å±•åŒ…å«åœ¨main/internal_functions.cä¸­çš„zend_module_entry *php_builtin_extensions[]ä¸­</p>

<p>3ã€php_register_extensions_bcæ³¨å†ŒSAPIçš„æ‰©å±•æ¨¡å—ï¼Œå³additional_modulesä¸­çš„æ‰©å±•ï¼Œä¾‹å¦‚Apache SAPIä¼šæ³¨å†Œä¸€äº›ä¸ApacheåŠŸèƒ½ç›¸å…³çš„æ‰©å±•ï¼ŒCLIæ¨¡å¼ä¸‹additional_modulesä¸ºNULL</p>

<p>4ã€php_ini_register_extensionsä¸­ä¼šå…ˆåŠ è½½Zendæ‰©å±•ï¼Œä¹‹åå†åŠ è½½PHPæ‰©å±•</p>

<p>void php_ini_register_extensions(TSRMLS_D)
{
    zend_llist_apply(&amp;extension_lists.engine, php_load_zend_extension_cb TSRMLS_CC);//åŠ è½½Zendæ‰©å±•
    zend_llist_apply(&amp;extension_lists.functions, php_load_php_extension_cb TSRMLS_CC);//åŠ è½½PHPæ‰©å±•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zend_llist_destroy(&amp;extension_lists.engine);
zend_llist_destroy(&amp;extension_lists.functions); } Zendæ‰©å±•çš„åŠ è½½ï¼ˆphp_load_zend_extension_cb-&gt;zend_load_extensionï¼‰ï¼š
</code></pre></div></div>

<p>åœ¨zend_load_extensionä¸­ä¼šåˆ¤æ–­æ‰©å±•æ˜¯å¦åˆæ³•ï¼ˆèƒ½å¦åŠ è½½ï¼Ÿç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Ÿâ€¦â€¦ï¼‰ï¼Œå¦‚æœåˆæ³•çš„è¯å°†è°ƒç”¨zend_register_extensionï¼Œå‘å…¨å±€å˜é‡zend_extensionsæ·»åŠ å½“å‰Zendæ‰©å±•ï¼Œå¹¶å‘å…¶ä»–å·²åŠ è½½çš„Zendæ‰©å±•å¹¿æ’­ä¸€æ¡æ¶ˆæ¯ï¼ˆå®ç°äº†message_handlerçš„Zendæ‰©å±•å°†æ¥æ”¶åˆ°ï¼‰è¯´æ˜è‡ªå·±è¢«åŠ è½½äº†ï¼Œè¯¥åŠŸèƒ½çš„ç”¨å¤„åœ¨äºï¼Œå¦‚æœæŸäº›æ‰©å±•å­˜åœ¨å†²çªï¼Œåˆ™æ‰©å±•èƒ½å¤Ÿå‘å‡ºè­¦å‘Šä¿¡æ¯ï¼Œå¹¶åœæ­¢åŠ è½½ã€‚</p>

<p>PHPæ‰©å±•çš„åŠ è½½ï¼ˆphp_load_php_extension_cb-&gt;php_load_extensionï¼‰ï¼š</p>

<p>åœ¨php_load_extensionä¸­ä¼šåˆ¤æ–­æ‰©å±•æ˜¯å¦åˆæ³•ï¼ˆèƒ½å¦åŠ è½½ï¼Ÿç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Ÿâ€¦â€¦ï¼‰ï¼Œå¦‚æœåˆæ³•çš„è¯å°†è°ƒç”¨zend_register_module_exï¼Œå…ˆæ£€æŸ¥æ‰©å±•çš„ä¾èµ–ï¼ˆ_zend_module_entryä¸­çš„depsï¼‰ï¼Œè¿™é‡Œåªæ£€æŸ¥å½“å‰æ‰©å±•æ˜¯å¦ä¸å·²åŠ è½½çš„æ‰©å±•å†²çªï¼Œå¦‚æœæ²¡æœ‰å†²çªï¼Œåˆ™å‘å…¨å±€å˜é‡module_registryæ·»åŠ å½“å‰PHPæ‰©å±•ï¼Œæ¥ç€æ³¨å†Œå½“å‰PHPæ‰©å±•çš„å‡½æ•°ï¼ˆ_zend_module_entryä¸­çš„functionsï¼‰</p>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„ç‚¹æ˜¯depsä¾èµ–ï¼Œè¯¥ä¾èµ–å£°æ˜äº†ï¼š</p>

<p>å½“å‰æ‰©å±•ä¼šä¸å“ªäº›æ‰©å±•å†²çª
å“ªäº›æ‰©å±•éœ€è¦å…ˆäºå½“å‰æ‰©å±•åŠ è½½
ä½†æ˜¯zend_register_module_exä¸­åªå¯¹å†²çªåšæ£€æŸ¥ï¼Œå¦‚æœAå£°æ˜è‡ªå·±ä¸Bå†²çªï¼Œä½†æ˜¯Bå´åœ¨Aä¹‹ååŠ è½½ï¼Œé‚£ä¹ˆå°±æ— æ³•æ£€æŸ¥åˆ°è¯¥å†²çªäº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥åœ¨php.iniä¸­æ’å¥½PHPæ‰©å±•çš„é¡ºåºï¼ˆå³Bæ”¾åˆ°Aä¹‹å‰ï¼‰ï¼ŒåŠ è½½çš„æ—¶å€™ä¼šæŒ‰ç…§è¯¥é¡ºåºåŠ è½½ã€‚</p>

<p>5ã€æ‰©å±•åˆå§‹åŒ–é˜¶æ®µï¼š</p>

<p>å…ˆæ¿€æ´»PHPæ‰©å±•ï¼Œåœ¨zend_startup_modulesä¸­ï¼Œä¼šå…ˆå¯¹PHPæ‰©å±•è¿›è¡Œæ’åºï¼ˆæ ¹æ®æ¯ä¸ªPHPæ‰©å±•ä¸­depså£°æ˜çš„ä¾èµ–ï¼‰ï¼Œç„¶åæ‰§è¡Œzend_startup_module_exï¼Œè°ƒç”¨PHPæ‰©å±•çš„MINIT</p>

<p>å†æ¿€æ´»Zendæ‰©å±•ï¼Œåœ¨zend_startup_extensionsä¸­ï¼Œå¯¹æ¯ä¸ªZendæ‰©å±•è°ƒç”¨å…¶startup()</p>

<p>6ã€è¯·æ±‚åˆå§‹åŒ–é˜¶æ®µï¼š</p>

<p>å…ˆè°ƒç”¨Zendæ‰©å±•çš„activate()ï¼šphp_request_startup-&gt;zend_activate-&gt;init_executor-&gt;zend_extension_activator-&gt;activate</p>

<p>å†è°ƒç”¨PHPæ‰©å±•çš„RINITï¼šphp_request_startup-&gt;zend_activate_modules-&gt;request_startup_func</p>

<p>7ã€è¯·æ±‚ç»“æŸé˜¶æ®µï¼š</p>

<p>å…ˆè°ƒç”¨PHPæ‰©å±•çš„RSHUTDOWNï¼šphp_request_shutdown-&gt;zend_deactivate_modules-&gt;request_shutdown_func</p>

<p>å†è°ƒç”¨Zendæ‰©å±•çš„deactivateï¼šphp_request_shutdown-&gt;zend_deactivate-&gt;shutdown_executor-&gt;zend_extension_deactivator-&gt;deactivate</p>

<p>8ã€æ‰©å±•å…³é—­é˜¶æ®µï¼š</p>

<p>å…ˆè°ƒç”¨PHPæ‰©å±•çš„MSHUTDOWNï¼šzend_shutdown-&gt;zend_destroy_modules-&gt;zend_hash_graceful_reverse_destroy-&gt;module_destructor-&gt;module_shutdown_func</p>

<p>å†è°ƒç”¨Zendæ‰©å±•çš„shutdown()ï¼šzend_shutdown-&gt;zend_shutdown_extensions-&gt;zend_extension_shutdown-&gt;shutdown</p>

<p>ä¸€å¼ å›¾äº†è§£æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸ</p>

<p>http://yangxikun.github.io/php/2016/07/10/php-zend-extension.html</p>

<p>https://blog.csdn.net/weixin_30488313/article/details/98249252</p>
:ET