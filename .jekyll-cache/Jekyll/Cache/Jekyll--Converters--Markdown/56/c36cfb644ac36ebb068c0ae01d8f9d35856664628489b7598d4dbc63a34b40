I"º˜<p>åœ¨ runtime.main() å‡½æ•°ä¸­ï¼Œæ‰§è¡Œ runtime_init() å‰ï¼Œä¼šå¯åŠ¨ä¸€ä¸ª sysmon çš„ç›‘æ§çº¿ç¨‹ï¼Œæ‰§è¡Œåå°ç›‘æ§ä»»åŠ¡ï¼š</p>

<p>systemstack(func() { // åˆ›å»ºç›‘æ§çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ç‹¬ç«‹äºè°ƒåº¦å™¨ï¼Œä¸éœ€è¦è·Ÿ p å…³è”å³å¯è¿è¡Œ    newm(sysmon, nil)})
sysmon å‡½æ•°ä¸ä¾èµ– P ç›´æ¥æ‰§è¡Œï¼Œé€šè¿‡ newm å‡½æ•°åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼š</p>

<p>func newm(fn func(), <em>p</em> *p) {</p>

<p>// åˆ›å»º m å¯¹è±¡</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp := allocm(_p_, fn)
</code></pre></div></div>

<p>// æš‚å­˜ m</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp.nextp.set(_p_)

mp.sigmask = initSigmask
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>execLock.rlock() // Prevent process clone.
</code></pre></div></div>

<p>// åˆ›å»ºç³»ç»Ÿçº¿ç¨‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>newosproc(mp, unsafe.Pointer(mp.g0.stack.hi))

execLock.runlock()
</code></pre></div></div>

<p>}
http://www.imooc.com/article/292206
<!-- more -->
å…ˆè°ƒç”¨ allocm åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ª mï¼Œæ¥ç€è°ƒç”¨ newosproc å‡½æ•°å¯åŠ¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼š</p>

<p>// src/runtime/os_linux.go</p>

<p>//go:nowritebarrier</p>

<p>func newosproc(mp *m, stk unsafe.Pointer) {</p>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ret := clone(cloneFlags, stk, unsafe.Pointer(mp), unsafe.Pointer(mp.g0), unsafe.Pointer(funcPC(mstart)))
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>}</p>

<p>æ ¸å¿ƒå°±æ˜¯è°ƒç”¨ clone å‡½æ•°åˆ›å»ºç³»ç»Ÿçº¿ç¨‹ï¼Œæ–°çº¿ç¨‹ä» mstart å‡½æ•°å¼€å§‹æ‰§è¡Œã€‚clone å‡½æ•°ç”±æ±‡ç¼–è¯­è¨€å®ç°ï¼š</p>

<p>// int32 clone(int32 flags, void <em>stk, M *mp, G *gp, void (</em>fn)(void));</p>

<p>TEXT runtimeÂ·clone(SB),NOSPLIT,$0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å‡†å¤‡ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°

MOVL  flags+0(FP), DI

MOVQ  stk+8(FP), SI

MOVQ  $0, DX
</code></pre></div></div>

<p>MOVQ  $0, R10</p>

<p>// å°† mpï¼Œgpï¼Œfn æ‹·è´åˆ°å¯„å­˜å™¨ï¼Œå¯¹å­çº¿ç¨‹å¯è§</p>

<p>MOVQ  mp+16(FP), R8</p>

<p>MOVQ  gp+24(FP), R9</p>

<p>MOVQ  fn+32(FP), R12</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ç³»ç»Ÿè°ƒç”¨ clone
</code></pre></div></div>

<p>MOVL  $56, AX</p>

<p>SYSCALL</p>

<p>// In parent, return.</p>

<p>CMPQ  AX, $0</p>

<p>JEQ  3(PC)</p>

<p>// çˆ¶çº¿ç¨‹ï¼Œè¿”å›</p>

<p>MOVL  AX, ret+40(FP)</p>

<p>RET</p>

<p>// In child, on new stack.</p>

<p>// åœ¨å­çº¿ç¨‹ä¸­ã€‚è®¾ç½® CPU æ ˆé¡¶å¯„å­˜å™¨æŒ‡å‘å­çº¿ç¨‹çš„æ ˆé¡¶</p>

<p>MOVQ  SI, SP</p>

<p>// If g or m are nil, skip Go-related setup.</p>

<p>CMPQ  R8, $0    // m</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JEQ  nog

CMPQ  R9, $0    // g
</code></pre></div></div>

<p>JEQ  nog</p>

<p>// Initialize m-&gt;procid to Linux tid</p>

<p>// é€šè¿‡ gettid ç³»ç»Ÿè°ƒç”¨è·å–çº¿ç¨‹ IDï¼ˆtidï¼‰</p>

<p>MOVL  $186, AX  // gettid</p>

<p>SYSCALL</p>

<p>// è®¾ç½® m.procid = tid</p>

<p>MOVQ  AX, m_procid(R8)</p>

<p>// Set FS to point at m-&gt;tls.</p>

<p>// æ–°çº¿ç¨‹åˆšåˆšåˆ›å»ºå‡ºæ¥ï¼Œè¿˜æœªè®¾ç½®çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œå³ m ç»“æ„ä½“å¯¹è±¡è¿˜æœªä¸å·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥ï¼Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ä¸‹é¢çš„æŒ‡ä»¤è´Ÿè´£è®¾ç½®æ–°çº¿ç¨‹çš„ TLSï¼ŒæŠŠ m å¯¹è±¡å’Œå·¥ä½œçº¿ç¨‹å…³è”èµ·æ¥
</code></pre></div></div>

<p>LEAQ  m_tls(R8), DI</p>

<p>CALL  runtimeÂ·settls(SB)</p>

<p>// In child, set up new stack</p>

<p>get_tls(CX)</p>

<p>MOVQ  R8, g_m(R9) // g.m = m</p>

<p>MOVQ  R9, g(CX) // tls.g = &amp;m.g0</p>

<p>CALL  runtimeÂ·stackcheck(SB)</p>

<p>nog:</p>

<p>// Call fn</p>

<p>// è°ƒç”¨ mstart å‡½æ•°ã€‚æ°¸ä¸è¿”å›</p>

<p>CALL  R12</p>

<p>// It shouldnâ€™t return. If it does, exit that thread.</p>

<p>MOVL  $111, DI</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVL  $60, AX
</code></pre></div></div>

<p>SYSCALL</p>

<p>JMP  -3(PC)  // keep exiting</p>

<p>å…ˆæ˜¯ä¸º clone ç³»ç»Ÿè°ƒç”¨å‡†å¤‡å‚æ•°ï¼Œå‚æ•°é€šè¿‡å¯„å­˜å™¨ä¼ é€’ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå†…æ ¸åˆ›å»ºçº¿ç¨‹æ—¶çš„é€‰é¡¹ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šæ–°çº¿ç¨‹åº”è¯¥ä½¿ç”¨çš„æ ˆï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯é€šè¿‡ newosproc å‡½æ•°ä¼ é€’è¿›æ¥çš„ã€‚</p>

<p>æ¥ç€å°† m, g0, fn åˆ†åˆ«ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œå¾…å­çº¿ç¨‹åˆ›å»ºå¥½åå†æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚å› ä¸ºè¿™äº›å‚æ•°æ­¤æ—¶æ˜¯åœ¨çˆ¶çº¿ç¨‹çš„æ ˆä¸Šï¼Œè‹¥ä¸ä¿å­˜åˆ°å¯„å­˜å™¨ä¸­ï¼Œå­çº¿ç¨‹å°±å–ä¸å‡ºæ¥äº†ã€‚</p>

<p>è¿™ä¸ªå‡ ä¸ªå‚æ•°ä¿å­˜åœ¨çˆ¶çº¿ç¨‹çš„å¯„å­˜å™¨ä¸­ï¼Œåˆ›å»ºå­çº¿ç¨‹æ—¶ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸ä¼šæŠŠçˆ¶çº¿ç¨‹æ‰€æœ‰çš„å¯„å­˜å™¨å¸®æˆ‘ä»¬å¤åˆ¶ä¸€ä»½ç»™å­çº¿ç¨‹ï¼Œæ‰€ä»¥å½“å­çº¿ç¨‹å¼€å§‹è¿è¡Œæ—¶å°±èƒ½æ‹¿åˆ°çˆ¶çº¿ç¨‹ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­çš„å€¼ï¼Œä»è€Œæ‹¿åˆ°è¿™å‡ ä¸ªå‚æ•°ã€‚</p>

<p>ä¹‹åï¼Œè°ƒç”¨ clone ç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸å¸®æˆ‘ä»¬åˆ›å»ºå‡ºäº†ä¸€ä¸ªå­çº¿ç¨‹ã€‚ç›¸å½“äºåŸæ¥çš„ä¸€ä¸ªæ‰§è¡Œåˆ†æ”¯ç°åœ¨å˜æˆäº†ä¸¤ä¸ªæ‰§è¡Œåˆ†æ”¯ï¼Œäºæ˜¯ä¼šæœ‰ä¸¤ä¸ªè¿”å›ã€‚è¿™å’Œè‘—åçš„ fork ç³»ç»Ÿè°ƒç”¨ç±»ä¼¼ï¼Œæ ¹æ®è¿”å›å€¼æ¥åˆ¤æ–­ç°åœ¨æ˜¯å¤„äºçˆ¶çº¿ç¨‹è¿˜æ˜¯å­çº¿ç¨‹ã€‚</p>

<p>å¦‚æœæ˜¯çˆ¶çº¿ç¨‹ï¼Œå°±ç›´æ¥è¿”å›äº†ã€‚å¦‚æœæ˜¯å­çº¿ç¨‹ï¼Œæ¥ç€è¿˜è¦æ‰§è¡Œä¸€å †æ“ä½œï¼Œä¾‹å¦‚è®¾ç½® tlsï¼Œè®¾ç½® m.procid ç­‰ç­‰ã€‚</p>

<p>æœ€åæ‰§è¡Œ mstart å‡½æ•°ï¼Œè¿™æ˜¯åœ¨ newosproc å‡½æ•°ä¼ é€’è¿›æ¥çš„ã€‚mstart å‡½æ•°å†è°ƒç”¨ mstart1ï¼Œåœ¨ mstart1 é‡Œä¼šæ‰§è¡Œè¿™ä¸€è¡Œï¼š</p>

<p>// æ‰§è¡Œå¯åŠ¨å‡½æ•°ã€‚åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œfn == nilif fn := <em>g</em>.m.mstartfn; fn != nil {    fn()}
ä¹‹å‰æˆ‘ä»¬åœ¨è®²åˆå§‹åŒ–çš„æ—¶å€™ï¼Œè¿™é‡Œçš„ fn æ˜¯ç©ºï¼Œä¼šè·³è¿‡çš„ã€‚ä½†åœ¨è¿™é‡Œï¼Œfn å°±æ˜¯æœ€å¼€å§‹åœ¨ runtime.main é‡Œè®¾ç½®çš„ sysmon å‡½æ•°ï¼Œå› æ­¤è¿™é‡Œä¼šæ‰§è¡Œ sysmonï¼Œè€Œå®ƒåˆæ˜¯ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œæ°¸ä¸è¿”å›ã€‚</p>

<p>æ‰€ä»¥ï¼Œè¿™é‡Œä¸ä¼šæ‰§è¡Œåˆ° mstart1 å‡½æ•°åé¢çš„ schedule å‡½æ•°ï¼Œä¹Ÿå°±ä¸ä¼šè¿›å…¥ schedule å¾ªç¯ã€‚å› æ­¤è¿™æ˜¯ä¸€ä¸ªä¸ç”¨å’Œ p ç»“åˆçš„ mï¼Œå®ƒç›´æ¥åœ¨åå°æ‰§è¡Œï¼Œé»˜é»˜åœ°æ‰§è¡Œç›‘æ§ä»»åŠ¡ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æ¥çœ‹ sysmon å‡½æ•°åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ</p>

<p>sysmon æ‰§è¡Œä¸€ä¸ªæ— é™å¾ªç¯ï¼Œä¸€å¼€å§‹æ¯æ¬¡å¾ªç¯ä¼‘çœ  20usï¼Œä¹‹åï¼ˆ1 ms åï¼‰æ¯æ¬¡ä¼‘çœ æ—¶é—´å€å¢ï¼Œæœ€ç»ˆæ¯ä¸€è½®éƒ½ä¼šä¼‘çœ  10msã€‚</p>

<p>sysmon ä¸­ä¼šè¿›è¡Œ netpoolï¼ˆè·å– fd äº‹ä»¶ï¼‰ã€retakeï¼ˆæŠ¢å ï¼‰ã€forcegcï¼ˆæŒ‰æ—¶é—´å¼ºåˆ¶æ‰§è¡Œ gcï¼‰ï¼Œscavenge heapï¼ˆé‡Šæ”¾è‡ªç”±åˆ—è¡¨ä¸­å¤šä½™çš„é¡¹å‡å°‘å†…å­˜å ç”¨ï¼‰ç­‰å¤„ç†ã€‚</p>

<p>å’Œè°ƒåº¦ç›¸å…³çš„ï¼Œæˆ‘ä»¬åªå…³å¿ƒ retake å‡½æ•°ï¼š</p>

<p>func retake(now int64) uint32 {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n := 0
</code></pre></div></div>

<p>// éå†æ‰€æœ‰çš„ p</p>

<p>for i := int32(0); i &lt; gomaxprocs; i++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    _p_ := allp[i]
</code></pre></div></div>

<p>if <em>p</em> == nil {</p>

<p>continue</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    }
</code></pre></div></div>

<p>// ç”¨äº sysmon çº¿ç¨‹è®°å½•è¢«ç›‘æ§ p çš„ç³»ç»Ÿè°ƒç”¨æ—¶é—´å’Œè¿è¡Œæ—¶é—´</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    pd := &amp;_p_.sysmontick
</code></pre></div></div>

<p>// p çš„çŠ¶æ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    s := _p_.status
</code></pre></div></div>

<p>if s == _Psyscall {</p>

<p>// P å¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­ï¼Œéœ€è¦æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¢å </p>

<p>// Retake P from syscall if itâ€™s there for more than 1 sysmon tick (at least 20us).</p>

<p>// <em>p</em>.syscalltick ç”¨äºè®°å½•ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼Œåœ¨å®Œæˆç³»ç»Ÿè°ƒç”¨ä¹‹ååŠ  1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        t := int64(_p_.syscalltick)
</code></pre></div></div>

<p>if int64(pd.syscalltick) != t {</p>

<p>// pd.syscalltick != <em>p</em>.syscalltickï¼Œè¯´æ˜å·²ç»ä¸æ˜¯ä¸Šæ¬¡è§‚å¯Ÿåˆ°çš„ç³»ç»Ÿè°ƒç”¨äº†ï¼Œ</p>

<p>// è€Œæ˜¯å¦å¤–ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°è®°å½• tick å’Œ when å€¼</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            pd.syscalltick = uint32(t)

            pd.syscallwhen = now
</code></pre></div></div>

<p>continue</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        }
</code></pre></div></div>

<p>// åªè¦æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œåˆ™æŠ¢å è¯¥ pï¼Œå¦åˆ™ä¸æŠ¢å </p>

<p>// 1. p çš„è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰ç­‰å¾…è¿è¡Œçš„ goroutine</p>

<p>// 2. æ²¡æœ‰æ— æ‰€äº‹äº‹çš„ p</p>

<p>// 3. ä»ä¸Šä¸€æ¬¡ç›‘æ§çº¿ç¨‹è§‚å¯Ÿåˆ° p å¯¹åº”çš„ m å¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­åˆ°ç°åœ¨å·²ç»è¶…è¿‡ 10 æ¯«ç§’</p>

<p>if runqempty(<em>p</em>) &amp;&amp; atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) &gt; 0 &amp;&amp; pd.syscallwhen+10<em>1000</em>1000 &gt; now {</p>

<p>continue</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        }



        incidlelocked(-1)
</code></pre></div></div>

<p>if atomic.Cas(&amp;<em>p</em>.status, s, _Pidle) {</p>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            n++

            _p_.syscalltick++
</code></pre></div></div>

<p>// å¯»æ‰¾ä¸€æ–°çš„ m æ¥ç®¡ p</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            handoffp(_p_)

        }

        incidlelocked(1)

    } else if s == _Prunning {
</code></pre></div></div>

<p>// P å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ£€æŸ¥æ˜¯å¦è¿è¡Œå¾—å¤ªä¹…äº†</p>

<p>// Preempt G if itâ€™s running for too long.</p>

<p>// æ¯å‘ç”Ÿä¸€æ¬¡è°ƒåº¦ï¼Œè°ƒåº¦å™¨ ++ è¯¥å€¼</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        t := int64(_p_.schedtick)
</code></pre></div></div>

<p>if int64(pd.schedtick) != t {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            pd.schedtick = uint32(t)

            pd.schedwhen = now
</code></pre></div></div>

<p>continue</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        }
</code></pre></div></div>

<p>//pd.schedtick == t è¯´æ˜(pd.schedwhen ï½ now)è¿™æ®µæ—¶é—´æœªå‘ç”Ÿè¿‡è°ƒåº¦</p>

<p>// è¿™æ®µæ—¶é—´æ˜¯åŒä¸€ä¸ªgoroutineä¸€ç›´åœ¨è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦è¿ç»­è¿è¡Œè¶…è¿‡äº† 10 æ¯«ç§’</p>

<p>if pd.schedwhen+forcePreemptNS &gt; now {</p>

<p>continue</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        }
</code></pre></div></div>

<p>// è¿ç»­è¿è¡Œè¶…è¿‡ 10 æ¯«ç§’äº†ï¼Œå‘èµ·æŠ¢å è¯·æ±‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        preemptone(_p_)

    }

}
</code></pre></div></div>

<p>return uint32(n)</p>

<p>}</p>

<p>ä»ä»£ç æ¥çœ‹ï¼Œä¸»è¦ä¼šå¯¹å¤„äº _Psyscall å’Œ _Prunning çŠ¶æ€çš„ p è¿›è¡ŒæŠ¢å ã€‚</p>

<p>æŠ¢å è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„ P
å½“ P å¤„äº _Psyscall çŠ¶æ€æ—¶ï¼Œè¡¨æ˜å¯¹åº”çš„ goroutine æ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨ã€‚å¦‚æœæŠ¢å  pï¼Œéœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š</p>

<p>p çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰ç­‰å¾…è¿è¡Œçš„ goroutineã€‚è¿™æ—¶ p ç»‘å®šçš„ g æ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ— æ³•å»æ‰§è¡Œå…¶ä»–çš„ gï¼Œå› æ­¤éœ€è¦æ¥ç®¡ p æ¥æ‰§è¡Œå…¶ä»–çš„ gã€‚</p>

<p>æ²¡æœ‰â€œæ— æ‰€äº‹äº‹â€çš„ pã€‚sched.nmspinning å’Œ sched.npidle éƒ½ä¸º 0ï¼Œè¿™å°±æ„å‘³ç€æ²¡æœ‰â€œæ‰¾å·¥ä½œâ€çš„ mï¼Œä¹Ÿæ²¡æœ‰ç©ºé—²çš„ pï¼Œå¤§å®¶éƒ½åœ¨â€œå¿™â€ï¼Œå¯èƒ½æœ‰å¾ˆå¤šå·¥ä½œè¦åšã€‚å› æ­¤è¦æŠ¢å å½“å‰çš„ pï¼Œè®©å®ƒæ¥æ‰¿æ‹…ä¸€éƒ¨åˆ†å·¥ä½œã€‚</p>

<p>ä»ä¸Šä¸€æ¬¡ç›‘æ§çº¿ç¨‹è§‚å¯Ÿåˆ° p å¯¹åº”çš„ m å¤„äºç³»ç»Ÿè°ƒç”¨ä¹‹ä¸­åˆ°ç°åœ¨å·²ç»è¶…è¿‡ 10 æ¯«ç§’ã€‚è¿™è¯´æ˜ç³»ç»Ÿè°ƒç”¨æ‰€èŠ±è´¹çš„æ—¶é—´è¾ƒé•¿ï¼Œéœ€è¦å¯¹å…¶è¿›è¡ŒæŠ¢å ï¼Œä»¥æ­¤æ¥ä½¿å¾— retake å‡½æ•°è¿”å›å€¼ä¸ä¸º 0ï¼Œè¿™æ ·ï¼Œä¼šä¿æŒ sysmon çº¿ç¨‹ 20 us çš„æ£€æŸ¥å‘¨æœŸï¼Œæé«˜ sysmon ç›‘æ§çš„å®æ—¶æ€§ã€‚</p>

<p>æ³¨æ„ï¼ŒåŸä»£ç æ˜¯ç”¨çš„ä¸‰ä¸ªä¸æ¡ä»¶ï¼Œä¸‰è€…éƒ½è¦æ»¡è¶³æ‰ä¼šæ‰§è¡Œä¸‹é¢çš„ continueï¼Œä¹Ÿå°±æ˜¯ä¸è¿›è¡ŒæŠ¢å ã€‚å› æ­¤è¦æƒ³è¿›è¡ŒæŠ¢å çš„è¯ï¼Œåªéœ€è¦ä¸‰ä¸ªæ¡ä»¶æœ‰ä¸€ä¸ªä¸æ»¡è¶³å°±è¡Œäº†ã€‚äºæ˜¯å°±æœ‰äº†ä¸Šè¿°ä¸‰ç§æƒ…å†µã€‚</p>

<p>ç¡®å®šè¦æŠ¢å å½“å‰ p åï¼Œå…ˆä½¿ç”¨åŸå­æ“ä½œå°† p çš„çŠ¶æ€ä¿®æ”¹ä¸º _Pidleï¼Œæœ€åè°ƒç”¨ handoffp è¿›è¡ŒæŠ¢å ã€‚</p>

<p>func handoffp(<em>p</em> *p) {</p>

<p>// å¦‚æœ p æœ¬åœ°æœ‰å·¥ä½œæˆ–è€…å…¨å±€æœ‰å·¥ä½œï¼Œéœ€è¦ç»‘å®šä¸€ä¸ª m</p>

<table>
  <tbody>
    <tr>
      <td>if !runqempty(<em>p</em>)</td>
      <td>Â </td>
      <td>sched.runqsize != 0 {</td>
    </tr>
  </tbody>
</table>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    startm(_p_, false)
</code></pre></div></div>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// æ‰€æœ‰å…¶å®ƒ p éƒ½åœ¨è¿è¡Œ goroutineï¼Œè¯´æ˜ç³»ç»Ÿæ¯”è¾ƒå¿™ï¼Œéœ€è¦å¯åŠ¨ m</p>

<p>if atomic.Load(&amp;sched.nmspinning)+atomic.Load(&amp;sched.npidle) == 0 &amp;&amp; atomic.Cas(&amp;sched.nmspinning, 0, 1) { // TODO: fast atomic</p>

<p>// p æ²¡æœ‰æœ¬åœ°å·¥ä½œï¼Œå¯åŠ¨ä¸€ä¸ªè‡ªæ—‹ m æ¥æ‰¾å·¥ä½œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    startm(_p_, true)
</code></pre></div></div>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>lock(&amp;sched.lock)</p>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// å…¨å±€é˜Ÿåˆ—æœ‰å·¥ä½œ</p>

<p>if sched.runqsize != 0 {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    unlock(&amp;sched.lock)

    startm(_p_, false)
</code></pre></div></div>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// æ²¡æœ‰å·¥ä½œè¦å¤„ç†ï¼ŒæŠŠ p æ”¾å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pidleput(_p_)

unlock(&amp;sched.lock)
</code></pre></div></div>

<p>}</p>

<p>handoffp å†æ¬¡è¿›è¡Œåœºæ™¯åˆ¤æ–­ï¼Œä»¥è°ƒç”¨ startm å¯åŠ¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥ç»‘å®š pï¼Œä½¿å¾—æ•´ä½“å·¥ä½œç»§ç»­æ¨è¿›ã€‚</p>

<p>å½“ p çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æˆ–å…¨å±€è¿è¡Œé˜Ÿåˆ—é‡Œé¢æœ‰å¾…è¿è¡Œçš„ goroutineï¼Œè¯´æ˜è¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åšï¼Œè°ƒç”¨ startm(<em>p</em>,false) å¯åŠ¨ä¸€ä¸ª m æ¥ç»“åˆ pï¼Œç»§ç»­å·¥ä½œã€‚</p>

<p>å½“é™¤äº†å½“å‰çš„ p å¤–ï¼Œå…¶ä»–æ‰€æœ‰çš„ p éƒ½åœ¨è¿è¡Œ goroutineï¼Œè¯´æ˜å¤©ä¸‹å¤ªå¹³ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„äº‹åšï¼Œå”¯ç‹¬è‡ªå·±æ²¡æœ‰ã€‚ä¸ºäº†å…¨å±€æ›´å¿«åœ°å®Œæˆå·¥ä½œï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ª mï¼Œä¸”è¦ä½¿å¾— m å¤„äºè‡ªæ—‹çŠ¶æ€ï¼Œå’Œ p ç»“åˆä¹‹åï¼Œå°½å¿«æ‰¾åˆ°å·¥ä½œã€‚</p>

<p>æœ€åï¼Œå¦‚æœå®åœ¨æ²¡æœ‰å·¥ä½œè¦å¤„ç†ï¼Œå°±å°† p æ”¾å…¥å…¨å±€ç©ºé—²é˜Ÿåˆ—é‡Œã€‚</p>

<p>æˆ‘ä»¬æ¥ç€æ¥çœ‹ startm å‡½æ•°éƒ½åšäº†äº›ä»€ä¹ˆï¼š</p>

<p>// runtime/proc.go</p>

<p>//</p>

<p>// è°ƒç”¨ m æ¥ç»‘å®š pï¼Œå¦‚æœæ²¡æœ‰ mï¼Œé‚£å°±æ–°å»ºä¸€ä¸ª</p>

<p>// å¦‚æœ p ä¸ºç©ºï¼Œé‚£å°±å°è¯•è·å–ä¸€ä¸ªå¤„äºç©ºé—²çŠ¶æ€çš„ pï¼Œå¦‚æœæ‰¾åˆ° pï¼Œé‚£å°±ä»€ä¹ˆéƒ½ä¸åš</p>

<p>func startm(<em>p</em> *p, spinning bool) {</p>

<p>lock(&amp;sched.lock)</p>

<p>if <em>p</em> == nil {</p>

<p>// æ²¡æœ‰æŒ‡å®š p åˆ™éœ€è¦ä»å…¨å±€ç©ºé—²é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ª p</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    _p_ = pidleget()
</code></pre></div></div>

<p>if <em>p</em> == nil {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        unlock(&amp;sched.lock)
</code></pre></div></div>

<p>if spinning {</p>

<p>// å¦‚æœæ‰¾åˆ° pï¼Œæ”¾å¼ƒã€‚è¿˜åŸå…¨å±€å¤„äºè‡ªæ—‹çŠ¶æ€çš„ m çš„æ•°é‡</p>

<p>if int32(atomic.Xadd(&amp;sched.nmspinning, -1)) &lt; 0 {</p>

<p>throw(â€œstartm: negative nmspinningâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            }

        }
</code></pre></div></div>

<p>// æ²¡æœ‰ç©ºé—²çš„ pï¼Œç›´æ¥è¿”å›</p>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    }

}
</code></pre></div></div>

<p>// ä» m ç©ºé—²é˜Ÿåˆ—ä¸­è·å–æ­£å¤„äºç¡çœ ä¹‹ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œ</p>

<p>// æ‰€æœ‰å¤„äºç¡çœ çŠ¶æ€çš„ m éƒ½åœ¨æ­¤é˜Ÿåˆ—ä¸­</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp := mget()

unlock(&amp;sched.lock)
</code></pre></div></div>

<p>if mp == nil {</p>

<p>// å¦‚æœæ²¡æœ‰æ‰¾åˆ° m</p>

<p>var fn func()</p>

<p>if spinning {</p>

<p>// The caller incremented nmspinning, so set m.spinning in the new M.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fn = mspinning

    }
</code></pre></div></div>

<p>// åˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    newm(fn, _p_)
</code></pre></div></div>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>if mp.spinning {</p>

<p>throw(â€œstartm: m is spinningâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>if mp.nextp != 0 {</p>

<p>throw(â€œstartm: m has pâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>if spinning &amp;&amp; !runqempty(<em>p</em>) {</p>

<p>throw(â€œstartm: p has runnable gsâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// The caller incremented nmspinning, so set m.spinning in the new M.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp.spinning = spinning
</code></pre></div></div>

<p>// è®¾ç½® m é©¬ä¸Šè¦ç»“åˆçš„ p</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp.nextp.set(_p_)
</code></pre></div></div>

<p>// å”¤é†’ m</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>notewakeup(&amp;mp.park)
</code></pre></div></div>

<p>}</p>

<p>é¦–å…ˆå¤„ç† p ä¸ºç©ºçš„æƒ…å†µï¼Œç›´æ¥ä»å…¨å±€ç©ºé—² p é˜Ÿåˆ—é‡Œæ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚å¦‚æœè®¾ç½®äº† spinning ä¸º true çš„è¯ï¼Œè¿˜éœ€è¦è¿˜åŸå…¨å±€çš„å¤„äºè‡ªæ—‹çŠ¶æ€çš„ m çš„æ•°å€¼ï¼š&amp;sched.nmspinning ã€‚</p>

<p>æå®šäº† pï¼Œæ¥ä¸‹æ¥çœ‹ mã€‚å…ˆè°ƒç”¨ mget å‡½æ•°ä»å…¨å±€ç©ºé—²çš„ m é˜Ÿåˆ—é‡Œè·å–ä¸€ä¸ª mï¼Œå¦‚æœæ²¡æ‰¾åˆ° mï¼Œåˆ™è¦è°ƒç”¨ newm æ–°åˆ›å»ºä¸€ä¸ª mï¼Œå¹¶ä¸”å¦‚æœè®¾ç½®äº† spinning ä¸º true çš„è¯ï¼Œå…ˆè¦è®¾ç½®å¥½ mstartfnï¼š</p>

<p>func mspinning() { // startmâ€™s caller incremented nmspinning. Set the new Mâ€™s spinning.    getg().m.spinning = true}
è¿™æ ·ï¼Œå¯åŠ¨ m åï¼Œåœ¨ mstart1 å‡½æ•°é‡Œï¼Œè¿›å…¥ schedule å¾ªç¯å‰ï¼Œæ‰§è¡Œ mstartfn å‡½æ•°ï¼Œä½¿å¾— m å¤„äºè‡ªæ—‹çŠ¶æ€ã€‚</p>

<p>æ¥ä¸‹æ¥æ˜¯æ­£å¸¸æƒ…å†µä¸‹ï¼ˆæ‰¾åˆ°äº† p å’Œ mï¼‰çš„å¤„ç†ï¼š</p>

<p>mp.spinning = spinning// è®¾ç½® m é©¬ä¸Šè¦ç»“åˆçš„ pmp.nextp.set(<em>p</em>)// å”¤é†’ mnotewakeup(&amp;mp.park)
è®¾ç½® nextp ä¸ºæ‰¾åˆ°çš„ pï¼Œè°ƒç”¨ notewakeup å”¤é†’ mã€‚ä¹‹å‰æˆ‘ä»¬è®² findrunnable å‡½æ•°çš„æ—¶å€™ï¼Œå¯¹äºæœ€åæ²¡æœ‰æ‰¾åˆ°å·¥ä½œçš„ mï¼Œæˆ‘ä»¬è°ƒç”¨ notesleep(&amp;<em>g</em>.m.park)ï¼Œä½¿å¾— m è¿›å…¥ç¡çœ çŠ¶æ€ã€‚ç°åœ¨ç»ˆäºæœ‰å·¥ä½œäº†ï¼Œéœ€è¦è€å°†å‡ºå±±ï¼Œå°†å…¶å”¤é†’ï¼š</p>

<p>// src/runtime/lock_futex.gofunc notewakeup(n *note) { // è®¾ç½® n.key = 1, è¢«å”¤é†’çš„çº¿ç¨‹é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº 1 // æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’    old := atomic.Xchg(key32(&amp;n.key), 1) if old != 0 { print(â€œnotewakeup - double wakeup (â€œ, old, â€œ)\nâ€) throw(â€œnotewakeup - double wakeupâ€)    }    futexwakeup(key32(&amp;n.key), 1)}
notewakeup å‡½æ•°é¦–å…ˆä½¿ç”¨ atomic.Xchg è®¾ç½® note.key å€¼ä¸º 1ï¼Œè¿™æ˜¯ä¸ºäº†ä½¿è¢«å”¤é†’çš„çº¿ç¨‹å¯ä»¥é€šè¿‡æŸ¥çœ‹è¯¥å€¼æ˜¯å¦ç­‰äº 1 æ¥ç¡®å®šæ˜¯è¢«å…¶å®ƒçº¿ç¨‹å”¤é†’è¿˜æ˜¯æ„å¤–ä»ç¡çœ ä¸­è‹é†’äº†è¿‡æ¥ã€‚</p>

<p>å¦‚æœè¯¥å€¼ä¸º 1 åˆ™è¡¨ç¤ºæ˜¯è¢«å”¤é†’çš„ï¼Œå¯ä»¥ç»§ç»­å·¥ä½œï¼Œä½†å¦‚æœè¯¥å€¼ä¸º 0 åˆ™è¡¨ç¤ºæ˜¯æ„å¤–è‹é†’ï¼Œéœ€è¦å†æ¬¡è¿›å…¥ç¡çœ ã€‚</p>

<p>è°ƒç”¨ futexwakeup æ¥å”¤é†’å·¥ä½œçº¿ç¨‹ï¼Œå®ƒå’Œ futexsleep æ˜¯ç›¸å¯¹çš„ã€‚</p>

<p>func futexwakeup(addr *uint32, cnt uint32) {</p>

<p>// è°ƒç”¨ futex å‡½æ•°å”¤é†’å·¥ä½œçº¿ç¨‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ret := futex(unsafe.Pointer(addr), _FUTEX_WAKE, cnt, nil, nil, 0)
</code></pre></div></div>

<p>if ret &gt;= 0 {</p>

<p>return</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>}</p>

<p>futex ç”±æ±‡ç¼–è¯­è¨€å®ç°ï¼Œå‰é¢å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œå°±ä¸é‡å¤äº†ã€‚ä¸»è¦å†…å®¹å°±æ˜¯å…ˆå‡†å¤‡å¥½å‚æ•°ï¼Œç„¶åè¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œç”±å†…æ ¸å”¤é†’çº¿ç¨‹ã€‚</p>

<p>å†…æ ¸åœ¨å®Œæˆå”¤é†’å·¥ä½œä¹‹åå½“å‰å·¥ä½œçº¿ç¨‹ä»å†…æ ¸è¿”å›åˆ° futex å‡½æ•°ç»§ç»­æ‰§è¡Œ SYSCALL æŒ‡ä»¤ä¹‹åçš„ä»£ç å¹¶æŒ‰å‡½æ•°è°ƒç”¨é“¾åŸè·¯è¿”å›ï¼Œç»§ç»­æ‰§è¡Œå…¶å®ƒä»£ç ã€‚</p>

<p>è€Œè¢«å”¤é†’çš„å·¥ä½œçº¿ç¨‹åˆ™ç”±å†…æ ¸è´Ÿè´£åœ¨é€‚å½“çš„æ—¶å€™è°ƒåº¦åˆ° CPU ä¸Šè¿è¡Œã€‚</p>

<p>æŠ¢å é•¿æ—¶é—´è¿è¡Œçš„ P
æˆ‘ä»¬çŸ¥é“ï¼ŒGo scheduler é‡‡ç”¨çš„æ˜¯ä¸€ç§ç§°ä¸ºåä½œå¼çš„æŠ¢å å¼è°ƒåº¦ï¼Œå°±æ˜¯è¯´å¹¶ä¸å¼ºåˆ¶è°ƒåº¦ï¼Œå¤§å®¶ä¿æŒåä½œå…³ç³»ï¼Œäº’ç›¸ä¿¡ä»»ã€‚å¯¹äºé•¿æ—¶é—´è¿è¡Œçš„ Pï¼Œæˆ–è€…è¯´ç»‘å®šåœ¨ P ä¸Šçš„é•¿æ—¶é—´è¿è¡Œçš„ goroutineï¼Œsysmon ä¼šæ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œç„¶åè®¾ç½®ä¸€äº›æ ‡å¿—ï¼Œè¡¨ç¤º goroutine è‡ªå·±è®©å‡º CPU çš„æ‰§è¡Œæƒï¼Œç»™å…¶ä»– goroutine ä¸€äº›æœºä¼šã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æå½“ P å¤„äº _Prunning çŠ¶æ€çš„æƒ…å†µã€‚sysmon æ‰«ææ¯ä¸ª p æ—¶ï¼Œéƒ½ä¼šè®°å½•ä¸‹å½“å‰è°ƒåº¦å™¨è°ƒåº¦çš„æ¬¡æ•°å’Œå½“å‰æ—¶é—´ï¼Œæ•°æ®è®°å½•åœ¨ç»“æ„ä½“ï¼š</p>

<p>type sysmontick struct {    schedtick   uint32    schedwhen   int64    syscalltick uint32    syscallwhen int64}
å‰é¢ä¸¤ä¸ªå­—æ®µè®°å½•è°ƒåº¦å™¨è°ƒåº¦çš„æ¬¡æ•°å’Œæ—¶é—´ï¼Œåé¢ä¸¤ä¸ªå­—æ®µè®°å½•ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°å’Œæ—¶é—´ã€‚</p>

<p>åœ¨ä¸‹ä¸€æ¬¡æ‰«ææ—¶ï¼Œå¯¹æ¯” sysmon è®°å½•ä¸‹çš„ p çš„è°ƒåº¦æ¬¡æ•°å’Œæ—¶é—´ï¼Œä¸å½“å‰ p è‡ªå·±è®°å½•ä¸‹çš„è°ƒåº¦æ¬¡æ•°å’Œæ—¶é—´å¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ã€‚è¯´æ˜ P åœ¨è¿™ä¸€æ®µæ—¶é—´å†…ä¸€ç›´åœ¨è¿è¡ŒåŒä¸€ä¸ª goroutineã€‚é‚£å°±æ¥è®¡ç®—ä¸€ä¸‹è¿è¡Œæ—¶é—´æ˜¯å¦å¤ªé•¿äº†ã€‚</p>

<p>å¦‚æœå‘ç°è¿è¡Œæ—¶é—´è¶…è¿‡äº† 10 msï¼Œåˆ™è¦è°ƒç”¨ preemptone(<em>p</em>) å‘èµ·æŠ¢å çš„è¯·æ±‚ï¼š</p>

<p>func preemptone(<em>p</em> *p) bool {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mp := _p_.m.ptr()
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>if mp == nil</td>
      <td>Â </td>
      <td>mp == getg().m {</td>
    </tr>
  </tbody>
</table>

<p>return false</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// è¢«æŠ¢å çš„ goroutine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp := mp.curg
</code></pre></div></div>

<table>
  <tbody>
    <tr>
      <td>if gp == nil</td>
      <td>Â </td>
      <td>gp == mp.g0 {</td>
    </tr>
  </tbody>
</table>

<p>return false</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// è®¾ç½®æŠ¢å æ ‡å¿—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp.preempt = true
</code></pre></div></div>

<p>// åœ¨ goroutine å†…éƒ¨çš„æ¯æ¬¡è°ƒç”¨éƒ½ä¼šæ¯”è¾ƒæ ˆé¡¶æŒ‡é’ˆå’Œ g.stackguard0ï¼Œ</p>

<p>// æ¥åˆ¤æ–­æ˜¯å¦å‘ç”Ÿäº†æ ˆæº¢å‡ºã€‚stackPreempt éå¸¸å¤§çš„ä¸€ä¸ªæ•°ï¼Œæ¯”ä»»ä½•æ ˆéƒ½å¤§</p>

<p>// stackPreempt = 0xfffffade</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp.stackguard0 = stackPreempt
</code></pre></div></div>

<p>return true</p>

<p>}</p>

<p>åŸºæœ¬ä¸Šåªæ˜¯å°† stackguard0 è®¾ç½®äº†ä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œè€Œæ£€æŸ¥ stackguard0 çš„åœ°æ–¹åœ¨å‡½æ•°è°ƒç”¨å‰çš„ä¸€æ®µæ±‡ç¼–ä»£ç é‡Œè¿›è¡Œã€‚</p>

<p>ä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<p>package main</p>

<p>import â€œfmtâ€</p>

<p>func main() {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println("hello qcrao.com!")
</code></pre></div></div>

<p>}</p>

<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>

<p>go tool compile -S main.go
å¾—åˆ°æ±‡ç¼–ä»£ç ï¼š</p>

<p>â€â€œ.main STEXT size=120 args=0x0 locals=0x48 0x0000 00000 (test26.go:5)  TEXT    â€œâ€œ.main(SB), $72-0 0x0000 00000 (test26.go:5)    MOVQ    (TLS), CX 0x0009 00009 (test26.go:5)    CMPQ    SP, 16(CX) 0x000d 00013 (test26.go:5)    JLS 113 0x000f 00015 (test26.go:5)    SUBQ    $72, SP 0x0013 00019 (test26.go:5)  MOVQ    BP, 64(SP) 0x0018 00024 (test26.go:5)  LEAQ    64(SP), BP 0x001d 00029 (test26.go:5)    FUNCDATA    $0, gclocalsÂ·69c1753bd5f81501d95132d08af04464(SB) 0x001d 00029 (test26.go:5)    FUNCDATA    $1, gclocalsÂ·e226d4ae4a7cad8835311c6a4683c14f(SB) 0x001d 00029 (test26.go:6)  MOVQ    $0, â€œâ€..autotmp_0+48(SP) 0x0026 00038 (test26.go:6)    MOVQ    $0, â€œâ€..autotmp_0+56(SP) 0x002f 00047 (test26.go:6)  LEAQ    type.string(SB), AX 0x0036 00054 (test26.go:6)  MOVQ    AX, â€œâ€..autotmp_0+48(SP) 0x003b 00059 (test26.go:6)  LEAQ    â€œâ€œ.statictmp_0(SB), AX 0x0042 00066 (test26.go:6)  MOVQ    AX, â€œâ€..autotmp_0+56(SP) 0x0047 00071 (test26.go:6)  LEAQ    â€œâ€..autotmp_0+48(SP), AX 0x004c 00076 (test26.go:6)  MOVQ    AX, (SP) 0x0050 00080 (test26.go:6)  MOVQ    $1, 8(SP) 0x0059 00089 (test26.go:6)    MOVQ    $1, 16(SP) 0x0062 00098 (test26.go:6)  PCDATA  $0, $1 0x0062 00098 (test26.go:6)  CALL    fmt.Println(SB) 0x0067 00103 (test26.go:7)  MOVQ    64(SP), BP 0x006c 00108 (test26.go:7)  ADDQ    $72, SP 0x0070 00112 (test26.go:7)    RET 0x0071 00113 (test26.go:7)    NOP 0x0071 00113 (test26.go:5)    PCDATA  $0, $-1 0x0071 00113 (test26.go:5)  CALL    runtime.morestack_noctxt(SB) 0x0076 00118 (test26.go:5)  JMP 0
ä»¥å‰çœ‹è¿™æ®µä»£ç çš„æ—¶å€™ä¼šç›´æ¥è·³è¿‡å‰é¢çš„å‡ è¡Œä»£ç ï¼Œçœ‹ä¸æ‡‚ã€‚è¿™æ¬¡èƒ½çœ‹æ‡‚äº†ï¼æ‰€ä»¥ï¼Œé‚£äº›æš‚æ—¶çœ‹ä¸æ‡‚çš„ï¼Œå…ˆæ”¾ä¸€æ”¾ï¼Œæ²¡å…³ç³»ï¼Œè®©å­å¼¹é£ä¸€ä¼šå„¿ï¼Œå¾ˆå¤šä¸œè¥¿å›è¿‡å¤´å†æ¥çœ‹å°±ä¼šè±ç„¶å¼€æœ—ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚</p>

<p>0x0000 00000 (test26.go:5)    MOVQ    (TLS), CX
å°†æœ¬åœ°å­˜å‚¨ tls ä¿å­˜åˆ° CX å¯„å­˜å™¨ä¸­ï¼Œï¼ˆTLSï¼‰è¡¨ç¤ºå®ƒæ‰€å…³è”çš„ gï¼Œè¿™é‡Œå°±æ˜¯å‰é¢æ‰€è®²åˆ°çš„ main gouroutineã€‚</p>

<p>0x0009 00009 (test26.go:5)    CMPQ    SP, 16(CX)
æ¯”è¾ƒ SP å¯„å­˜å™¨ï¼ˆä»£è¡¨å½“å‰ main goroutine çš„æ ˆé¡¶å¯„å­˜å™¨ï¼‰å’Œ 16(CX)ï¼Œæˆ‘ä»¬çœ‹ä¸‹ g ç»“æ„ä½“ï¼š</p>

<p>type g struct { // goroutine ä½¿ç”¨çš„æ ˆ    stack       stack   // offset known to runtime/cgo // ç”¨äºæ ˆçš„æ‰©å¼ å’Œæ”¶ç¼©æ£€æŸ¥    stackguard0 uintptr // offset known to liblink // â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦}
å¯¹è±¡ g çš„ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯ stack ç»“æ„ä½“ï¼š</p>

<p>type stack struct {    lo uintptr    hi uintptr}
å…± 16 å­—èŠ‚ã€‚è€Œ 16(CX) è¡¨ç¤º g å¯¹è±¡çš„ç¬¬ 16 ä¸ªå­—èŠ‚ï¼Œè·³è¿‡äº† g çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå°±æ˜¯ g.stackguard0 å­—æ®µã€‚</p>

<p>å¦‚æœ SP å°äº g.stackguard0ï¼Œè¿™æ˜¯å¿…ç„¶çš„ï¼Œå› ä¸ºå‰é¢å·²ç»æŠŠ g.stackguard0 è®¾ç½®æˆäº†ä¸€ä¸ªéå¸¸å¤§çš„å€¼ï¼Œå› æ­¤è·³è½¬åˆ°äº† 113 è¡Œã€‚</p>

<p>0x0071 00113 (test26.go:7)    NOP0x0071 00113 (test26.go:5)    PCDATA  $0, $-10x0071 00113 (test26.go:5)    CALL    runtime.morestack_noctxt(SB)0x0076 00118 (test26.go:5)    JMP 0
è°ƒç”¨ runtime.morestack_noctxt å‡½æ•°ï¼š</p>

<p>// src/runtime/asm_amd64.sTEXT runtimeÂ·morestack_noctxt(SB),NOSPLIT,$0    MOVL    $0, DX    JMP runtimeÂ·morestack(SB)
ç›´æ¥è·³è½¬åˆ° morestack å‡½æ•°ï¼š</p>

<p>TEXT runtimeÂ·morestack(SB),NOSPLIT,$0-0</p>

<p>// Cannot grow scheduler stack (m-&gt;g0).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>get_tls(CX)
</code></pre></div></div>

<p>// BX = gï¼Œg è¡¨ç¤º main goroutine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    g(CX), BX
</code></pre></div></div>

<p>// BX = g.m</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    g_m(BX), BX
</code></pre></div></div>

<p>// SI = g.m.g0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    m_g0(BX), SI

CMPQ    g(CX), SI

JNE    3(PC)

CALL    runtimeÂ·badmorestackg0(SB)

INT    $3
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// Set g-&gt;sched to context in f.</p>

<p>// å°†å‡½æ•°çš„è¿”å›åœ°å€ä¿å­˜åˆ° AX å¯„å­˜å™¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    0(SP), AX // f's PC
</code></pre></div></div>

<p>// å°†å‡½æ•°çš„è¿”å›åœ°å€ä¿å­˜åˆ° g.sched.pc</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    AX, (g_sched+gobuf_pc)(SI)
</code></pre></div></div>

<p>// g.sched.g = g</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    SI, (g_sched+gobuf_g)(SI)
</code></pre></div></div>

<p>// å–åœ°å€æ“ä½œç¬¦ï¼Œè°ƒç”¨ morestack_noctxt ä¹‹å‰çš„ rsp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LEAQ    8(SP), AX // f's SP
</code></pre></div></div>

<p>// å°† main å‡½æ•°çš„æ ˆé¡¶åœ°å€ä¿å­˜åˆ° g.sched.sp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    AX, (g_sched+gobuf_sp)(SI)
</code></pre></div></div>

<p>// å°† BP å¯„å­˜å™¨ä¿å­˜åˆ° g.sched.bp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    BP, (g_sched+gobuf_bp)(SI)
</code></pre></div></div>

<p>// newstack will fill gobuf.ctxt.</p>

<p>// Call newstack on m-&gt;g0â€™s stack.</p>

<p>// BX = g.m.g0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    m_g0(BX), BX
</code></pre></div></div>

<p>// å°† g0 ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ tls</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    BX, g(CX)
</code></pre></div></div>

<p>// æŠŠ g0 æ ˆçš„æ ˆé¡¶å¯„å­˜å™¨çš„å€¼æ¢å¤åˆ° CPU çš„å¯„å­˜å™¨ SPï¼Œè¾¾åˆ°åˆ‡æ¢æ ˆçš„ç›®çš„ï¼Œä¸‹é¢è¿™ä¸€æ¡æŒ‡ä»¤æ‰§è¡Œä¹‹å‰ï¼Œ</p>

<p>// CPU è¿˜æ˜¯ä½¿ç”¨çš„è°ƒç”¨æ­¤å‡½æ•°çš„ g çš„æ ˆï¼Œæ‰§è¡Œä¹‹å CPU å°±å¼€å§‹ä½¿ç”¨ g0 çš„æ ˆäº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MOVQ    (g_sched+gobuf_sp)(BX), SP
</code></pre></div></div>

<p>// å‡†å¤‡å‚æ•°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PUSHQ   DX  // ctxt argument
</code></pre></div></div>

<p>// ä¸è¿”å›</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CALL    runtimeÂ·newstack(SB)

MOVQ    $0, 0x1003 // crash if newstack returns

POPQ    DX  // keep balance check happy

RET
</code></pre></div></div>

<p>ä¸»è¦åšçš„å·¥ä½œå°±æ˜¯å°†å½“å‰ goroutineï¼Œä¹Ÿå°±æ˜¯ main goroutine çš„å’Œè°ƒåº¦ç›¸å…³çš„ä¿¡æ¯ä¿å­˜åˆ° g.sched ä¸­ï¼Œä»¥ä¾¿åœ¨è°ƒåº¦åˆ°å®ƒæ‰§è¡Œæ—¶ï¼Œå¯ä»¥æ¢å¤ã€‚</p>

<p>æœ€åï¼Œå°† g0 çš„åœ°å€ä¿å­˜åˆ° tls æœ¬åœ°å­˜å‚¨ï¼Œå¹¶ä¸”åˆ‡åˆ° g0 æ ˆæ‰§è¡Œä¹‹åçš„ä»£ç ã€‚ç»§ç»­è°ƒç”¨ newstack å‡½æ•°ï¼š</p>

<p>func newstack(ctxt unsafe.Pointer) {</p>

<p>// thisg = g0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>thisg := getg()
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// gp = main goroutine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp := thisg.m.curg
</code></pre></div></div>

<p>// Write ctxt to gp.sched. We do this here instead of in</p>

<p>// morestack so it has the necessary write barrier.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp.sched.ctxt = ctxt
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>morebuf := thisg.m.morebuf

thisg.m.morebuf.pc = 0

thisg.m.morebuf.lr = 0

thisg.m.morebuf.sp = 0

thisg.m.morebuf.g = 0
</code></pre></div></div>

<p>// æ£€æŸ¥ g.stackguard0 æ˜¯å¦è¢«è®¾ç½®æˆæŠ¢å æ ‡å¿—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>preempt := atomic.Loaduintptr(&amp;gp.stackguard0) == stackPreempt
</code></pre></div></div>

<p>if preempt {</p>

<table>
  <tbody>
    <tr>
      <td>if thisg.m.locks != 0</td>
      <td>Â </td>
      <td>thisg.m.mallocing != 0</td>
      <td>Â </td>
      <td>thisg.m.preemptoff != â€œâ€</td>
      <td>Â </td>
      <td>thisg.m.p.ptr().status != _Prunning {</td>
    </tr>
  </tbody>
</table>

<p>// è¿˜åŸ stackguard0 ä¸ºæ­£å¸¸å€¼ï¼Œè¡¨ç¤ºæˆ‘ä»¬å·²ç»å¤„ç†è¿‡æŠ¢å è¯·æ±‚äº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        gp.stackguard0 = gp.stack.lo + _StackGuard
</code></pre></div></div>

<p>// ä¸æŠ¢å ï¼Œè°ƒç”¨ gogo ç»§ç»­è¿è¡Œå½“å‰è¿™ä¸ª gï¼Œä¸éœ€è¦è°ƒç”¨ schedule å‡½æ•°å»æŒ‘é€‰å¦ä¸€ä¸ª goroutine</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        gogo(&amp;gp.sched) // never return

    }

}
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>if preempt {</p>

<p>if gp == thisg.m.g0 {</p>

<p>throw(â€œruntime: preempt g0â€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    }
</code></pre></div></div>

<p>if thisg.m.p == 0 &amp;&amp; thisg.m.locks == 0 {</p>

<p>throw(â€œruntime: g is running but p is notâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    }
</code></pre></div></div>

<p>// Synchronize with scang.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    casgstatus(gp, _Grunning, _Gwaiting)
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>// Act like goroutine called runtime.Gosched.</p>

<p>// ä¿®æ”¹ä¸º runningï¼Œè°ƒåº¦èµ·æ¥è¿è¡Œ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    casgstatus(gp, _Gwaiting, _Grunning)
</code></pre></div></div>

<p>// è°ƒç”¨ gopreempt_m æŠŠ gp åˆ‡æ¢å‡ºå»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    gopreempt_m(gp) // never return

}
</code></pre></div></div>

<p>// â€¦â€¦â€¦â€¦â€¦â€¦â€¦â€¦</p>

<p>}</p>

<p>å»æ‰äº†å¾ˆå¤šæš‚æ—¶è¿˜çœ‹ä¸æ‡‚çš„åœ°æ–¹ï¼Œç•™åˆ°åé¢å†ç ”ç©¶ã€‚åªå…³æ³¨æœ‰å…³æŠ¢å ç›¸å…³çš„ã€‚ç¬¬ä¸€æ¬¡åˆ¤æ–­ preempt æ ‡å¿—æ˜¯ true æ—¶ï¼Œæ£€æŸ¥äº† g çš„çŠ¶æ€ï¼Œå‘ç°ä¸èƒ½æŠ¢å ï¼Œä¾‹å¦‚å®ƒæ‰€ç»‘å®šçš„ P çš„çŠ¶æ€ä¸æ˜¯_Prunningï¼Œé‚£å°±æ¢å¤å®ƒçš„ stackguard0 å­—æ®µï¼Œä¸‹æ¬¡å°±ä¸ä¼šèµ°è¿™ä¸€å¥—æµç¨‹äº†ã€‚ç„¶åï¼Œè°ƒç”¨ gogo(&amp;gp.sched) ç»§ç»­æ‰§è¡Œå½“å‰çš„ goroutineã€‚</p>

<p>ä¸­é—´åˆå¤„ç†äº†å¾ˆå¤šåˆ¤æ–­æµç¨‹ï¼Œå†æ¬¡åˆ¤æ–­ preempt æ ‡å¿—æ˜¯ true æ—¶ï¼Œè°ƒç”¨ gopreempt_m(gp) å°† gp åˆ‡æ¢å‡ºå»ã€‚</p>

<p>func gopreempt_m(gp *g) { if trace.enabled {        traceGoPreempt()    }    goschedImpl(gp)}
æœ€ç»ˆè°ƒç”¨ goschedImpl å‡½æ•°ï¼š</p>

<p>func goschedImpl(gp *g) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>status := readgstatus(gp)
</code></pre></div></div>

<p>if status&amp;^_Gscan != _Grunning {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    dumpgstatus(gp)
</code></pre></div></div>

<p>throw(â€œbad g statusâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>}
</code></pre></div></div>

<p>// æ›´æ”¹ gp çš„çŠ¶æ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>casgstatus(gp, _Grunning, _Grunnable)
</code></pre></div></div>

<p>// è§£é™¤ m å’Œ g çš„å…³ç³»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dropg()
</code></pre></div></div>

<p>lock(&amp;sched.lock)</p>

<p>// å°† gp æ”¾å…¥å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>globrunqput(gp)

unlock(&amp;sched.lock)
</code></pre></div></div>

<p>// è¿›å…¥æ–°ä¸€è½®çš„è°ƒåº¦å¾ªç¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>schedule()
</code></pre></div></div>

<p>}</p>

<p>å°† gp çš„çŠ¶æ€æ”¹ä¸º _Grunnableï¼Œæ”¾å…¥å…¨å±€å¯è¿è¡Œé˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹æ¬¡æœ‰ m æ¥å…¨å±€é˜Ÿåˆ—æ‰¾å·¥ä½œæ—¶æ‰èƒ½ç»§ç»­è¿è¡Œï¼Œæ¯•ç«Ÿä½ å·²ç»è¿è¡Œè¿™ä¹ˆé•¿æ—¶é—´äº†ï¼Œç»™åˆ«äººä¸€ç‚¹æœºä¼šå˜›ã€‚</p>

<p>æœ€åï¼Œè°ƒç”¨ schedule() å‡½æ•°è¿›å…¥æ–°ä¸€è½®çš„è°ƒåº¦å¾ªç¯ï¼Œä¼šæ‰¾å‡ºä¸€ä¸ª goroutine æ¥è¿è¡Œï¼Œæ°¸ä¸è¿”å›ã€‚</p>

<p>è¿™æ ·ï¼Œå…³äº sysmon çº¿ç¨‹åœ¨å…³äºè°ƒåº¦è¿™å—åˆ°åº•åšäº†å•¥ï¼Œæˆ‘ä»¬å·²ç»å›ç­”å®Œäº†ã€‚æ€»ç»“ä¸€ä¸‹ï¼š</p>

<p>æŠ¢å å¤„äºç³»ç»Ÿè°ƒç”¨çš„ Pï¼Œè®©å…¶ä»– m æ¥ç®¡å®ƒï¼Œä»¥è¿è¡Œå…¶ä»–çš„ goroutineã€‚</p>

<p>å°†è¿è¡Œæ—¶é—´è¿‡é•¿çš„ goroutine è°ƒåº¦å‡ºå»ï¼Œç»™å…¶ä»– goroutine è¿è¡Œçš„æœºä¼šã€‚</p>

<p>æ·±å…¥Golangä¹‹goroutineã€‘http://www.opscoder.info/golang_goroutine.html
ã€é˜¿æ³¢å¼  å·¥ä½œçº¿ç¨‹çš„å”¤é†’åŠåˆ›å»ºã€‘https://mp.weixin.qq.com/s/T9CDaNF5KUFjE_Z6YW7mRw</p>

<p>http://www.imooc.com/article/292206
https://xargin.com/go-scheduler/
https://blog.csdn.net/u010853261/article/details/84901386
https://blog.csdn.net/u010853261/article/details/84790392</p>

:ET