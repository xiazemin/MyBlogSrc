I"Ä"<p>kubectl port-forward POD [LOCAL_PORT:]REMOTE_PORT [â€¦[LOCAL_PORT_N:]REMOTE_PORT_N]</p>

<p>http://kubernetes.kansea.com/docs/user-guide/kubectl/kubectl_port-forward/</p>

<p>å°†æœ¬åœ°ç«¯å£è½¬å‘åˆ° Pod ä¸­çš„ç«¯å£
å°†æœ¬åœ°å·¥ä½œç«™ä¸Šçš„ 6379 ç«¯å£è½¬å‘åˆ° redis-master pod çš„ 6379 ç«¯å£ï¼š</p>

<p>kubectl port-forward redis-master 6379:6379</p>

<p>https://jimmysong.io/kubernetes-handbook/guide/connecting-to-applications-port-forward.html
<!-- more -->
è½¬å‘ä¸€ä¸ªæœ¬åœ°ç«¯å£åˆ° pod ç«¯å£
ä» Kubernetes v1.10 å¼€å§‹ï¼Œkubectl port-forward å…è®¸ä½¿ç”¨èµ„æºåç§° ï¼ˆä¾‹å¦‚ pod åç§°ï¼‰æ¥é€‰æ‹©åŒ¹é…çš„ pod æ¥è¿›è¡Œç«¯å£è½¬å‘ã€‚</p>

<p>kubectl port-forward redis-master-765d459796-258hz 7000:6379 
è¿™ç›¸å½“äº</p>

<p>kubectl port-forward pods/redis-master-765d459796-258hz 7000:6379
æˆ–è€…</p>

<p>kubectl port-forward deployment/redis-master 7000:6379 
æˆ–è€…</p>

<p>kubectl port-forward rs/redis-master 7000:6379
æˆ–è€…</p>

<p>kubectl port-forward svc/redis-master 7000:redis
ä»¥ä¸Šæ‰€æœ‰å‘½ä»¤éƒ½åº”è¯¥æœ‰æ•ˆã€‚è¾“å‡ºåº”è¯¥ç±»ä¼¼äºï¼š</p>

<p>Forwarding from 127.0.0.1:7000 -&gt; 6379
Forwarding from [::1]:7000 -&gt; 6379</p>

<p>https://kubernetes.io/zh/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</p>

<p>https://kubernetes.io/zh/docs/tasks/debug-application-cluster/local-debugging/</p>

<p>å¼€å‘å’Œè°ƒè¯•ç°æœ‰çš„æœåŠ¡
åœ¨ Kubernetes ä¸Šå¼€å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œé€šå¸¸å¯¹å•ä¸ªæœåŠ¡è¿›è¡Œç¼–ç¨‹æˆ–è°ƒè¯•ã€‚ æœåŠ¡å¯èƒ½éœ€è¦è®¿é—®å…¶ä»–æœåŠ¡ä»¥è¿›è¡Œæµ‹è¯•å’Œè°ƒè¯•ã€‚ ä¸€ç§é€‰æ‹©æ˜¯ä½¿ç”¨è¿ç»­éƒ¨ç½²æµæ°´çº¿ï¼Œä½†å³ä½¿æœ€å¿«çš„éƒ¨ç½²æµæ°´çº¿ä¹Ÿä¼šåœ¨ç¨‹åºæˆ–è°ƒè¯•å‘¨æœŸä¸­å¼•å…¥å»¶è¿Ÿã€‚</p>

<p>ä½¿ç”¨ â€“swap-deployment é€‰é¡¹å°†ç°æœ‰éƒ¨ç½²ä¸ Telepresence ä»£ç†äº¤æ¢ã€‚ äº¤æ¢å…è®¸ä½ åœ¨æœ¬åœ°è¿è¡ŒæœåŠ¡å¹¶èƒ½å¤Ÿè¿æ¥åˆ°è¿œç«¯çš„ Kubernetes é›†ç¾¤ã€‚ è¿œç«¯é›†ç¾¤ä¸­çš„æœåŠ¡ç°åœ¨å°±å¯ä»¥è®¿é—®æœ¬åœ°è¿è¡Œçš„å®ä¾‹ã€‚</p>

<p>è¦è¿è¡Œ telepresence å¹¶å¸¦æœ‰ â€“swap-deployment é€‰é¡¹ï¼Œè¯·è¾“å…¥ï¼š</p>

<p>telepresence â€“swap-deployment $DEPLOYMENT_NAME</p>

<p>è¿™é‡Œçš„ $DEPLOYMENT_NAME æ˜¯ä½ ç°æœ‰çš„éƒ¨ç½²åç§°ã€‚</p>

<p>è¿è¡Œæ­¤å‘½ä»¤å°†ç”Ÿæˆ Shellã€‚åœ¨è¯¥ Shell ä¸­ï¼Œå¯åŠ¨ä½ çš„æœåŠ¡ã€‚ ç„¶åï¼Œä½ å°±å¯ä»¥åœ¨æœ¬åœ°å¯¹æºä»£ç è¿›è¡Œç¼–è¾‘ã€ä¿å­˜å¹¶èƒ½çœ‹åˆ°æ›´æ”¹ç«‹å³ç”Ÿæ•ˆã€‚ ä½ è¿˜å¯ä»¥åœ¨è°ƒè¯•å™¨æˆ–ä»»ä½•å…¶ä»–æœ¬åœ°å¼€å‘å·¥å…·ä¸­è¿è¡ŒæœåŠ¡</p>

<p>https://cloud.google.com/community/tutorials/developing-services-with-k8s</p>

<p>https://github.com/telepresenceio/telepresence</p>

<p>telepresenceçš„åŸç†ï¼Œæœ¬è´¨ä¸Šæ˜¯åå°è°ƒç”¨kubectlä¸dockerå‘½ä»¤ï¼Œå› ä¸ºkube-configä¸­å®šä¹‰äº†é›†ç¾¤åœ°å€åŠè®¿é—®æ–¹å¼ï¼Œå› æ­¤è¾¾åˆ°ç›´è¿k8sé›†ç¾¤çš„ç›®çš„ã€‚</p>

<p>å®¢æˆ·ç«¯åœ¨ä½¿ç”¨telepresenceå‘½ä»¤æ—¶ï¼Œå®ƒä¼šåœ¨è¿œç«¯é›†ç¾¤ä¸­ä»¥ç‰¹å®šçš„é•œåƒ(datawire/telepresence-k8s)å¯åŠ¨deploymentå’Œserviceèµ„æºï¼Œ
å¹¶ä¸”ç›‘å¬å‚æ•°ä¸­æŒ‡å®šçš„ä¸€ä¸ªç«¯å£ã€‚</p>

<p>æ¯ä¸ªtelepresenceå®ä¾‹éƒ½åœ¨é›†ç¾¤å¯åŠ¨çš„å®¹å™¨èµ„æºè¢«é™åˆ¶åœ¨cpu(25m~100m)ï¼Œå†…å­˜(64M~256M)ã€‚</p>

<p>å½“æœ¬åœ°å¯åŠ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”æš´éœ²çš„æ˜¯ä¸Šè¿°ç›‘å¬çš„ç«¯å£å·ï¼Œåˆ™telepresenceå°†æœ¬åœ°è¯¥ç«¯å£ä¸Šçš„æµé‡ä»£ç†åˆ°k8sé›†ç¾¤ä¸­ï¼Œ
å°±å¥½åƒè¿™ä¸ªåº”ç”¨æ˜¯è¿è¡Œåœ¨é›†ç¾¤å†…éƒ¨ä¸€æ ·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨é›†ç¾¤ä¸­å…¶å®ƒserviceåç§°æ¥è®¿é—®ã€‚</p>

<p>telepresenceæä¾›äº†ä¸‰ç§æ–¹å¼æ¥å»ºç«‹ä»£ç†é€šé“ï¼Œå„æœ‰é™åˆ¶ï¼š</p>

<p>Â </p>

<p>vpn-tcp: ä½¿ç”¨å«sshuttleçš„ç¨‹åºï¼Œé€šè¿‡SSHè¿æ¥æ¥å»ºç«‹ä¸€ç§ç±»VPNé€šé“ã€‚
é™åˆ¶ï¼šÂ Â  ä¸€å°æœºå­åªèƒ½ä½¿ç”¨ä¸€ä¸ªtelepresenceå®ä¾‹;</p>

<p>Â Â Â Â  åªèƒ½è§£æè¯¸å¦‚ <em>servicename\servicename.namespace</em> è¿™ç§åŸŸåï¼Œè€Œæ— æ³•è§£æk8sä¸­çš„å®Œæ•´åŸŸåå¦‚<em>servicename.namespace.svc.cluster.local</em></p>

<p>Â Â Â Â Â Â Â Â Â Â  å•å°æœºå­åªèƒ½å•å®ä¾‹è¿è¡Œçš„é™åˆ¶ï¼Œå®˜ç½‘å»ºè®®é€šè¿‡ inject-tcp çš„æ–¹å¼æ¥è¿è¡Œå¤šå®ä¾‹</p>

<p>Â </p>

<p>inject-tcp: ä½¿ç”¨ä¸€ç§å« LD_PRELOAD/DYLD_INSERT_LIBRARIES çš„æœºåˆ¶ï¼Œé€šè¿‡TCPè¿æ¥æ¥æ³¨å…¥ä¸€äº›å…±äº«åº“ã€‚
é™åˆ¶ï¼š suidç‰¹æƒçš„äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•è¿è¡Œç”Ÿæ•ˆï¼›</p>

<p>Â Â Â Â Â Â Â Â Â  é™æ€é“¾æ¥äºŒè¿›åˆ¶æ–‡ä»¶æ— æ³•è¿è¡Œç”Ÿæ•ˆï¼›</p>

<p>Â Â Â Â Â Â Â Â Â  éœ€è¦è§£ææ–‡ä»¶<em>/etc/resolv.conf</em>çš„å‘½ä»¤æ— æ³•ç”Ÿæ•ˆï¼Œå¦‚ping,nslookupç­‰ï¼›</p>

<p>Â Â Â Â Â Â Â Â  Golangç¨‹åºæ— æ³•è¿è¡Œï¼Œä»¥ä½ ä¸ºGoä½¿ç”¨äº†è‡ªå¸¦çš„dnsè§£æå™¨ï¼›å®˜ç½‘å»ºè®®Golangé€šè¿‡vpn-tcpæ–¹å¼ä»£ç†ï¼›</p>

<p>container: åŸºäºvpn-tcpï¼Œsshuttleè¿è¡Œäºå®¹å™¨å†…éƒ¨ã€‚</p>

<p>https://blog.csdn.net/a605692769/article/details/82257054</p>

<p>https://www.telepresence.io/discussion/how-it-works</p>

<p>æœ‰äº†è¿™äº›ä»£ç†ä¹‹åï¼š</p>

<p>æœ¬åœ°çš„æœåŠ¡å°±å¯ä»¥å®Œæ•´çš„è®¿é—®åˆ°è¿œç¨‹é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡ã€‚
æœ¬åœ°çš„æœåŠ¡ç›´æ¥è®¿é—®åˆ° Kubernetes é‡Œçš„å„ç§èµ„æºï¼ŒåŒ…æ‹¬ç¯å¢ƒå˜é‡ã€Secretsã€Config map ç­‰ã€‚
ç”šè‡³é›†ç¾¤ä¸­çš„æœåŠ¡è¿˜èƒ½ç›´æ¥è®¿é—®åˆ°æœ¬åœ°æš´éœ²å‡ºæ¥çš„æ¥å£ã€‚</p>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªæœåŠ¡ A å’Œ Bï¼ŒæœåŠ¡ A æ˜¯ä¾èµ–äºæœåŠ¡ B çš„</p>

<p>è°ƒè¯•æœåŠ¡ A</p>

<p>æœåŠ¡ A åœ¨æœ¬åœ°è¿è¡Œï¼ŒæœåŠ¡ B è¿è¡Œåœ¨è¿œç«¯é›†ç¾¤ä¸­ã€‚å€ŸåŠ© Telepresence æ­å»ºçš„ä»£ç†ï¼ŒA å°±èƒ½ç›´æ¥è®¿é—®åˆ° Bã€‚æ¯”æ–¹è¯´æˆ‘ä»¬çš„æœåŠ¡ B æ˜¯è¿™æ ·ä¸€ä¸ªç¨‹åºï¼Œå®ƒç›‘å¬åœ¨ 8000 ç«¯å£ä¸Šã€‚æ¯å½“æœ‰äººè®¿é—®æ—¶å®ƒå°±è¿”å› Hello, world! ã€‚</p>

<p>$ kubectl run service-b â€“image=datawire/hello-world â€“port=8000 â€“expose
$ kubectl get service service-b NAME        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGEservice-b   10.0.0.12    <none>        8000/TCP   1m</none></p>

<p>ç°åœ¨åœ¨æœ¬åœ°ç”¨é»˜è®¤å‚æ•°å¯åŠ¨ Telepresence ï¼Œç­‰å®ƒè¿æ¥å¥½é›†ç¾¤ï¼š</p>

<p>$ telepresenceT: Starting proxy with method â€˜V<strong>-tcpâ€™, which has the following limitations: All processes are affected, only one telepresence can run per machine, and youT: canâ€™t use other V</strong>s. You may need to add cloud hosts and headless services with â€“also-proxy. For a full list of method limitations seeT: https://telepresence.io/reference/methods.htmlT: Volumes are rooted at $TELEPRESENCE_ROOT. See https://telepresence.io/howto/volumes.html for details.T: Starting network proxy to cluster using new Deployment telepresence-1566230249-7112632-14485
T: No traffic is being forwarded from the remote Deployment to your local machine. You can use the â€“expose option to specify which ports you want toT: forward.
T: Setup complete. Launching your command.@test_cluster|bash-4.2#</p>

<p>è¿™æ—¶å€™å°±å¯ä»¥å¼€å§‹è°ƒè¯•æœåŠ¡ A äº†ï¼Œå› ä¸ºæœåŠ¡ B æš´éœ²å‡ºæ¥çš„æ¥å£æœ¬åœ°å·²ç»å¯ä»¥ç›´æ¥è®¿é—®åˆ°ï¼š</p>

<p>$ curl http://service-b:8000/Hello, world!</p>

<p>è¿™é‡Œè¦è¯´æ˜ä¸€ä¸‹è¿™èƒŒåå‘ç”Ÿçš„äº‹æƒ…ï¼š</p>

<p>å½“è¿è¡Œ Telepresence å‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒåˆ›å»ºäº†ä¸€ä¸ª Deploymentï¼Œè¿™ä¸ª Deployment åˆåˆ›å»ºäº†ä¸€ä¸ªç”¨æ¥åšä»£ç†çš„ Pod ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æŸ¥çœ‹åˆ°å®ƒ kubectl get pod -l telepresenceã€‚
åŒæ—¶å®ƒè¿˜åœ¨æœ¬åœ°åˆ›å»ºäº†ä¸€ä¸ªå…¨å±€çš„ V<strong>ï¼Œä½¿å¾—æœ¬åœ°çš„æ‰€æœ‰ç¨‹åºéƒ½å¯ä»¥è®¿é—®åˆ°é›†ç¾¤ä¸­çš„æœåŠ¡ã€‚Telepresence å…¶å®è¿˜æ”¯æŒå…¶ä»–çš„ç½‘ç»œä»£ç†æ¨¡å¼ï¼ˆä½¿ç”¨ â€“method åˆ‡æ¢ï¼‰ï¼ŒV</strong>-tcp æ˜¯é»˜è®¤çš„æ–¹å¼ï¼Œå…¶ä»–çš„å¥½åƒç”¨å¤„ä¸å¤§ï¼Œinject-tcp ç”šè‡³è¦åœ¨åç»­çš„ç‰ˆæœ¬ä¸­å–æ¶ˆæ‰ã€‚
å½“æœ¬åœ°çš„ curl è®¿é—® http://service-b:8000/ æ—¶ï¼Œå¯¹åº”çš„ DNS æŸ¥è¯¢å’Œ HTTP è¯·æ±‚éƒ½è¢« V** è·¯ç”±åˆ°é›†ç¾¤ä¸­åˆšåˆšåˆ›å»ºçš„ Pod å»å¤„ç†ã€‚
é™¤æ­¤ä¹‹å¤– Telepresence è¿˜å°†è¿œç«¯çš„æ–‡ä»¶ç³»ç»Ÿé€šè¿‡ sshfs æŒ‚è½½åˆ°æœ¬åœ° $TELEPRESENCE_ROOT ä¸‹é¢ï¼ˆä½ ä¹Ÿå¯ä»¥ç”¨å‚æ•° â€“mount <MOUNT_PATH> æŒ‡å®šæŒ‚è½½çš„è·¯å¾„ï¼‰ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±å¯ä»¥åœ¨æœ¬åœ°è®¿é—®åˆ°è¿œç¨‹çš„æ–‡ä»¶ç³»ç»Ÿï¼š</MOUNT_PATH></p>

<p>$ ls $TELEPRESENCE_ROOT/var/run/secrets/kubernetes.io/serviceaccountca.crt  namespace  token</p>

<p>å¦‚æœæˆ‘ä»¬é€€å‡º Telepresence å¯¹åº”çš„ Shellï¼Œå®ƒä¹Ÿä¼šåšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚å–æ¶ˆæœ¬åœ° V**ã€åˆ é™¤åˆšåˆšåˆ›å»ºçš„ Deployment ç­‰ã€‚</p>

<p>è°ƒè¯•æœåŠ¡ B</p>

<p>æœåŠ¡ B ä¸åˆšæ‰çš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒæ˜¯è¢«åˆ«äººè®¿é—®çš„ï¼Œè¦è°ƒè¯•å®ƒï¼Œé¦–å…ˆå¾—è¦æœ‰çœŸå®çš„è®¿é—®æµé‡ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½åšåˆ°å°†åˆ«äººå¯¹å®ƒçš„è®¿é—®è·¯ç”±åˆ°æœ¬åœ°æ¥ï¼Œä»è€Œå®ç°åœ¨æœ¬åœ°æ•æ‰åˆ°é›†ç¾¤ä¸­çš„æµé‡å‘¢ï¼Ÿ</p>

<p>Telepresence æä¾›è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼Œâ€“swap-deployment &lt;DEPLOYMENT_NAME[:CONTAINER]&gt;ï¼Œç”¨æ¥å°†é›†ç¾¤ä¸­çš„ä¸€ä¸ª Deployment æ›¿æ¢ä¸ºæœ¬åœ°çš„æœåŠ¡ã€‚å¯¹äºä¸Šé¢çš„ service-bï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ›¿æ¢ï¼š</p>

<p>$ telepresence â€“swap-deployment service-b â€“expose 8000:8000</p>

<p>è¿™ä¸ªæ—¶å€™é›†ç¾¤ä¸­çš„æœåŠ¡ A å†æƒ³è®¿é—®æœåŠ¡ B çš„ 8000 ç«¯å£æ—¶ï¼ŒTelepresence å°±ä¼šå°†è¿™ä¸ªè¯·æ±‚è½¬å‘åˆ°æœ¬åœ°çš„ 8000 ç«¯å£ã€‚å®ƒçš„å·¥ä½œåŸç†å°±æ˜¯å°†é›†ç¾¤ä¸­çš„ service-b æ›¿æ¢ä¸º Telepresence åˆ›å»ºçš„ Proxy ï¼Œç„¶åè¿™ä¸ª Proxy å†å°†è¯·æ±‚è½¬å‘åˆ°æœ¬åœ°å®¢æˆ·ç«¯ã€‚</p>

<p>https://cloud.tencent.com/developer/article/1537743</p>

<p>https://www.telepresence.io/</p>

<p>https://kubernetes.io/zh/docs/tasks/debug-application-cluster/local-debugging/</p>

:ET