I"’ <p>https://github.com/lizrice/containers-from-scratch/blob/master/main.go</p>

<p>ç›´æ¥dssh è¿è¡Œ
[root@25e1d9737615 containers-from-scratch]$ /home/go/bin/go run main.go run /bin/bash
Running [/bin/bash]
panic: fork/exec /proc/self/exe: operation not permitted</p>

<p>goroutine 1 [running]:
main.must(0x52f220, 0xc42000e480)
	/home/xiaoju/containers-from-scratch/main.go:74 +0x4a
main.run()</p>

<p>åŸå› ï¼šç”¨è‡ªå·±çš„å®¹å™¨ docker exec -it â€“privileged xxx bash</p>

<p>å…¬å¸çš„å®¹å™¨ ç”¨çš„æ˜¯dockerçš„é»˜è®¤rootæƒé™ï¼Œé˜‰å‰²ç‰ˆçš„ã€‚</p>

<p>https://github.com/google/gvisor/issues/144
<!-- more -->
Docker exec å‘½ä»¤ç”¨æ¥åœ¨å®¿ä¸»æœºç›´æ¥åœ¨å®¹å™¨å†…éƒ¨è¿è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œä¸éœ€è¦è¿›å…¥åˆ°å®¹å™¨ã€‚å¸®åŠ©ä¿¡æ¯å¦‚ä¸‹ï¼š</p>

<p>[root@localhost ~]# docker exec â€“help</p>

<p>Usage:  docker exec [OPTIONS] CONTAINER COMMAND [ARGâ€¦]</p>

<p>Run a command in a running container</p>

<p>Options:
  -d, â€“detach               Detached mode: run command in the background
      â€“detach-keys string   Override the key sequence for detaching a container
  -e, â€“env list             Set environment variables
  -i, â€“interactive          Keep STDIN open even if not attached
      â€“privileged           Give extended privileges to the command
  -t, â€“tty                  Allocate a pseudo-TTY
  -u, â€“user string          Username or UID (format: &lt;name|uid&gt;[:&lt;group|gid&gt;])
  -w, â€“workdir string       Working directory inside the container
å…¶ä¸­ï¼š</p>

<p>â€“detach-keys string è¦†ç›–ç”¨äºåˆ†ç¦»å®¹å™¨çš„é”®åºåˆ—</p>

<p>-e, â€“env list è®¾ç½®ç¯å¢ƒå˜é‡</p>

<p>-i, â€“interactive ä¿æŒSTDINæ‰“å¼€ï¼Œå³ä½¿æ²¡æœ‰è¿æ¥</p>

<p>â€“privileged ä¸ºè¯¥å‘½ä»¤æˆäºˆæ‰©å±•ç‰¹æƒ</p>

<p>-t, â€“tty åˆ†é…ä¸€ä¸ªpseudo-TTY</p>

<table>
  <tbody>
    <tr>
      <td>-u, â€“user string ç”¨æˆ·åæˆ–UID (æ ¼å¼: &lt;name</td>
      <td>uid&gt;[:&lt;group</td>
      <td>gid&gt;])</td>
    </tr>
  </tbody>
</table>

<p>-w, â€“workdir string å®¹å™¨å†…çš„å·¥ä½œç›®å½•</p>

<p>https://github.com/kubernetes-sigs/kind/issues/1458</p>

<p>// ç‰¹æƒæ¨¡å¼åˆ›å»ºå®¹å™¨
docker run -t -i â€“privileged -v /usr/java:/mnt â€“name ContainerName ImageId /usr/sbin/init
// é‡‡ç”¨hostç½‘ç»œæ¨¡å¼åˆ›å»ºå®¹å™¨
docker run -t -i -d â€“privileged -v /usr/java:/mnt â€“net=host â€“name Container ImageId /usr/sbin/init</p>

<p>privilegedå‚æ•°</p>

<p>$ docker help run 
â€¦
â€“privileged=false         Give extended privileges to this container
â€¦
å¤§çº¦åœ¨0.6ç‰ˆï¼Œprivilegedè¢«å¼•å…¥dockerã€‚
ä½¿ç”¨è¯¥å‚æ•°ï¼Œcontainerå†…çš„rootæ‹¥æœ‰çœŸæ­£çš„rootæƒé™ã€‚
å¦åˆ™ï¼Œcontainerå†…çš„rootåªæ˜¯å¤–éƒ¨çš„ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™ã€‚
privilegedå¯åŠ¨çš„å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šhostä¸Šçš„è®¾å¤‡ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œmountã€‚
ç”šè‡³å…è®¸ä½ åœ¨dockerå®¹å™¨ä¸­å¯åŠ¨dockerå®¹å™¨ã€‚</p>

<p>æœªè®¾ç½®privilegedå¯åŠ¨çš„å®¹å™¨ï¼š</p>

<p>[root@localhost ~]# docker run -t -i centos:latest bash
[root@65acccbba42f /]# ls /dev
console  fd  full  fuse  kcore  null  ptmx  pts  random  shm  stderr  stdin  stdout  tty  urandom  zero
[root@65acccbba42f /]# mkdir /home/test/
[root@65acccbba42f /]# mkdir /home/test2/
[root@65acccbba42f /]# mount -o bind /home/test  /home/test2
mount: permission denied
è®¾ç½®privilegedå¯åŠ¨çš„å®¹å™¨ï¼š</p>

<p>[root@localhost ~]# docker run -t -i â€“privileged centos:latest bash
[root@c39330902b45 /]# ls /dev/
autofs           dm-1  hidraw0       loop1               null    ptp3    sg0  shm       tty10  tty19  tty27  tty35  tty43  tty51  tty6   ttyS1    usbmon3  vcs5   vfio
bsg              dm-2  hidraw1       loop2               nvram   pts     sg1  snapshot  tty11  tty2   tty28  tty36  tty44  tty52  tty60  ttyS2    usbmon4  vcs6   vga_arbiter
btrfs-control    dm-3  hpet          loop3               oldmem  random  sg2  snd       tty12  tty20  tty29  tty37  tty45  tty53  tty61  ttyS3    usbmon5  vcsa   vhost-net
bus              dm-4  input         mapper              port    raw     sg3  stderr    tty13  tty21  tty3   tty38  tty46  tty54  tty62  uhid     usbmon6  vcsa1  watchdog
console          dm-5  kcore         mcelog              ppp     rtc0    sg4  stdin     tty14  tty22  tty30  tty39  tty47  tty55  tty63  uinput   vcs      vcsa2  watchdog0
cpu              dm-6  kmsg          mem                 ptmx    sda     sg5  stdout    tty15  tty23  tty31  tty4   tty48  tty56  tty7   urandom  vcs1     vcsa3  zero
cpu_dma_latency  fd    kvm           net                 ptp0    sda1    sg6  tty       tty16  tty24  tty32  tty40  tty49  tty57  tty8   usbmon0  vcs2     vcsa4
crash            full  loop-control  network_latency     ptp1    sda2    sg7  tty0      tty17  tty25  tty33  tty41  tty5   tty58  tty9   usbmon1  vcs3     vcsa5
dm-0             fuse  loop0         network_throughput  ptp2    sda3    sg8  tty1      tty18  tty26  tty34  tty42  tty50  tty59  ttyS0  usbmon2  vcs4     vcsa6
[root@c39330902b45 /]# mkdir /home/test/
[root@c39330902b45 /]# mkdir /home/test2/</p>

<p>[root@c39330902b45 /]# mount -o bind /home/test  /home/test2</p>

<p>â€“privilegeæ˜¯ä¸ºäº†ä¿®æ”¹ä¸€äº›å¦‚/etc/sysé‡Œé¢çš„æ–‡ä»¶çš„æ—¶å€™æ‰éœ€è¦çš„ï¼Œä½†æ­£å¸¸è¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œä¸å»ºè®®å¼€æ”¾è¿™ä¸ªæƒé™ã€‚</p>

<p>privilegedå‚æ•°
$ docker help run 
â€¦
â€“privileged=false         Give extended privileges to this container
â€¦
å¤§çº¦åœ¨0.6ç‰ˆï¼Œprivilegedè¢«å¼•å…¥dockerã€‚ä½¿ç”¨è¯¥å‚æ•°ï¼Œcontainerå†…çš„rootæ‹¥æœ‰çœŸæ­£çš„rootæƒé™ã€‚å¦åˆ™ï¼Œcontainerå†…çš„rootåªæ˜¯å¤–éƒ¨çš„ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™ã€‚privilegedå¯åŠ¨çš„å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šhostä¸Šçš„è®¾å¤‡ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œmountã€‚ç”šè‡³å…è®¸ä½ åœ¨dockerå®¹å™¨ä¸­å¯åŠ¨dockerå®¹å™¨ã€‚</p>

<p>æœªè®¾ç½®privilegedå¯åŠ¨çš„å®¹å™¨ï¼š</p>

<p>[root@xiexianbin_cn ~]# docker run -t -i centos:latest bash
[root@65acccbba42f /]# ls /dev
console  fd  full  fuse  kcore  null  ptmx  pts  random  shm  stderr  stdin  stdout  tty  urandom  zero
[root@65acccbba42f /]# mkdir /home/test/
[root@65acccbba42f /]# mkdir /home/test2/
[root@65acccbba42f /]# mount -o bind /home/test  /home/test2
mount: permission denied</p>

<p>è®¾ç½®privilegedå¯åŠ¨çš„å®¹å™¨ï¼š</p>

<p>[root@xiexianbin_cn ~]# docker run -t -i â€“privileged centos:latest bash
[root@c39330902b45 /]# ls /dev/
autofs           dm-1  hidraw0       loop1               null    ptp3    sg0  shm       tty10  tty19  tty27  tty35  tty43  tty51  tty6   ttyS1    usbmon3  vcs5   vfio
bsg              dm-2  hidraw1       loop2               nvram   pts     sg1  snapshot  tty11  tty2   tty28  tty36  tty44  tty52  tty60  ttyS2    usbmon4  vcs6   vga_arbiter
btrfs-control    dm-3  hpet          loop3               oldmem  random  sg2  snd       tty12  tty20  tty29  tty37  tty45  tty53  tty61  ttyS3    usbmon5  vcsa   vhost-net
bus              dm-4  input         mapper              port    raw     sg3  stderr    tty13  tty21  tty3   tty38  tty46  tty54  tty62  uhid     usbmon6  vcsa1  watchdog
console          dm-5  kcore         mcelog              ppp     rtc0    sg4  stdin     tty14  tty22  tty30  tty39  tty47  tty55  tty63  uinput   vcs      vcsa2  watchdog0
cpu              dm-6  kmsg          mem                 ptmx    sda     sg5  stdout    tty15  tty23  tty31  tty4   tty48  tty56  tty7   urandom  vcs1     vcsa3  zero
cpu_dma_latency  fd    kvm           net                 ptp0    sda1    sg6  tty       tty16  tty24  tty32  tty40  tty49  tty57  tty8   usbmon0  vcs2     vcsa4
crash            full  loop-control  network_latency     ptp1    sda2    sg7  tty0      tty17  tty25  tty33  tty41  tty5   tty58  tty9   usbmon1  vcs3     vcsa5
dm-0             fuse  loop0         network_throughput  ptp2    sda3    sg8  tty1      tty18  tty26  tty34  tty42  tty50  tty59  ttyS0  usbmon2  vcs4     vcsa6
[root@c39330902b45 /]# mkdir /home/test/
[root@c39330902b45 /]# mkdir /home/test2/
[root@c39330902b45 /]# mount -o bind /home/test  /home/test2</p>

<p>ï¼ˆåäºŒï¼‰docker â€“privileged</p>
<ol>
  <li>privilegedå‚æ•°ä½œç”¨
â€“privileged                     Give extended privileges to this container
å¤§çº¦åœ¨0.6ç‰ˆï¼Œprivilegedè¢«å¼•å…¥dockerã€‚
ä½¿ç”¨è¯¥å‚æ•°ï¼Œcontainerå†…çš„rootæ‹¥æœ‰çœŸæ­£çš„rootæƒé™ã€‚
å¦åˆ™ï¼Œcontainerå†…çš„rootåªæ˜¯å¤–éƒ¨çš„ä¸€ä¸ªæ™®é€šç”¨æˆ·æƒé™ã€‚
privilegedå¯åŠ¨çš„å®¹å™¨ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆå¤šhostä¸Šçš„è®¾å¤‡ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œmountã€‚
ç”šè‡³å…è®¸ä½ åœ¨dockerå®¹å™¨ä¸­å¯åŠ¨dockerå®¹å™¨ã€‚</li>
</ol>

:ET