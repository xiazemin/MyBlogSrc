I"ü<p>https://mp.weixin.qq.com/s/9CciL8ifi_Q_qfyNEPLNlg
<!-- more -->
ä¸€ä¸ª interface{} å¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ï¼ŒåŒæ—¶ä»–ä¹Ÿæ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å‚æ•°ï¼Œå› ä¸ºä»–å¯ä»¥æ˜¯ä»»ä½•çš„ typeã€‚è¦äº†è§£ interface{} æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå®ƒæ˜¯æ€æ ·å¯ä»¥ç¬¦åˆä»»ä½•ç±»å‹çš„ï¼Œæˆ‘ä»¬å¿…é¡»è¦å…ˆçŸ¥é“å®ƒåå­—èƒŒåçš„æ¦‚å¿µã€‚</p>

<p>Interfacesï¼ˆæ¥å£ï¼‰</p>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¯¹ç©ºæ¥å£å¾ˆå¥½çš„å®šä¹‰ï¼Œby Jordan Oreilli:</p>

<p>interface åŒ…å«ä¸¤ç§åŠŸèƒ½ï¼šä¸€å¨æ–¹æ³•çš„é›†åˆï¼ŒåŒæ—¶ä»–ä¹Ÿæ˜¯ä¸€ä¸ªç±»å‹ (type)</p>

<p>interface{} çš„ç±»å‹æ˜¯ä¸€ä¸ªæ²¡æœ‰æ–¹æ³•çš„æ¥å£ã€‚ç”±äºå®ƒæ²¡æœ‰éœ€è¦å®ç°çš„æ–¹æ³•ï¼Œæ‰€ä»¥æ‰€æœ‰çš„ç±»å‹éƒ½è‡³å°‘å®ç°äº†é›¶ä¸ªæ–¹æ³•ï¼Œè‡ªç„¶æ»¡è¶³äº† interface ç±»å‹çš„æ¡ä»¶ï¼Œæ‰€æœ‰çš„ç±»å‹éƒ½ç¬¦åˆç©ºçš„ interface</p>

<p>ä¸€ä¸ªä½¿ç”¨ Interface{} ç±»å‹åšå‚æ•°çš„æ–¹æ³•ï¼Œå¯ä»¥æ¥æ”¶ä»»ä½•ç±»å‹çš„å‚æ•°ã€‚Go ä¼šä¸ºæ–¹æ³•æŠŠå‚æ•°è½¬åŒ–ä¸º interface ç±»å‹ã€‚</p>

<p>Russ Cox æ›¾å†™è¿‡ä¸€ç¯‡å†…éƒ¨æè¿° interfaces çš„æ–‡ç« ï¼Œæè¿°äº†ä¸€ä¸ª interface ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š</p>

<p>ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å­˜å‚¨ç±»å‹ä¿¡æ¯</p>

<p>ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å…·ä½“çš„æ•°æ®</p>

<p>Russ  ç”¨ C è¯­è¨€æè¿°äº† interface çš„å®šä¹‰</p>

<p>è™½ç„¶ç°åœ¨çš„ runtime ä½¿ç”¨ Go å†™çš„ï¼Œä½†æ˜¯è¡¨è¿°ä¾ç„¶æ˜¯ç›¸åŒçš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰“å°å‡º interface{} çš„æŒ‡é’ˆåœ°å€æ¥è¯æ˜ä»–ï¼š</p>

<p>func main() {
  var i int8 = 1
  read(i)
}</p>

<p>//go:noinline
func read(i interface{}) {
  println(i)
}</p>

<p>print:
(0x10591e0,0x10be5c6)</p>

<p>ä¸¤ä¸ªæŒ‡é’ˆåœ°å€ä¸€ä¸ªæŒ‡å‘äº†ç±»å‹ä¿¡æ¯ï¼Œå¦ä¸€ä¸ªæŒ‡å‘äº†å€¼ã€‚</p>

<p>Underlying structure</p>

<p>ç©ºæ¥å£çš„åº•å±‚æè¿°æ˜¯åœ¨ reflection package çš„æ–‡æ¡£é‡Œï¼š</p>

<p>type emptyInterface struct {
   typ  *rtype            // word 1 with type description
   word unsafe.Pointer    // word 2 with the value
}
å’Œä¸Šé¢è¯´çš„ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç©º interface æœ‰ä¸€ä¸ªæè¿° type çš„æŒ‡é’ˆï¼Œä»¥åŠåŒ…å«å…·ä½“æ•°æ®çš„ word</p>

<p>rtype çš„ç»“æ„ä½“åŒ…å«äº†å…·ä½“çš„ type çš„æè¿°ï¼š</p>

<p>type rtype struct {
   size       uintptr
   ptrdata    uintptr
   hash       uint32
   tflag      tflag
   align      uint8
   fieldAlign uint8
   kind       uint8
   alg        *typeAlg
   gcdata     *byte
   str        nameOff
   ptrToThis  typeOff
}</p>

<p>åœ¨è¿™äº›å­—æ®µä¸­ï¼Œæœ‰ä¸€äº›æˆ‘ä»¬å·²çŸ¥çš„å†…å®¹ï¼š</p>

<p>size æ˜¯å­—èŠ‚å¤§å°</p>

<p>kind åŒ…å«äº† int8, int16, bool ç­‰ç±»å‹</p>

<p>align æ˜¯è¿™ä¸ªç±»å‹çš„å˜é‡çš„å¯¹é½æ–¹å¼</p>

<p>æ ¹æ®åµŒå…¥åˆ°ç©ºæ¥å£çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ˜ å°„å‡ºå­—æ®µæˆ–è€…æ–¹æ³•ï¼š</p>

<p>type structType struct {
   rtype
   pkgPath name
   fields  []structField
}</p>

<p>è¯¥ç»“æ„ä½“è¿˜æœ‰ä¸¤ä¸ªåŒ…å«å­—æ®µåˆ—è¡¨çš„æ˜ å°„å…³ç³»ã€‚å®ƒæ¸…æ¥šåœ°å±•ç¤ºäº†å°†å†…å»ºçš„ç±»å‹è½¬æ¢æˆç©ºæ¥å£å°†ä¼šå¯¼è‡´ä¸€æ¬¡æ°´å¹³è½¬æ¢ï¼Œåœ¨å­—æ®µæè¿°å’Œå®ƒçš„å€¼è¢«å­˜åœ¨å†…å­˜ä¸­çš„åœ°æ–¹</p>

<p>è¿™æ˜¯æˆ‘ä»¬çœ‹åˆ°çš„ç©ºæ¥å£çš„æè¿°ï¼š</p>

<p>interface is composed by two words</p>

<p>ç°åœ¨è®©æˆ‘ä»¬çœ‹ä¸‹ï¼Œä»ç©ºæ¥å£å®é™…ä¸Šå¯ä»¥è½¬æ¢åˆ°é‚£ç§ç±»å‹ä¸Šã€‚</p>

<p>Conversions</p>

<p>è®©æˆ‘ä»¬è¯•è¯•ç”¨ç©ºæ¥å£æ¥è½¬æ¢é”™è¯¯çš„ç±»å‹</p>

<p>func main() {
  var i int8 = 1
  read(i)
}</p>

<p>//go:noinline
func read(i interface{}) {
  n := i.(int16)
  println(n)
}</p>

<p>è™½ç„¶ä» int8 è½¬åˆ° int16 æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ç¨‹åºä¼š panic:</p>

<p>panic: interface conversion: interface {} is int8, not int16</p>

<p>goroutine 1 [running]:
main.read(0x10592e0, 0x10be5c1)
main.go:10 +0x7d
main.main()
main.go:5 +0x39
exit status 2</p>

<p>æˆ‘ä»¬ç”Ÿäº§ asm ä»£ç æ¥çœ‹çœ‹ Go åˆ°åº•æ£€æŸ¥äº†ä»€ä¹ˆ</p>

<p>code generated while checking the type of an empty interface</p>

<p>æ­¥éª¤å¦‚ä¸‹</p>

<p>æ­¥éª¤ 1ï¼š ç”¨ int16 (æŒ‡ä»¤ LEAQï¼šLoad Effective Address)çš„ç±»å‹ä¸ç©ºæ¥å£çš„å†…éƒ¨ç±»å‹ï¼ˆæŒ‡ä»¤ MOVQï¼šè¯»å–ç©ºæ¥å£ 48å­—èŠ‚åç§»çš„å†…å­˜ï¼‰ä½œæ¯”è¾ƒï¼ˆæŒ‡ä»¤ CMPQï¼‰</p>

<p>æ­¥éª¤ 2ï¼šæŒ‡ä»¤ JNEï¼Œå¦‚æœä¸ç­‰äºå°±è·³è½¬ï¼Œè·³è½¬åˆ°åœ¨ç¬¬ 3 æ­¥åˆ›å»ºçš„æŒ‡ä»¤ï¼Œæ¥å¤„ç†é”™è¯¯ä¿¡æ¯</p>

<p>æ­¥éª¤ 3ï¼šä»£ç æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ç”Ÿæˆä¸Šä¸€æ­¥çš„é”™è¯¯ä¿¡æ¯</p>

<p>æ­¥éª¤ 4ï¼šè¿™æ˜¯é”™è¯¯æŒ‡ä»¤çš„ç»“å°¾ã€‚è¿™ä¸ªç‰¹å®šçš„æŒ‡ä»¤ç”±æ˜¾ç¤ºè¯¥æŒ‡ä»¤ï¼ˆmain.go:10+0x7dï¼‰é”™è¯¯ä¿¡æ¯æ‰€å¼•ç”¨</p>

<p>ä»»ä½•ä»ç©ºæ¥å£å†…éƒ¨ç±»å‹çš„è½¬æ¢éƒ½æ˜¯åœ¨åŸå§‹ç±»å‹è½¬æ¢ä¹‹åè¿›è¡Œã€‚è½¬æ¢æˆç©ºæ¥å£ç„¶åå†è½¬æ¢å›åŸå§‹ç±»å‹å¯¹ä½ çš„ç¨‹åºè€—æ—¶æœ‰ä¸€äº›å½±å“ã€‚è®©æˆ‘ä»¬è¿è¡Œä¸€äº›åŸºå‡†æµ‹è¯•æ¥å¤§è‡´äº†è§£ä¸€ä¸‹ã€‚</p>

<p>æ€§èƒ½</p>

<p>è¿™é‡Œæœ‰ä¸¤ä¸ªåŸºå‡†æµ‹è¯•ã€‚ä¸€ä¸ªæ˜¯å¤åˆ¶ä¸€ä¸ªç»“æ„ä½“ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å¤åˆ¶ä¸€ä¸ªç©ºæ¥å£ã€‚</p>

<p>package main_test</p>

<p>import (
  â€œtestingâ€
)</p>

<p>var x MultipleFieldStructure</p>

<p>type MultipleFieldStructure struct {
  a int
  b string
  c float32
  d float64
  e int32
  f bool
  g uint64
  h *string
  i uint16
}</p>

<p>//go:noinline
func emptyInterface(i interface {}) {
  s := i.(MultipleFieldStructure)
  x = s
}</p>

<p>//go:noinline
func typed(s MultipleFieldStructure) {
  x = s
}</p>

<p>func BenchmarkWithType(b *testing.B) {
  s := MultipleFieldStructure{a: 1, h: new(string)}
  for i := 0; i &lt; b.N; i++ {
    typed(s)
  }
}</p>

<p>func BenchmarkWithEmptyInterface(b *testing.B) {
  s := MultipleFieldStructure{a: 1, h: new(string)}
  for i := 0; i &lt; b.N; i++ {
    emptyInterface(s)
  }
}</p>

<p>ç»“æœå¦‚ä¸‹</p>

<p>BenchmarkWithType-8               300000000           4.24 ns/op
BenchmarkWithEmptyInterface-8      20000000           60.4 ns/op</p>

<p>å°†ç±»å‹è½¬æ¢ä¸ºç©ºæ¥å£ï¼Œå†ä»ç©ºæ¥å£è½¬æ¢å›ç±»å‹çš„ä¸¤æ¬¡è¿‡ç¨‹æ¶ˆè€—é‡è¶…è¿‡ 55 çº³ç§’ã€‚è€Œä¸”æ—¶é•¿ä¼šéšç€ç»“æ„ä½“å†…éƒ¨å­—æ®µçš„å¢åŠ è€Œå¢åŠ ï¼š</p>

<p>BenchmarkWithType-8             100000000         17 ns/op
BenchmarkWithEmptyInterface-8    10000000        153 ns/op</p>

<p>ä½†æ˜¯ï¼Œç”¨æŒ‡é’ˆè½¬æ¢å›ç›¸åŒçš„ç»“æ„ä½“æŒ‡é’ˆæ˜¯ä¸€ä¸ªå¥½åŠæ³•ã€‚è½¬æ¢çœ‹èµ·æ¥æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p>

<p>func emptyInterface(i interface {}) {
  s := i.(*MultipleFieldStructure)
  y = s
}</p>

<p>ç°åœ¨ç»“æœæœ‰æ˜¾è‘—çš„ä¸åŒ</p>

<p>BenchmarkWithType-8                 2000000000          2.16 ns/op
BenchmarkWithEmptyInterface-8       2000000000          2.02 ns/op</p>

<p>å¯¹äºåƒ int æˆ–è€… string è¿™æ ·çš„åŸºæœ¬ç±»å‹ï¼Œæ€§èƒ½æµ‹è¯•ç•¥å¾®ä¸åŒ</p>

<p>int:</p>

<p>BenchmarkWithTypeInt-8              2000000000          1.42 ns/op
BenchmarkWithEmptyInterfaceInt-8    1000000000          2.02 ns/op</p>

<p>string:</p>

<p>BenchmarkWithTypeString-8           1000000000          2.19 ns/op
BenchmarkWithEmptyInterfaceString-8  50000000           30.7 ns/op</p>

<p>åˆç†å¹¶èŠ‚åˆ¶ä½¿ç”¨ç©ºæ¥å£ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç©ºæ¥å£ä¼šå¯¹ä½ çš„ç¨‹åºæ€§èƒ½é€ æˆä¸€äº›çœŸæ­£çš„å½±å“ã€‚</p>
:ET