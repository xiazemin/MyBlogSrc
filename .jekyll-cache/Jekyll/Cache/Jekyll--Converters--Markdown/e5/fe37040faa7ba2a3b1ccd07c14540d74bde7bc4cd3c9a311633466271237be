I"‡<p>https://mp.weixin.qq.com/s/F-bmQcRwJEFcRhpWYEm-wg
Golang HTTPæœåŠ¡åœ¨ä¸Šçº¿æ—¶ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶ï¼Œå…³é—­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œç„¶åå†å¯åŠ¨æ–°çš„è¿è¡Œè¿›ç¨‹ã€‚å¯¹äºè®¿é—®é¢‘ç‡æ¯”è¾ƒé«˜çš„é¢å‘ç»ˆç«¯ç”¨æˆ·çš„äº§å“ï¼Œå…³é—­ã€é‡å¯çš„è¿‡ç¨‹ä¸­ä¼šå‡ºç°æ— æ³•è®¿é—®ï¼ˆnginxè¡¨ç°ä¸º502ï¼‰çš„æƒ…å†µï¼Œå½±å“ç»ˆç«¯ç”¨æˆ·çš„ä½¿ç”¨ä½“éªŒã€‚</p>

<p>å®ç°çš„ä¸€èˆ¬æ€è·¯
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¦å®ç°å¹³æ»‘é‡å¯æˆ–å‡çº§ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>

<p>å‘å¸ƒæ–°çš„binæ–‡ä»¶è¦†ç›–è€çš„binæ–‡ä»¶</p>

<p>å‘é€ä¸€ä¸ªä¿¡å·é‡(USR2)ï¼Œå‘Šè¯‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ï¼Œè¿›è¡Œé‡å¯</p>

<p>æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ¥å—åˆ°ä¿¡å·åï¼Œä»¥å­è¿›ç¨‹çš„æ–¹å¼å¯åŠ¨æ–°çš„binæ–‡ä»¶</p>

<p>æ–°è¿›ç¨‹æ¥æ”¶å¹¶å¤„ç†æ–°çš„è¯·æ±‚</p>

<p>è€è¿›ç¨‹ä¸å†æ¥æ”¶æ–°è¯·æ±‚ï¼Œç­‰å¾…æ‰€æœ‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚å¤„ç†å®Œæˆåè‡ªåŠ¨é€€å‡º</p>

<p>æ–°è¿›ç¨‹åœ¨è€è¿›ç¨‹é€€å‡ºåï¼Œç»§ç»­æä¾›æœåŠ¡
<!-- more -->
é€‰å‹ä¸å®è·µ
é‡å¤é€ å¹³æ»‘é‡å¯åŠå‡çº§çš„è½®å­æ¯”è¾ƒç®€å•ï¼Œä½†æµ‹è¯•è¦†ç›–æ— æ³•æ§åˆ¶ï¼Œæ¯”è¾ƒè€—æ—¶è€—åŠ›ã€‚æ‰€ä»¥ç§‰ç€ä¸é‡å¤é€ è½®å­çš„æ€è·¯ï¼Œä½¿ç”¨githubä¸­çš„ä¸‰æ–¹åº“è¿›è¡Œé€‰æ‹©ï¼š</p>

<p>facebookgo/grace</p>

<p>fvbock/endless</p>

<p>jpillora/overseer</p>

<p>endlessä¸graceçš„å®ç°æ–¹å¼åŸç†éƒ½æ¯”è¾ƒç±»ä¼¼ï¼Œæ‰€ä»¥åœ¨é€‰å‹åˆæœŸæˆ‘ä»¬ä»¥facebookgo/graceåº“ä¸ºä¾‹é›†æˆåˆ°é¡¹ç›®ä¸­è¿›è¡Œæµ‹è¯•ï¼š</p>

<p>func (h *Server) ListenAndServe(listenAddress string) error {
    // â€¦.
    return gracehttp.Serve(&amp;http.Server{
        Addr: listenAddress,
        Handler: h.httpServerMux,
    })
}
ä½¿ç”¨ ab å·¥å…·å‹æµ‹ api-publish æœåŠ¡è¿›è¡Œæµ‹è¯•ï¼ŒæœåŠ¡å¯åŠ¨åï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>

<p>ab -c 10 -n 2000 http://127.0.0.1:38272/api/list
ç„¶åç»™è¿›ç¨‹å‘é€ USR2 ä¿¡å· kill -USR2 api-server-pidï¼Œå¯çœ‹åˆ°ä»¥ä¸‹ç»“æœï¼š</p>

<p>ç»“æœä¸­ Failed requests è¡¨ç¤ºåœ¨æ•´ä¸ªå‹æµ‹è¯·æ±‚ä¸­æ²¡æœ‰é”™è¯¯çš„è¯·æ±‚ï¼Œè¿™å¯ä»¥è¯´æ˜æœåŠ¡é‡å¯æ—¶æ²¡æœ‰ä¸­æ–­è¯·æ±‚çš„æ¥æ”¶å’Œå¤„ç†ã€‚å¦‚æœä½¿ç”¨sleepçš„æ–¹å¼æµ‹è¯•ï¼Œå¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°æ–°è¿›ç¨‹æ›¿ä»£è€è¿›ç¨‹çš„è¿‡ç¨‹ã€‚</p>

<p>supervisorçš„é—®é¢˜</p>

<p>å®é™…é¡¹ç›®ä¸­ï¼Œçº¿ä¸ŠæœåŠ¡æ˜¯è¢«supervisorå¯åŠ¨çš„ã€‚å¦‚ä¸Šæ‰€è¯´çš„æˆ‘ä»¬å¦‚æœé€šè¿‡graceæˆ–è€…endlessçš„å­è¿›ç¨‹å¯åŠ¨åé€€å‡ºçˆ¶è¿›ç¨‹è¿™ç§æ–¹å¼çš„è¯ï¼Œå­˜åœ¨çš„é—®é¢˜å°±æ˜¯å­è¿›ç¨‹ä¼šè¢«1å·è¿›ç¨‹æ¥ç®¡ï¼Œå¯¼è‡´supervisorè®¤ä¸ºæœåŠ¡æŒ‚æ‰é‡å¯æœåŠ¡ï¼Œä¸ºäº†é¿å…è¿™ç§é—®é¢˜æˆ‘ä»¬éœ€è¦ä½¿ç”¨master-workerçš„æ–¹å¼ã€‚</p>

<p>overseer è¿™ä¸ªå¤‡é€‰åº“å®ç°äº†master-workerçš„æ–¹å¼ã€‚ç®€å•é›†æˆæ–¹å¼ï¼š</p>

<p>return overseer.RunErr(overseer.Config{
    Address: address,
    Program: func(state overseer.State) {
        // â€¦
        http.Serve(state.Listener, nil)
    },
})
å¦å¤–ï¼šåœ¨æ›´æ–°supervisoræ—¶ï¼Œé…ç½®ä¸éœ€è¦æ›´æ–°ï¼Œä½†é‡å¯æœåŠ¡çš„å‘½ä»¤ä¸èƒ½ä½¿ç”¨supervisor restartï¼Œéœ€è¦ä½¿ç”¨supervisor signal sigusr2 apiçš„å‘½ä»¤ã€‚</p>

<p>è¿˜æ˜¯ä½¿ç”¨ä¸Šé¢çš„æµ‹è¯•æ–¹å¼ï¼š</p>

<p>å¯ä»¥æ˜æ˜¾çš„çœ‹åˆ°ï¼Œsupervisorå‘é€äº†USR2ä¿¡å·åï¼Œä¸»è¿›ç¨‹çš„pidæ²¡æœ‰å˜åŒ–ï¼Œé‡æ–°å¯åŠ¨äº†ä¸€ä¸ªæ–°çš„å­è¿›ç¨‹æ¥å¤„ç†çº¿ä¸Šè¯·æ±‚ã€‚</p>

<p>å…¶ä»–çš„é—®é¢˜
åœ¨ä½¿ç”¨overseeré›†æˆåˆ°é¡¹ç›®ä¸­æµ‹è¯•æ—¶ï¼Œå­è¿›ç¨‹çš„è¿è¡Œå‡½æ•°ä¸­ä»…ä»…åŠ å…¥äº†httpæœåŠ¡çš„å¯åŠ¨ï¼Œè¿™æ ·å¯¼è‡´ä¸€ä¸ªé—®é¢˜ã€‚</p>

<p>mainå‡½æ•°ä¸­ä»»åŠ¡ä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ï¼Œå¦‚æœæ˜¯cronçš„åˆå§‹åŒ–ï¼Œé‚£ä¹ˆcronå°±ä¼šåˆå§‹åŒ–ä¸¤æ¬¡ï¼Œå¯¼è‡´æœ‰ä¸¤ä¸ªcronåœ¨æ‰§è¡Œï¼Œè¿™æ ·çš„æ–¹å¼æ˜¯ä¸ç¬¦åˆé¢„æœŸçš„ã€‚</p>

<p>å¯¼è‡´è¿™æ ·çš„åŸå› æ˜¯ï¼šoverseeråœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶æ˜¯ä½¿ç”¨å’Œä¸»è¿›ç¨‹ä¸€æ ·çš„å¯åŠ¨å‘½ä»¤ã€‚æ‰€ä»¥mainå‡½æ•°ä¼šæ‰§è¡Œä¸¤æ¬¡ã€‚</p>

<p>func (mp *master) fork() error {
    mp.debugf(â€œstarting %sâ€, mp.binPath)
    cmd := exec.Command(mp.binPath)
    //mark this new process as the â€œactiveâ€ slave process.
    //this process is assumed to be holding the socket files.
    mp.slaveCmd = cmd
    mp.slaveID++
    //provide the slave process with some state
    e := os.Environ()
    e = append(e, envBinID+â€=â€+hex.EncodeToString(mp.binHash))
    e = append(e, envBinPath+â€=â€+mp.binPath)
    e = append(e, envSlaveID+â€=â€+strconv.Itoa(mp.slaveID))
    e = append(e, envIsSlave+â€=1â€)
    e = append(e, envNumFDs+â€=â€+strconv.Itoa(len(mp.slaveExtraFiles)))
    cmd.Env = e
    //inherit master args/stdfiles
    cmd.Args = os.Args
    cmd.Stdin = os.Stdin
    cmd.Stdout = os.Stdout
    cmd.Stderr = os.Stderr
    //include socket files
    cmd.ExtraFiles = mp.slaveExtraFiles
    if err := cmd.Start(); err != nil {
        return fmt.Errorf(â€œFailed to start slave process: %sâ€, err)
    }
    // â€¦
}
æˆ‘ä»¬é€šè¿‡è°ƒæ•´mainå‡½æ•°çš„å†…å®¹æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<p>å°†ä¹‹å‰æ‰€æœ‰çš„åˆå§‹åŒ–å†…å®¹é›†æˆåœ¨initializationå‡½æ•°ä¸­</p>

<p>å°†httpåˆå§‹åŒ–çš„å†…å®¹é›†æˆåœ¨httpServerå‡½æ•°ä¸­ï¼Œè¿”å›ä¸€ä¸ªhttp.Server</p>

<p>func main() {
  // é…ç½®åˆå§‹åŒ–
    if err := config.Init(appConf); err != nil {
        fmt.Println(err)
        return
    }
    cfg := config.GetConfig()</p>

<p>// åˆå§‹åŒ–graceful httpæœåŠ¡
    gracefulHTTPServer := microsvr.GracefulHTTPServer{
        Address:        cfg.HTTPListenAddress,
        Conf:           cfg,
        Initialization: initialization,
        HttpServer:     httpServer,
    }</p>

<p>// å¯åŠ¨
    if err := gracefulHTTPServer.Run(); err != nil {
        fmt.Println(err)
        return
    }
}</p>

<p>// åˆå§‹åŒ–æ—¥å¿—ã€æ•°æ®åº“é“¾æ¥ã€å®šæ—¶ä»»åŠ¡ç­‰
func initialization(cfg *config.Conf) {
    if err := microsvr.Init(cfg); err != nil {
        fmt.Println(err)
        return
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := server.AddConnect(cfg.Databases.String()); err != nil {
    fmt.Println(err)
    return
}
logger.Info("æ•°æ®åº“é“¾æ¥æˆåŠŸï¼š" + cfg.Databases.Address)
// cron
cron.Cron.Init() }
</code></pre></div></div>

<p>// åˆå§‹åŒ–httpæœåŠ¡ï¼Œä½†ä¸å¯åŠ¨
func httpServer() *http.Server {
    server := microsvr.NewHTTPServer()
    server.SetAllowOrginBack()
    Routers(server)
    return server
}
å®è·µå¯¹æ¯”ç»“æœï¼š</p>

<p>graceä¸endlessï¼šæ—§çš„apiéƒ½ä¸ä¼šæ–­æ‰ï¼Œä¼šæ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼Œä½†pidä¼šå˜åŒ–ï¼›ä¸æ”¯æŒsupervisorç®¡ç†</p>

<p>overseerï¼šæ—§apiä¸ä¼šæ–­æ‰ï¼Œä¼šæ‰§è¡ŒåŸæ¥çš„é€»è¾‘ï¼Œä¸»è¿›ç¨‹pidä¹Ÿä¸ä¼šå˜åŒ–ï¼Œæ”¯æŒsupervisorã€systemdç­‰ç®¡ç†</p>

<p>graceä¸endlessçš„åŸç†æ¯”è¾ƒç›¸åƒï¼Œéƒ½æ˜¯ç±»ä¼¼ä¸Šè¿°çš„ä¸€èˆ¬æ€è·¯çš„å®ç°åŸç†ã€‚overseerçš„ä¸åŒï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>

<p>æ·»åŠ äº†fetcherï¼šç”¨æ¥æ”¯æŒè‡ªåŠ¨å‡çº§binæ–‡ä»¶ï¼Œfetcherè¿è¡Œåœ¨ä¸€ä¸ªgoroutineä¸­ï¼Œé€šè¿‡é¢„å…ˆè®¾ç½®å¥½çš„é—´éš”æ—¶é—´æ¥æ£€æŸ¥binæ–‡ä»¶ï¼›æ”¯æŒFileã€Githubã€S3çš„æ–¹å¼</p>

<p>æ·»åŠ äº†ä¸»è¿›ç¨‹ç®¡ç†å¹³æ»‘é‡å¯ï¼šå­è¿›ç¨‹å¤„ç†é“¾æ¥ï¼Œèƒ½å¤Ÿä¿æŒä¸»è¿›ç¨‹pidä¸å˜</p>

<p>æˆ‘ä»¬ä½¿ç”¨äº†overseerä½œä¸ºæœ€ç»ˆçš„é€‰å‹ç»“æœã€‚</p>
:ET