I"È&<p>https://colobu.com/2020/04/09/accidents-of-etcd-and-go-module/
ä½¿ç”¨etcdåšå¼€å‘çš„æœ‹å‹ï¼Œå¦‚æœä½ å¼€å¯äº†go moduleçš„åŠŸèƒ½çš„è¯ï¼Œæ²¡æœ‰å‡ºç°ç¿»è½¦çš„ç°è±¡å—ï¼Ÿæˆ–è€…go get -u .æ›´æ–°ä¸€ä¸‹é¡¹ç›®ä¾èµ–è¯•è¯•çœ‹ã€‚</p>

<p>å› ä¸ºæˆ‘ä½¿ç”¨visual studio codeçš„æ–¹å¼æ˜¯æ‰“å¼€æ•´ä¸ªGOPATHè·¯å¾„ï¼Œè€Œgoplså¯¹äºæ•´ä¸ªGOPATHå¹¶ä¸å‹å¥½ï¼Œéå¸¸çš„æ…¢ï¼Œæ‰€ä»¥æˆ‘è®¾ç½®äº†å…¨å±€å˜é‡GO111MODULE=offï¼Œè¿˜æ˜¯é‡‡ç”¨ä¼ ç»Ÿçš„è€çš„åº“ä¾èµ–æ–¹å¼ã€‚</p>

<p>ä½†æ˜¯æˆ‘å¹¶ä¸æ’æ–¥ä½¿ç”¨go moduleï¼Œå¹¶ä¸”è§‰å¾—å®ƒå¯¹è§£å†³åº“ä¾èµ–çš„å†²çªè‡³å…³é‡è¦ï¼Œæ‰€ä»¥æˆ‘ä¸€èˆ¬åœ¨é¡¹ç›®ä¸­ä¹Ÿä¼šæ˜¯ä¸æ˜¯çš„å¼€å¯go module,æ›´æ–°ä¸€ä¸‹go.modã€‚ä½†æ˜¯ç›®å‰çœ‹æ¥go moduleçš„æ¨å¹¿èµ·æ¥é—®é¢˜è¿˜æ˜¯é‡é‡ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªåŸå› :</p>

<p>go moduleæœ¬èº«çš„bug
ä½¿ç”¨go moduleçš„é¡¹ç›®ä½¿ç”¨æ–¹å¼æœ‰é—®é¢˜
ä¸€äº›åº“æ²¡æœ‰é‡‡ç”¨go module
ç”±äºgo moduleçš„ä¸€äº›bug,ä»¥åŠå¼€æºé¡¹ç›®ä½¿ç”¨go moduleçš„é”™è¯¯å§¿åŠ¿ï¼Œgo moduleæ¨¡å¼ä¸‹å¯¼è‡´ä½¿ç”¨ä¸€äº›ä»£ç åº“å›°éš¾é‡é‡ã€‚æˆ‘ä»¬ä»¥etcdä¸ºä¾‹ï¼Œçœ‹çœ‹ç›®å‰ä½¿ç”¨etcdçš„ç¿»è½¦ç°åœºã€‚
<!-- more -->
å‡å¦‚çœ‹äº†å¾ˆå¤šgo moduleçš„åŠ±å¿—æ–‡ç« ï¼Œä¿¡å¿ƒæ»¡æ»¡ï¼Œå‡†å¤‡ä½¿ç”¨etcdå¼€å‘ä¸€äº›åˆ†å¸ƒå¼çš„åº”ç”¨ã€‚å¾ˆæ˜¾ç„¶ï¼Œç›¸å¯¹äºzookeeperåœ¨javaç”Ÿæ€åœˆçš„åœ°ä½ï¼Œåœ¨Goç”Ÿæ€åœˆæˆ‘ä»¬è‡ªç„¶ä¼šé€‰æ‹©etcdå»åšå¼€å‘ã€‚</p>

<p>é‚£ä¹ˆç°åœ¨ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç”Ÿæˆgo moduleæ–‡ä»¶:</p>

<p>1
2
3
âœ  workspace mkdir abc &amp;&amp; cd abc
âœ  abc go mod init  example.com/m
go: creating new go.mod: module example.com/m
åŠ å…¥etcdåº“:</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
âœ  abc go get -u -v go.etcd.io/etcd
go: go.etcd.io/etcd upgrade =&gt; v3.3.20+incompatible
go: finding module for package github.com/coreos/etcd/etcdmain
go: found github.com/coreos/etcd/etcdmain in github.com/coreos/etcd v3.3.20+incompatible
go: finding module for package sigs.k8s.io/yaml
go: finding module for package google.golang.org/grpc/codes
go: finding module for package github.com/coreos/pkg/capnslog
go: finding module for package google.golang.org/grpc/metadata
â€¦â€¦
go: found github.com/golang/groupcache/lru in github.com/golang/groupcache v0.0.0-20200121045136-8c9f03a8e57e
go: go.etcd.io/etcd imports
	github.com/coreos/etcd/etcdmain imports
	github.com/coreos/etcd/etcdserver imports
	github.com/coreos/etcd/mvcc/backend imports
	github.com/coreos/bbolt: github.com/coreos/bbolt@v1.3.4: parsing go.mod:
	module declares its path as: go.etcd.io/bbolt
	        but was required as: github.com/coreos/bbolt
ç¿»è½¦äº†ã€‚çœ‹èµ·æ¥coreosç»´æŠ¤çš„bboltåº“å£°æ˜å®ƒçš„moduleåç§°æ˜¯go.etcd.io/bboltï¼Œç»“æœåœ¨ä½¿ç”¨å®ƒçš„æ—¶å€™ä½¿ç”¨çš„package pathæ˜¯github.com/coreos/bboltï¼Œä¸ä¸€è‡´å•Š(etcd#11720, etcd#11739)ã€etcd#11749ã€‚</p>

<p>æ˜¾ç„¶æ˜¯etcdä½¿ç”¨çš„æ˜¯é”™è¯¯çš„bboltçš„è·¯å¾„ã€‚å†·é™ä¸‹æ¥ï¼Œè€ƒè™‘è§£å†³åŠæ³•ã€‚å¹¸å¥½ï¼Œgo moduleæä¾›replaceçš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•æ›¿æ¢:</p>

<p>1
replace github.com/coreos/bbolt =&gt; go.etcd.io/bbolt v1.3.4
ç°åœ¨æˆ‘ä»¬å†æ‰§è¡Œgo get -u -v go.etcd.io/etcd,è²Œä¼¼bboltçš„é—®é¢˜æ²¡æœ‰äº†ï¼Œä½†æ˜¯æ–°é—®é¢˜åˆæ¥äº†ï¼š</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
go: go.etcd.io/etcd upgrade =&gt; v3.3.20+incompatible
go: finding module for package github.com/coreos/etcd/etcdmain
go: found github.com/coreos/etcd/etcdmain in github.com/coreos/etcd v3.3.20+incompatible
go: finding module for package github.com/coreos/go-systemd/util
â€¦â€¦
google.golang.org/grpc/resolver/dns
github.com/coreos/etcd/clientv3/balancer/resolver/endpoint
google.golang.org/grpc/balancer/base</p>
<h1 id="githubcomcoreosetcdclientv3balancerresolverendpoint">github.com/coreos/etcd/clientv3/balancer/resolver/endpoint</h1>
<p>../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/resolver/endpoint/endpoint.go:114:78: undefined: resolver.BuildOption
../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/resolver/endpoint/endpoint.go:182:31: undefined: resolver.ResolveNowOption
â€¦â€¦
github.com/coreos/etcd/pkg/logutil</p>
<h1 id="githubcomcoreosetcdclientv3balancerpicker">github.com/coreos/etcd/clientv3/balancer/picker</h1>
<p>../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/picker/err.go:37:44: undefined: balancer.PickOptions
../../go/pkg/mod/github.com/coreos/etcd@v3.3.20+incompatible/clientv3/balancer/picker/roundrobin_balanced.go:55:54: undefined: balancer.PickOptions
github.com/grpc-ecosystem/grpc-gateway/runtime
â€¦..
æƒŠä¸æƒŠå–œï¼Œæ„ä¸æ„å¤–ã€‚è·¨è¿‡äº†ä¸€åº§å±±ï¼Œè¶Ÿè¿‡äº†ä¸€æ¡æ²³ï¼Œåˆé‡åˆ°äº†ä¸€åº§å±±ã€‚æˆ‘ç²¾ç¥æœ‰ç‚¹ææƒšäº†ï¼Œä½œä¸ºä¸€ä¸ªçŸ¥åçš„ä½¿ç”¨é‡å·¨å¤§çš„å¼€æºé¡¹ç›®ï¼Œé»˜è®¤go getä¸åº”è¯¥å›°éš¾é‡é‡å•Š,å³ä½¿æœ‰bug,è¿™æ˜æ˜¾çš„é—®é¢˜åº”è¯¥æ—©å°±ä¿®å¤äº†å•Šã€‚æœä¸€ä¸‹issue,ä½ ä¼šçœ‹åˆ°etcd#11563ã€etcd#11650ã€etcd#11707</p>

<p>Etcdçš„ä»£ç å’Œæ–°ç‰ˆæœ¬çš„grpc(v1.27.0)å†²çª,å†æ¬¡æ–½å±•æ›¿æ¢å¤§æ³•ï¼Œè®©é¡¹ç›®ä½¿ç”¨è€çš„grpc:</p>

<p>1
2
3
replace (
	google.golang.org/grpc =&gt; google.golang.org/grpc v1.26.0
)
é‡æ–°go get -u -v go.etcd.io/etcd,æ€€ç€åäºŒåˆ†çš„å¿å¿‘ï¼Œè§‚å¯Ÿä¸‹è½½ç»“æœï¼Œä¸€é¡¿åˆ·å±ä¹‹åï¼Œç»ˆäºæˆåŠŸäº†ï¼Œæ³ªæµæ»¡é¢ï¼Œé¢æ— è¡€è‰²ï¼Œè‰²å³æ˜¯ç©ºï¼Œç©ºå³æ˜¯è‰²ã€‚</p>

<p>åˆ°æ­¤å‘Šä¸€æ®µè½ã€‚å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨å…¶å®ƒçš„åº“ï¼Œè¦æ˜¯ä¾èµ–å…¶å®ƒçš„åº“ï¼Œè€Œå…¶å®ƒåº“ä¹Ÿåœ¨ä½¿ç”¨æŸä¸ªç‰ˆæœ¬çš„etcd,æˆ–è€…å®ƒæ²¡æœ‰ä½¿ç”¨go module,é—®é¢˜ä¸æ•¢æƒ³â€¦,ä¸è¿‡è¿˜å¥½æˆ‘ä»¬çš„ä¾‹å­è¿˜æ²¡æœ‰ä½¿ç”¨å…¶å®ƒåº“ï¼Œç›®å‰æ˜¯ä¾èµ–äº†ä¸€ä¸ªetcdã€‚</p>

<p>ç°åœ¨ä½ è‚¯å®šä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œè¿™ä¸ªé—®é¢˜å·²ç»æœ‰å¾ˆå¤šissue,éš¾é“etcdæ²¡æœ‰ä¿®æ”¹å—ï¼Ÿ</p>

<p>æ£€æŸ¥æˆ‘ä»¬çš„go.modæ–‡ä»¶ï¼Œå‘ç°ä¸€å †çš„indirectå¼•ç”¨çš„åº“ï¼Œå±…ç„¶è¿˜æœ‰ä¸¤ä¸ªetcd:</p>

<p>1
2
3
4
5
6
â€¦â€¦
github.com/coreos/etcd v3.3.20+incompatible // indirect
go.etcd.io/etcd v3.3.20+incompatible // indirect
â€¦â€¦
google.golang.org/grpc v1.28.1 // indirect
â€¦â€¦
å‘½åå¼•å…¥äº†go.etcd.io/etcd,å’‹è¿˜é™„èµ äº†ä¸€ä¸ªgithub.com/coreos/etcd?è€Œä¸”è¿™ä¿©çš„ä»£ç ä¸æ˜¯éƒ½ä¸€æ ·çš„å—ï¼Ÿ</p>

<p>go.etcd.io/etcdä¹‹æ‰€ä»¥æ˜¾ç¤ºä¸ºindirectæ˜¯å› ä¸ºæˆ‘ä»¬çš„ä»£ç ä¸­è¿˜æ²¡æœ‰å¼•ç”¨è¿™ä¸ªpackageã€‚ åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºabc.goæ–‡ä»¶:</p>

<p>1
2
3
package m
import _ â€œgo.etcd.io/etcdâ€
ç„¶ågo mod tidyå°±å¯ä»¥çœ‹åˆ°go.etcd.io/etcdçš„indirectæ ‡è®°æ²¡äº†ã€‚</p>

<p>1
2
3
4
5
6
â€¦â€¦
github.com/coreos/etcd v3.3.20+incompatible // indirect
go.etcd.io/etcd v3.3.20+incompatible // indirect
â€¦â€¦
google.golang.org/grpc v1.28.1 // indirect
â€¦â€¦
ä½†æ˜¯æˆ‘æƒ³é»˜é»˜åœ°é—®ä¸€å¥ï¼Œä¸ºä»€ä¹ˆgithub.com/coreos/etcdè¿˜å­˜åœ¨ï¼Ÿå®ƒè¢«æ ‡è®°ä¸ºindirect,è‚¯å®šæ˜¯æŸä¸ªåº“å¼•ç”¨å®ƒäº†ã€‚æ˜¯è°ï¼Ÿ</p>

<p>go mod why github.com/coreos/etcdæ˜¯æ²¡æœ‰ç”¨çš„:</p>

<p>1
2
3
âœ  abc go mod why github.com/coreos/etcd</p>
<h1 id="githubcomcoreosetcd">github.com/coreos/etcd</h1>
<p>(main module does not need package github.com/coreos/etcd)
è¦ä½¿ç”¨go mod graphæ‰¾ä¸€ä¸‹ï¼Œæ‰§è¡Œè¿™ä¸ªå‘½åç­›é€‰ä¸€ä¸‹ï¼š</p>

<p>1
2
3
âœ  abc go mod graph|grep github.com/coreos/etcd
example.com/m github.com/coreos/etcd@v3.3.20+incompatible
github.com/spf13/viper@v1.4.0 github.com/coreos/etcd@v3.3.10+incompatible
åŸæ¥æ˜¯github.com/spf13/viper@v1.4.0æçš„é¬¼ï¼Œgithub.com/coreos/etcd/etcdmainä½¿ç”¨äº†github.com/spf13/cobra@v0.0.7åº“, cobraåˆä½¿ç”¨viperçš„1.4.0ç‰ˆæœ¬ï¼Œè€Œviper@v1.4.0åˆä½¿ç”¨äº†etcd@v3.3.10ã€‚çœŸä¼˜ç§€ï¼Œç»•äº†ä¸€åœˆåˆç»•å›æ¥äº†ï¼Œå¾ªç¯ä¾èµ–å•Šã€‚ä½†æ˜¯å·²ç»é¢ç›®å…¨éï¼ŒåŸå…ˆäººå®¶æ˜¯å°ç”œç”œ(go.etcd.io/etcd),ç°åœ¨å´æˆäº†ç‰›å¤«äºº(github.com/coreos/etcd)ã€‚</p>

<p>æš‚ä¸”ä¸ç®¡å®ƒä»¬äº†ï¼Œå¥½æ­¹è‡³å°‘æˆ‘ä»¬çš„é¡¹ç›®å·²ç»æ²¡å•¥å†²çªäº†ï¼Œå¯ä»¥ç»§ç»­å¼€å‘äº†ã€‚ä½†æ˜¯æˆ‘å¿ƒä¸­è¿˜æœ‰éšéšæœ‰ä¸€ä¸ªå£°éŸ³åœ¨å‘¼å”¤ï¼Œåˆ¨æ ¹é—®åº•ï¼Œæ°¸ä¸æ”¾å¼ƒã€‚è´£ä»»æ„Ÿå’Œå†å²ä½¿å‘½ä¿ƒä½¿æˆ‘ä»¬å†é—®ä¸€å¥ï¼š ç›®å‰etcdçš„æœ€é«˜ç‰ˆæœ¬æ˜¯å¤šå°‘äº†ï¼Ÿ</p>

<p>å…¶å®å¾ˆå¥½æŸ¥ï¼Œåˆ°githubä¸ŠæŸ¥çœ‹é¡¹ç›®çš„tags:</p>

<p>å¯ä»¥çœ‹åˆ°ç›®å‰etcdé¡¹ç›®çš„æœ€é«˜ç‰ˆæœ¬å·²ç»åˆ°äº†3.4.7,å¯æˆ‘ä»¬ä¸ºä»€ä¹ˆé»˜è®¤æ‹‰ä¸‹æ¥çš„ç‰ˆæœ¬è¿˜æ˜¯å†å²ä¹…è¿œçš„v3.3.20+incompatibleã€‚ä¸ºä»€ä¹ˆï¼Ÿ</p>

<p>é¦–å…ˆï¼Œè¿™ä¸ªincompatibleæ˜¯å•¥å­æ„æ€ï¼Ÿä¾ç…§è¿™ä¸ªè§£é‡Š,åœ¨ç‰¹å®šçš„åœºæ™¯ä¸‹ä¼šåŠ ä¸Šincompatibleæ ‡ç­¾ã€‚</p>

<p>æ—¢ç„¶etcdéƒ½å·²ç»åˆ°äº†3.4.7äº†ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæœ€æ–°çš„ç‰ˆæœ¬:</p>

<p>1
2
3
âœ  abc go get -u -v go.etcd.io/etcd@3.4.7
get â€œgo.etcd.io/etcdâ€: found meta tag get.metaImport{Prefix:â€go.etcd.io/etcdâ€, VCS:â€gitâ€, RepoRoot:â€https://github.com/etcd-io/etcdâ€} at //go.etcd.io/etcd?go-get=1
go get go.etcd.io/etcd@3.4.7: go.etcd.io/etcd@3.4.7: invalid version: unknown revision 3.4.7
What? æ˜æ˜å®˜æ–¹ç½‘ç«™äº†å·²ç»æœ‰3.4.7ç‰ˆæœ¬äº†ï¼Œå’‹è·å–ä¸åˆ°ï¼Ÿ</p>

<p>1
GO111MODULE=on go list -m -json -versions go.etcd.io/etcd@latest
æ˜¾ç¤ºæœ€æ–°çš„ç‰ˆæœ¬æ˜¯v3.3.20+incompatible:</p>

<p>â€¦â€¦
		â€œv3.3.18+incompatibleâ€,
		â€œv3.3.19+incompatibleâ€,
		â€œv3.3.20+incompatibleâ€
	],
	â€œTimeâ€: â€œ2020-04-01T17:49:03Zâ€
}
å¦‚æœç¦ç”¨GOPROXY,æœ€æ–°ç‰ˆæœ¬æ˜¯v2.3.8+incompatible:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	"v2.3.6+incompatible",
	"v2.3.7+incompatible",
	"v2.3.8+incompatible"
],
"Time": "2017-02-16T03:25:01Z" } pkg.go.devä¹Ÿæ²¡æœ‰æ˜¾ç¤ºæœ€æ–°çš„ç‰ˆæœ¬ï¼š
</code></pre></div></div>

<p>ä¸ç®¡æ€æ ·ï¼Œè²Œä¼¼éƒ½æ²¡æœ‰3.4.7ç‰ˆæœ¬ã€‚å®åœ¨æ²¡æ‹›äº†ï¼Œetcdçš„issueä¸­æœ‰ç›¸å…³çš„è®¨è®º:etcd#11154,æ€¨å£°è½½é“ï¼Œç”šè‡³æœ‰ç¾¤ä¼—è¯´è¿˜å¥½ç›®å‰å¤§å®¶å¯ä»¥æ‹¿æ–°å‹è‚ºç‚ç—…æ¯’æªå¡ä½œè€…ä¸å…³å¿ƒè¿™ä¸ªbugã€‚æˆ‘çœ‹è¿™ä¸ªbugä»å»å¹´9æœˆä»½å°±å¼€å§‹äº†ï¼Œç›®å‰æ²¡æœ‰è¿˜æ²¡æœ‰å¤„ç†ã€‚ç›®å‰è€ƒè™‘åˆ°çš„å¤„ç†æ–¹æ³•æœ‰ä¸¤ä¸ªï¼š</p>

<p>åˆ é™¤etcdåº“ä¸­çš„go.mod: ç›´æ¥æœ‰æ•ˆï¼Œä½†æ˜¯å’Œgoå®˜æ–¹æåŠ›æ¨å¹¿go moduleç›¸èƒŒé©°
å®šä¹‰æ¨¡ç‰ˆä¸ºgo.etcd.io/etcd/v3ã€‚ä½†æ˜¯è¿™æ˜¯ä»¤äººè®¨åŒçš„äº‹æƒ…ï¼Œgo moduleå®šä¹‰äº†v0ã€v1å’Œv2 module,å°†moduleå®šä¹‰æ•´çš„éå¸¸çš„å¤æ‚ï¼Œä¹Ÿå¼ºè¿«åº“çš„å¼€å‘è€…éè¦åœ¨go.modå®šä¹‰ç‰ˆæœ¬ä¿¡æ¯ã€‚ æˆ–è®¸ï¼Œetcdçš„ä½œè€…é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ¥æŠµåˆ¶goçš„è¿™ç§è®¾è®¡æ–¹å¼ã€‚</p>
:ET