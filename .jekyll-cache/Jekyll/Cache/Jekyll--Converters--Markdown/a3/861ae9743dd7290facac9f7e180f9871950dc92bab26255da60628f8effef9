I"ÿ*<p>åœ¨ç”¨ Golang å¼€å‘çš„æ—¶å€™ï¼Œdeferè¿™ä¸ªè¯­æ³•ä¹Ÿæ˜¯å¿…å¤‡çš„çŸ¥è¯†ï¼Œä½†æ˜¯æˆ‘ä»¬é™¤äº†çŸ¥é“ä»–æ˜¯åœ¨ä¸€ä¸ªå‡½æ•°é€€å‡ºä¹‹å‰æ‰§è¡Œï¼Œå¯¹äºdeferæ˜¯å¦è¿˜æœ‰å…¶ä»–åœ°æ–¹éœ€è¦æ³¨æ„çš„å‘¢ã€‚</p>

<p>æœ¬æ–‡æ•´ç†çš„deferçš„å…¨åœºæ™¯ä½¿ç”¨æƒ…å†µï¼Œéƒ¨åˆ†åœºæ™¯æºè‡ªç½‘ç»œï¼ŒåŠ ä¸Šè‡ªå·±çš„é¢å¤–è§‚ç‚¹å’Œåˆ†æï¼Œå®Œæˆäº†è¿™ä»½deferçš„ 7 ä¸ªéšæ€§å¿…å¤‡çŸ¥è¯†ç‚¹ã€‚</p>

<p>æçº²å¦‚ä¸‹ï¼š</p>

<p>çŸ¥è¯†ç‚¹ 1ï¼š defer çš„æ‰§è¡Œé¡ºåº
çŸ¥è¯†ç‚¹ 2ï¼šdefer ä¸ return è°å…ˆè°å
çŸ¥è¯†ç‚¹ 3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–ä¸ defer é—´æ¥å½±å“
çŸ¥è¯†ç‚¹ 4ï¼šæœ‰åå‡½æ•°è¿”å›å€¼é‡è§ defer æƒ…å†µ
çŸ¥è¯†ç‚¹ 5ï¼šdefer é‡è§ panic
çŸ¥è¯†ç‚¹ 6ï¼šdefer ä¸­åŒ…å« panic
çŸ¥è¯†ç‚¹ 7ï¼šdefer ä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°
çŸ¥è¯†ç‚¹ 1ï¼šdefer çš„æ‰§è¡Œé¡ºåº
<!-- more --></p>

<p>å¤šä¸ª defer å‡ºç°çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä¸€ä¸ª â€œæ ˆâ€ çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å…ˆè¿›åå‡ºã€‚ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå†™åœ¨å‰é¢çš„ defer ä¼šæ¯”å†™åœ¨åé¢çš„ defer è°ƒç”¨çš„æ™šã€‚</p>

<p>ç¤ºä¾‹ä»£ç 
package main</p>

<p>import â€œfmtâ€</p>

<p>func main() {
    defer func1()
    defer func2()
    defer func3()
}</p>

<p>func func1() {
    fmt.Println(â€œAâ€)
}</p>

<p>func func2() {
    fmt.Println(â€œBâ€)
}</p>

<p>func func3() {
    fmt.Println(â€œCâ€)
}</p>

<p>è¾“å‡ºç»“æœï¼š</p>

<p>C
B
A
çŸ¥è¯†ç‚¹ 2: defer ä¸ return è°å…ˆè°å
ç¤ºä¾‹ä»£ç 
package main</p>

<p>import â€œfmtâ€</p>

<p>func deferFunc() int {
    fmt.Println(â€œdefer func calledâ€)
    return 0
}</p>

<p>func returnFunc() int {
    fmt.Println(â€œreturn func calledâ€)
    return 0
}</p>

<p>func returnAndDefer() int {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer deferFunc()

return returnFunc() }
</code></pre></div></div>

<p>func main() {
    returnAndDefer()
}
æ‰§è¡Œç»“æœä¸ºï¼š</p>

<p>return func called
defer func called
ç»“è®ºä¸ºï¼šreturn ä¹‹åçš„è¯­å¥å…ˆæ‰§è¡Œï¼Œdefer åçš„è¯­å¥åæ‰§è¡Œ</p>

<p>çŸ¥è¯†ç‚¹ 3ï¼šå‡½æ•°çš„è¿”å›å€¼åˆå§‹åŒ–
è¯¥çŸ¥è¯†ç‚¹ä¸å±äº defer æœ¬èº«ï¼Œä½†æ˜¯è°ƒç”¨çš„åœºæ™¯å´ä¸ defer æœ‰è”ç³»ï¼Œæ‰€ä»¥ä¹Ÿç®—æ˜¯ defer å¿…å¤‡äº†è§£çš„çŸ¥è¯†ç‚¹ä¹‹ä¸€ã€‚</p>

<p>å¦‚ ï¼š func DeferFunc1(i int) (t int) {} å…¶ä¸­è¿”å›å€¼t intï¼Œè¿™ä¸ªtä¼šåœ¨å‡½æ•°èµ·å§‹å¤„è¢«åˆå§‹åŒ–ä¸ºå¯¹åº”ç±»å‹çš„é›¶å€¼å¹¶ä¸”ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°ã€‚</p>

<p>ç¤ºä¾‹ä»£ç 
package main</p>

<p>import â€œfmtâ€</p>

<p>func DeferFunc(i int) (t int) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println("t = ", t)

return 2 }
</code></pre></div></div>

<p>func main() {
    DeferFunc(10)
}</p>

<p>ç»“æœ</p>

<p>t =  0
è¯æ˜ï¼Œåªè¦å£°æ˜å‡½æ•°çš„è¿”å›å€¼å˜é‡åç§°ï¼Œå°±ä¼šåœ¨å‡½æ•°åˆå§‹åŒ–æ—¶å€™ä¸ºä¹‹èµ‹å€¼ä¸º 0ï¼Œè€Œä¸”åœ¨å‡½æ•°ä½“ä½œç”¨åŸŸå¯è§ã€‚</p>

<p>çŸ¥è¯†ç‚¹ 4: æœ‰åå‡½æ•°è¿”å›å€¼é‡è§ defer æƒ…å†µ
åœ¨æ²¡æœ‰ defer çš„æƒ…å†µä¸‹ï¼Œå…¶å®å‡½æ•°çš„è¿”å›å°±æ˜¯ä¸ return ä¸€è‡´çš„ï¼Œä½†æ˜¯æœ‰äº† defer å°±ä¸ä¸€æ ·äº†ã€‚</p>

<p>â€‹ æˆ‘ä»¬é€šè¿‡çŸ¥è¯†ç‚¹ 2å¾—çŸ¥ï¼Œå…ˆ returnï¼Œå† deferï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œå®Œ return ä¹‹åï¼Œè¿˜è¦å†æ‰§è¡Œ defer é‡Œçš„è¯­å¥ï¼Œä¾ç„¶å¯ä»¥ä¿®æ”¹æœ¬åº”è¯¥è¿”å›çš„ç»“æœã€‚</p>

<p>package main</p>

<p>import â€œfmtâ€</p>

<p>func returnButDefer() (t int) {  //tåˆå§‹åŒ–0ï¼Œ å¹¶ä¸”ä½œç”¨åŸŸä¸ºè¯¥å‡½æ•°å…¨åŸŸ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
    t = t * 10
}()

return 1 }
</code></pre></div></div>

<p>func main() {
    fmt.Println(returnButDefer())
}
â€‹ è¯¥returnButDefer()æœ¬åº”çš„è¿”å›å€¼æ˜¯1ï¼Œä½†æ˜¯åœ¨ return ä¹‹åï¼Œåˆè¢« defer çš„åŒ¿å func å‡½æ•°æ‰§è¡Œï¼Œæ‰€ä»¥t=t*10è¢«æ‰§è¡Œï¼Œæœ€åreturnButDefer()è¿”å›ç»™ä¸Šå±‚main()çš„ç»“æœä¸º10</p>

<p>$ go run test.go
10
çŸ¥è¯†ç‚¹ 5: defer é‡è§ panic
â€‹ æˆ‘ä»¬çŸ¥é“ï¼Œèƒ½å¤Ÿè§¦å‘ defer çš„æ˜¯é‡è§ return(æˆ–å‡½æ•°ä½“åˆ°æœ«å°¾) å’Œé‡è§ panicã€‚</p>

<p>â€‹ æ ¹æ®çŸ¥è¯†ç‚¹ 2ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œdefer é‡è§ return æƒ…å†µå¦‚ä¸‹ï¼š</p>

<p>é‚£ä¹ˆï¼Œé‡åˆ° panic æ—¶ï¼Œéå†æœ¬åç¨‹çš„ defer é“¾è¡¨ï¼Œå¹¶æ‰§è¡Œ deferã€‚åœ¨æ‰§è¡Œ defer è¿‡ç¨‹ä¸­:é‡åˆ° recover åˆ™åœæ­¢ panicï¼Œè¿”å› recover å¤„ç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰é‡åˆ° recoverï¼Œéå†å®Œæœ¬åç¨‹çš„ defer é“¾è¡¨åï¼Œå‘ stderr æŠ›å‡º panic ä¿¡æ¯ã€‚</p>

<p>A. defer é‡è§ panicï¼Œä½†æ˜¯å¹¶ä¸æ•è·å¼‚å¸¸çš„æƒ…å†µ
test10.go
package main</p>

<p>import (
    â€œfmtâ€
)</p>

<p>func main() {
    defer_call()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println("main æ­£å¸¸ç»“æŸ") }
</code></pre></div></div>

<p>func defer_call() {
    defer func() { fmt.Println(â€œdefer: panic ä¹‹å‰1â€) }()
    defer func() { fmt.Println(â€œdefer: panic ä¹‹å‰2â€) }()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>panic("å¼‚å¸¸å†…å®¹")  //è§¦å‘deferå‡ºæ ˆ

defer func() { fmt.Println("defer: panic ä¹‹åï¼Œæ°¸è¿œæ‰§è¡Œä¸åˆ°") }() }
</code></pre></div></div>

<p>ç»“æœ</p>

<p>defer: panic ä¹‹å‰2
defer: panic ä¹‹å‰1
panic: å¼‚å¸¸å†…å®¹
//â€¦ å¼‚å¸¸å †æ ˆä¿¡æ¯
B. defer é‡è§ panicï¼Œå¹¶æ•è·å¼‚å¸¸
package main</p>

<p>import (
    â€œfmtâ€
)</p>

<p>func main() {
    defer_call()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println("main æ­£å¸¸ç»“æŸ") }
</code></pre></div></div>

<p>func defer_call() {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
    fmt.Println("defer: panic ä¹‹å‰1, æ•è·å¼‚å¸¸")
    if err := recover(); err != nil {
        fmt.Println(err)
    }
}()

defer func() { fmt.Println("defer: panic ä¹‹å‰2, ä¸æ•è·") }()

panic("å¼‚å¸¸å†…å®¹")  //è§¦å‘deferå‡ºæ ˆ

defer func() { fmt.Println("defer: panic ä¹‹å, æ°¸è¿œæ‰§è¡Œä¸åˆ°") }() } ç»“æœ
</code></pre></div></div>

<p>defer: panic ä¹‹å‰2, ä¸æ•è·
defer: panic ä¹‹å‰1, æ•è·å¼‚å¸¸
å¼‚å¸¸å†…å®¹
main æ­£å¸¸ç»“æŸ
defer æœ€å¤§çš„åŠŸèƒ½æ˜¯ panic åä¾ç„¶æœ‰æ•ˆ æ‰€ä»¥ defer å¯ä»¥ä¿è¯ä½ çš„ä¸€äº›èµ„æºä¸€å®šä¼šè¢«å…³é—­ï¼Œä»è€Œé¿å…ä¸€äº›å¼‚å¸¸å‡ºç°çš„é—®é¢˜ã€‚</p>

<p>çŸ¥è¯†ç‚¹ 6: defer ä¸­åŒ…å« panic
ç¼–è¯‘æ‰§è¡Œä¸‹é¢ä»£ç ä¼šå‡ºç°ä»€ä¹ˆ? test16.go
package main</p>

<p>import (
    â€œfmtâ€
)</p>

<p>func main()  {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
   if err := recover(); err != nil{
       fmt.Println(err)
   }else {
       fmt.Println("fatal")
   }
}()

defer func() {
    panic("defer panic")
}()

panic("panic") }
</code></pre></div></div>

<p>ç»“æœ</p>

<p>defer panic
åˆ†æ</p>

<p>panic ä»…æœ‰æœ€åä¸€ä¸ªå¯ä»¥è¢« revover æ•è·ã€‚</p>

<p>è§¦å‘panic(â€œpanicâ€)å defer é¡ºåºå‡ºæ ˆæ‰§è¡Œï¼Œç¬¬ä¸€ä¸ªè¢«æ‰§è¡Œçš„ defer ä¸­ ä¼šæœ‰panic(â€œdefer panicâ€)å¼‚å¸¸è¯­å¥ï¼Œè¿™ä¸ªå¼‚å¸¸å°†ä¼šè¦†ç›–æ‰ main ä¸­çš„å¼‚å¸¸panic(â€œpanicâ€)ï¼Œæœ€åè¿™ä¸ªå¼‚å¸¸è¢«ç¬¬äºŒä¸ªæ‰§è¡Œçš„ defer æ•è·åˆ°ã€‚</p>

<p>çŸ¥è¯†ç‚¹ 7: defer ä¸‹çš„å‡½æ•°å‚æ•°åŒ…å«å­å‡½æ•°
package main</p>

<p>import â€œfmtâ€</p>

<p>func function(index int, value int) int {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println(index)

return index }
</code></pre></div></div>

<p>func main() {
    defer function(1, function(3, 0))
    defer function(2, function(4, 0))
}</p>

<p>â€‹ è¿™é‡Œï¼Œæœ‰ 4 ä¸ªå‡½æ•°ï¼Œä»–ä»¬çš„ index åºå·åˆ†åˆ«ä¸º 1ï¼Œ2ï¼Œ3ï¼Œ4ã€‚</p>

<p>é‚£ä¹ˆè¿™ 4 ä¸ªå‡½æ•°çš„å…ˆåæ‰§è¡Œé¡ºåºæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œé¢æœ‰ä¸¤ä¸ª deferï¼Œ æ‰€ä»¥ defer ä¸€å…±ä¼šå‹æ ˆä¸¤æ¬¡ï¼Œå…ˆè¿›æ ˆ 1ï¼Œåè¿›æ ˆ 2ã€‚ é‚£ä¹ˆåœ¨å‹æ ˆ function1 çš„æ—¶å€™ï¼Œéœ€è¦è¿åŒå‡½æ•°åœ°å€ã€å‡½æ•°å½¢å‚ä¸€åŒè¿›æ ˆï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ° function1 çš„ç¬¬äºŒä¸ªå‚æ•°çš„ç»“æœï¼Œæ‰€ä»¥å°±éœ€è¦å…ˆæ‰§è¡Œ function3 å°†ç¬¬äºŒä¸ªå‚æ•°ç®—å‡ºï¼Œé‚£ä¹ˆ function3 å°±è¢«ç¬¬ä¸€ä¸ªæ‰§è¡Œã€‚åŒç†å‹æ ˆ function2ï¼Œå°±éœ€è¦æ‰§è¡Œ function4 ç®—å‡º function2 ç¬¬äºŒä¸ªå‚æ•°çš„å€¼ã€‚ç„¶åå‡½æ•°ç»“æŸï¼Œå…ˆå‡ºæ ˆ fuction2ã€å†å‡ºæ ˆ function1.</p>

<p>â€‹ æ‰€ä»¥é¡ºåºå¦‚ä¸‹ï¼š</p>

<p>defer å‹æ ˆ function1ï¼Œå‹æ ˆå‡½æ•°åœ°å€ã€å½¢å‚ 1ã€å½¢å‚ 2(è°ƒç”¨ function3) â€“&gt; æ‰“å° 3
defer å‹æ ˆ function2ï¼Œå‹æ ˆå‡½æ•°åœ°å€ã€å½¢å‚ 1ã€å½¢å‚ 2(è°ƒç”¨ function4) â€“&gt; æ‰“å° 4
defer å‡ºæ ˆ function2, è°ƒç”¨ function2 â€“&gt; æ‰“å° 2
defer å‡ºæ ˆ function1, è°ƒç”¨ function1â€“&gt; æ‰“å° 1
3
4
2
1
ç»ƒä¹ ï¼šdefer é¢è¯•çœŸé¢˜
äº†è§£ä»¥ä¸Š 6 ä¸ª defer çš„çŸ¥è¯†ç‚¹ï¼Œæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ç½‘ä¸Šçš„çœŸé¢˜å§ã€‚</p>

<p>ä¸‹é¢ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ</p>

<p>test11.go
package main</p>

<p>import â€œfmtâ€</p>

<p>func DeferFunc1(i int) (t int) {
    t = i
    defer func() {
        t += 3
    }()
    return t
}</p>

<p>func DeferFunc2(i int) int {
    t := i
    defer func() {
        t += 3
    }()
    return t
}</p>

<p>func DeferFunc3(i int) (t int) {
    defer func() {
        t += i
    }()
    return 2
}</p>

<p>func DeferFunc4() (t int) {
    defer func(i int) {
        fmt.Println(i)
        fmt.Println(t)
    }(t)
    t = 1
    return 2
}</p>

<p>func main() {
    fmt.Println(DeferFunc1(1))
    fmt.Println(DeferFunc2(1))
    fmt.Println(DeferFunc3(1))
    DeferFunc4()
}</p>

<p>ç»ƒä¹ é¢˜åˆ†æ
DeferFunc1
func DeferFunc1(i int) (t int) {
    t = i
    defer func() {
        t += 3
    }()
    return t
}
å°†è¿”å›å€¼ t èµ‹å€¼ä¸ºä¼ å…¥çš„ iï¼Œæ­¤æ—¶ t ä¸º 1
æ‰§è¡Œ return è¯­å¥å°† t èµ‹å€¼ç»™ tï¼ˆç­‰äºå•¥ä¹Ÿæ²¡åšï¼‰
æ‰§è¡Œ defer æ–¹æ³•ï¼Œå°† t + 3 = 4
å‡½æ•°è¿”å› 4 å› ä¸º t çš„ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°æ‰€ä»¥ä¿®æ”¹æœ‰æ•ˆã€‚
DeferFunc2
func DeferFunc2(i int) int {
    t := i
    defer func() {
        t += 3
    }()
    return t
}
åˆ›å»ºå˜é‡ t å¹¶èµ‹å€¼ä¸º 1
æ‰§è¡Œ return è¯­å¥ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°† t èµ‹å€¼ç»™è¿”å›å€¼ï¼Œæ­¤æ—¶è¿”å›å€¼ä¸º 1ï¼ˆè¿™ä¸ªè¿”å›å€¼å¹¶ä¸æ˜¯ tï¼‰
æ‰§è¡Œ defer æ–¹æ³•ï¼Œå°† t + 3 = 4
å‡½æ•°è¿”å›è¿”å›å€¼ 1
ä¹Ÿå¯ä»¥æŒ‰ç…§å¦‚ä¸‹ä»£ç ç†è§£</p>

<p>func DeferFunc2(i int) (result int) {
    t := i
    defer func() {
        t += 3
    }()
    return t
}
ä¸Šé¢çš„ä»£ç  return çš„æ—¶å€™ç›¸å½“äºå°† t èµ‹å€¼ç»™äº† resultï¼Œå½“ defer ä¿®æ”¹äº† t çš„å€¼ä¹‹åï¼Œå¯¹ result æ˜¯ä¸ä¼šé€ æˆå½±å“çš„ã€‚</p>

<p>DeferFunc3
func DeferFunc3(i int) (t int) {
    defer func() {
        t += i
    }()
    return 2
}
é¦–å…ˆæ‰§è¡Œ return å°†è¿”å›å€¼ t èµ‹å€¼ä¸º 2
æ‰§è¡Œ defer æ–¹æ³•å°† t + 1
æœ€åè¿”å› 3
DeferFunc4
func DeferFunc4() (t int) {
    defer func(i int) {
        fmt.Println(i)
        fmt.Println(t)
    }(t)
    t = 1
    return 2
}
åˆå§‹åŒ–è¿”å›å€¼ t ä¸ºé›¶å€¼ 0
é¦–å…ˆæ‰§è¡Œ defer çš„ç¬¬ä¸€æ­¥ï¼Œèµ‹å€¼ defer ä¸­çš„ func å…¥å‚ t ä¸º 0
æ‰§è¡Œ defer çš„ç¬¬äºŒæ­¥ï¼Œå°† defer å‹æ ˆ
å°† t èµ‹å€¼ä¸º 1
æ‰§è¡Œ return è¯­å¥ï¼Œå°†è¿”å›å€¼ t èµ‹å€¼ä¸º 2
æ‰§è¡Œ defer çš„ç¬¬ä¸‰æ­¥ï¼Œå‡ºæ ˆå¹¶æ‰§è¡Œ å› ä¸ºåœ¨å…¥æ ˆæ—¶ defer æ‰§è¡Œçš„ func çš„å…¥å‚å·²ç»èµ‹å€¼äº†ï¼Œæ­¤æ—¶å®ƒä½œä¸ºçš„æ˜¯ä¸€ä¸ªå½¢å¼å‚æ•°ï¼Œæ‰€ä»¥æ‰“å°ä¸º 0ï¼›ç›¸å¯¹åº”çš„å› ä¸ºæœ€åå·²ç»å°† t çš„å€¼ä¿®æ”¹ä¸º 2ï¼Œæ‰€ä»¥å†æ‰“å°ä¸€ä¸ª 2
ç»“æœ
4
1
3
0
2</p>
:ET