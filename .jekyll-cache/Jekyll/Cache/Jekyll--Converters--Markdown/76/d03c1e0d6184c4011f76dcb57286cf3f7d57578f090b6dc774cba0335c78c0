I"æ?<p>https://www.laruence.com/2009/04/28/719.html</p>

<p>å‡½æ•°å£°æ˜å®	è¯­ä¹‰
PHP_MINIT_FUNCTION()	å½“PHPè¢«è£…è½½æ—¶ï¼Œæ¨¡å—å¯åŠ¨å‡½æ•°å³è¢«å¼•æ“è°ƒç”¨ã€‚è¿™ä½¿å¾—å¼•æ“åšä¸€äº›ä¾‹å¦‚èµ„æºç±»å‹ï¼Œæ³¨å†ŒINIå˜é‡ç­‰çš„ä¸€æ¬¡åˆå§‹åŒ–ã€‚
PHP_MSHUTDOWN_FUNCTION()	å½“PHPå®Œå…¨å…³é—­æ—¶ï¼Œæ¨¡å—å…³é—­å‡½æ•°å³è¢«å¼•æ“è°ƒç”¨ã€‚é€šå¸¸ç”¨äºæ³¨é”€INIæ¡ç›®
PHP_RINIT_FUNCTION()	åœ¨æ¯æ¬¡PHPè¯·æ±‚å¼€å§‹ï¼Œè¯·æ±‚å‰å¯åŠ¨å‡½æ•°è¢«è°ƒç”¨ã€‚é€šå¸¸ç”¨äºç®¡ç†è¯·æ±‚å‰é€»è¾‘ã€‚
PHP_RSHUTDOWN_FUNCTION()	åœ¨æ¯æ¬¡PHPè¯·æ±‚ç»“æŸåï¼Œè¯·æ±‚å‰å…³é—­å‡½æ•°è¢«è°ƒç”¨ã€‚ç»å¸¸åº”ç”¨åœ¨æ¸…ç†è¯·æ±‚å‰å¯åŠ¨å‡½æ•°çš„é€»è¾‘ã€‚
PHP_MINFO_FUNCTION()	è°ƒç”¨phpinfo()æ—¶æ¨¡å—ä¿¡æ¯å‡½æ•°è¢«å‘¼å«ï¼Œä»è€Œæ‰“å°å‡ºæ¨¡å—ä¿¡æ¯ã€‚
<!-- more --></p>

<p>PHPæ¡†æ¶æä¾›äº†ç§°ä½œVCWD ï¼ˆvirtual current working directory è™šæ‹Ÿå½“å‰å·¥ä½œç›®å½•ï¼‰å®ï¼Œç”¨æ¥ä»£æ›¿ä»»ä½•ä¾èµ–å½“å‰å·¥ä½œç›®å½•çš„å­˜å–å‡½æ•°ã€‚è¿™äº›å®ä¸è¢«æ›¿ä»£çš„å‡½æ•°å…·å¤‡åŒæ ·çš„åŠŸèƒ½ï¼ŒåŒæ—¶æ˜¯è¢«é€æ˜åœ°å¤„ç†ã€‚åœ¨æŸäº›æ²¡æœ‰æ ‡å‡†Cå‡½æ•°åº“å¹³å°çš„æƒ…å†µä¸‹ï¼ŒVCWDæ¡†æ¶åˆ™ä¸ä¼šå¾—åˆ°æ”¯æŒã€‚ä¾‹å¦‚ï¼ŒWin32ä¸‹ä¸å­˜åœ¨chown()ï¼Œå°±ä¸ä¼šæœ‰ç›¸åº”çš„VCWD_CHOWN()å®è¢«å®šä¹‰ã€‚</p>

<p>INIæ–‡ä»¶(php.ini)çš„å®ç°ä½¿å¾—PHPæ‰©å±•æ³¨å†Œå’Œç›‘å¬å„è‡ªçš„INIæ¡ç›®ã€‚å¦‚æœè¿™äº›INIæ¡ç›®ç”±php.iniã€Apacheçš„htaccessæˆ–å…¶ä»–é…ç½®æ–¹æ³•æ¥èµ‹å€¼ï¼Œæ³¨å†Œçš„INIå˜é‡æ€»æ˜¯æ›´æ–°åˆ°æ­£ç¡®çš„å€¼ã€‚æ•´ä¸ªINIæ¡†æ¶æœ‰è®¸å¤šä¸åŒçš„é€‰é¡¹ä»¥å®ç°å…¶çµæ´»æ€§ã€‚æˆ‘ä»¬æ¶‰åŠä¸€äº›åŸºæœ¬çš„ï¼ˆä¹Ÿæ˜¯ä¸ªå¥½çš„å¼€ç«¯ï¼‰ï¼Œå€ŸåŠ©æœ¬ç« çš„å…¶ä»–ææ–™ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿåº”ä»˜æ—¥å¸¸å¼€å‘å·¥ä½œçš„éœ€è¦ã€‚
é€šè¿‡åœ¨PHP_INI_BEGIN()/PHP_INI_END()å®ä¹‹é—´çš„STD_PHP_INI_ENTRY()å®æ³¨å†ŒPHP INIæŒ‡ä»¤ã€‚</p>

<p>PECL_Gen(http://pear.php.net/package/PECL_Gen)ï¼Œè¿™ä¸ªå·¥å…·æ­£åœ¨å¼€å‘ä¹‹ä¸­ï¼Œæ¯”èµ·æœ¬ç« ä½¿ç”¨çš„ext_skelæœ‰æ›´å¤šçš„ç‰¹æ€§ã€‚</p>

<p>https://www.jianshu.com/p/ad5afec527f0</p>

<p>php-src/ext/myFile/myFile.c:37:25: error: unknown type name
      â€˜zend_rsrc_list_entryâ€™
zend_rsrc_list_entry =&gt; zend_resource</p>

<p>å‚æ•°ç±»å‹æ˜¯zend_resourceã€‚è¿™æ˜¯ PHP7 æ–°å¢çš„æ•°æ®ç»“æ„ï¼Œåœ¨ PHP 5 åˆ™æ˜¯zend_rsrc_list_entryã€‚</p>

<p>ZEND_REGISTER_RESOURCE(rsrc_result, rsrc_pointer, rsrc_type);
åœ¨ PHP 7 ä¸­åˆ é™¤äº†åŸæ¥çš„ZEND_REGISTER_RESOURCEå®ï¼Œç›´æ¥ä½¿ç”¨zend_register_resourceå‡½æ•°</p>

<p>ZEND_APIÂ zend_resource<em>Â zend_register_resource(void</em>rsrc_pointer,intrsrc_type)</p>

<p>æ–°å†™æ³•     RETURN_RES(zend_register_resource(rsrc_pointer, rsrc_type));</p>

<p>ZEND_API int zend_register_list_destructors_ex(rsrc_dtor_func_tÂ ld,Â rsrc_dtor_func_tÂ pld,constchar*type_name,intmodule_number)</p>

<p>error: use of undeclared identifier
      â€˜rsrc_pointerâ€™
    RETURN_RES(zend_register_resource(rsrc_pointer, rsrc_type));</p>

<p>RETURN_RES(zend_register_resource(fp, le_myfile));</p>

<p>php-src/ext/myFile/myFile.c:100:43: error: use of undeclared identifier
      â€˜le_myfileâ€™; did you mean â€˜le_myFileâ€™?
    RETURN_RES(zend_register_resource(fp, le_myfile));
                                          ^~~~~~~~~
                                          le_myFile</p>

<p>å†™é”™äº†ï¼Œçœ‹ç”Ÿæˆçš„ä»£ç 
 /* True global resources - no need for thread safety here */
static int le_myFile;</p>

<p>ext/myFile/myFile.c:150:29: error: unexpected type name â€˜FILEâ€™:
      expected expression
    ZEND_FETCH_RESOURCE(fp, FILE *, &amp;filehandle, -1, â€œstandard-cfileâ€, le_myFile);</p>

<p>ZEND_APIvoid<em>zend_fetch_resource(zend_resourceÂ </em>res,constchar*resource_type_name,intresource_type)</p>

<p>åœ¨ PHP 7 ä¸­åˆ é™¤äº†åŸæœ‰çš„ZEND_FETCH_RESOURCEå®ï¼Œç›´æ¥ä½¿ç”¨å‡½æ•°zend_fetch_resourceï¼Œè€Œä¸”è§£ææ–¹å¼ä¹Ÿå˜å¾—ç®€å•äº†å¾ˆå¤šï¼Œæƒ³æ¯” PHP 5 è¦é«˜æ•ˆå¾ˆå¤š</p>

<p>php-src/ext/myFile/myFile.c:154:28: error: too many arguments provided to
      function-like macro invocation
     RETURN_STRING(result, 0);
                           ^
     //RETURN_STRING(result, 0);
     RETURN_STRING(result);</p>

<p>php-src/ext/myFile/myFile.c:150:60: error: too many arguments to function
      call, expected 3, have 4
    zend_fetch_resource(&amp;filehandle, -1, â€œstandard-cfileâ€, le_myFile);</p>

<p>zend_fetch_resource(&amp;filehandle, -1, â€œstandard-cfileâ€, le_myFile);
zend_fetch_resource(&amp;filehandle, â€œstandard-cfileâ€, le_myFile);</p>

<p>Build complete.
Donâ€™t forget to run â€˜make testâ€™.</p>

<p>$php testmyFile.php
Segmentation fault: 11</p>

<p>/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:120:27: warning: implicit declaration of
      function â€˜Z_RESVAL_Pâ€™ is invalid in C99 [-Wimplicit-function-declaration]
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {
                          ^
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:120:27: warning: incompatible integer to
      pointer conversion passing â€˜intâ€™ to parameter of type â€˜zend_resource *â€™
      (aka â€˜struct _zend_resource *â€™) [-Wint-conversion]
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {
                          ^~~~~~~~~~~~~~~~~~~~~~
/usr/local/include/php/Zend/zend_list.h:59:46: note: passing argument to parameter â€˜resâ€™ here
ZEND_API int zend_list_delete(zend_resource *res);
                                             ^
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150:25: warning: incompatible pointer types
      passing â€˜zval **â€™ (aka â€˜struct _zval_struct **â€™) to parameter of type â€˜zend_resource *â€™
      (aka â€˜struct _zend_resource *â€™) [-Wincompatible-pointer-types]
    zend_fetch_resource(&amp;filehandle,â€standard-cfileâ€, le_myFile);
                        ^~~~~~~~~~~
/usr/local/include/php/Zend/zend_list.h:63:51: note: passing argument to parameter â€˜resâ€™ here
ZEND_API void *zend_fetch_resource(zend_resource *res, const char *resource_type_name, int resourâ€¦
                                                  ^
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:181:23: warning: incompatible pointer types
      passing â€˜zval **â€™ (aka â€˜struct _zval_struct **â€™) to parameter of type â€˜zend_resource *â€™
      (aka â€˜struct _zend_resource *â€™) [-Wincompatible-pointer-types]
                zend_fetch_resource(&amp;filehandle,â€standard-cfileâ€, le_myFile);
                                    ^~~~~~~~~~~
/usr/local/include/php/Zend/zend_list.h:63:51: note: passing argument to parameter â€˜resâ€™ here
ZEND_API void *zend_fetch_resource(zend_resource *res, const char *resource_type_name, int resourâ€¦
                                                  ^
4 warnings generated.</p>

<p>ä¸€æ­¥æ­¥æµ‹è¯•
$fp_in = file_open(â€œtest.txtâ€, â€œrâ€) or die(â€œUnable to open input file\nâ€);
$fp_out = file_open(â€œtest.txt.newâ€, â€œwâ€) or die(â€œUnable to open output file\nâ€);
var_dump(file_eof($fp_in));
var_dump(file_read($fp_in, 1024));</p>

<p>å‘ç°file_read æŠ¥é”™äº†</p>

<p>å†™phpæ‰©å±•æ—¶æœ€åè¿”å›å€¼ä¸ç®¡æ˜¯RETURN_STRING(str10,1);è¿˜æ˜¯RETURN_STRING(str10,0);æ€»æ˜¯æ˜¾ç¤ºSegmentation fault (core dumped)é”™è¯¯ã€‚</p>

<p>str10=(char <em>)malloc((strlen(str9)+1)</em>sizeof(char));</p>

<p>æ˜¯å“ªä¸ªåœ°æ–¹å‡ºé”™äº†å—ï¼Ÿ</p>

<p>ä¸å†™RETURN_STRINGåªç”¨ä¸‹é¢å°±æ²¡Segmentation faultäº†
printf(â€œ%s\nâ€,str10);free(str10);str10=NULL;</p>

<p>å¦‚æœæˆ‘ç›´æ¥ä½¿ç”¨ç±»ä¼¼å¦‚ä¸‹çš„ä»£ç ï¼Œå°±ä¼šå‡ºsegfaulté”™è¯¯</p>

<p>char* ret = â€œhello worldâ€;
RETURN_STRINGL(ret, strlen(ret), 0);
æ— è®ºretæ˜¯ç›´æ¥å†™å­—ç¬¦ä¸²ï¼Œè¿˜æ˜¯å…ˆåˆå§‹åŒ–æˆchar[100]è¿™æ ·ï¼Œéƒ½ä¸è¡Œ
ä½†æ˜¯åªè¦å°†ç¨‹åºç¨åŠ æ”¹è¿›ä½¿ç”¨åŠ¨æ€åˆ†é…å†…å­˜å°±æ²¡äº‹ï¼š</p>

<p>char* hello = â€œhello worldâ€;
int   len = strlen(hello);
char* ret = (char*)emalloc(len);
memcpy(ret, hello, len);
RETURN_STRINGL(ret, len, 0);
è¡¥å……ä¸€å¥ï¼šåæ¥å‘ç°RETURN_STRINGLçš„ç¬¬ä¸‰ä¸ªå‚æ•°æ”¹æˆ1ä¹Ÿä¸ä¼šæœ‰è¶Šç•Œè®¿é—®é”™è¯¯äº†</p>

<p>phpæœ¬èº«æ˜¯ç±»å‹å®‰å…¨çš„è„šæœ¬è¯­è¨€ï¼Œå¯¹äºRETURN_STRINGLæˆ–æ˜¯RETURN_STRINGè¿”å›çš„å­—ç¬¦ä¸²ï¼Œphpä¼šåœ¨é€‚å½“çš„æ—¶å€™freeæ‰ï¼Œæ‰€ä»¥ç¨‹åºå‘˜è¦ä¿è¯è¿”å›çš„å­—ç¬¦ä¸²åœ¨å †é‡Œï¼Œèƒ½å¤Ÿfreeæ‰ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåŠ¨æ€åˆ†é…å°±æ²¡äº‹çš„åŸå› ã€‚è€Œï¼š</p>

<p>char* ret = â€œhello worldâ€;
RETURN_STRINGL(ret, strlen(ret), 0);
è¿™æ˜¯ç›´æ¥è¿”å›äº†ä¸€ä¸ªé™æ€å­—ç¬¦ä¸²ï¼Œå¯¼è‡´phpåœ¨freeè¿™ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™å‡ºé”™ã€‚
RETURN_STRINGLå’ŒRETURN_STRINGæœ€åä¸€ä¸ªå‚æ•°ï¼Œå¦‚æœæ˜¯1ï¼Œè¡¨ç¤ºå¯¹ç¬¬ä¸€ä¸ªå‚æ•°ä¸­çš„å­—ç¬¦ä¸²åœ¨å †é‡Œå¤åˆ¶ä¸€ä»½è¿”å›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ€åä¸€ä¸ªå‚æ•°ç­‰äº1çš„æ—¶å€™ï¼Œç¨‹åºæ­£å¸¸çš„åŸå› ã€‚</p>

<p>//RETURN_STRING(result, 0);
 RETURN_STRING(resultï¼Œbytes_readï¼‹1ï¼Œ1);</p>

<p>27error::  errortoo : many argumentstoo  providedmany  toarguments
       providedfunction-like  tomacro
       function-likeinvocation macro
 invocation
     RETURN_STRING(result,bytes_read+1,1);
     RETURN_STRING(result,bytes_read+1,1);</p>

<p>/php-src/ext/myFile/myFile.c7::157 :7:error : error: use ofuse  undeclaredof  identifierundeclared
       identifierâ€™RETURN_STRINGâ€™</p>

<p>â€˜RETURN_STRINGâ€™
             RETURN_STRING(result,0);
             ^
             RETURN_STRING(result,0);</p>

<p>RETURN_STRING(result);</p>

<p>make clean 
 make</p>

<p>var_dump(file_eof($fp_in));  //è¿™ä¸€è¡Œæ³¨é‡Šæ‰å°±æ²¡æœ‰é—®é¢˜äº†
var_dump(file_read($fp_in, 1024));</p>

<p>Warning: file_read(): supplied resource is not a valid standard-cfile resource in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 5</p>

<p>https://github.com/zhoumengkang/notes/blob/master/php-extension/php7.0/tipi_file/tipi_file.c</p>

<p>ä»”ç»†çœ‹ä»£ç å‘ç°ï¼Œä¸€ä¸ªFILEï¼ŠæŒ‡é’ˆæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¹²æ‰ï¼Œé—®é¢˜è§£å†³</p>

<p>ln: myFile.la: File exists
make: *** [myFile.la] Error 1</p>

<p>$rm myFile.la</p>

<p>$make clean &amp; make &amp; make install</p>

<p>$php testmyFile.php
bool(true)
string(16) â€œ13456576
dfghjk
â€œ
[Thu May 28 12:54:56 2020]  Script:  â€˜/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.phpâ€™
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(153) :  Freeing 0x000000010e26c000 (1025 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php
=== Total 1 memory leaks detected ===</p>

<p>$php testmyFile.php
dyld: lazy symbol binding failed: Symbol not found: _Z_RESVAL_P
  Referenced from: /usr/local/lib/php/extensions/debug-non-zts-20160303/myFile.so
  Expected in: flat namespace</p>

<p>dyld: Symbol not found: _Z_RESVAL_P
  Referenced from: /usr/local/lib/php/extensions/debug-non-zts-20160303/myFile.so
  Expected in: flat namespace</p>

<p>Trace/BPT trap: 5</p>

<p>æŠ¥è¿™ä¸ªé”™çš„åŸå› æ˜¯:è·¯å¾„æ‰€æŒ‡å‘çš„æ–‡ä»¶ä¸å¯¹;æˆ–è€…è·¯å¾„ä¸‹æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶</p>

<p>https://blog.csdn.net/moqiluoji/article/details/79792671</p>

<p>æ›¿æ¢
     if (zend_list_delete(Z_RESVAL_P(filehandle)) == FAILURE) {
          RETURN_FALSE;
     }</p>

<p>ä¸º</p>

<p>zend_list_close(Z_RES_P(filehandle));</p>

<p>testbool(true)
string(16) â€œ13456576
dfghjk
â€œ
PHP Fatal error:  Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p>

<p>Fatal error: Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p>

<p>æŠŠ  RETURN_STRING(result);
æ›¿æ¢ä¸º  RETURN_STRINGL(result,0);
å¦‚æœæ˜¯1ï¼Œè¡¨ç¤ºå¯¹ç¬¬ä¸€ä¸ªå‚æ•°ä¸­çš„å­—ç¬¦ä¸²åœ¨å †é‡Œå¤åˆ¶ä¸€ä»½è¿”å›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ€åä¸€ä¸ªå‚æ•°ç­‰äº1çš„æ—¶å€™ï¼Œç¨‹åºæ­£å¸¸çš„åŸå› ã€‚</p>

<p>https://www.cnblogs.com/zjoch/p/5260883.html</p>

<p>$php testmyFile.php
testbool(true)
string(0) â€œâ€
PHP Fatal error:  Allowed memory size of 268435456 bytes exhausted at /Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c:150 (tried to allocate 1280 bytes) in /Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php on line 8</p>

<p>æ›¿æ¢
RETURN_STRINGL(result,0);
 RETURN_STRINGL(result,bytes_read);</p>

<p>https://my.oschina.net/kear/blog/85257</p>

<p>å¦‚æœæˆ‘ä»¬åœ¨ä¸€æ¬¡è¯·æ±‚çš„ç”Ÿå‘½å‘¨æœŸä¸­é€šè¿‡emallocåˆ†é…äº†å†…å­˜ï¼Œä½†æ˜¯æ²¡æœ‰é‡Šæ”¾ï¼Œé‚£ä¹ˆåœ¨PHPæ•´ä¸ªç”Ÿå‘½å‘¨æœŸæ˜¯ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼çš„ã€‚å› ä¸ºåœ¨è¯·æ±‚ç»“æŸçš„æ—¶å€™ï¼ŒPHPä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬é‡Šæ”¾æ‰è¿™äº›å†…å­˜ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸€æ¬¡è¯·æ±‚ä¸­ï¼Œå¦‚æœä¸€ç›´ä¸è‡ªå·±é‡Šæ”¾å†…å­˜ï¼Œé‚£ä¹ˆè¿™æ¬¡è¯·æ±‚å¾ˆå¯èƒ½ä¼šå†…å­˜ä¸å¤Ÿï¼Œå¯¼è‡´PHPè¿›ç¨‹æŒ‚æ‰ã€‚</p>

<p>https://zhuanlan.zhihu.com/p/83815759
 https://www.cnblogs.com/farwish/p/5663993.html</p>

<p>char *dest = (char *)emalloc(1024);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strcat(dest, src1);
strcat(dest, ori);
strcat(dest, src2);

RETURN_STRING(dest, 0);
</code></pre></div></div>

<p>æ˜¾ç„¶ dest æ˜¯é•¿æœŸå ç”¨å†…å­˜çš„ï¼Œä½†ä½ å¦‚ä½•åœ¨è¿”å›å€¼ä¹‹åï¼Œè¿˜èƒ½å†æŠŠå®ƒé”€æ¯å‘¢ï¼Œææ€•æ— æ³•åšåˆ°ã€‚</p>

<p>è¿™é‡Œå°±è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µï¼Œå½“ä½ çš„å‡½æ•°æ²¡æœ‰è¿”å›å€¼æ—¶ï¼Œå‡½æ•°é»˜è®¤è¿”å›çš„å˜é‡æ˜¯ zval *return_valueï¼Œä¹Ÿå°±æ˜¯ä½ ç”¨å®ƒå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>feof(fp) 0è¡¨ç¤ºæœªç»“æŸï¼Œé0è¡¨ç¤ºç»“æŸ
if (feof(fp) &lt;= 0) {
RETURN_TRUE;
}
è¿™æ®µè„šæœ¬æœ‰è¯¯å§ã€‚å½“feofå¾—åˆ°0æ—¶ï¼Œè¿”å›TUREï¼Œä¸‹é¢whileå¾ªç¯æ˜¯ä¸æ‰§è¡Œçš„ã€‚
while (!file_eof($fp_in))</p>

<p>feofæ˜¯Cè¯­è¨€æ ‡å‡†åº“å‡½æ•°ï¼Œå…¶åŸå‹åœ¨stdio.hä¸­ï¼Œå…¶åŠŸèƒ½æ˜¯æ£€æµ‹æµä¸Šçš„æ–‡ä»¶ç»“æŸç¬¦ï¼Œå¦‚æœæ–‡ä»¶ç»“æŸï¼Œåˆ™è¿”å›é0å€¼ï¼Œå¦åˆ™è¿”å›0ï¼ˆå³ï¼Œæ–‡ä»¶ç»“æŸï¼šè¿”å›é0å€¼ï¼›æ–‡ä»¶æœªç»“æŸï¼šè¿”å›0å€¼ï¼‰ã€‚</p>

<p>[Thu May 28 13:51:36 2020]  Script:  â€˜/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.phpâ€™
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(150) :  Freeing 0x000000010ec66000 (513 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php
=== Total 1 memory leaks detected ===</p>

<p>æ•´ä¸ªé—®é¢˜è§£å†³</p>

<p>å®šä¹‰äº†å…¨å±€å˜é‡éœ€è¦æŠŠç”Ÿæˆçš„.hæ–‡ä»¶é‡Œ
ZEND_BEGIN_MODULE_GLOBALS(myFile)
	zend_long  global_value;
	char *global_string;
ZEND_END_MODULE_GLOBALS(myFile)
æ³¨é‡Šå»æ‰</p>

<p>åŒæ—¶éœ€è¦æŠŠ .cæ–‡ä»¶é‡Œçš„æ³¨é‡Šä¹Ÿå»æ‰
/* If you declare any globals in php_myFile.h uncomment this:
ZEND_DECLARE_MODULE_GLOBALS(myFile)
*/</p>

<p>ä½ ä¹Ÿè®¸å¸Œæœ›åœ¨æ¯æ¬¡PHPè¯·æ±‚çš„å¼€å§‹åˆå§‹åŒ–å…¨å±€å˜é‡ã€‚å¦å¤–ï¼Œåšä¸ºä¸€ä¸ªä¾‹å­ï¼Œå…¨å±€å˜é‡å·²æŒ‡å‘äº†ä¸€ä¸ªå·²åˆ†é…çš„å†…å­˜ï¼Œåœ¨æ¯æ¬¡PHPè¯·æ±‚ç»“æŸæ—¶éœ€è¦é‡Šæ”¾å†…å­˜ã€‚ä¸ºäº†è¾¾åˆ°è¿™äº›ç›®çš„ï¼Œå…¨å±€å˜é‡æœºåˆ¶æä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„å®ï¼Œç”¨äºæ³¨å†Œå…¨å±€å˜é‡çš„æ„é€ å’Œææ„å‡½æ•°ï¼ˆå‚è€ƒè¡¨å¯¹å®å‚æ•°çš„è¯´æ˜ï¼‰ï¼š</p>

<p>ZEND_INIT_MODULE_GLOBALS(module_name, globals_ctor, globals_dtor)</p>

<p>æ·»åŠ è‡ªå®šä¹‰INIæŒ‡ä»¤
é€šè¿‡åœ¨PHP_INI_BEGIN()/PHP_INI_END()å®ä¹‹é—´çš„STD_PHP_INI_ENTRY()å®æ³¨å†ŒPHP INIæŒ‡ä»¤ã€‚</p>

<p>ä¸ºäº†ä½¿è‡ªå®šä¹‰INIæ¡ç›®æœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œä½ éœ€è¦åˆ†åˆ«å»æ‰PHP_MINIT_FUNCTION(myfile)ä¸­çš„REGISTER_INI_ENTRIES()è°ƒç”¨å’ŒPHP_MSHUTDOWN_FUNCTION(myfile)ä¸­çš„UNREGISTER_INI_ENTRIES()çš„æ³¨é‡Šã€‚
è®¿é—®ä¸¤ä¸ªç¤ºä¾‹å…¨å±€å˜é‡ä¸­çš„ä¸€ä¸ªä¸åœ¨æ‰©å±•é‡Œç¼–å†™MYFILE_G(global_value) å’ŒMYFILE_G(global_string)ä¸€æ ·ç®€å•ã€‚
å¦‚æœä½ æŠŠä¸‹é¢çš„ä¸¤è¡Œæ”¾åœ¨php.iniä¸­ï¼ŒMYFILE_G(global_value)çš„å€¼ä¼šå˜ä¸º99ã€‚</p>

<p>; php.ini â€“ The following line sets the INI entry myFile.global_value to 99.
myFile.global_value = 99</p>

<p>void myfunc(){
     TSRMLS_FETCH();
     MYFILE_G(myglobal) = 2;
}</p>

<p>æœ€åï¼Œä¸ºäº†ä½¿è‡ªå®šä¹‰INIæ¡ç›®æœºåˆ¶æ­£å¸¸å·¥ä½œï¼Œä½ éœ€è¦åˆ†åˆ«å»æ‰PHP_MINIT_FUNCTION(myfile)ä¸­çš„REGISTER_INI_ENTRIES()è°ƒç”¨å’ŒPHP_MSHUTDOWN_FUNCTION(myfile)ä¸­çš„UNREGISTER_INI_ENTRIES()çš„æ³¨é‡Šã€‚
è®¿é—®ä¸¤ä¸ªç¤ºä¾‹å…¨å±€å˜é‡ä¸­çš„ä¸€ä¸ªä¸åœ¨æ‰©å±•é‡Œç¼–å†™MYFILE_G(global_value) å’ŒMYFILE_G(global_string)ä¸€æ ·ç®€å•ã€‚
å¦‚æœä½ æŠŠä¸‹é¢çš„ä¸¤è¡Œæ”¾åœ¨php.iniä¸­ï¼ŒMYFILE_G(global_value)çš„å€¼ä¼šå˜ä¸º99ã€‚</p>

<p>$php testmyFile.php
testbool(false)
xiazemin:99	13456576
dfghjk
get result:xiazemin:99	13456576
dfghjk
[Thu May 28 14:29:19 2020]  Script:  â€˜/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.phpâ€™
/Users/didi/PhpstormProjects/c/php-src/ext/myFile/myFile.c(161) :  Freeing 0x000000010da04c80 (28 bytes), script=/Users/didi/PhpstormProjects/c/php-src/ext/myFile/testmyFile.php
=== Total 1 memory leaks detected ===</p>

<p>å®Œç¾è§£å†³</p>

:ET