I""“<p>åœ¨applicationç›®å½•ä¸‹æœ‰ä¸ªBootstrap.phpæ–‡ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯å›¾ä¸­çš„ç¬¬ä¸€ä¸ªç¯èŠ‚ï¼Œå¦‚æœå­˜åœ¨Bootstrap()å°±ä¼šå…ˆæ‰§è¡Œè¯¥æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒ…å«äº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–ç¯èŠ‚ï¼Œå¹¶è¿”å›ä¸€ä¸ªYaf_Applicationå¯¹è±¡ï¼Œç´§æ¥ç€è°ƒç”¨äº†å®ƒçš„runæ–¹æ³•ï¼Œruné‡Œé¢åŒ…å«äº†å›¾ä¸­æ‰€æœ‰ç¯èŠ‚ï¼Œruné¦–å…ˆæ˜¯è°ƒç”¨è·¯ç”±ï¼Œè·¯ç”±çš„ä¸»è¦ç›®çš„å…¶å®å°±æ˜¯æ‰¾åˆ°controllersæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œé‡Œé¢çš„initå’Œactionæ–¹æ³•ï¼Œæˆ–è€…æ‰¾åˆ°æ‰€æœ‰actionsçš„åœ°å€ç„¶ååŠ è½½ï¼Œåœ¨å»æ‰§è¡Œå¯¹åº”çš„executeæ–¹æ³•ï¼Œå¦‚æœè®¾ç½®äº†autoRenderåœ¨è¿”å›çš„æ—¶å€™ä¼šæ‰§è¡Œrenderæ–¹æ³•ï¼Œå°±æ˜¯viewè‡ªåŠ¨æ¸²æŸ“ï¼Œå›¾ä¸­æœ‰å…­ä¸ªåŒæ¨ªçº¿æ ‡å‡ºçš„ç¯èŠ‚ï¼Œå°±æ˜¯å…­ä¸ªæ’ä»¶æ–¹æ³•ï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰å®ç°è¿™å‡ ä¸ªæ–¹æ³•ï¼Œç„¶åYafæ¡†æ¶ä¼šåœ¨å›¾ä¸­ç›¸åº”çš„æ­¥éª¤å¤„è°ƒç”¨å¯¹åº”çš„HOOKæ–¹æ³•ã€‚
https://www.jianshu.com/p/130389235abc</p>

<p>Breakpoint 3, 0x0000000101078c44 in yaf_application_new () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/yaf.so
(gdb) c
Continuing.</p>

<p>Breakpoint 11, 0x0000000101079a14 in yaf_dispatcher_instance () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/yaf.so
(gdb) b yaf_router_route
Breakpoint 12 at 0x10108add4
(gdb) bt
#0  0x0000000101079a14 in yaf_dispatcher_instance () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/yaf.so
#1  0x0000000101077d69 in zim_yaf_application___construct () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/yaf.so
#2  0x000000010044b6d7 in ZEND_DO_FCALL_SPEC_RETVAL_UNUSED_HANDLER (execute_data=0x101678120) at Zend/zend_vm_execute.h:911
#3  0x000000010040c8c8 in execute_ex (ex=<optimized out="">) at Zend/zend_vm_execute.h:59767
#4  0x000000010040ca73 in zend_execute (op_array=0x10109ea50 &lt;yaf_globals+16&gt;, return_value=<optimized out="">) at Zend/zend_vm_execute.h:63804
#5  0x00000001003c4dfb in zend_execute_scripts (type=<optimized out="">, retval=0x0, file_count=<optimized out="">) at Zend/zend.c:1498
#6  0x0000000100359685 in php_execute_script (primary_file=<optimized out="">) at main/main.c:2599
#7  0x00000001004a0ec4 in do_cli (argc=<optimized out="">, argv=<optimized out="">) at sapi/cli/php_cli.c:1011
#8  0x000000010049fdd6 in main (argc=<optimized out="">, argv=<optimized out="">) at sapi/cli/php_cli.c:1403</optimized></optimized></optimized></optimized></optimized></optimized></optimized></optimized></optimized></p>

<p>https://www.iteye.com/blog/kenby-1979833
https://www.laruence.com/manual/
http://www.phpinternalsbook.com/
https://crispgm.com/page/php7-new-hashtable-implementation.html
<!-- more -->
yafæºç é˜…è¯»ä¹‹ â€“ æ¡†æ¶åŸºæœ¬ç”Ÿå‘½å‘¨æœŸ (yaf.c)
MINIT
php-fpmå¯åŠ¨masteræ—¶ä¼šå¯åŠ¨phpæ‰©å±•ï¼Œåœ¨yafæºç ä¸­ï¼Œè¿™é‡Œå¯¹åº”çš„æ˜¯MINITåŠä¹‹å‰çš„æ“ä½œï¼Œç›¸å…³æºç ä½äºyaf.c ï¼š</p>

<p>è¯»å–php.iniä¸­çš„yafé…ç½®
åœ¨PHP_INI_BEGIN()å’ŒPHP_INI_END()ä¹‹é—´å®šä¹‰ç›¸å…³å‚æ•°çš„é»˜è®¤å€¼ã€ä½œç”¨åŸŸã€å›è°ƒå‡½æ•°ç­‰</p>

<p>åœ¨MINITä¸­å®šä¹‰YAFå¸¸é‡ï¼Œå¦‚YAF_VERSIONç­‰</p>

<p>åœ¨MINITä¸­è½½å…¥yafæ¡†æ¶å„ä¸ªç»„ä»¶ï¼Œè‡ªæ­¤YAFæ¡†æ¶å°±å¸¸é©»å†…å­˜ï¼Œyafçš„å¿«çš„ä¼˜åŠ¿ä¹Ÿæºäºæ­¤ã€‚</p>

<p>PHP_MINIT_FUNCTION(yaf)
{
	REGISTER_INI_ENTRIES();
	if (YAF_G(use_namespace)) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	REGISTER_STRINGL_CONSTANT("YAF\\VERSION", PHP_YAF_VERSION, 	sizeof(PHP_YAF_VERSION) - 1, CONST_PERSISTENT | CONST_CS);
	REGISTER_STRINGL_CONSTANT("YAF\\ENVIRON", YAF_G(environ_name), strlen(YAF_G(environ_name)), CONST_PERSISTENT | CONST_CS);

	REGISTER_LONG_CONSTANT("YAF\\ERR\\STARTUP_FAILED", 		YAF_ERR_STARTUP_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\ROUTE_FAILED", 		YAF_ERR_ROUTE_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\DISPATCH_FAILED", 	YAF_ERR_DISPATCH_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\AUTOLOAD_FAILED", 	YAF_ERR_AUTOLOAD_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\NOTFOUND\\MODULE", 	YAF_ERR_NOTFOUND_MODULE, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\NOTFOUND\\CONTROLLER",YAF_ERR_NOTFOUND_CONTROLLER, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\NOTFOUND\\ACTION", 	YAF_ERR_NOTFOUND_ACTION, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\NOTFOUND\\VIEW", 		YAF_ERR_NOTFOUND_VIEW, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\CALL_FAILED",			YAF_ERR_CALL_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF\\ERR\\TYPE_ERROR",			YAF_ERR_TYPE_ERROR, CONST_PERSISTENT | CONST_CS);

} else {
	REGISTER_STRINGL_CONSTANT("YAF_VERSION", PHP_YAF_VERSION, 	sizeof(PHP_YAF_VERSION) - 1, 	CONST_PERSISTENT | CONST_CS);
	REGISTER_STRINGL_CONSTANT("YAF_ENVIRON", YAF_G(environ_name),strlen(YAF_G(environ_name)), 	CONST_PERSISTENT | CONST_CS);

	REGISTER_LONG_CONSTANT("YAF_ERR_STARTUP_FAILED", 		YAF_ERR_STARTUP_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_ROUTE_FAILED", 			YAF_ERR_ROUTE_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_DISPATCH_FAILED", 		YAF_ERR_DISPATCH_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_AUTOLOAD_FAILED", 		YAF_ERR_AUTOLOAD_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_NOTFOUND_MODULE", 		YAF_ERR_NOTFOUND_MODULE, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_NOTFOUND_CONTROLLER", 	YAF_ERR_NOTFOUND_CONTROLLER, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_NOTFOUND_ACTION", 		YAF_ERR_NOTFOUND_ACTION, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_NOTFOUND_VIEW", 		YAF_ERR_NOTFOUND_VIEW, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_CALL_FAILED",			YAF_ERR_CALL_FAILED, CONST_PERSISTENT | CONST_CS);
	REGISTER_LONG_CONSTANT("YAF_ERR_TYPE_ERROR",			YAF_ERR_TYPE_ERROR, CONST_PERSISTENT | CONST_CS);
}

/* startup components */
YAF_STARTUP(application);
YAF_STARTUP(bootstrap);
YAF_STARTUP(dispatcher);
YAF_STARTUP(loader);
YAF_STARTUP(request);
YAF_STARTUP(response);
YAF_STARTUP(controller);
YAF_STARTUP(action);
YAF_STARTUP(config);
YAF_STARTUP(view);
YAF_STARTUP(router);
YAF_STARTUP(plugin);
YAF_STARTUP(registry);
YAF_STARTUP(session);
YAF_STARTUP(exception);

return SUCCESS; }    RINIT è¯·æ±‚åˆå§‹åŒ–åªæ˜¯å¯¹yafç”¨æˆ·åº”ç”¨çº§åˆ«çš„é…ç½®åšäº†åˆå§‹åŒ–
</code></pre></div></div>

<p>PHP_RINIT_FUNCTION(yaf)
{
	YAF_G(throw_exception) = 1;
	YAF_G(ext) = zend_string_init(YAF_DEFAULT_EXT, sizeof(YAF_DEFAULT_EXT) - 1, 0);
	YAF_G(view_ext) = zend_string_init(YAF_DEFAULT_VIEW_EXT, sizeof(YAF_DEFAULT_VIEW_EXT) - 1, 0);
	YAF_G(default_module) = zend_string_init(
			YAF_ROUTER_DEFAULT_MODULE, sizeof(YAF_ROUTER_DEFAULT_MODULE) - 1, 0);
	YAF_G(default_controller) = zend_string_init(
			YAF_ROUTER_DEFAULT_CONTROLLER, sizeof(YAF_ROUTER_DEFAULT_CONTROLLER) - 1, 0);
	YAF_G(default_action) = zend_string_init(
			YAF_ROUTER_DEFAULT_ACTION, sizeof(YAF_ROUTER_DEFAULT_ACTION) - 1, 0);
	return SUCCESS;
}
RSHUTDOWN
é”€æ¯ç”¨æˆ·åº”ç”¨çº§åˆ«çš„é…ç½®</p>

<p>PHP_RSHUTDOWN_FUNCTION(yaf)
{
	YAF_G(running) = 0;
	YAF_G(in_exception)	= 0;
	YAF_G(catch_exception) = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (YAF_G(directory)) {
	zend_string_release(YAF_G(directory));
	YAF_G(directory) = NULL;
}
if (YAF_G(local_library)) {
	zend_string_release(YAF_G(local_library));
	YAF_G(local_library) = NULL;
}
if (YAF_G(local_namespaces)) {
	zend_string_release(YAF_G(local_namespaces));
	YAF_G(local_namespaces) = NULL;
}
if (YAF_G(bootstrap)) {
	zend_string_release(YAF_G(bootstrap));
	YAF_G(bootstrap) = NULL;
}
if (Z_TYPE(YAF_G(modules)) == IS_ARRAY) {
	zval_ptr_dtor(&amp;YAF_G(modules));
	ZVAL_UNDEF(&amp;YAF_G(modules));
}
if (YAF_G(base_uri)) {
	zend_string_release(YAF_G(base_uri));
	YAF_G(base_uri) = NULL;
}
if (YAF_G(view_directory)) {
	zend_string_release(YAF_G(view_directory));
	YAF_G(view_directory) = NULL;
}
if (YAF_G(view_ext)) {
	zend_string_release(YAF_G(view_ext));
}
if (YAF_G(default_module)) {
	zend_string_release(YAF_G(default_module));
}
if (YAF_G(default_controller)) {
	zend_string_release(YAF_G(default_controller));
}
if (YAF_G(default_action)) {
	zend_string_release(YAF_G(default_action));
}
if (YAF_G(ext)) {
	zend_string_release(YAF_G(ext));
}
YAF_G(default_route) = NULL;

return SUCCESS; } MSHUTDOWN é”€æ¯yafé…ç½®
</code></pre></div></div>

<p>PHP_MSHUTDOWN_FUNCTION(yaf)
{
	UNREGISTER_INI_ENTRIES();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (YAF_G(configs)) {
	zend_hash_destroy(YAF_G(configs));
	pefree(YAF_G(configs), 1);
}

return SUCCESS; }
</code></pre></div></div>

<p>yaf_dispatcher_get_controller() è·å– controller ç±»</p>

<p>zend_class_entry * yaf_dispatcher_get_controller(char* app_dir, char *module, char *controller, int len, int def_module TSRMLS_DC) {
    char     *directory     = NULL;
    int  directory_len  = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è¿™å—ä¹‹å‰è¯´è¿‡ï¼Œå¦‚æœdef_moduleç­‰äº1èµ°é»˜è®¤çš„è·¯å¾„
//å¦‚æœç­‰äº0åˆ™èµ°modulesä¸‹çš„è·¯å¾„
if (def_module) {
    // directory = app_dir/controllers
    directory_len = spprintf(&amp;directory, 0, "%s%c%s", app_dir, DEFAULT_SLASH, YAF_CONTROLLER_DIRECTORY_NAME);
} else {
    // directory = app_dir/modules/mymodule/controllers
    directory_len = spprintf(&amp;directory, 0, "%s%c%s%c%s%c%s", app_dir, DEFAULT_SLASH,
            YAF_MODULE_DIRECTORY_NAME, DEFAULT_SLASH, module, DEFAULT_SLASH, YAF_CONTROLLER_DIRECTORY_NAME);
}
 
if (directory_len) {
    char *class         = NULL;
    char *class_lowercase   = NULL;
    int class_len       = 0;
    zend_class_entry **ce   = NULL;
    // è¿™é‡Œæ ¹æ®é…ç½®åŒºåˆ†å‰ç¼€æ¨¡å¼è¿˜æ˜¯åç¼€æ¨¡å¼ 
    // Controller_Index æˆ–è€… Index_Controller 
    // ControllerIndex æˆ–è€… IndexController 
    if (YAF_G(name_suffix)) {
        class_len = spprintf(&amp;class, 0, "%s%s%s", controller, YAF_G(name_separator), "Controller");
    } else {
        class_len = spprintf(&amp;class, 0, "%s%s%s", "Controller", YAF_G(name_separator), controller);
    }
    //è½¬å°å†™
    class_lowercase = zend_str_tolower_dup(class, class_len);
   
    //æ˜¯å¦å­˜åœ¨è¿™ä¸ªControllerç±»
    if (zend_hash_find(EG(class_table), class_lowercase, class_len + 1, (void **)&amp;ce) != SUCCESS) {
        //åŠ è½½è¿™ä¸ªControllerç±»
        if (!yaf_internal_autoload(controller, len, &amp;directory TSRMLS_CC)) {
            yaf_trigger_error(YAF_ERR_NOTFOUND_CONTROLLER TSRMLS_CC, "Failed opening controller script %s: %s", directory, strerror(errno));
            efree(class);
            efree(class_lowercase);
            efree(directory);
            return NULL;
        //è·å–è¿™ä¸ªControllerç±»æŒ‡é’ˆ
        } else if (zend_hash_find(EG(class_table), class_lowercase, class_len + 1, (void **) &amp;ce) != SUCCESS)  {
            yaf_trigger_error(YAF_ERR_AUTOLOAD_FAILED TSRMLS_CC, "Could not find class %s in controller script %s", class, directory);
            efree(class);
            efree(class_lowercase);
            efree(directory);
            return 0;
        //åˆ¤æ–­æ˜¯å¦ç»§æ‰¿ Yaf_Controller_Abstract
        } else if (!instanceof_function(*ce, yaf_controller_ce TSRMLS_CC)) {
            yaf_trigger_error(YAF_ERR_TYPE_ERROR TSRMLS_CC, "Controller must be an instance of %s", yaf_controller_ce-&gt;name);
            efree(class);
            efree(class_lowercase);
            efree(directory);
            return 0;
        }
    }

    efree(class);
    efree(class_lowercase);
    efree(directory);

    return *ce;
}

return NULL; } yaf_dispatcher_handle() è°ƒç”¨äº†yaf_dispatcher_get_controller()
</code></pre></div></div>

<p>if (strncasecmp(Z_STRVAL_P(dmodule), Z_STRVAL_P(module), Z_STRLEN_P(module)) == 0) {
            is_def_module = 1;
        }</p>

<p>//æ‰¾åˆ°å¯¹åº”çš„controllerç±»
ce = yaf_dispatcher_get_controller(app_dir, Z_STRVAL_P(module), Z_STRVAL_P(controller), Z_STRLEN_P(controller), is_def_module TSRMLS_CC);</p>

<p>https://note.youdao.com/ynoteshare1/index.html?id=506a5d51332ac354fdbaa5fb902b2e1f&amp;type=note</p>

<p>https://blog.wislay.com/articles/543
æœ¬ç¯‡ä¸»è¦ç®€å•è®°å½•äº†ï¼š</p>

<p>yaf.c
yaf_application.c
yaf_bootstrap.c
yaf_controller.c
yaf_dispatcher.c
yaf_exception.c
yaf_loader.c
yaf_plugin.c
yaf_registry.c
æºç é˜…è¯»è¿‡ç¨‹ä¸­çš„ä¸€äº›é—®é¢˜å’Œç†è§£ã€‚</p>

<p>config.m4
æ‰©å±•æºç é˜…è¯»ï¼Œä» config.m4 æ–‡ä»¶å¼€å§‹ã€‚</p>

<p>å¯¹äºè¿™ä¸ªæ–‡ä»¶ï¼Œæœ€å€¼å¾—æ³¨æ„çš„åº”è¯¥æ˜¯ PHP_NEW_EXTENSION è¿™ä¸€ä¸ªå‡½æ•°å£°æ˜äº†ã€‚å£°æ˜äº†è¿™ä¸€ä¸ªæ‰©å±•çš„åç§°æ˜¯ yafï¼Œéœ€è¦ç¼–è¯‘ yaf.c ç­‰å¤šä¸ªæ–‡ä»¶ï¼Œä»¥åŠæ˜¯å¦ build åˆ° PHP çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚</p>

<p>yaf.c
yaf.c è¿™ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œä¸»è¦åšäº†å¦‚ä¸‹çš„å·¥ä½œï¼š</p>

<p>å®šä¹‰å„ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒå‡½æ•°ï¼ˆMINIT/RINIT/RSHUTDOWN/MSHUTDOWNï¼‰
å®šä¹‰ ini ä¸­å¯é…ç½®çš„é¡¹ç›®
å£°æ˜ä¾èµ–
åŠ è½½æ‰€éœ€æ¨¡å—
å®šä¹‰å„ä¸ªç”Ÿå‘½å‘¨æœŸçš„å›è°ƒæ–¹æ³•
PHP æ‰©å±•çš„ç”Ÿå‘½å‘¨æœŸå¯ä»¥ç®€å•çš„æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>

<p>MINIT
RINIT
RSHUTDOWN
MSHUTDOWN
å…¶ä¸­ RINIT/RSHUTDOWN åœ¨æ¯æ¬¡è¯·æ±‚ PHP ä»£ç æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p>

<p>èµ„æºå’Œå…¨å±€çš„ä¸€äº›åˆå§‹åŒ–å·¥ä½œå¯ä»¥åœ¨ MINIT å›è°ƒå‡½æ•°ä¸­è¿›è¡Œã€‚å¦‚ yaf çš„ MINIT æ–¹æ³•ä¸­ï¼Œå°±å®Œæˆäº†å£°æ˜ ini å¯é…ç½®é¡¹ç›®ï¼ˆREGISTER_INI_ENTRIES()ï¼‰ï¼Œå¸¸é‡å®šä¹‰ï¼Œä»¥åŠæ¨¡è®°è½½ã€‚</p>

<p>ä¸ MINIT ç›¸å¯¹çš„ï¼ŒMSHUTDOWN é˜¶æ®µçš„å›è°ƒå‡½æ•°åˆ™åšäº†èµ„æºé‡Šæ”¾é¢æ“ä½œï¼Œå¦‚é‡Šæ”¾äº†è¯»å–é…ç½®æ‰€éœ€è¦ä½¿ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p>

<p>å®šä¹‰ ini ä¸­å¯é…ç½®çš„é¡¹ç›®
å®šä¹‰ ini æ–‡ä»¶ä¸­çš„å¯é…ç½®é¡¹ç›®ä»£ç æ®µè‡ª PHP_INI_BEGIN() å¼€å§‹ï¼Œåˆ° PHP_INI_END() ç»“æŸï¼Œé€šè¿‡åå¦‚ STD_PHP_INI_* çš„å®è¿›è¡Œè®¾å®šã€‚</p>

<p>PHP_INI_BEGIN()
    STD_PHP_INI_ENTRY(â€œyaf.libraryâ€,            â€œâ€,  PHP_INI_ALL, OnUpdateString, global_library, zend_yaf_globals, yaf_globals)
    â€¦
    STD_PHP_INI_BOOLEAN(â€œyaf.use_namespaceâ€,    â€œ0â€, PHP_INI_SYSTEM, OnUpdateBool, use_namespace, zend_yaf_globals, yaf_globals)
#endif
PHP_INI_END();</p>

<p>1
2
3
4
5
6
7
PHP_INI_BEGIN()
    STD_PHP_INI_ENTRY(â€œyaf.libraryâ€,            â€œâ€,  PHP_INI_ALL, OnUpdateString, global_library, zend_yaf_globals, yaf_globals)
    â€¦
    STD_PHP_INI_BOOLEAN(â€œyaf.use_namespaceâ€,    â€œ0â€, PHP_INI_SYSTEM, OnUpdateBool, use_namespace, zend_yaf_globals, yaf_globals)
#endif
PHP_INI_END();</p>

<p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®çš„ç¬¬ä¸‰ä¸ªå‚æ•°æœ‰ PHP_INI_ALL å’Œ PHP_INI_SYSTEM ä¸¤ç§å€¼ï¼Œè¿™ä¸¤ä¸ªå€¼å†³å®šäº†æ˜¯å¦å¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹è¿™ç±»å‚æ•°ã€‚è®¾å®šä¸º PHP_INI_SYSTEM çš„é…ç½®é¡¹æ˜¯ä¸å…è®¸åœ¨è¿è¡Œæ—¶æ”¹å˜çš„ã€‚</p>

<p>æ‰€ä»¥ï¼Œæƒ³è¦å¯ç”¨ yaf çš„å‘½åç©ºé—´æ¨¡å¼ï¼Œå°±å¿…é¡»åœ¨ ini ä¸­è¿›è¡Œå¼€å¯ã€‚</p>

<p>yaf_application.c
è¿™ä¸€æ–‡ä»¶ä¸»è¦å®šä¹‰äº† Yaf_Application è¿™ä¸€ä¸ª classã€‚</p>

<p>å®šä¹‰çš„å†…å®¹åŒ…æ‹¬ï¼š</p>

<p>ç±»åä¸å‘½åç©ºé—´åç§°
ç±»å±æ€§ä¸è®¿é—®æƒé™æ§åˆ¶ï¼ˆYaf_Application è¿™ä¸€ä¸ª class è¢«å®šä¹‰ä¸º final classï¼Œå³ä¸èƒ½å†è¢«ç»§æ‰¿ï¼‰
ç±»çš„æ–¹æ³•ä¸è®¿é—®æƒé™æ§åˆ¶
é™¤äº†ä¸Šè¿°å†…å®¹ï¼Œè¿˜å®ç°äº†é…ç½®é¡¹è§£æå’Œåˆå§‹åŒ–åŠŸèƒ½ã€‚ä¸‹é¢ä¼šå¯¹ä¸€äº›é‡è¦çš„æ–¹æ³•è¿›è¡Œç®€å•çš„æè¿°ã€‚</p>

<p>__construct()
æ„é€ æ–¹æ³•ä¸­ä¸»è¦å®Œæˆäº†å¦‚ä¸‹çš„ä¸€äº›å·¥ä½œï¼š</p>

<p>è§£ææ„é€ æ–¹æ³•ä¸­çš„å‚æ•°
åˆå§‹åŒ– request/dispatcher/loader ç­‰å¯¹è±¡
è¯»å–è§£æé…ç½®æ–‡ä»¶
ä»æ‰‹å†Œä¸Šå¯ä»¥å¾—çŸ¥æ„é€ æ–¹æ³•çš„åŸå‹ä¸ºï¼š</p>

<p>public void Yaf_Application::__construct(mixed  $config,
                                         string $section = ap.environ);</p>

<p>1
2
3
public void Yaf_Application::__construct(mixed  $config,
                                         string $section = ap.environ);</p>

<p>æ ¹æ®ä¼ é€’çš„å­—ç¬¦ä¸²ä½œä¸ºæœ¬åº”ç”¨ ini é…ç½®æ–‡ä»¶çš„æ–‡ä»¶åï¼Œè¿›è¡Œè§£æã€‚</p>

<p>ç¬¬äºŒä¸ªå‚æ•° section å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œä¼šåªè¯»å– section: å¼€å¤´çš„é…ç½®é¡¹ç›®ã€‚</p>

<p>å¦‚ï¼Œè®¾å®š section ä¸º product ä¹‹åï¼Œè¯»å–åˆ°çš„æ•°æ®åº“ç«¯å£é…ç½®é¡¹åº”ä¸º 3306ã€‚</p>

<p>[common]
application.directory = APPLICATION_PATH  â€œ/applicationâ€
application.dispatcher.catchException = TRUE</p>

<p>[product:common]
database.driver    = â€œmysqlâ€
database.host      = â€œ127.0.0.1â€
database.port      = â€œ3306â€
database.database  = â€œlearnâ€
database.username  = â€œlearnâ€
database.password  = â€œ123456â€
database.charset   = â€œutf8â€
database.collation = â€œutf8_general_ciâ€
database.prefix    = â€œâ€</p>

<p>[dev:common]
database.driver    = â€œmysqlâ€
database.host      = â€œ127.0.0.1â€
database.port      = â€œ13306â€
database.database  = â€œlearnâ€
database.username  = â€œlearnâ€
database.password  = â€œ123456â€
database.charset   = â€œutf8â€
database.collation = â€œutf8_general_ciâ€
database.prefix    = â€œâ€</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
[common]
application.directory = APPLICATION_PATH  â€œ/applicationâ€
application.dispatcher.catchException = TRUE</p>

<p>[product:common]
database.driver    = â€œmysqlâ€
database.host      = â€œ127.0.0.1â€
database.port      = â€œ3306â€
database.database  = â€œlearnâ€
database.username  = â€œlearnâ€
database.password  = â€œ123456â€
database.charset   = â€œutf8â€
database.collation = â€œutf8_general_ciâ€
database.prefix    = â€œâ€</p>

<p>[dev:common]
database.driver    = â€œmysqlâ€
database.host      = â€œ127.0.0.1â€
database.port      = â€œ13306â€
database.database  = â€œlearnâ€
database.username  = â€œlearnâ€
database.password  = â€œ123456â€
database.charset   = â€œutf8â€
database.collation = â€œutf8_general_ciâ€
database.prefix    = â€œâ€</p>

<p>æ ¹æ®æ–¹æ³•åŸå‹ä¸­ä¼ å…¥çš„é…ç½®æ–‡ä»¶è·¯å¾„ï¼Œä¼šè§£æå‡ºå¦‚ bootstrap ç±»æ‰€åœ¨æ–‡ä»¶è·¯å¾„ä¹‹ç±»çš„é…ç½®ï¼Œå¹¶èµ‹å€¼åˆ°å…¨å±€å˜é‡ä¸­ï¼Œä¾›å…¶ä»–åŠŸèƒ½ä½¿ç”¨ã€‚</p>

<p>åœ¨è¯»å–é…ç½®æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜ä¼šé€šè¿‡ yaf_loader_register() å‡½æ•°æ³¨å†Œé»˜è®¤çš„è‡ªåŠ¨åŠ è½½æ–¹æ³•: Yaf_Loader::autoload()ã€‚</p>

<p>run()
run() æ–¹æ³•å®Œæˆçš„å·¥ä½œæ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­å½“å‰ app å¯¹è±¡æ˜¯å¦å·²ç»åœ¨è¿è¡Œä¸­ï¼Œå¦‚æœåœ¨è¿è¡Œä¸­åˆ™äº§ç”Ÿé”™è¯¯ï¼Œå¦åˆ™æ‰§è¡Œ dispatch è¿‡ç¨‹ï¼Œè·å¾— response å¯¹è±¡ã€‚</p>

<p>bootstrap()
bootstrap() æ–¹æ³•æ˜¯ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥å¯¹ yaf è¿›è¡Œä¸€äº›å…¨å±€çš„åˆå§‹åŒ–æ“ä½œã€‚</p>

<p>é¦–å…ˆä¼šåœ¨ç±»åè¡¨ï¼ˆEG(class_table)ï¼‰ä¸­æŸ¥æ‰¾åä¸º YAF_DEFAULT_BOOTSTRAP_LOWER å³åä¸º bootstrap çš„ç±»ã€‚</p>

<p>å¦‚æœä¸å­˜åœ¨è¿™æ ·çš„ä¸€ä¸ª classï¼Œåˆ™é€šè¿‡è¯»å–åä¸º bootstrap çš„å…¨å±€å˜é‡ï¼ˆYAF_G(bootstrap)ï¼‰ï¼Œæ¥ç¡®å®šå…·ä½“çš„éœ€è¦æ‰§è¡Œçš„ç±»æ‰€åœ¨çš„æ–‡ä»¶ã€‚å¦‚æœå…¨å±€å˜é‡ä¹Ÿæ²¡æœ‰é…ç½®ï¼Œåˆ™ä¼šåœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ Bootstrap.php çš„æ–‡ä»¶ã€‚bootstrap è¿™ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¯¹åº”çš„æ˜¯ä¼ å…¥çš„ ini æ–‡ä»¶ä¸­çš„ application.bootstrap é…ç½®é¡¹çš„å€¼ã€‚</p>

<p>åœ¨ç¡®å®šéœ€è¦æ‰§è¡Œçš„ bootstrap çš„æ–‡ä»¶è·¯å¾„ä¹‹åï¼Œé€šè¿‡ yaf_loader_import() å‡½æ•°åŠ è½½æ–‡ä»¶ã€‚å¹¶ä¼šå†æ¬¡å°è¯•åœ¨ç±»åè¡¨ï¼ˆEG(class_table)ï¼‰ä¸­æŸ¥æ‰¾åä¸º YAF_DEFAULT_BOOTSTRAP_LOWER çš„ç±»ï¼Œæœ€ååˆ¤æ–­è¿™ä¸ªç±»æ˜¯å¦ç»§æ‰¿äº† Yaf_Bootstrap_Abstractï¼Œä»»ä½•ä¸€é¡¹ä¸æ»¡è¶³ï¼Œéƒ½ä¼šè§¦å‘é”™è¯¯ã€‚</p>

<p>æ‘˜å½•ä¸€ä¸‹ä¸Šè¿°è¿™æ®µæºç ï¼š</p>

<p>if (!yaf_loader_import(bootstrap_path, len + 1, 0 TSRMLS_CC)) {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œCouldnâ€™t find bootstrap file %sâ€, bootstrap_path);
    retval = 0;
} else if (zend_hash_find(EG(class_table), YAF_DEFAULT_BOOTSTRAP_LOWER, YAF_DEFAULT_BOOTSTRAP_LEN, (void <em>*) &amp;ce) != SUCCESS)  {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œCouldnâ€™t find class %s in %sâ€, YAF_DEFAULT_BOOTSTRAP, bootstrap_path);
    retval = 0;
} else if (!instanceof_function(</em>ce, yaf_bootstrap_ce TSRMLS_CC)) {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œExpect a %s instance, %s giveâ€, yaf_bootstrap_ce-&gt;name, (*ce)-&gt;name);
    retval = 0;
}</p>

<p>1
2
3
4
5
6
7
8
9
10
11
if (!yaf_loader_import(bootstrap_path, len + 1, 0 TSRMLS_CC)) {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œCouldnâ€™t find bootstrap file %sâ€, bootstrap_path);
    retval = 0;
} else if (zend_hash_find(EG(class_table), YAF_DEFAULT_BOOTSTRAP_LOWER, YAF_DEFAULT_BOOTSTRAP_LEN, (void <em>*) &amp;ce) != SUCCESS)  {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œCouldnâ€™t find class %s in %sâ€, YAF_DEFAULT_BOOTSTRAP, bootstrap_path);
    retval = 0;
} else if (!instanceof_function(</em>ce, yaf_bootstrap_ce TSRMLS_CC)) {
    php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œExpect a %s instance, %s giveâ€, yaf_bootstrap_ce-&gt;name, (*ce)-&gt;name);
    retval = 0;
}</p>

<p>yaf_loader_import() æˆåŠŸåŠ è½½ä¹‹åè¿”å›å€¼æ˜¯1ï¼Œzend_hash_find() æ‰§è¡ŒæˆåŠŸä¹‹åè¿”å›å€¼æ˜¯ SUCCESS å³0ï¼Œinstanceof_function() åˆ¤æ–­ä¸ºçœŸæ—¶è¿”å›å€¼æ˜¯1ï¼Œæ‰€ä»¥ï¼Œä¸Šè¿°ä¸€æ®µä»£ç ï¼Œåœ¨ä¸€åˆ‡æ­£å¸¸çš„é€»è¾‘ä¸‹ï¼Œä¸‰ä¸ª if/else åˆ¤æ–­ä¸­çš„è¯­å¥éƒ½ä¼šæ‰§è¡Œã€‚</p>

<p>æ‰€ä»¥ï¼Œä¸Šè¿°æ­¥éª¤è¯´æ˜äº†ä¸¤ç‚¹ï¼š</p>

<p>bootstrap æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ˜¯å¯ä»¥é…ç½®çš„
bootstrap ç±»åå¿…é¡»æ˜¯ Bootstrapï¼ˆå› ä¸ºåªä¼šåœ¨ç±»åè¡¨ä¸­æŸ¥æ‰¾è¿™ä¸€ä¸ªå€¼ï¼‰
åœ¨ç±»åŠ è½½å®Œæˆåï¼Œä¼šé€ä¸ªè°ƒç”¨ _init å¼€å¤´çš„æ–¹æ³•ï¼Œå®Œæˆåˆå§‹åŒ–æ“ä½œï¼Œæ‰€æœ‰æ–¹æ³•ä¼šæ¥æ”¶ dispatcher ä½œä¸ºå‚æ•°ã€‚</p>

<p>yaf_bootstrap.c
è¿™ä¸€æ–‡ä»¶ä¸»è¦æ˜¯å£°æ˜äº† Yaf_Bootstrap_Abstract è¿™ä¸€ä¸ªæŠ½è±¡ç±»ã€‚</p>

<p>yaf_controller.c
è¿™ä¸€æ–‡ä»¶å£°æ˜äº† Yaf_Controller_Abstract è¿™ä¸€ä¸ªæŠ½è±¡ç±»ã€‚åŒæ—¶ä¹Ÿå®šä¹‰äº†è§†å›¾å±‚çš„ render ä¸ display æ“ä½œï¼ŒäºŒè€…åŒºåˆ«åœ¨äº render è¿”å›æ¸²æŸ“å¥½çš„è§†å›¾å­—ç¬¦ä¸²ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯ä¸€ä¸ª zvalï¼‰ã€‚</p>

<p>yaf_dispatcher.c
è¿™æ˜¯ yaf æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å…³é”®éƒ¨åˆ†ä¹‹ä¸€ã€‚</p>

<p>ä¸€ä¸ªè¯·æ±‚åˆ°æ¥ï¼ŒYaf_Application å¯¹è±¡åœ¨æ‰§è¡Œ run() æ–¹æ³•æ—¶ï¼Œæœ€åä¸€æ­¥å°±æ˜¯é€šè¿‡å·²ç»è®¾ç½®å¥½çš„ dispatcher å¼€å§‹å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå³è°ƒç”¨ yaf_dispatcher_dispatch() å‡½æ•°ã€‚</p>

<p>yaf_dispatcher_dispatch()
è·¯ç”±
yaf_dispatcher_dispatch() å‡½æ•°åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦å·²ç»è¢«è·¯ç”±è¿‡ï¼Œå¦‚æœæ²¡æœ‰è¢«è·¯ç”±è¿‡ï¼Œåˆ™é€šè¿‡ yaf_dispatcher_route() å‡½æ•°å¯¹å½“å‰è¯·æ±‚æ‰§è¡Œè·¯ç”±æ“ä½œã€‚</p>

<p>åœ¨æ‰§è¡Œè·¯ç”±ä¹‹å‰ï¼Œyaf çš„é’©å­æœºåˆ¶ä¼šé€šè¿‡ YAF_PLUGIN_HANDLE è¿™ä¸ªå®é€ä¸ªè°ƒç”¨å·²æ³¨å†Œæ’ä»¶ä¸­ routerstartup å›è°ƒæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºä¸ºæ³¨å†Œæ’ä»¶çš„é¡ºåºã€‚</p>

<p>Yaf_Dispatcher ä¸­åŒ…å«ä¸€ä¸ªæˆå‘˜å˜é‡ _router (å³ YAF_DISPATCHER_PROPERTY_NAME_ROUTER)ï¼Œæ­¤å¤„è®°å½•äº†å½“å‰ app å·²æ³¨å†Œçš„å„ä¸ªè·¯ç”±è§„åˆ™ã€‚åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ˆè°ƒç”¨ yaf_router_instance() å‡½æ•°ï¼‰ï¼Œä¼šæ³¨å†Œé»˜è®¤è·¯ç”±ï¼Œå¦‚æœä¸è®¾å®šï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ static è·¯ç”±ã€‚</p>

<p>åŒæ ·çš„ï¼Œä¸€ä¸ª app çš„ Dispatcher å¯¹è±¡çš„é»˜è®¤ Controller/Module/Action ç­‰ç­‰å‚æ•°ï¼Œä»¥åŠéœ€è¦æ‰§è¡Œçš„æ’ä»¶ï¼Œä¹Ÿéƒ½åœ¨è¿™ä¸€ä¸ªé˜¶æ®µå®Œæˆäº†é»˜è®¤å€¼çš„è®¾å®šã€‚</p>

<p>å¦‚æœæœ‰å¤šä¸ªè·¯ç”±è§„åˆ™ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼ŒååŠ å…¥çš„è·¯ç”±è§„åˆ™ä¼šå…ˆè¢«æ‰§è¡Œï¼Œæ­¤å¤„åœ¨æ‰‹å†Œä¸­ä¹Ÿå¯ä»¥è·çŸ¥ï¼Œä»ä»£ç ä¸Šæ¥çœ‹ï¼ŒåŸå› æ˜¯ yaf_router_route() å‡½æ•°åœ¨éå† HashTable æ—¶ä» HashTable çš„æœ«ç«¯å¼€å§‹è¿›è¡Œéå†ï¼š</p>

<p>â€¦
ht = Z_ARRVAL_P(routers);
for(zend_hash_internal_pointer_end(ht);
        zend_hash_has_more_elements(ht) == SUCCESS;
        zend_hash_move_backwards(ht)) {
â€¦</p>

<p>1
2
3
4
5
6
7
â€¦
ht = Z_ARRVAL_P(routers);
for(zend_hash_internal_pointer_end(ht);
        zend_hash_has_more_elements(ht) == SUCCESS;
        zend_hash_move_backwards(ht)) {
â€¦</p>

<p>ä¸€æ—¦è·¯ç”±è§„åˆ™å‘½ä¸­ï¼Œåˆ™ç»“æŸè·¯ç”±è¿‡ç¨‹ã€‚</p>

<p>åœ¨æ‰§è¡Œè·¯ç”±ä¹‹åï¼Œyaf çš„é’©å­æœºåˆ¶ä¼šé€šè¿‡ YAF_PLUGIN_HANDLE è¿™ä¸ªå®é€ä¸ªè°ƒç”¨å·²æ³¨å†Œæ’ä»¶ä¸­ routershutdown å›è°ƒæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºä¸ºæ³¨å†Œæ’ä»¶çš„é¡ºåºã€‚</p>

<p>åˆ†å‘
åˆ†å‘å¼€å§‹ä¹‹å‰ï¼Œyaf çš„é’©å­æœºåˆ¶ä¼šé€šè¿‡ YAF_PLUGIN_HANDLE è¿™ä¸ªå®é€ä¸ªè°ƒç”¨å·²æ³¨å†Œæ’ä»¶ä¸­ dispatchloopstartup å›è°ƒæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºä¸ºæ³¨å†Œæ’ä»¶çš„é¡ºåºã€‚</p>

<p>ä¹‹åä¼šæ‰§è¡Œè§†å›¾çš„åˆå§‹åŒ–æ“ä½œã€‚</p>

<p>è¯·æ±‚åœ¨åˆ†å‘è¿‡ç¨‹ä¸­æœ‰æœ€å¤§ forward æ¬¡æ•°ï¼ˆå°†è¯·æ±‚äº¤ç»™æŒ‡å®šçš„ module / controller / action å¤„ç†ï¼‰ï¼Œå³é…ç½®æ–‡ä»¶ä¸­ yaf.forward_limit è¿™ä¸€ä¸ªé…ç½®é¡¹ï¼Œè¿™ä¸ªé…ç½®å¯ä»¥é¿å…è®©ç”¨æˆ·è¯·æ±‚é™·å…¥æ— é™å¾ªç¯å¤„ç†çš„é—®é¢˜ä¹‹ä¸­ï¼ˆå¦‚ç”¨æˆ·æƒé™ç³»ç»Ÿå‡ºç°bugï¼Œæ— é™è½¬å…¥ç™»å½•é€»è¾‘ï¼‰ã€‚</p>

<p>æ¯ä¸€æ¬¡åˆ†å‘è¿‡ç¨‹ä¸­ï¼Œyaf çš„é’©å­æœºåˆ¶ä¼šå…ˆé€šè¿‡ YAF_PLUGIN_HANDLE è¿™ä¸ªå®é€ä¸ªè°ƒç”¨å·²æ³¨å†Œæ’ä»¶ä¸­ predispatch å›è°ƒæ–¹æ³•ï¼Œä¹‹åé€šè¿‡ yaf_dispatcher_handle() å‡½æ•°å®é™…å¤„ç†è¯·æ±‚ï¼Œè¯·æ±‚å®Œæˆä¹‹ååœ¨é€šè¿‡ YAF_PLUGIN_HANDLE è¿™ä¸ªå®é€ä¸ªè°ƒç”¨å·²æ³¨å†Œæ’ä»¶ä¸­ postdispatch å›è°ƒæ–¹æ³•ã€‚</p>

<p>åœ¨è¯·æ±‚æ‰§è¡Œå®Œæˆä¹‹åï¼Œå‘ç”¨æˆ·å‘é€å¯¹åº”çš„è¯·æ±‚ç»“æœã€‚</p>

<p>yaf_dispatcher_handle()
yaf_dispatcher_handle() è¿™ä¸€æ–¹æ³•å®Œæˆçš„å·¥ä½œæ˜¯ä» request å¯¹è±¡ä¸­å¾—çŸ¥å½“å‰çš„ module ä¸ controllerï¼Œä¹‹åæ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ï¼Œå®ä¾‹åŒ–å¯¹åº”çš„ Controllerï¼Œä¸ºå¯¹åº”çš„ Controller è®¾å®šå¥½æ¨¡æ¿ç›®å½•ç­‰è¿™ç±»åŸºç¡€å±æ€§ã€‚</p>

<p>ä¹‹åä¼šä» request å¯¹è±¡ä¸­è·å– actionï¼Œå³å®é™…éœ€è¦æ‰§è¡Œçš„æ–¹æ³•ã€‚</p>

<p>æ‰§è¡Œå®Œå¯¹åº”çš„actionä¹‹åï¼Œå¦‚æœæ‰§è¡Œç»“æœçš„è¿”å›å€¼ä¸ä¸ºçœŸå€¼ï¼ˆé0ï¼‰ï¼Œåˆ™ä¸ä¼šæ‰§è¡Œæ¸²æŸ“é¡µé¢ä»¥åŠè¾“å‡ºç­‰å·¥ä½œã€‚</p>

<p>å¦‚æœ Dispatcher ä¸­è®¾ç½®äº†åä¸º $_auto_render ä¸”å€¼ä¸ºçœŸçš„æˆå‘˜å˜é‡ï¼ˆyaf_dispatcher.h ä¸­çš„ #define YAF_DISPATCHER_PROPERTY_NAME_RENDER â€œ_auto_renderâ€ï¼‰ï¼Œå½“å‰ Controller å¯èƒ½ä¼šè§¦å‘è‡ªåŠ¨è¾“å‡ºã€‚</p>

<p>è¿™é‡Œè¯´å¯èƒ½ï¼Œæ˜¯å› ä¸º Controller ä¸­çš„æˆå‘˜å˜é‡ä¹Ÿä¼šå½±å“åˆ°è¿™ä¸€è¡Œä¸ºã€‚</p>

<p>å¦‚æœ Controller ä¸­è®¾ç½®äº†åä¸º $yafAutoRender ä¸”å€¼ä¸ºçœŸçš„æˆå‘˜å˜é‡ï¼ˆyaf_controller.h ä¸­çš„ #define YAF_CONTROLLER_PROPERTY_NAME_RENDER â€œyafAutoRenderâ€ï¼‰ï¼Œå½“å‰ Controller ä¼šè§¦å‘è‡ªåŠ¨è¾“å‡ºã€‚åªæœ‰ Controller ä¸­æ²¡æœ‰è®¾å®šè¿™ä¸€ä¸ªæˆå‘˜å˜é‡ï¼ŒDispatcher ä¸­çš„é…ç½®æ‰ä¼šäº§ç”Ÿå½±å“ã€‚</p>

<p>å®é™…ä¸Šï¼ŒYaf_Dispatcher ä¸­çš„ enableView()/disableView() æ–¹æ³•æ‰€åšçš„å°±æ˜¯ä¿®æ”¹è¿™ä¸€æˆå‘˜å˜é‡çš„å€¼ã€‚</p>

<p>yaf_exception.c
ä¸»è¦å®šä¹‰äº†å„ç§ç±»å‹çš„å¼‚å¸¸ç±»ã€‚</p>

<p>yaf_loader.c
Yaf çš„åˆä¸€æ ¸å¿ƒç»„æˆéƒ¨åˆ†ï¼Œä»£ç ä¸ç±»è‡ªåŠ¨åŠ è½½å™¨ã€‚</p>

<p>import()
import() æ–¹æ³•ä¸»è¦å®Œæˆçš„å·¥ä½œæ˜¯åŠ è½½å¯¹åº”çš„ PHP æ–‡ä»¶åˆ°å½“å‰æ‰§è¡Œç¯å¢ƒã€‚å®é™…ä¸Šä»ç„¶è°ƒç”¨çš„æ˜¯ yaf_loader_import() å‡½æ•°è¿›è¡ŒåŠ è½½å·¥ä½œã€‚</p>

<p>autoload()
å½“ä»£ç é‡åˆ°å½“å‰æ–‡ä»¶ä¸­æœªå®šä¹‰çš„ç±»æ—¶ï¼Œéœ€è¦è‡ªåŠ¨åŠ è½½å™¨å®Œæˆå¯¹åº”ä»£ç çš„åŠ è½½å·¥ä½œã€‚</p>

<p>ä»è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘å¯ä»¥çœ‹åˆ° yaf è‡ªåŠ¨åŠ è½½çš„è§„å¾‹ã€‚</p>

<p>åœ¨æœªåšç‰¹æ®Šé…ç½®çš„æƒ…å†µä¸‹ï¼Œåœ¨é»˜è®¤æ¨¡å—ä¸‹è¿›è¡Œå¼€å‘ï¼Œç®€å•æ¥è¯´å¯ä»¥æ¦‚æ‹¬æˆå¦‚ä¸‹å‡ ä¸ªï¼š</p>

<p>ä»£ç çš„èµ·å§‹æŸ¥æ‰¾ç›®å½•éƒ½åœ¨äºåœ¨iniä¸­å®šä¹‰çš„application.directory(æ­¤å¤„å€¼å¯ä»¥ä½¿ç”¨PHPä»£ç ä¸­çš„é¢„å®šä¹‰å¸¸é‡)
_è¡¨ç¤ºç›®å½•åˆ†éš”ç¬¦ï¼Œclass Foo_BarBar_Varç­‰åŒäºç›®å½•Foo/BarBar/Var.php
Controllerä¸ºç»“å°¾çš„ç±»ä¼šåœ¨controllersç›®å½•ä¸‹è¿›è¡ŒæŸ¥æ‰¾
Modelä¸ºç»“å°¾çš„ç±»ä¼šåœ¨modelsç›®å½•ä¸‹è¿›è¡ŒæŸ¥æ‰¾
Pluginä¸ºç»“å°¾çš„ç±»ä¼šåœ¨pluginsç›®å½•ä¸‹è¿›è¡ŒæŸ¥æ‰¾
å…¶ä»–ç±»ä¼šåœ¨libraryç›®å½•ä¸‹è¿›è¡ŒæŸ¥æ‰¾
use_spl_autoload é…ç½®é¡¹ä½œç”¨
æ‰‹å†Œé‡Œé¢æåŠï¼š</p>

<p>åœ¨use_spl_autoloadå…³é—­çš„æƒ…å†µä¸‹, Yaf Autoloaderåœ¨ä¸€æ¬¡æ‰¾ä¸åˆ°çš„æƒ…å†µä¸‹, ä¼šç«‹å³è¿”å›, è€Œå‰¥å¤ºå…¶åçš„è‡ªåŠ¨åŠ è½½å™¨çš„æ‰§è¡Œæœºä¼š.</p>

<p>ä»ä»£ç æ‰§è¡Œé€»è¾‘ä¸Šæ¥çœ‹ï¼Œç¡®å®å¦‚æ­¤ï¼Œspl_autoload_register() è¿™ä¸€å‡½æ•°åœ¨æ³¨å†Œçš„å›è°ƒæ–¹æ³•è¿”å› TRUE æ—¶ï¼Œä¸ä¼šè°ƒç”¨å·²æ³¨å†Œå‡½æ•°åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªåŠ è½½å‡½æ•°ã€‚</p>

<p>Yaf åœ¨è®¾ç½®è¿™ä¸€ä¸ªå€¼ä¸ºç©ºæˆ–è€…å…³é—­æ—¶ï¼ˆ0ï¼‰,åšæ³•æ˜¯æ— è®ºä½•ç§æƒ…å†µéƒ½è¿”å›çœŸå€¼ï¼š</p>

<p>if (!YAF_G(use_spl_autoload)) {
        /** directory might be NULL since we passed a NULL */
        if (yaf_internal_autoload(file_name, file_name_len, &amp;directory TSRMLS_CC)) {
            char *lc_classname = zend_str_tolower_dup(origin_classname, class_name_len);
            if (zend_hash_exists(EG(class_table), lc_classname, class_name_len + 1)) {
â€¦
                RETURN_TRUE; // æ³¨æ„
            } else {
                efree(lc_classname);
                php_error_docref(NULL TSRMLS_CC, E_STRICT, â€œCould not find class %s in %sâ€, class_name, directory);
            }
        }  else {
            php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œFailed opening script %s: %sâ€, directory, strerror(errno));
        }</p>

<p>â€¦
        RETURN_TRUE; // æ³¨æ„
    }</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
if (!YAF_G(use_spl_autoload)) {
        /** directory might be NULL since we passed a NULL */
        if (yaf_internal_autoload(file_name, file_name_len, &amp;directory TSRMLS_CC)) {
            char *lc_classname = zend_str_tolower_dup(origin_classname, class_name_len);
            if (zend_hash_exists(EG(class_table), lc_classname, class_name_len + 1)) {
â€¦
                RETURN_TRUE; // æ³¨æ„
            } else {
                efree(lc_classname);
                php_error_docref(NULL TSRMLS_CC, E_STRICT, â€œCould not find class %s in %sâ€, class_name, directory);
            }
        }  else {
            php_error_docref(NULL TSRMLS_CC, E_WARNING, â€œFailed opening script %s: %sâ€, directory, strerror(errno));
        }</p>

<p>â€¦
        RETURN_TRUE; // æ³¨æ„
    }</p>

<p>ä½†æ˜¯åœ¨é›†æˆ Eloquent çš„å°è¯•é‡Œï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å¹¶æ²¡æœ‰é…ç½®è¿™ä¸€ä¸ªé¡¹ç›®ä¸º1ï¼ˆå³å¼€å¯ï¼‰ï¼ŒæŒ‰ç…§æ‰©å±•æºç çš„é€»è¾‘ï¼ŒComposer ç”Ÿæˆçš„åŠ è½½å™¨åº”è¯¥ä¸èµ·ä½œç”¨ï¼Œè¿™ä¸ªå’Œå®é™…æƒ…å†µä¸ç¬¦ï¼Œå› ä¸º Eloquent åœ¨æ ·ä¾‹ç¨‹åºä¸­è¡¨ç°æ­£å¸¸ã€‚</p>

<p>ç©¶å…¶åŸå› ï¼Œå…¶å®å¾ˆç®€å•ï¼Œå³ Composer ç”Ÿæˆçš„è‡ªåŠ¨åŠ è½½å™¨åœ¨æ³¨å†Œæ—¶è¦æ±‚æ³¨å†Œåˆ°äº†åŠ è½½å‡½æ•°é˜Ÿåˆ—çš„é¦–ä½ã€‚</p>

<p>å…ˆæ¥çœ‹ spl_autoload_register() æ–¹æ³•çš„åŸå‹ï¼š</p>

<p>bool spl_autoload_register ([ callable $autoload_function [, bool $throw = true [, bool $prepend = false ]]] )</p>

<p>1
2
bool spl_autoload_register ([ callable $autoload_function [, bool $throw = true [, bool $prepend = false ]]] )</p>

<p>è®©äººå€¼å¾—æ³¨æ„çš„æ˜¯ $prepend å‚æ•°ï¼š</p>

<p>prepend
    å¦‚æœæ˜¯ trueï¼Œspl_autoload_register() ä¼šæ·»åŠ å‡½æ•°åˆ°é˜Ÿåˆ—ä¹‹é¦–ï¼Œè€Œä¸æ˜¯é˜Ÿåˆ—å°¾éƒ¨ã€‚</p>

<p>1
2
3
prepend
    å¦‚æœæ˜¯ trueï¼Œspl_autoload_register() ä¼šæ·»åŠ å‡½æ•°åˆ°é˜Ÿåˆ—ä¹‹é¦–ï¼Œè€Œä¸æ˜¯é˜Ÿåˆ—å°¾éƒ¨ã€‚</p>

<p>è¿›å…¥åˆ° vendor ç›®å½•ï¼Œç¿»çœ‹ autoload_real.php æºç ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>

<p>class ComposerAutoloaderInit4604f3b23b635a9f5adc52f8616258a1
{
    private static $loader;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static function loadClassLoader($class)
{
    if ('Composer\Autoload\ClassLoader' === $class) {
        require __DIR__ . '/ClassLoader.php';
    }
}

public static function getLoader()
{
    if (null !== self::$loader) {
        return self::$loader;
    }

    ...

    $loader-&gt;register(true); // æ³¨æ„ï¼Œè¿™é‡Œä¸º true
    
    ...

    return $loader;
} }
</code></pre></div></div>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
class ComposerAutoloaderInit4604f3b23b635a9f5adc52f8616258a1
{
    private static $loader;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static function loadClassLoader($class)
{
    if ('Composer\Autoload\ClassLoader' === $class) {
        require __DIR__ . '/ClassLoader.php';
    }
}
 
public static function getLoader()
{
    if (null !== self::$loader) {
        return self::$loader;
    }
 
    ...
 
    $loader-&gt;register(true); // æ³¨æ„ï¼Œè¿™é‡Œä¸º true
    
    ...
 
    return $loader;
} }
</code></pre></div></div>

<p>è¿™ä¸ª register æ–¹æ³•çš„å®šä¹‰ä¸ºï¼š</p>

<p>/**</p>
<ul>
  <li>Registers this instance as an autoloader.
 *</li>
  <li>@param bool $prepend Whether to prepend the autoloader or not
 */
public function register($prepend = false)
{
 spl_autoload_register(array($this, â€˜loadClassâ€™), true, $prepend);
}</li>
</ul>

<p>1
2
3
4
5
6
7
8
9
10
/**</p>
<ul>
  <li>Registers this instance as an autoloader.
 *</li>
  <li>@param bool $prepend Whether to prepend the autoloader or not
 */
public function register($prepend = false)
{
 spl_autoload_register(array($this, â€˜loadClassâ€™), true, $prepend);
}</li>
</ul>

<p>è‡³æ­¤ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é€šè¿‡ Composer ç”Ÿæˆçš„è‡ªåŠ¨åŠ è½½æ–¹æ³•ï¼Œå®é™…ä¸Šä¼šä¼˜å…ˆäº yaf è‡ªèº«çš„è‡ªåŠ¨åŠ è½½æ–¹æ³•ï¼Œç”±äº yaf çš„è‡ªåŠ¨åŠ è½½æ–¹æ³•ä¹Ÿæ˜¯é€šè¿‡ spl_autoload_register() æ–¹æ³•æ³¨å†Œçš„ï¼Œå¤„äºåŒä¸€ä¸ªåŠ è½½å‡½æ•°é˜Ÿåˆ—ï¼Œåœ¨ Composer å£°æ˜ä¼˜å…ˆçš„æƒ…å†µä¸‹ï¼ŒåŠ è½½å‡½æ•°æ‰§è¡Œé¡ºåºå°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p>

<p>yaf_plugin.c
æ’ä»¶æŠ½è±¡ç±» Yaf_Plugin_Abstract çš„å®šä¹‰ã€‚åœ¨è¿™é‡Œï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ’ä»¶å¯ä»¥å®ç°çš„ hook æ–¹æ³•ï¼š</p>

<p>zend_function_entry yaf_plugin_methods[] = {
    PHP_ME(yaf_plugin, routerStartup,        plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, routerShutdown,       plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, dispatchLoopStartup,  plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, dispatchLoopShutdown, plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, preDispatch,          plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, postDispatch,         plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, preResponse,          plugin_arg, ZEND_ACC_PUBLIC)
    {NULL, NULL, NULL}
};</p>

<p>1
2
3
4
5
6
7
8
9
10
11
zend_function_entry yaf_plugin_methods[] = {
    PHP_ME(yaf_plugin, routerStartup,        plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, routerShutdown,       plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, dispatchLoopStartup,  plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, dispatchLoopShutdown, plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, preDispatch,          plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, postDispatch,         plugin_arg, ZEND_ACC_PUBLIC)
    PHP_ME(yaf_plugin, preResponse,          plugin_arg, ZEND_ACC_PUBLIC)
    {NULL, NULL, NULL}
};</p>

<p>ä»–ä»¬éƒ½åªæ¥å—ä¸¤ä¸ªå‚æ•°ï¼šrequest ä¸ responseã€‚</p>

<p>ZEND_BEGIN_ARG_INFO_EX(plugin_arg, 0, 0, 2)
    ZEND_ARG_OBJ_INFO(0, request, Yaf_Request_Abstract, 0)
    ZEND_ARG_OBJ_INFO(0, response, Yaf_Response_Abstract, 0)
ZEND_END_ARG_INFO()</p>

<p>1
2
3
4
5
ZEND_BEGIN_ARG_INFO_EX(plugin_arg, 0, 0, 2)
    ZEND_ARG_OBJ_INFO(0, request, Yaf_Request_Abstract, 0)
    ZEND_ARG_OBJ_INFO(0, response, Yaf_Response_Abstract, 0)
ZEND_END_ARG_INFO()</p>

<p>yaf_registry.c
Yaf å…¨å±€å­˜å‚¨ç±» Yaf_Registry å®šä¹‰ã€‚ç”¨äºåœ¨æ•´ä¸ª app å£°æ˜å‘¨æœŸå†…å­˜å‚¨å…±æœ‰æ•°æ®ã€‚æ‰€æœ‰æ•°æ®éƒ½ä¼šå­˜å‚¨åˆ°ä¸€ä¸ª zval ä¹‹ä¸­ã€‚</p>

<p>https://blog.wislay.com/articles/549</p>

<p>Yaf ç‰ˆæœ¬ä¸º 2.3.0ã€‚</p>

<p>æœ¬ç¯‡ä¸»è¦ç®€å•è®°å½•äº†ï¼š</p>

<p>yaf_request.c
yaf_response.c
yaf_router.c
yaf_session.c
æºç é˜…è¯»è¿‡ç¨‹ä¸­çš„ä¸€äº›é—®é¢˜å’Œç†è§£ã€‚</p>

<p>yaf_request.c
å®šä¹‰äº† Yaf_Request_Abstract è¿™ä¸€æŠ½è±¡ç±»ã€‚åŒæ—¶ä»¥åŠå£°æ˜äº†è¿™äº›ç±»å‹çš„ getter / setter æ–¹æ³•ã€‚</p>

<p>ä¸€ä¸ª yaf çš„ request åŒ…å«äº†éœ€è¦è°ƒç”¨çš„ Controller / Action ç­‰ç­‰ä¿¡æ¯ã€‚</p>

<p>ä¸€ä¸ªåº”ç”¨åœºæ™¯æ˜¯åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶åœ¨åˆ†å‘å‰æ ¹æ®ç‰¹å®šæƒ…å†µæ”¹åŠ¨ request çš„ä¿¡æ¯ï¼Œä½¿å¾—å¯ä»¥æ›´æ”¹è¯·æ±‚è§¦å‘çš„æ“ä½œå¯¹è±¡ã€‚</p>

<p>yaf_response.c
å®šä¹‰äº† Yaf_Response_Abstract è¿™ä¸€æŠ½è±¡ç±»ã€‚</p>

<p>Response å¯¹è±¡ä¸­å…³é”®çš„æ“ä½œæ˜¯è¿”å›å†…å®¹çš„æ“ä½œä»¥åŠå®é™…è¿”å›å†…å®¹çš„æ–¹æ³•ã€‚</p>

<p>è¿”å›å†…å®¹å¯ä»¥åœ¨å¤šæ¬¡çš„ foward ç­‰è¿‡ç¨‹ä¸­ï¼Œåœ¨å½“å‰è¿”å›æ•°æ®ä¹‹å‰æˆ–è€…ä¹‹åè¿›è¡Œè¿½åŠ æ“ä½œï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ›¿æ¢æœ€ç»ˆè¿”å›çš„æ•°æ®ã€‚è¿™äº›æ“ä½œéƒ½é€šè¿‡ yaf_response_alter_body() å‡½æ•°å®ç°ï¼Œè¿™ä¸€å‡½æ•°å¯ä»¥æ”¯æŒï¼š</p>

<p>YAF_RESPONSE_PREPEND æ·»åŠ åˆ°å¤´éƒ¨
YAF_RESPONSE_APPEND è¿½åŠ åˆ°å°¾éƒ¨
YAF_RESPONSE_REPLACE ä¿®æ”¹æ•°æ®
ç›¸å¯¹åº”çš„å°±æ˜¯ response å¯¹è±¡ä¸­çš„ prependBody() / appendBody() / setBody() æ–¹æ³•ã€‚</p>

<p>å¯¹äº HTTP åè®®ä¸Šè¯¸å¦‚ Header ç­‰å†…å®¹çš„æ“ä½œï¼Œä¹Ÿåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­è¿›è¡Œäº†å®šä¹‰ã€‚</p>

<p>yaf_router.c
è¿™æ˜¯ yaf æ¡†æ¶æœ€ä¸ºé‡è¦çš„ç»„æˆéƒ¨åˆ†ä¹‹ä¸€ã€‚</p>

<p>åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œå®šä¹‰äº† Yaf_Router è¿™ä¸€ classã€‚åŒæ—¶ä¹Ÿå®šä¹‰äº† static / simple / supervar / rewrite / regex / map è¿™å‡ ä¸ªè·¯ç”±è§„åˆ™ã€‚</p>

<p>è·¯ç”±è¿‡ç¨‹ä¸æ·»åŠ è·¯ç”±è§„åˆ™çš„é¡ºåºç›¸åï¼Œåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æœ‰æ‰€æåŠã€‚</p>

<p>æ— è®ºæ˜¯å†…ç½®è·¯ç”±è§„åˆ™ï¼Œè¿˜æ˜¯æ–°å¢çš„è·¯ç”±è§„åˆ™ï¼Œéƒ½éœ€è¦å®ç° Yaf_Route_Interface è¿™ä¸€ä¸ªæ¥å£ï¼Œå®ç° route() æ–¹æ³•ï¼Œæ¥å— request å¯¹è±¡ï¼Œè®¤å®šä¸ºåŒ¹é…ä¹‹åï¼Œä¿®æ”¹å½“å‰è¯·æ±‚å¯¹è±¡çš„ module / controller / actionï¼Œå¹¶è¿”å›çœŸå€¼ã€‚</p>

<p>å¦‚æœæ²¡æœ‰è®¾å®šï¼Œåˆ™ä½¿ç”¨ static è·¯ç”±è§„åˆ™ã€‚</p>

<p>å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡å½“å‰ app çš„ dispatcher ä¸­çš„ router æ·»åŠ ä¸€ä¸ªå®ä¾‹åŒ–çš„è·¯ç”±è§„åˆ™ï¼Œå®ç°è‡ªå·±è·¯ç”±çš„ç›®çš„ã€‚</p>

<p>assemble()
assemble() æ–¹æ³•æ˜¯ä¸€ä¸ªæ ¹æ®è‡ªèº«è·¯ç”±è§„åˆ™æ‹¼è£…å‡ºåˆç† url çš„å·¥å…·ï¼Œæ¯ä¸€ä¸ªè·¯ç”±ç±»å‹éƒ½éœ€è¦ç»“åˆè‡ªèº«çš„è§„åˆ™ï¼Œæ¥å®ç°è¿™ä¸ªæ–¹æ³•ã€‚</p>

<p>Yaf è·¯ç”±æ—¶éœ€è¦çŸ¥é“ module / controller / actionï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ assemble() æ—¶ï¼Œè‡ªç„¶ä¹Ÿè¦é€šè¿‡æ•°ç»„çš„æ–¹å¼ï¼Œä¼ é€’è¿™äº›å‚æ•°ï¼Œå³æºç ä¸­çš„ï¼š</p>

<p>YAF_ROUTE_ASSEMBLE_MOUDLE_FORMAT :m
YAF_ROUTE_ASSEMBLE_CONTROLLER_FORMAT :c
YAF_ROUTE_ASSEMBLE_ACTION_FORMAT :a
è¿™æ˜¯ä¸€ä¸ªäº†è§£å„ä¸ªè·¯ç”±çš„æ‰‹æ®µã€‚</p>

<p>å…³äºå…·ä½“è·¯ç”±çš„ä½¿ç”¨ï¼Œå¦èµ·ç¯‡å¹…ã€‚</p>

<p>yaf_session.c
å®šä¹‰äº† Yaf_Session è¿™ä¸€ä¸ªç±»ã€‚</p>

<p>å¯ä»¥é€šè¿‡ getInstance() æ–¹æ³•è·å¾—å•ä¾‹ã€‚</p>

<p>Yaf_Session ç±»åªæ˜¯å¯¹ $_SESSION è¿›è¡Œäº†å°è£…ï¼Œå®é™…ä¸Šæ“ä½œçš„è¿˜æ˜¯ $_SESSION å˜é‡ï¼Œåœ¨åˆå§‹åŒ–è¿‡ç¨‹ä¸­å°† $_SESSION å˜é‡å’Œæˆå‘˜å±æ€§ sess è¿›è¡Œäº†å…³è”</p>

<p>https://www.kancloud.cn/wuzhc/note/798302</p>
:ET