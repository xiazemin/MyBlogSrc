I"å<p>https://github.com/prometheus/client_golang</p>

<p>https://segmentfault.com/a/1190000013565079</p>

<p>Query ç±»å‹çš„å†™æ³•ã€‚</p>

<p>Name</p>

<p>è¯¥å˜é‡çš„åç§°ï¼Œä¸æ”¯æŒç‰¹æ®Šå­—ç¬¦ä¾‹å¦‚$
Refresh</p>

<p>å¯é€‰Neverï¼ŒOn Dashboard Loadå’ŒOn Time Range Change
å¦‚æœè¯¥å˜é‡çš„å€¼ç»å¸¸åŠ¨æ€å¢åŠ çš„è¯åˆ™é€‰ On Time Range Changeï¼Œå¦åˆ™ On Dashboard Load å°±è¶³å¤Ÿäº†ï¼ŒQuery ç±»å‹åƒä¸‡ä¸è¦é€‰ Neverï¼Œå¦åˆ™å˜é‡åªä¼šåœ¨ä½ ç‚¹è¿›æ¥ç¼–è¾‘å˜é‡æ—¶æ‰ä¼šæ›´æ–°
Query</p>

<p>æŸ¥è¯¢è¯­å¥ï¼Œä¾‹å¦‚ stats.timers.fe.test.*
ç¼–å†™æ—¶ grafana ä¸ä¼šè§¦å‘è¯·æ±‚ï¼Œéœ€è¦åœ¨è¾“å…¥æ¡†å¤–é¢ç‚¹å‡»ä¸€ä¸‹ï¼ŒæŸ¥è¯¢åˆ°çš„å€¼å°±ä¼šæ˜¾ç¤ºåœ¨ä¸‹è¾¹äº†
<!-- more -->
https://segmentfault.com/a/1190000013565079
https://github.com/scotwells/prometheus-by-example/tree/master/job-processor</p>

<p>å½“ä½¿ç”¨ Prometheus ç”ŸæˆæœåŠ¡çº§åˆ«çš„æŒ‡æ ‡æ—¶ï¼Œæœ‰ä¸¤ä¸ªå…¸å‹çš„æ–¹æ³•ï¼šå†…åµŒåœ°è¿è¡Œåœ¨ä¸€ä¸ªæœåŠ¡é‡Œå¹¶åœ¨ HTTP æœåŠ¡å™¨ä¸Šæš´éœ²ä¸€ä¸ª /metrics ç«¯ç‚¹ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªç‹¬ç«‹è¿è¡Œçš„è¿›ç¨‹ï¼Œå»ºç«‹ä¸€ä¸ªæ‰€è°“çš„å¯¼å‡ºå™¨ã€‚</p>

<p>https://godoc.org/github.com/prometheus/client_golang/prometheus</p>

<p>Counterï¼ˆè®¡æ•°å™¨ï¼‰
counter æ˜¯ä¸€ä¸ªç´¯è®¡çš„æŒ‡æ ‡ï¼Œä»£è¡¨ä¸€ä¸ªå•è°ƒé€’å¢çš„è®¡æ•°å™¨ï¼Œå®ƒçš„å€¼åªä¼šå¢åŠ æˆ–åœ¨é‡å¯æ—¶é‡ç½®ä¸ºé›¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ counter æ¥ä»£è¡¨æœåŠ¡è¿‡çš„è¯·æ±‚æ•°ï¼Œå®Œæˆçš„ä»»åŠ¡æ•°ï¼Œæˆ–è€…é”™è¯¯çš„æ¬¡æ•°ã€‚</p>

<p>Gaugeï¼ˆè®¡é‡å™¨ï¼‰
gauge æ˜¯ä»£è¡¨ä¸€ä¸ªæ•°å€¼ç±»å‹çš„æŒ‡æ ‡ï¼Œå®ƒçš„å€¼å¯ä»¥å¢æˆ–å‡ã€‚gauge é€šå¸¸ç”¨äºä¸€äº›åº¦é‡çš„å€¼ä¾‹å¦‚æ¸©åº¦æˆ–æ˜¯å½“å‰å†…å­˜ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç”¨äºä¸€äº›å¯ä»¥å¢å‡çš„â€œè®¡æ•°â€ï¼Œå¦‚æ­£åœ¨è¿è¡Œçš„ Goroutine ä¸ªæ•°ã€‚</p>

<p>Histogramï¼ˆåˆ†å¸ƒå›¾ï¼‰
histogram å¯¹è§‚æµ‹å€¼ï¼ˆç±»ä¼¼è¯·æ±‚å»¶è¿Ÿæˆ–å›å¤åŒ…å¤§å°ï¼‰è¿›è¡Œé‡‡æ ·ï¼Œå¹¶ç”¨ä¸€äº›å¯é…ç½®çš„æ¡¶æ¥è®¡æ•°ã€‚å®ƒä¹Ÿä¼šç»™å‡ºä¸€ä¸ªæ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œã€‚</p>

<p>Summaryï¼ˆæ‘˜è¦ï¼‰
è·Ÿ histogram ç±»ä¼¼ï¼Œsummary ä¹Ÿå¯¹è§‚æµ‹å€¼ï¼ˆç±»ä¼¼è¯·æ±‚å»¶è¿Ÿæˆ–å›å¤åŒ…å¤§å°ï¼‰è¿›è¡Œé‡‡æ ·ã€‚åŒæ—¶å®ƒä¼šç»™å‡ºä¸€ä¸ªæ€»æ•°ä»¥åŠæ‰€æœ‰è§‚æµ‹å€¼çš„æ€»å’Œï¼Œå®ƒåœ¨ä¸€ä¸ªæ»‘åŠ¨çš„æ—¶é—´çª—å£ä¸Šè®¡ç®—å¯é…ç½®çš„åˆ†ä½æ•°ã€‚</p>

<p>// create a new mux server
server := http.NewServeMux()
// register a new handler for the /metrics endpoint
server.Handle(â€œ/metricsâ€, promhttp.Handler())
// start an http server using the mux server
http.ListenAndServe(â€œ:9001â€, server)</p>

<p>var (
  totalCounterVec = prometheus.NewCounterVec(
    prometheus.CounterOpts{
      Namespace: â€œworkerâ€,
      Subsystem: â€œjobsâ€,
      Name: â€œprocessed_totalâ€,
      Help: â€œTotal number of jobs processed by the workersâ€,
    },
    // We will want to monitor the worker ID that processed the
    // job, and the type of job that was processed
    []string{â€œworker_idâ€, â€œtypeâ€},
  )
)</p>

<p>func INIt() {
  â€¦
  // register with the prometheus collector
  prometheus.MustRegister(totalCounterVec)
  â€¦
}</p>

<p>func startWorker(workerID string, jobs &lt;-chan *Job) {
  for {
    select {
    case job := &lt;-jobs:
      â€¦
      totalCounterVec.WithLabelValues(workerID, job.Type).Inc()
      â€¦
    }
  }
}</p>

<p>https://studygolang.com/articles/17959</p>

<p>æŠ“å–é…ç½®çš„ä¿¡æ¯ã€‚</p>

<p>scrape_configs:</p>
<ul>
  <li>job_name: â€˜demoâ€™
    <h1 id="scrape-the-service-every-second">scrape the service every second</h1>
    <p>scrape_interval: 1s</p>
    <h1 id="setup-the-static-configs">setup the static configs</h1>
    <p>static_configs:</p>
    <ul>
      <li>targets: [â€˜docker.for.mac.localhost:9009â€™]</li>
    </ul>
  </li>
</ul>

<p>ä¸ºæ­¤æŒ‡æ ‡ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ rate() å‡½æ•°æ¥æ¯”è¾ƒå¤„ç†ä»»åŠ¡æ‰€èŠ±è´¹çš„ç§’æ•°ä»¥åŠå¤„ç†å®Œæˆçš„ä»»åŠ¡æ•°ã€‚</p>

<p>sum(
  rate(worker_jobs_process_time_seconds_sum[5m])
  /
  rate(worker_jobs_process_time_seconds_count[5m])
)</p>

:ET