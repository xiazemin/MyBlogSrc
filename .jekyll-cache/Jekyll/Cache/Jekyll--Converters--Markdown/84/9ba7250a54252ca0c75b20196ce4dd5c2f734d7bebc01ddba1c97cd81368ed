I"¡<p>Martiniæ ¸å¿ƒ
æˆ‘ä»¬ä»æœ€ç®€å•çš„å®˜æ–¹å®ä¾‹å…¥æ‰‹ï¼š</p>

<p>package main</p>

<p>import â€œgithub.com/go-martini/martiniâ€</p>

<p>func main() {
  m := martini.Classic()
  m.Get(â€œ/â€, func() string {
    return â€œHello world!â€
  })
  m.Run()
}
martini.Martiniæ˜¯è‡ªå¸¦çš„æ ¸å¿ƒç»“æ„ï¼Œè´Ÿè´£å®Œæˆä¾èµ–æ³¨å…¥å’Œè°ƒç”¨çš„è¿‡ç¨‹ã€‚martini.ClassicMartiniæ˜¯è·¯ç”±martini.Routerå’Œmartini.Martiniçš„ç»„åˆï¼Œå®ç°è·¯ç”±åˆ†å‘å’Œé€»è¾‘è°ƒç”¨çš„è¿‡ç¨‹ã€‚m := martini.Classic()è¿”å›çš„å°±æ˜¯martini.ClassicMartiniã€‚å…·ä½“åœ¨martini.go#L104:</p>

<p>func Classic() <em>ClassicMartini {
	r := NewRouter()
	m := New()
	m.Use(Logger())
	m.Use(Recovery())
	m.Use(Static(â€œpublicâ€))
	m.MapTo(r, (</em>Routes)(nil))
	m.Action(r.Handle)
	return &amp;ClassicMartini{m, r}
}
é‡Œé¢çš„m := New()å®šä¹‰åœ¨martini.go#L38:</p>

<p>func New() *Martini {
	m := &amp;Martini{Injector: inject.New(), action: func() {}, logger: log.New(os.Stdout, â€œ[martini] â€œ, 0)}
	m.Map(m.logger)
	m.Map(defaultReturnHandler())
	return m
}
ä¾èµ–æ³¨å…¥
ä¸Šé¢å¾ˆæ˜æ˜¾çš„çœ‹åˆ°ä¸¤ä¸ªå¥‡ç‰¹æ–¹æ³•ï¼šm.Map()ã€m.MapTo()ã€‚è¿™é‡Œï¼Œéœ€è¦æ³¨æ„martiniçš„ä¸€ä¸ªæœ€é‡è¦åŸåˆ™ï¼Œæ³¨å…¥çš„ä»»ä½•ç±»å‹çš„ç»“æ„ï¼Œéƒ½æ˜¯å”¯ä¸€çš„ã€‚å³å¦‚ï¼š</p>

<p>type User struct{
    Id int
}</p>

<p>m.Map(&amp;User{Id:1})
m.Map(&amp;User{Id:2})</p>

<p>martiniåœ¨å¯»æ‰¾&amp;Userç±»å‹çš„æ—¶å€™ï¼Œåªèƒ½è·å–åˆ°&amp;User{Id:2}ç»“æ„ï¼ˆæœ€åæ³¨å†Œçš„ï¼‰ã€‚Mapçš„ä½œç”¨ï¼Œå°±æ˜¯å‘å†…éƒ¨æ³¨å†Œå¯¹åº”ç±»å‹çš„å…·ä½“å¯¹è±¡æˆ–è€…å€¼ã€‚ç±»å‹ç´¢å¼•æ˜¯reflect.Typeã€‚ä»è€Œæˆ‘ä»¬å¯ä»¥ç†è§£åˆ°m.New()çš„ä»£ç ä¸­å°†m.Logger(*log.Logger)å’ŒdefaultReturnHandler(martini.ReturnHandler)(æ‹¬å·ä¸­æ˜¯ç±»å‹ç´¢å¼•)æ³¨å…¥åˆ°å†…éƒ¨ã€‚</p>

<p>è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªé—®é¢˜ã€‚æ¥å£è¿™ç§ç±»å‹ï¼Œæ˜¯æ— æ³•ç”¨reflect.Type()ç›´æ¥è·å–çš„ï¼ˆå› ä¸ºä¼ æ¥çš„éƒ½æ˜¯å·²ç»å®ç°æ¥å£çš„å…·ä½“ç»“æ„ï¼‰ã€‚è§£å†³æ–¹æ³•å°±æ˜¯m.MapTo()ã€‚</p>

<p>m.MapTo(r, (*Routes)(nil))
å³å°†r(martini.router)æŒ‰ç…§martini.Routeræ¥å£ï¼ˆæ³¨æ„å¤§å°å†™ï¼‰ç±»å‹æ³¨å…¥åˆ°å†…éƒ¨ã€‚</p>

<p>(*Routes)(nil)
ä¹Ÿæ˜¯é«˜æ˜çš„æ„é€ ã€‚æ¥å£çš„é»˜è®¤å€¼ä¸æ˜¯nilï¼Œæ— æ³•ç›´æ¥newã€‚ä½†æ˜¯æŒ‡é’ˆçš„é»˜è®¤å€¼æ˜¯nilï¼Œå¯ä»¥ç›´æ¥èµ‹å€¼ï¼Œæ¯”å¦‚var user *User; user = nilã€‚å› æ­¤ä»–æ³¨å†Œä¸€ä¸ªæ¥å£æŒ‡é’ˆç±»å‹çš„ç©ºæŒ‡é’ˆï¼Œç”¨reflect.Type.Elem()æ–¹æ³•å°±å¯ä»¥è·å–åˆ°æŒ‡é’ˆçš„å†…éƒ¨ç±»å‹ï¼Œå³æ¥å£ç±»å‹ï¼Œå¹¶ä»¥æ¥å£ç±»å‹ç´¢å¼•æ³¨å…¥åˆ°å†…éƒ¨ã€‚</p>

<p>è·¯ç”±è¿‡ç¨‹
HTTPå¤„ç†
martini.Martiniå®ç°äº†http.Handleræ–¹æ³•ï¼Œå®é™…çš„HTTPæ‰§è¡Œè¿‡ç¨‹åœ¨ä»£ç martini.go#L68:</p>

<p>func (m <em>Martini) ServeHTTP(res http.ResponseWriter, req *http.Request) {
	m.createContext(res, req).run()
}
è¿™é‡Œéœ€è¦æˆ‘ä»¬å…³æ³¨m.createContextï¼Œå®ƒè¿”å›</em>martini.contextç±»å‹ï¼Œä»£ç martini.go#L87ï¼š</p>

<p>func (m <em>Martini) createContext(res http.ResponseWriter, req *http.Request) *context {
	c := &amp;context{inject.New(), m.handlers, m.action, NewResponseWriter(res), 0}
	c.SetParent(m)
	c.MapTo(c, (</em>Context)(nil))
	c.MapTo(c.rw, (<em>http.ResponseWriter)(nil))
	c.Map(req)
	return c
}
åˆ›å»º</em>martini.contextç±»å‹ï¼›ç„¶åSetParentè®¾ç½®å¯»æ‰¾æ³¨å…¥å¯¹è±¡çš„æ—¶å€™åŒæ—¶ä»m(<em>martini.Martini)ä¸­å¯»æ‰¾ï¼ˆ</em>martini.contextå’Œ*martini.Martiniä¸¤ä¸ªç‹¬ç«‹çš„injectï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥è·å–m.Mapæ³¨å…¥çš„æ•°æ®ã€‚</p>

<p>è¿™é‡Œå‰å‡ºæ¥è¯´ï¼šä»ä»£ç çœ‹å‡ºå®é™…ä¸Šæ³¨å…¥çš„æ•°æ®æœ‰ä¸¤å±‚ï¼Œåˆ†åˆ«åœ¨<em>martini.contextå’Œ</em>martini.Martiniã€‚*martini.contextä¸­çš„æ˜¯å½“å‰è¯·æ±‚å¯ä»¥è·å–çš„ï¼ˆæ¯ä¸ªè¯·æ±‚éƒ½ä¼šm.createContext()ï¼Œéƒ½æ˜¯æ–°çš„å¯¹è±¡ï¼‰;martini.Martiniæ˜¯å…¨å±€çš„ï¼Œä»»ä½•è¯·æ±‚éƒ½å¯ä»¥è·å–åˆ°ã€‚</p>

<p>å›åˆ°ä¸Šä¸€æ®µï¼Œc.MapToæŠŠ<em>martini.contextæŒ‰martini.Contextæ¥å£ï¼Œå°†martini.ResponseWriteræŒ‰http.ResponseWriteræ¥å£ï¼ŒæŠŠreq(</em>http.Request)æ³¨å…¥åˆ°å½“å‰ä¸Šä¸‹æ–‡ã€‚</p>

<p>context.runæ–¹æ³•å®šä¹‰åœ¨martini.go#L163:</p>

<p>func (c *context) run() {
	for c.index &lt;= len(c.handlers) {
		_, err := c.Invoke(c.handler())
		if err != nil {
			panic(err)
		}
		c.index += 1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	if c.Written() {
		return
	}
} } å®ƒåœ¨å¾ªç¯c.handlers(æ¥è‡ªm.handlers,createContextä»£ç ä¸­)ã€‚è¿™é‡Œæƒ³è§£é‡Šä¸‰ä¸ªç»†èŠ‚ã€‚
</code></pre></div></div>

<p>c.Invokeæ˜¯inject.Invokeæ–¹æ³•ï¼Œå†…éƒ¨å°±æ˜¯è·å–c.hanlder()è¿”å›çš„martini.Handler(func)ç±»å‹çš„ä¼ å…¥å‚æ•°reflect.Type.In()ï¼Œæ ¹æ®å‚æ•°ä¸ªæ•°å’Œç±»å‹å»å†…éƒ¨æ‰¾å¯¹åº”çš„ç»“æ„ï¼Œç„¶åæ‹¼è£…æˆ[]reflect.Valueç»™å‡½æ•°çš„reflect.Value(func).Call()ã€‚</p>

<p>c.handler()çš„è¿”å›æ¥è‡ªä¸¤ä¸ªæ–¹é¢,c.hanlderså’Œc.actionã€‚c.handlersæ¥è‡ªm.Use()æ·»åŠ ,c.actionæ¥è‡ªr.Handle(*martini.router.Handle)(è§ä¸Šæ–‡martini.ClassicMartini.Newä¸­çš„m.Action(r.Handle))ã€‚å› æ­¤ï¼Œå¯ä»¥å‘ç°å®é™…ä¸Šhandlersæ˜¯æœ‰ä¸¤ä¸ªåˆ—è¡¨ï¼Œä¸€ä¸ªæ˜¯c.handlers([]martini.handler)å’Œr.handlers(martini.routerContext.handlers)ã€‚è€Œä¸”å‰è€…å…ˆæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´æ— è®ºm.Useå†™åœ¨å“ªå„¿ï¼Œéƒ½è¦æ¯”routeræ·»åŠ çš„funcå…ˆæ‰§è¡Œã€‚</p>

<p>c.Writtenåˆ¤æ–­è¯·æ±‚æ˜¯å¦å·²ç»å‘é€ã€‚ä»–å®é™…ä¸Šæ˜¯åˆ¤æ–­martini.ResponseWriter.statusæ˜¯å¦å¤§äº0ã€‚å› æ­¤åªè¦å‘é€äº†response statusï¼Œhandlersè¿‡ç¨‹å°±ä¼šåœæ­¢ã€‚</p>

<p>è·¯ç”±è°ƒç”¨
ä»ä¸Šé¢å¯ä»¥çŸ¥é“ï¼Œè·¯ç”±è°ƒç”¨è¿‡ç¨‹æœ‰ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ˜¯m.Use()æ·»åŠ çš„handlersï¼ŒäºŒæ˜¯è·¯ç”±æ·»åŠ æ¯”å¦‚m.Get(â€œ/â€,handlersâ€¦)ä¸­çš„handlersã€‚m.Useçš„handlersè°ƒç”¨å°±æ˜¯ä¸Šæ–‡çš„*martini.context.runæ–¹æ³•ï¼Œä¸å†èµ˜è¿°ã€‚è·¯ç”±ä¸­çš„handlersæ‰§è¡Œæ˜¯åœ¨router.go#L218:</p>

<p>func (r <em>route) Handle(c Context, res http.ResponseWriter) {
	context := &amp;routeContext{c, 0, r.handlers}
	c.MapTo(context, (</em>Context)(nil))
	context.run()
}
å’Œrouter.go#L315:</p>

<p>func (r *routeContext) run() {
	for r.index &lt; len(r.handlers) {
		handler := r.handlers[r.index]
		vals, err := r.Invoke(handler)
		if err != nil {
			panic(err)
		}
		r.index += 1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	// if the handler returned something, write it to the http response
	if len(vals) &gt; 0 {
		ev := r.Get(reflect.TypeOf(ReturnHandler(nil)))
		handleReturn := ev.Interface().(ReturnHandler)
		handleReturn(r, vals)
	}

	if r.Written() {
		return
	}
} } å¦‚æœä½ å·²ç»ç†è§£ä¸Šæ–‡ä¸­è¯´æ˜ï¼Œè¿™ä¸ªè¿‡ç¨‹å’Œmartini.context.runæ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€è¿™é‡Œè¦è§£é‡Šçš„æ˜¯martini.ReturnHandlerã€‚å®ƒä¸å¾ˆä¸Šæ–‡ä¸­çš„m.Map(defaultReturnHandler())é¥ç›¸å‘¼åº”ã€‚
</code></pre></div></div>

<p>ä¸­é—´ä»¶
ä»ä¸Šæ–‡ä¸éš¾ç†è§£ï¼Œä¸­é—´ä»¶å…¶å®å°±æ˜¯martini.Handlerè¢«m.Useæ·»åŠ åˆ°m.handlersä¸­ã€‚è¿™é‡Œæˆ‘ä»¬æ¥è¯´æ˜å®˜æ–¹çš„ä¸€ä¸ªä¸­é—´ä»¶martini.Logger()ï¼Œå®ç°ä»£ç åœ¨logger.go:</p>

<p>func Logger() Handler {
	return func(res http.ResponseWriter, req *http.Request, c Context, log *log.Logger) {
		start := time.Now()
		log.Printf(â€œStarted %s %sâ€, req.Method, req.URL.Path)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	rw := res.(ResponseWriter)
	c.Next()

	log.Printf("Completed %v %s in %v\n", rw.Status(), http.StatusText(rw.Status()), time.Since(start))
} } é¦–å…ˆçœ‹funcçš„ä¼ å…¥å‚æ•°ï¼Œhttp.ResponseWriterå’Œ*http.Requestæ¥è‡ªï¼š
</code></pre></div></div>

<p>c := &amp;context{inject.New(), m.handlers, m.action, NewResponseWriter(res), 0}
// â€¦
c.MapTo(c.rw, (*http.ResponseWriter)(nil))
c.Map(req)
Contextæ¥è‡ªï¼š</p>

<p>context := &amp;routeContext{c, 0, r.handlers}
c.MapTo(context, (*Context)(nil))
*log.Loggeræ¥è‡ªï¼š</p>

<p>m := &amp;Martini{Injector: inject.New(), action: func() {}, logger: log.New(os.Stdout, â€œ[martini] â€œ, 0)}
m.Map(m.logger)
ç„¶åçœ‹rw := res.(ResponseWriter)ã€‚å®é™…ä¸Šc.rwæ˜¯NewReponseWriter(res)è¿”å›çš„martini.ResponseWriterç±»å‹ï¼Œä¸€æ¬¡å¯ä»¥åœ¨è¿™é‡Œç›´æ¥è½¬æ¢ï¼ˆæ³¨æ„åœ¨å¤–éƒ¨è°ƒç”¨ï¼Œä¸æ˜¯martiniåŒ…ä¸­ï¼Œè¦importå¹¶å†™res.(martini.ResponseWriter)ï¼‰ã€‚</p>

<p>æœ€åæ˜¯c.Next()æ–¹æ³•ï¼Œæºç åœ¨martini.go#L154:</p>

<p>func (c *context) Next() {
	c.index += 1
	c.run()
}
æ„æ€å°±æ˜¯indexè‡ªå¢ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªhandlerï¼Œc.runèµ°å®Œæ‰€æœ‰handlerï¼Œç„¶åç»§ç»­ä¸­é—´ä»¶é‡Œçš„log.Printfâ€¦ã€‚</p>
:ET