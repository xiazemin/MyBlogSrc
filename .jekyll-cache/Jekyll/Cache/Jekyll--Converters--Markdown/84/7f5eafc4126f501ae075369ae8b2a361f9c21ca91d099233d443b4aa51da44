I"ù9<p>deferçš„è¡Œä¸ºè§„åˆ™ï¼Œåªæœ‰ä¸‰æ¡
è§„åˆ™ä¸€ï¼šå»¶è¿Ÿå‡½æ•°çš„å‚æ•°åœ¨deferè¯­å¥å‡ºç°æ—¶å°±å·²ç»ç¡®å®šä¸‹æ¥äº†
å®˜æ–¹ç»™å‡ºä¸€ä¸ªä¾‹å­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>func a() {
    i := 0
    defer fmt.Println(i)
    i++
    return
}
deferè¯­å¥ä¸­çš„fmt.Println()å‚æ•°iå€¼åœ¨deferå‡ºç°æ—¶å°±å·²ç»ç¡®å®šä¸‹æ¥ï¼Œå®é™…ä¸Šæ˜¯æ‹·è´äº†ä¸€ä»½ã€‚åé¢å¯¹å˜é‡içš„ä¿®æ”¹ä¸ä¼šå½±å“fmt.Println()å‡½æ•°çš„æ‰§è¡Œï¼Œä»ç„¶æ‰“å°â€0â€ã€‚</p>

<p>æ³¨æ„ï¼šå¯¹äºæŒ‡é’ˆç±»å‹å‚æ•°ï¼Œè§„åˆ™ä»ç„¶é€‚ç”¨ï¼Œåªä¸è¿‡å»¶è¿Ÿå‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªåœ°å€å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œdeferåé¢çš„è¯­å¥å¯¹å˜é‡çš„ä¿®æ”¹å¯èƒ½ä¼šå½±å“å»¶è¿Ÿå‡½æ•°ã€‚
è§„åˆ™äºŒï¼šå»¶è¿Ÿå‡½æ•°æ‰§è¡ŒæŒ‰åè¿›å…ˆå‡ºé¡ºåºæ‰§è¡Œï¼Œå³å…ˆå‡ºç°çš„deferæœ€åæ‰§è¡Œ
è¿™ä¸ªè§„åˆ™å¾ˆå¥½ç†è§£ï¼Œå®šä¹‰deferç±»ä¼¼äºå…¥æ ˆæ“ä½œï¼Œæ‰§è¡Œdeferç±»ä¼¼äºå‡ºæ ˆæ“ä½œã€‚</p>

<p>è®¾è®¡deferçš„åˆè¡·æ˜¯ç®€åŒ–å‡½æ•°è¿”å›æ—¶èµ„æºæ¸…ç†çš„åŠ¨ä½œï¼Œèµ„æºå¾€å¾€æœ‰ä¾èµ–é¡ºåºï¼Œæ¯”å¦‚å…ˆç”³è¯·Aèµ„æºï¼Œå†è·Ÿæ®Aèµ„æºç”³è¯·Bèµ„æºï¼Œè·Ÿæ®Bèµ„æºç”³è¯·Cèµ„æºï¼Œå³ç”³è¯·é¡ºåºæ˜¯:Aâ€“&gt;Bâ€“&gt;Cï¼Œé‡Šæ”¾æ—¶å¾€å¾€åˆè¦åå‘è¿›è¡Œã€‚è¿™å°±æ˜¯æŠŠdefferè®¾è®¡æˆFIFOçš„åŸå› ã€‚</p>

<p>æ¯ç”³è¯·åˆ°ä¸€ä¸ªç”¨å®Œéœ€è¦é‡Šæ”¾çš„èµ„æºæ—¶ï¼Œç«‹å³å®šä¹‰ä¸€ä¸ªdeferæ¥é‡Šæ”¾èµ„æºæ˜¯ä¸ªå¾ˆå¥½çš„ä¹ æƒ¯ã€‚</p>

<p>è§„åˆ™ä¸‰ï¼šå»¶è¿Ÿå‡½æ•°å¯èƒ½æ“ä½œä¸»å‡½æ•°çš„å…·åè¿”å›å€¼
å®šä¹‰deferçš„å‡½æ•°ï¼Œå³ä¸»å‡½æ•°å¯èƒ½æœ‰è¿”å›å€¼ï¼Œè¿”å›å€¼æœ‰æ²¡æœ‰åå­—æ²¡æœ‰å…³ç³»ï¼Œdeferæ‰€ä½œç”¨çš„å‡½æ•°ï¼Œå³å»¶è¿Ÿå‡½æ•°å¯èƒ½ä¼šå½±å“åˆ°è¿”å›å€¼ã€‚</p>

<p>è‹¥è¦ç†è§£å»¶è¿Ÿå‡½æ•°æ˜¯å¦‚ä½•å½±å“ä¸»å‡½æ•°è¿”å›å€¼çš„ï¼Œåªè¦æ˜ç™½å‡½æ•°æ˜¯å¦‚ä½•è¿”å›çš„å°±è¶³å¤Ÿäº†ã€‚
<!-- more -->
å‡½æ•°è¿”å›è¿‡ç¨‹
æœ‰ä¸€ä¸ªäº‹å®å¿…é¡»è¦äº†è§£ï¼Œå…³é”®å­—returnä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå®é™…ä¸Šreturnåªä»£ç†æ±‡ç¼–æŒ‡ä»¤retï¼Œå³å°†è·³è½¬ç¨‹åºæ‰§è¡Œã€‚æ¯”å¦‚è¯­å¥return iï¼Œå®é™…ä¸Šåˆ†ä¸¤æ­¥è¿›è¡Œï¼Œå³å°†iå€¼å­˜å…¥æ ˆä¸­ä½œä¸ºè¿”å›å€¼ï¼Œç„¶åæ‰§è¡Œè·³è½¬ï¼Œè€Œdeferçš„æ‰§è¡Œæ—¶æœºæ­£æ˜¯è·³è½¬å‰ï¼Œæ‰€ä»¥è¯´deferæ‰§è¡Œæ—¶è¿˜æ˜¯æœ‰æœºä¼šæ“ä½œè¿”å›å€¼çš„ã€‚</p>

<p>func deferFuncReturn() (result int) {
    i := 1</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
   result++
}()

return i } è¯¥å‡½æ•°çš„returnè¯­å¥å¯ä»¥æ‹†åˆ†æˆä¸‹é¢ä¸¤è¡Œï¼š
</code></pre></div></div>

<p>result = i
return</p>

<p>è€Œå»¶è¿Ÿå‡½æ•°çš„æ‰§è¡Œæ­£æ˜¯åœ¨returnä¹‹å‰ï¼Œå³åŠ å…¥deferåçš„æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>result = i
result++
return
æ‰€ä»¥ä¸Šé¢å‡½æ•°å®é™…è¿”å›i++å€¼ã€‚</p>

<p>å…³äºä¸»å‡½æ•°æœ‰ä¸åŒçš„è¿”å›æ–¹å¼ï¼Œä½†è¿”å›æœºåˆ¶å°±å¦‚ä¸Šæœºä»‹ç»æ‰€è¯´ï¼Œåªè¦æŠŠreturnè¯­å¥æ‹†å¼€éƒ½å¯ä»¥å¾ˆå¥½çš„ç†è§£</p>

<p>ä¸»å‡½æ•°æ‹¥æœ‰åŒ¿åè¿”å›å€¼ï¼Œè¿”å›å­—é¢å€¼
ä¸€ä¸ªä¸»å‡½æ•°æ‹¥æœ‰ä¸€ä¸ªåŒ¿åçš„è¿”å›å€¼ï¼Œè¿”å›æ—¶ä½¿ç”¨å­—é¢å€¼ï¼Œæ¯”å¦‚è¿”å›â€1â€ã€â€2â€ã€â€Helloâ€è¿™æ ·çš„å€¼ï¼Œè¿™ç§æƒ…å†µä¸‹deferè¯­å¥æ˜¯æ— æ³•æ“ä½œè¿”å›å€¼çš„ã€‚</p>

<p>ä¸€ä¸ªè¿”å›å­—é¢å€¼çš„å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>func foo() int {
    var i int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
    i++
}()

return 1 }
</code></pre></div></div>

<p>ä¸Šé¢çš„returnè¯­å¥ï¼Œç›´æ¥æŠŠ1å†™å…¥æ ˆä¸­ä½œä¸ºè¿”å›å€¼ï¼Œå»¶è¿Ÿå‡½æ•°æ— æ³•æ“ä½œè¯¥è¿”å›å€¼ï¼Œæ‰€ä»¥å°±æ— æ³•å½±å“è¿”å›å€¼ã€‚</p>

<p>ä¸»å‡½æ•°æ‹¥æœ‰åŒ¿åè¿”å›å€¼ï¼Œè¿”å›å˜é‡
ä¸€ä¸ªä¸»å‡½æ•°æ‹¥æœ‰ä¸€ä¸ªåŒ¿åçš„è¿”å›å€¼ï¼Œè¿”å›ä½¿ç”¨æœ¬åœ°æˆ–å…¨å±€å˜é‡ï¼Œè¿™ç§æƒ…å†µä¸‹deferè¯­å¥å¯ä»¥å¼•ç”¨åˆ°è¿”å›å€¼ï¼Œä½†ä¸ä¼šæ”¹å˜è¿”å›å€¼ã€‚</p>

<p>ä¸€ä¸ªè¿”å›æœ¬åœ°å˜é‡çš„å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>func foo() int {
    var i int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
    i++
}()

return i } ä¸Šé¢çš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼ŒåŒæ—¶deferå‡½æ•°ä¹Ÿä¼šæ“ä½œè¿™ä¸ªå±€éƒ¨å˜é‡ã€‚å¯¹äºåŒ¿åè¿”å›å€¼æ¥è¯´ï¼Œå¯ä»¥å‡å®šä»ç„¶æœ‰ä¸€ä¸ªå˜é‡å­˜å‚¨è¿”å›å€¼ï¼Œå‡å®šè¿”å›å€¼å˜é‡ä¸º"anony"ï¼Œä¸Šé¢çš„è¿”å›è¯­å¥å¯ä»¥æ‹†åˆ†æˆä»¥ä¸‹è¿‡ç¨‹ï¼š
</code></pre></div></div>

<p>anony = i
i++
return
ç”±äºiæ˜¯æ•´å‹ï¼Œä¼šå°†å€¼æ‹·è´ç»™anonyï¼Œæ‰€ä»¥deferè¯­å¥ä¸­ä¿®æ”¹iå€¼ï¼Œå¯¹å‡½æ•°è¿”å›å€¼ä¸é€ æˆå½±å“ã€‚</p>

<p>ä¸»å‡½æ•°æ‹¥æœ‰å…·åè¿”å›å€¼
ä¸»å‡½å£°æ˜è¯­å¥ä¸­å¸¦åå­—çš„è¿”å›å€¼ï¼Œä¼šè¢«åˆå§‹åŒ–æˆä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå‡½æ•°å†…éƒ¨å¯ä»¥åƒä½¿ç”¨å±€éƒ¨å˜é‡ä¸€æ ·ä½¿ç”¨è¯¥è¿”å›å€¼ã€‚å¦‚æœdeferè¯­å¥æ“ä½œè¯¥è¿”å›å€¼ï¼Œå¯èƒ½ä¼šæ”¹å˜è¿”å›ç»“æœã€‚</p>

<p>ä¸€ä¸ªå½±å“å‡½è¿”å›å€¼çš„ä¾‹å­ï¼š</p>

<p>func foo() (ret int) {
    defer func() {
        ret++
    }()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return 0 } ä¸Šé¢çš„å‡½æ•°æ‹†è§£å‡ºæ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
</code></pre></div></div>

<p>ret = 0
ret++
return
å‡½æ•°çœŸæ­£è¿”å›å‰ï¼Œåœ¨deferä¸­å¯¹è¿”å›å€¼åšäº†+1æ“ä½œï¼Œæ‰€ä»¥å‡½æ•°æœ€ç»ˆè¿”å›1ã€‚</p>

<p>deferå®ç°åŸç†</p>

<p>1 deferæ•°æ®ç»“æ„
æºç åŒ…src/src/runtime/runtime2.go:_deferå®šä¹‰äº†deferçš„æ•°æ®ç»“æ„ï¼š</p>

<p>type _defer struct {
    sp      uintptr   //å‡½æ•°æ ˆæŒ‡é’ˆ
    pc      uintptr   //ç¨‹åºè®¡æ•°å™¨
    fn      *funcval  //å‡½æ•°åœ°å€
    link    *_defer   //æŒ‡å‘è‡ªèº«ç»“æ„çš„æŒ‡é’ˆï¼Œç”¨äºé“¾æ¥å¤šä¸ªdefer
}
æˆ‘ä»¬çŸ¥é“deferåé¢ä¸€å®šè¦æ¥ä¸€ä¸ªå‡½æ•°çš„ï¼Œæ‰€ä»¥deferçš„æ•°æ®ç»“æ„è·Ÿä¸€èˆ¬å‡½æ•°ç±»ä¼¼ï¼Œä¹Ÿæœ‰æ ˆåœ°å€ã€ç¨‹åºè®¡æ•°å™¨ã€å‡½æ•°åœ°å€ç­‰ç­‰ã€‚</p>

<p>ä¸å‡½æ•°ä¸åŒçš„ä¸€ç‚¹æ˜¯å®ƒå«æœ‰ä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ç”¨äºæŒ‡å‘å¦ä¸€ä¸ªdeferï¼Œæ¯ä¸ªgoroutineæ•°æ®ç»“æ„ä¸­å®é™…ä¸Šä¹Ÿæœ‰ä¸€ä¸ªdeferæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªdeferçš„å•é“¾è¡¨ï¼Œæ¯æ¬¡å£°æ˜ä¸€ä¸ªdeferæ—¶å°±å°†deferæ’å…¥åˆ°å•é“¾è¡¨è¡¨å¤´ï¼Œæ¯æ¬¡æ‰§è¡Œdeferæ—¶å°±ä»å•é“¾è¡¨è¡¨å¤´å–å‡ºä¸€ä¸ªdeferæ‰§è¡Œã€‚
	<img src="https://xiazemin.github.io/MyBlog/img/defer.jpg" />
	æ–°å£°æ˜çš„deferæ€»æ˜¯æ·»åŠ åˆ°é“¾è¡¨å¤´éƒ¨ã€‚
å‡½æ•°è¿”å›å‰æ‰§è¡Œdeferåˆ™æ˜¯ä»é“¾è¡¨é¦–éƒ¨ä¾æ¬¡å–å‡ºæ‰§è¡Œ
  ä¸€ä¸ªgoroutineå¯èƒ½è¿ç»­è°ƒç”¨å¤šä¸ªå‡½æ•°ï¼Œdeferæ·»åŠ è¿‡ç¨‹è·Ÿä¸Šè¿°æµç¨‹ä¸€è‡´ï¼Œè¿›å…¥å‡½æ•°æ—¶æ·»åŠ deferï¼Œç¦»å¼€å‡½æ•°æ—¶å–å‡ºdeferï¼Œæ‰€ä»¥å³ä¾¿è°ƒç”¨å¤šä¸ªå‡½æ•°ï¼Œä¹Ÿæ€»æ˜¯èƒ½ä¿è¯deferæ˜¯æŒ‰FIFOæ–¹å¼æ‰§è¡Œçš„
  2 deferçš„åˆ›å»ºå’Œæ‰§è¡Œ
æºç åŒ…src/runtime/panic.goå®šä¹‰äº†ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«ç”¨äºåˆ›å»ºdeferå’Œæ‰§è¡Œdeferã€‚</p>

<p>deferproc()ï¼š åœ¨å£°æ˜deferå¤„è°ƒç”¨ï¼Œå…¶å°†deferå‡½æ•°å­˜å…¥goroutineçš„é“¾è¡¨ä¸­ï¼›
deferreturn()ï¼šåœ¨returnæŒ‡ä»¤ï¼Œå‡†ç¡®çš„è®²æ˜¯åœ¨retæŒ‡ä»¤å‰è°ƒç”¨ï¼Œå…¶å°†deferä»goroutineé“¾è¡¨ä¸­å–å‡ºå¹¶æ‰§è¡Œã€‚</p>

<p>å¯ä»¥ç®€å•è¿™ä¹ˆç†è§£ï¼Œåœ¨ç¼–è¯‘åœ¨é˜¶æ®µï¼Œå£°æ˜deferå¤„æ’å…¥äº†å‡½æ•°deferproc()ï¼Œåœ¨å‡½æ•°returnå‰æ’å…¥äº†å‡½æ•°deferreturn()ã€‚</p>

<p>deferå®šä¹‰çš„å»¶è¿Ÿå‡½æ•°å‚æ•°åœ¨deferè¯­å¥å‡ºæ—¶å°±å·²ç»ç¡®å®šä¸‹æ¥äº†
deferå®šä¹‰é¡ºåºä¸å®é™…æ‰§è¡Œé¡ºåºç›¸å
returnä¸æ˜¯åŸå­æ“ä½œï¼Œæ‰§è¡Œè¿‡ç¨‹æ˜¯: ä¿å­˜è¿”å›å€¼(è‹¥æœ‰)â€“&gt;æ‰§è¡Œdeferï¼ˆè‹¥æœ‰ï¼‰â€“&gt;æ‰§è¡Œretè·³è½¬
ç”³è¯·èµ„æºåç«‹å³ä½¿ç”¨deferå…³é—­èµ„æºæ˜¯å¥½ä¹ æƒ¯</p>

<p>.1. ç»“æ„
åœ¨ä»‹ç» defer å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ä¸å®ç°åŸç†ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ defer å…³é”®å­—åœ¨ Go è¯­è¨€ä¸­å­˜åœ¨çš„ç»“æ„å’Œå½¢å¼ï¼Œ</p>

<p>type _defer struct {
    siz     int32
    started bool
    sp      uintptr
    pc      uintptr
    fn      *funcval
    _panic  *_panic
    link    *_defer
}
åœ¨ _defer ç»“æ„ä¸­çš„ sp å’Œ pc åˆ†åˆ«æŒ‡å‘äº†æ ˆæŒ‡é’ˆå’Œè°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œfn å­˜å‚¨çš„å°±æ˜¯å‘ defer å…³é”®å­—ä¸­ä¼ å…¥çš„å‡½æ•°äº†ã€‚</p>

<p>2.2. ç¼–è¯‘æœŸé—´
defer å…³é”®å­—æ˜¯åœ¨ Go è¯­è¨€ç¼–è¯‘æœŸé—´çš„ SSA é˜¶æ®µæ‰è¢« stmt å‡½æ•°å¤„ç†çš„ï¼Œæˆ‘ä»¬èƒ½åœ¨ stmt ä¸­çš„ switch/case è¯­å¥ä¸­æ‰¾åˆ°å¤„ç† ODEFER èŠ‚ç‚¹çš„ç›¸å…³é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç å…¶å®è°ƒç”¨äº† call å‡½æ•°ï¼Œè¿™è¡¨ç¤º defer åœ¨ç¼–è¯‘å™¨çœ‹æ¥ä¹Ÿæ˜¯ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œå®ƒä»¬çš„å¤„ç†é€»è¾‘å…¶å®ä¹Ÿæ˜¯å·®ä¸å¤šçš„ã€‚</p>

<p>func (s *state) stmt(n *Node) {
    switch n.Op {
    case ODEFER:
        s.call(n.Left, callDefer)
    }
}
è¢«è°ƒç”¨çš„ call å‡½æ•°å…¶å®è´Ÿè´£äº† Go è¯­è¨€ä¸­æ‰€æœ‰å‡½æ•°å’Œæ–¹æ³•è°ƒç”¨çš„ ä¸­é—´ä»£ç ç”Ÿæˆï¼Œå®ƒçš„å·¥ä½œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å†…å®¹ï¼š</p>

<p>è·å–éœ€è¦æ‰§è¡Œçš„å‡½æ•°åã€é—­åŒ…æŒ‡é’ˆã€ä»£ç æŒ‡é’ˆå’Œå‡½æ•°è°ƒç”¨çš„æ¥æ”¶æ–¹ï¼›
è·å–æ ˆåœ°å€å¹¶å°†å‡½æ•°æˆ–è€…æ–¹æ³•çš„å‚æ•°å†™å…¥æ ˆä¸­ï¼›
ä½¿ç”¨ newValue1A ä»¥åŠç›¸å…³å‡½æ•°ç”Ÿæˆå‡½æ•°è°ƒç”¨çš„ä¸­é—´ä»£ç ï¼›
å¦‚æœå½“å‰è°ƒç”¨çš„ã€å‡½æ•°ã€æ˜¯ deferï¼Œé‚£ä¹ˆå°±ä¼šå•ç‹¬ç”Ÿæˆç›¸å…³çš„ç»“æŸä»£ç å—ï¼›
æœ€åä¼šè·å–å‡½æ•°çš„è¿”å›å€¼åœ°å€å¹¶ç»“æŸå½“å‰æ–¹æ³•çš„è°ƒç”¨ï¼›
ç”±äºæˆ‘ä»¬åœ¨è¿™ä¸€èŠ‚ä¸­ä¸»è¦å…³æ³¨çš„å†…å®¹å…¶å®å°±æ˜¯ defer æœ€ç»ˆè°ƒç”¨äº†ä»€ä¹ˆæ–¹æ³•ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåˆ é™¤äº†å‡½æ•°ä¸­ä¸ç›¸å…³çš„å†…å®¹ï¼š</p>

<p>func (s *state) call(n *Node, k callKind) *ssa.Value {
    //â€¦
    var call *ssa.Value
    switch {
    case k == callDefer:
        call = s.newValue1A(ssa.OpStaticCall, types.TypeMem, deferproc, s.mem())
    // â€¦
    }
    call.AuxInt = stksize
    s.vars[&amp;memVar] = call
    // â€¦
}
deferproc å°±æ˜¯ defer å…³é”®å­—åœ¨è¿è¡ŒæœŸé—´ä¼šè°ƒç”¨çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶äº†ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å‚æ•°çš„å¤§å°å’Œé—­åŒ…æ‰€åœ¨çš„åœ°å€ã€‚</p>

<p>é™¤äº†å°†æ‰€æœ‰ defer å…³é”®å­—çš„è°ƒç”¨éƒ½è½¬æ¢æˆ deferproc çš„å‡½æ•°è°ƒç”¨ä¹‹å¤–ï¼ŒGo è¯­è¨€çš„ç¼–è¯‘å™¨å…¶å®è¿˜åœ¨ SSA ä¸­é—´ä»£ç ç”ŸæˆæœŸé—´ï¼Œä¸ºæ‰€æœ‰è°ƒç”¨ defer çš„å‡½æ•°æœ«å°¾æ’å…¥äº†è°ƒç”¨ deferreturn çš„è¯­å¥ï¼Œè¿™ä¸€è¿‡ç¨‹çš„å®ç°å…¶å®åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†</p>

<p>é¦–å…ˆ walkstmt å‡½æ•°åœ¨é‡åˆ° ODEFER èŠ‚ç‚¹æ—¶ä¼šé€šè¿‡ Curfn.Func.SetHasDefer(true) è¡¨è¾¾å¼è®¾ç½®å½“å‰å‡½æ•°çš„ hasdefer å±æ€§ï¼›
SSA ä¸­é—´ä»£ç ç”Ÿæˆé˜¶æ®µè°ƒç”¨çš„ buildssa å‡½æ•°å…¶å®ä¼šæ‰§è¡Œ s.hasdefer = fn.Func.HasDefer() è¯­å¥æ›´æ–° state çš„ hasdefer å±æ€§ï¼›
æœ€ååœ¨ exit ä¸­ä¼šæ’å…¥ deferreturn çš„å‡½æ•°è°ƒç”¨ï¼›
func (s *state) exit() *ssa.Block {
    if s.hasdefer {
        s.rtcall(Deferreturn, true, nil)
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ... } åœ¨ Go è¯­è¨€çš„ç¼–è¯‘æœŸé—´ï¼Œç¼–è¯‘å™¨ä¸ä»…å°† defer è½¬æ¢æˆäº† deferproc çš„å‡½æ•°è°ƒç”¨ï¼Œè¿˜åœ¨æ‰€æœ‰è°ƒç”¨ defer çš„å‡½æ•°ç»“å°¾ï¼ˆè¿”å›ä¹‹å‰ï¼‰æ’å…¥äº† deferreturnï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±éœ€è¦äº†è§£ Go è¯­è¨€çš„è¿è¡Œæ—¶éƒ½åšäº†ä»€ä¹ˆã€‚
</code></pre></div></div>

<p>2.3. è¿è¡Œæ—¶
æ¯ä¸€ä¸ª defer å…³é”®å­—éƒ½ä¼šè¢«è½¬æ¢æˆ deferprocï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­æˆ‘ä»¬ä¼šä¸º defer åˆ›å»ºä¸€ä¸ªæ–°çš„ _defer ç»“æ„ä½“å¹¶è®¾ç½®å®ƒçš„ fnã€pc å’Œ sp å‚æ•°ï¼Œé™¤æ­¤ä¹‹å¤–æˆ‘ä»¬ä¼šå°† defer ç›¸å…³çš„å‡½æ•°éƒ½æ‹·è´åˆ°ç´§æŒ¨ç€ç»“æ„ä½“çš„å†…å­˜ç©ºé—´ä¸­ï¼š</p>

<p>func deferproc(siz int32, fn *funcval) {
    sp := getcallersp()
    argp := uintptr(unsafe.Pointer(&amp;fn)) + unsafe.Sizeof(fn)
    callerpc := getcallerpc()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>d := newdefer(siz)
if d._panic != nil {
    throw("deferproc: d.panic != nil after newdefer")
}
d.fn = fn
d.pc = callerpc
d.sp = sp
switch siz {
case 0:
case sys.PtrSize:
    *(*uintptr)(deferArgs(d)) = *(*uintptr)(unsafe.Pointer(argp))
default:
    memmove(deferArgs(d), unsafe.Pointer(argp), uintptr(siz))
}

return0() } ä¸Šè¿°å‡½æ•°æœ€ç»ˆä¼šä½¿ç”¨ return0 è¿”å›ï¼Œè¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯é¿å…åœ¨ deferproc å‡½æ•°ä¸­ä½¿ç”¨ return è¿”å›æ—¶åˆä¼šå¯¼è‡´ deferreturn å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªä¸ä¼šè§¦å‘ defer çš„å‡½æ•°äº†ã€‚
</code></pre></div></div>

<p>deferproc ä¸­è°ƒç”¨çš„ newdefer ä¸»è¦ä½œç”¨å°±æ˜¯åˆå§‹åŒ–æˆ–è€…å–å‡ºä¸€ä¸ªæ–°çš„ _defer ç»“æ„ä½“ï¼š</p>

<p>func newdefer(siz int32) <em>_defer {
    var d *_defer
    sc := deferclass(uintptr(siz))
    gp := getg()
    if sc &lt; uintptr(len(p{}.deferpool)) {
        pp := gp.m.p.ptr()
        if len(pp.deferpool[sc]) == 0 &amp;&amp; sched.deferpool[sc] != nil {
            lock(&amp;sched.deferlock)
            for len(pp.deferpool[sc]) &lt; cap(pp.deferpool[sc])/2 &amp;&amp; sched.deferpool[sc] != nil {
                d := sched.deferpool[sc]
                sched.deferpool[sc] = d.link
                d.link = nil
                pp.deferpool[sc] = append(pp.deferpool[sc], d)
            }
            unlock(&amp;sched.deferlock)
        }
        if n := len(pp.deferpool[sc]); n &gt; 0 {
            d = pp.deferpool[sc][n-1]
            pp.deferpool[sc][n-1] = nil
            pp.deferpool[sc] = pp.deferpool[sc][:n-1]
        }
    }
    if d == nil {
        total := roundupsize(totaldefersize(uintptr(siz)))
        d = (</em>_defer)(mallocgc(total, deferType, true))
    }
    d.siz = siz
    d.link = gp._defer
    gp._defer = d
    return d
}
ä»æœ€åçš„ä¸€å°æ®µä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œæ‰€æœ‰çš„ _defer ç»“æ„ä½“éƒ½ä¼šå…³è”åˆ°æ‰€åœ¨çš„ Goroutine ä¸Šå¹¶ä¸”æ¯åˆ›å»ºä¸€ä¸ªæ–°çš„ _defer éƒ½ä¼šè¿½åŠ åˆ°åç¨‹æŒæœ‰çš„ _defer é“¾è¡¨çš„æœ€å‰é¢ã€‚</p>

<p>Golang-Goroutine-Defer-List</p>

<p>deferreturn å…¶å®ä¼šä» Goroutine çš„é“¾è¡¨ä¸­å–å‡ºé“¾è¡¨æœ€å‰é¢çš„ _defer ç»“æ„ä½“å¹¶è°ƒç”¨ jmpdefer å‡½æ•°å¹¶ä¼ å…¥éœ€è¦æ‰§è¡Œçš„å‡½æ•°å’Œå‚æ•°ï¼š</p>

<p>func deferreturn(arg0 uintptr) {
    gp := getg()
    d := gp._defer
    if d == nil {
        return
    }
    sp := getcallersp()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>switch d.siz {
case 0:
case sys.PtrSize:
    *(*uintptr)(unsafe.Pointer(&amp;arg0)) = *(*uintptr)(deferArgs(d))
default:
    memmove(unsafe.Pointer(&amp;arg0), deferArgs(d), uintptr(d.siz))
}
fn := d.fn
d.fn = nil
gp._defer = d.link
freedefer(d)
jmpdefer(fn, uintptr(unsafe.Pointer(&amp;arg0))) } jmpdefer å…¶å®æ˜¯ä¸€ä¸ªç”¨æ±‡ç¼–è¯­è¨€å®ç°çš„å‡½æ•°ï¼Œåœ¨ä¸åŒçš„å¤„ç†å™¨æ¶æ„ä¸Šçš„å®ç°ç¨æœ‰ä¸åŒï¼Œä½†æ˜¯å…·ä½“çš„æ‰§è¡Œé€»è¾‘éƒ½å·®ä¸å¤ªå¤šï¼Œå®ƒä»¬çš„å·¥ä½œå…¶å®å°±æ˜¯è·³è½¬åˆ°å¹¶æ‰§è¡Œ defer æ‰€åœ¨çš„ä»£ç æ®µå¹¶åœ¨æ‰§è¡Œç»“æŸä¹‹åè·³è½¬å› defereturn å‡½æ•°ã€‚
</code></pre></div></div>

<p>TEXT runtimeÂ·jmpdefer(SB), NOSPLIT, $0-8
    MOVL    fv+0(FP), DX    // fn
    MOVL    argp+4(FP), BX    // caller sp
    LEAL    -4(BX), SP    // caller sp after CALL
#ifdef GOBUILDMODE_shared
    SUBL    $16, (SP)    // return to CALL again
#else
    SUBL    $5, (SP)    // return to CALL again
#endif
    MOVL    0(DX), BX
    JMP    BX    // but first run the deferred function
defereturn å‡½æ•°ä¼šå¤šæ¬¡åˆ¤æ–­å½“å‰ Goroutine ä¸­æ˜¯å¦æœ‰å‰©ä½™çš„ _defer ç»“æ„ç›´åˆ°æ‰€æœ‰çš„ _defer éƒ½æ‰§è¡Œå®Œæ¯•ï¼Œè¿™æ—¶å½“å‰å‡½æ•°æ‰ä¼šè¿”å›ã€‚</p>

<ol>
  <li>æ€»ç»“
defer å…³é”®å­—ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«è½¬æ¢æˆ deferproc çš„å‡½æ•°è°ƒç”¨å¹¶åœ¨å‡½æ•°è¿”å›ä¹‹å‰æ’å…¥ deferreturn æŒ‡ä»¤ï¼›åœ¨è¿è¡ŒæœŸé—´ï¼Œæ¯ä¸€æ¬¡ deferproc çš„è°ƒç”¨éƒ½ä¼šå°†ä¸€ä¸ªæ–°çš„ _defer ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine æŒæœ‰çš„é“¾è¡¨å¤´ï¼Œè€Œ deferreturn ä¼šä» Goroutine ä¸­å–å‡º _defer ç»“æ„å¹¶ä¾æ¬¡æ‰§è¡Œï¼Œæ‰€æœ‰ _defer ç»“æ„æ‰§è¡ŒæˆåŠŸä¹‹åå½“å‰å‡½æ•°æ‰ä¼šè¿”å›ã€‚</li>
</ol>

<p>https://draveness.me/golang/keyword/golang-defer.html
https://docs.kilvn.com/go-internals/03.4.html</p>

:ET