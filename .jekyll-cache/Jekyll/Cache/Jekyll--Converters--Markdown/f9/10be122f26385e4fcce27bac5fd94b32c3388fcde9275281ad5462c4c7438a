I"›<p>https://github.com/xiazemin/Benchmark/blob/master/READEME.md
https://github.com/brendangregg/FlameGraph
https://github.com/uber-archive/go-torch</p>

<p>Benchmark
GoåšBenchmaråªè¦åœ¨ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª_test.goåç¼€çš„æ–‡ä»¶ï¼Œç„¶åæ·»åŠ ä¸‹é¢å‡½æ•°ï¼š</p>

<p>func BenchmarkStringJoin1(b *testing.B) {
    b.ReportAllocs()
    input := []string{â€œHelloâ€, â€œWorldâ€}
    for i := 0; i &lt; b.N; i++ {
        result := strings.Join(input, â€œ â€œ)
        if result != â€œHello Worldâ€ {
            b.Error(â€œUnexpected result: â€œ + result)
        }
    }
}</p>

<p>è°ƒç”¨ä»¥ä¸‹å‘½ä»¤:</p>

<h1 id="go-test--runxxx--bench--benchtime3s--cpuprofile-profile_cpuout">go test -run=xxx -bench=. -benchtime=â€3sâ€ -cpuprofile profile_cpu.out</h1>

<p>è¯¥å‘½ä»¤ä¼šè·³è¿‡å•å…ƒæµ‹è¯•ï¼Œæ‰§è¡Œæ‰€æœ‰benchmark,åŒæ—¶ç”Ÿæˆä¸€ä¸ªcpuæ€§èƒ½æè¿°æ–‡ä»¶.</p>

<p>è¿™é‡Œæœ‰ä¸¤ä¸ªæ³¨æ„ç‚¹:</p>

<p>-benchtime å¯ä»¥æ§åˆ¶benchmarkçš„è¿è¡Œæ—¶é—´
b.ReportAllocs() ï¼Œåœ¨reportä¸­åŒ…å«å†…å­˜åˆ†é…ä¿¡æ¯ï¼Œä¾‹å¦‚ç»“æœæ˜¯:
BenchmarkStringJoin1-4 300000 4351 ns/op 32 B/op 2 allocs/op</p>

<p>-4è¡¨ç¤º4ä¸ªCPUçº¿ç¨‹æ‰§è¡Œï¼›300000è¡¨ç¤ºæ€»å…±æ‰§è¡Œäº†30ä¸‡æ¬¡ï¼›4531ns/opï¼Œè¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œè€—æ—¶4531çº³ç§’ï¼›32B/opè¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œåˆ†é…äº†32å­—èŠ‚å†…å­˜ï¼›2 allocs/opè¡¨ç¤ºæ¯æ¬¡æ‰§è¡Œåˆ†é…äº†2æ¬¡å¯¹è±¡ã€‚</p>

<p>æ ¹æ®ä¸Šé¢çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±èƒ½å¯¹çƒ­ç‚¹è·¯å¾„è¿›è¡Œå†…å­˜å¯¹è±¡åˆ†é…çš„ä¼˜åŒ–,ä¾‹å¦‚é’ˆå¯¹ä¸Šé¢çš„ç¨‹åºæˆ‘ä»¬å¯ä»¥è¿›è¡Œå°å°çš„ä¼˜åŒ–:</p>

<p>func BenchmarkStringJoin2(b *testing.B) {
    b.ReportAllocs()
    input := []string{â€œHelloâ€, â€œWorldâ€}
    join := func(strs []string, delim string) string {
        if len(strs) == 2 {
            return strs[0] + delim + strs[1];
        }
        return â€œâ€;
    };
    for i := 0; i &lt; b.N; i++ {
        result := join(input, â€œ â€œ)
        if result != â€œHello Worldâ€ {
            b.Error(â€œUnexpected result: â€œ + result)
        }
    }
}</p>

<p>æ–°çš„Benchmarkç»“æœæ˜¯ï¼š</p>

<p>BenchmarkStringJoin2-4 500000 2440 ns/op 16 B/op 1 allocs/op</p>

<p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨å‡å°‘äº†å†…å­˜åˆ†é…åï¼Œæ€§èƒ½æå‡äº†60%ä»¥ä¸Šï¼</p>

<p>Cpu Profile
ä¸Šä¸€èŠ‚çš„benchmarkç»“æœï¼Œæˆ‘ä»¬åªèƒ½çœ‹åˆ°å‡½æ•°çš„æ•´ä½“æ€§èƒ½ï¼Œä½†æ˜¯å¦‚æœè¯¥å‡½æ•°è¾ƒä¸ºå¤æ‚å‘¢ï¼Ÿç„¶åæˆ‘ä»¬åˆæƒ³çŸ¥é“å‡½æ•°å†…éƒ¨çš„è€—æ—¶ï¼Œè¿™æ—¶å°±è¯¥Cpu Profileç™»åœºäº†ã€‚</p>

<p>Cpu profileæ˜¯Goè¯­è¨€å·¥å…·é“¾ä¸­æœ€é—ªè€€çš„éƒ¨åˆ†ä¹‹ä¸€ï¼ŒæŒæ¡äº†å®ƒä»¥åŠmemoryã€block profile,é‚£åŸºæœ¬ä¸Šå°±æ²¡æœ‰ä½ å‘ç°ä¸äº†çš„æ€§èƒ½ç“¶é¢ˆäº†ã€‚</p>

<p>ä¹‹å‰çš„benchmarkåŒæ—¶è¿˜ç”Ÿæˆäº†ä¸€ä¸ªprofile_cpu.outæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤:</p>

<h1 id="go-tool-pprof-apptest-profile_cpuout">go tool pprof app.test profile_cpu.out</h1>
<p>Entering interactive mode (type â€œhelpâ€ for commands)
(pprof) top10
8220ms of 10360ms total (79.34%)
Dropped 63 nodes (cum &lt;= 51.80ms)
Showing top 10 nodes out of 54 (cum &gt;= 160ms)
      flat  flat%   sum%        cum   cum%
    2410ms 23.26% 23.26%     4960ms 47.88%  runtime.concatstrings
    2180ms 21.04% 44.31%     2680ms 25.87%  runtime.mallocgc
    1200ms 11.58% 55.89%     1200ms 11.58%  runtime.memmove
     530ms  5.12% 61.00%      530ms  5.12%  runtime.memeqbody
     530ms  5.12% 66.12%     2540ms 24.52%  runtime.rawstringtmp
     470ms  4.54% 70.66%     2420ms 23.36%  strings.Join
     390ms  3.76% 74.42%     2330ms 22.49%  app.BenchmarkStringJoin3B
     180ms  1.74% 76.16%     1970ms 19.02%  runtime.rawstring
     170ms  1.64% 77.80%     5130ms 49.52%  runtime.concatstring3
     160ms  1.54% 79.34%      160ms  1.54%  runtime.eqstring</p>

<p>ä¸Šé¢ä»…ä»…å±•ç¤ºéƒ¨åˆ†å‡½æ•°çš„ä¿¡æ¯ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨é“¾è·¯çš„æ€§èƒ½åˆ†æï¼Œå› æ­¤å¦‚æœéœ€è¦å®Œæ•´ä¿¡æ¯ï¼Œæˆ‘ä»¬è¦ç”Ÿæˆsvgæˆ–è€…pdfå›¾ã€‚</p>

<h1 id="go-tool-pprof--svg-profile_cpuout--profile_cpusvg">go tool pprof -svg profile_cpu.out &gt; profile_cpu.svg</h1>
<h1 id="go-tool-pprof--pdf-profile_cpuout--profile_cpupdf">go tool pprof -pdf profile_cpu.out &gt; profile_cpu.pdf</h1>

<p>ä¸‹é¢æ˜¯profile_cpu.pdfçš„å›¾:</p>

<p><img src="https://xiazemin.github.io/MyBlog/img/profile_cpu.svg" /></p>

<p>å¯ä»¥çœ‹åˆ°å›¾é‡ŒåŒ…å«äº†å¤šä¸ªbenchmarkçš„åˆé›†(ä¹‹å‰çš„ä¸¤æ®µbenmarkå‡½æ•°éƒ½åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­)ï¼Œä½†æ˜¯æˆ‘ä»¬åªå…³å¿ƒæ€§èƒ½æœ€å·®çš„é‚£ä¸ªbenchmark,å› æ­¤éœ€è¦è¿‡æ»¤ï¼š</p>

<p>go test -run=xxx -bench=BenchmarkStringJoin2B$ -cpuprofile profile_2b.out
go test -run=xxx -bench=BenchmarkStringJoin2$ -cpuprofile profile_2.out
go tool pprof -svg profile_2b.out &gt; profile_2b.svg
go tool pprof -svg profile_2.out &gt; profile_2.svg</p>

<p>æ ¹æ®å›¾ç‰‡å±•ç¤ºï¼Œbenchmarkè‡ªèº«çš„å‡½æ•°(å¾ªç¯ä¹‹å¤–çš„å‡½æ•°)runtime.concatstringsè§¦å‘äº†å†…å­˜å¯¹è±¡çš„åˆ†é…ï¼Œé€ æˆäº†è€—æ—¶ï¼Œä½†æ˜¯è·Ÿè¸ªåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»æ— æ³•ç»§ç»­ä¸‹å»äº†ï¼Œå› æ­¤ä¸‹é¢å°±éœ€è¦flame graphs äº†ã€‚</p>

<p>â€œA flame graph is a good way to drill down your benchmarks, finding your bottlenecks #golangâ€ via @TitPetric
å¦‚æœæƒ³è¯¦ç»†æŸ¥çœ‹ï¼Œä½ åªè¦ç‚¹å‡»è¿™äº›çŸ©å½¢å—å°±å¥½ã€‚
ç”Ÿæˆè¿™äº›å›¾ï¼Œæˆ‘ä»¬éœ€è¦ uber/go-torchè¿™ä¸ªåº“https://github.com/uber-archive/go-torchï¼Œè¿™ä¸ªåº“ä½¿ç”¨äº†https://github.com/brendangregg/FlameGraph,ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªåŠ¨ä¸‹è½½ä¾èµ–ï¼Œç„¶åç”Ÿæˆframe graphçš„è„šæœ¬ï¼Œè¯»è€…å¯ä»¥æ ¹æ®éœ€è¦ï¼Œè‡ªå·±å®ç°ã€‚</p>

<p>#!/bin/bash</p>
<h1 id="install-flamegraph-scripts">install flamegraph scripts</h1>
<p>if [ ! -d â€œ/opt/flamegraphâ€ ]; then
    echo â€œInstalling flamegraph (git clone)â€
    git clone â€“depth=1 https://github.com/brendangregg/FlameGraph.git /opt/flamegraph
fi</p>

<h1 id="install-go-torch-using-docker">install go-torch using docker</h1>
<p>if [ ! -f â€œbin/go-torchâ€ ]; then
    echo â€œInstalling go-torch via dockerâ€
    docker run â€“net=party â€“rm=true -it -v $(pwd)/bin:/go/bin golang go get github.com/uber/go-torch
    # or if you have go installed locally: go get github.com/uber/go-torch
fi</p>

<p>PATH=â€$PATH:/opt/flamegraphâ€
bin/go-torch -b profile_cpu.out -f profile_cpu.torch.svg</p>

<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çš„benchmarkä¹‹è·¯å°±å‘Šä¸€æ®µè½ï¼Œä½†æ˜¯ä¸Šé¢æ‰€è¿°çš„cpu profileä¸ä»…ä»…èƒ½ç”¨åœ¨benchmarkä¸­ï¼Œè¿˜èƒ½ç›´æ¥åœ¨çº¿debugç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨æ€§èƒ½
<!-- more -->
ç‹¬ç«‹å®‰è£…
git clone â€“depth=1 https://github.com/brendangregg/FlameGraph.git /Users/didi/goLang/FlameGraph
go get github.com/uber/go-torch</p>

<p>PATH=â€$PATH:/Users/didi/goLang/FlameGraphâ€
cd src/github.com/xiazemin/Benchmark/
 ~/goLang/bin/go-torch -b profile_cpu.out -f profile_cpu.torch.svg</p>

<p><img src="https://xiazemin.github.io/MyBlog/img/profile_cpu.torch.svg" /></p>
:ET