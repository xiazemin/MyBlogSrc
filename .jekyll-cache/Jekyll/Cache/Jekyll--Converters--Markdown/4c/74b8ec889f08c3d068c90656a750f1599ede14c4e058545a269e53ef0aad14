I"‚<p>å…ˆè¯´è¯´æˆ‘çš„ç†è§£ï¼šsocketpairåˆ›å»ºäº†ä¸€å¯¹æ— åçš„å¥—æ¥å­—æè¿°ç¬¦ï¼ˆåªèƒ½åœ¨AF_UNIXåŸŸä¸­ä½¿ç”¨ï¼‰ï¼Œæè¿°ç¬¦å­˜å‚¨äºä¸€ä¸ªäºŒå…ƒæ•°ç»„,eg. s[2] .è¿™å¯¹å¥—æ¥å­—å¯ä»¥è¿›è¡ŒåŒå·¥é€šä¿¡ï¼Œæ¯ä¸€ä¸ªæè¿°ç¬¦æ—¢å¯ä»¥è¯»ä¹Ÿå¯ä»¥å†™ã€‚è¿™ä¸ªåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ä¹Ÿå¯ä»¥è¿›è¡Œé€šä¿¡ï¼Œå‘s[0]ä¸­å†™å…¥ï¼Œå°±å¯ä»¥ä»s[1]ä¸­è¯»å–ï¼ˆåªèƒ½ä»s[1]ä¸­è¯»å–ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨s[1]ä¸­å†™å…¥ï¼Œç„¶åä»s[0]ä¸­è¯»å–ï¼›ä½†æ˜¯ï¼Œè‹¥æ²¡æœ‰åœ¨0ç«¯å†™å…¥ï¼Œè€Œä»1ç«¯è¯»å–ï¼Œåˆ™1ç«¯çš„è¯»å–æ“ä½œä¼šé˜»å¡ï¼Œå³ä½¿åœ¨1ç«¯å†™å…¥ï¼Œä¹Ÿä¸èƒ½ä»1è¯»å–ï¼Œä»ç„¶é˜»å¡ï¼›åä¹‹äº¦ç„¶â€¦â€¦
<!-- more -->
//
// Created by didi on 2019-05-31.
//</p>

<p>#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include &lt;sys/types.h&gt;
//#include <error.h>
#include <errno.h>
#include &lt;sys/socket.h&gt;
#include <stdlib.h></stdlib.h></errno.h></error.h></unistd.h></string.h></stdio.h></p>

<p>#define BUF_SIZE 30</p>

<p>int main(){
    int s[2];
    int w,r;
    char * string = â€œThis is a test stringâ€;
    char * buf = (char*)calloc(1 , BUF_SIZE);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if( socketpair(AF_UNIX,SOCK_STREAM,0,s) == -1 ){
    printf("create unnamed socket pair failed:%s\n",strerror(errno) );
    exit(-1);
}

/*******test in a single process ********/
if( ( w = write(s[0] , string , strlen(string) ) ) == -1 ){
    printf("Write socket error:%s\n",strerror(errno));
    exit(-1);
}
/*****read*******/
if( (r = read(s[1], buf , BUF_SIZE )) == -1){
    printf("Read from socket error:%s\n",strerror(errno) );
    exit(-1);
}
printf("Read string in same process : %s \n",buf);
if( (r = read(s[0], buf , BUF_SIZE )) == -1){
    printf("Read from socket s0 error:%s\n",strerror(errno) );
    exit(-1);
}
printf("Read from s0 :%s\n",buf);

printf("Test successed\n");
exit(0); }
</code></pre></div></div>

<p>è‹¥forkå­è¿›ç¨‹ï¼Œç„¶ååœ¨æœè¿›ç¨‹å…³é—­ä¸€ä¸ªæè¿°ç¬¦eg. s[1] ï¼Œåœ¨å­è¿›ç¨‹ä¸­å†å…³é—­å¦ä¸€ä¸ª eg. s[0]    ,åˆ™å¯ä»¥å®ç°çˆ¶å­è¿›ç¨‹ä¹‹é—´çš„åŒå·¥é€šä¿¡ï¼Œä¸¤ç«¯éƒ½å¯è¯»å¯å†™ï¼›å½“ç„¶ï¼Œä»ç„¶éµå®ˆå’Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¹‹é—´å·¥ä½œçš„åŸåˆ™ï¼Œä¸€ç«¯å†™ï¼Œåœ¨å¦ä¸€ç«¯è¯»å–ï¼›</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> è¿™å’Œpipeæœ‰ä¸€å®šçš„åŒºåˆ«ï¼Œpipeæ˜¯å•å·¥é€šä¿¡ï¼Œä¸€ç«¯è¦ä¹ˆæ˜¯è¯»ç«¯è¦ä¹ˆæ˜¯å†™ç«¯ï¼Œè€Œsocketpairå®ç°äº†åŒå·¥å¥—æ¥å­—ï¼Œä¹Ÿå°±æ²¡æœ‰æ‰€è°“çš„è¯»ç«¯å’Œå†™ç«¯çš„åŒºåˆ†
</code></pre></div></div>

<p>//
// Created by didi on 2019-05-31.
//</p>

<p>#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include &lt;sys/types.h&gt;
//#include <error.h>
#include <errno.h>
#include &lt;sys/socket.h&gt;
#include <stdlib.h></stdlib.h></errno.h></error.h></unistd.h></string.h></stdio.h></p>

<p>#define BUF_SIZE 30</p>

<p>int main(){
    int s[2];
    int w,r;
    char * string = â€œThis is a test stringâ€;
    char * buf = (char*)calloc(1 , BUF_SIZE);
    pid_t pid;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if( socketpair(AF_UNIX,SOCK_STREAM,0,s) == -1 ){
    printf("create unnamed socket pair failed:%s\n",strerror(errno) );
    exit(-1);
}

/***********Test : fork but don't close any fd in neither parent nor child process***********/
if( ( pid = fork() ) &gt; 0 ){
    printf("Parent process's pid is %d\n",getpid());
    close(s[1]);
    if( ( w = write(s[0] , string , strlen(string) ) ) == -1 ){
        printf("Write socket error:%s\n",strerror(errno));
        exit(-1);
    }
}else if(pid == 0){
    printf("Fork child process successed\n");
    printf("Child process's pid is :%d\n",getpid());
    close(s[0]);
}else{
    printf("Fork failed:%s\n",strerror(errno));
    exit(-1);
}

/*****read***In parent and child****/
if( (r = read(s[1], buf , BUF_SIZE )) == -1){
    printf("Pid %d read from socket error:%s\n",getpid() , strerror(errno) );
    exit(-1);
}
printf("Pid %d read string in same process : %s \n",getpid(),buf);
printf("Test successed , %d\n",getpid());
exit(0); }
</code></pre></div></div>

<p>æˆ‘ä¹Ÿæµ‹è¯•äº†åœ¨çˆ¶å­è¿›ç¨‹ä¸­éƒ½ä¸close(s[1])ï¼Œä¹Ÿå°±æ˜¯ä¿æŒä¸¤ä¸ªè¯»ç«¯ï¼Œåˆ™çˆ¶è¿›ç¨‹èƒ½å¤Ÿè¯»åˆ°stringä¸²ï¼Œä½†å­è¿›ç¨‹è¯»å–ç©ºä¸²ï¼Œæˆ–è€…å­è¿›ç¨‹å…ˆè¯»äº†æ•°æ®ï¼Œçˆ¶è¿›ç¨‹é˜»å¡äºreadæ“ä½œï¼</p>

<p>ä¹‹æ‰€ä»¥å­è¿›ç¨‹èƒ½è¯»å–çˆ¶è¿›ç¨‹çš„stringï¼Œæ˜¯å› ä¸ºforkæ—¶ï¼Œå­è¿›ç¨‹ç»§æ‰¿äº†çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦çš„ï¼ŒåŒæ—¶ä¹Ÿå°±å¾—åˆ°äº†ä¸€ä¸ªå’Œçˆ¶è¿›ç¨‹æŒ‡å‘ç›¸åŒæ–‡ä»¶è¡¨é¡¹çš„æŒ‡é’ˆï¼›è‹¥çˆ¶å­è¿›ç¨‹å‡ä¸å…³é—­è¯»ç«¯ï¼Œå› ä¸ºæŒ‡å‘ç›¸åŒçš„æ–‡ä»¶è¡¨é¡¹ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹å°±æœ‰äº†ç«äº‰å…³ç³»ï¼Œäº‰ç›¸è¯»å–è¿™ä¸ªå­—ç¬¦ä¸²ï¼çˆ¶è¿›ç¨‹readåå°†æ•°æ®è½¬åˆ°å…¶åº”ç”¨ç¼“å†²åŒºï¼Œè€Œå­è¿›ç¨‹å°±å¾—ä¸åˆ°äº†ï¼Œåªæœ‰ä¸€ä»½æ•°æ®æ‹·è´ï¼ˆè‹¥å°†çˆ¶è¿›ç¨‹é˜»å¡ä¸€æ®µæ—¶é—´ï¼Œåˆ™æ”¶åˆ°æ•°æ®çš„å°±æ˜¯å­è¿›ç¨‹äº†ï¼Œå·²ç»å¾—åˆ°éªŒè¯ï¼Œè®©çˆ¶è¿›ç¨‹sleep(3)ï¼Œå­è¿›ç¨‹è·å¾—stringï¼Œè€Œçˆ¶è¿›ç¨‹è·å–ä¸åˆ°è€Œæ˜¯é˜»å¡ï¼‰</p>

<p>Linux æä¾›äº† popen å’Œ pclose å‡½æ•° (1)ï¼Œç”¨äºåˆ›å»ºå’Œå…³é—­ç®¡é“ä¸å¦å¤–ä¸€ä¸ªè¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚å…¶æ¥å£å¦‚ä¸‹ï¼š
FILE *popen(const char *commandï¼Œ const char *mode);
int pclose(FILE *stream);</p>

<p>æœ‰ä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ pipe å‡½æ•° (2)åˆ›å»ºä¸¤ä¸ªå•å‘ç®¡é“ã€‚æ²¡æœ‰é”™è¯¯æ£€æµ‹çš„ä»£ç ç¤ºæ„å¦‚ä¸‹ï¼š
int pipe_in[2], pipe_out[2];
pid_t pid;
pipe(&amp;pipe_in); // åˆ›å»ºçˆ¶è¿›ç¨‹ä¸­ç”¨äºè¯»å–æ•°æ®çš„ç®¡é“
pipe(&amp;pipe_out);    // åˆ›å»ºçˆ¶è¿›ç¨‹ä¸­ç”¨äºå†™å…¥æ•°æ®çš„ç®¡é“
if ( (pid = fork()) == 0) { // å­è¿›ç¨‹
    close(pipe_in[0]);  // å…³é—­çˆ¶è¿›ç¨‹çš„è¯»ç®¡é“çš„å­è¿›ç¨‹è¯»ç«¯
    close(pipe_out[1]); // å…³é—­çˆ¶è¿›ç¨‹çš„å†™ç®¡é“çš„å­è¿›ç¨‹å†™ç«¯
    dup2(pipe_in[1], STDOUT_FILENO);    // å¤åˆ¶çˆ¶è¿›ç¨‹çš„è¯»ç®¡é“åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å‡º
    dup2(pipe_out[0], STDIN_FILENO);    // å¤åˆ¶çˆ¶è¿›ç¨‹çš„å†™ç®¡é“åˆ°å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥
    close(pipe_in[1]);  // å…³é—­å·²å¤åˆ¶çš„è¯»ç®¡é“
    close(pipe_out[0]); // å…³é—­å·²å¤åˆ¶çš„å†™ç®¡é“
    /* ä½¿ç”¨execæ‰§è¡Œå‘½ä»¤ <em>/
} else {    // çˆ¶è¿›ç¨‹
    close(pipe_in[1]);  // å…³é—­è¯»ç®¡é“çš„å†™ç«¯
    close(pipe_out[0]); // å…³é—­å†™ç®¡é“çš„è¯»ç«¯
    /</em> ç°åœ¨å¯å‘pipe_out[1]ä¸­å†™æ•°æ®ï¼Œå¹¶ä»pipe_in[0]ä¸­è¯»ç»“æœ <em>/
    close(pipe_out[1]); // å…³é—­å†™ç®¡é“
    /</em> è¯»å–pipe_in[0]ä¸­çš„å‰©ä½™æ•°æ® <em>/
    close(pipe_in[0]);  // å…³é—­è¯»ç®¡é“
    /</em> ä½¿ç”¨waitç³»åˆ—å‡½æ•°ç­‰å¾…å­è¿›ç¨‹é€€å‡ºå¹¶å–å¾—é€€å‡ºä»£ç  */
}
å½“ç„¶ï¼Œè¿™æ ·çš„ä»£ç çš„å¯è¯»æ€§ï¼ˆç‰¹åˆ«æ˜¯åŠ ä¸Šé”™è¯¯å¤„ç†ä»£ç ä¹‹åï¼‰æ¯”è¾ƒå·®ï¼Œä¹Ÿä¸å®¹æ˜“å°è£…æˆç±»ä¼¼äºpopen/pcloseçš„å‡½æ•°ï¼Œæ–¹ä¾¿é«˜å±‚ä»£ç ä½¿ç”¨ã€‚ç©¶å…¶åŸå› ï¼Œæ˜¯pipeå‡½æ•°è¿”å›çš„ä¸€å¯¹æ–‡ä»¶æè¿°ç¬¦åªèƒ½ä»ç¬¬ä¸€ä¸ªä¸­è¯»ã€ç¬¬äºŒä¸ªä¸­å†™ï¼ˆè‡³å°‘å¯¹äºLinuxæ˜¯å¦‚æ­¤ï¼‰ã€‚ä¸ºäº†åŒæ—¶è¯»å†™ï¼Œå°±åªèƒ½é‡‡å–è¿™ä¹ˆç´¯èµ˜çš„ä¸¤ä¸ªpipeè°ƒç”¨ã€ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å½¢å¼äº†ã€‚</p>

<p>Linuxå®ç°äº†ä¸€ä¸ªæºè‡ªBSDçš„socketpairè°ƒç”¨ (3)ï¼Œå¯ä»¥å®ç°ä¸Šè¿°åœ¨åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­è¿›è¡Œè¯»å†™çš„åŠŸèƒ½ï¼ˆè¯¥è°ƒç”¨ç›®å‰ä¹Ÿæ˜¯POSIXè§„èŒƒçš„ä¸€éƒ¨åˆ† (4)ï¼‰ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨èƒ½åˆ›å»ºä¸€å¯¹å·²è¿æ¥çš„ï¼ˆUNIXæ—ï¼‰æ— åsocketã€‚åœ¨Linuxä¸­ï¼Œå®Œå…¨å¯ä»¥æŠŠè¿™ä¸€å¯¹socketå½“æˆpipeè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ä½¿ç”¨ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯è¿™ä¸€å¯¹æ–‡ä»¶æè¿°ç¬¦ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½å¯è¯»å’Œå¯å†™ã€‚</p>

<p>int fd[2];
pid_t pid;
socketpair(AF_UNIX, SOCKET_STREAM, 0, fd);  // åˆ›å»ºç®¡é“
if ( (pid = fork()) == 0) { // å­è¿›ç¨‹
    close(fd[0]);   // å…³é—­ç®¡é“çš„çˆ¶è¿›ç¨‹ç«¯
    dup2(fd[1], STDOUT_FILENO); // å¤åˆ¶ç®¡é“çš„å­è¿›ç¨‹ç«¯åˆ°æ ‡å‡†è¾“å‡º
    dup2(fd[1], STDIN_FILENO);  // å¤åˆ¶ç®¡é“çš„å­è¿›ç¨‹ç«¯åˆ°æ ‡å‡†è¾“å…¥
    close(fd[1]);   // å…³é—­å·²å¤åˆ¶çš„è¯»ç®¡é“
    /* ä½¿ç”¨execæ‰§è¡Œå‘½ä»¤ <em>/
} else {    // çˆ¶è¿›ç¨‹
    close(fd[1]);   // å…³é—­ç®¡é“çš„å­è¿›ç¨‹ç«¯
    /</em> ç°åœ¨å¯åœ¨fd[0]ä¸­è¯»å†™æ•°æ® <em>/
    shutdown(fd[0], SHUT_WR);   // é€šçŸ¥å¯¹ç«¯æ•°æ®å‘é€å®Œæ¯•
    /</em> è¯»å–å‰©ä½™æ•°æ® <em>/
    close(fd[0]);   // å…³é—­ç®¡é“
    /</em> ä½¿ç”¨waitç³»åˆ—å‡½æ•°ç­‰å¾…å­è¿›ç¨‹é€€å‡ºå¹¶å–å¾—é€€å‡ºä»£ç  */
}</p>
:ET