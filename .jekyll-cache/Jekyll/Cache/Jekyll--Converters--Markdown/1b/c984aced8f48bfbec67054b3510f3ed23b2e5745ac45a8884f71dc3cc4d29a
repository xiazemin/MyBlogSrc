I"ŸF<p>https://newt0n.github.io/2017/02/10/PHP-%E5%8D%8F%E7%A8%8B%E5%8E%9F%E7%90%86/</p>

<p>https://www.laruence.com/2008/08/16/301.html</p>

<p>https://my.oschina.net/agiledev/blog/343166</p>

<p>https://zhuanlan.zhihu.com/p/84221387</p>

<p>https://github.com/swoole/swoole-src/releases/tag/v4.0.0</p>

<p>https://github.com/swoole/phpx</p>

<p>https://segmentfault.com/a/1190000011360313?utm_source=tag-newest</p>

<p>https://segmentfault.com/a/1190000011111074?utm_source=tag-newest</p>

<p>https://segmentfault.com/u/hantianfeng</p>

<p>https://segmentfault.com/a/1190000011360313
<!-- more --></p>

<p>###åˆ›å»ºç¬¬ä¸€ä¸ªPHPæ‰©å±•ç±»</p>

<p>æœ¬èŠ‚å°†ä¼šé€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„PHPæ‰©å±•ç±»ï¼Œä»‹ç»åœ¨PHPæ‰©å±•å¼€å‘è¿‡ç¨‹ä¸­å¦‚ä½•å®ç°é¢å‘å¯¹è±¡ã€‚</p>

<p>åœ¨PHPæ‰©å±•å®ç°ä¸­ï¼Œç±»çš„åˆ›å»ºä¸»è¦åŒ…å«ä¸‰æ­¥ï¼š</p>

<p>åˆ›å»ºä¸€ä¸ªå…¨å±€çš„zend_class_entryå˜é‡ï¼Œç”¨äºå­˜å‚¨ç±»çš„å…¥å£ã€‚
åˆ›å»ºä¸€ä¸ªzend_function_entryç»“æ„ä½“æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ç±»ä¸­åŒ…å«çš„æ–¹æ³•ã€‚
åœ¨æ‰©å±•çš„MINITæ–¹æ³•ä¸­æ³¨å†Œç±»ã€‚
ä¸‹é¢å°†å¯¹è¿™ä¸‰ä¸ªæ­¥éª¤è¿›è¡Œå±•å¼€æè¿°ï¼Œæˆ‘ä»¬å°†ä¼šç»§ç»­åœ¨PHPæ‰©å±•å¼€å‘ - æ„å»ºç¬¬ä¸€ä¸ªPHPæ‰©å±•ä¸€èŠ‚ä¸­åˆ›å»ºçš„ ext_demo_1æ‰©å±•çš„åŸºç¡€ä¹‹ä¸Šè¿›è¡Œå¼€å‘ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰€å†™çš„æ‰€æœ‰ä»£ç éƒ½åœ¨ext_demo_1.cæ–‡ä»¶ä¸­ã€‚</p>

<p>####åˆ›å»ºä¸€ä¸ªç®€å•çš„ç©ºç±»</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸ºphp_democlass_entryçš„zend_class_entryç»“æ„ä½“å˜é‡ï¼Œ è¯¥ç»“æ„ä½“å˜é‡å®é™…å­˜å‚¨äº†æˆ‘ä»¬åˆ›å»ºçš„ç±»çš„å…¥å£ã€‚</p>

<p>zend_class_entry *php_democlass_entry;
è¿™é‡Œçš„php_democlass_entryåœ¨æ‰©å±•æºæ–‡ä»¶ä¸­æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œä¸ºäº†ä½¿å…¶å®ƒæ‰©å±•å¯ä»¥ä½¿ç”¨æˆ‘ä»¬åˆ›å»ºçš„ç±»ï¼Œ è¿™ä¸ªå…¨å±€å˜é‡åº”è¯¥åœ¨å¤´æ–‡ä»¶ä¸­å¯¼å‡ºã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ›å»ºzend_function_entryç»“æ„ä½“æ•°ç»„ï¼Œè¿™ä¸ªæ•°ç»„ä¸å‡½æ•°å®šä¹‰æ—¶çš„æ•°ç»„æ˜¯ä¸€æ ·çš„ã€‚</p>

<p>const zend_function_entry ext_demo_1_democlass_functions[] = {
	PHP_FE_END
};
ä¸å‡½æ•°æ³¨å†Œä¸åŒçš„æ˜¯ï¼Œå¯¹äºç±»çš„åˆ›å»ºï¼Œæˆ‘ä»¬éœ€è¦åœ¨MINITæ–¹æ³•ä¸­æ³¨å†Œè¯¥ç±»ã€‚</p>

<p>PHP_MINIT_FUNCTION(ext_demo_1)
{
	/* åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç±»å…¥å£å˜é‡ */
	zend_class_entry temp_ce;
	INIT_CLASS_ENTRY(temp_ce, â€œDemoClassâ€, ext_demo_1_democlass_functions);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php_democlass_entry = zend_register_internal_class(&amp;temp_ce TSRMLS_CC);
return SUCCESS; } åœ¨MINITå‡½æ•°ä¸­ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªtemp_ceå˜é‡ç”¨äºå­˜å‚¨ä¸´æ—¶çš„ç±»å…¥å£ï¼Œæ¥ä¸‹æ¥ä½¿ç”¨INIT_CLASS_ENTRY å®åˆå§‹åŒ–è¯¥å˜é‡ï¼Œä¹‹åä½¿ç”¨zend_register_internal_class()å°†è¯¥ç±»æ³¨å†Œåˆ°Zendå¼•æ“ï¼Œ è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæœ€ç»ˆçš„ç±»å…¥å£ï¼Œå°†å…¶èµ‹å€¼ç»™å‰é¢åˆ›å»ºçš„å…¨å±€å˜é‡ã€‚
</code></pre></div></div>

<p>è¿™é‡Œçš„INIT_CLASS_ENTRYæ˜¯ä¸€ä¸ªå®å®šä¹‰:</p>

<p>/* zend_API.h 162-163 */
#define INIT_CLASS_ENTRY(class_container, class_name, functions) <br />
	INIT_OVERLOADED_CLASS_ENTRY(class_container, class_name, functions, NULL, NULL, NULL)
å®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºç±»å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„zend_class_entryå˜é‡ï¼Œ ç¬¬äºŒä¸ªå‚æ•°ä¸ºæˆ‘ä»¬è¦åˆ›å»ºçš„å¯¹è±¡åç§°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºæˆ‘ä»¬åˆ›å»ºçš„ç±»åŒ…å«å“ªäº›å‡½æ•°ã€‚</p>

<p>åœ¨ä½¿ç”¨INIT_CLASS_ENTRYä¹‹åï¼Œéƒ½æ‰§è¡Œäº†å“ªäº›æ“ä½œå‘¢ï¼Ÿè·Ÿè¿›è¯¥å®å®šä¹‰çš„å®ç°ä»£ç åå¯ä»¥å‘ç°ï¼Œ åœ¨è¯¥å®çš„å®šä¹‰ä¸­ï¼Œé¦–å…ˆä¸ºç»“æ„ä½“(zend_class_entry)å˜é‡class_containerè®¾ç½®nameå±æ€§ï¼Œ ç„¶åå¯¹è¯¥ç»“æ„ä½“å˜é‡è¿›è¡Œåˆå§‹åŒ–(zend_API.h 176-204)ã€‚</p>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªç©ºçš„ç±»ï¼Œç¼–è¯‘è¯¥æ‰©å±•ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨php â€“rc DemoClassæµ‹è¯•ä¸€ä¸‹ï¼š</p>

<p>ext_demo_1 mylxsw$ php â€“rc DemoClass
Class [ <internal:ext_demo_1> class DemoClass ] {</internal:ext_demo_1></p>

<ul>
  <li>
    <p>Constants [0] {
  }</p>
  </li>
  <li>
    <p>Static properties [0] {
  }</p>
  </li>
  <li>
    <p>Static methods [0] {
  }</p>
  </li>
  <li>
    <p>Properties [0] {
  }</p>
  </li>
  <li>
    <p>Methods [0] {
  }
}
####ä¸ºPHPç±»æ·»åŠ æ–¹æ³•</p>
  </li>
</ul>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ºæˆ‘ä»¬åˆšæ‰åˆ›å»ºçš„ç©ºç±»æ·»åŠ ä¸€ä¸ªåä¸ºsayHelloçš„æ–¹æ³•ã€‚</p>

<p>åœ¨ext_demo_1.cæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªsayHelloçš„æ–¹æ³•ï¼š</p>

<p>PHP_METHOD(DemoClass, sayHello)
{
	char *name, *str_hello;
	int name_len, str_hello_len;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "s", &amp;name, &amp;name_len) == FAILURE) {
	RETURN_NULL();
}

str_hello_len = spprintf(&amp;str_hello, 0, "Hello, %s, You are welcome!\n", name);
RETURN_STRINGL(str_hello, str_hello_len, 0); } è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸ºDemoClassç±»åˆ›å»ºäº†ä¸€ä¸ªåä¸ºsayHelloçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼Œ å¹¶ä¸”è¿”å›Hello, æä¾›çš„å‚æ•°, You are welcome!ã€‚
</code></pre></div></div>

<p>ä¸è¦å¿˜è®°åœ¨å¤´æ–‡ä»¶php_ext_demo_1.hæ–‡ä»¶ä¸­å£°æ˜ä¸€ä¸‹ï¼Œå¦åˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šå› ä¸ºPHP_MEå®ä¸­ä½¿ç”¨äº†è¯¥æ–¹æ³•è€ŒæŠ¥é”™ã€‚</p>

<p>PHP_METHOD(DemoClass, sayHello);
åœ¨ext_demo_1_democlass_functionsç»“æ„ä½“æ•°ç»„ä¸­åŠ å…¥è¯¥æ–¹æ³•ï¼š</p>

<p>const zend_function_entry ext_demo_1_democlass_functions[] = {
	PHP_ME(DemoClass, sayHello, NULL, ZEND_ACC_PUBLIC) /* sayHelloæ–¹æ³•ä¸ºPUBLICå¯è§æ€§ */
	PHP_FE_END
};
è¿™é‡Œçš„PHP_MEå®ä¸ä¹‹å‰å‡½æ•°éƒ¨åˆ†ä¸­PHP_FEç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºå¢åŠ äº†ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç”¨äºæŒ‡å®šè¯¥æ–¹æ³•æ‰€å±çš„ç±»åï¼Œ æœ€åä¸€ä¸ªå‚æ•°ç”¨äºæŒ‡å®šæ–¹æ³•å±æ€§ã€‚è¿™é‡Œçš„æ–¹æ³•å±æ€§åŒ…å« ZEND_ACC_PUBLICï¼ŒZEND_ACC_PROTECTEDï¼Œ ZEND_ACC_PRIVATEï¼ŒZEND_ACC_STATICï¼Œ ZEND_ACC_FINALï¼ŒZEND_ACC_ABSTRACTã€‚</p>

<table>
  <tbody>
    <tr>
      <td>å…¶ä¸­ï¼Œå‰ä¸‰ä¸ªå‚æ•°å¯ä»¥ä¸åé¢å‡ ä¸ªç»„åˆä½¿ç”¨ï¼Œå¤šä¸ªå‚æ•°ç»„åˆæ—¶ï¼Œä½¿ç”¨</td>
      <td>è¿›è¡Œåˆ†éš”ï¼Œ ä¾‹å¦‚:</td>
    </tr>
  </tbody>
</table>

<p>PHP_ME(
    Test, protectedFinalStaticMethod, arginfo_xyz,
    ZEND_ACC_PROTECTED | ZEND_ACC_FINAL | ZEND_ACC_STATIC
)
å¯¹äºæŠ½è±¡æ–¹æ³•æ¥è¯´ï¼Œå¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ZEND_ACC_ABSTRACTå®ï¼Œè€Œåº”è¯¥ä½¿ç”¨Zendå®šä¹‰çš„ PHP_ABSTRACT_ME(ç±»å, æŠ½è±¡æ–¹æ³•å, å‚æ•°ä¿¡æ¯)å–ä»£ã€‚</p>

<p>ç±»ä¼¼äºPHP_FUNCTIONå®ï¼Œè¿™é‡Œçš„PHP_METHODå®å±•å¼€åå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>/* PHP_METHOD(ClassName, methodName) { } */
void zim_ClassName_methodName(INTERNAL_FUNCTION_PARAMETERS) { }
å¯¹äºsayHelloæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ZEND_ARG_INFOç³»åˆ—å®ä¸ºå…¶å‚æ•°æä¾›ç±»å‹æç¤ºåŠŸèƒ½ã€‚</p>

<p>ZEND_BEGIN_ARG_INFO_EX(democlass_sayhello_args, 0, 0, 1)
	ZEND_ARG_INFO(0, name)
ZEND_END_ARG_INFO();
æ·»åŠ è¯¥æ®µä»£ç ä¹‹åï¼Œéœ€è¦ä¿®æ”¹PHP_MEå‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°NULLä¸ºdemoclass_sayhello_argsã€‚</p>

<p>é‡æ–°ç¼–è¯‘æ‰©å±•ï¼Œæ‰§è¡Œä»¥ä¸‹PHPè„šæœ¬æµ‹è¯•æ˜¯å¦æ‰©å±•åŠŸèƒ½æ­£å¸¸ï¼š</p>

<p>&lt;?php
$demo = new DemoClass();
echo $demo-&gt;sayHello(â€˜mylxswâ€™);
ç¨‹åºè¾“å‡ºï¼š</p>

<p>$ php test.php
Hello, mylxsw, You are welcome!
åœ¨ç±»æ–¹æ³•å†…ï¼Œä½¿ç”¨getThis()æ–¹æ³•è·å–å½“å‰å¯¹è±¡å®ä¾‹ï¼Œè¿”å›å€¼ç±»å‹ä¸ºzval *ï¼Œå¯¹åº”PHPä¸­çš„$thisã€‚</p>

<p>####ä¸ºç±»æ·»åŠ å±æ€§</p>

<p>è¦åœ¨åˆ›å»ºå¥½çš„ç±»ä¸­æ·»åŠ å±æ€§ï¼Œè¦ä½¿ç”¨zend_declare_property_*ç³»åˆ—å‡½æ•°ã€‚åœ¨MINITæ–¹æ³•ä¸­ï¼Œ æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>

<p>PHP_MINIT_FUNCTION(ext_demo_1)
{
	â€¦
	zend_declare_property_long(php_democlass_entry, â€œageâ€, sizeof(â€œageâ€) - 1, 24, ZEND_ACC_PUBLIC TSRMLS_CC);
	â€¦
}
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨zend_declare_property_long()å‡½æ•°ä¸ºDemoClassç±»æ·»åŠ äº†ä¸€ä¸ªageå­—æ®µï¼Œ å¹¶ä¸”è®¾ç½®å…¶å¯è§æ€§ä¸ºPUBLICï¼Œç±»å‹ä¸ºlongå‹ã€‚</p>

<p>ä¸‹é¢æ˜¯zend_declare_property_*ç³»åˆ—å‡½æ•°:</p>

<p>ZEND_API int zend_declare_property(zend_class_entry *ce, char *name, int name_length, zval *property, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_ex(zend_class_entry *ce, const char *name, int name_length, zval *property, int access_type, char *doc_comment, int doc_comment_len TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_null(zend_class_entry *ce, char *name, int name_length, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_bool(zend_class_entry *ce, char *name, int name_length, long value, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_long(zend_class_entry *ce, char *name, int name_length, long value, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_double(zend_class_entry *ce, char *name, int name_length, double value, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_string(zend_class_entry *ce, char *name, int name_length, char *value, int access_type TSRMLS_DC);</p>

<p>ZEND_API int zend_declare_property_stringl(zend_class_entry *ce, char *name, int name_length, char *value, int value_len, int access_type TSRMLS_DC);
è¦è®¿é—®ç±»ä¸­çš„å±æ€§ï¼Œæ¯”å¦‚è·å–å±æ€§çš„å€¼æˆ–è€…æ˜¯ä¿®æ”¹å±æ€§çš„å€¼ç­‰ï¼Œä½¿ç”¨zend_read_property()å’Œ zend_update_property()å‡½æ•°ã€‚</p>

<p>/* zend_API.h 326-328 */
ZEND_API zval *zend_read_property(zend_class_entry *scope, zval *object, char *name, int name_length, zend_bool silent TSRMLS_DC);</p>

<p>ZEND_API zval *zend_read_static_property(zend_class_entry *scope, char *name, int name_length, zend_bool silent TSRMLS_DC);</p>

<p>ZEND_API void zend_update_property(zend_class_entry *scope, zval *object, char *name, int name_length, zval *value TSRMLS_DC);</p>

<p>/* ä¸‹é¢è¿™ä¸ªæ˜¯zend_update_property_*ç³»åˆ—å‡½æ•°ï¼Œä¸declareç³»åˆ—ç±»ä¼¼ï¼Œä¸åšè¯¦è¿°ï¼Œå‚è€ƒzend_API.h 309-328 */
ZEND_API void zend_update_property_long(zend_class_entry *scope, zval *object, char *name, int name_length, long value TSRMLS_DC);</p>

<p>ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬æ³¨å†Œä¸€ä¸ªåä¸ºageçš„longå‹å±æ€§ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„getter/setteræ–¹æ³•ã€‚</p>

<p>/* getAgeæ–¹æ³•çš„å‚æ•°ç±»å‹æç¤ºï¼Œæ— å‚æ•° */
ZEND_BEGIN_ARG_INFO_EX(democlass_getage_args, 0, 0, 0)
ZEND_END_ARG_INFO()</p>

<p>/* setAgeæ–¹æ³•å‚æ•°ç±»å‹æç¤ºï¼Œä¸€ä¸ªå¿…é¡»å‚æ•°ï¼Œåç§°$age */
ZEND_BEGIN_ARG_INFO_EX(democlass_setage_args, 0, 0, 1)
	ZEND_ARG_INFO(0, age)
ZEND_END_ARG_INFO()</p>

<p>/* å°†åˆ›å»ºçš„æ–¹æ³•å‘Šè¯‰zend_function_entryï¼Œè®¾ç½®å¯è§æ€§ä¸ºpublic */
const zend_function_entry ext_demo_1_democlass_functions[] = {
	â€¦
	PHP_ME(DemoClass, setAge, democlass_setage_args, ZEND_ACC_PUBLIC)
	PHP_ME(DemoClass, getAge, democlass_getage_args, ZEND_ACC_PUBLIC)
	PHP_FE_END
};</p>

<p>/* setAge($age)æ–¹æ³• <em>/
PHP_METHOD(DemoClass, setAge)
{
	long age;
	zval *obj;
	if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, â€œlâ€, &amp;age) == FAILURE) {
		RETURN_NULL();
	}
	obj = getThis();/</em> è·å–$thiså¯¹è±¡ <em>/
	/</em> æ›´æ–°ageå­—æ®µçš„ä¿¡æ¯ */
	zend_update_property_long(php_democlass_entry, obj, â€œageâ€, sizeof(â€œageâ€) - 1, age);
}</p>

<p>/* getAgeæ–¹æ³•<em>/
PHP_METHOD(DemoClass, getAge)
{
	zval *obj, *age;
	obj = getThis();
	/</em> æ£€ç´¢ageå±æ€§çš„å€¼ */
	age = zend_read_property(php_democlass_entry, obj, â€œageâ€, sizeof(â€œageâ€) - 1, 1 TSRMLS_CC);
	RETURN_ZVAL(age, 1, 0);
}</p>

<p>/* MINITæ–¹æ³•<em>/
PHP_MINIT_FUNCTION(ext_demo_1)
{
	â€¦/</em> è¿™é‡Œçœç•¥äº†ï¼Œå®Œæˆç±»çš„æ³¨å†Œ <em>/
	/</em> å£°æ˜å±æ€§ageï¼Œå¹¶è®¾ç½®ä¸ºpublicå¯è§æ€§ <em>/
	zend_declare_property_long(php_democlass_entry, â€œageâ€, sizeof(â€œageâ€) - 1, 24, ZEND_ACC_PUBLIC TSRMLS_CC);
	return SUCCESS;
}
è¦åˆ›å»ºstaticå±æ€§çš„è¯ï¼ŒåŒæ ·ä½¿ç”¨zend_declare_property</em>ç³»åˆ—å‡½æ•°ï¼ŒåŒºåˆ«æ˜¯ç±»å‹æ ‡è¯†ç¬¦éœ€è¦å¢åŠ  ZEND_ACC_STATICã€‚å¯¹staticå­—æ®µçš„æ“ä½œä½¿ç”¨zend_read_static_property()å’Œzend_update_static_property*ç³»åˆ—å‡½æ•°ã€‚</p>

<p>è¿˜æœ‰ä¸€ä¸ªæ˜¯ç±»å¸¸é‡ï¼Œç±»å¸¸é‡ä½¿ç”¨zend_declare_class_constant*ç³»åˆ—å®å£°æ˜ï¼Œä½¿ç”¨zend_update_class_constants è¿›è¡Œæ“ä½œã€‚</p>

<p>####æ¥å£å’Œç»§æ‰¿</p>

<p>ä¸åœ¨PHPä¸­ä½¿ç”¨ç±»å’Œæ¥å£ç±»ä¼¼ï¼Œåœ¨æ‰©å±•å¼€å‘ä¸­ï¼Œæ‰©å±•å†…éƒ¨çš„ç±»ä¹Ÿå¯ä»¥ç»§æ‰¿å…¶å®ƒç±»æˆ–è€…å®ç°æ¥å£ã€‚</p>

<p>å½“æˆ‘ä»¬åˆ›å»ºçš„ç±»éœ€è¦ç»§æ‰¿ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç±»çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦å°†æ³¨å†Œç±»çš„å‡½æ•°ä¿®æ”¹ä¸ºzend_register_internal_class_exã€‚</p>

<p>designner_entry = zend_register_internal_class_ex(&amp;temp_designner_ce, person_entry, NULL TSRMLS_CC);
ä¸ä¹‹å‰ä½¿ç”¨zend_register_internal_classä¸åŒçš„æ˜¯ï¼Œ_exç‰ˆæœ¬çš„æ³¨å†Œå‡½æ•°å¢åŠ äº†ä¸¤ä¸ªå‚æ•°ï¼Œ ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¦ç»§æ‰¿çš„ç±»çš„å…¨å±€æ ‡è¯†ï¼Œä¹Ÿå°±æ˜¯åœ¨åˆ›å»ºç±»çš„æ—¶å€™æˆ‘ä»¬é‚£ä¸ªzend_class_entryå…¨å±€å¯¹è±¡ã€‚ è¿™é‡Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºNULLï¼Œè¿™ä¸ªå‚æ•°çš„ä½œç”¨æ˜¯åœ¨è°ƒç”¨å…¶å®ƒæ‰©å±•ç±»æ—¶ï¼Œå¦‚æœæ‰©å±•æ²¡æœ‰æŒ‰ç…§è§„èŒƒå¯¼å‡ºç±»çš„å…¨å±€æ ‡è¯†ç¬¦çš„è¯ï¼Œ æˆ‘ä»¬å°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºNULLï¼Œç¬¬ä¸‰ä¸ªå‚æ•°è®¾ä¸ºå­—ç¬¦ä¸²å½¢å¼çš„ç±»åï¼Œå½“ç„¶ï¼Œä¸æ¨èè¿™æ ·åšï¼Œä¾‹å¦‚ï¼š</p>

<p>custom_exception_ce = zend_register_internal_class_ex(
    &amp;tmp_ce, NULL, â€œRuntimeExceptionâ€ TSRMLS_CC
);
æ¥å£çš„åˆ›å»ºä¸ç±»ç›¸ä¼¼ï¼ŒåŒºåˆ«åœ¨äºåœ¨æ¥å£åˆ›å»ºæ—¶ï¼Œåœ¨zend_function_entryä¸­ï¼Œéœ€è¦å°†æ¥å£æ‰€æœ‰çš„æ–¹æ³• ä½¿ç”¨PHP_ABSTRACT_MEæ·»åŠ ï¼Œå…¶å®ƒæ­¥éª¤ä¸ç±»çš„åˆ›å»ºä¸€æ ·ï¼Œåœ¨MINITæ–¹æ³•ä¸­ï¼Œå½“åˆå§‹åŒ–ç±»ä¹‹åï¼Œåªéœ€è¦å† è®¾ç½®åˆ›å»ºç±»çš„ce_flagså­—æ®µä¸ºZEND_ACC_INTERFACEå³å¯ã€‚</p>

<p>zend_class_entry <em>php_sample3_iface_entry;
PHP_MINIT_FUNCTION(sample3)
{
    zend_class_entry ce;
    INIT_CLASS_ENTRY(ce, â€œSample3_Interfaceâ€,
                        php_sample3_iface_methods);
    php_sample3_iface_entry =
                zend_register_internal_class(&amp;ce TSRMLS_CC);
    php_sample3_iface_entry-&gt;ce_flags|= ZEND_ACC_INTERFACE;/</em> æ³¨æ„è¿™é‡Œä½¿ç”¨äº†â€œ|â€ */
    â€¦
å¦‚æœåˆ›å»ºçš„ç±»è¦å®ç°æ¥å£ï¼Œåªéœ€è¦å†ä½¿ç”¨zend_class_implements()å‡½æ•°æ·»åŠ ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚</p>

<p>/* DataClass implements Countable, ArrayAccess, IteratorAggregate */
zend_class_implements(
        data_class_ce TSRMLS_CC, 3, spl_ce_Countable, zend_ce_arrayaccess, zend_ce_aggregate
    );
è¿™é‡Œçš„zend_class_implements()å‡½æ•°æ˜¯ä¸ªå˜å‚å‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦å®ç°æ¥å£çš„ç±»çš„zend_class_entryå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºéœ€è¦å®ç°çš„æ¥å£çš„ä¸ªæ•°ï¼Œå…¶å®ƒå‚æ•°æ˜¯å¯å˜çš„ï¼Œéƒ½ä¸ºéœ€è¦å®ç°çš„æ¥å£ã€‚</p>

<p>###é™„å½•</p>

<p>####å¯¹è±¡ç»“æ„</p>

<p>åœ¨zvalä¸­ï¼Œä¸å¯¹è±¡æœ‰å…³çš„å­—æ®µæ˜¯zvalue_valueè”åˆä½“ä¸­çš„zend_object_valueå­—æ®µï¼Œ è¯¥ç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p>

<p>/* zend_types.h 53-59 */
typedef unsigned int zend_object_handle;
typedef struct _zend_object_handlers zend_object_handlers;</p>

<p>typedef struct _zend_object_value {
	zend_object_handle handle;
	zend_object_handlers *handlers;
} zend_object_value;
è¯¥ç»“æ„ä½“zend_object_valueä¸­ï¼Œzend_object_handleç±»å‹çš„handleä¸ºintç±»å‹çš„æ•´æ•°å€¼ï¼Œ è¯¥handleæ˜¯ä¸€ä¸ªå”¯ä¸€çš„å¯¹è±¡IDæ ‡è¯†ï¼Œç”¨äºä»å¯¹è±¡å­˜å‚¨ä¸­æŸ¥è¯¢å®é™…çš„å¯¹è±¡ã€‚</p>

<p>ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘zend_object_handlersç»“æ„ä½“çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ä½“å®šä¹‰äº†å®é™…å¯¹è±¡çš„è¡Œä¸º(zend_object_handlers.h 113-141)ã€‚</p>

<p>####ç±»ç»“æ„</p>

<p>åœ¨PHPæ‰©å±•ä¸­ï¼ŒZendå¼•æ“å®šä¹‰äº†zend_class_entryç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªç±»çš„åŸºæœ¬ç»“æ„ã€‚</p>

<p>/* zend.h 418-470 <em>/
struct _zend_class_entry {
	char type;/</em> ç±»çš„ç±»å‹ï¼šZEND_INTERNAL_CLASS æˆ–è€… ZEND_USER_CLASS <em>/
	char *name;/</em> ç±»çš„åç§° <em>/
	zend_uint name_length;/</em> ç±»åç§°é•¿åº¦ ï¼Œ sizeof(name) - 1 <em>/
	struct _zend_class_entry *parent; /</em> è¯¥ç±»çš„çˆ¶ç±» <em>/
	int refcount;/</em> å¼•ç”¨è®¡æ•° <em>/
	zend_bool constants_updated;
  /</em></p>
<ul>
  <li>ce_flagsæŒ‡å®šäº†ç±»çš„åŸºæœ¬å±æ€§</li>
  <li>ZEND_ACC_IMPLICIT_ABSTRACT_CLASS éšå¼çš„æŠ½è±¡ç±»ï¼ˆå«æœ‰abstractæ–¹æ³•ï¼‰</li>
  <li>ZEND_ACC_EXPLICIT_ABSTRACT_CLASS æ·»åŠ äº†abstractå…³é”®å­—çš„æŠ½è±¡ç±»</li>
  <li>ZEND_ACC_FINAL_CLASS è¯¥ç±»æ˜¯finalçš„</li>
  <li>ZEND_ACC_INTERFACE è¿™æ˜¯ä¸€ä¸ªæ¥å£
   */
    zend_uint ce_flags;</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HashTable function_table; /* æ–¹æ³•å“ˆå¸Œè¡¨ */
HashTable default_properties; /* é»˜è®¤å±æ€§å“ˆå¸Œè¡¨ */
HashTable properties_info; /* å±æ€§ä¿¡æ¯å“ˆå¸Œè¡¨ */
HashTable default_static_members; /* é»˜è®¤çš„é™æ€æˆå‘˜å˜é‡å“ˆå¸Œè¡¨ */   /*    * type == ZEND_USER_CLASS    -&gt;  &amp;default_static_members    * type == ZEND_INTERAL_CLASS -&gt; NULL    */
HashTable *static_members;
HashTable constants_table; /* å¸¸é‡å“ˆå¸Œè¡¨ */
const struct _zend_function_entry *builtin_functions; /* æ–¹æ³•å®šä¹‰å…¥å£ */
</code></pre></div></div>

<p>/* æ„é€ å‡½æ•°ã€ææ„å‡½æ•°ã€cloneå‡½æ•°ä»¥åŠå…¶å®ƒé­”æœ¯æ–¹æ³• */
	union _zend_function *constructor;
	union _zend_function *destructor;
	union _zend_function *clone;
	union _zend_function *__get;
	union _zend_function *__set;
	union _zend_function *__unset;
	union _zend_function *__isset;
	union _zend_function *__call;
	union _zend_function *__callstatic;
	union _zend_function *__tostring;
	union _zend_function *serialize_func;
	union _zend_function *unserialize_func;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zend_class_iterator_funcs iterator_funcs;

/* ç±»å¥æŸ„handler */
zend_object_value (*create_object)(zend_class_entry *class_type TSRMLS_DC);
zend_object_iterator *(*get_iterator)(zend_class_entry *ce, zval *object, int by_ref TSRMLS_DC);
</code></pre></div></div>

<p>/* ç±»å£°æ˜çš„æ¥å£ <em>/
	int (</em>interface_gets_implemented)(zend_class_entry <em>iface, zend_class_entry *class_type TSRMLS_DC);
	union _zend_function *(</em>get_static_method)(zend_class_entry <em>ce, char</em> method, int method_len TSRMLS_DC);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* åºåˆ—åŒ–å›è°ƒå‡½æ•° */
int (*serialize)(zval *object, unsigned char **buffer, zend_uint *buf_len, zend_serialize_data *data TSRMLS_DC);
int (*unserialize)(zval **object, zend_class_entry *ce, const unsigned char *buf, zend_uint buf_len, zend_unserialize_data *data TSRMLS_DC);

zend_class_entry **interfaces; /* ç±»å®ç°çš„æ¥å£ */
zend_uint num_interfaces; /* ç±»å®ç°çš„æ¥å£æ•°ç›® */

char *filename; /* ç±»æ‰€åœ¨çš„æ–‡ä»¶ */
zend_uint line_start; /* ç±»å®šä¹‰çš„å¼€å§‹è¡Œ */
zend_uint line_end;/* ç±»å®šä¹‰çš„ç»“æŸè¡Œ */
char *doc_comment;
zend_uint doc_comment_len;

struct _zend_module_entry *module;/* ç±»æ‰€åœ¨çš„æ¨¡å—å…¥å£*/ };
</code></pre></div></div>

:ET