I"ğ6<p>https://segmentfault.com/a/1190000022646776
Goè¯­è¨€çš„æ ‡å‡†åº“é‡Œæä¾›ä¸¤ç§ç±»å‹çš„è®¡æ—¶å™¨Timerå’ŒTickerã€‚Timerç»è¿‡æŒ‡å®šçš„durationæ—¶é—´åè¢«è§¦å‘ï¼Œå¾€è‡ªå·±çš„æ—¶é—´channelå‘é€å½“å‰æ—¶é—´ï¼Œæ­¤åTimerä¸å†è®¡æ—¶ã€‚Tickeråˆ™æ˜¯æ¯éš”durationæ—¶é—´éƒ½ä¼šæŠŠå½“å‰æ—¶é—´ç‚¹å‘é€ç»™è‡ªå·±çš„æ—¶é—´channelï¼Œåˆ©ç”¨è®¡æ—¶å™¨çš„æ—¶é—´channelå¯ä»¥å®ç°å¾ˆå¤šä¸è®¡æ—¶ç›¸å…³çš„åŠŸèƒ½ã€‚</p>

<p>æ–‡ç« ä¸»è¦æ¶‰åŠå¦‚ä¸‹å†…å®¹ï¼š</p>

<p>Timerå’ŒTickerè®¡æ—¶å™¨çš„å†…éƒ¨ç»“æ„è¡¨ç¤º
Timerå’ŒTickerçš„ä½¿ç”¨æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹
å¦‚ä½•æ­£ç¡®Resetå®šæ—¶å™¨
<!-- more --></p>

<p>è®¡æ—¶å™¨çš„å†…éƒ¨è¡¨ç¤º
ä¸¤ç§è®¡æ—¶å™¨éƒ½æ˜¯åŸºäºGoè¯­è¨€çš„è¿è¡Œæ—¶è®¡æ—¶å™¨runtime.timerå®ç°çš„ï¼Œrumtime.timerçš„ç»“æ„ä½“è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>

<p>type timer struct {
    pp puintptr</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>when     int64
period   int64
f        func(interface{}, uintptr)
arg      interface{}
seq      uintptr
nextwhen int64
status   uint32 } rumtime.timerç»“æ„ä½“ä¸­çš„å­—æ®µå«ä¹‰æ˜¯
</code></pre></div></div>

<p>when â€” å½“å‰è®¡æ—¶å™¨è¢«å”¤é†’çš„æ—¶é—´ï¼›
period â€” ä¸¤æ¬¡è¢«å”¤é†’çš„é—´éš”ï¼›
f â€” æ¯å½“è®¡æ—¶å™¨è¢«å”¤é†’æ—¶éƒ½ä¼šè°ƒç”¨çš„å‡½æ•°ï¼›
arg â€” è®¡æ—¶å™¨è¢«å”¤é†’æ—¶è°ƒç”¨ f ä¼ å…¥çš„å‚æ•°ï¼›
nextWhen â€” è®¡æ—¶å™¨å¤„äº timerModifiedLater/timerModifiedEairlier çŠ¶æ€æ—¶ï¼Œç”¨äºè®¾ç½® when å­—æ®µï¼›
status â€” è®¡æ—¶å™¨çš„çŠ¶æ€ï¼›
è¿™é‡Œçš„ runtime.timer åªæ˜¯ç§æœ‰çš„è®¡æ—¶å™¨è¿è¡Œæ—¶è¡¨ç¤ºï¼Œå¯¹å¤–æš´éœ²çš„è®¡æ—¶å™¨ time.Timer å’Œtime.Tickerçš„ç»“æ„ä½“è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>

<p>type Timer struct {
    C &lt;-chan Time
    r runtimeTimer
}</p>

<p>type Ticker struct {
    C &lt;-chan Time 
    r runtimeTimer
}
Timer.Cå’ŒTicker.Cå°±æ˜¯è®¡æ—¶å™¨ä¸­çš„æ—¶é—´channelï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹æ€ä¹ˆä½¿ç”¨è¿™ä¸¤ç§è®¡æ—¶å™¨ï¼Œä»¥åŠä½¿ç”¨æ—¶è¦æ³¨æ„çš„åœ°æ–¹ã€‚</p>

<p>Timerè®¡æ—¶å™¨
time.Timer è®¡æ—¶å™¨å¿…é¡»é€šè¿‡ time.NewTimerã€time.AfterFunc æˆ–è€… time.After å‡½æ•°åˆ›å»ºã€‚ å½“è®¡æ—¶å™¨å¤±æ•ˆæ—¶ï¼Œå¤±æ•ˆçš„æ—¶é—´å°±ä¼šè¢«å‘é€ç»™è®¡æ—¶å™¨æŒæœ‰çš„ channelï¼Œè®¢é˜… channel çš„ goroutine ä¼šæ”¶åˆ°è®¡æ—¶å™¨å¤±æ•ˆçš„æ—¶é—´ã€‚</p>

<p>é€šè¿‡å®šæ—¶å™¨Timerç”¨æˆ·å¯ä»¥å®šä¹‰è‡ªå·±çš„è¶…æ—¶é€»è¾‘ï¼Œå°¤å…¶æ˜¯åœ¨åº”å¯¹ä½¿ç”¨selectå¤„ç†å¤šä¸ªchannelçš„è¶…æ—¶ã€å•channelè¯»å†™çš„è¶…æ—¶ç­‰æƒ…å½¢æ—¶å°¤ä¸ºæ–¹ä¾¿ã€‚Timerå¸¸è§çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>//ä½¿ç”¨time.AfterFuncï¼š</p>

<p>t := time.AfterFunc(d, f)</p>

<p>//ä½¿ç”¨time.Afterï¼š
select {
    case m := &lt;-c:
       handle(m)
    case &lt;-time.After(5 * time.Minute):
       fmt.Println(â€œtimed outâ€)
}</p>

<p>// ä½¿ç”¨time.NewTimer:
t := time.NewTimer(5 * time.Minute)
select {
    case m := &lt;-c:
       handle(m)
    case &lt;-t.C:
       fmt.Println(â€œtimed outâ€)
}
time.AfterFuncè¿™ç§æ–¹å¼åˆ›å»ºçš„Timerï¼Œåœ¨åˆ°è¾¾è¶…æ—¶æ—¶é—´åä¼šåœ¨å•ç‹¬çš„goroutineé‡Œæ‰§è¡Œå‡½æ•°fã€‚</p>

<p>func AfterFunc(d Duration, f func()) *Timer {
    t := &amp;Timer{
        r: runtimeTimer{
            when: when(d),
            f:    goFunc,
            arg:  f,
        },
    }
    startTimer(&amp;t.r)
    return t
}</p>

<p>func goFunc(arg interface{}, seq uintptr) {
    go arg.(func())()
}
ä»ä¸Šé¢AfterFuncçš„æºç å¯ä»¥çœ‹åˆ°å¤–é¢ä¼ å…¥çš„få‚æ•°å¹¶éç›´æ¥èµ‹å€¼ç»™äº†è¿è¡Œæ—¶è®¡æ—¶å™¨çš„fï¼Œè€Œæ˜¯ä½œä¸ºåŒ…è£…å‡½æ•°goFuncçš„å‚æ•°ä¼ å…¥çš„ã€‚goFuncä¼šå¯åŠ¨äº†ä¸€ä¸ªæ–°çš„goroutineæ¥æ‰§è¡Œå¤–éƒ¨ä¼ å…¥çš„å‡½æ•°fã€‚è¿™æ˜¯å› ä¸ºæ‰€æœ‰è®¡æ—¶å™¨çš„äº‹ä»¶å‡½æ•°éƒ½æ˜¯ç”±Goè¿è¡Œæ—¶å†…å”¯ä¸€çš„ goroutine timerprocè¿è¡Œçš„ã€‚ä¸ºäº†ä¸é˜»å¡timerprocçš„æ‰§è¡Œï¼Œå¿…é¡»å¯åŠ¨ä¸€ä¸ªæ–°çš„goroutineæ‰§è¡Œåˆ°æœŸçš„äº‹ä»¶å‡½æ•°ã€‚</p>

<p>å¯¹äºNewTimerå’ŒAfterè¿™ä¸¤ç§åˆ›å»ºæ–¹æ³•ï¼Œåˆ™æ˜¯Timeråœ¨è¶…æ—¶åï¼Œæ‰§è¡Œä¸€ä¸ªæ ‡å‡†åº“ä¸­å†…ç½®çš„å‡½æ•°ï¼šsendTimeã€‚</p>

<p>func NewTimer(d Duration) *Timer {
    c := make(chan Time, 1)
    t := &amp;Timer{
        C: c,
        r: runtimeTimer{
            when: when(d),
            f:    sendTime,
            arg:  c,
        },
    }
    startTimer(&amp;t.r)
    return t
}</p>

<p>func sendTime(c interface{}, seq uintptr) {
    select {
    case c.(chan Time) &lt;- Now():
    default:
    }
}
sendTimeå°†å½“å‰æ—¶é—´å‘é€åˆ°Timerçš„æ—¶é—´channelä¸­ã€‚é‚£ä¹ˆè¿™ä¸ªåŠ¨ä½œä¸ä¼šé˜»å¡timerprocçš„æ‰§è¡Œä¹ˆï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šï¼ŒåŸå› æ˜¯NewTimeråˆ›å»ºçš„æ˜¯ä¸€ä¸ªå¸¦ç¼“å†²çš„channelæ‰€ä»¥æ— è®ºTimer.Cè¿™ä¸ªchannelæœ‰æ²¡æœ‰æ¥æ”¶æ–¹sendTimeéƒ½å¯ä»¥éé˜»å¡çš„å°†å½“å‰æ—¶é—´å‘é€ç»™Timer.Cï¼Œè€Œä¸”sendTimeä¸­è¿˜åŠ äº†åŒä¿é™©ï¼šé€šè¿‡selectåˆ¤æ–­Timer.Cçš„Bufferæ˜¯å¦å·²æ»¡ï¼Œä¸€æ—¦æ»¡äº†ï¼Œä¼šç›´æ¥é€€å‡ºï¼Œä¾ç„¶ä¸ä¼šé˜»å¡ã€‚</p>

<p>Timerçš„Stopæ–¹æ³•å¯ä»¥é˜»æ­¢è®¡æ—¶å™¨è§¦å‘ï¼Œè°ƒç”¨Stopæ–¹æ³•æˆåŠŸåœæ­¢äº†è®¡æ—¶å™¨çš„è§¦å‘å°†ä¼šè¿”å›trueï¼Œå¦‚æœè®¡æ—¶å™¨å·²ç»è¿‡æœŸäº†æˆ–è€…å·²ç»è¢«Stopåœæ­¢è¿‡äº†ï¼Œå†æ¬¡è°ƒç”¨Stopæ–¹æ³•å°†ä¼šè¿”å›falseã€‚</p>

<p>Goè¿è¡Œæ—¶å°†æ‰€æœ‰è®¡æ—¶å™¨ç»´æŠ¤åœ¨ä¸€ä¸ªæœ€å°å †Min Heapä¸­ï¼ŒStopä¸€ä¸ªè®¡æ—¶å™¨å°±æ˜¯ä»å †ä¸­åˆ é™¤è¯¥è®¡æ—¶å™¨ã€‚</p>

<p>Tickerè®¡æ—¶å™¨
Tickerå¯ä»¥å‘¨æœŸæ€§åœ°è§¦å‘æ—¶é—´äº‹ä»¶ï¼Œæ¯æ¬¡åˆ°è¾¾æŒ‡å®šçš„æ—¶é—´é—´éš”åéƒ½ä¼šè§¦å‘äº‹ä»¶ã€‚</p>

<p>time.Tickeréœ€è¦é€šè¿‡time.NewTickeræˆ–è€…time.Tickåˆ›å»ºã€‚</p>

<p>// ä½¿ç”¨time.Tick:
go func() {
    for t := range time.Tick(time.Minute) {
        fmt.Println(â€œTick atâ€, t)
    }
}()</p>

<p>// ä½¿ç”¨time.Ticker
var ticker *time.Ticker = time.NewTicker(1 * time.Second)</p>

<p>go func() {
    for t := range ticker.C {
        fmt.Println(â€œTick atâ€, t)
    }
}()</p>

<p>time.Sleep(time.Second * 5)
ticker.Stop()   <br />
fmt.Println(â€œTicker stoppedâ€)
ä¸è¿‡time.Tickå¾ˆå°‘ä¼šè¢«ç”¨åˆ°ï¼Œé™¤éä½ æƒ³åœ¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸé‡Œéƒ½ä½¿ç”¨time.Tickerçš„æ—¶é—´channelã€‚å®˜æ–‡æ–‡æ¡£é‡Œå¯¹time.Tickçš„æè¿°æ˜¯ï¼š</p>

<p>time.Tickåº•å±‚çš„Tickerä¸èƒ½è¢«åƒåœ¾æ”¶é›†å™¨æ¢å¤ï¼›
æ‰€ä»¥ä½¿ç”¨time.Tickæ—¶ä¸€å®šè¦å°å¿ƒï¼Œä¸ºé¿å…æ„å¤–å°½é‡ä½¿ç”¨time.NewTickerè¿”å›çš„Tickeræ›¿ä»£ã€‚</p>

<p>NewTickeråˆ›å»ºçš„è®¡æ—¶å™¨ä¸NewTimeråˆ›å»ºçš„è®¡æ—¶å™¨æŒæœ‰çš„æ—¶é—´channelä¸€æ ·éƒ½æ˜¯å¸¦ä¸€ä¸ªç¼“å­˜çš„channelï¼Œæ¯æ¬¡è§¦å‘åæ‰§è¡Œçš„å‡½æ•°ä¹Ÿæ˜¯sendTimeï¼Œè¿™æ ·å³ä¿è¯äº†æ— è®ºæœ‰è¯¯æ¥æ”¶æ–¹Tickerè§¦å‘æ—¶é—´äº‹ä»¶æ—¶éƒ½ä¸ä¼šé˜»å¡ï¼š</p>

<p>func NewTicker(d Duration) *Ticker {
    if d &lt;= 0 {
        panic(errors.New(â€œnon-positive interval for NewTickerâ€))
    }
    // Give the channel a 1-element time buffer.
    // If the client falls behind while reading, we drop ticks
    // on the floor until the client catches up.
    c := make(chan Time, 1)
    t := &amp;Ticker{
        C: c,
        r: runtimeTimer{
            when:   when(d),
            period: int64(d),
            f:      sendTime,
            arg:    c,
        },
    }
    startTimer(&amp;t.r)
    return t
}
Resetè®¡æ—¶å™¨æ—¶è¦æ³¨æ„çš„é—®é¢˜
å…³äºResetçš„ä½¿ç”¨å»ºè®®ï¼Œæ–‡æ¡£é‡Œçš„æè¿°æ˜¯ï¼š</p>

<p>é‡ç½®è®¡æ—¶å™¨æ—¶å¿…é¡»æ³¨æ„ä¸è¦ä¸å½“å‰è®¡æ—¶å™¨åˆ°æœŸå‘é€æ—¶é—´åˆ°t.Cçš„æ“ä½œäº§ç”Ÿç«äº‰ã€‚å¦‚æœç¨‹åºå·²ç»ä»t.Cæ¥æ”¶åˆ°å€¼ï¼Œåˆ™è®¡æ—¶å™¨æ˜¯å·²çŸ¥çš„å·²è¿‡æœŸï¼Œå¹¶ä¸”t.Resetå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœç¨‹åºå°šæœªä»t.Cæ¥æ”¶å€¼ï¼Œè®¡æ—¶å™¨å¿…é¡»å…ˆè¢«åœæ­¢ï¼Œå¹¶ä¸”-å¦‚æœä½¿ç”¨t.Stopæ—¶æŠ¥å‘Šè®¡æ—¶å™¨å·²è¿‡æœŸï¼Œé‚£ä¹ˆè¯·æ’ç©ºå…¶é€šé“ä¸­å€¼ã€‚</p>

<p>ä¾‹å¦‚ï¼š</p>

<p>if !t.Stop() {
  &lt;-t.C
}
t.Reset(d)
ä¸‹é¢çš„ä¾‹å­é‡Œproducer goroutineé‡Œæ¯ä¸€ç§’å‘é€šé“ä¸­å‘é€ä¸€ä¸ªfalseå€¼ï¼Œå¾ªç¯ç»“æŸåç­‰å¾…ä¸€ç§’å†å¾€é€šé“é‡Œå‘é€ä¸€ä¸ªtrueå€¼ã€‚åœ¨consumer goroutineé‡Œé€šè¿‡å¾ªç¯è¯•å›¾ä»é€šé“ä¸­è¯»å–å€¼ï¼Œç”¨è®¡æ—¶å™¨è®¾ç½®äº†æœ€é•¿ç­‰å¾…æ—¶é—´ä¸º5ç§’ï¼Œå¦‚æœè®¡æ—¶å™¨è¶…æ—¶äº†ï¼Œè¾“å‡ºå½“å‰æ—¶é—´å¹¶è¿›è¡Œä¸‹æ¬¡å¾ªç¯å°è¯•ï¼Œå¦‚æœä»é€šé“ä¸­è¯»å–å‡ºçš„ä¸æ˜¯æœŸå¾…çš„å€¼ï¼ˆé¢„æœŸå€¼æ˜¯true)ï¼Œåˆ™å°è¯•é‡æ–°ä»é€šé“ä¸­è¯»å–å¹¶é‡ç½®è®¡æ—¶å™¨ã€‚</p>

<p>func main() {
    c := make(chan bool)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go func() {
    for i := 0; i &lt; 5; i++ {
        time.Sleep(time.Second * 1)
        c &lt;- false
    }

    time.Sleep(time.Second * 1)
    c &lt;- true
}()

go func() {
    // try to read from channel, block at most 5s.
    // if timeout, print time event and go on loop.
    // if read a message which is not the type we want(we want true, not false),
    // retry to read.
    timer := time.NewTimer(time.Second * 5)
    for {
        // timer is active , not fired, stop always returns true, no problems occurs.
        if !timer.Stop() {
            &lt;-timer.C
        }
        timer.Reset(time.Second * 5)
        select {
        case b := &lt;-c:
            if b == false {
                fmt.Println(time.Now(), ":recv false. continue")
                continue
            }
            //we want true, not false
            fmt.Println(time.Now(), ":recv true. return")
            return
        case &lt;-timer.C:
            fmt.Println(time.Now(), ":timer expired")
            continue
        }
    }
}()

//to avoid that all goroutine blocks.
var s string
fmt.Scanln(&amp;s) } ç¨‹åºçš„è¾“å‡ºå¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>2020-05-13 12:49:48.90292 +0800 CST m=+1.004554120 :recv false. continue
2020-05-13 12:49:49.906087 +0800 CST m=+2.007748042 :recv false. continue
2020-05-13 12:49:50.910208 +0800 CST m=+3.011892138 :recv false. continue
2020-05-13 12:49:51.914291 +0800 CST m=+4.015997373 :recv false. continue
2020-05-13 12:49:52.916762 +0800 CST m=+5.018489240 :recv false. continue
2020-05-13 12:49:53.920384 +0800 CST m=+6.022129708 :recv true. return
ç›®å‰æ¥çœ‹æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½¿ç”¨Reseté‡ç½®è®¡æ—¶å™¨ä¹Ÿèµ·ä½œç”¨äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯¹producer goroutinåšä¸€äº›æ›´æ”¹ï¼Œæˆ‘ä»¬æŠŠproducer goroutineé‡Œæ¯ç§’å‘é€å€¼çš„é€»è¾‘æ”¹æˆæ¯6ç§’å‘é€å€¼ï¼Œè€Œconsumer gouroutineé‡Œå’Œè®¡æ—¶å™¨è¿˜æ˜¯5ç§’å°±åˆ°æœŸã€‚</p>

<p>// producer
    go func() {
        for i := 0; i &lt; 5; i++ {
            time.Sleep(time.Second * 6)
            c &lt;- false
        }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    time.Sleep(time.Second * 6)
    c &lt;- true
}() å†æ¬¡è¿è¡Œä¼šå‘ç°ç¨‹åºå‘ç”Ÿäº†deadlockåœ¨ç¬¬ä¸€æ¬¡æŠ¥å‘Šè®¡æ—¶å™¨è¿‡æœŸåç›´æ¥é˜»å¡ä½äº†ï¼š
</code></pre></div></div>

<p>2020-05-13 13:09:11.166976 +0800 CST m=+5.005266022 :timer expired</p>

<p>é‚£ç¨‹åºæ˜¯åœ¨å“ªé˜»å¡ä½çš„å‘¢ï¼Ÿå¯¹å°±æ˜¯åœ¨æŠ½å¹²timer.Cé€šé“æ—¶é˜»å¡ä½äº†ï¼ˆè‹±æ–‡å«åšdrain channelæ¯”å–»æˆæµå¹²ç®¡é“é‡Œçš„æ°´ï¼Œåœ¨ç¨‹åºé‡Œå°±æ˜¯è®©timer.Cç®¡é“ä¸­ä¸å†å­˜åœ¨æœªæ¥æ”¶çš„å€¼)ã€‚</p>

<p>if !timer.Stop() {
    &lt;-timer.C
}
timer.Reset(time.Second * 5)
producer goroutineçš„å‘é€è¡Œä¸ºå‘ç”Ÿäº†å˜åŒ–ï¼Œcomsumer goroutineåœ¨æ”¶åˆ°ç¬¬ä¸€ä¸ªæ•°æ®å‰æœ‰äº†ä¸€æ¬¡è®¡æ—¶å™¨è¿‡æœŸçš„äº‹ä»¶ï¼Œforå¾ªç¯è¿›è¡Œä¸€ä¸‹æ¬¡å¾ªç¯ã€‚è¿™æ—¶timer.Stopå‡½æ•°è¿”å›çš„ä¸å†æ˜¯trueï¼Œè€Œæ˜¯falseï¼Œå› ä¸ºè®¡æ—¶å™¨å·²ç»è¿‡æœŸäº†ï¼Œä¸Šé¢æåˆ°çš„ç»´æŠ¤ç€æ‰€æœ‰æ´»è·ƒè®¡æ—¶å™¨çš„æœ€å°å †ä¸­å·²ç»ä¸åŒ…å«è¯¥è®¡æ—¶å™¨äº†ã€‚è€Œæ­¤æ—¶timer.Cä¸­å¹¶æ²¡æœ‰æ•°æ®ï¼Œæ¥ä¸‹æ¥ç”¨äºdrain channelçš„ä»£ç ä¼šå°†consumer goroutineé˜»å¡ä½ã€‚</p>

<p>è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥ç›´æ¥Resetè®¡æ—¶å™¨ï¼Œè€Œä¸ç”¨æ˜¾å¼drain channelã€‚å¦‚ä½•å°†è¿™ä¸¤ç§æƒ…å½¢åˆäºŒä¸ºä¸€å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªselectæ¥åŒ…è£¹drain channelçš„æ“ä½œï¼Œè¿™æ ·æ— è®ºchannelä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Œdrainéƒ½ä¸ä¼šé˜»å¡ä½ã€‚</p>

<p>//consumer
    go func() {
        // try to read from channel, block at most 5s.
        // if timeout, print time event and go on loop.
        // if read a message which is not the type we want(we want true, not false),
        // retry to read.
        timer := time.NewTimer(time.Second * 5)
        for {
            // timer may be not active, and fired
            if !timer.Stop() {
                select {
                case &lt;-timer.C: //try to drain from the channel
                default:
                }
            }
            timer.Reset(time.Second * 5)
            select {
            case b := &lt;-c:
                if b == false {
                    fmt.Println(time.Now(), â€œ:recv false. continueâ€)
                    continue
                }
                //we want true, not false
                fmt.Println(time.Now(), â€œ:recv true. returnâ€)
                return
            case &lt;-timer.C:
                fmt.Println(time.Now(), â€œ:timer expiredâ€)
                continue
            }
        }
    }()
è¿è¡Œä¿®æ”¹åçš„ç¨‹åºï¼Œå‘ç°ç¨‹åºä¸ä¼šè¢«é˜»å¡ä½ï¼Œèƒ½æ­£å¸¸è¿›è¡Œé€šé“è¯»å–ï¼Œè¯»å–åˆ°trueå€¼åä¼šè‡ªè¡Œé€€å‡ºã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>

<p>2020-05-13 13:25:08.412679 +0800 CST m=+5.005475546 :timer expired
2020-05-13 13:25:09.409249 +0800 CST m=+6.002037341 :recv false. continue
2020-05-13 13:25:14.412282 +0800 CST m=+11.005029547 :timer expired
2020-05-13 13:25:15.414482 +0800 CST m=+12.007221569 :recv false. continue
2020-05-13 13:25:20.416826 +0800 CST m=+17.009524859 :timer expired
2020-05-13 13:25:21.418555 +0800 CST m=+18.011245687 :recv false. continue
2020-05-13 13:25:26.42388 +0800 CST m=+23.016530193 :timer expired
2020-05-13 13:25:27.42294 +0800 CST m=+24.015582511 :recv false. continue
2020-05-13 13:25:32.425666 +0800 CST m=+29.018267054 :timer expired
2020-05-13 13:25:33.428189 +0800 CST m=+30.020782483 :recv false. continue
2020-05-13 13:25:38.432428 +0800 CST m=+35.024980796 :timer expired
2020-05-13 13:25:39.428343 +0800 CST m=+36.020887629 :recv true. return
æ€»ç»“
ä»¥ä¸Šæ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»äº†Goè¯­è¨€çš„è®¡æ—¶å™¨ä»¥åŠå®ƒä»¬çš„ä½¿ç”¨æ–¹æ³•å’Œæ³¨æ„äº‹é¡¹ï¼Œæ€»ç»“ä¸€ä¸‹æœ‰å¦‚ä¸‹å…³é”®ç‚¹ï¼š</p>

<p>Timerå’ŒTickeréƒ½æ˜¯åœ¨è¿è¡Œæ—¶è®¡æ—¶å™¨runtime.timerçš„åŸºç¡€ä¸Šå®ç°çš„ã€‚
è¿è¡Œæ—¶é‡Œçš„æ‰€æœ‰è®¡æ—¶å™¨çš„äº‹ä»¶å‡½æ•°éƒ½ç”±è¿è¡Œæ—¶å†…å”¯ä¸€çš„goroutine timerprocè§¦å‘ã€‚
time.Tickåˆ›å»ºçš„Tickeråœ¨è¿è¡Œæ—¶ä¸ä¼šè¢«gcå›æ”¶ï¼Œèƒ½ä¸ç”¨å°±ä¸ç”¨ã€‚
Timerå’ŒTickerçš„æ—¶é—´channeléƒ½æ˜¯å¸¦æœ‰ä¸€ä¸ªç¼“å†²çš„é€šé“ã€‚
time.Afterï¼Œtime.NewTimerï¼Œtime.NewTickeråˆ›å»ºçš„è®¡æ—¶å™¨è§¦å‘æ—¶éƒ½ä¼šæ‰§è¡ŒsendTimeã€‚
sendTimeå’Œè®¡æ—¶å™¨å¸¦ç¼“å­˜çš„æ—¶é—´é€šé“ä¿è¯äº†è®¡æ—¶å™¨ä¸ä¼šé˜»å¡ç¨‹åºã€‚
Resetè®¡æ—¶å™¨æ—¶è¦æ³¨æ„drain channelå’Œè®¡æ—¶å™¨è¿‡æœŸå­˜åœ¨ç«äº‰æ¡ä»¶</p>
:ET