I"‰<p>ip netns å‘½ä»¤ç”¨æ¥ç®¡ç† network namespaceã€‚å®ƒå¯ä»¥åˆ›å»ºå‘½åçš„ network namespaceï¼Œç„¶åé€šè¿‡åå­—æ¥å¼•ç”¨ network namespaceï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ã€‚</p>

<p>ip netns å‘½ä»¤æ ¼å¼å¦‚ä¸‹ï¼š
ip [ OPTIONS ] netns  { COMMAND | help }</p>

<p>å¯ä»¥é€šè¿‡ help å‘½ä»¤æŸ¥çœ‹ ip netns æ‰€æœ‰æ“ä½œçš„å¸®åŠ©ä¿¡æ¯ï¼š
<!-- more -->
network namespace
network namespace åœ¨é€»è¾‘ä¸Šæ˜¯ç½‘ç»œå †æ ˆçš„ä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒæœ‰è‡ªå·±çš„è·¯ç”±ã€é˜²ç«å¢™è§„åˆ™å’Œç½‘ç»œè®¾å¤‡ã€‚
é»˜è®¤æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹ç»§æ‰¿å…¶çˆ¶è¿›ç¨‹çš„ network namespaceã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸æ˜¾å¼åˆ›å»ºæ–°çš„ network namespaceï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½ä» init è¿›ç¨‹ç»§æ‰¿ç›¸åŒçš„é»˜è®¤ network namespaceã€‚
æ ¹æ®çº¦å®šï¼Œå‘½åçš„ network namespace æ˜¯å¯ä»¥æ‰“å¼€çš„ /var/run/netns/ ç›®å½•ä¸‹çš„ä¸€ä¸ªå¯¹è±¡ã€‚æ¯”å¦‚æœ‰ä¸€ä¸ªåç§°ä¸º net1 çš„ network namespace å¯¹è±¡ï¼Œåˆ™å¯ä»¥ç”±æ‰“å¼€ /var/run/netns/net1 å¯¹è±¡äº§ç”Ÿçš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨ network namespace net1ã€‚é€šè¿‡å¼•ç”¨è¯¥æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ä¿®æ”¹è¿›ç¨‹çš„ network namespaceã€‚</p>

<p>æ˜¾ç¤ºæ‰€æœ‰å‘½åçš„ network namespace
ip netns list å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰å‘½åçš„ network namesapceï¼Œå…¶å®å°±æ˜¯æ˜¾ç¤º /var/run/netns ç›®å½•ä¸‹çš„æ‰€æœ‰ network namespace å¯¹è±¡ï¼š</p>

<p>åˆ›å»ºå‘½åçš„ network namespace
ip netns add NAME å‘½ä»¤åˆ›å»ºä¸€ä¸ªå‘½åçš„ network namespaceï¼š</p>

<p>åˆ é™¤å‘½åçš„ network namespace
ip [-all] netns del [ NAME ] å‘½ä»¤åˆ é™¤æŒ‡å®šåç§°çš„ network namespaceã€‚å¦‚æœæŒ‡å®šäº† -all é€‰é¡¹ï¼Œåˆ™å°è¯•åˆ é™¤æ‰€æœ‰çš„ network namespaceã€‚</p>

<p>æ³¨æ„ï¼Œå¦‚æœæˆ‘ä»¬æŠŠç½‘å¡è®¾ç½®åˆ°äº†æŸä¸ª network namespace ä¸­ï¼Œå¹¶åœ¨è¯¥ network namespace ä¸­å¯åŠ¨äº†è¿›ç¨‹ï¼š</p>

<p>$ sudo ip netns add net0
$ sudo ip link set dev eth0 netns net0
$ sudo ip netns exec net0 bash
åœ¨å¦ä¸€ä¸ª bash è¿›ç¨‹ä¸­åˆ é™¤ network namespace net0ï¼š</p>

<p>$ sudo ip netns del net0
æ­¤æ—¶è™½ç„¶å¯ä»¥åˆ é™¤ netowrk namespaceï¼Œä½†æ˜¯åœ¨è¿›ç¨‹é€€å‡ºä¹‹å‰ï¼Œç½‘å¡ä¸€ç›´ä¼šä¿æŒåœ¨ä½ å·²ç»åˆ é™¤äº†çš„é‚£ä¸ª network namespace ä¸­ã€‚</p>

<p>æŸ¥çœ‹è¿›ç¨‹çš„ network namespace
ip netns identify [PID] å‘½ä»¤ç”¨æ¥æŸ¥çœ‹è¿›ç¨‹çš„ network namespaceã€‚å¦‚æœä¸æŒ‡å®š PID å°±æ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„ network namespaceï¼š
ä¸‹é¢çš„å‘½ä»¤æŒ‡å®šäº† PIDï¼š
æŸ¥çœ‹ network namespace ä¸­è¿›ç¨‹çš„ PID
ip netns pids NAME å‘½ä»¤ç”¨æ¥æŸ¥çœ‹æŒ‡å®šçš„ network namespace ä¸­çš„è¿›ç¨‹çš„ PIDã€‚è¿™ä¸ªå‘½ä»¤å…¶å®å°±æ˜¯å»æ£€æŸ¥ /proc ä¸‹çš„æ‰€æœ‰è¿›ç¨‹ï¼Œçœ‹è¿›ç¨‹çš„ network namespace æ˜¯ä¸æ˜¯æŒ‡å®šçš„ network namespaceï¼š</p>

<p>åœ¨æŒ‡å®šçš„ network namespace ä¸­æ‰§è¡Œå‘½ä»¤
ip [-all] netns exec [ NAME ] cmd å‘½ä»¤ç”¨æ¥åœ¨æŒ‡å®šçš„ network namespace ä¸­æ‰§è¡Œå‘½ä»¤ã€‚æ¯”å¦‚æˆ‘ä»¬è¦çœ‹ä¸€ä¸‹æŸä¸ª network namespace ä¸­æœ‰å“ªäº›ç½‘å¡ï¼š
ip netns exec neta ip addr</p>

<p>ip netns exec åé¢è·Ÿç€ namespace çš„åå­—ï¼Œæ¯”å¦‚è¿™é‡Œçš„ netaï¼Œç„¶åæ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œåªè¦æ˜¯åˆæ³•çš„ shell å‘½ä»¤éƒ½èƒ½è¿è¡Œï¼Œæ¯”å¦‚ä¸Šé¢çš„ ip addr æˆ–è€… bashã€‚
æ›´æ£’çš„æ˜¯ï¼Œæ‰§è¡Œçš„å¯ä»¥æ˜¯ä»»ä½•å‘½ä»¤ï¼Œä¸åªæ˜¯å’Œç½‘ç»œç›¸å…³çš„(å½“ç„¶ï¼Œå’Œç½‘ç»œæ— å…³å‘½ä»¤æ‰§è¡Œçš„ç»“æœå’Œåœ¨å¤–éƒ¨æ‰§è¡Œæ²¡æœ‰åŒºåˆ«)ã€‚æ¯”å¦‚ä¸‹é¢ä¾‹å­ä¸­ï¼Œæ‰§è¡Œ bash å‘½ä»¤ä¹‹åï¼Œåé¢æ‰€æœ‰çš„å‘½ä»¤éƒ½æ˜¯åœ¨è¿™ä¸ª network namespace ä¸­æ‰§è¡Œçš„ï¼Œå¥½å¤„æ˜¯ä¸ç”¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤éƒ½è¦æŠŠ ip netns exec NAME è¡¥å…¨ï¼Œç¼ºç‚¹æ˜¯ä½ æ— æ³•æ¸…æ¥šçŸ¥é“è‡ªå·±å½“å‰æ‰€åœ¨çš„ shellï¼Œå®¹æ˜“æ··æ·†</p>

<p>é€šè¿‡ -all å‚æ•°æˆ‘ä»¬å¯ä»¥åŒæ—¶åœ¨æ‰€æœ‰çš„ network namespace æ‰§è¡Œå‘½ä»¤ï¼š</p>

<p>è¾“å‡ºä¸­çš„ netns: æŒ‡ç¤ºåœ¨æŸä¸ª network namespace ä¸­æ‰§è¡Œçš„ç»“æœã€‚</p>

<p>ç›‘æ§å¯¹ network namespace çš„æ“ä½œ
ip netns monitor å‘½ä»¤ç”¨æ¥ç›‘æ§å¯¹ network namespace çš„æ“ä½œã€‚æ¯”å¦‚æˆ‘ä»¬åˆ é™¤ä¸€ä¸ª network namespace æ—¶å°±ä¼šæ”¶åˆ°ç›¸åº”çš„é€šçŸ¥</p>

<p>ç†è§£ ip netns add å‘½ä»¤
æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„æ¼”ç¤ºæ¥ç†è§£ ip netns add å‘½ä»¤çš„æœ¬è´¨ã€‚
æŸ¥çœ‹é»˜è®¤ network namespace çš„ IDï¼š</p>

<p>$ readlink /proc/$$/ns/net
åœ¨ /var/run/netns ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªç”¨äºç»‘å®š network namespace çš„æ–‡ä»¶ï¼Œåä¸º mynetï¼š</p>

<p>$ sudo mkdir -p /var/run/netns
$ sudo touch /var/run/netns/mynet</p>

<p>é€šè¿‡ unshare å‘½ä»¤åˆ›å»ºæ–°çš„ network namespaceï¼Œå¹¶åœ¨æ–°çš„ namespace ä¸­å¯åŠ¨æ–°çš„ bashï¼š</p>

<p>$ sudo unshare â€“net bash
æŸ¥çœ‹æ–°çš„ network namespace IDï¼š</p>

<h1 id="readlink-procnsnet">readlink /proc/$$/ns/net</h1>

<p>é€šè¿‡ç»‘å®šæŒ‚è½½æŠŠå½“å‰ bash è¿›ç¨‹çš„ network namespace æ–‡ä»¶æŒ‚è½½åˆ°å‰é¢åˆ›å»ºçš„ mynet æ–‡ä»¶ä¸Šï¼š</p>

<h1 id="mount-bind-procnsnet-varrunnetnsmynet">mount â€“bind /proc/$$/ns/net /var/run/netns/mynet</h1>
<h1 id="ls--i-varrunnetnsmynet">ls -I /var/run/netns/mynet</h1>
<p>é€šè¿‡ ls -I å‘½ä»¤å¯ä»¥çœ‹åˆ°æ–‡ä»¶ mynet çš„ inode å·å’Œ network namespace çš„ ID ç›¸åŒï¼Œè¯´æ˜ç»‘å®šæˆåŠŸï¼š</p>

<p>é€€å‡ºæ–°åˆ›å»ºçš„ bashï¼Œå†æ£€æŸ¥ä¸€æ¬¡ mynet æ–‡ä»¶çš„ inodeï¼š</p>

<h1 id="exit">exit</h1>
<p>$ ls -I /var/run/netns/mynet</p>

<p>å¯ä»¥çœ‹å‡º mynet æ–‡ä»¶çš„ inode æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œè¯´æ˜æˆ‘ä»¬ä½¿ç”¨äº†ç»‘å®šæŒ‚è½½åï¼Œè™½ç„¶æ–°çš„ network namespace ä¸­å·²ç»æ²¡æœ‰è¿›ç¨‹äº†ï¼Œä½†è¿™ä¸ªæ–°çš„ network namespace è¿˜ç»§ç»­å­˜åœ¨ã€‚</p>

<p>ä¸Šé¢çš„ä¸€ç³»åˆ—æ“ä½œå…¶å®ç­‰åŒäºæ‰§è¡Œäº†å‘½ä»¤ï¼šsudo ip netns add mynet
ä¸‹é¢çš„ nsenter å‘½ä»¤åˆ™ç­‰åŒäºæ‰§è¡Œäº†å‘½ä»¤ï¼š sudo ip netns exec mynet bash</p>

<p>$ sudo nsenter â€“net=/var/run/netns/mynet bash</p>
<h1 id="readlink-procnsnet-1">readlink /proc/$$/ns/net</h1>

<p>é€šè¿‡ nsenter å‘½ä»¤æ–°å»ºäº†ä¸€ä¸ª bash è¿›ç¨‹ï¼Œå¹¶æŠŠå®ƒåŠ å…¥ mynet æ‰€å…³è”çš„ network namespace(net:[4026532616])ã€‚</p>

<p>ä»ä¸Šé¢çš„ç¤ºä¾‹å¯ä»¥çœ‹å‡ºï¼Œåˆ›å»ºå‘½åçš„ network namespace å…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åé€šè¿‡ç»‘å®šæŒ‚è½½çš„æ–¹å¼å°†æ–°åˆ›å»ºçš„ network namespace æ–‡ä»¶(/proc/$$/ns/net)å’Œè¯¥æ–‡ä»¶ç»‘å®šï¼Œå°±ç®—è¯¥ network namespace é‡Œçš„æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºäº†ï¼Œå†…æ ¸è¿˜æ˜¯ä¼šä¿ç•™è¯¥ network namespaceï¼Œä»¥åæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡è¿™ä¸ªç»‘å®šçš„æ–‡ä»¶æ¥åŠ å…¥è¯¥ network namespaceã€‚</p>

<p>network namespace æ˜¯å®ç°ç½‘ç»œè™šæ‹ŸåŒ–çš„é‡è¦åŠŸèƒ½ï¼Œå®ƒèƒ½åˆ›å»ºå¤šä¸ªéš”ç¦»çš„ç½‘ç»œç©ºé—´ï¼Œå®ƒä»¬æœ‰ç‹¬è‡ªçš„ç½‘ç»œæ ˆä¿¡æ¯ã€‚ä¸ç®¡æ˜¯è™šæ‹Ÿæœºè¿˜æ˜¯å®¹å™¨ï¼Œè¿è¡Œçš„æ—¶å€™ä»¿ä½›è‡ªå·±å°±åœ¨ç‹¬ç«‹çš„ç½‘ç»œä¸­
network namespace æ˜¯ linux å†…æ ¸æä¾›çš„åŠŸèƒ½ï¼Œ
å€ŸåŠ© ip å‘½ä»¤æ¥å®Œæˆå„ç§æ“ä½œã€‚ip å‘½ä»¤æ¥è‡ªäº iproute2 å®‰è£…åŒ…ï¼Œä¸€èˆ¬ç³»ç»Ÿä¼šé»˜è®¤å®‰è£…</p>

<p>NOTEï¼šip å‘½ä»¤å› ä¸ºéœ€è¦ä¿®æ”¹ç³»ç»Ÿçš„ç½‘ç»œé…ç½®ï¼Œé»˜è®¤éœ€è¦ sudo æƒé™ã€‚è¿™ç¯‡æ–‡ç« ä½¿ç”¨ root ç”¨æˆ·æ‰§è¡Œï¼Œè¯·ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæˆ–è€…é‡è¦çš„ç³»ç»Ÿä¸­ç”¨ root ç›´æ¥æ‰§è¡Œï¼Œä»¥é˜²äº§ç”Ÿé”™è¯¯ã€‚</p>

<p>ip å‘½ä»¤ç®¡ç†çš„åŠŸèƒ½å¾ˆå¤šï¼Œ å’Œ network namespace æœ‰å…³çš„æ“ä½œéƒ½æ˜¯åœ¨å­å‘½ä»¤ ip netns ä¸‹è¿›è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡ ip netns help` æŸ¥çœ‹æ‰€æœ‰æ“ä½œçš„å¸®åŠ©ä¿¡æ¯ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ip netns æ˜¯æ²¡æœ‰ç½‘ç»œ namespace çš„ï¼Œæ‰€ä»¥ ip netns ls å‘½ä»¤çœ‹ä¸åˆ°ä»»ä½•è¾“å‡ºã€‚</p>

<p>[root@localhost ~]# ip netns help
Usage: ip netns list
       ip netns add NAME
       ip netns delete NAME
       ip netns identify PID
       ip netns pids NAME
       ip netns exec NAME cmd â€¦
       ip netns monitor
[root@localhost ~]# ip netns ls
åˆ›å»º network namespace ä¹Ÿéå¸¸ç®€å•ï¼Œç›´æ¥ä½¿ç”¨ ip netns add åé¢è·Ÿç€è¦åˆ›å»ºçš„ namespace åç§°ã€‚å¦‚æœç›¸åŒåå­—çš„ namespace å·²ç»å­˜åœ¨ï¼Œå‘½ä»¤ä¼šæŠ¥ Cannot create namespace çš„é”™è¯¯ã€‚</p>

<p>[root@localhost ~]# ip netns add net1
[root@localhost ~]# ip netns ls
net1
ip netns å‘½ä»¤åˆ›å»ºçš„ network namespace ä¼šå‡ºç°åœ¨ /var/run/netns/ ç›®å½•ä¸‹ï¼Œå¦‚æœéœ€è¦ç®¡ç†å…¶ä»–ä¸æ˜¯ ip netns åˆ›å»ºçš„ network namespaceï¼Œåªè¦åœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæŒ‡å‘å¯¹åº” network namespace æ–‡ä»¶çš„é“¾æ¥å°±è¡Œã€‚</p>

<p>æœ‰äº†è‡ªå·±åˆ›å»ºçš„ network namespaceï¼Œæˆ‘ä»¬è¿˜éœ€è¦çœ‹çœ‹å®ƒé‡Œé¢æœ‰å“ªäº›ä¸œè¥¿ã€‚å¯¹äºæ¯ä¸ª network namespace æ¥è¯´ï¼Œå®ƒä¼šæœ‰è‡ªå·±ç‹¬ç«‹çš„ç½‘å¡ã€è·¯ç”±è¡¨ã€ARP è¡¨ã€iptables ç­‰å’Œç½‘ç»œç›¸å…³çš„èµ„æºã€‚ip å‘½ä»¤æä¾›äº† ip netns exec å­å‘½ä»¤å¯ä»¥åœ¨å¯¹åº”çš„ network namespace ä¸­æ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦çœ‹ä¸€ä¸‹è¿™ä¸ª network namespace ä¸­æœ‰å“ªäº›ç½‘å¡ã€‚æ›´æ£’çš„æ˜¯ï¼Œè¦æ‰§è¡Œçš„å¯ä»¥æ˜¯ä»»ä½•å‘½ä»¤ï¼Œä¸åªæ˜¯å’Œç½‘ç»œç›¸å…³çš„ï¼ˆå½“ç„¶ï¼Œå’Œç½‘ç»œæ— å…³å‘½ä»¤æ‰§è¡Œçš„ç»“æœå’Œåœ¨å¤–éƒ¨æ‰§è¡Œæ²¡æœ‰åŒºåˆ«ï¼‰ã€‚æ¯”å¦‚ä¸‹é¢ä¾‹å­ä¸­ï¼Œæ‰§è¡Œ bash å‘½ä»¤äº†ä¹‹åï¼Œåé¢æ‰€æœ‰çš„å‘½ä»¤éƒ½æ˜¯åœ¨è¿™ä¸ª network namespace ä¸­æ‰§è¡Œçš„ï¼Œå¥½å¤„æ˜¯ä¸ç”¨æ¯æ¬¡æ‰§è¡Œå‘½ä»¤éƒ½è¦æŠŠ ip netns exec NAME è¡¥å…¨ï¼Œç¼ºç‚¹æ˜¯ä½ æ— æ³•æ¸…æ¥šçŸ¥é“è‡ªå·±å½“å‰æ‰€åœ¨çš„ shellï¼Œå®¹æ˜“æ··æ·†ã€‚</p>

<p>[root@localhost ~]# ip netns exec net1 ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
[root@localhost ~]# ip netns exec net1 bash
[root@localhost ~]# ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
[root@localhost ~]# exit
exit
æ›´æ–°ï¼šé€šè¿‡ä¿®æ”¹ bash çš„å‰ç¼€ä¿¡æ¯å¯ä»¥åŒºåˆ†ä¸åŒ shellï¼Œæ“ä½œå¦‚ä¸‹ï¼š</LOOPBACK></LOOPBACK></p>

<p>$ ip netns exec ns1 /bin/bash â€“rcfile &lt;(echo â€œPS1="namespace ns1&gt; "â€)</p>

<p>namespace ns1&gt; ping www.google.com
PING www.google.com (178.60.128.38) 56(84) bytes of data.
64 bytes from cache.google.com (178.60.128.38): icmp_seq=1 ttl=58 time=17.6 ms
ip netns exec åé¢è·Ÿç€ namespace çš„åå­—ï¼Œæ¯”å¦‚è¿™é‡Œçš„ net1ï¼Œç„¶åæ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ï¼Œåªè¦æ˜¯åˆæ³•çš„ shell å‘½ä»¤éƒ½èƒ½è¿è¡Œï¼Œæ¯”å¦‚ä¸Šé¢çš„ ip addr æˆ–è€… bashã€‚</p>

<p>æ¯ä¸ª namespace åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª lo çš„ interfaceï¼Œå®ƒçš„ä½œç”¨å’Œ linux ç³»ç»Ÿä¸­é»˜è®¤çœ‹åˆ°çš„ lo ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸ºäº†å®ç° loopback é€šä¿¡ã€‚å¦‚æœå¸Œæœ› lo èƒ½å·¥ä½œï¼Œä¸è¦å¿˜è®°å¯ç”¨å®ƒï¼š</p>

<p>[root@localhost ~]# ip netns exec net1 ip link set lo up
é»˜è®¤æƒ…å†µä¸‹ï¼Œnetwork namespace æ˜¯ä¸èƒ½å’Œä¸»æœºç½‘ç»œï¼Œæˆ–è€…å…¶ä»– network namespace é€šä¿¡çš„ã€‚</p>

<p>network namespace ä¹‹é—´é€šä¿¡
æœ‰äº†ä¸åŒ network namespace ä¹‹åï¼Œä¹Ÿå°±æœ‰äº†ç½‘ç»œçš„éš”ç¦»ï¼Œä½†æ˜¯å¦‚æœå®ƒä»¬ä¹‹é—´æ²¡æœ‰åŠæ³•é€šä¿¡ï¼Œä¹Ÿæ²¡æœ‰å®é™…ç”¨å¤„ã€‚è¦æŠŠä¸¤ä¸ªç½‘ç»œè¿æ¥èµ·æ¥ï¼Œlinux æä¾›äº† veth pair ã€‚å¯ä»¥æŠŠ veth pair å½“åšæ˜¯åŒå‘çš„ pipeï¼ˆç®¡é“ï¼‰ï¼Œä»ä¸€ä¸ªæ–¹å‘å‘é€çš„ç½‘ç»œæ•°æ®ï¼Œå¯ä»¥ç›´æ¥è¢«å¦å¤–ä¸€ç«¯æ¥æ”¶åˆ°ï¼›æˆ–è€…ä¹Ÿå¯ä»¥æƒ³è±¡æˆä¸¤ä¸ª namespace ç›´æ¥é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„è™šæ‹Ÿç½‘å¡è¿æ¥èµ·æ¥ï¼Œå¯ä»¥ç›´æ¥é€šä¿¡ã€‚</p>

<p>ä½¿ç”¨ä¸Šé¢æåˆ°çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å†åˆ›å»ºå¦å¤–ä¸€ä¸ª network namespaceï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ net0 å’Œ net1 ä¸¤ä¸ªåå­—ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ip link add type veth æ¥åˆ›å»ºä¸€å¯¹ veth pair å‡ºæ¥ï¼Œéœ€è¦è®°ä½çš„æ˜¯ veth pair æ— æ³•å•ç‹¬å­˜åœ¨ï¼Œåˆ é™¤å…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¹Ÿä¼šè‡ªåŠ¨æ¶ˆå¤±ã€‚</p>

<p>[root@localhost ~]# ip link add type veth
[root@localhost ~]# ip link
4: veth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether 36:88:73:83:c9:64 brd ff:ff:ff:ff:ff:ff
5: veth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
    link/ether fe:7e:75:4d:79:2e brd ff:ff:ff:ff:ff:ff
å°çŸ¥è¯†: åˆ›å»º veth pair çš„æ—¶å€™å¯ä»¥è‡ªå·±æŒ‡å®šå®ƒä»¬çš„åå­—ï¼Œæ¯”å¦‚ ip link add vethfoo type veth peer name vethbar åˆ›å»ºå‡ºæ¥çš„ä¸¤ä¸ªåå­—å°±æ˜¯ vethfoo å’Œ vethbar ã€‚å› ä¸ºè¿™é‡Œæˆ‘ä»¬å¯¹åå­—æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œæ‰€ä»¥å°±ç›´æ¥ä½¿ç”¨ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„åå­—ã€‚å¦‚æœ pair çš„ä¸€ç«¯æ¥å£å¤„äº DOWN çŠ¶æ€ï¼Œå¦ä¸€ç«¯èƒ½è‡ªåŠ¨æ£€æµ‹åˆ°è¿™ä¸ªä¿¡æ¯ï¼Œå¹¶æŠŠè‡ªå·±çš„çŠ¶æ€è®¾ç½®ä¸º NO-CARRIERã€‚</p>

<p>åˆ›å»ºç»“æŸä¹‹åï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°åå­—ä¸º veth0 å’Œ veth1 ä¸¤ä¸ªç½‘ç»œæ¥å£ï¼Œåå­—åé¢çš„æ•°å­—æ˜¯ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„ã€‚æ¥ä¸‹æ¥ï¼Œè¦åšçš„æ˜¯æŠŠè¿™å¯¹ veth pair åˆ†åˆ«æ”¾åˆ°å·²ç»ä¸¤ä¸ª namespace é‡Œé¢ï¼Œè¿™ä¸ªå¯ä»¥ä½¿ç”¨ ip link set DEV netns NAME æ¥å®ç°ï¼š</p>

<p>[root@localhost ~]# ip link set veth0 netns net0
[root@localhost ~]# ip link set veth1 netns net1
[root@localhost ~]# ip netns exec net0 ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
4: veth0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000
    link/ether 36:88:73:83:c9:64 brd ff:ff:ff:ff:ff:ff
[root@localhost ~]# ip netns exec net1 ip addr
1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
5: veth1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN qlen 1000
    link/ether fe:7e:75:4d:79:2e brd ff:ff:ff:ff:ff:ff
æœ€åï¼Œæˆ‘ä»¬ç»™è¿™å¯¹ veth pair é…ç½®ä¸Š ip åœ°å€ï¼Œå¹¶å¯ç”¨å®ƒä»¬ã€‚</LOOPBACK></LOOPBACK></p>

<p>[root@localhost ~]# ip netns exec net0 ip link set veth0 up
[root@localhost ~]# ip netns exec net0 ip addr add 10.0.1.1/24 dev veth0
[root@localhost ~]# ip netns exec net0 ip route
10.0.1.0/24 dev veth0  proto kernel  scope link  src 10.0.1.1</p>

<p>[root@localhost ~]# ip netns exec net1 ip link set veth1 up
[root@localhost ~]# ip netns exec net1 ip addr add 10.0.1.2/24 dev veth1
å¯ä»¥çœ‹åˆ°ï¼Œæœ€æ¯ä¸ª namespace ä¸­ï¼Œåœ¨é…ç½®ç© ip ä¹‹åï¼Œè¿˜è‡ªåŠ¨ç”Ÿæˆäº†å¯¹åº”çš„è·¯ç”±è¡¨ä¿¡æ¯ï¼Œç½‘ç»œ 10.0.1.0/24 æ•°æ®æŠ¥æ–‡éƒ½ä¼šé€šè¿‡ veth pair è¿›è¡Œä¼ è¾“ã€‚ä½¿ç”¨ ping å‘½ä»¤å¯ä»¥éªŒè¯å®ƒä»¬çš„è¿é€šæ€§ï¼š</p>

<p>[root@localhost ~]# ip netns exec net0 ping -c 3 10.0.1.2
PING 10.0.1.2 (10.0.1.2) 56(84) bytes of data.
64 bytes from 10.0.1.2: icmp_seq=1 ttl=64 time=0.039 ms
64 bytes from 10.0.1.2: icmp_seq=2 ttl=64 time=0.039 ms
64 bytes from 10.0.1.2: icmp_seq=3 ttl=64 time=0.139 ms</p>

<p>â€” 10.0.1.2 ping statistics â€”
3 packets transmitted, 3 received, 0% packet loss, time 2004ms
rtt min/avg/max/mdev = 0.039/0.072/0.139/0.047 ms</p>

<p>ä½¿ç”¨ bridge è¿æ¥ä¸åŒçš„ namespace
è™½ç„¶ veth pair å¯ä»¥å®ç°ä¸¤ä¸ª network namespace ä¹‹é—´çš„é€šä¿¡ï¼Œä½†æ˜¯å½“å¤šä¸ª namespace éœ€è¦é€šä¿¡çš„æ—¶å€™ï¼Œå°±æ— èƒ½ä¸ºåŠ›äº†ã€‚
è®²åˆ°å¤šä¸ªç½‘ç»œè®¾å¤‡é€šä¿¡ï¼Œæˆ‘ä»¬é¦–å…ˆæƒ³åˆ°çš„äº¤æ¢æœºå’Œè·¯ç”±å™¨ã€‚å› ä¸ºè¿™é‡Œè¦è€ƒè™‘çš„åªæ˜¯åŒä¸ªç½‘ç»œï¼Œæ‰€ä»¥åªç”¨åˆ°äº¤æ¢æœºçš„åŠŸèƒ½ã€‚linux å½“ç„¶ä¹Ÿæä¾›äº†è™šæ‹Ÿäº¤æ¢æœºçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨ ip å‘½ä»¤æ¥å®Œæˆæ‰€æœ‰çš„æ“ä½œã€‚</p>

<p>NOTEï¼šå’Œ bridge æœ‰å…³çš„æ“ä½œä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤ brctlï¼Œè¿™ä¸ªå‘½ä»¤æ¥è‡ª bridge-utils è¿™ä¸ªåŒ…ï¼Œè¯»è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„å‘è¡Œç‰ˆè¿›è¡Œå®‰è£…ï¼Œä½¿ç”¨æ–¹æ³•è¯·æŸ¥é˜… man é¡µé¢æˆ–è€…ç›¸å…³æ–‡æ¡£ã€‚</p>

<p>é¦–å…ˆæˆ‘ä»¬æ¥åˆ›å»ºéœ€è¦çš„ bridgeï¼Œç®€å•èµ·è§åå­—å°±å«åš br0ã€‚</p>

<p>[root@localhost ~]# ip link add br0 type bridge
[root@localhost ~]# ip link set dev br0 up
ä¸‹é¢åªæ¼”ç¤ºä¸€ä¸ª namespace çš„æ“ä½œï¼Œå…¶ä»– namespace è¦åšçš„äº‹æƒ…å’Œè¿™ä¸ªç±»ä¼¼ã€‚åˆ›å»º veth pairï¼š</p>

<p>[root@localhost ~]# ip link add type veth
æŠŠå…¶ä¸­ä¸€ä¸ª vethï¼ˆveth1ï¼‰ æ”¾åˆ° net0 é‡Œé¢ï¼Œè®¾ç½®å®ƒçš„ ip åœ°å€å¹¶å¯ç”¨å®ƒï¼š</p>

<p>[root@localhost ~]# ip link set dev veth1 netns net0
[root@localhost ~]# ip netns exec net0 ip link set dev veth1 name eth0
[root@localhost ~]# ip netns exec net0 ip addr add 10.0.1.1/24 dev eth0
[root@localhost ~]# ip netns exec net0 ip link set dev eth0 up
æœ€åï¼ŒæŠŠå¦ä¸€ä¸ª vethï¼ˆveth0ï¼‰è¿æ¥åˆ°åˆ›å»ºçš„ bridge ä¸Šï¼Œå¹¶å¯ç”¨å®ƒï¼š</p>

<p>[root@localhost ~]# ip link set dev veth0 master br0
[root@localhost ~]# ip link set dev veth0 up
å¯ä»¥é€šè¿‡ bridge å‘½ä»¤ï¼ˆä¹Ÿæ˜¯ iproute2 åŒ…è‡ªå¸¦çš„å‘½ä»¤ï¼‰æ¥æŸ¥çœ‹ bridge ç®¡ç†çš„ link ä¿¡æ¯ï¼š</p>

<p>[root@localhost ~]# bridge link
17: veth0 state UP : &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master br0 state forwarding priority 32 cost 2
æœ€åé€šè¿‡ ping å‘½ä»¤æ¥æµ‹è¯•ç½‘ç»œçš„è¿é€šæ€§ï¼š</p>

<p>[root@localhost ~]# ip netns exec net0 ping -c 3 10.0.1.3
PING 10.0.1.3 (10.0.1.3) 56(84) bytes of data.
64 bytes from 10.0.1.3: icmp_seq=1 ttl=64 time=0.251 ms
64 bytes from 10.0.1.3: icmp_seq=2 ttl=64 time=0.047 ms
64 bytes from 10.0.1.3: icmp_seq=3 ttl=64 time=0.046 ms</p>

<p>â€” 10.0.1.3 ping statistics â€”
3 packets transmitted, 3 received, 0% packet loss, time 2008ms
ä¸‹å›¾æ˜¯è¿™éƒ¨åˆ†ç½‘ç»œçš„æ‹“æ‰‘ç»“æ„ï¼Œå¦‚æœå¯¹ docker ç½‘ç»œç†Ÿæ‚‰çš„è¯ï¼Œå…¶å®è¿™å’Œ docker é»˜è®¤çš„ bridge ç½‘ç»œæ¨¡å‹éå¸¸ç›¸ä¼¼ã€‚å½“ç„¶è¦å®ç°æ¯ä¸ª namespace å¯¹å¤–ç½‘çš„è®¿é—®è¿˜éœ€è¦é¢å¤–çš„é…ç½®ï¼ˆè®¾ç½®é»˜è®¤ç½‘å…³ï¼Œå¼€å¯ ip_forwardï¼Œä¸ºç½‘ç»œæ·»åŠ  NAT è§„åˆ™ç­‰ï¼‰ã€‚</p>

<p>https://blog.kghost.info/2013/03/01/linux-network-emulator/
https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/</p>

<ol>
  <li>ip netns add xx åˆ›å»ºä¸€ä¸ª namespace
    <h1 id="ip-netns-add-net1">ip netns add net1</h1>
    <h1 id="ip-netns-ls">ip netns ls</h1>
    <p>net1</p>
  </li>
  <li>ip netns exec xx yy åœ¨æ–° namespace xx ä¸­æ‰§è¡Œ yy å‘½ä»¤
    <h1 id="ip-netns-exec-net1-ip-addr">ip netns exec net1 ip addr</h1>
    <p>1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</LOOPBACK></p>
    <h1 id="ip-netns-exec-net1-bash--åœ¨-net1-ä¸­æ‰“å¼€ä¸€ä¸ªshellç»ˆç«¯">ip netns exec net1 bash // åœ¨ net1 ä¸­æ‰“å¼€ä¸€ä¸ªshellç»ˆç«¯</h1>
    <h1 id="ip-addr--åœ¨net1ä¸­çš„shellç»ˆç«¯">ip addr // åœ¨net1ä¸­çš„shellç»ˆç«¯</h1>
    <p>1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</LOOPBACK></p>
    <h1 id="exit--é€€å‡ºnet1">exit // é€€å‡ºnet1</h1>
    <p>ä¸Šé¢ bash ä¸å¥½åŒºåˆ†æ˜¯å½“å‰æ˜¯åœ¨å“ªä¸ª shellï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢çš„æ–¹æ³•è§£å†³ï¼š</p>
    <h1 id="ip-netns-exec-net1-binbash-rcfile-echo-ps1namespace-net1-">ip netns exec net1 /bin/bash â€“rcfile &lt;(echo â€œPS1="namespace net1&gt; "â€)</h1>
    <p>namespace net1&gt; ping www.baidu.com
æ¯ä¸ª namespace åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå›ç¯æ¥å£ lo ï¼Œé»˜è®¤ä¸å¯ç”¨ï¼Œå¯ä»¥é€šè¿‡ ip link set lo up å¯ç”¨ã€‚</p>
  </li>
  <li>network namespace ä¹‹é—´çš„é€šä¿¡
æ–°åˆ›å»ºçš„ namespace é»˜è®¤ä¸èƒ½å’Œä¸»æœºç½‘ç»œï¼Œä»¥åŠå…¶ä»– namespace é€šä¿¡ã€‚</li>
</ol>

<p>å¯ä»¥ä½¿ç”¨ Linux æä¾›çš„ veth pair æ¥å®Œæˆé€šä¿¡ã€‚</p>

<p>3.1 ip link add type veth åˆ›å»º veth pair</p>
<h1 id="ip-link-add-type-veth">ip link add type veth</h1>
<h1 id="ip-link">ip link</h1>
<p>3: veth0@veth1: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 1a:53:39:5a:26:12 brd ff:ff:ff:ff:ff:ff
4: veth1@veth0: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000
    link/ether 46:df:46:1f:bf:d6 brd ff:ff:ff:ff:ff:ff
ä½¿ç”¨å‘½ä»¤ ip link add xxx type veth peer name yyy æŒ‡å®š veth pair çš„åå­—ã€‚</p>

<p>3.2 ip link set xx netns yy å°† veth xx åŠ å…¥åˆ° namespace yy ä¸­</p>
<h1 id="ip-link-set-veth0-netns-net0">ip link set veth0 netns net0</h1>
<h1 id="ip-link-set-veth1-netns-net1">ip link set veth1 netns net1</h1>
<p>#</p>
<h1 id="ip-netns-exec-net0-ip-addr">ip netns exec net0 ip addr</h1>
<p>1: lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
10: veth0@if11: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group default qlen 1000
    link/ether 1a:53:39:5a:26:12 brd ff:ff:ff:ff:ff:ff link-netnsid 1
3.3 ç»™ veth pair é…ä¸Š ip åœ°å€</LOOPBACK></p>
<h1 id="ip-netns-exec-net0-ip-link-set-veth0-up">ip netns exec net0 ip link set veth0 up</h1>
<h1 id="ip-netns-exec-net0-ip-addr-1">ip netns exec net0 ip addr</h1>
<p>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
10: veth0@if11: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state LOWERLAYERDOWN group default qlen 1000
    link/ether 1a:53:39:5a:26:12 brd ff:ff:ff:ff:ff:ff link-netnsid 1</p>
<h1 id="ip-netns-exec-net0-ip-addr-add-1011124-dev-veth0">ip netns exec net0 ip addr add 10.1.1.1/24 dev veth0</h1>
<h1 id="ip-netns-exec-net0-ip-route">ip netns exec net0 ip route</h1>
<p>10.1.1.0/24 dev veth0  proto kernel  scope link  src 10.1.1.1 linkdown
#</p>
<h1 id="ip-netns-exec-net1-ip-link-set-veth1-up">ip netns exec net1 ip link set veth1 up</h1>
<h1 id="ip-netns-exec-net1-ip-addr-add-1011224-dev-veth1">ip netns exec net1 ip addr add 10.1.1.2/24 dev veth1</h1>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨é…å®Œ ip ä¹‹åï¼Œè¿˜è‡ªåŠ¨ç”Ÿæˆäº†å¯¹åº”çš„è·¯ç”±è¡¨ä¿¡æ¯ã€‚</p>

<p>3.4. ping æµ‹è¯•ä¸¤ä¸ª namespace çš„è¿é€šæ€§</p>
<h1 id="ip-netns-exec-net0-ping-10112">ip netns exec net0 ping 10.1.1.2</h1>
<p>PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.
64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.069 ms
64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.054 ms
64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.053 ms
64 bytes from 10.1.1.2: icmp_seq=4 ttl=64 time=0.053 ms
Done!</p>

<ol>
  <li>å¤šä¸ªä¸åŒ namespace ä¹‹é—´çš„é€šä¿¡
2 ä¸ª namespace ä¹‹é—´é€šä¿¡å¯ä»¥å€ŸåŠ© veth pair ï¼Œå¤šä¸ª namespace ä¹‹é—´çš„é€šä¿¡åˆ™å¯ä»¥ä½¿ç”¨ bridge æ¥è½¬æ¥ï¼Œä¸ç„¶æ¯ä¸¤ä¸ª namespace éƒ½å»é… veth pair å°†ä¼šæ˜¯ä¸€ä»¶éº»çƒ¦çš„äº‹ã€‚ä¸‹é¢å°±çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ bridge æ¥è½¬æ¥ã€‚</li>
</ol>

<p>4.1 ä½¿ç”¨ ip link å’Œ brctl åˆ›å»º bridge
é€šå¸¸ Linux ä¸­å’Œ bridge æœ‰å…³çš„æ“ä½œæ˜¯ä½¿ç”¨å‘½ä»¤ brctl (yum install -y bridge-utils ) ã€‚ä½†ä¸ºäº†å‰åç…§åº”ï¼Œè¿™é‡Œéƒ½ç”¨ ip ç›¸å…³çš„å‘½ä»¤æ¥æ“ä½œã€‚
// å»ºç«‹ä¸€ä¸ª bridge</p>
<h1 id="ip-link-add-br0-type-bridge">ip link add br0 type bridge</h1>
<h1 id="ip-link-set-dev-br0-up">ip link set dev br0 up</h1>
<p>9: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UNKNOWN group default qlen 1000
    link/ether 42:55:ed:eb:a0:07 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::4055:edff:feeb:a007/64 scope link
       valid_lft forever preferred_lft forever
4.2 åˆ›å»º veth pair
//ï¼ˆ1ï¼‰åˆ›å»º 3 ä¸ª veth pair</p>
<h1 id="ip-link-add-type-veth-1">ip link add type veth</h1>
<h1 id="ip-link-add-type-veth-2">ip link add type veth</h1>
<h1 id="ip-link-add-type-veth-3">ip link add type veth</h1>
<p>4.3 å°† veth pair çš„ä¸€å¤´æŒ‚åˆ° namespace ä¸­ï¼Œä¸€å¤´æŒ‚åˆ° bridge ä¸Šï¼Œå¹¶è®¾ IP åœ°å€
// ï¼ˆ1ï¼‰é…ç½®ç¬¬ 1 ä¸ª net0</p>
<h1 id="ip-link-set-dev-veth1-netns-net0">ip link set dev veth1 netns net0</h1>
<h1 id="ip-netns-exec-net0-ip-link-set-dev-veth1-name-eth0">ip netns exec net0 ip link set dev veth1 name eth0</h1>
<h1 id="ip-netns-exec-net0-ip-addr-add-1001124-dev-eth0">ip netns exec net0 ip addr add 10.0.1.1/24 dev eth0</h1>
<h1 id="ip-netns-exec-net0-ip-link-set-dev-eth0-up">ip netns exec net0 ip link set dev eth0 up</h1>
<p>#</p>
<h1 id="ip-link-set-dev-veth0-master-br0">ip link set dev veth0 master br0</h1>
<h1 id="ip-link-set-dev-veth0-up">ip link set dev veth0 up</h1>

<p>// ï¼ˆ2ï¼‰é…ç½®ç¬¬ 2 ä¸ª net1</p>
<h1 id="ip-link-set-dev-veth3-netns-net1">ip link set dev veth3 netns net1</h1>
<h1 id="ip-netns-exec-net1-ip-link-set-dev-veth3-name-eth0">ip netns exec net1 ip link set dev veth3 name eth0</h1>
<h1 id="ip-netns-exec-net1-ip-addr-add-1001224-dev-eth0">ip netns exec net1 ip addr add 10.0.1.2/24 dev eth0</h1>
<h1 id="ip-netns-exec-net1-ip-link-set-dev-eth0-up">ip netns exec net1 ip link set dev eth0 up</h1>
<p>#</p>
<h1 id="ip-link-set-dev-veth2-master-br0">ip link set dev veth2 master br0</h1>
<h1 id="ip-link-set-dev-veth2-up">ip link set dev veth2 up</h1>

<p>// ï¼ˆ3ï¼‰é…ç½®ç¬¬ 3 ä¸ª net2</p>
<h1 id="ip-link-set-dev-veth5-netns-net2">ip link set dev veth5 netns net2</h1>
<h1 id="ip-netns-exec-net2-ip-link-set-dev-veth5-name-eth0">ip netns exec net2 ip link set dev veth5 name eth0</h1>
<h1 id="ip-netns-exec-net2-ip-addr-add-1001324-dev-eth0">ip netns exec net2 ip addr add 10.0.1.3/24 dev eth0</h1>
<h1 id="ip-netns-exec-net2-ip-link-set-dev-eth0-up">ip netns exec net2 ip link set dev eth0 up</h1>
<p>#</p>
<h1 id="ip-link-set-dev-veth4-master-br0">ip link set dev veth4 master br0</h1>
<h1 id="ip-link-set-dev-veth4-up">ip link set dev veth4 up</h1>
<p>è¿™æ ·ä¹‹åï¼Œç«Ÿç„¶é€šä¸äº†ï¼Œç»æŸ¥é˜… å‚è§ ï¼Œæ˜¯å› ä¸º</p>

<p>åŸå› æ˜¯å› ä¸ºç³»ç»Ÿä¸ºbridgeå¼€å¯äº†iptablesåŠŸèƒ½ï¼Œå¯¼è‡´æ‰€æœ‰ç»è¿‡br0çš„æ•°æ®åŒ…éƒ½è¦å—iptablesé‡Œé¢è§„åˆ™çš„é™åˆ¶ï¼Œè€Œdockerä¸ºäº†å®‰å…¨æ€§ï¼Œå°†iptablesé‡Œé¢filterè¡¨çš„FORWARDé“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®æˆäº†dropï¼Œäºæ˜¯æ‰€æœ‰ä¸ç¬¦åˆdockerè§„åˆ™çš„æ•°æ®åŒ…éƒ½ä¸ä¼šè¢«forwardï¼Œå¯¼è‡´ä½ è¿™ç§æƒ…å†µpingä¸é€šã€‚</p>

<p>è§£å†³åŠæ³•æœ‰ä¸¤ä¸ªï¼ŒäºŒé€‰ä¸€ï¼š</p>

<p>å…³é—­ç³»ç»Ÿbridgeçš„iptablesåŠŸèƒ½ï¼Œè¿™æ ·æ•°æ®åŒ…è½¬å‘å°±ä¸å—iptableså½±å“äº†ï¼šecho 0 &gt; /proc/sys/net/bridge/bridge-nf-call-iptables
ä¸ºbr0æ·»åŠ ä¸€æ¡iptablesè§„åˆ™ï¼Œè®©ç»è¿‡br0çš„åŒ…èƒ½è¢«forwardï¼šiptables -A FORWARD -i br0 -j ACCEPT
ç¬¬ä¸€ç§æ–¹æ³•ä¸ç¡®å®šä¼šä¸ä¼šå½±å“dockerï¼Œå»ºè®®ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚</p>

<p>æˆ‘é‡‡ç”¨ä»¥ä¸‹æ–¹æ³•è§£å†³ï¼š
iptables -A FORWARD -i br0 -j ACCEPT
ç»“æœï¼š</p>
<h1 id="ip-netns-exec-net0-ping--c-2-10012">ip netns exec net0 ping -c 2 10.0.1.2</h1>
<p>PING 10.0.1.2 (10.0.1.2) 56(84) bytes of data.
64 bytes from 10.0.1.2: icmp_seq=1 ttl=64 time=0.071 ms
64 bytes from 10.0.1.2: icmp_seq=2 ttl=64 time=0.072 ms</p>

<p>â€” 10.0.1.2 ping statistics â€”
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.071/0.071/0.072/0.008 ms</p>

<h1 id="ip-netns-exec-net0-ping--c-2-10013">ip netns exec net0 ping -c 2 10.0.1.3</h1>
<p>PING 10.0.1.3 (10.0.1.3) 56(84) bytes of data.
64 bytes from 10.0.1.3: icmp_seq=1 ttl=64 time=0.071 ms
64 bytes from 10.0.1.3: icmp_seq=2 ttl=64 time=0.087 ms</p>

<p>â€” 10.0.1.3 ping statistics â€”
2 packets transmitted, 2 received, 0% packet loss, time 1000ms
rtt min/avg/max/mdev = 0.071/0.079/0.087/0.008 ms
Done!</p>

<ol>
  <li>Bridge ä¹‹é—´çš„åŒä½æœºé€šä¿¡</li>
</ol>

<p>ä¸ºbridgeå¼€å¯äº†iptablesåŠŸèƒ½ï¼Œå¯¼è‡´æ‰€æœ‰ç»è¿‡br0çš„æ•°æ®åŒ…éƒ½è¦å—iptablesé‡Œé¢è§„åˆ™çš„é™åˆ¶ï¼Œè€Œdockerä¸ºäº†å®‰å…¨æ€§ï¼Œå°†iptablesé‡Œé¢filterè¡¨çš„FORWARDé“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®æˆäº†dropï¼Œäºæ˜¯æ‰€æœ‰ä¸ç¬¦åˆdockerè§„åˆ™çš„æ•°æ®åŒ…éƒ½ä¸ä¼šè¢«forwardï¼Œå¯¼è‡´ä½ è¿™ç§æƒ…å†µpingä¸é€šã€‚</p>

<p>è§£å†³åŠæ³•æœ‰ä¸¤ä¸ªï¼ŒäºŒé€‰ä¸€ï¼š</p>

<p>å…³é—­ç³»ç»Ÿbridgeçš„iptablesåŠŸèƒ½ï¼Œè¿™æ ·æ•°æ®åŒ…è½¬å‘å°±ä¸å—iptableså½±å“äº†ï¼šecho 0 &gt; /proc/sys/net/bridge/bridge-nf-call-iptables</p>

<p>ä¸ºbr0æ·»åŠ ä¸€æ¡iptablesè§„åˆ™ï¼Œè®©ç»è¿‡br0çš„åŒ…èƒ½è¢«forwardï¼šiptables -A FORWARD -i br0 -j ACCEPT</p>

<p>ç¬¬ä¸€ç§æ–¹æ³•ä¸ç¡®å®šä¼šä¸ä¼šå½±å“dockerï¼Œå»ºè®®ç”¨ç¬¬äºŒç§æ–¹æ³•ã€‚</p>

<p>åœ¨ä¸“ä¸šçš„ç½‘ç»œä¸–ç•Œä¸­ï¼Œç»å¸¸ä½¿ç”¨åˆ°Virtual Routing and Forwardingï¼ˆVRFï¼‰ï¼Œæ¯”å¦‚Ciscoï¼ŒAlcatel-Lucent, Juniper ç­‰ã€‚å¯¹äºL2 switchï¼Œè‡ªä»ä¸Šä¸–çºª90å¹´ä»£å°±å¼€å§‹ä½¿ç”¨VLANï¼Œä¸€ä¸ªç‰©ç†äº¤æ¢æœºä¸Šå¯ä»¥ä½¿ç”¨å¤šä¸ªå¹¿æ’­åŸŸï¼Œå¦‚ä»Šå¤§å¤šæ•°äº¤æ¢æœºéƒ½æ”¯æŒ4K vlanã€‚</p>

<p>è¿™ä¸ªæ¦‚å¿µè¢«å¼•å…¥åˆ°L3ï¼Œå¦‚ä»Šå¾ˆå¤šç½‘ç»œè®¾å¤‡æ”¯æŒVRFã€‚è¿™æ„å‘³ç€ï¼Œå•ä¸ªç‰©ç†è®¾å¤‡ä¸Šå¯è¿è¡Œå¤šä¸ªè™šæ‹Ÿè·¯ç”±ï¼ˆL3 è½¬å‘å®ä¾‹ï¼‰ã€‚</p>

<p>åœ¨linuxä¸­ï¼ŒVRFè¢«å«åšâ€œnetwork namespaceâ€ï¼Œå½“ç„¶äº†linuxä¸­è¿˜åŒ…æ‹¬å…¶ä»–namespaceï¼Œä¸è¿‡æœ¬æ–‡ä¸è®¨è®ºã€‚</p>

<p>æ¯ä¸ªnetwork namespaceæ‹¥æœ‰å…¶å¯¹åº”çš„è·¯ç”±è¡¨ï¼ˆrouting tableï¼‰&amp; å…¶å¯¹åº”çš„iptablesï¼Œå¹¶ä¸”è¿è¡Œç¨‹åºè¿è¡Œå…¶ä¸­ã€‚ ä¸ºä»€ä¹ˆæœ‰äººä½¿ç”¨å®ƒï¼Ÿæ¯”å¦‚ä¸€ä¸ªè¿è¡Œåœ¨linuxä¸Šçš„ Firewallï¼Œå°†firewallçš„æ‰€æœ‰æœåŠ¡ç«¯å£åˆ†é…ç»™ä¸€ä¸ªnetwork namespaceï¼Œè¿™æ ·ï¼Œé»˜è®¤çš„network namespace å’Œ Firewall network namespaceå°±è¿è¡Œç€ä¸åŒçš„è·¯ç”±è¡¨ã€‚åƒSSHè¿™æ ·çš„applicationè¿è¡Œåœ¨é»˜è®¤çš„network namespaceï¼Œä½†æ˜¯ä¸åœ¨Firewall network namespaceã€‚</p>

<p>ä¸‹é¢å±•ç¤ºäº†å…¶åŸºæœ¬ç”¨æ³•ã€‚</p>

<p>Basic network namespace commands
åŸºæœ¬å‘½ä»¤ä¸ºâ€œipâ€ï¼Œæœ‰äº›ç”¨æˆ·ä½¿ç”¨å®ƒæ¥ä»£æ›¿åºŸå¼ƒçš„ ifconfigï¼Œrouteï¼Œnetstatâ€¦ å¿…é¡»ä¸ºrootç”¨æˆ·æ¥ä½¿ç”¨å®ƒï¼Œè¿™æ ·æ‰èƒ½æ›´æ”¹network stackçš„é…ç½®ã€‚ä¸‹é¢æ˜¯ipå‘½ä»¤å’Œå…¶ä»–å‘½ä»¤çš„æ˜ å°„ï¼š</p>

<p>ifconfig                                            â€“&gt; ip addr or just ip a
ifconfig <interface> up/down                        --&gt; ip link set dev <interface> up/down
ifconfig <interface> <ip> netmask <netmask>         --&gt; ip addr add <ip>/<masklen> dev <interface>
netstat -rn                                         --&gt; ip route or just ip r
route add -net <net> netmask <netmask> gw <gateway> --&gt; ip r add <net>/<netmasklen> via <gateway>
Check your Linux for namespace support
ä½¿ç”¨å‰ï¼Œå…ˆæ£€æŸ¥ç³»ç»Ÿæ˜¯å¦æ”¯æŒã€‚</gateway></netmasklen></net></gateway></netmask></net></interface></masklen></ip></netmask></ip></interface></interface></interface></p>

<p>Creating a network namespace</p>
<h1 id="add-a-new-namespace">add a new namespace</h1>
<p>ip netnas add <network namespace="" name="">
#Example:
ip netns add nstest
Listing all existing network namespaces in the system</network></p>
<h1 id="list-all-namespaces">list all namespaces</h1>
<p>ip netns list
#will show the namespace from above</p>

<p>nstest
Deleting a network namespace
ip netns delete <network namespace="" name="">
Executing a command in a network namespace
ä¸‹é¢å±•ç¤ºäº†ä½¿ç¨‹åºè¿è¡Œåœ¨network namespaceä¸­çš„â€œé»‘é­”æ³•â€ã€‚</network></p>

<h1 id="execute-a-command-in-a-namespace">execute a command in a namespace</h1>
<p>ip netns exec <network namespace="" name=""> <command />
#Example using the namespace from above:
ip netns exec nstest ip addr
å±•ç¤ºäº†åœ¨æ­¤network namespaceä¸­çš„æ‰€æœ‰çš„ip interface</network></p>

<p>lo: <LOOPBACK> mtu 65536 qdisc noop state DOWN mode DEFAULT 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
ä¸€ä¸ªè„æŠ€å·§æ˜¯åœ¨network namespaceä¸­è¿è¡Œshellï¼š</LOOPBACK></p>

<p>ip netns exec <network namespace="" name=""> bash
ç°åœ¨ï¼Œä½ å·²ç»â€œtrappedâ€å…¥namespaceä¸­äº†ï¼Œexité€€å‡ºã€‚</network></p>

<p>Exploring the network namespace
å½“æˆ‘ä»¬å·²ç»åˆ›å»ºäº†network namespaceï¼Œç¬¬ä¸€ä¸ªtaskæ˜¯bring upå…¶ä¸­çš„lo interfaceã€‚åº”è¯¥æ³¨æ„åˆ°çš„æ˜¯ï¼Œåœ¨åˆ›å»ºäº†network namespaceåï¼Œlo interfaceçš„çŠ¶æ€æ˜¯downã€‚å¦‚æœå¿½ç•¥äº†è¿™ä¸ªï¼Œå¯èƒ½ä¼šå‘ç”Ÿä¸€äº›å¥‡æ€ªçš„äº‹ã€‚</p>

<h1 id="set-the-link-of-lo-in-the-namespace-to-up">set the link of lo in the namespace to up</h1>
<p>ip netns exec nstest ip link set dev lo up</p>
<h1 id="list-all-interfaces-and-the-state-in-the-namespace">list all interfaces and the state in the namespace</h1>
<p>ip netns exec nstest ip link
ç°åœ¨lo interfaceçŠ¶æ€ä¸ºupï¼Œç°åœ¨ï¼Œæ˜¯æ—¶å€™å°†network namespaceé“¾æ¥åˆ°å¤–éƒ¨ç©ºé—´ã€‚</p>

<p>Adding interfaces to a network namespace
å°†ä¸€ä¸ªç‰©ç†interfaceåˆ†é…ç»™network namespaceæ˜¯ä¸å¯èƒ½çš„ï¼Œè€Œæ˜¯ä½¿ç”¨ virtual interfaceæ¥å®ç°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªvirtual interfaceï¼ŒåŒæ ·ä½¿ç”¨ ip commandï¼š</p>

<p>ip link add veth-a type veth peer name veth-b
ä¸Šè¿°å‘½ä»¤åˆ›å»ºäº†ä¸¤ä¸ªvirtual interfaceï¼Œåˆ†åˆ«ä¸ºveth-a &amp; veth-b,ä»–ä»¬ä¹‹é—´é€šè¿‡ä¸€ä¸ªvirtual cableé“¾æ¥ã€‚ip linkå‘½ä»¤æ˜¾ç¤ºäº†åœ¨é»˜è®¤namespaceä¸‹è¿™ä¸¤ä¸ªinterfaceçš„ä¿¡æ¯ã€‚</p>

<p>ip link
veth-b: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
 link/ether 72:01:ad:c5:67:84 brd ff:ff:ff:ff:ff:ff
veth-a: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
 link/ether 8e:8b:bd:b1:88:e5 brd ff:ff:ff:ff:ff:ff
ä¸‹é¢æˆ‘ä»¬å°†å…¶ä¸­çš„ä¸€ä¸ªinterfaceæ·»åŠ å…¥ä¹‹å‰æˆ‘ä»¬åˆ›å»ºçš„namespace nstestï¼š</p>

<p>ip link set veth-b netns nstest
ç°åœ¨veth-bä¸åœ¨é»˜è®¤çš„namespaceä¸‹äº†ï¼Œè€Œå‡ºç°åœ¨äº†nstest ä¸­ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤éªŒè¯ï¼š</p>

<h1 id="list-all-interfaces-in-the-namespace-nstest">list all interfaces in the namespace nstest</h1>
<p>ip netns exec nstest ip link</p>

<p>lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT 
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
veth-b: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
 link/ether 72:01:ad:c5:67:84 brd ff:ff:ff:ff:ff:ff
ç°åœ¨ï¼Œåœ¨network namespace nstestä¸­ï¼Œå°±æ‹¥æœ‰äº†ä¸¤ä¸ªinterfaceã€‚</p>

<p>Assign ip addresses to the veth interfaces
ç°åœ¨æ˜¯æ—¶å€™ä¸ºè¿™ä¸ªveth interfaceåˆ†é…ipå¹¶ä¸”ä½¿ä»–çš„çŠ¶æ€ä¸ºupã€‚</p>

<h1 id="default-namespace">default namespace</h1>
<p>ip addr add 10.0.0.1/24 dev veth-a
ip link set dev veth-a up
#</p>
<h1 id="namespace-nstest">namespace nstest</h1>
<p>ip netns exec nstest ip addr add 10.0.0.2/24 dev veth-b
ip netns exec nstest ip link set dev veth-b up
å¯é€šè¿‡â€œip linkâ€æŸ¥çœ‹interfaceçŠ¶æ€æ˜¯å¦ä¸ºupï¼Œä½¿ç”¨â€œip addrâ€æŸ¥çœ‹interfaceçš„ip åœ°å€ï¼Œä½¿ç”¨â€œip routeâ€æŸ¥çœ‹å…¶è·¯ç”±ã€‚</p>

<p>ç°åœ¨å¯ä»¥åœ¨default namespaceä¸­ï¼Œé€šè¿‡veth-aæ¥pingé€š ä½äº nstestä¸­çš„veth-bã€‚</p>

<p>ping 10.0.0.2
PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.
64 bytes from 10.0.0.2: icmp_req=1 ttl=64 time=0.054 ms
64 bytes from 10.0.0.2: icmp_req=2 ttl=64 time=0.034 ms
64 bytes from 10.0.0.2: icmp_req=3 ttl=64 time=0.039 ms
64 bytes from 10.0.0.2: icmp_req=4 ttl=64 time=0.036 ms
ä»¥åŠåœ¨nstest network namespaceä¸­ï¼Œé€šè¿‡veth-bæ¥pingé€š veth-aï¼š</p>

<p>ip netns exec nstest ping 10.0.0.1
PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.
64 bytes from 10.0.0.1: icmp_req=1 ttl=64 time=0.064 ms
64 bytes from 10.0.0.1: icmp_req=2 ttl=64 time=0.036 ms
64 bytes from 10.0.0.1: icmp_req=3 ttl=64 time=0.039 ms
Demo
ä¸‹é¢ä¸€èµ·æ¥å®ç°ä¸€ä¸ªdemoï¼Œæœ€ç»ˆå®ç°å¦‚ä¸‹çš„caseï¼š
å›¾ç‰‡æè¿°</p>

<p>é¦–å…ˆï¼Œå…ˆå»ºç«‹å¯¹åº”çš„namespaceï¼š</p>

<p>$ sudo ip netns add server
$ sudo ip netns add gateway
$ sudo ip netns add client
$ ip netns list
client
gateway
server
ç„¶åï¼Œå¯ç”¨gateway namespaceä¸­çš„ip forwardåŠŸèƒ½ï¼Œæ³¨æ„ï¼Œæ“ä½œå…¨æ˜¯åœ¨rootæƒé™ä¸‹æ‰§è¡Œï¼š</p>

<p>$ ip netns exec gateway sysctl net.ipv4.ip_forward=1
net.ipv4.ip_forward = 1
ä¸‹é¢æˆ‘ä»¬æ¥åˆ›å»ºä¸¤å¯¹vethï¼Œç”¨æ¥è¿æ¥ä¸åŒçš„namespaceï¼š</p>

<p>$ ip link add svr-veth type veth peer name svrgw-veth
$ ip link add cli-veth type veth peer name cligw-veth
$ ip link show | grep veth
3: svrgw-veth:  mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
4: svr-veth:  mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
5: cligw-veth:  mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
6: cli-veth:  mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
å°†vethå¯¹çš„ä¸¤ç«¯åŠ å…¥å¯¹åº”çš„namespaceä¸­ï¼Œè¿™æ ·åœ¨é»˜è®¤çš„default namespaceä¸­å°±çœ‹ä¸åˆ°ä»–ä»¬äº†ï¼š</p>

<p>$ ip link set svr-veth netns server
$ ip link set svrgw-veth netns gateway
$ ip link set cligw-veth netns gateway
$ ip link set cli-veth netns client
$ ip link show | grep veth
åœ¨æŒ‡å®šçš„namespaceä¸Šå¯ä»¥çœ‹åˆ°å¯¹åº”çš„interfaceï¼š</p>

<p>$ ip netns exec server ip link show | grep veth
4: svr-veth:  mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000
ä¸ºå„ä¸ªvethåˆ†é…ipï¼š</p>

<p>$ ip netns exec server ifconfig svr-veth 192.168.100.1
$ ip netns exec gateway ifconfig svrgw-veth 192.168.100.254
$ ip netns exec gateway ifconfig cligw-veth 10.0.100.254
$ ip netns exec client ifconfig cli-veth 10.0.100.1
åœ¨å„ä¸ªvethå¯¹ä¸­ï¼Œé€šè¿‡pingæ¥æ£€æŸ¥è¿é€šæ€§ï¼š</p>

<p>$ ip netns exec gateway ping 192.168.100.1 -I 192.168.100.254
PING 192.168.100.1 (192.168.100.1) from 192.168.100.254 : 56(84) bytes of data.
64 bytes from 192.168.100.1: icmp_req=1 ttl=64 time=0.044 ms
64 bytes from 192.168.100.1: icmp_req=2 ttl=64 time=0.036 ms
64 bytes from 192.168.100.1: icmp_req=3 ttl=64 time=0.040 ms
^C
â€” 192.168.100.1 ping statistics â€”
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.036/0.040/0.044/0.003 ms</p>

<p>$ ip netns exec gateway ping 10.0.100.1 -I 10.0.100.254
PING 10.0.100.1 (10.0.100.1) from 10.0.100.254 : 56(84) bytes of data.
64 bytes from 10.0.100.1: icmp_req=1 ttl=64 time=0.107 ms
64 bytes from 10.0.100.1: icmp_req=2 ttl=64 time=0.037 ms
64 bytes from 10.0.100.1: icmp_req=3 ttl=64 time=0.037 ms
^C
â€” 10.0.100.1 ping statistics â€”
3 packets transmitted, 3 received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev = 0.037/0.060/0.107/0.033 ms
æ¥ä¸‹æ¥è®¾å®šè·¯ç”±ï¼Œå°†å„namespaceä¸­çš„é»˜è®¤è·¯ç”±æŒ‡å‘å¯¹åº”çš„veth ipï¼š</p>

<p>$ sudo ip netns exec client route add default gw 10.0.100.254
$ sudo ip netns exec client netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         10.0.100.254    0.0.0.0         UG        0 0          0 cli-veth
10.0.0.0        0.0.0.0         255.0.0.0       U         0 0          0 cli-veth
$ ip netns exec server route add default gw 192.168.100.254
$ ip netns exec server netstat -rn
Kernel IP routing table
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.100.254 0.0.0.0         UG        0 0          0 svr-veth
192.168.100.0   0.0.0.0         255.255.255.0   U         0 0          0 svr-veth
æœ€åæˆ‘ä»¬å°è¯•ä»client namespace åˆ° server namespaceçš„ç½‘ç»œè¿é€šæ€§ï¼Œé€šè¿‡pingå‘½ä»¤æ¥æµ‹è¯•ï¼š</p>

<p>$ ip netns exec client ping 192.168.100.1 -I 10.0.100.1
PING 192.168.100.1 (192.168.100.1) from 10.0.100.1 : 56(84) bytes of data.
64 bytes from 192.168.100.1: icmp_req=1 ttl=63 time=0.106 ms
64 bytes from 192.168.100.1: icmp_req=2 ttl=63 time=0.076 ms
64 bytes from 192.168.100.1: icmp_req=3 ttl=63 time=0.050 ms
^C
â€” 192.168.100.1 ping statistics â€”
3 packets transmitted, 3 received, 0% packet loss, time 1999ms
rtt min/avg/max/mdev = 0.050/0.077/0.106/0.024 ms</p>
:ET