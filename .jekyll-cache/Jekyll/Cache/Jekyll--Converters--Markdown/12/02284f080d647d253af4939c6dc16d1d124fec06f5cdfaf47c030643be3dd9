I"õJ<p>Dockerè·¨ä¸»æœºå®¹å™¨é—´ç½‘ç»œé€šä¿¡å®ç°çš„å·¥å…·æœ‰Pipeworkã€Flannelã€Weaveã€Open vSwitchï¼ˆè™šæ‹Ÿäº¤æ¢æœºï¼‰ã€Calico
<!-- more -->
Weaveçš„æ€è·¯
åœ¨æ¯ä¸ªå®¿ä¸»æœºä¸Šå¸ƒç½®ä¸€ä¸ªç‰¹æ®Šçš„routeçš„å®¹å™¨ï¼Œä¸åŒå®¿ä¸»æœºçš„routeå®¹å™¨è¿æ¥èµ·æ¥ã€‚ routeæ‹¦æˆªæ‰€æœ‰æ™®é€šå®¹å™¨çš„ipè¯·æ±‚ï¼Œå¹¶é€šè¿‡udpåŒ…å‘é€åˆ°å…¶ä»–å®¿ä¸»æœºä¸Šçš„æ™®é€šå®¹å™¨ã€‚è¿™æ ·åœ¨è·¨æœºçš„å¤šä¸ªå®¹å™¨ç«¯çœ‹åˆ°çš„å°±æ˜¯åŒä¸€ä¸ªæ‰å¹³ç½‘ç»œã€‚ weaveè§£å†³äº†ç½‘ç»œé—®é¢˜ï¼Œä¸è¿‡éƒ¨ç½²ä¾ç„¶æ˜¯å•æœºçš„ã€‚</p>

<p>Flannelçš„æ€è·¯
Flannelæ˜¯CoreOSå›¢é˜Ÿé’ˆå¯¹Kubernetesè®¾è®¡çš„ä¸€ä¸ªç½‘ç»œè§„åˆ’æœåŠ¡ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒçš„åŠŸèƒ½æ˜¯è®©é›†ç¾¤ä¸­çš„ä¸åŒèŠ‚ç‚¹ä¸»æœºåˆ›å»ºçš„Dockerå®¹å™¨éƒ½å…·æœ‰å…¨é›†ç¾¤å”¯ä¸€çš„è™šæ‹ŸIPåœ°å€ã€‚ä½†åœ¨é»˜è®¤çš„Dockeré…ç½®ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„DockeræœåŠ¡ä¼šåˆ†åˆ«è´Ÿè´£æ‰€åœ¨èŠ‚ç‚¹å®¹å™¨çš„IPåˆ†é…ã€‚è¿™æ ·å¯¼è‡´çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œä¸åŒèŠ‚ç‚¹ä¸Šå®¹å™¨å¯èƒ½è·å¾—ç›¸åŒçš„å†…å¤–IPåœ°å€ã€‚å¹¶ä½¿è¿™äº›å®¹å™¨ä¹‹é—´èƒ½å¤Ÿä¹‹é—´é€šè¿‡IPåœ°å€ç›¸äº’æ‰¾åˆ°ï¼Œä¹Ÿå°±æ˜¯ç›¸äº’pingé€šã€‚Flannelè®¾è®¡ç›®çš„å°±æ˜¯ä¸ºé›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹é‡æ–°è§„åˆ’IPåœ°å€çš„ä½¿ç”¨è§„åˆ™ï¼Œä»è€Œä½¿å¾—ä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨èƒ½å¤Ÿè·å¾—â€åŒå±ä¸€ä¸ªå†…ç½‘â€ä¸”â€ä¸é‡å¤çš„â€IPåœ°å€ï¼Œå¹¶è®©å±äºä¸åŒèŠ‚ç‚¹ä¸Šçš„å®¹å™¨èƒ½å¤Ÿç›´æ¥é€šè¿‡å†…ç½‘IPé€šä¿¡ã€‚</p>

<p>Flannelå®è´¨ä¸Šæ˜¯ä¸€ç§â€è¦†ç›–ç½‘ç»œ(overlay network)â€ï¼Œå³è¡¨ç¤ºè¿è¡Œåœ¨ä¸€ä¸ªç½‘ä¸Šçš„ç½‘ï¼ˆåº”ç”¨å±‚ç½‘ç»œï¼‰ï¼Œå¹¶ä¸ä¾é ipåœ°å€æ¥ä¼ é€’æ¶ˆæ¯ï¼Œè€Œæ˜¯é‡‡ç”¨ä¸€ç§æ˜ å°„æœºåˆ¶ï¼ŒæŠŠipåœ°å€å’Œidentifiersåšæ˜ å°„æ¥èµ„æºå®šä½ã€‚ä¹Ÿå°±æ˜¯å°†TCPæ•°æ®åŒ…è£…åœ¨å¦ä¸€ç§ç½‘ç»œåŒ…é‡Œé¢è¿›è¡Œè·¯ç”±è½¬å‘å’Œé€šä¿¡ï¼Œç›®å‰å·²ç»æ”¯æŒUDPã€VxLANã€AWS VPCå’ŒGCEè·¯ç”±ç­‰æ•°æ®è½¬å‘æ–¹å¼ã€‚</p>

<p>Flannel ä½¿ç”¨etcdå­˜å‚¨é…ç½®æ•°æ®å’Œå­ç½‘åˆ†é…ä¿¡æ¯ã€‚flannel å¯åŠ¨ä¹‹åï¼Œåå°è¿›ç¨‹é¦–å…ˆæ£€ç´¢é…ç½®å’Œæ­£åœ¨ä½¿ç”¨çš„å­ç½‘åˆ—è¡¨ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„å­ç½‘ï¼Œç„¶åå°è¯•å»æ³¨å†Œå®ƒã€‚etcdä¹Ÿå­˜å‚¨è¿™ä¸ªæ¯ä¸ªä¸»æœºå¯¹åº”çš„ipã€‚flannel ä½¿ç”¨etcdçš„watchæœºåˆ¶ç›‘è§†/coreos.com/network/subnetsä¸‹é¢æ‰€æœ‰å…ƒç´ çš„å˜åŒ–ä¿¡æ¯ï¼Œå¹¶ä¸”æ ¹æ®å®ƒæ¥ç»´æŠ¤ä¸€ä¸ªè·¯ç”±è¡¨ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œflannelä¼˜åŒ–äº†Universal TAP/TUNè®¾å¤‡ï¼Œå¯¹TUNå’ŒUDPä¹‹é—´çš„ipåˆ†ç‰‡åšäº†ä»£ç†ã€‚</p>

<p>Flannelå·¥ä½œåŸç†
æ¯ä¸ªä¸»æœºé…ç½®ä¸€ä¸ªipæ®µå’Œå­ç½‘ä¸ªæ•°ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥é…ç½®ä¸€ä¸ªè¦†ç›–ç½‘ç»œä½¿ç”¨ 10.100.0.0/16æ®µï¼Œæ¯ä¸ªä¸»æœº/24ä¸ªå­ç½‘ã€‚å› æ­¤ä¸»æœºaå¯ä»¥æ¥å—10.100.5.0/24ï¼Œä¸»æœºBå¯ä»¥æ¥å—10.100.18.0/24çš„åŒ…ã€‚flannelä½¿ç”¨etcdæ¥ç»´æŠ¤åˆ†é…çš„å­ç½‘åˆ°å®é™…çš„ipåœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚å¯¹äºæ•°æ®è·¯å¾„ï¼Œflannel ä½¿ç”¨udpæ¥å°è£…ipæ•°æ®æŠ¥ï¼Œè½¬å‘åˆ°è¿œç¨‹ä¸»æœºã€‚é€‰æ‹©UDPä½œä¸ºè½¬å‘åè®®æ˜¯å› ä¸ºä»–èƒ½ç©¿é€é˜²ç«å¢™ã€‚ä¾‹å¦‚ï¼ŒAWS Classicæ— æ³•è½¬å‘IPoIP or GRE ç½‘ç»œåŒ…ï¼Œæ˜¯å› ä¸ºå®ƒçš„å®‰å…¨ç»„ä»…ä»…æ”¯æŒTCP/UDP/ICMPã€‚ Flannelå·¥ä½œåŸç†æµç¨‹å›¾å¦‚ä¸‹ (é»˜è®¤çš„èŠ‚ç‚¹é—´æ•°æ®é€šä¿¡æ–¹å¼æ˜¯UDPè½¬å‘;  flannelé»˜è®¤ä½¿ç”¨8285ç«¯å£ä½œä¸ºUDPå°è£…æŠ¥æ–‡çš„ç«¯å£ï¼ŒVxLanä½¿ç”¨8472ç«¯å£)</p>

<p>å¯¹ä¸Šå›¾çš„ç®€å•è¯´æ˜ (Flannelçš„å·¥ä½œåŸç†å¯ä»¥è§£é‡Šå¦‚ä¸‹)ï¼š
-&gt; æ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼Œè¿™æ˜¯ä¸ªP2Pçš„è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚
-&gt; Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¥å¼ è¡¨é‡Œä¿å­˜äº†å„ä¸ªèŠ‚ç‚¹ä¸»æœºçš„å­ç½‘ç½‘æ®µä¿¡æ¯ã€‚
-&gt; æºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€æ ·çš„ç”±docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚</p>

<p>è¿™æ ·æ•´ä¸ªæ•°æ®åŒ…çš„ä¼ é€’å°±å®Œæˆäº†ï¼Œè¿™é‡Œéœ€è¦è§£é‡Šä¸‰ä¸ªé—®é¢˜ï¼š
1) UDPå°è£…æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ
åœ¨UDPçš„æ•°æ®å†…å®¹éƒ¨åˆ†å…¶å®æ˜¯å¦ä¸€ä¸ªICMPï¼ˆä¹Ÿå°±æ˜¯pingå‘½ä»¤ï¼‰çš„æ•°æ®åŒ…ã€‚åŸå§‹æ•°æ®æ˜¯åœ¨èµ·å§‹èŠ‚ç‚¹çš„FlannelæœåŠ¡ä¸Šè¿›è¡ŒUDPå°è£…çš„ï¼ŒæŠ•é€’åˆ°ç›®çš„èŠ‚ç‚¹åå°±è¢«å¦ä¸€ç«¯çš„FlannelæœåŠ¡
è¿˜åŸæˆäº†åŸå§‹çš„æ•°æ®åŒ…ï¼Œä¸¤è¾¹çš„DockeræœåŠ¡éƒ½æ„Ÿè§‰ä¸åˆ°è¿™ä¸ªè¿‡ç¨‹çš„å­˜åœ¨ã€‚</p>

<p>2) ä¸ºä»€ä¹ˆæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„Dockerä¼šä½¿ç”¨ä¸åŒçš„IPåœ°å€æ®µï¼Ÿ
è¿™ä¸ªäº‹æƒ…çœ‹èµ·æ¥å¾ˆè¯¡å¼‚ï¼Œä½†çœŸç›¸ååˆ†ç®€å•ã€‚å…¶å®åªæ˜¯å•çº¯çš„å› ä¸ºFlannelé€šè¿‡Etcdåˆ†é…äº†æ¯ä¸ªèŠ‚ç‚¹å¯ç”¨çš„IPåœ°å€æ®µåï¼Œå·å·çš„ä¿®æ”¹äº†Dockerçš„å¯åŠ¨å‚æ•°ã€‚
åœ¨è¿è¡Œäº†FlannelæœåŠ¡çš„èŠ‚ç‚¹ä¸Šå¯ä»¥æŸ¥çœ‹åˆ°DockeræœåŠ¡è¿›ç¨‹è¿è¡Œå‚æ•°ï¼ˆps aux|grep docker|grep â€œbipâ€ï¼‰ï¼Œä¾‹å¦‚â€œâ€“bip=182.48.25.1/24â€è¿™ä¸ªå‚æ•°ï¼Œå®ƒé™åˆ¶äº†æ‰€åœ¨èŠ‚
ç‚¹å®¹å™¨è·å¾—çš„IPèŒƒå›´ã€‚è¿™ä¸ªIPèŒƒå›´æ˜¯ç”±Flannelè‡ªåŠ¨åˆ†é…çš„ï¼Œç”±Flannelé€šè¿‡ä¿å­˜åœ¨EtcdæœåŠ¡ä¸­çš„è®°å½•ç¡®ä¿å®ƒä»¬ä¸ä¼šé‡å¤ã€‚</p>

<p>3) ä¸ºä»€ä¹ˆåœ¨å‘é€èŠ‚ç‚¹ä¸Šçš„æ•°æ®ä¼šä»docker0è·¯ç”±åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼Œåœ¨ç›®çš„èŠ‚ç‚¹ä¼šä»flannel0è·¯ç”±åˆ°docker0è™šæ‹Ÿç½‘å¡ï¼Ÿ
ä¾‹å¦‚ç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®åŒ…è¦ä»IPä¸º172.17.18.2çš„å®¹å™¨å‘åˆ°IPä¸º172.17.46.2çš„å®¹å™¨ã€‚æ ¹æ®æ•°æ®å‘é€èŠ‚ç‚¹çš„è·¯ç”±è¡¨ï¼Œå®ƒåªä¸172.17.0.0/16åŒ¹é…è¿™æ¡è®°å½•åŒ¹é…ï¼Œå› æ­¤æ•°æ®ä»docker0
å‡ºæ¥ä»¥åå°±è¢«æŠ•é€’åˆ°äº†flannel0ã€‚åŒç†åœ¨ç›®æ ‡èŠ‚ç‚¹ï¼Œç”±äºæŠ•é€’çš„åœ°å€æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå› æ­¤ç›®çš„åœ°å€ä¸€å®šä¼šè½åœ¨docker0å¯¹äºçš„172.17.46.0/24è¿™ä¸ªè®°å½•ä¸Šï¼Œè‡ªç„¶çš„è¢«æŠ•é€’åˆ°äº†docker0ç½‘å¡ã€‚</p>

<p>pipeworkçš„æ€è·¯
pipeworkæ˜¯ä¸€ä¸ªå•æœºçš„å·¥å…·ï¼Œç»„åˆäº†brctlç­‰å·¥å…·ï¼Œå¯ä»¥è®¤ä¸ºpipeworkè§£å†³çš„æ˜¯å®¿ä¸»æœºä¸Šçš„è®¾ç½®å®¹å™¨çš„è™šæ‹Ÿç½‘å¡ã€ç½‘æ¡¥ã€ipç­‰ï¼Œå¯ä»¥é…åˆå…¶ä»–ç½‘ç»œä½¿ç”¨ã€‚</p>

<p>å¦‚æœå®¹å™¨æ•°é‡ä¸å¤šï¼Œæƒ³ç®€å•çš„ç»„ä¸€ä¸ªå¤§çš„3å±‚ç½‘ç»œï¼Œå¯ä»¥è€ƒè™‘weave
å¦‚æœå®¹å™¨æ•°é‡å¾ˆå¤šï¼Œè€Œä¸”ä½ ä»¬çš„ç¯å¢ƒå¤æ‚,éœ€è¦å¤šä¸ªå­ç½‘ï¼Œå¯ä»¥è€ƒè™‘open vswitchæˆ–è€…fannel
weaveçš„æ€»ä½“ç½‘ç»œæ€§èƒ½è¡¨ç°æ¬ ä½³ï¼Œ flannel VXLAN èƒ½æ»¡è¶³è¦æ±‚ï¼Œä¸€èˆ¬æ¨èç”¨flannel</p>

<p>Flannelç¯å¢ƒéƒ¨ç½²è®°å½•</p>

<p>1ï¼‰æœºå™¨ç¯å¢ƒï¼ˆcentos7ç³»ç»Ÿï¼‰</p>

<p>1
2
182.48.115.233     éƒ¨ç½²etcdï¼Œflannelï¼Œdocker      ä¸»æœºåï¼šnode-1   ä¸»æ§ç«¯ï¼ˆé€šè¿‡etcdï¼‰
182.48.115.235     éƒ¨ç½²flannelï¼Œdocker            ä¸»æœºåï¼šnode-2   è¢«æ§ç«¯
2ï¼‰node-1ï¼ˆ182.48.115.233ï¼‰æœºå™¨æ“ä½œ
è®¾ç½®ä¸»æœºååŠç»‘å®šhosts
[root@node-1 ~]# hostnamectl â€“static set-hostname  node-1
[root@node-1 ~]# vim /etc/hosts
182.48.115.233    node-1
182.48.115.233    etcd
182.48.115.235    node-2</p>

<p>å…³é—­é˜²ç«å¢™ï¼Œå¦‚æœå¼€å¯é˜²ç«å¢™ï¼Œåˆ™æœ€å¥½æ‰“å¼€2379å’Œ4001ç«¯å£
[root@node-1 ~]# systemctl disable firewalld.service
[root@node-1 ~]# systemctl stop firewalld.service</p>

<p>å…ˆå®‰è£…dockerç¯å¢ƒ
[root@node-1 ~]# yum install -y docker</p>

<p>å®‰è£…etcd
k8sè¿è¡Œä¾èµ–etcdï¼Œéœ€è¦å…ˆéƒ¨ç½²etcdï¼Œä¸‹é¢é‡‡ç”¨yumæ–¹å¼å®‰è£…ï¼š
[root@node-1 ~]# yum install etcd -y</p>

<p>yumå®‰è£…çš„etcdé»˜è®¤é…ç½®æ–‡ä»¶åœ¨/etc/etcd/etcd.confï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š
[root@node-1 ~]# cp /etc/etcd/etcd.conf /etc/etcd/etcd.conf.bak
[root@node-1 ~]# cat /etc/etcd/etcd.conf
#[member]
ETCD_NAME=master                                            #èŠ‚ç‚¹åç§°
ETCD_DATA_DIR=â€/var/lib/etcd/default.etcdâ€                  #æ•°æ®å­˜æ”¾ä½ç½®
#ETCD_WAL_DIR=â€â€
#ETCD_SNAPSHOT_COUNT=â€10000â€
#ETCD_HEARTBEAT_INTERVAL=â€100â€
#ETCD_ELECTION_TIMEOUT=â€1000â€
#ETCD_LISTEN_PEER_URLS=â€http://0.0.0.0:2380â€
ETCD_LISTEN_CLIENT_URLS=â€http://0.0.0.0:2379,http://0.0.0.0:4001â€             #ç›‘å¬å®¢æˆ·ç«¯åœ°å€
#ETCD_MAX_SNAPSHOTS=â€5â€
#ETCD_MAX_WALS=â€5â€
#ETCD_CORS=â€â€
#
#[cluster]
#ETCD_INITIAL_ADVERTISE_PEER_URLS=â€http://localhost:2380â€</p>
<h1 id="if-you-use-different-etcd_name-eg-test-set-etcd_initial_cluster-value-for-this-name-ie-testhttp">if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. â€œtest=http://â€¦â€</h1>
<p>#ETCD_INITIAL_CLUSTER=â€default=http://localhost:2380â€
#ETCD_INITIAL_CLUSTER_STATE=â€newâ€
#ETCD_INITIAL_CLUSTER_TOKEN=â€etcd-clusterâ€
ETCD_ADVERTISE_CLIENT_URLS=â€http://etcd:2379,http://etcd:4001â€           #é€šçŸ¥å®¢æˆ·ç«¯åœ°å€
#ETCD_DISCOVERY=â€â€
#ETCD_DISCOVERY_SRV=â€â€
#ETCD_DISCOVERY_FALLBACK=â€proxyâ€
#ETCD_DISCOVERY_PROXY=â€â€</p>

<p>å¯åŠ¨etcdå¹¶éªŒè¯çŠ¶æ€
[root@node-1 ~]# systemctl start etcd</p>

<p>[root@node-1 ~]# ps -ef|grep etcd
etcd     28145     1  1 14:38 ?        00:00:00 /usr/bin/etcd â€“name=master â€“data-dir=/var/lib/etcd/default.etcd â€“listen-client-urls=http://0.0.0.0:2379,http://0.0.0.0:4001
root     28185 24819  0 14:38 pts/1    00:00:00 grep â€“color=auto etcd
[root@node-1 ~]# lsof -i:2379
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
etcd    28145 etcd    6u  IPv6 1283822      0t0  TCP *:2379 (LISTEN)
etcd    28145 etcd   18u  IPv6 1284133      0t0  TCP localhost:53203-&gt;localhost:2379 (ESTABLISHED)
â€¦â€¦..</p>

<p>[root@node-1 ~]# etcdctl set testdir/testkey0 0
0
[root@node-1 ~]# etcdctl get testdir/testkey0
0
[root@node-1 ~]# etcdctl -C http://etcd:4001 cluster-health
member 8e9e05c52164694d is healthy: got healthy result from http://etcd:2379
cluster is healthy
[root@node-1 ~]# etcdctl -C http://etcd:2379 cluster-health
member 8e9e05c52164694d is healthy: got healthy result from http://etcd:2379
cluster is healthy</p>

<p>å®‰è£…è¦†ç›–ç½‘ç»œFlannel
[root@node-1 ~]# yum install flannel</p>

<p>é…ç½®Flannel
[root@node-1 ~]# cp /etc/sysconfig/flanneld /etc/sysconfig/flanneld.bak
[root@node-1 ~]# vim /etc/sysconfig/flanneld</p>
<h1 id="flanneld-configuration-options">Flanneld configuration options</h1>

<h1 id="etcd-url-location--point-this-to-the-server-where-etcd-runs">etcd url location.  Point this to the server where etcd runs</h1>
<p>FLANNEL_ETCD_ENDPOINTS=â€http://etcd:2379â€</p>

<h1 id="etcd-config-key--this-is-the-configuration-key-that-flannel-queries">etcd config key.  This is the configuration key that flannel queries</h1>
<h1 id="for-address-range-assignment">For address range assignment</h1>
<p>FLANNEL_ETCD_PREFIX=â€/atomic.io/networkâ€</p>

<h1 id="any-additional-options-that-you-want-to-pass">Any additional options that you want to pass</h1>
<p>#FLANNEL_OPTIONS=â€â€</p>

<p>é…ç½®etcdä¸­å…³äºflannelçš„keyï¼ˆè¿™ä¸ªåªåœ¨å®‰è£…äº†etcdçš„æœºå™¨ä¸Šæ“ä½œï¼‰
Flannelä½¿ç”¨Etcdè¿›è¡Œé…ç½®ï¼Œæ¥ä¿è¯å¤šä¸ªFlannelå®ä¾‹ä¹‹é—´çš„é…ç½®ä¸€è‡´æ€§ï¼Œæ‰€ä»¥éœ€è¦åœ¨etcdä¸Šè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼ˆâ€™/atomic.io/network/configâ€™è¿™ä¸ªkeyä¸ä¸Šæ–‡/etc/sysconfig/flannelä¸­çš„é…ç½®é¡¹FLANNEL_ETCD_PREFIXæ˜¯ç›¸å¯¹åº”çš„ï¼Œé”™è¯¯çš„è¯å¯åŠ¨å°±ä¼šå‡ºé”™ï¼‰ï¼š
[root@node-1 ~]# etcdctl mk /atomic.io/network/config â€˜{ â€œNetworkâ€: â€œ182.48.0.0/16â€ }â€™
{ â€œNetworkâ€: â€œ182.48.0.0/16â€ }</p>

<p>æ¸©é¦¨æç¤ºï¼šä¸Šé¢flannelè®¾ç½®çš„ipç½‘æ®µå¯ä»¥ä»»æ„è®¾å®šï¼Œéšä¾¿è®¾å®šä¸€ä¸ªç½‘æ®µéƒ½å¯ä»¥ã€‚å®¹å™¨çš„ipå°±æ˜¯æ ¹æ®è¿™ä¸ªç½‘æ®µè¿›è¡Œè‡ªåŠ¨åˆ†é…çš„ï¼Œipåˆ†é…åï¼Œå®¹å™¨ä¸€èˆ¬æ˜¯å¯ä»¥å¯¹å¤–è”ç½‘çš„ï¼ˆç½‘æ¡¥æ¨¡å¼ï¼Œåªè¦å®¿ä¸»æœºèƒ½ä¸Šç½‘å°±å¯ä»¥ï¼‰</p>

<p>å¯åŠ¨Flannel
[root@node-1 ~]# systemctl enable flanneld.service
[root@node-1 ~]# systemctl start flanneld.service
[root@node-1 ~]# ps -ef|grep flannel
root      9305  9085  0 09:12 pts/2    00:00:00 grep â€“color=auto flannel
root     28876     1  0 May15 ?        00:00:07 /usr/bin/flanneld -etcd-endpoints=http://etcd:2379 -etcd-prefix=/atomic.io/network</p>

<p>å¯åŠ¨Flannelåï¼Œä¸€å®šè¦è®°å¾—é‡å¯dockerï¼Œè¿™æ ·Flannelé…ç½®åˆ†é…çš„ipæ‰èƒ½ç”Ÿæ•ˆï¼Œå³docker0è™šæ‹Ÿç½‘å¡çš„ipä¼šå˜æˆä¸Šé¢flannelè®¾å®šçš„ipæ®µ
[root@node-1 ~]# systemctl restart docker
3ï¼‰node-2ï¼ˆ182.48.115.235ï¼‰æœºå™¨æ“ä½œ
è®¾ç½®ä¸»æœºååŠç»‘å®šhosts
[root@node-2 ~]# hostnamectl â€“static set-hostname  node-2
[root@node-2 ~]# vim /etc/hosts
182.48.115.233    node-1
182.48.115.233    etcd
182.48.115.235    node-2</p>

<p>å…³é—­é˜²ç«å¢™ï¼Œå¦‚æœå¼€å¯é˜²ç«å¢™ï¼Œåˆ™æœ€å¥½æ‰“å¼€2379å’Œ4001ç«¯å£
[root@node-2 ~]# systemctl disable firewalld.service
[root@node-2 ~]# systemctl stop firewalld.service</p>

<p>å…ˆå®‰è£…dockerç¯å¢ƒ
[root@node-2 ~]# yum install -y docker</p>

<p>å®‰è£…è¦†ç›–ç½‘ç»œFlannel
[root@node-2 ~]# yum install flannel</p>

<p>é…ç½®Flannel
[root@node-2 ~]# cp /etc/sysconfig/flanneld /etc/sysconfig/flanneld.bak
[root@node-2 ~]# vim /etc/sysconfig/flanneld</p>
<h1 id="flanneld-configuration-options-1">Flanneld configuration options</h1>

<h1 id="etcd-url-location--point-this-to-the-server-where-etcd-runs-1">etcd url location.  Point this to the server where etcd runs</h1>
<p>FLANNEL_ETCD_ENDPOINTS=â€http://etcd:2379â€</p>

<h1 id="etcd-config-key--this-is-the-configuration-key-that-flannel-queries-1">etcd config key.  This is the configuration key that flannel queries</h1>
<h1 id="for-address-range-assignment-1">For address range assignment</h1>
<p>FLANNEL_ETCD_PREFIX=â€/atomic.io/networkâ€</p>

<h1 id="any-additional-options-that-you-want-to-pass-1">Any additional options that you want to pass</h1>
<p>#FLANNEL_OPTIONS=â€â€</p>

<p>å¯åŠ¨Flannel
[root@node-2 ~]# systemctl enable flanneld.service
[root@node-2 ~]# systemctl start flanneld.service
[root@node-2 ~]# ps -ef|grep flannel
root      3841  9649  0 09:11 pts/0    00:00:00 grep â€“color=auto flannel
root     28995     1  0 May15 ?        00:00:07 /usr/bin/flanneld -etcd-endpoints=http://etcd:2379 -etcd-prefix=/atomic.io/network</p>

<p>å¯åŠ¨Flannelåï¼Œä¸€å®šè¦è®°å¾—é‡å¯dockerï¼Œè¿™æ ·Flannelé…ç½®åˆ†é…çš„ipæ‰èƒ½ç”Ÿæ•ˆï¼Œå³docker0è™šæ‹Ÿç½‘å¡çš„ipä¼šå˜æˆä¸Šé¢flannelè®¾å®šçš„ipæ®µ
[root@node-2 ~]# systemctl restart docker
4ï¼‰åˆ›å»ºå®¹å™¨ï¼ŒéªŒè¯è·¨ä¸»æœºå®¹å™¨ä¹‹é—´çš„ç½‘ç»œè”é€šæ€§
é¦–å…ˆåœ¨node-1ï¼ˆ182.48.115.233ï¼‰ä¸Šå®¹å™¨å®¹å™¨ï¼Œå¦‚ä¸‹ï¼Œç™»é™†å®¹å™¨å‘ç°å·²ç»æŒ‰ç…§ä¸Šé¢flannelé…ç½®çš„åˆ†é…äº†ä¸€ä¸ªipæ®µï¼ˆæ¯ä¸ªå®¿ä¸»æœºéƒ½ä¼šåˆ†é…ä¸€ä¸ª182.48.0.0/16çš„ç½‘æ®µï¼‰</p>

<p>[root@node-1 ~]# docker run -ti -d â€“name=node-1.test docker.io/nginx /bin/bash
5e403bf93857fa28b42c9e2abaa5781be4e2bc118ba0c25cb6355b9793dd107e
[root@node-1 ~]# docker exec -ti node-1.test /bin/bash
root@5e403bf93857:/# ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2953: eth0@if2954: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1472 qdisc noqueue state UP group default
    link/ether 02:42:b6:30:19:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 182.48.25.4/24 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:b6ff:fe30:1904/64 scope link
       valid_lft forever preferred_lft forever</p>

<p>æ¥ç€åœ¨node-2ï¼ˆ182.48.115.233ï¼‰ä¸Šå®¹å™¨å®¹å™¨
[root@node-2 ~]# docker exec -ti node-2.test /bin/bash
root@052a6a2a4a19:/# ip addr
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
10: eth0@if11: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1472 qdisc noqueue state UP group default
    link/ether 02:42:b6:30:43:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 182.48.67.3/24 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:b6ff:fe30:4303/64 scope link
       valid_lft forever preferred_lft forever</p>

<p>root@052a6a2a4a19:/# ping 182.48.25.4
PING 182.48.25.4 (182.48.25.4): 56 data bytes
64 bytes from 182.48.25.4: icmp_seq=0 ttl=60 time=2.463 ms
64 bytes from 182.48.25.4: icmp_seq=1 ttl=60 time=1.211 ms
â€¦â€¦.</p>

<p>root@052a6a2a4a19:/# ping www.baidu.com
PING www.a.shifen.com (14.215.177.37): 56 data bytes
64 bytes from 14.215.177.37: icmp_seq=0 ttl=51 time=39.404 ms
64 bytes from 14.215.177.37: icmp_seq=1 ttl=51 time=39.437 ms
â€¦â€¦.</p>

<p>å‘ç°ï¼Œåœ¨ä¸¤ä¸ªå®¿ä¸»æœºçš„å®¹å™¨å†…ï¼Œäº’ç›¸pingå¯¹æ–¹å®¹å™¨çš„ipï¼Œæ˜¯å¯ä»¥pingé€šçš„ï¼ä¹Ÿå¯ä»¥ç›´æ¥è¿æ¥å¤–ç½‘ï¼ˆæ¡¥æ¥æ¨¡å¼ï¼‰</p>

<p>æŸ¥çœ‹ä¸¤å°å®¿ä¸»æœºçš„ç½‘å¡ä¿¡æ¯ï¼Œå‘ç°docker0è™šæ‹Ÿç½‘å¡çš„ipï¼ˆç›¸å½“äºå®¹å™¨çš„ç½‘å…³ï¼‰ä¹Ÿå·²ç»å˜æˆäº†flannelé…ç½®çš„ipæ®µï¼Œå¹¶ä¸”å¤šäº†flannel0çš„è™šæ‹Ÿç½‘å¡ä¿¡æ¯
[root@node-1 ~]# ifconfig
docker0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1472
        inet 182.48.25.1  netmask 255.255.255.0  broadcast 0.0.0.0
        inet6 fe80::42:31ff:fe0f:cf0f  prefixlen 64  scopeid 0x20<link />
        ether 02:42:31:0f:cf:0f  txqueuelen 0  (Ethernet)
        RX packets 48  bytes 2952 (2.8 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 31  bytes 2286 (2.2 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p>

<p>eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 182.48.115.233  netmask 255.255.255.224  broadcast 182.48.115.255
        inet6 fe80::5054:ff:fe34:782  prefixlen 64  scopeid 0x20<link />
        ether 52:54:00:34:07:82  txqueuelen 1000  (Ethernet)
        RX packets 10759798  bytes 2286314897 (2.1 GiB)
        RX errors 0  dropped 40  overruns 0  frame 0
        TX packets 21978639  bytes 1889026515 (1.7 GiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p>

<p>flannel0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1472
        inet 182.48.25.0  netmask 255.255.0.0  destination 182.48.25.0
        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 500  (UNSPEC)
        RX packets 12  bytes 1008 (1008.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 12  bytes 1008 (1008.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</p>

<p>é€šè¿‡ä¸‹é¢å‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹åˆ°æœ¬æœºçš„å®¹å™¨çš„ipæ‰€åœ¨çš„èŒƒå›´
[root@node-1 ~]# ps aux|grep docker|grep â€œbipâ€
root      2080  0.0  1.4 796864 28168 ?        Ssl  May15   0:18 /usr/bin/dockerd-current â€“add-runtime docker-runc=/usr/libexec/docker/docker-runc-current â€“default-runtime=docker-runc â€“exec-opt native.cgroupdriver=systemd â€“userland-proxy-path=/usr/libexec/docker/docker-proxy-current â€“insecure-registry registry:5000 â€“bip=182.48.25.1/24 â€“ip-masq=true â€“mtu=1472</p>

<p>è¿™é‡Œé¢çš„â€œâ€“bip=182.48.25.1/24â€è¿™ä¸ªå‚æ•°ï¼Œå®ƒé™åˆ¶äº†æ‰€åœ¨èŠ‚ç‚¹å®¹å™¨è·å¾—çš„IPèŒƒå›´ã€‚
è¿™ä¸ªIPèŒƒå›´æ˜¯ç”±Flannelè‡ªåŠ¨åˆ†é…çš„ï¼Œç”±Flannelé€šè¿‡ä¿å­˜åœ¨EtcdæœåŠ¡ä¸­çš„è®°å½•ç¡®ä¿å®ƒä»¬ä¸ä¼šé‡å¤ã€‚
==========================================================================
æ¸©é¦¨æç¤ºï¼š
å¦‚ä¸Šé¢æ“ä½œåï¼Œå‘ç°å„å®¹å™¨å†…åˆ†é…çš„ipä¹‹é—´ç›¸äº’pingä¸é€šï¼ŒåŸºæœ¬å°±æ˜¯ç”±äºé˜²ç«å¢™é—®é¢˜å¼•èµ·çš„ï¼
å¯æ˜¯æ˜æ˜å·²ç»åœ¨å‰é¢éƒ¨ç½²çš„æ—¶å€™ï¼Œé€šè¿‡â€systemctl stop firewalld.serviceâ€å…³é—­äº†é˜²ç«å¢™ï¼Œä¸ºä»€ä¹ˆè¿˜æœ‰é˜²ç«å¢™é—®é¢˜ï¼Ÿï¼Ÿ
è¿™æ˜¯å› ä¸ºlinuxè¿˜æœ‰åº•å±‚çš„iptablesï¼Œæ‰€ä»¥è§£å†³åŠæ³•æ˜¯åœ¨å„èŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸‹é¢æ“ä½œï¼š</p>

<p>[root@node-1 ~]# iptables -P INPUT ACCEPT
[root@node-1 ~]# iptables -P FORWARD ACCEPT
[root@node-1 ~]# iptables -F
[root@node-1 ~]# iptables -L -n</p>

<p>æ‰§è¡Œä¸Šé¢æ“ä½œåï¼ŒåŸºæœ¬å„å®¹å™¨é—´å°±èƒ½ç›¸äº’pingé€šäº†ã€‚
dockeré€šè¿‡Flannelå¯ä»¥å®ç°å„å®¹å™¨é—´çš„ç›¸äº’é€šä¿¡ï¼Œå³å®¿ä¸»æœºå’Œå®¹å™¨ï¼Œå®¹å™¨å’Œå®¹å™¨ä¹‹é—´éƒ½èƒ½ç›¸äº’é€šä¿¡ã€‚</p>
:ET