I"ó$<p>./configure â€“enable-debug â€“enable-phpdbg
make
make install</p>

<p>ext/opcache/jit/zend_jit_perf_dump.c:105:20: error: use of undeclared identifier
      â€˜CLOCK_MONOTONICâ€™
        if (clock_gettime(CLOCK_MONOTONIC, &amp;ts) != 0) {</p>

<p>#define CLOCK_MONOTONIC 0
https://stackoverflow.com/questions/5167269/clock-gettime-alternative-in-mac-os-x</p>

<p>EX_CONSTANT æœªå®šä¹‰é—®é¢˜
php7 å’Œphp8 ä¸å…¼å®¹ï¼Œéœ€è¦æ¢ä¸€ç§æ–¹å¼
estatus = EX_CONSTANT(EX(opline)-&gt;op1);
estatus = RT_CONSTANT(EX(opline), EX(opline)-&gt;op1);</p>

<p>https://gist.github.com/cmb69/3060a552fc825497d066262ab31f3998
https://zhuanlan.zhihu.com/p/64144202
<!-- more -->
Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20190128/
Installing PHP CLI binary:        /usr/local/bin/
Installing PHP CLI man page:      /usr/local/php/man/man1/
Installing phpdbg binary:         /usr/local/bin/
Installing phpdbg man page:       /usr/local/php/man/man1/
Installing PHP CGI binary:        /usr/local/bin/
Installing PHP CGI man page:      /usr/local/php/man/man1/
Installing build environment:     /usr/local/lib/php/build/
Installing header files:          /usr/local/include/php/
Installing helper programs:       /usr/local/bin/
  program: phpize
  program: php-config
Installing man pages:             /usr/local/php/man/man1/
  page: phpize.1
  page: php-config.1
/Users/didi/PhpstormProjects/c/php-src/build/shtool install -c ext/phar/phar.phar /usr/local/bin/phar.phar
ln -s -f phar.phar /usr/local/bin/phar
Installing PDO headers:           /usr/local/include/php/ext/pdo/</p>

<p>$php -v
Failed loading /usr/local/lib/php/extensions/debug-non-zts-20160303/xdebug.so:  dlopen(/usr/local/lib/php/extensions/debug-non-zts-20160303/xdebug.so, 9): Symbol not found: _gc_globals
  Referenced from: /usr/local/lib/php/extensions/debug-non-zts-20160303/xdebug.so
  Expected in: flat namespace
 in /usr/local/lib/php/extensions/debug-non-zts-20160303/xdebug.so
PHP Warning:  PHP Startup: openssl: Unable to initialize module
Module compiled with module API=20160303
PHP    compiled with module API=20190128
These options need to match
 in Unknown on line 0</p>

<p>Warning: PHP Startup: slowLog: Unable to initialize module
Module compiled with module API=20160303
PHP    compiled with module API=20190128
These options need to match
 in Unknown on line 0
PHP Fatal error:  Directive â€˜track_errorsâ€™ is no longer available in PHP in Unknown on line 0</p>

<p>Fatal error: Directive â€˜track_errorsâ€™ is no longer available in PHP in Unknown on line 0</p>

<p>vi  /usr/local/lib/php.ini
æ³¨é‡Šæ‰æ‰©å±•
In php.ini change
track_errors=On
to
track_errors=Off
https://github.com/SublimeLinter/SublimeLinter-phplint/issues/31</p>

<p>$php -v
PHP 8.0.0-dev (cli) (built: Jul 20 2020 12:11:10) ( NTS DEBUG )
Copyright (c) The PHP Group
Zend Engine v4.0.0-dev, Copyright (c) Zend Technologies</p>

<p>cd ext/al
phpize
./configure
make
make install</p>

<p>vi /usr/local/lib/php.ini
 extension_dir = â€œ/usr/local/lib/php/extensions/debug-non-zts-20190128/â€
extension=al.so</p>

<table>
  <tbody>
    <tr>
      <td>php -m</td>
      <td>grep al</td>
    </tr>
  </tbody>
</table>

<p>1 warning generated.
[100%] Linking C executable alae
Undefined symbols for architecture x86_64:
  â€œ_OnUpdateBoolâ€, referenced from:
      ini_entries in</p>

<p>ld: symbol(s) not found for architecture x86_64
åŸå› ï¼š
ä¿®æ”¹phpæºç åï¼Œéœ€è¦é‡æ–°ç¼–è¯‘phpï¼Œphpæ‰©å±•é‡ŒåŠ è½½phpå‡½æ•°æ˜¯ä»é“¾æ¥åº“é‡ŒåŠ è½½çš„ï¼Œä¸æ˜¯ä»æºä»£ç ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ°</p>

<p>é’ˆå¯¹ä¸åŒç‰ˆæœ¬çš„phpï¼Œå¾ˆå®¹æ˜“å‡ºç°ä¸å…¼å®¹é—®é¢˜ï¼Œè§£å†³åŠæ³•å°±æ˜¯ç¼–è¯‘å¯¹åº”ç‰ˆæœ¬çš„php
https://stackoverflow.com/questions/40746352/symbols-not-found-for-architecture-x86-64-cmake-mac-sierra</p>

<p>https://blog.csdn.net/ligaofeng/article/details/52674696
https://segmentfault.com/q/1010000004137098</p>

<p>https://stackoverflow.com/questions/23534362/warning-treating-c-header-input-as-c-header-when-in-c-mode-this-behavi</p>

<p>zend_std_cast_object_tostring æ‰¾ä¸åˆ°é—®é¢˜
#include <zend_object_handlers.h>
è€Œä¸æ˜¯
#include "zend_object_handlers.h"</zend_object_handlers.h></p>

<p>http://cs.potsdam.edu/Documentation/php/html/zend-api.zend-std-cast-object-tostring.html</p>

<p>http://cs.potsdam.edu/Documentation/php/html/zend-api.zend-std-cast-object-tostring.html</p>

<p>ç±»å‹è½¬åŒ–é—®é¢˜
Z_OBJ_P(data)
å°†zval è½¬åŒ–æˆzend_object</p>

<p>https://learnku.com/articles/9173/2-analysis-of-zval
http://www.phpinternalsbook.com/php7/internal_types/zvals/basic_structure.html
https://yuerblog.cc/2017/08/09/course4-how-the-zval-works/</p>

<p>å°†zend_stringè½¬åŒ–æˆzval
zval myval;
zend_string *hello, *world;</p>

<p>zend_string_init(hello, â€œhelloâ€, strlen(â€œhelloâ€), 0);</p>

<p>/* å­˜å‚¨å­—ç¬¦ä¸²åˆ° zval */
ZVAL_STR(&amp;myval, hello);</p>

<p>https://learnku.com/docs/php-internals/php7/strings_zend_strings/6852</p>

<p>å°†zvalè½¬åŒ–æˆzend_string
ZSTR_VAL(str));</p>

<p>http://www.phpinternalsbook.com/php7/internal_types/strings/zend_strings.html
https://xz.aliyun.com/t/5426</p>

<p>è·å–zvalçš„å€¼åŠç±»å‹
zvalçš„ç±»å‹é€šè¿‡Z_TYPE(zval)ã€Z_TYPE_P(zval*)ä¸¤ä¸ªå®è·å–ï¼Œè¿™ä¸ªå€¼å–çš„å°±æ˜¯zval.u1.v.typeï¼Œä½†æ˜¯è®¾ç½®æ—¶ä¸è¦åªä¿®æ”¹è¿™ä¸ªtypeï¼Œè€Œæ˜¯è¦è®¾ç½®typeinfoï¼Œå› ä¸ºzvalè¿˜æœ‰å…¶å®ƒçš„æ ‡è¯†éœ€è¦è®¾ç½®ï¼Œæ¯”å¦‚æ˜¯å¦ä½¿ç”¨å¼•ç”¨è®¡æ•°ã€æ˜¯å¦å¯è¢«åƒåœ¾å›æ”¶ã€æ˜¯å¦å¯è¢«å¤åˆ¶ç­‰ç­‰ã€‚</p>

<p>å†…æ ¸æä¾›äº†Z_XXX(zval)ã€Z_XXX_P(zval*)ç³»åˆ—çš„å®ç”¨äºè·å–ä¸åŒç±»å‹zvalçš„valueã€‚</p>

<p>Z_LVAL(zval)ã€Z_LVAL_P(zval_p): è¿”å›zend_long
Z_DVAL(zval)ã€Z_DVAL_P(zval_p): è¿”å›double
Z_STR(zval)ã€Z_STR_P(zval_p): è¿”å›zend_string*
Z_STRVAL(zval)ã€Z_STRVAL_P(zval_p): è¿”å›char<em>ï¼Œå³ï¼šzend_string-&gt;val
Z_STRLEN(zval)ã€Z_STRLEN_P(zval_p): è·å–å­—ç¬¦ä¸²é•¿åº¦
Z_STRHASH(zval)ã€Z_STRHASH_P(zval_p): è·å–å­—ç¬¦ä¸²çš„å“ˆå¸Œå€¼
Z_ARR(zval)ã€Z_ARR_P(zval_p)ã€Z_ARRVAL(zval)ã€Z_ARRVAL_P(zval_p): è¿”å›zend_array</em>
Z_OBJ(zval)ã€Z_OBJ_P(zval_p): è¿”å›zend_object*
Z_OBJ_HT(zval)ã€Z_OBJ_HT_P(zval_p): è¿”å›å¯¹è±¡çš„zend_object_handlersï¼Œå³zend_object-&gt;handlers
Z_OBJ_HANDLER(zval, hf)ã€Z_OBJ_HANDLER_P(zv_p, hf): è·å–å¯¹è±¡å„æ“ä½œçš„handleræŒ‡é’ˆï¼Œhfä¸ºwrite_propertyã€read_propertyç­‰ï¼Œæ³¨æ„ï¼šè¿™ä¸ªå®å–åˆ°çš„ä¸ºåªè¯»ï¼Œä¸è¦è¯•å›¾ä¿®æ”¹è¿™ä¸ªå€¼(å¦‚ï¼šZ_OBJ_HANDLER(obj, write_property) = xxx;)ï¼Œå› ä¸ºå¯¹è±¡çš„handlersæˆå‘˜å‰åŠ äº†constä¿®é¥°ç¬¦
Z_OBJCE(zval)ã€Z_OBJCE_P(zval_p): è¿”å›å¯¹è±¡çš„zend_class_entry*
Z_OBJPROP(zval)ã€Z_OBJPROP_P(zval_p): è·å–å¯¹è±¡çš„æˆå‘˜æ•°ç»„
Z_RES(zval)ã€Z_RES_P(zval_p): è¿”å›zend_resource*
Z_RES_HANDLE(zval)ã€Z_RES_HANDLE_P(zval_p): è¿”å›èµ„æºhandle
Z_RES_TYPE(zval)ã€Z_RES_TYPE_P(zval_p): è¿”å›èµ„æºtype
Z_RES_VAL(zval)ã€Z_RES_VAL_P(zval_p): è¿”å›èµ„æºptr
Z_REF(zval)ã€Z_REF_P(zval_p): è¿”å›zend_reference*
Z_REFVAL(zval)ã€Z_REFVAL_P(zval_p): è¿”å›å¼•ç”¨çš„zval*</p>

<p>https://juejin.im/entry/5a41fc8cf265da43305eb7e9
https://www.tuine.me/php7-internal/3/zend_runtime_cache.html
https://www.ucloud.cn/yun/29096.html</p>

<p>https://learnku.com/docs/php-internals/php7/building_php/6840
https://gywbd.github.io/posts/2016/2/debug-php-source-code.html</p>

<p>https://gywbd.github.io/posts/2016/4/php-new-syntax-feature.html</p>

<p>https://xz.aliyun.com/t/5201
https://www.ssfiction.com/archives/48519
https://github.com/phacility/xhprof/issues/89</p>

<p>$php -m  |grep slow
PHP Warning:  PHP Startup: slowLog: Unable to initialize module
Module compiled with module API=20160303
PHP    compiled with module API=20190128
These options need to match
 in Unknown on line 0
Warning: PHP Startup: slowLog: Unable to initialize module</p>

<p>make clean
  phpize
  ./configure
  make
  make install</p>

<p>$php -m  |grep slow
PHP Warning:  Missing arginfo for confirm_slowLog_compiled() in Unknown on line 0
Warning: Missing arginfo for confirm_slowLog_compiled() in Unknown on line 0
slowLog</p>

<p>cd ext
$./ext_skel â€“extname=ext8</p>

<p>$./ext_skel â€“extname=ext_hello_world</p>

<p>https://www.php.net/manual/ru/internals2.buildsys.skeleton.php</p>

<p>/Users/didi/PhpstormProjects/c/php-src/ext/ext_hello_world/ext_hello_world.c:9:10: fatal error: â€˜php_%EXT_HELLO_WORLD%.hâ€™ file not found
#include â€œphp_%EXT_HELLO_WORLD%.hâ€
         ^
2 errors generated.
make: *** [ext_hello_world.lo] Error 1</p>

<p>php8 å»æ‰äº†bashè„šæœ¬</p>

<p>ç”¨./ext_skel.php â€“extname=ext_hello_world</p>

<p>$./ext_skel.php â€“extname=ext_hello
PHP Warning:  Missing arginfo for confirm_slowLog_compiled() in Unknown on line 0</p>

<p>Warning: Missing arginfo for confirm_slowLog_compiled() in Unknown on line 0
Error: Unsupported argument â€œâ€“extname=ext_helloâ€ passed</p>

<p>vi  /usr/local/lib/php.ini
;extension=slowLog.so</p>

<p>https://github.com/php/php-src/blob/master/ext/ext_skel.php</p>

<p>$php ext_skel.php â€“extname=ext_hello
Error: Unsupported argument â€œâ€“extname=ext_helloâ€ passed</p>

<p>$php ext_skel.php â€“ext ext_hello
Copying config scriptsâ€¦ done
Copying sourcesâ€¦ done
Copying testsâ€¦ done</p>

<p>Success. The extension is now ready to be compiled. To do so, use the
following steps:</p>

<p>cd /path/to/php-src/ext/ext_hello
phpize
./configure
make</p>

<p>Donâ€™t forget to run tests once the compilation is done:
make test</p>

<p>Thank you for using PHP!</p>

<p>$make install
Installing shared extensions:     /usr/local/lib/php/extensions/debug-non-zts-20190128/</p>

:ET