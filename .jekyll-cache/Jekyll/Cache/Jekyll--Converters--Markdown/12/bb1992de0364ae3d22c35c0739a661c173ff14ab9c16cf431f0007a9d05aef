I"Œ<p>åœ¨è®¡ç®—æœºç¼–ç¨‹ä¸­ï¼Œç¼–è¯‘æŒ‡ç¤º(pragma)æ˜¯ä¸€ç§è¯­è¨€ç»“æ„ï¼Œå®ƒæŒ‡ç¤ºç¼–è¯‘å™¨åº”è¯¥å¦‚ä½•å¤„ç†å…¶è¾“å…¥ã€‚æŒ‡ç¤ºä¸æ˜¯ç¼–ç¨‹è¯­è¨€è¯­æ³•çš„ä¸€éƒ¨åˆ†ï¼Œå› ç¼–è¯‘å™¨è€Œå¼‚ã€‚
<!-- more -->
https://golang.org/cmd/compile/#hdr-Compiler_Directives
å½¢å¦‚ //go: å°±æ˜¯ Go è¯­è¨€ç¼–è¯‘æŒ‡ç¤ºçš„å®ç°æ–¹å¼ã€‚
//go: æ˜¯è¿ç»­çš„ï¼Œ// å’Œ go ä¹‹é—´å¹¶æ²¡æœ‰ç©ºæ ¼ã€‚</p>

<p>https://github.com/golang/go/blob/master/src/cmd/compile/internal/gc/lex.go#L52</p>

<p>func pragmaValue(verb string) syntax.Pragma {
	switch verb {
	case â€œgo:nointerfaceâ€:
		if objabi.Fieldtrack_enabled != 0 {
			return Nointerface
		}
	case â€œgo:noescapeâ€:
		return Noescape
	case â€œgo:noraceâ€:
		return Norace
	case â€œgo:nosplitâ€:
		return Nosplit
	case â€œgo:noinlineâ€:
		return Noinline
	case â€œgo:systemstackâ€:
		return Systemstack
	case â€œgo:nowritebarrierâ€:
		return Nowritebarrier
	case â€œgo:nowritebarrierrecâ€:
		return Nowritebarrierrec | Nowritebarrier // implies Nowritebarrier
	case â€œgo:yeswritebarrierrecâ€:
		return Yeswritebarrierrec
	case â€œgo:cgo_unsafe_argsâ€:
		return CgoUnsafeArgs
	case â€œgo:uintptrescapesâ€:
		// For the next function declared in the file
		// any uintptr arguments may be pointer values
		// converted to uintptr. This directive
		// ensures that the referenced allocated
		// object, if any, is retained and not moved
		// until the call completes, even though from
		// the types alone it would appear that the
		// object is no longer needed during the
		// call. The conversion to uintptr must appear
		// in the argument list.
		// Used in syscall/dll_windows.go.
		return UintptrEscapes
	case â€œgo:notinheapâ€:
		return NotInHeap
	}
	return 0
}</p>

<p>//go:noinline
noinline é¡¾åæ€ä¹‰ï¼Œä¸è¦å†…è”ã€‚</p>

<p>Inline å†…è”
Inlineï¼Œæ˜¯åœ¨ç¼–è¯‘æœŸé—´å‘ç”Ÿçš„ï¼Œå°†å‡½æ•°è°ƒç”¨è°ƒç”¨å¤„æ›¿æ¢ä¸ºè¢«è°ƒç”¨å‡½æ•°ä¸»ä½“çš„ä¸€ç§ç¼–è¯‘å™¨ä¼˜åŒ–æ‰‹æ®µã€‚
ä¼˜åŠ¿ï¼š
å‡å°‘å‡½æ•°è°ƒç”¨çš„å¼€é”€ï¼Œæé«˜æ‰§è¡Œé€Ÿåº¦ã€‚
å¤åˆ¶åçš„æ›´å¤§å‡½æ•°ä½“ä¸ºå…¶ä»–ç¼–è¯‘ä¼˜åŒ–å¸¦æ¥å¯èƒ½æ€§ï¼Œå¦‚ è¿‡ç¨‹é—´ä¼˜åŒ–
æ¶ˆé™¤åˆ†æ”¯ï¼Œå¹¶æ”¹å–„ç©ºé—´å±€éƒ¨æ€§å’ŒæŒ‡ä»¤é¡ºåºæ€§ï¼ŒåŒæ ·å¯ä»¥æé«˜æ€§èƒ½ã€‚
é—®é¢˜ï¼š
ä»£ç å¤åˆ¶å¸¦æ¥çš„ç©ºé—´å¢é•¿ã€‚
å¦‚æœæœ‰å¤§é‡é‡å¤ä»£ç ï¼Œåè€Œä¼šé™ä½ç¼“å­˜å‘½ä¸­ç‡ï¼Œå°¤å…¶å¯¹ CPU ç¼“å­˜æ˜¯è‡´å‘½çš„ã€‚
æ‰€ä»¥ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¯¹äºæ˜¯å¦ä½¿ç”¨å†…è”ï¼Œè¦è°¨æ…è€ƒè™‘ï¼Œå¹¶åšå¥½å¹³è¡¡ï¼Œä»¥ä½¿å®ƒå‘æŒ¥æœ€å¤§çš„ä½œç”¨ã€‚
ç®€å•æ¥è¯´ï¼Œå¯¹äºçŸ­å°è€Œä¸”å·¥ä½œè¾ƒå°‘çš„å‡½æ•°ï¼Œä½¿ç”¨å†…è”æ˜¯æœ‰æ•ˆç›Šçš„ã€‚</p>

<p>//go:nosplit
nosplit çš„ä½œç”¨æ˜¯ï¼šè·³è¿‡æ ˆæº¢å‡ºæ£€æµ‹ã€‚</p>

<p>æ ˆæº¢å‡ºæ˜¯ä»€ä¹ˆï¼Ÿ
æ­£æ˜¯å› ä¸ºä¸€ä¸ª Goroutine çš„èµ·å§‹æ ˆå¤§å°æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸”æ¯”è¾ƒå°çš„ï¼Œæ‰å¯ä»¥åšåˆ°æ”¯æŒå¹¶å‘å¾ˆå¤š Goroutineï¼Œå¹¶é«˜æ•ˆè°ƒåº¦ã€‚
stack.go æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ_StackMin æ˜¯ 2048 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 2kï¼Œå®ƒä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œå½“ä¸å¤Ÿç”¨æ—¶ï¼Œå®ƒä¼šåŠ¨æ€åœ°å¢é•¿ã€‚
é‚£ä¹ˆï¼Œå¿…ç„¶æœ‰ä¸€ä¸ªæ£€æµ‹çš„æœºåˆ¶ï¼Œæ¥ä¿è¯å¯ä»¥åŠæ—¶åœ°çŸ¥é“æ ˆä¸å¤Ÿç”¨äº†ï¼Œç„¶åå†å»å¢é•¿ã€‚
å›åˆ°è¯é¢˜ï¼Œnosplit å°±æ˜¯å°†è¿™ä¸ªè·³è¿‡è¿™ä¸ªæœºåˆ¶ã€‚</p>

<p>ä¼˜åŠ£
æ˜¾ç„¶åœ°ï¼Œä¸æ‰§è¡Œæ ˆæº¢å‡ºæ£€æŸ¥ï¼Œå¯ä»¥æé«˜æ€§èƒ½ï¼Œä½†åŒæ—¶ä¹Ÿæœ‰å¯èƒ½å‘ç”Ÿ stack overflow è€Œå¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚</p>

<p>//go:noescape
noescape çš„ä½œç”¨æ˜¯ï¼šç¦æ­¢é€ƒé€¸ï¼Œè€Œä¸”å®ƒå¿…é¡»æŒ‡ç¤ºä¸€ä¸ªåªæœ‰å£°æ˜æ²¡æœ‰ä¸»ä½“çš„å‡½æ•°ã€‚</p>

<p>é€ƒé€¸æ˜¯ä»€ä¹ˆï¼Ÿ
Go ç›¸æ¯” Cã€C++ æ˜¯å†…å­˜æ›´ä¸ºå®‰å…¨çš„è¯­è¨€ï¼Œä¸»è¦ä¸€ä¸ªç‚¹å°±ä½“ç°åœ¨å®ƒå¯ä»¥è‡ªåŠ¨åœ°å°†è¶…å‡ºè‡ªèº«ç”Ÿå‘½å‘¨æœŸçš„å˜é‡ï¼Œä»å‡½æ•°æ ˆè½¬ç§»åˆ°å †ä¸­ï¼Œé€ƒé€¸å°±æ˜¯æŒ‡è¿™ç§è¡Œä¸ºã€‚</p>

<p>ä¼˜åŠ£
æœ€æ˜¾è€Œæ˜“è§çš„å¥½å¤„æ˜¯ï¼ŒGC å‹åŠ›å˜å°äº†ã€‚
å› ä¸ºå®ƒå·²ç»å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œä¸‹é¢çš„å‡½æ•°æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šé€ƒé€¸ï¼Œé‚£ä¹ˆå½“å‡½æ•°è¿”å›æ—¶ï¼Œå…¶ä¸­çš„èµ„æºä¹Ÿä¼šä¸€å¹¶éƒ½è¢«é”€æ¯ã€‚
ä¸è¿‡ï¼Œè¿™ä¹ˆåšä»£è¡¨ä¼šç»•è¿‡ç¼–è¯‘å™¨çš„é€ƒé€¸æ£€æŸ¥ï¼Œä¸€æ—¦è¿›å…¥è¿è¡Œæ—¶ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ä¸¥é‡çš„é”™è¯¯åŠåæœã€‚</p>

<p>//go:norace
norace çš„ä½œç”¨æ˜¯ï¼šè·³è¿‡ç«æ€æ£€æµ‹
æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œéš¾å…ä¼šå‡ºç°æ•°æ®ç«äº‰ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ç¼–è¯‘å™¨æ£€æµ‹åˆ°æœ‰æ•°æ®ç«äº‰ï¼Œå°±ä¼šç»™å‡ºæç¤ºã€‚</p>

<p>æ‰§è¡Œ go run -race main.go åˆ©ç”¨ -race æ¥ä½¿ç¼–è¯‘å™¨æŠ¥å‘Šæ•°æ®ç«äº‰é—®é¢˜ã€‚ä½ ä¼šçœ‹åˆ°ï¼š</p>

<p>==================
WARNING: DATA RACE
Read at 0x00000112f470 by goroutine 6:
  main.add()
      /Users/sxs/Documents/go/src/test/main.go:15 +0x3a</p>

<p>Previous write at 0x00000112f470 by goroutine 5:
  main.add()
      /Users/sxs/Documents/go/src/test/main.go:15 +0x56</p>

<p>è¯´æ˜ä¸¤ä¸ª goroutine æ‰§è¡Œçš„ add() åœ¨ç«äº‰ã€‚</p>

<p>ä¼˜åŠ£
ä½¿ç”¨ norace é™¤äº†å‡å°‘ç¼–è¯‘æ—¶é—´ï¼Œæˆ‘æƒ³ä¸åˆ°æœ‰å…¶ä»–çš„ä¼˜ç‚¹äº†ã€‚ä½†ç¼ºç‚¹å´å¾ˆæ˜æ˜¾ï¼Œé‚£å°±æ˜¯æ•°æ®ç«äº‰ä¼šå¯¼è‡´ç¨‹åºçš„ä¸ç¡®å®šæ€§ã€‚</p>

:ET