I"ó<p>ä¼˜ç‚¹:åœ¨ä¸€ä¸ªè¿›ç¨‹å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«å…¨å±€å˜é‡ï¼Œå¾ˆæ–¹ä¾¿åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ•°æ®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ç¼ºç‚¹:çº¿ç¨‹æ˜¯å¯¹å…¨å±€å˜é‡éšæ„é‚æ”¹å¯èƒ½é€ æˆå¤šçº¿ç¨‹ä¹‹é—´å¯¹å…¨å±€å˜é‡çš„æ··ä¹±ï¼ˆå³çº¿ç¨‹éå®‰å…¨ &lt;!-- more --&gt; è§£å†³çš„åŠæ³•:å¯ä»¥åœ¨çº¿ç¨‹å¯¹å…¨å±€å˜é‡æ“ä½œçš„åœ°æ–¹æ·»åŠ ä¸€ä¸ªäº’æ–¥é”.
</code></pre></div></div>

<p>ä¸Šé”çš„è¿‡ç¨‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨é”çš„acquire()æ–¹æ³•è·å¾—é”æ—¶ï¼Œé”å°±è¿›å…¥â€œlockedâ€çŠ¶æ€ã€‚æ¯æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å¾—é”ã€‚å¦‚æœæ­¤æ—¶å¦ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å¾—è¿™ä¸ªé”ï¼Œè¯¥çº¿ç¨‹å°±ä¼šå˜ä¸ºâ€œblockedâ€çŠ¶æ€ï¼Œç§°ä¸ºâ€œé˜»å¡â€ï¼Œç›´åˆ°æ‹¥æœ‰é”çš„çº¿ç¨‹è°ƒç”¨é”çš„release()æ–¹æ³•é‡Šæ”¾é”ä¹‹åï¼Œé”è¿›å…¥â€œunlockedâ€çŠ¶æ€ã€‚çº¿ç¨‹è°ƒåº¦ç¨‹åºä»å¤„äºåŒæ­¥é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ä¸­é€‰æ‹©ä¸€ä¸ªæ¥è·å¾—é”ï¼Œå¹¶ä½¿å¾—è¯¥çº¿ç¨‹è¿›å…¥è¿è¡Œï¼ˆrunningï¼‰çŠ¶æ€

ç»“è®ºï¼šä¸€ä¸ªçº¿ç¨‹æ”¹å˜çš„å€¼ï¼Œåœ¨å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¸­èƒ½å¤Ÿæœ‰æ•ˆï¼Œå¤šçº¿ç¨‹å…±äº«å…¨å±€å˜é‡ã€‚

æœ‰ä¸€ä¸ªåˆå§‹å€¼ä¸ºnçš„å…¨å±€å˜é‡ä½œä¸ºè®¡æ•°å™¨, ç„¶åç”¨nä¸ªçº¿ç¨‹,æ¯ä¸ªçº¿ç¨‹å°†è®¡æ•°å™¨å‡1,å°†è¿™ä¸ªè®¡æ•°å™¨å‡å°‘åˆ°0; åœ¨næ¯”è¾ƒå¤§çš„æ—¶å€™, å¾—ä¸åˆ°æ­£ç¡®ç»“æœ.
</code></pre></div></div>

<p>ä½¿ç”¨äº†pthreadçº¿ç¨‹å’Œstd::thread,å°è¯•äº†ç”¨pthread_mutex, std::mutex, ä»¥åŠ__atomic_sub_fetchè¿›è¡ŒåŠ é”æˆ–è€…åŸå­å‡,éƒ½å¾—ä¸åˆ°æ­£ç¡®ç»“æœ</p>

<p>å½“nä¸º10çš„æ—¶å€™,å¯ä»¥å¾—åˆ°æ­£ç¡®ç»“æœ.
å½“nä¸º100çš„æ—¶å€™,å¾—ä¸åˆ°æ­£ç¡®ç»“æœ.è€Œåœ¨çº¿ç¨‹å†…å»¶æ—¶10msä¹‹åå¯ä»¥å¾—åˆ°æ­£ç¡®ç»“æœ</p>

<p>æˆ‘çŒœæ˜¯å…±äº«èµ„æºè¿™é‡Œå‡ºäº†é—®é¢˜,ä½†æ˜¯å®åœ¨æƒ³ä¸é€š,è¿™ä¸ªé”åº”è¯¥æ€ä¹ˆåŠ æ‰æ˜¯å¯¹çš„â€¦ æ±‚å„ä½Dalaoè§£ç­”ä¸€ä¸‹`</p>

<p>ç›¸å…³ä»£ç 
å…¨å±€å˜é‡</p>

<p>int count = 100;
pthread_mutex_t mutex_pthread;
mutex mutex_std;
çº¿ç¨‹å‡½æ•°</p>

<p>void* writer(void* id) {</p>

<p>cout Â«Â â€œWriter enter. â€œ Â«Â (long)id Â«Â endl;
//this_thread::sleep_for(chrono::milliseconds(10));</p>

<p>//__atomic_sub_fetch(&amp;count, 1, __ATOMIC_RELAXED);</p>

<p>//pthread_mutex_lock(&amp;mutex_pthread);
//countâ€“;
//pthread_mutex_unlock(&amp;mutex_pthread);</p>

<p>{
    lock_guard<mutex> lock_guard1(mutex_std);
    count--;
  }</mutex></p>

<p>cout Â«Â â€œWriter exit. â€œ Â«Â (long)id Â«Â â€, count: â€œ Â«Â count Â«Â endl;
  return NULL;
}
ä¸»å‡½æ•°</p>

<p>int main() {
  std::cout Â«Â â€œHello, World!â€ Â«Â std::endl;</p>

<p>pthread_mutex_init(&amp;mutex_pthread, NULL);
  vector<pthread_t> writers;
  for (int i = 0; i &lt; count; i++) {
    pthread_t th;
    pthread_create(&amp;th, NULL, writer, (void*)i);
    writers.push_back(th);
  }</pthread_t></p>

<p>for (int i = 0; i &lt; count; i++) {
    void* ret;
    pthread_join(writers[i], &amp;ret);
  }</p>

<p>cout.flush();
  cerr Â«Â â€œAll writers end. Count: â€œ Â«Â count Â«Â endl;
  while (count);
  cerr Â«Â â€œAll writers end. Count: â€œ Â«Â count Â«Â endl;</p>

<p>return 0;
}</p>
:ET