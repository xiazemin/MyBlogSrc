I"è:<p>https://github.com/kiwenlau/kubernetes-shell
https://github.com/kiwenlau/kubernetes-supervisor
ä¸€èˆ¬æ¥è¯´ï¼ŒDockerå®¹å™¨æ¯”è¾ƒé€‚åˆè¿è¡Œå•ä¸ªè¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œé¡¹ç›®â€ä½¿ç”¨å¤šä¸ªDockerå®¹å™¨è¿è¡ŒKubernetesâ€œï¼ŒKubernetesçš„å„ä¸ªç»„ä»¶åˆ†åˆ«è¿è¡Œåœ¨å„ä¸ªå®¹å™¨ä¹‹ä¸­ï¼Œæ¯ä¸ªå®¹å™¨åªè¿è¡Œå•ä¸ªè¿›ç¨‹ã€‚</p>

<p>ç„¶è€Œï¼Œå¾ˆå¤šæ—¶å€™æˆ‘ä»¬éœ€è¦åœ¨Dockerå®¹å™¨ä¸­è¿è¡Œå¤šä¸ªè¿›ç¨‹ã€‚ä¾‹å¦‚ï¼Œé¡¹ç›®â€ä½¿ç”¨å•ä¸ªDockerå®¹å™¨è¿è¡ŒKubernetesâ€œï¼Œkubernetesçš„å„ä¸ªç»„ä»¶å‡è¿è¡Œåœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼Œè¯¥å®¹å™¨ä¸­è¿è¡Œäº†å¤šä¸ªè¿›ç¨‹ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•è¿è¡Œå¤šè¿›ç¨‹Dockerå®¹å™¨ï¼Ÿ</p>

<p>ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨Shellè„šæœ¬ï¼Œå¦ä¸€ç§æ–¹æ³•æ˜¯ä½¿ç”¨è¿›ç¨‹ç®¡ç†å·¥å…·Supervisorã€‚kiwenlau/kubernetes-shellå’Œkiwenlau/kubernetes-supervisoråˆ†åˆ«é‡‡ç”¨äº†è¿™ä¸¤ç§æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨å¤šä¸ªè¿›ç¨‹æ¥è¿è¡ŒKubernetesçš„å„ä¸ªç»„ä»¶ï¼Œä»è€Œå®ç°â€ä½¿ç”¨å•ä¸ªDockerå®¹å™¨è¿è¡ŒKubernetesâ€œã€‚ä¸‹é¢æˆ‘å°†åˆ†åˆ«ä»‹ç»ä¸¤ç§ä¸åŒæ–¹æ³•ã€‚</p>

<p>äºŒ. ä½¿ç”¨Shellè„šæœ¬è¿è¡Œå¤šè¿›ç¨‹Dockerå®¹å™¨
è¿™ä¸ªæ–¹æ³•å¤§å®¶åº”è¯¥ä¼šæ¯”è¾ƒç†Ÿæ‚‰ï¼Œä½¿ç”¨Shellè„šæœ¬ä¾æ¬¡å¯åŠ¨Kubernetesçš„å„ä¸ªç»„ä»¶å³å¯ã€‚ä»¥ä¸‹ä¸ºstart-kubernetes.sh</p>

<p>#!/bin/bash</p>

<h1 id="start-docker-daemon">start docker daemon</h1>
<p>docker daemon &gt; /var/log/docker.log 2&gt;&amp;1 &amp;</p>

<h1 id="start-etcd">start etcd</h1>
<p>etcd â€“data-dir=/var/etcd/data &gt; /var/log/etcd.log 2&gt;&amp;1 &amp;</p>

<h1 id="wait-for-ectd-to-setup">wait for ectd to setup</h1>
<p>sleep 5</p>

<h1 id="start-apiserver">start apiserver</h1>
<p>kube-apiserver â€“service-cluster-ip-range=10.0.0.1/24 â€“insecure-bind-address=0.0.0.0 â€“etcd_servers=http://127.0.0.1:4001 &gt; /var/log/kube-apiserver.log 2&gt;&amp;1 &amp;</p>

<h1 id="wait-for-apiserver-to-setup">wait for apiserver to setup</h1>
<p>sleep 5</p>

<h1 id="start-controller-manager-sheduler-kubelet-and-proxy">start controller manager, sheduler, kubelet and proxy</h1>
<p>kube-controller-manager â€“master=http://0.0.0.0:8080 &gt; /var/log/kube-controller-manager.log 2&gt;&amp;1 &amp;
kube-scheduler â€“master=http://0.0.0.0:8080 &gt; /var/log/kube-scheduler.log 2&gt;&amp;1 &amp;
kubelet â€“api_servers=http://0.0.0.0:8080 â€“address=0.0.0.0 â€“cluster_dns=10.0.0.10 â€“cluster_domain=â€kubernetes.localâ€ â€“pod-infra-container-image=â€kiwenlau/pause:0.8.0â€  &gt; /var/log/kubelet.log 2&gt;&amp;1 &amp;
kube-proxy â€“master=http://0.0.0.0:8080 &gt; /var/log/kube-proxy.log 2&gt;&amp;1 &amp;</p>

<h1 id="just-keep-this-script-running">just keep this script running</h1>
<p>while [[ true ]]; do
	sleep 1
done
ç„¶ååœ¨Dockerfileä¸­ï¼Œå°†start-kubernetes.shæŒ‡å®šä¸ºDockerå®¹å™¨é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å³å¯:</p>

<p>CMD [â€œstart-kubernetes.shâ€]
éœ€è¦æ³¨æ„çš„ä¸€ç‚¹åœ¨äºï¼Œstart-kubernetes.shè„šæœ¬å°†ä½œä¸ºDockerå®¹å™¨çš„1å·è¿›ç¨‹è¿è¡Œï¼Œå¿…é¡»å§‹ç»ˆä¿æŒè¿è¡Œã€‚å› ä¸ºDockerå®¹å™¨ä»…åœ¨1å·è¿›ç¨‹è¿è¡Œæ—¶ä¿æŒè¿è¡Œï¼Œæ¢è¨€ä¹‹ï¼ŒDockerå®¹å™¨å°†åœ¨1å·è¿›ç¨‹é€€å‡ºåExitedã€‚ç”±äºKubernetesçš„å„ä¸ªç»„ä»¶éƒ½ä»¥åå°è¿›ç¨‹æ–¹å¼æ‰§è¡Œï¼Œæˆ‘åœ¨è„šæœ¬æœ«å°¾æ·»åŠ äº†æ­»å¾ªç¯ï¼Œä»¥ä¿æŒstart-kubernetes.shè„šæœ¬å§‹ç»ˆå¤„äºè¿è¡ŒçŠ¶æ€ã€‚</p>

<h1 id="just-keep-this-script-running-1">just keep this script running</h1>
<p>while [[ true ]]; do
	sleep 1
done
ä¸‰. ä½¿ç”¨supervisorè¿è¡Œå¤šè¿›ç¨‹Dockerå®¹å™¨
Supervisoræ˜¯è¿›ç¨‹ç®¡ç†å·¥å…·ã€‚è¿™æ—¶ï¼Œéœ€è¦ç¼–å†™supervisorçš„é…ç½®æ–‡ä»¶kubernetes.conf:</p>

<p>[supervisord]
nodaemon=true</p>

<p>[program:etcd]
command=etcd â€“data-dir=/var/etcd/data
autorestart=true
stdout_logfile=/var/log/etcd.stdout.log
stderr_logfile=/var/log/etcd.stderr.log</p>

<p>[program:kube-apiserver]
command=kube-apiserver â€“service-cluster-ip-range=10.0.0.1/24 â€“insecure-bind-address=0.0.0.0 â€“etcd_servers=http://127.0.0.1:4001
autorestart=true
stdout_logfile=/var/log/kube-apiserver.stdout.log
stderr_logfile=/var/log/kube-apiserver.stderr.log</p>

<p>[program:kube-controller-manager]
command=kube-controller-manager â€“master=http://0.0.0.0:8080
autorestart=true
stdout_logfile=/var/log/controller-manager.stdout.log
stderr_logfile=/var/log/controller-manager.stderr.log</p>

<p>[program:kube-scheduler]
command=kube-scheduler â€“master=http://0.0.0.0:8080
autorestart=true
stdout_logfile=/var/log/kube-scheduler.stdout.log
stderr_logfile=/var/log/kube-scheduler.stderr.log</p>

<p>[program:kubelet]
command=kubelet â€“api_servers=http://0.0.0.0:8080 â€“address=0.0.0.0 â€“cluster_dns=10.0.0.10 â€“cluster_domain=â€kubernetes.localâ€ â€“pod-infra-container-image=â€kiwenlau/pause:0.8.0â€
autorestart=true
stdout_logfile=/var/log/kubelet.stdout.log
stderr_logfile=/var/log/kubelet.stderr.log</p>

<p>[program:kube-proxy]
command=kube-proxy â€“master=http://0.0.0.0:8080
autorestart=true
stdout_logfile=/var/log/kube-proxy.stdout.log
stderr_logfile=/var/log/kube-proxy.stderr.log</p>

<p>[program:docker]
command=docker daemon
autorestart=true
stdout_logfile=/var/log/docker.stdout.log
stderr_logfile=/var/log/docker.stderr.log
å¯çŸ¥ï¼Œå°†Kubernetesçš„å„ä¸ªç»„ä»¶çš„å¯åŠ¨å‘½ä»¤è®¾ä¸ºcommandå³å¯ã€‚autorestartå‚æ•°è®¾ä¸ºtrueï¼Œæ„å‘³ç€supervisorå°†è´Ÿè´£é‡å¯æ„å¤–é€€å‡ºçš„ç»„ä»¶ã€‚stdout_logfileå’Œstderr_logfileå‚æ•°åˆ™å¯ä»¥ç”¨äºè®¾ç½®å‘½ä»¤çš„æ ‡å‡†è¾“å‡ºæ–‡ä»¶å’Œæ ‡å‡†é”™è¯¯è¾“å‡ºæ–‡ä»¶ã€‚</p>

<p>ç„¶ååœ¨Dockerfileä¸­ï¼Œå°†supervisordæŒ‡å®šä¸ºDockerå®¹å™¨é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤å³å¯:</p>

<p>CMD [â€œsupervisordâ€, â€œ-câ€, â€œ/etc/supervisor/conf.d/kubernetes.confâ€]
æ­¤æ—¶, supervisordæ˜¯Dockerå®¹å™¨ä¸­çš„1å·è¿›ç¨‹ï¼Œä¹Ÿéœ€è¦å§‹ç»ˆä¿æŒè¿è¡ŒçŠ¶æ€ã€‚nodaemonè®¾ä¸ºtrueæ—¶ï¼Œè¡¨ç¤ºsupervisorä¿æŒå‰å°è¿è¡Œè€Œéåœ¨åå°è¿è¡Œã€‚è‹¥supervisoråœ¨åå°è¿è¡Œï¼Œåˆ™Dockerå®¹å™¨ä¹Ÿä¼šåœ¨æ‰§è¡Œsupervisordå‘½ä»¤åç«‹å³Exited.</p>

<p>[supervisord]
nodaemon=true
å››. æ€»ç»“
ä½¿ç”¨Shellè„šæœ¬è¿è¡Œå¤šè¿›ç¨‹Dockerå®¹å™¨ï¼Œä¼˜åŠ¿æ˜¯å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰ã€‚ç”±äºéœ€è¦ä¿æŒDockerå®¹å™¨çš„1å·è¿›ç¨‹å§‹ç»ˆè¿è¡Œï¼Œè¿™ä¸€ç‚¹æ¯”è¾ƒå®¹æ˜“å‡ºé”™ã€‚è‹¥è¦å®ç°è¿›ç¨‹æ„å¤–é€€å‡ºåè‡ªåŠ¨é‡å¯çš„è¯ï¼Œä½¿ç”¨shellè„šæœ¬æ¯”è¾ƒéº»çƒ¦ã€‚</p>

<p>ä½¿ç”¨supervisorè¿è¡Œå¤šè¿›ç¨‹Dockerå®¹å™¨ï¼Œéå¸¸æ–¹ä¾¿ã€‚å¦å¤–ï¼Œä¿æŒ1å·è¿›ç¨‹ä¿æŒè¿è¡Œï¼Œä»¥åŠè¿›ç¨‹æ„å¤–é€€å‡ºåè‡ªåŠ¨é‡å¯ï¼Œå®ç°èµ·æ¥éƒ½å¾ˆç®€å•ã€‚</p>

<p>ä½¿ç”¨å¤šä¸ªDockerå®¹å™¨è¿è¡ŒKubernetes
GitHubåœ°å€
https://github.com/kiwenlau/single-kubernetes-docker</p>

<!-- more -->
<p>https://docs.docker.com/config/containers/multi-service_container/</p>

<p>https://devops.stackexchange.com/questions/447/why-it-is-recommended-to-run-only-one-process-in-a-container</p>

<p>å¯¹äºspringbooté¡¹ç›®ï¼Œä¸€å¼€å§‹æ˜¯ç”¨java -jar æ–¹å¼å®¹å™¨ä¸­å¯åŠ¨ï¼Œå¹¶ä½œä¸ºå®¹å™¨çš„ä¸»è¿›ç¨‹ã€‚ä½†æµ‹è¯•ç¯å¢ƒï¼Œç»å¸¸ä»£ç é€»è¾‘å¯èƒ½æœ‰é—®é¢˜ï¼Œå¯¼è‡´ä¸»è¿›ç¨‹å¤±è´¥ï¼Œå®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œè¿›è€Œè§¦å‘marathon/k8så¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¿›è€Œä¸æ–­é‡å¯å®¹å™¨ã€‚å¼€å‘å‘¢ä¹Ÿä¸€ç›´æŠ±æ€¨çœ‹ä¸åˆ°â€œäº‹æ•…ç°åœºâ€ã€‚æ‰€ä»¥é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œç›´è§‚çš„æƒ³æ³•æ˜¯ ä¸è®©java -jar ä½œä¸ºå®¹å™¨çš„ä¸»è¿›ç¨‹ï¼Œè¿›è€Œäº§ç”Ÿä¸€ä¸ªåœ¨å®¹å™¨ä¸­è¿è¡Œå¤šè¿›ç¨‹çš„é—®é¢˜ã€‚</p>

<p>ä½†å®¹å™¨ä¸­è¿è¡Œå¤šè¿›ç¨‹ï¼Œè·Ÿ one process per container çš„ç†å¿µç›¸æ‚–ï¼Œæˆ‘ä»¬å°±å¾—æ¢å¯»ä¸‹æ¥é¾™å»è„‰äº†ã€‚</p>

<p>ä»ä¸šç•Œæ¥è¯´ï¼Œè™½ç„¶ä¸€ä¸ªå®¹å™¨ä¸€ä¸ªè¿›ç¨‹æ˜¯å®˜æ–¹æ¨èï¼Œä½†å¥½åƒå¹¶ä¸è¢«å¤§å‚æ‰€éµå®ˆï¼Œä»¥è‡³äºé˜¿é‡Œç”šè‡³ä¸“é—¨æäº†ä¸€ä¸ªPouchContainer å‡ºæ¥ï¼Œç¾å›¢å®¹å™¨å¹³å°æ¶æ„åŠå®¹å™¨æŠ€æœ¯å®è·µ</p>

<p>æ­¤å¤–è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€ä¸ªå®¹å™¨å¤šè¿›ç¨‹ åœ¨k8s çš„Pod æ¦‚å¿µä¸‹ï¼Œè¦ç›¸æœºåšå‡ºä¸€å®šçš„è°ƒæ•´ã€‚</p>

<p>ä¸ºä»€ä¹ˆæ¨èä¸€ä¸ªå®¹å™¨ä¸€ä¸ªè¿›ç¨‹ï¼Ÿ
stack exchange Why it is recommended to run only one process in a container? æœ‰ä¸€ç³»åˆ—å›ç­”</p>

<p>Run Multiple Processes in a Container ä¹Ÿæäº†ä¸‰ä¸ªadvantages</p>

<p>ç†ç”±è¦æ‰¾çš„è¯æœ‰å¾ˆå¤šï¼Œæ¯”è¾ƒå–œæ¬¢ä¸€ä¸ªå›ç­”ï¼šAs in most cases, itâ€™s not all-or-nothing. The guidance of â€œone process per containerâ€ stems from the idea that containers should serve a distinct purpose. For example, a container should not be both a web application and a Redis server.</p>

<p>There are cases where it makes sense to run multiple processes in a single container, as long as both processes support a single, modular function.</p>

<p>ä¸€ä¸ªå®¹å™¨å¤šä¸ªè¿›ç¨‹æœ‰ä»€ä¹ˆé£é™©
ç†è§£Dockerå®¹å™¨çš„è¿›ç¨‹ç®¡ç†</p>

<p>linux å¯¹pid=1è¿›ç¨‹çš„è¦æ±‚</p>

<p>ç®¡ç†å­¤å„¿è¿›ç¨‹ã€‚å½“ä¸€ä¸ªå­è¿›ç¨‹ç»ˆæ­¢åï¼Œå®ƒé¦–å…ˆä¼šå˜æˆä¸€ä¸ªâ€œå¤±æ•ˆ(defunct)â€çš„è¿›ç¨‹ï¼Œä¹Ÿç§°ä¸ºâ€œåƒµå°¸ï¼ˆzombieï¼‰â€è¿›ç¨‹ï¼Œç­‰å¾…çˆ¶è¿›ç¨‹æˆ–ç³»ç»Ÿæ”¶å›ï¼ˆreapï¼‰ã€‚å¦‚æœçˆ¶è¿›ç¨‹å·²ç»ç»“æŸäº†ï¼Œé‚£äº›ä¾ç„¶åœ¨è¿è¡Œä¸­çš„å­è¿›ç¨‹ä¼šæˆä¸ºâ€œå­¤å„¿ï¼ˆorphanedï¼‰â€è¿›ç¨‹ã€‚åœ¨Linuxä¸­Initè¿›ç¨‹(PID1)ä½œä¸ºæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œä¼šç»´æŠ¤è¿›ç¨‹æ ‘çš„çŠ¶æ€ï¼Œä¸€æ—¦æœ‰æŸä¸ªå­è¿›ç¨‹æˆä¸ºäº†â€œå­¤å„¿â€è¿›ç¨‹åï¼Œinitå°±ä¼šè´Ÿè´£æ¥ç®¡è¿™ä¸ªå­è¿›ç¨‹ã€‚å½“ä¸€ä¸ªå­è¿›ç¨‹æˆä¸ºâ€œåƒµå°¸â€è¿›ç¨‹ä¹‹åï¼Œå¦‚æœå…¶çˆ¶è¿›ç¨‹å·²ç»ç»“æŸï¼Œinitä¼šæ”¶å‰²è¿™äº›â€œåƒµå°¸â€ï¼Œé‡Šæ”¾PIDèµ„æºã€‚
å¦‚æœå®ƒæ²¡æœ‰æä¾›æŸä¸ªä¿¡å·çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå‘é€ç»™å®ƒçš„è¯¥ä¿¡å·éƒ½ä¼šè¢«å±è”½ã€‚init è¿›ç¨‹ä¸€èˆ¬ä¸å¤„ç† SIGTERM ä¿¡å·ï¼Œtheyâ€™re built for hardware shutdowns instead. åŸæœ¬æ˜¯é˜²æ­¢initè¿›ç¨‹è¢«è¯¯æ€ã€‚
docker stop å¯¹PID1è¿›ç¨‹ çš„è¦æ±‚</p>

<p>æ”¯æŒç®¡ç†è¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½äº§ç”Ÿçš„åƒµå°¸/å­¤å„¿è¿›ç¨‹
å®¹å™¨çš„PID1è¿›ç¨‹éœ€è¦èƒ½å¤Ÿæ­£ç¡®çš„å¤„ç†SIGTERMä¿¡å·æ¥æ”¯æŒä¼˜é›…é€€å‡ºï¼Œå¦‚æœå®¹å™¨ä¸­åŒ…å«å¤šä¸ªè¿›ç¨‹ï¼Œéœ€è¦PID1è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®çš„ä¼ æ’­SIGTERMä¿¡å·æ¥ç»“æŸæ‰€æœ‰çš„å­è¿›ç¨‹ä¹‹åå†é€€å‡ºã€‚
ç»¼ä¸Šï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨æœ‰å¤šä¸ªè¿›ç¨‹ï¼Œå¯é€‰çš„å®è·µæ–¹å¼ä¸ºï¼š</p>

<p>å¤šä¸ªè¿›ç¨‹å…³ç³»å¯¹ç­‰ï¼Œç”±ä¸€ä¸ªinit è¿›ç¨‹ç®¡ç†ï¼Œæ¯”å¦‚supervisorã€systemd
ä¸€ä¸ªè¿›ç¨‹ï¼ˆAï¼‰ä½œä¸ºä¸»è¿›ç¨‹ï¼Œæ‹‰èµ·å¦ä¸€ä¸ªè¿›ç¨‹ï¼ˆBï¼‰</p>

<p>A å…ˆæŒ‚ï¼Œå› ä¸ºå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸä¸ ä¸»è¿›ç¨‹ä¸€è‡´ï¼Œåˆ™è¿›ç¨‹B ä¹Ÿä¼šè¢«kill ç»“æŸ
B å…ˆæŒ‚ï¼Œåˆ™è¦çœ‹A æ˜¯å¦å…·å¤‡åƒµå°¸è¿›ç¨‹çš„å¤„ç†èƒ½åŠ›ï¼ˆå¤§éƒ¨åˆ†ä¸å…·å¤‡ï¼‰ã€‚è‹¥A ä¸å…·å¤‡ï¼ŒB æˆä¸ºåƒµå°¸è¿›ç¨‹ï¼Œå®¹å™¨å­˜ç»­æœŸé—´ï¼Œåƒµå°¸è¿›ç¨‹ä¸€è‡´å­˜åœ¨ã€‚
A é€šå¸¸ä¸æ”¯æŒ SIGTERM
æ‰€ä»¥ç¬¬äºŒç§æ–¹æ¡ˆé€šå¸¸ä¸å¯å–ï¼Œå¯¹äºç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåˆ™æœ‰init è¿›ç¨‹çš„é€‰å‹é—®é¢˜</p>

 	åƒµå°¸è¿›ç¨‹å›æ”¶	å¤„ç†SIGTERMä¿¡å·	alpine å®‰è£…å¤§å°	ä¸“ç”¨é•œåƒ	å¤‡æ³¨
<p>sh/bash	æ”¯æŒ	ä¸æ”¯æŒ	0m	 	è„šæœ¬ä¸­å¯ä»¥ä½¿ç”¨exec é¡¶æ›¿æ‰sh/bash è‡ªèº«
Supervisor	å¾…ç¡®è®¤	æ”¯æŒ	79m	 	 
runit	å¾…ç¡®è®¤	æ”¯æŒ	31m	phusion/baseimage-docker	 
s6	 	 	33m	 	 
ä¸€ä¸ªå®¹å™¨å¤šä¸ªè¿›ç¨‹çš„å¯èƒ½é€‰æ‹©
è‡ªå®šä¹‰è„šæœ¬
å®˜æ–¹ Run multiple services in a container</p>

<p>systemd
CHAPTER 3. USING SYSTEMD WITH CONTAINERS</p>

<p>Running Docker Containers with Systemd</p>

<p>Do you need to execute more than one process per container?</p>

<p>supervisor
å®˜æ–¹ Run multiple services in a container</p>

<p>Admatic Tech Blog: Starting Multiple Services inside a Container with Supervisord</p>

<p>ä½¿ç”¨</p>

<p>supervisord.conf</p>

<p>[supervisord]
nodaemon=true
logfile=/dev/stdout
loglevel=debug
logfile_maxbytes=0</p>

<p>[program:pinggoogle]
command=ping admatic.in
autostart=true
autorestart=true
startsecs=5
stdout_logfile=NONE
stderr_logfile=NONE
Dockerfile</p>

<p>FROM ubuntu
â€¦
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
â€¦
CMD [â€œ/usr/bin/supervisordâ€]
runit
Run Multiple Processes in a Container</p>

<p>A fullyÂ­ powered Linux environment typically includes an â€‹initâ€‹ process that spawns and supervises other processes, such as system daemons. The command defined in the CMD instruction of the Dockerfile is the only process launched inside the Docker container, so â€‹system daemons do not start automatically, even if properly installed.</p>

<p>runit - a UNIX init scheme with service supervision</p>

<p>ä½¿ç”¨
Dockerfile</p>

<p>FROM phusion/passenger-Â­ruby22</p>

<p>â€¦</p>

<p>#install custom bootstrap script as runit service
COPY myapp/start.sh /etc/service/myapp/run
myapp/start.sh</p>

<p>#!/bin/sh
exec command
åœ¨è¿™ä¸ªDockerfile ä¸­ï¼ŒCMD ç»§æ‰¿è‡ª base imageã€‚ å°†myapp/start.sh æ‹·è´åˆ° å®¹å™¨çš„ /etc/service/myapp/run æ–‡ä»¶ä¸­å³å¯ è¢«runit ç®¡ç†ï¼Œrunit ä¼šç®¡ç† /etc/service/ ä¸‹çš„åº”ç”¨ï¼ˆç›®å½•å¯é…ç½®ï¼‰ï¼Œå³ Each service is associated with a service directory</p>

<p>è¿™é‡Œè¦æ³¨æ„ï¼šè®°å¾—é€šè¿‡exec æ–¹å¼æ‰§è¡Œ commandï¼Œè¿™æ¶‰åŠåˆ° shellï¼Œexecï¼Œsourceæ‰§è¡Œè„šæœ¬çš„åŒºåˆ«</p>

<p>Using runit for maintaining services</p>

<p>runitï¼šè¿›ç¨‹ç®¡ç†å·¥å…·runit</p>

 	ä½œç”¨	å¤‡æ³¨
<p>runit-init	runit-init is the first process the kernel starts. If runit-init is started as process no 1, it runs and replaces itself with runit	 
runsvdir	starts and monitors a collection of runsv processes	å½“runsvdiræ£€æŸ¥åˆ°/etc/serviceç›®å½•ä¸‹åŒ…å«ä¸€ä¸ªæ–°çš„ç›®å½•æ—¶ï¼Œrunsvdirä¼šå¯åŠ¨ä¸€ä¸ªrunsvè¿›ç¨‹æ¥æ‰§è¡Œå’Œç›‘æ§runè„šæœ¬ã€‚
runsvchdir	change services directory of runsvdir	 
sv	control and manage services monitored by runsv	sv status /etc/service/test
sv stop /etc/service/test
sv restart /etc/service/test
runsv	starts and monitors a service and optionally an appendant log service	 
chpst	runs a program with a changed process state	runè„šæœ¬é»˜è®¤è¢«rootç”¨æˆ·æ‰§è¡Œï¼Œé€šè¿‡chpstå¯ä»¥å°†runé…ç½®ä¸ºæ™®é€šç”¨æˆ·æ¥æ‰§è¡Œã€‚
utmpset	logout a line from utmp and wtmp file	 
svlogd	runitâ€™s service logging daemon	 
runit å·¥ä½œåŸç†</p>

<p>s6
Managing multiple processes in Docker containers</p>

<p>Docker-friendliness image
ä¸å…¶åœ¨init è¿›ç¨‹å·¥å…·çš„é€‰å‹ä¸ŠæŒ£æ‰ï¼Œæ˜¯å¦æœ‰æ›´æœ‰é­„åŠ›çš„å·¥å…·å‘¢ï¼Ÿ</p>

<p>docker åŸç”Ÿæ”¯æŒå¤šè¿›ç¨‹ï¼Œæ¯”å¦‚é˜¿é‡Œçš„ pouch
åŸç”Ÿæ”¯æŒå¤šè¿›ç¨‹çš„ é•œåƒ
github æœ‰ä¸€ä¸ª phusion/baseimage-docker ç¬”è€…2018.11.7 çœ‹åˆ°æ—¶ï¼Œæœ‰6848ä¸ªstarã€‚ è¯¥é•œåƒæœ‰å‡ ä¸ªä¼˜ç‚¹ï¼š</p>

<p>Modifications for Docker-friendliness.
Administration tools that are especially useful in the context of Docker.
Mechanisms for easily running multiple processes, without violating the Docker philosophy. å…·ä½“çš„è¯´ï¼ŒThe Docker developers advocate running a single logical service inside a single container. But we are not disputing that. Baseimage-docker advocates running multiple OS processes inside a single container, and a single logical service can consist of multiple OS processes.
ä»€ä¹ˆå« ubuntu å¯¹ Docker-friendlinessï¼Ÿï¼ˆå¾…ä½“ä¼šï¼‰</p>

<p>multi-user
multi-process
ä¼˜é›…çš„ç®¡ç†springboot é¡¹ç›®
å›åˆ°æ–‡å¼€å§‹æåˆ°çš„é—®é¢˜ï¼š</p>

<p>phusion/baseimage-docker çš„image æ˜¯åŸºäºubuntuï¼Œç¬”è€…è¯•ç€ç”¨alpine + runit + sshd å®ç°äº†ä¸€ä¸ªç®€æ´çš„base imageï¼Œå…·ä½“æƒ…å†µå¾…å®è·µä¸€æ®µæ—¶é—´å†äº¤æµã€‚</p>

<p>å¤šè¿›ç¨‹æ–¹å¼ï¼Œä½¿å¾—ä¸ç®¡springboot æ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œå®¹å™¨éƒ½ä¼šå¯åŠ¨æˆåŠŸ
å¦å¤–é‡‡å– æªæ–½ç›‘æ§ springboot çš„å¥åº·çŠ¶æ€ï¼Œä»¥å†³å®šæ˜¯å¦ å‘è¯¥å®¹å™¨æ‰“å…¥æµé‡
runit æ­£å¸¸ä¼šå°è¯•ä¸æ–­é‡å¯ï¼Œå®é™…ä¸Šå¾€å¾€å› ä¸ºä»£ç çš„åŸå› ï¼Œå¯åŠ¨ä¸€æ¬¡å°±è¡Œäº†ã€‚å› æ­¤å¯åŠ¨springboot çš„æ—¶å€™ï¼Œå…ˆæ£€æŸ¥ä¸‹ æœ‰æ²¡æœ‰/etc/service/springboot/superviseï¼ˆrunsvå°†æœåŠ¡çš„çŠ¶æ€ä¿å­˜æœåŠ¡å¯¹åº”åœ¨superviseç›®å½•ä¸­ï¼‰ æ–‡ä»¶ï¼Œè‹¥æ²¡æœ‰åˆ™æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ã€‚æœ‰åˆ™æ˜¯ç¬¬äºŒæ¬¡å¯åŠ¨ï¼Œå†™å…¥/etc/service/springboot/downï¼ˆdown å‘ŠçŸ¥runsv åœæ­¢è¯¥æœåŠ¡ï¼‰</p>

<p>https://qiankunli.github.io/2018/11/06/multi_process_per_container.html</p>
:ET