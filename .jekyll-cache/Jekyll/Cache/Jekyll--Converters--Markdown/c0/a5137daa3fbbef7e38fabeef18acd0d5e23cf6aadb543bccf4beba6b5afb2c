I"f¾<p>ä¸€ã€å‰è¨€
å‰å‡ å¤©çš„å·¥ä½œä¸­ï¼Œéœ€è¦é€šè¿‡curlåšä¸€æ¬¡æ¥å£æµ‹è¯•ã€‚è®©æˆ‘æ„å¤–çš„æ˜¯ï¼Œé€šè¿‡$_POSTç«Ÿç„¶æ— æ³•è·å–åˆ°Content-Typeæ˜¯application/jsonçš„httpè¯·æ±‚çš„bodyå‚æ•°ã€‚
æŸ¥äº†ä¸‹phpå®˜ç½‘ï¼ˆhttp://php.net/manual/zh/reserved.variables.post.phpï¼‰å¯¹$_POSTçš„æè¿°ï¼Œçš„ç¡®æ˜¯è¿™æ ·ã€‚åæ¥é€šè¿‡file_get_contents(â€œphp://inputâ€)è·å–åˆ°äº†åŸå§‹çš„httpè¯·æ±‚bodyï¼Œç„¶åå¯¹å‚æ•°è¿›è¡Œjson_decodeè§£å†³äº†æ¥å£æµ‹è¯•çš„é—®é¢˜ã€‚äº‹åï¼Œè„‘å­é‡Œé¢å†’å‡ºäº†æŒºå¤šé—®é¢˜ï¼š</p>

<p>php-fpmæ˜¯æ€ä¹ˆè¯»å–å¹¶è§£æFastCGIåè®®çš„ï¼Ÿhttpè¯·æ±‚çš„headerå’Œbodyåˆ†åˆ«éƒ½å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ
å¯¹äºContent-Typeæ˜¯application/x-www-form-urlencodedçš„è¯·æ±‚ï¼Œä¸ºä»€ä¹ˆé€šè¿‡$_POSTå¯ä»¥æ‹¿åˆ°è§£æåçš„å‚æ•°æ•°ç»„ï¼Ÿ
å¯¹äºContent-Typeæ˜¯application/jsonçš„è¯·æ±‚ï¼Œä¸ºä»€ä¹ˆé€šè¿‡$_POSTæ‹¿ä¸åˆ°è§£æåçš„å‚æ•°æ•°ç»„ï¼Ÿ
<!-- more -->
åŸºäºè¿™å‡ ä¸ªé—®é¢˜ï¼Œå¯¹phpä»£ç è¿›è¡Œäº†ä¸€æ¬¡æ–°çš„å­¦ä¹ ï¼Œ æœ‰ä¸€å®šçš„æ”¶è·ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹ã€‚
æœ€åï¼Œç¼–å†™äº†ä¸€ä¸ªå«postjsonçš„phpæ‰©å±•ï¼Œå®ƒåœ¨æºä»£ç å±‚é¢å®ç°äº†featureï¼šå¯¹äºContent-Typeæ˜¯application/jsonçš„è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡$_POSTæ‹¿åˆ°è¯·æ±‚å‚æ•°ã€‚</p>

<p>äºŒã€fpmæ•´ä½“æµç¨‹
åœ¨åˆ†æä¹‹å‰ï¼Œæœ‰å¿…è¦å¯¹php-fpmæ•´ä½“æµç¨‹æœ‰æ‰€äº†è§£ã€‚åŒ…æ‹¬ä½ å¯èƒ½æƒ³çŸ¥é“çš„fpmè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ã€inié…ç½®æ–‡ä»¶ä½•æ—¶è¯»å–ï¼Œæ‰©å±•åœ¨å“ªé‡Œè¢«åŠ è½½ï¼Œè¯·æ±‚æ•°æ®åœ¨å“ªé‡Œè¢«è¯»å–ç­‰ç­‰ï¼Œè¿™é‡Œéƒ½ä¼šç¨å¾®æåŠä¸€ä¸‹ï¼Œè¿™æ ·çœ‹åé¢çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæ¯”è¾ƒæ¸…æ¥šï¼ŒæŸä¸€ä¸ªå‡½æ•°è°ƒç”¨å‘ç”Ÿåœ¨æ•´ä¸ªæµç¨‹çš„å“ªä¸€ä¸ªç¯èŠ‚ï¼Œåšåˆ°å¯è¯†åºå±±çœŸé¢ç›®ï¼Œå“ªæ€•èº«åœ¨æ­¤å±±ä¸­ã€‚
<img src="https://xiazemin.github.io/MyBlog/img/sapi_fpm.png" />
å’ŒNginxè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹ç±»ä¼¼ï¼Œfpmå¯åŠ¨è¿‡ç¨‹æœ‰3ç§è¿›ç¨‹è§’è‰²ï¼šå¯åŠ¨shellè¿›ç¨‹ã€fpm masterè¿›ç¨‹å’Œfpm workerè¿›ç¨‹ã€‚ä¸Šå›¾åˆ—å‡ºäº†å„ä¸ªè¿›ç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­æ‰§è¡Œçš„ä¸»è¦å‡½æ•°ï¼Œå…¶ä¸­æ ‡æœ‰é¢œè‰²çš„è¡¨ç¤ºå’Œä¸Šé¢çš„é—®é¢˜ç­”æ¡ˆæœ‰å…³è”çš„å‡½æ•°ã€‚ä¸‹é¢æ¦‚å†µçš„è¯´æ˜ä¸€ä¸‹ï¼š</p>

<p>å¯åŠ¨shellè¿›ç¨‹
1.sapi_startupï¼šSAPIå¯åŠ¨ã€‚å°†ä¼ å…¥çš„cgi_sapi_moduleçš„åœ°å€èµ‹å€¼ç»™å…¨å±€å˜é‡sapi_moduleï¼Œåˆå§‹åŒ–å…¨å±€å˜é‡SGï¼Œæœ€åæ‰§è¡Œphp_setup_sapi_content_typeså‡½æ•°ã€‚ã€è¿™ä¸ªå‡½æ•°åé¢ä¼šè¯¦ç»†è¯´æ˜ã€‘
2.php_module_startup ï¼šæ¨¡å—åˆå§‹åŒ–ã€‚php.iniæ–‡ä»¶çš„è§£æï¼ŒphpåŠ¨æ€æ‰©å±•.soçš„åŠ è½½ã€phpæ‰©å±•ã€zendæ‰©å±•çš„å¯åŠ¨éƒ½æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚</p>

<p>zend_startupï¼šå¯åŠ¨zendå¼•æ“ï¼Œè®¾ç½®ç¼–è¯‘å™¨ã€æ‰§è¡Œå™¨çš„å‡½æ•°æŒ‡é’ˆï¼Œåˆå§‹åŒ–ç›¸å…³HashTableç»“æ„çš„ç¬¦å·è¡¨CG(function_table)ã€CG(class_table)ä»¥åŠCG(auto_globals)ï¼Œæ³¨å†ŒZendæ ¸å¿ƒæ‰©å±•zend_builtin_moduleï¼ˆè¯¥è¿‡ç¨‹ä¼šæ³¨å†ŒZendå¼•æ“æä¾›çš„å‡½æ•°ï¼šfunc_get_argsã€strlenã€class_existsç­‰ï¼‰ï¼Œæ³¨å†Œæ ‡å‡†å¸¸é‡å¦‚E_ALLã€TRUEã€FALSEç­‰ã€‚
php_init_configï¼šè¯»å–php.inié…ç½®æ–‡ä»¶å¹¶è§£æï¼Œå°†è§£æçš„key-valueå¯¹å­˜å‚¨åˆ°configuration_hashè¿™ä¸ªhashtableä¸­ï¼Œå¹¶ä¸”å°†æ‰€æœ‰çš„phpæ‰©å±•ï¼ˆextension=xx.so)çš„æ‰©å±•åç§°ä¿å­˜åˆ°extension_lists.functionsç»“æ„ä¸­ï¼Œå°†æ‰€æœ‰çš„zendæ‰©å±•ï¼ˆzend_extension=xx.so)çš„æ‰©å±•åç§°ä¿å­˜åˆ°extension_lists.engineç»“æ„ä¸­ã€‚
php_startup_auto_globalsï¼šå‘CG(auth_globals)ä¸­æ³¨å†Œ_GETã€_POSTã€_COOKIEã€_SERVERç­‰è¶…å…¨å±€å˜é‡é’©å­ï¼Œåœ¨åé¢åˆé€‚çš„æ—¶æœºï¼ˆå®é™…ä¸Šæ˜¯php_hash_environmentï¼‰ä¼šå›è°ƒç›¸åº”çš„handlerã€‚
php_startup_sapi_content_typesï¼šè®¾ç½®sapi_moduleçš„default_post_readerå’Œtreat_dataã€‚ã€è¿™2ä¸ªå‡½æ•°åé¢ä¼šè¯¦ç»†è¯´æ˜ã€‘
php_ini_register_extensionsï¼šéå†extension_lists.functionsï¼Œä½¿ç”¨dlopenå‡½æ•°æ‰“å¼€xx.soæ‰©å±•æ–‡ä»¶ï¼Œå°†æ‰€æœ‰çš„phpæ‰©å±•æ³¨å†Œåˆ°å…¨å±€å˜é‡module_registryä¸­ï¼ŒåŒæ—¶å¦‚æœphpæ‰©å±•æœ‰å®ç°å‡½æ•°çš„è¯ï¼Œå°†å®ç°çš„å‡½æ•°æ³¨å†Œåˆ°CG(function_table)ã€‚éå†extension_lists.engineï¼Œä½¿ç”¨dlopenå‡½æ•°æ‰“å¼€xx.soæ‰©å±•æ–‡ä»¶ï¼Œå°†æ‰€æœ‰çš„zendæ‰©å±•æ³¨å†Œåˆ°å…¨å±€å˜é‡zend_extensionsä¸­ã€‚
zend_startup_modulesï¼šéå†module_registryï¼Œè°ƒç”¨æ‰€æœ‰phpæ‰©å±•çš„MINITå‡½æ•°ã€‚
zend_startup_extensionsï¼šéå†zend_extensionsï¼Œè°ƒç”¨æ‰€æœ‰zendæ‰©å±•çš„startupå‡½æ•°ã€‚
3.fpm_initï¼šfpmè¿›ç¨‹ç›¸å…³åˆå§‹åŒ–ã€‚è¿™ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒé‡è¦ã€‚è§£æphp-fpm.confã€fork masterè¿›ç¨‹ã€å®‰è£…ä¿¡å·å¤„ç†å™¨ã€æ‰“å¼€ç›‘å¬socketï¼ˆé»˜è®¤9000ç«¯å£ï¼‰éƒ½æ˜¯åœ¨è¿™é‡Œå®Œæˆçš„ã€‚å¯åŠ¨shellè¿›ç¨‹åœ¨forkä¹‹åä¸ä¹…å°±é€€å‡ºäº†ã€‚è€Œmasterè¿›ç¨‹åˆ™é€šè¿‡setsidè°ƒç”¨è„±ç¦»äº†åŸæ¥å¯åŠ¨shellçš„ç»ˆç«¯æ‰€åœ¨ä¼šè¯ï¼Œæˆä¸ºäº†daemonè¿›ç¨‹ã€‚é™äºç¯‡å¹…ï¼Œè¿™é‡Œä¸å†å±•å¼€ã€‚
masterè¿›ç¨‹
fpm_runï¼šæ ¹æ®php-fpm.confçš„é…ç½®fork workerè¿›ç¨‹ï¼ˆä¸€ä¸ªç›‘å¬ç«¯å£å¯¹åº”ä¸€ä¸ªworker poolå³è¿›ç¨‹æ± ï¼Œworkerè¿›ç¨‹ä»å±äºworker poolï¼Œåªå¤„ç†è¯¥ç›‘å¬ç«¯å£çš„è¯·æ±‚ï¼‰ã€‚ç„¶åè¿›å…¥fpm_event_loopå‡½æ•°ï¼Œæ— é™ç­‰å¾…äº‹ä»¶çš„åˆ°æ¥ã€‚
fpm_event_loopï¼šäº‹ä»¶å¾ªç¯ã€‚ä¸€ç›´ç­‰å¾…ç€ä¿¡å·äº‹ä»¶æˆ–è€…å®šæ—¶å™¨äº‹ä»¶çš„å‘ç”Ÿã€‚åŒºåˆ«äºNginxçš„masterè¿›ç¨‹ä½¿ç”¨suspendç³»ç»Ÿè°ƒç”¨æŒ‚èµ·è¿›ç¨‹ï¼Œfpm masteré€šè¿‡å¾ªç¯çš„è°ƒç”¨epoll_waitï¼ˆtimeoutä¸º1sï¼‰æ¥ç­‰å¾…äº‹ä»¶ã€‚
workerè¿›ç¨‹
fpm_init_requestï¼šåˆå§‹åŒ–requestå¯¹è±¡ã€‚è®¾ç½®requestçš„listen_socketä¸ºä»çˆ¶è¿›ç¨‹å¤åˆ¶è¿‡æ¥çš„ç›¸åº”worker poolå¯¹åº”çš„ç›‘å¬socketã€‚
fcgi_accept_requestï¼šç›‘å¬è¯·æ±‚è¿æ¥ï¼Œè¯»å–è¯·æ±‚çš„å¤´ä¿¡æ¯ã€‚</p>

<p>1.acceptç³»ç»Ÿè°ƒç”¨ï¼šå¦‚æœæ²¡æœ‰è¯·æ±‚åˆ°æ¥ï¼Œworkerè¿›ç¨‹ä¼šé˜»å¡åœ¨è¿™é‡Œã€‚ç›´åˆ°è¯·æ±‚åˆ°æ¥ï¼Œå°†è¿æ¥fdèµ‹å€¼ç»™requestå¯¹è±¡çš„fdå­—æ®µã€‚
2.select/pollç³»ç»Ÿè°ƒç”¨ï¼šå¾ªç¯çš„è°ƒç”¨selectæˆ–è€…pollï¼ˆtimeoutä¸º5s)ï¼Œç­‰å¾…ç€è¿æ¥fdä¸Šæœ‰å¯è¯»äº‹ä»¶ã€‚å¦‚æœè¿æ¥fdä¸€ç›´ä¸å¯è¯»ï¼Œworkerè¿›ç¨‹å°†ä¸€ç›´åœ¨è¿™é‡Œé˜»å¡ç€ã€‚
3.fcgi_read_requestï¼šä¸€æ—¦è¿æ¥fdä¸Šæœ‰å¯è¯»äº‹ä»¶ä¹‹åï¼Œä¼šè°ƒç”¨è¯¥å‡½æ•°å¯¹FastCGIåè®®è¿›è¡Œè§£æï¼Œè§£æå‡ºhttpè¯·æ±‚headerä»¥åŠfastcgi_paramå˜é‡å­˜å‚¨åˆ°requestçš„envå­—æ®µä¸­ã€‚
php_request_startupï¼šè¯·æ±‚åˆå§‹åŒ–</p>

<p>1.zend_activateï¼šé‡ç½®åƒåœ¾å›æ”¶å™¨ï¼Œåˆå§‹åŒ–ç¼–è¯‘å™¨ã€æ‰§è¡Œå™¨ã€è¯æ³•æ‰«æå™¨ã€‚
2.sapi_activateï¼šæ¿€æ´»SAPIï¼Œè¯»å–httpè¯·æ±‚bodyæ•°æ®ã€‚
3.php_hash_environmentï¼šå›è°ƒåœ¨php_startup_auto_globalså‡½æ•°ä¸­æ³¨å†Œçš„_GETï¼Œ_POSTï¼Œ_COOKIEç­‰è¶…å…¨å±€å˜é‡çš„é’©å­ï¼Œå®Œæˆè¶…å…¨å±€å˜é‡çš„ç”Ÿæˆã€‚
4.zend_activate_modulesï¼šè°ƒç”¨æ‰€æœ‰phpæ‰©å±•çš„RINITå‡½æ•°ã€‚
php_execute_scriptï¼šä½¿ç”¨Zend VMå¯¹phpè„šæœ¬æ–‡ä»¶è¿›è¡Œç¼–è¯‘ï¼ˆè¯æ³•åˆ†æ+è¯­æ³•åˆ†æï¼‰ç”Ÿæˆè™šæ‹Ÿæœºå¯è¯†åˆ«çš„opcodesï¼Œç„¶åæ‰§è¡Œè¿™äº›æŒ‡ä»¤ã€‚è¿™å—å¾ˆå¤æ‚ï¼Œä¹Ÿæ˜¯phpè¯­è¨€çš„ç²¾åæ‰€åœ¨ï¼Œé™äºç¯‡å¹…è¿™é‡Œä¸å±•å¼€ã€‚
php_request_shutdownï¼šè¯·æ±‚å…³é—­ã€‚è°ƒç”¨æ³¨å†Œçš„register_shutdown_functionå›è°ƒï¼Œè°ƒç”¨__destructææ„å‡½æ•°ï¼Œè°ƒç”¨æ‰€æœ‰phpæ‰©å±•çš„RSHUTDOWNå‡½æ•°ï¼Œflushè¾“å‡ºå†…å®¹ï¼Œå‘é€httpå“åº”headerï¼Œæ¸…ç†å…¨å±€å˜é‡ï¼Œå…³é—­ç¼–è¯‘å™¨ã€æ‰§è¡Œå™¨ï¼Œå…³é—­è¿æ¥fdç­‰ã€‚
æ³¨ï¼šå½“workerè¿›ç¨‹æ‰§è¡Œå®Œphp_request_shutdownåä¼šå†æ¬¡è°ƒç”¨fcgi_accept_requestå‡½æ•°ï¼Œå‡†å¤‡ç›‘å¬æ–°çš„è¯·æ±‚ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªworkerè¿›ç¨‹åªèƒ½é¡ºåºçš„å¤„ç†è¯·æ±‚ï¼Œåœ¨å¤„ç†å½“å‰è¯·æ±‚çš„è¿‡ç¨‹ä¸­ï¼Œè¯¥workerè¿›ç¨‹ä¸ä¼šæ¥å—æ–°çš„è¯·æ±‚è¿æ¥ï¼Œè¿™å’ŒNginx workerè¿›ç¨‹çš„äº‹ä»¶å¤„ç†æœºåˆ¶æ˜¯ä¸ä¸€æ ·çš„ã€‚
ä¸‰ã€FastCGIåè®®çš„å¤„ç†
è¨€å½’æ­£ä¼ ï¼Œè®©æˆ‘ä»¬å›åˆ°æœ¬æ–‡çš„ä¸»é¢˜ï¼Œä¸€æ­¥æ­¥æ¥å¼€$_POSTçš„é¢çº±ã€‚</p>

<p>å¤§å®¶éƒ½çŸ¥é“$_POSTå­˜å‚¨çš„æ˜¯å¯¹httpè¯·æ±‚bodyæ•°æ®è§£æåçš„æ•°ç»„ï¼Œä½†php-fpmå¹¶ä¸æ˜¯ä¸€ä¸ªweb serverï¼Œå®ƒå¹¶ä¸æ”¯æŒhttpåè®®ï¼Œä¸€èˆ¬å®ƒé€šè¿‡FastCGIåè®®æ¥å’Œweb serverå¦‚Apacheã€Nginxè¿›è¡Œæ•°æ®é€šä¿¡ã€‚å…³äºè¿™ä¸ªåè®®ï¼Œå·²ç»æœ‰å…¶ä»–åŒå­¦å†™çš„å¥½å‡ ç¯‡å¾ˆæ£’çš„æ–‡ç« æ¥è®²è¿°ï¼Œå¦‚æœå¯¹FastCGIä¸äº†è§£çš„ï¼Œå¯ä»¥å…ˆè¯»ä¸€ä¸‹è¿™äº›æ–‡ç« ã€‚</p>

<p>ä¸€ä¸ªFastCGIè¯·æ±‚ç”±ä¸‰éƒ¨åˆ†çš„æ•°æ®åŒ…ç»„æˆï¼šFCGI_BEGIN_REQUESTæ•°æ®åŒ…ã€FCGI_PARAMSæ•°æ®åŒ…ã€FCGI_STDINæ•°æ®åŒ…ã€‚
<img src="https://xiazemin.github.io/MyBlog/img/fcgi_fpm_content.png" /></p>

<p>FCGI_BEGIN_REQUESTè¡¨ç¤ºè¯·æ±‚çš„å¼€å§‹ï¼Œå®ƒåŒ…æ‹¬ï¼š</p>

<p>header
dataï¼šæ•°æ®éƒ¨åˆ†ï¼Œæ‰¿è½½ç€web serveræœŸæœ›fpmæ‰®æ¼”çš„è§’è‰²roleå­—æ®µ
FCGI_PARAMSä¸»è¦ç”¨æ¥ä¼ è¾“httpè¯·æ±‚çš„headerä»¥åŠfastcgi_paramå˜é‡æ•°æ®ï¼Œå®ƒåŒ…æ‹¬ï¼š</p>

<p>é¦–headerï¼šè¡¨ç¤ºFCGI_PARAMSçš„å¼€å§‹
dataï¼šæ‰¿è½½ç€httpè¯·æ±‚headerå’Œfastcgi_paramsä¿¡æ¯çš„key-valueå¯¹ç»„æˆçš„å­—ç¬¦ä¸²
paddingï¼šå¡«å……å­—æ®µ
å°¾headerï¼šè¡¨ç¤ºFCGI_PARAMSçš„ç»“æŸ
FCGI_STDINç”¨æ¥ä¼ è¾“httpè¯·æ±‚çš„bodyæ•°æ®ï¼Œå®ƒåŒ…æ‹¬ï¼š</p>

<p>é¦–headerï¼šè¡¨ç¤ºFCGI_STDINçš„å¼€å§‹
dataï¼šæ‰¿è½½ç€åŸå§‹çš„httpè¯·æ±‚bodyæ•°æ®
paddingï¼šå¡«å……å­—æ®µ
å°¾headerï¼šè¡¨ç¤ºFCGI_STDINçš„ç»“æŸ</p>

<p>phpå¯¹FastCGIåè®®æœ¬èº«çš„å¤„ç†ä¸Šï¼Œå¯ä»¥åˆ†ä¸ºäº†3ä¸ªé˜¶æ®µï¼šå¤´ä¿¡æ¯è¯»å–ã€bodyä¿¡æ¯è¯»å–ã€æ•°æ®åç½®å¤„ç†ã€‚ä¸‹é¢ä¸€ä¸€ä»‹ç»å„ä¸ªé˜¶æ®µéƒ½åšäº†äº›ä»€ä¹ˆã€‚
<img src="https://xiazemin.github.io/MyBlog/img/fpmarticlex.png" /></p>

<p>å¤´ä¿¡æ¯è¯»å–
å¤´ä¿¡æ¯è¯»å–é˜¶æ®µåªè¯»å–FCGI_BEGIN_REQUESTå’ŒFCGI_PARAMSæ•°æ®åŒ…ã€‚å› æ­¤åœ¨è¿™ä¸ªé˜¶æ®µåªèƒ½æ‹¿åˆ°httpè¯·æ±‚çš„headerä»¥åŠfastcgi_paramå˜é‡ã€‚åœ¨main/fastcgi.cä¸­fcgi_read_requestè´Ÿè´£å®Œæˆè¿™ä¸ªé˜¶æ®µçš„è¯»å–å·¥ä½œã€‚ä»ç¬¬äºŒèŠ‚å¯ä»¥çœ‹åˆ°ï¼Œå®ƒåœ¨workerè¿›ç¨‹å‘ç°è¯·æ±‚è¿æ¥fdå¯è¯»ä¹‹åè¢«è°ƒç”¨ã€‚</p>

<p>static int fcgi_read_request(fcgi_request *req)
{
    fcgi_header hdr;
    int len, padding;
    unsigned char buf[FCGI_MAX_LENGTH+8];
    â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è¯»å–åˆ°äº†FCGI_BEGIN_REQUESTçš„header
if (hdr.type == FCGI_BEGIN_REQUEST &amp;&amp; len == sizeof(fcgi_begin_request)) { 
    
    //è¯»å–FCGI_BEGIN_REQUESTçš„dataï¼Œå­˜å‚¨åˆ°bufé‡Œ
    if (safe_read(req, buf, len+padding) != len+padding) { 
        return 0;
    }

    ...
    //åˆ†æbufé‡ŒFCGI_BEGIN_REQUESTçš„dataä¸­FCGI_ROLEï¼Œä¸€èˆ¬æ˜¯RESPONDER
    switch ((((fcgi_begin_request*)buf)-&gt;roleB1 &lt;&lt; 8) + ((fcgi_begin_request*)buf)-&gt;roleB0) { 
        case FCGI_RESPONDER:
            fcgi_hash_set(&amp;req-&gt;env, FCGI_HASH_FUNC("FCGI_ROLE", sizeof("FCGI_ROLE")-1), "FCGI_ROLE", sizeof("FCGI_ROLE")-1, "RESPONDER", sizeof("RESPONDER")-1);
            break;
        case FCGI_AUTHORIZER:
            fcgi_hash_set(&amp;req-&gt;env, FCGI_HASH_FUNC("FCGI_ROLE", sizeof("FCGI_ROLE")-1), "FCGI_ROLE", sizeof("FCGI_ROLE")-1, "AUTHORIZER", sizeof("AUTHORIZER")-1);
            break;
        case FCGI_FILTER:
            fcgi_hash_set(&amp;req-&gt;env, FCGI_HASH_FUNC("FCGI_ROLE", sizeof("FCGI_ROLE")-1), "FCGI_ROLE", sizeof("FCGI_ROLE")-1, "FILTER", sizeof("FILTER")-1);
            break;
        default:
            return 0;
    }

    //ç»§ç»­è¯»ä¸‹ä¸€ä¸ªheader
    if (safe_read(req, &amp;hdr, sizeof(fcgi_header)) != sizeof(fcgi_header) ||
        hdr.version &lt; FCGI_VERSION_1) {
        return 0;
    }

    len = (hdr.contentLengthB1 &lt;&lt; 8) | hdr.contentLengthB0;
    padding = hdr.paddingLength;

    while (hdr.type == FCGI_PARAMS &amp;&amp; len &gt; 0) {
        //è¯»å–åˆ°äº†FCGI_PARAMSçš„é¦–headerï¼ˆheaderä¸­lenå¤§äº0ï¼Œè¡¨ç¤ºFCGI_PARAMSæ•°æ®åŒ…çš„å¼€å§‹ï¼‰
        if (len + padding &gt; FCGI_MAX_LENGTH) {
            return 0;
        }

        //è¯»å–FCGI_PARAMSçš„data
        if (safe_read(req, buf, len+padding) != len+padding) {
            req-&gt;keep = 0;
            return 0;
        }

        //è§£æFCGI_PARAMSçš„dataï¼Œå°†key-valueå¯¹å­˜å‚¨åˆ°req.envä¸­
        if (!fcgi_get_params(req, buf, buf+len)) {
            req-&gt;keep = 0;
            return 0;
        }

        //ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªheaderï¼Œä¸‹ä¸€ä¸ªheaderæœ‰å¯èƒ½ä»ç„¶æ˜¯FCGI_PARAMSçš„é¦–headerï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯FCGI_PARAMSçš„å°¾header
        if (safe_read(req, &amp;hdr, sizeof(fcgi_header)) != sizeof(fcgi_header) ||
            hdr.version &lt; FCGI_VERSION_1) {
            req-&gt;keep = 0;
            return 0;
        }
        len = (hdr.contentLengthB1 &lt;&lt; 8) | hdr.contentLengthB0;
        padding = hdr.paddingLength;
    }
}
...
return 1; } ä¸Šé¢çš„ä»£ç å¯ä»¥å’ŒFastCGIåè®®å¯¹ç…§ç€å»çœ‹ï¼Œè¿™ä¼šåŠ æ·±æˆ‘ä»¬å¯¹FastCGIåè®®çš„ç†è§£ã€‚
</code></pre></div></div>

<p>æ€»çš„æ¥è®²ï¼Œå¯¹äºFastCGIåè®®ï¼Œæ€»æ˜¯éœ€è¦å…ˆè¯»å–headerï¼Œæ ¹æ®headerä¸­å¸¦çš„ç±»å‹ä»¥åŠé•¿åº¦ç»§ç»­åšä¸åŒçš„å¤„ç†ã€‚</p>

<p>å½“è¯»å–åˆ°FCGI_PARAMSçš„dataæ—¶ï¼Œä¼šè°ƒç”¨fcgi_get_paramså‡½æ•°å¯¹dataè¿›è¡Œè§£æï¼Œå°†dataä¸­çš„http headerä»¥åŠfastcgi_paramså­˜å‚¨åˆ°req.envç»“æ„ä½“ä¸­ã€‚FCGI_PARAMSçš„dataæ ¼å¼æ˜¯ä»€ä¹ˆæ ·çš„å‘¢ï¼Ÿå®ƒæ˜¯ç”±ä¸€ä¸ªä¸ªçš„key-valueå¯¹ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œå¯¹äºkey-valueå¯¹ï¼Œé€šè¿‡keyLength+valueLength+key+valueçš„å½¢å¼æ¥æè¿°ï¼Œå› æ­¤FCGI_PARAMSçš„dataçš„æ ¼å¼ä¸€èˆ¬æ˜¯è¿™æ ·ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/FCGI_PARAMS.png" />
è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œä¸ºäº†èŠ‚çœç©ºé—´ï¼Œåœ¨Lengthå­—æ®µé•¿åº¦åˆ¶å®šä¸Šï¼Œé‡‡å–äº†é•¿çŸ­2ç§è¡¨ç¤ºæ³•ã€‚å¦‚æœkeyæˆ–è€…valueçš„Lengthä¸è¶…è¿‡127ï¼Œé‚£ä¹ˆç›¸åº”çš„Lengthå­—æ®µç”¨ä¸€ä¸ªcharæ¥è¡¨ç¤ºã€‚æœ€é«˜ä½æ˜¯0ï¼Œå¦‚æœç›¸åº”çš„Lengthå­—æ®µå¤§äº127ï¼Œé‚£ä¹ˆç›¸åº”çš„Lengthå­—æ®µç”¨4ä¸ªcharæ¥è¡¨ç¤ºï¼Œç¬¬ä¸€ä¸ªcharçš„æœ€é«˜ä½æ˜¯1ã€‚å¤§éƒ¨åˆ†httpä¸­çš„headerä»¥åŠfastcgi_paramså˜é‡çš„key-valueçš„é•¿åº¦å…¶å®éƒ½æ˜¯ä¸è¶…è¿‡127çš„ã€‚</p>

<p>ä¸¾ä¸ªæ —å­ï¼Œåœ¨æˆ‘çš„vmç¯å¢ƒä¸‹ï¼Œæ‰§è¡Œå¦‚ä¸‹curlå‘½ä»¤ï¼šcurl -H â€œContent-Type: application/jsonâ€ -d â€˜{â€œaâ€:1}â€™ http://10.179.195.72:8585/test/jiweibinï¼Œä¸‹é¢æ˜¯æˆ‘gdbæ—¶FCGI_PARAMSçš„dataçš„ç»“æœï¼š</p>

<p>\017?SCRIPT_FILENAME/home/weibin/codedir/mis_deploy/mis/src/index.php/test/jiweibin\f\000QUERY_STRING\016\004REQUEST_METHODPOST\f\020CONTENT_TYPEapplication/json\016\001CO
NTENT_LENGTH7\v SCRIPT_NAME/mis/src/index.php/test/jiâ€¦
å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªkey-valueå¯¹æ˜¯â€017?SCRIPT_FILENAME/home/weibin/codedir/mis_deploy/mis/src/index.php/test/jiweibinâ€ï¼ŒkeyLengthæ˜¯â€™017â€™ï¼Œå®ƒæ˜¯8è¿›åˆ¶ï¼Œè½¬æˆåè¿›åˆ¶æ˜¯15ï¼ŒvalueLengthæ˜¯å­—ç¬¦â€™?â€™ï¼Œå­—ç¬¦â€™?â€™å¯¹åº”çš„æ•°å€¼æ˜¯63ï¼Œä¹Ÿå°±æ˜¯valueLengthæ˜¯63ï¼Œå› æ­¤æŒ‰keyLengthå¾€åè¯»å–15ä¸ªé•¿åº¦çš„å­—ç¬¦ï¼Œå–åˆ°äº†keyæ˜¯ï¼šâ€SCRIPT_FILENAMEâ€ï¼Œç»§ç»­å‰ç§»è¯»å–63ä¸ªå­—ç¬¦ï¼Œå–åˆ°valueæ˜¯ï¼šâ€/home/weibin/codedir/mis_deploy/mis/src/index.php/test/jiweibinâ€ã€‚ä»¥æ­¤ç±»æ¨ï¼Œæˆ‘ä»¬è§£æå‡ºä¸€ä¸ªä¸ªkey-valueå¯¹ï¼Œå¯ä»¥çœ‹åˆ°CONTENT_TYPE=application/jsonä¹Ÿåœ¨å…¶ä¸­ã€‚</p>

<p>åœ¨fcgi_get_paramsé‡Œé¢è§£æäº†æŸä¸€ä¸ªkey-valueå¯¹ä¹‹åï¼Œä¼šè°ƒç”¨fcgi_hash_setå‡½æ•°å°†key-valueå­˜å‚¨åˆ°req.envç»“æ„ä½“ä¸­ã€‚req.envç»“æ„ä½“çš„ç±»å‹æ˜¯fcgi_hashï¼š</p>

<p>typedef struct _fcgi_hash {
    fcgi_hash_bucket  *hash_table[FCGI_HASH_TABLE_SIZE]; //hashtableï¼Œå…±128ä¸ªslotï¼Œæ¯ä¸€ä¸ªslotå­˜å‚¨ç€æŒ‡å‘bucketçš„æŒ‡é’ˆ
    fcgi_hash_bucket  *list; //æŒ‰æ’å…¥é¡ºåºçš„é€†åºæ’åˆ—çš„bucketé“¾è¡¨å¤´æŒ‡é’ˆ
    fcgi_hash_buckets *buckets; //å­˜å‚¨bucketçš„ç‰©ç†å†…å­˜
    fcgi_data_seg     *data; //å­˜å‚¨å­—ç¬¦ä¸²çš„å †å†…å­˜é¦–åœ°å€
}   ;
è¿™ä¸ªhashtableçš„å®ç°é‡‡ç”¨äº†æ™®éé‡‡ç”¨çš„é“¾åœ°å€æ³•æ€è·¯ï¼Œä¸è¿‡bucketçš„å†…å­˜åˆ†é…ï¼ˆmallocï¼‰å¹¶ä¸æ˜¯æ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œçš„ï¼Œè€Œæ˜¯åœ¨hashåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§é¢„åˆ†é…ä¸€ä¸ªå¤§å°ä¸º128çš„è¿ç»­çš„æ•°ç»„ã€‚ä¸Šé¢çš„bucketsæŒ‡é’ˆæŒ‡å‘è¿™æ®µå†…å­˜ã€‚åŒæ—¶hashtableè¿˜ç»´æŠ¤äº†ä¸€ä¸ªæŒ‰ç…§å…ƒç´ æ’å…¥é¡ºåºé€†åºæ’åˆ—çš„å…¨å±€å•é“¾è¡¨ï¼ŒlistæŒ‡å‘äº†è¿™ä¸ªé“¾è¡¨çš„å¤´å…ƒç´ ã€‚æ¯ä¸€ä¸ªbucketå…ƒç´ åŒ…æ‹¬å¯¹keyè¿›è¡Œhashä¹‹åçš„hash_valueã€keyçš„lengthã€keyçš„å­—ç¬¦æŒ‡é’ˆã€valueçš„lengthã€valueçš„å­—ç¬¦æŒ‡é’ˆã€ç›¸åŒslotä¸­ä¸‹ä¸ªbucketå…ƒç´ æŒ‡é’ˆï¼Œå…¨å±€å•é“¾è¡¨çš„ä¸‹ä¸€ä¸ªbucketå…ƒç´ æŒ‡é’ˆã€‚bucketä¸­keyå’Œvalueå¹¶ä¸ç›´æ¥å­˜å‚¨å­—ç¬¦æ•°ç»„ï¼ˆå› ä¸ºé•¿åº¦æœªçŸ¥ï¼‰ï¼Œè€Œåªæ˜¯å­˜å‚¨å­—ç¬¦æŒ‡é’ˆï¼ŒçœŸæ­£çš„å­—ç¬¦æ•°ç»„å­˜å‚¨åœ¨hashtableçš„dataæŒ‡å‘çš„å†…å­˜ä¸­ã€‚</p>

<p>ä¸‹å›¾å±•ç¤ºäº†å½“æˆ‘è§£æå‡ºFCGI_ROLEï¼ˆé€šè¿‡è§£æFCGI_BEGIN_REQUESTï¼‰ä»¥åŠç¬¬ä¸€ä¸ªkey-valueå¯¹ï¼ˆSCRIPT_FILENAME=â€/home/weibinâ€¦â€œï¼‰æ—¶ï¼Œå†…å­˜çš„ç¤ºæ„å›¾ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/params_articlex.png" /></p>

<p>bodyä¿¡æ¯è¯»å–
è¯¥é˜¶æ®µè´Ÿè´£å¤„ç†FCGI_STDINæ•°æ®åŒ…ï¼Œè¿™ä¸ªæ•°æ®åŒ…æ‰¿è½½ç€åŸå§‹http postè¯·æ±‚çš„bodyæ•°æ®ã€‚</p>

<p>ä¹Ÿè®¸ä½ ä¼šæƒ³ï¼Œä¸ºä»€ä¹ˆåœ¨å¤´ä¿¡æ¯è¯»å–çš„æ—¶å€™ï¼Œä¸åŒæ—¶å°†bodyæ•°æ®è¯»å–å‡ºæ¥å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ºäº†é€‚é…å¤šç§Content-Typeä¸åŒçš„è¡Œä¸ºã€‚</p>

<p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åšä¸‹å®éªŒï¼Œé’ˆå¯¹Content-Typeä¸ºmultipart/form-dataç±»å‹çš„è¯·æ±‚ï¼Œä»$_POSTå¯ä»¥æ‹¿åˆ°bodyæ•°æ®ï¼Œä½†å´ä¸èƒ½é€šè¿‡php://inputè·å–åˆ°åŸå§‹çš„bodyæ•°æ®æµã€‚è€Œå¯¹äºContent-Typeä¸ºx-www-form-urlencodedçš„è¯·æ±‚ï¼Œè¿™2è€…æ˜¯éƒ½å¯ä»¥è·å–åˆ°çš„ã€‚</p>

<p>ä¸‹è¡¨æ€»ç»“äº†3ç§ä¸åŒçš„Content-Typeçš„è¡Œä¸ºå·®å¼‚ï¼Œæœ¬èŠ‚æˆ‘ä»¬è¯´æ˜php://inputçš„è¡Œä¸ºå·®å¼‚åŸå› ä¹‹æ‰€åœ¨ï¼Œè€Œ$_POSTçš„å·®å¼‚åˆ™è¦åœ¨ä¸‹ä¸€èŠ‚è¿›è¡Œè®²è§£ã€‚
<img src="https://xiazemin.github.io/MyBlog/img/content_articlex.png" />
åœ¨bodyä¿¡æ¯è¯»å–é˜¶æ®µï¼Œå¯¹ä¸åŒçš„Content-Typeå·®å¼‚åŒ–å¤„ç†çš„å…³é”®èŠ‚ç‚¹å‘ç”Ÿåœ¨sapi_read_post_dataå‡½æ•°ï¼Œè§ä¸‹å›¾ï¼Œå±•ç¤ºäº†å·®å¼‚åŒ–å¤„ç†çš„æ•´ä½“æµç¨‹ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/sapi_read_post_data.png" /></p>

<p>ä¸‹é¢æˆ‘ä»¬åŸºäºä¸Šå›¾ï¼Œç»“åˆç€ä»£ç è¿›è¡Œè¯¦ç»†åˆ†æã€‚ï¼ˆä»£ç å¯èƒ½ä¼šç¨å¾®å¤šä¸€ç‚¹ï¼Œè¿™å—ä»£ç æ¯”è¾ƒæ ¸å¿ƒï¼Œä¸æ˜¯å¾ˆå¥½é€šè¿‡å›¾çš„æ–¹å¼å»ç”»ï¼‰</p>

<p>fpmåœ¨æ¥æ”¶åˆ°è¯·æ±‚è¿æ¥å¹¶ä¸”è¯»å–å¹¶è§£æå®Œå¤´ä¿¡æ¯ä¹‹åï¼Œä¼šè°ƒç”¨php_request_startupæ‰§è¡Œè¯·æ±‚åˆå§‹åŒ–ã€‚å®ƒåˆè°ƒç”¨sapi_activateå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­å¦‚æœå½“å‰è¯·æ±‚æ˜¯POSTè¯·æ±‚ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨sapi_read_post_dataå‡½æ•°å¯¹bodyæ•°æ®è¿›è¡Œè¯»å–ã€‚</p>

<p>SAPI_API void sapi_activate(void)
{
    â€¦
    /* Handle request method <em>/
    if (SG(server_context)) {
        if (PG(enable_post_data_reading)
        &amp;&amp;  SG(request_info).content_type
        &amp;&amp;  SG(request_info).request_method
        &amp;&amp; !strcmp(SG(request_info).request_method, â€œPOSTâ€)) {
            /</em> HTTP POST may contain form data to be processed into variables
             * depending on given content type */
            sapi_read_post_data();   //æ ¹æ®ä¸åŒçš„Content-Typeè¿›è¡Œpostæ•°æ®çš„è¯»å–
        } else {
            SG(request_info).content_type_dup = NULL;
        }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ...
}
... } è€Œåœ¨sapi_read_post_dataä¸­ï¼Œä¼šé¦–å…ˆä»SG(known_post_content_types)è¿™ä¸ªhashtableä¸­æŸ¥è¯¢æ˜¯å¦æœ‰å¯¹åº”çš„é’©å­ï¼Œå¦‚æœæœ‰åˆ™è°ƒç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚
</code></pre></div></div>

<p>static void sapi_read_post_data(void)
{
    â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* now try to find an appropriate POST content handler */
if ((post_entry = zend_hash_str_find_ptr(&amp;SG(known_post_content_types), content_type,
        content_type_length)) != NULL) { //content_typeå·²æ³¨å†Œé’©å­
    /* found one, register it for use */
    SG(request_info).post_entry = post_entry; //å°†é’©å­ä¿å­˜åˆ°SG
    post_reader_func = post_entry-&gt;post_reader; //é’©å­ä¸­çš„post_readerå‡½æ•°æŒ‡é’ˆèµ‹å€¼ç»™post_reader_func
} else {
    /* fallback */
    SG(request_info).post_entry = NULL;
    if (!sapi_module.default_post_reader) {
        /* no default reader ? */
        SG(request_info).content_type_dup = NULL;
        sapi_module.sapi_error(E_WARNING, "Unsupported content type:  '%s'", content_type);
        return;
    }
}
...

if(post_reader_func) { //å¦‚æœpost_reader_funcä¸ä¸ºç©ºï¼Œæ‰§è¡Œpost_reader_func
    post_reader_func();
}

//å¦åˆ™ï¼Œæ‰§è¡Œé»˜è®¤çš„å¤„ç†é€»è¾‘ï¼ˆä¹‹æ‰€ä»¥post_reader_funcå’Œsapi_module.default_post_readeräº’æ–¥ï¼Œå…³é”®çš„é€»è¾‘åœ¨sapi_module.default_post_readeré‡Œé¢å®ç°ï¼‰
if(sapi_module.default_post_reader) { 
    sapi_module.default_post_reader();
} } SG(known_post_content_types)ä¸­ä¸ºå“ªäº›Content-Typeå®‰è£…äº†é’©å­å‘¢ï¼Ÿç­”æ¡ˆæ˜¯åªæœ‰2ç§ï¼šapplication/x-www-form-urlencodedå’Œmultipart/form-dataã€‚åœ¨ç¬¬äºŒèŠ‚æ›¾ç»æåˆ°ï¼Œåœ¨SAPIå¯åŠ¨é˜¶æ®µï¼Œä¼šæ‰§è¡Œä¸€ä¸ªç¥ç§˜å‡½æ•°php_setup_sapi_content_typesï¼Œå®ƒä¼šéå†php_post_entriesæ•°ç»„ï¼Œå°†ä¸Šé¢2ä¸ªContent-Typeå¯¹åº”çš„é’©å­æ³¨å†Œåˆ°SGçš„known_post_content_typesè¿™ä¸ªhashtableä¸­ã€‚
</code></pre></div></div>

<p>#define DEFAULT_POST_CONTENT_TYPE â€œapplication/x-www-form-urlencodedâ€ 
#define MULTIPART_CONTENT_TYPE â€œmultipart/form-dataâ€</p>

<p>int php_setup_sapi_content_types(void) 
{
    sapi_register_post_entries(php_post_entries);  //å®‰è£…å†…ç½®çš„Content_Typeå¤„ç†é’©å­</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return SUCCESS; }
</code></pre></div></div>

<p>static sapi_post_entry php_post_entries[] = { 
    { DEFAULT_POST_CONTENT_TYPE, sizeof(DEFAULT_POST_CONTENT_TYPE)-1, sapi_read_standard_form_data, php_std_post_handler },
    { MULTIPART_CONTENT_TYPE,    sizeof(MULTIPART_CONTENT_TYPE)-1,    NULL,                         rfc1867_post_handler },
    { NULL, 0, NULL, NULL }
};</p>

<p>struct _sapi_post_entry {
    char <em>content_type;
    uint content_type_len;
    void (</em>post_reader)(void); //postæ•°æ®è¯»å–å‡½æ•°æŒ‡é’ˆ
    void (*post_handler)(char *content_type_dup, void *arg); //postæ•°æ®åç½®å¤„ç†å‡½æ•°æŒ‡é’ˆï¼Œè§ä¸‹ä¸€å°èŠ‚
};</p>

<p>typedef struct _sapi_post_entry sapi_post_entry;
é’©å­åŒ…å«äº†2ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œpost_readeråœ¨æœ¬é˜¶æ®µä¼šè¢«è°ƒç”¨ï¼Œè€Œpost_handlerä¼šåœ¨æ•°æ®åç½®å¤„ç†é˜¶æ®µè¢«è°ƒç”¨ã€‚ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹åˆ°ï¼Œphpä¸ºapplication/x-www-form-urlencodedå®‰è£…çš„é’©å­çš„post_readerå‡½æ•°æŒ‡é’ˆæŒ‡å‘sapi_read_standard_form_dataï¼Œè€Œmultipart/form-dataè™½ç„¶é’©å­å·²å®‰è£…ï¼Œä½†æ˜¯post_readerå‡½æ•°æŒ‡é’ˆä¸ºNULLï¼Œæ‰€ä»¥åœ¨æœ¬é˜¶æ®µä¸è¿›è¡Œä»»ä½•å¤„ç†ã€‚</p>

<p>è®©æˆ‘ä»¬ç»§ç»­è·Ÿè¸ªsapi_read_standard_form_dataéƒ½å¹²äº†äº›ä»€ä¹ˆï¼Œå®ƒçš„æ•´ä½“æµç¨‹å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/sapi_read_standard_form_data.png" />
é¦–å…ˆï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªphpstreamï¼Œå¹¶å°†SG(request_info).request_bodyæŒ‡å‘è¿™ä¸ªphpstreamï¼ˆphpstreamæ˜¯phpå¯¹ioçš„å°è£…ï¼Œæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸å±•å¼€ï¼‰ã€‚ç„¶åè°ƒç”¨sapi_read_post_blockå‡½æ•°è¯»å–htt ppostè¯·æ±‚çš„bodyæ•°æ®ï¼Œå†…éƒ¨å®ƒä¼šè°ƒç”¨sapi_cgi_read_postå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ¤æ–­å¤´ä¿¡æ¯é‡Œæ˜¯å¦å­˜åœ¨REQUEST_BODY_FILEå­—æ®µï¼ˆREQUEST_BODY_FILEç”¨æ¥åœ¨nginxå’Œfpmä¼ é€’sizeç‰¹åˆ«å¤§çš„bodyæ—¶æˆ–è€…ä¼ é€’ä¸Šä¼ çš„æ–‡ä»¶æ—¶åªä¼ é€’æ–‡ä»¶åï¼Œè¿™é‡Œä¸å±•å¼€ï¼‰ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥è¯»REQUEST_BODY_FILEå¯¹åº”çš„æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰åˆ™è°ƒç”¨fcgi_readå‡½æ•°è§£æFCGI_STDINæ•°æ®åŒ…ã€‚æœ€åå°†è¯»å–çš„æ•°æ®å†™å…¥åˆ°ä¹‹å‰åˆ›å»ºçš„phpstreamä¸­ã€‚</p>

<p>php://inputå…¶å®å°±æ˜¯åŸºäºè¿™ä¸ªstreamåšçš„è¯»å–åŒ…è£…ã€‚å¯¹äºmultipart/form-dataï¼Œç”±äºå®‰è£…çš„é’©å­ä¸­post_readeræ˜¯NULLï¼Œåœ¨æœ¬é˜¶æ®µå¹¶æœªåšä»»ä½•äº‹å„¿ï¼Œå› æ­¤æ— æ³•é€šè¿‡php://inputè·å–åˆ°åŸå§‹çš„post bodyæ•°æ®æµã€‚</p>

<p>ä¸‹é¢å¯¹ç…§ç€ä¸Šé¢çš„æµç¨‹ï¼Œè·Ÿè¸ªä¸‹ä»£ç ï¼š</p>

<p>SAPI_API SAPI_POST_READER_FUNC(sapi_read_standard_form_data)
{
    //åˆ›å»ºphpstream
    SG(request_info).request_body = php_stream_temp_create_ex(TEMP_STREAM_DEFAULT, SAPI_POST_BLOCK_SIZE, PG(upload_tmp_dir));</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (sapi_module.read_post) {
    size_t read_bytes;

    for (;;) {
        char buffer[SAPI_POST_BLOCK_SIZE];

        //è°ƒç”¨sapi_module.read_postè¯»å–FCGI_STDINæ•°æ®åŒ…
        read_bytes = sapi_read_post_block(buffer, SAPI_POST_BLOCK_SIZE);

        if (read_bytes &gt; 0) {
            //å°†bodyæ•°æ®å†™åˆ°SG(request_info).request_bodyè¿™ä¸ªphpstream
            if (php_stream_write(SG(request_info).request_body, buffer, read_bytes) != read_bytes) {
               ...
            }
        }
        ...
        if (read_bytes &lt; SAPI_POST_BLOCK_SIZE) {
            /* done */
            break;
        }
    }
    php_stream_rewind(SG(request_info).request_body);
} } sapi_read_post_blockå†…éƒ¨ä¼šè°ƒç”¨sapi_module.read_postå‡½æ•°æŒ‡é’ˆï¼Œè€Œå¯¹äºphp-fpmè€Œè¨€ï¼Œsapi_module.read_postæŒ‡å‘sapi_cgi_read_postå‡½æ•°ï¼Œè¯¥å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨fcgi_readè¯»å–FCGI_STDINæ•°æ®æµã€‚
</code></pre></div></div>

<p>static sapi_module_struct cgi_sapi_module = {
    â€œfpm-fcgiâ€,                     /* name <em>/
    â€¦
    sapi_cgi_read_post,             /</em> read POST data <em>/ 
    sapi_cgi_read_cookies,          /</em> read Cookies */
    â€¦
    STANDARD_SAPI_MODULE_PROPERTIES
};</p>

<p>static size_t sapi_cgi_read_post(char *buffer, size_t count_bytes)
{
    â€¦
    while (read_bytes &lt; count_bytes) {
        â€¦
        if (request_body_fd == -1) {
            //æ£€æŸ¥æ˜¯å¦æœ‰REQUEST_BODY_FILEå¤´
            char *request_body_filename = FCGI_GETENV(request, â€œREQUEST_BODY_FILEâ€);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        if (request_body_filename &amp;&amp; *request_body_filename) {
            request_body_fd = open(request_body_filename, O_RDONLY);
            ...
        }
    }

    /* If REQUEST_BODY_FILE variable not available - read post body from fastcgi stream */
    if (request_body_fd &lt; 0) {
        //å¦‚æœæ²¡æœ‰REQUEST_BODY_FILEå¤´ï¼Œç»§ç»­æŒ‰ç…§FastCGIåè®®è¯»å–FCGI_STDINæ•°æ®åŒ…
        tmp_read_bytes = fcgi_read(request, buffer + read_bytes, count_bytes - read_bytes);
    } else {
        //å¦‚æœæœ‰REQUEST_BODY_FILEå¤´ï¼Œä»æ–‡ä»¶è¯»å–bodyæ•°æ®
        tmp_read_bytes = read(request_body_fd, buffer + read_bytes, count_bytes - read_bytes);
    }
    ...
    read_bytes += tmp_read_bytes;
}
return read_bytes; }
</code></pre></div></div>

<p>int fcgi_read(fcgi_request *req, char *str, int len)
{
    int ret, n, rest;
    fcgi_header hdr;
    unsigned char buf[255];</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>n = 0;
rest = len;
while (rest &gt; 0) {
    if (req-&gt;in_len == 0) { //ç¬¬ä¸€æ¬¡å¾ªç¯ï¼Œè¯»å–header
        if (safe_read(req, &amp;hdr, sizeof(fcgi_header)) != sizeof(fcgi_header) ||
            hdr.version &lt; FCGI_VERSION_1 ||
            hdr.type != FCGI_STDIN) { //å¦‚æœheaderä¸æ˜¯STDINï¼Œå¼‚å¸¸é€€å‡º
            req-&gt;keep = 0;
            return 0;
        }
        req-&gt;in_len = (hdr.contentLengthB1 &lt;&lt; 8) | hdr.contentLengthB0;
        req-&gt;in_pad = hdr.paddingLength;
        if (req-&gt;in_len == 0) {
            return n;
        }
    }
    
    //è¯»å–FCGI_STDINçš„data
    if (req-&gt;in_len &gt;= rest) {
        ret = (int)safe_read(req, str, rest);
    } else {
        ret = (int)safe_read(req, str, req-&gt;in_len);
    }
    ...
}
return n; } è‡³æ­¤ï¼Œæˆ‘ä»¬è·Ÿè¸ªå®Œæˆäº†application/x-www-form-urlencodedçš„æ•´ä¸ªbodyè¯»å–è¿‡ç¨‹ã€‚
</code></pre></div></div>

<p>å†å›è¿‡å¤´æ¥çœ‹ä¸‹application/jsonï¼Œç”±äºå¹¶æ²¡æœ‰ä¸ºå®ƒå®‰è£…é’©å­ï¼Œåœ¨sapi_read_post_dataæ—¶ï¼Œä½¿ç”¨é»˜è®¤çš„å¤„ç†æ–¹å¼ã€‚è¿™é‡Œçš„é»˜è®¤è¡Œä¸ºä¼šæ‰§è¡Œsapi_module.default_post_readerå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ã€‚è€Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæŒ‡å‘å“ªä¸ªå‡½æ•°å‘¢ï¼Ÿ</p>

<p>åœ¨ç¬¬äºŒèŠ‚è®²åˆ°çš„php_module_startupå‡½æ•°ä¸­æœ‰ä¸€ä¸ªphp_startup_sapi_content_typeså‡½æ•°ï¼Œå®ƒä¼šæŒ‡å®šsapi_module.default_post_readeræ˜¯php_default_post_readerã€‚</p>

<p>int php_startup_sapi_content_types(void)
{
    sapi_register_default_post_reader(php_default_post_reader); //è®¾ç½®default_post_reader
    sapi_register_treat_data(php_default_treat_data);
    sapi_register_input_filter(php_default_input_filter, NULL);
    return SUCCESS;
}</p>

<p>SAPI_API SAPI_POST_READER_FUNC(php_default_post_reader)
{
    if (!strcmp(SG(request_info).request_method, â€œPOSTâ€)) {  //å¦‚æœæ˜¯POSTè¯·æ±‚
        if (NULL == SG(request_info).post_entry) { //å¦‚æœContent-Typeæ²¡æœ‰å¯¹åº”çš„é’©å­
            /* no post handler registered, so we just swallow the data */
            sapi_read_standard_form_data(); //å’Œapplication/x-www-form-urlencodedä¸€æ ·çš„å¤„ç†é€»è¾‘
        }
    }
}
åœ¨php_default_post_readerä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå…¶å®å®ƒæ‰§è¡Œçš„ä»ç„¶æ˜¯sapi_read_standard_form_dataå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯åœ¨bodyä¿¡æ¯è¯»å–é˜¶æ®µï¼Œå°½ç®¡application/jsonæ²¡æœ‰æ³¨å†Œé’©å­ï¼Œä½†æ˜¯å®ƒå’Œapplication/x-www-form-urlencodedä»ç„¶ä¿æŒè¿™ä¸€è‡´çš„å¤„ç†é€»è¾‘ã€‚è¿™ä¹Ÿè§£é‡Šäº†ï¼Œä¸ºä»€ä¹ˆapplication/jsonå¯ä»¥é€šè¿‡php://inputæ‹¿åˆ°åŸå§‹postæ•°æ®ã€‚</p>

<p>åˆ°ç°åœ¨ï¼Œphp://inputçš„è¡Œä¸ºå·®å¼‚å·²ç»æ˜¯å¯ä»¥è§£é‡Šçš„æ¸…äº†ï¼Œè€Œ$_POSTæˆ‘ä»¬éœ€è¦ç»§ç»­è·Ÿè¸ªä¸‹å»ã€‚</p>

<p>æ•°æ®åç½®å¤„ç†
æ•°æ®åç½®å¤„ç†é˜¶æ®µæ˜¯ç”¨æ¥å¯¹åŸå§‹çš„bodyæ•°æ®åšåç½®å¤„ç†çš„ï¼Œ$_POSTå°±æ˜¯åœ¨è¿™ä¸ªé˜¶æ®µäº§ç”Ÿã€‚ä¸‹å›¾å±•ç¤ºäº†åœ¨æ•°æ®åç½®å¤„ç†é˜¶æ®µï¼Œphpæ‰§è¡Œçš„å‡½æ•°æµç¨‹ã€‚
<img src="https://xiazemin.github.io/MyBlog/img/php_startup_auto_globals.png" /></p>

<p>ç¬¬äºŒèŠ‚è®²åˆ°ï¼Œåœ¨php_module_startupå‡½æ•°ä¸­ï¼Œä¼šè°ƒç”¨php_startup_auto_globalså‘CG(auto_globals)è¿™ä¸ªhashtableæ³¨å†Œè¶…å…¨å±€å˜é‡_GETã€_POSTã€_COOKIEã€_SERVERçš„é’©å­ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶æœºå›è°ƒã€‚</p>

<p>void php_startup_auto_globals(void)
{
    zend_register_auto_global(zend_string_init(â€œ_GETâ€, sizeof(â€œ_GETâ€)-1, 1), 0, php_auto_globals_create_get);
    zend_register_auto_global(zend_string_init(â€œ_POSTâ€, sizeof(â€œ_POSTâ€)-1, 1), 0, php_auto_globals_create_post);
    zend_register_auto_global(zend_string_init(â€œ_COOKIEâ€, sizeof(â€œ_COOKIEâ€)-1, 1), 0, php_auto_globals_create_cookie);
    zend_register_auto_global(zend_string_init(â€œ_SERVERâ€, sizeof(â€œ_SERVERâ€)-1, 1), PG(auto_globals_jit), php_auto_globals_create_server);
    zend_register_auto_global(zend_string_init(â€œ_ENVâ€, sizeof(â€œ_ENVâ€)-1, 1), PG(auto_globals_jit), php_auto_globals_create_env);
    zend_register_auto_global(zend_string_init(â€œ_REQUESTâ€, sizeof(â€œ_REQUESTâ€)-1, 1), PG(auto_globals_jit), php_auto_globals_create_request);
    zend_register_auto_global(zend_string_init(â€œ_FILESâ€, sizeof(â€œ_FILESâ€)-1, 1), 0, php_auto_globals_create_files);
}
è€Œè¿™ä¸ªåˆé€‚çš„æ—¶æœºå°±æ˜¯php_request_startupä¸­åœ¨sapi_activateä¹‹åæ‰§è¡Œçš„php_hash_environmentå‡½æ•°ã€‚è¯¥å‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨zend_activate_auto_globalså‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°éå†æ‰€æœ‰æ³¨å†Œçš„auto globalï¼Œå›è°ƒç›¸åº”çš„é’©å­ã€‚è€Œ$_POSTå¯¹åº”çš„é’©å­æ˜¯php_auto_globals_create_postã€‚</p>

<p>PHPAPI int php_hash_environment(void)
{
    memset(PG(http_globals), 0, sizeof(PG(http_globals)));
    zend_activate_auto_globals(); //æ¿€æ´»è¶…å…¨å±€å˜é‡ï¼Œå›è°ƒstartupæ—¶æ³¨å†Œçš„é’©å­
    if (PG(register_argc_argv)) {
        php_build_argv(SG(request_info).query_string, &amp;PG(http_globals)[TRACK_VARS_SERVER]);
    }
    return SUCCESS;
}</p>

<p>ZEND_API void zend_activate_auto_globals(void) /* {{{ */
{
    zend_auto_global *auto_global;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZEND_HASH_FOREACH_PTR(CG(auto_globals), auto_global) { //éå†æ‰€æœ‰çš„è¶…å…¨å±€å˜é‡
    if (auto_global-&gt;jit) {
        auto_global-&gt;armed = 1;
    } else if (auto_global-&gt;auto_global_callback) {
        auto_global-&gt;armed = auto_global-&gt;auto_global_callback(auto_global-&gt;name); //å›è°ƒé’©å­å‡½æ•°
    } else {
        auto_global-&gt;armed = 0;
    }
} ZEND_HASH_FOREACH_END(); } php_auto_globals_create_poståšäº†ä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿä¸‹å›¾å±•ç¤ºäº†å®ƒçš„æ•´ä½“æµç¨‹ã€‚ &lt;img src="https://xiazemin.github.io/MyBlog/img/php_auto_globals_create_post.png"/&gt;
</code></pre></div></div>

<p>åœ¨PGé‡Œæœ‰ä¸€ä¸ªhttp_globalså­—æ®µï¼Œå®ƒæ˜¯åŒ…å«6ä¸ªzvalçš„æ•°ç»„ã€‚è¿™6ä¸ªzvalåˆ†åˆ«ç”¨æ¥ä¸´æ—¶å­˜å‚¨ _POSTã€_GETã€_COOKIEã€_SERVERã€_ENVå’Œ_FILES æ•°æ®ã€‚</p>

<p>struct _php_core_globals {
    â€¦
    zval http_globals[6]; //0-$_POST 1-$_GET 2-$_COOKIE 3-$_SERVER 4-$_ENV 5-$_FILES
    â€¦
};
å¯¹äºä¸€ä¸ªç®€å•çš„postè¯·æ±‚ï¼šcurl -d â€œa=1â€ http://10.179.195.72:8585/test/jiweibin ï¼ŒContent-Typeæ˜¯application/x-www-form-urlencodedï¼Œphp_auto_globals_create_postæ‰€åšçš„æ“ä½œå¯ä»¥åˆ†è¿™ä¹ˆå‡ æ­¥ï¼š</p>

<p>è¯»å–ä¸Šä¸€é˜¶æ®µå†™å…¥åˆ°SG(request_info).request_bodyè¿™ä¸ªphpstreamä¸­çš„bodyæ•°æ®åˆ°å†…å­˜bufã€‚è¿™é‡Œbodyæ•°æ®æ˜¯â€a=1â€è¿™ä¸ªå­—ç¬¦ä¸²ã€‚
è§£æpost bodyæ•°æ®ï¼ˆæŒ‰&amp;åˆ†å‰²key-valueå¯¹ï¼ŒæŒ‰=åˆ†å‰²keyå’Œvalueï¼‰ï¼Œå¹¶å°†è§£æåçš„æ•°æ®é€šè¿‡è°ƒç”¨add_post_varså‡½æ•°ï¼Œå†™å…¥åˆ°PG(http_globals)[0]è¿™ä¸ªzvalä¸­ï¼Œzvalçš„ç±»å‹æ˜¯æ•°ç»„ç±»å‹ã€‚
æœ€åï¼Œä¸ºäº†è®©Zendå¼•æ“å¯ä»¥é€šè¿‡_POSTè¿™ä¸ªå­—ç¬¦ä¸²ç´¢å¼•åˆ°ä¸Šä¸€æ­¥è§£æçš„zvalï¼Œæˆ‘ä»¬éœ€è¦ä»¥â€_POSTâ€ä¸ºkeyï¼Œåˆšåˆšzvalä¸ºvalueæ³¨å†Œåˆ°php Zendå¼•æ“çš„å…¨å±€å˜é‡ç¬¦å·è¡¨EG(symbol_table)ä¸­ã€‚
åœ¨php_auto_globals_create_postå‡½æ•°ä¸­ï¼Œ å½“å‘ç°å½“å‰çš„è¯·æ±‚æ˜¯POSTè¯·æ±‚æ—¶ï¼Œä¼šè°ƒsapi_module.treat_dataå‡½æ•°æŒ‡é’ˆã€‚åœ¨php_module_startupé˜¶æ®µï¼Œphpä¼šè®¾ç½®sapi_module.treat_dataå‡½æ•°æŒ‡é’ˆæŒ‡å‘php_default_treat_dataå‡½æ•°ã€‚è¯¥å‡½æ•°ä¼šæœ€ç»ˆå®Œæˆbodyæ•°æ®è§£æå¹¶å­˜å‚¨åˆ°PG(http_globals)[0]è¿™ä¸ªzvalä¸­ã€‚åœ¨è°ƒç”¨å®Œphp_default_treat_dataä¹‹åï¼Œä¼šå°†â€_POSTâ€å’ŒPG(http_globals)[0]æ³¨å†Œåˆ°ç¬¦å·è¡¨EG(symbol_table)ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>

<p>static zend_bool php_auto_globals_create_post(zend_string *name)
{
    if (PG(variables_order) &amp;&amp;
            (strchr(PG(variables_order),â€™Pâ€™) || strchr(PG(variables_order),â€™pâ€™)) &amp;&amp;
        !SG(headers_sent) &amp;&amp;
        SG(request_info).request_method &amp;&amp;
        !strcasecmp(SG(request_info).request_method, â€œPOSTâ€)) { 
        sapi_module.treat_data(PARSE_POST, NULL, NULL); //ä»streamä¸­è¯»å–å¹¶è§£æbodyæ•°æ®ï¼Œå­˜å‚¨åˆ°PG(http_globals)[0]
    } else {
        zval_ptr_dtor(&amp;PG(http_globals)[TRACK_VARS_POST]);
        array_init(&amp;PG(http_globals)[TRACK_VARS_POST]);
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zend_hash_update(&amp;EG(symbol_table), name, &amp;PG(http_globals)[TRACK_VARS_POST]); //å°†'_POST'å’ŒPG(http_globals)[0]æ³¨å†Œåˆ°EG(symbol_table)
Z_ADDREF(PG(http_globals)[TRACK_VARS_POST]);

return 0; /* don't rearm */ } åœ¨php_default_treat_dataä¸­ï¼Œå¯¹äºPOSTè¯·æ±‚ï¼Œä¼šé‡æ–°åˆå§‹åŒ–PG(http_globals)[0]ï¼ˆTRACK_VARS_POSTæ˜¯ä¸€ä¸ªå®ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µä¼šè¢«æ›¿æ¢ä¸º0ï¼‰ï¼Œç„¶åè°ƒç”¨sapi_handle_postå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå›è°ƒåœ¨SAPIå¯åŠ¨é˜¶æ®µä¸ºContent-Typeå®‰è£…çš„é’©å­ä¸­çš„post_handlerå‡½æ•°æŒ‡é’ˆã€‚
</code></pre></div></div>

<p>SAPI_API SAPI_TREAT_DATA_FUNC(php_default_treat_data)
{
    â€¦
    zval array;
    â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZVAL_UNDEF(&amp;array);
switch (arg) {
    case PARSE_POST:
    case PARSE_GET:
    case PARSE_COOKIE:
        array_init(&amp;array);
        switch (arg) {
            case PARSE_POST:
                zval_ptr_dtor(&amp;PG(http_globals)[TRACK_VARS_POST]); //ææ„zvalï¼Œé‡Šæ”¾ä¸Šä¸€æ¬¡è¯·æ±‚çš„æ—§æ•°ç»„å†…å­˜
                ZVAL_COPY_VALUE(&amp;PG(http_globals)[TRACK_VARS_POST], &amp;array);  //é‡æ–°åˆå§‹åŒ–zval,æŒ‡å‘æ–°çš„ç©ºæ•°ç»„å†…å­˜
                break;
            ...
        }
        break;
    default:
        ZVAL_COPY_VALUE(&amp;array, destArray);
        break;
}

if (arg == PARSE_POST) {
    sapi_handle_post(&amp;array); //å›è°ƒContent-Typeé’©å­
    return;
}
... }
</code></pre></div></div>

<p>SAPI_API void sapi_handle_post(void *arg)
{
    //å¦‚æœContent-Typeå·²ç»å®‰è£…é’©å­
    if (SG(request_info).post_entry &amp;&amp; SG(request_info).content_type_dup) { 
        SG(request_info).post_entry-&gt;post_handler(SG(request_info).content_type_dup, arg); //è°ƒç”¨ç›¸åº”é’©å­çš„post_handlerå‡½æ•°æŒ‡é’ˆ
        efree(SG(request_info).content_type_dup);
        SG(request_info).content_type_dup = NULL;
    }
å¯¹äºapplication/x-www-form-urlencodedï¼Œpost_handleræ˜¯php_std_post_handlerã€‚</p>

<p>SAPI_API SAPI_POST_HANDLER_FUNC(php_std_post_handler)
{
    zval *arr = (zval *) arg; //argæŒ‡å‘PG(http_globals)[0]
    php_stream *s = SG(request_info).request_body;
    post_var_data_t post_data;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (s &amp;&amp; SUCCESS == php_stream_rewind(s)) {
    memset(&amp;post_data, 0, sizeof(post_data));

    while (!php_stream_eof(s)) {
        char buf[SAPI_POST_HANDLER_BUFSIZ] = {0};
 
        //è¯»å–ä¸Šä¸€é˜¶æ®µè¢«å†™å…¥çš„phpstream
        size_t len = php_stream_read(s, buf, SAPI_POST_HANDLER_BUFSIZ); 

        if (len &amp;&amp; len != (size_t) -1) {
            smart_str_appendl(&amp;post_data.str, buf, len);
 
            //è§£æå¹¶æ’å…¥åˆ°arrä¸­ï¼ŒarræŒ‡å‘PG(http_globals)[0]
            if (SUCCESS != add_post_vars(arr, &amp;post_data, 0)) {
                smart_str_free(&amp;post_data.str);
                return;
            }
        }

        if (len != SAPI_POST_HANDLER_BUFSIZ){ //è¯»åˆ°æœ€åäº†
            break;
        }
    }

    if (post_data.str.s) {
        //è§£æå¹¶æ’å…¥åˆ°arrä¸­ï¼ŒarræŒ‡å‘PG(http_globals)[0]
        add_post_vars(arr, &amp;post_data, 1);
        smart_str_free(&amp;post_data.str);
    }
} } å¯¹äºmultipart/form-dataï¼Œpost_handleræ˜¯rfc1867_post_handlerã€‚ç”±äºå®ƒçš„ä»£ç è¿‡é•¿ï¼Œè¿™é‡Œä¸å†è´´ä»£ç äº†ã€‚ç”±äºåœ¨bodyä¿¡æ¯è¯»å–é˜¶æ®µï¼Œé’©å­çš„post_readeræ˜¯ç©ºï¼Œæ‰€ä»¥rfc1867_post_handlerä¼šä¸€è¾¹åšFCGI_STDINæ•°æ®åŒ…çš„è¯»å–ï¼Œä¸€è¾¹åšè§£æå­˜å‚¨å·¥ä½œï¼Œæœ€ç»ˆå°†æ•°æ®åŒ…ä¸­çš„key-valueå¯¹å­˜å‚¨åˆ°PG(http_globals)[0]ä¸­ã€‚å¦å¤–ï¼Œè¯¥å‡½æ•°è¿˜ä¼šå¯¹ä¸Šä¼ çš„æ–‡ä»¶è¿›è¡Œå¤„ç†ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è¯»ä¸‹è¿™ä¸ªå‡½æ•°ã€‚
</code></pre></div></div>

<p>å¯¹äºapplication/jsonï¼Œç”±äºæœªå®‰è£…ä»»ä½•é’©å­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸ä¼šåšä»»ä½•äº‹æƒ…ï¼ŒPG(http_globals)[0]æ˜¯ç©ºæ•°ç»„ã€‚å› æ­¤å¦‚æœContent-Typeæ˜¯application/jsonï¼Œæ˜¯æ— æ³•è·å–åˆ°$_POSTå˜é‡çš„ã€‚</p>

<p>php_auto_globals_create_postæ‰§è¡Œçš„æœ€åï¼Œéœ€è¦è¿›è¡Œå…¨å±€å˜é‡ç¬¦å·è¡¨çš„æ³¨å†Œæ“ä½œï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå…¶å®è¿™å’ŒZendå¼•æ“çš„ä»£ç æ‰§è¡Œæœ‰å…³ç³»äº†ã€‚Zendå¼•æ“çš„ç¼–è¯‘å™¨ç¢°åˆ°$_POSTæ—¶ï¼Œopcodeä¼šæ˜¯ZEND_FETCH_Ræˆ–è€…ZEND_FETCH_Wï¼ˆå…¶ä¸­æ“ä½œæ•°æ˜¯â€™_POSTâ€™ï¼Œfetch_typeæ˜¯globalï¼‰ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µæ‰§è¡Œå™¨ä¼šå»EG(symbol_table)ä¸­æ ¹æ®key=â€™_POSTâ€™å»æ‰¾åˆ°å¯¹åº”çš„zvalã€‚å› æ­¤è¿™é‡Œçš„æ³¨å†Œæ“ä½œæ˜¯æœ‰å¿…è¦çš„ã€‚</p>

<p>è®©æˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥éªŒè¯ä¸‹opcodeï¼Œå†™ä¸€ä¸ªç®€å•çš„phpè„šæœ¬test.phpï¼š</p>

<p>&lt;?php
var_dump($_POST);
å®‰è£…vldæ‰©å±•ä¹‹åï¼Œæ‰§è¡Œphp -dvld.active=1 test.phpï¼Œå¯ä»¥çœ‹åˆ°opcodeæ˜¯FETCH_Rï¼Œæ­£å¦‚æˆ‘ä»¬é¢„æœŸã€‚å®ƒä¼šå…ˆä»å…¨å±€ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾â€™_POSTâ€™å¯¹åº”çš„zvalï¼Œç„¶åèµ‹å€¼ç»™$0ï¼ˆä¸»å‡½æ•°æ ˆçš„ç¬¬ä¸€ä¸ªå˜é‡ï¼Œè¯¥å˜é‡æ˜¯éšå¼å£°æ˜ï¼‰ã€‚</p>

<p>clipboard.png</p>

<p>å››ã€postjsonæ‰©å±•
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯¹$_POSTçš„æ•´ä½“æµç¨‹ä»¥åŠç»†èŠ‚æœ‰æ‰€äº†è§£ã€‚è®©æˆ‘ä»¬åšç‚¹ä»€ä¹ˆå§ï¼Œå†™ä¸€ä¸ªæ‰©å±•ï¼Œæ¥è®©application/jsonçš„è¯·æ±‚ä¹Ÿå¯ä»¥äº«å—åˆ°$_POSTè¿™ä¸ªè¶…å…¨å±€å˜é‡å¸¦æ¥çš„ä¾¿åˆ©ã€‚ï¼ˆè¿™ä¸ªæ‰©å±•çš„ç”Ÿäº§ç¯å¢ƒçš„æ„ä¹‰ä¸å¤§ï¼Œå®Œå…¨å¯ä»¥åœ¨phpå±‚é€šè¿‡php://inputæ‹¿åˆ°è¯·æ±‚bodyï¼Œæ›´å¤šçš„æ˜¯å­¦ä»¥è‡´ç”¨çš„å­¦ä¹ æ„ä¹‰ï¼‰</p>

<p>å¦‚ä½•æ¥å®ç°æˆ‘ä»¬çš„æ‰©å±•å‘¢ï¼Ÿ ä¸Šé¢æˆ‘ä»¬çŸ¥é“ï¼Œä¹‹æ‰€ä»¥æ‹¿ä¸åˆ°æ˜¯å› ä¸ºæ²¡æœ‰ä¸ºapplication/jsonå®‰è£…é’©å­ï¼Œå¯¼è‡´åœ¨æ•°æ®åç½®å¤„ç†é˜¶æ®µå¹¶æ²¡æœ‰åšpost bodyçš„è§£æï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å®‰è£…ä¸€ä¸ªé’©å­ï¼Œé’©å­çš„post_readerå¯ä»¥æ˜¯NULLï¼ˆè¿™æ ·ä¼šèµ°é»˜è®¤é€»è¾‘ï¼‰ï¼Œä¹Ÿå¯ä»¥å’Œapplication/x-www-form-urlencodedä¿æŒä¸€è‡´ï¼šsapi_read_standard_form_dataã€‚è€Œpost_handleråˆ™éœ€è¦æˆ‘ä»¬ç¼–å†™äº†ï¼Œpost_handleræˆ‘ä»¬å–åï¼šphp_json_post_handlerã€‚</p>

<p>ä¸‹å›¾å±•ç¤ºäº†postjsonæ‰©å±•æ•´ä½“çš„æ‰§è¡Œæµç¨‹ï¼š</p>

<p>å®ƒåœ¨æ¨¡å—åˆå§‹åŒ–æ—¶ï¼Œzend_startup_modulesæ‰§è¡Œä¹‹åï¼Œä¼šè°ƒç”¨è¯¥æ‰©å±•çš„MINITå‡½æ•°ï¼ŒMINITå‡½æ•°é‡Œé¢ä¼šè¿›è¡Œini entryæ³¨å†Œï¼Œå¹¶è·å–åˆ°å…³å¿ƒçš„inié…ç½®çš„å€¼ï¼ˆè¿™é‡Œæˆ‘ä»¬ä¼šæ³¨å†Œä¸€ä¸ªå¼€å…³é…ç½®postjson.parseè¡¨ç¤ºæ˜¯å¦å¼€å¯æ‰©å±•)ï¼Œå¦‚æœæ‰©å±•å¼€å¯ï¼Œæˆ‘ä»¬ä¼šå‘SG(known_post_content_types)æ³¨å†Œapplication/jsonçš„é’©å­ã€‚
ç„¶ååœ¨è¯·æ±‚åˆå§‹åŒ–æ—¶ï¼ŒFastCGIåè®®å¤„ç†çš„æ•°æ®åç½®å¤„ç†é˜¶æ®µï¼Œå›è°ƒæˆ‘ä»¬çš„é’©å­å‡½æ•°php_json_post_handlerï¼Œå®Œæˆjsonæ ¼å¼çš„post bodyçš„è§£æä»¥åŠå°†è§£æåçš„key-valueå­˜å‚¨åˆ°PG(http_globals)[0]çš„æ“ä½œã€‚
åç»­phpçš„æ¡†æ¶ä»£ç php_auto_globals_create_postä¼šå®Œæˆåç»­çš„ç¬¦å·è¡¨æ³¨å†Œæ“ä½œã€‚
<img src="https://xiazemin.github.io/MyBlog/img/php_json_post_handler.png" /></p>

<p>å…³äºphp_json_post_handlerï¼Œå¯¹jsonçš„è§£ææ˜¯ä¸€ä¸ªå¤æ‚çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç°æœ‰çš„è½®å­ï¼Œçœ‹ä¸‹phpçš„jsonæ‰©å±•æ˜¯å¦‚ä½•å®ç°çš„:</p>

<p>static PHP_FUNCTION(json_decode)
{
    char <em>str;
    size_t str_len;
    zend_bool assoc = 0; /</em> return JS objects as PHP objects by default */
    zend_long depth = PHP_JSON_PARSER_DEFAULT_DEPTH;
    zend_long options = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS(), "s|bll", &amp;str, &amp;str_len, &amp;assoc, &amp;depth, &amp;options) == FAILURE) {
    return;
}

JSON_G(error_code) = 0;

if (!str_len) {
    JSON_G(error_code) = PHP_JSON_ERROR_SYNTAX;
    RETURN_NULL();
}

/* For BC reasons, the bool $assoc overrides the long $options bit for PHP_JSON_OBJECT_AS_ARRAY */
if (assoc) {
    options |=  PHP_JSON_OBJECT_AS_ARRAY;
} else {
    options &amp;= ~PHP_JSON_OBJECT_AS_ARRAY;
}

php_json_decode_ex(return_value, str, str_len, options, depth); //è§£æstr,å­˜å‚¨åˆ°return_valueè¿™ä¸ªzvalä¸­ }  æˆ‘ä»¬å¯ä»¥ä½¿ç”¨php_json_decode_exï¼ˆå®ƒå†…éƒ¨ä½¿ç”¨yaccå®Œæˆè¯­æ³•è§£æï¼‰è¿™ä¸ªå‡½æ•°æ¥åšjsonè§£æï¼Œå°†return_valueæ›¿æ¢ä¸º&amp;PG(http_globals)[0]ã€‚è€Œstråˆ™ä»SG(request_info).request_bodyè¿™ä¸ªphpstreamä¸­å»è¯»å–ã€‚æ‰€ä»¥ï¼Œæ•´ä½“çš„æ€è·¯å·²ç»é€šäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ“ä½œä¸€ä¸‹ã€‚
</code></pre></div></div>

<p>ç”Ÿæˆæ‰©å±•éª¨æ¶
è¿›å…¥åˆ°æºç ç›®å‰çš„extç›®å½•ï¼šcd /home/weibin/offcial_code/php/7.0.6/php-7.0.6/extï¼Œæ‰§è¡Œ ./ext_skel â€“extname=postjsonï¼Œè¿™æ—¶åœ¨ä»£ç ç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°postjson.cå’Œphp_postjson.hç­‰æ–‡ä»¶ã€‚</p>

<p>ç¼–è¾‘php_postjson.hæ–‡ä»¶
æˆ‘ä»¬çš„æ‰©å±•å¯ä»¥åœ¨php.iniä¸­å¼€å…³ï¼Œå¼€çš„æ–¹å¼æ˜¯postjson.parse=On,å…³çš„æ–¹å¼æ˜¯postjson.parse=Offï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ªå­˜å‚¨è¿™ä¸ªå¼€å…³çš„ç»“æ„ä½“ï¼Œparseå­—æ®µè¡¨ç¤ºè¿™ä¸ªå¼€å…³ã€‚å®šä¹‰äº†2ä¸ªå¸¸é‡ï¼šJSON_CONTENT_TYPEå’ŒCHUNK_SIZEï¼Œåˆ†åˆ«ç”¨æ¥è¡¨ç¤ºapplication/jsonçš„Content-Typeå’Œè¯»å–phpstreamæ—¶çš„bufferå¤§å°ã€‚</p>

<p>#ifndef PHP_POSTJSON_H
#define PHP_POSTJSON_H</p>

<p>#include â€œSAPI.hâ€
#include â€œext/json/php_json.hâ€
#include â€œphp_globals.hâ€</p>

<p>extern zend_module_entry postjson_module_entry;
#define phpext_postjson_ptr &amp;postjson_module_entry
#define PHP_POSTJSON_VERSION â€œ0.1.0â€ /* Replace with version number for your extension */</p>

<p>#ifdef PHP_WIN32</p>
<h1 id="define-php_postjson_api-__declspecdllexport">define PHP_POSTJSON_API __declspec(dllexport)</h1>
<p>#elif defined(<strong>GNUC</strong>) &amp;&amp; <strong>GNUC</strong> &gt;= 4</p>
<h1 id="define-php_postjson_api-attribute-visibilitydefault">define PHP_POSTJSON_API <strong>attribute</strong> ((visibility(â€œdefaultâ€)))</h1>
<p>#else</p>
<h1 id="define-php_postjson_api">define PHP_POSTJSON_API</h1>
<p>#endif
#ifdef ZTS
#include â€œTSRM.hâ€
#endif</p>

<p>ZEND_BEGIN_MODULE_GLOBALS(postjson)
    zend_long  parse;  //å­˜å‚¨é…ç½®çš„ç»“æ„ä½“
ZEND_END_MODULE_GLOBALS(postjson)</p>

<p>SAPI_POST_HANDLER_FUNC(php_json_post_handler);</p>

<p>#define JSON_CONTENT_TYPE â€œapplication/jsonâ€
#define CHUNK_SIZE    8192</p>

<p>/* Always refer to the globals in your function as POSTJSON_G(variable).
   You are encouraged to rename these macros something shorter, see
   examples in any other php module directory.
<em>/
#define POSTJSON_G(v) ZEND_MODULE_GLOBALS_ACCESSOR(postjson, v)
#if defined(ZTS) &amp;&amp; defined(COMPILE_DL_POSTJSON)
ZEND_TSRMLS_CACHE_EXTERN()
#endif
#endif    /</em> PHP_POSTJSON_H */
ç¼–è¾‘postjson.cæ–‡ä»¶
è¿™é‡Œå®šä¹‰inié…ç½®ï¼Œé’©å­æ•°ç»„post_entriesï¼Œå®ç°php_json_post_handlerï¼Œå¹¶æ”¹å†™MINITå‡½æ•°ï¼Œåˆ¤æ–­iniä¸­å¼€å…³postjson.parseæ˜¯å¦å¼€å¯ï¼Œå¦‚æœå¼€å¯ï¼Œåˆ™æ³¨å†Œé’©å­ã€‚</p>

<p>åœ¨php_json_post_handlerä¸­åˆ†é…ä¸€ä¸ª8kçš„zend_stringï¼Œè¯»å–SG(request_info).request_bodyè¿™ä¸ªphpstreamåˆ°ä¸€ä¸ª8kçš„bufferï¼Œå¦‚æœä¸€æ¬¡è¯»å–ä¸å®Œï¼Œåˆ†å¤šæ¬¡è¯»å–ï¼Œzend_stringä¸æ–­æ‰©å®¹ï¼Œæœ€ç»ˆåŒ…å«æ•´ä¸ªjsonå­—ç¬¦ä¸²ã€‚æœ€åè°ƒç”¨php_json_decode_exå‡½æ•°å®Œæˆjsonä¸²è§£æå¹¶å­˜å‚¨åˆ°PG(http_globlas)[0]ä¸­ã€‚</p>

<p>#ifdef HAVE_CONFIG_H
#include â€œconfig.hâ€
#endif
#include â€œphp.hâ€
#include â€œphp_ini.hâ€
#include â€œext/standard/info.hâ€
#include â€œphp_postjson.hâ€</p>

<p>ZEND_DECLARE_MODULE_GLOBALS(postjson)
/* True global resources - no need for thread safety here */
static int le_postjson;</p>

<p>//postjsonæ‰©å±•ä½¿ç”¨åˆ°çš„ini
PHP_INI_BEGIN()
    STD_PHP_INI_BOOLEAN(â€œpostjson.parseâ€,      â€œ0â€, PHP_INI_ALL, OnUpdateLong, parse, zend_postjson_globals, postjson_globals)
PHP_INI_END()</p>

<p>static sapi_post_entry post_entries[] = { //å®šä¹‰Content-Typeé’©å­
    { JSON_CONTENT_TYPE,    sizeof(JSON_CONTENT_TYPE)-1,    sapi_read_standard_form_data,  php_json_post_handler },
    { NULL, 0, NULL, NULL }
};
SAPI_POST_HANDLER_FUNC(php_json_post_handler){ //post handler
    size_t ret = 0;
    char *ptr;
    size_t len = 0, max_len;
    int step = CHUNK_SIZE;
    int min_room = CHUNK_SIZE / 4;
    int persistent = 0;
    zend_string *result;
    php_stream *s = SG(request_info).request_body;
    if (s &amp;&amp; SUCCESS == php_stream_rewind(s)) {
        max_len = step;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    result = zend_string_alloc(max_len, persistent);
    ptr = ZSTR_VAL(result);
    while ((ret = php_stream_read(s, ptr, max_len - len)))    { //è¯»å–SG(request_info).request_bodyè¿™ä¸ªphpstream
        len += ret;
        if (len + min_room &gt;= max_len) {
            result = zend_string_extend(result, max_len + step, persistent);
            max_len += step;
            ptr = ZSTR_VAL(result) + len;
        } else {
            ptr += ret;
        }
    }
    if (len) {
        result = zend_string_truncate(result, len, persistent);
        ZSTR_VAL(result)[len] = '\0';
        //è§£æjsonï¼Œå¹¶å­˜å‚¨åˆ°PG(http_globals)[0]
        php_json_decode_ex(&amp;PG(http_globals)[TRACK_VARS_POST], ZSTR_VAL(result), ZSTR_LEN(result), PHP_JSON_OBJECT_AS_ARRAY, PHP_JSON_PARSER_DEFAULT_DEPTH);
    } else {
        zend_string_free(result);
        result = NULL;
    }
} }
</code></pre></div></div>

<p>static void php_postjson_init_globals(zend_postjson_globals *postjson_globals)
{
    postjson_globals-&gt;parse = 0;
}</p>

<p>PHP_MINIT_FUNCTION(postjson)
{
    ZEND_INIT_MODULE_GLOBALS(postjson, php_postjson_init_globals, NULL);
    REGISTER_INI_ENTRIES();
    int parse = (int)POSTJSON_G(parse);
    if(parse == 1){ //å¦‚æœiniä¸­postjson.parseå¼€å¯ï¼Œé‚£ä¹ˆå°†application/jsonçš„é’©å­æ³¨å†Œåˆ°SG(known_post_content_types)ä¸­
        sapi_register_post_entries(post_entries);  <br />
    }
    return SUCCESS;
}</p>

<p>const zend_function_entry postjson_functions[] = { //è¿™é‡Œæˆ‘ä»¬ä¸æ³¨å†Œä»»ä½•phpå‡½æ•°
        PHP_FE_END    /* Must be the last line in postjson_functions[] */
};</p>

<p>static zend_module_dep module_deps[] = { //æœ¬æ‰©å±•ä¾èµ–phpçš„jsonæ‰©å±•
    ZEND_MOD_REQUIRED(â€œjsonâ€)
    ZEND_MOD_END
};</p>

<p>zend_module_entry postjson_module_entry = {
    STANDARD_MODULE_HEADER_EX,NULL,
    module_deps,
    â€œpostjsonâ€,
    postjson_functions,
    PHP_MINIT(postjson),
    PHP_MSHUTDOWN(postjson),
    PHP_RINIT(postjson),        /* Replace with NULL if thereâ€™s nothing to do at request start <em>/
    PHP_RSHUTDOWN(postjson),    /</em> Replace with NULL if thereâ€™s nothing to do at request end */
    PHP_MINFO(postjson),
    PHP_POSTJSON_VERSION,
    STANDARD_MODULE_PROPERTIES
};
â€¦
ç¼–è¯‘å®‰è£…
   phpize</p>

<p>configure â€“with-php-config=../php-config</p>

<p>make</p>

<p>make install
é…ç½®php.ini
å¢åŠ posté…ç½®ï¼š</p>

<p>[postjson]
extension=â€postjson.soâ€
postjson.parse=On
éªŒè¯æ˜¯å¦å®‰è£…æˆåŠŸï¼šphp -m|grep postjson</p>

<p>clipboard.png</p>

<p>æµ‹è¯•
é‡å¯php-fpmï¼Œkill -USR2 cat /home/weibin/php7/var/run/php-fpm.pid</p>

<p>ç¼–å†™æµ‹è¯•è„šæœ¬ï¼š</p>

<p>&lt;?php
namespace xxx\Test;</p>

<p>class Jiweibin{
    function index() {
        var_dump($_POST);
        var_dump(file_get_contents(â€œphp://inputâ€));
    }</p>

<p>}
æ‰§è¡Œcurlå‘½ä»¤ï¼Œcurl -H â€œContent-Type: application/jsonâ€ -d â€˜{â€œaâ€:1}â€™ http://10.179.195.72:8585/test/jiweibinï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼Œæˆ‘ä»¬çœ‹åˆ°é€šè¿‡$_POSTå¯ä»¥æ‹¿åˆ°è§£æåçš„postæ•°æ®äº†ï¼Œæå®šã€‚</p>

<p>clipboard.png</p>

<p>äº”ã€æ€»ç»“
æœ¬ç¯‡wikiï¼Œä»æºç è§’åº¦åˆ†æäº†phpä¸­_POSTçš„åŸç†ï¼Œå±•ç°äº†FastCGIåè®®çš„æ•´ä½“å¤„ç†æµç¨‹ï¼Œä»¥åŠé’ˆå¯¹ä¸åŒContent-Typeçš„å¤„ç†å·®å¼‚åŒ–ï¼Œå¹¶ä¸ºapplication/jsonåŠ¨æ‰‹ç¼–å†™äº†phpæ‰©å±•ï¼Œå®ç°äº†_POSTçš„è§£æï¼Œå¸Œæœ›å¤§å®¶æœ‰æ‰€æ”¶è·ã€‚ä½†æœ¬ç¯‡wikiå¹¶ä¸æ˜¯ç»ˆç‚¹ï¼Œé€šè¿‡ç¼–å†™è¿™ç¯‡wikiï¼Œå¯¹jsonè§£æï¼ˆyaccï¼‰ã€Zendå¼•æ“åŸç†æœ‰äº†æ¯”è¾ƒæµ“åšçš„å…´è¶£å’Œæ¢çŸ¥æ¬²ï¼Œæœ‰æ—¶é—´çš„è¯ï¼Œå¸Œæœ›èƒ½åˆ†äº«ç»™å¤§å®¶ï¼Œå¦å¤–æ„Ÿè°¢æˆ‘çš„åŒäº‹æœ±æ ‹åŒå­¦ï¼Œä¸€èµ·è·Ÿä»£ç çš„æ„Ÿè§‰è¿˜æ˜¯å¾ˆèµçš„ã€‚</p>
:ET