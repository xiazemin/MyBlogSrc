I"ª…<p>unsafeåŒ…å«ä»¥ä¸‹èµ„æºï¼š</p>

<p>ä¸‰ä¸ªå‡½æ•°ï¼š</p>

<p>func Alignofï¼ˆvariable ArbitraryTypeï¼‰uintptr
func Offsetofï¼ˆselector ArbitraryTypeï¼‰uintptr
func Sizeofï¼ˆvariable ArbitraryTypeï¼‰uintptr
å’Œä¸€ç§ç±»å‹ï¼š</p>

<p>ç±»å‹Pointer * ArbitraryType</p>

<p>å…¶å®å°±æ˜¯ä¸€ä¸ªintç±»å‹æŒ‡é’ˆ
type ArbitraryType int</p>

<p>é™¤äº†è¿™ä¸‰ä¸ªå‡½æ•°å’Œä¸€ä¸ªç±»å‹å¤–ï¼ŒæŒ‡é’ˆåœ¨unsafeåŒ…ä¹Ÿä¸ºç¼–è¯‘å™¨æœåŠ¡ã€‚</p>

<p>å‡ºäºå®‰å…¨åŸå› ï¼ŒGolangä¸å…è®¸ä»¥ä¸‹ä¹‹é—´çš„ç›´æ¥è½¬æ¢ï¼š</p>

<p>ä¸¤ä¸ªä¸åŒæŒ‡é’ˆç±»å‹çš„å€¼ï¼Œä¾‹å¦‚ int64å’Œ float64ã€‚</p>

<p>æŒ‡é’ˆç±»å‹å’Œuintptrçš„å€¼ã€‚
ä½†æ˜¯å€ŸåŠ©unsafe.Pointerï¼Œæˆ‘ä»¬å¯ä»¥æ‰“ç ´Goç±»å‹å’Œå†…å­˜å®‰å…¨æ€§ï¼Œå¹¶ä½¿ä¸Šé¢çš„è½¬æ¢æˆä¸ºå¯èƒ½ã€‚</p>

<p>unsafeåŒ…æ–‡æ¡£ä¸­åˆ—å‡ºçš„è§„åˆ™ï¼š</p>

<p>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerã€‚
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼ã€‚
uintptrå¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerã€‚
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºuintptrã€‚
è¿™äº›è§„åˆ™ä¸Goè§„èŒƒä¸€è‡´ï¼š</p>

<p>åº•å±‚ç±»å‹uintptrçš„ä»»ä½•æŒ‡é’ˆæˆ–å€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼Œåä¹‹äº¦ç„¶ã€‚
unsafe.Pointerå…¶å®å°±æ˜¯ç±»ä¼¼Cçš„void *ï¼Œåœ¨golangä¸­æ˜¯ç”¨äºå„ç§æŒ‡é’ˆç›¸äº’è½¬æ¢çš„æ¡¥æ¢ã€‚uintptræ˜¯golangçš„å†…ç½®ç±»å‹ï¼Œæ˜¯èƒ½å­˜å‚¨æŒ‡é’ˆçš„æ•´å‹ï¼Œuintptrçš„åº•å±‚ç±»å‹æ˜¯intï¼Œå®ƒå’Œunsafe.Pointerå¯ç›¸äº’è½¬æ¢ã€‚uintptrå’Œunsafe.Pointerçš„åŒºåˆ«å°±æ˜¯ï¼šunsafe.Pointeråªæ˜¯å•çº¯çš„é€šç”¨æŒ‡é’ˆç±»å‹ï¼Œç”¨äºè½¬æ¢ä¸åŒç±»å‹æŒ‡é’ˆï¼Œå®ƒä¸å¯ä»¥å‚ä¸æŒ‡é’ˆè¿ç®—ï¼›è€Œuintptræ˜¯ç”¨äºæŒ‡é’ˆè¿ç®—çš„ï¼ŒGC ä¸æŠŠ uintptr å½“æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯è¯´ uintptr æ— æ³•æŒæœ‰å¯¹è±¡ï¼Œuintptrç±»å‹çš„ç›®æ ‡ä¼šè¢«å›æ”¶ã€‚golangçš„unsafeåŒ…å¾ˆå¼ºå¤§ï¼ŒåŸºæœ¬ä¸Šå¾ˆå°‘ä¼šå»ç”¨å®ƒã€‚å®ƒå¯ä»¥åƒCä¸€æ ·å»æ“ä½œå†…å­˜ï¼Œä½†ç”±äºgolangä¸æ”¯æŒç›´æ¥è¿›è¡ŒæŒ‡é’ˆè¿ç®—ï¼Œæ‰€ä»¥ç”¨èµ·æ¥ç¨æ˜¾éº»çƒ¦ã€‚
<!-- more -->
unsafeåŒ…æä¾›äº†è®¿é—®åº•å±‚å†…å­˜çš„æ–¹æ³•ã€‚æ˜¯ç”¨unsafeå‡½æ•°å¯ä»¥æé«˜è®¿é—®å¯¹è±¡çš„é€Ÿåº¦ã€‚é€šå¸¸ç”¨äºå¯¹å¤§æ•°ç»„çš„éå†ã€‚
unsafeå†…å®¹ä»‹ç»
func Alignof(x ArbitraryType) uintptr
func Offsetof(x ArbitraryType) uintptr
func Sizeof(x ArbitraryType) uintptr
type ArbitraryType int
type Pointer *ArbitraryType</p>

<p>é€šè¿‡æŒ‡é’ˆåŠ åç§»é‡çš„æ“ä½œï¼Œåœ¨åœ°å€ä¸­ï¼Œä¿®æ”¹ï¼Œè®¿é—®å˜é‡çš„å€¼</p>

<p>è¿™ä¸ªåŒ…ä¸­ï¼Œåªæä¾›äº†3ä¸ªå‡½æ•°ï¼Œä¸¤ä¸ªç±»å‹
unsafeä¸­ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªä¸ªå…¼å®¹ä¸‡ç‰©çš„ç±»å‹ï¼Œå°†å…¶ä»–ç±»å‹éƒ½è½¬æ¢è¿‡æ¥ï¼Œç„¶åé€šè¿‡è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«èƒ½å–é•¿åº¦ï¼Œåç§»é‡ï¼Œå¯¹é½å­—èŠ‚æ•°ï¼Œå°±å¯ä»¥åœ¨å†…å­˜åœ°å€æ˜ å°„ä¸­ï¼Œæ¥å›æ¸¸èµ°ã€‚æ”¾åœ¨cè¯­è¨€ä¸­ï¼Œæ˜¯ä¸æ˜¯ï¼Œåªè¦ç»™ä½ ä¸€ä¸ªèµ·å§‹åœ°å€ï¼Œä½ å°±ä¸€ä¸‹å­å¹²åˆ°åº•ï¼ï¼ï¼åœ¨golangä¸­ï¼Œé€šè¿‡unsafeåŒ…ï¼Œä½ ä¹Ÿå¯ä»¥å°½æƒ…çš„å»æ”¾çºµ
uintptrï¼šç”¨äºæŒ‡é’ˆè¿ç®—ï¼ŒGC ä¸æŠŠ uintptr å½“æŒ‡é’ˆï¼Œuintptr æ— æ³•æŒæœ‰å¯¹è±¡ã€‚uintptr ç±»å‹çš„ç›®æ ‡ä¼šè¢«å›æ”¶ã€‚
unsafe.Pointer å¯ä»¥å’Œ æ™®é€šæŒ‡é’ˆ è¿›è¡Œç›¸äº’è½¬æ¢ã€‚
unsafe.Pointer å¯ä»¥å’Œ uintptr è¿›è¡Œç›¸äº’è½¬æ¢ã€‚
ä¹Ÿå°±æ˜¯è¯´ unsafe.Pointer æ˜¯æ¡¥æ¢ï¼Œå¯ä»¥è®©ä»»æ„ç±»å‹çš„æŒ‡é’ˆå®ç°ç›¸äº’è½¬æ¢ï¼Œä¹Ÿå¯ä»¥å°†ä»»æ„ç±»å‹çš„æŒ‡é’ˆè½¬æ¢ä¸º uintptr è¿›è¡ŒæŒ‡é’ˆè¿ç®—ã€‚
è¯¦ç»†è¯´æ˜</p>

<p>type ArbitraryType int</p>

<p>æ˜¯intçš„ä¸€ä¸ªåˆ«åï¼Œä½†æ˜¯golangä¸­ï¼Œå¯¹ArbitraryTypeèµ‹äºˆäº†ç‰¹æ®Šçš„æ„ä¹‰ï¼Œ</p>

<p>type Pointer *ArbitraryType</p>

<p>æ˜¯intæŒ‡é’ˆç±»å‹çš„ä¸€ä¸ªåˆ«åï¼Œåœ¨golangç³»ç»Ÿä¸­ï¼Œå¯ä»¥æŠŠPointerç±»å‹ï¼Œç†è§£æˆä»»ä½•æŒ‡é’ˆçš„äº²çˆ¹ã€‚</p>

<p>func Alignof(x ArbitraryType) uintptr</p>

<p>Alignofè¿”å›å˜é‡å¯¹é½å­—èŠ‚æ•°é‡</p>

<p>func Offsetof(x ArbitraryType) uintptr</p>

<p>Offsetofè¿”å›å˜é‡æŒ‡å®šå±æ€§çš„åç§»é‡ï¼Œè¿™ä¸ªå‡½æ•°è™½ç„¶æ¥æ”¶çš„æ˜¯ä»»ä½•ç±»å‹çš„å˜é‡ï¼Œä½†æ˜¯è¿™ä¸ªåˆä¸€ä¸ªå‰æï¼Œå°±æ˜¯å˜é‡è¦æ˜¯ä¸€ä¸ªstructç±»å‹ï¼Œä¸”è¿˜ä¸èƒ½ç›´æ¥å°†è¿™ä¸ªstructç±»å‹çš„å˜é‡å½“ä½œå‚æ•°ï¼Œåªèƒ½å°†è¿™ä¸ªstructç±»å‹å˜é‡çš„å±æ€§å½“ä½œå‚æ•°ã€‚</p>

<p>func Sizeof(x ArbitraryType) uintptr</p>

<p>Sizeof è¿”å›å˜é‡åœ¨å†…å­˜ä¸­å ç”¨çš„å­—èŠ‚æ•°ï¼Œåˆ‡è®°ï¼Œå¦‚æœæ˜¯sliceï¼Œåˆ™ä¸ä¼šè¿”å›è¿™ä¸ªsliceåœ¨å†…å­˜ä¸­çš„å®é™…å ç”¨é•¿åº¦ã€‚
ç¤ºä¾‹
é€šè¿‡æŒ‡é’ˆä¿®æ”¹ç»“æ„ä½“å­—æ®µ
package main</p>

<p>import (
    â€œfmtâ€
    â€œunsafeâ€
)</p>

<p>func main() {
    s := struct {
        a byte
        b byte
        c byte
        d int64
    }{0, 0, 0, 0}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å°†ç»“æ„ä½“æŒ‡é’ˆè½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
p := unsafe.Pointer(&amp;s)
// ä¿å­˜ç»“æ„ä½“çš„åœ°å€å¤‡ç”¨ï¼ˆåç§»é‡ä¸º 0ï¼‰
up0 := uintptr(p)
// å°†é€šç”¨æŒ‡é’ˆè½¬æ¢ä¸º byte å‹æŒ‡é’ˆ
pb := (*byte)(p)
// ç»™è½¬æ¢åçš„æŒ‡é’ˆèµ‹å€¼
*pb = 10
// ç»“æ„ä½“å†…å®¹è·Ÿç€æ”¹å˜
fmt.Println(s)

// åç§»åˆ°ç¬¬ 2 ä¸ªå­—æ®µ
up := up0 + unsafe.Offsetof(s.b)
// å°†åç§»åçš„åœ°å€è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
p = unsafe.Pointer(up)
// å°†é€šç”¨æŒ‡é’ˆè½¬æ¢ä¸º byte å‹æŒ‡é’ˆ
pb = (*byte)(p)
// ç»™è½¬æ¢åçš„æŒ‡é’ˆèµ‹å€¼
*pb = 20
// ç»“æ„ä½“å†…å®¹è·Ÿç€æ”¹å˜
fmt.Println(s)

// åç§»åˆ°ç¬¬ 3 ä¸ªå­—æ®µ
up = up0 + unsafe.Offsetof(s.c)
// å°†åç§»åçš„åœ°å€è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
p = unsafe.Pointer(up)
// å°†é€šç”¨æŒ‡é’ˆè½¬æ¢ä¸º byte å‹æŒ‡é’ˆ
pb = (*byte)(p)
// ç»™è½¬æ¢åçš„æŒ‡é’ˆèµ‹å€¼
*pb = 30
// ç»“æ„ä½“å†…å®¹è·Ÿç€æ”¹å˜
fmt.Println(s)

// åç§»åˆ°ç¬¬ 4 ä¸ªå­—æ®µ
up = up0 + unsafe.Offsetof(s.d)
// å°†åç§»åçš„åœ°å€è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
p = unsafe.Pointer(up)
// å°†é€šç”¨æŒ‡é’ˆè½¬æ¢ä¸º int64 å‹æŒ‡é’ˆ
pi := (*int64)(p)
// ç»™è½¬æ¢åçš„æŒ‡é’ˆèµ‹å€¼
*pi = 40
// ç»“æ„ä½“å†…å®¹è·Ÿç€æ”¹å˜
fmt.Println(s) }
</code></pre></div></div>

<p>è®¿é—®æ•°ç»„
package main</p>

<p>import (
     â€œfmtâ€
     â€œunsafeâ€
)</p>

<p>type Foo struct {
     A int
     B int
}</p>

<p>func main() {
     foo := &amp;Foo{1, 2}
     fmt.Println(foo)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> base := uintptr(unsafe.Pointer(foo))
 offset := unsafe.Offsetof(foo.A)

 ptr := unsafe.Pointer(base + offset)
 *(*int)(ptr) = 3

 fmt.Println(foo) }
</code></pre></div></div>

<p>ä¿®æ”¹å…¶å®ƒåŒ…ä¸­çš„ç»“æ„ä½“ç§æœ‰å­—æ®µ
æ–¹æ³•Aï¼ˆæŒ‡é’ˆéå†ï¼‰
package main</p>

<p>import (
    â€œfmtâ€
    â€œreflectâ€
    â€œstringsâ€
    â€œunsafeâ€
)</p>

<p>func main() {
    // åˆ›å»ºä¸€ä¸ª strings åŒ…ä¸­çš„ Reader å¯¹è±¡
    // å®ƒæœ‰ä¸‰ä¸ªç§æœ‰å­—æ®µï¼šs stringã€i int64ã€prevRune int
    sr := strings.NewReader(â€œabcdefâ€)
    // æ­¤æ—¶ sr ä¸­çš„æˆå‘˜æ˜¯æ— æ³•ä¿®æ”¹çš„
    fmt.Println(sr)
    // ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ unsafe æ¥è¿›è¡Œä¿®æ”¹
    // å…ˆå°†å…¶è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
    p := unsafe.Pointer(sr)
    // è·å–ç»“æ„ä½“åœ°å€
    up0 := uintptr(p)
    // ç¡®å®šè¦ä¿®æ”¹çš„å­—æ®µï¼ˆè¿™é‡Œä¸èƒ½ç”¨ unsafe.Offsetof è·å–åç§»é‡ï¼Œå› ä¸ºæ˜¯ç§æœ‰å­—æ®µï¼‰
    if sf, ok := reflect.TypeOf(<em>sr).FieldByName(â€œiâ€); ok {
        // åç§»åˆ°æŒ‡å®šå­—æ®µçš„åœ°å€
        up := up0 + sf.Offset
        // è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
        p = unsafe.Pointer(up)
        // è½¬æ¢ä¸ºç›¸åº”ç±»å‹çš„æŒ‡é’ˆ
        pi := (</em>int64)(p)
        // å¯¹æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å®¹è¿›è¡Œä¿®æ”¹
        *pi = 3 // ä¿®æ”¹ç´¢å¼•
    }
    // çœ‹çœ‹ä¿®æ”¹ç»“æœ
    fmt.Println(sr)
    // çœ‹çœ‹è¯»å‡ºçš„æ˜¯ä»€ä¹ˆ
    b, err := sr.ReadByte()
    fmt.Printf(â€œ%c, %v\nâ€, b, err)
}</p>

<p>æ–¹æ³•Bï¼ˆç±»å‹è½¬æ¢ï¼‰
// å®šä¹‰ä¸€ä¸ªå’Œ strings åŒ…ä¸­çš„ Reader ç›¸åŒçš„æœ¬åœ°ç»“æ„ä½“
type Reader struct {
    s        string
    i        int64
    prevRune int
}</p>

<p>func main() {
    // åˆ›å»ºä¸€ä¸ª strings åŒ…ä¸­çš„ Reader å¯¹è±¡
    sr := strings.NewReader(â€œabcdefâ€)
    // æ­¤æ—¶ sr ä¸­çš„æˆå‘˜æ˜¯æ— æ³•ä¿®æ”¹çš„
    fmt.Println(sr)
    // æˆ‘ä»¬å¯ä»¥é€šè¿‡ unsafe æ¥è¿›è¡Œä¿®æ”¹
    // å…ˆå°†å…¶è½¬æ¢ä¸ºé€šç”¨æŒ‡é’ˆ
    p := unsafe.Pointer(sr)
    // å†è½¬æ¢ä¸ºæœ¬åœ° Reader ç»“æ„ä½“
    pR := (<em>Reader)(p)
    // è¿™æ ·å°±å¯ä»¥è‡ªç”±ä¿®æ”¹ sr ä¸­çš„ç§æœ‰æˆå‘˜äº†
    (</em>pR).i = 3 // ä¿®æ”¹ç´¢å¼•
    // çœ‹çœ‹ä¿®æ”¹ç»“æœ
    fmt.Println(sr)
    // çœ‹çœ‹è¯»å‡ºçš„æ˜¯ä»€ä¹ˆ
    b, err := sr.ReadByte()
    fmt.Printf(â€œ%c, %v\nâ€, b, err)
}</p>

<p>ä»¥ä¸‹æ˜¯æ ‡å‡†åº“çš„æè¿°ï¼šunsafeåŒ…æä¾›äº†ä¸€äº›è·³è¿‡goè¯­è¨€ç±»å‹å®‰å…¨é™åˆ¶çš„æ“ä½œã€‚</p>

<p>APIï¼š
è¯¥åŒ…é‡Œé¢åªæœ‰ä¸€ä¸ªæ–‡ä»¶unsafe.goå’Œä¸€å †å£°æ˜ï¼Œå¹¶æ²¡æœ‰å…·ä½“çš„å®ç°ä»¥åŠæµ‹è¯•ç”¨ä¾‹å’Œä¾‹å­ã€‚é‚£æˆ‘è¿™é‡Œå°±æŠŠæ³¨é‡Šçš„ä¿¡æ¯ç®€å•ç¿»ä¸€ä¸‹ã€‚ç”¨ä½œå¯¹è¯¥åŒ…çš„ç†è§£ã€‚</p>

<p>UnsafeåŒ…ç»•è¿‡äº†Goè¯­è¨€çš„å®‰å…¨é™åˆ¶ã€‚ä½¿ç”¨è¯¥åŒ…ä¼šå¯¼è‡´ä½ çš„ç¨‹åºæ— æ³•ç§»æ¤ã€‚</p>

<p>// è¯¥ç±»å‹ä»…ç”¨äºæ–‡æ¡£çš„ç›®çš„ï¼Œå¹¶ä¸æ˜¯çœŸæ­£unsafeåŒ…çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒè¡¨ç¤ºGoè¯­è¨€ä¸­çš„ä»»æ„ç±»å‹</p>

<p>type ArbitraryType int</p>

<p>Pointerç±»å‹æ˜¯ä¸€ä¸ªæŒ‡å‘ä»»ä½•ç±»å‹çš„æŒ‡é’ˆç±»å‹ã€‚ä»–æœ‰å››ç§ç‰¹æ®Šçš„æ“ä½œï¼Œè¿™äº›æ“ä½œå…¶ä»–ç±»å‹ä¸å…è®¸ä½¿ç”¨ã€‚</p>

<ol>
  <li>
    <p>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆç±»å‹éƒ½å¯ä»¥è½¬æ¢ä¸ºPointerç±»å‹</p>
  </li>
  <li>
    <p>Pointerç±»å‹å¯ä»¥è½¬æ¢ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆç±»å‹</p>
  </li>
  <li>
    <p>Uintptrç±»å‹å€¼å¯ä»¥è½¬æ¢ä¸ºPointerç±»å‹</p>
  </li>
  <li>
    <p>Pointerç±»å‹å¯ä»¥è½¬æ¢ä¸ºuintptrç±»å‹å€¼</p>
  </li>
</ol>

<p>å› æ­¤ï¼Œé€šè¿‡Pointerç±»å‹ï¼Œç¨‹åºå¯ä»¥è¯»å†™ä»»æ„å†…å­˜ã€‚ä½¿ç”¨æ—¶åº”è¯¥éå¸¸å°å¿ƒã€‚</p>

<p>æ¶‰åŠåˆ°Pointerç±»å‹çš„ï¼Œä»¥ä¸‹å‡ ç§ä½¿ç”¨åœºæ™¯æ˜¯æœ‰æ•ˆçš„ï¼Œå…¶ä»–åœºæ™¯å‡ä¸å·ç§°æ”¯æŒã€‚ç”šè‡³åœ¨æœ‰æ•ˆçš„è¿™å‡ ä¸ªåœºæ™¯é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šä¸¥æ ¼çš„é™åˆ¶ã€‚</p>

<p>åœºæ™¯1ï¼šå°†ä»»æ„ç±»å‹è½¬æ¢ä¸ºPointerç±»å‹ç„¶åè½¬æ¢ä¸ºå…¶ä»–ç±»å‹ã€‚T1-&gt;Pointer-&gt;T2</p>

<p>é™åˆ¶ï¼šT2ä¸èƒ½é•¿äºT1ï¼Œä¸¤ç§ç±»å‹ä½¿ç”¨ç›¸åŒçš„å†…å­˜å¸ƒå±€æ–¹å¼ã€‚</p>

<p>è¿™ç§è½¬æ¢å…è®¸ä¸€ç§ç±»å‹è½¬æ¢ä¸ºå¦å¤–ä¸€ç§ç±»å‹ã€‚ä¾‹å­å¦‚ä¸‹ï¼ˆfloat64ç±»å‹è½¬æ¢ä¸ºuint64ç±»å‹ï¼‰</p>

<p>func Float64bits(f float64) uint64 {</p>

<p>return <em>(</em>uint64)(unsafe.Pointer(&amp;f))</p>

<p>}</p>

<p>åœºæ™¯2ï¼šå°†Pointerç±»å‹è½¬æ¢ä¸ºuintptrç±»å‹ï¼ˆä¸è¿”å›æŒ‡é’ˆç±»å‹ï¼‰</p>

<p>å°†Pointerè½¬æ¢ä¸ºuintptrç±»å‹ï¼Œå°†ä¼šå°†å†…å­˜åœ°å€ä½œä¸ºintå€¼è¿›è¡Œä¿å­˜ã€‚é€šå¸¸çš„ç”¨æ³•æ˜¯ç”¨äºå†…å­˜åœ°å€çš„æ‰“å°ã€‚ é€šå¸¸æƒ…å†µä¸‹å°†ä¸€ä¸ªuintptrçš„å€¼è½¬æ¢ä¸ºPointeræ˜¯æ— æ•ˆçš„ã€‚</p>

<p>Uintptræ˜¯ä¸€ä¸ªintç±»å‹çš„å€¼å¹¶ä¸æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå°†Pointerç±»å‹è½¬æ¢ä¸ºUintpträ¹‹åå°±ä¸¢å¤±äº†æŒ‡é’ˆçš„è¯­ä¹‰ã€‚å³ä½¿uintptråŒ…å«äº†æŸä¸ªå¯¹è±¡çš„åœ°å€ï¼Œå½“è¯¥å¯¹è±¡è¢«ç§»é™¤çš„æ—¶å€™ï¼Œåƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰æ—¢ä¸ä¼šæ›´æ–°uintptrçš„å€¼ï¼Œä¹Ÿä¸ä¼šå› ä¸ºuintptrå€¼é¿å…è¯¥å¯¹è±¡è¢«å›æ”¶ã€‚</p>

<p>æ‰€ä»¥ä»uintptråˆ°Pointerå”¯ä¸€æœ‰æ•ˆçš„è½¬æ¢æ˜¯æšä¸¾ç±»å‹</p>

<p>åœºæ™¯3ï¼šå°†Pointerè½¬æ¢ä¸ºuintptrï¼Œè®¡ç®—åè¿”å›</p>

<p>å¦‚æœpæ˜¯ä¸€ä¸ªæŒ‡å‘ä¸€ä¸ªå·²åˆ†é…çš„å¯¹è±¡çš„Pointerå¯¹è±¡ï¼Œå®ƒå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è¿›è¡Œåç§»ï¼š</p>

<p>//å°†pè½¬æ¢ä¸ºuintptrï¼ŒåŠ ä¸Šä¸€ä¸ªåç§»é‡ä¹‹åè½¬æ¢ä¸ºPointerå¯¹è±¡</p>

<p>p = unsafe.Pointer(uintptr(p) + offset)</p>

<p>æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼æ˜¯è®¿é—®ä¸€ä¸ªç»“æ„ä½“çš„æŸä¸€ä¸ªå­—æ®µæˆ–è€…æ•°ç»„çš„æŸä¸€ä¸ªå…ƒç´ ã€‚å¦‚ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼š</p>

<p>// ç±»ä¼¼äº f := unsafe.Pointer(&amp;s.f)</p>

<p>f := unsafe.Pointer(uintptr(unsafe.Pointer(&amp;s)) + unsafe.Offsetof(s.f))</p>

<p>// ç±»ä¼¼äº e := unsafe.Pointer(&amp;x[i])</p>

<p>e := unsafe.Pointer(uintptr(unsafe.Pointer(&amp;x[0])) + i*unsafe.Sizeof(x[0]))</p>

<p>é€šè¿‡è¿™ç§æ–¹å¼è¿›è¡Œç»“æ„ä½“çš„åç§»æ˜¯æœ‰æ•ˆçš„ï¼Œé€šè¿‡&amp;è·å–æŒ‡é’ˆåŒæ ·æ˜¯æœ‰æ•ˆçš„ã€‚ä»»ä½•æƒ…å†µä¸‹ï¼Œè¿”å›çš„æŒ‡é’ˆéƒ½å¿…é¡»æŒ‡å‘åŸå§‹åˆ†é…çš„å¯¹è±¡ä¸Šã€‚è¿™ä¸€ç‚¹ä¸Cä¸åŒï¼ŒæŒ‡é’ˆè¶…è¿‡å¯¹è±¡å†…å­˜åˆ†é…åœ°å€åæ˜¯æ— æ•ˆçš„ã€‚æ¯”å¦‚ï¼š</p>

<p>// æ— æ•ˆï¼šå› ä¸ºendæŒ‡é’ˆå·²ç»è¶…å‡ºäº†så¯¹è±¡çš„ç”³è¯·ç©ºé—´</p>

<p>var s thing</p>

<p>end = unsafe.Pointer(uintptr(unsafe.Pointer(&amp;s)) + unsafe.Sizeof(s))</p>

<p>// æ— æ•ˆï¼šåŸå› åŒä¸Š</p>

<p>b := make([]byte, n)</p>

<p>end = unsafe.Pointer(uintptr(unsafe.Pointer(&amp;b[0])) + uintptr(n))</p>

<p>æ­¤å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§è½¬æ¢å¿…é¡»åœ¨åŒä¸€ä¸ªè¡¨è¾¾å¼ä¸­å®Œæˆï¼Œå¹¶ä¸”ä¸­é—´åªèƒ½åŒ…å«intç±»å‹çš„è¿ç®—ç¬¦ã€‚æ¯”å¦‚ï¼š</p>

<p>// æ— æ•ˆï¼šä¸èƒ½å…ˆå­˜å‚¨åè½¬æ¢ï¼Œå¿…é¡»åœ¨åŒä¸€ä¸ªè¡¨è¾¾å¼ä¸­å®Œæˆè¯¥æ“ä½œã€‚</p>

<p>u := uintptr(p)</p>

<p>p = unsafe.Pointer(u + offset)</p>

<p>åœºæ™¯4ï¼šè°ƒç”¨syscall.Syscallå‡½æ•°çš„æ—¶å€™ä»Pointerè½¬æ¢ä¸ºuintptr</p>

<p>åœ¨syscallåŒ…ä¸­ï¼ŒåŒ…å«è¿™äº›uintptrå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œåœ¨ä¼ å…¥æ“ä½œç³»ç»Ÿåæœ‰å¯èƒ½ä¼šå°†è¿™äº›å‚æ•°é‡æ–°è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼ˆå½“ç„¶è¿™ä¾èµ–äºç³»ç»Ÿå‡½æ•°çš„å…·ä½“å®ç°ï¼‰ã€‚</p>

<p>ä¹Ÿå°±æ˜¯è¯´æœ‰ä¸€äº›ç³»ç»Ÿå‡½æ•°å¯ä»¥å°†ä¼ å…¥çš„uintptrç±»å‹éšè¯•çš„è½¬æ¢ä¸ºæŒ‡é’ˆå¯¹è±¡å¹¶ä½¿ç”¨ã€‚</p>

<p>é™åˆ¶ï¼šè¿™ç§Pointerç±»å‹å‘uintptrçš„è½¬æ¢å¿…é¡»è¦å’Œsyscallè°ƒç”¨å‡½æ•°å‡ºç°åœ¨åŒä¸€æ¡è¯­å¥ä¸­ã€‚å¦‚ä¸‹é¢å®ä¾‹ï¼š</p>

<p>syscall.Syscall(SYS_READ, uintptr(fd), uintptr(unsafe.Pointer(p)), uintptr(n))</p>

<p>è¿™æ˜¯ä¸ºäº†é¿å…è°ƒç”¨æ—¶ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡å·²ç»è¢«é‡Šæ”¾äº†ã€‚å¦‚ä¸‹ç¤ºä¾‹å°±æ˜¯æ— æ•ˆçš„ï¼Œå­˜åœ¨å¯¹è±¡è¢«é‡Šæ”¾çš„é£é™©ã€‚</p>

<p>u := uintptr(unsafe.Pointer(p))</p>

<p>syscall.Syscall(SYS_READ, uintptr(fd), u, uintptr(n))</p>

<p>åœºæ™¯5ï¼šå°†reflect.Value.Pointeræˆ–è€…reflect.Value.UnsafeAddrçš„ç»“æœä»uintptrè½¬æ¢ä¸ºPointerç±»å‹</p>

<p>åœ¨reflectåŒ…ä¸­çš„Value.pointerå’Œundafeaddrä¸¤ä¸ªå‡½æ•°è¿”å›çš„éƒ½æ˜¯uintptræ¥ä»£æ›¿Pointerå¯¹è±¡ï¼Œä»¥é˜²æ­¢è°ƒç”¨è€…åœ¨æ²¡æœ‰import unsafeåŒ…çš„æƒ…å†µä¸‹å°†è¯¥ç»“æœè½¬æ¢ä¸ºä»»æ„ç±»å‹ã€‚ä½†æ˜¯è¿™å°±æ„å‘³ç€è¿™ä¸ªç»“æœå¿…é¡»åœ¨è¿”å›ä¹‹å‰ç«‹åˆ»è½¬æ¢ä¸ºæŒ‡é’ˆï¼Œå¦åˆ™è¯¥å¯¹è±¡æœ‰è¢«é‡Šæ”¾çš„é£é™©ã€‚å¦‚ä¸‹ï¼š</p>

<p>p := (*int)(unsafe.Pointer(reflect.ValueOf(new(int)).Pointer()))</p>

<p>// ä¸‹é¢è¿™ä¸ªç¤ºä¾‹æ˜¯æ— æ•ˆçš„ï¼Œç”³è¯·çš„å¯¹è±¡æœ‰è¢«GCå›æ”¶çš„é£é™©</p>

<p>u := reflect.ValueOf(new(int)).Pointer()</p>

<p>p := (*int)(unsafe.Pointer(u))</p>

<p>åœºæ™¯6ï¼šå°†ä¸€ä¸ªreflect.SliceHeader æˆ– reflect.StringHeaderçš„Dataå­—æ®µè½¬æ¢ä¸ºPointerï¼ˆå­˜ç–‘ï¼Œè¿˜æ²¡æœ‰ç†è§£ï¼‰</p>

<p>å’Œå‰é¢çš„ä¾‹å­ä¸€æ ·ï¼Œåå°„ç±»å‹å°†ç»“æ„ä½“ä¸­çš„Dataå­—æ®µå£°æ˜ä¸ºuintptrï¼Œä»¥é˜²æ­¢åœ¨æ²¡æœ‰import unsafeä¹‹å‰å°±å°†è¯¥å€¼è½¬æ¢ä¸ºä»»æ„ç±»å‹ã€‚ä½†æ˜¯è¿™å°±æ„å‘³ç€è¿™ä¸¤ä¸ªç±»å‹åªæœ‰åœ¨æŒ‡å‘ä¸€ä¸ªæ´»åŠ¨çš„åˆ‡ç‰‡æˆ–è€…å­—ç¬¦ä¸²å€¼çš„æ—¶å€™æœ‰æ•ˆã€‚</p>

<p>var s string</p>

<p>hdr := (*reflect.StringHeader)(unsafe.Pointer(&amp;s)) // case 1</p>

<p>hdr.Data = uintptr(unsafe.Pointer(p)) // case 6 (this case)</p>

<p>hdr.Len = n</p>

<p>åœ¨è¿™ç§ç”¨æ³•ä¸­ï¼Œhdr.Dataå®é™…ä¸Šæ˜¯æŒ‡å‘å­—ç¬¦ä¸²å¤´çš„å¦å¤–ä¸€ç§æ–¹å¼ï¼Œè€Œä¸æ˜¯uintptrå€¼æœ¬èº«ã€‚</p>

<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œreflect.SliceHeader and reflect.StringHeaderè¿™ä¸¤ä¸ªå¯¹è±¡åªæœ‰åœ¨ä¸‹é¢è¿™ä¸ªæƒ…å†µä¸‹è¢«ä½¿ç”¨ï¼Œä½œä¸º*reflect.SliceHeader and *reflect.StringHeaderæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€å—åˆ‡ç‰‡æˆ–è€…å­—ç¬¦ä¸²ã€‚</p>

<p>ç¨‹åºé‡Œé¢ä¸åº”è¯¥å£°æ˜è¿™äº›å¯¹è±¡ï¼Œå¦‚ä¸‹å›¾ï¼š</p>

<p>//æ— æ•ˆï¼šç›´æ¥å£°æ˜ï¼Œä¸ä¼šå°†Dataä¿¡æ¯ä¿å­˜ä¸ºå¼•ç”¨</p>

<p>var hdr reflect.StringHeader</p>

<p>hdr.Data = uintptr(unsafe.Pointer(p))</p>

<p>hdr.Len = n</p>

<p>s := <em>(</em>string)(unsafe.Pointer(&amp;hdr)) // p æœ‰å¯èƒ½å·²ç»è¢«å›æ”¶</p>

<p>/*</p>

<p>Sizeofè¿”å›ç±»å‹væœ¬èº«æ•°æ®æ‰€å ç”¨çš„å­—èŠ‚æ•°ã€‚è¿”å›å€¼æ˜¯â€œé¡¶å±‚â€çš„æ•°æ®å æœ‰çš„å­—èŠ‚æ•°ã€‚ä¾‹å¦‚ï¼Œè‹¥væ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå®ƒä¼šè¿”å›è¯¥åˆ‡ç‰‡æè¿°ç¬¦çš„å¤§å°ï¼Œè€Œéè¯¥åˆ‡ç‰‡åº•å±‚å¼•ç”¨çš„å†…å­˜çš„å¤§å°ã€‚</p>

<p>*/</p>

<p>func Sizeofï¼ˆx ArbitraryTypeï¼‰uintptr</p>

<p>/*</p>

<p>Offsetofè¿”å›ç±»å‹væ‰€ä»£è¡¨çš„ç»“æ„ä½“å­—æ®µåœ¨ç»“æ„ä½“ä¸­çš„åç§»é‡ï¼Œå®ƒå¿…é¡»ä¸ºç»“æ„ä½“ç±»å‹çš„å­—æ®µçš„å½¢å¼ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒè¿”å›è¯¥ç»“æ„èµ·å§‹å¤„ä¸è¯¥å­—æ®µèµ·å§‹å¤„ä¹‹é—´çš„å­—èŠ‚æ•°ã€‚</p>

<p>*/</p>

<p>func Offsetof(x ArbitraryType) uintptr</p>

<p>/*</p>

<p>Alignofè¿”å›ç±»å‹vçš„å¯¹é½æ–¹å¼ï¼ˆå³ç±»å‹våœ¨å†…å­˜ä¸­å ç”¨çš„å­—èŠ‚æ•°ï¼‰ï¼›è‹¥æ˜¯ç»“æ„ä½“ç±»å‹çš„å­—æ®µçš„å½¢å¼ï¼Œå®ƒä¼šè¿”å›å­—æ®µfåœ¨è¯¥ç»“æ„ä½“ä¸­çš„å¯¹é½æ–¹å¼ã€‚</p>

<p>*/</p>

<p>func Alignof(x ArbitraryType) uintptr</p>

<p>Pointerä¸uintptr
unsafe.Pointeråœ¨Golangä¸­æ˜¯ç”¨äºå„ç§ç±»å‹è½¬åŒ–çš„æ¡¥æ¢ï¼ŒPointerä»£è¡¨äº†ä¸€ä¸ªæŒ‡å‘ä»»æ„ç±»å‹çš„æŒ‡é’ˆã€‚</p>

<p>uintptræ˜¯Golangçš„å†…ç½®ç±»å‹ï¼Œæ˜¯èƒ½å­˜å‚¨æŒ‡é’ˆçš„æ•´å‹ï¼Œuintptrçš„åº•å±‚ç±»å‹æ˜¯intï¼Œå®ƒå’Œunsafe.Pointerå¯ç›¸äº’è½¬æ¢ã€‚</p>

<p>Pointerä¸uintptrçš„åŒºåˆ«åœ¨äºï¼š</p>

<p>unsafe.Pointeråªæ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„ç±»å‹ï¼Œä½†æ˜¯ä¸èƒ½åƒCä¸­çš„æŒ‡é’ˆé‚£æ ·ä½œè®¡ç®—ï¼Œè€Œåªèƒ½ç”¨äºè½¬åŒ–ä¸åŒç±»å‹çš„æŒ‡é’ˆï¼›å¦‚æœunsafe.Pointerå˜é‡ä»ç„¶æœ‰æ•ˆï¼Œåˆ™ç”±unsafe.Pointerå˜é‡è¡¨ç¤ºçš„åœ°å€å¤„çš„æ•°æ®ä¸ä¼šè¢«GCå›æ”¶ï¼›
uintptræ˜¯å¯ä»¥ç”¨äºæŒ‡é’ˆè¿ç®—çš„ï¼Œä½†æ˜¯æ— æ³•æŒæœ‰å¯¹è±¡ï¼ŒGCå¹¶ä¸æŠŠuintptrå½“åšæŒ‡é’ˆï¼Œæ‰€ä»¥uintptrç±»å‹çš„ç›®æ ‡ä¼šè¢«å›æ”¶ã€‚
åœ¨Golangä¸­å‡ºäºå®‰å…¨çš„åŸå› ï¼Œä¸å…è®¸ä¸¤ä¸ªä¸åŒæŒ‡é’ˆç±»å‹çš„å€¼å»ç›´æ¥è½¬æ¢ï¼›ä¹Ÿä¸å…è®¸æŒ‡é’ˆç±»å‹å’Œuintptrçš„å€¼å»ç›´æ¥è½¬æ¢ã€‚ä½†æ˜¯å€ŸåŠ©unsafe.Pointerï¼Œæˆ‘ä»¬</p>

<p>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerï¼›
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼ï¼›
uintptrå¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerï¼›
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºuintptrã€‚
ä¾‹å­
é€šè¿‡unsafe.Pointeræ¥è½¬åŒ–ç±»å‹
åœ¨æ­¤ä¹‹å‰æç¤ºä¸€ä¸‹è¿™é‡Œæˆ‘ä»¬è¯´çš„ç±»å‹çš„è½¬åŒ–ï¼Œæ˜¯è½¬åŒ–å‰åå˜é‡ä¸ºåŒä¸€å˜é‡ï¼Œè€Œä¸æ˜¯è¿™æ ·ä¸ºä¸¤ä¸ªå˜é‡ï¼š</p>

<p>func main() {
    var a int64 = 3
    var b float64 = float64(a)
    fmt.Println(&amp;a) // 0xc42000e248
    fmt.Println(&amp;b) // 0xc42000e250
} <br />
å¦‚æœæˆ‘ä»¬è¦æ¥åšä¸€ä¸ªå¼ºåˆ¶çš„è½¬åŒ–çš„è¯ï¼Œa = float64(a),Golangä¼šæŠ¥é”™ï¼šcannot use float64(a) (type float64) as type int64 in assignmentã€‚</p>

<p>ä½¿ç”¨unsafe.Pointeræ¥å°†T1è½¬åŒ–ä¸ºT2ï¼Œä¸€ä¸ªå¤§è‡´çš„è¯­æ³•ä¸º<em>(</em>T2)(unsafe.Pointer(&amp;t1))</p>

<p>func main() {
    var n int64 = 3
    var pn = &amp;n // nçš„æŒ‡é’ˆ
    var pf = (<em>float64)(unsafe.Pointer(pn)) // é€šè¿‡Pointeræ¥å°†nçš„ç±»å‹è½¬ä¸ºfloat
    fmt.Println(</em>pf) // 2.5e-323
    *pf = 3.5
    fmt.Println(n) // 4615063718147915776</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println(pf) // 0xc42007a050
fmt.Println(pn) // 0xc42007a050 } è¿™ä¸ªä¾‹å­è™½ç„¶æ²¡æœ‰å®é™…çš„æ„ä¹‰ï¼Œä½†æ˜¯ç»•è¿‡äº†Golangç±»å‹ç³»ç»Ÿå’Œå†…å­˜å®‰å…¨ï¼Œå°†ä¸€ä¸ªå˜é‡çš„ç±»å‹ä½œäº†è½¬åŒ–ã€‚
</code></pre></div></div>

<p>é€šè¿‡uintptræ¥è®¡ç®—åç§»é‡
æˆ‘ä»¬çŸ¥é“åœ¨Golangä¸­æŒ‡é’ˆæ˜¯ä¸èƒ½ç”¨æ¥è®¡ç®—çš„ï¼Œä½†æ˜¯å€ŸåŠ©uintptræˆ‘ä»¬å¯ä»¥ä½œè®¡ç®—ï¼š</p>

<p>func main() {
    a := [4]int{0, 1, 2, 3}
    p1 := unsafe.Pointer(&amp;a[1]) // indexä¸º1çš„å…ƒç´ 
    p3 := unsafe.Pointer(uintptr(p1) + 2 * unsafe.Sizeof(a[0])) // æ‹¿åˆ°indexä¸º3çš„æŒ‡é’ˆ
    <em>(</em>int)(p3) = 4 // é‡æ–°èµ‹å€¼
    fmt.Println(a) // a = [0 1 2 4]
}
åŒæ ·çš„å¯¹äºä¸€ä¸ªç»“æ„ä½“æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¢å‡åç§»é‡æ¥å®šä½ä¸åŒçš„æˆå‘˜å˜é‡ï¼Œå…¶ä¾èµ–çš„æ³¨æ„æ€æƒ³æ˜¯ï¼šç»“æ„ä½“çš„æˆå‘˜åœ¨å†…å­˜ä¸­çš„åˆ†é…æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œç»“æ„ä½“ä¸­ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€å°±æ˜¯è¿™ä¸ªç»“æ„ä½“çš„åœ°å€ï¼š</p>

<p>type Person struct {
    name   string
    age    int
}</p>

<p>func main() {
    a := Person{â€œJasperâ€, 27}
    pa := unsafe.Pointer(&amp;a)
    aname := (<em>string)(unsafe.Pointer(uintptr(pa) + unsafe.Offsetof(a.name))) // pname := (</em>string)(unsafe.Pointer(uintptr(pa))) è¿™æ ·ä¹Ÿæ˜¯å¯ä»¥çš„
    aage := (*int)(unsafe.Pointer(uintptr(pa) + unsafe.Offsetof(a.age)))
    *aname = â€œJasper2â€
    *aage = 28
    fmt.Println(a) // {Jasper2 28}
} <br />
åº”ç”¨
ä¸Šé¢ç»™çš„ä¾‹å­éƒ½æ˜¯ä¸€äº›æ¦‚å¿µä¸Šçš„ï¼Œæ²¡æœ‰å¤ªå¤šçš„å®é™…æ„ä¹‰ï¼Œé‚£ä¹ˆåœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬æœ‰æœ‰å“ªäº›åœ°æ–¹æ˜¯å¯ä»¥æˆ–è€…å¿…é¡»å€ŸåŠ©Pointerä¸uintptræ¥å®ç°çš„å‘¢ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€äº›ä¾‹å­ã€‚</p>

<p>stringä¸[]byteç›¸äº’è½¬æ¢
æˆ‘ä»¬åœ¨å†™ç¨‹åºçš„æ—¶å€™ä¼šç»å¸¸é‡åˆ°stringä¸[]byteç›¸äº’è½¬æ¢çš„æƒ…å†µï¼Œè¿™ç§è½¬åŒ–å…¶å®ä»£ä»·å¾ˆé«˜ï¼Œå› ä¸ºstringä¸[]byteçš„å†…å­˜ç©ºé—´ä¸å…±äº«ï¼Œæ‰€ä»¥æ¯æ¬¡è½¬æ¢éƒ½ä¼´éšç€å†…å­˜çš„åˆ†é…ä¸åº•å±‚å­—èŠ‚çš„æ‹·è´ã€‚è€Œæˆ‘ä»¬ä½¿ç”¨unsafeå°±å¯ä»¥é¿å¼€è¿™äº›ï¼Œä»è€Œæå‡æ€§èƒ½ã€‚</p>

<p>func string2byte(s string) []byte {
    sh := (<em>reflect.StringHeader)(unsafe.Pointer(&amp;s))
    bh := reflect.SliceHeader{
        Data: sh.Data,
        Len:  sh.Len,
        Cap:  sh.Len,
    }
    return *(</em>[]byte)(unsafe.Pointer(&amp;bh))
}</p>

<p>func byte2string(b []byte) string{
    bh := (<em>reflect.SliceHeader)(unsafe.Pointer(&amp;b))
    sh := reflect.StringHeader{
        Data: bh.Data,
        Len:  bh.Len,
    }
    return *(</em>string)(unsafe.Pointer(&amp;sh))
}
è¿™æ ·çš„è½¬åŒ–è¿‡ç¨‹ä¾èµ–äºäºŒè€…çš„æ•°æ®ç»“æ„ï¼š</p>

<p>struct string{
    uint8 *str;
    int len;
  }</p>

<p>struct []uint8{
    uint8 *array;
    int len;
    int cap;
  }<br />
æ³¨æ„ï¼Œè¿™æ ·è™½ç„¶å¯ä»¥å®ç°ï¼Œä½†å¼ºçƒˆæ¨èä¸è¦ä½¿ç”¨è¿™ç§æ–¹æ³•æ¥è½¬æ¢ç±»å‹ï¼Œå› ä¸ºè¿™æ ·ä¼šå¯¼è‡´ä¿®æ”¹è½¬åŒ–è¿‡åçš„å€¼ä¼šå½±å“ä¹‹å‰çš„å˜é‡ã€‚</p>

<p>ä¿®æ”¹ç§æœ‰æˆå‘˜å˜é‡
åœ¨Golangä¸­å¯¹äºä¸åœ¨åŒä¸€ä¸ªpackageé‡Œé¢çš„å¯¹è±¡çš„ç§æœ‰å˜é‡(å°å†™çš„)æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹çš„ï¼Œä½†æ˜¯ä½¿ç”¨unsafeå¯ä»¥åšåˆ°ï¼š</p>

<p>package p</p>

<p>import (
    â€œfmtâ€
)</p>

<p>type V struct {
    i int32
    j int64
}</p>

<p>func (this V) PrintI() {
    fmt.Printf(â€œi=%d\nâ€, this.i)
}</p>

<p>func (this V) PrintJ() {
    fmt.Printf(â€œj=%d\nâ€, this.j)
}
æˆ‘ä»¬åœ¨miané‡Œé¢å®ç°æ¥ç›´æ¥ä¿®æ”¹i,jçš„å€¼ï¼š</p>

<p>package main</p>

<p>import (
    â€œpâ€
    â€œunsafeâ€
)</p>

<p>func main() {
    var v <em>p.V = new(p.V)
    var i *int32 = (</em>int32)(unsafe.Pointer(v))
    <em>i = int32(1)
    var j *int64 = (</em>int64)(unsafe.Pointer(uintptr(unsafe.Pointer(v)) +unsafe.Sizeof(int32(0))))
    *j = int64(2)
    v.PrintI()
    v.PrintJ()
}
å…¶å®åœ¨ä¸Šé¢ç”¨uintptrè®¡ç®—åç§»é‡ä»‹ç»çš„é‚£æ ·ï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°ä¿®æ”¹ç§æœ‰å˜é‡çš„ç›®çš„ã€‚è™½ç„¶è¾¾åˆ°äº†ç›®çš„ï¼Œä½†æ˜¯åœ¨å¼€å‘ä¸­å…¶å®å¹¶ä¸å»ºè®®è¿™ä¹ˆå¹²ã€‚</p>

<p>åœ¨åå°„ä¸­ä½¿ç”¨
reflectåŒ…ä¸­Valueç±»å‹çš„æ–¹æ³•ä¸­åç§°ä¸ºPointerå’ŒUnsafeAddrçš„æ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯uintptrè€Œä¸æ˜¯unsafe.Pointer,ç›®çš„æ˜¯ä¸ºäº†ä½¿è°ƒç”¨è€…å¯ä»¥å°†ç»“æœè½¬ä¸ºä»»æ„ç±»å‹è€Œä¸ç”¨å¯¼å…¥unsafeåŒ…ã€‚ç„¶è€Œï¼Œè¿™æ„å‘³ç€è°ƒç”¨ç»“æœå¿…é¡»é©¬ä¸Šå†è°ƒç”¨å®Œæˆåè½¬ä¸ºPointer,å¹¶ä¸”æ˜¯åœ¨åŒä¸€ä¸ªè¡¨è¾¾å¼ä¸­å®Œæˆï¼›å¦‚ä¸‹ï¼š</p>

<p>p := (*int)(unsafe.Pointer(reflect.ValueOf(new(int)).Pointer()))</p>

<p>The unsafe Package in Golang
Golangçš„unsafeåŒ…æ˜¯ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„åŒ…ã€‚ ä¸ºä»€ä¹ˆè¿™æ ·è¯´å‘¢ï¼Ÿ æœ¬æ–‡å°†è¯¦ç»†è§£é‡Šã€‚</p>

<p>æ¥è‡ªgoè¯­è¨€å®˜æ–¹æ–‡æ¡£çš„è­¦å‘Š
unsafeåŒ…çš„æ–‡æ¡£æ˜¯è¿™ä¹ˆè¯´çš„ï¼š</p>

<p>å¯¼å…¥unsafeçš„è½¯ä»¶åŒ…å¯èƒ½ä¸å¯ç§»æ¤ï¼Œå¹¶ä¸”ä¸å—Go 1å…¼å®¹æ€§æŒ‡å—çš„ä¿æŠ¤ã€‚
Go 1 å…¼å®¹æ€§æŒ‡å—è¿™ä¹ˆè¯´ï¼š</p>

<p>å¯¼å…¥unsafeè½¯ä»¶åŒ…å¯èƒ½å–å†³äºGoå®ç°çš„å†…éƒ¨å±æ€§ã€‚ æˆ‘ä»¬ä¿ç•™å¯¹å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒçš„å®ç°è¿›è¡Œæ›´æ”¹çš„æƒåˆ©ã€‚
å½“ç„¶åŒ…åç§°æš—ç¤ºunsafeåŒ…æ˜¯ä¸å®‰å…¨çš„ã€‚ ä½†è¿™ä¸ªåŒ…æœ‰å¤šå±é™©å‘¢ï¼Ÿ è®©æˆ‘ä»¬å…ˆçœ‹çœ‹unsafeåŒ…çš„ä½œç”¨ã€‚</p>

<p>UnsafeåŒ…çš„ä½œç”¨
ç›´åˆ°ç°åœ¨ï¼ˆGo1.7ï¼‰ï¼ŒunsafeåŒ…å«ä»¥ä¸‹èµ„æºï¼š</p>

<p>ä¸‰ä¸ªå‡½æ•°ï¼š</p>

<p>func Alignofï¼ˆvariable ArbitraryTypeï¼‰uintptr
func Offsetofï¼ˆselector ArbitraryTypeï¼‰uintptr
func Sizeofï¼ˆvariable ArbitraryTypeï¼‰uintptr
å’Œä¸€ç§ç±»å‹ï¼š</p>

<p>ç±»å‹Pointer * ArbitraryType
è¿™é‡Œï¼ŒArbitraryTypeä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç±»å‹ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå ä½ç¬¦ã€‚</p>

<p>ä¸Golangä¸­çš„å¤§å¤šæ•°å‡½æ•°ä¸åŒï¼Œä¸Šè¿°ä¸‰ä¸ªå‡½æ•°çš„è°ƒç”¨å°†å§‹ç»ˆåœ¨ç¼–è¯‘æ—¶æ±‚å€¼ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶ã€‚ è¿™æ„å‘³ç€å®ƒä»¬çš„è¿”å›ç»“æœå¯ä»¥åˆ†é…ç»™å¸¸é‡ã€‚</p>

<p>ï¼ˆBTWï¼ŒunsafeåŒ…ä¸­çš„å‡½æ•°ä¸­éå”¯ä¸€è°ƒç”¨å°†åœ¨ç¼–è¯‘æ—¶æ±‚å€¼ã€‚å½“ä¼ é€’ç»™lenå’Œcapçš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„å€¼æ—¶ï¼Œå†…ç½®å‡½æ•°å’Œcapå‡½æ•°çš„è°ƒç”¨ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘æ—¶è¢«æ±‚å€¼ã€‚ï¼‰</p>

<p>é™¤äº†è¿™ä¸‰ä¸ªå‡½æ•°å’Œä¸€ä¸ªç±»å‹å¤–ï¼ŒæŒ‡é’ˆåœ¨unsafeåŒ…ä¹Ÿä¸ºç¼–è¯‘å™¨æœåŠ¡ã€‚</p>

<p>å‡ºäºå®‰å…¨åŸå› ï¼ŒGolangä¸å…è®¸ä»¥ä¸‹ä¹‹é—´çš„ç›´æ¥è½¬æ¢ï¼š</p>

<p>ä¸¤ä¸ªä¸åŒæŒ‡é’ˆç±»å‹çš„å€¼ï¼Œä¾‹å¦‚ int64å’Œ float64ã€‚</p>

<p>æŒ‡é’ˆç±»å‹å’Œuintptrçš„å€¼ã€‚
ä½†æ˜¯å€ŸåŠ©unsafe.Pointerï¼Œæˆ‘ä»¬å¯ä»¥æ‰“ç ´Goç±»å‹å’Œå†…å­˜å®‰å…¨æ€§ï¼Œå¹¶ä½¿ä¸Šé¢çš„è½¬æ¢æˆä¸ºå¯èƒ½ã€‚è¿™æ€ä¹ˆå¯èƒ½å‘ç”Ÿï¼Ÿè®©æˆ‘ä»¬é˜…è¯»unsafeåŒ…æ–‡æ¡£ä¸­åˆ—å‡ºçš„è§„åˆ™ï¼š</p>

<p>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerã€‚
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆå€¼ã€‚
uintptrå¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerã€‚
unsafe.Pointerå¯ä»¥è½¬æ¢ä¸ºuintptrã€‚
è¿™äº›è§„åˆ™ä¸Goè§„èŒƒä¸€è‡´ï¼š</p>

<p>åº•å±‚ç±»å‹uintptrçš„ä»»ä½•æŒ‡é’ˆæˆ–å€¼éƒ½å¯ä»¥è½¬æ¢ä¸ºæŒ‡é’ˆç±»å‹ï¼Œåä¹‹äº¦ç„¶ã€‚
è§„åˆ™è¡¨æ˜unsafe.Pointerç±»ä¼¼äºcè¯­è¨€ä¸­çš„void ã€‚å½“ç„¶ï¼Œvoid åœ¨Cè¯­è¨€é‡Œæ˜¯å±é™©çš„ï¼</p>

<p>åœ¨ä¸Šè¿°è§„åˆ™ä¸‹ï¼Œå¯¹äºä¸¤ç§ä¸åŒç±»å‹T1å’ŒT2ï¼Œå¯ä»¥ä½¿ T1å€¼ä¸unsafe.Pointerå€¼ä¸€è‡´ï¼Œç„¶åå°†unsafe.Pointerå€¼è½¬æ¢ä¸º T2å€¼ï¼ˆæˆ–uintptrå€¼ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ç»•è¿‡Goç±»å‹ç³»ç»Ÿå’Œå†…å­˜å®‰å…¨æ€§ã€‚å½“ç„¶ï¼Œæ»¥ç”¨è¿™ç§æ–¹å¼æ˜¯å¾ˆå±é™©çš„ã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œunsafeâ€
)
func main() {
    var n int64 = 5
    var pn = &amp;n
    var pf = (<em>float64)(unsafe.Pointer(pn))
    // now, pn and pf are pointing at the same memory address
    fmt.Println(</em>pf) // 2.5e-323
    *pf = 3.14159
    fmt.Println(n) // 4614256650576692846
}
åœ¨è¿™ä¸ªä¾‹å­ä¸­çš„è½¬æ¢å¯èƒ½æ˜¯æ— æ„ä¹‰çš„ï¼Œä½†å®ƒæ˜¯å®‰å…¨å’Œåˆæ³•çš„ï¼ˆä¸ºä»€ä¹ˆå®ƒæ˜¯å®‰å…¨çš„ï¼Ÿï¼‰ã€‚</p>

<p>å› æ­¤ï¼Œèµ„æºåœ¨unsafeåŒ…ä¸­çš„ä½œç”¨æ˜¯ä¸ºGoç¼–è¯‘å™¨æœåŠ¡ï¼Œunsafe.Pointerç±»å‹çš„ä½œç”¨æ˜¯ç»•è¿‡Goç±»å‹ç³»ç»Ÿå’Œå†…å­˜å®‰å…¨ã€‚</p>

<p>å†æ¥ä¸€ç‚¹ unsafe.Pointer å’Œ uintptr
è¿™é‡Œæœ‰ä¸€äº›å…³äºunsafe.Pointerå’Œuintptrçš„äº‹å®ï¼š</p>

<p>uintptræ˜¯ä¸€ä¸ªæ•´æ•°ç±»å‹ã€‚
å³ä½¿uintptrå˜é‡ä»ç„¶æœ‰æ•ˆï¼Œç”±uintptrå˜é‡è¡¨ç¤ºçš„åœ°å€å¤„çš„æ•°æ®ä¹Ÿå¯èƒ½è¢«GCå›æ”¶ã€‚
unsafe.Pointeræ˜¯ä¸€ä¸ªæŒ‡é’ˆç±»å‹ã€‚
ä½†æ˜¯unsafe.Pointerå€¼ä¸èƒ½è¢«å–æ¶ˆå¼•ç”¨ã€‚
å¦‚æœunsafe.Pointerå˜é‡ä»ç„¶æœ‰æ•ˆï¼Œåˆ™ç”±unsafe.Pointerå˜é‡è¡¨ç¤ºçš„åœ°å€å¤„çš„æ•°æ®ä¸ä¼šè¢«GCå›æ”¶ã€‚
unsafe.Pointeræ˜¯ä¸€ä¸ªé€šç”¨çš„æŒ‡é’ˆç±»å‹ï¼Œå°±åƒ* intç­‰ã€‚
ç”±äºuintptræ˜¯ä¸€ä¸ªæ•´æ•°ç±»å‹ï¼Œuintptrå€¼å¯ä»¥è¿›è¡Œç®—æœ¯è¿ç®—ã€‚ æ‰€ä»¥é€šè¿‡ä½¿ç”¨uintptrå’Œunsafe.Pointerï¼Œæˆ‘ä»¬å¯ä»¥ç»•è¿‡é™åˆ¶ï¼Œ* Tå€¼ä¸èƒ½åœ¨Golangä¸­è®¡ç®—åç§»é‡ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œunsafeâ€
)</p>

<p>func main() {
    a := [4]int{0, 1, 2, 3}
    p1 := unsafe.Pointer(&amp;a[1])
    p3 := unsafe.Pointer(uintptr(p1) + 2 * unsafe.Sizeof(a[0]))
    <em>(</em>int)(p3) = 6
    fmt.Println(â€œa =â€, a) // a = [0 1 2 6]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ...

type Person struct {
    name   string
    age    int
    gender bool
}

who := Person{"John", 30, true}
pp := unsafe.Pointer(&amp;who)
pname := (*string)(unsafe.Pointer(uintptr(pp) + unsafe.Offsetof(who.name)))
page := (*int)(unsafe.Pointer(uintptr(pp) + unsafe.Offsetof(who.age)))
pgender := (*bool)(unsafe.Pointer(uintptr(pp) + unsafe.Offsetof(who.gender)))
*pname = "Alice"
*page = 28
*pgender = false
fmt.Println(who) // {Alice 28 false} } unsafeåŒ…æœ‰å¤šå±é™© å…³äºunsafeåŒ…ï¼ŒIanï¼ŒGoå›¢é˜Ÿçš„æ ¸å¿ƒæˆå‘˜ä¹‹ä¸€ï¼Œå·²ç»ç¡®è®¤ï¼š
</code></pre></div></div>

<p>åœ¨unsafeåŒ…ä¸­çš„å‡½æ•°çš„ç­¾åå°†ä¸ä¼šåœ¨ä»¥åçš„Goç‰ˆæœ¬ä¸­æ›´æ”¹ï¼Œ</p>

<p>å¹¶ä¸”unsafe.Pointerç±»å‹å°†åœ¨ä»¥åçš„Goç‰ˆæœ¬ä¸­å§‹ç»ˆå­˜åœ¨ã€‚
æ‰€ä»¥ï¼ŒunsafeåŒ…ä¸­çš„ä¸‰ä¸ªå‡½æ•°çœ‹èµ·æ¥ä¸å±é™©ã€‚ go team leaderç”šè‡³æƒ³æŠŠå®ƒä»¬æ”¾åœ¨åˆ«çš„åœ°æ–¹ã€‚ unsafeåŒ…ä¸­è¿™å‡ ä¸ªå‡½æ•°å”¯ä¸€ä¸å®‰å…¨çš„æ˜¯å®ƒä»¬è°ƒç”¨ç»“æœå¯èƒ½åœ¨åæ¥çš„ç‰ˆæœ¬ä¸­è¿”å›ä¸åŒçš„å€¼ã€‚ å¾ˆéš¾è¯´è¿™ç§ä¸å®‰å…¨æ˜¯ä¸€ç§å±é™©ã€‚</p>

<p>çœ‹èµ·æ¥æ‰€æœ‰çš„unsafeåŒ…çš„å±é™©éƒ½ä¸ä½¿ç”¨unsafe.Pointeræœ‰å…³ã€‚ unsafeåŒ…docsåˆ—å‡ºäº†ä¸€äº›ä½¿ç”¨unsafe.Pointeråˆæ³•æˆ–éæ³•çš„æƒ…å†µã€‚ è¿™é‡Œåªåˆ—å‡ºéƒ¨åˆ†éæ³•ä½¿ç”¨æ¡ˆä¾‹ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œunsafeâ€
)</p>

<p>// case A: conversions between unsafe.Pointer and uintptr 
//         donâ€™t appear in the same expression
func illegalUseA() {
    fmt.Println(â€œ===================== illegalUseAâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pa := new([4]int)

// split the legal use
// p1 := unsafe.Pointer(uintptr(unsafe.Pointer(pa)) + unsafe.Sizeof(pa[0]))
// into two expressions (illegal use):
ptr := uintptr(unsafe.Pointer(pa))
p1 := unsafe.Pointer(ptr + unsafe.Sizeof(pa[0]))
// "go vet" will make a warning for the above line:
// possible misuse of unsafe.Pointer

// the unsafe package docs, https://golang.org/pkg/unsafe/#Pointer,
// thinks above splitting is illegal.
// but the current Go compiler and runtime (1.7.3) can't detect
// this illegal use.
// however, to make your program run well for later Go versions,
// it is best to comply with the unsafe package docs.

*(*int)(p1) = 123
fmt.Println("*(*int)(p1)  :", *(*int)(p1)) // }    
</code></pre></div></div>

<p>// case B: pointers are pointing at unknown addresses
func illegalUseB() {
    fmt.Println(â€œ===================== illegalUseBâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a := [4]int{0, 1, 2, 3}
p := unsafe.Pointer(&amp;a)
p = unsafe.Pointer(uintptr(p) + uintptr(len(a)) * unsafe.Sizeof(a[0]))
// now p is pointing at the end of the memory occupied by value a.
// up to now, although p is invalid, it is no problem.
// but it is illegal if we modify the value pointed by p
*(*int)(p) = 123
fmt.Println("*(*int)(p)  :", *(*int)(p)) // 123 or not 123
// the current Go compiler/runtime (1.7.3) and "go vet" 
// will not detect the illegal use here.

// however, the current Go runtime (1.7.3) will 
// detect the illegal use and panic for the below code.
p = unsafe.Pointer(&amp;a)
for i := 0; i &lt;= len(a); i++ {
    *(*int)(p) = 123 // Go runtime (1.7.3) never panic here in the tests

    fmt.Println(i, ":", *(*int)(p))
    // panic at the above line for the last iteration, when i==4.
    // runtime error: invalid memory address or nil pointer dereference

    p = unsafe.Pointer(uintptr(p) + unsafe.Sizeof(a[0]))
} }
</code></pre></div></div>

<p>func main() {
    illegalUseA()
    illegalUseB()
}
ç¼–è¯‘å™¨å¾ˆéš¾æ£€æµ‹Goç¨‹åºä¸­éæ³•çš„unsafe.Pointerä½¿ç”¨ã€‚ è¿è¡Œâ€œgo vetâ€å¯ä»¥å¸®åŠ©æ‰¾åˆ°ä¸€äº›æ½œåœ¨çš„é”™è¯¯ï¼Œä½†ä¸æ˜¯æ‰€æœ‰çš„éƒ½èƒ½æ‰¾åˆ°ã€‚ åŒæ ·æ˜¯Goè¿è¡Œæ—¶ï¼Œä¹Ÿä¸èƒ½æ£€æµ‹æ‰€æœ‰çš„éæ³•ä½¿ç”¨ã€‚ éæ³•unsafe.Pointerä½¿ç”¨å¯èƒ½ä¼šä½¿ç¨‹åºå´©æºƒæˆ–è¡¨ç°å¾—æ€ªå¼‚ï¼ˆæœ‰æ—¶æ˜¯æ­£å¸¸çš„ï¼Œæœ‰æ—¶æ˜¯å¼‚å¸¸çš„ï¼‰ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½¿ç”¨ä¸å®‰å…¨çš„åŒ…æ˜¯å±é™©çš„ã€‚</p>

<p>è½¬æ¢T1 ä¸º T2
å¯¹äºå°† T1è½¬æ¢ä¸ºunsafe.Pointerï¼Œç„¶åè½¬æ¢ä¸º T2ï¼ŒunsafeåŒ…docsè¯´ï¼š</p>

<p>å¦‚æœT2æ¯”T1å¤§ï¼Œå¹¶ä¸”ä¸¤è€…å…±äº«ç­‰æ•ˆå†…å­˜å¸ƒå±€ï¼Œåˆ™è¯¥è½¬æ¢å…è®¸å°†ä¸€ç§ç±»å‹çš„æ•°æ®é‡æ–°è§£é‡Šä¸ºå¦ä¸€ç±»å‹çš„æ•°æ®ã€‚
è¿™ç§â€œç­‰æ•ˆå†…å­˜å¸ƒå±€â€çš„å®šä¹‰æ˜¯æœ‰ä¸€äº›æ¨¡ç³Šçš„ã€‚ çœ‹èµ·æ¥goå›¢é˜Ÿæ•…æ„å¦‚æ­¤ã€‚ è¿™ä½¿å¾—ä½¿ç”¨unsafeåŒ…æ›´å±é™©ã€‚</p>

<p>ç”±äºGoå›¢é˜Ÿä¸æ„¿æ„åœ¨è¿™é‡Œåšå‡ºå‡†ç¡®çš„å®šä¹‰ï¼Œæœ¬æ–‡ä¹Ÿä¸å°è¯•è¿™æ ·åšã€‚ è¿™é‡Œï¼Œåˆ—å‡ºäº†å·²ç¡®è®¤çš„åˆæ³•ç”¨ä¾‹çš„ä¸€å°éƒ¨åˆ†ï¼Œ</p>

<p>åˆæ³•ç”¨ä¾‹1ï¼šåœ¨[]Tå’Œ[]MyTä¹‹é—´è½¬æ¢
åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬ç”¨intä½œä¸ºTï¼š</p>

<p>type MyInt int
åœ¨Golangä¸­ï¼Œ[] intå’Œ[] MyIntæ˜¯ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼Œå®ƒä»¬çš„åº•å±‚ç±»å‹æ˜¯è‡ªèº«ã€‚ å› æ­¤ï¼Œ[] intçš„å€¼ä¸èƒ½è½¬æ¢ä¸º[] MyIntï¼Œåä¹‹äº¦ç„¶ã€‚ ä½†æ˜¯åœ¨unsafe.Pointerçš„å¸®åŠ©ä¸‹ï¼Œè½¬æ¢æ˜¯å¯èƒ½çš„ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œunsafeâ€
)</p>

<p>func main() {
    type MyInt int</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a := []MyInt{0, 1, 2}
// b := ([]int)(a) // error: cannot convert a (type []MyInt) to type []int
b := *(*[]int)(unsafe.Pointer(&amp;a))

b[0]= 3

fmt.Println("a =", a) // a = [3 1 2]
fmt.Println("b =", b) // b = [3 1 2]

a[2] = 9

fmt.Println("a =", a) // a = [3 1 9]
fmt.Println("b =", b) // b = [3 1 9] } åˆæ³•ç”¨ä¾‹2: è°ƒç”¨sync/atomicåŒ…ä¸­æŒ‡é’ˆç›¸å…³çš„å‡½æ•° sync / atomicåŒ…ä¸­çš„ä»¥ä¸‹å‡½æ•°çš„å¤§å¤šæ•°å‚æ•°å’Œç»“æœç±»å‹éƒ½æ˜¯unsafe.Pointeræˆ–*unsafe.Pointerï¼š
</code></pre></div></div>

<p>func CompareAndSwapPointerï¼ˆaddr * unsafe.Pointerï¼Œoldï¼Œnew unsafe.Pointerï¼‰ï¼ˆswapped boolï¼‰
func LoadPointerï¼ˆaddr * unsafe.Pointerï¼‰ï¼ˆval unsafe.Pointerï¼‰
func StorePointerï¼ˆaddr * unsafe.Pointerï¼Œval unsafe.Pointerï¼‰
func SwapPointerï¼ˆaddr * unsafe.Pointerï¼Œnew unsafe.Pointerï¼‰ï¼ˆold unsafe.Pointerï¼‰
è¦ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œå¿…é¡»å¯¼å…¥unsafeåŒ…ã€‚ æ³¨æ„ï¼š unsafe.Pointeræ˜¯ä¸€èˆ¬ç±»å‹ï¼Œå› æ­¤ unsafe.Pointerçš„å€¼å¯ä»¥è½¬æ¢ä¸ºunsafe.Pointerï¼Œåä¹‹äº¦ç„¶ã€‚</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œlogâ€
    â€œtimeâ€
    â€œunsafeâ€
    â€œsync/atomicâ€
    â€œsyncâ€
    â€œmath/randâ€
)</p>

<p>var data *string</p>

<p>// get data atomically
func Data() string {
    p := (<em>string)(atomic.LoadPointer(
            (</em>unsafe.Pointer)(unsafe.Pointer(&amp;data)),
        ))
    if p == nil {
        return â€œâ€
    } else {
        return *p
    }
}</p>

<p>// set data atomically
func SetData(d string) {
    atomic.StorePointer(
            (*unsafe.Pointer)(unsafe.Pointer(&amp;data)), 
            unsafe.Pointer(&amp;d),
        )
}</p>

<p>func main() {
    var wg sync.WaitGroup
    wg.Add(200)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for range [100]struct{}{} {
    go func() {
        time.Sleep(time.Second * time.Duration(rand.Intn(1000)) / 1000)

        log.Println(Data())
        wg.Done()
    }()
}

for i := range [100]struct{}{} {
    go func(i int) {
        time.Sleep(time.Second * time.Duration(rand.Intn(1000)) / 1000)
        s := fmt.Sprint("#", i)
        log.Println("====", s)

        SetData(s)
        wg.Done()
    }(i)
}

wg.Wait()

fmt.Println("final data = ", *data) } ç»“è®º unsafeåŒ…ç”¨äºGoç¼–è¯‘å™¨ï¼Œè€Œä¸æ˜¯Goè¿è¡Œæ—¶ã€‚ ä½¿ç”¨unsafeä½œä¸ºç¨‹åºåŒ…åç§°åªæ˜¯è®©ä½ åœ¨ä½¿ç”¨æ­¤åŒ…æ˜¯æ›´åŠ å°å¿ƒã€‚ ä½¿ç”¨unsafe.Pointerå¹¶ä¸æ€»æ˜¯ä¸€ä¸ªåä¸»æ„ï¼Œæœ‰æ—¶æˆ‘ä»¬å¿…é¡»ä½¿ç”¨å®ƒã€‚ Golangçš„ç±»å‹ç³»ç»Ÿæ˜¯ä¸ºäº†å®‰å…¨å’Œæ•ˆç‡è€Œè®¾è®¡çš„ã€‚ ä½†æ˜¯åœ¨Goç±»å‹ç³»ç»Ÿä¸­ï¼Œå®‰å…¨æ€§æ¯”æ•ˆç‡æ›´é‡è¦ã€‚ é€šå¸¸Goæ˜¯é«˜æ•ˆçš„ï¼Œä½†æœ‰æ—¶å®‰å…¨çœŸçš„ä¼šå¯¼è‡´Goç¨‹åºæ•ˆç‡ä½ä¸‹ã€‚ unsafeåŒ…ç”¨äºæœ‰ç»éªŒçš„ç¨‹åºå‘˜é€šè¿‡å®‰å…¨åœ°ç»•è¿‡Goç±»å‹ç³»ç»Ÿçš„å®‰å…¨æ€§æ¥æ¶ˆé™¤è¿™äº›ä½æ•ˆã€‚ unsafeåŒ…å¯èƒ½è¢«æ»¥ç”¨å¹¶ä¸”æ˜¯å±é™©çš„ã€‚
</code></pre></div></div>
:ET