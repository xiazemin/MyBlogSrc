I"äÀ<p>æ¥æ”¶å‚æ•°
ä¸åƒåœ¨ç”¨æˆ·ç©ºé—´çš„ä»£ç é‚£æ ·ï¼Œä¸€ä¸ªå†…éƒ¨å‡½æ•°çš„å‚æ•°å®é™…ä¸Šä¸ä¼šå£°æ˜åœ¨å‡½æ•°çš„å¤´éƒ¨ã€‚ç›¸åï¼Œå‚æ•°åˆ—è¡¨çš„å¼•ç”¨ä¼šä¼ é€’åˆ°æ¯ä¸ªå‡½æ•°ä¸­ â€“ ä¸ç®¡å‚æ•°ä¼ é€’äº†æ²¡æœ‰ â€“ æ¥ä¸‹æ¥å‡½æ•°å°±å¯ä»¥è®©Zend EngineæŠŠè¿™äº›å‚æ•°å˜æˆå¯ä»¥ä½¿ç”¨çš„å˜é‡ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæ–°å‡½æ•°ï¼Œhello_greetme()ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ¥æ”¶1ä¸ªå‚æ•°ï¼Œç„¶åè¿™ä¸ªå‚æ•°ä¼šå’Œä¸€äº›å…¶ä»–çš„é—®å€™è¯­ä¸€èµ·è¾“å‡ºã€‚åƒä¹‹å‰ä¸€æ ·ï¼Œæˆ‘å°†åœ¨ä¸‰ä¸ªåœ°æ–¹æ·»åŠ ä»£ç ï¼š</p>

<p>åœ¨php_hello.hæ–‡ä»¶é è¿‘å…¶ä»–å‡½æ•°åŸå‹çš„åœ°æ–¹ï¼š</p>

<p>PHP_FUNCTION(hello_greetme);
åœ¨hello.cæ–‡ä»¶ä¸­hello_functionsç»“æ„ä½“çš„ç»“å°¾å¤„ï¼š</p>

<p>PHP_FE(hello_bool, NULL)
    PHP_FE(hello_null, NULL)
    PHP_FE(hello_greetme, NULL)
    {NULL, NULL, NULL}
};
åœ¨é è¿‘hello.cæ–‡ä»¶ç»“å°¾å¤„ï¼Œå…¶ä»–å‡½æ•°çš„åé¢ï¼š</p>

<p>PHP_FUNCTION(hello_greetme)
{
    char *name;
    int name_len;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "s", &amp;name, &amp;name_len) == FAILURE) {
    RETURN_NULL();
}
 
php_printf("Hello %s ", name);
RETURN_TRUE; } zend_parse_parameters()å‡½æ•°å¤§éƒ¨åˆ†çš„ä»£ç çœ‹èµ·æ¥å‡ ä¹éƒ½ä¸€æ ·ã€‚ZEND_NUM_ARGS()å‘Zend Engineæä¾›å…³äºæ¥æ”¶åˆ°çš„å‚æ•°æ•°é‡ï¼ŒTSRMLS_CCè¢«ç”¨æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæœ€åå‡½æ•°ä¼šè¿”å›SUCCESSæˆ–è€…FAILUREã€‚åœ¨æ™®é€šæƒ…å†µä¸‹zend_parse_parameters()å°†ä¼šè¿”å›SUCCESSï¼›å¦‚æœä¸€ä¸ªè°ƒç”¨è„šæœ¬ä¼ é€’çš„å‚æ•°æ•°é‡è¶…è¿‡äº†å‡½æ•°å®šä¹‰çš„å‚æ•°æ•°é‡ï¼Œæˆ–è€…ä¼ é€’çš„å‚æ•°ä¸èƒ½è½¬æ¢æˆåˆé€‚çš„æ•°æ®ç±»å‹ï¼ŒZendå°†ä¼šè‡ªåŠ¨çš„è¾“å‡ºä¸€ä¸ªé”™è¯¯ä¿¡æ¯ï¼Œç„¶åå‡½æ•°ä¼šä¼˜é›…åœ°æŠŠæ§åˆ¶æƒè¿”å›ç»™è°ƒç”¨è„šæœ¬ã€‚
</code></pre></div></div>

<p>åœ¨è¿™ä¸ªä¾‹å­ä½ ä½¿ç”¨â€œsâ€æ¥æŒ‡æ˜è¿™ä¸ªå‡½æ•°åªèƒ½æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå¹¶ä¸”è¿™ä¸ªå‚æ•°å¯ä»¥è¢«è½¬æ¢æˆstringæ•°æ®ç±»å‹ï¼Œå­˜å…¥é€šè¿‡å¼•ç”¨ä¼ é€’çš„char*å˜é‡ä¸­ã€‚</p>

<p>æ³¨æ„ä¸€ä¸ªintå˜é‡ä¹Ÿä»¥å¼•ç”¨çš„æ–¹å¼ä¼ é€’ç»™äº†zend_parse_parameters()ã€‚è¿™ä¸ªå…è®¸Zend Engineæ¥æä¾›è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æœ‰å¤šå°‘å­—èŠ‚ï¼Œæ‰€ä»¥äºŒè¿›åˆ¶å®‰å…¨çš„å‡½æ•°å°±ä¸éœ€è¦ä¾èµ–strlen(name)æ¥æ£€æµ‹å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚äº‹å®ä¸Šï¼Œä½¿ç”¨strlen(name)æœ‰å¯èƒ½å¾—ä¸åˆ°æ­£ç¡®çš„ç»“æœï¼Œå› ä¸ºnameå¯èƒ½åœ¨å­—ç¬¦ä¸²æœ«å°¾å‰é¢åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªNULLå­—ç¬¦ã€‚</p>

<p>ä¸€æ—¦ä½ çš„å‡½æ•°æ¥æ”¶åˆ°äº†nameè¿™ä¸ªå‚æ•°ï¼Œå‡½æ•°æ¥ä¸‹æ¥è¦åšçš„äº‹æƒ…å°±æ˜¯è¾“å‡ºä¸€å¥æ­£å¼é—®å€™è¯­ï¼Œå¹¶æŠŠnameå‚æ•°çš„å€¼ä½œä¸ºå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚æ³¨æ„åˆ°æˆ‘ä»¬ä½¿ç”¨äº†php_printf()è€Œæ²¡æœ‰ä½¿ç”¨æ›´åŠ ç†Ÿæ‚‰çš„printf()å‡½æ•°ã€‚ä½¿ç”¨è¿™ä¸ªå‡½æ•°éå¸¸é‡è¦ï¼Œæœ‰å‡ ä¸ªåŸå› ã€‚ç¬¬ä¸€ï¼Œå®ƒå…è®¸é€šè¿‡PHPçš„è¾“å‡ºç¼“å†²ï¼ˆoutput bufferingï¼‰æœºåˆ¶å¯¹è¾“å‡ºçš„å­—ç¬¦ä¸²è¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªæœºåˆ¶å®é™…ä¸Šé™¤äº†å¯¹æ•°æ®è¿›è¡Œç¼“å†²ä¹‹å¤–ï¼Œå®ƒè¿˜ä¼šæ‰§è¡Œä¸€äº›é¢å¤–çš„å¤„ç†æ¯”å¦‚gzipå‹ç¼©ã€‚ç¬¬äºŒï¼Œå½“ä»¥CLIæˆ–è€…CGIæ–¹å¼ä½¿ç”¨PHPçš„æ—¶å€™ï¼Œstdoutæ˜¯ä¸€ä¸ªæ•°æ®è¾“å‡ºçš„å®Œç¾ç›®çš„åœ°ï¼Œä½†æ˜¯å¤§å¤šæ•°SAPIå¸Œæœ›é€šè¿‡ä¸€ä¸ªæŒ‡å®šçš„ç®¡é“æˆ–è€…å¥—æ¥å­—æ¥è¿›è¡Œè¾“å‡ºã€‚å› æ­¤ï¼Œå¦‚æœæƒ³ç®€å•åœ°ä½¿ç”¨printf()æ¥æŠŠæ•°æ®è¾“å‡ºåˆ°stdoutå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œæ•°æ®å‘é€é¡ºåºæ··ä¹±ï¼Œæˆ–è€…æ•°æ®é”™è¯¯ï¼Œå› ä¸ºå®ƒçš„bypassed é¢„å¤„ç†ï¼ˆbypassed preprocessingï¼‰ã€‚</p>

<p>æœ€åè¿™ä¸ªå‡½æ•°é€šè¿‡ç®€å•åœ°è¿”å›TRUEæ¥æŠŠæ§åˆ¶æƒäº¤ç»™é‚£ä¸ªè°ƒç”¨ç¨‹åºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä¸ç”¨æ˜ç¡®çš„è¿”å›ä¸€ä¸ªå€¼ï¼ˆé»˜è®¤ä¸ºNULLï¼‰ï¼Œä½†æ˜¯è¿™ä¹ˆåšæ˜¯éå¸¸ç³Ÿç³•çš„ã€‚å¦‚æœä¸€ä¸ªå‡½æ•°æ²¡æœ‰ä»»ä½•æœ‰ç”¨çš„ä¿¡æ¯éœ€è¦æŠ¥å‘Šçš„è¯ï¼Œé‚£ä¹ˆå°±è¿”å›TRUEï¼Œç®€å•çš„è¯´ä¸€å¥ï¼šâ€œä¸€åˆ‡OKï¼Œæˆ‘å®Œæˆäº†ä½ è®©æˆ‘å®Œæˆçš„ä»»åŠ¡â€ã€‚</p>

<p>å› ä¸ºPHPå­—ç¬¦ä¸²æœ‰å¯èƒ½äº‹å®ä¸ŠåŒ…å«NULLï¼Œæ‰€ä»¥è¦æƒ³è¾“å‡ºä¸€ä¸ªäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«NULLï¼Œå¹¶ä¸”è¿˜æœ‰NULLåè¾¹çš„å­—ç¬¦ï¼Œé‚£ä¹ˆæ–¹æ³•æ˜¯æŠŠphp_printf()è¯­å¥æ›¿æ¢æˆå¦‚ä¸‹ä»£ç å—ï¼š</p>

<p>php_printf(â€œHello â€œ);
PHPWRITE(name, name_len);
php_printf(â€œ â€œ);
è¿™ä¸ªä»£ç å—ä½¿ç”¨äº†php_printf()æ¥å¤„ç†ä¸åŒ…å«NULLå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç”¨äº†å¦ä¸€ä¸ªå® â€“PHPWRITEæ¥å¤„ç†ç”¨æˆ·æä¾›çš„å­—ç¬¦ä¸²ã€‚è¿™ä¸ªå®æ¥å—ç”±zend_parse_parameters()æä¾›çš„é•¿åº¦å‚æ•°ï¼ˆname_lenï¼‰ï¼Œæ‰€ä»¥nameå‚æ•°çš„æ•´ä½“å†…å®¹å¯ä»¥ä¸ç”¨æ‹…å¿ƒNULLè€Œæ”¾å¿ƒå¾—è¾“å‡ºã€‚</p>

<p>zend_parse_parameters()ä¹Ÿå¯ä»¥å¤„ç†å¯é€‰å‚æ•°ã€‚åœ¨ä¸‹ä¸€ä¸ªä¾‹å­ä¸­ï¼Œä½ å°†ä¼šåˆ›å»ºä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªlong(PHPçš„æ•´å‹)ï¼Œä¸€ä¸ªdouble (æµ®ç‚¹å‹)ï¼Œå’Œä¸€ä¸ªå¯é€‰çš„Booleanå€¼ã€‚åœ¨ç”¨æˆ·ç©ºé—´å£°æ˜è¿™ä¸ªå‡½æ•°çš„è¯å¯èƒ½çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>

<p>function hello_add($a, $b, $return_long = false) {
    $sum = (int)$a + (float)$b;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if ($return_long) {
    return intval($sum);
} else {
    return floatval($sum);
} } åœ¨Cè¯­è¨€ä¸­ï¼Œè¿™ä¸ªå‡½æ•°çœ‹èµ·æ¥å¦‚ä¸‹ï¼ˆå½“ä½ æƒ³æŠŠå®ƒåŠ åˆ°hello.cä¸­çš„æ—¶å€™ï¼Œä¸è¦å¿˜è®°åœ¨php_hello.hå’Œhello_functions[]ä¸­åŠ å…¥è¿™ä¸ªå‡½æ•°å®ä½“å£°æ˜ï¼‰ï¼š
</code></pre></div></div>

<p>PHP_FUNCTION(hello_add)
{
    long a;
    double b;
    zend_bool return_long = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "ld|b", &amp;a, &amp;b, &amp;return_long) == FAILURE) {
    RETURN_NULL();
}
 
if (return_long) {
    RETURN_LONG(a + b);
} else {
    RETURN_DOUBLE(a + b);
} } è¿™ä¸€æ¬¡ï¼Œä½ çš„æ•°æ®ç±»å‹å­—ç¬¦ä¸²è¿™æ ·è¯»ï¼šâ€œæˆ‘éœ€è¦ä¸€ä¸ª(l)ongç±»å‹çš„å‚æ•°ï¼Œç„¶åä¸€ä¸ª(d)oubleç±»å‹çš„â€ã€‚ä¸‹ä¸€ä¸ªç®¡é“å­—ç¬¦è¯´æ˜æ¥ä¸‹æ¥çš„å‚æ•°åˆ—è¡¨æ˜¯å¯é€‰çš„ã€‚å¦‚æœä¸€ä¸ªå¯é€‰çš„å‚æ•°åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ä¼ é€’ï¼Œé‚£ä¹ˆzend_parse_parameters()ä¸ä¼šæ”¹å˜å·²ç»ä¼ ç»™å®ƒçš„å‚æ•°å€¼ã€‚æœ€åé‚£ä¸ªbæ˜¾ç„¶æ˜¯Booleanç±»å‹ã€‚åœ¨æ•°æ®ç±»å‹å­—ç¬¦ä¸²ä¹‹åï¼Œaï¼Œbï¼Œä»¥åŠreturn_longä»¥å¼•ç”¨çš„æ–¹å¼ä¼ é€’è¿›æ¥ï¼Œæ‰€ä»¥zend_parse_parameters()å¯ä»¥ç”¨å‚æ•°å€¼æ¥å¡«å……å®ƒä»¬ã€‚
</code></pre></div></div>

<p>è­¦å‘Šï¼šå°½ç®¡intå’Œlongåœ¨32ä½å¹³å°ä¸Šæ˜¯å¯ä»¥ç›¸äº’æ›¿æ¢ç€ä½¿ç”¨çš„ï¼Œä½†æ˜¯å¦‚æœè¿™ä¹ˆåšçš„è¯ï¼Œå½“ä½ çš„ä»£ç åœ¨64ä½ç¡¬ä»¶ä¸Šé‡æ–°ç¼–è¯‘çš„æ—¶å€™å°±ä¼šéå¸¸å±é™©ã€‚æ‰€ä»¥è®°ä½ç”¨longæ¥å¤„ç†longç±»å‹ï¼Œç”¨intæ¥å¤„ç†å­—ç¬¦ä¸²é•¿åº¦ã€‚</p>

<p>Table 1 ç»™å‡ºäº†å„ç§æ•°æ®ç±»å‹ï¼Œä»¥åŠå¯ä»¥åœ¨zend_parse_parameters()ä¸­ä½¿ç”¨ï¼Œä¸è¿™äº›ç±»å‹ç›¸å¯¹åº”çš„å­—æ¯å’ŒCè¯­è¨€æ•°æ®ç±»å‹ï¼š</p>

<p>Table 1: Types and letter codes used in zend_parse_parameters()
Type    Code    Variable Type
Boolean  b       zend_bool
Long     l       long
Double   d       double
String   s       char<em>, int
Resource r       zval</em>
Array   a        zval*
Object  o        zval*
zval    z        zval*
ä½ å¯èƒ½æ³¨æ„åˆ°äº†Table 1ä¸­æœ€åå››ä¸ªç±»å‹éƒ½è¿”å›äº†ç›¸åŒçš„æ•°æ®ç±»å‹ â€“ ä¸€ä¸ªzval*ã€‚ä¸€ä¸ªzvalï¼Œå°±åƒä½ å°†è¦çœ‹åˆ°çš„é‚£æ ·ï¼Œæ˜¯ç”¨æ¥å­˜å‚¨PHPä¸­æ‰€æœ‰ç”¨æˆ·ç©ºé—´å˜é‡çš„çœŸå®æ•°æ®ç±»å‹ã€‚ä¸‰ä¸ªâ€œå¤æ‚â€çš„æ•°æ®ç±»å‹ï¼ŒResource, Arrayå’ŒObjectï¼Œå½“ä»–ä»¬çš„æ•°æ®ç±»å‹å­—æ¯æ ‡ç¤ºåœ¨zend_parse_parameters()ä¸­è¢«ä½¿ç”¨çš„æ—¶å€™ï¼ŒZend Engineä¼šå¯¹å…¶è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œä½†æ˜¯å®ƒä»¬åœ¨Cè¯­è¨€ä¸­æ²¡æœ‰ç›¸å¯¹åº”çš„æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ä»»ä½•è½¬æ¢ä¼šè¢«å®é™…æ‰§è¡Œã€‚</p>

<p>ZVAL
zvalå’Œæ™®é€šçš„PHPç”¨æˆ·ç©ºé—´å˜é‡ï¼Œå°†ä¼šæ˜¯æœ€éš¾ç†è§£ï¼Œç»å°½ä½ è„‘æ±çš„æ¦‚å¿µã€‚å®ƒä»¬ä¹Ÿå°†ä¼šæ˜¯æœ€é‡è¦çš„æ¦‚å¿µã€‚å¼€å§‹ä¹‹å‰ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¸€ä¸ªzvalçš„ç»“æ„ï¼š</p>

<p>struct {
    union {
        long lval;
        double dval;
        struct {
            char *val;
            int len;
        } str;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    HashTable *ht;
    zend_object_value obj;
 
} value;
 
zend_uint refcount;
zend_uchar type;
zend_uchar is_ref;
</code></pre></div></div>

<p>} zval;
å°±åƒä½ çœ‹è§çš„ï¼Œæ¯ä¸ªzvalé€šå¸¸æœ‰ä¸‰ä¸ªåŸºæœ¬çš„å…ƒç´ ï¼štypeï¼Œis_refï¼Œrefcountã€‚is_refå’Œrefcountå°†ä¼šåœ¨è¿™ä¸ªæ•™ç¨‹çš„åé¢ä»‹ç»ï¼›ç°åœ¨å…ˆè®©æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹typeã€‚</p>

<p>åˆ°ç°åœ¨ä¸ºæ­¢ä½ åº”è¯¥å·²ç»ç†Ÿæ‚‰äº†PHPçš„8ä¸ªæ•°æ®ç±»å‹ã€‚å®ƒä»¬ä¸­çš„7ä¸ªåœ¨Table 1ä¸­åˆ—å‡ºæ¥äº†ï¼Œå†åŠ ä¸ŠNULLï¼Œå°½ç®¡äº‹å®ä¸Šå®ƒåœ¨å­—é¢ä¸Šè¡¨ç¤ºä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚å¯¹äºä¸€ä¸ªç‰¹å®šçš„zvalæ¥è¯´ï¼Œå®ƒçš„ç±»å‹æ˜¯å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸‰ä¸ªä¾¿åˆ©çš„å®ä¸­çš„ä¸€ä¸ªæ¥è¿›è¡Œæ£€æŸ¥ï¼šZ_TYPE(zval)ï¼ŒZ_TYPE_P(zval<em>)ï¼Œæˆ–è€…Z_TYPE_PP(zval**)ã€‚è¿™ä¸ªä¸‰ä¸ªå”¯ä¸€çš„ä¸åŒå°±æ˜¯å¯¹ä¼ é€’å˜é‡çš„å¼•ç”¨çš„å±‚çº§è¦æ±‚ä¸åŒã€‚å¯¹äº_P å’Œ _PPè¿™ç§å‘½åçš„æƒ¯ä¾‹åœ¨å…¶ä»–å®ä¸­ä¹Ÿä¼šå‡ºç°ï¼Œæ¯”å¦‚ä½ å°†è¦çœ‹è§çš„</em>VALå®ã€‚</p>

<p>typeå†³å®šäº†zval``valueè”åˆä½“çš„ä¸­é‚£ä¸€éƒ¨åˆ†è¢«ä½¿ç”¨ã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„var_dump()ï¼š</p>

<p>PHP_FUNCTION(hello_dump)
{
    zval *uservar;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "z", uservar) == FAILURE) {
 
    RETURN_NULL();
 
}
 
switch (Z_TYPE_P(uservar)) {
 
    case IS_NULL:
        php_printf("NULL ");
        break;
 
    case IS_BOOL:
        php_printf("Boolean: %s ", Z_LVAL_P(uservar) ? "TRUE" : "FALSE");
        break;
 
    case IS_LONG:
        php_printf("Long: %ld ", Z_LVAL_P(uservar));
        break;
 
    case IS_DOUBLE:
        php_printf("Double: %f ", Z_DVAL_P(uservar));
        break;
 
    case IS_STRING:
        php_printf("String: ");
        PHPWRITE(Z_STRVAL_P(uservar), Z_STRLEN_P(uservar));
        php_printf(" ");
        break;
 
    case IS_RESOURCE:
        php_printf("Resource ");
        break;
 
    case IS_ARRAY:
        php_printf("Array ");
        break;
 
    case IS_OBJECT:
        php_printf("Object ");
        break;
 
    default:
        php_printf("Unknown ");
 
}
 
RETURN_TRUE; } å°±åƒä½ æ‰€çœ‹åˆ°çš„ï¼ŒBooleanæ•°æ®ç±»å‹ä½¿ç”¨äº†å’Œlongæ•°æ®ç±»å‹ä¸€æ ·çš„å†…éƒ¨å®ã€‚å°±åƒä½ åœ¨è¿™ä¸ªç³»åˆ—æ•™ç¨‹çš„ç¬¬ä¸€éƒ¨åˆ†ä¸­ä½¿ç”¨çš„RETURN_BOOL()é‚£æ ·ï¼ŒFALSEç”¨0æ¥ä»£è¡¨ï¼ŒTRUEç”¨1æ¥ä»£è¡¨ã€‚
</code></pre></div></div>

<p>å½“ä½ ä½¿ç”¨zend_parse_parameters()æ¥è¦æ±‚ä¸€ä¸ªæŒ‡å®šäº†æ•°æ®ç±»å‹çš„å‚æ•°çš„æ—¶å€™ï¼Œæ¯”å¦‚stringï¼ŒZend Engineå°†ä¼šå»æ£€æŸ¥è¾“å…¥å˜é‡çš„æ•°æ®ç±»å‹ã€‚å¦‚æœç±»å‹åŒ¹é…ï¼ŒZendä¼šç®€å•åœ°æŠŠå‚æ•°å€¼ç®€å•çš„ä¼ é€’åˆ°zvalä¸­å¯¹åº”çš„éƒ¨åˆ†ã€‚å¦‚æœä¸åŒ¹é…ï¼Œé‚£ä¹ˆZendä¼šä½¿ç”¨type-jugglingè§„åˆ™å¯¹è¾“å…¥å˜é‡è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p>

<p>å¯¹ä½ ä¹‹å‰å®ç°çš„å‡½æ•°hello_greetme()è¿›è¡Œä¿®æ”¹ï¼ŒæŠŠå…¶åˆ†æˆå‡ ä¸ªå°ç‰‡æ®µï¼š</p>

<p>PHP_FUNCTION(hello_greetme)
{
    zval *zname;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "z", &amp;zname) == FAILURE) {
    RETURN_NULL();
}
 
convert_to_string(zname);
php_printf("Hello ");
PHPWRITE(Z_STRVAL_P(zname), Z_STRLEN_P(zname));
php_printf(" ");
 
RETURN_TRUE; } è¿™ä¸€æ¬¡ï¼Œzend_parse_parameters()ç®€å•çš„æ¥æ”¶ä¸€ä¸ªä¸å®šæ•°æ®ç±»å‹çš„PHPå˜é‡ï¼ˆzvalï¼‰ï¼Œç„¶åè¿™ä¸ªå‡½æ•°æ˜ç¡®çš„æŠŠè¿™ä¸ªå˜é‡è½¬æ¢æˆå­—ç¬¦ä¸²ç±»å‹(ç±»ä¼¼äº$zname = (string)$zname; )ï¼Œç„¶åä½¿ç”¨Z_STRVAL_På®å¾—åˆ°znameçš„å€¼ï¼Œå¹¶è¾“å‡ºã€‚å°±åƒä½ å¯èƒ½çŒœåˆ°çš„ï¼Œå’Œå…¶ä»–æ•°æ®ç±»å‹boolï¼Œlongå’Œdoubleç›¸å¯¹åº”çš„convert_to_*()å‡½æ•°ä¹Ÿæ˜¯å­˜åœ¨çš„ã€‚
</code></pre></div></div>

<p>åˆ›å»ºZVAL
åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œä½ æ‰€ä½¿ç”¨çš„zvaléƒ½æ˜¯ç”±Zend Engineæ¥åˆ†é…å’Œé‡Šæ”¾çš„ã€‚ä½†æ˜¯æ— è®ºå¦‚ä½•ï¼Œæœ‰æ—¶å€™ï¼Œè‡ªå·±åˆ›å»ºzvalæ˜¯å¾ˆå¿…è¦çš„ã€‚çœ‹ä¸€ä¸‹å¦‚ä¸‹çš„ä»£ç å—ï¼š</p>

<p>{
    zval *temp;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ALLOC_INIT_ZVAL(temp);
 
Z_TYPE_P(temp) = IS_LONG;
Z_LVAL_P(temp) = 1234;
 
zval_ptr_dtor(&amp;temp); } ALLOC_INIT_ZVAL()ï¼Œå°±åƒå®ƒåå­—æ‰€è¡¨æ˜çš„é‚£æ ·ï¼Œä¸ºä¸€ä¸ªzval*åˆ†é…å†…å­˜ï¼Œç„¶ååˆå§‹åŒ–ä¸ºä¸€ä¸ªæ–°çš„å˜é‡ã€‚å½“è¿™ä¸ªè¿‡ç¨‹ä¸€æ—¦å®Œæˆï¼ŒZ_*_P()å®å°±å¯ä»¥è¢«ç”¨æ¥è®¾ç½®å˜é‡çš„æ•°æ®ç±»å‹å’Œå€¼ã€‚zval_ptr_dtor()è¢«ç”¨æ¥åšä¸€è„æ´»ï¼šæ¸…ç†åˆ†é…ç»™å˜é‡çš„å†…å­˜ã€‚
</code></pre></div></div>

<p>è¿™ä¸¤ä¸ªZ_*_P()å®çš„è°ƒç”¨å¯ä»¥è¢«å‡å°‘åˆ°ä¸€ä¸ªå•ç‹¬çš„è¯­å¥ï¼š</p>

<p>ZVAL_LONG(temp, 1234);</p>

<p>å¯¹äºå…¶ä»–æ•°æ®ç±»å‹ï¼Œç±»ä¼¼çš„å®ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå¹¶ä¸”å®ƒä»¬æœ‰ç›¸åŒçš„è¯­æ³•æ ¼å¼ï¼Œå°±åƒä½ åœ¨è¿™ä¸ªç³»åˆ—æ•™ç¨‹ç¬¬ä¸€éƒ¨åˆ†æ‰€è§çš„RETURN_<em>()å®ã€‚äº‹å®ä¸ŠRETURN_</em>()å®å°±æ˜¯å¯¹RETVAL_<em>()å®è¿›è¡Œäº†ç®€å•çš„åŒ…è£…ï¼ŒZVAL_</em>()å®ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚ä¸‹é¢çš„äº”ä¸ªç‰ˆæœ¬æ˜¯ç­‰åŒçš„ï¼š</p>

<p>RETURN_LONG(42);</p>

<p>RETVAL_LONG(42);
return;</p>

<p>ZVAL_LONG(return_value, 42);
return;</p>

<p>Z_TYPE_P(return_value) = IS_LONG;
Z_LVAL_P(return_value) = 42;
return;</p>

<p>return_value-&gt;type = IS_LONG;
return_value-&gt;value.lval = 42;
return;
å¦‚æœä½ è¶³å¤Ÿæœºè­¦ï¼Œé‚£ä¹ˆä½ ä¼šè€ƒè™‘è¿™äº›å®æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼Œå°±åƒå®ƒä»¬åœ¨hello_long()å‡½æ•°ä¸­è¢«ä½¿ç”¨çš„é‚£æ ·ã€‚â€œreturn_valueæ˜¯ä»å“ªæ¥çš„ï¼Œä¸ºä»€ä¹ˆå®ƒæ²¡æœ‰é€šè¿‡ ALLOC_INIT_ZVAL()æ¥è¿›è¡Œåˆ†é…ï¼Ÿâ€ï¼Œä½ å¯èƒ½æƒ³çŸ¥é“ã€‚</p>

<p>åœ¨ä½ ä¸€å¤©åˆä¸€å¤©çš„æ‰©å±•ç¼–å†™è¿‡ç¨‹ä¸­return_valueè¢«éšè—äº†èµ·æ¥ï¼Œå…¶å®å®ƒæ˜¯åœ¨æ¯ä¸ªPHP_FUNCTION()åŸå‹ä¸­å®šä¹‰çš„ä¸€ä¸ªå‡½æ•°å‚æ•°ã€‚Zend Engineä¼šä¸ºå®ƒåˆ†é…å†…å­˜ï¼Œç„¶ååˆå§‹åŒ–ä¸ºNULLï¼Œæ‰€ä»¥å³ä½¿ä½ çš„å‡½æ•°æ²¡æœ‰å®é™…çš„å»è®¾ç½®è¿™ä¸ªå˜é‡ï¼Œå…¶ä¹Ÿæœ‰äº†ä¸€ä¸ªå¯ä»¥è¢«è°ƒç”¨ç¨‹åºæ‰€ç”¨çš„å€¼ã€‚å½“ä½ çš„å†…éƒ¨å‡½æ•°æ‰§è¡Œå®Œä¹‹åï¼ŒZend Engineä¼šæŠŠè¿™ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™è°ƒç”¨ç¨‹åºï¼Œæˆ–è€…å¦‚æœè°ƒç”¨ç¨‹åºè¢«å‘ŠçŸ¥å¿½ç•¥è¿™ä¸ªå˜é‡ï¼Œåˆ™é‡Šæ”¾æ‰å®ƒã€‚</p>

<p>æ•°ç»„
æ—¢ç„¶ä½ åœ¨è¿‡å»ä½¿ç”¨è¿‡PHPï¼Œé‚£ä¹ˆä½ å·²ç»è®¤è¯†åˆ°ä¸€ä¸ªæ•°ç»„å˜é‡çš„ä½œç”¨å°±æ˜¯åŒ…å«å…¶ä»–å„ç§å˜é‡ã€‚å®ƒå†…éƒ¨æ˜¯é€šè¿‡ä¸€ä¸ªå¤§å®¶éƒ½ç†Ÿæ‚‰çš„æ•°æ®ç»“æ„HashTableæ¥å®ç°çš„ã€‚å½“è¦åˆ›å»ºæ•°ç»„ï¼Œå¹¶ä¸”æŠŠè¿™äº›æ•°ç»„è¿”å›ç»™PHPï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨Table 2ä¸­æ‰€åˆ—å‡½æ•°ä¸­çš„ä¸€ä¸ªã€‚</p>

<p>Table 2: zval array creation functions</p>

<p>PHP Syntax  C Syntax (arr is a zval<em>)   Meaning
$arr = array(); array_init(arr);             Initialize a new array
$arr[] = NULL;  add_next_index_null(arr);   Add a value of a given type to a numerically indexed array
$arr[] = 42;    add_next_index_long(arr, 42);
$arr[] = true;  add_next_index_bool(arr, 1);
$arr[] = 3.14;  add_next_index_double(arr, 3.14);
$arr[] = â€˜fooâ€™; add_next_index_string(arr, â€œfooâ€, 1);
$arr[] = $myvar; add_next_index_zval(arr, myvar);
$arr[0] = NULL; add_index_null(arr, 0);     Add a value of a given type to a specific index in an array
$arr[1] = 42;   add_index_long(arr, 1, 42);
$arr[2] = true; add_index_bool(arr, 2, 1);
$arr[3] = 3.14; add_index_double(arr, 3, 3.14);
$arr[4] = â€˜fooâ€™;add_index_string(arr, 4, â€œfooâ€, 1);
$arr[5] = $myvar; add_index_zval(arr, 5, myvar);
$arr[â€˜abcâ€™] = NULL; add_assoc_null(arr, â€œabcâ€); Add a value of a given type to an associatively indexed array
$arr[â€˜defâ€™] = 711; add_assoc_long(arr, â€œdefâ€, 711);
$arr[â€˜ghiâ€™] = true; add_assoc_bool(arr, â€œghiâ€, 1);
$arr[â€˜jklâ€™] = 1.44; add_assoc_double(arr, â€œjklâ€, 1.44);
$arr[â€˜mnoâ€™] = â€˜bazâ€™; add_assoc_string(arr, â€œmnoâ€, â€œbazâ€, 1);
$arr[â€˜pqrâ€™] = $myvar; add_assoc_zval(arr, â€œpqrâ€, myvar);
åƒRETURN_STRING()å®ä¸€æ ·ï¼Œadd_</em><em>string()å‡½æ•°ä¹Ÿä¼šåœ¨æœ€åä¸€ä¸ªå‚æ•°ä¸­ç”¨0æˆ–è€…1æ¥æŒ‡æ˜è¿™ä¸ªå­—ç¬¦ä¸²å†…å®¹æ˜¯å¦éœ€è¦å¤åˆ¶ã€‚è¿™äº›add</em><em>_string()å‡½æ•°æ¯ä¸ªè¿˜æœ‰add_</em>_stringl()æ ¼å¼çš„å˜ä½“ã€‚lè¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦å°†ä¼šæ˜ç¡®åœ°æä¾›ï¼ˆä¸éœ€è¦Zend Engineè°ƒç”¨éäºŒè¿›åˆ¶å®‰å…¨çš„strval()å‡½æ•°æ¥æ£€æµ‹ï¼‰ã€‚</p>

<p>ä½¿ç”¨è¿™ä¸ªäºŒè¿›åˆ¶å®‰å…¨æ ¼å¼çš„å‡½æ•°åªéœ€è¦ç®€å•çš„åœ¨é‚£ä¸ªå¤åˆ¶å‚æ•°å‰é¢æŒ‡å®šé•¿åº¦å³å¯ï¼Œåƒè¿™æ ·ï¼š</p>

<p>add_assoc_stringl(arr, â€œsomeStringVarâ€, â€œbazâ€, 3, 1);
åœ¨ä½¿ç”¨add_assoc_<em>()å‡½æ•°çš„æ—¶å€™ï¼Œæ‰€æœ‰æ•°ç»„çš„keyéƒ½å‡è®¾ä¸åŒ…å«ä»»ä½•çš„NULL â€“ add_assoc_</em>()å‡½æ•°æœ¬èº«å¯¹äºkeyæ˜¯éäºŒè¿›åˆ¶å®‰å…¨ã€‚åœ¨å®ƒä»¬ä¹‹ä¸­ä½¿ç”¨åŒ…å«NULLçš„keyæ˜¯ä¸è¢«é¼“åŠ±çš„ï¼ˆå³ä½¿è¿™ä¸ªæŠ€æœ¯å·²ç»åœ¨protectedå¯¹è±¡å±æ€§å’Œprivateå¯¹è±¡å±æ€§ä¸­ä½¿ç”¨äº†ï¼‰ï¼Œä½†æ˜¯å¦‚æœå¿…é¡»è¿™ä¹ˆåšçš„è¯ï¼Œå½“æˆ‘ä»¬ç¨åæ¥è§¦zend_hash_*()å‡½æ•°çš„æ—¶å€™ï¼Œä½ å°†ä¼šäº†è§£åˆ°å¦‚ä½•æ›´åŠ å……åˆ†åœ°ç”¨å¥½å®ƒã€‚</p>

<p>æŠŠä½ åˆšæ‰å·²ç»å­¦åˆ°çš„ä¸œè¥¿å±•ç¤ºä¸€ä¸‹ï¼Œåˆ›å»ºå¦‚ä¸‹çš„ä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¿”å›ä¸€ä¸ªæ•°ç»„çš„å€¼ç»™è°ƒç”¨ç¨‹åºã€‚ç¡®å®šåœ¨php_hello.hå’Œhello_functions[]ä¸­åŠ å…¥é€‚å½“çš„å‡½æ•°å®ä½“æ¥å£°æ˜è¿™ä¸ªå‡½æ•°ã€‚</p>

<p>PHP_FUNCTION(hello_array)
{
    char *mystr;
    zval *mysubarray;
    array_init(return_value);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_index_long(return_value, 42, 123);
add_next_index_string(return_value, "I should now be found at index 43", 1);
add_next_index_stringl(return_value, "I'm at 44!", 10, 1);
 
mystr = estrdup("Forty Five");
add_next_index_string(return_value, mystr, 0);
 
add_assoc_double(return_value, "pi", 3.1415926535);
 
ALLOC_INIT_ZVAL(mysubarray);
array_init(mysubarray);
add_next_index_string(mysubarray, "hello", 1);
add_assoc_zval(return_value, "subarray", mysubarray); } æ„å»ºè¿™ä¸ªæ‰©å±•ï¼Œç„¶åç»™å‡ºvar_dump(hello_array())çš„ç»“æœï¼š
</code></pre></div></div>

<p>array(6) {
  [42]=&gt;
  int(123)</p>

<p>[43]=&gt;
  string(33) â€œI should now be found at index 43â€</p>

<p>[44]=&gt;
  string(10) â€œIâ€™m at 44!â€</p>

<p>[45]=&gt;
  string(10) â€œForty Fiveâ€</p>

<p>[â€œpiâ€]=&gt;
  float(3.1415926535)</p>

<p>[â€œsubarrayâ€]=&gt;
  array(1) {
    [0]=&gt;
    string(5) â€œhelloâ€
  }
}
è¯»å–æ•°ç»„ä¸­çš„å€¼æ„å‘³ç€ä½¿ç”¨ZENDAPIä¸­çš„zend_hashä¸€ç±»çš„å‡½æ•°æŠŠHashTableä¸­çš„å†…å®¹æŠ½å‡ºç„¶åè½¬æ¢æˆzval**ã€‚è®©æˆ‘ä»¬ä»¥ä¸€ä¸ªæ¥æ”¶æ•°ç»„å‚æ•°çš„ç®€å•å‡½æ•°å¼€å§‹ï¼š</p>

<p>function hello_array_strings($arr) {
    if (!is_array($arr)) return NULL;
    printf(â€œThe array passed contains %d elements â€œ, count($arr));</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreach($arr as $data) {
    if (is_string($data)) echo "$data ";
} } æˆ–è€…ï¼Œç”¨Cè¯­è¨€ï¼š
</code></pre></div></div>

<p>PHP_FUNCTION(hello_array_strings)
{
    zval *arr, **data;
    HashTable *arr_hash;
    HashPosition pointer;
    int array_count;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "a", &amp;arr) == FAILURE) {
    RETURN_NULL();
}
 
arr_hash = Z_ARRVAL_P(arr);
array_count = zend_hash_num_elements(arr_hash);
php_printf("The array passed contains %d elements ", array_count);
 
for(zend_hash_internal_pointer_reset_ex(arr_hash, &amp;pointer); zend_hash_get_current_data_ex(arr_hash, (void**) &amp;data, &amp;pointer) == SUCCESS; zend_hash_move_forward_ex(arr_hash, &amp;pointer)) {
    if (Z_TYPE_PP(data) == IS_STRING) {
 
        PHPWRITE(Z_STRVAL_PP(data), Z_STRLEN_PP(data));
 
        php_printf(" ");
 
    }
}
 
RETURN_TRUE; } ä¸ºäº†ä¿æŒè¿™ä¸ªå‡½æ•°çš„ç®€æ´ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­åªæœ‰stringç±»å‹çš„æ•°ç»„å…ƒç´ è¢«è¾“å‡ºäº†ã€‚ä½ å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ç”¨convert_to_string()å°±åƒæˆ‘ä»¬åœ¨ä¹‹å‰çš„hello_greetme()å‡½æ•°ä¸­åšçš„é‚£æ ·ã€‚è®©æˆ‘ä»¬æ”¹ä¸€ä¸‹çœ‹çœ‹ï¼›æŠŠä¸Šé¢çš„forå¾ªç¯ä»£ç ç”¨ä»¥ä¸‹çš„ä»£ç æ›¿æ¢æ‰ï¼š
</code></pre></div></div>

<p>for(zend_hash_internal_pointer_reset_ex(arr_hash, &amp;pointer); zend_hash_get_current_data_ex(arr_hash, (void**) &amp;data, &amp;pointer) == SUCCESS; zend_hash_move_forward_ex(arr_hash, &amp;pointer)) {
    convert_to_string_ex(data);
    PHPWRITE(Z_STRVAL_PP(data), Z_STRLEN_PP(data));
    php_printf(â€œ â€œ);
}
ç°åœ¨é‡æ–°ç¼–è¯‘ä½ çš„æ‰©å±•ï¼Œç„¶ååœ¨ç”¨æˆ·ç©ºé—´è¿è¡Œå¦‚ä¸‹ä»£ç ï¼š</p>

<p>æ³¨æ„è¿™ä¸ªåŸå§‹çš„æ•°ç»„å·²ç»è¢«æ›´æ”¹äº†ï¼è®°ä½ï¼Œconvert_to_*()å‡½æ•°çš„ä½œç”¨å’Œè°ƒç”¨set_type()æ˜¯ä¸€æ ·çš„ã€‚ç”±äºä½ åœ¨å’Œä¼ é€’è¿›æ¥çš„æ•°ç»„ä¸€èµ·å·¥ä½œï¼Œä¿®æ”¹å®ƒçš„ç±»å‹å°†ä¼šæ”¹å˜åŸå§‹å˜é‡ã€‚ä¸ºäº†é¿å…è¿™ä¸ªï¼Œä½ éœ€è¦é¦–é€‰å¤åˆ¶ä¸€ä»½zvalã€‚ä¸ºäº†è¿™ä¹ˆåšï¼Œå†ä¿®æ”¹ä¸€ä¸‹forå¾ªç¯ä»£ç å¦‚ä¸‹ï¼š</p>

<p>for(zend_hash_internal_pointer_reset_ex(arr_hash, &amp;pointer); zend_hash_get_current_data_ex(arr_hash, (void<em>*) &amp;data, &amp;pointer) == SUCCESS; zend_hash_move_forward_ex(arr_hash, &amp;pointer)) {
        zval temp;
        temp = **data;
        zval_copy_ctor(&amp;temp);
        convert_to_string(&amp;temp);
        PHPWRITE(Z_STRVAL(temp), Z_STRLEN(temp));
        php_printf(â€œ â€œ);
        zval_dtor(&amp;temp);
}
è¿™ä¸ªç‰ˆæœ¬ä¸­æœ€æ˜æ˜¾çš„éƒ¨åˆ† â€“ temp = **data â€“ å°±æ˜¯æ‹·è´åŸå§‹zvalä¸­çš„dataæˆå‘˜ï¼Œä½†æ˜¯å› ä¸ºä¸€ä¸ªzvalå¯èƒ½ä¼šåŒ…å«é™„åŠ çš„èµ„æºæ¯”å¦‚åƒchar</em> å­—ç¬¦ä¸²ï¼Œæˆ–è€…HashTable* æ•°ç»„ï¼Œé‚£ä¹ˆè¿™äº›ä¾èµ–çš„èµ„æºéœ€è¦é€šè¿‡zval_copy_ctor()æ¥å¤åˆ¶ä¸€ä»½ã€‚åˆ°ç›®å‰ä¸ºæ­¢åªæœ‰ä¸€ä¸ªç®€å•çš„è½¬æ¢ï¼Œè¾“å‡ºï¼Œæœ€åçš„é‚£ä¸ªzval_dtor()ç”¨æ¥é‡Šæ”¾æ‰zval_copy_ctor()æ‹·è´çš„èµ„æºã€‚</p>

<p>å¦‚æœä½ æƒ³çŸ¥é“å½“æˆ‘ä»¬é¦–æ¬¡ä»‹ç»convert_to_string()çš„æ—¶å€™ï¼Œä¸ºä»€ä¹ˆä½ ä¸åšzval_copy_ctor()è¿™ä¸ªå·¥ä½œï¼Œé‚£æ˜¯å› ä¸ºå½“ä¼ é€’ä¸€ä¸ªå˜é‡ç»™ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºè¿™ä¸ªå˜é‡çš„æ‹·è´ï¼Œä»è€ŒæŠŠzvalä»åŸå§‹å˜é‡ä¸­åˆ†ç¦»å¼€æ¥ã€‚è¿™ä¸ªåªèƒ½åœ¨åŸºæœ¬çš„zvalä¸Šå®Œæˆï¼Œæ‰€ä»¥ä¸€äº›é™„å±çš„èµ„æºï¼ˆæ¯”å¦‚æ•°ç»„å…ƒç´ å’Œå¯¹è±¡å±æ€§ï¼‰ä»ç„¶éœ€è¦åœ¨ä½¿ç”¨ä¹‹å‰å°±åˆ†ç¦»ã€‚</p>

<p>ç°åœ¨ä½ å·²ç»çœ‹åˆ°äº†æ•°ç»„çš„å€¼ï¼Œè®©æˆ‘ä»¬å†ä¿®æ”¹ä¸€ä¸‹ä»£ç è®©æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°æ•°ç»„çš„keyï¼š</p>

<p>for(zend_hash_internal_pointer_reset_ex(arr_hash, &amp;pointer); zend_hash_get_current_data_ex(arr_hash, (void**) &amp;data, &amp;pointer) == SUCCESS; zend_hash_move_forward_ex(arr_hash, &amp;pointer)) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zval temp;
char *key;
int key_len;
long index;
 
if (zend_hash_get_current_key_ex(arr_hash, &amp;key, &amp;key_len, &amp;index, 0, &amp;pointer) == HASH_KEY_IS_STRING) {
    PHPWRITE(key, key_len);
} else {
    php_printf("%ld", index);
}
 
php_printf(" =&gt; ");
 
temp = **data;
zval_copy_ctor(&amp;temp);
convert_to_string(&amp;temp);
PHPWRITE(Z_STRVAL(temp), Z_STRLEN(temp));
php_printf(" ");
zval_dtor(&amp;temp); } è®°ä½æ•°ç»„å¯ä»¥æœ‰æ•°å­—ç´¢å¼•ï¼Œå…³è”å­—ç¬¦ä¸²keyï¼Œæˆ–è€…äºŒè€…éƒ½æœ‰ã€‚è°ƒç”¨zend_hash_get_current_key_ex()å¯ä»¥ä»æ•°ç»„å½“å‰ä½ç½®æ¥è·å¾—æ•°ç»„keyçš„ç±»å‹ï¼Œç„¶åç”¨è¿”å›å€¼æ¥å†³å®škeyçš„ç±»å‹ï¼Œå¯èƒ½æ˜¯HASH_KEY_IS_STRINGï¼ŒHASH_KEY_IS_LONGï¼Œæˆ–è€…HASH_KEY_NON_EXISTANTã€‚æ—¢ç„¶zend_hash_get_current_data_ex()å¯ä»¥è¿”å›ä¸€ä¸ªzval**ï¼Œä½ å¯ä»¥å®‰å…¨çš„å‡è®¾HASH_KEY_NON_EXISTANTæ˜¯ä¸ä¼šè¢«è¿”å›çš„ï¼Œæ‰€ä»¥åªæœ‰IS_STRINGå’ŒIS_LONGéœ€è¦è¢«æ£€æŸ¥ã€‚
</code></pre></div></div>

<p>è¿™å„¿æœ‰å¦ä¸€ä¸ªè¿­ä»£HashTableçš„æ–¹æ³•ã€‚Zend Engineå…¬å¼€äº†ä¸‰ä¸ªéå¸¸ç›¸ä¼¼çš„å‡½æ•°æ¥ååŠ©è¿™ä¸ªå·¥ä½œï¼šzend_hash_apply()ï¼Œzend_hash_apply_with_argument()ï¼Œå’Œzend_hash_apply_with_arguments()ã€‚ç¬¬ä¸€ä¸ªå°±æ˜¯å¾ªç¯ä¸€ä¸ªHashTableï¼Œç¬¬äºŒä¸ªå…è®¸ä¼ é€’ä¸€ä¸ªå•ç‹¬çš„void*å‚æ•°ç»™å®ƒï¼Œä¸æ­¤åŒæ—¶ç¬¬ä¸‰ä¸ªå…è®¸é€šè¿‡ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨æ¥ä¼ é€’æ•°é‡ä¸é™çš„å‚æ•°ã€‚hello_array_walk()æ˜¾ç¤ºäº†æ¯ä¸ªå‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>

<p>static int php_hello_array_walk(zval **element TSRMLS_DC)
{
    zval temp;
    temp = **element;
    zval_copy_ctor(&amp;temp);
    convert_to_string(&amp;temp);
    PHPWRITE(Z_STRVAL(temp), Z_STRLEN(temp));
    php_printf(â€œ â€œ);
    zval_dtor(&amp;temp);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return ZEND_HASH_APPLY_KEEP; }
</code></pre></div></div>

<p>static int php_hello_array_walk_arg(zval **element, char *greeting TSRMLS_DC)
{
    php_printf(â€œ%sâ€, greeting);
    php_hello_array_walk(element TSRMLS_CC);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return ZEND_HASH_APPLY_KEEP; }
</code></pre></div></div>

<p>static int php_hello_array_walk_args(zval <em>*element, int num_args, var_list args, zend_hash_key *hash_key)
{
    char *prefix = va_arg(args, char</em>);
    char <em>suffix = va_arg(args, char</em>);
    TSRMLS_FETCH();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>php_printf("%s", prefix);
php_hello_array_walk(element TSRMLS_CC);
php_printf("%s ", suffix);
 
return ZEND_HASH_APPLY_KEEP; }
</code></pre></div></div>

<p>PHP_FUNCTION(hello_array_walk)
{
    zval *zarray;
    int print_newline = 1;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "a", &amp;zarray) == FAILURE) {
    RETURN_NULL();
}
 
zend_hash_apply(Z_ARRVAL_P(zarray), (apply_func_t)php_hello_array_walk TSRMLS_CC);
zend_hash_apply_with_argument(Z_ARRVAL_P(zarray), (apply_func_arg_t)php_hello_array_walk_arg, "Hello " TSRMLS_CC);
zend_hash_apply_with_arguments(Z_ARRVAL_P(zarray), (apply_func_args_t)php_hello_array_walk_args, 2, "Hello ", "Welcome to my extension!");
 
RETURN_TRUE; } åˆ°ç°åœ¨ä¸ºæ­¢ä½ åº”è¯¥å¯¹ä¸ä¸Šé¢å¤§éƒ¨åˆ†ä»£ç ç›¸å…³è”çš„å‡½æ•°ä½¿ç”¨å¾ˆç†Ÿæ‚‰äº†ã€‚ä¼ é€’ç»™hello_array_walk()çš„æ•°ç»„è¢«å¾ªç¯äº†ä¸‰æ¬¡ï¼Œä¸€æ¬¡æ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œä¸€æ¬¡è·Ÿç€ä¸€ä¸ªå‚æ•°ï¼Œç¬¬ä¸‰æ¬¡è·Ÿç€ä¸¤ä¸ªå‚æ•°ã€‚åœ¨è¿™ä¸ªè®¾è®¡ä¸­ï¼Œwalk_arg()å’Œwalk_args()å‡½æ•°å®é™…ä¸Šä¾èµ–äºæ²¡æœ‰å‚æ•°çš„walk()å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„å·¥ä½œæ˜¯ç±»å‹è½¬æ¢ï¼Œå¹¶è¾“å‡ºzvalï¼Œæ˜¾ç„¶è¿™ä¸ªå·¥ä½œå¯¹äºè¿™ä¸‰ä¸ªå‡½æ•°æ¥è¯´éƒ½æ˜¯å…±åŒçš„ã€‚
</code></pre></div></div>

<p>åœ¨è¿™ä¸ªä»£ç å—ä¸­ï¼Œå°±åƒåœ¨ä½ å°†è¦ä½¿ç”¨zend_hash_apply()å‡½æ•°çš„å¤§éƒ¨åˆ†åœ°æ–¹ï¼Œè¿™ä¸ªapply()å‡½æ•°ä¼šè¿”å›ZEND_HASH_APPLY_KEEPã€‚è¿™ä¸ªå‘Šè¯‰zend_hash_apply()å‡½æ•°æŠŠå…ƒç´ ç•™åœ¨HashTableä¸­ï¼Œç„¶åç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªã€‚åœ¨è¿™å„¿è¿˜å¯ä»¥è¿”å›å…¶ä»–å€¼ï¼šZEND_HASH_APPLY_REMOVEï¼Œæ„æ€æ˜¯ â€“ åˆ é™¤å½“å‰çš„å…ƒç´ ï¼Œç„¶åç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª â€“ZEND_HASH_APPLY_STOPï¼Œæ„æ€æ˜¯åœ¨å½“å‰å…ƒç´ å¤„åœæ­¢æ•°ç»„è¿­ä»£ï¼Œç„¶åå®Œå…¨é€€å‡ºzend_hash_apply()å‡½æ•°ã€‚</p>

<p>æ‰€æœ‰ç»„ä»¶ä¸­ç¨å¾®ä¸å¤ªç†Ÿæ‚‰çš„åº”è¯¥æ˜¯TSRMLS_FETCH()ã€‚ä½ å¯ä»¥å›æƒ³ä¸€ä¸‹ç¬¬ä¸€éƒ¨åˆ†ï¼ŒTSRMLS_*å®æ˜¯çº¿ç¨‹å®‰å…¨èµ„æºç®¡ç†å±‚çš„ä¸€éƒ¨åˆ†ï¼Œå¯¹äºä¿æŒçº¿ç¨‹ä¹‹é—´çš„ç‹¬ç«‹æ˜¯å¾ˆå¿…è¦çš„ã€‚å› ä¸ºå¤šå‚æ•°ç‰ˆæœ¬çš„zend_hash_apply()ä½¿ç”¨äº†ä¸€ä¸ªå¯å˜å‚æ•°åˆ—è¡¨ï¼Œæ‰€ä»¥è¿™ä¸ªtsrm_lsæ ‡ç¤ºæ²¡æ³•ä¼ é€’åˆ°walk()å‡½æ•°ä¸­ã€‚ä¸ºäº†å½“æˆ‘ä»¬åœ¨å›è°ƒphp_hello_array_walk()å‡½æ•°çš„æ—¶å€™å¯ä»¥ä½¿ç”¨çº¿ç¨‹å®‰å…¨æœºåˆ¶ï¼Œä½ éœ€è¦åœ¨å‡½æ•°ä¸­è°ƒç”¨TSRMLS_FETCH()ï¼Œå®ƒä¼šåœ¨èµ„æºæ± ä¸­å¯»æ‰¾æ­£ç¡®çš„çº¿ç¨‹ã€‚ï¼ˆæ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•æ¯”ç›´æ¥ä¼ é€’å‚æ•°è¦æ…¢å¾—å¤šï¼Œæ‰€ä»¥åªåœ¨æ— æ³•é¿å…çš„æ—¶å€™æ‰ç”¨ã€‚ï¼‰</p>

<p>ç”¨foreachè¿™ç§å½¢å¼çš„æ–¹æ³•æ¥è¿­ä»£ä¸€ä¸ªæ•°ç»„æ˜¯å¾ˆå¸¸è§çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä½ ç»å¸¸ä¼šç”¨ä¸€ä¸ªæ•°å­—keyæˆ–è€…å…³è”keyåœ¨æ•°ç»„ä¸­æŸ¥æ‰¾ä¸€ä¸ªç‰¹å®šçš„å€¼ã€‚ä¸‹ä¸€ä¸ªå‡½æ•°å°†ä¼šæ ¹æ®keyä»ä¸€ä¸ªæ•°ç»„ä¸­è¿”å›ä¸€ä¸ªå€¼ï¼Œå…¶ä¸­è¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¿™ä¸ªæ•°ç»„ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ‰€éœ€è¦çš„keyã€‚</p>

<p>PHP_FUNCTION(hello_array_value)
{
    zval *zarray, *zoffset, **zvalue;
    long index = 0;
    char *key = NULL;
    int key_len = 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "az", &amp;zarray, &amp;zoffset) == FAILURE) {
    RETURN_NULL();
}
 
switch (Z_TYPE_P(zoffset)) {
 
    case IS_NULL:
        index = 0;
        break;
 
    case IS_DOUBLE:
       index = (long)Z_DVAL_P(zoffset);
        break;
 
    case IS_BOOL:
    case IS_LONG:
    case IS_RESOURCE:
        index = Z_LVAL_P(zoffset);
        break;
 
    case IS_STRING:
        key = Z_STRVAL_P(zoffset);
        key_len = Z_STRLEN_P(zoffset);
        break;
 
    case IS_ARRAY:
        key = "Array";
        key_len = sizeof("Array") - 1;
        break;
 
    case IS_OBJECT:
        key = "Object";
        key_len = sizeof("Object") - 1;
        break;
 
    default:
        key = "Unknown";
        key_len = sizeof("Unknown") - 1;
}
 
if (key &amp;&amp; zend_hash_find(Z_ARRVAL_P(zarray), key, key_len + 1, (void**)&amp;zvalue) == FAILURE) {
    RETURN_NULL();
} else if (!key &amp;&amp; zend_hash_index_find(Z_ARRVAL_P(zarray), index, (void**)&amp;zvalue) == FAILURE) {
    RETURN_NULL();
}
 
*return_value = **zvalue;
zval_copy_ctor(return_value); } è¿™ä¸ªå‡½æ•°ä»¥ä¸€ä¸ªswitchå—å¼€å§‹ï¼Œä¸»è¦æ˜¯å¤„ç†ç±»å‹è½¬æ¢ï¼Œæ–¹æ³•å’ŒZend Engineå¾ˆåƒã€‚NULLè¢«å½“åš0ï¼ŒBooleanç±»å‹è¢«é€‚å½“çš„è½¬æ¢ä¸º0æˆ–è€…1ï¼Œdoubleç±»å‹è¢«è½¬æ¢æˆlong(åœ¨å¤„ç†è¿‡ç¨‹ä¸­ä¼šè¢«æˆªæ–­)ï¼Œç„¶åresourceç±»å‹è¢«è½¬æ¢æˆæ•°å­—å€¼ã€‚å¯¹resourceç±»å‹çš„å¤„ç†æ–¹å¼æ˜¯ä»PHP3ç•™ä¸‹æ¥çš„ï¼Œå½“resourceåªæ˜¯æŸ¥è¯¢æ•°ç»„æ—¶å€™æ‰€éœ€è¦çš„ä¸€ä¸ªæ•°å­—keyè€Œä¸æ˜¯ä¸€ä¸ªå”¯ä¸€çš„ç±»å‹ã€‚
</code></pre></div></div>

<p>æ•°ç»„å’Œå¯¹è±¡è¢«ç®€å•çš„å½“æˆå­—ç¬¦ä¸²å­—é¢é‡â€œArrayâ€æˆ–â€œObjectâ€ï¼Œå› ä¸ºè½¬æ¢ä¸ä¼šæœ‰å®è´¨æ€§ç»“æœã€‚æœ€åçš„defaultæ¡ä»¶æ˜¯ä¸ºäº†èƒ½å¤Ÿå‘åå…¼å®¹ï¼Œå½“è¿™ä¸ªæ‰©å±•å’ŒPHPæœªæ¥çš„ä¸€ä¸ªç‰ˆæœ¬ç›¸ç¼–è¯‘çš„æ—¶å€™ï¼Œè¿™ä¸ªPHPç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å…¶ä»–çš„æ•°æ®ç±»å‹ã€‚</p>

<p>å¦‚æœå‡½æ•°æ­£åœ¨å¯»æ‰¾ä¸€ä¸ªå…³è”keyï¼Œé‚£ä¹ˆkeyå°±å¿…é¡»æ˜¯éNULLï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªkeyçš„å€¼æ¥å†³å®šæ˜¯ä½¿ç”¨å…³è”æŸ¥è¯¢è¿˜æ˜¯æ•°å­—ç´¢å¼•æŸ¥è¯¢ã€‚å¦‚æœæŸ¥è¯¢å¤±è´¥äº†ï¼Œé‚£æ˜¯å› ä¸ºkeyä¸å­˜åœ¨ï¼Œç„¶åå‡½æ•°ä¼šè¿”å›NULLæ¥è¡¨æ˜æŸ¥è¯¢å¤±è´¥ã€‚å¦åˆ™zvalä¼šè¢«æ‹·è´åˆ°return_valueä¸­ã€‚</p>

<p>ç¬¦å·è¡¨ä½œä¸ºæ•°ç»„
å¦‚æœä½ ä¹‹å‰ä½¿ç”¨è¿‡$GLOBALSæ•°ç»„ï¼Œä½ åº”è¯¥çŸ¥é“è‡ªå·±åœ¨PHPè„šæœ¬çš„å…¨å±€ç©ºé—´ä¸­å£°æ˜çš„å˜é‡ä¹Ÿä¼šå‡ºç°åœ¨è¿™ä¸ªæ•°ç»„ä¸­ã€‚å›æƒ³ä¸€ä¸‹ï¼Œä¸€ä¸ªæ•°ç»„çš„å†…éƒ¨å®ç°æ˜¯ä¸€ä¸ªHashTableï¼Œä¸€ä¸ªé—®é¢˜å‡ºç°äº†ï¼šâ€œGLOBALSæ•°ç»„èƒ½å¦åœ¨ä¸€ä¸ªç‰¹æ®Šçš„åœ°æ–¹è¢«æ‰¾åˆ°å‘¢ï¼Ÿâ€å›ç­”æ˜¯â€œYESâ€ã€‚å®ƒå­˜åœ¨äºä¸€ä¸ªå«åšEG(symbol_table)çš„Executor Globals ç»“æ„ä½“ä¸­ï¼ŒEG(symbol_table)æ˜¯ä¸€ä¸ªHashTableï¼ˆä¸æ˜¯HashTable*ï¼Œæé†’ä¸€ä¸‹ä½ ï¼Œå°±æ˜¯HashTableï¼‰ã€‚</p>

<p>ä½ å·²ç»çŸ¥é“å¦‚ä½•åœ¨ä¸€ä¸ªæ•°ç»„ä¸­æ‰¾åˆ°å…³è”keyæ‰€å¯¹åº”çš„å…ƒç´ ï¼Œé‚£ä¹ˆç°åœ¨ä½ çŸ¥é“è¯¥å»å“ªé‡Œæ‰¾å…¨å±€ç¬¦å·è¡¨ï¼Œé‚£ä¹ˆåœ¨æ‰©å±•ä»£ç ä¸­æŸ¥æ‰¾å˜é‡åº”è¯¥æ˜¯ä¸€ä¸ªå¾ˆå®¹æ˜“çš„äº‹æƒ…ï¼š</p>

<p>PHP_FUNCTION(hello_get_global_var)
{
    char *varname;
    int varname_len;
    zval **varvalue;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "s", &amp;varname, &amp;varname_len) == FAILURE) {
    RETURN_NULL();
}
 
if (zend_hash_find(&amp;EG(symbol_table), varname, varname_len + 1, (void**)&amp;varvalue) == FAILURE) {
    php_error_docref(NULL TSRMLS_CC, E_NOTICE, "Undefined variable: %s", varname);
    RETURN_NULL();
}
 
*return_value = **varvalue;
zval_copy_ctor(return_value); } ç°åœ¨ä½ åº”è¯¥å¯¹è¿™ä¸ªå¾ˆç†Ÿæ‚‰äº†ã€‚è¿™ä¸ªå‡½æ•°æ¥æ”¶ä¸€ä¸ªå­—ç¬¦ä¸²å‚æ•°ï¼Œå¹¶ç”¨å®ƒåœ¨å…¨å±€ç©ºé—´ä¸­å¯»æ‰¾ä¸€ä¸ªå˜é‡ï¼Œç„¶åè¿”å›å®ƒã€‚
</code></pre></div></div>

<p>æ–°å‡ºç°çš„ä¸€ä¸ªå‡½æ•°æ˜¯php_error_docref()ã€‚ä½ å°†ä¼šåœ¨PHPæºç æ ‘ä¸­å‘ç°è¿™ä¸ªå‡½æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¯é€‰çš„æ–‡æ¡£å¼•ç”¨ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯å½“å‰å‡½æ•°ï¼‰ã€‚æ¥ä¸‹æ¥æ˜¯å¾ˆç»å¸¸å‡ºç°çš„TSRMLS_CCï¼Œä¹‹åæ˜¯ä¸€ä¸ªé”™è¯¯çš„ä¸¥é‡çº§åˆ«ï¼Œæœ€åæ˜¯ä¸€ä¸ªprintf()ç±»å‹æ ¼å¼çš„å­—ç¬¦ä¸²å’Œä¸€ä¸ªå¸¦æœ‰é”™è¯¯ä¿¡æ¯å®é™…å†…å®¹çš„ä¸€ä¸ªå˜é‡ã€‚æ— è®ºä½ çš„å‡½æ•°ä»€ä¹ˆæ—¶å€™å‡ºç°é”™è¯¯ï¼Œæä¾›ä¸€äº›å¯ä»¥ç†è§£çš„é”™è¯¯ä¿¡æ¯æ˜¯éå¸¸é‡è¦çš„ã€‚äº‹å®ä¸Šï¼Œå›å»ç»™hello_array_value()åŠ ä¸Šé”™è¯¯å¤„ç†è¯­å¥æ˜¯éå¸¸å¥½çš„åšæ³•ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹æœ€åçš„å®Œæ•´æ€§æ£€æŸ¥ç« èŠ‚ä¹Ÿä¼šåŒ…å«è¿™ä¸ªå·¥ä½œã€‚</p>

<p>é™¤äº†å…¨å±€ç¬¦å·è¡¨ä¹‹å¤–ï¼ŒZend Engineä¹Ÿä¿ç•™äº†ä¸€ä¸ªå±€éƒ¨ç¬¦å·è¡¨çš„å¼•ç”¨ã€‚å› ä¸ºå†…éƒ¨å‡½æ•°æ²¡æœ‰ä»–ä»¬è‡ªå·±çš„ç¬¦å·è¡¨ï¼ˆå®ƒä»¬ä¸ºä»€ä¹ˆè¦æœ‰ï¼Ÿï¼‰ï¼Œæ‰€ä»¥å±€éƒ¨ç¬¦å·è¡¨å®é™…ä¸Šå°±æ˜¯ç”¨æ¥ä¿å­˜å†…éƒ¨å‡½æ•°å˜é‡çš„ã€‚è®©æˆ‘ä»¬çœ‹ä¸ªç®€å•çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°åœ¨å±€éƒ¨ä½œç”¨åŸŸè®¾ç½®ä¸€ä¸ªå˜é‡ï¼š</p>

<p>PHP_FUNCTION(hello_set_local_var)
{
    zval *newvar;
    char *varname;
    int varname_len;
    zval *value;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "sz", &amp;varname, &amp;varname_len, &amp;value) == FAILURE) {
    RETURN_NULL();
}
 
ALLOC_INIT_ZVAL(newvar);
*newvar = *value;
zval_copy_ctor(newvar);
zend_hash_add(EG(active_symbol_table), varname, varname_len + 1, &amp;newvar, sizeof(zval*), NULL);
 
RETURN_TRUE; } å¾ˆæ˜æ˜¾è¿™æ²¡æœ‰ä»€ä¹ˆæ–°çš„ä¸œè¥¿ã€‚ç»§ç»­ï¼Œç„¶åæŠŠä½ ç°åœ¨æ‰‹ä¸Šçš„ä»£ç ç¼–è¯‘ä¸€ä¸‹ï¼Œå¹¶è¿è¡Œä¸€äº›æµ‹è¯•è„šæœ¬ã€‚ç¡®ä¿ç¼–è¯‘è¿‡ç¨‹æ— è¯¯ã€‚
</code></pre></div></div>

<p>å¼•ç”¨è®¡æ•°
åˆ°ç°åœ¨ä¸ºæ­¢ï¼Œæˆ‘ä»¬æ·»åŠ åˆ°HashTableä¸­çš„zvalä¸æ˜¯æ–°åˆ›å»ºçš„å°±æ˜¯æ–°æ‹·è´è¿‡æ¥çš„ã€‚è¿™äº›zvalæ˜¯ç‹¬ç«‹çš„ï¼Œæ‹¥æœ‰è‡ªå·±çš„èµ„æºï¼Œåªå­˜åœ¨äºHashTableä¹‹ä¸­ã€‚ä½œä¸ºä¸€ä¸ªè¯­è¨€è®¾è®¡çš„æ¦‚å¿µè€Œè¨€ï¼Œè¿™ç§åˆ›å»ºï¼Œæ‹·è´å˜é‡çš„æ–¹æ¡ˆæ˜¯â€œè¶³å¤Ÿå¥½â€çš„ï¼Œä½†æ˜¯æˆ‘çŸ¥é“ä½ å¾ˆç†Ÿæ‚‰ç”¨Cæ¥ç¼–ç¨‹ï¼Œæ‰€ä»¥ä½ çŸ¥é“å¦‚æœæ‹·è´ä¸€å¤§å—æ•°æ®çš„è¯æ˜¯éå¸¸è€—è´¹å†…å­˜å’ŒCPUæ—¶é—´çš„ï¼Œé™¤éä½ é‡åˆ°ç‰¹æ®Šæƒ…å†µä¸å¾—ä¸è¿™ä¹ˆåšã€‚è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªç”¨æˆ·ç©ºé—´ä»£ç å—ï¼š</p>

<p>å¦‚æœä½¿ç”¨zval_copy_ctor()ï¼ˆå®é™…ä¸Šä½¿ç”¨estrndup()æ¥å®Œæˆçš„ï¼‰æ¥æŠŠ$aæ‹·è´åˆ°$bï¼Œé‚£ä¹ˆè¿™ä¸ªç®€çŸ­çš„è„šæœ¬å°†ä¼šç”¨æ‰8Mçš„å†…å­˜æ¥å­˜å‚¨ä¸¤ä¸ªç›¸åŒçš„4Mæ–‡ä»¶çš„å†…å®¹ã€‚æœ€åä¸€æ­¥é‡Šæ”¾$aä¼šä½¿æƒ…å†µå˜å¾—æ›´ç³Ÿï¼Œå› ä¸ºåŸå§‹çš„å­—ç¬¦ä¸²å·²ç»è¢«efree()é‡Šæ”¾æ‰äº†ã€‚åœ¨Cè¯­è¨€ä¸­å®Œæˆè¿™ä¸ªåº”è¯¥ä¼šç®€å•ä¸€äº›ï¼šb = a; a = NULL;</p>

<p>å¹¸è¿çš„æ˜¯ï¼ŒZend Engineæ¯”ä»¥ä¸Šçš„åšæ³•è¦èªæ˜ä¸€äº›ã€‚å½“$aé¦–æ¬¡è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œä¸€ä¸ªéšå«çš„stringç±»å‹çš„zvalä¼šè¢«åˆ›å»ºï¼Œå†…å®¹æ˜¯logæ–‡ä»¶ã€‚é€šè¿‡è°ƒç”¨zend_hash_add()æ¥æŠŠé‚£ä¸ªzvalåˆ†é…ç»™$aã€‚å½“$aè¢«æ‹·è´åˆ°$bä¸­çš„æ—¶å€™ï¼Œå¯æƒ³è€ŒçŸ¥ï¼ŒZend Engineä¼šåšç±»ä¼¼ä¸‹é¢çš„äº‹æƒ…ï¼š</p>

<p>{
    zval <strong>value;
    zend_hash_find(EG(active_symbol_table), â€œaâ€, sizeof(â€œaâ€), (void</strong>)&amp;value);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ZVAL_ADDREF(*value);
zend_hash_add(EG(active_symbol_table), "b", sizeof("b"), value, sizeof(zval*)); } å½“ç„¶ï¼Œå®é™…ä»£ç ä¼šæ›´å¤æ‚ï¼Œä½†æ˜¯é‡ç‚¹å…³æ³¨çš„åœ°æ–¹æ˜¯ZVAL_ADDREF()ã€‚è®°å¾—åœ¨ä¸€ä¸ªzvalä¸­æœ‰å››ä¸ªæ ‡å‡†çš„å…ƒç´ ã€‚ä½ å·²ç»çœ‹è¿‡typeå’Œvalueäº†ï¼›è¿™æ¬¡çœ‹ä¸‹refcountã€‚å°±åƒå®ƒçš„åå­—è¡¨ç¤ºçš„é‚£æ ·ï¼ŒrefcountæŒ‡çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„zvalåœ¨ä¸€ä¸ªç¬¦å·è¡¨ï¼Œæ•°ç»„æˆ–è€…å…¶ä»–åœ°æ–¹è¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚
</code></pre></div></div>

<p>å½“ä½ ä½¿ç”¨ALLOC_INIT_ZVAL()çš„æ—¶å€™ï¼Œrefcountä¼šè¢«è®¾ç½®ä¸º1ï¼Œæ‰€ä»¥å½“ä½ æƒ³è¦è¿”å›è¿™ä¸ªzvalï¼Œæˆ–è€…æŠŠå®ƒåŠ å…¥åˆ°ä¸€ä¸ªHashTableä¸­çš„æ—¶å€™ï¼Œä¸éœ€è¦åšä»»ä½•äº‹ã€‚åœ¨ä»¥ä¸Šçš„ä»£ç ä¸­ï¼Œä½ ä»ä¸€ä¸ªHashTableä¸­æ‰¾åˆ°äº†ä¸€ä¸ªzvalï¼Œä½†æ˜¯æ²¡æœ‰åˆ é™¤å®ƒï¼Œæ‰€ä»¥å®ƒçš„refcountçš„å€¼ç¬¦åˆå®ƒè¢«å¼•ç”¨çš„æ¬¡æ•°ã€‚ä¸ºäº†åœ¨å…¶ä»–åœ°æ–¹å¯ä»¥å¼•ç”¨å®ƒï¼Œä½ éœ€è¦å¢åŠ å®ƒçš„å¼•ç”¨è®¡æ•°ã€‚</p>

<p>å½“åœ¨ç”¨æˆ·ç©ºé—´ä»£ç ä¸­è°ƒç”¨unset($a)æ—¶å€™ï¼ŒZend Engineä¼šåœ¨é‚£ä¸ªå˜é‡ä¸Šæ‰§è¡Œzval_ptr_dtor()ã€‚ä½¿ç”¨zval_ptr_dtor()çš„é‡è¦æ€§ä½ æ˜¯çœ‹ä¸è§çš„ï¼Œè¿™ä¸ªè°ƒç”¨ä¸éœ€è¦é”€æ¯è¿™ä¸ªzvalä»¥åŠå®ƒçš„æ‰€æœ‰å†…å®¹ã€‚å®ƒå®é™…åšçš„äº‹æƒ…æ˜¯å‡å°‘å®ƒçš„refcountã€‚å¦‚æœï¼Œæˆ‘è¯´å¦‚æœï¼Œrefcountçš„å€¼ä¸º0äº†ï¼Œé‚£ä¹ˆZend Engineä¼šé”€æ¯è¿™ä¸ªzvalâ€¦</p>

<p>https://blog.csdn.net/xiaogugood/article/details/35994385
<!-- more --></p>

<p>é˜…è¯»PHPçš„æºç æœ‰ä¸€æ®µæ—¶é—´äº†ï¼ŒçŸ¥é“åœ¨æ‰©å±•å‡½æ•°ä¸­åªè¦ä½¿ç”¨PHP_FUNCTIONï¼Œå¹¶ä¸”å°†å€¼èµ‹ç»™return_valueå°±å¯ä»¥è¿”å›æ­¤å‡½æ•°çš„å€¼ã€‚
ç„¶åè‡ªå·±è·Ÿè¸ªä»£ç ï¼Œä¸€ç›´ä»¥ä¸ºæœ‰ä¸€ä¸ªreturn_valueè¿™æ ·çš„å…¨å±€å˜é‡æˆ–åŒ…å« return_valueçš„å…¨å±€hashtableå­˜åœ¨ï¼Œç„¶åä¸åœçš„è°ƒè¯•ï¼Œä¸€ç›´æ²¡æœ‰å‘ç°ï¼Œ
ç›´åˆ°ä»Šå¤©é—®äº†é¸Ÿå“¥åæ‰é¡¿ç„¶é†’æ‚Ÿï¼Œé¸Ÿå“¥åœ¨é‚®ä»¶ä¸­è¯´ï¼šâ€œ return_valueæ˜¯phpä¸­æ‰€æœ‰å¯¹phpè„šæœ¬æä¾›å‡½æ•°PHP_FUCTIONçš„ä¸€ä¸ªå‚æ•°ï¼Œé€šè¿‡å®å±•å¼€çš„ã€‚ é€šè¿‡å¤åˆ¶ç»™è¿™ä¸ªå‚æ•°ï¼Œ ZEä¼šå°†è¿”å›å€¼ç»™å‰ç«¯è°ƒç”¨è„šæœ¬ã€‚ â€
åœ¨æ­¤éå¸¸æ„Ÿè°¢é¸Ÿå“¥çš„æŒ‡å¯¼ã€‚é¸Ÿå“¥çš„blogåœ°å€ï¼šhttp://www.laruence.com/</p>

<p>å…¶å®å®šä¹‰å¦‚ä¸‹ï¼š</p>

<p>1
2
3
4
#define PHP_FUNCTION ZEND_FUNCTION
#define ZEND_FUNCTION(name) ZEND_NAMED_FUNCTION(ZEND_FN(name))
#define ZEND_NAMED_FUNCTION(name) void name(INTERNAL_FUNCTION_PARAMETERS)
#define INTERNAL_FUNCTION_PARAMETERS int ht, zval *return_value, zval **return_value_ptr, zval *this_ptr, int return_value_used TSRMLS_DC
ä¸€äº›å†…ç½®çš„å‡½æ•°ï¼ˆæ¯”å¦‚eachï¼‰ç›´æ¥ä½¿ç”¨ZEND_FUNCTION
æ‰©å±•å‡½æ•°ä½¿ç”¨PHP_FUNCTION</p>

<p>åœ¨ä¸€äº›æ‰©å±•å‡½æ•°ä¸­æˆ‘ä»¬ç»å¸¸çœ‹åˆ°ä¸€äº›æ˜¯æ²¡æœ‰ä½¿ç”¨return_valueï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸€äº›åŒ…å«äº†return_valueçš„å®ä»£æ›¿ã€‚
å¸¸è§çš„å®å¦‚ä¸‹ï¼š</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
//    zend_API.h    500è¡Œå¼€å§‹
#define ZVAL_FALSE(z)   ZVAL_BOOL(z, 0)
#define ZVAL_TRUE(z)   ZVAL_BOOL(z, 1)</p>

<p>#define RETVAL_RESOURCE(l) ZVAL_RESOURCE(return_value, l)
#define RETVAL_BOOL(b) ZVAL_BOOL(return_value, b)
#define RETVAL_NULL() ZVAL_NULL(return_value)
#define RETVAL_LONG(l) ZVAL_LONG(return_value, l)
#define RETVAL_DOUBLE(d) ZVAL_DOUBLE(return_value, d)
#define RETVAL_STRING(s, duplicate) ZVAL_STRING(return_value, s, duplicate)
#define RETVAL_STRINGL(s, l, duplicate) ZVAL_STRINGL(return_value, s, l, duplicate)
#define RETVAL_EMPTY_STRING() ZVAL_EMPTY_STRING(return_value)
#define RETVAL_ZVAL(zv, copy, dtor) ZVAL_ZVAL(return_value, zv, copy, dtor)
#define RETVAL_FALSE   ZVAL_BOOL(return_value, 0)
#define RETVAL_TRUE   ZVAL_BOOL(return_value, 1)</p>

<p>#define RETURN_RESOURCE(l) { RETVAL_RESOURCE(l); return; }
#define RETURN_BOOL(b) { RETVAL_BOOL(b); return; }
#define RETURN_NULL() { RETVAL_NULL(); return;}
#define RETURN_LONG(l) { RETVAL_LONG(l); return; }
#define RETURN_DOUBLE(d) { RETVAL_DOUBLE(d); return; }
#define RETURN_STRING(s, duplicate) { RETVAL_STRING(s, duplicate); return; }
#define RETURN_STRINGL(s, l, duplicate) { RETVAL_STRINGL(s, l, duplicate); return; }
#define RETURN_EMPTY_STRING() { RETVAL_EMPTY_STRING(); return; }
#define RETURN_ZVAL(zv, copy, dtor) { RETVAL_ZVAL(zv, copy, dtor); return; }
#define RETURN_FALSE   { RETVAL_FALSE; return; }
#define RETURN_TRUE   { RETVAL_TRUE; return; }</p>

<p>http://www.phppan.com/2010/02/php-source-12-return_value/</p>

<p>[php-src]Phpæ‰©å±•çš„å†…å­˜æ³„æ¼å¤„ç†æ€è·¯</p>

<p>ä¸€. å°è£…å‡½æ•°æ—¶äº§ç”Ÿ memory leaks.</p>

<p>[weichen@localhost www]$ php 2.php 
[122,3333]
[Tue Jul 10 15:34:42 2016]  Script:  â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/pdoner/pdoner.c(83) :  Freeing 0x7F86B52F79F8 (32 bytes), script=/home/www/2.php
[Tue Jul 10 15:34:42 2016]  Script:  â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/php-5.6.14/ext/standard/string.c(1161) :  Freeing 0x7F86B52F7B60 (79 bytes), script=/home/www/2.php
=== Total 2 memory leaks detected ===
phpç¼–è¯‘å¼€å¯ â€“enable-debugï¼Œå¦‚æœæ‰©å±•ä¸­å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œä¼šæœ‰ç›¸åº”æç¤ºã€‚å†…å­˜æ³„æ¼é—®é¢˜ç›¸å½“å›°æ‰°ã€‚</p>

<p>ä¸ºä»€ä¹ˆä¼šæœ‰å†…å­˜æ³„éœ²ï¼Ÿæ˜¯ä½ çš„å‡½æ•°ä¸€ç›´åœ¨ç”³è¯·å†…å­˜åšæŸä»¶äº‹ï¼Œè€ŒåŠŸèƒ½å®Œæˆåæ²¡æœ‰é‡Šæ”¾å†…å­˜ã€‚</p>

<p>ç½‘ä¸Šçš„ hello world ç¨‹åºå¾ˆå¤šï¼ŒåŸºæœ¬æ˜¯ä¸è®²å†…å­˜å¤„ç†çš„ï¼Œå³ä¾¿ç¨ä½œä¿®æ”¹ï¼Œä¹Ÿæ— æ³•ç”¨äºçœŸå®é¡¹ç›®ã€‚</p>

<p>æ‰€ä»¥é‡Šæ”¾å†…å­˜ä¹Ÿæ˜¯åº•å±‚ç¨‹åºçš„å…³é”®ç‚¹ã€‚ç°åœ¨åˆ†æä¸€ä¸‹ä¸Šé¢çš„æç¤ºä¿¡æ¯ï¼Œæ€»å…±æ£€æµ‹æœ‰ 2 å¤„å†…å­˜æ³„æ¼ã€‚</p>

<p>ç¬¬(1)å¤„ï¼š</p>

<p>[Tue Jul 10 15:34:42 2016]  Script:  â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/pdoner/pdoner.c(83) :  Freeing 0x7F86B52F79F8 (32 bytes), script=/home/www/2.php</p>

<p>æç¤ºæˆ‘ä»¬ pdoner.c(83) æœ‰é—®é¢˜ï¼Œå›åˆ°ç¨‹åºä¸­æ˜¯ MAKE_STD_ZVAL(glue); ç»™ glue åˆå§‹åŒ–æ²¡é—®é¢˜ï¼Œé—®é¢˜æ˜¯ç”¨å®Œäº†æ²¡æœ‰é‡Šæ”¾ï¼Œå¾ˆå®¹æ˜“æƒ³åˆ°çš„æ˜¯è¦é‡Šæ”¾æ‰ glueã€‚</p>

<p>zval_ptr_dtor(&amp;glue);</p>

<p>ç¼–è¯‘å®‰è£…ä¾æ—§æœ‰é—®é¢˜ï¼Œå‡ºç°æ®µé”™è¯¯ä¸€èˆ¬æ˜¯æŒ‡é’ˆä½¿ç”¨æœ‰è¯¯ï¼š</p>

<p>[weichen@localhost www]$ php 2.php 
[Tue Jul 10 14:58:25 2016]  Script:  â€˜/home/www/2.phpâ€™
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
/home/weichen/Downloads/php-5.6.14/Zend/zend_execute.h(79) : Block 0x7fb3f93459c8 status:
/home/weichen/Downloads/php-5.6.14/Zend/zend_variables.c(37) : Actual location (location was relayed)
Invalid pointer: ((thread_id=0x007A7C7A) != (expected=0x06567840))
Segmentation fault (core dumped)
zval_ptr_dtor ä½¿ç”¨æœ‰ä»€ä¹ˆè®²ç©¶ï¼Ÿè¿™æ—¶å€™æœ€å¥½å…ˆæŸ¥é˜…ä¸€ä¸‹å†…æ ¸ä¸­çš„ç”¨æ³•ã€‚</p>

<p>zend_API.h ä¸­æœ‰è¿™æ ·ä¸€å¤„ç”¨æ³•ï¼š</p>

<p>#define ZVAL_ZVAL(z, zv, copy, dtor) do {       <br />
        zval *__z = (z);                        <br />
        zval *__zv = (zv);                      <br />
        ZVAL_COPY_VALUE(__z, __zv);             <br />
        if (copy) {                             <br />
            zval_copy_ctor(__z);                <br />
        }                                       <br />
        if (dtor) {                             <br />
            if (!copy) {                        <br />
                ZVAL_NULL(__zv);                <br />
            }                                   <br />
            zval_ptr_dtor(&amp;__zv);               <br />
        }                                       <br />
    } while (0)
æ³¨æ„ï¼Œåœ¨è°ƒç”¨ zval_ptr_dtor é”€æ¯ __zv ä¹‹å‰ï¼Œè°ƒç”¨äº† ZVAL_NULL(__zv) æŠŠæŒ‡é’ˆç½®ä¸ºnullã€‚</p>

<p>æ‰€ä»¥æˆ‘ä»¬ç…§è¿™ç§æ–¹å¼ï¼ŒæŠŠ glue è®¾ä¸ºnullã€‚</p>

<p>ZVAL_NULL(glue);
zval_ptr_dtor(&amp;glue);
ç¼–è¯‘è¿è¡Œï¼Œå¯ä»¥çœ‹åˆ°åªå‰©ä¸€å¤„æç¤ºäº†ã€‚</p>

<p>ç¬¬(2)å¤„ï¼š</p>

<p>[Tue Jul 10 15:34:42 2016]  Script:  â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/php-5.6.14/ext/standard/string.c(1161) :  Freeing 0x7F86B52F7B60 (79 bytes), script=/home/www/2.php
å½“æ—¶è¿™ä¸ªè¿˜æ²¡æœ‰è§£å†³æ‰ï¼Œå…ˆç»§ç»­å¾€ä¸‹çœ‹ï¼Œå›å¤´å†ä¸€èµ·çœ‹è¿™ä¸ªçš„è§£å†³åŠæ³•ã€‚</p>

<p>äºŒ. å°è£…ç±»æ—¶äº§ç”Ÿ memory leaks.</p>

<p>PDONER_ERRS_* å‡ä¸ºå®šä¹‰çš„å¸¸é‡ï¼Œä¸‹é¢æ˜¯æ— å†…å­˜æ³„æ¼çš„ç‰ˆæœ¬ï¼š</p>

<p>/* {{{ proto public Errs::__construct(void) */
PHP_METHOD(errs, __construct)
{
    zval *msg;
    MAKE_STD_ZVAL(msg);
    array_init(msg);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_index_string(msg, PDONER_ERRS_SUCC, "æˆåŠŸ", 1);
add_index_string(msg, PDONER_ERRS_FAIL, "å¤±è´¥", 1);
add_index_string(msg, PDONER_ERRS_EXCEP, "å¼‚å¸¸", 1);
add_index_string(msg, PDONER_ERRS_UNKNOW, "æœªçŸ¥", 1);

zend_update_property(errs_ce, getThis(), ZEND_STRL(PDONER_ERRS_PROPERTY_NAME_MSG), msg TSRMLS_CC);

zval_ptr_dtor(&amp;msg);
</code></pre></div></div>

<p>/*
    add_index_string(msg, PDONER_ERRS_SUCC, â€œæˆåŠŸâ€, 0);
    add_index_string(msg, PDONER_ERRS_FAIL, â€œå¤±è´¥â€, 0);
    add_index_string(msg, PDONER_ERRS_EXCEP, â€œå¼‚å¸¸â€, 0);
    add_index_string(msg, PDONER_ERRS_UNKNOW, â€œæœªçŸ¥â€, 0);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>add_property_zval_ex(getThis(), PDONER_ERRS_PROPERTY_NAME_MSG, sizeof(PDONER_ERRS_PROPERTY_NAME_MSG), msg TSRMLS_CC); */ } /* }}} */ æ‰©å±•ç±»çš„å±æ€§æ— æ³•ç›´æ¥åˆå§‹åŒ–æˆæ•°ç»„å’Œå¯¹è±¡ï¼Œæ‰€ä»¥åªèƒ½ä»¥ä¿®æ”¹å±æ€§çš„æ–¹å¼æ“ä½œï¼Œåœ¨æ„é€ å‡½æ•°å†… æˆ–è€… MINIT é˜¶æ®µã€‚
</code></pre></div></div>

<p>æ³¨æ„ï¼Œç”±äºå±æ€§èµ‹å€¼åœ¨ construct é˜¶æ®µï¼Œå¦‚æœæ²¡æœ‰å®ä¾‹åŒ–ç±»ï¼Œæ‰©å±•å†…éƒ¨ zend_read_property æ—¶è¿˜æ˜¯æ²¡æœ‰å€¼çš„ã€‚</p>

<p>zend_update_property ç¬¬äºŒä¸ªå‚æ•°æ˜¯å½“å‰å¯¹è±¡ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ç”¨åœ¨ MINIT é˜¶æ®µï¼Œä¸Šé¢ç”¨æ³•å‚è€ƒäº† Yaf-2.3.5ï¼š</p>

<p>PHP_METHOD(yaf_config_ini, __construct) {
    zval *filename, *section = NULL;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "z|z", &amp;filename, &amp;section) == FAILURE) {
    zval *prop;
    MAKE_STD_ZVAL(prop);
    array_init(prop);
    zend_update_property(yaf_config_ini_ce, getThis(), ZEND_STRL(YAF_CONFIG_PROPERT_NAME), prop TSRMLS_CC);
    zval_ptr_dtor(&amp;prop);
    return;
}

(void)yaf_config_ini_instance(getThis(), filename, section TSRMLS_CC); }
</code></pre></div></div>

<p>éç†æƒ³æƒ…å†µä¸‹ï¼š</p>

<p>1). æˆ‘ä»¬çš„æ„é€ å‡½æ•°ä¸­ï¼Œå¦‚æœä¼ äº†é duplicate çš„å‚æ•°ï¼šadd_index_string(msg, PDONER_ERRS_SUCC, â€œæˆåŠŸâ€, 0);</p>

<p>è°ƒç”¨ Errs::$msg å¯ä»¥æˆåŠŸè¾“å‡ºå†…å®¹ï¼Œä½†æ˜¯æœ‰æ®µé”™è¯¯ï¼š</p>

<h2 id="thu-jul-10-170438-2016-script-homewww2php">[Thu Jul 10 17:04:38 2016] Script: â€˜/home/www/2.phpâ€™</h2>
<p>/home/weichen/Downloads/php-5.6.14/Zend/zend_execute.h(79) : Block 0x7fbf5ed4bb4e status:
/home/weichen/Downloads/php-5.6.14/Zend/zend_variables.c(37) : Actual location (location was relayed)
Invalid pointer: ((thread_id=0x646F6C70) != (expected=0x6BF6E840))
Segmentation fault (core dumped)</p>

<p>Referenceï¼šwhen to duplicate string using add_index_string?</p>

<p>http://grokbase.com/t/php/php-dev/01285y74sp/when-to-duplicate-string-using-add-index-string</p>

<p>æœ‰å…¶å®ƒåœ°æ–¹ç”¨ï¼Œåˆ™å¤åˆ¶ä¸€ä»½å‡ºå»ï¼›æ²¡æœ‰å…¶å®ƒåœ°æ–¹ç”¨ï¼Œduplicate å¡« 0 .</p>

<p>2). å¯ç”¨æ³¨é‡Šæ®µä»£ç çš„æƒ…å†µï¼Œå¯ä»¥æˆåŠŸè¾“å‡ºï¼Œå´æœ‰ 11 å¤„å†…å­˜æ³„æ¼ï¼š</p>

<p>[Thu Jul 10 17:06:56 2016] Script: â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/php-5.6.14/Zend/zend_API.c(1369) : Freeing 0x7F1900D44820 (72 bytes), script=/home/www/2.php
/home/weichen/Downloads/php-5.6.14/Zend/zend_hash.c(419) : Actual location (location was relayed)
Last leak repeated 3 times
[Thu Jul 10 17:06:56 2016] Script: â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/php-5.6.14/Zend/zend_API.c(1366) : Freeing 0x7F1900D448C8 (32 bytes), script=/home/www/2.php
Last leak repeated 3 times
[Thu Jul 10 17:06:56 2016] Script: â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/pdoner/pdoner.c(120) : Freeing 0x7F1900D45C58 (32 bytes), script=/home/www/2.php
[Thu Jul 10 17:06:56 2016] Script: â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/php-5.6.14/Zend/zend_hash.c(392) : Freeing 0x7F1900D45D58 (64 bytes), script=/home/www/2.php
/home/weichen/Downloads/php-5.6.14/Zend/zend_alloc.c(2583) : Actual location (location was relayed)
[Thu Jul 10 17:06:56 2016] Script: â€˜/home/www/2.phpâ€™
/home/weichen/Downloads/pdoner/pdoner.c(121) : Freeing 0x7F1900D467C0 (72 bytes), script=/home/www/2.php
/home/weichen/Downloads/php-5.6.14/Zend/zend_API.c(1011) : Actual location (location was relayed)
=== Total 11 memory leaks detected ===</p>

<p>å¯è§æ˜¯æ²¡æœ‰é”€æ¯ zval *msg çš„ç¼˜æ•…ã€‚ä½ åŠ ä¸Š  zval_ptr_dtor(&amp;msg); åˆä¼šæŠ¥æ®µé”™è¯¯ã€‚</p>

<p>æ³¨æ„ä¸Šé¢çš„ç”¨æ³•æ²¡æœ‰è¿™æ ·ç”¨ï¼šadd_property_zval_ex(getThis(), ZEND_STRL(PDONER_ERRS_PROPERTY_NAME_MSG), msg TSRMLS_CC);</p>

<p>ä¸‰. å­—ç¬¦ä¸²è¿”å›å€¼çš„éš¾é¢˜.</p>

<p>å›åˆ°ç¬¬(2)å¤„çš„å­—ç¬¦ä¸²é—®é¢˜ä¸Šï¼Œåˆšå¼€å§‹æ˜¯è¿™ä¹ˆåšçš„ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char *src1 = "[";
char *ori = Z_STRVAL_P(return_value);
char *src2 = "]";

char *dest = (char *)emalloc(1024);

strcat(dest, src1);
strcat(dest, ori);
strcat(dest, src2);

RETURN_STRING(dest, 0); æ˜¾ç„¶ dest æ˜¯é•¿æœŸå ç”¨å†…å­˜çš„ï¼Œä½†ä½ å¦‚ä½•åœ¨è¿”å›å€¼ä¹‹åï¼Œè¿˜èƒ½å†æŠŠå®ƒé”€æ¯å‘¢ï¼Œææ€•æ— æ³•åšåˆ°ã€‚
</code></pre></div></div>

<p>è¿™é‡Œå°±è¦å¼•å…¥ä¸€ä¸ªæ¦‚å¿µï¼Œå½“ä½ çš„å‡½æ•°æ²¡æœ‰è¿”å›å€¼æ—¶ï¼Œå‡½æ•°é»˜è®¤è¿”å›çš„å˜é‡æ˜¯ zval *return_valueï¼Œä¹Ÿå°±æ˜¯ä½ ç”¨å®ƒå°±ä¸ä¼šæœ‰é—®é¢˜ã€‚</p>

<p>å¦å¤–ï¼Œæˆ‘ä»¬ç”¨å†…æ ¸ä¸­æä¾›çš„å­—ç¬¦ä¸²è¿æ¥å‡½æ•° concat_function(zval *result, zval *op1, zval *op2) ä»£æ›¿ strcat æ›´æœ‰æ•ˆçš„å¤„ç†ã€‚</p>

<p>concat_function åœ¨ ./Zend/zend_operators.c:1422ï¼Œæœ‰æ—¶å€™ä¸æ¸…æ¥šç”¨æ³•æœ€å¥½æ˜¯çœ‹å®ƒçš„å®ç°ã€‚</p>

<p>ä½¿ç”¨ concat_function ä¹‹åï¼Œæœ‰ä¸€äº›è¦æ³¨æ„çš„é—®é¢˜ï¼Œçœ‹ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ç¬¬ä¸€ç§æ–¹æ³•ï¼Œå¼•å…¥ä¸€ä¸ªå˜é‡
zval result;

concat_function(&amp;result, &amp;op1, return_value TSRMLS_CC);
concat_function(&amp;result, &amp;result, &amp;op2 TSRMLS_CC);

// 1. zval_ptr_dtor(&amp;return_value) was wrong.
// 2. forget zval_dtor(return_value) will cause memory leaks.

zval_dtor(return_value);

// copy result to return_value;
// if "zval result" is not zero-terminated, use ZVAL_ZVAL() instead, like the way 2. (PHP Warning:  String is not zero-terminated.)
ZVAL_COPY_VALUE(return_value, &amp;result);
   
// ç¬¬äºŒç§æ–¹æ³•ï¼Œæ›´ç®€æ´
concat_function(&amp;op1, &amp;op1, return_value TSRMLS_CC);
concat_function(&amp;op1, &amp;op1, &amp;op2 TSRMLS_CC);
zval_dtor(return_value);
ZVAL_ZVAL(return_value, &amp;op1, 0, 1); 

zval_dtor(&amp;op1);
zval_dtor(&amp;op2); ä¸Šé¢æ˜¯ pdoner æ‰©å±•å‡½æ•° pd_implode_json çš„å®ç°ï¼šhttps://github.com/farwish/pdoner
</code></pre></div></div>

<p>php æœªå¼€å¯ debug æ¨¡å¼æƒ…å†µä¸‹ä½¿ç”¨ valgrind å·¥å…·ï¼šhttp://tina.reeze.cn/book/?p=chapt06/06-07-memory-leaks</p>

<p>Link: http://www.cnblogs.com/farwish/p/5663993.html</p>

<p>https://blog.csdn.net/dilunzhuang0924/article/details/102107379
https://blog.csdn.net/weixin_34210740/article/details/86276931</p>

<p>https://github.com/farwish/pdoner/blob/master/pdoner.c#L145</p>

<p>https://segmentfault.com/a/1190000007575322
https://www.laruence.com/2018/04/08/3170.html</p>

<p>zval <em>var;
char *cstr;
int cstrlen;
/</em> â€¦ */
if (Z_TYPE_P(var) != IS_STRING) {
    convert_to_string(var);
}
cstr = Z_STRVAL_P(var);
cstrlen = Z_STRLEN_P(var);</p>

<p>https://stackoverflow.com/questions/3606125/convert-zval-to-char</p>

<p>https://www.jianshu.com/p/ac028b2aab07
https://www.cnblogs.com/xingxia/articles/memory_deal.html
https://blog.csdn.net/xiaogugood/article/details/35994385</p>
:ET