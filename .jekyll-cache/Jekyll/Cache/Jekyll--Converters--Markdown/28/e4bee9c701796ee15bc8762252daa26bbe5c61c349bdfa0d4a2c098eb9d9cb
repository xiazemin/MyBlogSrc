I"K<p>æ³¨æ„å’Œptraceï¼ˆptrace()ç³»ç»Ÿè°ƒç”¨æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ä¸€ä¸ªç¨‹åºï¼ˆè¿½è¸ªè€…ï¼‰å¯ä»¥è§‚å¯Ÿå’Œæ§åˆ¶å¦å¤–ä¸€ä¸ªç¨‹åºï¼ˆè¢«è¿½è¸ªè€…ï¼‰çš„æ‰§è¡Œï¼Œå¹¶æ£€æŸ¥å’Œæ”¹å˜è¢«è¿½è¸ªè€…çš„å†…å­˜åŠå¯„å­˜å™¨ã€‚å®ƒä¸»è¦ç”¨äºå®ç°æ–­ç‚¹è°ƒè¯•å’Œè¿½è¸ªç³»ç»Ÿè°ƒç”¨ã€‚GDBçš„å·¥ä½œæœºåˆ¶ï¼‰åŒºåˆ†</p>

<p>å’Œjstackä¸€æ ·, pstackäº¦èƒ½å±•ç°è¿›ç¨‹çš„çº¿ç¨‹å †æ ˆå¿«ç…§, éå¸¸æ–¹ä¾¿éªŒè¯å’Œæ€§èƒ½è¯„ä¼°.
 pstackçš„ä½œç”¨, å¤§è‡´å¯ä»¥å½’çº³å¦‚ä¸‹:
ã€€ã€€1). æŸ¥çœ‹çº¿ç¨‹æ•°(æ¯”pstree, åŒ…å«äº†è¯¦ç»†çš„å †æ ˆä¿¡æ¯)
ã€€ã€€2). èƒ½ç®€å•éªŒè¯æ˜¯å¦æŒ‰ç…§é¢„å®šçš„è°ƒç”¨é¡ºåº/è°ƒç”¨æ ˆæ‰§è¡Œ
ã€€ã€€3). é‡‡ç”¨é«˜é¢‘ç‡å¤šæ¬¡é‡‡æ ·ä½¿ç”¨æ—¶, èƒ½å‘ç°ç¨‹åºå½“å‰çš„é˜»å¡åœ¨å“ªé‡Œ, ä»¥åŠæ€§èƒ½æ¶ˆè€—ç‚¹åœ¨å“ªé‡Œ?
ã€€ã€€4). èƒ½åæ˜ å‡ºç–‘ä¼¼çš„æ­»é”ç°è±¡(å¤šä¸ªçº¿ç¨‹åŒæ—¶åœ¨wait lock, å…·ä½“éœ€è¦è¿›ä¸€æ­¥éªŒè¯)
ã€€ã€€å½“ç„¶è¿˜èƒ½ä¸¾ä¾‹æ›´å¤šçš„ä½œç”¨, ç›¸ä¿¡ä½¿ç”¨è¿‡jstackçš„coder, å¿…ç„¶æ·±ä»¥ä¸ºç„¶.</p>

<p>pstackåŸç†:
pstackæ˜¯/usr/bin/gstackçš„è½¯é“¾æ¥, è€Œgstackæœ¬èº«æ˜¯åŸºäºgdbå°è£…çš„shellè„šæœ¬.
æœ€æ ¸å¿ƒçš„ç‰‡æ®µ, backtrace=â€thread apply all btâ€
ã€€ã€€shellé‡‡ç”¨äº†here documentçš„æ–¹å¼, å®Œæˆäº†GDBçš„äº¤äº’å·¥ä½œ(æ³¨æ„EOFæ ‡è¯†, åŠèŒƒå›´å†…çš„äº¤äº’å‘½ä»¤). 
ã€€ã€€é‡è¦çš„æ˜¯è¾“å…¥thread apply all btè¿™ä¸ªäº¤äº’å‘½ä»¤. è¯¥å‘½ä»¤è¦æ±‚è¾“å‡ºæ‰€æœ‰çš„çº¿ç¨‹å †æ ˆä¿¡æ¯.
ã€€ã€€å¯¹GDBè¾“å‡ºçš„ç»“æœ, é€šè¿‡ç®¡é“å¹¶å€ŸåŠ©sedå‘½ä»¤è¿›è¡Œäº†æ›¿æ¢å’Œè¿‡æ»¤.
ã€€ã€€
`#!/bin/bash</p>

<p>if test $# -ne 1; then
Â Â Â  echo â€œUsage: <code class="language-plaintext highlighter-rouge">basename $0 .sh</code> <process-id>" 1&gt;&amp;2
Â Â Â  exit 1
fi</process-id></p>

<p>if test ! -r /proc/$1; then
Â Â Â  echo â€œProcess $1 not found.â€ 1&gt;&amp;2
Â Â Â  exit 1
fi</p>

<h1 id="gdb-doesnt-allow-thread-apply-all-bt-when-the-process-isnt">GDB doesnâ€™t allow â€œthread apply all btâ€ when the process isnâ€™t</h1>
<h1 id="threaded-need-to-peek-at-the-process-to-determine-if-that-or-the">threaded; need to peek at the process to determine if that or the</h1>
<h1 id="simpler-bt-should-be-used">simpler â€œbtâ€ should be used.</h1>

<p>backtrace=â€btâ€
if test -d /proc/$1/task ; then
Â Â Â  # Newer kernel; has a task/ directory.
Â Â Â  if test <code class="language-plaintext highlighter-rouge">/bin/ls /proc/$1/task | /usr/bin/wc -l</code> -gt 1 2&gt;/dev/null ; then
Â Â Â Â Â Â Â  backtrace=â€thread apply all btâ€
Â Â Â  fi
elif test -f /proc/$1/maps ; then
Â Â Â  # Older kernel; go by it loading libpthread.
Â Â Â  if /bin/grep -e libpthread /proc/$1/maps &gt; /dev/null 2&gt;&amp;1 ; then
Â Â Â Â Â Â Â  backtrace=â€thread apply all btâ€
Â Â Â  fi
fi</p>

<p>GDB=${GDB:-/usr/bin/gdb}</p>

<p>if $GDB -nx â€“quiet â€“batch â€“readnever &gt; /dev/null 2&gt;&amp;1; then
Â Â Â  readnever=â€“readnever
else
Â Â Â  readnever=
fi</p>

<h1 id="run-gdb-strip-out-unwanted-noise">Run GDB, strip out unwanted noise.</h1>
<p>$GDB â€“quiet $readnever -nx /proc/$1/exe $1 Â«EOF 2&gt;&amp;1 | 
$backtrace
EOF
/bin/sed -n <br />
Â Â Â  -e â€˜s/^(gdb) //â€™ <br />
Â Â Â  -e â€˜/^#/pâ€™ <br />
Â Â Â  -e â€˜/^Thread/pâ€™
`
<!-- more -->
åˆ©ç”¨pstack å’Œ straceåˆ†æç¨‹åºåœ¨å“ªé‡Œè€—æ—¶</p>

<p>ps	æŸ¥æ‰¾è¿›ç¨‹çš„pid
  pstack	æ‰“å°è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„æ ˆä¿¡æ¯
  strace 	ç»Ÿè®¡æ¯ä¸€æ­¥ç³»ç»Ÿè°ƒç”¨èŠ±è´¹çš„æ—¶é—´</p>

<ol>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ps -aux</td>
          <td>grep nws    å¯ä»¥çœ‹å‡ºnwsçš„pidä¸º171211</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>pstack   171211 æ‰“å°å‡ºnwsè¿›ç¨‹ä¸‹æ‰€æœ‰çš„çº¿ç¨‹æ ˆä¿¡æ¯ã€‚å¯ä»¥çœ‹å‡ºç¨‹åºå¥½å‡ ä¸ªçº¿ç¨‹éƒ½å¡åœ¨pwriteè¿™ä¸€æ­¥ã€‚</li>
  <li>strace -o output.txt -T -tt -e trace=all -p 171264 nwsè¿›ç¨‹ä¸­çš„171264çº¿ç¨‹è¿›è¡Œç³»ç»Ÿè°ƒç”¨è·Ÿè¸ªï¼Œ å°†è¾“å‡ºçš„ä¿¡æ¯ä¿å­˜åœ¨output.txtä¸­</li>
</ol>

<p>1.æ­»æœºåï¼Œè¾“å…¥:
   info threads â€”â€”- æŸ¥çœ‹æ‰€æœ‰threadä¿¡æ¯</p>
<ol>
  <li>thread apply all bt
   æ˜¾ç¤ºæ‰€æœ‰çš„çº¿ç¨‹å †æ ˆ</li>
</ol>

:ET