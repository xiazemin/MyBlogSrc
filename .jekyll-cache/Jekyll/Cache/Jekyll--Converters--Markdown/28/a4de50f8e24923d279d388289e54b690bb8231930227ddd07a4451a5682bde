I"»	<p>ESä¸­Dateå‹å­—æ®µä¸èƒ½ç›´æ¥ç”¨&gt;,&lt;,+,-è¿›è¡Œæ¯”è¾ƒå’Œè®¡ç®—ï¼Œä¼šæŠ¥é”™ã€‚
å¯ä»¥å…ˆæŠŠDateç±»å‹å–å¾—getMillis()ï¼Œå–å¾—æ—¶é—´æˆ³ï¼Œç„¶åå°±å¯ä»¥è¿›è¡Œæ¯”è¾ƒäº†ã€‚</p>

<p>ä½¿ç”¨TransportClientä»£ç å¦‚ä¸‹,paramæ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨scriptä¸­ä½¿ç”¨</p>

<p>Map&lt;String, Object&gt; params = Maps.newHashMap();
        params.put(â€œdatesubâ€, 5);
        QueryBuilder qb = QueryBuilders.boolQuery()
                .must(QueryBuilders.scriptQuery(
                        new Script(Script.DEFAULT_SCRIPT_TYPE, 
                                Script.DEFAULT_SCRIPT_LANG, 
                                â€œdoc[â€˜updated_timeâ€™].value.getMillis() - doc[â€˜create_timeâ€™].value.getMillis() &lt; params.datesubâ€, 
                                params)));</p>

<p>è„šæœ¬åŒ–åº¦é‡æ ‡å‡†èšåˆåœ¨å…¶æ‰§è¡Œçš„4ä¸ªé˜¶æ®µä½¿ç”¨è„šæœ¬ï¼š</p>

<p>init_script</p>

<p>åœ¨ä»»ä½•æ–‡ä»¶é›†åˆä¹‹å‰æ‰§è¡Œã€‚å…è®¸èšåˆè®¾ç½®ä»»ä½•åˆå§‹çŠ¶æ€ã€‚</p>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨å¯¹è±¡ä¸­init_scriptåˆ›å»ºä¸€ä¸ªæ•°ç»„ã€‚transactions_agg</p>

<p>map_script</p>

<p>æ¯ä¸ªæ”¶é›†çš„æ–‡ä»¶æ‰§è¡Œä¸€æ¬¡ã€‚è¿™æ˜¯å”¯ä¸€å¿…éœ€çš„è„šæœ¬ã€‚å¦‚æœæœªæŒ‡å®šcombine_scriptï¼Œåˆ™ç”Ÿæˆçš„çŠ¶æ€éœ€è¦å­˜å‚¨åœ¨åä¸ºçš„å¯¹è±¡ä¸­_aggã€‚</p>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œmap_scriptæ£€æŸ¥typeå­—æ®µçš„å€¼ã€‚å¦‚æœå€¼ä¸ºsaleï¼Œåˆ™amountå­—æ®µçš„å€¼å°†æ·»åŠ åˆ°transactionsæ•°ç»„ä¸­ã€‚å¦‚æœç±»å‹å­—æ®µçš„å€¼ä¸æ˜¯é”€å”®ï¼Œåˆ™é‡‘é¢å­—æ®µçš„å¦å®šå€¼å°†æ·»åŠ åˆ°äº¤æ˜“ä¸­ã€‚</p>

<p>combine_script</p>

<p>æ–‡æ¡£æ”¶é›†å®Œæˆåï¼Œåœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šæ‰§è¡Œä¸€æ¬¡ã€‚å…è®¸èšåˆåˆå¹¶ä»æ¯ä¸ªåˆ†ç‰‡è¿”å›çš„çŠ¶æ€ã€‚å¦‚æœæœªæä¾›combine_scriptï¼Œåˆ™ç»„åˆé˜¶æ®µå°†è¿”å›èšåˆå˜é‡ã€‚</p>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œcombine_scriptè¿­ä»£éå†æ‰€æœ‰å­˜å‚¨çš„äº‹åŠ¡ï¼Œå¯¹profitå˜é‡ä¸­çš„å€¼æ±‚å’Œå¹¶æœ€ç»ˆè¿”å›profitã€‚</p>

<p>reduce_script</p>

<p>åœ¨æ‰€æœ‰åˆ†ç‰‡è¿”å›ç»“æœåï¼Œåœ¨åè°ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œä¸€æ¬¡ã€‚è¯¥è„šæœ¬æä¾›å¯¹å˜é‡çš„è®¿é—®ï¼Œè¯¥å˜é‡_aggsæ˜¯æ¯ä¸ªåˆ†ç‰‡ä¸Šcombine_scriptç»“æœçš„æ•°ç»„ã€‚å¦‚æœæœªæä¾›reduce_scriptï¼Œåˆ™reduceé˜¶æ®µå°†è¿”å›_aggså˜é‡ã€‚</p>

<p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œreduce_scriptè¿­ä»£é€šè¿‡profitæ¯ä¸ªåˆ†ç‰‡è¿”å›çš„å€¼ï¼Œåœ¨è¿”å›æœ€ç»ˆç»„åˆåˆ©æ¶¦ä¹‹å‰å¯¹å€¼è¿›è¡Œæ±‚å’Œï¼Œè¯¥æœ€ç»ˆç»„åˆåˆ©æ¶¦å°†åœ¨èšåˆçš„å“åº”ä¸­è¿”å›ã€‚
<!-- more -->
https://blog.csdn.net/weixin_38409915/article/details/117651121
https://blog.csdn.net/ZYC88888/article/details/103605428
https://blog.csdn.net/tiansheng1225/article/details/82499085</p>
:ET