I"©5<p>shkex æ¨¡å—æœ€å¸¸è§çš„ç”¨æ³•å°±æ˜¯å…¶ä¸­çš„split å‡½æ•°ï¼Œsplit å‡½æ•°æä¾›äº†å’Œshell å¤„ç†å‘½ä»¤è¡Œå‚æ•°æ—¶ä¸€è‡´çš„åˆ†éš”æ–¹å¼</p>

<p>ä»£ç ç¤ºä¾‹ï¼š
shlex.split(â€œpython -u a.py -a A    -b   B     -o testâ€)
[â€˜pythonâ€™, â€˜-uâ€™, â€˜a.pyâ€™, â€˜-aâ€™, â€˜Aâ€™, â€˜-bâ€™, â€˜Bâ€™, â€˜-oâ€™, â€˜testâ€™]
åœ¨shell ä¸­ï¼Œå¯¹äºé€‰é¡¹å’Œå¯¹åº”çš„å€¼ä¹‹é—´å¯ä»¥æœ‰å¤šä¸ªç©ºæ ¼ï¼Œè€Œshlex.split ä¿æŒäº†å’Œsell ä¸€è‡´çš„å¤„ç†æ–¹å¼
<!-- more -->
subprocessæ¨¡å—æ˜¯å¹²å˜›çš„ï¼š</p>

<p>DESCRIPTION
This module allows you to spawn processes, connect to their
input/output/error pipes, and obtain their return codes.</p>

<p>å³å…è®¸ä½ å»åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹è®©å…¶æ‰§è¡Œå¦å¤–çš„ç¨‹åºï¼Œå¹¶ä¸å®ƒè¿›è¡Œé€šä¿¡ï¼Œè·å–æ ‡å‡†çš„è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ä»¥åŠè¿”å›ç ç­‰ã€‚ 
æ³¨æ„ï¼šä½¿ç”¨è¿™ä¸ªæ¨¡å—ä¹‹å‰è¦å…ˆå¼•å…¥è¯¥æ¨¡å—ã€‚</p>

<p>Popenç±»</p>

<p>subprocessæ¨¡å—ä¸­å®šä¹‰äº†ä¸€ä¸ªPopenç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥æ¥åˆ›å»ºè¿›ç¨‹ï¼Œå¹¶ä¸å…¶è¿›è¡Œå¤æ‚çš„äº¤äº’ã€‚æŸ¥çœ‹ä¸€ä¸‹å®ƒçš„æ„é€ å‡½æ•°ï¼š
<strong>init</strong>(self, args, bufsize=0, executable=None, 
stdin=None, stdout=None, stderr=None, preexec_fn=None, 
close_fds=False, shell=False, cwd=None, env=None, 
universal_newlines=False, startupinfo=None, 
creationflags=0)
ä¸»è¦å‚æ•°è¯´æ˜ï¼š 
argsï¼šargs should be a string, or a sequence of program arguments.ä¹Ÿå°±æ˜¯è¯´å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…åºåˆ—ç±»å‹ï¼ˆå¦‚ï¼šå­—ç¬¦ä¸²ã€listã€å…ƒç»„ï¼‰ï¼Œç”¨äºæŒ‡å®šè¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶åŠå…¶å‚æ•°ã€‚å¦‚æœæ˜¯ä¸€ä¸ªåºåˆ—ç±»å‹å‚æ•°ï¼Œåˆ™åºåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ é€šå¸¸éƒ½å¿…é¡»æ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨executeableå‚æ•°æ¥æŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ã€‚</p>

<p>stdin,stdout,stderrï¼šåˆ†åˆ«è¡¨ç¤ºç¨‹åºçš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯ã€‚æœ‰æ•ˆçš„å€¼å¯ä»¥æ˜¯PIPEï¼Œå­˜åœ¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå­˜åœ¨çš„æ–‡ä»¶å¯¹è±¡æˆ–Noneï¼Œå¦‚æœä¸ºNoneéœ€ä»çˆ¶è¿›ç¨‹ç»§æ‰¿è¿‡æ¥ï¼Œstdoutå¯ä»¥æ˜¯PIPEï¼Œè¡¨ç¤ºå¯¹å­è¿›ç¨‹åˆ›å»ºä¸€ä¸ªç®¡é“ï¼Œstderrå¯ä»¥æ˜¯STDOUTï¼Œè¡¨ç¤ºæ ‡å‡†é”™è¯¯æ•°æ®åº”è¯¥ä»åº”ç”¨ç¨‹åºä¸­æ•è·å¹¶ä½œä¸ºæ ‡å‡†è¾“å‡ºæµstdoutçš„æ–‡ä»¶å¥æŸ„ã€‚</p>

<p>shellï¼šå¦‚æœè¿™ä¸ªå‚æ•°è¢«è®¾ç½®ä¸ºTrueï¼Œç¨‹åºå°†é€šè¿‡shellæ¥æ‰§è¡Œã€‚ 
envï¼šå®ƒæè¿°çš„æ˜¯å­è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å¦‚æœä¸ºNoneï¼Œå­è¿›ç¨‹çš„ç¯å¢ƒå˜é‡å°†ä»çˆ¶è¿›ç¨‹ç»§æ‰¿è€Œæ¥ã€‚</p>

<p>åˆ›å»ºPopenç±»çš„å®ä¾‹å¯¹è±¡
res = subprocess.Popen(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
cmdï¼šæ ‡å‡†åƒå­è¿›ç¨‹ä¼ å…¥éœ€è¦æ‰§è¡Œçš„shellå‘½ä»¤ï¼Œå¦‚ï¼šls -al</p>

<p>subprocess.PIPEï¼šåœ¨åˆ›å»ºPopenå¯¹è±¡æ—¶ï¼Œsubprocess.PIPEå¯ä»¥åˆå§‹åŒ–ä¸ºstdin, stdoutæˆ–stderrçš„å‚æ•°ï¼Œè¡¨ç¤ºä¸å­è¿›ç¨‹é€šä¿¡çš„æ ‡å‡†è¾“å…¥æµï¼Œæ ‡å‡†è¾“å‡ºæµä»¥åŠæ ‡å‡†é”™è¯¯ã€‚</p>

<p>subprocess.STDOUTï¼šä½œä¸ºPopenå¯¹è±¡çš„stderrçš„å‚æ•°ï¼Œè¡¨ç¤ºå°†æ ‡å‡†é”™è¯¯é€šè¿‡æ ‡å‡†è¾“å‡ºæµè¾“å‡ºã€‚</p>

<p>Popenç±»æ‹¥æœ‰çš„æ–¹æ³•åŠå±æ€§</p>

<p>1ã€Popen.pid 
è·å–å­è¿›ç¨‹çš„è¿›ç¨‹IDã€‚</p>

<p>2ã€Popen.returncode</p>

<p>è·å–è¿›ç¨‹çš„è¿”å›ç ã€‚å¦‚æœè¿›ç¨‹æœªç»“æŸï¼Œå°†è¿”å›Noneã€‚</p>

<p>3ã€communicate(input=None)</p>

<p>å®˜æ–¹è§£é‡Šï¼š</p>

<p>Interact with process: Send data to stdin. Read data from
stdout and stderr, until end-of-file is reached. Wait for
process to terminate. The optional input argument should be a
string to be sent to the child process, or None, if no data
should be sent to the child.</p>

<p>communicate() returns a tuple (stdout, stderr).</p>

<p>ä¸å­è¿›ç¨‹è¿›è¡Œäº¤äº’ï¼Œåƒstdinå‘é€æ•°æ®ï¼Œå¹¶ä»stdoutå’Œstderrè¯»å‡ºæ•°æ®å­˜åœ¨ä¸€ä¸ªtupleä¸­å¹¶è¿”å›ã€‚ 
å‚æ•°inputåº”è¯¥æ˜¯ä¸€ä¸ªå‘é€ç»™å­è¿›ç¨‹çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæœªæŒ‡å®šæ•°æ®ï¼Œå°†ä¼ å…¥Noneã€‚</p>

<p>4ã€poll() 
æ£€æŸ¥å­è¿›ç¨‹æ˜¯å¦ç»“æŸï¼Œå¹¶è¿”å›returncodeå±æ€§ã€‚</p>

<p>5ã€wait()
Wait for child process to terminate. Returns returncode attribute.
ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œç»“æŸï¼Œå¹¶è¿”å›returncodeå±æ€§ï¼Œå¦‚æœä¸º0è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸã€‚</p>

<p>6ã€send_signal( sig)
Send a signal to the process
å‘é€ä¿¡å·ç»™å­è¿›ç¨‹ã€‚</p>

<p>7ã€terminate()
Terminates the process
ç»ˆæ­¢å­è¿›ç¨‹ã€‚windowsä¸‹å°†è°ƒç”¨Windows API TerminateProcessï¼ˆï¼‰æ¥ç»“æŸå­è¿›ç¨‹ã€‚</p>

<p>8ã€kill() 
å®˜æ–¹æ–‡æ¡£å¯¹è¿™ä¸ªå‡½æ•°çš„è§£é‡Šè·Ÿterminate()æ˜¯ä¸€æ ·çš„ï¼Œè¡¨ç¤ºæ€æ­»å­è¿›ç¨‹ã€‚</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="k">class</span> <span class="nc">Shell</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
 <span class="k">def</span> <span class="nf">runCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">:</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">STDOUT</span><span class="p">)</span>
  <span class="n">sout</span> <span class="p">,</span><span class="n">serr</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">communicate</span><span class="p">()</span>   
  <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">sout</span><span class="p">,</span> <span class="n">serr</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">pid</span>
 
<span class="n">shell</span> <span class="o">=</span> <span class="n">Shell</span><span class="p">()</span>
<span class="k">while</span> <span class="mi">1</span> <span class="p">:</span>
 <span class="nb">input</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">)</span>
 <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">'exit'</span> <span class="ow">or</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">'bye'</span> <span class="p">:</span>
  <span class="k">break</span>
 <span class="k">else</span> <span class="p">:</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">shell</span><span class="p">.</span><span class="n">runCmd</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">"è¿”å›ç ï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†è¾“å‡ºï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†é”™è¯¯ï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
 
</pre></td></tr></tbody></table></code></pre></figure>

<p>#!/usr/bin/expect -f
 # sudo apt-get install expect
 # ./ssh.exp user passwd server
set user [lrange $argv 0 0]
set pass [lrange $argv 1 1]
set server [lrange $argv 2 2]
set cmds [lrange $argv 3 $argc]</p>

<p>spawn ssh -o StrictHostKeyChecking=no $user@$server $cmds
match_max 100000
expect â€œ<em>?assword:</em>â€
send â€“ â€œ$pass\râ€
send â€“ â€œ\râ€
interact</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="code"><pre><span class="c1">#!/usr/local/bin/python
#encoding=utf-8
</span><span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="k">class</span> <span class="nc">Shell</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="p">:</span>
 <span class="k">def</span> <span class="nf">runCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">:</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="p">.</span><span class="n">PIPE</span><span class="p">)</span>
  <span class="n">sout</span> <span class="p">,</span><span class="n">serr</span> <span class="o">=</span> <span class="n">res</span><span class="p">.</span><span class="n">communicate</span><span class="p">()</span>
  <span class="c1">#print sout,serr
</span>  <span class="k">return</span> <span class="n">res</span><span class="p">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">sout</span><span class="p">,</span> <span class="n">serr</span><span class="p">,</span> <span class="n">res</span><span class="p">.</span><span class="n">pid</span>
<span class="n">shell</span> <span class="o">=</span> <span class="n">Shell</span><span class="p">()</span>
<span class="k">while</span> <span class="mi">1</span> <span class="p">:</span>
 <span class="nb">input</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">'&gt;'</span><span class="p">)</span>
 <span class="k">if</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">'exit'</span> <span class="ow">or</span> <span class="nb">input</span> <span class="o">==</span> <span class="s">'bye'</span> <span class="p">:</span>
  <span class="k">break</span>
 <span class="k">else</span> <span class="p">:</span>
  <span class="n">ssh_args</span> <span class="o">=</span> <span class="s">' %s %s %s %s %s </span><span class="se">\"</span><span class="s">%s</span><span class="se">\"</span><span class="s"> '</span> <span class="o">%</span> <span class="p">(</span><span class="s">"sshpass"</span><span class="p">,</span><span class="s">"-p"</span><span class="p">,</span><span class="s">"12345"</span><span class="p">,</span><span class="s">"ssh"</span><span class="p">,</span><span class="s">"user@192.123.11.12"</span><span class="p">,</span><span class="s">"ls -al ./"</span><span class="p">)</span>
  <span class="k">print</span> <span class="n">ssh_args</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">shell</span><span class="p">.</span><span class="n">runCmd</span><span class="p">(</span><span class="n">ssh_args</span><span class="p">)</span>
  <span class="c1">#result = shell.runCmd(input)
</span>  <span class="k">print</span> <span class="n">result</span>
  <span class="k">print</span> <span class="s">"è¿”å›ç dockerï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†è¾“å‡ºdockerï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†é”™è¯¯dockerï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"docker pid: "</span><span class="p">,</span><span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">shell</span><span class="p">.</span><span class="n">runCmd</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
  <span class="k">print</span> <span class="s">"è¿”å›ç ï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†è¾“å‡ºï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">print</span> <span class="s">"æ ‡å‡†é”™è¯¯ï¼š"</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
  <span class="n">result2</span> <span class="o">=</span> <span class="n">shell</span><span class="p">.</span><span class="n">runCmd</span><span class="p">(</span><span class="s">'exit'</span><span class="p">)</span>
  <span class="k">print</span> <span class="n">result2</span>
 
</pre></td></tr></tbody></table></code></pre></figure>

:ET