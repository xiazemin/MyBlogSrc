I"­,<p>Linuxæ˜¯ä¸€ä¸ªå¤šä»»åŠ¡æ“ä½œç³»ç»Ÿï¼Œå¯ä»¥æ–¹ä¾¿çš„åœ¨ä¸€ä¸ªæ§åˆ¶å°ï¼ˆæˆ–shellï¼‰ä¸‹åŒæ—¶æ‰§è¡Œå¤šæ¡å‘½ä»¤ï¼Œè¾¾åˆ°è¿™æ ·çš„ç›®æ ‡å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚æœ¬æ–‡å¸®åŠ©ç†è§£ä¸‹é¢å‡ ä¸ªè·Ÿæ§åˆ¶å°æœ‰å…³çš„æ¦‚å¿µï¼štty/ptyï¼Œcontrol terminalï¼Œsessionï¼Œprocess groupï¼Œsignalï¼›å¹¶è®¾è®¡å®ç°ä¸€ä¸ªå¤šä»»åŠ¡æ§åˆ¶ç¨‹åº</p>

<p>bash çš„å¤šä»»åŠ¡æ”¯æŒ
ç†Ÿæ‚‰Linuxçš„åŒå­¦éƒ½çŸ¥é“ï¼Œbashæ”¯æŒåŒæ—¶è·‘å¤šä¸ªä»»åŠ¡ï¼Œä¸‹é¢å…ˆç®€å•æ¼”ç¤ºä¸€ä¸‹ bash çš„å¤šä»»åŠ¡ã€‚é¦–å…ˆï¼Œè¿è¡Œä¸€ä¸ª cat å‘½ä»¤ï¼Œç„¶åé€šè¿‡ Ctrl+Z ä¸­æ–­è¿™ä¸ª cat å›åˆ° bashï¼š</p>

<p>$ cat
^Z
[1]+  Stopped                 cat
ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥å†è¿è¡Œä¸€ä¸ª cat ä»»åŠ¡ï¼Œè¿™å›è®© cat å¹²ç‚¹æ´»ï¼Œç»§ç»­ç”¨ Ctrl+Z ä¸­æ–­ï¼š</p>

<p>$ cat /dev/urandom &gt; /dev/null
^Z
[2]+  Stopped                 cat /dev/urandom &gt; /dev/null
è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸¤ä¸ª cat ä»»åŠ¡åœ¨åå°ï¼Œé€šè¿‡ bash å†…ç½®çš„ jobs å‘½ä»¤å¯ä»¥æŸ¥çœ‹åå°çš„ä»»åŠ¡ï¼š</p>

<p>$ jobs
[1]-  Stopped                 cat
[2]+  Stopped                 cat /dev/urandom &gt; /dev/null
å¤§å®¶å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤æ¡å‘½ä»¤éƒ½å¤„äº Stopped çŠ¶æ€ï¼Œç°åœ¨æˆ‘ä»¬é€šè¿‡ bg å‘½ä»¤è®©ç¬¬äºŒä¸ª cat åœ¨åå°è¿è¡Œï¼š</p>

<p>$ bg 2
[2]+ cat /dev/urandom &gt; /dev/null &amp;
$ jobs
[1]+  Stopped                 cat
[2]-  Running                 cat /dev/urandom &gt; /dev/null &amp;
è¿™æ—¶å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ª cat å˜æˆè“ Running çŠ¶æ€ï¼ŒåŒæ—¶æˆ‘æœºå™¨çš„ CPU æ¸©åº¦ä¹Ÿé£šä¸Šæ¥äº†ã€‚æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ fg å‘½ä»¤è®©ç¬¬ä¸€ä¸ª cat åˆ°å‰å°æ‰§è¡Œï¼š</p>

<p>$ fg 1
cat
ç°åœ¨è¿™ä¸ª cat åˆæ¢å¤åˆ°ç­‰å¾…æˆ‘çš„è¾“å…¥çš„çŠ¶æ€äº†ã€‚è¿™æ ·çœ‹æ¥ï¼Œå¥½åƒ multi-tasking æ˜¯ä¸€ä»¶éå¸¸ç®€å•çš„äº‹æƒ…ï¼Œé‚£ä¹ˆè¯·å°è¯•å›ç­”ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š</p>

<p>Q1. å¦‚ä½•ä¸­æ–­/ç»§ç»­ç¨‹åºçš„è¿è¡Œï¼Ÿ
Q2. å¦‚ä½•é˜²æ­¢åå°è¿è¡Œçš„ç¨‹åºäº’ç›¸æŠ¢å¤ºæ§åˆ¶å°è¾“å…¥ï¼Ÿ</p>

<table>
  <tbody>
    <tr>
      <td>æˆ‘æŒ‰äº†breakè®©è¿›ç¨‹åœäº†ï¼ŒæŒ‰ä»€ä¹ˆé”®èƒ½å‘SIGCONT è®©è¿›ç¨‹ç»§ç»­èµ°å•Šï¼Ÿ</td>
      <td>é€šå¸¸æ˜¯é€šè¿‡shellæ¥æ§åˆ¶çš„ï¼Œ Ctrl+Z SIGSTOP ç”¨bgæˆ–fgå‘½ä»¤ä¼šå‘SIGCONT, ä¹Ÿå¯ä»¥ç”¨kill -SIGCONT PID</td>
    </tr>
  </tbody>
</table>

<p>Ctrl+cæ˜¯å¼ºåˆ¶ä¸­æ–­ç¨‹åºçš„æ‰§è¡Œã€‚</p>

<p>Ctrl+zçš„æ˜¯å°†ä»»åŠ¡ä¸­æ–­,ä½†æ˜¯æ­¤ä»»åŠ¡å¹¶æ²¡æœ‰ç»“æŸ,ä»–ä»ç„¶åœ¨è¿›ç¨‹ä¸­ä»–åªæ˜¯ç»´æŒæŒ‚èµ·çš„çŠ¶æ€ã€‚</p>

<p>ç”¨æˆ·å¯ä»¥ä½¿ç”¨fg/bgæ“ä½œç»§ç»­å‰å°æˆ–åå°çš„ä»»åŠ¡, 
fgå‘½ä»¤é‡æ–°å¯åŠ¨å‰å°è¢«ä¸­æ–­çš„ä»»åŠ¡,
bgå‘½ä»¤æŠŠè¢«ä¸­æ–­çš„ä»»åŠ¡æ”¾åœ¨åå°æ‰§è¡Œ.
<!-- more -->
TTY - signal è½¬æ¢
é¦–å…ˆï¼Œå›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜</p>

<p>Q1. å¦‚ä½•ä¸­æ–­/ç»§ç»­ç¨‹åºçš„è¿è¡Œï¼Ÿ
å¾ˆç®€å•ï¼Œé€šè¿‡ä¸¤ä¸ª signal å°±å¯ä»¥æ§åˆ¶ç¨‹åºä¸­æ–­/è¿è¡Œï¼š</p>

<p>$ man 7 signal
       â€¦
       SIGCONT   19,18,25    Cont    Continue if stopped
       SIGSTOP   17,19,23    Stop    Stop process
       â€¦
äºæ˜¯æŸåŒå­¦å°±åœ¨ bash çš„ä»£ç é‡Œé¢æ‰¾å…³äºè¿™ä¸¤ä¸ª signal çš„ä»£ç ï¼Œä½†æ˜¯ä»–åªæ‰¾åˆ°äº† fg/bg å‘½ä»¤ç»™ç¨‹åºå‘é€äº† SIGCONTï¼Œæ²¡æœ‰æ‰¾åˆ°å…³äº SIGSTOP çš„ä»£ç ï¼Œäºæ˜¯æœ‰äº†ä¸‹é¢çš„é—®é¢˜ï¼š</p>

<p>Q1.1: ä»€ä¹ˆç¨‹åºç»™ cat å‘é€äº† SIGSTOP ä¿¡å·ï¼Ÿ
é€šè¿‡æœ¬å°èŠ‚æ ‡é¢˜ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œsignal å…¶å®æ˜¯ TTY å‘é€çš„ï¼š</p>

<p>$ stty -a
speed 38400 baud; rows 51; columns 185; line = 0;
â€¦. susp = ^Z; â€¦.
â€¦.
â€¦.
çœ‹åˆ°äº†é‡Œé¢çš„ susp = ^Z äº†ä¹ˆï¼Œè¿™ä¸ªè®¾ç½®çš„æ„æ€å°±æ˜¯ä¸€æ—¦ TTY æ”¶åˆ°äº† Ctrl-Z å°±ä¼šæŠŠå…¶è½¬æ¢æˆ SIGSTOP ä¿¡å·ï¼ŸåŒç†æˆ‘ä»¬å¯ä»¥è®¾ç½® Ctrl-N ä¸ºæŒ‚èµ·çš„å¿«æ·é”®</p>

<p>$ stty susp ^N
$ cat
^N
[1]+  Stopped                 cat
ç”±äºæ‰€æœ‰çš„ä¿¡å·éƒ½æ˜¯ tty æ§åˆ¶çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹ Ctrl-C/S/Q ç­‰æ‰€æœ‰ä¿¡å·å¿«æ·é”®çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™é‡Œåˆæœ‰äº†ä¸‹é¢è¿™ä¸ªé—®é¢˜ï¼š</p>

<p>Q3. å“ªäº›ç¨‹åºä¼šæ”¶åˆ° TTY æ¥çš„ä¿¡å·ï¼Ÿå¦‚æœå½“å‰ TTY æ¥çš„ä¿¡å·æ‰€æœ‰ç¨‹åºéƒ½èƒ½æ”¶åˆ°ï¼Œé‚£ä¹ˆ Ctrl-C ä¼šä¸ä¼šè¿åå°ç¨‹åºä¸€èµ·æ€æ‰ï¼Ÿ
è¿™ä¸ªé—®é¢˜å…ˆå–ä¸ªå…³å­ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹process groupã€‚</p>

<p>process group
è¿™é‡Œå…ˆå¯åŠ¨ä¸€äº›è¿›ç¨‹ï¼š</p>

<p>$ google-chrome &amp;
[1] 26077
$ cat | cat
æˆ‘åœ¨è¿™ä¸ª bash session é‡Œé¢å¯åŠ¨äº†3ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ª google-chromeï¼Œä¸¤ä¸ª catã€‚chrome åˆç»§ç»­å¯åŠ¨äº†å¾ˆå¤šè¿›ç¨‹ã€‚ä¸ºäº†æ–¹ä¾¿ç†è§£ç”»å¼ å›¾ï¼Œç†æ¸… TTYï¼Œsession ä¸ process group ä¹‹é—´çš„å…³ç³»ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Session                             â”‚ â”Œâ”€â”€â”€â”€â”€â”  One  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ TTY â”‚&lt;â”€â”€onâ”€&gt;â”‚  â”‚ Process group                  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜  One  â”‚  â”‚   bash                         â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ Active process group           â”‚ â”‚
          â”‚  â”‚   cat                          â”‚ â”‚
          â”‚  â”‚   cat                          â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ process group                  â”‚ â”‚
          â”‚  â”‚   /opt/google/chrome/chrome    â”‚ â”‚
          â”‚  â”‚    \_ /opt/google/chrome/chromeâ”‚ â”‚
          â”‚  â”‚    \_ /opt/google/chrome/chromeâ”‚ â”‚
          â”‚  â”‚    \_ /opt/google/chrome/chromeâ”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ æ¯ä¸ª TTY å¯¹åº”ä¸€ä¸ª sessionï¼Œsession æ˜¯ç”± login (ssh/getty/â€¦) ç¨‹åºåˆ›å»ºçš„ï¼Œbash ä»…ä»…æ˜¯ç»§æ‰¿äº†è¿™ä¸ª sessionã€‚æ¯ä¸ª session é‡Œé¢æœ‰è‹¥å¹²ä¸ª process groupï¼Œæ¯å½“ bash åˆ›å»ºï¼ˆforkï¼‰ä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œåœ¨è¿è¡Œç¨‹åºï¼ˆexec*ï¼‰å‰ï¼Œéƒ½ä¼šä¸ºè¿™ä¸ªè¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„ process groupã€‚æ¯ä¸ª process group ä¸­åªæœ‰ä¸€ä¸ª group å¤„äº active çŠ¶æ€ï¼Œç”± bash æ§åˆ¶å“ªä¸ªè¿›ç¨‹å¤„äº active çŠ¶æ€ã€‚æ¯ä¸ª process group é‡Œé¢æœ‰è‹¥å¹²ä¸ªè¿›ç¨‹ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Œä¸”å¬æˆ‘æ…¢æ…¢é“æ¥ã€‚å¤§å®¶æ˜¯å¦è¿˜è®°å¾—å‰é¢ç•™ä¸‹çš„ä¸¤ä¸ªæ‚¬è€Œæœªå†³çš„é—®é¢˜ï¼š
</code></pre></div></div>

<p>Q2. å¦‚ä½•é˜²æ­¢åå°è¿è¡Œçš„ç¨‹åºäº’ç›¸æŠ¢å¤ºæ§åˆ¶å°è¾“å…¥ï¼Ÿ
Q3. å“ªäº›ç¨‹åºä¼šæ”¶åˆ° TTY æ¥çš„ä¿¡å·ï¼Ÿå¦‚æœå½“å‰ TTY æ¥çš„ä¿¡å·æ‰€æœ‰ç¨‹åºéƒ½èƒ½æ”¶åˆ°ï¼Œé‚£ä¹ˆ Ctrl-C ä¼šä¸ä¼šè¿åå°ç¨‹åºä¸€èµ·æ€æ‰ï¼Ÿ
æœ‰äº† process group çš„æ¦‚å¿µï¼Œå›ç­”è¿™ä¸¤ä¸ªé—®é¢˜å°±éå¸¸ç®€å•äº†ï¼Œåªæœ‰å¤„äº Active å†…çš„è¿›ç¨‹èƒ½å¤Ÿè·å–æ§åˆ¶å°è¾“å…¥ï¼Œå¹¶ä¸” signal åªå‘é€ç»™ Active å†…çš„è¿›ç¨‹ã€‚å½“æœ‰åå°è¿è¡Œçš„è¿›ç¨‹æƒ³è¦è¯»å–æ§åˆ¶å°çš„æ—¶å€™ï¼ˆæ¯”å¦‚åå°è¿è¡Œä¸€ä¸ª catï¼‰ï¼Œtty ä¼šå‘å…¶å‘é€ SIGSTOP ä¿¡å·ï¼ŒæŒ‚èµ·æ­¤ç¨‹åºï¼Œä½ ä¼šå‘ç°ï¼Œä¼å›¾è®© cat åå°è¿è¡Œæ˜¯ä¸å¯èƒ½çš„ã€‚å½“ç”¨æˆ·æŒ‰ä¸‹ Ctrl-C æˆ–è€… Ctrl-Z çš„æ—¶å€™ï¼Œåªæœ‰å‰å°çš„è¿›ç¨‹ä¼šæ”¶åˆ°ç›¸åº”çš„ä¿¡å·ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ç”±äº bash çš„ç‰¹æ®Šè®¾è®¡ï¼Œç”¨æˆ·æ˜¯æ— æ³•è®©ä¸¤ä¸ªç¨‹åºåŒæ—¶è¯»å–æ§åˆ¶å°çš„ï¼Œå¦‚æœæœ‰äººå®åœ¨æ— èŠï¼Œå†™äº†ä¸ªç¨‹åº fork å‡ºå‡ ä¸ªå‰å°è¿›ç¨‹è¯»å–æ§åˆ¶å°ï¼ˆæ¯”å¦‚ç¬”è€…ï¼‰ï¼Œè¿˜æ˜¯ä¼šå‡ºç°æŠ¢å çš„ç°è±¡ï¼š</p>

<p>int main() {
        if (fork())
                execlp(â€œawkâ€, â€œawkâ€, â€œ{ print "parent:" $0 }â€, 0);
        else
                execlp(â€œawkâ€, â€œawkâ€, â€œ{ print "child:" $0 }â€, 0);
}
ç”¨æˆ·çš„è¾“å…¥ä¼šéšæœºä¼ ç»™ parent æˆ–è€… childï¼Œå¹¶ä¸”ç»“æœæ˜¯ä¸å¯é¢„æµ‹çš„ã€‚</p>

<p>å¤šä»»åŠ¡æ§åˆ¶çš„å®ç°
å‰é¢ä»‹ç»çš„å¤šä»»åŠ¡æ§åˆ¶çš„åŸç†ï¼Œä¸‹é¢æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªå¤šä»»åŠ¡æ§åˆ¶ç¨‹åºï¼Œå®ç°å’Œ bash ä¸€æ ·çš„åŠŸèƒ½ï¼š</p>

<p>åœ¨å‰å°æœ‰ä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™ç­‰å¾…</p>

<p>set processGroups</p>

<p>int startCommand(char *cmd) {
  int pid = fork();
  if (pid) {
    int = waitpid(pid); // ç­‰å¾…å‘½ä»¤è¿”å›ï¼ˆç»“æŸæˆ–è€…æŒ‚èµ·ï¼‰
    return status;
  } else {
    int mypid = getpid()
    pgid = setpgid(); // å»ºç«‹æ–°çš„ process group
    tcsetpgrp(pgid); // è®¾ç½®å½“å‰ group ä¸º active
    processGroups.add(mypid)
    exec(cmd); // è¿è¡Œå‘½ä»¤
  }
}
å¯ä»¥éšæ—¶æŒ‚èµ·å‰å°æ‰§è¡Œçš„ä»»åŠ¡</p>

<p>æŒ‚èµ·ç¨‹åºå®Œå…¨ç”± tty å®Œæˆï¼Œåªéœ€è¦åœ¨ waitpid åé¢æ£€æŸ¥å‰å°ç¨‹åºæ˜¯ç»“æŸäº†ï¼Œè¿˜æ˜¯è¢«æŒ‚èµ·äº†ï¼Œå¦‚æœæ˜¯æŒ‚èµ·äº†ï¼Œéœ€è¦æŠŠæ§åˆ¶å°è¾“å…¥æƒé™è¿”è¿˜ç»™ bashï¼š</p>

<p>â€¦
switch(startCommand(cmd)) {
case exit:
  processGroups.remove(pid);
  break;
case suspend:
  break; // do nothing
}
tcsetpgrp(getpgid()); // æ‹¿å› active process group
bg å‘½ä»¤åˆ‡æ¢åå°æ‰§è¡Œä»»åŠ¡</p>

<p>åªéœ€è¦å‘ç¨‹åºå‘é€ SIGCONT ä¿¡å·ï¼š</p>

<p>void bg(pid) {
  if (issuspended(pid))
    kill(pid, SIGCONT);
}
fg å‘½ä»¤æŠŠä»»åŠ¡åˆ‡æ¢åˆ°å‰å°</p>

<p>å…ˆè®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œç„¶åè½¬ç§» active process groupï¼š</p>

<p>int fg(pid) {
  bg(pid);
  tcsetpgrp(getpgid(pid));
  return waitpid(pid);
}
jobs å‘½ä»¤æŸ¥çœ‹å½“å‰ä»»åŠ¡</p>

<p>for (pid in processGroups)
  print pid;
è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†ä¸€ä¸ªå¤šä»»åŠ¡æ§åˆ¶ç¨‹åºï¼Œç”±äº tty è®¾å¤‡çš„å­˜åœ¨ï¼Œä½¿å¾—å®ç°å¤šä»»åŠ¡æ§åˆ¶è½»æ¾äº†å¾ˆå¤šã€‚Windows ä¸‹æ˜¯æ²¡æœ‰ tty è®¾å¤‡çš„ï¼Œäºæ˜¯æ§åˆ¶å°ç¨‹åºå°±æœ‰å¾ˆå¤šé™åˆ¶ï¼Œæ¯”å¦‚æ— æ³•å®ç°ä¸€ä¸ªèƒ½å¤Ÿè·å– Ctrl-C è¾“å…¥çš„æ§åˆ¶å°ç¨‹åºï¼Œåªæœ‰å»æ‹¦æˆª interrupt ä¿¡å·ã€‚ä¸Šé¢è¿™äº›å†…å®¹ä¼°è®¡åªæœ‰ bash çš„è®¾è®¡å¸ˆæ‰ä¼šå…³æ³¨ï¼Œä½†æ˜¯ä¸‹é¢çš„å†…å®¹å°±æ˜¯å‡ ä¹æ¯ä¸ª linux ç¨‹åºå‘˜éƒ½ä¼šå…³æ³¨çš„å†…å®¹ã€‚</p>

<p>daemon ç¨‹åºçš„å®ç°
daemon è¿›ç¨‹å°±æ˜¯è¦ä¸ TTY åˆ’å¼€ç•Œé™ï¼Œæ‰€æœ‰ä¸œè¥¿éƒ½ä¸ä¾èµ– TTYï¼Œé‚£ä¹ˆç»“æœå°±éå¸¸ç®€å•äº†ï¼Œå› ä¸º TTY å’Œ session æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ª session å°±ç­‰äºæŠŠä¸åŸæ¥ TTY æœ‰å…³çš„ä¸œè¥¿å®Œå…¨æŠ›å¼€äº†ï¼š</p>

<p>void daemonize(char *cmd) {
  close(0);
  close(1);
  close(2);
  if (fork())
    exit(0);
  else {
    setsid();
    exec(cmd);
  }
}
ä¸ºä»€ä¹ˆè¿™é‡Œéœ€è¦ fork ï¼Ÿ</p>

<p>First of all: setsid() will make your process a process group leader, but it will also make you the leader of a new session. If you are just interested in getting your own process group, then use setpgid(0,0).</p>

<p>Now for understanding the actual reason why setsid() returns EPERM if you already are process group leader or session leader you have to understand that process group and session ids are initialized from the process id of the process creating them (and hence leading them, i.e. for a session leader pid == sid and for a process group leader pid == pgid). Also process groups cannot move between sessions.</p>

<p>That means if you are a process group leader, and creating a new session would be allowed then the sid and the pgid would get set to your pid, leaving the other processes in your old process group in a weird state: their process group leader suddenly is in a different session then they themselves might be. And that cannot be allowed, hence the EPERM by the kernel.</p>

<p>Now if you fork() once you are neither session nor process group leader anymore and hence setting your sid and pgid to your pid is safe, because there are no other processes in such group.</p>
:ET