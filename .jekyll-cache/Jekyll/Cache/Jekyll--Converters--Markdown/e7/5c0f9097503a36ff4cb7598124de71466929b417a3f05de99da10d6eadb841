I"§,<p>æ ¹æ®phpæ‰‹å†Œçš„è§£æã€‚</p>

<p>__destructæ˜¯</p>

<p>ææ„å‡½æ•°ä¼šåœ¨åˆ°æŸä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½è¢«åˆ é™¤æˆ–è€…å½“å¯¹è±¡è¢«æ˜¾å¼é”€æ¯æ—¶æ‰§è¡Œã€‚</p>

<p>è€Œregister_shutdown_functionæ˜¯</p>

<p>Registers a callback to be executed after script execution finishes or exit() is called. æ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ­¤å‡½æ•°åœ¨è„šæœ¬è¿è¡Œå®Œæ¯•æˆ–è°ƒç”¨exit()æ—¶æ‰§è¡Œã€‚</p>

<p>ä»å­—é¢ä¸Šç†è§£ï¼Œ<strong>destructæ˜¯å¯¹è±¡å±‚é¢çš„ï¼Œè€Œregister_shutdown_functionæ˜¯æ•´ä¸ªè„šæœ¬å±‚é¢çš„ï¼Œç†åº”register_shutdown_functionçš„çº§åˆ«æ›´é«˜ï¼Œå…¶æ‰€æ³¨å†Œçš„å‡½æ•°ä¹Ÿåº”æœ€åæ‰§è¡Œã€‚
<!-- more -->
egister_shutdown_function(function(){echo â€˜globalâ€™;});
    class A {
        public function __construct(){
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    new A;
æ‰§è¡Œç»“æœï¼š</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>A::__destruct
global
å®Œå…¨è¯å®äº†æˆ‘ä»¬çš„çŒœæµ‹ï¼Œå®ƒæŒ‰ç…§å¯¹è±¡-&gt;è„šæœ¬çš„é¡ºåºè¢«æ‰§è¡Œäº†ã€‚</p>

<p>ä½†å¦‚æœæˆ‘ä»¬åœ¨å¯¹è±¡ä¸­æ³¨å†Œäº†register_shutdown_functionå‘¢ï¼Ÿå®ƒè¿˜æ˜¯ä¸€æ ·çš„é¡ºåºå—ï¼Ÿï¼</p>

<p>class A {
        public function <strong>construct(){
            register_shutdown_function(function(){echo â€˜localâ€™, â€˜<br />â€™;});
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    new A;</p>

<p>ç»“æœï¼š
local
A::__destruct</p>

<p>å¯ä»¥çœ‹åˆ°register_shutdown_functionå…ˆè¢«è°ƒç”¨äº†ï¼Œæœ€åæ‰æ˜¯æ‰§è¡Œå¯¹è±¡çš„__destructã€‚è¿™è¡¨æ˜register_shutdown_functionæ³¨å†Œçš„å‡½æ•°è¢«å½“ä½œç±»ä¸­çš„ä¸€ä¸ªæ–¹æ³•ï¼Ÿï¼ä¸å¾—è€ŒçŸ¥ï¼Œè¿™å¯èƒ½éœ€è¦æŸ¥çœ‹phpæºä»£ç æ‰èƒ½è§£æäº†ã€‚</p>

<p>æˆ‘ä»¬å¯ä»¥æ‰©å¤§èŒƒå›´æŸ¥çœ‹æƒ…å†µï¼š</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>register_shutdown_function(function(){echo â€˜globalâ€™, â€˜<br />â€™;});
    class A {
        public function <strong>construct(){
            register_shutdown_function(array($this, â€˜opâ€™));
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
        public function op()
        {
            echo <strong>class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    class B {
        public function <strong>construct()
        {
            register_shutdown_function(array($this, â€˜opâ€™));
            $obj = new A;
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
        public function op()
        {
            echo <strong>class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    $b = new B;
æˆ‘ä»¬åœ¨å…¨å±€æ³¨å†Œä¸€ä¸ªregister_shutdown_functionå‡½æ•°ï¼Œåœ¨ç±»ABä¸­åˆå„æ³¨å†Œäº†ä¸€ä¸ªï¼Œè€Œä¸”ç±»ä¸­åˆ†åˆ«è¿˜æœ‰ææ„æ–¹æ³•ã€‚æœ€åè¿è¡Œç»“æœä¼šæ€æ ·å‘¢ï¼Ÿ</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>global
B::op
A::op
A::__destruct
B::__destruct
ç»“æœå®Œå…¨é¢ è¦†äº†æˆ‘ä»¬çš„æƒ³åƒï¼Œregister_shutdown_functionå‡½æ•°æ— è®ºåœ¨ç±»ä¸­æ³¨å†Œè¿˜æ˜¯åœ¨å…¨å±€æ³¨å†Œï¼Œå®ƒéƒ½æ˜¯å…ˆè¢«æ‰§è¡Œï¼Œç±»ä¸­æ‰§è¡Œçš„é¡ºåºå°±æ˜¯å®ƒä»¬è¢«æ³¨å†Œçš„å…ˆåé¡ºåºã€‚å¦‚æœæˆ‘ä»¬å†ä»”ç»†ç ”ç©¶ï¼Œå…¨å±€çš„register_shutdown_functionå‡½æ•°æ— è®ºæ”¾åœ¨å‰é¢è¿˜æ˜¯åé¢éƒ½æ˜¯è¿™ä¸ªç»“æœï¼Œäº‹æƒ…ä¼¼ä¹æœ‰äº†ç»“æœï¼Œé‚£å°±æ˜¯register_shutdown_functionæ¯”__destructå…ˆæ‰§è¡Œï¼Œå…¨å±€çš„register_shutdown_functionå‡½æ•°åˆå…ˆäºç±»ä¸­æ³¨å†Œçš„register_shutdown_functionå…ˆæ‰§è¡Œã€‚</p>

<p>ä¸”æ…¢ï¼Œæˆ‘æ— æ³•æ¥å—è¿™ä¸ªç»“æœï¼ŒæŒ‰ç…§è¿™æ ·çš„ç»“è®ºï¼Œéš¾é“è¯´è„šæœ¬å·²ç»ç»“æŸåè¿˜å¯ä»¥å†æ‰§è¡Œ__destructï¼Ÿï¼å› æ­¤ï¼Œæˆ‘è¿˜è¦ç»§ç»­éªŒè¯è¿™ä¸ªç»“è®ºâ€”å»æ‰ç±»ä¸­æ³¨å†Œregister_shutdown_functionï¼Œè€Œä¿ç•™å…¨å±€register_shutdown_functionï¼š</p>

<p>lass A {
        public function <strong>destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    class B {
        public function <strong>construct()
        {
            $obj = new A;
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    register_shutdown_function(function(){echo â€˜globalâ€™, â€˜<br />â€™;});
è¾“å‡ºï¼š</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>A::__destruct
global
B::__destruct
ç»“æœä»¤äººèŒ«ç„¶ï¼ŒAã€Bä¸¤ä¸ªç±»çš„ææ„å‡½æ•°æ‰§è¡Œé¡ºåºæ— å¯è´¨ç–‘ï¼Œå› ä¸ºBä¸­è°ƒç”¨äº†Aï¼Œç±»Aè‚¯å®šæ¯”Bå…ˆé”€æ¯ï¼Œä½†å…¨å±€çš„register_shutdown_functionå‡½æ•°åˆæ€ä¹ˆå¤¹åœ¨å®ƒä»¬ä¸­é—´è¢«æ‰§è¡Œï¼Ÿï¼è´¹è§£ã€‚</p>

<p>æŒ‰ç…§æ‰‹å†Œçš„è§£æï¼Œææ„å‡½æ•°ä¹Ÿå¯åœ¨è°ƒç”¨exitæ—¶æ‰§è¡Œã€‚</p>

<p>ææ„å‡½æ•°å³ä½¿åœ¨ä½¿ç”¨ exit()ç»ˆæ­¢è„šæœ¬è¿è¡Œæ—¶ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚åœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨ exit() å°†ä¼šä¸­æ­¢å…¶ä½™å…³é—­æ“ä½œçš„è¿è¡Œã€‚</p>

<p>å¦‚æœåœ¨å‡½æ•°ä¸­è°ƒç”¨exitï¼Œå®ƒä»¬åˆå¦‚ä½•è¢«è°ƒç”¨çš„å‘¢ï¼Ÿ</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>class A {
        public function <strong>construct(){
            register_shutdown_function(array($this, â€˜opâ€™));
            exit;
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
        public function op()
        {
            echo <strong>class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    class B {
        public function <strong>construct()
        {
            register_shutdown_function(array($this, â€˜opâ€™));
            $obj = new A;
        }
        public function __destruct()
        {
            echo __class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
        public function op()
        {
            echo <strong>class</strong>,â€™::â€™,<strong>function</strong>,â€™<br />â€™;
        }
    }
    register_shutdown_function(function(){echo â€˜globalâ€™, â€˜<br />â€™;});
    $b = new B;
è¾“å‡ºï¼š</p>

<p>å¤åˆ¶ä»£ç ä»£ç å¦‚ä¸‹:</p>

<p>global
B::op
A::op
B::__destruct
A::__destruct
è¿™ä¸ªé¡ºåºä¸ä¸Šè¿°ç¬¬ä¸‰ä¸ªä¾‹å­ç›¸ä¼¼ï¼Œä¸åŒçš„ä¸”ä»¤äººä¸å¯æ€è®®çš„æ˜¯Bç±»çš„ææ„å‡½æ•°å…ˆäºç±»Aæ‰§è¡Œï¼Œéš¾é“é”€æ¯Båç±»Açš„æ‰€æœ‰å¼•ç”¨æ‰è¢«å…¨éƒ¨é”€æ¯ï¼Ÿï¼ä¸å¾—è€ŒçŸ¥ã€‚</p>

<p>ç»“è®ºï¼š
1ã€å°½é‡ä¸è¦åœ¨è„šæœ¬ä¸­å°†register_shutdown_functionä¸__destructæ··æ­ä½¿ç”¨ï¼Œå®ƒä»¬çš„è¡Œä¸ºå®Œå…¨ä¸å¯é¢„æµ‹ã€‚
1ã€å› ä¸ºå¯¹è±¡åœ¨ç›¸äº’å¼•ç”¨ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•æµ‹çŸ¥å¯¹è±¡å‡ æ—¶è¢«é”€æ¯ï¼Œå½“éœ€è¦æŒ‰é¡ºåºè¾“å‡ºå†…å®¹æ—¶ï¼Œä¸åº”æŠŠå†…å®¹æ”¾åœ¨ææ„å‡½æ•°__destructé‡Œï¼›
2ã€å°½é‡ä¸è¦åœ¨ç±»ä¸­æ³¨å†Œregister_shutdown_functionï¼Œå› ä¸ºå®ƒçš„é¡ºåºéš¾ä»¥é¢„æµ‹ï¼ˆåªæœ‰è°ƒç”¨è¿™ä¸ªå¯¹è±¡æ—¶æ‰ä¼šæ³¨å†Œå‡½æ•°ï¼‰ï¼Œè€Œä¸”__destructå®Œå…¨å¯ä»¥ä»£æ›¿register_shutdown_functionï¼›
3ã€å¦‚æœéœ€è¦åœ¨è„šæœ¬é€€å‡ºæ—¶æ‰§è¡Œç›¸å…³åŠ¨ä½œï¼Œæœ€å¥½åœ¨è„šæœ¬å¼€å§‹æ—¶æ³¨å†Œregister_shutdown_functionï¼Œå¹¶æŠŠæ‰€æœ‰åŠ¨ä½œæ”¾åœ¨ä¸€ä¸ªå‡½æ•°é‡Œã€‚</p>

<p>åœ¨è¿›è¡Œå¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡register_shutdown_functionæ³¨å†Œäº†ä¸€ä¸ªå‡½æ•°è¿›è¡Œæ—¥å¿—åˆ·æ–°ç£ç›˜ï¼Œä½†æ˜¯æ¯æ¬¡åœ¨ä¸€ä¸ªå¯¹è±¡çš„__destructæ‰“å°çš„æ—¥å¿—éƒ½ä¸èƒ½æ­£ç¡®çš„åˆ·æ–°åˆ°ç£ç›˜ï¼Œå®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æœ‰è¯´æ˜åˆ°åº•æ˜¯è°å…ˆæ‰§è¡Œï¼Œæ‰€ä»¥çœ‹äº†ä¸‹æºç ï¼Œè·Ÿå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œé¿å…å¤§å®¶è¸©å‘ã€‚</p>

<p>ç›´æ¥çœ‹æºç ï¼š
å¾ˆæ¸…æ™°çš„çœ‹å‡ºæ¥æ˜¯å…ˆè°ƒç”¨register_shutdown_functionä¸­çš„æ–¹æ³•ï¼Œè€Œææ„å‡½æ•°ç¬¬äºŒæ­¥æ‰§è¡Œï¼Œæœ€åflush bufferã€‚</p>

<p>// php7.0.6çº¿ä¸Šç‰ˆæœ¬
// ä»£ç è·¯å¾„ï¼šphp-src/main/main.c
void php_request_shutdown(void <em>dummy)
{
â€¦â€¦
    /</em> 1. Call all possible shutdown functions registered with register_shutdown_function() */
    if (PG(modules_activated)) zend_try {
        php_call_shutdown_functions();
    } zend_end_try();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* 2. Call all possible __destruct() functions */
zend_try {
    zend_call_destructors();
} zend_end_try();

/* 3. Flush all output buffers */
zend_try { â€¦â€¦ } éªŒè¯ï¼š &lt;?php
// test.php
register_shutdown_function(function() {
    echo "1.shutdown\n";
});
class Test {
    function __destruct() {
        echo "2.destruct\n";
    }
}
/* 
 * è¿™é‡Œå¦‚æœä¸èµ‹å€¼ç»™$test, ä¼šä¼˜å…ˆæ‰§è¡Œ__destructï¼Œ
 * å› ä¸ºç›¸å½“äºæ‰§è¡Œäº†unset($test)ï¼Œè€Œä¸æ˜¯åœ¨è¯·æ±‚ç»“æŸåé”€æ¯çš„å¯¹è±¡
 */
$test = new Test(); æœªä¿®æ”¹å‰ï¼š php test.php 1.shutdown 2.destruct
</code></pre></div></div>

<p>ä¿®æ”¹æºç ï¼Œæ¢äº†ä¸€ä¸‹é¡ºåºï¼š</p>

<p>// php7.0.6çº¿ä¸Šç‰ˆæœ¬
// ä»£ç è·¯å¾„ï¼šphp-src/main/main.c
void php_request_shutdown(void <em>dummy)
{
  â€¦â€¦
    /</em> 2. Call all possible __destruct() functions */
    zend_try {
        zend_call_destructors();
    } zend_end_try();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* 1. Call all possible shutdown functions registered with register_shutdown_function() */
if (PG(modules_activated)) zend_try {
    php_call_shutdown_functions();
} zend_end_try();

/* 3. Flush all output buffers */
zend_try { â€¦â€¦ } ä¿®æ”¹åç»“æœï¼š php test.php 2.destruct 1.shutdown
</code></pre></div></div>

<p>ç»“è®ºï¼š
å½“è¯·æ±‚ç»“æŸåï¼Œéœ€è¦PHPè‡ªåŠ¨é‡Šæ”¾çš„å¯¹è±¡ï¼ŒPHPä¼˜å…ˆæ‰§è¡Œregister_shutdown_functionæ³¨å†Œçš„å‡½æ•°ï¼Œåæ‰§è¡Œå¯¹è±¡çš„__destructï¼Œæ‰€ä»¥å°½é‡ä¸è¦æ··åˆä½¿ç”¨__destructå’Œregister_shutdown_functionï¼Œé™¤éä½ æ¸…æ¥šä»–ä»¬çš„æ‰§è¡Œé¡ºåºå¯¹ä½ æ²¡å½±å“</p>

<p>fastcgi_finish_request,register_shutdown_functionå’Œ__destructçš„ç†è§£</p>

<p>é’ˆå¯¹nginxå’Œphp-fpmæ¨¡å¼ï¼Œphpå®šä¹‰äº†ä¸€ä¸ªå‡½æ•°fastcgi_finish_requestï¼Œå¯ä»¥æé«˜æ¥å£è¿”å›æ•°æ®çš„é€Ÿåº¦ã€‚</p>

<p>nginxçš„fastcgiæ¨¡å—ä¸php-fpmç¨‹åºè¿›è¡Œäº¤äº’ï¼Œè·å–php-fpmçš„workerè¿›ç¨‹æ‰§è¡Œçš„ç»“æœã€‚ä¸€èˆ¬æƒ…å†µï¼Œphpçš„è¿›ç¨‹å®Œå…¨æ‰§è¡Œå®Œåï¼Œæ‰ä¼šå§è¾“å‡ºçš„æ•°æ®flushåˆ°nginxçš„fastcgiç¼“å­˜åŒºã€‚åœ¨phpè¿›ç¨‹ä¸­æ‰§è¡Œfastcgi_finish_request()ï¼Œå¯ä»¥ä¸»åŠ¨æŠŠè¿›ç¨‹çš„è¾“å‡ºæ•°æ®flushåˆ°nginx,è¿™æ—¶å€™php-fpmçš„workerç»§ç»­æ‰§è¡Œåˆ°ç¨‹åºç»“æŸã€‚</p>

<p>__destruct(),ææ„å‡½æ•°ï¼Œåªæœ‰å½“å®ä¾‹åˆ é™¤æ—¶æ‰ä¼šæ‰§è¡Œã€‚</p>

<p>register_shutdown_function()ï¼Œè¿›ç¨‹ç»“æŸæ—¶ï¼Œæ‰§è¡Œæ³¨å†Œçš„å‡½æ•°ã€‚æ— è®ºphpè¿›ç¨‹æ˜¯ä½•åŸå› ç»“æŸï¼ŒåŒ…æ‹¬errç­‰ç­‰ï¼Œéƒ½ä¼šæ‰§è¡Œè¿™é‡Œçš„å‡½æ•°ï¼ˆæ‰§è¡Œæ³¨å†Œçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠä»£ç åŠ å…¥åˆ°å†…å­˜ä¸­ï¼‰ã€‚</p>

<p>class A {
	public function test()
	{
		echo â€˜aaaaaâ€™;
        register_shutdown_function(function () {
            echo â€˜shutdownâ€™;
        });
	}
	public function __destruct()
    {
        echo â€˜__destructâ€™.â€<br />â€;
    }
}
$class = new A();
$class-&gt;test();
æ¥å£ä¼šè¾“å‡ºï¼šaaaaashutdown__destructï¼Œä¸‰ä¸ªåœ°æ–¹çš„è¾“å‡ºéƒ½ä¼šæœ‰ã€‚
class A {
	public function test()
	{
		echo â€˜aaaaaâ€™;
        register_shutdown_function(function () {
            echo â€˜shutdownâ€™;
        });
	}
	public function __destruct()
    {
        echo â€˜__destructâ€™.â€<br />â€;
    }
}
$class = new A();
$class-&gt;test();
if (function_exists(â€˜fastcgi_finish_requestâ€™)) {
        fastcgi_finish_request();//ä¸»åŠ¨flushæ•°æ®ç»™nginx
   }
æ¥å£è¾“å‡ºï¼šaaaaaã€‚å› ä¸º__destructï¼Œregister_shutdown_functionçš„æ³¨å†Œå‡½æ•°éƒ½è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œå°±å·²ç»è¿”å›æ•°æ®ç»™nginxäº†ï¼Œå¹¶ä¸”ä¼šå…³é—­è¿™ä¸ªcgiè¿æ¥ã€‚æ‰€ä»¥åœ¨__destructï¼Œregister_shutdown_functionçš„æ³¨å†Œå‡½æ•°ä¸­ä¸è¦åšè¾“å‡ºæ“ä½œï¼Œä¸ç„¶nginxæ¥æ”¶ä¸åˆ°åé¢çš„è¾“å‡ºäº†ã€‚</p>
:ET