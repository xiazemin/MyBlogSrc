I"Ş<p>POSIXæä¾›äº†forkå’Œexecè°ƒç”¨æ¥å¯åŠ¨ä¸€ä¸ªæ–°è¿›ç¨‹ï¼Œforkå¤åˆ¶çˆ¶è¿›ç¨‹ï¼Œç„¶åé€šè¿‡execæ¥æ›¿æ¢è‡ªå·±è¦æ‰§è¡Œçš„ç¨‹åºã€‚åœ¨goä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨exec.Commandæˆ–è€…os.StartProcessæ¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœã€‚
åœ¨å¯åŠ¨å­è¿›ç¨‹æ—¶ï¼Œéœ€è¦è®©å­è¿›ç¨‹çŸ¥é“ï¼Œæˆ‘æ­£å¤„äºçƒ­æ›´æ–°è¿‡ç¨‹ä¸­ã€‚é€šå¸¸ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–è€…å‚æ•°æ¥å®ç°ï¼Œä¾‹å­ä¸­ä½¿ç”¨äº†-gracefulè¿™ä¸ªå‚æ•°ã€‚
file := netListener.File() // this returns a Dup()
path := â€œ/path/to/executableâ€
args := []string{
    â€œ-gracefulâ€}</p>

<p>cmd := exec.Command(path, argsâ€¦)
cmd.Stdout = os.Stdout
cmd.Stderr = os.Stderr
cmd.ExtraFiles = []*os.File{file}</p>

<p>err := cmd.Start()
if err != nil {
    log.Fatalf(â€œgracefulRestart: Failed to launch, error: %vâ€, err)
}
ç„¶ååœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨net.FileListeneræ¥ä»fdåˆ›å»ºä¸€ä¸ªListener
func FileListener
func FileListener(f *os.File) (ln Listener, err error)
FileListener returns a copy of the network listener corresponding to the open file f. It is the callerâ€™s responsibility to close ln when finished. Closing ln does not affect f, and closing f does not affect ln.</p>

<p>flag.BoolVar(&amp;gracefulChild, â€œgracefulâ€, false, â€œlisten on fd open 3 (internal use only)â€)</p>

<p>if gracefulChild {
    log.Print(â€œmain: Listening to existing file descriptor 3.â€)
    f := os.NewFile(3, â€œâ€) // 3å°±æ˜¯æˆ‘ä»¬ä¼ é€’çš„listening fd
    l, err = net.FileListener(f)
} else {
    log.Print(â€œmain: Listening on a new file descriptor.â€)
    l, err = net.Listen(â€œtcpâ€, server.Addr)
}
åˆ°è¿™é‡Œï¼Œå­è¿›ç¨‹å°±å¯ä»¥Acceptå¹¶æ¥å—è¿æ¥äº†ï¼Œç°åœ¨æˆ‘ä»¬è¿˜éœ€è¦ç«‹åˆ»å¹²æ‰çˆ¶è¿›ç¨‹ã€‚ä½¿ç”¨getpidè°ƒç”¨è·å–åˆ°çˆ¶è¿›ç¨‹çš„idï¼Œç„¶åkillå®ƒã€‚</p>

<p>parent := syscall.Getppid()
syscall.Kill(parent, syscall.SIGTERM)
å½“ç„¶ï¼Œæ›´åŠ å®Œç¾çš„æ–¹å¼è¿˜éœ€è¦çˆ¶è¿›ç¨‹å¯ä»¥ä¼˜é›…é€€å‡ºï¼Œå³ä¸å†æ¥å—æ–°è¿æ¥ï¼Œå¹¶ä¸”å¤„ç†å®Œå½“å‰æ‰€æœ‰è¿æ¥åå†é€€å‡ºï¼Œå¦‚æœä¸€æ®µæ—¶é—´å†…æ²¡èƒ½å¤„ç†å®Œï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ç›´æ¥é€€å‡ºã€‚
<!-- more -->
ä¸Šé¢ netListener.File() ä¸ dup å‡½æ•°ç±»ä¼¼ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ‹·è´çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦å¤–ï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦ä¸åº”è¯¥è®¾ç½® FD_CLOEXEC æ ‡è¯†ï¼Œè¿™å°†ä¼šå¯¼è‡´å‡ºç°æˆ‘ä»¬ä¸æƒ³è¦çš„ç»“æœï¼šå­è¿›ç¨‹çš„è¯¥æ–‡ä»¶æè¿°ç¬¦è¢«å…³é—­ã€‚</p>

<p>ä½ å¯èƒ½ä¼šæƒ³åˆ°å¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æŠŠè¯¥æ–‡ä»¶æè¿°ç¬¦çš„å€¼ä¼ é€’ç»™å­è¿›ç¨‹ï¼Œä½†ç›¸å¯¹æ¥è¯´ï¼Œæˆ‘ä½¿ç”¨çš„è¿™ç§æ–¹å¼æ›´ä¸ºç®€å•</p>

<p>æœ€ç»ˆï¼Œ args æ•°ç»„åŒ…å«äº†ä¸€ä¸ª -graceful é€‰é¡¹ï¼Œä½ çš„è¿›ç¨‹éœ€è¦ä»¥æŸç§æ–¹å¼é€šçŸ¥å­è¿›ç¨‹è¦å¤ç”¨çˆ¶è¿›ç¨‹çš„æè¿°ç¬¦è€Œä¸æ˜¯æ–°æ‰“å¼€ä¸€ä¸ªã€‚</p>

<p>å­è¿›ç¨‹åˆå§‹åŒ–
server := &amp;http.Server{Addr: â€œ0.0.0.0:8888â€}</p>

<p>var gracefulChild bool
var l net.Listever
var err error</p>

<p>flag.BoolVar(&amp;gracefulChild, â€œgracefulâ€, false, â€œlisten on fd open 3 (internal use only)â€)</p>

<p>if gracefulChild {
    log.Print(â€œmain: Listening to existing file descriptor 3.â€)
    f := os.NewFile(3, â€œâ€)
    l, err = net.FileListener(f)
} else {
    log.Print(â€œmain: Listening on a new file descriptor.â€)
    l, err = net.Listen(â€œtcpâ€, server.Addr)
}
é€šçŸ¥çˆ¶è¿›ç¨‹åœæ­¢
if gracefulChild {
    parent := syscall.Getppid()
    log.Printf(â€œmain: Killing parent pid: %vâ€, parent)
    syscall.Kill(parent, syscall.SIGTERM)
}</p>

<p>server.Serve(l)
çˆ¶è¿›ç¨‹åœæ­¢æ¥æ”¶è¯·æ±‚å¹¶ç­‰å¾…å½“å‰æ‰€å¤„ç†çš„æ‰€æœ‰è¯·æ±‚ç»“æŸ
ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹æˆ‘ä»¬éœ€è¦ä½¿ç”¨ sync.WaitGroup æ¥ä¿è¯å¯¹å½“å‰æ‰“å¼€çš„è¿æ¥çš„è¿½è¸ªï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯ï¼šæ¯å½“æ¥æ”¶ä¸€ä¸ªæ–°çš„è¯·æ±‚æ—¶ï¼Œç»™wait groupåšåŸå­æ€§åŠ æ³•ï¼Œå½“è¯·æ±‚ç»“æŸæ—¶ç»™wait groupåšåŸå­æ€§å‡æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´wait groupå­˜å‚¨äº†å½“å‰æ­£åœ¨å¤„ç†çš„è¯·æ±‚çš„æ•°é‡</p>

<p>var httpWg sync.WaitGroup
åŒ†åŒ†ä¸€ç¥ï¼Œæˆ‘å‘ç°goä¸­çš„httpæ ‡å‡†åº“å¹¶æ²¡æœ‰ä¸ºAccept()å’ŒClose()æä¾›é’©å­å‡½æ•°ï¼Œä½†è¿™å°±åˆ°äº† interface å±•ç°å…¶é­”åŠ›çš„æ—¶å€™äº†(éå¸¸æ„Ÿè°¢ Jeff R. Allen çš„è¿™ç¯‡ æ–‡ç«  )</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œè¯¥ä¾‹å­å®ç°äº†æ¯å½“æ‰§è¡ŒAccept()çš„æ—¶å€™ä¼šåŸå­æ€§å¢åŠ wait groupã€‚é¦–å…ˆæˆ‘ä»¬å…ˆç»§æ‰¿ net.Listener å®ç°ä¸€ä¸ªç»“æ„ä½“</p>

<p>type gracefulListener struct {
    net.Listener
    stop    chan error
    stopped bool
}</p>

<p>func (gl <em>gracefulListener) File() *os.File {
    tl := gl.Listener.(</em>net.TCPListener)
    fl, _ := tl.File()
    return fl
}
æ¥ä¸‹æ¥æˆ‘ä»¬è¦†ç›–Acceptæ–¹æ³•(æš‚æ—¶å…ˆå¿½ç•¥ gracefulConn )</p>

<p>func (gl *gracefulListener) Accept() (c net.Conn, err error) {
    c, err = gl.Listener.Accept()
    if err != nil {
        return
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c = gracefulConn{Conn: c}

httpWg.Add(1)
return } æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ„é€ å‡½æ•°ä»¥åŠä¸€ä¸ªCloseæ–¹æ³•ï¼Œæ„é€ å‡½æ•°ä¸­å¦èµ·ä¸€ä¸ªgoroutineå…³é—­ï¼Œä¸ºä»€ä¹ˆè¦å¦èµ·ä¸€ä¸ªgoroutineå…³é—­ï¼Œè¯·çœ‹ refer^{[1]}
</code></pre></div></div>

<p>func newGracefulListener(l net.Listener) (gl *gracefulListener) {
    gl = &amp;gracefulListener{Listener: l, stop: make(chan error)}
    // è¿™é‡Œä¸ºä»€ä¹ˆä½¿ç”¨go å¦èµ·ä¸€ä¸ªgoroutineå…³é—­è¯·çœ‹æ–‡ç« æœ«å°¾
    go func() {
        _ = &lt;-gl.stop
        gl.stopped = true
        gl.stop &lt;- gl.Listener.Close()
    }()
    return
}</p>

<p>func (gl *gracefulListener) Close() error {
    if gl.stopped {
        return syscall.EINVAL
    }
    gl.stop &lt;- nil
    return &lt;-gl.stop
}
æˆ‘ä»¬çš„ Close æ–¹æ³•ç®€å•çš„å‘stop chanä¸­å‘é€äº†ä¸€ä¸ªnilï¼Œè®©æ„é€ å‡½æ•°ä¸­çš„goroutineè§£é™¤é˜»å¡çŠ¶æ€å¹¶æ‰§è¡ŒCloseæ“ä½œã€‚æœ€ç»ˆï¼Œgoroutineæ‰§è¡Œçš„å‡½æ•°é‡Šæ”¾äº† net.TCPListener æ–‡ä»¶æè¿°ç¬¦ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ª net.Conn çš„å˜ç§æ¥åŸå­æ€§çš„å¯¹wait groupåšå‡æ³•</p>

<p>type gracefulConn struct {
    net.Conn
}</p>

<p>func (w gracefulConn) Close() error {
    httpWg.Done()
    return w.Conn.Close()
}
ä¸ºäº†è®©æˆ‘ä»¬ä¸Šé¢æ‰€å†™çš„ä¼˜é›…å¯åŠ¨æ–¹æ¡ˆç”Ÿæ•ˆï¼Œæˆ‘ä»¬éœ€è¦æ›¿æ¢ server.Serve(l) è¡Œä¸º:</p>

<p>netListener = newGracefulListener(l)
server.Serve(netListener)
æœ€åè¡¥å……ï¼šæˆ‘ä»¬è¿˜éœ€è¦é¿å…å®¢æˆ·ç«¯é•¿æ—¶é—´ä¸å…³é—­è¿æ¥çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ›å»ºserverçš„æ—¶å€™å¯ä»¥æŒ‡å®šè¶…æ—¶æ—¶é—´ï¼š</p>

<p>server := &amp;http.Server{
        Addr:           â€œ0.0.0.0:8888â€,
        ReadTimeout:    10 * time.Second,
        WriteTimeout:   10 * time.Second,
        MaxHeaderBytes: 1 Â«Â 16}</p>
:ET