I"·<p>https://github.com/sony/gobreaker
<!-- more -->
çœ‹äº†ä¸€ä¸‹go-kitï¼Œå‘ç°è¿™ä¸ªå¾®æœåŠ¡æ¡†æ¶çš„ç†”æ–­å™¨ï¼Œä¹Ÿæ˜¯ä½¿ç”¨sonyå¼€æºçš„ä½œä¸ºåŸºç¡€ã€‚ sonyå¼€æºåœ¨ github çš„ç†”æ–­å™¨ åœ¨æºä»£å¤´æ³¨é‡Šä¸­å‘ç°ï¼ŒåŸæ¥sonyå®ç°çš„æ˜¯å¾®è½¯2015æ—¶å…¬å¸ƒçš„CircuitBreakeræ ‡å‡†ï¼Œæœç„¶å¾®è½¯æ‰å¼€æºç•Œçš„å¤§ç¥ã€‚</p>

<p>1ï¼‰å¾®è½¯å®šä¹‰çš„ Circuit breaker
å¾®è½¯çš„åŸæ–‡ä»¶åœ¨æ­¤ï¼šhttps://msdn.microsoft.com/en-us/library/dn589784.aspx åä¸çŸ¥é“æ€ä¹ˆæ­£ç¡®ç¿»è¯‘ï¼Œç›´è§‚ç¿»è¯‘ï¼Œå¯èƒ½å«ï¼šç¯å½¢ç†”æ–­å™¨ï¼ˆæˆ–å«ï¼šå¾ªç¯çŠ¶æ€è‡ªåŠ¨åˆ‡æ¢ä¸­æ–­å™¨ï¼‰ã€‚ å› ä¸ºå®ƒæ˜¯åœ¨ä¸‹é¢3ä¸ªçŠ¶æ€å¾ªç¯åˆ‡æ¢ ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     Closed 
     /    \  Half-Open &lt;--&gt; Open
</code></pre></div></div>

<p>åˆå§‹çŠ¶æ€æ˜¯ï¼šClosedï¼ŒæŒ‡ç†”æ–­å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ã€‚
è¾¾åˆ°ä¸€å®šæ•°é‡çš„é”™è¯¯è®¡æ•°ï¼Œè¿›å…¥Open çŠ¶æ€ï¼ŒæŒ‡ç†”æ–­å‘ç”Ÿï¼Œä¸‹æ¸¸å‡ºç°é”™è¯¯ï¼Œä¸èƒ½å†æ”¾è¡Œè¯·æ±‚ã€‚
ç»è¿‡ä¸€æ®µIntervalæ—¶é—´åï¼Œè‡ªåŠ¨è¿›å…¥Half-OpençŠ¶æ€ï¼Œç„¶åå¼€å§‹å°è¯•å¯¹æˆåŠŸè¯·æ±‚è®¡æ•°ã€‚
è¿›å…¥Half-Openåï¼Œæ ¹æ®æˆåŠŸ/å¤±è´¥è®¡æ•°æƒ…å†µï¼Œä¼šè‡ªåŠ¨è¿›å…¥Closedæˆ–Openã€‚</p>

<p>2ï¼‰sonyå¼€æºçš„goå®ç°
// ä»å®šä¹‰çš„é”™è¯¯æ¥çœ‹ï¼Œsonyçš„åº”è¯¥å¢åŠ äº†å¯¹è¿æ¥æ•°è¿›è¡Œäº†é™åˆ¶ ã€‚
 var (
	// ErrTooManyRequests is returned when the CB state is half open and the requests count is over the cb maxRequests
	ErrTooManyRequests = errors.New(â€œtoo many requestsâ€)
	// ErrOpenState is returned when the CB state is open
	ErrOpenState = errors.New(â€œcircuit breaker is openâ€)
)
2.1ï¼‰ é€šè¿‡Settingsçš„å®ç°ï¼Œäº†è§£å¯é…ç½®åŠŸèƒ½ï¼š
type Settings struct {
	Name          string
	MaxRequests   uint32        // åŠå¼€çŠ¶æ€æœŸæœ€å¤§å…è®¸æ”¾è¡Œè¯·æ±‚ï¼šå³è¿›å…¥Half-OpençŠ¶æ€æ—¶ï¼Œä¸€ä¸ªæ—¶é—´å‘¨æœŸå†…å…è®¸æœ€å¤§åŒæ—¶è¯·æ±‚æ•°ï¼ˆå¦‚æœè¿˜è¾¾ä¸åˆ°åˆ‡å›closedçŠ¶æ€æ¡ä»¶ï¼Œåˆ™ä¸èƒ½å†æ”¾è¡Œè¯·æ±‚ï¼‰ã€‚
	Interval      time.Duration // closedçŠ¶æ€æ—¶ï¼Œé‡ç½®è®¡æ•°çš„æ—¶é—´å‘¨æœŸï¼›å¦‚æœé…ä¸º0ï¼Œåˆ‡å…¥Openåæ°¸ä¸åˆ‡å›Closedâ€“æœ‰ç‚¹æš´åŠ›ã€‚
	Timeout       time.Duration // è¿›å…¥OpençŠ¶æ€åï¼Œå¤šé•¿æ—¶é—´ä¼šè‡ªåŠ¨åˆ‡æˆ Half-openï¼Œé»˜è®¤60sï¼Œä¸èƒ½é…ä¸º0ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ReadyToTripå›è°ƒå‡½æ•°ï¼šè¿›å…¥OpençŠ¶æ€çš„æ¡ä»¶ï¼Œæ¯”å¦‚é»˜è®¤æ˜¯è¿æ¥5æ¬¡å‡ºé”™ï¼Œå³è¿›å…¥OpençŠ¶æ€ï¼Œå³å¯å¯¹ç†”æ–­æ¡ä»¶è¿›è¡Œé…ç½®ã€‚åœ¨failè®¡æ•°å‘ç”Ÿåï¼Œå›è°ƒä¸€æ¬¡ã€‚
ReadyToTrip   func(counts Counts) bool 

// çŠ¶æ€åˆ‡æ¢æ—¶çš„ç†”æ–­å™¨
OnStateChange func(name string, from State, to State) } 2.2ï¼‰æ ¸å¿ƒçš„*æ‰§è¡Œå‡½æ•°*å®ç° è¦æŠŠç†”æ–­å™¨ä½¿ç”¨åˆ°å·¥ç¨‹ä¸­ï¼Œåªéœ€è¦ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªgobreakerï¼Œå†ä½¿ç”¨è¿™ä¸ªExecuteåŒ…ä¸€ä¸‹åŸæ¥çš„è¯·æ±‚å‡½æ•°ã€‚
</code></pre></div></div>

<p>func (cb *CircuitBreaker) Execute(req func() (interface{}, error)) (interface{}, error) {
	generation, err := cb.beforeRequest() // 
	if err != nil {
		return nil, err
	}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>defer func() {
	e := recover()
	if e != nil {
		cb.afterRequest(generation, false)
		panic(e) // å¦‚æœä»£ç å‘ç”Ÿäº†panicï¼Œç»§ç»­panicç»™ä¸Šå±‚è°ƒç”¨è€…å»recoverã€‚
	}
}()

result, err := req()
cb.afterRequest(generation, err == nil)
return result, err } 2.2 å…³é”® func beforeRequest() å‡½æ•°åšäº†å‡ ä»¶äº‹ï¼š
</code></pre></div></div>

<p>å‡½æ•°çš„æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ¤æ–­æ˜¯å¦æ”¾è¡Œè¯·æ±‚ï¼Œè®¡æ•°æˆ–è¾¾åˆ°åˆ‡æ¢æ–°æ¡ä»¶åˆšåˆ‡æ¢ã€‚
åˆ¤æ–­æ˜¯å¦Closedï¼Œå¦‚æ˜¯ï¼Œæ”¾è¡Œæ‰€æœ‰è¯·æ±‚ã€‚
å¹¶ä¸”åˆ¤æ–­æ—¶é—´æ˜¯å¦è¾¾åˆ°Intervalå‘¨æœŸï¼Œä»è€Œæ¸…ç©ºè®¡æ•°ï¼Œè¿›å…¥æ–°å‘¨æœŸï¼Œè°ƒç”¨toNewGeneration()
å¦‚æœæ˜¯OpençŠ¶æ€ï¼Œè¿”å›ErrOpenStateï¼Œâ€”ä¸æ”¾è¡Œæ‰€æœ‰è¯·æ±‚ã€‚
åŒæ ·åˆ¤æ–­å‘¨æœŸæ—¶é—´ï¼Œåˆ°è¾¾åˆ™ åŒæ ·è°ƒç”¨ toNewGeneration(){æ¸…ç©ºè®¡æ•°}
å¦‚æœæ˜¯half-opençŠ¶æ€ï¼Œåˆ™åˆ¤æ–­æ˜¯å¦å·²æ”¾è¡ŒMaxRequestsä¸ªè¯·æ±‚ï¼Œå¦‚æœªè¾¾åˆ°åˆšæ”¾è¡Œï¼›å¦åˆ™è¿”å›:ErrTooManyRequestsã€‚
æ­¤å‡½æ•°ä¸€æ—¦æ”¾è¡Œè¯·æ±‚ï¼Œå°±ä¼šå¯¹è¯·æ±‚è®¡æ•°åŠ 1ï¼ˆconut.onRequest())ï¼Œè¯·æ±‚ååˆ°å¦ä¸€ä¸ªå…³é”®å‡½æ•° : afterRequest()ã€‚
2.3 å…³é”® func afterRequest()
å‡½æ•°æ ¸å¿ƒå†…å®¹å¾ˆç®€å•ï¼Œå°±å¯¹æˆåŠŸ/å¤±è´¥è¿›è¡Œè®¡æ•°ï¼Œè¾¾åˆ°æ¡ä»¶åˆ™åˆ‡æ¢çŠ¶æ€ã€‚
ä¸beforeRequestä¸€æ ·ï¼Œä¼šè°ƒç”¨å…¬å…±å‡½æ•° currentState(now)
currentState(now) å…ˆåˆ¤æ–­æ˜¯å¦è¿›å…¥ä¸€ä¸ªå…ˆçš„è®¡æ•°æ—¶é—´å‘¨æœŸ(Interval), æ˜¯åˆ™é‡ç½®è®¡æ•°ï¼Œæ”¹å˜ç†”æ–­å™¨çŠ¶æ€ï¼Œå¹¶è¿”å›æ–°ä¸€ä»£ã€‚
å¦‚æœrequestè€—æ—¶å¤§äºInterval, å‡ æœ¬æ¯æ¬¡éƒ½ä¼šè¿›å…¥æ–°çš„è®¡æ•°å‘¨æœŸï¼Œç†”æ–­å™¨å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº†ã€‚
ä»£ç çš„æ ¸å¿ƒå†…å®¹
ä½¿ç”¨äº†ä¸€ä¸ªgenerationçš„æ¦‚å¿µï¼Œæ¯ä¸€ä¸ªæ—¶é—´å‘¨æœŸ(Interval)çš„è®¡æ•°(count)çŠ¶æ€ç§°ä¸ºä¸€ä¸ªgenerationã€‚
åœ¨before/afterçš„ä¸¤ä¸ªå‡½æ•°ä¸­ï¼Œå®ç°äº†ä¸¤ä¸ªçŠ¶æ€è‡ªåŠ¨åˆ‡æ¢çš„æœºåˆ¶ï¼š
åœ¨åŒä¸€ä¸ªgeneration(å³æ—¶é—´ï¼‰å‘¨æœŸå†…ï¼Œè®¡æ•°æ»¡è¶³çŠ¶æ€åˆ‡æ¢æ¡ä»¶ï¼Œå³è‡ªåŠ¨åˆ‡æ¢ï¼›
è¶…è¿‡ä¸€ä¸ªgenerationæ—¶é—´å‘¨æœŸçš„ä¹Ÿä¼šè‡ªåŠ¨åˆ‡æ¢ï¼›
æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨ï¼Œåªåœ¨è¯·æ±‚è°ƒç”¨æ—¶ï¼Œå»æ£€æµ‹å½“æ—¶çŠ¶æ€ä¸æ—¶é—´é—´éš”ã€‚</p>
:ET