I"ó<p>1.2.1ã€é‚»æ¥è¡¨
â€ƒâ€ƒä¸šç•Œæœ€å¸¸ä½¿ç”¨çš„æ–¹æ¡ˆææ€•å°±æ˜¯â€œé‚»æ¥è¡¨â€äº†ï¼Œç®€è€Œè¨€ä¹‹ï¼Œâ€œé‚»æ¥è¡¨â€çš„æ¯æ¡æ•°æ®éƒ½å­˜å‚¨äº†â€œä¸Šçº§æ•°æ®IDâ€ã€‚
æˆ‘ä»¬ä½¿ç”¨çš„Redisæ•°æ®ç»“æ„æ˜¯ Hashï¼ŒRedisçš„keyä¸ºä¼ä¸šIDï¼ˆdepttree:ä¼ä¸šIDï¼‰ï¼Œfield ä¸º éƒ¨é—¨IDï¼Œfield å¯¹åº”çš„valueæ˜¯ è¯¥éƒ¨é—¨IDå¯¹åº”çš„ä¸Šçº§éƒ¨é—¨IDã€‚</p>

<p>ä¸šåŠ¡é€»è¾‘ï¼š</p>

<p>æŸ¥è¯¢æ‰€æœ‰çˆ¶éƒ¨é—¨æ—¶ï¼Œå…ˆä»ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œç¼“å­˜ç¼ºå¤±æ—¶ä»DBæŸ¥è¯¢å¹¶æ›´æ–°åˆ°Redisï¼›
éƒ¨é—¨å…³ç³»å˜æ›´æ—¶ï¼Œåˆ™åˆ é™¤Redisç¼“å­˜ï¼›
éƒ¨é—¨åˆ é™¤æ—¶ï¼Œåˆ™åˆ é™¤Redisç¼“å­˜ï¼›
Redisä¸­çš„æ•°æ®å­˜å‚¨é‡‡ç”¨çš„æ˜¯â€œé‚»æ¥è¡¨â€çš„æ–¹å¼ï¼›</p>

<p>æ›´æ–°Redisæ—¶é‡‡ç”¨æ‰¹é‡æ›´æ–°æå‡æ€§èƒ½ï¼ŒHMSET key field value [field value â€¦]ï¼›</p>

<p>HMSET depttree:ä¼ä¸š001 B1 A0 B2 A0 B3 A0 CB1-1 B1</p>

<p>ä»hashçš„ç»“æ„çœ‹ï¼Œæ— æ³•ä¸€æ¬¡æ€§æŸ¥è¯¢æŒ‡å®šéƒ¨é—¨çš„æ‰€æœ‰ä¸Šçº§éƒ¨é—¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ° Lua è„šæœ¬ã€‚
<!-- more --></p>

<p>local rediskey = KEYS[1];
local currentDeptNo = KEYS[2];
local utilDeptNo = KEYS[3];
local maxGetTimes = tonumber(KEYS[4]);</p>

<p>if(currentDeptNo == utilDeptNo) then
  return currentDeptNo;
 end</p>

<p>if(maxGetTimes &gt; 100) then
  maxGetTimes = 100;
 end</p>

<p>local time = 1;</p>

<p>local result = currentDeptNo;
 local tempDept = currentDeptNo;</p>

<p>while(tempDept ~= utilDeptNo)
 do
  if(time &gt; maxGetTimes) then
   return â€œerror: the times of query exceeded the maxGetTimes!â€;
  end</p>

<p>tempDept = redis.call(â€˜hgetâ€™,rediskey , tempDept);
  â€“ redis.debug(â€œtempDept: %qâ€,tempDept);</p>

<p>if(tempDept == false or tempDept == â€œNULLâ€) then
   return result;
  end</p>

<p>result = result .. â€œ,â€ .. tempDept;
  time = time + 1 ;
 end</p>

<p>return result;</p>

<p>Redis Cluster æ“ä½œå¤škeyæ—¶ï¼Œè¦æ±‚å‘½ä»¤ä¸­çš„æ‰€æœ‰keyéƒ½å±äºä¸€ä¸ªslotï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸â€œCROSSSLOT Keys in request donâ€™t hash to the same slotâ€ã€‚</p>

<p>é€šè¿‡æŸ¥çœ‹jedisçš„ getSlot æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¦‚æœ key åŒ…å« {}ï¼Œåˆ™ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ª {} ä¸­çš„å­—ç¬¦ä¸²ä½œä¸º hash keyï¼Œæ‰€ä»¥é›†ç¾¤æ¨¡å¼ä¸‹æˆ‘ä»¬å¯ä»¥å°† Redis key çš„ç›¸åŒå†…å®¹ ä½¿ç”¨ {} åŒ…è£…èµ·æ¥ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ{} æ¨¡å¼ è™½ç„¶èƒ½å°† ä¸åŒçš„ key  hash åˆ°ç›¸åŒ soltï¼Œä½†æ•°æ®é‡è¿‡å¤§æ—¶ï¼Œææ˜“é€ æˆ æ•°æ®å€¾æ–œï¼Œä»è€Œå½±å“ç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚æ‰€ä»¥ä½¿ç”¨å‰è¯·å……åˆ†åˆ†æè¯„ä¼°æ•°æ®ï¼ŒæŒ‰éœ€çµæ´»å¤„ç†ã€‚</p>

<p>https://mp.weixin.qq.com/s/LPEmQYF0j6t1B3U1JxF3Lw
https://mp.weixin.qq.com/s/PJexnM9OHryF2z2WDX09Sg</p>

<p>è§£å†³
å› ä¸ºRedisè¦æ±‚å•ä¸ªLuaè„šæœ¬æ“ä½œçš„keyå¿…é¡»åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯Clusterä¼šå°†æ•°æ®è‡ªåŠ¨åˆ†å¸ƒåˆ°ä¸åŒçš„èŠ‚ç‚¹(è™šæ‹Ÿçš„16384ä¸ªslotï¼Œå…·ä½“çœ‹å®˜æ–¹æ–‡æ¡£)ã€‚</p>

<p>Redis clusterå¯¹å¤škeyæ“ä½œæœ‰é™åˆ¶ï¼Œè¦æ±‚å‘½ä»¤ä¸­æ‰€æœ‰çš„keyéƒ½å±äºä¸€ä¸ªslotï¼Œæ‰å¯ä»¥è¢«æ‰§è¡Œã€‚</p>

<blockquote>
  <p>CLUSTER KEYSLOT somekey
11058
CLUSTER KEYSLOT foo{hash_tag}
(integer) 2515
CLUSTER KEYSLOT bar{hash_tag}
(integer) 2515
keySlotç®—æ³•ä¸­ï¼Œå¦‚æœkeyåŒ…å«{}ï¼Œå°±ä¼šä½¿ç”¨ç¬¬ä¸€ä¸ª{}å†…éƒ¨çš„å­—ç¬¦ä¸²ä½œä¸ºhash keyï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ‹¥æœ‰åŒæ ·{}å†…éƒ¨å­—ç¬¦ä¸²çš„keyå°±ä¼šæ‹¥æœ‰ç›¸åŒslotã€‚</p>
</blockquote>

<p>https://blog.csdn.net/xixingzhe2/article/details/86167859</p>

<p>https://github.com/zxiaofan/OpenSource_Study/blob/master/redis_scripts/lua_getAllSupDept.lua</p>
:ET