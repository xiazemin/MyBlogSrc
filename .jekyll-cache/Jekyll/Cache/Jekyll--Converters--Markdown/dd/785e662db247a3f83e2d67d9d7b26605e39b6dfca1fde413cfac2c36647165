I"ˆ<p>https://github.com/tj/co
JSå‡½æ•°ç”Ÿæˆå™¨ï¼Œfunction* () {}</p>

<p>#1ï¼Œæš‚åœã€ç»§ç»­
function* fn() {
    console.log(1);
    //æš‚åœï¼
    yield;
    //è°ƒç”¨nextæ–¹æ³•ç»§ç»­æ‰§è¡Œ
    console.log(2);
}
var iter = fn();
iter.next(); //1
iter.next(); //2</p>

<p>1ã€å‡½æ•°ç”Ÿæˆå™¨ç‰¹ç‚¹æ˜¯å‡½æ•°åå‰é¢æœ‰ä¸€ä¸ªâ€˜*â€™
2ã€é€šè¿‡è°ƒç”¨å‡½æ•°ç”Ÿæˆä¸€ä¸ªæ§åˆ¶å™¨
3ã€è°ƒç”¨next()æ–¹æ³•å¼€å§‹æ‰§è¡Œå‡½æ•°
4ã€é‡åˆ°yieldå‡½æ•°å°†æš‚åœ
5ã€å†æ¬¡è°ƒç”¨next()ç»§ç»­æ‰§è¡Œå‡½æ•°</p>

<p>#2ï¼Œæ¶ˆæ¯ä¼ é€’
ã€€ã€€é™¤äº†æš‚åœå’Œç»§ç»­æ‰§è¡Œå¤–ï¼Œç”Ÿæˆå™¨åŒæ—¶æ”¯æŒä¼ å€¼ã€‚
    function* fn() {
        var a = yield â€˜helloâ€™;
        yield;
        console.log(a);
    }
var iter = fn();
var res = iter.next();
console.log(res.value); //hello
iter.next(2);
iter.next(); //2
å¯ä»¥çœ‹åˆ°ï¼Œyieldåé¢æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨nextæ—¶ï¼Œæš‚åœåœ¨è¿™é‡Œä¸”è¿”å›ç»™äº†iter.next()ã€‚</p>

<p>ã€€ã€€è€Œæš‚åœçš„åœ°æ–¹æ˜¯ä¸€ä¸ªèµ‹å€¼è¯­å¥ï¼Œéœ€è¦ä¸€ä¸ªå˜é‡ç»™aï¼Œäºæ˜¯next()æ–¹æ³•ä¸­ä¼ äº†ä¸€ä¸ªå‚æ•°2æ›¿æ¢äº†yieldï¼Œæœ€åæ‰“å°aå¾—åˆ°äº†2ã€‚
ã€€ã€€
#3ï¼Œå¼‚æ­¥åº”ç”¨ ã€€ã€€
ã€€ã€€é€šè¿‡yieldæ¥å®ç°å¼‚æ­¥æ§åˆ¶æµç¨‹ï¼š
    function fn(a, b) {
        //å‡è®¾è¿™æ˜¯ä¸€ä¸ªajaxè¯·æ±‚
        ajax(â€˜urlâ€™ + a + b, function(data) {
            //æ•°æ®è¯·æ±‚åˆ°ä¼šæ‰§è¡Œit.next
            it.next(data);
        });
    }
    //è¿™é‡Œæ˜¯å‡½æ•°ç”Ÿæˆå™¨
    function* g() {
        //å½“å¼‚æ­¥æ“ä½œå®Œæ¯•yieldä¼šå¾—åˆ°å€¼
        //è¿™é‡Œä¼šè‡ªåŠ¨ç»§ç»­æ‰§è¡Œ
        var text = yield fn(a, b);
        console.log(text);
    }
    var it = g();
    it.next();</p>

<p>ç¡®å®å¾ˆå·§å¦™ï¼Œé€šè¿‡å›è°ƒå‡½æ•°æ¥ç»§ç»­æ‰§è¡Œå‡½æ•°ç”Ÿæˆå™¨ï¼Œç„¶åå¾—åˆ°æ•°æ®ã€‚</p>

<p>ã€€ã€€ç„¶è€Œï¼Œç›´æ¥åœ¨å›è°ƒé‡Œæ‹¿æ•°æ®ä¸è¡Œä¹ˆã€‚ä¹¦ä¸Šè®²ï¼Œè¿™æ ·å¼‚æ­¥æ“ä½œç¬¦åˆå¤§è„‘æ€è€ƒæ¨¡å¼ï¼Œå‡½æ•°çš„æ‰§è¡Œçœ‹èµ·æ¥â€˜åŒæ­¥â€™äº†ã€‚
<!-- more -->
yield+promise</p>

<p>promiseå¯¹å¼‚æ­¥çš„å®ç°ï¼š 
function request(url) {
        return new Promise(function(resolve, reject) {
            //ajaxå¼‚æ­¥è¯·æ±‚å®Œæˆä¼šè°ƒç”¨resolveå†³è®®
            ajax(url, resolve);
        });
    }
    request(â€˜urlâ€™).then(function(res) {
        console.log(res);
    })</p>

<p>æµç¨‹å¤§æ¦‚æ˜¯è°ƒç”¨å‡½æ•°ä¼ å…¥urlï¼Œç”±äºä¼šç«‹å³å†³è®®ï¼Œè§¦å‘ajaxè¯·æ±‚å‡½æ•°ã€‚å¼‚æ­¥è¯·æ±‚å®Œè°ƒç”¨è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯resolveï¼Œç„¶åæ ¹æ®è¿”å›çš„resolveè°ƒç”¨thenæ–¹æ³•è·å–æ•°æ®ã€‚</p>

<p>ç°åœ¨å°†yieldä¸promiseç»¼åˆåœ¨ä¸€èµ·ï¼š
 function foo(x) {
        return request(â€˜urlâ€™ + x);
    }
    //ç­‰å¾…promiseå†³è®®å€¼è¿”å›
    function* fn() {
        var text = yield foo(1);
    }
    var it = fn();
    //è¿”å›ä¸€ä¸ªpromise
    var p = it.next().value;
    //å¯¹promiseå¤„ç†
    p.then(function(text) {
        //è¿™é‡Œç»§ç»­æ‰§è¡Œç”Ÿæˆå™¨
        it.next(text);
    })</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.cnblogs.com/yuzhengbo/p/6807914.html

https://developer.mozilla.org/zh-tw/docs/web/javascript/reference/statements/function*


co å‡½æ•°åº“æ˜¯è‘—åç¨‹åºå‘˜ TJ Holowaychuk äº2013å¹´6æœˆå‘å¸ƒçš„ä¸€ä¸ªå°å·¥å…·ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚
fs.readfile("a.txt","utf-8",function(err,result){
 if(result)
 {
      fs.readfile("b.txt","utf-8",function(err,result){
           if(result){
               fs.readfile("c.txt","utf-8",function(err,result){
                   //......
               });
           }
      });
 }
 if(err){

 }  })
</code></pre></div></div>

<p>è§£é‡Š:åŸºäºäº‹ä»¶é©±åŠ¨çš„ç‰¹æ€§ï¼Œå›è°ƒå‡½æ•°å¯¹äºå‰ç«¯å¼€å‘æ¥è¯´éå¸¸å¸¸è§ï¼Œä½†æ˜¯åœ¨æœåŠ¡ç«¯å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨æ•°æ®ä¾èµ–çš„æƒ…å†µï¼Œæ¯”å¦‚ä¸Šé¢ä»£ç çš„æƒ…å†µï¼Œc=&gt;b=&gt;a(å®é™…ä¸Šæœ‰å¯èƒ½æœ‰æ›´å¤šä¾èµ–ï¼Œè¿™ä¸ªä¾‹å­åªæ˜¯ä¸ºäº†è¯´æ˜callback-hell),ä»£ç åµŒå¥—å±‚æ•°è¿‡å¤šå¯¹äºåæœŸç»´æŠ¤æ¥è¯´éå¸¸å¤´ç–¼</p>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œäººä»¬æƒ³åˆ°äº†å¾ˆå¤šåŠæ³•ï¼Œå†æ­¤åˆ—ä¸¾å‡ ä¸ªæ¯”è¾ƒå¸¸è§çš„ï¼Œasync.waterfall()ã€promise,generator</p>

<p>async:</p>

<p>ä¼˜ç‚¹ï¼šè§£å†³äº†å›è°ƒåµŒå¥—çš„é—®é¢˜ä»¥åŠç®€å•çš„æµç¨‹æ§åˆ¶
ç¼ºç‚¹ï¼šä¾ç„¶ä¸æ˜¯åŒæ­¥çš„æ€ç»´</p>

<p>promise:
ä¼˜ç‚¹ï¼šè§£å†³äº†å›è°ƒåµŒå¥—çš„é—®é¢˜
ç¼ºç‚¹ï¼šä½†æ˜¯æ²¡æœ‰è§£å†³æµç¨‹æ§åˆ¶é—®é¢˜(promiseçŠ¶æ€ä¸€æ—¦rejectæˆ–è€…resolveå°±ä¸å¯ä»¥å†æ¬¡å˜åŒ–)ï¼Œä¹Ÿä¸æ˜¯åŒæ­¥çš„æ€ç»´</p>

<p>generator:
ä¼˜ç‚¹ï¼šè§£å†³äº†æµç¨‹æ§åˆ¶é—®é¢˜
ç¼ºç‚¹ï¼šå•ç‹¬ä½¿ç”¨æ•ˆæœä¸ä½³</p>

<p>coç®€ä»‹ï¼šcoæ•´åˆäº†promiseä¸generator,ä½¿ä»£ç ä¹¦å†™èµ·æ¥éå¸¸å‹å¥½</p>

<p>äºŒã€ä¸ºä»€ä¹ˆç”¨co?
å…ˆçœ‹ä¸€ä¸ªå®ä¾‹</p>

<p>coå®ä¾‹ï¼š</p>

<p>co(function *(){
  // yield any promise
  var result = yield toPromise(fs.readFile)(â€œa.txtâ€,â€™utf-8â€™);
  if(result)
  {
     var result2=yield toPromise(fs.readFile)(â€œb.txtâ€,â€™utf-8â€™)
     if(result2)
     {
         var result3=yield toPromise(fs.readFile)(â€œb.txtâ€,â€™utf-8â€™)
     }
  }
}).catch(onerror);
function onerror(err) {
  console.error(err.stack);
}
è·Ÿç”¨javaæˆ–è€…phpä¹¦å†™æ–¹å¼åŸºæœ¬æ²¡æœ‰ä»€ä¹ˆä¸åŒäº†ï¼Œä½†æ˜¯ä»£ç å´æ˜¯å¼‚æ­¥æ‰§è¡Œçš„å“¦ã€‚æ‰€ä»¥å¾ˆå¤šäººéƒ½è¯´ç”¨äº†coå°±å†ä¹Ÿä¸æƒ³å›å»äº†</p>

<p>ä¸‰ã€ co å‡½æ•°åº“çš„åŸç†
function co(gen) {
  var ctx = this;
  var args = slice.call(arguments, 1)</p>

<p>// we wrap everything in a promise to avoid promise chaining,
  // which leads to memory leak errors.
  // see https://github.com/tj/co/issues/180
  return new Promise(function(resolve, reject) {
    if (typeof gen === â€˜functionâ€™) gen = gen.apply(ctx, args);
    if (!gen || typeof gen.next !== â€˜functionâ€™) return resolve(gen);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>onFulfilled();

/**
 * @param {Mixed} res
 * @return {Promise}
 * @api private
 */

function onFulfilled(res) {
  var ret;
  try {
    ret = gen.next(res);
  } catch (e) {
    return reject(e);
  }
  next(ret);
}

/**
 * @param {Error} err
 * @return {Promise}
 * @api private
 */

function onRejected(err) {
  var ret;
  try {
    ret = gen.throw(err);
  } catch (e) {
    return reject(e);
  }
  next(ret);
}

/**
 * Get the next value in the generator,
 * return a promise.
 *
 * @param {Object} ret
 * @return {Promise}
 * @api private
 */

function next(ret) {
  if (ret.done) return resolve(ret.value);
  var value = toPromise.call(ctx, ret.value);
  if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);
  return onRejected(new TypeError('You may only yield a function, promise, generator, array, or object, '
    + 'but the following object was passed: "' + String(ret.value) + '"'));
}   }); } coçš„åŸç†éå¸¸ç®€å•ï¼Œåœ¨å¯¹generatoræ¯”è¾ƒç†Ÿæ‚‰çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨é€’å½’çš„æ–¹æ³•å®Œæˆä¸€æ­¥æ­¥è°ƒç”¨ã€‚
</code></pre></div></div>

<p>value.then(onFulfilled, onRejected)ï¼Œè‡ªåŠ¨æ³¨å†Œpromiseçš„resolve,rejectæ–¹æ³•ï¼Œåœ¨çŠ¶æ€å‘ç”Ÿæ”¹å˜æˆä¸ºresolveæ—¶è‡ªåŠ¨è°ƒç”¨onFulfilled,æ‰§è¡Œä¸‹ä¸€ä¸ªyield(å½“ç„¶è¿˜æœ‰è¿”å›ä¸Šä¸€æ¬¡çš„å¤„ç†ç»“æœ),rejectæ—¶è‡ªåŠ¨è°ƒç”¨onRejectedï¼ŒæŠ›å‡ºé”™è¯¯ã€‚</p>

<p>https://zhuanlan.zhihu.com/p/24831979</p>
:ET