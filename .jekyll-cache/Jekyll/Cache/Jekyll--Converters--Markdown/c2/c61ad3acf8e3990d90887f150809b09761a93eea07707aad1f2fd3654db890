I"Î<p>https://github.com/yedf/handy/tree/master/handy
æœåŠ¡å™¨ç¼–ç¨‹ä¸­ï¼Œä¸€ä¸ªä¼˜ç§€çš„æ—¥å¿—ç³»ç»Ÿéœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶</p>

<p>é«˜æ•ˆï¼Œæ—¥å¿—ç³»ç»Ÿä¸åº”å ç”¨å¤ªå¤šèµ„æº
ç®€æ´ï¼Œå¼•å…¥ä¸€ä¸ªç±»ä¼¼log4cppè¿™ä¹ˆåºå¤§çš„åº“ï¼Œä¸æ˜¯ä¸€ä¸ªä»¤äººæ„‰å¿«çš„åšæ³•
çº¿ç¨‹å®‰å…¨ï¼ŒæœåŠ¡å™¨ä¸­å„ä¸ªçº¿ç¨‹éƒ½èƒ½åŒæ—¶å†™å‡ºæ—¥å¿—
è½®æ›¿ï¼ŒæœåŠ¡å™¨ä¸å‡ºæ•…éšœæ˜¯ä¸é‡å¯çš„ï¼ŒåŠå¹´ä¸€å¹´çš„æ—¥å¿—æ”¾åˆ°ä¸€ä¸ªæ–‡ä»¶ä¼šå¯¼è‡´æ–‡ä»¶è¿‡å¤§
åŠæ—¶ä¿å­˜ï¼Œç¨‹åºæ•…éšœå¯¼è‡´å¼‚å¸¸é€€å‡ºï¼Œæ­¤æ—¶éœ€è¦é€šè¿‡æ—¥å¿—è¯Šæ–­é—®é¢˜ï¼Œä¸ç¼“å†²çš„æ—¥å¿—ç³»ç»Ÿæ›´æ˜“ç”¨</p>

<p>è‘—åçš„æ—¥å¿—åº“æœ‰log4xxxç³»åˆ—ï¼Œæä¾›äº†éå¸¸çµæ´»çš„åŠŸèƒ½ï¼Œå½“ç„¶éšä¹‹è€Œæ¥çš„ä»£ä»·å°±æ˜¯åºå¤§çš„åº“ã€‚åœ¨å¤§å¤šæ•°æœåŠ¡å™¨åº”ç”¨ä¸­ï¼Œæ‰€éœ€çš„åŠŸèƒ½ä¸å¤šï¼Œæˆ‘åå‘äºé€‰æ‹©ä¸€ä¸ªæ”¯æŒæŒ‰æ—¶é—´è½®æ›¿çš„ç®€æ´çš„æ—¥å¿—åº“ã€‚</p>

<p>åœ¨å‰é¢åˆ—å‡ºçš„å„é¡¹ç‰¹ç‚¹ä¸­ï¼Œçº¿ç¨‹å®‰å…¨ä¸è½®æ›¿æ˜¯ä¸ªéš¾ç‚¹ã€‚å¼•å…¥é”åˆ™å¸¦æ¥å¤æ‚æ€§ä»¥åŠæ€§èƒ½é—®é¢˜ï¼Œèƒ½å¦è®¾è®¡å‡ºç®€æ´ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆå‘¢ï¼Ÿæœªå¼•å…¥è½®æ›¿æœºåˆ¶æ—¶ï¼Œæ—¥å¿—çš„è¾“å‡ºå¯ä»¥æŒ‰ä¸‹é¢æ­¥éª¤å®ç°ï¼š</p>

<p>ä½¿ç”¨O_APPENDæ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œè¿™ä¸ªæ ‡è®°è®©writeå†™å‡ºçš„å†…å®¹æ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾ï¼Œç§»åŠ¨æ–‡ä»¶æŒ‡é’ˆä¸è¾“å‡ºå†…å®¹æ˜¯åŸå­çš„ï¼Œç”±æ“ä½œç³»ç»Ÿæ¥ä¿è¯åŸå­æ€§ã€‚å› æ­¤è¿™ä¸ªæ ‡è®°ä¿è¯åœ¨å¤šçº¿ç¨‹/å¤šè¿›ç¨‹è°ƒç”¨writeä¹Ÿèƒ½å¤Ÿä¿æŒè¾“å‡ºçš„å†…å®¹ä¸ä¼šç›¸äº’è¦†ç›–é”™ä¹±ï¼Œnginxçš„æ—¥å¿—ä¹Ÿåˆ©ç”¨äº†è¿™ä¸ªæ ‡è®°æ¥è¾¾åˆ°å¤šè¿›ç¨‹ä¸å¹²æ‰°
æ¯ä¸€æ¬¡logï¼Œéƒ½ä¼šç”ŸæˆåŒ…æ‹¬äº†æ—¶é—´çš„æœ€ç»ˆè¾“å‡ºå­—ç¬¦ä¸²ï¼Œè°ƒç”¨writeï¼Œå†™å‡ºåˆ°æ—¥å¿—ç³»ç»Ÿçš„æ–‡ä»¶æè¿°ç¬¦fdã€‚å½“writeè¿”å›æ—¶ï¼Œæ—¥å¿—å·²ç»å†™åˆ°æ“ä½œç³»ç»Ÿï¼Œä¸ç®¡ç¨‹åºæ˜¯å¦å´©æºƒï¼Œåªè¦æ“ä½œç³»ç»Ÿä¸å´©æºƒï¼Œé‚£ä¹ˆè¾“å‡ºçš„å†…å®¹å°±ä¼šä¿å­˜åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ã€‚</p>

<p>è½®æ›¿çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å…³é—­å½“å‰æ–‡ä»¶å¹¶æ‰“å¼€æ–°æ–‡ä»¶ï¼Œè®©æ–°çš„å†…å®¹å†™åˆ°æ–°æ–‡ä»¶ä¸­ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±éœ€è¦é”æ¥åŒæ­¥æ‰€æœ‰çº¿ç¨‹çš„æ—¥å¿—è¾“å‡ºæ“ä½œï¼Œé¿å…å†™å…¥åˆ°ä¸åˆæ³•çš„æ–‡ä»¶æè¿°ç¬¦ä¸­ã€‚
<!-- more -->
è¿™é‡Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸ªä¸éœ€è¦ä½¿ç”¨é”çš„æ–°æŠ€å·§ï¼Œä½¿ç”¨posixé‡Œçš„dup2æ¥åšåˆ°æ— é”è½®æ›¿æ–‡ä»¶ã€‚ä¸‹é¢æ˜¯å®Œæ•´çš„æ­¥éª¤ä¸æè¿°ã€‚</p>

<p>//è½®æ›¿æ—¶ï¼Œé¦–å…ˆé‡å‘½åå·²æ‰“å¼€çš„æ—¥å¿—æ–‡ä»¶ï¼Œä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œ
rename(filename, newname);
//ç„¶ååˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
fd = open(filename,â€¦);
//ä½¿ç”¨dup2ç³»ç»Ÿå‡½æ•°æŠŠfdï¼ˆæ–°ï¼‰å¤åˆ¶åˆ°fd_ï¼ˆæ—§ï¼‰ä¸Š
dup2(fd, fd_);
//å…³é—­fdï¼ˆæ–°ï¼‰
close(fd);
å…¶ä¸­dup2æ˜¯åŸå­æ“ä½œï¼Œå®ƒä¼šå…³é—­fd_å¹¶ä¸”æŠŠfd_ä¹ŸæŒ‡å‘fdæ‰“å¼€çš„æ–‡ä»¶ã€‚å› æ­¤fd_è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦æ€»æ˜¯ä¿æŒæ‰“å¼€çŠ¶æ€ï¼Œå¹¶ä¸”å€¼ä¸å˜ï¼Œä½†æ˜¯å‰åæŒ‡å‘äº†ä¸åŒçš„æ–‡ä»¶ï¼Œå®Œå…¨ä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹è°ƒç”¨write(fd_, â€¦)ç­‰æ“ä½œã€‚å¦ä¸€è¾¹writeä¹Ÿæ˜¯ä¸ªåŸå­æ“ä½œï¼Œå®ƒä¸dup2ä¸ä¼šäº¤å‰è¿›è¡Œï¼Œå› æ­¤ä¿è¯äº†æ—¥å¿—ç³»ç»Ÿçš„æ­£ç¡®æ€§ã€‚</p>

<p>è¯¦æƒ…å‚è§å¼€æºåº“handyä¸­çš„logging.hå’Œhttp://logging.ccï¼Œé‡Œé¢ä¸€éƒ¨åˆ†ä»£ç é‡‡ç”¨äº†C++11çš„è¯­æ³•</p>

<p>https://github.com/yedf/handy/tree/master/handy</p>

<p>handyçš„æ—¥å¿—ç³»ç»Ÿä¸­ï¼Œæ—¥å¿—è¦åšçš„å†…å®¹å°±æ˜¯ä½¿ç”¨snprintfæ ¼å¼åŒ–è¦è¾“å‡ºçš„å†…å®¹ï¼Œç„¶åè°ƒç”¨writeï¼Œæ²¡æœ‰å¤šä½™çš„å·¥ä½œï¼Œå› æ­¤åšåˆ°äº†ç®€æ´é«˜æ•ˆ</p>

<p>PSï¼šå¯¹äºprintfé£æ ¼çš„æ—¥å¿—ç³»ç»Ÿï¼Œç¼–è¯‘å™¨çš„æ ¼å¼æ£€æŸ¥æœ‰éå¸¸å¤§çš„å¸®åŠ©ï¼Œèƒ½å¤Ÿåœ¨ç¼–è¯‘å™¨æ£€æŸ¥å‡ºæ ¼å¼é”™è¯¯ï¼Œè€Œä¸æ˜¯è¿è¡Œæ—¶å‡ºé”™ç„¶åå»è°ƒè¯•ã€‚è¿™é‡Œæœ‰ä¸ªé€šç”¨çš„è·¨å¹³å°çš„æŠ€å·§ï¼Œå°±æ˜¯å…ˆæŠŠå†…å®¹ç”¨snprintfæ‰“å°åˆ°ä¸€ä¸ªé•¿åº¦ä¸º0çš„bufferä¸­ï¼Œä¾‹å¦‚snprintf(0, 0, <strong>VA_ARGS</strong>);è¿™æ ·ï¼Œä¸€æ—¦æ ¼å¼å­—ç¬¦ä¸²ä¸åé¢çš„å‚æ•°ä¸åŒ¹é…ï¼Œç¼–è¯‘å™¨èƒ½å¤Ÿç«‹åˆ»æ£€æŸ¥å‡ºï¼Œå¹¶æç¤ºã€‚</p>

<p>golangæ—¥å¿—åº“
golangæ ‡å‡†åº“çš„æ—¥å¿—æ¡†æ¶éå¸¸ç®€å•ï¼Œä»…ä»…æä¾›äº†printï¼Œpanicå’Œfatalä¸‰ä¸ªå‡½æ•°å¯¹äºæ›´ç²¾ç»†çš„æ—¥å¿—çº§åˆ«ã€æ—¥å¿—æ–‡ä»¶åˆ†å‰²ä»¥åŠæ—¥å¿—åˆ†å‘ç­‰æ–¹é¢å¹¶æ²¡æœ‰æä¾›æ”¯æŒã€‚æ‰€ä»¥å‚¬ç”Ÿäº†å¾ˆå¤šç¬¬ä¸‰æ–¹çš„æ—¥å¿—åº“ï¼Œä½†æ˜¯åœ¨golangçš„ä¸–ç•Œé‡Œï¼Œæ²¡æœ‰ä¸€ä¸ªæ—¥å¿—åº“åƒslf4jé‚£æ ·åœ¨Javaä¸­å…·æœ‰ç»å¯¹ç»Ÿæ²»åœ°ä½ã€‚golangä¸­ï¼Œæµè¡Œçš„æ—¥å¿—æ¡†æ¶åŒ…æ‹¬logrusã€zapã€zerologã€seelogç­‰ã€‚
logrusæ˜¯ç›®å‰Githubä¸Šstaræ•°é‡æœ€å¤šçš„æ—¥å¿—åº“ï¼Œç›®å‰(2018.08ï¼Œä¸‹åŒ)staræ•°é‡ä¸º8119ï¼Œforkæ•°ä¸º1031ã€‚logrusåŠŸèƒ½å¼ºå¤§ï¼Œæ€§èƒ½é«˜æ•ˆï¼Œè€Œä¸”å…·æœ‰é«˜åº¦çµæ´»æ€§ï¼Œæä¾›äº†è‡ªå®šä¹‰æ’ä»¶çš„åŠŸèƒ½ã€‚å¾ˆå¤šå¼€æºé¡¹ç›®ï¼Œå¦‚dockerï¼Œprometheusç­‰ï¼Œéƒ½æ˜¯ç”¨äº†logrusæ¥è®°å½•å…¶æ—¥å¿—ã€‚
zapæ˜¯Uberæ¨å‡ºçš„ä¸€ä¸ªå¿«é€Ÿã€ç»“æ„åŒ–çš„åˆ†çº§æ—¥å¿—åº“ã€‚å…·æœ‰å¼ºå¤§çš„ad-hocåˆ†æåŠŸèƒ½ï¼Œå¹¶ä¸”å…·æœ‰çµæ´»çš„ä»ªè¡¨ç›˜ã€‚zapç›®å‰åœ¨GitHubä¸Šçš„staræ•°é‡çº¦ä¸º4.3kã€‚
seelogæä¾›äº†çµæ´»çš„å¼‚æ­¥è°ƒåº¦ã€æ ¼å¼åŒ–å’Œè¿‡æ»¤åŠŸèƒ½ã€‚ç›®å‰åœ¨GitHubä¸Šä¹Ÿæœ‰çº¦1.1kã€‚</p>

<p>logrusç‰¹æ€§
logruså…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>

<p>å®Œå…¨å…¼å®¹golangæ ‡å‡†åº“æ—¥å¿—æ¨¡å—ï¼šlogrusæ‹¥æœ‰å…­ç§æ—¥å¿—çº§åˆ«ï¼šdebugã€infoã€warnã€errorã€fatalå’Œpanicï¼Œè¿™æ˜¯golangæ ‡å‡†åº“æ—¥å¿—æ¨¡å—çš„APIçš„è¶…é›†ã€‚å¦‚æœæ‚¨çš„é¡¹ç›®ä½¿ç”¨æ ‡å‡†åº“æ—¥å¿—æ¨¡å—ï¼Œå®Œå…¨å¯ä»¥ä»¥æœ€ä½çš„ä»£ä»·è¿ç§»åˆ°logrusä¸Šã€‚
å¯æ‰©å±•çš„Hookæœºåˆ¶ï¼šå…è®¸ä½¿ç”¨è€…é€šè¿‡hookçš„æ–¹å¼å°†æ—¥å¿—åˆ†å‘åˆ°ä»»æ„åœ°æ–¹ï¼Œå¦‚æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿã€æ ‡å‡†è¾“å‡ºã€logstashã€elasticsearchæˆ–è€…mqç­‰ï¼Œæˆ–è€…é€šè¿‡hookå®šä¹‰æ—¥å¿—å†…å®¹å’Œæ ¼å¼ç­‰ã€‚
å¯é€‰çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼šlogruså†…ç½®äº†ä¸¤ç§æ—¥å¿—æ ¼å¼ï¼ŒJSONFormatterå’ŒTextFormatterï¼Œå¦‚æœè¿™ä¸¤ä¸ªæ ¼å¼ä¸æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥è‡ªå·±åŠ¨æ‰‹å®ç°æ¥å£Formatterï¼Œæ¥å®šä¹‰è‡ªå·±çš„æ—¥å¿—æ ¼å¼ã€‚
Fieldæœºåˆ¶ï¼šlogrusé¼“åŠ±é€šè¿‡Fieldæœºåˆ¶è¿›è¡Œç²¾ç»†åŒ–çš„ã€ç»“æ„åŒ–çš„æ—¥å¿—è®°å½•ï¼Œè€Œä¸æ˜¯é€šè¿‡å†—é•¿çš„æ¶ˆæ¯æ¥è®°å½•æ—¥å¿—ã€‚
logrusæ˜¯ä¸€ä¸ªå¯æ’æ‹”çš„ã€ç»“æ„åŒ–çš„æ—¥å¿—æ¡†æ¶ã€‚
logrusçš„ä½¿ç”¨
ç¬¬ä¸€ä¸ªç¤ºä¾‹
æœ€ç®€å•çš„ä½¿ç”¨logrusçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<p>package main</p>

<p>import (
  log â€œgithub.com/sirupsen/logrusâ€
)</p>

<p>func main() {
  log.WithFields(log.Fields{
    â€œanimalâ€: â€œwalrusâ€,
  }).Info(â€œA walrus appearsâ€)
}</p>

<p>ä¸Šé¢ä»£ç æ‰§è¡Œåï¼Œæ ‡å‡†è¾“å‡ºä¸Šè¾“å‡ºå¦‚ä¸‹ï¼š</p>

<p>time=â€2018-08-11T15:42:22+08:00â€ level=info msg=â€A walrus appearsâ€ animal=walrus
1
logrusä¸golangæ ‡å‡†åº“æ—¥å¿—æ¨¡å—å®Œå…¨å…¼å®¹ï¼Œå› æ­¤æ‚¨å¯ä»¥ä½¿ç”¨logâ€œgithub.com/sirupsen/logrusâ€æ›¿æ¢æ‰€æœ‰æ—¥å¿—å¯¼å…¥ã€‚
logruså¯ä»¥é€šè¿‡ç®€å•çš„é…ç½®ï¼Œæ¥å®šä¹‰è¾“å‡ºã€æ ¼å¼æˆ–è€…æ—¥å¿—çº§åˆ«ç­‰ã€‚</p>

<p>package main</p>

<p>import (
	â€œosâ€
	log â€œgithub.com/sirupsen/logrusâ€
)</p>

<p>func init() {
	// è®¾ç½®æ—¥å¿—æ ¼å¼ä¸ºjsonæ ¼å¼
	log.SetFormatter(&amp;log.JSONFormatter{})</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è®¾ç½®å°†æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆé»˜è®¤çš„è¾“å‡ºä¸ºstderrï¼Œæ ‡å‡†é”™è¯¯ï¼‰
// æ—¥å¿—æ¶ˆæ¯è¾“å‡ºå¯ä»¥æ˜¯ä»»æ„çš„io.writerç±»å‹
log.SetOutput(os.Stdout)

// è®¾ç½®æ—¥å¿—çº§åˆ«ä¸ºwarnä»¥ä¸Š
log.SetLevel(log.WarnLevel) }
</code></pre></div></div>

<p>func main() {
	log.WithFields(log.Fields{
		â€œanimalâ€: â€œwalrusâ€,
		â€œsizeâ€:   10,
	}).Info(â€œA group of walrus emerges from the oceanâ€)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>log.WithFields(log.Fields{
	"omg":    true,
	"number": 122,
}).Warn("The group's number increased tremendously!")

log.WithFields(log.Fields{
	"omg":    true,
	"number": 100,
}).Fatal("The ice breaks!") } Logger loggeræ˜¯ä¸€ç§ç›¸å¯¹é«˜çº§çš„ç”¨æ³•, å¯¹äºä¸€ä¸ªå¤§å‹é¡¹ç›®, å¾€å¾€éœ€è¦ä¸€ä¸ªå…¨å±€çš„logruså®ä¾‹ï¼Œå³loggerå¯¹è±¡æ¥è®°å½•é¡¹ç›®æ‰€æœ‰çš„æ—¥å¿—ã€‚å¦‚ï¼š
</code></pre></div></div>

<p>package main</p>

<p>import (
	â€œgithub.com/sirupsen/logrusâ€
	â€œosâ€
)</p>

<p>// logrusæä¾›äº†New()å‡½æ•°æ¥åˆ›å»ºä¸€ä¸ªlogrusçš„å®ä¾‹ã€‚
// é¡¹ç›®ä¸­ï¼Œå¯ä»¥åˆ›å»ºä»»æ„æ•°é‡çš„logruså®ä¾‹ã€‚
var log = logrus.New()</p>

<p>func main() {
    // ä¸ºå½“å‰logruså®ä¾‹è®¾ç½®æ¶ˆæ¯çš„è¾“å‡ºï¼ŒåŒæ ·åœ°ï¼Œ
    // å¯ä»¥è®¾ç½®logruså®ä¾‹çš„è¾“å‡ºåˆ°ä»»æ„io.writer
	log.Out = os.Stdout</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ä¸ºå½“å‰logruså®ä¾‹è®¾ç½®æ¶ˆæ¯è¾“å‡ºæ ¼å¼ä¸ºjsonæ ¼å¼ã€‚
// åŒæ ·åœ°ï¼Œä¹Ÿå¯ä»¥å•ç‹¬ä¸ºæŸä¸ªlogruså®ä¾‹è®¾ç½®æ—¥å¿—çº§åˆ«å’Œhookï¼Œè¿™é‡Œä¸è¯¦ç»†å™è¿°ã€‚
log.Formatter = &amp;logrus.JSONFormatter{}

log.WithFields(logrus.Fields{
	"animal": "walrus",
	"size":   10,
}).Info("A group of walrus emerges from the ocean") }
</code></pre></div></div>

<p>Fields
å‰ä¸€ç« æåˆ°è¿‡ï¼Œlogrusä¸æ¨èä½¿ç”¨å†—é•¿çš„æ¶ˆæ¯æ¥è®°å½•è¿è¡Œä¿¡æ¯ï¼Œå®ƒæ¨èä½¿ç”¨Fieldsæ¥è¿›è¡Œç²¾ç»†åŒ–çš„ã€ç»“æ„åŒ–çš„ä¿¡æ¯è®°å½•ã€‚
ä¾‹å¦‚ä¸‹é¢çš„è®°å½•æ—¥å¿—çš„æ–¹å¼ï¼š</p>

<p>log.Fatalf(â€œFailed to send event %s to topic %s with key %dâ€, event, topic, key)
1
åœ¨logrusä¸­ä¸å¤ªæå€¡ï¼Œlogrusé¼“åŠ±ä½¿ç”¨ä»¥ä¸‹æ–¹å¼æ›¿ä»£ä¹‹ï¼š</p>

<p>log.WithFields(log.Fields{
  â€œeventâ€: event,
  â€œtopicâ€: topic,
  â€œkeyâ€: key,
}).Fatal(â€œFailed to send eventâ€)</p>

<p>å‰é¢çš„WithFields APIå¯ä»¥è§„èŒƒä½¿ç”¨è€…æŒ‰ç…§å…¶æå€¡çš„æ–¹å¼è®°å½•æ—¥å¿—ã€‚ä½†æ˜¯WithFieldsä¾ç„¶æ˜¯å¯é€‰çš„ï¼Œå› ä¸ºæŸäº›åœºæ™¯ä¸‹ï¼Œä½¿ç”¨è€…ç¡®å®åªéœ€è¦è®°å½•ä»ªä¸€æ¡ç®€å•çš„æ¶ˆæ¯ã€‚</p>

<p>é€šå¸¸ï¼Œåœ¨ä¸€ä¸ªåº”ç”¨ä¸­ã€æˆ–è€…åº”ç”¨çš„ä¸€éƒ¨åˆ†ä¸­ï¼Œéƒ½æœ‰ä¸€äº›å›ºå®šçš„Fieldã€‚æ¯”å¦‚åœ¨å¤„ç†ç”¨æˆ·httpè¯·æ±‚æ—¶ï¼Œä¸Šä¸‹æ–‡ä¸­ï¼Œæ‰€æœ‰çš„æ—¥å¿—éƒ½ä¼šæœ‰request_idå’Œuser_ipã€‚ä¸ºäº†é¿å…æ¯æ¬¡è®°å½•æ—¥å¿—éƒ½è¦ä½¿ç”¨log.WithFields(log.Fields{â€œrequest_idâ€: request_id, â€œuser_ipâ€: user_ip})ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªlogrus.Entryå®ä¾‹ï¼Œä¸ºè¿™ä¸ªå®ä¾‹è®¾ç½®é»˜è®¤Fieldsï¼Œåœ¨ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨è¿™ä¸ªlogrus.Entryå®ä¾‹è®°å½•æ—¥å¿—å³å¯ã€‚</p>

<p>requestLogger := log.WithFields(log.Fields{â€œrequest_idâ€: request_id, â€œuser_ipâ€: user_ip})
requestLogger.Info(â€œsomething happened on that requestâ€) # will log request_id and user_ip
requestLogger.Warn(â€œsomething not great happenedâ€)</p>

<p>Hook
logrusæœ€ä»¤äººå¿ƒåŠ¨çš„åŠŸèƒ½å°±æ˜¯å…¶å¯æ‰©å±•çš„HOOKæœºåˆ¶äº†ï¼Œé€šè¿‡åœ¨åˆå§‹åŒ–æ—¶ä¸ºlogrusæ·»åŠ hookï¼Œlogruså¯ä»¥å®ç°å„ç§æ‰©å±•åŠŸèƒ½ã€‚</p>

<p>Hookæ¥å£
logrusçš„hookæ¥å£å®šä¹‰å¦‚ä¸‹ï¼Œå…¶åŸç†æ˜¯æ¯æ­¤å†™å…¥æ—¥å¿—æ—¶æ‹¦æˆªï¼Œä¿®æ”¹logrus.Entryã€‚</p>

<p>// logrusåœ¨è®°å½•Levels()è¿”å›çš„æ—¥å¿—çº§åˆ«çš„æ¶ˆæ¯æ—¶ä¼šè§¦å‘HOOKï¼Œ
// æŒ‰ç…§Fireæ–¹æ³•å®šä¹‰çš„å†…å®¹ä¿®æ”¹logrus.Entryã€‚
type Hook interface {
	Levels() []Level
	Fire(*Entry) error
}</p>

<p>ä¸€ä¸ªç®€å•è‡ªå®šä¹‰hookå¦‚ä¸‹ï¼ŒDefaultFieldHookå®šä¹‰ä¼šåœ¨æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—æ¶ˆæ¯ä¸­åŠ å…¥é»˜è®¤å­—æ®µappName=â€myAppNameâ€ã€‚</p>

<p>type DefaultFieldHook struct {
}</p>

<p>func (hook *DefaultFieldHook) Fire(entry *log.Entry) error {
    entry.Data[â€œappNameâ€] = â€œMyAppNameâ€
    return nil
}</p>

<p>func (hook *DefaultFieldHook) Levels() []log.Level {
    return log.AllLevels
}</p>

<p>hookçš„ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨åˆå§‹åŒ–å‰è°ƒç”¨log.AddHook(hook)æ·»åŠ ç›¸åº”çš„hookå³å¯ã€‚</p>

<p>logruså®˜æ–¹ä»…ä»…å†…ç½®äº†syslogçš„hookã€‚
æ­¤å¤–ï¼Œä½†Githubä¹Ÿæœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹çš„hookå¯ä¾›ä½¿ç”¨ï¼Œæ–‡æœ«å°†æä¾›ä¸€äº›ç¬¬ä¸‰æ–¹HOOKçš„è¿æ¥ã€‚</p>

<p>è®°å½•æ–‡ä»¶åå’Œè¡Œå·
logrusçš„ä¸€ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜å°±æ˜¯æ²¡æœ‰æä¾›æ–‡ä»¶åå’Œè¡Œå·ï¼Œè¿™åœ¨å¤§å‹é¡¹ç›®ä¸­é€šè¿‡æ—¥å¿—å®šä½é—®é¢˜æ—¶æœ‰è¯¸å¤šä¸ä¾¿ã€‚Githubä¸Šçš„logrusçš„issue#63ï¼šLog filename and line numberåˆ›å»ºäº2014å¹´ï¼Œå››å¹´è¿‡å»äº†ä»æ˜¯opençŠ¶æ€~~~
ç½‘ä¸Šç»™å‡ºçš„è§£å†³æ–¹æ¡ˆåˆ†ä½ä¸¤ç±»ï¼Œä¸€å°±æ˜¯è‡ªå·±å®ç°ä¸€ä¸ªhookï¼›äºŒå°±æ˜¯é€šè¿‡è£…é¥°å™¨åŒ…è£…logrus.Entryã€‚ä¸¤ç§æ–¹æ¡ˆç½‘ä¸Šéƒ½æœ‰å¾ˆå¤šä»£ç ï¼Œä½†æ˜¯å¤§å¤šæ— æ³•æ­£å¸¸å·¥ä½œã€‚ä½†æ€»ä½“æ¥è¯´ï¼Œè§£å†³é—®é¢˜çš„æ€è·¯éƒ½æ˜¯å¯¹çš„ï¼šé€šè¿‡æ ‡å‡†åº“çš„runtimeæ¨¡å—è·å–è¿è¡Œæ—¶ä¿¡æ¯ï¼Œå¹¶ä»ä¸­æå–æ–‡ä»¶åï¼Œè¡Œå·å’Œè°ƒç”¨å‡½æ•°åã€‚</p>

<p>æ ‡å‡†åº“runtimeæ¨¡å—çš„Caller(skip int)å‡½æ•°å¯ä»¥è¿”å›å½“å‰goroutineè°ƒç”¨æ ˆä¸­çš„æ–‡ä»¶åï¼Œè¡Œå·ï¼Œå‡½æ•°ä¿¡æ¯ç­‰ï¼Œå‚æ•°skipè¡¨ç¤ºè¡¨ç¤ºè¿”å›çš„æ ˆå¸§çš„å±‚æ¬¡ï¼Œ0è¡¨ç¤ºruntime.Callerçš„è°ƒç”¨ç€ã€‚è¿”å›å€¼åŒ…æ‹¬å“åº”æ ˆå¸§å±‚æ¬¡çš„pc(ç¨‹åºè®¡æ•°å™¨)ï¼Œæ–‡ä»¶åå’Œè¡Œå·ä¿¡æ¯ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡è·Ÿè¸ªè°ƒç”¨æ ˆå‘ç°ï¼Œä»runtime.Caller()çš„è°ƒç”¨è€…å¼€å§‹ï¼Œåˆ°è®°å½•æ—¥å¿—çš„ç”Ÿæˆä»£ç ä¹‹é—´ï¼Œå¤§æ¦‚æœ‰8åˆ°11å±‚å·¦å³ï¼Œæ‰€æœ‰æˆ‘ä»¬åœ¨hookä¸­å¾ªç¯ç¬¬8åˆ°11å±‚è°ƒç”¨æ ˆåº”è¯¥å¯ä»¥æ‰¾åˆ°æ—¥å¿—è®°å½•çš„ç”Ÿäº§ä»£ç ã€‚</p>

<p>æ­¤å¤–ï¼Œruntime.FuncForPC(pc uintptr) *Funcå¯ä»¥è¿”å›æŒ‡å®špcçš„å‡½æ•°ä¿¡æ¯ã€‚
æ‰€æœ‰æˆ‘ä»¬è¦å®ç°çš„hookä¹Ÿæ˜¯åŸºäºä»¥ä¸ŠåŸç†ï¼Œä½¿ç”¨runtime.Caller()ä¾æ¬¡å¾ªç¯è°ƒç”¨æ ˆçš„ç¬¬7~11å±‚ï¼Œè¿‡æ»¤æ‰sirupsenåŒ…å†…å®¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªésiupsenråŒ…å°±è®¤ä¸ºæ˜¯æˆ‘ä»¬çš„ç”Ÿäº§ä»£ç äº†ï¼Œå¹¶è¿”å›pcä»¥ä¾¿é€šè¿‡runtime.FuncForPC()è·å–å‡½æ•°åç§°ã€‚ç„¶åå°†æ–‡ä»¶åã€è¡Œå·å’Œå‡½æ•°åç»„è£…ä¸ºsourceå­—æ®µå¡åˆ°logrus.Entryä¸­å³å¯ã€‚</p>

<p>import (
	â€œfmtâ€
	log â€œgithub.com/sirupsen/logrusâ€
	â€œruntimeâ€
	â€œstringsâ€
)</p>

<p>// line number hook for log the call context,
type lineHook struct {
    Field  string
    // skipä¸ºéå†è°ƒç”¨æ ˆå¼€å§‹çš„ç´¢å¼•ä½ç½®
	Skip   int
	levels []log.Level
}</p>

<p>// Levels implement levels
func (hook lineHook) Levels() []log.Level {
	return log.AllLevels
}</p>

<p>// Fire implement fire
func (hook lineHook) Fire(entry *log.Entry) error {
	entry.Data[hook.Field] = findCaller(hook.Skip)
	return nil
}</p>

<p>func findCaller(skip int) string {
	file := â€œâ€
	line := 0
	var pc uintptr
    // éå†è°ƒç”¨æ ˆçš„æœ€å¤§ç´¢å¼•ä¸ºç¬¬11å±‚.
	for i := 0; i &lt; 11; i++ {
        file, line, pc = getCaller(skip + i)
        // è¿‡æ»¤æ‰æ‰€æœ‰logrusåŒ…ï¼Œå³å¯å¾—åˆ°ç”Ÿæˆä»£ç ä¿¡æ¯
		if !strings.HasPrefix(file, â€œlogrusâ€) {
			break
		}
	}</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fullFnName := runtime.FuncForPC(pc)

fnName := ""
if fullFnName != nil {
	fnNameStr := fullFnName.Name()
    // å–å¾—å‡½æ•°å
	parts := strings.Split(fnNameStr, ".")
	fnName = parts[len(parts)-1]
}

return fmt.Sprintf("%s:%d:%s()", file, line, fnName) }
</code></pre></div></div>

<p>func getCaller(skip int) (string, int, uintptr) {
	pc, file, line, ok := runtime.Caller(skip)
	if !ok {
		return â€œâ€, 0, pc
	}
	n := 0</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è·å–åŒ…å
for i := len(file) - 1; i &gt; 0; i-- {
	if file[i] == '/' {
		n++
		if n &gt;= 2 {
			file = file[i+1:]
			break
		}
	}
}
return file, line, pc } æ•ˆæœå¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>time=â€2018-08-11T19:10:15+08:00â€ level=warning msg=â€postgres_exporter is ready for scraping on 0.0.0.0:9295â€¦â€ source=â€postgres_exporter/main.go:60:main()â€
time=â€2018-08-11T19:10:17+08:00â€ level=error msg=â€!!!msb info not foundâ€ source=â€postgres/postgres_query.go:63:QueryPostgresInfo()â€
time=â€2018-08-11T19:10:17+08:00â€ level=error msg=â€get postgres instances info failed, scrape metrics failed, error:msb env not foundâ€ source=â€collector/exporter.go:71:Scrape()â€</p>

<p>æ—¥å¿—æœ¬åœ°æ–‡ä»¶åˆ†å‰²
logrusæœ¬èº«ä¸å¸¦æ—¥å¿—æœ¬åœ°æ–‡ä»¶åˆ†å‰²åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡file-rotatelogsè¿›è¡Œæ—¥å¿—æœ¬åœ°æ–‡ä»¶åˆ†å‰²ã€‚ æ¯æ¬¡å½“æˆ‘ä»¬å†™å…¥æ—¥å¿—çš„æ—¶å€™ï¼Œlogruséƒ½ä¼šè°ƒç”¨file-rotatelogsæ¥åˆ¤æ–­æ—¥å¿—æ˜¯å¦è¦è¿›è¡Œåˆ‡åˆ†ã€‚å…³äºæœ¬åœ°æ—¥å¿—æ–‡ä»¶åˆ†å‰²çš„ä¾‹å­ç½‘ä¸Šå¾ˆå¤šï¼Œè¿™é‡Œä¸å†è¯¦ç»†ä»‹ç»ï¼Œå¥‰ä¸Šä»£ç ï¼š</p>

<p>import (
	â€œgithub.com/lestrrat-go/file-rotatelogsâ€
	â€œgithub.com/rifflock/lfshookâ€
	log â€œgithub.com/sirupsen/logrusâ€
	â€œtimeâ€
)</p>

<p>func newLfsHook(logLevel *string, maxRemainCnt uint) log.Hook {
	writer, err := rotatelogs.New(
        logName+â€.%Y%m%d%Hâ€,
        // WithLinkNameä¸ºæœ€æ–°çš„æ—¥å¿—å»ºç«‹è½¯è¿æ¥ï¼Œä»¥æ–¹ä¾¿éšç€æ‰¾åˆ°å½“å‰æ—¥å¿—æ–‡ä»¶
        rotatelogs.WithLinkName(logName),</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // WithRotationTimeè®¾ç½®æ—¥å¿—åˆ†å‰²çš„æ—¶é—´ï¼Œè¿™é‡Œè®¾ç½®ä¸ºä¸€å°æ—¶åˆ†å‰²ä¸€æ¬¡
    rotatelogs.WithRotationTime(time.Hour),
    
    // WithMaxAgeå’ŒWithRotationCountäºŒè€…åªèƒ½è®¾ç½®ä¸€ä¸ªï¼Œ
    // WithMaxAgeè®¾ç½®æ–‡ä»¶æ¸…ç†å‰çš„æœ€é•¿ä¿å­˜æ—¶é—´ï¼Œ
    // WithRotationCountè®¾ç½®æ–‡ä»¶æ¸…ç†å‰æœ€å¤šä¿å­˜çš„ä¸ªæ•°ã€‚
	//rotatelogs.WithMaxAge(time.Hour*24),
	rotatelogs.WithRotationCount(maxRemainCnt),
)

if err != nil {
	log.Errorf("config local file system for logger error: %v", err)
}

level, ok := logLevels[*logLevel]

if ok {
	log.SetLevel(level)
} else {
	log.SetLevel(log.WarnLevel)
}

lfsHook := lfshook.NewHook(lfshook.WriterMap{
	log.DebugLevel: writer,
	log.InfoLevel:  writer,
	log.WarnLevel:  writer,
	log.ErrorLevel: writer,
	log.FatalLevel: writer,
	log.PanicLevel: writer,
}, &amp;log.TextFormatter{DisableColors: true})

return lfsHook }
</code></pre></div></div>

<p>ä½¿ç”¨ä¸Šè¿°æœ¬åœ°æ—¥å¿—æ–‡ä»¶åˆ‡å‰²çš„æ•ˆæœå¦‚ä¸‹ï¼š</p>

<p>å°†æ—¥å¿—å‘é€åˆ°elasticsearch
å°†æ—¥å¿—å‘é€åˆ°elasticsearchæ˜¯å¾ˆå¤šæ—¥å¿—ç›‘æ§ç³»ç»Ÿçš„é€‰æ‹©ï¼Œå°†logrusæ—¥å¿—å‘é€åˆ°elasticsearchçš„åŸç†æ˜¯åœ¨hookçš„æ¯æ¬¡fireè°ƒç”¨æ—¶ï¼Œä½¿ç”¨golangçš„eså®¢æˆ·ç«¯å°†æ—¥å¿—ä¿¡æ¯å†™åˆ°elasticsearchã€‚elasticsearchå®˜æ–¹æ²¡æœ‰æä¾›golangå®¢æˆ·ç«¯ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹çš„goè¯­è¨€å®¢æˆ·ç«¯å¯ä¾›ä½¿ç”¨ï¼Œæˆ‘ä»¬é€‰æ‹©elasticã€‚elasticæä¾›äº†ä¸°å¯Œçš„æ–‡æ¡£ï¼Œä»¥åŠJavaä¸­çš„æµå¼æ¥å£ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚</p>

<p>client, err := elastic.NewClient(elastic.SetURL(â€œhttp://localhost:9200â€))
	if err != nil {
		log.Panic(err)
    }</p>

<p>// Index a tweet (using JSON serialization)
tweet1 := Tweet{User: â€œolivereâ€, Message: â€œTake Fiveâ€, Retweets: 0}
put1, err := client.Index().
    Index(â€œtwitterâ€).
    Type(â€œtweetâ€).
    Id(â€œ1â€).
    BodyJson(tweet1).
    Do(context.Background())</p>

<p>è€ƒè™‘åˆ°logrusçš„Fieldsæœºåˆ¶ï¼Œå¯ä»¥å®ç°å¦‚ä¸‹æ•°æ®æ ¼å¼ï¼š</p>

<p>msg := struct {
	Host      string
	Timestamp string <code class="language-plaintext highlighter-rouge">json:"@timestamp"</code>
	Message   string
	Data      logrus.Fields
	Level     string
}</p>

<p>å…¶ä¸­Hostè®°å½•äº§ç”Ÿæ—¥å¿—ä¸»æœºä¿¡æ¯ï¼Œåœ¨åˆ›å»ºhookæ˜¯æŒ‡å®šã€‚å…¶ä»–æ•°æ®éœ€è¦ä»logrus.Entryä¸­å–å¾—ã€‚æµ‹è¯•è¿‡ç¨‹æˆ‘ä»¬é€‰æ‹©æŒ‰ç…§æ­¤åŸç†å®ç°çš„ç¬¬ä¸‰æ–¹HOOKï¼šelogrusã€‚å…¶ä½¿ç”¨å¦‚ä¸‹ï¼š</p>

<p>import (
    â€œgithub.com/olivere/elasticâ€
	â€œgopkg.in/sohlich/elogrusâ€
)</p>

<p>func initLog() {
    client, err := elastic.NewClient(elastic.SetURL(â€œhttp://localhost:9200â€))
    if err != nil {
        log.Panic(err)
    }
    hook, err := elogrus.NewElasticHook(client, â€œlocalhostâ€, log.DebugLevel, â€œmylogâ€)
    if err != nil {
        log.Panic(err)
    }
    log.AddHook(hook)
}</p>

<p>ä»ElasticsearchæŸ¥è¯¢å¾—åˆ°æ—¥å¿—å­˜å‚¨ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p>GET http://localhost:9200/mylog/_search</p>

<p>HTTP/1.1 200 OK
content-type: application/json; charset=UTF-8
transfer-encoding: chunked</p>

<p>{
  â€œtookâ€: 1,
  â€œtimed_outâ€: false,
  â€œ<em>shardsâ€: {
    â€œtotalâ€: 5,
    â€œsuccessfulâ€: 5,
    â€œfailedâ€: 0
  },
  â€œhitsâ€: {
    â€œtotalâ€: 2474,
    â€œmax_scoreâ€: 1.0,
    â€œhitsâ€: [
      {
        â€œ_indexâ€: â€œmylogâ€,
        â€œ_typeâ€: â€œlogâ€,
        â€œ_idâ€: â€œAWUw13jWnMZReb-jHQupâ€,
        â€œ_scoreâ€: 1.0,
        â€œ_sourceâ€: {
          â€œHostâ€: â€œlocalhostâ€,
          â€œ@timestampâ€: â€œ2018-08-13T01:12:32.212818666Zâ€,
          â€œMessageâ€: â€œ!!!msb info not foundâ€,
          â€œDataâ€: {},
          â€œLevelâ€: â€œERRORâ€
        }
      },
      {
        â€œ_indexâ€: â€œmylogâ€,
        â€œ_typeâ€: â€œlogâ€,
        â€œ_idâ€: â€œAWUw13jgnMZReb-jHQuqâ€,
        â€œ_scoreâ€: 1.0,
        â€œ_sourceâ€: {
          â€œHostâ€: â€œlocalhostâ€,
          â€œ@timestampâ€: â€œ2018-08-13T01:12:32.223103348Zâ€,
          â€œMessageâ€: â€œget postgres instances info failed, scrape metrics failed, error:msb env not foundâ€,
          â€œDataâ€: {
            â€œsourceâ€: â€œcollector/exporter.go:71:Scrape()â€
          },
          â€œLevelâ€: â€œERRORâ€
        }
      },
      //â€¦
      {
        â€œ_indexâ€: â€œmylogâ€,
        â€œ_typeâ€: â€œlogâ€,
        â€œ_idâ€: â€œAWUw2f1enMZReb-jHQu</em>â€,
        â€œ_scoreâ€: 1.0,
        â€œ_sourceâ€: {
          â€œHostâ€: â€œlocalhostâ€,
          â€œ@timestampâ€: â€œ2018-08-13T01:15:17.212546892Zâ€,
          â€œMessageâ€: â€œ!!!msb info not foundâ€,
          â€œDataâ€: {
            â€œsourceâ€: â€œcollector/exporter.go:71:Scrape()â€
          },
          â€œLevelâ€: â€œERRORâ€
        }
      },
      {
        â€œ_indexâ€: â€œmylogâ€,
        â€œ_typeâ€: â€œlogâ€,
        â€œ_idâ€: â€œAWUw2NhmnMZReb-jHQu1â€,
        â€œ_scoreâ€: 1.0,
        â€œ_sourceâ€: {
          â€œHostâ€: â€œlocalhostâ€,
          â€œ@timestampâ€: â€œ2018-08-13T01:14:02.21276903Zâ€,
          â€œMessageâ€: â€œ!!!msb info not foundâ€,
          â€œDataâ€: {},
          â€œLevelâ€: â€œERRORâ€
        }
      }
    ]
  }
}</p>

<p>Response code: 200 (OK); Time: 16ms; Content length: 3039 bytes</p>

<p>å°†æ—¥å¿—å‘é€åˆ°å…¶ä»–ä½ç½®
å°†æ—¥å¿—å‘é€åˆ°æ—¥å¿—ä¸­å¿ƒä¹Ÿæ˜¯logrusæ‰€æå€¡çš„ï¼Œè™½ç„¶æ²¡æœ‰æä¾›å®˜æ–¹æ”¯æŒï¼Œä½†æ˜¯ç›®å‰Githubä¸Šæœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹hookå¯ä¾›ä½¿ç”¨ï¼š</p>

<p>logrus_amqpï¼šLogrus hook for Activemqã€‚
logrus-logstash-hook:Logstash hook for logrusã€‚
mgorus:Mongodb Hooks for Logrusã€‚
logrus_influxdb:InfluxDB Hook for Logrusã€‚
logrus-redis-hook:Hook for Logrus which enables logging to RELK stack (Redis, Elasticsearch, Logstash and Kibana)ã€‚
ç­‰ç­‰ï¼Œä¸Šè¿°ç¬¬ä¸‰æ–¹hookæˆ‘è¿™é‡Œæ²¡æœ‰å…·ä½“éªŒè¯ï¼Œå¤§å®¶å¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œå°è¯•ã€‚</p>

<p>å…¶ä»–æ³¨æ„äº‹é¡¹
Fatalå¤„ç†
å’Œå¾ˆå¤šæ—¥å¿—æ¡†æ¶ä¸€æ ·ï¼Œlogrusçš„Fatalç³»åˆ—å‡½æ•°ä¼šæ‰§è¡Œos.Exit(1)ã€‚ä½†æ˜¯logrusæä¾›å¯ä»¥æ³¨å†Œä¸€ä¸ªæˆ–å¤šä¸ªfatal handlerå‡½æ•°çš„æ¥å£logrus.RegisterExitHandler(handler func() {} )ï¼Œè®©logrusåœ¨æ‰§è¡Œos.Exit(1)ä¹‹å‰è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚fatal handlerå¯ä»¥åœ¨ç³»ç»Ÿå¼‚å¸¸æ—¶è°ƒç”¨ä¸€äº›èµ„æºé‡Šæ”¾apiç­‰ï¼Œè®©åº”ç”¨æ­£ç¡®çš„å…³é—­ã€‚</p>

<p>çº¿ç¨‹å®‰å…¨
é»˜è®¤æƒ…å†µä¸‹ï¼Œlogrusçš„apiéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå…¶å†…éƒ¨é€šè¿‡äº’æ–¥é”æ¥ä¿æŠ¤å¹¶å‘å†™ã€‚äº’æ–¥é”å·¥ä½œäºè°ƒç”¨hooksæˆ–è€…å†™æ—¥å¿—çš„æ—¶å€™ï¼Œå¦‚æœä¸éœ€è¦é”ï¼Œå¯ä»¥è°ƒç”¨logger.SetNoLock()æ¥å…³é—­ä¹‹ã€‚å¯ä»¥å…³é—­logrusäº’æ–¥é”çš„æƒ…å½¢åŒ…æ‹¬ï¼š</p>

<p>æ²¡æœ‰è®¾ç½®hookï¼Œæˆ–è€…æ‰€æœ‰çš„hookéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„å®ç°ã€‚
å†™æ—¥å¿—åˆ°logger.Outå·²ç»æ˜¯çº¿ç¨‹å®‰å…¨çš„äº†ï¼Œå¦‚logger.Outå·²ç»è¢«é”ä¿æŠ¤ï¼Œæˆ–è€…å†™æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶æ˜¯ä»¥O_APPENDæ–¹å¼æ‰“å¼€çš„ï¼Œå¹¶ä¸”æ¯æ¬¡å†™æ“ä½œéƒ½å°äº4kã€‚</p>

<p>å‰ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬çœ‹åˆ°äº†Golangæ ‡å‡†åº“ä¸­logæ¨¡å—çš„ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»log.Loggerå¼€å§‹é€æ­¥åˆ†æå…¶å®ç°ã€‚ å…¶æºç å¯ä»¥å‚è€ƒå®˜æ–¹åœ°å€</p>

<p>1.Loggerç»“æ„
é¦–å…ˆæ¥çœ‹ä¸‹ç±»å‹Loggerçš„å®šä¹‰ï¼š</p>

<p>1
2
3
4
5
6
7
type Logger struct {
    mu     sync.Mutex // ensures atomic writes; protects the following fields
    prefix string     // prefix to write at beginning of each line
    flag   int        // properties
    out    io.Writer  // destination for output
    buf    []byte     // for accumulating text to write
}
ä¸»è¦æœ‰5ä¸ªæˆå‘˜ï¼Œå…¶ä¸­3ä¸ªæˆ‘ä»¬æ¯”è¾ƒç†Ÿæ‚‰ï¼Œåˆ†åˆ«æ˜¯è¡¨ç¤ºLogå‰ç¼€çš„ â€œprefixâ€ï¼Œè¡¨ç¤ºLogå¤´æ ‡ç­¾çš„ â€œflagâ€ ï¼Œä»¥åŠLogçš„è¾“å‡ºç›®çš„åœ°outã€‚ bufæ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œä¸»è¦ç”¨æ¥å­˜æ”¾å³å°†åˆ·å…¥outçš„å†…å®¹ï¼Œç›¸å½“äºä¸€ä¸ªä¸´æ—¶ç¼“å­˜ï¼Œåœ¨å¯¹è¾“å‡ºå†…å®¹è¿›è¡Œåºåˆ—åŒ–æ—¶ä½œä¸ºå­˜å‚¨ç›®çš„åœ°ã€‚ muæ˜¯ä¸€ä¸ªmutexä¸»è¦ç”¨æ¥ä½œçº¿ç¨‹å®‰å…¨çš„å®ä¹ ï¼Œå½“æœ‰å¤šä¸ªgoroutineåŒæ—¶å¾€ä¸€ä¸ªç›®çš„åˆ·å†…å®¹çš„æ—¶å€™ï¼Œé€šè¿‡mutexä¿è¯æ¯æ¬¡å†™å…¥æ˜¯ä¸€æ¡å®Œæ•´çš„ä¿¡æ¯ã€‚</p>

<p>2.stdåŠæ•´ä½“ç»“æ„
åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æåˆ°äº†logæ¨¡å—æä¾›äº†ä¸€å¥—åŒ…çº§åˆ«çš„ç®€å•æ¥å£ï¼Œä½¿ç”¨è¯¥æ¥å£å¯ä»¥ç›´æ¥å°†æ—¥å¿—å†…å®¹æ‰“å°åˆ°æ ‡å‡†é”™è¯¯ã€‚é‚£ä¹ˆè¯¥è¿‡ç¨‹æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå…¶å®å°±æ˜¯é€šè¿‡ä¸€ä¸ªå†…ç½®çš„Loggerç±»å‹çš„å˜é‡ â€œstdâ€ æ¥å®ç°çš„ã€‚è¯¥å˜é‡ä½¿ç”¨ï¼š</p>

<p>1
var std = New(os.Stderr, â€œâ€, LstdFlags)
è¿›è¡Œåˆå§‹åŒ–ï¼Œé»˜è®¤è¾“å‡ºåˆ°ç³»ç»Ÿçš„æ ‡å‡†è¾“å‡º â€œos.Stderrâ€ ,å‰ç¼€ä¸ºç©ºï¼Œä½¿ç”¨æ—¥æœŸåŠ æ—¶é—´ä½œä¸ºLogæŠ¬å¤´ã€‚</p>

<p>å½“æˆ‘ä»¬è°ƒç”¨ log.Printçš„æ—¶å€™æ˜¯æ€ä¹ˆæ‰§è¡Œçš„å‘¢ï¼Ÿæˆ‘ä»¬çœ‹å…¶ä»£ç ï¼š</p>

<p>1
2
3
func Print(v â€¦interface{}) {
    std.Output(2, fmt.Sprint(vâ€¦))
}
è¿™é‡Œå®é™…å°±æ˜¯è°ƒç”¨äº†Loggerå¯¹è±¡çš„ Outputæ–¹æ³•ï¼Œå°†æ—¥å¿—å†…å®¹æŒ‰ç…§fmtåŒ…ä¸­çº¦å®šçš„æ ¼å¼è½¬ä¹‰åä¼ ç»™Outputã€‚Outputå®šä¹‰å¦‚ä¸‹ :</p>

<p>1
func (l *Logger) Output(calldepth int, s string) error</p>

<p>å…¶ä¸­sä¸ºæ—¥å¿—æ²¡æœ‰åŠ å‰ç¼€å’ŒLogæŠ¬å¤´çš„å…·ä½“å†…å®¹ï¼Œxxxxx ã€‚è¯¥å‡½æ•°æ‰§è¡Œå…·ä½“çš„å°†æ—¥å¿—åˆ·å…¥åˆ°å¯¹åº”çš„ä½ç½®ã€‚</p>

<p>3.æ ¸å¿ƒå‡½æ•°çš„å®ç°
Logger.Outputæ˜¯æ‰§è¡Œå…·ä½“çš„å°†æ—¥å¿—åˆ·å…¥åˆ°å¯¹åº”ä½ç½®çš„æ–¹æ³•ã€‚</p>

<p>è¯¥æ–¹æ³•é¦–å…ˆæ ¹æ®éœ€è¦è·å¾—å½“å‰æ—¶é—´å’Œè°ƒç”¨è¯¥æ–¹æ³•çš„æ–‡ä»¶åŠè¡Œå·ä¿¡æ¯ã€‚ç„¶åè°ƒç”¨formatHeaderæ–¹æ³•å°†Logçš„å‰ç¼€å’ŒLogæŠ¬å¤´å…ˆæ ¼å¼åŒ–å¥½ æ”¾å…¥Logger.bufä¸­ï¼Œç„¶åå†å°†Logçš„å†…å®¹å­˜å…¥åˆ°Logger.bufä¸­ï¼Œæœ€åè°ƒç”¨Logger.out.Writeæ–¹æ³•å°†å®Œæ•´çš„æ—¥å¿—å†™å…¥åˆ°è¾“å‡ºç›®çš„åœ°ä¸­ã€‚</p>

<p>ç”±äºå†™å…¥æ–‡ä»¶ä»¥åŠæ‹¼æ¥bufçš„è¿‡ç¨‹æ˜¯çº¿ç¨‹éå®‰å…¨çš„ï¼Œå› æ­¤ä½¿ç”¨mutexä¿è¯æ¯æ¬¡å†™å…¥çš„åŸå­æ€§ã€‚</p>

<p>1
2
l.mu.Lock()
defer l.mu.Unlock()
å°†bufçš„æ‹¼æ¥å’Œæ–‡ä»¶çš„å†™å…¥æ”¾å…¥è¿™ä¸ªåé¢ï¼Œä½¿å¾—åœ¨å¤šä¸ªgoroutineä½¿ç”¨åŒä¸€ä¸ªLoggerå¯¹è±¡æ˜¯ï¼Œä¸ä¼šå¼„ä¹±bufï¼Œä¹Ÿä¸ä¼šæ‚ç³…çš„å†™å…¥ã€‚</p>

<p>è¯¥æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ€ç»ˆä¼šä¼ é€’ç»™runtime.Callerçš„skipï¼ŒæŒ‡çš„æ˜¯è·³è¿‡çš„æ ˆçš„æ·±åº¦ã€‚è¿™é‡Œæˆ‘è®°ä½ç»™2å°±å¯ä»¥äº†ã€‚è¿™æ ·å°±ä¼šå¾—åˆ°æˆ‘ä»¬è°ƒç”¨log æ˜¯æ‰€å¤„çš„ä½ç½®ã€‚</p>

<p>åœ¨golangçš„æ³¨é‡Šä¸­è¯´é”ä½ runtime.Callerçš„è¿‡ç¨‹æ¯”è¾ƒé‡ï¼Œè¿™ç‚¹æˆ‘è¿˜æ˜¯ä¸å¾ˆäº†è§£ï¼Œåªæ˜¯ä»ä»£ç ä¸­çœ‹åˆ°å…¶åœ¨è¿™é‡ŒæŠŠé”æ‰“å¼€äº†ã€‚</p>

<p>1
2
3
4
5
6
7
8
9
10
11
if l.flag&amp;(Lshortfile|Llongfile) != 0 {
    // release lock while getting caller info - itâ€™s expensive.
    l.mu.Unlock()
    var ok bool
    _, file, line, ok = runtime.Caller(calldepth)
    if !ok {
        file = â€œ???â€
        line = 0
    }
    l.mu.Lock()
}
åœ¨formatHeaderé‡Œé¢é¦–å…ˆå°†å‰ç¼€ç›´æ¥å¤åˆ¶åˆ°Logger.bufä¸­,ç„¶åæ ¹æ®flagé€‰æ‹©LogæŠ¬å¤´çš„å†…å®¹ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªlogæ¨¡å—å®ç°çš„ itoaçš„æ–¹æ³•ï¼Œä½œç”¨ç±»ä¼¼cçš„itoa,å°†ä¸€ä¸ªæ•´æ•°è½¬æ¢æˆä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åªæ˜¯å…¶è½¬æ¢åå°†ç»“æœç›´æ¥è¿½åŠ åˆ°äº†bufçš„å°¾éƒ¨ã€‚</p>

<p>çºµè§‚æ•´ä¸ªå®ç°ï¼Œæœ€å€¼å¾—å­¦ä¹ çš„å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„éƒ¨åˆ†ã€‚åœ¨ä»€ä¹ˆä½ç½®åˆé€‚åšæ€æ ·çš„åŒæ­¥æ“ä½œã€‚</p>

<p>4.å¯¹å¤–æ¥å£çš„å®ç°
åœ¨äº†è§£äº†æ ¸å¿ƒæ ¼å¼åŒ–å’Œè¾“å‡ºç»“æ„åï¼Œåœ¨çœ‹å…¶å°è£…å°±éå¸¸ç®€å•äº†ï¼Œå‡ ä¹éƒ½æ˜¯é¦–å…ˆç”¨Outputè¿›è¡Œæ—¥å¿—çš„è®°å½•ï¼Œç„¶ååœ¨å¿…è¦çš„æ—¶å€™ åšos.exitæˆ–è€…panicçš„æ“ä½œï¼Œè¿™é‡Œçœ‹ä¸‹Fatalçš„å®ç°ã€‚</p>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
func (l *Logger) Fatal(v â€¦interface{}) {
    l.Output(2, fmt.Sprint(vâ€¦))
    os.Exit(1)
}
// Fatalf is equivalent to l.Printf() followed by a call to os.Exit(1).
func (l *Logger) Fatalf(format string, v â€¦interface{}) {
    l.Output(2, fmt.Sprintf(format, vâ€¦))
    os.Exit(1)
}
// Fatalln is equivalent to l.Println() followed by a call to os.Exit(1).
func (l *Logger) Fatalln(v â€¦interface{}) {
    l.Output(2, fmt.Sprintln(vâ€¦))
    os.Exit(1)
}
è¿™é‡Œä¹ŸéªŒè¯äº†æˆ‘ä»¬ä¹‹å‰åšçš„Panicçš„ç»“æœï¼Œå…ˆåšè¾“å‡ºæ—¥å¿—æ“ä½œã€‚å†è¿›è¡Œpanicã€‚</p>

<p>5.Golangçš„logæ¨¡å—è®¾è®¡
Golangçš„logæ¨¡å—ä¸»è¦æä¾›äº†ä¸‰ç±»æ¥å£ ï¼š</p>

<p>Print ï¼š ä¸€èˆ¬çš„æ¶ˆæ¯è¾“å‡º</p>

<p>Fatal : ç±»ä¼¼assertä¸€èˆ¬çš„å¼ºè¡Œé€€å‡º</p>

<p>Panic ï¼š ç›¸å½“äºOOé‡Œé¢å¸¸ç”¨çš„å¼‚å¸¸æ•è·</p>

<p>ä¸å…¶è¯´logæ¨¡å—æä¾›äº†ä¸‰ç±»æ—¥å¿—æ¥å£ï¼Œä¸å¦‚è¯´logæ¨¡å—ä»…ä»…æ˜¯å¯¹ç±»Cä¸­çš„ printfã€assertã€tryâ€¦catchâ€¦çš„ç®€å•å°è£…ã€‚Golangçš„logæ¨¡å— å¹¶æ²¡æœ‰å¯¹logè¿›è¡Œåˆ†ç±»ã€åˆ†çº§ã€è¿‡æ»¤ç­‰å…¶ä»–ç±»ä¼¼log4jã€log4cã€zlogå½“ä¸­å¸¸è§çš„æ¦‚å¿µã€‚å½“ç„¶åœ¨ä½¿ç”¨ä¸­ä½ å¯ä»¥é€šè¿‡æ·»åŠ prefix,æ¥è¿›è¡Œç®€å•çš„ åˆ†çº§ï¼Œæˆ–è€…æ”¹å˜Logger.outæ”¹å˜å…¶è¾“å‡ºä½ç½®ã€‚ä½†è¿™äº›å¹¶æ²¡æœ‰åœ¨APIå±‚é¢ç»™å‡ºç›´è§‚çš„æ¥å£ã€‚</p>

<p>Golangçš„logæ¨¡å—å°±åƒæ˜¯å…¶ç›®å‰ä»…ä¸“æ³¨äºä¸ºæœåŠ¡å™¨ç¼–ç¨‹ä¸€æ ·ï¼Œä»–çš„logæ¨¡å—ä¹Ÿä¸“æ³¨äºæœåŠ¡å™¨å°¤å…¶æ˜¯åŸºç¡€ç»„ä»¶è€ŒæœåŠ¡ã€‚å°±åƒnginxã€redisã€lighttpdã€keepalivedè‡ªå·±ä¸ºè‡ªå·±å†™äº†ä¸€ä¸ªç®€å•çš„æ—¥å¿—æ¨¡å—è€Œæ²¡æœ‰å®ç°log4cé‚£æ ·åºå¤§ä¸”å¤æ‚çš„æ—¥å¿—æ¨¡å—ä¸€æ ·ã€‚ä»–çš„æ—¥å¿—æ¨¡å—ä»…ä»…éœ€è¦ä¸º æœ¬æœåŠ¡æŒ‰ç…§éœ€è¦çš„æ ¼å¼å’Œæ–¹å¼æä¾›æ¥å£å°†æ—¥å¿—è¾“å‡ºåˆ°ç›®çš„åœ°å³å¯ã€‚</p>

<p>Golangçš„logæ¨¡å—å¯ä»¥è¿›è¡Œä¸€èˆ¬çš„ä¿¡æ¯è®°å½•ï¼Œassertæ—¶çš„ä¿¡æ¯è¾“å‡ºï¼Œä»¥åŠå‡ºç°å¼‚å¸¸æ—¶çš„æ—¥å¿—è®°å½•ï¼Œé€šè¿‡å¯¹å…¶Printçš„åŒ…è£…å¯ä»¥å®ç°æ›´å¤æ‚çš„ è¾“å‡ºã€‚å› æ­¤è¿™ä¸ªlogæ¨¡å—å¯è°“æ˜¯è¯­è¨€å±‚é¢ä¸Šéå¸¸åŸºç¡€çš„ä¸€å±‚åº“ï¼Œååº”çš„æ˜¯è¯­è¨€æœ¬èº«çš„ç‰¹å¾è€Œä¸æ˜¯ä¸€ä¸ªæœåŠ¡åº”è¯¥æ€æ ·æ€æ ·ã€‚</p>

<p>ä¸ºä»€ä¹ˆè¦ç”¨zapæ¥å†™æ—¥å¿—
åŸæ¥æ˜¯å†™PHPçš„ï¼Œä¸€ç›´ç”¨çš„error_logï¼Œç¬¬ä¸€æ¬¡å†™Goé¡¹ç›®çš„æ—¶å€™ï¼Œè¿˜çœŸä¸çŸ¥é“è¯¥æ€ä¹ˆå†™æ—¥å¿—ï¼Œåæ¥å°±æŒ‰ç…§PHPçš„å†™æ³•è‡ªå·±ä¸æˆè§„èŒƒçš„æ£é¼“å†™ã€‚å»äº†æ–°å…¬å¸ä¹‹åï¼Œå‘ç°ç”¨çš„æ˜¯zapã€‚åæ¥æŸ¥è¯¢ äº†è§£äº†ä¸‹zapï¼Œå‰åŒäº‹ååº”ä»–ä»¬å¾ˆå¤šå¤§å…¬å¸éƒ½åœ¨ä½¿ç”¨zapå†™æ—¥å¿—ï¼ŒGitHubä¸Šstar é«˜è¾¾7Kå¤šï¼Œè¶³ä»¥è¯´æ˜å®ƒå—æ¬¢è¿çš„ç¨‹åº¦ã€‚</p>

<p>1.zapæ˜¯Uberå¼€æºçš„æ—¥å¿—åº“ï¼›
2.å¾ˆå¤šå¤§çš„å…¬å¸å’Œå°çš„å…¬å¸éƒ½åœ¨ä½¿ç”¨ï¼›
3.è·Ÿseelogã€logrusç­‰ç±»åº“ç›¸æ¯”ï¼Œé«˜æ€§èƒ½æ˜¯å®ƒæœ€çªå‡ºçš„ä¼˜åŠ¿ï¼›
æˆ‘æƒ³ä»¥ä¸Šå‡ ä¸ªåŸå› å°±å·²ç»è¯´æ˜äº†å®ƒçš„å¹¿æ³›æ€§ã€ç¨³å®šæ€§ï¼Œå°±å€¼å¾—æˆ‘ä»¬å»å°è¯•ã€‚</p>

<p>æ€ä¹ˆä½¿ç”¨zap
æˆ‘ä»¬è¯´ä¸‹ç®€å•çš„ä½¿ç”¨æ¡ˆä¾‹
é¦–ç›¸å½“ç„¶æ˜¯ä¸‹è½½
go get -u go.uber.org/zap
å…ˆè´´ä¸€ä¸ªæˆ‘è¿™è¾¹å¸¸ç”¨çš„zapçš„é…ç½®</p>

<p>zap.Config{
        Level:       zap.NewAtomicLevelAt(zap.DebugLevel),
        Development: true,
        Encoding:    â€œjsonâ€,
        EncoderConfig: zapcore.EncoderConfig{
            TimeKey:        â€œtâ€,
            LevelKey:       â€œlevelâ€,
            NameKey:        â€œlogâ€,
            CallerKey:      â€œcallerâ€,
            MessageKey:     â€œmsgâ€,
            StacktraceKey:  â€œtraceâ€,
            LineEnding:     zapcore.DefaultLineEnding,
            EncodeLevel:    zapcore.LowercaseLevelEncoder,
            EncodeTime:     æ—¶é—´æ ¼å¼å‡½æ•°,
            EncodeDuration: zapcore.SecondsDurationEncoder,
            EncodeCaller:   zapcore.ShortCallerEncoder,
        },
        OutputPaths:      []string{â€œ/tmp/zap.logâ€},
        ErrorOutputPaths: []string{â€œ/tmp/zap.logâ€},
        InitialFields: map[string]interface{}{
            â€œappâ€: â€œtestâ€,
        },
    }
åŸºæœ¬é…ç½®çš„è¯´æ˜
Levelï¼šæ—¥å¿—çº§åˆ«ï¼Œè·Ÿå…¶ä»–è¯­è¨€æ˜¯ä¸€æ ·çš„ã€‚åªä¸è¿‡å®ƒéœ€è¦çš„ç±»å‹æ˜¯AtomicLevelã€‚æ‰€ä»¥éœ€è¦ä½¿ç”¨zap.NewAtomicLevelAtåšä¸‹å¦‚ä¸‹çš„è½¬åŒ–ã€‚</p>

<p>zap.NewAtomicLevelAt(zap.DebugLevel)
zap.DebugLevel
zap.InfoLevel
zap.WarnLevel
zap.ErrorLevel
Developmentï¼šbool æ˜¯å¦æ˜¯å¼€å‘ç¯å¢ƒã€‚å¦‚æœæ˜¯å¼€å‘æ¨¡å¼ï¼Œå¯¹DPanicLevelè¿›è¡Œå †æ ˆè·Ÿè¸ª
DisableCallerï¼šbool ç¦æ­¢ä½¿ç”¨è°ƒç”¨å‡½æ•°çš„æ–‡ä»¶åå’Œè¡Œå·æ¥æ³¨é‡Šæ—¥å¿—ã€‚é»˜è®¤è¿›è¡Œæ³¨é‡Šæ—¥å¿—
DisableStacktraceï¼šbool æ˜¯å¦ç¦ç”¨å †æ ˆè·Ÿè¸ªæ•è·ã€‚é»˜è®¤å¯¹Warnçº§åˆ«ä»¥ä¸Šå’Œç”Ÿäº§errorçº§åˆ«ä»¥ä¸Šçš„è¿›è¡Œå †æ ˆè·Ÿè¸ªã€‚
Encodingï¼šç¼–ç ç±»å‹ï¼Œç›®å‰ä¸¤ç§json å’Œ consoleã€æŒ‰ç…§ç©ºæ ¼éš”å¼€ã€‘,å¸¸ç”¨json
EncoderConfigï¼šç”Ÿæˆæ ¼å¼çš„ä¸€äº›é…ç½®â€“TODO åé¢æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹EncoderConfigé…ç½®å„ä¸ªè¯´æ˜
OutputPathsï¼š[]string æ—¥å¿—å†™å…¥æ–‡ä»¶çš„åœ°å€
ErrorOutputPathsï¼š[]string å°†ç³»ç»Ÿå†…çš„errorè®°å½•åˆ°æ–‡ä»¶çš„åœ°å€
InitialFieldsï¼šmap[string]interface{} åŠ å…¥ä¸€äº›åˆå§‹çš„å­—æ®µæ•°æ®ï¼Œæ¯”å¦‚é¡¹ç›®å
å½“ç„¶äº†ï¼Œå¦‚æœæƒ³æ§åˆ¶å°è¾“å‡ºï¼ŒOutputPathså’ŒErrorOutputPathsä¸èƒ½é…ç½®ä¸ºæ–‡ä»¶åœ°å€ï¼Œè€Œåº”è¯¥æ”¹ä¸ºstdoutã€‚</p>

<p>å…³äºconfigçš„é…ç½®ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒæ–‡ä»¶é‡Œé¢çš„æ³¨é‡Š
go.uber.org/zap/config.go
type Config struct</p>

<p>EncoderConfigé…ç½®è¯´æ˜
MessageKeyï¼šè¾“å…¥ä¿¡æ¯çš„keyå
LevelKeyï¼šè¾“å‡ºæ—¥å¿—çº§åˆ«çš„keyå
TimeKeyï¼šè¾“å‡ºæ—¶é—´çš„keyå
NameKey CallerKey StacktraceKeyè·Ÿä»¥ä¸Šç±»ä¼¼ï¼Œçœ‹åå­—å°±çŸ¥é“
LineEndingï¼šæ¯è¡Œçš„åˆ†éš”ç¬¦ã€‚åŸºæœ¬zapcore.DefaultLineEnding å³â€\nâ€
EncodeLevelï¼šåŸºæœ¬zapcore.LowercaseLevelEncoderã€‚å°†æ—¥å¿—çº§åˆ«å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå°å†™
EncodeTimeï¼šè¾“å‡ºçš„æ—¶é—´æ ¼å¼
EncodeDurationï¼šä¸€èˆ¬zapcore.SecondsDurationEncoder,æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´è½¬åŒ–æˆæµ®ç‚¹å‹çš„ç§’
EncodeCallerï¼šä¸€èˆ¬zapcore.ShortCallerEncoderï¼Œä»¥åŒ…/æ–‡ä»¶:è¡Œå· æ ¼å¼åŒ–è°ƒç”¨å †æ ˆ
EncodeNameï¼šå¯é€‰å€¼ã€‚</p>

<p>å…·ä½“EncoderConfigçš„è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒæ–‡ä»¶é‡Œé¢çš„æ³¨é‡Š
go.uber.org/zapcore/encoder.go
type EncoderConfig struct</p>

<p>ä¸¾ä¸ªæ —å­
ä½ æ‰¯è¿™ä¹ˆå¤šé…ç½®è¯´æ˜ï¼Œè°æœ‰æ—¶é—´çœ‹è¿™ç©æ„ï¼Œå†™ä¸ªå¸¸ç”¨çš„è®©å¤§å®¶ç…§ç€ç”¨å°±å¥½äº†å˜›ã€‚</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œgo.uber.org/zapâ€
    â€œgo.uber.org/zap/zapcoreâ€
    â€œtimeâ€
)</p>

<p>var logger *zap.Logger
func formatEncodeTime(t time.Time, enc zapcore.PrimitiveArrayEncoder) {
    enc.AppendString(fmt.Sprintf(â€œ%d%02d%02d_%02d%02d%02dâ€, t.Year(), t.Month(), t.Day(), t.Hour(), t.Minute(), t.Second()))
}</p>

<p>func FormateLog(args []interface{}) *zap.Logger {
    log := logger.With(ToJsonData(args))
    return log
}</p>

<p>func Debug(msg string, args â€¦interface{}) {
    FormateLog(args).Sugar().Debugf(msg)
}</p>

<p>func ToJsonData(args []interface{}) zap.Field {
    det := make([]string, 0)
    if len(args) &gt; 0 {
        for _, v := range args {
            det = append(det, fmt.Sprintf(â€œ%+vâ€, v))
        }
    }
    zap := zap.Any(â€œdetailâ€, det)
    return zap
}</p>

<p>func InitZapLog() {
    cfg := zap.Config{
        Level:       zap.NewAtomicLevelAt(zap.DebugLevel),
        Development: true,
        Encoding:    â€œjsonâ€,
        EncoderConfig: zapcore.EncoderConfig{
            TimeKey:        â€œtâ€,
            LevelKey:       â€œlevelâ€,
            NameKey:        â€œloggerâ€,
            CallerKey:      â€œcallerâ€,
            MessageKey:     â€œmsgâ€,
            StacktraceKey:  â€œtraceâ€,
            LineEnding:     zapcore.DefaultLineEnding,
            EncodeLevel:    zapcore.LowercaseLevelEncoder,
            EncodeTime:     formatEncodeTime,
            EncodeDuration: zapcore.SecondsDurationEncoder,
            EncodeCaller:   zapcore.ShortCallerEncoder,
        },
        OutputPaths:      []string{â€œ/tmp/zap.logâ€},
        ErrorOutputPaths: []string{â€œ/tmp/zap.logâ€},
        InitialFields: map[string]interface{}{
            â€œappâ€: â€œtestâ€,
        },
    }
    var err error
    logger, err = cfg.Build()
    if err != nil {
        panic(â€œlog init fail:â€ + err.Error())
    }
}</p>

<p>func main() {
    InitZapLog()
    defer logger.Sync()
    a := []string{â€œtestâ€,â€helloâ€,â€worldâ€}
    Debug(â€œoutputâ€,a)
}
æ‰§è¡Œä¸‹ï¼Œå°±ä¼šåœ¨æ—¥å¿—æ–‡ä»¶ä¸Šè¾“å…¥æŒ‰ç…§æˆ‘ä»¬é…ç½®æ—¥å¿—æ ¼å¼ã€‚</p>

<p>tail -f /tmp/zap.log
{â€œlevelâ€:â€debugâ€,â€tâ€:â€20190630_044053â€,â€callerâ€:â€myproject/main.go:21â€,â€msgâ€:â€outputâ€,â€appâ€:â€testâ€,â€detailâ€:[â€œ[test hello world]â€]}
ç„¶åæˆ‘ä»¬è¯•ä¸‹æ§åˆ¶å°è¾“å‡ºï¼Œä¿®æ”¹ä¸‰ä¸ªconsoleç›¸å…³çš„é…ç½®ä»£ç 
Â·Â·Â·
OutputPaths: []string{â€œstdoutâ€},
ErrorOutputPaths: []string{â€œstdoutâ€},
æ§åˆ¶å°çª—å£å°±ä¼šè¾“å‡º
{â€œlevelâ€:â€debugâ€,â€tâ€:â€20190630_092533â€,â€callerâ€:â€myproject/main.go:21â€,â€msgâ€:â€outputâ€,â€appâ€:â€testâ€,â€detailâ€:[â€œ[test hello world]â€]}
Â·Â·Â·</p>

<p>å½“ç„¶äº†ï¼Œzapæœ€æƒ³çš„ä½¿ç”¨å’Œæ–‡æ¡£ï¼Œçœ‹å®˜ç½‘å˜›
https://github.com/uber-go/zap
https://godoc.org/go.uber.org/zap
glogç®€ä»‹
glogæ˜¯è‘—åçš„googleå¼€æºC++æ—¥å¿—åº“glogçš„golangç‰ˆæœ¬ï¼Œglogæ˜¯ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—åº“ï¼Œä¸Šæ‰‹ç®€å•ä¸éœ€è¦é…ç½®æ–‡ä»¶å¹¶ä¸”ç¨³å®šé«˜æ•ˆï¼Œä½†æ˜¯å¯ä»¥è‡ªå®šä¹‰æ§åˆ¶çš„å†…å®¹å°±å°‘äº†ã€‚ glogä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š</p>

<p>glogæœ‰å››ç§æ—¥å¿—ç­‰çº§INFO &lt; WARING &lt; ERROR &lt; FATALï¼Œä¸åŒç­‰çº§çš„æ—¥å¿—æ˜¯æ‰“å°åˆ°ä¸åŒæ–‡ä»¶çš„ï¼Œä½ç­‰çº§çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼ˆINFOï¼‰ä¼šåŒ…å«é«˜ç­‰çº§çš„æ—¥å¿—ä¿¡æ¯ï¼ˆERRORï¼‰
é€šè¿‡å‘½ä»¤è¡Œä¼ é€’å‚æ•° â€“log_diræŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„å­˜æ”¾ç›®å½•ï¼Œé»˜è®¤ä¸ºos.TempDir()
å¯ä»¥æ ¹æ®æ–‡ä»¶å¤§å°åˆ‡å‰²æ—¥å¿—æ–‡ä»¶ï¼Œä½†æ˜¯ä¸èƒ½æ ¹æ®æ—¥æœŸåˆ‡å‰²æ—¥å¿—æ–‡ä»¶
æ—¥å¿—è¾“å‡ºæ ¼å¼æ˜¯å›ºå®šçš„(Lmmdd hh:mm:ss.uuuuuu threadid file:line] msgâ€¦)ä¸å¯ä»¥è‡ªå®šä¹‰
åœ¨ç¨‹åºå¼€å§‹æ—¶éœ€è¦è°ƒç”¨flag.Parse()è§£æå‘½ä»¤è¡Œå‚æ•°ï¼Œåœ¨ç¨‹åºé€€å‡ºæ—¶éœ€è¦è°ƒç”¨glog.Flush() ç¡®ä¿å°†ç¼“å­˜åŒºä¸­çš„å†…å®¹è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ã€‚
ä½¿ç”¨äº‹ä¾‹
func main() {
    //åˆå§‹åŒ–å‘½ä»¤è¡Œå‚æ•°
    flag.Parse()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//é€€å‡ºæ—¶è°ƒç”¨ï¼Œç¡®ä¿æ—¥å¿—å†™å…¥æ–‡ä»¶ä¸­
defer glog.Flush()

glog.Info("hello, glog")
glog.Warning("warning glog")
glog.Error("error glog")

glog.Infof("info %d", 1)
glog.Warningf("warning %d", 2)
glog.Errorf("error %d", 3)
</code></pre></div></div>

<p>}
//å‡è®¾ç¼–è¯‘åçš„å¯æ‰§è¡Œç¨‹åºåä¸ºdemo,è¿è¡Œæ—¶æŒ‡å®šlog_dirå‚æ•°å°†æ—¥å¿—æ–‡ä»¶ä¿å­˜åˆ°ç‰¹å®šçš„ç›®å½•
// ./demo â€“log_dir=./log
æºç åˆ†æ
æˆ‘ä»¬é¡ºç€äº‹ä¾‹ä»£ç ä¸­çš„ glog.Error(â€œerror glogâ€) è¿™è¡Œä»£ç æ¥çœ‹ä¸‹ï¼Œæ¥çœ‹ä¸‹æ—¥å¿—å†…å®¹æ˜¯å¦‚ä½•è¾“å‡ºåˆ°æ–‡ä»¶ä¸­å»çš„ã€‚</p>

<p>func Error(args â€¦interface{}) {
    logging.print(errorLog, argsâ€¦)
}</p>

<p>//errorLogæ˜¯glogå®šä¹‰çš„æ—¥å¿—ç­‰çº§æ ‡è®°ï¼Œåº•å±‚æ˜¯ä¸€ä¸ªint32ç±»å‹çš„å˜é‡
type severity int32 
const (
    infoLog severity = iota
    warningLog
    errorLog
    fatalLog
    numSeverity = 4
)</p>

<p>// Errorå‡½æ•°å®é™…åªæ˜¯åšäº†ä¸€å±‚ç®€å•çš„å°è£…ï¼Œå®é™…è°ƒç”¨çš„æ˜¯loggeringå¯¹è±¡çš„printå‡½æ•°ï¼Œloggeringæ˜¯ä¸€ä¸ªloggingTç±»å‹çš„å…¨å±€å˜é‡</p>

<p>func (l *loggingT) print(s severity, args â€¦interface{}) {
    l.printDepth(s, 1, argsâ€¦)
}
//printDepthå¯ä»¥æŒ‡å®šè¾“å‡ºæ—¥å¿—æ ˆçš„è°ƒç”¨å±‚æ¬¡<br />
func (l *loggingT) printDepth(s severity, depth int, args â€¦interface{}) {
//headeræ„é€ æ ¼å¼åŒ–çš„é™„åŠ ä¿¡æ¯ Lmmdd hh:mm:ss.uuuuuu threadid file:line]ï¼Œglogåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå…·ä½“æŸ¥çœ‹æºç 
//headerå‡½æ•°ä¸­ä¼šä»ä¸€ä¸ªfreeListä¸­å–bufferå¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šåˆ›å»ºæ–°çš„bufferå¯¹è±¡ï¼Œåœ¨ä½¿ç”¨å®Œåè°ƒç”¨ putBufferå°†bufferæ”¾å›åˆ°freeListä¸­
    buf, file, line := l.header(s, depth)
    fmt.Fprint(buf, argsâ€¦)
    if buf.Bytes()[buf.Len()-1] != â€˜\nâ€™ {
        buf.WriteByte(â€˜\nâ€™)
    }
    l.output(s, buf, file, line, false)
}</p>

<p>func (l *loggingT) output(s severity, buf *buffer, file string, line int, alsoToStderr bool) {
    data := buf.Bytes()
    //glogä¼šä¸ºæ¯ä¸ªçº§åˆ«çš„æ—¥å¿—åˆ›å»ºä¸åŒçš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰“å°æ—¥å¿—æ—¶é¦–å…ˆè¦ä¿è¯è¯¥çº§åˆ«çš„æ—¥å¿—æ–‡ä»¶å·²å­˜åœ¨
    if l.file[s] == nil {
        if err := l.createFiles(s); err != nil {
            os.Stderr.Write(data) 
            l.exit(err)
        }
    }
    //glogä¼šå°†é«˜çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯æ‰“å°åˆ°ä½çº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ä¸­
    //å»æ‰ä»£ç æ®µä¸­çš„ fallthroughï¼Œåˆ™å¯ä»¥å®ç°erroræ—¥å¿—åªè¾“å‡ºåˆ°erroræ–‡ä»¶ä¸­ï¼Œè€Œä¸ä¼šç»§ç»­è¾“å‡ºåˆ°infoçº§åˆ«çš„æ—¥å¿—æ–‡ä»¶ä¸­
    switch s {
    case fatalLog:
        l.file[fatalLog].Write(data)
        fallthrough
    case errorLog:
        l.file[errorLog].Write(data)
        fallthrough
    case warningLog:
        l.file[warningLog].Write(data)
        fallthrough
    case infoLog:
        l.file[infoLog].Write(data)
    }
    if s == fatalLog {
       //å¦‚æœæ˜¯FATALæ—¥å¿—ä¿¡æ¯ï¼Œåˆ™é€€å‡ºç¨‹åº
        os.Exit(255)
    }
    //å°†ä½¿ç”¨å®Œçš„bufferå¯¹è±¡æ”¾åˆ°ç¼“å†²æ± ä¸­
    l.putBuffer(buf)
}</p>

<p>//loggingT.fileæ˜¯ä¸€ä¸ªflushSyncWriteræ¥å£ç±»å‹çš„æ•°ç»„ï¼Œåœ¨glogä¸­å®é™…çš„å¯¹è±¡æ˜¯syncBufferï¼ŒsyncBufferå°è£…äº†åº•å±‚çš„å†™æ–‡ä»¶æ“ä½œï¼Œå¢åŠ äº†ç¼“å†²åŒºé¿å…è¿‡äºé¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨æé«˜å†™æ—¥å¿—æ•ˆç‡
type syncBuffer struct {
    *bufio.Writer
    file   *os.File
    sev    severity
    nbytes uint64 // The number of bytes written to this file
}
//å†™å…¥æ—¥å¿—å‰ä¼šåˆ¤æ–­æ—¥å¿—æ–‡ä»¶æ˜¯å¦å·²ç»è¶…è¿‡æŒ‡å®šçš„æœ€å¤§å°ºå¯¸ï¼Œå¦‚æœè¶…è¿‡åˆ™åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
//æ—¥å¿—å†…å®¹ä¼šå…ˆå†™å…¥åˆ°å†…å­˜ä¸­  sb.Writer = bufio.NewWriterSize(sb.file, bufferSize)
func (sb *syncBuffer) Write(p []byte) (n int, err error) {
    if sb.nbytes+uint64(len(p)) &gt;= MaxSize {
        if err := sb.rotateFile(time.Now()); err != nil {
            sb.logger.exit(err)
        }
    }
    n, err = sb.Writer.Write(p)
    sb.nbytes += uint64(n)
    return
}</p>

<p>//æˆ‘ä»¬é€šè¿‡è°ƒç”¨syncBuffer.Writeå‡½æ•°å°†æ—¥å¿—å†…å®¹è¾“å‡ºï¼Œä½†æ˜¯syncBufferç¼“å†²åŒºä¸­çš„å†…å®¹æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¾“å‡ºåˆ°æ–‡ä»¶ä¸­çš„å‘¢
//glogçš„initå‡½æ•°ä¸­ä¼šå¼€å¯ä¸€ä¸ª goroutineå®šæ—¶çš„è°ƒç”¨ flushSyncWriterçš„Flushå‡½æ•°å°†å†…å­˜ä¸­çš„æ—¥å¿—å†…å®¹åˆ·åˆ°æ–‡ä»¶ä¸­ 
func init() {
    go logging.flushDaemon()
}</p>

<p>func (l *loggingT) flushDaemon() {
    for _ = range time.NewTicker(flushInterval).C {
        for s := fatalLog; s &gt;= infoLog; sâ€“ {
        file := l.file[s]
        if file != nil {
            file.Flush() 
            file.Sync()<br />
        }
    }
}
vlogç®€ä»‹
ä¸€èˆ¬çš„æ—¥å¿—åº“ä¼šæä¾›æ—¥å¿—è¾“å‡ºçº§åˆ«ï¼Œå½“æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«ä½äºè¾“å‡ºçº§åˆ«æ—¶åˆ™ä¸ä¼šè¾“å‡ºè¯¥æ—¥å¿—ä¿¡æ¯ã€‚æˆ‘ä»¬ä½¿ç”¨å…¶ä»–æ—¥å¿—åº“æ—¶ä¼šä½¿ç”¨log.Debug()æ‰“å°å‡ºè°ƒè¯•ä¿¡æ¯ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸‹å°†æ—¥å¿—åº“çš„è¾“å‡ºçº§åˆ«è®¾ç½®ä¸ºDEBUGï¼Œè°ƒè¯•ä¿¡æ¯å°±ä¼šè¾“å‡ºä¾¿äºæˆ‘ä»¬æŸ¥çœ‹ç¨‹åºçš„å…·ä½“è¿è¡Œæƒ…å†µï¼Œè€Œåœ¨çº¿ä¸Šç¨‹åºä¸­å°†æ—¥å¿—çš„è¾“å‡ºçº§åˆ«è®¾ç½®ä¸ºINFOè°ƒè¯•ä¿¡æ¯å°±ä¸ä¼šè¾“å‡ºã€‚ glogåˆ™é‡‡ç”¨å¦å¤–ä¸€ç§æ–¹å¼å®ç°è¿™ç§åŠŸèƒ½ï¼Œglogæä¾›è®©ç”¨æˆ·è‡ªå®šä¹‰åˆ†çº§ä¿¡æ¯çš„åŠŸèƒ½ï¼Œç”¨æˆ·è‡ªå®šä¹‰åˆ†çº§ä¸glogè‡ªå¸¦çš„æ—¥å¿—ç­‰çº§(INFO ERROR)æ˜¯å®Œå…¨åˆ†ç¦»çš„ï¼Œåœ¨å‘½ä»¤è¡Œå‚æ•°è®¾ç½®ä¸­ç‹¬ç«‹è®¾ç½®â€œvâ€æˆ–â€œvmoduleâ€å‚æ•°æ¥æ§åˆ¶ã€‚</p>

<p>if glog.V(1) {
    glog.Info(â€œStarting transactionâ€¦â€)
}
glog.V(1).Infoln(â€œProcessedâ€, nItems, â€œelementsâ€)
åœ¨æµ‹è¯•ç¯å¢ƒä¸‹æˆ‘ä»¬è¿è¡Œç¨‹åºæ—¶æŒ‡å®šç”¨æˆ·è‡ªå®šä¹‰çº§åˆ«ä¸º1 (â€“v=1)ï¼Œä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯å°±ä¼šè¾“å‡ºã€‚ è€Œåœ¨çº¿ä¸Šç¯å¢ƒä¸­æŒ‡å®šè‡ªå®šä¹‰çº§åˆ«ä¸º0(â€“v=0)ï¼Œä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯åˆ™ä¸ä¼šè¾“å‡ºã€‚</p>

<p>func init(){
    flag.Var(&amp;logging.verbosity, â€œvâ€, â€œlog level for V logsâ€)
}</p>

<p>type Verbose bool</p>

<p>func V(level Level) Verbose {
    if logging.verbosity.get() &gt;= level {
        return Verbose(true)
    }
    return Verbose(false)
}</p>

<p>func (v Verbose) Info(args â€¦interface{}) {
    if v {
        logging.print(infoLog, argsâ€¦)
    }
}
ä¿®æ”¹glogæºç 
glogæœ‰äº›åŠŸèƒ½ä¸æˆ‘ä»¬å¸¸ç”¨çš„æ—¥å¿—åº“ä¸å¤ªä¸€æ ·æˆ–è€…æ²¡æœ‰æˆ‘ä»¬æœŸæœ›çš„åŠŸèƒ½ï¼Œå¯ä»¥ä¿®æ”¹glogçš„æºç æ¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ã€‚æ¯”å¦‚æˆ‘ä»¬ä¹‹å‰ä½¿ç”¨çš„æ—¥å¿—åº“æ˜¯æœ‰DEBUG INFO ERROR FATALçº§åˆ«çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹glogæºç å¢åŠ DEBUGçº§åˆ«ï¼Œåˆ é™¤WARNçº§åˆ«ï¼Œå·²äºæˆ‘ä»¬çš„åŸæœ‰ç³»ç»Ÿä¿æŒä¸€è‡´ã€‚ å…·ä½“ä¿®æ”¹å†…å®¹æŸ¥çœ‹githubæºç </p>

<p>è®¾ç½®ç­‰çº§æ§åˆ¶æ—¥å¿—çš„è¾“å‡º å®ç°åŸç†ï¼šå®šä¹‰ä¸€ä¸ªè¾“å‡ºç­‰çº§å˜é‡ï¼Œæä¾›æ¥å£ç»™ç”¨æˆ·å¯ä»¥è®¾ç½®è¯¥å˜é‡çš„å€¼ï¼Œé»˜è®¤ä¸ºINFOï¼Œåœ¨è¾“å‡ºæ—¥å¿—æ—¶æ£€æŸ¥æ—¥å¿—ä¿¡æ¯çš„ç­‰çº§æ˜¯å¦å¤§äºè¾“å‡ºç­‰çº§ï¼Œå¦‚æœå¤§äºåˆ™è¾“å‡ºæ—¥å¿—ä¿¡æ¯å¦åˆ™ä¸è¾“å‡º</p>

<p>var outputSeverity severity
//outputLevel å¿…é¡»ä¸ºINFO ERRORç­‰å­—ç¬¦ä¸²ï¼Œå¦åˆ™panic
//SetLevelString ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºæˆ‘éƒ½æ˜¯åœ¨ç¨‹åºå¼€å¯æ—¶åœ¨ä¸»è¿›ç¨‹ä¸­è°ƒç”¨ä¸€æ¬¡SetLevelStringå‡½æ•°ï¼Œè€Œä¸ä¼šåœ¨ç¨‹åºè¿è¡Œä¸­éšæ„è°ƒç”¨</p>

<p>func SetLevelString(outputLevel string) {
    severity, ok := severityByName(outputLevel)
    if !ok {
        panic(fmt.Errorf(â€œunknown severity name %sâ€, outputLevel))
    }
    outputSeverity = severity
}</p>

<p>func (l *loggingT) println(s severity, args â€¦interface{}) {
    if s &lt; outputSeverity {
        return
    }
    buf, file, line := l.header(s, 0)
    fmt.Fprintln(buf, argsâ€¦)
    l.output(s, buf, file, line, false)
}
//ç”¨æˆ·åœ¨æµ‹è¯•ç¯å¢ƒä¸‹è°ƒç”¨ SetLevelString(â€œDEBUGâ€)åˆ™è°ƒè¯•ä¿¡æ¯èƒ½å¤Ÿæ­£å¸¸è¾“å‡ºåˆ°æ–‡ä»¶ä¸­ï¼Œè€Œåœ¨çº¿ä¸Šç¯å¢ƒä¸‹è°ƒç”¨SetLevelString(â€œINFOâ€)å±è”½è°ƒè¯•ä¿¡æ¯
æ¯å¤©è‡ªåŠ¨åˆ‡å‰²æ—¥å¿—æ–‡ä»¶</p>

<p>å®ç°åŸç†ï¼šåœ¨åˆ›å»ºæ—¥å¿—æ–‡ä»¶æ—¶è®°å½•ä¸‹åˆ›å»ºæ–‡ä»¶çš„æ—¥æœŸ(MMDD)ï¼Œè¾“å‡ºæ¯æ¡æ—¥å¿—ä¿¡æ¯æ—¶åˆ¤æ–­å½“å‰æ—¥æœŸä¸æ—¥å¿—æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´åˆ™åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func init() {
    flag.BoolVar(&amp;logging.dailyRolling, "dailyRolling", false, " weather to handle log files daily")
}
</code></pre></div></div>

<p>func (sb *syncBuffer) Write(p []byte) (n int, err error) {
    if logging.dailyRolling {
        if sb.createdDate != string(p[1:5]) {
            if err := sb.rotateFile(time.Now()); err != nil {
                sb.logger.exit(err)
            }
        }
    }
    //å†™æ—¥å¿—ä¿¡æ¯
}</p>

<p>func (sb *syncBuffer) rotateFile(now time.Time) error {
    sb.createdDate = fmt.Sprintf(â€œ%02d%02dâ€, month, day)
    //åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶
}</p>

<p>https://github.com/google/glog
å†™åœ¨å‰é¢
Golang çš„logåŒ…å†…å®¹ä¸å¤šï¼Œè¯´å®è¯ï¼Œç›´æ¥ç”¨æ¥åšæ—¥å¿—å¼€å‘æœ‰äº›ç®€æ˜“ã€‚ä¸»è¦æ˜¯ç¼ºå°‘ä¸€äº›åŠŸèƒ½ï¼š</p>

<p>æŒ‰æ—¥å¿—çº§åˆ«æ‰“å°å’Œæ§åˆ¶æ—¥å¿—ï¼›
æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨åˆ†å‰²ï¼›
å¼‚æ­¥æ‰“å°æ—¥å¿—ã€‚
æŒ‰æ—¥å¿—çº§åˆ«æ‰“å°å’Œæ§åˆ¶æ—¥å¿—
æˆ‘ä»¬å®ç°çš„æ—¥å¿—æ¨¡å—å°†ä¼šæ”¯æŒ4ä¸ªçº§åˆ«ï¼š</p>

<p>const (
    LevelError = iota
    LevelWarning
    LevelInformational
    LevelDebug
)
å®šä¹‰ä¸€ä¸ªæ—¥å¿—ç»“æ„ä½“ï¼š</p>

<p>type Logger struct {
    level int
    l     *log.Logger
}</p>

<p>func (ll *Logger) Error(format string, v â€¦interface{}) {
    if LevelError &gt; ll.level {
        return
    }
    msg := fmt.Sprintf(â€œ[E] â€œ+format, vâ€¦)
    ll.l.Printf(msg)
}
è¿™æ ·å°±èƒ½å®ç°æ—¥å¿—çº§åˆ«æ§åˆ¶è¾“å‡ºï¼Œå¹¶ä¸”æ‰“å°çš„æ—¶å€™è¿½åŠ ä¸€ä¸ªæ ‡è®°ï¼Œæ¯”å¦‚ä¸Šé¢çš„ä¾‹å­ï¼ŒError çº§åˆ«å°±ä¼šè¿½åŠ [E]ã€‚</p>

<p>è¿™ä¸ªå®ç°å·²ç»å¯ä»¥äº†ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¼˜åŒ–çš„ç©ºé—´ã€‚æ¯”å¦‚æ‰“å°è¿½åŠ æ ‡è®°[E]çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯å­—ç¬¦ä¸²åŠ æ³•ã€‚å­—ç¬¦ä¸²åŠ æ³•ä¼šç”³è¯·æ–°çš„å†…å­˜ï¼Œå¯¹æ€§èƒ½ä¸æ˜¯å¾ˆä¼˜åŒ–ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡å­—ç¬¦æ•°ç»„æ¥ä¼˜åŒ–ã€‚</p>

<p>ä½†æˆ‘ä¸ä¼šè¿™ä¹ˆå»ä¼˜åŒ–äº†ã€‚è¿™ä¸ªæ—¶å€™çœ‹ä¸€ä¸‹ log åŒ…çš„ APIï¼Œå¯ä»¥å‘ç°åŸç”ŸåŒ…æ˜¯æ”¯æŒè®¾ç½®å‰ç¼€çš„ï¼š</p>

<p>func (l *Logger) SetPrefix(prefix string)
å†å»çœ‹ä¸€ä¸‹å…·ä½“çš„å®ç°ï¼š</p>

<p>func (l <em>Logger) formatHeader(buf *[]byte, t time.Time, file string, line int) {
    *buf = append(</em>buf, l.prefixâ€¦)
åŸç”ŸåŒ…åœ¨å†™æ—¥å¿—å‰ç¼€çš„æ—¶å€™å°±ç”¨åˆ°äº†[]byteæ¥æå‡æ€§èƒ½ã€‚æ—¢ç„¶äººå®¶å·²ç»æä¾›äº†ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä¸è¦è‡ªå·±é€ äº†ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè®¾ç½®å‰ç¼€æ˜¯åˆå§‹åŒ–çš„æ—¶å€™å°±è¦è®¾ç½®ï¼Œæ‰“å°çš„æ—¶å€™è‡ªåŠ¨è¾“å‡ºå‡ºæ¥ã€‚ä¸€ä¸ªlog.Loggerå¯¹è±¡åªèƒ½æœ‰ä¸€ä¸ªå‰ç¼€ï¼Œè€Œæˆ‘ä»¬éœ€è¦4ç§çº§åˆ«çš„å‰ç¼€ï¼Œè¿™ä¸ªå¦‚ä½•æ‰“å°ï¼Ÿ</p>

<p>type Logger struct {
    level int
    err   *log.Logger
    warn  *log.Logger
    info  *log.Logger
    debug *log.Logger
}
æˆ‘ä»¬ç›´æ¥ç”³è¯·4ä¸ªæ—¥å¿—å¯¹è±¡å°±èƒ½è§£å†³ã€‚ä¸ºäº†ä¿è¯æ‰€æœ‰çº§åˆ«éƒ½æ‰“å°åˆ°åŒä¸€ä¸ªæ–‡ä»¶é‡Œé¢ï¼Œåˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®æˆåŒä¸€ä¸ªio.Writerå³å¯ã€‚</p>

<p>logger := new(LcLogger)</p>

<p>logger.err = log.New(w, â€œ[E] â€œ, flag)
logger.warn = log.New(w, â€œ[W] â€œ, flag)
logger.info = log.New(w, â€œ[I] â€œ, flag)
logger.debug = log.New(w, â€œ[D] â€œ, flag)
è®¾ç½®æ—¥å¿—çº§åˆ«ï¼š</p>

<p>func (ll *Logger) SetLevel(l int) {
    ll.level = l
}
æ‰“å°çš„æ—¶å€™æ ¹æ®æ—¥å¿—çº§åˆ«æ§åˆ¶è¾“å‡ºã€‚ï¼ˆè®²ä¸€ä¸ªæˆ‘é‡åˆ°çš„å‘ã€‚ä¹‹å‰æœ‰ä¸€æ¬¡æ‰“å°æ—¥å¿—æ‰“å¤ªå¤šäº†ï¼Œç£ç›˜éƒ½æ‰“æ»¡äº†ï¼Œå°±å¯»æ€ç€æŠŠæ—¥å¿—çº§åˆ«è°ƒé«˜å‡å°‘æ‰“å°å†…å®¹ã€‚æŠŠçº§åˆ«è°ƒæˆ Error åå‘ç°è¿˜æ˜¯æ²¡æœ‰æ•ˆæœï¼Œæœ€åçœ‹äº†çœ‹ä»£ç å‘ç°å‡ºé—®é¢˜çš„æ—¥å¿—æ‰“å°çš„æ˜¯ Error çº§åˆ«ã€‚ã€‚ã€‚Errorçº§åˆ«çš„æ—¥å¿—è¦å°½é‡å°‘æ‰“ã€‚ï¼‰</p>

<p>func (ll *Logger) Error(format string, v â€¦interface{}) {
    if LevelError &gt; ll.level {
        return
    }
    ll.err.Printf(format, vâ€¦)
}
æ—¥å¿—æ–‡ä»¶è‡ªåŠ¨åˆ†å‰²
æ—¥å¿—æ–‡ä»¶éœ€è¦è‡ªåŠ¨åˆ†å‰²ã€‚å¦åˆ™ä¸€ä¸ªæ–‡ä»¶è¿‡å¤§ï¼Œæ¸…ç†ç£ç›˜çš„æ—¶å€™è¿™ä¸ªæ–‡ä»¶å› ä¸ºè¿˜æ˜¯æ‰“å°æ—¥å¿—æ²¡åŠæ³•æ¸…ç†ã€‚</p>

<p>æ—¥å¿—åˆ†å‰²æˆ‘è§‰å¾—ç®€å•çš„ä»¥å¤§å°åˆ†å‰²å°±å¥½ã€‚</p>

<p>é‚£ä¹ˆæ—¥å¿—åˆ†å‰²åŠŸèƒ½å¦‚ä½•æ¥å…¥å’±ä»¬ä¸Šé¢å®ç°çš„æ—¥å¿—æ¨¡å—å‘¢ï¼Ÿå…³é”®å°±åœ¨io.Writerã€‚</p>

<p>type Writer interface {
    Write(p []byte) (n int, err error)
}
Writerè¿™ä¸ªæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚æ­¤ç®€å•ã€‚åŸç”ŸåŒ…é»˜è®¤æ‰“å°æ—¥å¿—ä¼šè¾“å‡ºåˆ°os.Stderré‡Œé¢ï¼Œè¿™æ˜¯ä¸€ä¸ªos.Fileç±»å‹çš„å˜é‡ï¼Œå®ƒå®ç°äº†Writerè¿™ä¸ªæ¥å£ã€‚</p>

<p>func (f *File) Write(b []byte) (n int, err error)
å†™æ—¥å¿—çš„æ—¶å€™ï¼Œlog åŒ…ä¼šè‡ªåŠ¨è°ƒç”¨Writeæ–¹æ³•ã€‚æˆ‘ä»¬å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ªWriterï¼Œåœ¨Writeçš„æ—¶å€™è®¡ç®—ä¸€ä¸‹å†™å…¥æ­¤è¡Œæ—¥å¿—ä¹‹åå½“å‰æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œå¦‚æœè¶…è¿‡è®¾å®šçš„å€¼ï¼Œæ‰§è¡Œä¸€æ¬¡åˆ†å‰²ã€‚æŒ‰æ—¥å­åˆ†å‰²æ—¥å¿—ä¹Ÿæ˜¯è¿™ä¸ªæ—¶å€™æ“ä½œã€‚</p>

<p>æ¨èç”¨ gopkg.in/natefinch/lumberjack.v2 è¿™ä¸ªåŒ…æ¥åšæ—¥å¿—åˆ†å‰²ï¼ŒåŠŸèƒ½å¾ˆå¼ºå¤§ã€‚</p>

<p>jack := &amp;lumberjack.Logger{
    Filename: lfn,
    MaxSize:  maxsize, // megabytes
}
ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œjackå¯¹è±¡å°±æ˜¯ä¸€ä¸ªWriteräº†ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶ç»™Loggerä½¿ç”¨ã€‚</p>

<p>æ—¥å¿—çš„å¼‚æ­¥è¾“å‡º
åç¨‹æ± ä¹Ÿæ•´ä¸ªåŒ…ï¼šgithub.com/ivpusic/grpoolã€‚åç¨‹æ± å°±ä¸å±•å¼€è¯´äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹è¿™ä¸ªåŒ…çš„å®ç°ã€‚</p>

<p>æ—¥å¿—çš„ç»“æ„ä½“å†ä¸€æ¬¡å‡çº§ï¼š</p>

<p>type Logger struct {
    level int
    err   *log.Logger
    warn  *log.Logger
    info  *log.Logger
    debug *log.Logger
    p     *grpool.Pool
}
åˆå§‹åŒ–ï¼š</p>

<p>logger.p = grpool.NewPool(numWorkers, jobQueueLen)
æ—¥å¿—è¾“å‡ºï¼š</p>

<p>func (ll *Logger) Error(format string, v â€¦interface{}) {
    if LevelError &gt; ll.level {
        return
    }
    ll.p.JobQueue &lt;- func() {
        ll.err.Printf(format, vâ€¦)
    }
}
æ—¥å¿—è¡Œå·
å¦‚æœä½ ä¸€æ­¥ä¸€æ­¥æŒ‰ä¸Šé¢çš„åšäº†ï¼Œæ‰“å°æ—¥å¿—è®¾ç½®äº†Lshortfileï¼Œå±•ç¤ºè¡Œå·çš„èŠ±ï¼Œä½ å¯èƒ½ä¼šå‘ç°è¿™ä¸ªæ—¶å€™æ‰“å°å‡ºæ¥çš„è¡Œå·æœ‰é—®é¢˜ã€‚æ‰“å°æ—¥å¿—çš„æ—¶å€™ç”¨åˆ°äº†runtimeé‡Œé¢çš„å †æ ˆä¿¡æ¯ï¼Œå› ä¸ºæˆ‘ä»¬å°è£…äº†ä¸€å±‚ï¼Œæ‰€ä»¥æ‰“å°çš„å †æ ˆæ·±åº¦ä¼šå‘ç”Ÿå˜åŒ–ã€‚ç®€å•çš„è¯´å°±æ˜¯æ·±äº†ä¸€å±‚ã€‚</p>

<p>åŸç”Ÿçš„æ—¥å¿—åŒ…æä¾›äº†func (l *Logger) Output(calldepth int, s string) erroræ¥æ§åˆ¶æ—¥å¿—å †æ ˆæ·±åº¦è¾“å‡ºï¼Œæˆ‘ä»¬å†æ¬¡å¯¹ä»£ç è¿›è¡Œè°ƒæ•´ã€‚</p>

<p>type Logger struct {
    level int
    err   *log.Logger
    warn  *log.Logger
    info  *log.Logger
    debug *log.Logger
    p     *grpool.Pool
    depth int
}</p>

<p>func (ll *Logger) Error(format string, v â€¦interface{}) {
    if LevelError &gt; ll.level {
        return
    }
    ll.p.JobQueue &lt;- func() {
        ll.err.Output(ll.depth, fmt.Sprintf(format, vâ€¦))
    }
}
æˆ‘ä»¬åªå°è£…äº†ä¸€å±‚ï¼Œæ‰€ä»¥æ·±åº¦è®¾ç½®æˆ3å°±å¯ä»¥äº†ã€‚</p>

<p>çº¿ç¨‹å®‰å…¨
åŸç”ŸåŒ…æ‰“å°æ—¥å¿—æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š</p>

<p>func (l *Logger) Output(calldepth int, s string) error {
    now := time.Now() // get this early.
    var file string
    var line int
    l.mu.Lock() // çœ‹åˆ°è¿™é‡Œäº†ä¹ˆï¼Ÿ
    defer l.mu.Unlock()
    if l.flag&amp;(Lshortfile|Llongfile) != 0 {
        // release lock while getting caller info - itâ€™s expensive.
        l.mu.Unlock()
        var ok bool
        _, file, line, ok = runtime.Caller(calldepth)
        if !ok {
            file = â€œ???â€
            line = 0
        }
        l.mu.Lock()
    }
    l.buf = l.buf[:0]
    l.formatHeader(&amp;l.buf, now, file, line)
    l.buf = append(l.buf, sâ€¦)
    if len(s) == 0 || s[len(s)-1] != â€˜\nâ€™ {
        l.buf = append(l.buf, â€˜\nâ€™)
    }
    _, err := l.out.Write(l.buf)
    return err
}
æœ‰å®ƒçš„ä¿è¯ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜äº†ã€‚</p>

<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼ŒfmtåŒ…æ‰“å°æ—¥å¿—æ˜¯çº¿ç¨‹å®‰å…¨çš„ä¹ˆï¼Ÿprintlnå®‰å…¨ä¹ˆï¼Ÿfmtå’Œprintlnæ‰“å°æ—¥å¿—éƒ½æ‰“å°åˆ°äº†å“ªé‡Œï¼Ÿæœ‰å…´è¶£çš„å¯ä»¥ç•™è¨€ä¸€ä¸‹ä¸€èµ·è®¨è®ºã€‚</p>

<p>æœ€å
æ—¥å¿—çš„æ‰“å°ä¼šç”¨åˆ°è¯¸å¦‚fmt.Sprintfçš„ä¸œè¥¿ï¼Œè¿™ä¸ªåœ¨å®ç°çš„æ—¶å€™å°†ä¼šç”¨åˆ°åå°„ã€‚åå°„ä¼šå¯¹æ€§èƒ½æœ‰å½±å“ï¼Œä½†æ˜¯ä¸ç”¨åå°„çš„è¯ä»£ç è¿‡äºæ¶å¿ƒã€‚</p>

<p>å®Œæ•´çš„ä»£ç æ”¾åˆ°äº† GitHub ä¸Šé¢ï¼Œåœ°å€ã€‚</p>

<p>ä¸Šé¢ä»‹ç»çš„æ—¥å¿—åªæ˜¯åœ¨é’ˆå¯¹è¾“å‡ºåˆ°æ–‡ä»¶ã€‚å¦‚æœä½ æƒ³è¾“å‡ºæœ‰é‚®ä»¶ã€ElasticSearchç­‰å…¶å®ƒåœ°æ–¹ï¼Œä¸è¦åœ¨åˆå§‹åŒ–çš„æ—¶å€™é€šè¿‡å„ç§å¤æ‚é…ç½®å‚æ•°æ¥å®ç°ã€‚</p>

<p>æˆ‘è¯´çš„æ˜¯è¿™æ ·ï¼š</p>

<p>NewLogger(â€œesâ€, â€¦)
NewLogger(â€œsmtpâ€, â€¦)
è¿™æ ·åšçš„é—®é¢˜å°±æ˜¯ï¼Œæˆ‘åªèƒ½ç”¨ä½ æä¾›å¥½çš„ä¸œè¥¿ï¼Œå¦‚æœæƒ³æ‰©å±•åªèƒ½ä¿®æ”¹æ—¥å¿—åŒ…äº†ã€‚å¦‚æœè¿™ä¸ªåŒ…æ˜¯ç¬¬ä¸‰æ–¹çš„åŒ…ï¼Œé‚£è®©åˆ«äººæ€ä¹ˆæ‰©å±•å‘¢ï¼Ÿè€Œä¸”è¿™ç§å®ç°ä¹Ÿä¸æ˜¯ Golang çš„å®ç°é£æ ¼ã€‚</p>

<p>å…¶å®å¤§å®¶çœ‹çœ‹åŸç”Ÿçš„è¿™äº›åŒ…ï¼Œå¾ˆå¤šéƒ½æ˜¯é€šè¿‡æ¥å£ä¸²è”èµ·æ¥çš„ã€‚åŸç”Ÿçš„ log åŒ…ï¼Œä½ å¯ä»¥è®¤ä¸ºä»–æä¾›çš„æœåŠ¡ä¸»è¦æ˜¯æµç¨‹æ–¹é¢çš„æœåŠ¡ï¼Œæ‹¼æ¥å¥½è¦æ‰“å°çš„å†…å®¹ï¼ŒåŒ…æ‹¬è¡Œå·ã€æ—¶é—´ç­‰ç­‰ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œç„¶åè°ƒç”¨Writeræ¥æ‰“å°ã€‚å¦‚æœæˆ‘ä»¬è¦æŠŠæ—¥å¿—æ‰“å°åˆ° ES é‡Œé¢ï¼Œå°±å®ç°ä¸€ä¸ªESWriterã€‚è¿™æ‰æ˜¯ Golang é£æ ¼çš„ä»£ç ã€‚</p>
:ET