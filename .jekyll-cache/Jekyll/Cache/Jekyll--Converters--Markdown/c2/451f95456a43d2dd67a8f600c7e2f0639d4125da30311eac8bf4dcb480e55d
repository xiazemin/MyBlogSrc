I"´<p>Golangæ”¯æŒè¯­è¨€çº§åˆ«çš„å¹¶å‘ï¼Œå¹¶å‘çš„æœ€å°é€»è¾‘å•ä½å«åšgoroutineï¼Œgoroutineå°±æ˜¯Goä¸ºäº†å®ç°å¹¶å‘æä¾›çš„ç”¨æˆ·æ€çº¿ç¨‹ï¼Œè¿™ç§ç”¨æˆ·æ€çº¿ç¨‹æ˜¯è¿è¡Œåœ¨å†…æ ¸æ€çº¿ç¨‹(OSçº¿ç¨‹)ä¹‹ä¸Šã€‚å½“æˆ‘ä»¬åˆ›å»ºäº†å¤§é‡çš„goroutineå¹¶ä¸”åŒæ—¶è¿è¡Œåœ¨ä¸€ä¸ªæˆ–åˆ™å¤šä¸ªå†…æ ¸æ€çº¿ç¨‹ä¸Šæ—¶(å†…æ ¸çº¿ç¨‹ä¸goroutineæ˜¯m:nçš„å¯¹åº”å…³ç³»)ï¼Œå°±éœ€è¦ä¸€ä¸ªè°ƒåº¦å™¨æ¥ç»´æŠ¤ç®¡ç†è¿™äº›goroutineï¼Œç¡®ä¿æ‰€æœ‰çš„goroutineéƒ½æœ‰ç›¸å¯¹å…¬å¹³çš„æœºä¼šä½¿ç”¨CPUã€‚</p>

<p>è¿™é‡Œå†æ¬¡å¼ºè°ƒä¸€æ¬¡ï¼Œgoroutineä¸å†…æ ¸OSçº¿ç¨‹çš„æ˜ å°„å…³ç³»æ˜¯M:Nï¼Œè¿™æ ·å¤šä¸ªgoroutineå°±å¯ä»¥åœ¨å¤šä¸ªå†…æ ¸çº¿ç¨‹ä¸Šé¢è¿è¡Œã€‚goroutineçš„åˆ‡æ¢å¤§éƒ¨åˆ†åœºæ™¯ä¸‹éƒ½æ²¡æœ‰èµ°OSçº¿ç¨‹çš„åˆ‡æ¢æ‰€å¸¦æ¥çš„å¼€é”€ï¼Œè¿™æ ·æ•´ä½“è¿è¡Œæ•ˆç‡ç›¸æ¯”OSçº¿ç¨‹çš„è°ƒåº¦ä¼šé«˜å¾ˆå¤šï¼Œä½†æ˜¯è¿™æ ·å¸¦æ¥çš„é—®é¢˜å°±æ˜¯goroutineè°ƒåº¦æ¨¡å‹çš„å¤æ‚ã€‚
<!-- more -->
Golangçš„è°ƒåº¦æ¨¡å‹ä¸»è¦æœ‰å‡ ä¸ªä¸»è¦çš„å®ä½“ï¼šGã€Mã€Pã€schedtã€‚</p>

<p>Gï¼šä»£è¡¨ä¸€ä¸ªgoroutineå®ä½“ï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆå†…å­˜ï¼Œinstruction pointerå’Œä¸€äº›ç›¸å…³ä¿¡æ¯(æ¯”å¦‚ç­‰å¾…çš„channelç­‰ç­‰)ï¼Œæ˜¯ç”¨äºè°ƒåº¦å™¨è°ƒåº¦çš„å®ä½“ã€‚
Mï¼šä»£è¡¨ä¸€ä¸ªçœŸæ­£çš„å†…æ ¸OSçº¿ç¨‹ï¼Œå’ŒPOSIXé‡Œçš„threadå·®ä¸å¤šï¼Œå±äºçœŸæ­£æ‰§è¡ŒæŒ‡ä»¤çš„äººã€‚
Pï¼šä»£è¡¨Mè°ƒåº¦çš„ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªå±€éƒ¨çš„è°ƒåº¦å™¨ï¼Œè°ƒåº¦åç¨‹goä»£ç åœ¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¸Šè·‘ã€‚Pæ˜¯å®ç°åç¨‹ä¸å†…æ ¸çº¿ç¨‹çš„N:Mæ˜ å°„å…³ç³»çš„å…³é”®ã€‚Pçš„ä¸Šé™æ˜¯é€šè¿‡ç³»ç»Ÿå˜é‡runtime.GOMAXPROCS (numLogicalProcessors)æ¥æ§åˆ¶çš„ã€‚golangå¯åŠ¨æ—¶æ›´æ–°è¿™ä¸ªå€¼ï¼Œä¸€èˆ¬ä¸å»ºè®®ä¿®æ”¹è¿™ä¸ªå€¼ã€‚Pçš„æ•°é‡ä¹Ÿä»£è¡¨äº†golangä»£ç æ‰§è¡Œçš„å¹¶å‘åº¦ï¼Œå³æœ‰å¤šå°‘goroutineå¯ä»¥å¹¶è¡Œçš„è¿è¡Œã€‚
schedtï¼šruntimeå…¨å±€è°ƒåº¦æ—¶ä½¿ç”¨çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªå®ä½“å…¶å®åªæ˜¯ä¸€ä¸ªå£³ï¼Œé‡Œé¢ä¸»è¦æœ‰Mçš„å…¨å±€idleé˜Ÿåˆ—ï¼ŒPçš„å…¨å±€idleé˜Ÿåˆ—ï¼Œä¸€ä¸ªå…¨å±€çš„å°±ç»ªçš„Gé˜Ÿåˆ—ä»¥åŠä¸€ä¸ªruntimeå…¨å±€è°ƒåº¦å™¨çº§åˆ«çš„é”ã€‚å½“å¯¹Mæˆ–Pç­‰åšä¸€äº›éå±€éƒ¨è°ƒåº¦å™¨çš„æ“ä½œæ—¶ï¼Œä¸€èˆ¬éœ€è¦å…ˆé”ä½å…¨å±€è°ƒåº¦å™¨ã€‚
ä¸ºäº†è§£é‡Šæ¸…æ¥šè¿™å‡ ä¸ªå®ä½“ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬å…ˆæŠ½è±¡Gã€Mã€Pã€schedtçš„å…³ç³»ï¼Œä¸»è¦çš„workflowå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºå‡ ä¸ªç»“è®ºï¼š</p>

<p>æˆ‘ä»¬é€šè¿‡ go func()æ¥åˆ›å»ºä¸€ä¸ªgoroutineï¼›
æœ‰ä¸¤ä¸ªå­˜å‚¨goroutineçš„é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å±€éƒ¨è°ƒåº¦å™¨Pçš„local queueã€ä¸€ä¸ªæ˜¯å…¨å±€è°ƒåº¦å™¨æ•°æ®æ¨¡å‹schedtçš„global queueã€‚æ–°åˆ›å»ºçš„goroutineä¼šå…ˆä¿å­˜åœ¨local queueï¼Œå¦‚æœlocal queueå·²ç»æ»¡äº†å°±ä¼šä¿å­˜åœ¨å…¨å±€çš„global queueï¼›
goroutineåªèƒ½è¿è¡Œåœ¨Mä¸­ï¼Œä¸€ä¸ªMå¿…é¡»æŒæœ‰ä¸€ä¸ªPï¼ŒMä¸Pæ˜¯1ï¼š1çš„å…³ç³»ã€‚Mä¼šä»Pçš„local queueå¼¹å‡ºä¸€ä¸ªRunableçŠ¶æ€çš„goroutineæ¥æ‰§è¡Œï¼Œå¦‚æœPçš„local queueä¸ºç©ºï¼Œå°±ä¼šæ‰§è¡Œwork stealingï¼›
ä¸€ä¸ªMè°ƒåº¦goroutineæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªloopï¼›
å½“Mæ‰§è¡ŒæŸä¸€ä¸ªgoroutineæ—¶å€™å¦‚æœå‘ç”Ÿäº†syscallæˆ–åˆ™å…¶ä½™é˜»å¡æ“ä½œï¼ŒMä¼šé˜»å¡ï¼Œå¦‚æœå½“å‰æœ‰ä¸€äº›Gåœ¨æ‰§è¡Œï¼Œruntimeä¼šæŠŠè¿™ä¸ªçº¿ç¨‹Mä»Pä¸­æ‘˜é™¤(detach)ï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªæ–°çš„æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹(å¦‚æœæœ‰ç©ºé—²çš„çº¿ç¨‹å¯ç”¨å°±å¤ç”¨ç©ºé—²çº¿ç¨‹)æ¥æœåŠ¡äºè¿™ä¸ªPï¼›
å½“Mç³»ç»Ÿè°ƒç”¨ç»“æŸæ—¶å€™ï¼Œè¿™ä¸ªgoroutineä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²çš„Pæ‰§è¡Œï¼Œå¹¶æ”¾å…¥åˆ°è¿™ä¸ªPçš„local queueã€‚å¦‚æœè·å–ä¸åˆ°Pï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹Mä¼šparkå®ƒè‡ªå·±(ä¼‘çœ )ï¼Œ åŠ å…¥åˆ°ç©ºé—²çº¿ç¨‹ä¸­ï¼Œç„¶åè¿™ä¸ªgoroutineä¼šè¢«æ”¾å…¥schedtçš„global queueã€‚
Goè¿è¡Œæ—¶ä¼šåœ¨ä¸‹é¢çš„goroutineè¢«é˜»å¡çš„æƒ…å†µä¸‹è¿è¡Œå¦å¤–ä¸€ä¸ªgoroutineï¼š</p>

<p>syscallã€
network inputã€
channel operationsã€
primitives in the sync packageã€‚
3.è°ƒåº¦æ ¸å¿ƒé—®é¢˜
å‰é¢å·²ç»å¤§è‡´ä»‹ç»äº†schedulerçš„ä¸€äº›æ ¸å¿ƒè°ƒåº¦åŸç†ï¼Œä»‹ç»çš„éƒ½æ˜¯æ¯”è¾ƒæŠ½è±¡çš„å†…å®¹ã€‚å¬ä¸‹æ¥è¿˜æœ‰å‡ ä¸ªç–‘é—®éœ€è¦åˆ†æï¼Œä¸»è¦é€šè¿‡åé¢çš„æºç æ¥è¿›è¡Œç»†è‡´åˆ†æã€‚</p>

<p>Question1ï¼šå¦‚æœä¸€ä¸ªgoroutineä¸€ç›´å æœ‰CPUåˆä¸ä¼šæœ‰é˜»å¡æˆ–åˆ™ä¸»åŠ¨è®©å‡ºCPUçš„è°ƒåº¦ï¼Œscheduleræ€ä¹ˆåšæŠ¢å å¼è°ƒåº¦è®©å‡ºCPUï¼Ÿ
Answer1ï¼šæœ‰ä¸€ä¸ªsysmonçº¿ç¨‹åšæŠ¢å å¼è°ƒåº¦ï¼Œå½“ä¸€ä¸ªgoroutineå ç”¨CPUè¶…è¿‡10msä¹‹åï¼Œè°ƒåº¦å™¨ä¼šæ ¹æ®å®é™…æƒ…å†µæä¾›ä¸ä¿è¯çš„åç¨‹åˆ‡æ¢æœºåˆ¶ï¼Œå…·ä½“ç»†èŠ‚è§åé¢æºç åˆ†æã€‚</p>

<p>Question2ï¼šæˆ‘ä»¬çŸ¥é“Pçš„ä¸Šé™æ˜¯ç³»ç»Ÿå¯åŠ¨æ—¶å€™è®¾å®šçš„å¹¶ä¸”ä¸€èˆ¬ä¸ä¼šæ›´æ”¹ï¼Œé‚£ä¹ˆå†…æ ¸çº¿ç¨‹Mä¸Šé™æ˜¯å¤šå°‘ï¼Ÿé‡åˆ°éœ€è¦æ–°çš„Mæ—¶å€™æ˜¯é€‰å–IDELçš„Mè¿˜æ˜¯åˆ›å»ºæ–°çš„Mï¼Œæ•´ä½“ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ
Answer2ï¼šåœ¨golangç³»ç»Ÿå¯åŠ¨æ—¶å€™ä¼šè®¾ç½®å†…æ ¸çº¿ç¨‹ä¸Šé™æ˜¯10000ï¼Œè¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹ï¼ŒMçš„æ•°é‡ä¸Pçš„æ•°é‡å’ŒGçš„æ•°é‡æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå®é™…æƒ…å†µè¦çœ‹è°ƒåº¦å™¨çš„æ‰§è¡Œæƒ…å†µã€‚
è‡³äºå…·ä½“çš„ç­–ç•¥è§åé¢çš„æºç åˆ†æã€‚</p>

<p>Question3ï¼šPã€Mã€Gçš„çŠ¶æ€æœºè¿è½¬ï¼Œä¸»è¦æ˜¯åç¨‹å¯¹è±¡Gã€‚
Answer3ï¼šçŠ¶æ€æœºè§åé¢çš„æºç åˆ†æ</p>

<p>Question4ï¼šæ¯ä¸€ä¸ªåç¨‹goroutineçš„æ ˆç©ºé—´æ˜¯ä¿å­˜åœ¨å“ªé‡Œçš„ï¼ŸPã€Mã€Gåˆ†åˆ«ç»´æŠ¤çš„ä¸å†…å­˜æœ‰å…³çš„æ•°æ®æœ‰å“ªäº›ï¼Ÿ
Answer4ï¼šgolang scheduler use thrid-level cacheï¼Œeach goroutine stack space is applied in heapã€‚</p>

<p>Question5ï¼šå½“syscallã€ç½‘ç»œIOã€channelæ—¶ï¼Œå¦‚æœè¿™äº›é˜»å¡è¿”å›äº†ï¼Œå¯¹åº”çš„Gä¼šè¢«ä¿å­˜åœ¨å“ªä¸ªåœ°æ–¹ï¼Ÿglobal Queueæˆ–åˆ™æ˜¯local queue? ä¸ºä»€ä¹ˆï¼Ÿç³»ç»Ÿåˆå§‹åŒ–æ—¶å€™çš„Gä¼šè¢«ä¿å­˜åœ¨å“ªé‡Œï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
Answer5ï¼šå”¤é†’çš„Mé¦–å…ˆä¼šå°è¯•è·å–ä¸€ä¸ªç©ºé—²Pï¼Œç„¶åå°†Gæ”¾åˆ°Pçš„local queueï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œå°±æ”¾è¿› global queueï¼Œç„¶åMè‡ªå·±æ”¾è¿›the M idle åˆ—è¡¨ã€‚</p>

<p>Noticeï¼šschedulerçš„æºç ä¸»è¦åœ¨ä¸¤ä¸ªæ–‡ä»¶ï¼š</p>

<p>runtime/runtime2.go ä¸»è¦æ˜¯å®ä½“Gã€Mã€Pã€schedtçš„æ•°æ®æ¨¡å‹
runtime/proc.go ä¸»è¦æ˜¯è°ƒåº¦å®ç°çš„é€»è¾‘éƒ¨åˆ†ã€‚
Section2 ä¸»è¦æ¨¡å‹çš„æºç åˆ†æ
è¿™ä¸€éƒ¨åˆ†ä¸»è¦ç»“åˆæºç è¿›è¡Œåˆ†æï¼Œä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä»‹ç»ä¸»è¦æ¨¡å‹Gã€Mã€Pã€schedtçš„èŒè´£ã€ç»´æŠ¤çš„æ•°æ®åŸŸä»¥åŠå®ƒä»¬çš„è”ç³»ã€‚</p>

<p>2.1 å®ä½“M
å®ä½“Måœ¨æ¨¡å‹ä¸Šç­‰åŒäºç³»ç»Ÿå†…æ ¸OSçº¿ç¨‹ï¼ŒMè¿è¡Œçš„goä»£ç ç±»å‹æœ‰ä¸¤ç§ï¼š</p>

<p>goroutineä»£ç , Mè¿è¡Œgoä»£ç éœ€è¦ä¸€ä¸ªå®ä½“Pè¿›è¡Œå±€éƒ¨è°ƒåº¦ï¼›
åŸç”Ÿä»£ç , ä¾‹å¦‚é˜»å¡çš„syscall, Mè¿è¡ŒåŸç”Ÿä»£ç ä¸éœ€è¦P
Mä¼šä»runqueue(local or global)ä¸­æŠ½å–Gå¹¶è¿è¡Œï¼Œå¦‚æœGè¿è¡Œå®Œæ¯•æˆ–åˆ™Gè¿›å…¥äº†ç¡çœ æ€ï¼Œå°±ä¼šä»runqueueä¸­å–å‡ºä¸‹ä¸€ä¸ªrunnableçŠ¶æ€çš„Gè¿è¡Œ, å¾ªç¯è°ƒåº¦ã€‚</p>

<p>Gæœ‰æ—¶ä¼šæ‰§è¡Œä¸€äº›é˜»å¡è°ƒç”¨(syscall)ï¼Œè¿™æ—¶Mä¼šé‡Šæ”¾æŒæœ‰çš„På¹¶è¿›å…¥é˜»å¡æ€ï¼Œå…¶ä»–çš„Mä¼šå–å¾—è¿™ä¸ªidelçŠ¶æ€çš„På¹¶ç»§ç»­è¿è¡Œé˜Ÿåˆ—ä¸­çš„Gã€‚Golangéœ€è¦ä¿è¯æœ‰è¶³å¤Ÿçš„Må¯ä»¥è¿è¡ŒG, ä¸è®©CPUé—²ç€, ä¹Ÿéœ€è¦ä¿è¯Mçš„æ•°é‡ä¸èƒ½è¿‡å¤šã€‚é€šå¸¸åˆ›å»ºä¸€ä¸ªMçš„åŸå› æ˜¯ç”±äºæ²¡æœ‰è¶³å¤Ÿçš„Mæ¥å…³è”På¹¶è¿è¡Œå…¶ä¸­å¯è¿è¡Œçš„Gã€‚è€Œä¸”è¿è¡Œæ—¶ç³»ç»Ÿæ‰§è¡Œç³»ç»Ÿç›‘æ§çš„æ—¶å€™ï¼Œæˆ–è€…GCçš„æ—¶å€™ä¹Ÿä¼šåˆ›å»ºMã€‚</p>

<p>Mç»“æ„ä½“å®šä¹‰åœ¨runtime2.goå¦‚ä¸‹ï¼š</p>

<p>type m struct {
	/*
        1.  æ‰€æœ‰è°ƒç”¨æ ˆçš„Goroutine,è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„Goroutineã€‚
        2.  æ™®é€šçš„Goroutineæ ˆæ˜¯åœ¨Heapåˆ†é…çš„å¯å¢é•¿çš„stack,è€Œg0çš„stackæ˜¯Må¯¹åº”çš„çº¿ç¨‹æ ˆã€‚
        3.  æ‰€æœ‰ä¸è°ƒåº¦ç›¸å…³çš„ä»£ç ,éƒ½ä¼šå…ˆåˆ‡æ¢åˆ°g0çš„æ ˆå†æ‰§è¡Œã€‚
    */
	g0      *g     // goroutine with scheduling stack
	morebuf gobuf  // gobuf arg to morestack
	divmod  uint32 // div/mod denominator for arm - known to liblink</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Fields not known to debuggers.
procid        uint64       // for debuggers, but offset not hard-coded
gsignal       *g           // signal-handling g
goSigStack    gsignalStack // Go-allocated signal handling stack
sigmask       sigset       // storage for saved signal mask
tls           [6]uintptr   // thread-local storage (for x86 extern register)
// è¡¨ç¤ºMçš„èµ·å§‹å‡½æ•°ã€‚å…¶å®å°±æ˜¯æˆ‘ä»¬ go è¯­å¥æºå¸¦çš„é‚£ä¸ªå‡½æ•°ã€‚
mstartfn      func()
// Mä¸­å½“å‰è¿è¡Œçš„goroutine
curg          *g       // current running goroutine
caughtsig     guintptr // goroutine running during fatal signal
// ä¸Mç»‘å®šçš„Pï¼Œå¦‚æœä¸ºnilè¡¨ç¤ºç©ºé—²
p             puintptr // attached p for executing go code (nil if not executing go code)
// ç”¨äºæš‚å­˜äºå½“å‰Mæœ‰æ½œåœ¨å…³è”çš„Pã€‚ ï¼ˆé¢„è”ï¼‰å½“Mé‡æ–°å¯åŠ¨æ—¶ï¼Œå³ç”¨é¢„è”çš„è¿™ä¸ªPåšå…³è”å•¦
nextp         puintptr
id            int64
mallocing     int32
throwing      int32
// å½“å‰mæ˜¯å¦å…³é—­æŠ¢å å¼è°ƒåº¦
preemptoff    string // if != "", keep curg running on this m
/**  */
locks         int32
dying         int32
profilehz     int32
// ä¸ä¸º0è¡¨ç¤ºæ­¤måœ¨åšå¸®å¿™gcã€‚helpgcç­‰äºnåªæ˜¯ä¸€ä¸ªç¼–å·
helpgc        int32
// è‡ªæ—‹çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰Mæ˜¯å¦æ­£åœ¨è‡ªæ—‹å¯»æ‰¾Gã€‚åœ¨å¯»æ‰¾è¿‡ç¨‹ä¸­Må¤„äºè‡ªæ—‹çŠ¶æ€ã€‚
spinning      bool // m is out of work and is actively looking for work
blocked       bool // m is blocked on a note
inwb          bool // m is executing a write barrier
newSigstack   bool // minit on C thread called sigaltstack
printlock     int8
incgo         bool   // m is executing a cgo call
freeWait      uint32 // if == 0, safe to free g0 and delete m (atomic)
fastrand      [2]uint32
needextram    bool
traceback     uint8
ncgocall      uint64      // number of cgo calls in total
ncgo          int32       // number of cgo calls currently in progress
cgoCallersUse uint32      // if non-zero, cgoCallers in use temporarily
cgoCallers    *cgoCallers // cgo traceback if crashing in cgo call
park          note
//è¿™ä¸ªåŸŸç”¨äºé“¾æ¥allm
alllink       *m // on allm
schedlink     muintptr
mcache        *mcache
// è¡¨ç¤ºä¸å½“å‰Mé”å®šçš„é‚£ä¸ªGã€‚è¿è¡Œæ—¶ç³»ç»Ÿä¼šæŠŠ ä¸€ä¸ªM å’Œä¸€ä¸ªGé”å®šï¼Œä¸€æ—¦é”å®šå°±åªèƒ½åŒæ–¹ç›¸äº’ä½œç”¨ï¼Œä¸æ¥å—ç¬¬ä¸‰è€…ã€‚
lockedg       guintptr
createstack   [32]uintptr    // stack that created this thread.
lockedExt     uint32         // tracking for external LockOSThread
lockedInt     uint32         // tracking for internal lockOSThread
nextwaitm     muintptr       // next m waiting for lock
waitunlockf   unsafe.Pointer // todo go func(*g, unsafe.pointer) bool
waitlock      unsafe.Pointer
waittraceev   byte
waittraceskip int
startingtrace bool
syscalltick   uint32
thread        uintptr // thread handle
freelink      *m      // on sched.freem

// these are here because they are too large to be on the stack
// of low-level NOSPLIT functions.
libcall   libcall
libcallpc uintptr // for cpu profiler
libcallsp uintptr
libcallg  guintptr
syscall   libcall // stores syscall parameters on windows

vdsoSP uintptr // SP for traceback while in VDSO call (0 if not in call)
vdsoPC uintptr // PC for traceback while in VDSO call

mOS } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 ä¸Šé¢å­—æ®µå¾ˆå¤šï¼Œæ ¸å¿ƒçš„ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ä¸ªå­—æ®µï¼š
</code></pre></div></div>

<p>g0      *g     // goroutine with scheduling stackï¼Œä¹Ÿæ˜¯è¿è¡Œå±€éƒ¨è°ƒåº¦å™¨çš„g
mstartfn      func()
curg          *g       // current running goroutine
p             puintptr // attached p for executing go code (nil if not executing go code)
nextp         puintptr
helpgc        int32
spinning      bool // m is out of work and is actively looking for work
alllink       *m // on allm
lockedg       guintptr
1
2
3
4
5
6
7
8
9
è¿™äº›å­—æ®µä¸»è¦åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

<p>g0: Golang runtimeç³»ç»Ÿåœ¨çº¿ç¨‹åˆ›å»ºçš„æ—¶å€™åˆ›å»ºçš„ï¼Œg0çš„æ ˆä½¿ç”¨çš„æ˜¯å†…æ ¸çº¿ç¨‹çš„æ ˆï¼Œä¸»è¦ç”¨äºå±€éƒ¨è°ƒåº¦å™¨æ‰§è¡Œè°ƒåº¦é€»è¾‘æ—¶ä½¿ç”¨çš„æ ˆï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œè°ƒåº¦é€»è¾‘æ—¶çš„çº¿ç¨‹æ ˆã€‚
mstartfnï¼šè¡¨ç¤ºMçš„èµ·å§‹å‡½æ•°ã€‚å…¶å®å°±æ˜¯æˆ‘ä»¬ go å…³é”®å­—åé¢æºå¸¦çš„é‚£ä¸ªå‡½æ•°ã€‚
curgï¼šå­˜æ”¾å½“å‰æ­£åœ¨è¿è¡Œçš„Gçš„æŒ‡é’ˆã€‚
pï¼šæŒ‡å‘å½“å‰ä¸Må…³è”çš„é‚£ä¸ªPã€‚
nextpï¼šç”¨äºæš‚å­˜äºå½“å‰Mæœ‰æ½œåœ¨å…³è”çš„Pã€‚ ï¼ˆé¢„è”ï¼‰å½“Mé‡æ–°å¯åŠ¨æ—¶ï¼Œå³ç”¨é¢„è”çš„è¿™ä¸ªPåšå…³è”å•¦
spinningï¼šè‡ªæ—‹çŠ¶æ€æ ‡å¿—ä½ï¼Œè¡¨ç¤ºå½“å‰Mæ˜¯å¦æ­£åœ¨å¯»æ‰¾Gã€‚
alllinkï¼šè¿æ¥åˆ°æ‰€æœ‰çš„mé“¾è¡¨çš„ä¸€ä¸ªæŒ‡é’ˆã€‚
lockedgï¼šè¡¨ç¤ºä¸å½“å‰Mé”å®šçš„é‚£ä¸ªGã€‚è¿è¡Œæ—¶ç³»ç»Ÿä¼šæŠŠ ä¸€ä¸ªM å’Œä¸€ä¸ªGé”å®šï¼Œä¸€æ—¦é”å®šå°±åªèƒ½åŒæ–¹ç›¸äº’ä½œç”¨ï¼Œä¸æ¥å—ç¬¬ä¸‰è€…ã€‚
Mçš„çŠ¶æ€æœºæ¯”è¾ƒç®€å•ï¼Œå› ä¸ºMæ˜¯golangå¯¹å†…æ ¸OSçº¿ç¨‹çš„æ›´ä¸Šä¸€å±‚æŠ½è±¡ï¼Œæ‰€ä»¥Mä¹Ÿæ²¡æœ‰ä¸“é—¨å­—æ®µæ¥ç»´æŠ¤çŠ¶æ€ï¼Œç®€å•æ¥è¯´æœ‰ä¸€ä¸‹å‡ ç§çŠ¶æ€ï¼š</p>

<p>è‡ªæ—‹ä¸­(spinning): Mæ­£åœ¨ä»è¿è¡Œé˜Ÿåˆ—è·å–G, è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªPï¼›
æ‰§è¡Œgoä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡Œgoä»£ç , è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªPï¼›
æ‰§è¡ŒåŸç”Ÿä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡ŒåŸç”Ÿä»£ç æˆ–è€…é˜»å¡çš„syscall, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰Pï¼›
ä¼‘çœ ä¸­: Må‘ç°æ— å¾…è¿è¡Œçš„Gæ—¶ä¼šè¿›å…¥ä¼‘çœ ï¼Œå¹¶æ·»åŠ åˆ°ç©ºé—²Mé“¾è¡¨ä¸­, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰Pã€‚
ä¸Šé¢çš„å‡ ç§çŠ¶æ€ä¸­ï¼Œspinningè¿™ä¸ªçŠ¶æ€éå¸¸é‡è¦ï¼Œæ˜¯å¦éœ€è¦å”¤é†’æˆ–è€…åˆ›å»ºæ–°çš„Må–å†³äºå½“å‰è‡ªæ—‹ä¸­çš„Mçš„æ•°é‡ã€‚</p>

<p>Måœ¨è¢«åˆ›å»ºä¹‹åˆä¼šè¢«åŠ å…¥åˆ°å…¨å±€çš„Måˆ—è¡¨ ã€runtime.allmã€‘ã€‚ æ¥ç€ï¼ŒMçš„èµ·å§‹å‡½æ•°ï¼ˆmstartfnï¼‰å’Œå‡†å¤‡å…³è”çš„Péƒ½ä¼šè¢«è®¾ç½®ã€‚æœ€åï¼Œruntimeä¼šä¸ºMä¸“é—¨åˆ›å»ºä¸€ä¸ªæ–°çš„å†…æ ¸çº¿ç¨‹å¹¶ä¸ä¹‹å…³è”ã€‚è¿™æ—¶å€™è¿™ä¸ªæ–°çš„Må°±ä¸ºæ‰§è¡ŒGåšå¥½äº†å‡†å¤‡ã€‚å…¶ä¸­èµ·å§‹å‡½æ•°ï¼ˆmstartfnï¼‰ä»…å½“runtimeè¦ç”¨æ­¤Mæ‰§è¡Œç³»ç»Ÿç›‘æ§æˆ–è€…åƒåœ¾å›æ”¶ç­‰ä»»åŠ¡çš„æ—¶å€™æ‰ä¼šè¢«è®¾ç½®ã€‚ã€runtime.allmã€‘çš„ä½œç”¨æ˜¯runtimeåœ¨éœ€è¦çš„æ—¶å€™ä¼šé€šè¿‡å®ƒè·å–åˆ°æ‰€æœ‰çš„Mçš„ä¿¡æ¯ï¼ŒåŒæ—¶é˜²æ­¢Mè¢«gcã€‚</p>

<p>åœ¨æ–°çš„Mè¢«åˆ›å»ºåä¼šåšä¸€äº›åˆå§‹åŒ–å·¥ä½œã€‚å…¶ä¸­åŒ…æ‹¬äº†å¯¹è‡ªèº«æ‰€æŒçš„æ ˆç©ºé—´ä»¥åŠä¿¡å·çš„åˆå§‹åŒ–ã€‚åœ¨ä¸Šè¿°åˆå§‹åŒ–å®Œæˆå mstartfn å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œ (å¦‚æœå­˜åœ¨çš„è¯)ã€‚ã€æ³¨æ„ã€‘ï¼šå¦‚æœmstartfn ä»£è¡¨çš„æ˜¯ç³»ç»Ÿç›‘æ§ä»»åŠ¡çš„è¯ï¼Œé‚£ä¹ˆè¯¥Mä¼šä¸€ç›´åœ¨æ‰§è¡Œmstartfn è€Œä¸ä¼šæœ‰åç»­çš„æµç¨‹ã€‚å¦åˆ™ mstartfn æ‰§è¡Œå®Œåï¼Œå½“å‰Må°†ä¼šä¸é‚£ä¸ªå‡†å¤‡ä¸ä¹‹å…³è”çš„På®Œæˆå…³è”ã€‚è‡³æ­¤ï¼Œä¸€ä¸ªå¹¶å‘æ‰§è¡Œç¯å¢ƒæ‰çœŸæ­£å®Œæˆã€‚ä¹‹åå°±æ˜¯Må¼€å§‹å¯»æ‰¾å¯è¿è¡Œçš„Gå¹¶è¿è¡Œä¹‹ã€‚</p>

<p>runtimeç®¡è¾–çš„Mä¼šåœ¨GCä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™è¢«åœæ­¢ï¼Œè¿™æ—¶å€™ç³»ç»Ÿä¼šå¯¹Mçš„å±æ€§åšæŸäº›å¿…è¦çš„é‡ç½®å¹¶æŠŠMæ”¾ç½®å…¥å…¨å±€è°ƒåº¦å™¨çš„ç©ºé—²Måˆ—è¡¨ã€‚ã€å¾ˆé‡è¦ã€‘å› ä¸ºè°ƒåº¦å™¨åœ¨éœ€è¦ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„Mæ—¶ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿä¼šå…ˆå»è¿™ä¸ªç©ºé—²åˆ—è¡¨è·å–Mã€‚(åªæœ‰éƒ½æ²¡æœ‰çš„æ—¶å€™æ‰ä¼šåˆ›å»ºM)</p>

<p>Mæœ¬èº«æ˜¯æ— çŠ¶æ€çš„ã€‚Mæ˜¯å¦æ˜¯ç©ºé—²æ€ä»…æ ¹æ®å®ƒæ˜¯å¦å­˜åœ¨äºè°ƒåº¦å™¨çš„ç©ºé—²Måˆ—è¡¨ ã€runtime.sched.midleã€‘ ä¸­æ¥åˆ¤å®šï¼ˆæ³¨æ„ï¼šç©ºé—²åˆ—è¡¨ä¸æ˜¯é‚£ä¸ªå…¨å±€åˆ—è¡¨ï¼‰ã€‚</p>

<p>å•ä¸ªGoç¨‹åºæ‰€ä½¿ç”¨çš„Mçš„æœ€å¤§æ•°é‡æ˜¯å¯ä»¥è¢«è®¾ç½®çš„ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨å‘½ä»¤è¿è¡ŒGoç¨‹åºæ—¶å€™ï¼Œæœ‰ä¸€ä¸ªå¼•å¯¼ç¨‹åºå…ˆä¼šè¢«å¯åŠ¨çš„ã€‚åœ¨è¿™ä¸ªå¼•å¯¼ç¨‹åºä¸­ä¼šä¸ºGoç¨‹åºçš„è¿è¡Œå»ºç«‹å¿…è¦çš„ç¯å¢ƒã€‚å¼•å¯¼ç¨‹åºå¯¹Mçš„æ•°é‡è¿›è¡Œåˆå§‹åŒ–è®¾ç½®ï¼Œé»˜è®¤æœ€å¤§å€¼æ˜¯10000ã€ä¸€ä¸ªGoç¨‹åºæœ€å¤šå¯ä»¥ä½¿ç”¨10000ä¸ªMï¼Œå³ï¼šç†æƒ³çŠ¶æ€ä¸‹ï¼Œå¯ä»¥åŒæ—¶æœ‰1Wä¸ªå†…æ ¸çº¿ç¨‹è¢«åŒæ—¶è¿è¡Œã€‘ã€‚å¯ä»¥ä½¿ç”¨ runtime/debug.SetMaxThreads() å‡½æ•°è®¾ç½®ã€‚</p>

<p>2.2 å®ä½“P(processor)
Pæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå¹¶ä¸ä»£è¡¨ä¸€ä¸ªå…·ä½“çš„å®ä½“ï¼ŒæŠ½è±¡åœ°è¡¨ç¤ºMè¿è¡ŒGæ‰€éœ€è¦çš„èµ„æºã€‚På¹¶ä¸ä»£è¡¨CPUæ ¸å¿ƒæ•°ï¼Œè€Œæ˜¯è¡¨ç¤ºæ‰§è¡Œgoä»£ç çš„å¹¶å‘åº¦ã€‚æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰§è¡ŒåŸç”Ÿä»£ç çš„æ—¶å€™å¹¶ä¸å—Pæ•°é‡çš„é™åˆ¶ã€‚</p>

<p>åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹(M)å¯ä»¥æ‹¥æœ‰Pï¼Œ å±€éƒ¨è°ƒåº¦å™¨Pç»´æŠ¤çš„æ•°æ®éƒ½æ˜¯é”è‡ªç”±(lock free)çš„, è¯»å†™è¿™äº›æ•°æ®çš„æ•ˆç‡ä¼šéå¸¸çš„é«˜ã€‚</p>

<p>Pæ˜¯ä½¿Gèƒ½å¤Ÿåœ¨Mä¸­è¿è¡Œçš„å…³é”®ã€‚Goçš„runtimeé€‚å½“åœ°è®©Pä¸ä¸åŒçš„Må»ºç«‹æˆ–è€…æ–­å¼€è”ç³»ï¼Œä»¥ä½¿å¾—Pä¸­çš„é‚£äº›å¯è¿è¡Œçš„Gèƒ½å¤Ÿåœ¨éœ€è¦çš„æ—¶å€™åŠæ—¶è·å¾—è¿è¡Œæ—¶æœºã€‚</p>

<p>Pç»“æ„ä½“å®šä¹‰åœ¨runtime2.goå¦‚ä¸‹ï¼š</p>

<p>type p struct {
	lock mutex</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>id          int32
// å½“å‰pçš„çŠ¶æ€
status      uint32 // one of pidle/prunning/...
// é“¾æ¥
link        puintptr
schedtick   uint32     // incremented on every scheduler call
syscalltick uint32     // incremented on every system call
sysmontick  sysmontick // last tick observed by sysmon
// påå‘é“¾æ¥åˆ°å…³è”çš„m(ç©ºé—²æ—¶ä¸ºnil)
m           muintptr   // back-link to associated m (nil if idle)
mcache      *mcache
racectx     uintptr

deferpool    [5][]*_defer // pool of available defer structs of different sizes (see panic.go)
deferpoolbuf [5][32]*_defer

// Cache of goroutine ids, amortizes accesses to runtimeÂ·sched.goidgen.
goidcache    uint64
goidcacheend uint64

// Queue of runnable goroutines. Accessed without lock.
runqhead uint32
runqtail uint32
runq     [256]guintptr
// runnext, if non-nil, is a runnable G that was ready'd by
// the current G and should be run next instead of what's in
// runq if there's time remaining in the running G's time
// slice. It will inherit the time left in the current time
// slice. If a set of goroutines is locked in a
// communicate-and-wait pattern, this schedules that set as a
// unit and eliminates the (potentially large) scheduling
// latency that otherwise arises from adding the ready'd
// goroutines to the end of the run queue.
runnext guintptr

// Available G's (status == Gdead)
gfree    *g
gfreecnt int32

sudogcache []*sudog
sudogbuf   [128]*sudog

tracebuf traceBufPtr

// traceSweep indicates the sweep events should be traced.
// This is used to defer the sweep start event until a span
// has actually been swept.
traceSweep bool
// traceSwept and traceReclaimed track the number of bytes
// swept and reclaimed by sweeping in the current sweep loop.
traceSwept, traceReclaimed uintptr

palloc persistentAlloc // per-P to avoid mutex

// Per-P GC state
gcAssistTime         int64 // Nanoseconds in assistAlloc
gcFractionalMarkTime int64 // Nanoseconds in fractional mark worker
gcBgMarkWorker       guintptr
gcMarkWorkerMode     gcMarkWorkerMode

// gcMarkWorkerStartTime is the nanotime() at which this mark
// worker started.
gcMarkWorkerStartTime int64

// gcw is this P's GC work buffer cache. The work buffer is
// filled by write barriers, drained by mutator assists, and
// disposed on certain GC state transitions.
gcw gcWork

// wbBuf is this P's GC write barrier buffer.
//
// TODO: Consider caching this in the running G.
wbBuf wbBuf

runSafePointFn uint32 // if 1, run sched.safePointFn at next safe point

pad [sys.CacheLineSize]byte } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 è¿™äº›å­—æ®µé‡Œé¢æ¯”è¾ƒæ ¸å¿ƒçš„å­—æ®µå¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>lock mutex
status      uint32 // one of pidle/prunning/â€¦
link        puintptr
m           muintptr   // back-link to associated m (nil if idle)
// local runnable queue. Accessed without lock. implement through array
runqhead uint32
runqtail uint32
runq     [256]guintptr
runnext guintptr
// Available Gâ€™s (status == Gdead)
gfree    *g
1
2
3
4
5
6
7
8
9
10
11
é€šè¿‡runtime.GOMAXPROCSå‡½æ•°æˆ‘ä»¬å¯ä»¥æ”¹å˜å•ä¸ªGoç¨‹åºå¯ä»¥æ‹¥æœ‰Pçš„æœ€å¤§æ•°é‡ï¼Œå¦‚æœä¸åšè®¾ç½®ä¼šæœ‰ä¸€ä¸ªé»˜è®¤å€¼ã€‚</p>

<p>æ¯ä¸€ä¸ªPéƒ½å¿…é¡»å…³è”ä¸€ä¸ªMæ‰èƒ½ä½¿å…¶ä¸­çš„Gå¾—ä»¥è¿è¡Œã€‚</p>

<p>ã€æ³¨æ„ã€‘ï¼šruntimeä¼šå°†Mä¸å…³è”çš„Påˆ†ç¦»å¼€æ¥ã€‚ä½†æ˜¯å¦‚æœè¯¥Pçš„runqueueä¸­è¿˜æœ‰æœªè¿è¡Œçš„Gï¼Œé‚£ä¹ˆruntimeå°±ä¼šæ‰¾åˆ°ä¸€ä¸ªç©ºçš„Mï¼ˆåœ¨è°ƒåº¦å™¨çš„ç©ºé—²é˜Ÿåˆ—ä¸­çš„Mï¼‰ æˆ–è€…åˆ›å»ºä¸€ä¸ªç©ºçš„Mï¼Œå¹¶ä¸è¯¥På…³è”èµ·æ¥ï¼ˆä¸ºäº†è¿è¡ŒGè€Œåšå‡†å¤‡ï¼‰ã€‚</p>

<p>runtime.GOMAXPROCSåªèƒ½å¤Ÿè®¾ç½®Pçš„æ•°é‡ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°Mï¼ˆå†…æ ¸çº¿ç¨‹ï¼‰æ•°é‡ï¼Œæ‰€ä»¥runtime.GOMAXPROCSä¸æ˜¯æ§åˆ¶çº¿ç¨‹æ•°ï¼Œåªèƒ½å½±å“å±€éƒ¨è°ƒåº¦å™¨Pçš„æ•°é‡ã€‚</p>

<p>åœ¨runtimeåˆå§‹åŒ–æ—¶ä¼šç¡®è®¤Pçš„æœ€å¤§æ•°é‡ï¼Œä¹‹åä¼šæ ¹æ®è¿™ä¸ªæœ€å¤§å€¼åˆå§‹åŒ–å…¨å±€Påˆ—è¡¨ã€runtime.allpã€‘ã€‚ç±»ä¼¼å…¨å±€Måˆ—è¡¨ï¼Œã€runtime.allpã€‘åŒ…å«äº†runtimeåˆ›å»ºçš„æ‰€æœ‰Pã€‚éšåï¼Œruntimeä¼šæŠŠè°ƒåº¦å™¨çš„å¯è¿è¡ŒGé˜Ÿåˆ—ã€runtime.schedt.runqã€‘ä¸­çš„æ‰€æœ‰Gå‡åŒ€çš„æ”¾å…¥å…¨å±€çš„Påˆ—è¡¨ä¸­çš„å„ä¸ªPçš„å¯æ‰§è¡ŒGé˜Ÿåˆ— local queueä¸­ã€‚åˆ°è¿™é‡Œä¸ºæ­¢ï¼Œruntimeéœ€è¦ç”¨åˆ°çš„æ‰€æœ‰Péƒ½å‡†å¤‡å°±ç»ªäº†ã€‚</p>

<p>ç±»ä¼¼Mçš„ç©ºé—²åˆ—è¡¨ï¼Œè°ƒåº¦å™¨ä¹Ÿå­˜åœ¨ä¸€ä¸ªç©ºé—²Pçš„åˆ—è¡¨ã€runtime.shcedt.pidleã€‘ï¼Œå½“ä¸€ä¸ªPä¸å†ä¸ä»»ä½•Må…³è”çš„æ—¶å€™ï¼Œruntimeä¼šæŠŠè¯¥Pæ”¾å…¥è¿™ä¸ªåˆ—è¡¨ï¼Œè€Œä¸€ä¸ªç©ºé—²çš„På…³è”äº†æŸä¸ªMä¹‹åä¼šè¢«ä»ã€runtime.shcedt.pidleã€‘ä¸­å–å‡ºæ¥ã€‚ã€æ³¨æ„ï¼šä¸€ä¸ªPåŠ å…¥äº†ç©ºé—²åˆ—è¡¨ï¼Œå…¶Gçš„å¯è¿è¡Œlocal queueä¹Ÿä¸ä¸€å®šä¸ºç©ºã€‘ã€‚</p>

<p>å’ŒMä¸åŒï¼ŒPæ˜¯æœ‰çŠ¶æ€æœºçš„ï¼ˆäº”ç§ï¼‰ï¼š</p>

<p>Pidelï¼šå½“å‰Pæœªå’Œä»»ä½•Må…³è”
Prunningï¼šå½“å‰På·²ç»å’ŒæŸä¸ªMå…³è”ï¼ŒMåœ¨æ‰§è¡ŒæŸä¸ªG
Psyscallï¼šå½“å‰Pä¸­çš„è¢«è¿è¡Œçš„é‚£ä¸ªGæ­£åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨
Pgcstopï¼šruntimeæ­£åœ¨è¿›è¡ŒGCï¼ˆruntimeä¼šåœ¨gcæ—¶è¯•å›¾æŠŠå…¨å±€Påˆ—è¡¨ä¸­çš„Péƒ½å¤„äºæ­¤ç§çŠ¶æ€ï¼‰
Pdeadï¼šå½“å‰På·²ç»ä¸å†è¢«ä½¿ç”¨ï¼ˆåœ¨è°ƒç”¨runtime.GOMAXPROCSå‡å°‘Pçš„æ•°é‡æ—¶ï¼Œå¤šä½™çš„På°±å¤„äºæ­¤çŠ¶æ€ï¼‰
åœ¨å¯¹Påˆå§‹åŒ–çš„æ—¶å€™å°±æ˜¯Pgcstopçš„çŠ¶æ€ï¼Œä½†æ˜¯è¿™ä¸ªçŠ¶æ€ä¿æŒæ—¶é—´å¾ˆçŸ­ï¼Œåœ¨åˆå§‹åŒ–å¹¶å¡«å……Pä¸­çš„Gé˜Ÿåˆ—ä¹‹åï¼Œruntimeä¼šå°†å…¶çŠ¶æ€ç½®ä¸ºPidleå¹¶æ”¾å…¥è°ƒåº¦å™¨çš„ç©ºé—²Påˆ—è¡¨ã€runtime.schedt.pidleã€‘ä¸­ï¼Œå…¶ä¸­çš„Pä¼šç”±è°ƒåº¦å™¨æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œå–ç”¨ã€‚å…·ä½“çš„çŠ¶æ€æœºæµè½¬å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé™¤äº†PdeadçŠ¶æ€ä»¥å¤–çš„å…¶ä½™çŠ¶æ€ï¼Œåœ¨runtimeè¿›è¡ŒGCçš„æ—¶å€™ï¼ŒPéƒ½ä¼šè¢«æŒ‡å®šæˆPgcstopã€‚åœ¨GCç»“æŸåçŠ¶æ€ä¸ä¼šå›å¤åˆ°GCå‰çš„çŠ¶æ€ï¼Œè€Œæ˜¯éƒ½ç»Ÿä¸€ç›´æ¥è½¬åˆ°äº†Pidle ã€è¿™æ„å‘³ç€ï¼Œä»–ä»¬éƒ½éœ€è¦è¢«é‡æ–°è°ƒåº¦ã€‘ã€‚</p>

<p>ã€æ³¨æ„ã€‘é™¤äº†Pgcstop çŠ¶æ€çš„Pï¼Œå…¶ä»–çŠ¶æ€çš„Péƒ½ä¼šåœ¨è°ƒç”¨runtime.GOMAXPROCS å‡½æ•°å‡å°‘Pæ•°ç›®æ—¶ï¼Œè¢«è®¤ä¸ºæ˜¯å¤šä½™çš„Pè€ŒçŠ¶æ€è½¬ä¸ºPdeadï¼Œè¿™æ—¶å€™å…¶å¸¦çš„å¯è¿è¡ŒGçš„é˜Ÿåˆ—ä¸­çš„Géƒ½ä¼šè¢«è½¬ç§»åˆ°è°ƒåº¦å™¨çš„å¯è¿è¡ŒGé˜Ÿåˆ—ä¸­ï¼Œå®ƒçš„è‡ªç”±Gé˜Ÿåˆ— ã€gfreeã€‘ä¹Ÿæ˜¯ä¸€æ ·è¢«ç§»åˆ°è°ƒåº¦å™¨çš„è‡ªç”±åˆ—è¡¨ã€runtime.sched.gfreeã€‘ä¸­ã€‚</p>

<p>ã€æ³¨æ„ã€‘æ¯ä¸ªPä¸­éƒ½æœ‰ä¸€ä¸ªå¯è¿è¡ŒGé˜Ÿåˆ—åŠè‡ªç”±Gé˜Ÿåˆ—ã€‚è‡ªç”±Gé˜Ÿåˆ—åŒ…å«äº†å¾ˆå¤šå·²ç»å®Œæˆçš„Gï¼Œéšç€è¢«è¿è¡Œå®Œæˆçš„Gçš„ç§¯æ”’åˆ°ä¸€å®šç¨‹åº¦åï¼Œruntimeä¼šæŠŠå…¶ä¸­çš„éƒ¨åˆ†Gè½¬ç§»åˆ°å…¨å±€è°ƒåº¦å™¨çš„è‡ªç”±Gé˜Ÿåˆ— ã€runtime.sched.gfreeã€‘ä¸­ã€‚</p>

<p>ã€æ³¨æ„ã€‘å½“æˆ‘ä»¬æ¯æ¬¡ç”¨ goå…³é”®å­—å¯ç”¨ä¸€ä¸ªGçš„æ—¶å€™ï¼Œé¦–å…ˆéƒ½æ˜¯å°½å¯èƒ½å¤ç”¨å·²ç»æ‰§è¡Œå®Œçš„Gã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼šè¿è¡Œæ—¶ç³»ç»Ÿéƒ½ä¼šå…ˆä»Pçš„è‡ªç”±Gé˜Ÿåˆ—è·å–ä¸€ä¸ªGæ¥å°è£…æˆ‘ä»¬æä¾›çš„å‡½æ•° (go å…³é”®å­—åé¢çš„å‡½æ•°) ï¼Œå¦‚æœå‘ç°Pä¸­çš„è‡ªç”±Gè¿‡å°‘æ—¶ï¼Œä¼šä»è°ƒåº¦å™¨çš„è‡ªç”±Gé˜Ÿåˆ—ä¸­ç§»ä¸€äº›Gè¿‡æ¥ï¼Œåªæœ‰è¿è°ƒåº¦å™¨çš„è‡ªç”±Gåˆ—è¡¨éƒ½å¼¹å°½ç²®ç»çš„æ—¶å€™ï¼Œæ‰ä¼šå»åˆ›å»ºæ–°çš„Gã€‚</p>

<p>2.3 å®ä½“G(goroutine)
goroutineå¯ä»¥ç†è§£æˆè¢«è°ƒåº¦å™¨ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ï¼Œgoroutineä½¿ç”¨goå…³é”®å­—åˆ›å»ºã€‚</p>

<p>goroutineçš„æ–°å»º, ä¼‘çœ , æ¢å¤, åœæ­¢éƒ½å—åˆ°goçš„runtimeç®¡ç†ã€‚
goroutineæ‰§è¡Œå¼‚æ­¥æ“ä½œæ—¶ä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€, å¾…æ“ä½œå®Œæˆåå†æ¢å¤, æ— éœ€å ç”¨ç³»ç»Ÿçº¿ç¨‹ã€‚
goroutineæ–°å»ºæˆ–æ¢å¤æ—¶ä¼šæ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—, ç­‰å¾…Må–å‡ºå¹¶è¿è¡Œã€‚</p>

<p>gå’Œgobufçš„ç»“æ„å®šä¹‰å’Œåœ¨runtime2.goå¦‚ä¸‹ï¼š</p>

<p>type g struct {
	// Stack parameters.
	// stack describes the actual stack memory: [stack.lo, stack.hi).
	// stackguard0 is the stack pointer compared in the Go stack growth prologue.
	// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
	// stackguard1 is the stack pointer compared in the C stack growth prologue.
	// It is stack.lo+StackGuard on g0 and gsignal stacks.
	// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
	stack       stack   // offset known to runtime/cgo
	stackguard0 uintptr // offset known to liblink
	stackguard1 uintptr // offset known to liblink</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_panic         *_panic // innermost panic - offset known to liblink
_defer         *_defer // innermost defer
/**
 *	æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ‰§è¡Œå®ƒçš„mï¼Œä¹Ÿå³géš¶å±äºmï¼›
 */
m              *m      // current m; offset known to arm liblink
// è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œåˆ©ç”¨schedåŸŸæ¥ä¿å­˜ä¸Šä¸‹æ–‡
sched          gobuf
syscallsp      uintptr        // if status==Gsyscall, syscallsp = sched.sp to use during gc
syscallpc      uintptr        // if status==Gsyscall, syscallpc = sched.pc to use during gc
stktopsp       uintptr        // expected sp at top of stack, to check in traceback
param          unsafe.Pointer // passed parameter on wakeup
// çŠ¶æ€Gidle,Grunnable,Grunning,Gsyscall,Gwaiting,Gdead
atomicstatus   uint32
stackLock      uint32 // sigprof/scang lock; TODO: fold in to atomicstatus
goid           int64
//????
schedlink      guintptr
waitsince      int64      // approx time when the g become blocked
waitreason     waitReason // if status==Gwaiting
// æŠ¢å æ ‡å¿—
preempt        bool       // preemption signal, duplicates stackguard0 = stackpreempt
paniconfault   bool       // panic (instead of crash) on unexpected fault address
preemptscan    bool       // preempted g does scan for gc
gcscandone     bool       // g has scanned stack; protected by _Gscan bit in status
gcscanvalid    bool       // false at start of gc cycle, true if G has not run since last scan; TODO: remove?
throwsplit     bool       // must not split stack
raceignore     int8       // ignore race detection events
sysblocktraced bool       // StartTrace has emitted EvGoInSyscall about this goroutine
sysexitticks   int64      // cputicks when syscall has returned (for tracing)
traceseq       uint64     // trace event sequencer
tracelastp     puintptr   // last P emitted an event for this goroutine
// Gè¢«é”å®šåªèƒ½åœ¨è¿™ä¸ªmä¸Šè¿è¡Œ
lockedm        muintptr
sig            uint32
writebuf       []byte
sigcode0       uintptr
sigcode1       uintptr
sigpc          uintptr
// åˆ›å»ºè¿™ä¸ªgoroutineçš„goè¡¨è¾¾å¼çš„pc
gopc           uintptr         // pc of go statement that created this goroutine
ancestors      *[]ancestorInfo // ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)
startpc        uintptr         // pc of goroutine function
racectx        uintptr
waiting        *sudog         // sudog structures this g is waiting on (that have a valid elem ptr); in lock order
cgoCtxt        []uintptr      // cgo traceback context
labels         unsafe.Pointer // profiler labels
timer          *timer         // cached timer for time.Sleep
selectDone     uint32         // are we participating in a select and did someone win the race?

// Per-G GC state

// gcAssistBytes is this G's GC assist credit in terms of
// bytes allocated. If this is positive, then the G has credit
// to allocate gcAssistBytes bytes without assisting. If this
// is negative, then the G must correct this by performing
// scan work. We track this in bytes to make it fast to update
// and check for debt in the malloc hot path. The assist ratio
// determines how this corresponds to scan work debt.
gcAssistBytes int64 }
</code></pre></div></div>

<p>//ç”¨äºä¿å­˜Gåˆ‡æ¢æ—¶ä¸Šä¸‹æ–‡çš„ç¼“å­˜ç»“æ„ä½“
type gobuf struct {
	// The offsets of sp, pc, and g are known to (hard-coded in) libmach.
	//
	// ctxt is unusual with respect to GC: it may be a
	// heap-allocated funcval, so GC needs to track it, but it
	// needs to be set and cleared from assembly, where itâ€™s
	// difficult to have write barriers. However, ctxt is really a
	// saved, live register, and we only ever exchange it between
	// the real register and the gobuf. Hence, we treat it as a
	// root during stack scanning, which means assembly that saves
	// and restores it doesnâ€™t need write barriers. Itâ€™s still
	// typed as a pointer so that any other writes from Go get
	// write barriers.
	sp   uintptr //å½“å‰çš„æ ˆæŒ‡é’ˆ
	pc   uintptr //å½“å‰çš„è®¡æ•°å™¨
	g    guintptr //gè‡ªèº«å¼•ç”¨
	ctxt unsafe.Pointer
	ret  sys.Uintreg
	lr   uintptr
	bp   uintptr // for GOEXPERIMENT=framepointer
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
Goè¯­è¨€çš„ç¼–è¯‘å™¨ä¼šæŠŠæˆ‘ä»¬ç¼–å†™çš„goroutineç¼–è¯‘ä¸ºruntimeçš„å‡½æ•°è°ƒç”¨ï¼Œå¹¶æŠŠgoè¯­å¥ä¸­çš„å‡½æ•°ä»¥åŠå…¶å‚æ•°ä¼ é€’ç»™runtimeçš„å‡½æ•°ä¸­ã€‚</p>

<p>runtimeåœ¨æ¥åˆ°è¿™æ ·ä¸€ä¸ªè°ƒç”¨åï¼Œä¼šå…ˆæ£€æŸ¥ä¸€ä¸‹goå‡½æ•°åŠå…¶å‚æ•°çš„åˆæ³•æ€§ï¼Œç´§æ¥ç€ä¼šè¯•å›¾ä»å±€éƒ¨è°ƒåº¦å™¨Pçš„è‡ªç”±Gé˜Ÿåˆ—ä¸­(æˆ–è€…å…¨å±€è°ƒåº¦å™¨çš„è‡ªç”±Gé˜Ÿåˆ—)ä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„è‡ªç”±G ï¼ˆPä¸­æœ‰è®²è¿°äº†ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ–°åˆ›å»ºä¸€ä¸ªGã€‚ç±»ä¼¼Må’ŒPï¼ŒGåœ¨è¿è¡Œæ—¶ç³»ç»Ÿä¸­ä¹Ÿæœ‰å…¨å±€çš„Gåˆ—è¡¨ã€runtime.allgã€‘ï¼Œé‚£äº›æ–°å»ºçš„Gä¼šå…ˆæ”¾åˆ°è¿™ä¸ªå…¨å±€çš„Gåˆ—è¡¨ä¸­ï¼Œå…¶åˆ—è¡¨çš„ä½œç”¨ä¹Ÿæ˜¯é›†ä¸­æ”¾ç½®äº†å½“å‰è¿è¡Œæ—¶ç³»ç»Ÿä¸­ç»™æ‰€æœ‰çš„Gçš„æŒ‡é’ˆã€‚åœ¨ç”¨è‡ªç”±Gå°è£…goçš„å‡½æ•°æ—¶ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿéƒ½ä¼šå¯¹è¿™ä¸ªGé‡æ–°åšä¸€æ¬¡åˆå§‹åŒ–ã€‚</p>

<p>åˆå§‹åŒ–ï¼šåŒ…å«äº†è¢«å…³è”çš„goå…³é”®å­—åçš„å‡½æ•°åŠå½“å‰Gçš„çŠ¶æ€æœºGçš„IDç­‰ç­‰ã€‚åœ¨Gè¢«åˆå§‹åŒ–å®Œæˆåå°±ä¼šè¢«æ”¾ç½®åˆ°å½“å‰æœ¬åœ°çš„Pçš„å¯è¿è¡Œé˜Ÿåˆ—ä¸­ã€‚åªè¦æ—¶æœºæˆç†Ÿï¼Œè°ƒåº¦å™¨ä¼šç«‹å³å°½å¿ƒè¿™ä¸ªGçš„è°ƒåº¦è¿è¡Œã€‚</p>

<p>Gçš„çŠ¶æ€æœºä¼šæ¯”è¾ƒå¤æ‚ä¸€ç‚¹ï¼Œå¤§è‡´ä¸Šå’Œå†…æ ¸çº¿ç¨‹çš„çŠ¶æ€æœºæœ‰ä¸€ç‚¹ç±»ä¼¼ï¼Œä½†æ˜¯çŠ¶æ€æœºæµè½¬æœ‰ä¸€äº›åŒºåˆ«ã€‚Gçš„å„ç§çŠ¶æ€å¦‚ä¸‹ï¼š</p>

<p>Gidleï¼šGè¢«åˆ›å»ºä½†è¿˜æœªå®Œå…¨è¢«åˆå§‹åŒ–ã€‚
Grunnableï¼šå½“å‰Gä¸ºå¯è¿è¡Œçš„ï¼Œæ­£åœ¨ç­‰å¾…è¢«è¿è¡Œã€‚
Grunningï¼šå½“å‰Gæ­£åœ¨è¢«è¿è¡Œã€‚
Gsyscallï¼šå½“å‰Gæ­£åœ¨è¢«ç³»ç»Ÿè°ƒç”¨
Gwaitingï¼šå½“å‰Gæ­£åœ¨å› æŸä¸ªåŸå› è€Œç­‰å¾…
Gdeadï¼šå½“å‰Gå®Œæˆäº†è¿è¡Œ
åˆå§‹åŒ–å®Œçš„Gæ˜¯å¤„äºGrunnableçš„çŠ¶æ€ï¼Œä¸€ä¸ªGçœŸæ­£åœ¨Mä¸­è¿è¡Œæ—¶æ˜¯å¤„äºGrunningçš„çŠ¶æ€ï¼ŒGçš„çŠ¶æ€æœºæµè½¬å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>ä¸Šå›¾æœ‰ä¸€æ­¥æ˜¯ç­‰å¾…çš„äº‹ä»¶åˆ°æ¥ï¼Œé‚£ä¹ˆGåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ˜¯å¦ç­‰å¾…æŸä¸ªäº‹ä»¶ä»¥åŠç­‰å¾…ä»€ä¹ˆæ ·çš„äº‹ä»¶ï¼Ÿå®Œå…¨ç”±èµ·å°è£…çš„goå…³é”®å­—åçš„å‡½æ•°å†³å®šã€‚ï¼ˆå¦‚ï¼šç­‰å¾…chanä¸­çš„å€¼ã€æ¶‰åŠç½‘ç»œI/Oã€time.Timerã€time.Sleepç­‰ç­‰äº‹ä»¶ï¼‰</p>

<p>Gé€€å‡ºç³»ç»Ÿè°ƒç”¨çš„è¿‡ç¨‹éå¸¸å¤æ‚ï¼šruntimeå…ˆä¼šå°è¯•è·å–ç©ºé—²å±€éƒ¨è°ƒåº¦å™¨På¹¶ç›´æ¥è¿è¡Œå½“å‰Gï¼Œå¦‚æœæ²¡æœ‰å°±ä¼šæŠŠå½“å‰Gè½¬æˆGrunnableçŠ¶æ€å¹¶æ”¾ç½®å…¥å…¨å±€è°ƒåº¦å™¨çš„global queueã€‚</p>

<p>æœ€åï¼Œå·²ç»æ˜¯GdeadçŠ¶æ€çš„Gæ˜¯å¯ä»¥è¢«é‡æ–°åˆå§‹åŒ–å¹¶ä½¿ç”¨çš„(ä»è‡ªç”±Gé˜Ÿåˆ—å–å‡ºæ¥é‡æ–°åˆå§‹åŒ–ä½¿ç”¨)ã€‚è€Œå¯¹æ¯”è¿›å…¥PdeadçŠ¶æ€çš„Pç­‰å¾…çš„å‘½è¿åªæœ‰è¢«é”€æ¯ã€‚å¤„äºGdeadçš„Gä¼šè¢«æ”¾ç½®åˆ°æœ¬åœ°Pæˆ–è€…è°ƒåº¦å™¨çš„è‡ªç”±Gåˆ—è¡¨ä¸­ã€‚</p>

<p>è‡³æ­¤ï¼ŒGã€Mã€Pçš„åˆæ­¥æè¿°å·²ç»å®Œæ¯•ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä¸€äº›æ ¸å¿ƒçš„é˜Ÿåˆ—ï¼š</p>

<p>ä¸­æ–‡å	æºç åç§°	ä½œç”¨åŸŸ	ç®€è¦è¯´æ˜
å…¨å±€Måˆ—è¡¨	runtime.allm	è¿è¡Œæ—¶ç³»ç»Ÿ	å­˜æ”¾æ‰€æœ‰M
å…¨å±€Påˆ—è¡¨	runtime.allp	è¿è¡Œæ—¶ç³»ç»Ÿ	å­˜æ”¾æ‰€æœ‰P
å…¨å±€Gåˆ—è¡¨	runtime.allg	è¿è¡Œæ—¶ç³»ç»Ÿ	å­˜æ”¾æ‰€æœ‰G
è°ƒåº¦å™¨ä¸­çš„ç©ºé—²Måˆ—è¡¨	runtime.schedt.midle	è°ƒåº¦å™¨	å­˜æ”¾ç©ºé—²Mï¼Œé“¾è¡¨ç»“æ„
è°ƒåº¦å™¨ä¸­çš„ç©ºé—²Påˆ—è¡¨	runtime.schedt.pidle	è°ƒåº¦å™¨	å­˜æ”¾ç©ºé—²Pï¼Œé“¾è¡¨ç»“æ„
è°ƒåº¦å™¨ä¸­çš„å¯è¿è¡ŒGé˜Ÿåˆ—	runtime.schedt.runq	è°ƒåº¦å™¨	å­˜æ”¾å¯è¿è¡ŒGï¼Œé“¾è¡¨ç»“æ„
è°ƒåº¦å™¨ä¸­çš„è‡ªç”±Gåˆ—è¡¨	runtime.schedt.gfree	è°ƒåº¦å™¨	å­˜æ”¾è‡ªç”±Gï¼Œ é“¾è¡¨ç»“æ„
Pä¸­çš„å¯è¿è¡ŒGé˜Ÿåˆ—	runq	æœ¬åœ°P	å­˜æ”¾å½“å‰Pä¸­çš„å¯è¿è¡ŒGï¼Œç¯å½¢é˜Ÿåˆ—ï¼Œæ•°ç»„å®ç°
Pä¸­çš„è‡ªç”±Gåˆ—è¡¨	gfree	æœ¬åœ°P	å­˜æ”¾å½“å‰Pä¸­çš„è‡ªç”±Gï¼Œé“¾è¡¨ç»“æ„
ä¸‰ä¸ªå…¨å±€çš„åˆ—è¡¨ä¸»è¦ä¸ºäº†ç»Ÿè®¡runtimeçš„æ‰€æœ‰Gã€Mã€Pã€‚æˆ‘ä»¬ä¸»è¦å…³å¿ƒå‰©ä¸‹çš„è¿™äº›å®¹å™¨ï¼Œå°¤å…¶æ˜¯å’ŒGç›¸å…³çš„å››ä¸ªã€‚</p>

<p>åœ¨runtimeåˆ›å»ºçš„Géƒ½ä¼šè¢«ä¿å­˜åœ¨å…¨å±€çš„Gåˆ—è¡¨ä¸­ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</p>

<p>ä»Gsyscallè½¬å‡ºæ¥çš„Gï¼Œå¦‚æœä¸èƒ½é©¬ä¸Šè·å–ç©ºé—²çš„Pæ‰§è¡Œï¼Œå°±ä¼šè¢«æ”¾ç½®åˆ°å…¨å±€è°ƒåº¦å™¨çš„å¯è¿è¡Œé˜Ÿåˆ—ä¸­(global queue)ã€‚
è¢«runtimeåˆå§‹åŒ–çš„Gä¼šè¢«æ”¾ç½®åˆ°æœ¬åœ°Pçš„å¯è¿è¡Œé˜Ÿåˆ—ä¸­(local queue)
ä»Gwaitingè½¬å‡ºæ¥çš„Gï¼Œé™¤äº†å› ç½‘ç»œIOé™·å…¥ç­‰å¾…çš„Gä¹‹å¤–ï¼Œéƒ½ä¼šè¢«é˜²æ­¢åˆ°æœ¬åœ°På¯è¿è¡Œçš„Gé˜Ÿåˆ—ä¸­ã€‚
è½¬æˆGdeadçŠ¶æ€çš„Gä¼šå…ˆè¢«æ”¾ç½®åœ¨æœ¬åœ°Pçš„è‡ªç”±Gåˆ—è¡¨ã€‚
è°ƒåº¦å™¨ä¸­çš„ä¸Gã€Mã€Pç›¸å…³çš„åˆ—è¡¨å…¶å®åªæ˜¯èµ·äº†ä¸€ä¸ªæš‚å­˜çš„ä½œç”¨ã€‚
ä¸€å¥è¯æ¦‚æ‹¬ä¸‰è€…å…³ç³»ï¼š</p>

<p>Géœ€è¦ç»‘å®šåœ¨Mä¸Šæ‰èƒ½è¿è¡Œ
Méœ€è¦ç»‘å®šPæ‰èƒ½è¿è¡Œ
è¿™ä¸‰è€…ä¹‹é—´çš„å®ä½“å…³ç³»æ˜¯ï¼š</p>

<p>å†…æ ¸è°ƒåº¦å®ä½“(Kernel Scheduling Entry)ä¸ä¸‰è€…çš„å…³ç³»æ˜¯ï¼š</p>

<p>å¯çŸ¥ï¼šä¸€ä¸ªGçš„æ‰§è¡Œéœ€è¦Må’ŒPçš„æ”¯æŒã€‚ä¸€ä¸ªMåœ¨äºä¸€ä¸ªPå…³è”ä¹‹åå°±å½¢æˆä¸€ä¸ªæœ‰æ•ˆçš„Gè¿è¡Œç¯å¢ƒ ã€å†…æ ¸çº¿ç¨‹ + ä¸Šä¸‹æ–‡ç¯å¢ƒã€‘ã€‚æ¯ä¸ªPéƒ½å«æœ‰ä¸€ä¸ª å¯è¿è¡ŒGçš„é˜Ÿåˆ—ã€runqã€‘ã€‚é˜Ÿåˆ—ä¸­çš„Gä¼šè¢«ä¸€æ¬¡ä¼ é€’ç»™æœ¬åœ°På…³è”çš„Må¹¶ä¸”è·å¾—è¿è¡Œæ—¶æœºã€‚</p>

<p>M ä¸ KSE çš„å…³ç³»æ˜¯ç»å¯¹çš„ä¸€å¯¹ä¸€ï¼Œä¸€ä¸ªMä»…èƒ½ä»£è¡¨ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚åœ¨ä¸€ä¸ªMçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œä»…ä¼šå’Œä¸€ä¸ªå†…æ ¸KSEäº§ç”Ÿå…³è”ã€‚Mä¸Pä»¥åŠPä¸Gä¹‹é—´çš„å…³è”æ—¶å¤šå˜çš„ï¼Œæ€»æ˜¯ä¼šéšç€è°ƒåº¦å™¨çš„å®é™…è°ƒåº¦ç­–ç•¥è€Œå˜åŒ–ã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬å†å›é¡¾ä¸‹Gã€Mã€Pé‡Œé¢æ ¸å¿ƒæˆå‘˜</p>

<p>Gé‡Œé¢çš„æ ¸å¿ƒæˆå‘˜</p>

<p>stack ï¼šå½“å‰gä½¿ç”¨çš„æ ˆç©ºé—´, æœ‰loå’Œhiä¸¤ä¸ªæˆå‘˜
stackguard0 ï¼šæ£€æŸ¥æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿçš„å€¼, ä½äºè¿™ä¸ªå€¼ä¼šæ‰©å¼ æ ˆ, 0æ˜¯goä»£ç ä½¿ç”¨çš„
stackguard1 ï¼šæ£€æŸ¥æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿçš„å€¼, ä½äºè¿™ä¸ªå€¼ä¼šæ‰©å¼ æ ˆ, 1æ˜¯åŸç”Ÿä»£ç ä½¿ç”¨çš„
m ï¼šå½“å‰gå¯¹åº”çš„m
sched ï¼šgçš„è°ƒåº¦æ•°æ®, å½“gä¸­æ–­æ—¶ä¼šä¿å­˜å½“å‰çš„pcå’Œrspç­‰å€¼åˆ°è¿™é‡Œ, æ¢å¤è¿è¡Œæ—¶ä¼šä½¿ç”¨è¿™é‡Œçš„å€¼
atomicstatus: gçš„å½“å‰çŠ¶æ€
schedlink: ä¸‹ä¸€ä¸ªg, å½“gåœ¨é“¾è¡¨ç»“æ„ä¸­ä¼šä½¿ç”¨
preempt: gæ˜¯å¦è¢«æŠ¢å ä¸­
lockedm: gæ˜¯å¦è¦æ±‚è¦å›åˆ°è¿™ä¸ªMæ‰§è¡Œ, æœ‰çš„æ—¶å€™gä¸­æ–­äº†æ¢å¤ä¼šè¦æ±‚ä½¿ç”¨åŸæ¥çš„Mæ‰§è¡Œ
Mé‡Œé¢çš„æ ¸å¿ƒæˆå‘˜</p>

<p>g0: ç”¨äºè°ƒåº¦çš„ç‰¹æ®Šg, è°ƒåº¦å’Œæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ä¼šåˆ‡æ¢åˆ°è¿™ä¸ªg
curg: å½“å‰è¿è¡Œçš„g
p: å½“å‰æ‹¥æœ‰çš„P
nextp: å”¤é†’Mæ—¶, Mä¼šæ‹¥æœ‰è¿™ä¸ªP
park: Mä¼‘çœ æ—¶ä½¿ç”¨çš„ä¿¡å·é‡, å”¤é†’Mæ—¶ä¼šé€šè¿‡å®ƒå”¤é†’
schedlink: ä¸‹ä¸€ä¸ªm, å½“måœ¨é“¾è¡¨ç»“æ„ä¸­ä¼šä½¿ç”¨
mcache: åˆ†é…å†…å­˜æ—¶ä½¿ç”¨çš„æœ¬åœ°åˆ†é…å™¨, å’Œp.mcacheä¸€æ ·(æ‹¥æœ‰Pæ—¶ä¼šå¤åˆ¶è¿‡æ¥)
lockedg: lockedmçš„å¯¹åº”å€¼
Pé‡Œé¢çš„æ ¸å¿ƒæˆå‘˜</p>

<p>status: pçš„å½“å‰çŠ¶æ€
link: ä¸‹ä¸€ä¸ªp, å½“påœ¨é“¾è¡¨ç»“æ„ä¸­ä¼šä½¿ç”¨
m: æ‹¥æœ‰è¿™ä¸ªPçš„M
mcache: åˆ†é…å†…å­˜æ—¶ä½¿ç”¨çš„æœ¬åœ°åˆ†é…å™¨
runqhead: æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å‡ºé˜Ÿåºå·
runqtail: æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„å…¥é˜Ÿåºå·
runq: æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„æ•°ç»„, å¯ä»¥ä¿å­˜256ä¸ªG
gfree: Gçš„è‡ªç”±åˆ—è¡¨, ä¿å­˜å˜ä¸º_Gdeadåå¯ä»¥å¤ç”¨çš„Gå®ä¾‹
gcBgMarkWorker: åå°GCçš„workerå‡½æ•°, å¦‚æœå®ƒå­˜åœ¨Mä¼šä¼˜å…ˆæ‰§è¡Œå®ƒ
gcw: GCçš„æœ¬åœ°å·¥ä½œé˜Ÿåˆ—, è¯¦ç»†å°†åœ¨ä¸‹ä¸€ç¯‡(GCç¯‡)åˆ†æ
è°ƒåº¦å™¨é™¤äº†è®¾è®¡ä¸Šé¢çš„ä¸‰ä¸ªç»“æ„ä½“ï¼Œè¿˜æœ‰ä¸€ä¸ªå…¨å±€è°ƒåº¦å™¨æ•°æ®ç»“æ„schedt:</p>

<p>type schedt struct {
	// accessed atomically. keep at top to ensure alignment on 32-bit systems.
	// // ä¸‹é¢ä¸¤ä¸ªå˜é‡éœ€ä»¥åŸå­è®¿é—®è®¿é—®ã€‚ä¿æŒåœ¨ struct é¡¶éƒ¨ï¼Œç¡®ä¿å…¶åœ¨ 32 ä½ç³»ç»Ÿä¸Šå¯ä»¥å¯¹é½
	goidgen  uint64
	lastpoll uint64</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lock mutex

// When increasing nmidle, nmidlelocked, nmsys, or nmfreed, be
// sure to call checkdead().
//=====ä¸mæ•°é‡ç›¸å…³çš„å˜é‡================================================
// ç©ºé—²måˆ—è¡¨æŒ‡é’ˆ
midle        muintptr // idle m's waiting for work
// ç©ºé—²mçš„æ•°é‡
nmidle       int32    // number of idle m's waiting for work
// è¢«é”ä½çš„mç©ºé—²æ•°é‡
nmidlelocked int32    // number of locked m's waiting for work
// å·²ç»åˆ›å»ºçš„mçš„æ•°ç›®å’Œä¸‹ä¸€ä¸ªm ID
mnext        int64    // number of m's that have been created and next M ID
// å…è®¸åˆ›å»ºçš„mçš„æœ€å¤§æ•°é‡
maxmcount    int32    // maximum number of m's allowed (or die)
// ä¸è®¡å…¥æ­»é”çš„mçš„æ•°é‡
nmsys        int32    // number of system m's not counted for deadlock
// é‡Šæ”¾mçš„ç´¯è®¡æ•°é‡
nmfreed      int64    // cumulative number of freed m's

//ç³»ç»Ÿçš„goroutineçš„æ•°é‡
ngsys uint32 // number of system goroutines; updated atomically

//=====ä¸pæ•°é‡ç›¸å…³çš„å˜é‡================================================
// ç©ºé—²çš„påˆ—è¡¨
pidle      puintptr // idle p's
// ç©ºé—²pçš„æ•°é‡
npidle     uint32
//
nmspinning uint32 // See "Worker thread parking/unparking" comment in proc.go.

// Global runnable queue.
// å…¨å±€runable gé“¾è¡¨çš„headåœ°å€
runqhead guintptr
// å…¨å±€runable gé“¾è¡¨çš„tailåœ°å€
runqtail guintptr
// å…¨å±€runable gé“¾è¡¨çš„å¤§å°
runqsize int32

// Global cache of dead G's.
gflock       mutex
gfreeStack   *g
gfreeNoStack *g
ngfree       int32

// Central cache of sudog structs.
sudoglock  mutex
sudogcache *sudog

// Central pool of available defer structs of different sizes.
deferlock mutex
deferpool [5]*_defer

// freem is the list of m's waiting to be freed when their
// m.exited is set. Linked through m.freelink.
freem *m

gcwaiting  uint32 // gc is waiting to run
stopwait   int32
stopnote   note
sysmonwait uint32
sysmonnote note

// safepointFn should be called on each P at the next GC
// safepoint if p.runSafePointFn is set.
safePointFn   func(*p)
safePointWait int32
safePointNote note

profilehz int32 // cpu profiling rate

procresizetime int64 // nanotime() of last change to gomaxprocs
totaltime      int64 // âˆ«gomaxprocs dt up to procresizetime } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 å…¨å±€è°ƒåº¦å™¨ï¼Œå…¨å±€åªæœ‰ä¸€ä¸ªschedtç±»å‹çš„å®ä¾‹ã€‚
</code></pre></div></div>

<p>sudoG ç»“æ„ä½“ï¼š</p>

<p>// sudog ä»£è¡¨åœ¨ç­‰å¾…åˆ—è¡¨é‡Œçš„ gï¼Œæ¯”å¦‚å‘ channel å‘é€/æ¥æ”¶å†…å®¹æ—¶
// ä¹‹æ‰€ä»¥éœ€è¦ sudog æ˜¯å› ä¸º g å’ŒåŒæ­¥å¯¹è±¡ä¹‹é—´çš„å…³ç³»æ˜¯å¤šå¯¹å¤šçš„
// ä¸€ä¸ª g å¯èƒ½ä¼šåœ¨å¤šä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ä¸€ä¸ª g å¯èƒ½è¢«æ‰“åŒ…ä¸ºå¤šä¸ª sudog
// å¤šä¸ª g ä¹Ÿå¯ä»¥ç­‰å¾…åœ¨åŒä¸€ä¸ªåŒæ­¥å¯¹è±¡ä¸Š
// å› æ­¤å¯¹äºä¸€ä¸ªåŒæ­¥å¯¹è±¡å°±ä¼šæœ‰å¾ˆå¤š sudog äº†
// sudog æ˜¯ä»ä¸€ä¸ªç‰¹æ®Šçš„æ± ä¸­è¿›è¡Œåˆ†é…çš„ã€‚ç”¨ acquireSudog å’Œ releaseSudog æ¥åˆ†é…å’Œé‡Šæ”¾ sudog</p>

<p>type sudog struct {
	// The following fields are protected by the hchan.lock of the
	// channel this sudog is blocking on. shrinkstack depends on
	// this for sudogs involved in channel ops.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g          *g
selectdone *uint32 // CAS to 1 to win select race (may point to stack)
next       *sudog
prev       *sudog
elem       unsafe.Pointer // data element (may point to stack)
 
// The following fields are never accessed concurrently.
// For channels, waitlink is only accessed by g.
// For semaphores, all fields (including the ones above)
// are only accessed when holding a semaRoot lock.
 
acquiretime int64
releasetime int64
ticket      uint32
parent      *sudog // semaRoot binary tree
waitlink    *sudog // g.waiting list or semaRoot
waittail    *sudog // semaRoot
c           *hchan // channel } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 Section3 ä¸»è¦è°ƒåº¦æµç¨‹çš„æºç åˆ†æ ä¸‹é¢ä¸»è¦åˆ†æè°ƒåº¦å™¨è°ƒåº¦æµç¨‹çš„æºç ï¼Œä¸»è¦åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼š 1ï¼‰é¢„å¤‡çŸ¥è¯†ç‚¹ 2ï¼‰mainç¨‹åºå¯åŠ¨åˆå§‹åŒ–è¿‡ç¨‹ï¼ˆå•ç‹¬ä¸€ç¯‡æ–‡ç« å†™è¿™ä¸ªï¼‰ 3ï¼‰æ–°å»º goroutineçš„è¿‡ç¨‹ 4ï¼‰å¾ªç¯è°ƒåº¦çš„è¿‡ç¨‹ 5ï¼‰æŠ¢å å¼è°ƒåº¦çš„å®ç° 6ï¼‰åˆå§‹åŒ–Pè¿‡ç¨‹ 7ï¼‰åˆå§‹åŒ–Mè¿‡ç¨‹ 8ï¼‰åˆå§‹åŒ–Gè¿‡ç¨‹
</code></pre></div></div>

<p>3.1 é¢„å¤‡çŸ¥è¯†
åœ¨å­¦ä¹ æºç ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸€äº›å…³äºGolangçš„ä¸€äº›è§„èŒƒå’Œé¢„å¤‡çŸ¥è¯†ã€‚</p>

<p>3.1.1 golangçš„å‡½æ•°è°ƒç”¨è§„èŒƒ
åœ¨golangé‡Œé¢è°ƒç”¨å‡½æ•°ï¼Œå¿…é¡»è¦å…³æ³¨çš„å°±æ˜¯å‚æ•°çš„ä¼ å…¥å’Œè¿”å›å€¼ã€‚Golangæœ‰è‡ªå·±çš„ä¸€å¥—å‡½æ•°è°ƒç”¨è§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå®šä¹‰ï¼Œæ‰€æœ‰å‚æ•°éƒ½é€šè¿‡æ ˆä¼ é€’ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯é€šè¿‡æ ˆä¼ é€’ã€‚</p>

<p>æ¯”å¦‚ï¼Œå¯¹äºå‡½æ•°ï¼š</p>

<p>type MyStruct struct { 
	X int
	P *int 
}
func someFunc(x int, s MyStruct) (int, MyStruct) { â€¦ }
1
2
3
4
5
è°ƒç”¨å‡½æ•°æ—¶å€™ï¼Œæ ˆçš„å†…å®¹å¦‚ä¸‹ï¼š</p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯ä»ä½ä½åˆ°é«˜ä½æ’åˆ—ï¼Œgoå‡½æ•°å¯ä»¥æœ‰å¤šä¸ªè¿”å›å€¼çš„åŸå› ä¹Ÿåœ¨æ­¤ï¼Œå› ä¸ºè¿”å›å€¼éƒ½é€šè¿‡æ ˆä¼ é€’äº†ã€‚</p>

<p>éœ€è¦æ³¨æ„è¿™é‡Œçš„â€è¿”å›åœ°å€â€æ˜¯x86å’Œx64ä¸Šçš„, armçš„è¿”å›åœ°å€ä¼šé€šè¿‡LRå¯„å­˜å™¨ä¿å­˜, å†…å®¹ä¼šå’Œè¿™é‡Œçš„ç¨å¾®ä¸ä¸€æ ·.</p>

<p>å¦å¤–æ³¨æ„çš„æ˜¯goå’Œcä¸ä¸€æ ·, ä¼ é€’ struct æ—¶æ•´ä¸ªstruct çš„å†…å®¹éƒ½ä¼šå¤åˆ¶åˆ°æ ˆä¸Š, å¦‚æœæ„é€ ä½“å¾ˆå¤§å°†ä¼šå½±å“æ€§èƒ½ã€‚</p>

<p>3.1.2 TLS(thread local storage)
TLSå…¨ç§°æ˜¯Thread Local Storageï¼Œä»£è¡¨æ¯ä¸ªçº¿ç¨‹ä¸­çš„æœ¬åœ°æ•°æ®ã€‚å†™å…¥TLSä¸­çš„æ•°æ®ä¸ä¼šå¹²æ‰°åˆ°å…¶ä½™çº¿ç¨‹ä¸­çš„å€¼ã€‚</p>

<p>Goçš„åç¨‹å®ç°éå¸¸ä¾èµ–äºTLSæœºåˆ¶ï¼Œä¼šç”¨äºè·å–ç³»ç»Ÿçº¿ç¨‹ä¸­å½“å‰çš„Gå’ŒGæ‰€å±äºçš„Må®ä¾‹ã€‚</p>

<p>Goæ“ä½œTLSä¼šä½¿ç”¨ç³»ç»ŸåŸç”Ÿçš„æ¥å£ï¼Œä»¥Linux X64ä¸ºä¾‹ï¼Œ
goåœ¨æ–°å»ºMæ—¶å€™ä¼šè°ƒç”¨arch_prctl è¿™ä¸ªsyscallæ¥è®¾ç½®FSå¯„å­˜å™¨çš„å€¼ä¸ºM.tlsçš„åœ°å€ï¼Œ
è¿è¡Œä¸­æ¯ä¸ªMçš„FSå¯„å­˜å™¨éƒ½ä¼šæŒ‡å‘å®ƒä»¬å¯¹åº”çš„Må®ä¾‹çš„tlsï¼Œlinuxå†…æ ¸è°ƒåº¦çº¿ç¨‹æ—¶FSå¯„å­˜å™¨ä¼šè·Ÿç€çº¿ç¨‹ä¸€èµ·åˆ‡æ¢ï¼Œ
è¿™æ ·goä»£ç åªéœ€è¦è®¿é—®FSå¯„å­˜æœºå°±å¯ä»¥è·å–åˆ°çº¿ç¨‹æœ¬åœ°çš„æ•°æ®ã€‚</p>

<p>3.1.3 æ ˆæ‰©å¼ 
goçš„åç¨‹è®¾è®¡æ˜¯stackful coroutineï¼Œæ¯ä¸€ä¸ªgoroutineéƒ½éœ€è¦æœ‰è‡ªå·±çš„æ ˆç©ºé—´ï¼Œ
æ ˆç©ºé—´çš„å†…å®¹å†goroutineä¼‘çœ æ—¶å€™éœ€è¦ä¿ç•™çš„ï¼Œç­‰åˆ°é‡æ–°è°ƒåº¦æ—¶å€™æ¢å¤(è¿™ä¸ªæ—¶å€™æ•´ä¸ªè°ƒç”¨æ ‘æ˜¯å®Œæ•´çš„)ã€‚
è¿™æ ·å°±ä¼šå¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœç³»ç»Ÿå­˜åœ¨å¤§é‡çš„goroutineï¼Œç»™æ¯ä¸€ä¸ªgoroutineéƒ½é¢„å…ˆåˆ†é…ä¸€ä¸ªè¶³å¤Ÿçš„æ ˆç©ºé—´é‚£ä¹ˆgoå°±ä¼šä½¿ç”¨è¿‡å¤šçš„å†…å­˜ã€‚</p>

<p>ä¸ºäº†é¿å…å†…å­˜ä½¿ç”¨è¿‡å¤šé—®é¢˜ï¼Œgoåœ¨ä¸€å¼€å§‹æ—¶å€™ï¼Œä¼šé»˜è®¤åªä¸ºgoroutineåˆ†é…ä¸€ä¸ªå¾ˆå°çš„æ ˆç©ºé—´ï¼Œå®ƒçš„å¤§å°åœ¨1.92ç‰ˆæœ¬ä¸­æ˜¯2kã€‚
å½“å‡½æ•°å‘ç°æ ˆç©ºé—´ä¸è¶³æ—¶ï¼Œä¼šç”³è¯·ä¸€å—æ–°çš„æ ˆç©ºé—´å¹¶æŠŠåŸæ¥çš„æ ˆå¤åˆ¶è¿‡å»ã€‚</p>

<p>gå®ä¾‹é‡Œé¢çš„g.stackã€g.stackguard0ä¸¤ä¸ªå˜é‡æ¥æè¿°goroutineå®ä¾‹çš„æ ˆã€‚</p>

<p>3.1.4 å†™å±éšœ(write barrier)
goæ”¯æŒå¹¶è¡ŒGCçš„ï¼ŒGCçš„æ‰«æé˜¶æ®µå’Œgoä»£ç å¯ä»¥åŒæ—¶è¿è¡Œã€‚è¿™æ ·å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼ŒGCæ‰«æçš„è¿‡ç¨‹ä¸­goä»£ç çš„æ‰§è¡Œå¯èƒ½æ”¹å˜äº†å¯¹è±¡ä¾èµ–æ ‘ã€‚</p>

<p>æ¯”å¦‚ï¼šå¼€å§‹æ‰«ææ—¶å€™å‘ç°æ ¹å¯¹è±¡Aå’ŒBï¼ŒBæ‹¥æœ‰Cçš„æŒ‡é’ˆï¼ŒGCå…ˆæ‰«æAï¼Œç„¶åBæŠŠCçš„æŒ‡é’ˆäº¤ç»™Aï¼ŒGCå†æ‰«æBï¼Œè¿™æ—¶Cå°±ä¸ä¼šè¢«æ‰«æåˆ°ã€‚
ä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜ï¼Œgoåœ¨GCæ‰«ææ ‡è®°é˜¶æ®µä¼šå¯ç”¨å†™å±éšœï¼ˆWrite Barrierï¼‰</p>

<p>å¯ç”¨äº†Write barrierä¹‹åï¼Œå½“BæŠŠCæŒ‡é’ˆäº¤ç»™Aæ—¶ï¼ŒGCä¼šè®¤ä¸ºåœ¨è¿™ä¸€è½®æ‰«æä¸­Cçš„æŒ‡é’ˆæ˜¯å­˜æ´»çš„ï¼Œå³ä½¿A å¯èƒ½åœ¨ç¨åä¸¢æ‰Cï¼Œé‚£ä¹ˆCåœ¨ä¸‹ä¸€è½®GCä¸­å†å›æ”¶ã€‚</p>

<p>Write barrieråªé’ˆå¯¹æŒ‡é’ˆå¯ç”¨ï¼Œè€Œä¸”åªåœ¨GCçš„æ ‡è®°é˜¶æ®µå¯ç”¨ï¼Œå¹³æ—¶ä¼šç›´æ¥æŠŠå€¼å†™å…¥åˆ°ç›®æ ‡åœ°å€ã€‚</p>

<p>3.1.5 m0å’Œg0
goä¸­æœ‰ç‰¹æ®Šçš„Må’ŒGï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯m0å’Œg0ã€‚</p>

<p>m0æ˜¯å¯åŠ¨ç¨‹åºåçš„ä¸»çº¿ç¨‹ï¼Œè¿™ä¸ªMå¯¹åº”çš„å®ä¾‹ä¼šåœ¨å…¨å±€å˜é‡runtime.m0ä¸­ï¼Œä¸éœ€è¦åœ¨heapä¸Šåˆ†é…ï¼Œ
m0è´Ÿè´£æ‰§è¡Œåˆå§‹åŒ–æ“ä½œå’Œå¯åŠ¨ç¬¬ä¸€ä¸ªgï¼Œ åœ¨ä¹‹åm0å°±å’Œå…¶ä»–çš„mä¸€æ ·äº†ã€‚</p>

<p>g0æ˜¯ä»…ç”¨äºè´Ÿè´£è°ƒåº¦çš„Gï¼Œg0ä¸æŒ‡å‘ä»»ä½•å¯æ‰§è¡Œçš„å‡½æ•°, æ¯ä¸ªméƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„g0ã€‚</p>

<p>åœ¨è°ƒåº¦æˆ–ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šä½¿ç”¨g0çš„æ ˆç©ºé—´, å…¨å±€å˜é‡çš„g0æ˜¯m0çš„g0ã€‚</p>

<p>3.1.6 goä¸­çº¿ç¨‹çš„ç§ç±»
åœ¨ runtime ä¸­æœ‰ä¸‰ç§çº¿ç¨‹ï¼š</p>

<p>ä¸€ç§æ˜¯ä¸»çº¿ç¨‹ï¼Œ
ä¸€ç§æ˜¯ç”¨æ¥è·‘ sysmon çš„çº¿ç¨‹ï¼Œ
ä¸€ç§æ˜¯æ™®é€šçš„ç”¨æˆ·çº¿ç¨‹ã€‚
ä¸»çº¿ç¨‹åœ¨ runtime ç”±å¯¹åº”çš„å…¨å±€å˜é‡: runtime.m0 æ¥è¡¨ç¤ºã€‚ç”¨æˆ·çº¿ç¨‹å°±æ˜¯æ™®é€šçš„çº¿ç¨‹äº†ï¼Œå’Œ p ç»‘å®šï¼Œæ‰§è¡Œ g ä¸­çš„ä»»åŠ¡ã€‚è™½ç„¶è¯´æ˜¯æœ‰ä¸‰ç§ï¼Œå®é™…ä¸Šå‰ä¸¤ç§çº¿ç¨‹æ•´ä¸ª runtime å°±åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚ç”¨æˆ·çº¿ç¨‹æ‰ä¼šæœ‰å¾ˆå¤šå®ä¾‹ã€‚</p>

<p>ä¸»çº¿ç¨‹ä¸­ç”¨æ¥è·‘ runtime.mainï¼Œæµç¨‹çº¿æ€§æ‰§è¡Œï¼Œæ²¡æœ‰è·³è½¬ã€‚</p>

<p>3.2 mainçº¿ç¨‹å¯åŠ¨æ‰§è¡Œ
mainçº¿ç¨‹çš„å¯åŠ¨æ˜¯ä¼´éšç€goçš„main goroutineä¸€èµ·å¯åŠ¨çš„ï¼Œå…·ä½“çš„å¯åŠ¨æµç¨‹å¯çœ‹å¦å¤–ä¸€ç¯‡åšæ–‡ï¼š
Golang-bootstrapåˆ†æ é‡Œé¢å…³äºscheduler.mainå‡½æ•°çš„åˆ†æã€‚</p>

<p>3.3 æ–°å»ºgoroutineè¿‡ç¨‹
å‰é¢å·²ç»è®²è¿‡äº†ï¼Œå½“æˆ‘ä»¬ç”¨ go func() åˆ›å»ºä¸€ä¸ªå†™çš„goroutineæ—¶å€™ï¼Œcompilerä¼šç¼–è¯‘æˆå¯¹runtime.newproc()çš„è°ƒç”¨ã€‚å †æ ˆçš„ç»“æ„å¦‚ä¸‹ï¼š</p>

<p>runtime.newproc()æºç å¦‚ä¸‹ï¼š</p>

<p>// Create a new g running fn with siz bytes of arguments.
// Put it on the queue of gâ€™s waiting to run.
// The compiler turns a go statement into a call to this.
// Cannot split the stack because it assumes that the arguments
// are available sequentially after &amp;fn; they would not be
// copied if a stack split occurred.
//go:nosplit
// æ ¹æ® å‚æ•° fn å’Œ siz åˆ›å»ºä¸€ä¸ª g
// å¹¶æŠŠå®ƒæ”¾ç½®å…¥ è‡ªç”±gé˜Ÿåˆ—ä¸­ç­‰å¾…å”¤é†’
func newproc(siz int32, fn <em>funcval) {
	//è·å–æ ˆä¸Šçš„å‚æ•°çš„æŒ‡é’ˆåœ°å€
	argp := add(unsafe.Pointer(&amp;fn), sys.PtrSize)
	gp := getg()
	// è·å–pcæŒ‡é’ˆåœ°å€
	pc := getcallerpc()
	// ç”¨g0çš„æ ˆåˆ›å»ºGå¯¹è±¡
	systemstack(func() {
		newproc1(fn, (</em>uint8)(argp), siz, gp, pc)
	})
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
newprocåªåšäº†ä¸‰ä»¶äº‹ï¼š</p>

<p>è®¡ç®—å‚æ•°çš„åœ°å€ argp
è·å–è°ƒç”¨ç«¯çš„åœ°å€(è¿”å›åœ°å€) pc
ä½¿ç”¨systemstackè°ƒç”¨ newproc1 å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ç”¨g0çš„æ ˆåˆ›å»ºgå¯¹è±¡
systemstack ä¼šåˆ‡æ¢å½“å‰çš„ g åˆ° g0, å¹¶ä¸”ä½¿ç”¨g0çš„æ ˆç©ºé—´, ç„¶åè°ƒç”¨ä¼ å…¥çš„å‡½æ•°, å†åˆ‡æ¢å›åŸæ¥çš„gå’ŒåŸæ¥çš„æ ˆç©ºé—´ã€‚
åˆ‡æ¢åˆ°g0åä¼šå‡è£…è¿”å›åœ°å€æ˜¯mstart, è¿™æ ·tracebackçš„æ—¶å€™å¯ä»¥åœ¨mstartåœæ­¢ã€‚
è¿™é‡Œä¼ ç»™systemstackçš„æ˜¯ä¸€ä¸ªé—­åŒ…, è°ƒç”¨æ—¶ä¼šæŠŠé—­åŒ…çš„åœ°å€æ”¾åˆ°å¯„å­˜å™¨rdx, å…·ä½“å¯ä»¥å‚è€ƒä¸Šé¢å¯¹é—­åŒ…çš„åˆ†æã€‚</p>

<p>ä¸‹é¢ä¸»è¦çœ‹ newproc1 å‡½æ•°ä¸»è¦åšçš„äº‹æƒ…ï¼š</p>

<p>// Create a new g running fn with narg bytes of arguments starting
// at argp. callerpc is the address of the go statement that created
// this. The new g is put on the queue of gâ€™s waiting to run.
// æ ¹æ®å‡½æ•°å‚æ•°å’Œå‡½æ•°åœ°å€ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Gï¼Œç„¶åå°†è¿™ä¸ªGåŠ å…¥é˜Ÿåˆ—ç­‰å¾…è¿è¡Œ
func newproc1(fn <em>funcval, argp *uint8, narg int32, callergp *g, callerpc uintptr) {
	// get g0
	_g_ := getg()
	// è®¾ç½®g0å¯¹åº”çš„mçš„locks++, ç¦æ­¢æŠ¢å 
	_g_.m.locks++ // disable preemption because it can be holding p in a local var
	// get the p that m has
	_p_ := _g_.m.p.ptr()
	// new a g
	newg := gfget(_p_)
	if newg == nil {
		newg = malg(_StackMin)
		casgstatus(newg, _Gidle, _Gdead)
		allgadd(newg) // publishes with a g-&gt;status of Gdead so GC scanner doesnâ€™t look at uninitialized stack.
	}
	totalSize := 4</em>sys.RegSize + uintptr(siz) + sys.MinFrameSize // extra space in case of reads slightly beyond frame
	totalSize += -totalSize &amp; (sys.SpAlign - 1)                  // align to spAlign
	sp := newg.stack.hi - totalSize
	spArg := sp</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//  åˆå§‹åŒ– gï¼Œg çš„ gobuf ç°åœºï¼Œg çš„ m çš„ curg
// ä»¥åŠå„ç§å¯„å­˜å™¨
memclrNoHeapPointers(unsafe.Pointer(&amp;newg.sched), unsafe.Sizeof(newg.sched))
newg.sched.sp = sp
newg.stktopsp = sp
newg.sched.pc = funcPC(goexit) + sys.PCQuantum // +PCQuantum so that previous instruction is in same function
newg.sched.g = guintptr(unsafe.Pointer(newg))
gostartcallfn(&amp;newg.sched, fn)
newg.gopc = callerpc
newg.ancestors = saveAncestors(callergp)
newg.startpc = fn.fn
if _g_.m.curg != nil {
	newg.labels = _g_.m.curg.labels
}
if isSystemGoroutine(newg) {
	atomic.Xadd(&amp;sched.ngsys, +1)
}
newg.gcscanvalid = false
casgstatus(newg, _Gdead, _Grunnable)

newg.goid = int64(_p_.goidcache)
_p_.goidcache++
//
runqput(_p_, newg, true)

if atomic.Load(&amp;sched.npidle) != 0 &amp;&amp; atomic.Load(&amp;sched.nmspinning) == 0 &amp;&amp; mainStarted {
	wakep()
}
_g_.m.locks--
if _g_.m.locks == 0 &amp;&amp; _g_.preempt { // restore the preemption request in case we've cleared it in newstack
	_g_.stackguard0 = stackPreempt
} } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>è°ƒç”¨getg(æ±‡ç¼–å®ç°)è·å–å½“å‰çš„g, ä¼šç¼–è¯‘ä¸ºè¯»å–FSå¯„å­˜å™¨(TLS), è¿™é‡Œä¼šè·å–åˆ°g0
è®¾ç½®gå¯¹åº”çš„mçš„locks++, ç¦æ­¢æŠ¢å 
è·å–mæ‹¥æœ‰çš„p
æ–°å»ºä¸€ä¸ªgç­–ç•¥ï¼š
è°ƒç”¨ gfgetå‡½æ•°ï¼Œè¿™é‡Œæ˜¯å¤ç”¨ä¼˜å…ˆç­–ç•¥
é¦–å…ˆä»pçš„gfreeè·å–å›æ”¶çš„gï¼Œå¦‚æœp.gfreeé“¾è¡¨ä¸ºç©ºï¼Œå°±ä»å…¨å±€è°ƒåº¦å™¨schedé‡Œé¢çš„gfreeé“¾è¡¨é‡Œé¢steal 32ä¸ªfreeçš„gç»™p.gfreeã€‚
å°†p.gfreeé“¾è¡¨çš„headå…ƒç´ è·å–è¿”å›ã€‚
å¦‚æœè·å–ä¸åˆ°freegæ—¶è°ƒç”¨malg()å‡½æ•°æ–°å»ºä¸€ä¸ªg, åˆå§‹çš„æ ˆç©ºé—´å¤§å°æ˜¯2Kã€‚
æŠŠå‚æ•°å¤åˆ¶åˆ°gçš„æ ˆä¸Š
æŠŠè¿”å›åœ°å€å¤åˆ¶åˆ°gçš„æ ˆä¸Š, è¿™é‡Œçš„è¿”å›åœ°å€æ˜¯goexit, è¡¨ç¤ºè°ƒç”¨å®Œç›®æ ‡å‡½æ•°åä¼šè°ƒç”¨goexit
è®¾ç½®gçš„è°ƒåº¦æ•°æ®(sched)
è®¾ç½®sched.spç­‰äºå‚æ•°+è¿”å›åœ°å€åçš„rspåœ°å€
è®¾ç½®sched.pcç­‰äºç›®æ ‡å‡½æ•°çš„åœ°å€, æŸ¥çœ‹gostartcallfnå’Œgostartcall
è®¾ç½®sched.gç­‰äºg
è®¾ç½®gçš„çŠ¶æ€ä¸ºå¾…è¿è¡Œ(_Grunnable)
è°ƒç”¨runqputå‡½æ•°æŠŠgæ”¾åˆ°è¿è¡Œé˜Ÿåˆ—
é¦–å…ˆéšæœºæŠŠgæ”¾åˆ°p.runnext, å¦‚æœæ”¾åˆ°runnextåˆ™å…¥é˜ŸåŸæ¥åœ¨runnextçš„gï¼›
ç„¶åå°è¯•æŠŠgæ”¾åˆ°Pçš„local queueï¼›
å¦‚æœlocal queueï¼ˆ256 capacityï¼‰æ»¡äº†åˆ™è°ƒç”¨runqputslowå‡½æ•°æŠŠgæ”¾åˆ°â€å…¨å±€è¿è¡Œé˜Ÿåˆ—â€ï¼ˆæ“ä½œå…¨å±€ sched æ—¶ï¼Œéœ€è¦è·å–å…¨å±€ sched.lock é”ï¼Œå…¨å±€é”äº‰æŠ¢çš„å¼€é”€è¾ƒå¤§ï¼Œæ‰€ä»¥æ‰ç§°ä¹‹ä¸º slow
runqputslowä¼šæŠŠæœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­ä¸€åŠçš„gæ”¾åˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—, è¿™æ ·ä¸‹æ¬¡å°±å¯ä»¥å¿«é€Ÿä½¿ç”¨local queue.
å¦‚æœå½“å‰æœ‰ç©ºé—²çš„Pï¼Œä½†æ˜¯æ²¡æœ‰è‡ªæ—‹çš„M(nmspinningç­‰äº0)ï¼Œå¹¶ä¸”ä¸»å‡½æ•°å·²æ‰§è¡Œï¼Œåˆ™å”¤é†’æˆ–æ–°å»ºä¸€ä¸ªMæ¥è°ƒåº¦ä¸€ä¸ªPæ‰§è¡Œ
è¿™ä¸€æ­¥éå¸¸é‡è¦, ç”¨äºä¿è¯å½“å‰æœ‰è¶³å¤Ÿçš„Mè¿è¡ŒG, å…·ä½“è¯·æŸ¥çœ‹ä¸Šé¢çš„â€ç©ºé—²Mé“¾è¡¨â€
å”¤é†’æˆ–æ–°å»ºä¸€ä¸ªMä¼šé€šè¿‡è°ƒç”¨wakepå‡½æ•°
é¦–å…ˆäº¤æ¢nmspinningåˆ°1, æˆåŠŸå†ç»§ç»­, å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œwakepå‡½æ•°åªæœ‰ä¸€ä¸ªä¼šç»§ç»­
è°ƒç”¨startmå‡½æ•°
è°ƒç”¨pidlegetä»â€ç©ºé—²Pé“¾è¡¨â€è·å–ä¸€ä¸ªç©ºé—²çš„P
è°ƒç”¨mgetä»â€ç©ºé—²Mé“¾è¡¨â€è·å–ä¸€ä¸ªç©ºé—²çš„M
å¦‚æœæ²¡æœ‰ç©ºé—²çš„M, åˆ™è°ƒç”¨newmæ–°å»ºä¸€ä¸ªM
newmä¼šæ–°å»ºä¸€ä¸ªmçš„å®ä¾‹, mçš„å®ä¾‹åŒ…å«ä¸€ä¸ªg0, ç„¶åè°ƒç”¨newosproccloneä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹
newosprocä¼šè°ƒç”¨syscall cloneåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹
çº¿ç¨‹åˆ›å»ºåä¼šè®¾ç½®TLS, è®¾ç½®TLSä¸­å½“å‰çš„gä¸ºg0, ç„¶åæ‰§è¡Œmstart
è°ƒç”¨notewakeup(&amp;mp.park)å”¤é†’çº¿ç¨‹
åˆ›å»ºgoroutineçš„æµç¨‹å°±è¿™ä¹ˆå¤šäº†, æ¥ä¸‹æ¥çœ‹çœ‹Mæ˜¯å¦‚ä½•è°ƒåº¦çš„.</p>

<p>3.4 å¾ªç¯è°ƒåº¦scheduleè¿‡ç¨‹
ä»å‰é¢æè¿°çš„è°ƒåº¦å™¨çš„å·¥ä½œæµå¯çŸ¥ï¼Œscheduleræ˜¯ä¸€ä¸ªå¾ªç¯çš„è¿‡ç¨‹ã€‚</p>

<p>Må¯åŠ¨æ—¶ä¼šè°ƒç”¨mstartå‡½æ•°ï¼Œm0åœ¨åˆå§‹åŒ–åè°ƒç”¨ï¼Œå…¶ä»–çš„måœ¨çº¿ç¨‹å¯åŠ¨åè°ƒç”¨ã€‚proc.goæºç é‡Œé¢è¿™ä¸ªå‡½æ•°çš„æ³¨é‡Šå°±æ˜¯ï¼š</p>

<p>//Called to start an M. begin scheduling
1
mstartå‡½æ•°çš„å¤„ç†å¦‚ä¸‹:</p>

<p>é¦–å…ˆè°ƒç”¨getgå‡½æ•°è·å–å½“å‰çš„g, è¿™é‡Œä¼šè·å–åˆ°g0
å¦‚æœg0æœªåˆ†é…æ ˆåˆ™ä»å½“å‰çš„æ ˆç©ºé—´(ç³»ç»Ÿæ ˆç©ºé—´)ä¸Šåˆ†é…, ä¹Ÿå°±æ˜¯è¯´g0ä¼šä½¿ç”¨ç³»ç»Ÿæ ˆç©ºé—´
è°ƒç”¨mstart1å‡½æ•°
è°ƒç”¨gosaveå‡½æ•°ä¿å­˜å½“å‰çš„çŠ¶æ€åˆ°g0çš„è°ƒåº¦æ•°æ®ä¸­, ä»¥åæ¯æ¬¡è°ƒåº¦éƒ½ä¼šä»è¿™ä¸ªæ ˆåœ°å€å¼€å§‹ï¼›
è°ƒç”¨asminitå‡½æ•°, ä¸åšä»»ä½•äº‹æƒ…ï¼›
è°ƒç”¨minitå‡½æ•°, è®¾ç½®å½“å‰çº¿ç¨‹å¯ä»¥æ¥æ”¶çš„ä¿¡å·(signal)ï¼›
è°ƒç”¨scheduleå‡½æ•°ã€‚
è°ƒç”¨scheduleå‡½æ•°åå°±è¿›å…¥äº†è°ƒåº¦å¾ªç¯ï¼Œæ•´ä¸ªæµç¨‹å¯ä»¥ç®€å•æ€»ç»“ä¸ºï¼š</p>

<p>scheduleå‡½æ•°è·å–g =&gt; [å¿…è¦æ—¶ä¼‘çœ ] =&gt; [å”¤é†’åç»§ç»­è·å–] =&gt; executeå‡½æ•°æ‰§è¡Œg =&gt; æ‰§è¡Œåè¿”å›åˆ°goexit =&gt; é‡æ–°æ‰§è¡Œscheduleå‡½æ•°
scheduleå‡½æ•°å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š</p>

<p>è·å–å½“å‰è°ƒåº¦çš„gï¼Œä¹Ÿå°±æ˜¯g0ï¼Œg0åœ¨æ‰§è¡Œè°ƒåº¦é€»è¾‘ï¼›
å¦‚æœå½“å‰GCéœ€è¦åœæ­¢æ•´ä¸ªä¸–ç•Œï¼ˆSTW), åˆ™è°ƒç”¨gcstopmä¼‘çœ å½“å‰çš„Mï¼›
å¦‚æœMæ‹¥æœ‰çš„Pä¸­æŒ‡å®šäº†éœ€è¦åœ¨å®‰å…¨ç‚¹è¿è¡Œçš„å‡½æ•°(P.runSafePointFn), åˆ™è¿è¡Œå®ƒï¼›
å¿«é€Ÿè·å–å¾…è¿è¡Œçš„G, ä»¥ä¸‹å¤„ç†å¦‚æœæœ‰ä¸€ä¸ªè·å–æˆåŠŸåé¢å°±ä¸ä¼šç»§ç»­è·å–ï¼š
å¦‚æœå½“å‰GCæ­£åœ¨æ ‡è®°é˜¶æ®µ, åˆ™æŸ¥æ‰¾æœ‰æ²¡æœ‰å¾…è¿è¡Œçš„GC Worker, GC Workerä¹Ÿæ˜¯ä¸€ä¸ªGï¼›
ä¸ºäº†å…¬å¹³èµ·è§, æ¯61æ¬¡è°ƒåº¦ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—è·å–ä¸€æ¬¡G, (ä¸€ç›´ä»æœ¬åœ°è·å–å¯èƒ½å¯¼è‡´å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­çš„Gä¸è¢«è¿è¡Œ)ï¼›
ä»Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–G, è°ƒç”¨runqgetå‡½æ•°ã€‚
å¿«é€Ÿè·å–å¤±è´¥æ—¶, è°ƒç”¨findrunnableå‡½æ•°è·å–å¾…è¿è¡Œçš„G, ä¼šé˜»å¡åˆ°è·å–æˆåŠŸä¸ºæ­¢ï¼š
å¦‚æœå½“å‰GCéœ€è¦åœæ­¢æ•´ä¸ªä¸–ç•Œï¼ˆSTW), åˆ™è°ƒç”¨stopmä¼‘çœ å½“å‰çš„Mï¼›
å¦‚æœMæ‹¥æœ‰çš„Pä¸­æŒ‡å®šäº†éœ€è¦åœ¨å®‰å…¨ç‚¹è¿è¡Œçš„å‡½æ•°(P.runSafePointFn), åˆ™è¿è¡Œå®ƒï¼›
å¦‚æœæœ‰ææ„å™¨å¾…è¿è¡Œåˆ™ä½¿ç”¨â€è¿è¡Œææ„å™¨çš„Gâ€ï¼›
ä»Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ä¸­è·å–G, è°ƒç”¨runqgetå‡½æ•°ï¼Œå¦‚æœè·å–åˆ°å°±è¿”å›ï¼›
ä»å…¨å±€è¿è¡Œé˜Ÿåˆ—è·å–G, è°ƒç”¨globrunqgetå‡½æ•°, éœ€è¦ä¸Šé”ï¼Œè·å–åˆ°å°±è¿”å›ã€‚ï¼›
ä»ç½‘ç»œäº‹ä»¶ååº”å™¨è·å–G, å‡½æ•°netpollä¼šè·å–å“ªäº›fdå¯è¯»å¯å†™æˆ–å·²å…³é—­, ç„¶åè¿”å›ç­‰å¾…fdç›¸å…³äº‹ä»¶çš„Gï¼›
å¦‚æœä»local å’Œ global éƒ½è·å–ä¸åˆ°G, åˆ™æ‰§è¡ŒWork Stealingï¼š
è°ƒç”¨runqstealå°è¯•ä»å…¶ä»–Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ç›—å–ä¸€åŠçš„Gã€‚
å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°G, å°±éœ€è¦ä¼‘çœ Mäº†, æ¥ä¸‹æ¥æ˜¯ä¼‘çœ çš„æ­¥éª¤ï¼š
å†æ¬¡æ£€æŸ¥å½“å‰GCæ˜¯å¦åœ¨æ ‡è®°é˜¶æ®µ, åœ¨åˆ™æŸ¥æ‰¾æœ‰æ²¡æœ‰å¾…è¿è¡Œçš„GC Worker, GC Workerä¹Ÿæ˜¯ä¸€ä¸ªGï¼›
å†æ¬¡æ£€æŸ¥å¦‚æœå½“å‰GCéœ€è¦åœæ­¢æ•´ä¸ªä¸–ç•Œ, æˆ–è€…PæŒ‡å®šäº†éœ€è¦å†å®‰å…¨ç‚¹è¿è¡Œçš„å‡½æ•°, åˆ™è·³åˆ°findrunnableçš„é¡¶éƒ¨é‡è¯•ï¼›
å†æ¬¡æ£€æŸ¥å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰G, æœ‰åˆ™è·å–å¹¶è¿”å›ï¼›
é‡Šæ”¾Mæ‹¥æœ‰çš„P, Pä¼šå˜ä¸ºç©ºé—²(_Pidle)çŠ¶æ€ï¼›
æŠŠPæ·»åŠ åˆ°â€ç©ºé—²Pé“¾è¡¨â€ä¸­ï¼›
è®©Mç¦»å¼€è‡ªæ—‹çŠ¶æ€, è¿™é‡Œçš„å¤„ç†éå¸¸é‡è¦, å‚è€ƒä¸Šé¢çš„â€ç©ºé—²Mé“¾è¡¨â€ï¼›
é¦–å…ˆå‡å°‘è¡¨ç¤ºå½“å‰è‡ªæ—‹ä¸­çš„Mçš„æ•°é‡çš„å…¨å±€å˜é‡nmspinningï¼›
å†æ¬¡æ£€æŸ¥æ‰€æœ‰Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—, å¦‚æœä¸ä¸ºç©ºåˆ™è®©Mé‡æ–°è¿›å…¥è‡ªæ—‹çŠ¶æ€, å¹¶è·³findrunnableçš„é¡¶éƒ¨é‡è¯•ï¼›
å†æ¬¡æ£€æŸ¥æœ‰æ²¡æœ‰å¾…è¿è¡Œçš„GC Worker, æœ‰åˆ™è®©Mé‡æ–°è¿›å…¥è‡ªæ—‹çŠ¶æ€, å¹¶è·³åˆ°findrunnableçš„é¡¶éƒ¨é‡è¯•
å†æ¬¡æ£€æŸ¥ç½‘ç»œäº‹ä»¶ååº”å™¨æ˜¯å¦æœ‰å¾…è¿è¡Œçš„G, è¿™é‡Œå¯¹netpollçš„è°ƒç”¨ä¼šé˜»å¡, ç›´åˆ°æŸä¸ªfdæ”¶åˆ°äº†äº‹ä»¶ï¼›
å¦‚æœæœ€ç»ˆè¿˜æ˜¯è·å–ä¸åˆ°G, è°ƒç”¨stopmä¼‘çœ å½“å‰çš„Mï¼›
å”¤é†’åè·³åˆ°findrunnableçš„é¡¶éƒ¨é‡è¯•ã€‚
æˆåŠŸè·å–åˆ°ä¸€ä¸ªå¾…è¿è¡Œçš„Gï¼›
è®©Mç¦»å¼€è‡ªæ—‹çŠ¶æ€, è°ƒç”¨resetspinning, è¿™é‡Œçš„å¤„ç†å’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼š
å¦‚æœå½“å‰æœ‰ç©ºé—²çš„P, ä½†æ˜¯æ— è‡ªæ—‹çš„M(nmspinningç­‰äº0), åˆ™å”¤é†’æˆ–æ–°å»ºä¸€ä¸ªMï¼›
ä¸Šé¢ç¦»å¼€è‡ªæ—‹çŠ¶æ€æ˜¯ä¸ºäº†ä¼‘çœ M, æ‰€ä»¥ä¼šå†æ¬¡æ£€æŸ¥æ‰€æœ‰é˜Ÿåˆ—ç„¶åä¼‘çœ ï¼›
è¿™é‡Œç¦»å¼€è‡ªé€‰çŠ¶æ€æ˜¯ä¸ºäº†æ‰§è¡ŒG, æ‰€ä»¥ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²çš„P, æœ‰åˆ™è¡¨ç¤ºå¯ä»¥å†å¼€æ–°çš„Mæ‰§è¡ŒGã€‚
å¦‚æœGè¦æ±‚å›åˆ°æŒ‡å®šçš„M(ä¾‹å¦‚ä¸Šé¢çš„runtime.main)ï¼š
è°ƒç”¨startlockedmå‡½æ•°æŠŠGå’ŒPäº¤ç»™è¯¥M, è‡ªå·±è¿›å…¥ä¼‘çœ ï¼›
ä»ä¼‘çœ å”¤é†’åè·³åˆ°scheduleçš„é¡¶éƒ¨é‡è¯•
è°ƒç”¨executeå‡½æ•°åœ¨å½“å‰Mä¸Šæ‰§è¡ŒGã€‚
executeå‡½æ•°æ‰§è¡Œgpçš„å¤„ç†å¦‚ä¸‹:</p>

<p>è°ƒç”¨getgè·å–å½“å‰çš„g(g0)ï¼›
æŠŠG(gp)çš„çŠ¶æ€ç”±å¾…è¿è¡Œ(_Grunnable)æ”¹ä¸ºè¿è¡Œä¸­(_Grunning)ï¼›
è®¾ç½®Gçš„stackguard, æ ˆç©ºé—´ä¸è¶³æ—¶å¯ä»¥æ‰©å¼ ï¼›
å¢åŠ Pä¸­è®°å½•çš„è°ƒåº¦æ¬¡æ•°(å¯¹åº”ä¸Šé¢çš„æ¯61æ¬¡ä¼˜å…ˆè·å–ä¸€æ¬¡å…¨å±€è¿è¡Œé˜Ÿåˆ—)ï¼›
è®¾ç½®g.m.curg = gï¼›
è®¾ç½®gp.m = g0.mï¼›
è°ƒç”¨gogoå‡½æ•°(åœ¨Mä¸Šæ‰§è¡Œgpï¼Œé€šè¿‡æ±‡ç¼–ä»£ç å®ç°çš„ï¼Œåœ¨asm_amd64.sé‡Œé¢æœ‰gogoå‡½æ•°åœ¨64ä½å¹³å°ä¸Šå®ç°)ï¼š
è¿™ä¸ªå‡½æ•°ä¼šæ ¹æ®g.schedä¸­ä¿å­˜çš„çŠ¶æ€æ¢å¤å„ä¸ªå¯„å­˜å™¨çš„å€¼å¹¶ç»§ç»­è¿è¡Œg
é¦–å…ˆé’ˆå¯¹g.sched.ctxtè°ƒç”¨å†™å±éšœ(GCæ ‡è®°æŒ‡é’ˆå­˜æ´»), ctxtä¸­ä¸€èˆ¬ä¼šä¿å­˜æŒ‡å‘[å‡½æ•°+å‚æ•°]çš„æŒ‡é’ˆ
è®¾ç½®TLSä¸­çš„gä¸ºg.sched.g, ä¹Ÿå°±æ˜¯gè‡ªèº«
è®¾ç½®rspå¯„å­˜å™¨ä¸ºg.sched.rsp
è®¾ç½®raxå¯„å­˜å™¨ä¸ºg.sched.ret
è®¾ç½®rdxå¯„å­˜å™¨ä¸ºg.sched.ctxt (ä¸Šä¸‹æ–‡)
è®¾ç½®rbpå¯„å­˜å™¨ä¸ºg.sched.rbp
æ¸…ç©ºschedä¸­ä¿å­˜çš„ä¿¡æ¯
è·³è½¬åˆ°g.sched.pc
å› ä¸ºå‰é¢åˆ›å»ºgoroutineçš„newproc1å‡½æ•°æŠŠè¿”å›åœ°å€è®¾ä¸ºäº†goexit, å‡½æ•°è¿è¡Œå®Œæ¯•è¿”å›æ—¶å°†ä¼šè°ƒç”¨goexitå‡½æ•°ã€‚
è‡ªæ­¤ä¸€æ¬¡è°ƒåº¦è¿‡ç¨‹å°±ç»“æŸäº†ã€‚
g.sched.pcåœ¨Gé¦–æ¬¡è¿è¡Œæ—¶ä¼šæŒ‡å‘ç›®æ ‡å‡½æ•°çš„ç¬¬ä¸€æ¡æœºå™¨æŒ‡ä»¤,
å¦‚æœGè¢«æŠ¢å æˆ–è€…ç­‰å¾…èµ„æºè€Œè¿›å…¥ä¼‘çœ , åœ¨ä¼‘çœ å‰ä¼šä¿å­˜çŠ¶æ€åˆ°g.sched,
g.sched.pcä¼šå˜ä¸ºå”¤é†’åéœ€è¦ç»§ç»­æ‰§è¡Œçš„åœ°å€, â€œä¿å­˜çŠ¶æ€â€çš„å®ç°å°†åœ¨ä¸‹é¢è®²è§£.</p>

<p>ç›®æ ‡å‡½æ•°æ‰§è¡Œå®Œæ¯•åä¼šè°ƒç”¨goexitå‡½æ•°ï¼Œgoexitå‡½æ•°ä¼šè°ƒç”¨goexit1å‡½æ•°ï¼Œgoexit1å‡½æ•°ä¼šé€šè¿‡mcallè°ƒç”¨goexit0å‡½æ•°ã€‚
mcallè¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨äºå®ç°â€ä¿å­˜çŠ¶æ€â€çš„, å¤„ç†å¦‚ä¸‹:</p>

<p>è®¾ç½®g.sched.pcç­‰äºå½“å‰çš„è¿”å›åœ°å€
è®¾ç½®g.sched.spç­‰äºå¯„å­˜å™¨rspçš„å€¼
è®¾ç½®g.sched.gç­‰äºå½“å‰çš„g
è®¾ç½®g.sched.bpç­‰äºå¯„å­˜å™¨rbpçš„å€¼
åˆ‡æ¢TLSä¸­å½“å‰çš„gç­‰äºm.g0
è®¾ç½®å¯„å­˜å™¨rspç­‰äºg0.sched.sp, ä½¿ç”¨g0çš„æ ˆç©ºé—´
è®¾ç½®ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåŸæ¥çš„g
è®¾ç½®rdxå¯„å­˜å™¨ä¸ºæŒ‡å‘å‡½æ•°åœ°å€çš„æŒ‡é’ˆ(ä¸Šä¸‹æ–‡)
è°ƒç”¨æŒ‡å®šçš„å‡½æ•°, ä¸ä¼šè¿”å›ã€‚
mcallè¿™ä¸ªå‡½æ•°ä¿å­˜å½“å‰çš„è¿è¡ŒçŠ¶æ€åˆ°g.sched, ç„¶ååˆ‡æ¢åˆ°g0å’Œg0çš„æ ˆç©ºé—´, å†è°ƒç”¨æŒ‡å®šçš„å‡½æ•°ã€‚
å›åˆ°g0çš„æ ˆç©ºé—´è¿™ä¸ªæ­¥éª¤éå¸¸é‡è¦, å› ä¸ºè¿™ä¸ªæ—¶å€™gå·²ç»ä¸­æ–­, ç»§ç»­ä½¿ç”¨gçš„æ ˆç©ºé—´ä¸”å…¶ä»–Må”¤é†’äº†è¿™ä¸ªgå°†ä¼šäº§ç”Ÿç¾éš¾æ€§çš„åæœã€‚
Gåœ¨ä¸­æ–­æˆ–è€…ç»“æŸåéƒ½ä¼šé€šè¿‡mcallå›åˆ°g0çš„æ ˆç©ºé—´ç»§ç»­è°ƒåº¦, ä»goexitè°ƒç”¨çš„mcallçš„ä¿å­˜çŠ¶æ€å…¶å®æ˜¯å¤šä½™çš„, å› ä¸ºGå·²ç»ç»“æŸäº†ã€‚</p>

<p>goexit1å‡½æ•°ä¼šé€šè¿‡mcallè°ƒç”¨goexit0å‡½æ•°, goexit0å‡½æ•°è°ƒç”¨æ—¶å·²ç»å›åˆ°äº†g0çš„æ ˆç©ºé—´, å¤„ç†å¦‚ä¸‹:</p>

<p>æŠŠGçš„çŠ¶æ€ç”±è¿è¡Œä¸­(_Grunning)æ”¹ä¸ºå·²ä¸­æ­¢(_Gdead)
æ¸…ç©ºGçš„æˆå‘˜
è°ƒç”¨dropgå‡½æ•°è§£é™¤Må’ŒGä¹‹é—´çš„å…³è”
è°ƒç”¨gfputå‡½æ•°æŠŠGæ”¾åˆ°Pçš„è‡ªç”±åˆ—è¡¨ä¸­, ä¸‹æ¬¡åˆ›å»ºGæ—¶å¯ä»¥å¤ç”¨
è°ƒç”¨scheduleå‡½æ•°ç»§ç»­è°ƒåº¦
Gç»“æŸåå›åˆ°scheduleå‡½æ•°, è¿™æ ·å°±ç»“æŸäº†ä¸€ä¸ªè°ƒåº¦å¾ªç¯ã€‚
ä¸ä»…åªæœ‰Gç»“æŸä¼šé‡æ–°å¼€å§‹è°ƒåº¦, Gè¢«æŠ¢å æˆ–è€…ç­‰å¾…èµ„æºä¹Ÿä¼šé‡æ–°è¿›è¡Œè°ƒåº¦, ä¸‹é¢ç»§ç»­æ¥çœ‹è¿™ä¸¤ç§æƒ…å†µã€‚</p>

<p>3.5 æŠ¢å å¼è°ƒåº¦å®ç°(sysmonçº¿ç¨‹)
Golang-bootstrapåˆ†æ è¿™ç¯‡æ–‡ç« é‡Œé¢æˆ‘æåˆ°äº†runtime.mainä¼šåˆ›å»ºä¸€ä¸ªé¢å¤–çš„Mè¿è¡Œsysmonå‡½æ•°ï¼ŒæŠ¢å å¼è°ƒåº¦å°±æ˜¯åœ¨sysmonä¸­å®ç°çš„ã€‚</p>

<p>sysmonå‡½æ•°(4249è¡Œ) ä¼šè¿›å…¥ä¸€ä¸ªæ— é™å¾ªç¯ï¼Œç¬¬ä¸€è½®å›ä¼‘çœ 20usï¼Œä¹‹åæ¯æ¬¡ä¼‘çœ æ—¶é—´å€å¢ï¼Œæœ€ç»ˆæ¯ä¸€è½®éƒ½ä¼šä¼‘çœ 10msã€‚</p>

<p>sysmonä¸­æœ‰netpool(è·å–fdäº‹ä»¶)ï¼Œretake(æŠ¢å )ï¼Œforcegc(æŒ‰æ—¶é—´å¼ºåˆ¶æ‰§è¡Œgc),scavenge heap(é‡Šæ”¾è‡ªç”±åˆ—è¡¨ä¸­å¤šä½™çš„é¡¹å‡å°‘å†…å­˜å ç”¨)ç­‰å¤„ç†ã€‚</p>

<p>retakeå‡½æ•°è´Ÿè´£å¤„ç†æŠ¢å ï¼Œæµç¨‹æ˜¯:</p>

<p>æšä¸¾æ‰€æœ‰çš„Pï¼š
å¦‚æœPåœ¨ç³»ç»Ÿè°ƒç”¨ä¸­(_Psyscall), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯(20us~10ms), åˆ™æŠ¢å è¿™ä¸ªP
è°ƒç”¨handoffpè§£é™¤Må’ŒPä¹‹é—´çš„å…³è”
å¦‚æœPåœ¨è¿è¡Œä¸­(_Prunning), ä¸”ç»è¿‡äº†ä¸€æ¬¡sysmonå¾ªç¯å¹¶ä¸”Gè¿è¡Œæ—¶é—´è¶…è¿‡forcePreemptNS(10ms), åˆ™æŠ¢å è¿™ä¸ªP
è°ƒç”¨preemptoneå‡½æ•°
è®¾ç½®g.preempt = true
è®¾ç½®g.stackguard0 = stackPreempt
ä¸ºä»€ä¹ˆè®¾ç½®äº†stackguardå°±å¯ä»¥å®ç°æŠ¢å ?
å› ä¸ºè¿™ä¸ªå€¼ç”¨äºæ£€æŸ¥å½“å‰æ ˆç©ºé—´æ˜¯å¦è¶³å¤Ÿ, goå‡½æ•°çš„å¼€å¤´ä¼šæ¯”å¯¹è¿™ä¸ªå€¼åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å¼ æ ˆ.
stackPreemptæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¸¸é‡, å®ƒçš„å€¼ä¼šæ¯”ä»»ä½•çš„æ ˆåœ°å€éƒ½è¦å¤§, æ£€æŸ¥æ—¶ä¸€å®šä¼šè§¦å‘æ ˆæ‰©å¼ .</p>

<p>æ ˆæ‰©å¼ è°ƒç”¨çš„æ˜¯morestack_noctxtå‡½æ•°, morestack_noctxtå‡½æ•°æ¸…ç©ºrdxå¯„å­˜å™¨å¹¶è°ƒç”¨morestackå‡½æ•°ã€‚
morestackå‡½æ•°ä¼šä¿å­˜Gçš„çŠ¶æ€åˆ°g.sched, åˆ‡æ¢åˆ°g0å’Œg0çš„æ ˆç©ºé—´, ç„¶åè°ƒç”¨newstackå‡½æ•°ã€‚
newstackå‡½æ•°åˆ¤æ–­g.stackguard0ç­‰äºstackPreempt, å°±çŸ¥é“è¿™æ˜¯æŠ¢å è§¦å‘çš„, è¿™æ—¶ä¼šå†æ£€æŸ¥ä¸€éæ˜¯å¦è¦æŠ¢å ï¼š</p>

<p>å¦‚æœMè¢«é”å®š(å‡½æ•°çš„æœ¬åœ°å˜é‡ä¸­æœ‰P), åˆ™è·³è¿‡è¿™ä¸€æ¬¡çš„æŠ¢å å¹¶è°ƒç”¨gogoå‡½æ•°ç»§ç»­è¿è¡ŒG
å¦‚æœMæ­£åœ¨åˆ†é…å†…å­˜, åˆ™è·³è¿‡è¿™ä¸€æ¬¡çš„æŠ¢å å¹¶è°ƒç”¨gogoå‡½æ•°ç»§ç»­è¿è¡ŒG
å¦‚æœMè®¾ç½®äº†å½“å‰ä¸èƒ½æŠ¢å , åˆ™è·³è¿‡è¿™ä¸€æ¬¡çš„æŠ¢å å¹¶è°ƒç”¨gogoå‡½æ•°ç»§ç»­è¿è¡ŒG
å¦‚æœMçš„çŠ¶æ€ä¸æ˜¯è¿è¡Œä¸­, åˆ™è·³è¿‡è¿™ä¸€æ¬¡çš„æŠ¢å å¹¶è°ƒç”¨gogoå‡½æ•°ç»§ç»­è¿è¡ŒG
å³ä½¿è¿™ä¸€æ¬¡æŠ¢å å¤±è´¥, å› ä¸ºg.preemptç­‰äºtrue, runtimeä¸­çš„ä¸€äº›ä»£ç ä¼šé‡æ–°è®¾ç½®stackPreemptä»¥é‡è¯•ä¸‹ä¸€æ¬¡çš„æŠ¢å ã€‚
å¦‚æœåˆ¤æ–­å¯ä»¥æŠ¢å , åˆ™ç»§ç»­åˆ¤æ–­æ˜¯å¦GCå¼•èµ·çš„, å¦‚æœæ˜¯åˆ™å¯¹Gçš„æ ˆç©ºé—´æ‰§è¡Œæ ‡è®°å¤„ç†(æ‰«ææ ¹å¯¹è±¡)ç„¶åç»§ç»­è¿è¡Œã€‚
å¦‚æœä¸æ˜¯GCå¼•èµ·çš„åˆ™è°ƒç”¨gopreempt_må‡½æ•°å®ŒæˆæŠ¢å ã€‚</p>

<p>gopreempt_må‡½æ•°ä¼šè°ƒç”¨goschedImplå‡½æ•°, goschedImplå‡½æ•°çš„æµç¨‹æ˜¯:</p>

<p>æŠŠGçš„çŠ¶æ€ç”±è¿è¡Œä¸­(_Grunnable)æ”¹ä¸ºå¾…è¿è¡Œ(_Grunnable)
è°ƒç”¨dropgå‡½æ•°è§£é™¤Må’ŒGä¹‹é—´çš„å…³è”
è°ƒç”¨globrunqputæŠŠGæ”¾åˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—
è°ƒç”¨scheduleå‡½æ•°ç»§ç»­è°ƒåº¦
ä¸ºå…¨å±€è¿è¡Œé˜Ÿåˆ—çš„ä¼˜å…ˆåº¦æ¯”è¾ƒä½, å„ä¸ªMä¼šç»è¿‡ä¸€æ®µæ—¶é—´å†å»é‡æ–°è·å–è¿™ä¸ªGæ‰§è¡Œï¼Œ</p>

<p>æŠ¢å æœºåˆ¶ä¿è¯äº†ä¸ä¼šæœ‰ä¸€ä¸ªGé•¿æ—¶é—´çš„è¿è¡Œå¯¼è‡´å…¶ä»–Gæ— æ³•è¿è¡Œçš„æƒ…å†µå‘ç”Ÿã€‚</p>

<p>Section4ï¼šschedulerä¸memory allocationã€channelã€garbage collectionå…³è”éƒ¨åˆ†</p>

<p>goroutineä¸è°ƒåº¦å™¨
æˆ‘ä»¬éƒ½çŸ¥é“Goè¯­è¨€æ˜¯åŸç”Ÿæ”¯æŒè¯­è¨€çº§å¹¶å‘çš„ï¼Œè¿™ä¸ªå¹¶å‘çš„æœ€å°é€»è¾‘å•å…ƒå°±æ˜¯goroutineã€‚goroutineå°±æ˜¯Goè¯­è¨€æä¾›çš„ä¸€ç§ç”¨æˆ·æ€çº¿ç¨‹ï¼Œå½“ç„¶è¿™ç§ç”¨æˆ·æ€çº¿ç¨‹æ˜¯è·‘åœ¨å†…æ ¸çº§çº¿ç¨‹ä¹‹ä¸Šçš„ã€‚å½“æˆ‘ä»¬åˆ›å»ºäº†å¾ˆå¤šçš„goroutineï¼Œå¹¶ä¸”å®ƒä»¬éƒ½æ˜¯è·‘åœ¨åŒä¸€ä¸ªå†…æ ¸çº¿ç¨‹ä¹‹ä¸Šçš„æ—¶å€™ï¼Œå°±éœ€è¦ä¸€ä¸ªè°ƒåº¦å™¨æ¥ç»´æŠ¤è¿™äº›goroutineï¼Œç¡®ä¿æ‰€æœ‰çš„goroutineéƒ½ä½¿ç”¨cpuï¼Œå¹¶ä¸”æ˜¯å°½å¯èƒ½å…¬å¹³çš„ä½¿ç”¨cpuèµ„æºã€‚</p>

<p>è¿™ä¸ªè°ƒåº¦å™¨çš„åŸç†ä»¥åŠå®ç°å€¼å¾—æˆ‘ä»¬å»æ·±å…¥ç ”ç©¶ä¸€ä¸‹ã€‚æ”¯æ’‘æ•´ä¸ªè°ƒåº¦å™¨çš„ä¸»è¦æœ‰4ä¸ªé‡è¦ç»“æ„ï¼Œåˆ†åˆ«æ˜¯Mã€Gã€Pã€Schedï¼Œå‰ä¸‰ä¸ªå®šä¹‰åœ¨runtime.hä¸­ï¼ŒSchedå®šä¹‰åœ¨proc.cä¸­ã€‚</p>

<p>Schedç»“æ„å°±æ˜¯è°ƒåº¦å™¨ï¼Œå®ƒç»´æŠ¤æœ‰å­˜å‚¨Må’ŒGçš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚
Mä»£è¡¨å†…æ ¸çº§çº¿ç¨‹ï¼Œä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œgoroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯ã€‚
På…¨ç§°æ˜¯Processorï¼Œå¤„ç†å™¨ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªgoroutineé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutineï¼Œè¿™ä¸ªPçš„è§’è‰²å¯èƒ½æœ‰ä¸€ç‚¹è®©äººè¿·æƒ‘ï¼Œä¸€å¼€å§‹å®¹æ˜“å’ŒMå†²çªï¼Œåé¢é‡ç‚¹èŠä¸€ä¸‹å®ƒä»¬çš„å…³ç³»ã€‚
Gå°±æ˜¯goroutineå®ç°çš„æ ¸å¿ƒç»“æ„äº†ï¼ŒGç»´æŠ¤äº†goroutineéœ€è¦çš„æ ˆã€ç¨‹åºè®¡æ•°å™¨ä»¥åŠå®ƒæ‰€åœ¨çš„Mç­‰ä¿¡æ¯ã€‚
ç†è§£Mã€Pã€Gä¸‰è€…çš„å…³ç³»å¯¹ç†è§£æ•´ä¸ªè°ƒåº¦å™¨éå¸¸é‡è¦ï¼Œæˆ‘ä»ç½‘ç»œä¸Šæ‰¾äº†ä¸€ä¸ªå›¾æ¥è¯´æ˜å…¶ä¸‰è€…å…³ç³»ï¼š
è¿™é‡Œå†™å›¾ç‰‡æè¿°
åœ°é¼ (gopher)ç”¨å°è½¦è¿ç€ä¸€å †å¾…åŠ å·¥çš„ç –ã€‚Må°±å¯ä»¥çœ‹ä½œå›¾ä¸­çš„åœ°é¼ ï¼ŒPå°±æ˜¯å°è½¦ï¼ŒGå°±æ˜¯å°è½¦é‡Œè£…çš„ç –ã€‚ä¸€å›¾èƒœåƒè¨€å•Šï¼Œå¼„æ¸…æ¥šäº†å®ƒä»¬ä¸‰è€…çš„å…³ç³»ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¼€å§‹é‡ç‚¹èŠåœ°é¼ æ˜¯å¦‚ä½•åœ¨æ¬è¿ç –å—çš„ã€‚</p>

<p>å¯åŠ¨è¿‡ç¨‹
åœ¨å…³å¿ƒç»å¤§å¤šæ•°ç¨‹åºçš„å†…éƒ¨åŸç†çš„æ—¶å€™ï¼Œæˆ‘ä»¬éƒ½è¯•å›¾å»å¼„æ˜ç™½å…¶å¯åŠ¨åˆå§‹åŒ–è¿‡ç¨‹ï¼Œå¼„æ˜ç™½è¿™ä¸ªè¿‡ç¨‹å¯¹åç»­çš„æ·±å…¥åˆ†æè‡³å…³é‡è¦ã€‚åœ¨asm_amd64.sæ–‡ä»¶ä¸­çš„æ±‡ç¼–ä»£ç _rt0_amd64å°±æ˜¯æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ï¼Œæ ¸å¿ƒè¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>CALL    runtimeÂ·args(SB)
CALL    runtimeÂ·osinit(SB)
CALL    runtimeÂ·hashinit(SB)
CALL    runtimeÂ·schedinit(SB)</p>

<p>// create a new goroutine to start program
PUSHQ   $runtimeÂ·mainÂ·f(SB)        // entry
PUSHQ   $0         // arg size
CALL    runtimeÂ·newproc(SB)
POPQ    AX
POPQ    AX</p>

<p>// start this M
CALL    runtimeÂ·mstart(SB)
1
2
3
4
5
6
7
8
9
10
11
12
13
14
å¯åŠ¨è¿‡ç¨‹åšäº†è°ƒåº¦å™¨åˆå§‹åŒ–runtimeÂ·schedinitåï¼Œè°ƒç”¨runtimeÂ·newprocåˆ›å»ºå‡ºç¬¬ä¸€ä¸ªgoroutineï¼Œè¿™ä¸ªgoroutineå°†æ‰§è¡Œçš„å‡½æ•°æ˜¯runtimeÂ·mainï¼Œè¿™ç¬¬ä¸€ä¸ªgoroutineä¹Ÿå°±æ˜¯æ‰€è°“çš„ä¸»goroutineã€‚æˆ‘ä»¬å†™çš„æœ€ç®€å•çš„Goç¨‹åºâ€helloï¼Œworldâ€å°±æ˜¯å®Œå…¨è·‘åœ¨è¿™ä¸ªgoroutineé‡Œï¼Œå½“ç„¶ä»»ä½•ä¸€ä¸ªGoç¨‹åºçš„å…¥å£éƒ½æ˜¯ä»è¿™ä¸ªgoroutineå¼€å§‹çš„ã€‚æœ€åè°ƒç”¨çš„runtimeÂ·mstartå°±æ˜¯çœŸæ­£çš„æ‰§è¡Œä¸Šä¸€æ­¥åˆ›å»ºçš„ä¸»goroutineã€‚</p>

<p>å¯åŠ¨è¿‡ç¨‹ä¸­çš„è°ƒåº¦å™¨åˆå§‹åŒ–runtimeÂ·schedinitå‡½æ•°ä¸»è¦æ ¹æ®ç”¨æˆ·è®¾ç½®çš„GOMAXPROCSå€¼æ¥åˆ›å»ºä¸€æ‰¹å°è½¦(P)ï¼Œä¸ç®¡GOMAXPROCSè®¾ç½®ä¸ºå¤šå¤§ï¼Œæœ€å¤šä¹Ÿåªèƒ½åˆ›å»º256ä¸ªå°è½¦(P)ã€‚è¿™äº›å°è½¦(p)åˆå§‹åˆ›å»ºå¥½åéƒ½æ˜¯é—²ç½®çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¿˜æ²¡å¼€å§‹ä½¿ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½æ”¾ç½®åœ¨è°ƒåº¦å™¨ç»“æ„(Sched)çš„pidleå­—æ®µç»´æŠ¤çš„é“¾è¡¨ä¸­å­˜å‚¨èµ·æ¥äº†ï¼Œä»¥å¤‡åç»­ä¹‹éœ€ã€‚</p>

<p>æŸ¥çœ‹runtimeÂ·mainå‡½æ•°å¯ä»¥äº†è§£åˆ°ä¸»goroutineå¼€å§‹æ‰§è¡Œåï¼Œåšçš„ç¬¬ä¸€ä»¶äº‹æƒ…æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å†…æ ¸çº¿ç¨‹(åœ°é¼ M)ï¼Œä¸è¿‡è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªç‰¹æ®Šçº¿ç¨‹ï¼Œå®ƒåœ¨æ•´ä¸ªè¿è¡ŒæœŸä¸“é—¨è´Ÿè´£åšç‰¹å®šçš„äº‹æƒ…â€”â€”ç³»ç»Ÿç›‘æ§(sysmon)ã€‚æ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥Goç¨‹åºçš„mainå‡½æ•°å¼€å§‹Goç¨‹åºçš„æ‰§è¡Œã€‚</p>

<p>è‡³æ­¤ï¼ŒGoç¨‹åºå°±è¢«å¯åŠ¨èµ·æ¥å¼€å§‹è¿è¡Œäº†ã€‚ä¸€ä¸ªçœŸæ­£å¹²æ´»çš„Goç¨‹åºï¼Œä¸€å®šåˆ›å»ºæœ‰ä¸å°‘çš„goroutineï¼Œæ‰€ä»¥åœ¨Goç¨‹åºå¼€å§‹è¿è¡Œåï¼Œå°±ä¼šå‘è°ƒåº¦å™¨æ·»åŠ goroutineï¼Œè°ƒåº¦å™¨å°±è¦è´Ÿè´£ç»´æŠ¤å¥½è¿™äº›goroutineçš„æ­£å¸¸æ‰§è¡Œã€‚</p>

<p>åˆ›å»ºgoroutine(G)
åœ¨Goç¨‹åºä¸­ï¼Œæ—¶å¸¸ä¼šæœ‰ç±»ä¼¼ä»£ç ï¼š</p>

<p>go do_something()
1
goå…³é”®å­—å°±æ˜¯ç”¨æ¥åˆ›å»ºä¸€ä¸ªgoroutineçš„ï¼Œåé¢çš„å‡½æ•°å°±æ˜¯è¿™ä¸ªgoroutineéœ€è¦æ‰§è¡Œçš„ä»£ç é€»è¾‘ã€‚goå…³é”®å­—å¯¹åº”åˆ°è°ƒåº¦å™¨çš„æ¥å£å°±æ˜¯runtimeÂ·newprocã€‚runtimeÂ·newprocå¹²çš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±è´Ÿè´£åˆ¶é€ ä¸€å—ç –(G)ï¼Œç„¶åå°†è¿™å—ç –(G)æ”¾å…¥å½“å‰è¿™ä¸ªåœ°é¼ (M)çš„å°è½¦(P)ä¸­ã€‚</p>

<p>æ¯ä¸ªæ–°çš„goroutineéƒ½éœ€è¦æœ‰ä¸€ä¸ªè‡ªå·±çš„æ ˆï¼ŒGç»“æ„çš„schedå­—æ®µç»´æŠ¤äº†æ ˆåœ°å€ä»¥åŠç¨‹åºè®¡æ•°å™¨ç­‰ä¿¡æ¯ï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„è°ƒåº¦ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªgoroutineæ”¾å¼ƒcpuçš„æ—¶å€™éœ€è¦ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œå¾…ä¸‹æ¬¡é‡æ–°è·å¾—cpuçš„æ—¶å€™ï¼Œéœ€è¦å°†è¿™äº›ä¿¡æ¯è£…è½½åˆ°å¯¹åº”çš„cpuå¯„å­˜å™¨ä¸­ã€‚</p>

<p>å‡è®¾è¿™ä¸ªæ—¶å€™å·²ç»åˆ›å»ºäº†å¤§é‡çš„goroutneï¼Œå°±è½®åˆ°è°ƒåº¦å™¨å»ç»´æŠ¤è¿™äº›goroutineäº†ã€‚</p>

<p>åˆ›å»ºå†…æ ¸çº¿ç¨‹(M)
è¿™é‡Œå†™å›¾ç‰‡æè¿°
Goç¨‹åºä¸­æ²¡æœ‰è¯­è¨€çº§çš„å…³é”®å­—è®©ä½ å»åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œä½ åªèƒ½åˆ›å»ºgoroutineï¼Œå†…æ ¸çº¿ç¨‹åªèƒ½ç”±runtimeæ ¹æ®å®é™…æƒ…å†µå»åˆ›å»ºã€‚runtimeä»€ä¹ˆæ—¶å€™åˆ›å»ºçº¿ç¨‹ï¼Ÿä»¥åœ°é¼ è¿ç –å›¾æ¥è®²ï¼Œç –(G)å¤ªå¤šäº†ï¼Œåœ°é¼ (M)åˆå¤ªå°‘äº†ï¼Œå®åœ¨å¿™ä¸è¿‡æ¥ï¼Œåˆšå¥½è¿˜æœ‰ç©ºé—²çš„å°è½¦(P)æ²¡æœ‰ä½¿ç”¨ï¼Œé‚£å°±ä»åˆ«å¤„å†å€Ÿäº›åœ°é¼ (M)è¿‡æ¥ç›´åˆ°æŠŠå°è½¦(p)ç”¨å®Œä¸ºæ­¢ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªåœ°é¼ (M)ä¸å¤Ÿç”¨ï¼Œä»åˆ«å¤„å€Ÿåœ°é¼ (M)çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹(M)ã€‚åˆ›å»ºMçš„æ¥å£å‡½æ•°æ˜¯:</p>

<p>void newm(void (*fn)(void), P *p)
1
newmå‡½æ•°çš„æ ¸å¿ƒè¡Œä¸ºå°±æ˜¯è°ƒç”¨cloneç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œæ¯ä¸ªå†…æ ¸çº¿ç¨‹çš„å¼€å§‹æ‰§è¡Œä½ç½®éƒ½æ˜¯runtimeÂ·mstartå‡½æ•°ã€‚å‚æ•°på°±æ˜¯ä¸€è¾†ç©ºé—²çš„å°è½¦(p)ã€‚</p>

<p>æ¯ä¸ªåˆ›å»ºå¥½çš„å†…æ ¸çº¿ç¨‹éƒ½ä»runtimeÂ·mstartå‡½æ•°å¼€å§‹æ‰§è¡Œäº†ï¼Œå®ƒä»¬å°†ç”¨åˆ†é…ç»™è‡ªå·±å°è½¦å»æ¬ç –äº†ã€‚</p>

<p>è°ƒåº¦æ ¸å¿ƒ
newmæ¥å£åªæ˜¯ç»™æ–°åˆ›å»ºçš„Måˆ†é…äº†ä¸€ä¸ªç©ºé—²çš„Pï¼Œä¹Ÿå°±æ˜¯ç›¸å½“äºå‘Šè¯‰å€Ÿæ¥çš„åœ°é¼ (M)â€”â€”â€œæ¥ä¸‹æ¥çš„æ—¥å­ï¼Œä½ å°†ä½¿ç”¨1å·å°è½¦æ¬ç –ï¼Œè®°ä½æ˜¯1å·å°è½¦ï¼›å¾…ä¼šè‡ªå·±åˆ°åœè½¦åœºæ‹¿è½¦ã€‚â€ï¼Œåœ°é¼ (M)å»æ‹¿å°è½¦(P)è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯acquirepã€‚runtimeÂ·mstartåœ¨è¿›å…¥scheduleä¹‹å‰ä¼šç»™å½“å‰Mè£…é…ä¸ŠPï¼ŒruntimeÂ·mstartå‡½æ•°ä¸­çš„ä»£ç ï¼š</p>

<p>} else if(m != &amp;runtimeÂ·m0) {
    acquirep(m-&gt;nextp);
    m-&gt;nextp = nil;
}
schedule();
1
2
3
4
5
ifåˆ†æ”¯çš„å†…å®¹å°±æ˜¯ä¸ºå½“å‰Mè£…é…ä¸ŠPï¼Œnextpå°±æ˜¯newmåˆ†é…çš„ç©ºé—²å°è½¦(P)ï¼Œåªæ˜¯åˆ°è¿™ä¸ªæ—¶å€™æ‰çœŸæ­£æ‹¿åˆ°æ‰‹ç½¢äº†ã€‚æ²¡æœ‰Pï¼ŒMæ˜¯æ— æ³•æ‰§è¡Œgoroutineçš„ï¼Œå°±åƒåœ°é¼ æ²¡æœ‰å°è½¦æ— æ³•è¿ç –ä¸€æ ·çš„é“ç†ã€‚å¯¹åº”acquirepçš„åŠ¨ä½œæ˜¯releasepï¼ŒæŠŠMè£…é…çš„Pç»™è½½æ‰ï¼›æ´»å¹²å®Œäº†ï¼Œåœ°é¼ éœ€è¦ä¼‘æ¯äº†ï¼Œå°±æŠŠå°è½¦è¿˜åˆ°åœè½¦åœºï¼Œç„¶åç¡è§‰å»ã€‚</p>

<p>åœ°é¼ (M)æ‹¿åˆ°å±äºè‡ªå·±çš„å°è½¦(P)åï¼Œå°±è¿›å…¥å·¥åœºå¼€å§‹å¹²æ´»äº†ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„scheduleè°ƒç”¨ã€‚ç®€åŒ–scheduleçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p>static void
schedule(void)
{
    G *gp;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp = runqget(m-&gt;p);
if(gp == nil)
    gp = findrunnable();

if (m-&gt;p-&gt;runqhead != m-&gt;p-&gt;runqtail &amp;&amp;
    runtimeÂ·atomicload(&amp;runtimeÂ·sched.nmspinning) == 0 &amp;&amp;
    runtimeÂ·atomicload(&amp;runtimeÂ·sched.npidle) &gt; 0)  // TODO: fast atomic
    wakep();

execute(gp); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 scheduleå‡½æ•°è¢«æˆ‘ç®€åŒ–äº†å¤ªå¤šï¼Œä¸»è¦æ˜¯æˆ‘ä¸å–œæ¬¢è´´å¤§æ®µå¤§æ®µçš„ä»£ç ï¼Œå› æ­¤åªä¿ç•™ä¸»å¹²ä»£ç äº†ã€‚è¿™é‡Œæ¶‰åŠåˆ°4å¤§æ­¥é€»è¾‘ï¼š è¿™é‡Œå†™å›¾ç‰‡æè¿° runqget, åœ°é¼ (M)è¯•å›¾ä»è‡ªå·±çš„å°è½¦(P)å–å‡ºä¸€å—ç –(G)ï¼Œå½“ç„¶ç»“æœå¯èƒ½å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªåœ°é¼ çš„å°è½¦å·²ç»ç©ºäº†ï¼Œæ²¡æœ‰ç –äº†ã€‚ findrunnable, å¦‚æœåœ°é¼ è‡ªå·±çš„å°è½¦ä¸­æ²¡æœ‰ç –ï¼Œé‚£ä¹Ÿä¸èƒ½é—²ç€ä¸å¹²æ´»æ˜¯å§ï¼Œæ‰€ä»¥åœ°é¼ å°±ä¼šè¯•å›¾è·‘å»å·¥åœºä»“åº“å–ä¸€å—ç –æ¥å¤„ç†ï¼›å·¥åœºä»“åº“ä¹Ÿå¯èƒ½æ²¡ç –å•Šï¼Œå‡ºç°è¿™ç§æƒ…å†µçš„æ—¶å€™ï¼Œè¿™ä¸ªåœ°é¼ ä¹Ÿæ²¡æœ‰å·æ‡’åœä¸‹å¹²æ´»ï¼Œè€Œæ˜¯æ‚„æ‚„è·‘å‡ºå»ï¼Œéšæœºç›¯ä¸Šä¸€ä¸ªå°ä¼™ä¼´(åœ°é¼ )ï¼Œç„¶åä»å®ƒçš„è½¦é‡Œè¯•å›¾å·ä¸€åŠç –åˆ°è‡ªå·±è½¦é‡Œã€‚å¦‚æœå¤šæ¬¡å°è¯•å·ç –éƒ½å¤±è´¥äº†ï¼Œé‚£è¯´æ˜å®åœ¨æ²¡æœ‰ç –å¯æ¬äº†ï¼Œè¿™ä¸ªæ—¶å€™åœ°é¼ å°±ä¼šæŠŠå°è½¦è¿˜å›åœè½¦åœºï¼Œç„¶åç¡è§‰ä¼‘æ¯äº†ã€‚å¦‚æœåœ°é¼ ç¡è§‰äº†ï¼Œä¸‹é¢çš„è¿‡ç¨‹å½“ç„¶éƒ½åœæ­¢äº†ï¼Œåœ°é¼ ç¡è§‰ä¹Ÿå°±æ˜¯çº¿ç¨‹sleepäº†ã€‚ wakep, åˆ°è¿™ä¸ªè¿‡ç¨‹çš„æ—¶å€™ï¼Œå¯æ€œçš„åœ°é¼ å‘ç°è‡ªå·±å°è½¦é‡Œæœ‰å¥½å¤šç –å•Šï¼Œè‡ªå·±æ ¹æœ¬å¤„ç†ä¸è¿‡æ¥ï¼›å†å›å¤´ä¸€çœ‹åœè½¦åœºå±…ç„¶æœ‰é—²ç½®çš„å°è½¦ï¼Œç«‹é©¬è·‘åˆ°å®¿èˆä¸€çœ‹ï¼Œä½ å¦¹ï¼Œå±…ç„¶è¿˜æœ‰å°ä¼™ä¼´åœ¨ç¡è§‰ï¼Œç›´æ¥ç»™å±è‚¡ä¸€è„šï¼Œâ€œä½ å¦¹ï¼Œå±…ç„¶è¿˜åœ¨ç¡è§‰ï¼Œè€å­éƒ½å¿«ç´¯æ­»äº†ï¼Œèµ¶ç´§èµ·æ¥å¹²æ´»ï¼Œåˆ†æ‹…ç‚¹å·¥ä½œã€‚â€ï¼Œå°ä¼™ä¼´é†’äº†ï¼Œæ‹¿ä¸Šè‡ªå·±çš„å°è½¦ï¼Œä¹–ä¹–å¹²æ´»å»äº†ã€‚æœ‰æ—¶å€™ï¼Œå¯æ€œçš„åœ°é¼ è·‘åˆ°å®¿èˆå´å‘ç°æ²¡æœ‰åœ¨ç¡è§‰çš„å°ä¼™ä¼´ï¼Œäºæ˜¯ä¼šå¾ˆå¤±æœ›ï¼Œæœ€ååªå¥½å‘å·¥åœºè€æ¿è¯´â€”â€”â€åœè½¦åœºè¿˜æœ‰é—²ç½®çš„è½¦å•Šï¼Œæˆ‘å¿«å¹²ä¸åŠ¨äº†ï¼Œèµ¶ç´§ä»åˆ«çš„å·¥åœºå€Ÿä¸ªåœ°é¼ æ¥å¸®å¿™å§ã€‚â€ï¼Œæœ€åå·¥åœºè€æ¿å°±ææ¥ä¸€ä¸ªæ–°çš„åœ°é¼ å¹²æ´»äº†ã€‚ executeï¼Œåœ°é¼ æ‹¿ç€ç –æ”¾å…¥ç«ç§æ¬¢å¿«çš„çƒ§ç»ƒèµ·æ¥ã€‚ æ³¨ï¼š â€œåœ°é¼ å·ç –â€å«work stealingï¼Œä¸€ç§è°ƒåº¦ç®—æ³•ã€‚ åˆ°è¿™é‡Œï¼Œè²Œä¼¼æ•´ä¸ªå·¥åœºéƒ½æ­£å¸¸çš„è¿è½¬èµ·æ¥äº†ï¼Œæ— æ‡ˆå¯å‡»çš„æ ·å­ã€‚ä¸å¯¹ï¼Œè¿˜æœ‰ä¸€ä¸ªç–‘ç‚¹æ²¡è§£å†³å•Šï¼Œå‡è®¾åœ°é¼ çš„è½¦é‡Œæœ‰å¾ˆå¤šç –ï¼Œå®ƒæŠŠä¸€å—ç –æ”¾å…¥ç«ç‚‰ä¸­åï¼Œä½•æ—¶æŠŠå®ƒå–å‡ºæ¥ï¼Œæ”¾å…¥ç¬¬äºŒå—ç –å‘¢ï¼Ÿéš¾é“è¦ä¸€ç›´æŠŠç¬¬ä¸€å—ç –çƒ§ç»ƒå¥½ï¼Œæ‰å–å‡ºæ¥å—ï¼Ÿé‚£ä¼°è®¡åé¢çš„ç –çœŸçš„æ˜¯ç­‰å¾—èŠ±å„¿éƒ½è¦è°¢äº†ã€‚è¿™é‡Œå°±æ˜¯è¦çœŸæ­£è§£å†³goroutineçš„è°ƒåº¦ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢é—®é¢˜ã€‚
</code></pre></div></div>

<p>è°ƒåº¦ç‚¹ å½“æˆ‘ä»¬ç¿»çœ‹channelçš„å®ç°ä»£ç å¯ä»¥å‘ç°ï¼Œå¯¹channelè¯»å†™æ“ä½œçš„æ—¶å€™ä¼šè§¦å‘è°ƒç”¨runtimeÂ·parkå‡½æ•°ã€‚goroutineè°ƒç”¨parkåï¼Œè¿™ä¸ªgoroutineå°±ä¼šè¢«è®¾ç½®ä½waitingçŠ¶æ€ï¼Œæ”¾å¼ƒcpuã€‚è¢«parkçš„goroutineå¤„äºwaitingçŠ¶æ€ï¼Œå¹¶ä¸”è¿™ä¸ªgoroutineä¸åœ¨å°è½¦(P)ä¸­ï¼Œå¦‚æœä¸å¯¹å…¶è°ƒç”¨runtimeÂ·readyï¼Œå®ƒæ˜¯æ°¸è¿œä¸ä¼šå†è¢«æ‰§è¡Œçš„ã€‚é™¤äº†channelæ“ä½œå¤–ï¼Œå®šæ—¶å™¨ä¸­ï¼Œç½‘ç»œpollç­‰éƒ½æœ‰å¯èƒ½park goroutineã€‚
é™¤äº†parkå¯ä»¥æ”¾å¼ƒcpuå¤–ï¼Œè°ƒç”¨runtimeÂ·goschedå‡½æ•°ä¹Ÿå¯ä»¥è®©å½“å‰goroutineæ”¾å¼ƒcpuï¼Œä½†å’Œparkå®Œå…¨ä¸åŒï¼›goschedæ˜¯å°†goroutineè®¾ç½®ä¸ºrunnableçŠ¶æ€ï¼Œç„¶åæ”¾å…¥åˆ°è°ƒåº¦å™¨å…¨å±€ç­‰å¾…é˜Ÿåˆ—ï¼ˆä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„å·¥åœºä»“åº“ï¼Œè¿™ä¸‹å°±æ˜ç™½ä¸ºä½•å·¥åœºä»“åº“ä¼šæœ‰ç –å—(G)äº†å§ï¼‰ã€‚</p>

<p>é™¤æ­¤ä¹‹å¤–ï¼Œå°±è½®åˆ°ç³»ç»Ÿè°ƒç”¨äº†ï¼Œæœ‰äº›ç³»ç»Ÿè°ƒç”¨ä¹Ÿä¼šè§¦å‘é‡æ–°è°ƒåº¦ã€‚Goè¯­è¨€å®Œå…¨æ˜¯è‡ªå·±å°è£…çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥åœ¨å°è£…ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œå¯ä»¥åšä¸å°‘æ‰‹è„šï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™æ‰§è¡Œentersyscallï¼Œé€€å‡ºååˆæ‰§è¡Œexitsyscallå‡½æ•°ã€‚ ä¹Ÿåªæœ‰å°è£…äº†entersyscallçš„ç³»ç»Ÿè°ƒç”¨æ‰æœ‰å¯èƒ½è§¦å‘é‡æ–°è°ƒåº¦ï¼Œå®ƒå°†æ”¹å˜å°è½¦(P)çš„çŠ¶æ€ä¸ºsyscallã€‚è¿˜è®°ä¸€å¼€å§‹æåˆ°çš„sysmonçº¿ç¨‹å—ï¼Ÿè¿™ä¸ªç³»ç»Ÿç›‘æ§çº¿ç¨‹ä¼šæ‰«ææ‰€æœ‰çš„å°è½¦(P)ï¼Œå‘ç°ä¸€ä¸ªå°è½¦(P)å¤„äºäº†syscallçš„çŠ¶æ€ï¼Œå°±çŸ¥é“è¿™ä¸ªå°è½¦(P)é‡åˆ°äº†goroutineåœ¨åšç³»ç»Ÿè°ƒç”¨ï¼Œäºæ˜¯ç³»ç»Ÿç›‘æ§çº¿ç¨‹å°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„åœ°é¼ (M)å»æŠŠè¿™ä¸ªå¤„äºsyscallçš„å°è½¦ç»™æŠ¢è¿‡æ¥ï¼Œå¼€å§‹å¹²æ´»ï¼Œè¿™æ ·è¿™ä¸ªå°è½¦ä¸­çš„æ‰€æœ‰ç –å—(G)å°±å¯ä»¥ç»•è¿‡ä¹‹å‰ç³»ç»Ÿè°ƒç”¨çš„ç­‰å¾…äº†ã€‚è¢«æŠ¢èµ°å°è½¦çš„åœ°é¼ ç­‰ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œå‘ç°è‡ªå·±çš„è½¦æ²¡ï¼Œä¸èƒ½ç»§ç»­å¹²æ´»äº†ï¼Œäºæ˜¯åªèƒ½æŠŠæ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„goroutineæ”¾å›åˆ°å·¥åœºä»“åº“ï¼Œè‡ªå·±ç¡è§‰å»äº†ã€‚</p>

<p>ä»goroutineçš„è°ƒåº¦ç‚¹å¯ä»¥çœ‹å‡ºï¼Œè°ƒåº¦å™¨è¿˜æ˜¯æŒºç²—æš´çš„ï¼Œè°ƒåº¦ç²’åº¦æœ‰ç‚¹è¿‡å¤§ï¼Œå…¬å¹³æ€§ä¹Ÿæ²¡æœ‰æƒ³æƒ³çš„é‚£ä¹ˆå¥½ã€‚æ€»ä¹‹ï¼Œè¿™ä¸ªè°ƒåº¦å™¨è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚</p>

<p>ç°åœºå¤„ç† goroutineåœ¨cpuä¸Šæ¢å…¥æ¢å‡ºï¼Œä¸æ–­ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™ï¼Œå¿…é¡»è¦ä¿è¯çš„äº‹æƒ…å°±æ˜¯ä¿å­˜ç°åœºå’Œæ¢å¤ç°åœºï¼Œä¿å­˜ç°åœºå°±æ˜¯åœ¨goroutineæ”¾å¼ƒcpuçš„æ—¶å€™ï¼Œå°†ç›¸å…³å¯„å­˜å™¨çš„å€¼ç»™ä¿å­˜åˆ°å†…å­˜ä¸­ï¼›æ¢å¤ç°åœºå°±æ˜¯åœ¨goroutineé‡æ–°è·å¾—cpuçš„æ—¶å€™ï¼Œéœ€è¦ä»å†…å­˜æŠŠä¹‹å‰çš„å¯„å­˜å™¨ä¿¡æ¯å…¨éƒ¨æ”¾å›åˆ°ç›¸åº”å¯„å­˜å™¨ä¸­å»ã€‚
goroutineåœ¨ä¸»åŠ¨æ”¾å¼ƒcpuçš„æ—¶å€™(park/gosched)ï¼Œéƒ½ä¼šæ¶‰åŠåˆ°è°ƒç”¨runtimeÂ·mcallå‡½æ•°ï¼Œæ­¤å‡½æ•°ä¹Ÿæ˜¯æ±‡ç¼–å®ç°ï¼Œä¸»è¦å°†goroutineçš„æ ˆåœ°å€å’Œç¨‹åºè®¡æ•°å™¨ä¿å­˜åˆ°Gç»“æ„çš„schedå­—æ®µä¸­ï¼Œmcallå°±å®Œæˆäº†ç°åœºä¿å­˜ã€‚æ¢å¤ç°åœºçš„å‡½æ•°æ˜¯runtimeÂ·gogocallï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦åœ¨executeä¸­è°ƒç”¨ï¼Œå°±æ˜¯åœ¨æ‰§è¡Œgoroutineå‰ï¼Œéœ€è¦é‡æ–°è£…è½½ç›¸åº”çš„å¯„å­˜å™¨ã€‚</p>
:ET