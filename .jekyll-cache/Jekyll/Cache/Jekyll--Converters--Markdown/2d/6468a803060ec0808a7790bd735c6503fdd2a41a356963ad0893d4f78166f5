I"·2<p>å•ä¸ªå¼‚æ­¥ä»»åŠ¡</p>

<p>var fetch = require(â€˜node-fetchâ€™);</p>

<p>function* gen(){
  var url = â€˜https://api.github.com/users/githubâ€™;
  var result = yield fetch(url);
  console.log(result.bio);
}
ä¸ºäº†è·å¾—æœ€ç»ˆçš„æ‰§è¡Œç»“æœï¼Œä½ éœ€è¦è¿™æ ·åšï¼š</p>

<p>var g = gen();
var result = g.next();</p>

<p>result.value.then(function(data){
  return data.json();
}).then(function(data){
  g.next(data);
});
é¦–å…ˆæ‰§è¡Œ Generator å‡½æ•°ï¼Œè·å–éå†å™¨å¯¹è±¡ã€‚</p>

<p>ç„¶åä½¿ç”¨ next æ–¹æ³•ï¼Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ç¬¬ä¸€é˜¶æ®µï¼Œå³ fetch(url)ã€‚</p>

<p>æ³¨æ„ï¼Œç”±äº fetch(url) ä¼šè¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæ‰€ä»¥ result çš„å€¼ä¸ºï¼š</p>

<p>1
{ value: Promise { <pending> }, done: false }
æœ€åæˆ‘ä»¬ä¸ºè¿™ä¸ª Promise å¯¹è±¡æ·»åŠ ä¸€ä¸ª then æ–¹æ³•ï¼Œå…ˆå°†å…¶è¿”å›çš„æ•°æ®æ ¼å¼åŒ–(data.json())ï¼Œå†è°ƒç”¨ g.nextï¼Œå°†è·å¾—çš„æ•°æ®ä¼ è¿›å»ï¼Œç”±æ­¤å¯ä»¥æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡çš„ç¬¬äºŒé˜¶æ®µï¼Œä»£ç æ‰§è¡Œå®Œæ¯•ã€‚</pending></p>

<p>å¤šä¸ªå¼‚æ­¥ä»»åŠ¡</p>

<p>ä¸ŠèŠ‚æˆ‘ä»¬åªè°ƒç”¨äº†ä¸€ä¸ªæ¥å£ï¼Œé‚£å¦‚æœæˆ‘ä»¬è°ƒç”¨äº†å¤šä¸ªæ¥å£ï¼Œä½¿ç”¨äº†å¤šä¸ª yieldï¼Œæˆ‘ä»¬å²‚ä¸æ˜¯è¦åœ¨ then å‡½æ•°ä¸­ä¸æ–­çš„åµŒå¥—ä¸‹å»â€¦â€¦</p>

<p>æ‰€ä»¥æˆ‘ä»¬æ¥çœ‹çœ‹æ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡çš„æƒ…å†µï¼š</p>

<p>var fetch = require(â€˜node-fetchâ€™);</p>

<p>function* gen() {
  var r1 = yield fetch(â€˜https://api.github.com/users/githubâ€™);
  var r2 = yield fetch(â€˜https://api.github.com/users/github/followersâ€™);
  var r3 = yield fetch(â€˜https://api.github.com/users/github/reposâ€™);</p>

<p>console.log([r1.bio, r2[0].login, r3[0].full_name].join(â€˜\nâ€™));
}
ä¸ºäº†è·å¾—æœ€ç»ˆçš„æ‰§è¡Œç»“æœï¼Œä½ å¯èƒ½è¦å†™æˆï¼š</p>

<p>var g = gen();
var result1 = g.next();</p>

<p>result1.value.then(function(data){
  return data.json();
})
.then(function(data){
  return g.next(data).value;
})
.then(function(data){
  return data.json();
})
.then(function(data){
  return g.next(data).value
})
.then(function(data){
  return data.json();
})
.then(function(data){
  g.next(data)
});
ä½†æˆ‘çŸ¥é“ä½ è‚¯å®šä¸æƒ³å†™æˆè¿™æ ·â€¦â€¦</p>

<p>å…¶å®ï¼Œåˆ©ç”¨é€’å½’ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å†™ï¼š</p>

<p>function run(gen) {
  var g = gen();</p>

<p>function next(data) {
    var result = g.next(data);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (result.done) return;
 
result.value.then(function(data) {
  return data.json();
}).then(function(data) {
  next(data);
});
</code></pre></div></div>

<p>}</p>

<p>next();
}</p>

<p>run(gen);
å…¶ä¸­çš„å…³é”®å°±æ˜¯ yield çš„æ—¶å€™è¿”å›ä¸€ä¸ª Promise å¯¹è±¡ï¼Œç»™è¿™ä¸ª Promise å¯¹è±¡æ·»åŠ  then æ–¹æ³•ï¼Œå½“å¼‚æ­¥æ“ä½œæˆåŠŸæ—¶æ‰§è¡Œ then ä¸­çš„ onFullfilled å‡½æ•°ï¼ŒonFullfilled å‡½æ•°ä¸­åˆå»æ‰§è¡Œ g.nextï¼Œä»è€Œè®© Generator ç»§ç»­æ‰§è¡Œï¼Œç„¶åå†è¿”å›ä¸€ä¸ª Promiseï¼Œå†åœ¨æˆåŠŸæ—¶æ‰§è¡Œ g.nextï¼Œç„¶åå†è¿”å›â€¦â€¦</p>

<p>å¯åŠ¨å™¨å‡½æ•°</p>

<p>åœ¨ run è¿™ä¸ªå¯åŠ¨å™¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åœ¨ then å‡½æ•°ä¸­å°†æ•°æ®æ ¼å¼åŒ– data.json()ï¼Œä½†åœ¨æ›´å¹¿æ³›çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ yield ç›´æ¥è·Ÿä¸€ä¸ª Promiseï¼Œè€Œéä¸€ä¸ª fetch å‡½æ•°è¿”å›çš„ Promiseï¼Œå› ä¸ºæ²¡æœ‰ json æ–¹æ³•ï¼Œä»£ç å°±ä¼šæŠ¥é”™ã€‚æ‰€ä»¥ä¸ºäº†æ›´å…·å¤‡é€šç”¨æ€§ï¼Œè¿åŒè¿™ä¸ªä¾‹å­å’Œå¯åŠ¨å™¨ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸ºï¼š</p>

<p>var fetch = require(â€˜node-fetchâ€™);</p>

<p>function* gen() {
  var r1 = yield fetch(â€˜https://api.github.com/users/githubâ€™);
  var json1 = yield r1.json();
  var r2 = yield fetch(â€˜https://api.github.com/users/github/followersâ€™);
  var json2 = yield r2.json();
  var r3 = yield fetch(â€˜https://api.github.com/users/github/reposâ€™);
  var json3 = yield r3.json();</p>

<p>console.log([json1.bio, json2[0].login, json3[0].full_name].join(â€˜\nâ€™));
}</p>

<p>function run(gen) {
  var g = gen();</p>

<p>function next(data) {
    var result = g.next(data);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (result.done) return;
 
result.value.then(function(data) {
  next(data);
});
</code></pre></div></div>

<p>}</p>

<p>next();
}</p>

<p>run(gen);
åªè¦ yield åè·Ÿç€ä¸€ä¸ª Promise å¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ª run å‡½æ•°å°† Generator å‡½æ•°è‡ªåŠ¨æ‰§è¡Œã€‚</p>

<p>å›è°ƒå‡½æ•°
yield åä¸€å®šè¦è·Ÿç€ä¸€ä¸ª Promise å¯¹è±¡æ‰èƒ½ä¿è¯ Generator çš„è‡ªåŠ¨æ‰§è¡Œå—ï¼Ÿå¦‚æœåªæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ï¼š</p>

<p>é¦–å…ˆæˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸€ä¸ªæ™®é€šçš„å¼‚æ­¥è¯·æ±‚ï¼š</p>

<p>function fetchData(url, cb) {
  setTimeout(function(){
    cb({status: 200, data: url})
  }, 1000)
}
æˆ‘ä»¬å°†è¿™ç§å‡½æ•°æ”¹é€ æˆï¼š</p>

<p>function fetchData(url) {
  return function(cb){
    setTimeout(function(){
      cb({status: 200, data: url})
    }, 1000)
  }
}
å¯¹äºè¿™æ ·çš„ Generator å‡½æ•°ï¼š</p>

<p>function* gen() {
  var r1 = yield fetchData(â€˜https://api.github.com/users/githubâ€™);
  var r2 = yield fetchData(â€˜https://api.github.com/users/github/followersâ€™);</p>

<p>console.log([r1.data, r2.data].join(â€˜\nâ€™));
}
å¦‚æœè¦è·å¾—æœ€ç»ˆçš„ç»“æœï¼š</p>

<p>var g = gen();</p>

<p>var r1 = g.next();</p>

<p>r1.value(function(data) {
  var r2 = g.next(data);
  r2.value(function(data) {
    g.next(data);
  });
});
å¦‚æœå†™æˆè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¼šé¢ä¸´è·Ÿç¬¬ä¸€èŠ‚åŒæ ·çš„é—®é¢˜ï¼Œé‚£å°±æ˜¯å½“ä½¿ç”¨å¤šä¸ª yield æ—¶ï¼Œä»£ç ä¼šå¾ªç¯åµŒå¥—èµ·æ¥â€¦â€¦</p>

<p>åŒæ ·åˆ©ç”¨é€’å½’ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¹é€ ä¸ºï¼š</p>

<p>function run(gen) {
  var g = gen();</p>

<p>function next(data) {
    var result = g.next(data);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (result.done) return;
 
result.value(next);   }
</code></pre></div></div>

<p>next();
}</p>

<p>run(gen);
run
ç”±æ­¤å¯ä»¥çœ‹åˆ° Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œéœ€è¦ä¸€ç§æœºåˆ¶ï¼Œå³å½“å¼‚æ­¥æ“ä½œæœ‰äº†ç»“æœï¼Œèƒ½å¤Ÿè‡ªåŠ¨äº¤å›æ‰§è¡Œæƒã€‚</p>

<p>è€Œä¸¤ç§æ–¹æ³•å¯ä»¥åšåˆ°è¿™ä¸€ç‚¹ã€‚</p>

<p>ï¼ˆ1ï¼‰å›è°ƒå‡½æ•°ã€‚å°†å¼‚æ­¥æ“ä½œè¿›è¡ŒåŒ…è£…ï¼Œæš´éœ²å‡ºå›è°ƒå‡½æ•°ï¼Œåœ¨å›è°ƒå‡½æ•°é‡Œé¢äº¤å›æ‰§è¡Œæƒã€‚</p>

<p>ï¼ˆ2ï¼‰Promise å¯¹è±¡ã€‚å°†å¼‚æ­¥æ“ä½œåŒ…è£…æˆ Promise å¯¹è±¡ï¼Œç”¨ then æ–¹æ³•äº¤å›æ‰§è¡Œæƒã€‚</p>

<p>åœ¨ä¸¤ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å„å†™äº†ä¸€ä¸ª run å¯åŠ¨å™¨å‡½æ•°ï¼Œé‚£æˆ‘ä»¬èƒ½ä¸èƒ½å°†è¿™ä¸¤ç§æ–¹å¼ç»“åˆåœ¨ä¸€äº›ï¼Œå†™ä¸€ä¸ªé€šç”¨çš„ run å‡½æ•°å‘¢ï¼Ÿæˆ‘ä»¬å°è¯•ä¸€ä¸‹ï¼š</p>

<p>// ç¬¬ä¸€ç‰ˆ
function run(gen) {
  var gen = gen();</p>

<p>function next(data) {
    var result = gen.next(data);
    if (result.done) return;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (isPromise(result.value)) {
  result.value.then(function(data) {
    next(data);
  });
} else {
  result.value(next)
}   }
</code></pre></div></div>

<p>next()
}</p>

<p>function isPromise(obj) {
  return â€˜functionâ€™ == typeof obj.then;
}</p>

<p>module.exports = run;
å…¶å®å®ç°çš„å¾ˆç®€å•ï¼Œåˆ¤æ–­ result.value æ˜¯å¦æ˜¯ Promiseï¼Œæ˜¯å°±æ·»åŠ  then å‡½æ•°ï¼Œä¸æ˜¯å°±ç›´æ¥æ‰§è¡Œã€‚</p>

<p>return Promise
æˆ‘ä»¬å·²ç»å†™äº†ä¸€ä¸ªä¸é”™çš„å¯åŠ¨å™¨å‡½æ•°ï¼Œæ”¯æŒ yield åè·Ÿå›è°ƒå‡½æ•°æˆ–è€… Promise å¯¹è±¡ã€‚</p>

<p>ç°åœ¨æœ‰ä¸€ä¸ªé—®é¢˜éœ€è¦æ€è€ƒï¼Œå°±æ˜¯æˆ‘ä»¬å¦‚ä½•è·å¾— Generator å‡½æ•°çš„è¿”å›å€¼å‘¢ï¼Ÿåˆå¦‚æœ Generator å‡½æ•°ä¸­å‡ºç°äº†é”™è¯¯ï¼Œå°±æ¯”å¦‚ fetch äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æ¥å£ï¼Œè¿™ä¸ªé”™è¯¯è¯¥å¦‚ä½•æ•è·å‘¢ï¼Ÿ</p>

<p>è¿™å¾ˆå®¹æ˜“è®©äººæƒ³åˆ° Promiseï¼Œå¦‚æœè¿™ä¸ªå¯åŠ¨å™¨å‡½æ•°è¿”å›ä¸€ä¸ª Promiseï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»™è¿™ä¸ª Promise å¯¹è±¡æ·»åŠ  then å‡½æ•°ï¼Œå½“æ‰€æœ‰çš„å¼‚æ­¥æ“ä½œæ‰§è¡ŒæˆåŠŸåï¼Œæˆ‘ä»¬æ‰§è¡Œ onFullfilled å‡½æ•°ï¼Œå¦‚æœæœ‰ä»»ä½•å¤±è´¥ï¼Œå°±æ‰§è¡Œ onRejected å‡½æ•°ã€‚</p>

<p>æˆ‘ä»¬å†™ä¸€ç‰ˆï¼š</p>

<p>// ç¬¬äºŒç‰ˆ
function run(gen) {
  var gen = gen();</p>

<p>return new Promise(function(resolve, reject) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function next(data) {
  try {
    var result = gen.next(data);
  } catch (e) {
    return reject(e);
  }
 
  if (result.done) {
    return resolve(result.value)
  };
 
  var value = toPromise(result.value);
 
  value.then(function(data) {
    next(data);
  }, function(e) {
    reject(e)
  });
}
 
next()   })
</code></pre></div></div>

<p>}</p>

<p>function isPromise(obj) {
  return â€˜functionâ€™ == typeof obj.then;
}</p>

<p>function toPromise(obj) {
  if (isPromise(obj)) return obj;
  if (â€˜functionâ€™ == typeof obj) return thunkToPromise(obj);
  return obj;
}</p>

<p>function thunkToPromise(fn) {
  return new Promise(function(resolve, reject) {
    fn(function(err, res) {
      if (err) return reject(err);
      resolve(res);
    });
  });
}</p>

<p>module.exports = run;
ä¸ç¬¬ä¸€ç‰ˆæœ‰å¾ˆå¤§çš„ä¸åŒï¼š</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ª Promiseï¼Œå½“ result.done ä¸º true çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†è¯¥å€¼ resolve(result.value)ï¼Œå¦‚æœæ‰§è¡Œçš„è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¢« catch ä½ï¼Œæˆ‘ä»¬ä¼šå°†åŸå›  reject(e)ã€‚</p>

<p>å…¶æ¬¡ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ thunkToPromise å°†å›è°ƒå‡½æ•°åŒ…è£…æˆä¸€ä¸ª Promiseï¼Œç„¶åç»Ÿä¸€çš„æ·»åŠ  then å‡½æ•°ã€‚åœ¨è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ thunkToPromise å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬éµå¾ªäº† error first çš„åŸåˆ™ï¼Œè¿™æ„å‘³ç€å½“æˆ‘ä»¬å¤„ç†å›è°ƒå‡½æ•°çš„æƒ…å†µæ—¶ï¼š</p>

<p>// æ¨¡æ‹Ÿæ•°æ®è¯·æ±‚
function fetchData(url) {
  return function(cb) {
    setTimeout(function() {
      cb(null, { status: 200, data: url })
    }, 1000)
  }
}
åœ¨æˆåŠŸæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åº”è¯¥è¿”å› nullï¼Œè¡¨ç¤ºæ²¡æœ‰é”™è¯¯åŸå› ã€‚</p>

<p>ä¼˜åŒ–
æˆ‘ä»¬åœ¨ç¬¬äºŒç‰ˆçš„åŸºç¡€ä¸Šå°†ä»£ç å†™çš„æ›´åŠ ç®€æ´ä¼˜é›…ä¸€ç‚¹ï¼Œæœ€ç»ˆçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p>// ç¬¬ä¸‰ç‰ˆ
function run(gen) {</p>

<p>return new Promise(function(resolve, reject) {
    if (typeof gen == â€˜functionâ€™) gen = gen();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å¦‚æœ gen ä¸æ˜¯ä¸€ä¸ªè¿­ä»£å™¨
if (!gen || typeof gen.next !== 'function') return resolve(gen)
 
onFulfilled();
 
function onFulfilled(res) {
  var ret;
  try {
    ret = gen.next(res);
  } catch (e) {
    return reject(e);
  }
  next(ret);
}
 
function onRejected(err) {
  var ret;
  try {
    ret = gen.throw(err);
  } catch (e) {
    return reject(e);
  }
  next(ret);
}
 
function next(ret) {
  if (ret.done) return resolve(ret.value);
  var value = toPromise(ret.value);
  if (value &amp;&amp; isPromise(value)) return value.then(onFulfilled, onRejected);
  return onRejected(new TypeError('You may only yield a function, promise ' +
    'but the following object was passed: "' + String(ret.value) + '"'));
}   }) }
</code></pre></div></div>

<p>function isPromise(obj) {
  return â€˜functionâ€™ == typeof obj.then;
}</p>

<p>function toPromise(obj) {
  if (isPromise(obj)) return obj;
  if (â€˜functionâ€™ == typeof obj) return thunkToPromise(obj);
  return obj;
}</p>

<p>function thunkToPromise(fn) {
  return new Promise(function(resolve, reject) {
    fn(function(err, res) {
      if (err) return reject(err);
      resolve(res);
    });
  });
}</p>

<p>module.exports = run;
co
å¦‚æœæˆ‘ä»¬å†å°†è¿™ä¸ªå¯åŠ¨å™¨å‡½æ•°å†™çš„å®Œå–„ä¸€äº›ï¼Œæˆ‘ä»¬å°±ç›¸å½“äºå†™äº†ä¸€ä¸ª coï¼Œå®é™…ä¸Šï¼Œä¸Šé¢çš„ä»£ç ç¡®å®æ˜¯æ¥è‡ªäº coâ€¦â€¦</p>

<p>è€Œ co æ˜¯ä»€ä¹ˆï¼Ÿ co æ˜¯å¤§ç¥ TJ Holowaychuk äº 2013 å¹´ 6 æœˆå‘å¸ƒçš„ä¸€ä¸ªå°æ¨¡å—ï¼Œç”¨äº Generator å‡½æ•°çš„è‡ªåŠ¨æ‰§è¡Œã€‚</p>

<p>å¦‚æœç›´æ¥ä½¿ç”¨ co æ¨¡å—ï¼Œè¿™ä¸¤ç§ä¸åŒçš„ä¾‹å­å¯ä»¥ç®€å†™ä¸ºï¼š</p>

<p>// yield åæ˜¯ä¸€ä¸ª Promise
var fetch = require(â€˜node-fetchâ€™);
var co = require(â€˜coâ€™);</p>

<p>function* gen() {
  var r1 = yield fetch(â€˜https://api.github.com/users/githubâ€™);
  var json1 = yield r1.json();
  var r2 = yield fetch(â€˜https://api.github.com/users/github/followersâ€™);
  var json2 = yield r2.json();
  var r3 = yield fetch(â€˜https://api.github.com/users/github/reposâ€™);
  var json3 = yield r3.json();</p>

<p>console.log([json1.bio, json2[0].login, json3[0].full_name].join(â€˜\nâ€™));
}</p>

<p>co(gen);</p>

<p>// yield åæ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°
var co = require(â€˜coâ€™);</p>

<p>function fetchData(url) {
  return function(cb) {
    setTimeout(function() {
      cb(null, { status: 200, data: url })
    }, 1000)
  }
}</p>

<p>function* gen() {
  var r1 = yield fetchData(â€˜https://api.github.com/users/githubâ€™);
  var r2 = yield fetchData(â€˜https://api.github.com/users/github/followersâ€™);</p>

<p>console.log([r1.data, r2.data].join(â€˜\nâ€™));
}</p>

<p>co(gen);
<!-- more -->
https://github.com/mqyqingfeng/Blog
https://github.com/mqyqingfeng/Blog/issues/99
https://zhuanlan.zhihu.com/p/47645608
https://www.bilibili.com/video/BV1xW411x7sw?p=16</p>

<p>koa
server.use(* ()={}) //è‡ªåŠ¨æ‰§è¡Œnext</p>

<p>co
å¦‚æœä½ æ‰§è¡Œgen.next()ä¼šè¿”å›11: prevï¼Œä¸èƒ½è°ƒç”¨f2å’Œf3ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ å’Œä¸Šé¢ä¸€æ ·ï¼ŒæŠŠyieldéƒ½æ”¹æˆyield* æ˜¯ä¼šé“¾å¼è°ƒç”¨f2ï¼Œf3çš„ã€‚å¯æ˜¯koaæ²¡æœ‰è§„å®šå¿…é¡»ä½¿ç”¨yield*ã€‚ä¸ºäº†æ‰§è¡Œgenï¼Œkoaå¼•å…¥äº†coâ€”â€”ä¸€ä¸ªGneratorè‡ªåŠ¨æ‰§è¡Œå‡½æ•°ã€‚</p>

<p>const co = require (â€˜coâ€™);
co(gen);</p>

<p>https://zhuanlan.zhihu.com/p/50952766</p>

:ET