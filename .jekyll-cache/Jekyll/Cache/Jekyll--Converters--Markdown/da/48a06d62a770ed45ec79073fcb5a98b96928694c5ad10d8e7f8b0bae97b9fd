I"<p>å½“è®¢å•â¼€ä¸€ç›´å¤„äºæœªâ½€æ”¯ä»˜çŠ¶æ€æ—¶ï¼Œå¦‚ä½•åŠæ—¶çš„å…³é—­è®¢å•ï¼Œå¹¶é€€è¿˜åº“å­˜?
å®šæ—¶çš„çˆ†æ¬¾å•†å“è‡ªåŠ¨ä¸Šä¸‹æ¶ã€å¹¿å‘Šçš„å®šæ—¶æ›´æ–°å¦‚ä½•åšåˆ°ï¼Ÿ</p>

<p>æ³¨ï¼šæ–‡ä¸­æ¶æ„è®¾è®¡ä»¥åŠå®é™…å¼€å‘ä¸ºæˆ‘å¸é‡è±å¤§å“¥æ‰€è®¾è®¡ï¼Œç°å…¥èŒç½‘æ˜“è€ƒæ‹‰ã€‚æœ¬æ–‡ä¸è¿‡æ˜¯æ‹¾äººç‰™æ…§ï¼Œå°†å…¶è®¾è®¡ä»¥æ–‡å­—çš„å½¢å¼å‘ˆç°å‡ºæ¥è€Œå·²ã€‚</p>

<p>ç›®æ ‡ï¼š
å¯é æ€§:æ¶ˆæ¯è¿›â¼Šå…¥åˆ°å»¶è¿Ÿé˜Ÿåˆ—åˆ—åï¼Œ ä¿è¯â¾„è‡³å°‘è¢«æ¶ˆè´¹â¼€ä¸€æ¬¡ã€‚</p>

<p>é«˜å¯â½¤ç”¨æ€§:è‡³å°‘å¾—â½€æ”¯æŒå¤šå®ä¾‹ä¾‹éƒ¨ç½²ã€‚æŒ‚æ‰ä¸€ ä¸ªå®ä¾‹ä¾‹åï¼Œè¿˜æœ‰åå¤‡å®ä¾‹ä¾‹ç»§ç»­æä¾›æœåŠ¡ã€‚</p>

<p>å®æ—¶æ€§:å…è®¸å­˜åœ¨â¼€ä¸€å®šçš„æ—¶é—´è¯¯ å·®ï¼Œå¸Œæœ›åœ¨ç§’çº§ã€‚</p>

<p>æ”¯æŒæ¶ˆæ¯åˆ é™¤:ä¸šåŠ¡ä½¿â½¤ç”¨â½…æ–¹ï¼Œå¯ ä»¥éšæ—¶åˆ é™¤æŒ‡å®šæ¶ˆæ¯ã€‚
<!-- more -->
è®¾è®¡æ–¹æ¡ˆå¯¹æ¯”</p>
<ol>
  <li>
    <p>è½®è®­+DB
åŸç†ï¼šå®šæ—¶ä»»åŠ¡æ‰«ææ‰«ædbã€‚ ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œä¿è¯äº†å¯é æ€§ï¼Œé«˜å¯ç”¨æ€§ï¼Œå®æ—¶æ€§ã€‚ ç¼ºç‚¹ï¼šå¾ˆéš¾å®ç°åˆ°ç»†ç²’åº¦ï¼Œå¦åˆ™æ•°æ®åº“å‹åŠ›æ¯”è¾ƒå¤§ï¼Œç¨‹åºCPUå¾ˆå¤§æµªè´¹ã€‚</p>
  </li>
  <li>
    <p>RocketMQ
åŸç†ï¼šmqè‡ªå¸¦å»¶è¿Ÿæ¶ˆè´¹ã€‚ ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œä¿è¯äº†å¯é æ€§ï¼Œé«˜å¯ç”¨æ€§ï¼Œå®æ—¶æ€§ï¼Œä¸éœ€è¦è½®è®­ä»»åŠ¡ï¼ŒMQè‡ªå¸¦å®ç°ã€‚ ç¼ºç‚¹ï¼šæ¯”è¾ƒæ­»çš„ç²’åº¦ï¼Œ18ä¸ªlevelï¼Œæœ€å¤§2å°æ—¶ã€‚</p>
  </li>
  <li>
    <p>Redisé”®è¿‡æœŸé€šçŸ¥
åŸç†ï¼šRedisé€šè¿‡è®¢é˜…è¿‡æœŸçš„æ¶ˆæ¯ï¼Œåšä»»åŠ¡ç›‘å¬ã€‚ ä¼˜ç‚¹ï¼šé«˜å¯ç”¨æ€§ï¼Œå®æ—¶æ€§ã€‚ ç¼ºç‚¹ï¼šå¤§é‡é”®åŒä¸€æ—¶é—´è¿‡æœŸï¼Œå¯¹redisæ¥è¯´è´Ÿè½½å¤§ï¼›æ¶ˆæ¯åªä¼šå‘é€ä¸€æ¬¡ï¼Œæ²¡æœ‰ç¡®è®¤æœºåˆ¶ï¼Œä¸èƒ½ä¿è¯å¯é æ€§ã€‚</p>
  </li>
  <li>
    <p>æœ‰èµçš„å»¶æ—¶æ¶ˆæ¯:Redis(zset)+è½®è®­
åŸç†ï¼šRedis-Zsetï¼Œæ— é™å¾ªç¯æ‰«æä»»åŠ¡Bucketã€‚ ä¼˜ç‚¹ï¼šé«˜å¯ç”¨æ€§ï¼Œå®æ—¶æ€§ï¼ŒæŒä¹…æ€§ã€‚ ç¼ºç‚¹ï¼šç‹¬ç«‹çº¿ç¨‹çš„æ— é™å¾ªç¯ï¼ŒCPUçš„æµªè´¹ï¼›å¦‚æœå•ç‚¹ä»»åŠ¡å¤šï¼Œæ˜¯å¦ä¼šå½±å“åé¢å…¶ä»–ç‚¹çš„ä»»åŠ¡å‡†æ—¶æ€§ï¼›é’ˆå¯¹è¶…é•¿æ—¶é—´ï¼ˆ30å¤©ä»¥ä¸Šï¼‰çš„å»¶è¿Ÿä»»åŠ¡ï¼Œå¦‚æœç»§ç»­ç”¨redisï¼Œæƒ³å¿…æ˜¯å¾ˆæµªè´¹çš„ã€‚</p>
  </li>
</ol>

<p>æ¶ˆæ¯ç»“æ„
æ¯ä¸ªJobå¿…é¡»åŒ…å«ä¸€ä¸‹å‡ ä¸ªå±æ€§ï¼š</p>

<p>Topicï¼šæ¶ˆæ¯çš„Topic
Idï¼šJobçš„å”¯ä¸€æ ‡è¯†ã€‚ç”¨æ¥æ£€ç´¢å’Œåˆ é™¤æŒ‡å®šçš„Jobä¿¡æ¯ã€‚
Delayï¼šJobéœ€è¦å»¶è¿Ÿçš„æ—¶é—´ã€‚å•ä½ï¼šç§’ã€‚ï¼ˆæœåŠ¡ç«¯ä¼šå°†å…¶è½¬æ¢ä¸ºç»å¯¹æ—¶é—´ï¼‰
tagï¼ˆæ¶ˆæ¯ æ ‡ç­¾
msgJsonï¼šçš„å†…å®¹ï¼Œä¾›æ¶ˆè´¹è€…åšå…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼Œä»¥jsonæ ¼å¼å­˜å‚¨ã€‚
å…·ä½“ç»“æ„å¦‚ä¸‹å›¾è¡¨ç¤ºï¼š</p>

<p>æ¶ˆæ¯çŠ¶æ€è½¬æ¢
æ¯ä¸ªJobåªä¼šå¤„äºæŸä¸€ä¸ªçŠ¶æ€ä¸‹ï¼š</p>

<p>readyï¼šå¯æ‰§è¡ŒçŠ¶æ€ï¼Œç­‰å¾…æ¶ˆè´¹ã€‚
delayï¼šä¸å¯æ‰§è¡ŒçŠ¶æ€ï¼Œç­‰å¾…æ—¶é’Ÿå‘¨æœŸã€‚
reservedï¼šå·²è¢«æ¶ˆè´¹è€…è¯»å–ï¼Œä½†è¿˜æœªå¾—åˆ°æ¶ˆè´¹è€…çš„å“åº”ï¼ˆdeleteã€finishï¼‰ã€‚
deletedï¼šå·²è¢«æ¶ˆè´¹å®Œæˆæˆ–è€…å·²è¢«åˆ é™¤ã€‚
å®¹é”™æœºåˆ¶ï¼š
å½“å‰èŠ‚ç‚¹æŒ‚äº†å¦‚ä½•ç¡®ä¿ä»»åŠ¡ä¾ç„¶èƒ½å¤Ÿæ— è¯¯çš„æ‰§è¡Œã€‚</p>

<p>é‡‡ç”¨zookeeperåšä»»åŠ¡èŠ‚ç‚¹é›†ç¾¤ï¼Œå½“å‰èŠ‚ç‚¹çš„ä»»åŠ¡æ”¾å…¥redisç¼“å­˜ï¼Œkeyé‡‡ç”¨ã€ip:pidã€çš„è®¾è®¡ï¼Œä¿è¯åœ¨èŠ‚ç‚¹æŒ‚æ‰çš„æƒ…å†µï¼Œæœ‰å…¶ä»–èŠ‚ç‚¹æ¥æ‰‹ä»»åŠ¡ï¼Œä¿è¯äº†å¯é æ€§å’Œå¯ç”¨æ€§ã€‚
æç«¯æƒ…å†µä¸‹ï¼Œå¯èƒ½å¤šå‘ï¼Œéœ€è¦ä¸šåŠ¡æ–¹ï¼Œä¿è¯å¹‚ç­‰æ€§ã€‚
ä¼˜åŒ–ï¼š10åˆ†é’Ÿçš„ä¸šåŠ¡ä»»åŠ¡ï¼Œæ”¾å…¥redisç¼“å­˜Listã€‚
é™„å½•ï¼š
1ï¼šJDK Timerï¼ˆä½¿ç”¨æ¡ˆä¾‹å¦‚HashedWheelTimeï¼‰
java.util.Timeræ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„å®šæ—¶å™¨ï¼Œå®šæ—¶è°ƒåº¦æ‰€æ‹¥æœ‰çš„TimerTaskä»»åŠ¡,TimerTaskç±»æ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç±»ï¼Œå®ç°äº†Runnableæ¥å£ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œéœ€è¦å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡éƒ½éœ€è¦é‡å†™ä»–çš„runæ–¹æ³•</p>

<p>TaskQueueæ˜¯ä¸€ä¸ªç”±å¹³è¡¡äºŒå‰æ ‘å †å®ç°çš„ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œæ¯ä¸ªTimerå¯¹è±¡å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªTaskQueueé˜Ÿåˆ—ï¼Œç”¨æˆ·çº¿ç¨‹è°ƒç”¨Timerçš„Scheduleæ–¹æ³•å°±æ˜¯æŠŠTimerTaskä»»åŠ¡æ·»åŠ åˆ°TaskQueueé˜Ÿåˆ—ï¼Œåœ¨è°ƒç”¨scheduleæ–¹æ³•æ—¶ï¼Œlong delayå‚æ•°ç”¨æ¥æŒ‡æ˜è¯¥ä»»åŠ¡å»¶è¿Ÿå¤šå°‘æ—¶é—´æ‰§è¡Œã€‚</p>

<p>TimerThreadæ˜¯å…·ä½“æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œä»–ä»TaskQueueé˜Ÿåˆ—é‡Œé¢è·å–ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡è¿›è¡Œæ‰§è¡Œï¼Œåªæœ‰æ‰§è¡Œäº†å½“å‰çš„ä»»åŠ¡æ‰ä¼šä»é˜Ÿåˆ—é‡Œè·å–ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œè€Œä¸ç®¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä»»åŠ¡å·²ç»è¾¾åˆ°äº†è®¾ç½®çš„delayæ—¶é—´ï¼Œä¸€ä¸ªTimeråªæœ‰ä¸€ä¸ªTimerThreaçº¿ç¨‹ï¼Œå› æ­¤å†…éƒ¨å®ç°ä¸ºå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…æ¨¡å‹</p>

<p>1ï¼šæ„å»ºä¸€ä¸ªå®šæ—¶å™¨
public Timer() {
        this(â€œTimer-â€œ + serialNumber());
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Creates a new timer whose associated thread may be specified to
 * {@linkplain Thread#setDaemon run as a daemon}.
 * A daemon thread is called for if the timer will be used to
 * schedule repeating "maintenance activities", which must be
 * performed as long as the application is running, but should not
 * prolong the lifetime of the application.
 *
 * @param isDaemon true if the associated thread should run as a daemon.
 */
public Timer(boolean isDaemon) {
    this("Timer-" + serialNumber(), isDaemon);
}

/**
 * Creates a new timer whose associated thread has the specified name.
 * The associated thread does &lt;i&gt;not&lt;/i&gt;
 * {@linkplain Thread#setDaemon run as a daemon}.
 *
 * @param name the name of the associated thread
 * @throws NullPointerException if {@code name} is null
 * @since 1.5
 */
public Timer(String name) {
    thread.setName(name);
    thread.start();
}

/**
 * Creates a new timer whose associated thread has the specified name,
 * and may be specified to
 * {@linkplain Thread#setDaemon run as a daemon}.
 *
 * @param name the name of the associated thread
 * @param isDaemon true if the associated thread should run as a daemon
 * @throws NullPointerException if {@code name} is null
 * @since 1.5
 */
public Timer(String name, boolean isDaemon) {
    thread.setName(name);
    thread.setDaemon(isDaemon);
    thread.start();
} 2ï¼šä»»åŠ¡è°ƒåº¦çš„å‡ ç§æ–¹æ³•
</code></pre></div></div>

<p>/**
     * Schedules the specified task for execution at the specified time.  If
     * the time is in the past, the task is scheduled for immediate execution.
     *
     * @param task task to be scheduled.
     * @param time time at which task is to be executed.
     * @throws IllegalArgumentException if <tt>time.getTime()</tt> is negative.
     * @throws IllegalStateException if task was already scheduled or
     *         cancelled, timer was cancelled, or timer thread terminated.
     * @throws NullPointerException if {@code task} or {@code time} is null
     */
    public void schedule(TimerTask task, Date time) {
        sched(task, time.getTime(), 0);
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Schedules the specified task for repeated &lt;i&gt;fixed-delay execution&lt;/i&gt;,
 * beginning after the specified delay.  Subsequent executions take place
 * at approximately regular intervals separated by the specified period.
 *
 * &lt;p&gt;In fixed-delay execution, each execution is scheduled relative to
 * the actual execution time of the previous execution.  If an execution
 * is delayed for any reason (such as garbage collection or other
 * background activity), subsequent executions will be delayed as well.
 * In the long run, the frequency of execution will generally be slightly
 * lower than the reciprocal of the specified period (assuming the system
 * clock underlying &lt;tt&gt;Object.wait(long)&lt;/tt&gt; is accurate).
 *
 * &lt;p&gt;Fixed-delay execution is appropriate for recurring activities
 * that require "smoothness."  In other words, it is appropriate for
 * activities where it is more important to keep the frequency accurate
 * in the short run than in the long run.  This includes most animation
 * tasks, such as blinking a cursor at regular intervals.  It also includes
 * tasks wherein regular activity is performed in response to human
 * input, such as automatically repeating a character as long as a key
 * is held down.
 *
 * @param task   task to be scheduled.
 * @param delay  delay in milliseconds before task is to be executed.
 * @param period time in milliseconds between successive task executions.
 * @throws IllegalArgumentException if {@code delay &lt; 0}, or
 *         {@code delay + System.currentTimeMillis() &lt; 0}, or
 *         {@code period &lt;= 0}
 * @throws IllegalStateException if task was already scheduled or
 *         cancelled, timer was cancelled, or timer thread terminated.
 * @throws NullPointerException if {@code task} is null
 */
public void schedule(TimerTask task, long delay, long period) {
    if (delay &lt; 0)
        throw new IllegalArgumentException("Negative delay.");
    if (period &lt;= 0)
        throw new IllegalArgumentException("Non-positive period.");
    sched(task, System.currentTimeMillis()+delay, -period);
}

/**
 * Schedules the specified task for repeated &lt;i&gt;fixed-delay execution&lt;/i&gt;,
 * beginning at the specified time. Subsequent executions take place at
 * approximately regular intervals, separated by the specified period.
 *
 * &lt;p&gt;In fixed-delay execution, each execution is scheduled relative to
 * the actual execution time of the previous execution.  If an execution
 * is delayed for any reason (such as garbage collection or other
 * background activity), subsequent executions will be delayed as well.
 * In the long run, the frequency of execution will generally be slightly
 * lower than the reciprocal of the specified period (assuming the system
 * clock underlying &lt;tt&gt;Object.wait(long)&lt;/tt&gt; is accurate).  As a
 * consequence of the above, if the scheduled first time is in the past,
 * it is scheduled for immediate execution.
 *
 * &lt;p&gt;Fixed-delay execution is appropriate for recurring activities
 * that require "smoothness."  In other words, it is appropriate for
 * activities where it is more important to keep the frequency accurate
 * in the short run than in the long run.  This includes most animation
 * tasks, such as blinking a cursor at regular intervals.  It also includes
 * tasks wherein regular activity is performed in response to human
 * input, such as automatically repeating a character as long as a key
 * is held down.
 *
 * @param task   task to be scheduled.
 * @param firstTime First time at which task is to be executed.
 * @param period time in milliseconds between successive task executions.
 * @throws IllegalArgumentException if {@code firstTime.getTime() &lt; 0}, or
 *         {@code period &lt;= 0}
 * @throws IllegalStateException if task was already scheduled or
 *         cancelled, timer was cancelled, or timer thread terminated.
 * @throws NullPointerException if {@code task} or {@code firstTime} is null
 */
public void schedule(TimerTask task, Date firstTime, long period) {
    if (period &lt;= 0)
        throw new IllegalArgumentException("Non-positive period.");
    sched(task, firstTime.getTime(), -period);
}

/**
 * Schedules the specified task for repeated &lt;i&gt;fixed-rate execution&lt;/i&gt;,
 * beginning after the specified delay.  Subsequent executions take place
 * at approximately regular intervals, separated by the specified period.
 *
 * &lt;p&gt;In fixed-rate execution, each execution is scheduled relative to the
 * scheduled execution time of the initial execution.  If an execution is
 * delayed for any reason (such as garbage collection or other background
 * activity), two or more executions will occur in rapid succession to
 * "catch up."  In the long run, the frequency of execution will be
 * exactly the reciprocal of the specified period (assuming the system
 * clock underlying &lt;tt&gt;Object.wait(long)&lt;/tt&gt; is accurate).
 *
 * &lt;p&gt;Fixed-rate execution is appropriate for recurring activities that
 * are sensitive to &lt;i&gt;absolute&lt;/i&gt; time, such as ringing a chime every
 * hour on the hour, or running scheduled maintenance every day at a
 * particular time.  It is also appropriate for recurring activities
 * where the total time to perform a fixed number of executions is
 * important, such as a countdown timer that ticks once every second for
 * ten seconds.  Finally, fixed-rate execution is appropriate for
 * scheduling multiple repeating timer tasks that must remain synchronized
 * with respect to one another.
 *
 * @param task   task to be scheduled.
 * @param delay  delay in milliseconds before task is to be executed.
 * @param period time in milliseconds between successive task executions.
 * @throws IllegalArgumentException if {@code delay &lt; 0}, or
 *         {@code delay + System.currentTimeMillis() &lt; 0}, or
 *         {@code period &lt;= 0}
 * @throws IllegalStateException if task was already scheduled or
 *         cancelled, timer was cancelled, or timer thread terminated.
 * @throws NullPointerException if {@code task} is null
 */
public void scheduleAtFixedRate(TimerTask task, long delay, long period) {
    if (delay &lt; 0)
        throw new IllegalArgumentException("Negative delay.");
    if (period &lt;= 0)
        throw new IllegalArgumentException("Non-positive period.");
    sched(task, System.currentTimeMillis()+delay, period);
}

/**
 * Schedules the specified task for repeated &lt;i&gt;fixed-rate execution&lt;/i&gt;,
 * beginning at the specified time. Subsequent executions take place at
 * approximately regular intervals, separated by the specified period.
 *
 * &lt;p&gt;In fixed-rate execution, each execution is scheduled relative to the
 * scheduled execution time of the initial execution.  If an execution is
 * delayed for any reason (such as garbage collection or other background
 * activity), two or more executions will occur in rapid succession to
 * "catch up."  In the long run, the frequency of execution will be
 * exactly the reciprocal of the specified period (assuming the system
 * clock underlying &lt;tt&gt;Object.wait(long)&lt;/tt&gt; is accurate).  As a
 * consequence of the above, if the scheduled first time is in the past,
 * then any "missed" executions will be scheduled for immediate "catch up"
 * execution.
 *
 * &lt;p&gt;Fixed-rate execution is appropriate for recurring activities that
 * are sensitive to &lt;i&gt;absolute&lt;/i&gt; time, such as ringing a chime every
 * hour on the hour, or running scheduled maintenance every day at a
 * particular time.  It is also appropriate for recurring activities
 * where the total time to perform a fixed number of executions is
 * important, such as a countdown timer that ticks once every second for
 * ten seconds.  Finally, fixed-rate execution is appropriate for
 * scheduling multiple repeating timer tasks that must remain synchronized
 * with respect to one another.
 *
 * @param task   task to be scheduled.
 * @param firstTime First time at which task is to be executed.
 * @param period time in milliseconds between successive task executions.
 * @throws IllegalArgumentException if {@code firstTime.getTime() &lt; 0} or
 *         {@code period &lt;= 0}
 * @throws IllegalStateException if task was already scheduled or
 *         cancelled, timer was cancelled, or timer thread terminated.
 * @throws NullPointerException if {@code task} or {@code firstTime} is null
 */
public void scheduleAtFixedRate(TimerTask task, Date firstTime,
                                long period) {
    if (period &lt;= 0)
        throw new IllegalArgumentException("Non-positive period.");
    sched(task, firstTime.getTime(), period);
} 3:schedul()ä¸scheduleAtFixedRate() ä¸¤è€…åŠŸèƒ½ç›¸ä¼¼ï¼Œä½†scheduleï¼ˆï¼‰æ›´æ³¨é‡ä¿æŒæ—¶é—´é—´éš”çš„ç¨³å®šï¼Œä¿è¯æ¯éš”periodçš„æ—¶é—´å¯è°ƒç”¨ä¸€æ¬¡ã€‚è€ŒscheduleAtFixRateæ›´æ³¨é‡ä¿æŒæ‰§è¡Œé¢‘ç‡çš„ç¨³å®šï¼Œä¿è¯å¤šæ¬¡è°ƒç”¨çš„æ—¶é—´è¶‹è¿‘äºperiodçš„æ—¶é—´ï¼Œå¦‚æœæ‰§è¡Œä»»åŠ¡çš„æ—¶é—´å¤§äºperiodçš„æ—¶é—´ï¼Œå°±ä¼šåœ¨ä»»åŠ¡æ‰§è¡Œå®Œé©¬ä¸Šæ‰§è¡Œä¸‹ä¸€æ¬¡ä»»åŠ¡ã€‚
</code></pre></div></div>

<p>4ï¼šTimerç±»çš„ç¼ºé™·
æ—¶é—´ä¸å‡†ç¡®å»¶è¿Ÿï¼šç”±äºTimeråœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœå­˜åœ¨å¤šä¸ªä»»åŠ¡ï¼ŒæŸä¸ªä»»åŠ¡è€—æ—¶è¿‡é•¿ï¼Œå°±ä¼šå¯¼è‡´ä»»åŠ¡æ—¶é—´å»¶è¿Ÿï¼Œå³ä½¿æ˜¯å‘¨æœŸæ‰§è¡Œçš„ï¼Œä¹Ÿä¼šå½±å“ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚</p>

<p>å¼‚å¸¸ç»ˆæ­¢ï¼šå¦‚æœæŠ›å‡ºæœªæ•è·çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´Timerçº¿ç¨‹ç»ˆæ­¢ï¼Œè¿˜ä¼šç»ˆæ­¢æ‰€æœ‰çš„ä»»åŠ¡ï¼Œè€Œä¸”Timerä¸ä¼šé‡æ–°æ¢å¤çº¿ç¨‹åå†æ‰§è¡Œã€‚</p>

<p>æ‰§è¡Œå‘¨æœŸä»»åŠ¡ä¾èµ–ç³»ç»Ÿæ—¶é—´ï¼Œç”±äºTimeræ‰§è¡Œå‘¨æœŸä¾èµ–äºç³»ç»Ÿæ—¶é—´ï¼Œæ‰€ä»¥å¦‚æœå½“å‰ç³»ç»Ÿæ—¶é—´å‡ºç°äº†å˜åŒ–ï¼Œåˆ™ä¼šå‡ºç°ä¸€äº›æ‰§è¡Œä¸Šçš„å˜åŒ–ã€‚</p>

<p>2ï¼šscheduledExecutorï¼ˆåœ¨Sentinelä¸­å¤§é‡ä½¿ç”¨ï¼Œå¦‚ç†”æ–­ä»¥åŠwarmupæ¨¡å¼çš„é™æµï¼‰
åŸºäºçº¿ç¨‹æ± è®¾è®¡çš„SceduledExecutorï¼Œå°±æ˜¯æ”¹æˆäº†å¤šçº¿ç¨‹çš„æ–¹å¼ï¼Œä»»åŠ¡å¹¶å‘æ‰§è¡Œï¼Œç›¸äº’ä¹‹é—´ä¸ä¼šå—åˆ°å¹²æ‰°ã€‚</p>

<p>å…·ä½“å®ç°ç±»ä¸ºScheduledThreadPoolExecutorï¼Œè¿™æ˜¯ä¸€ä¸ªExecutorServiceçº¿ç¨‹æ± ï¼Œé™¤äº†å…·æœ‰çº¿ç¨‹æ± çš„åŸºæœ¬åŠŸèƒ½ï¼Œè¿˜å…·æœ‰å®šæ—¶ä»¥åŠå‘¨æœŸæ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ï¼Œå¸¸ç”¨ä½œå®šæ—¶ä»»åŠ¡ã€‚
æ ¸å¿ƒæ–¹æ³•</p>

<p>/**
     * @throws RejectedExecutionException {@inheritDoc}
     * @throws NullPointerException       {@inheritDoc}
     */
    public ScheduledFuture&lt;?&gt; schedule(Runnable command,
                                       long delay,
                                       TimeUnit unit) {
        if (command == null || unit == null)
            throw new NullPointerException();
        RunnableScheduledFuture&lt;?&gt; t = decorateTask(command,
            new ScheduledFutureTask<Void>(command, null,
                                          triggerTime(delay, unit)));
        delayedExecute(t);
        return t;
    }</Void></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * @throws RejectedExecutionException {@inheritDoc}
 * @throws NullPointerException       {@inheritDoc}
 */
public &lt;V&gt; ScheduledFuture&lt;V&gt; schedule(Callable&lt;V&gt; callable,
                                       long delay,
                                       TimeUnit unit) {
    if (callable == null || unit == null)
        throw new NullPointerException();
    RunnableScheduledFuture&lt;V&gt; t = decorateTask(callable,
        new ScheduledFutureTask&lt;V&gt;(callable,
                                   triggerTime(delay, unit)));
    delayedExecute(t);
    return t;
}

/**
 * @throws RejectedExecutionException {@inheritDoc}
 * @throws NullPointerException       {@inheritDoc}
 * @throws IllegalArgumentException   {@inheritDoc}
 */
public ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command,
                                              long initialDelay,
                                              long period,
                                              TimeUnit unit) {
    if (command == null || unit == null)
        throw new NullPointerException();
    if (period &lt;= 0)
        throw new IllegalArgumentException();
    ScheduledFutureTask&lt;Void&gt; sft =
        new ScheduledFutureTask&lt;Void&gt;(command,
                                      null,
                                      triggerTime(initialDelay, unit),
                                      unit.toNanos(period));
    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);
    sft.outerTask = t;
    delayedExecute(t);
    return t;
}

/**
 * @throws RejectedExecutionException {@inheritDoc}
 * @throws NullPointerException       {@inheritDoc}
 * @throws IllegalArgumentException   {@inheritDoc}
 */
public ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command,
                                                 long initialDelay,
                                                 long delay,
                                                 TimeUnit unit) {
    if (command == null || unit == null)
        throw new NullPointerException();
    if (delay &lt;= 0)
        throw new IllegalArgumentException();
    ScheduledFutureTask&lt;Void&gt; sft =
        new ScheduledFutureTask&lt;Void&gt;(command,
                                      null,
                                      triggerTime(initialDelay, unit),
                                      unit.toNanos(-delay));
    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);
    sft.outerTask = t;
    delayedExecute(t);
    return t;
} ä¸¤è€…çš„ä¸€ä¸ªå¯¹æ¯” 1ï¼šScheduledExecutorå¯ä»¥è§£å†³Timerçš„ä¸å‡†ç¡®å»¶è¿Ÿé—®é¢˜ï¼Œå› ä¸ºå†…éƒ¨æ˜¯çº¿ç¨‹æ± å®ç°çš„ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œäº’ç›¸ä¹‹é—´ä¸å—å½±å“
</code></pre></div></div>

<p>2ï¼šç”±äºæ˜¯ScheduledExecutorå¹¶å‘æ‰§è¡Œï¼Œå¯ä»¥èµ·åˆ°å¾ˆå¥½çš„çº¿ç¨‹éš”ç¦»ï¼Œå³ä½¿äº§ç”Ÿå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å…¶ä»–ä»»åŠ¡å—åˆ°å½±å“ã€‚</p>

<p>3ï¼šScheduledExecutoræ‰§è¡Œçš„å‘¨æœŸä»»åŠ¡ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™ä¼šç»ˆæ­¢ï¼Œä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸”ä¸ä¼šå‘¨æœŸæ€§æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­å°½å¯èƒ½çš„æ•è·ä¸€åˆ‡å¼‚å¸¸ã€‚</p>

<p>åº”ç”¨åœºæ™¯
åˆ›å»ºè®¢å• 10 åˆ†é’Ÿä¹‹åè‡ªåŠ¨æ”¯ä»˜
è®¢å•è¶…æ—¶å–æ¶ˆ
â€¦â€¦.ç­‰ç­‰â€¦
å®ç°æ–¹å¼
æœ€ç®€å•çš„æ–¹å¼ï¼Œå®šæ—¶æ‰«è¡¨;ä¾‹å¦‚æ¯åˆ†é’Ÿæ‰«è¡¨ä¸€æ¬¡ååˆ†é’Ÿä¹‹åæœªæ”¯ä»˜çš„è®¢å•è¿›è¡Œä¸»åŠ¨æ”¯ä»˜ ;
ä¼˜ç‚¹ï¼š ç®€å•
ç¼ºç‚¹ï¼š æ¯åˆ†é’Ÿå…¨å±€æ‰«è¡¨ï¼Œæµªè´¹èµ„æºï¼Œæœ‰ä¸€åˆ†é’Ÿå»¶è¿Ÿ</p>

<p>ä½¿ç”¨ RabbitMq å®ç° RabbitMq å®ç°å»¶è¿Ÿé˜Ÿåˆ—
ä¼˜ç‚¹ï¼š å¼€æºï¼Œç°æˆçš„ç¨³å®šçš„å®ç°æ–¹æ¡ˆ;
ç¼ºç‚¹ï¼š RabbitMq æ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶;å»¶è¿Ÿé˜Ÿåˆ—åªæ˜¯å…¶ä¸­ä¸€ä¸ªå°åŠŸèƒ½ï¼Œå¦‚æœå›¢é˜ŸæŠ€æœ¯æ ˆä¸­æœ¬æ¥å°±æ˜¯ä½¿ç”¨ RabbitMq é‚£è¿˜å¥½ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¸ºäº†ä½¿ç”¨å»¶è¿Ÿé˜Ÿåˆ—è€Œå»éƒ¨ç½²ä¸€å¥— RabbitMq æˆæœ¬æœ‰ç‚¹å¤§;</p>

<p>ä½¿ç”¨ Java ä¸­çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼ŒDelayQueue
ä¼˜ç‚¹ï¼š java.util.concurrent åŒ…ä¸‹ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ—ï¼Œç®€å•æ˜“ç”¨;æ‹¿æ¥å³ç”¨
ç¼ºç‚¹ï¼š å•æœºã€ä¸èƒ½æŒä¹…åŒ–ã€å®•æœºä»»åŠ¡ä¸¢å¤±ç­‰ç­‰;</p>

<p>åŸºäº Redis è‡ªç ”å»¶è¿Ÿé˜Ÿåˆ—
æ—¢ç„¶ä¸Šé¢æ²¡æœ‰å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œå› ä¸º Redis çš„ zsetã€list çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ Redis æ¥å®ç°ä¸€ä¸ªå»¶è¿Ÿé˜Ÿåˆ— RedisDelayQueue</p>

<p>è®¾è®¡ç›®æ ‡
å®æ—¶æ€§ï¼š å…è®¸å­˜åœ¨ä¸€å®šæ—¶é—´å†…çš„ç§’çº§è¯¯å·®
é«˜å¯ç”¨æ€§ï¼šæ”¯æŒå•æœºï¼Œæ”¯æŒé›†ç¾¤
æ”¯æŒæ¶ˆæ¯åˆ é™¤ï¼šä¸šåŠ¡è´¹éšæ—¶åˆ é™¤æŒ‡å®šæ¶ˆæ¯
æ¶ˆæ¯å¯é æ€§ï¼š ä¿è¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡
æ¶ˆæ¯æŒä¹…åŒ–ï¼š åŸºäº Redis è‡ªèº«çš„æŒä¹…åŒ–ç‰¹æ€§ï¼Œä¸Šé¢çš„æ¶ˆæ¯å¯é æ€§åŸºäº Redis çš„æŒä¹…åŒ–ï¼Œæ‰€ä»¥å¦‚æœ Redis æ•°æ®ä¸¢å¤±ï¼Œæ„å‘³ç€å»¶è¿Ÿæ¶ˆæ¯çš„ä¸¢å¤±ï¼Œä¸è¿‡å¯ä»¥åšä¸»å¤‡å’Œé›†ç¾¤ä¿è¯;
æ•°æ®ç»“æ„
Redis_Delay_Table: æ˜¯ä¸€ä¸ª Hash_Table ç»“æ„ï¼›é‡Œé¢å­˜å‚¨äº†æ‰€æœ‰çš„å»¶è¿Ÿé˜Ÿåˆ—çš„ä¿¡æ¯;KV ç»“æ„ï¼›K=TOPIC:ID V=CONENT; V ç”±å®¢æˆ·ç«¯ä¼ å…¥çš„æ•°æ®ï¼Œæ¶ˆè´¹çš„æ—¶å€™å›ä¼ ï¼›
RD_ZSET_BUCKET: å»¶è¿Ÿé˜Ÿåˆ—çš„æœ‰åºé›†åˆ; å­˜æ”¾ member=TOPIC:ID å’Œ score= æ‰§è¡Œæ—¶é—´æˆ³; æ ¹æ®æ—¶é—´æˆ³æ’åº;
RD_LIST_TOPIC: list ç»“æ„; æ¯ä¸ª Topic ä¸€ä¸ª listï¼›list å­˜æ”¾çš„éƒ½æ˜¯å½“å‰éœ€è¦è¢«æ¶ˆè´¹çš„å»¶è¿Ÿ Job;
è®¾è®¡å›¾</p>

<p>738 x 439
2365 x 1407</p>

<p>ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸ
æ–°å¢ä¸€ä¸ªJob,ä¼šåœ¨Redis_Delay_Tableä¸­æ’å…¥ä¸€æ¡æ•°æ®ï¼Œè®°å½•äº†ä¸šåŠ¡æ¶ˆè´¹æ–¹çš„ æ•°æ®ç»“æ„; RD_ZSET_BUCKET ä¹Ÿä¼šæ’å…¥ä¸€æ¡æ•°æ®ï¼Œè®°å½•äº†æ‰§è¡Œæ—¶é—´æˆ³;
æ¬è¿çº¿ç¨‹ä¼šå»RD_ZSET_BUCKETä¸­æŸ¥æ‰¾å“ªäº›æ‰§è¡Œæ—¶é—´æˆ³runTimeMillisæ¯”ç°åœ¨çš„æ—¶é—´å°;å°†è¿™äº›è®°å½•å…¨éƒ¨åˆ é™¤;åŒæ—¶ä¼šè§£æå‡ºæ¥æ¯ä¸ªä»»åŠ¡çš„Topicæ˜¯ä»€ä¹ˆï¼Œç„¶åå°†è¿™äº›ä»»åŠ¡pushåˆ°Topicå¯¹åº”çš„åˆ—è¡¨RD_LIST_TOPICä¸­;
æ¯ä¸ª Topic çš„ List éƒ½ä¼šæœ‰ä¸€ä¸ªç›‘å¬çº¿ç¨‹å»æ‰¹é‡è·å– List ä¸­çš„å¾…æ¶ˆè´¹æ•°æ®;è·å–åˆ°çš„æ•°æ®å…¨éƒ¨æ‰”ç»™è¿™ä¸ªTopicçš„æ¶ˆè´¹çº¿ç¨‹æ± 
æ¶ˆæ¯çº¿ç¨‹æ± æ‰§è¡Œä¼šå» Redis_Delay_Table æŸ¥æ‰¾æ•°æ®ç»“æ„ï¼Œè¿”å›ç»™å›è°ƒæ¥å£ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•;
ä»¥ä¸Šæ‰€æœ‰æ“ä½œï¼Œéƒ½æ˜¯åŸºäº Lua è„šæœ¬åšçš„æ“ä½œï¼ŒLua è„šæœ¬æ‰§è¡Œçš„ä¼˜ç‚¹åœ¨äºï¼Œæ‰¹é‡å‘½ä»¤æ‰§è¡Œå…·æœ‰åŸå­æ€§ï¼Œäº‹åŠ¡æ€§ï¼Œ å¹¶ä¸”é™ä½äº†ç½‘ç»œå¼€é”€ï¼Œæ¯•ç«Ÿåªæœ‰ä¸€æ¬¡ç½‘ç»œå¼€é”€;</p>

<p>æ¬è¿çº¿ç¨‹æ“ä½œæµç¨‹å›¾</p>

<p>571 x 577
920 x 929</p>

<p>è®¾è®¡ç»†èŠ‚
æ¬è¿æ“ä½œ
1.æ¬è¿æ“ä½œçš„æ—¶æœº</p>

<p>ä¸ºäº†é¿å…é¢‘ç¹çš„æ‰§è¡Œæ¬è¿æ“ä½œï¼Œ æˆ‘ä»¬åŸºäº wait(time)/notify çš„æ–¹å¼æ¥é€šçŸ¥æ‰§è¡Œæ¬è¿æ“ä½œ;</p>

<p>738 x 614
1065 x 886</p>

<p>æˆ‘ä»¬ç”¨ä¸€ä¸ªAtomicLong nextTime æ¥ä¿å­˜ä¸‹ä¸€æ¬¡å°†è¦æ¬è¿çš„æ—¶é—´;æœåŠ¡å¯åŠ¨çš„æ—¶å€™nextTime=0;æ‰€ä»¥è‚¯å®šæ¯”å½“å‰æ—¶é—´å°ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆå»æ‰§è¡Œä¸€æ¬¡æ¬è¿æ“ä½œï¼Œç„¶åè¿”å›æ¬è¿æ“ä½œä¹‹åçš„ZSETçš„è¡¨å¤´æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ—¶é—´æˆ³å°±æ˜¯ä¸‹ä¸€æ¬¡å°†è¦æ‰§è¡Œçš„æ—¶é—´æˆ³ï¼Œ æŠŠè¿™ä¸ªæ—¶é—´æˆ³èµ‹å€¼ç»™ nextTime; å¦‚æœè¡¨ä¸­æ²¡æœ‰å…ƒç´ äº†åˆ™å°†nextTime=Long.MaxValue ;å› ä¸º while å¾ªç¯ï¼Œä¸‹ä¸€æ¬¡åˆä¼šè·Ÿå½“å‰æ—¶é—´å¯¹æ¯”;å¦‚æœnextTimeæ¯”å½“å‰æ—¶é—´å¤§ï¼Œåˆ™è¯´æ˜éœ€è¦ç­‰å¾…; é‚£ä¹ˆæˆ‘ä»¬wait(nextTime-System.currentTimeMills()); ç­‰åˆ°æ—¶é—´åˆ°äº†ä¹‹åï¼Œå†æ¬¡å»åˆ¤æ–­ä¸€ä¸‹ï¼Œå°±ä¼šæ¯”å½“å‰æ—¶é—´å°ï¼Œå°±ä¼šæ‰§è¡Œä¸€æ¬¡æ¬è¿æ“ä½œ;</p>

<p>é‚£ä¹ˆå½“æœ‰æ–°å¢å»¶è¿Ÿä»»åŠ¡ Job çš„æ—¶é—´æ€ä¹ˆåŠï¼Œè¿™ä¸ªæ—¶å€™åˆä¼šå°†å½“å‰æ–°å¢ Job çš„æ‰§è¡Œæ—¶é—´æˆ³è·ŸnextTimeåšä¸ªå¯¹æ¯”;å¦‚æœå°çš„è¯å°±é‡æ–°èµ‹å€¼;
é‡æ–°èµ‹å€¼ä¹‹åï¼Œè¿˜æ˜¯è°ƒç”¨ä¸€ä¸‹ notifyAll() é€šçŸ¥ä¸€ä¸‹æ¬è¿çº¿ç¨‹ï¼›è®©ä»–é‡æ–°å»åˆ¤æ–­ä¸€ä¸‹ æ–°çš„æ—¶é—´æ˜¯å¦æ¯”å½“å‰æ—¶é—´å°;å¦‚æœè¿˜æ˜¯å¤§çš„è¯ï¼Œé‚£ä¹ˆå°±ç»§ç»­wait(nextTime-System.currentTimeMills()); ä½†æ˜¯è¿™ä¸ªæ—¶å€™waitçš„æ—¶é—´åˆä¼šå˜å°;æ›´ç²¾å‡†;</p>

<p>2.ä¸€æ¬¡æ¬è¿æ“ä½œçš„æœ€å¤§æ•°é‡
Redis çš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œåœ¨ä¸€ä¸ª Lua é‡Œé¢å¾ªç¯éå† 1000 ä¸ª 10000 ä¸ªæ ¹æœ¬æ²¡å·®; è€Œä¸”æ˜¯åœ¨ Lua é‡Œé¢æ“ä½œï¼Œå°±åªæœ‰ä¸€æ¬¡ç½‘ç»œå¼€é”€;ä¸€æ¬¡æ“ä½œå¤šå°‘ä¸ªå…ƒç´ æ ¹æœ¬å°±ä¸ä¼šæ˜¯é—®é¢˜;</p>

<p>æ¬è¿æ“ä½œçš„é˜²æŠ¤æœºåˆ¶
1.æ¯åˆ†é’Ÿå”¤é†’å®šæ—¶çº¿ç¨‹</p>

<p>åœ¨æ¶ˆè´¹æ–¹å¤šå®ä¾‹éƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œ å¦‚æœæŸä¸€å°æœºå™¨æŒ‚æ‰äº†ï¼Œä½†æ˜¯è¿™å°æœºå™¨çš„ nextTime æ˜¯æœ€å°çš„ï¼Œå°±åœ¨ä¸€åˆ†é’Ÿä¹‹å( æ–°å¢ job çš„æ—¶å€™è½åˆ°è¿™å°æœºå™¨ï¼Œåˆšå¥½æ—¶é—´æˆ³å¾ˆå°), å…¶ä»–æœºå™¨å¯èƒ½æ˜¯ 1 ä¸ªå°æ—¶ä¹‹åæ‰§è¡Œæ¬è¿æ“ä½œ; å¦‚æœè¿™å°æœºå™¨ç«‹é©¬é‡å¯ï¼Œé‚£ä¹ˆè¿˜ä¼šç«‹é©¬æ‰§è¡Œä¸€æ¬¡æ¬è¿æ“ä½œ;ä¸‡ä¸€ä»–æ²¡æœ‰é‡å¯;é‚£å¯èƒ½å°±ä¼šå¾ˆä¹…ä¹‹åæ‰ä¼šæ¬è¿;
æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§é˜²æŠ¤æ‰‹æ®µæ¥åº”å¯¹è¿™ç§æç«¯æƒ…å†µ;
æ¯”å¦‚æ¯åˆ†é’Ÿå°† nextTime=0;å¹¶ä¸”å”¤é†’ wait;
é‚£ä¹ˆå°±ä¼šè‡³å°‘æ¯åˆ†é’Ÿä¼šæ‰§è¡Œä¸€æ¬¡æ¬è¿æ“ä½œï¼ è¿™æ˜¯å¯ä»¥æ¥å—çš„</p>

<p>LrangeAndLTrim æ‰¹é‡è·å–ä¸”åˆ é™¤å¾…æ¶ˆè´¹ä»»åŠ¡
1.æ‰§è¡Œæ—¶æœºä»¥åŠå¦‚ä½•é˜²æ­¢é¢‘ç¹è¯·æ±‚ Redis
è¿™æ˜¯ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå¾ªç¯å»åšè¿™æ ·çš„æ“ä½œï¼ŒæŠŠæ‹¿åˆ°çš„æ•°æ®ç»™çº¿ç¨‹æ± å»æ¶ˆè´¹;
ä½†æ˜¯ä¹Ÿä¸èƒ½ä¸€ç›´ä¸åœçš„å»æ‰§è¡Œæ“ä½œï¼Œå¦‚æœ list å·²ç»æ²¡æœ‰æ•°æ®äº†å»æ“ä½œä¹Ÿæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä¸ç„¶å°±å¤ªæµªè´¹èµ„æºäº†ï¼Œå¹¸å¥½ List ä¸­æœ‰ä¸€ä¸ªBLPOPé˜»å¡åŸè¯­ï¼Œå¦‚æœ list ä¸­æœ‰æ•°æ®å°±ä¼šç«‹é©¬è¿”å›ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±ä¼šä¸€ç›´é˜»å¡åœ¨é‚£é‡Œï¼Œç›´åˆ°æœ‰æ•°æ®è¿”å›ï¼Œå¯ä»¥è®¾ç½®é˜»å¡çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä¼šè¿”å› NULL;
ç¬¬ä¸€æ¬¡å»è·å– N ä¸ªå¾…æ¶ˆè´¹çš„ä»»åŠ¡æ‰”è¿›åˆ°æ¶ˆè´¹çº¿ç¨‹æ± ä¸­;å¦‚æœè·å–åˆ°äº† 0 ä¸ªï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç«‹é©¬ç”¨BLPOPæ¥é˜»å¡ï¼Œç­‰æœ‰å…ƒç´ çš„æ—¶å€™ BLPOP å°±è¿”å›æ•°æ®äº†ï¼Œä¸‹æ¬¡å°±å¯ä»¥å°è¯•å»LrangeAndLTrimä¸€æ¬¡äº†ã€‚ é€šè¿‡BLPOPé˜»å¡ï¼Œæˆ‘ä»¬é¿å…äº†é¢‘ç¹çš„å»è¯·æ±‚ redis,å¹¶ä¸”æ›´é‡è¦çš„æ˜¯æé«˜äº†å®æ—¶æ€§;</p>

<p>2.æ‰¹é‡è·å–çš„æ•°é‡å’Œæ¶ˆè´¹çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—</p>

<p>æ‰§è¡Œä¸Šé¢çš„ä¸€æ¬¡è·å– N ä¸ªå…ƒç´ æ˜¯ä¸å®šçš„ï¼Œè¿™ä¸ªè¦çœ‹çº¿ç¨‹æ± çš„ maxPoolSize æœ€å¤§çº¿ç¨‹æ•°é‡; å› ä¸ºé¿å…æ¶ˆè´¹çš„ä»»åŠ¡è¿‡å¤šè€Œæ”¾å…¥çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—ï¼Œ æ”¾å…¥é˜»å¡é˜Ÿåˆ—æœ‰å®•æœºä¸¢å¤±ä»»åŠ¡çš„é£é™©ï¼Œå…³æœºé‡å¯çš„æ—¶å€™è¿˜è¦è®²é˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡é‡æ–°æ”¾å…¥ List ä¸­å¢åŠ äº†å¤æ‚æ€§;</p>

<p>æ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡LrangeAndLTrimè·å–çš„å…ƒç´ ä¸èƒ½å¤§äºå½“å‰çº¿ç¨‹æ± å¯ç”¨çš„çº¿ç¨‹æ•°; è¿™æ ·çš„ä¸€ä¸ªæ§åˆ¶å¯ç”¨ç”¨ä¿¡å·é‡Semaphoreæ¥åš</p>

<p>Codis é›†ç¾¤å¯¹ BLPOP çš„å½±å“
å¦‚æœ Redis é›†ç¾¤ç”¨äº† codis æ–¹æ¡ˆæˆ–è€… Twemproxy æ–¹æ¡ˆ; ä»–ä»¬ä¸æ”¯æŒ BLPOP çš„å‘½ä»¤;
codis ä¸æ”¯æŒçš„å‘½ä»¤é›†åˆ
é‚£ä¹ˆå°±ä¸èƒ½åˆ©ç”¨ BLPOP æ¥é˜²æ­¢é¢‘ç¹è¯·æ±‚ redis;é‚£ä¹ˆé€€è€Œæ±‚å…¶æ¬¡æ”¹æˆæ¯ç§’æ‰§è¡Œä¸€æ¬¡ LrangeAndLTrim æ“ä½œ;</p>

<p>é›†ç¾¤å¯¹ Lua çš„å½±å“
Lua è„šæœ¬çš„æ‰§è¡Œåªèƒ½åœ¨å•æœºå™¨ä¸Šï¼Œ é›†ç¾¤çš„ç¯å¢ƒä¸‹å¦‚æœæƒ³è¦æ‰§è¡Œ Lua è„šæœ¬ä¸å‡ºé”™ï¼Œé‚£ä¹ˆ Lua è„šæœ¬ä¸­çš„æ‰€æœ‰ key å¿…é¡»è½åœ¨åŒä¸€å°æœºå™¨;
ä¸ºäº†æ”¯æŒé›†ç¾¤æ“ä½œ Lua,æˆ‘ä»¬åˆ©ç”¨ hashtag; ç”¨{}æŠŠä¸‰ä¸ª jey çš„å…³é”®è¯åŒ…èµ·æ¥;
{projectName}:Redis_Delay_Table
{projectName}:Redis_Delay_Table
{projectName}:RD_LIST_TOPIC
é‚£ä¹ˆæ‰€æœ‰çš„æ•°æ®å°±ä¼šåœ¨åŒä¸€å°æœºå™¨ä¸Šäº†</p>

<p>é‡è¯•æœºåˆ¶
æ¶ˆè´¹è€…å›è°ƒæ¥å£å¦‚æœæŠ›å‡ºå¼‚å¸¸äº†ï¼Œæˆ–è€…æ‰§è¡Œè¶…æ—¶äº†ï¼Œé‚£ä¹ˆä¼šå°†è¿™ä¸ª Job é‡æ–°æ”¾å…¥åˆ° RD_LIST_TOPIC ä¸­ç­‰å¾…è¢«ä¸‹ä¸€æ¬¡æ¶ˆè´¹;é»˜è®¤é‡è¯• 2 æ¬¡;å¯ä»¥è®¾ç½®ä¸é‡è¯•;</p>

<p>è¶…æ—¶æœºåˆ¶
è¶…æ—¶æœºåˆ¶çš„ä¸»è¦æ€è·¯éƒ½ä¸€æ ·ï¼Œå°±æ˜¯ç›‘å¬ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡è®¾å®šå€¼ä¹‹åæŠ›å‡ºå¼‚å¸¸æ‰“æ–­æ–¹æ³•çš„æ‰§è¡Œ;</p>

<p>è¿™æ˜¯ä½¿ç”¨çš„æ–¹å¼æ˜¯ åˆ©ç”¨ Callable æ¥å£å®ç°å¼‚æ­¥è¶…æ—¶å¤„ç†</p>

<p>public class TimeoutUtil {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**æ‰§è¡Œç”¨æˆ·å›è°ƒæ¥å£çš„ çº¿ç¨‹æ± ;    è®¡ç®—å›è°ƒæ¥å£çš„è¶…æ—¶æ—¶é—´           **/
private static ExecutorService executorService = Executors.newCachedThreadPool();

/**
 * æœ‰è¶…æ—¶æ—¶é—´çš„æ–¹æ³•
 * @param timeout æ—¶é—´ç§’
 * @return
 */
public static void timeoutMethod(long timeout, Function function) throws InterruptedException, ExecutionException, TimeoutException {
    FutureTask futureTask = new FutureTask(()-&gt;(function.apply("")));
    executorService.execute(futureTask);
    //new Thread(futureTask).start();
    try {
        futureTask.get(timeout, TimeUnit.MILLISECONDS);
    } catch (InterruptedException | ExecutionException | TimeoutException e) {
        //e.printStackTrace();
        futureTask.cancel(true);
        throw e;
    }

} }
</code></pre></div></div>

<p>è¿™ç§æ–¹å¼æœ‰ä¸€ç‚¹ä¸å¥½å°±æ˜¯å¤ªè´¹çº¿ç¨‹äº†ï¼Œç›¸å½“äºçº¿ç¨‹ä½¿ç”¨ç¿»äº†ä¸€å€;ä½†æ˜¯ç›¸æ¯”å…¶ä»–çš„æ–¹å¼ï¼Œè¿™ç§ç®—æ˜¯æ›´å¥½ä¸€ç‚¹çš„</p>

<p>ä¼˜é›…åœæœº
åœ¨ Jvm é‚£é‡Œæ³¨å†Œä¸€ä¸ª Runtime.getRuntime().addShutdownHook(Runnable)åœæœºå›è°ƒæ¥å£;åœ¨è¿™é‡Œé¢åšå¥½å–„åå·¥ä½œ;</p>

<p>å…³é—­å¼‚æ­¥ AddJob çº¿ç¨‹æ± 
å…³é—­æ¯åˆ†é’Ÿå”¤é†’çº¿ç¨‹
å…³é—­æ¬è¿çº¿ç¨‹ while(!stop)çš„å½¢å¼
å…³é—­æ‰€æœ‰çš„ topic ç›‘å¬çº¿ç¨‹ while(!stop)çš„å½¢å¼
å…³é—­å…³é—­æ‰€æœ‰ topic çš„æ¶ˆè´¹çº¿ç¨‹ ;å…ˆè°ƒç”¨ shutdown;å† executor.awaitTermination(20, TimeUnit.SECONDS);æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™çš„çº¿ç¨‹ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œ; å¦‚æœè¿˜æ²¡æœ‰æ‰§è¡Œå®Œåˆ™ç­‰å¾…æ‰§è¡Œå®Œï¼›æœ€å¤šç­‰å¾… 20 ç§’ä¹‹åå¼ºåˆ¶è°ƒç”¨ shutdownNow å¼ºåˆ¶å…³é—­;
å…³é—­é‡è¯•çº¿ç¨‹ while(!stop)çš„å½¢å¼
å…³é—­ å¼‚å¸¸æœªæ¶ˆè´¹ Job é‡å…¥ List çº¿ç¨‹æ± 
ä¼˜é›…åœæ­¢çº¿ç¨‹ä¸€èˆ¬æ˜¯ç”¨ä¸‹é¢çš„æ–¹å¼
â‘  ã€ while(!stop)çš„å½¢å¼ ç”¨æ ‡è¯†ä½æ¥åœæ­¢çº¿ç¨‹
â‘¡ .å…ˆ è°ƒç”¨ executor.shutdown(); é˜»æ­¢æ¥å—æ–°çš„ä»»åŠ¡;ç„¶åç­‰å¾…å½“å‰æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ‰§è¡Œå®Œ; å¦‚æœæœ‰é˜»å¡åˆ™éœ€è¦è°ƒç”¨ executor.shutdownNow()å¼ºåˆ¶ç»“æŸ;æ‰€ä»¥è¦ç»™ä¸€ä¸ªç­‰å¾…æ—¶é—´;</p>

<p>/**
     * shutdownNow ç»ˆæ­¢çº¿ç¨‹çš„æ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨Thread.interrupt()æ–¹æ³•æ¥å®ç°çš„
     * å¦‚æœçº¿ç¨‹ä¸­æ²¡æœ‰sleep ã€waitã€Conditionã€å®šæ—¶é”ç­‰åº”ç”¨, interrupt()æ–¹æ³•æ˜¯æ— æ³•ä¸­æ–­å½“å‰çš„çº¿ç¨‹çš„ã€‚
     * ä¸Šé¢çš„æƒ…å†µä¸­æ–­ä¹‹åè¿˜æ˜¯å¯ä»¥å†æ‰§è¡Œfinallyé‡Œé¢çš„æ–¹æ³•çš„;
     * ä½†æ˜¯å¦‚æœæ˜¯å…¶ä»–çš„æƒ…å†µ finallyæ˜¯ä¸ä¼šè¢«æ‰§è¡Œçš„
     * @param executor
     */
    public static void closeExecutor(ExecutorService executor, String executorName) {
        try {
            //æ–°çš„ä»»åŠ¡ä¸è¿›é˜Ÿåˆ—
            executor.shutdown();
            //ç»™10ç§’é’Ÿæ²¡æœ‰åœæ­¢å®Œå¼ºè¡Œåœæ­¢;
            if(!executor.awaitTermination(20, TimeUnit.SECONDS)) {
                logger.warn(â€œçº¿ç¨‹æ± : {},{}æ²¡æœ‰åœ¨20ç§’å†…å…³é—­,åˆ™è¿›è¡Œå¼ºåˆ¶å…³é—­â€,executorName,executor);
                List<Runnable> droppedTasks = executor.shutdownNow();
                logger.warn("çº¿ç¨‹æ± : {},{} è¢«å¼ºè¡Œå…³é—­,é˜»å¡é˜Ÿåˆ—ä¸­å°†æœ‰{}ä¸ªå°†ä¸ä¼šè¢«æ‰§è¡Œ.", executorName,executor,droppedTasks.size() );
            }
            logger.info("çº¿ç¨‹æ± :{},{} å·²ç»å…³é—­...",executorName,executor);
        }  catch (InterruptedException e) {
            logger.info("çº¿ç¨‹æ± :{},{} æ‰“æ–­...",executorName,executor);
        }
    }
BLPOP é˜»å¡çš„æƒ…å†µå¦‚ä½•ä¼˜é›…åœæ­¢ç›‘å¬ Redis çš„çº¿ç¨‹</Runnable></p>

<p>å¦‚æœä¸æ˜¯åœ¨codisé›†ç¾¤çš„ç¯å¢ƒä¸‹ï¼ŒBLPOP æ˜¯å¯ä»¥å¾ˆæ–¹ä¾¿çš„é˜»å¡çº¿ç¨‹çš„;ä½†æ˜¯åœæœºçš„æ—¶å€™å¯èƒ½ä¼šæœ‰ç‚¹é—®é¢˜;</p>

<p>å‡å¦‚æ­£åœ¨å…³æœºï¼Œå½“å‰çº¿ç¨‹æ­£åœ¨BLPOPé˜»å¡ï¼Œ é‚£å…³æœºçº¿ç¨‹ç­‰æˆ‘ä»¬ 20 ç§’æ‰§è¡Œï¼Œ åˆšå¥½åœ¨å€’æ•° 1 ç§’çš„æ—¶å€™BLPOPè·å–åˆ°äº†æ•°æ®ï¼Œä¸¢ç»™æ¶ˆè´¹çº¿ç¨‹å»æ¶ˆè´¹;å¦‚æœæ¶ˆè´¹çº¿ç¨‹ 1 ç§’æ‰§è¡Œä¸å®Œï¼Œé‚£ä¹ˆ 20 ç§’å€’è®¡æ—¶åˆ°äº†ï¼Œå¼ºåˆ¶å…³æœºï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±ä¼šè¢«ä¸¢å¤±äº†; æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ</p>

<p>â‘  . ä¸ç”¨BLPOP, æ¯æ¬¡éƒ½ sleep ä¸€ç§’å»è°ƒç”¨LrangeAndLTrimæ“ä½œ;
â‘¡ .å…³æœºçš„æ—¶å€™æ€æ‰ Redis çš„ blpop å®¢æˆ·ç«¯; æ€æ‰ä¹‹å BLPOP ä¼šç«‹é©¬è¿”å› null; è¿›å…¥ä¸‹ä¸€ä¸ªå¾ªç¯ä½“;</p>

<p>ä¸è¶³
å› ä¸º Redis çš„æŒä¹…åŒ–ç‰¹æ€§ï¼Œåšä¸åˆ°æ¶ˆæ¯å®Œå…¨ä¸ä¸¢å¤±ï¼Œå¦‚æœè¦ä¿è¯å®Œæˆä¸ä¸¢å¤±ï¼ŒRedis çš„æŒä¹…åŒ–åˆ·ç›˜ç­–ç•¥è¦æ”¶ç´§
å› ä¸º Codis ä¸èƒ½ä½¿ç”¨ BLPOP è¿™ç§é˜»å¡çš„å½¢å¼ï¼Œåœ¨è·å–æ¶ˆè´¹ä»»åŠ¡çš„æ—¶å€™ç”¨äº†æ¯ç§’ä¸€æ¬¡å»è·å–ï¼Œæœ‰ç‚¹æµªè´¹æ€§èƒ½;
æ”¯æŒæ¶ˆè´¹è€…å¤šå®ä¾‹éƒ¨ç½²ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ä¸èƒ½å‡åŒ€çš„åˆ†é…åˆ°æ¯å°æœºå™¨ä¸Šå»æ¶ˆè´¹;
è™½ç„¶æ”¯æŒ Redis é›†ç¾¤ï¼Œä½†æ˜¯å…¶å®æ˜¯ä¼ªé›†ç¾¤ï¼Œå› ä¸º Lua è„šæœ¬çš„åŸå› ï¼Œè®©ä»–ä»¬éƒ½åªèƒ½è½åœ¨ä¸€å°æœºå™¨ä¸Š;
æ€»ç»“
å®æ—¶æ€§
æ­£å¸¸æƒ…å†µä¸‹ æ¶ˆè´¹çš„æ—¶é—´è¯¯å·®ä¸è¶…è¿‡ 1 ç§’é’Ÿ; æç«¯æƒ…å†µä¸‹ï¼Œä¸€å°å®ä¾‹å®•æœºï¼Œå¦å¤–çš„å®ä¾‹ nextTime å¾ˆè¿Ÿ; é‚£ä¹ˆæœ€å¤§è¯¯å·®æ˜¯ 1 åˆ†é’Ÿ; çœŸæ­£çš„è¯¯å·®æ¥è‡ªäºä¸šåŠ¡æ–¹çš„æ¥å£çš„æ¶ˆè´¹é€Ÿåº¦</p>

<p>QPS
å®Œå…¨è§†ä¸šåŠ¡æ–¹çš„æ¶ˆè´¹é€Ÿåº¦è€Œå®š; å»¶è¿Ÿé˜Ÿåˆ—ä¸æ˜¯ç“¶é¢ˆ</p>

<p>ç›®å‰å¯ä»¥è€ƒè™‘ä½¿ç”¨rabbitmqæ¥æ»¡è¶³éœ€æ±‚ ä½†æ˜¯ä¸æ‰“ç®—ä½¿ç”¨,å› ä¸ºç›®å‰å¤ªå¤šçš„ä¸šåŠ¡ä½¿ç”¨äº†å¦å¤–çš„MQä¸­é—´ä»¶ã€‚</p>

<p>å¼€å‘å‰éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼Ÿ</p>

<p>åŠæ—¶æ€§ æ¶ˆè´¹ç«¯èƒ½æŒ‰æ—¶æ”¶åˆ°
åŒä¸€æ—¶é—´æ¶ˆæ¯çš„æ¶ˆè´¹æƒé‡
å¯é æ€§ æ¶ˆæ¯ä¸èƒ½å‡ºç°æ²¡æœ‰è¢«æ¶ˆè´¹æ‰çš„æƒ…å†µ
å¯æ¢å¤ å‡å¦‚æœ‰å…¶ä»–æƒ…å†µ å¯¼è‡´æ¶ˆæ¯ç³»ç»Ÿä¸å¯ç”¨äº† è‡³å°‘èƒ½ä¿è¯æ•°æ®å¯ä»¥æ¢å¤
å¯æ’¤å› å› ä¸ºæ˜¯å»¶è¿Ÿæ¶ˆæ¯ æ²¡æœ‰åˆ°æ‰§è¡Œæ—¶é—´çš„æ¶ˆæ¯æ”¯æŒå¯ä»¥å–æ¶ˆæ¶ˆè´¹
é«˜å¯ç”¨ å¤šå®ä¾‹ è¿™é‡ŒæŒ‡HA/ä¸»å¤‡æ¨¡å¼å¹¶ä¸æ˜¯å¤šå®ä¾‹åŒæ—¶ä¸€èµ·å·¥ä½œ
æ¶ˆè´¹ç«¯å¦‚ä½•æ¶ˆè´¹</p>

<p>å½“ç„¶åˆæ­¥é€‰ç”¨redisä½œä¸ºæ•°æ®ç¼“å­˜çš„ä¸»è¦åŸå› æ˜¯å› ä¸ºredisè‡ªèº«æ”¯æŒzsetçš„æ•°æ®ç»“æ„(score å»¶è¿Ÿæ—¶é—´æ¯«ç§’) è¿™æ ·å°±å°‘äº†æ’åºçš„çƒ¦æ¼è€Œä¸”æ€§èƒ½è¿˜å¾ˆé«˜,æ­£å¥½æˆ‘ä»¬çš„éœ€æ±‚å°±æ˜¯æŒ‰æ—¶é—´ç»´åº¦å»åˆ¤å®šæ‰§è¡Œçš„é¡ºåº åŒæ—¶ä¹Ÿæ”¯æŒmap listæ•°æ®ç»“æ„ã€‚</p>

<p>ç®€å•å®šä¹‰ä¸€ä¸ªæ¶ˆæ¯æ•°æ®ç»“æ„</p>

<p>private String topic;/<strong><em>topic**/
private String id;/</em></strong>è‡ªåŠ¨ç”Ÿæˆ å…¨å±€æƒŸä¸€ snowflake<strong>/
private String bizKey;
private long delay;/</strong><em>å»¶æ—¶æ¯«ç§’æ•°<strong>/
private int priority;//ä¼˜å…ˆçº§
private long ttl;/</strong>æ¶ˆè´¹ç«¯æ¶ˆè´¹çš„ttl<strong>/
private String body;/</strong></em>æ¶ˆæ¯ä½“**/
private long createTime=System.currentTimeMillis();
private int status= Status.WaitPut.ordinal();
è¿è¡ŒåŸç†ï¼š</p>

<p>ç”¨Mapæ¥å­˜å‚¨å…ƒæ•°æ®ã€‚idä½œä¸ºkey,æ•´ä¸ªæ¶ˆæ¯ç»“æ„åºåˆ—åŒ–(json/â€¦)ä¹‹åä½œä¸ºvalue,æ”¾å…¥å…ƒæ¶ˆæ¯æ± ä¸­ã€‚
å°†idæ”¾å…¥å…¶ä¸­(æœ‰Nä¸ª)ä¸€ä¸ªzsetæœ‰åºåˆ—è¡¨ä¸­,ä»¥createTime+delay+priorityä½œä¸ºscoreã€‚ä¿®æ”¹çŠ¶æ€ä¸ºæ­£åœ¨å»¶è¿Ÿä¸­
ä½¿ç”¨timerå®æ—¶ç›‘æ§zsetæœ‰åºåˆ—è¡¨ä¸­top 10çš„æ•°æ® ã€‚ å¦‚æœæ•°æ®score&lt;=å½“å‰æ—¶é—´æ¯«ç§’å°±å–å‡ºæ¥,æ ¹æ®topicé‡æ–°æ”¾å…¥ä¸€ä¸ªæ–°çš„å¯æ¶ˆè´¹åˆ—è¡¨(list)ä¸­,åœ¨zsetä¸­åˆ é™¤å·²ç»å–å‡ºæ¥çš„æ•°æ®,å¹¶ä¿®æ”¹çŠ¶æ€ä¸ºå¾…æ¶ˆè´¹
å®¢æˆ·ç«¯è·å–æ•°æ®åªéœ€è¦ä»å¯æ¶ˆè´¹é˜Ÿåˆ—ä¸­è·å–å°±å¯ä»¥äº†ã€‚å¹¶ä¸”çŠ¶æ€å¿…é¡»ä¸ºå¾…æ¶ˆè´¹ è¿è¡Œæ—¶é—´éœ€è¦&lt;=å½“å‰æ—¶é—´çš„ å¦‚æœä¸æ»¡è¶³ é‡æ–°æ”¾å…¥zsetåˆ—è¡¨ä¸­,ä¿®æ”¹çŠ¶æ€ä¸ºæ­£åœ¨å»¶è¿Ÿã€‚å¦‚æœæ»¡è¶³ä¿®æ”¹çŠ¶æ€ä¸ºå·²æ¶ˆè´¹ã€‚æˆ–è€…ç›´æ¥åˆ é™¤å…ƒæ•°æ®ã€‚
å®¢æˆ·ç«¯
å› ä¸ºæ¶‰åŠåˆ°ä¸åŒç¨‹åºè¯­è¨€çš„é—®é¢˜,æ‰€ä»¥å½“å‰é»˜è®¤æ”¯æŒhttpè®¿é—®æ–¹å¼ã€‚</p>

<p>æ·»åŠ å»¶æ—¶æ¶ˆæ¯æ·»åŠ æˆåŠŸä¹‹åè¿”å›æ¶ˆè´¹å”¯ä¸€ID POST /push {â€¦..æ¶ˆæ¯ä½“}
åˆ é™¤å»¶æ—¶æ¶ˆæ¯ éœ€è¦ä¼ é€’æ¶ˆæ¯ID GET /delete?id=
æ¢å¤å»¶æ—¶æ¶ˆæ¯ GET /reStore?expire=true|false expireæ˜¯å¦æ¢å¤å·²è¿‡æœŸæœªæ‰§è¡Œçš„æ¶ˆæ¯ã€‚
æ¢å¤å•ä¸ªå»¶æ—¶æ¶ˆæ¯ éœ€è¦ä¼ é€’æ¶ˆæ¯ID GET /reStore/id
è·å–æ¶ˆæ¯ éœ€è¦é•¿è¿æ¥ GET /get/topic
ç”¨nginxæš´éœ²æœåŠ¡,é…ç½®ä¸ºè½®è¯¢ åœ¨æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯çš„æ—¶å€™å°±å¯ä»¥æµé‡å¹³å‡åˆ†é…ã€‚</p>

<p>ç›®å‰ç³»ç»Ÿä¸­å®¢æˆ·ç«¯å¹¶æ²¡æœ‰é‡‡ç”¨HTTPé•¿è¿æ¥çš„æ–¹å¼æ¥æ¶ˆè´¹æ¶ˆæ¯,è€Œæ˜¯é‡‡ç”¨MQçš„æ–¹å¼æ¥æ¶ˆè´¹æ•°æ®è¿™æ ·å®¢æˆ·ç«¯å°±å¯ä»¥ä¸ç”¨å…³å¿ƒå»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—ã€‚åªéœ€è¦åœ¨å‘é€MQçš„æ—¶å€™æ‹¦æˆªä¸€ä¸‹ å¦‚æœæ˜¯å»¶è¿Ÿæ¶ˆæ¯å°±ç”¨å»¶è¿Ÿæ¶ˆæ¯ç³»ç»Ÿå¤„ç†ã€‚</p>

<p>æ¶ˆæ¯å¯æ¢å¤
å®ç°æ¢å¤çš„åŸç† æ­£å¸¸æƒ…å†µä¸‹ä¸€èˆ¬éƒ½æ˜¯è®°å½•æ—¥å¿—,æ¯”å¦‚mysqlçš„binlogç­‰ã€‚</p>

<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥é‡‡ç”¨mysqlæ•°æ®åº“ä½œä¸ºè®°å½•æ—¥å¿—ã€‚</p>

<p>ç›®å‰æ‰“ç®—åˆ›å»ºä»¥ä¸‹2å¼ è¡¨:</p>

<p>æ¶ˆæ¯è¡¨ å­—æ®µåŒ…æ‹¬æ•´ä¸ªæ¶ˆæ¯ä½“
æ¶ˆæ¯æµè½¬è¡¨ å­—æ®µåŒ…æ‹¬æ¶ˆæ¯IDã€å˜æ›´çŠ¶æ€ã€å˜æ›´æ—¶é—´ã€zsetæ‰«æçº¿ç¨‹Nameã€host/ip
å®šä¹‰zsetæ‰«æçº¿ç¨‹Nameæ˜¯ä¸ºäº†æ›´æ¸…æ¥šçš„çœ‹åˆ°æ¶ˆæ¯è¢«åˆ†å‘åˆ°å…·ä½“å“ªä¸ªzsetä¸­ã€‚å‰ææ˜¯zsetçš„keyå’Œç›‘æ§zsetçš„çº¿ç¨‹åç§°è¦æœ‰ç‚¹å…³ç³» è¿™é‡Œä¹Ÿå¯ä»¥æ˜¯zset keyã€‚</p>

<p>ä¸¾ä¸ªæ —å­</p>

<p>å‡å¦‚redisæœåŠ¡å™¨å®•æœºäº†,é‡å¯ä¹‹åå‘ç°æ•°æ®ä¹Ÿæ²¡æœ‰äº†ã€‚æ‰€ä»¥è¿™ä¸ªæ¢å¤æ˜¯å¾ˆæœ‰å¿…è¦çš„,åªéœ€è¦ä»è¡¨1ä¹Ÿå°±æ˜¯æ¶ˆæ¯è¡¨ä¸­æŠŠæ¶ˆæ¯çŠ¶æ€ä¸ç­‰äºå·²æ¶ˆè´¹çš„æ•°æ®å…¨éƒ¨é‡æ–°åˆ†å‘åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­å»,ç„¶ååŒæ­¥ä¸€ä¸‹çŠ¶æ€å°±å¯ä»¥äº†ã€‚</p>

<p>å½“ç„¶æ¢å¤å•ä¸ªä»»åŠ¡ä¹Ÿå¯ä»¥è¿™ä¹ˆå¹²ã€‚</p>

<p>å…³äºé«˜å¯ç”¨
åˆ†å¸ƒå¼åè°ƒè¿˜æ˜¯é€‰ç”¨zookeeperå§ã€‚</p>

<p>å¦‚æœæœ‰å¤šä¸ªå®ä¾‹æœ€å¤šåŒæ—¶åªèƒ½æœ‰1ä¸ªå®ä¾‹å·¥ä½œ è¿™æ ·å°±é¿å…äº†åˆ†å¸ƒå¼ç«äº‰é”å¸¦æ¥çš„åå¤„,å½“ç„¶å¦‚æœä¸šåŠ¡éœ€è¦å¤šä¸ªå®ä¾‹åŒæ—¶å·¥ä½œä¹Ÿæ˜¯æ”¯æŒçš„,ä¹Ÿå°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯æœ€å¤šåªèƒ½æœ‰1ä¸ªå®ä¾‹å¤„ç†,å¯ä»¥é€‰ç”¨zookeeperæˆ–è€…rediså°±èƒ½å®ç°åˆ†å¸ƒå¼é”äº†ã€‚</p>

<p>æœ€ç»ˆåšäº†ä¸€ä¸‹æµ‹è¯•å¤šå®ä¾‹åŒæ—¶è¿è¡Œ,å¯èƒ½å› ä¸ºä¼šæ¶‰åŠåˆ°é”çš„é—®é¢˜æ€§èƒ½æœ‰æ‰€ä¸‹é™,åè€Œå•æœºæ•ˆæœå¾ˆå¥½ã€‚æ‰€ä»¥æ¯”è¾ƒæ¨èåŸºäºdockerçš„ä¸»å¤‡éƒ¨ç½²æ¨¡å¼ã€‚</p>

<p>æ‰©å±•
æ”¯æŒzseté˜Ÿåˆ—ä¸ªæ•°å¯é…ç½® é¿å…å¤§æ•°æ®å¸¦æ¥é«˜å»¶è¿Ÿçš„é—®é¢˜ã€‚</p>

<p>ç›®å‰å­˜åœ¨æ—¥å¿—å’Œrediså…ƒæ•°æ®æœ‰å¯èƒ½ä¸ä¸€è‡´çš„é—®é¢˜ å¦‚mysqlæŒ‚äº†,å†™æ—¥å¿—ä¸ä¼šæˆåŠŸã€‚</p>

<p>https://gudaoxuri.gitbook.io/microservices-architecture/wei-fu-wu-hua-zhi-ji-shu-jia-gou/delay-queue</p>

<p>å»¶æ—¶ä»»åŠ¡æœ‰åˆ«äºå®šå¼ä»»åŠ¡ï¼Œå®šå¼ä»»åŠ¡å¾€å¾€æ˜¯å›ºå®šå‘¨æœŸçš„ï¼Œæœ‰æ˜ç¡®çš„è§¦å‘æ—¶é—´ã€‚è€Œå»¶æ—¶ä»»åŠ¡ä¸€èˆ¬æ²¡æœ‰å›ºå®šçš„å¼€å§‹æ—¶é—´ï¼Œå®ƒå¸¸å¸¸æ˜¯ç”±ä¸€ä¸ªäº‹ä»¶è§¦å‘çš„ï¼Œè€Œåœ¨è¿™ä¸ªäº‹ä»¶è§¦å‘ä¹‹åçš„ä¸€æ®µæ—¶é—´å†…è§¦å‘å¦ä¸€ä¸ªäº‹ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»åŠ¡äº‹ä»¶ç”Ÿæˆæ—¶å¹¶ä¸æƒ³è®©æ¶ˆè´¹è€…ç«‹å³æ‹¿åˆ°ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰æ¥æ”¶åˆ°è¯¥äº‹ä»¶è¿›è¡Œæ¶ˆè´¹ã€‚</p>

<p>å»¶è¿Ÿä»»åŠ¡ç›¸å…³çš„ä¸šåŠ¡åœºæ™¯å¦‚ä¸‹ï¼š</p>

<p>åœºæ™¯ä¸€ï¼šåœ¨è®¢å•ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç”¨æˆ·æŸä¸ªæ—¶åˆ»ä¸‹å•ä¹‹åé€šå¸¸æœ‰30åˆ†é’Ÿçš„æ—¶é—´è¿›è¡Œæ”¯ä»˜ï¼Œå¦‚æœ30åˆ†é’Ÿä¹‹å†…æ²¡æœ‰æ”¯ä»˜æˆåŠŸï¼Œé‚£ä¹ˆè¿™ä¸ªè®¢å•å°†è‡ªåŠ¨è¿›è¡Œè¿‡æœŸå¤„ç†ã€‚</p>

<p>åœºæ™¯äºŒï¼šç”¨æˆ·æŸä¸ªæ—¶åˆ»é€šè¿‡æ‰‹æœºè¿œç¨‹é¥æ§å®¶é‡Œçš„æ™ºèƒ½è®¾å¤‡åœ¨æŒ‡å®šçš„æ—¶é—´è¿›è¡Œå·¥ä½œã€‚è¿™æ—¶å°±å¯ä»¥å°†ç”¨æˆ·æŒ‡ä»¤å‘é€åˆ°å»¶æ—¶é˜Ÿåˆ—ï¼Œå½“æŒ‡ä»¤è®¾å®šçš„æ—¶é—´åˆ°äº†å†å°†æŒ‡ä»¤æ¨é€åˆ°åªèƒ½è®¾å¤‡ã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥æ¢è®¨ä¸€äº›æ–¹æ¡ˆï¼Œå…¶å®è¿™äº›æ–¹æ¡ˆæ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œå’Œç³»ç»Ÿæ¶æ„ä¸€æ ·ï¼Œåªæœ‰æœ€é€‚åˆã€‚å¯¹äºæ•°æ®é‡è¾ƒå°çš„æƒ…å†µä¸‹ï¼Œä»»æ„ä¸€ç§æ–¹æ¡ˆéƒ½å¯è¡Œï¼Œè€ƒè™‘çš„æ˜¯ç®€å•æ˜äº†å’Œå¼€å‘é€Ÿåº¦ï¼Œå°½é‡é¿å…æŠŠç³»ç»Ÿæå¤æ‚äº†ã€‚è€Œå¯¹äºæ•°æ®é‡è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼Œå°±éœ€è¦æœ‰ä¸€äº›é€‰æ‹©ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„æ–¹æ¡ˆéƒ½é€‚åˆäº†ã€‚</p>

<p>è§£å†³æ–¹å¼
å®šæ—¶å™¨è½®è¯¢éå†æ•°æ®åº“è®°å½•
JDKçš„DelayQueue
JDK ScheduledExecutorService
æ—¶é—´è½®ï¼ˆnettyï¼‰
åˆ©ç”¨quartzç­‰å®šæ—¶ä»»åŠ¡
Redisçš„ZSetå®ç°
rabbitMqå®ç°å»¶æ—¶é˜Ÿåˆ—
å®šæ—¶å™¨è½®è¯¢éå†æ•°æ®åº“è®°å½•
è¿™æ˜¯æ¯”è¾ƒå¸¸è§çš„ä¸€ç§æ–¹å¼ï¼Œæ‰€æœ‰çš„è®¢å•æˆ–è€…æ‰€æœ‰çš„å‘½ä»¤ä¸€èˆ¬éƒ½ä¼šå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚æˆ‘ä»¬ä¼šèµ·ä¸€ä¸ªçº¿ç¨‹å®šæ—¶å»æ‰«æ•°æ®åº“æˆ–è€…ä¸€ä¸ªæ•°æ®åº“å®šæ—¶Jobï¼Œæ‰¾åˆ°é‚£äº›è¶…æ—¶çš„æ•°æ®ï¼Œç›´æ¥æ›´æ–°çŠ¶æ€ï¼Œæˆ–è€…æ‹¿å‡ºæ¥æ‰§è¡Œä¸€äº›æ“ä½œã€‚è¿™ç§æ–¹å¼å¾ˆç®€å•ï¼Œä¸ä¼šå¼•å…¥å…¶ä»–çš„æŠ€æœ¯ï¼Œå¼€å‘å‘¨æœŸçŸ­ã€‚</p>

<p>å¦‚æœæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œåƒä¸‡çº§ç”šè‡³æ›´å¤šï¼Œæ’å…¥é¢‘ç‡å¾ˆé«˜çš„è¯ï¼Œä¸Šé¢çš„æ–¹å¼åœ¨æ€§èƒ½ä¸Šä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼ŒæŸ¥æ‰¾å’Œæ›´æ–°å¯¹ä¼šå ç”¨å¾ˆå¤šæ—¶é—´ï¼Œè½®è¯¢é¢‘ç‡é«˜çš„è¯ç”šè‡³ä¼šå½±å“æ•°æ®å…¥åº“ã€‚ä¸€ç§å¯ä»¥å°è¯•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨ç±»ä¼¼TBScheduleæˆ–Elastic-Jobè¿™æ ·çš„åˆ†å¸ƒå¼çš„ä»»åŠ¡è°ƒåº¦åŠ ä¸Šæ•°æ®åˆ†ç‰‡åŠŸèƒ½ï¼ŒæŠŠéœ€è¦åˆ¤æ–­çš„æ•°æ®åˆ†åˆ°ä¸åŒçš„æœºå™¨ä¸Šæ‰§è¡Œã€‚</p>

<p>å¦‚æœæ•°æ®é‡è¿›ä¸€æ­¥å¢å¤§ï¼Œé‚£æ‰«æ•°æ®åº“è‚¯å®šå°±ä¸è¡Œäº†ã€‚å¦ä¸€æ–¹é¢ï¼Œå¯¹äºè®¢å•è¿™ç±»æ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿè®¸ä¼šé‡åˆ°åˆ†åº“åˆ†è¡¨ï¼Œé‚£ä¸Šè¿°æ–¹æ¡ˆå°±ä¼šå˜å¾—è¿‡äºå¤æ‚ï¼Œå¾—ä¸å¿å¤±ã€‚</p>

<p>JDKçš„DelayQueue
Javaä¸­çš„DelayQueueä½äºjava.util.concurrentåŒ…ä¸‹ï¼Œä½œä¸ºå•æœºå®ç°ï¼Œå®ƒå¾ˆå¥½çš„å®ç°äº†å»¶è¿Ÿä¸€æ®µæ—¶é—´åè§¦å‘äº‹ä»¶çš„éœ€æ±‚ã€‚ç”±äºæ˜¯çº¿ç¨‹å®‰å…¨çš„å®ƒå¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…å’Œå¤šä¸ªç”Ÿäº§è€…ï¼Œä»è€Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥æå‡æ€§èƒ½ã€‚DelayQueueæœ¬è´¨æ˜¯å°è£…äº†ä¸€ä¸ªPriorityQueueï¼Œä½¿ä¹‹çº¿ç¨‹å®‰å…¨ï¼ŒåŠ ä¸ŠDelayåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹åªèƒ½åœ¨é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯â€œè¿‡æœŸâ€ä¹‹åæ‰èƒ½è¿”å›æ•°æ®è·å–åˆ°æ¶ˆæ¯ï¼Œä¸ç„¶åªèƒ½è·å–åˆ°nullã€‚</p>

<p>ä¹‹æ‰€ä»¥è¦ç”¨åˆ°PriorityQueueï¼Œä¸»è¦æ˜¯éœ€è¦æ’åºã€‚ä¹Ÿè®¸åæ’å…¥çš„æ¶ˆæ¯éœ€è¦æ¯”é˜Ÿåˆ—ä¸­çš„å…¶ä»–æ¶ˆæ¯æå‰è§¦å‘ï¼Œé‚£ä¹ˆè¿™ä¸ªåæ’å…¥çš„æ¶ˆæ¯å°±éœ€è¦æœ€å…ˆè¢«æ¶ˆè´¹è€…è·å–ï¼Œè¿™å°±éœ€è¦æ’åºåŠŸèƒ½ã€‚PriorityQueueå†…éƒ¨ä½¿ç”¨æœ€å°å †æ¥å®ç°æ’åºé˜Ÿåˆ—ã€‚é˜Ÿé¦–çš„ï¼Œæœ€å…ˆè¢«æ¶ˆè´¹è€…æ‹¿åˆ°çš„å°±æ˜¯æœ€å°çš„é‚£ä¸ªã€‚ä½¿ç”¨æœ€å°å †è®©é˜Ÿåˆ—åœ¨æ•°æ®é‡è¾ƒå¤§çš„æ—¶å€™æ¯”è¾ƒæœ‰ä¼˜åŠ¿ã€‚ä½¿ç”¨æœ€å°å †æ¥å®ç°ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸»è¦æ˜¯å› ä¸ºæœ€å°å †åœ¨æ’å…¥å’Œè·å–æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦ç›¸å¯¹éƒ½æ¯”è¾ƒå¥½ï¼Œéƒ½æ˜¯O(logN)ã€‚</p>

<p>ä¸‹é¢ä¾‹å­å®ç°äº†æœªæ¥æŸä¸ªæ—¶é—´è¦è§¦å‘çš„æ¶ˆæ¯ã€‚æˆ‘æŠŠè¿™äº›æ¶ˆæ¯æ”¾åœ¨DelayQueueä¸­ï¼Œå½“æ¶ˆæ¯çš„è§¦å‘æ—¶é—´åˆ°ï¼Œæ¶ˆè´¹è€…å°±èƒ½æ‹¿åˆ°æ¶ˆæ¯ï¼Œå¹¶ä¸”æ¶ˆè´¹ï¼Œå®ç°å¤„ç†æ–¹æ³•ã€‚ç¤ºä¾‹ä»£ç ï¼š</p>

<p>/*</p>
<ul>
  <li>
    <p>å®šä¹‰æ”¾åœ¨å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œéœ€è¦å®ç°Delayedæ¥å£
 */
public class DelayedTask implements Delayed {</p>

    <p>private int _expireInSecond = 0;</p>

    <p>public DelayedTask(int delaySecond) {
     Calendar cal = Calendar.getInstance();
     cal.add(Calendar.SECOND, delaySecond);
     _expireInSecond = (int) (cal.getTimeInMillis() / 1000);
 }</p>

    <p>public int compareTo(Delayed o) {
     long d = (getDelay(TimeUnit.NANOSECONDS) - o.getDelay(TimeUnit.NANOSECONDS));
     return (d == 0) ? 0 : ((d &lt; 0) ? -1 : 1);
 }</p>

    <p>public long getDelay(TimeUnit unit) {
     // TODO Auto-generated method stub</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Calendar cal = Calendar.getInstance();
 return _expireInSecond - (cal.getTimeInMillis() / 1000);   }
</code></pre></div>    </div>
  </li>
</ul>

<p>}
ä¸‹é¢å®šä¹‰äº†ä¸‰ä¸ªå»¶è¿Ÿä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯10ç§’ï¼Œ5ç§’å’Œ15ç§’ã€‚ä¾æ¬¡å…¥é˜Ÿåˆ—ï¼ŒæœŸæœ›5ç§’é’Ÿåï¼Œ5ç§’çš„æ¶ˆæ¯å…ˆè¢«è·å–åˆ°ï¼Œç„¶åæ¯ä¸ª5ç§’é’Ÿï¼Œä¾æ¬¡è·å–åˆ°10ç§’æ•°æ®å’Œ15ç§’çš„é‚£ä¸ªæ•°æ®ã€‚</p>

<p>public static void main(String[] args) throws InterruptedException {
        // TODO Auto-generated method stub</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

    //å®šä¹‰å»¶è¿Ÿé˜Ÿåˆ—
    DelayQueue&lt;DelayedTask&gt; delayQueue = new DelayQueue&lt;DelayedTask&gt;();

    //å®šä¹‰ä¸‰ä¸ªå»¶è¿Ÿä»»åŠ¡
    DelayedTask task1 = new DelayedTask(10);
    DelayedTask task2 = new DelayedTask(5);
    DelayedTask task3 = new DelayedTask(15);

    delayQueue.add(task1);
    delayQueue.add(task2);
    delayQueue.add(task3);

    System.out.println(sdf.format(new Date()) + " start");
    
    while (delayQueue.size() != 0) {
        
        //å¦‚æœæ²¡åˆ°æ—¶é—´ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›
        DelayedTask task = delayQueue.poll();

        if (task != null) {
            Date now = new Date();
            System.out.println(sdf.format(now));
        }
        
        Thread.sleep(1000);
    }
} DelayQueueæ˜¯ä¸€ç§å¾ˆå¥½çš„å®ç°æ–¹å¼ï¼Œè™½ç„¶æ˜¯å•æœºï¼Œä½†æ˜¯å¯ä»¥å¤šçº¿ç¨‹ç”Ÿäº§å’Œæ¶ˆè´¹ï¼Œæé«˜æ•ˆç‡ã€‚æ‹¿åˆ°æ¶ˆæ¯åä¹Ÿå¯ä»¥ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹å»æ‰§è¡Œä¸‹ä¸€æ­¥çš„ä»»åŠ¡ã€‚å¦‚æœæœ‰åˆ†å¸ƒå¼çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨Redisæ¥å®ç°æ¶ˆæ¯çš„åˆ†å‘ï¼Œå¦‚æœå¯¹æ¶ˆæ¯çš„å¯é æ€§æœ‰éå¸¸é«˜çš„è¦æ±‚å¯ä»¥ä½¿ç”¨æ¶ˆæ¯ä¸­é—´ä»¶.
</code></pre></div></div>

<p>JDK ScheduledExecutorService
JDKè‡ªå¸¦çš„ä¸€ç§çº¿ç¨‹æ± ï¼Œå®ƒèƒ½è°ƒåº¦ä¸€äº›å‘½ä»¤åœ¨ä¸€æ®µæ—¶é—´ä¹‹åæ‰§è¡Œï¼Œæˆ–è€…å‘¨æœŸæ€§çš„æ‰§è¡Œã€‚æ–‡ç« å¼€å¤´çš„ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸»è¦ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œå³ï¼Œåœ¨ä¸€æ®µæ—¶é—´ä¹‹åæ‰§è¡ŒæŸä¸ªæ“ä½œã€‚ä»£ç ä¾‹å­å¦‚ä¸‹ï¼š</p>

<p>public static void main(String[] args) {
        // TODO Auto-generated method stub
        ScheduledExecutorService executor = Executors.newScheduledThreadPool(100);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for (int i = 10; i &gt; 0; i--) {
        executor.schedule(new Runnable() {

            public void run() {
                // TODO Auto-generated method stub
                System.out.println(
                        "Work start, thread id:" + Thread.currentThread().getId() + " " + sdf.format(new Date()));
            }

        }, i, TimeUnit.SECONDS);
    }
} ScheduledExecutorServiceçš„å®ç°ç±»ScheduledThreadPoolExecutoræä¾›äº†ä¸€ç§å¹¶è¡Œå¤„ç†çš„æ¨¡å‹ï¼Œç®€åŒ–äº†çº¿ç¨‹çš„è°ƒåº¦ã€‚DelayedWorkQueueæ˜¯ç±»ä¼¼DelayQueueçš„å®ç°ï¼Œä¹Ÿæ˜¯åŸºäºæœ€å°å †çš„ã€çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸Šä¾‹æ’åºåè¾“å‡ºçš„ç»“æœã€‚
</code></pre></div></div>

<p>ScheduledExecutorServiceæ¯”ä¸Šé¢ä¸€ç§DelayQueueæ›´åŠ å®ç”¨ã€‚å› ä¸ºï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨DelayQueueè·å–æ¶ˆæ¯åè§¦å‘äº‹ä»¶éƒ½ä¼šå®ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œï¼Œä»¥ä¿è¯å…¶ä»–äº‹ä»¶èƒ½å‡†æ—¶è¿›è¡Œã€‚è€ŒScheduledThreadPoolExecutorå°±æ˜¯å¯¹è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œäº†å°è£…ï¼Œè®©å¤§å®¶æ›´åŠ æ–¹ä¾¿çš„ä½¿ç”¨ã€‚åŒæ—¶åœ¨åŠ å¼ºäº†éƒ¨åˆ†åŠŸèƒ½ï¼Œæ¯”å¦‚å®šæ—¶è§¦å‘å‘½ä»¤ã€‚</p>

<p>æ—¶é—´è½®
æ—¶é—´è½®æ˜¯ä¸€ç§éå¸¸æƒŠè‰³çš„æ•°æ®ç»“æ„ã€‚å…¶åœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨å¹¿æ³›ï¼Œæ˜¯Linuxå†…æ ¸å®šæ—¶å™¨çš„å®ç°æ–¹æ³•å’ŒåŸºç¡€ä¹‹ä¸€ã€‚æŒ‰ä½¿ç”¨åœºæ™¯ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§æ—¶é—´è½®ï¼šåŸå§‹æ—¶é—´è½®å’Œåˆ†å±‚æ—¶é—´è½®ã€‚åˆ†å±‚æ—¶é—´è½®æ˜¯åŸå§‹æ—¶é—´è½®çš„å‡çº§ç‰ˆæœ¬ï¼Œæ¥åº”å¯¹æ—¶é—´â€œæ§½â€æ•°é‡æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œå¯¹å†…å­˜å’Œç²¾åº¦éƒ½æœ‰å¾ˆé«˜è¦æ±‚çš„æƒ…å†µã€‚æˆ‘ä»¬å»¶è¿Ÿä»»åŠ¡çš„åœºæ™¯ä¸€èˆ¬åªéœ€è¦ç”¨åˆ°åŸå§‹æ—¶é—´è½®å°±å¯ä»¥äº†ã€‚</p>

<p>åŸå§‹æ—¶é—´è½®ï¼šå¦‚ä¸‹å›¾ä¸€ä¸ªè½®å­ï¼Œæœ‰8ä¸ªâ€œæ§½â€ï¼Œå¯ä»¥ä»£è¡¨æœªæ¥çš„ä¸€ä¸ªæ—¶é—´ã€‚å¦‚æœä»¥ç§’ä¸ºå•ä½ï¼Œä¸­é—´çš„æŒ‡é’ˆæ¯éš”ä¸€ç§’é’Ÿè½¬åŠ¨åˆ°æ–°çš„â€œæ§½â€ä¸Šé¢ï¼Œå°±å¥½åƒæ‰‹è¡¨ä¸€æ ·ã€‚å¦‚æœå½“å‰æŒ‡é’ˆæŒ‡åœ¨1ä¸Šé¢ï¼Œæˆ‘æœ‰ä¸€ä¸ªä»»åŠ¡éœ€è¦4ç§’ä»¥åæ‰§è¡Œï¼Œé‚£ä¹ˆè¿™ä¸ªæ‰§è¡Œçš„çº¿ç¨‹å›è°ƒæˆ–è€…æ¶ˆæ¯å°†ä¼šè¢«æ”¾åœ¨5ä¸Šã€‚é‚£å¦‚æœéœ€è¦åœ¨20ç§’ä¹‹åæ‰§è¡Œæ€ä¹ˆåŠï¼Œç”±äºè¿™ä¸ªç¯å½¢ç»“æ„æ§½æ•°åªåˆ°8ï¼Œå¦‚æœè¦20ç§’ï¼ŒæŒ‡é’ˆéœ€è¦å¤šè½¬2åœˆã€‚ä½ç½®æ˜¯åœ¨2åœˆä¹‹åçš„5ä¸Šé¢ï¼ˆ20 % 8 + 1ï¼‰ã€‚è¿™ä¸ªåœˆæ•°éœ€è¦è®°å½•åœ¨æ§½ä¸­çš„æ•°æ®ç»“æ„é‡Œé¢ã€‚è¿™ä¸ªæ•°æ®ç»“æ„æœ€é‡è¦çš„æ˜¯ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæ˜¯è§¦å‘ä»»åŠ¡çš„å‡½æ•°æŒ‡é’ˆï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è§¦å‘çš„æ€»ç¬¬å‡ åœˆæ•°ã€‚æ—¶é—´è½®å¯ä»¥ç”¨ç®€å•çš„æ•°ç»„æˆ–è€…æ˜¯ç¯å½¢é“¾è¡¨æ¥å®ç°ã€‚</p>

<p>ç›¸æ¯”DelayQueueçš„æ•°æ®ç»“æ„ï¼Œæ—¶é—´è½®åœ¨ç®—æ³•å¤æ‚åº¦ä¸Šæœ‰ä¸€å®šä¼˜åŠ¿ã€‚DelayQueueç”±äºæ¶‰åŠåˆ°æ’åºï¼Œéœ€è¦è°ƒå †ï¼Œæ’å…¥å’Œç§»é™¤çš„å¤æ‚åº¦æ˜¯O(lgn)ï¼Œè€Œæ—¶é—´è½®åœ¨æ’å…¥å’Œç§»é™¤çš„å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚</p>

<p>æ—¶é—´è½®æ¯”è¾ƒå¥½çš„å¼€æºå®ç°æ˜¯Nettyçš„</p>

<p>// åˆ›å»ºTimer, ç²¾åº¦ä¸º100æ¯«ç§’,
        HashedWheelTimer timer = new HashedWheelTimer();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    System.out.println(sdf.format(new Date()));

    MyTask task1 = new MyTask();
    MyTask task2 = new MyTask();
    MyTask task3 = new MyTask();
    
    timer.newTimeout(task1, 5, TimeUnit.SECONDS);
    timer.newTimeout(task2, 10, TimeUnit.SECONDS);
    timer.newTimeout(task3, 15, TimeUnit.SECONDS);
    
    // é˜»å¡mainçº¿ç¨‹
    try {
        System.in.read();
    } catch (IOException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    } å…¶ä¸­HashedWheelTimeræœ‰å¤šä¸ªæ„é€ å‡½æ•°ã€‚å…¶ä¸­ï¼š
</code></pre></div></div>

<p>ThreadFactory ï¼šåˆ›å»ºçº¿ç¨‹çš„ç±»ï¼Œé»˜è®¤Executors.defaultThreadFactory()ã€‚</p>

<p>TickDurationï¼šå¤šå°‘æ—¶é—´æŒ‡é’ˆé¡ºæ—¶é’ˆè½¬ä¸€æ ¼ï¼Œå•ä½ç”±ä¸‹é¢ä¸€ä¸ªå‚æ•°æä¾›ã€‚</p>

<p>TimeUnitï¼šä¸Šä¸€ä¸ªå‚æ•°çš„æ—¶é—´å•ä½ã€‚</p>

<p>TicksPerWheelï¼šæ—¶é—´è½®ä¸Šçš„æ ¼å­æ•°ã€‚</p>

<p>å¦‚æœä¸€ä¸ªä»»åŠ¡è¦åœ¨120såæ‰§è¡Œï¼Œæ—¶é—´è½®æ˜¯é»˜è®¤å‚æ•°çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡åœ¨æ—¶é—´è½®ä¸Šéœ€è¦ç»è¿‡</p>

<p>120000ms / (512 * 100ms) = 2è½®</p>

<p>120000ms % (512 * 100ms) = 176æ ¼ã€‚</p>

<p>åœ¨ä½¿ç”¨HashedWheelTimerçš„è¿‡ç¨‹ä¸­ï¼Œå»¶è¿Ÿä»»åŠ¡çš„å®ç°æœ€å¥½ä½¿ç”¨å¼‚æ­¥çš„ï¼Œå› ä¸ºå¦‚æœHashedWheelTimerçš„ä»»åŠ¡ç®¡ç†å’Œæ‰§è¡Œéƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢ï¼Œä»»åŠ¡ä¼šè€—æ—¶ï¼Œé‚£ä¹ˆæŒ‡é’ˆå°±ä¼šå»¶è¿Ÿï¼Œå¯¼è‡´æ•´ä¸ªä»»åŠ¡å°±ä¼šå»¶è¿Ÿã€‚</p>

<p>Quartz
quartzæ˜¯ä¸€ä¸ªä¼ä¸šçº§çš„å¼€æºçš„ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼Œquartzå†…éƒ¨ä½¿ç”¨TreeSetæ¥ä¿å­˜Triggerï¼Œå¦‚ä¸‹å›¾ã€‚Javaä¸­çš„TreeSetæ˜¯ä½¿ç”¨TreeMapå®ç°ï¼ŒTreeMapæ˜¯ä¸€ä¸ªçº¢é»‘æ ‘å®ç°ã€‚çº¢é»‘æ ‘çš„æ’å…¥å’Œåˆ é™¤å¤æ‚åº¦éƒ½æ˜¯logNã€‚å’Œæœ€å°å †ç›¸æ¯”å„æœ‰åƒç§‹ã€‚æœ€å°å †æ’å…¥æ¯”çº¢é»‘æ ‘å¿«ï¼Œåˆ é™¤é¡¶å±‚èŠ‚ç‚¹æ¯”çº¢é»‘æ ‘æ…¢ã€‚
ç›¸æ¯”ä¸Šè¿°çš„ä¸‰ç§è½»é‡çº§çš„å®ç°åŠŸèƒ½ä¸°å¯Œå¾ˆå¤šã€‚æœ‰ä¸“é—¨çš„ä»»åŠ¡è°ƒåº¦çº¿ç¨‹ï¼Œå’Œä»»åŠ¡æ‰§è¡Œçº¿ç¨‹æ± ã€‚quartzåŠŸèƒ½å¼ºå¤§ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ‰§è¡Œå‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ç”¨æ¥å®ç°å»¶è¿Ÿä»»åŠ¡ã€‚ä½†æ˜¯å¦‚æœåªæ˜¯å®ç°ä¸€ä¸ªç®€å•çš„åŸºäºå†…å­˜çš„å»¶æ—¶ä»»åŠ¡çš„è¯ï¼Œquartzå°±ç¨æ˜¾åºå¤§ã€‚</p>

<p>Redis ZSet
Redisä¸­çš„ZSetæ˜¯ä¸€ä¸ªæœ‰åºçš„Setï¼Œå†…éƒ¨ä½¿ç”¨HashMapå’Œè·³è¡¨(SkipList)æ¥ä¿è¯æ•°æ®çš„å­˜å‚¨å’Œæœ‰åºï¼ŒHashMapé‡Œæ”¾çš„æ˜¯æˆå‘˜åˆ°scoreçš„æ˜ å°„ï¼Œè€Œè·³è·ƒè¡¨é‡Œå­˜æ”¾çš„æ˜¯æ‰€æœ‰çš„æˆå‘˜ï¼Œæ’åºä¾æ®æ˜¯HashMapé‡Œå­˜çš„score,ä½¿ç”¨è·³è·ƒè¡¨çš„ç»“æ„å¯ä»¥è·å¾—æ¯”è¾ƒé«˜çš„æŸ¥æ‰¾æ•ˆç‡ï¼Œå¹¶ä¸”åœ¨å®ç°ä¸Šæ¯”è¾ƒç®€å•ã€‚</p>

<p>public class ZSetTest {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private JedisPool jedisPool = null;
// RedisæœåŠ¡å™¨IP
private String ADDR = "10.23.22.42";
// Redisçš„ç«¯å£å·
private int PORT = 6379;

private SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");

public void intJedis() {
    jedisPool = new JedisPool(ADDR, PORT);
}

public static void main(String[] args) {
    // TODO Auto-generated method stub

    ZSetTest zsetTest = new ZSetTest();
    zsetTest.intJedis();

    zsetTest.addItem();
    zsetTest.getItem();

    zsetTest.deleteZSet();
}

public void deleteZSet() {
    Jedis jedis = jedisPool.getResource();
    jedis.del("zset_test");
}

public void addItem() {
    Jedis jedis = jedisPool.getResource();

    Calendar cal1 = Calendar.getInstance();
    cal1.add(Calendar.SECOND, 10);
    int second10later = (int) (cal1.getTimeInMillis() / 1000);

    Calendar cal2 = Calendar.getInstance();
    cal2.add(Calendar.SECOND, 20);
    int second20later = (int) (cal2.getTimeInMillis() / 1000);

    Calendar cal3 = Calendar.getInstance();
    cal3.add(Calendar.SECOND, 30);
    int second30later = (int) (cal3.getTimeInMillis() / 1000);

    Calendar cal4 = Calendar.getInstance();
    cal4.add(Calendar.SECOND, 40);
    int second40later = (int) (cal4.getTimeInMillis() / 1000);

    Calendar cal5 = Calendar.getInstance();
    cal5.add(Calendar.SECOND, 50);
    int second50later = (int) (cal5.getTimeInMillis() / 1000);

    jedis.zadd("zset_test", second50later, "e");
    jedis.zadd("zset_test", second10later, "a");
    jedis.zadd("zset_test", second30later, "c");
    jedis.zadd("zset_test", second20later, "b");
    jedis.zadd("zset_test", second40later, "d");

    System.out.println(sdf.format(new Date()) + " add finished.");
}

public void getItem() {

    Jedis jedis = jedisPool.getResource();

    while (true) {
        try {

            Set&lt;Tuple&gt; set = jedis.zrangeWithScores("zset_test", 0, 0);

            String value = ((Tuple) set.toArray()[0]).getElement();
            int score = (int) ((Tuple) set.toArray()[0]).getScore();

            Calendar cal = Calendar.getInstance();
            int nowSecond = (int) (cal.getTimeInMillis() / 1000);

            if (nowSecond &gt;= score) {
                jedis.zrem("zset_test", value);
                System.out.println(sdf.format(new Date()) + " removed value:" + value);
            }

            if (jedis.zcard("zset_test") &lt;= 0)
            {
                System.out.println(sdf.format(new Date()) + " zset empty ");
                return;
            }
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
}
</code></pre></div></div>

<p>}
åœ¨ç”¨ä½œå»¶è¿Ÿä»»åŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨æ·»åŠ æ•°æ®çš„æ—¶å€™ï¼Œä½¿ç”¨zaddæŠŠscoreå†™æˆæœªæ¥æŸä¸ªæ—¶åˆ»çš„unixæ—¶é—´æˆ³ã€‚æ¶ˆè´¹è€…ä½¿ç”¨zrangeWithScoresè·å–ä¼˜å…ˆçº§æœ€é«˜çš„ï¼ˆæœ€æ—©å¼€å§‹çš„çš„ï¼‰ä»»åŠ¡ã€‚æ³¨æ„ï¼ŒzrangeWithScoreså¹¶ä¸æ˜¯å–å‡ºæ¥ï¼Œåªæ˜¯çœ‹ä¸€ä¸‹å¹¶ä¸åˆ é™¤ï¼Œç±»ä¼¼äºQueueçš„peekæ–¹æ³•ã€‚ç¨‹åºå¯¹æœ€æ—©çš„è¿™ä¸ªæ¶ˆæ¯è¿›è¡ŒéªŒè¯ï¼Œæ˜¯å¦åˆ°è¾¾è¦è¿è¡Œçš„æ—¶é—´ï¼Œå¦‚æœæ˜¯åˆ™æ‰§è¡Œï¼Œç„¶ååˆ é™¤zsetä¸­çš„æ•°æ®ã€‚å¦‚æœä¸æ˜¯ï¼Œåˆ™ç»§ç»­ç­‰å¾…ã€‚</p>

<p>ç”±äºzrangeWithScores å’Œ zremæ˜¯å…ˆåä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æœ‰å¹¶å‘é—®é¢˜ï¼Œå³ä¸¤ä¸ªçº¿ç¨‹æˆ–è€…ä¸¤ä¸ªè¿›ç¨‹éƒ½ä¼šæ‹¿åˆ°ä¸€æ ·çš„ä¸€æ ·çš„æ•°æ®ï¼Œç„¶åé‡å¤æ‰§è¡Œï¼Œæœ€ååˆéƒ½ä¼šåˆ é™¤ã€‚å¦‚æœæ˜¯å•æœºå¤šçº¿ç¨‹æ‰§è¡Œï¼Œæˆ–è€…åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¯ä»¥ä½¿ç”¨Redisäº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç”±Rediså®ç°çš„åˆ†å¸ƒå¼é”ï¼Œæˆ–è€…ä½¿ç”¨ä¸‹ä¾‹ä¸­Redis Scriptã€‚ä½ å¯ä»¥åœ¨Rediså®˜æ–¹çš„Transactionç« èŠ‚æ‰¾åˆ°äº‹åŠ¡çš„ç›¸å…³å†…å®¹ã€‚</p>

<p>ä½¿ç”¨Redisçš„å¥½å¤„ä¸»è¦æ˜¯ï¼š</p>

<p>è§£è€¦ï¼šæŠŠä»»åŠ¡ã€ä»»åŠ¡å‘èµ·è€…ã€ä»»åŠ¡æ‰§è¡Œè€…çš„ä¸‰è€…åˆ†å¼€ï¼Œé€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œç¨‹åºå¼ºå£®æ€§æå‡ï¼Œæœ‰åˆ©äºä»»åŠ¡å‘èµ·è€…å’Œæ‰§è¡Œè€…å„è‡ªè¿­ä»£ï¼Œé€‚åˆå¤šäººåä½œã€‚</p>

<p>å¼‚å¸¸æ¢å¤ï¼šç”±äºä½¿ç”¨Redisä½œä¸ºæ¶ˆæ¯é€šé“ï¼Œæ¶ˆæ¯éƒ½å­˜å‚¨åœ¨Redisä¸­ã€‚å¦‚æœå‘é€ç¨‹åºæˆ–è€…ä»»åŠ¡å¤„ç†ç¨‹åºæŒ‚äº†ï¼Œé‡å¯ä¹‹åï¼Œè¿˜æœ‰é‡æ–°å¤„ç†æ•°æ®çš„å¯èƒ½æ€§ã€‚</p>

<p>åˆ†å¸ƒå¼ï¼šå¦‚æœæ•°æ®é‡è¾ƒå¤§ï¼Œç¨‹åºæ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä»»åŠ¡å‘èµ·è€…å’Œä»»åŠ¡æ‰§è¡Œè€…è¿›è¡Œåˆ†å¸ƒå¼éƒ¨ç½²ã€‚ç‰¹åˆ«æ³¨æ„ä»»åŠ¡çš„æ‰§è¡Œè€…ï¼Œä¹Ÿå°±æ˜¯Redisçš„æ¥æ”¶æ–¹éœ€è¦è€ƒè™‘åˆ†å¸ƒå¼é”çš„é—®é¢˜ã€‚</p>

<p>RabbitMQ TTLå’ŒDXL
AMQPå’ŒRabbitMQæœ¬èº«æ²¡æœ‰ç›´æ¥æ”¯æŒå»¶è¿Ÿé˜Ÿåˆ—åŠŸèƒ½ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡ä»¥ä¸‹ç‰¹æ€§æ¨¡æ‹Ÿå‡ºå»¶è¿Ÿé˜Ÿåˆ—çš„åŠŸèƒ½ã€‚
ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡RabbitMQçš„ä¸¤ä¸ªç‰¹æ€§æ¥æ›²çº¿å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼š</p>

<p>Time To Live(TTL)
RabbitMQå¯ä»¥é’ˆå¯¹Queueå’ŒMessageè®¾ç½® x-message-ttï¼Œæ¥æ§åˆ¶æ¶ˆæ¯çš„ç”Ÿå­˜æ—¶é—´ï¼Œå¦‚æœè¶…æ—¶ï¼Œåˆ™æ¶ˆæ¯å˜ä¸ºdead letter
RabbitMQé’ˆå¯¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯è¿‡æœŸæ—¶é—´æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è®¾ç½®ã€‚</p>

<p>A: é€šè¿‡é˜Ÿåˆ—å±æ€§è®¾ç½®ï¼Œé˜Ÿåˆ—ä¸­æ‰€æœ‰æ¶ˆæ¯éƒ½æœ‰ç›¸åŒçš„è¿‡æœŸæ—¶é—´ã€‚
B: å¯¹æ¶ˆæ¯è¿›è¡Œå•ç‹¬è®¾ç½®ï¼Œæ¯æ¡æ¶ˆæ¯TTLå¯ä»¥ä¸åŒã€‚
å¦‚æœåŒæ—¶ä½¿ç”¨ï¼Œåˆ™æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ä»¥ä¸¤è€…ä¹‹é—´TTLè¾ƒå°çš„é‚£ä¸ªæ•°å€¼ä¸ºå‡†ã€‚æ¶ˆæ¯åœ¨é˜Ÿåˆ—çš„ç”Ÿå­˜æ—¶é—´ä¸€æ—¦è¶…è¿‡è®¾ç½®çš„TTLå€¼ï¼Œå°±æˆä¸ºdead letter
Dead Letter Exchangesï¼ˆDLXï¼‰
RabbitMQçš„Queueå¯ä»¥é…ç½®x-dead-letter-exchange å’Œx-dead-letter-routing-keyï¼ˆå¯é€‰ï¼‰ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœé˜Ÿåˆ—å†…å‡ºç°äº†dead letterï¼Œåˆ™æŒ‰ç…§è¿™ä¸¤ä¸ªå‚æ•°é‡æ–°è·¯ç”±ã€‚</p>

<p>x-dead-letter-exchangeï¼šå‡ºç°dead letterä¹‹åå°†dead letteré‡æ–°å‘é€åˆ°æŒ‡å®šexchange</p>

<p>x-dead-letter-routing-keyï¼šæŒ‡å®šrouting-keyå‘é€</p>

<p>é˜Ÿåˆ—å‡ºç°dead letterçš„æƒ…å†µæœ‰ï¼š</p>

<p>æ¶ˆæ¯æˆ–è€…é˜Ÿåˆ—çš„TTLè¿‡æœŸ
é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦
æ¶ˆæ¯è¢«æ¶ˆè´¹ç«¯æ‹’ç»ï¼ˆbasic.reject or basic.nackï¼‰å¹¶ä¸”requeue=false
åˆ©ç”¨DLXï¼Œå½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡åï¼Œå®ƒèƒ½è¢«é‡æ–°publishåˆ°å¦ä¸€ä¸ªExchangeã€‚è¿™æ—¶å€™æ¶ˆæ¯å°±å¯ä»¥é‡æ–°è¢«æ¶ˆè´¹</p>

<p>æ¶ˆæ¯é˜Ÿåˆ—ä½¿ç”¨ä»‹ç»ï¼š
Â  Â  Â  Â  åœ¨å¾ˆå¤šåœºæ™¯ä¸‹æˆ‘éƒ½æœ‰ç”¨åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæœ‰çš„ä½¿ç”¨Kafkaï¼Œæœ‰çš„ç”¨RabbitMQç­‰éƒ½èƒ½æ»¡è¶³æ¶ˆæ¯çš„ç”Ÿäº§å’Œæ¶ˆè´¹ï¼Œä½†æ˜¯å»¶è¿Ÿé˜Ÿåˆ—å‘¢ï¼Ÿæ€ä¹ˆè®¾è®¡ï¼Œä½†èƒ½é…åˆä»£ç +æ•°æ®åº“+MQä¹Ÿèƒ½å®ç°ï¼Œåªæ˜¯é€»è¾‘ç¹çä¸€ç‚¹ã€‚</p>

<p>Â </p>

<p>éœ€æ±‚èƒŒæ™¯ï¼š
Â  Â  Â  Â  Â å¤§å®¶éƒ½ç”¨è¿‡æ”¯ä»˜å®|å¾®ä¿¡ï¼Œéƒ½æœ‰å¯¹åº”çš„æ”¯ä»˜é€šçŸ¥åŠŸèƒ½ï¼Œä¸”æ˜¯æœ‰é¢‘æ¬¡æ§åˆ¶çš„å“¦ï¼Œï¼ˆåƒæ”¯ä»˜å®ï¼šå¦‚æœå•†æˆ·åé¦ˆç»™æ”¯ä»˜å®çš„å­—ç¬¦ä¸æ˜¯successè¿™7ä¸ªå­—ç¬¦ï¼Œæ”¯ä»˜å®æœåŠ¡å™¨ä¼šä¸æ–­é‡å‘é€šçŸ¥ï¼Œç›´åˆ°è¶…è¿‡24å°æ—¶22åˆ†é’Ÿã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ25å°æ—¶ä»¥å†…å®Œæˆ8æ¬¡é€šçŸ¥ï¼ˆé€šçŸ¥çš„é—´éš”é¢‘ç‡ä¸€èˆ¬æ˜¯ï¼š4m,10m,10m,1h,2h,6h,15hï¼‰ï¼Œè¿™ç§åœºæ™¯å°±å¯ä»¥è®¾è®¡å¯¹åº”çš„å»¶è¿Ÿé˜Ÿåˆ—æ¥å¤„ç†äº†ï¼‰</p>

<p>Â </p>

<p>Redisè®¾è®¡å»¶è¿Ÿé˜Ÿåˆ—ï¼š
Â  Â  Â  Â  Â Redisçš„æœ‰åºé›†åˆå¤©ç„¶æ”¯æŒè¿™ç§åœºæ™¯ï¼Œ</p>

<p>Â  Â  Â  Â  Â $redis-&gt;zAdd(â€˜notify_msg_queueâ€™, â€˜1553053550â€™, â€˜1553053550-1234567891-0â€™);//å€¼ï¼šå½“å‰æ—¶é—´æˆ³-è®¢å•å·-é€šçŸ¥æ¬¡æ•°</p>

<p>Â  Â  Â  Â  Â $redis-&gt;zRangeByScore(â€˜notify_msg_queueâ€™, 0, â€˜1553053550â€™);//æ’åºå› å­ç”¨æ—¶é—´æˆ³ï¼Œè¿™æ ·èƒ½å»é™¤ä¹‹å‰åˆ°ç°åœ¨çš„æ‰€æœ‰æ•°æ®</p>

<p>Â  Â  Â  Â  Â $redis-&gt;zRem(â€˜notify_msg_queueâ€™, â€˜1553053550-1234567891-0â€™)ï¼›//æŒ‡å®šåˆ é™¤å¯¹åº”çš„å€¼</p>

<p>Â </p>

<p>Â  Â  Â  Â  Â è®¾è®¡åŸç†ï¼šé˜Ÿåˆ—åå­—ä¸ºï¼šnotify_msg_queueï¼Œå› å­ä¸ºå½“å‰æ—¶é—´æˆ³ï¼Œå€¼ä¸ºã€å½“å‰æ—¶é—´æˆ³-è®¢å•å·-é€šçŸ¥æ¬¡æ•°ã€‘ï¼Œè·å–çš„æ—¶å€™</p>

<p>Â  Â  Â  Â  Â å¦‚æœé€šè¿‡zRangeByScoreæ‹¿åˆ°å¯¹åº”çš„å€¼èƒ½åå¤„ç†å€¼ï¼Œæ ¹æ® â€œ-â€ç¬¦å·åˆ†å‰²å€¼ï¼Œå¦‚æœæ—¶é—´æˆ³ &lt;= ï¼Œèƒ½åæ ¹æ®è®¢å•å¥½é€šçŸ¥ä¸šåŠ¡æ–¹</p>

<p>Â  Â  Â  Â  Â çš„é€šçŸ¥æ¥å£ï¼Œå¦‚æœé€šçŸ¥æˆåŠŸåˆ™zRemåˆ é™¤å¯¹åº”å€¼ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå¦‚æœé€šçŸ¥æ˜¯å§åˆ é™¤åŸæ¥çš„å€¼ï¼Œé‡æ–°èµ‹æ–°å€¼å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†å²æ—¶é—´æˆ³+4åˆ†é’Ÿï¼ˆè‹¥éƒ½æ˜¯è´¥å°±ä¾æ¬¡å¢åŠ ï¼š4m,10m,10m,1h,2h,6h,15hï¼ŒçŸ¥é“15håï¼‰</p>

<p>http://silence.work/2018/12/16/RocketMQ-%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E7%9A%84%E4%BD%BF%E7%94%A8%E4%B8%8E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</p>

<p>ä»€ä¹ˆæ˜¯å®šæ—¶æ¶ˆæ¯å’Œå»¶è¿Ÿæ¶ˆæ¯ï¼Ÿ
å®šæ—¶æ¶ˆæ¯ï¼šProducer å°†æ¶ˆæ¯å‘é€åˆ° MQ æœåŠ¡ç«¯ï¼Œä½†å¹¶ä¸æœŸæœ›è¿™æ¡æ¶ˆæ¯ç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯æ¨è¿Ÿåˆ°åœ¨å½“å‰æ—¶é—´ç‚¹ä¹‹åçš„æŸä¸€ä¸ªæ—¶é—´æŠ•é€’åˆ° Consumer è¿›è¡Œæ¶ˆè´¹ï¼Œè¯¥æ¶ˆæ¯å³å®šæ—¶æ¶ˆæ¯ã€‚
å»¶è¿Ÿæ¶ˆæ¯ï¼šProducer å°†æ¶ˆæ¯å‘é€åˆ° MQ æœåŠ¡ç«¯ï¼Œä½†å¹¶ä¸æœŸæœ›è¿™æ¡æ¶ˆæ¯ç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯å»¶è¿Ÿä¸€å®šæ—¶é—´åæ‰æŠ•é€’åˆ° Consumer è¿›è¡Œæ¶ˆè´¹ï¼Œè¯¥æ¶ˆæ¯å³å»¶æ—¶æ¶ˆæ¯ã€‚
å®šæ—¶æ¶ˆæ¯ä¸å»¶è¿Ÿæ¶ˆæ¯åœ¨ä»£ç é…ç½®ä¸Šå­˜åœ¨ä¸€äº›å·®å¼‚ï¼Œä½†æ˜¯æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœç›¸åŒï¼šæ¶ˆæ¯åœ¨å‘é€åˆ° MQ æœåŠ¡ç«¯åå¹¶ä¸ä¼šç«‹é©¬æŠ•é€’ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯ä¸­çš„å±æ€§å»¶è¿Ÿå›ºå®šæ—¶é—´åæ‰æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚</p>

<p>ç›®å‰ä¸šç•ŒMQå¯¹å®šæ—¶æ¶ˆæ¯å’Œå»¶è¿Ÿæ¶ˆæ¯çš„æ”¯æŒæƒ…å†µ</p>

<p>ä¸Šå›¾æ˜¯é˜¿é‡Œäº‘ä¸Šå¯¹ä¸šç•ŒMQåŠŸèƒ½çš„å¯¹æ¯”ï¼Œå…¶ä¸­å¼€æºäº§å“ä¸­åªæœ‰é˜¿é‡Œçš„RocketMQæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼Œä¸”æ˜¯å›ºå®šçš„18ä¸ªLevelã€‚</p>

<p>å›ºå®šLevelçš„å«ä¹‰æ˜¯å»¶è¿Ÿæ˜¯ç‰¹å®šçº§åˆ«çš„ï¼Œæ¯”å¦‚æ”¯æŒ3ç§’ã€5ç§’çš„Levelï¼Œé‚£ä¹ˆç”¨æˆ·åªèƒ½å‘é€3ç§’å»¶è¿Ÿæˆ–è€…5ç§’å»¶è¿Ÿï¼Œä¸èƒ½å‘é€8ç§’å»¶è¿Ÿçš„æ¶ˆæ¯ã€‚</p>

<p>æ¶ˆæ¯é˜Ÿåˆ—RocketMQçš„é˜¿é‡Œäº‘ç‰ˆæœ¬ï¼ˆæ”¶è´¹ç‰ˆæœ¬ï¼‰æ‰æ”¯æŒåˆ°ç²¾ç¡®åˆ°ç§’çº§åˆ«çš„å»¶è¿Ÿæ¶ˆæ¯ï¼ˆæ²¡æœ‰ç‰¹å®šLevelçš„é™åˆ¶ï¼‰ã€‚</p>

<p>ä¸Šå›¾æ˜¯CMQä¸­å¯¹MQåŠŸèƒ½çš„å¯¹æ¯”ï¼Œå…¶ä¸­æ ‡æ˜è…¾è®¯çš„CMQæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼Œä½†æ˜¯æ²¡æœ‰å…·ä½“å†™æ˜æ”¯æŒåˆ°ä»€ä¹ˆç²¾åº¦ï¼Œæ”¯æŒä»»æ„æ—¶é—´è¿˜æ˜¯ç‰¹å®šçš„Levelã€‚</p>

<p>é€šè¿‡è…¾è®¯äº‘ä¸ŠCMQçš„APIæ–‡æ¡£å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªç§’çº§åˆ«çš„delaySecondsï¼Œåº”è¯¥æ˜¯æ”¯æŒä»»æ„çº§åˆ«çš„å»¶è¿Ÿï¼Œå³å’Œæ”¶è´¹ç‰ˆæœ¬çš„RocketMQä¸€è‡´ã€‚</p>

<p>æ€»ç»“</p>

<p>å¼€æºç‰ˆæœ¬ä¸­ï¼Œåªæœ‰RocketMQæ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼Œä¸”åªæ”¯æŒ18ä¸ªç‰¹å®šçº§åˆ«çš„å»¶è¿Ÿ
ä»˜è´¹ç‰ˆæœ¬ä¸­ï¼Œé˜¿é‡Œäº‘å’Œè…¾è®¯äº‘ä¸Šçš„MQäº§å“éƒ½æ”¯æŒç²¾åº¦ä¸ºç§’çº§åˆ«çš„å»¶è¿Ÿæ¶ˆæ¯
ï¼ˆçœŸæ˜¯æœ‰é’±èƒ½ä½¿é¬¼æ¨ç£¨å•Šï¼Œæœ‰é’±å°±èƒ½å‘ä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯äº†ï¼Œæ²¡é’±æœ€å¤šåªèƒ½å‘ç‰¹å®šLeveläº†ï¼‰</p>

<p>ä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯éš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿ
å¼€æºç‰ˆæœ¬æ²¡æœ‰æ”¯æŒä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œæˆ‘æƒ³å¯èƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› ï¼š</p>

<p>ä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯çš„éœ€æ±‚ä¸å¼ºçƒˆ
å¯èƒ½æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æŠ€æœ¯å«é‡çš„ç‚¹ï¼Œä¸æ„¿æ„å¼€æº
éœ€æ±‚ä¸å¼º</p>

<p>å¯¹æ”¯æŒä»»æ„å»¶è¿Ÿçš„éœ€æ±‚ç¡®å®ä¸å¼ºï¼Œå› ä¸º:</p>

<p>å»¶è¿Ÿå¹¶ä¸æ˜¯MQåœºæ™¯çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸šåŠ¡å•ç‹¬åšä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆçš„æˆæœ¬ä¸å¤§
ä¸šåŠ¡ä¸Šä¸€èˆ¬å¯¹å»¶è¿Ÿçš„éœ€æ±‚éƒ½æ˜¯å›ºå®šçš„ï¼Œæ¯”å¦‚ä¸‹å•ååŠå°æ—¶checkæ˜¯å¦ä»˜æ¬¾ï¼Œå‘è´§å7å¤©checkæ˜¯å¦æ”¶è´§
åœ¨æˆ‘å¸ï¼ŒMQä¸Šçº¿ä¸€å¹´å¤šåæ‰æœ‰ä¸šåŠ¡æ–¹å¸Œæœ›æˆ‘èƒ½æ”¯æŒå»¶è¿Ÿæ¶ˆæ¯ï¼Œä¸”ä¸è¦æ±‚ä»»æ„å»¶è¿Ÿï¼Œåªè¦æ±‚å’ŒRocketMQå¼€æºç‰ˆæœ¬ä¸€è‡´ï¼Œæ”¯æŒä¸€äº›ä¸šåŠ¡ä¸Šçš„çº§åˆ«å³å¯ã€‚</p>

<p>ä¸æ„¿æ„å¼€æº</p>

<p>ä¸ºäº†å·®å¼‚åŒ–ï¼ˆå¥½åœ¨äº‘ä¸Šå–é’±ï¼‰ï¼Œåªèƒ½é™å¼€æºç‰ˆæœ¬çš„åŠŸèƒ½è¿›è¡Œé˜‰å‰²ï¼Œæ‰€ä»¥å¼€æºç‰ˆæœ¬çš„RocketMQå˜æˆäº†åªæ”¯æŒç‰¹å®šLevelçš„å»¶è¿Ÿã€‚</p>

<p>éš¾ç‚¹åœ¨å“ªé‡Œï¼Ÿ</p>

<p>æ—¢ç„¶ä¸šåŠ¡æœ‰éœ€æ±‚ï¼Œæˆ‘ä»¬è‚¯å®šä¹Ÿè¦å»æ”¯æŒã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåˆ’æ¸…æ¥šå®šä¹‰å’Œè¾¹ç•Œï¼š</p>

<p>åœ¨æˆ‘ä»¬çš„ç³»ç»ŸèŒƒå›´å†…ï¼Œæ”¯æŒä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯æŒ‡çš„æ˜¯ï¼š</p>

<p>ç²¾åº¦æ”¯æŒåˆ°ç§’çº§åˆ«</p>

<p>æœ€å¤§æ”¯æŒ30å¤©çš„å»¶è¿Ÿ</p>

<p>æœ¬ç€å¯¹è‡ªå·±çš„é«˜è¦æ±‚ï¼Œæˆ‘ä»¬å¹¶ä¸æ»¡è¶³äºå¼€æºRocketMQçš„18ä¸ªLevelçš„æ–¹æ¡ˆã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬è‡ªå·±è¦å»å®ç°ä¸€ä¸ªæ”¯æŒä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œéš¾ç‚¹åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>

<p>æ’åº
æ¶ˆæ¯å­˜å‚¨
é¦–å…ˆï¼Œæ”¯æŒä»»æ„å»¶è¿Ÿæ„å‘³ç€æ¶ˆæ¯æ˜¯éœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œæ’åºçš„ã€‚</p>

<p>æ¯”å¦‚ç”¨æˆ·å…ˆå‘äº†ä¸€æ¡å»¶è¿Ÿ1åˆ†é’Ÿçš„æ¶ˆæ¯ï¼Œä¸€ç§’åå‘äº†ä¸€æ¡å»¶è¿Ÿ3ç§’çš„æ¶ˆæ¯ï¼Œæ˜¾ç„¶å»¶è¿Ÿ3ç§’çš„æ¶ˆæ¯éœ€è¦å…ˆè¢«æŠ•é€’å‡ºå»ã€‚é‚£ä¹ˆæœåŠ¡ç«¯åœ¨æ”¶åˆ°æ¶ˆæ¯åéœ€è¦å¯¹æ¶ˆæ¯è¿›è¡Œæ’åºåå†æŠ•é€’å‡ºå»ã€‚</p>

<p>åœ¨MQä¸­ï¼Œä¸ºäº†ä¿è¯å¯é æ€§ï¼Œæ¶ˆæ¯æ˜¯éœ€è¦è½ç›˜çš„ï¼Œä¸”å¯¹æ€§èƒ½å’Œå»¶è¿Ÿçš„è¦æ±‚ï¼Œå†³å®šäº†åœ¨æœåŠ¡ç«¯å¯¹æ¶ˆæ¯è¿›è¡Œæ’åºæ˜¯å®Œå…¨ä¸å¯æ¥å—çš„ã€‚</p>

<p>å…¶æ¬¡ï¼Œç›®å‰MQçš„æ–¹æ¡ˆä¸­éƒ½æ˜¯åŸºäºWALçš„æ–¹å¼å®ç°çš„ï¼ˆRocketMQã€Kafkaï¼‰ï¼Œæ—¥å¿—æ–‡ä»¶ä¼šè¢«è¿‡æœŸåˆ é™¤ï¼Œä¸€èˆ¬ä¼šä¿ç•™æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ•°æ®ã€‚</p>

<p>æ”¯æŒä»»æ„çº§åˆ«çš„å»¶è¿Ÿï¼Œé‚£ä¹ˆéœ€è¦ä¿å­˜æœ€è¿‘30å¤©çš„æ¶ˆæ¯ã€‚</p>

<p>é˜¿é‡Œå†…éƒ¨ 1000+ æ ¸å¿ƒåº”ç”¨ä½¿ç”¨ï¼Œæ¯å¤©æµè½¬å‡ åƒäº¿æ¡æ¶ˆæ¯ï¼Œç»è¿‡åŒ11äº¤æ˜“ã€å•†å“ç­‰æ ¸å¿ƒé“¾è·¯çœŸå®åœºæ™¯çš„éªŒè¯ï¼Œç¨³å®šå¯é ã€‚</p>

<p>è€ƒè™‘ä¸€ä¸‹ä¸€å¤©å‡ åƒäº¿çš„æ¶ˆæ¯ï¼Œä¿å­˜30å¤©çš„è¯éœ€è¦å †å¤šå°‘æœåŠ¡å™¨ï¼Œæ˜¾ç„¶æ˜¯æ— æ³•åšåˆ°çš„ã€‚</p>

<p>çŸ¥å·±çŸ¥å½¼
è™½ç„¶å†³å®šè‡ªå·±åšï¼Œä½†æ˜¯ä¾æ—§éœ€è¦å…ˆäº†è§£å¼€æºçš„å®ç°ï¼Œé‚£ä¹ˆå°±åªèƒ½çœ‹çœ‹RocketMQå¼€æºç‰ˆæœ¬ä¸­ï¼Œæ”¯æŒ18ä¸ªLevelæ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå¸Œæœ›èƒ½ä»ä¸­å¾—åˆ°ä¸€äº›çµæ„Ÿã€‚</p>

<p>ä¸Šå›¾æ˜¯é€šè¿‡RocketMQæºç åˆ†æåç®€åŒ–ä¸€ä¸ªå®ç°åŸç†æ–¹æ¡ˆç¤ºæ„å›¾ã€‚</p>

<p>åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>

<p>æ¶ˆæ¯çš„å†™å…¥
æ¶ˆæ¯çš„Schedule
æ¶ˆæ¯å†™å…¥ä¸­ï¼š</p>

<p>åœ¨å†™å…¥CommitLogä¹‹å‰ï¼Œå¦‚æœæ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œæ›¿æ¢æ‰æ¶ˆæ¯çš„Topicå’ŒqueueId(è¢«æ›¿æ¢ä¸ºå»¶è¿Ÿæ¶ˆæ¯ç‰¹å®šçš„Topicï¼ŒqueueIdåˆ™ä¸ºå»¶è¿Ÿçº§åˆ«å¯¹åº”çš„id)
æ¶ˆæ¯å†™å…¥CommitLogä¹‹åï¼Œæäº¤dispatchRequeståˆ°DispatchService
å› ä¸ºåœ¨ç¬¬â‘ æ­¥ä¸­Topicå’ŒQueueIdè¢«æ›¿æ¢äº†ï¼Œæ‰€ä»¥å†™å…¥çš„ConsumeQueueå®é™…ä¸ŠéçœŸæ­£æ¶ˆæ¯åº”è¯¥æ‰€å±çš„ConsumeQueueï¼Œè€Œæ˜¯å†™å…¥åˆ°ScheduledConsumeQueueä¸­ï¼ˆè¿™ä¸ªç‰¹å®šçš„Queueå­˜æ”¾ä¸ä¼šè¢«æ¶ˆè´¹ï¼‰
Scheduleè¿‡ç¨‹ä¸­ï¼š</p>

<p>ç»™æ¯ä¸ªLevelè®¾ç½®å®šæ—¶å™¨ï¼Œä»ScheduledConsumeQueueä¸­è¯»å–ä¿¡æ¯
å¦‚æœScheduledConsumeQueueä¸­çš„å…ƒç´ å·²è¿‘åˆ°æ—¶ï¼Œé‚£ä¹ˆä»CommitLogä¸­è¯»å–æ¶ˆæ¯å†…å®¹ï¼Œæ¢å¤æˆæ­£å¸¸çš„æ¶ˆæ¯å†…å®¹å†™å…¥CommitLog
å†™å…¥CommitLogåæäº¤dispatchRequestç»™DispatchService
å› ä¸ºåœ¨å†™å…¥CommitLogå‰å·²ç»æ¢å¤äº†Topicç­‰å±æ€§ï¼Œæ‰€ä»¥æ­¤æ—¶DispatchServiceä¼šå°†æ¶ˆæ¯æŠ•é€’åˆ°æ­£ç¡®çš„ConsumeQueueä¸­
å›é¡¾ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼Œæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯æ²¡æœ‰äº†æ’åºï¼š</p>

<p>å…ˆå‘ä¸€æ¡levelæ˜¯5sçš„æ¶ˆæ¯ï¼Œå†å‘ä¸€æ¡levelæ˜¯3sçš„æ¶ˆæ¯ï¼Œå› ä¸ºä»–ä»¬ä¼šå±äºä¸åŒçš„ScheduleQueueæ‰€ä»¥æŠ•é€’é¡ºåºèƒ½ä¿æŒæ­£ç¡®
å¦‚æœå…ˆåå‘ä¸¤æ¡levelç›¸åŒçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆä»–ä»¬çš„å¤„äºåŒä¸€ä¸ªConsumeQueueä¸”ä¿æŒå‘é€é¡ºåº
å› ä¸ºlevelæ•°å›ºå®šï¼Œæ¯ä¸ªlevelçš„æœ‰è‡ªå·±ç‹¬ç«‹çš„å®šæ—¶å™¨ï¼Œå¼€é”€ä¹Ÿä¸ä¼šå¾ˆå¤§
ScheduledConsumeQueueå…¶å®æ˜¯ä¸€ä¸ªæ™®é€šçš„ConsumeQueueï¼Œæ‰€ä»¥å¯é æ€§ç­‰éƒ½å¯ä»¥æŒ‰ç…§åŸç³»ç»Ÿçš„M-Sç»“æ„ç­‰å¾—åˆ°ä¿éšœ
ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼š</p>

<p>å›ºå®šäº†Levelï¼Œä¸å¤Ÿçµæ´»ï¼Œæœ€å¤šåªèƒ½æ”¯æŒ18ä¸ªLevel
ä¸šåŠ¡æ˜¯ä¼šå˜çš„ï¼Œä½†æ˜¯Leveléœ€è¦æå‰åˆ’åˆ†ï¼Œä¸æ”¯æŒä¿®æ”¹
å¦‚æœè¦æ”¯æŒ30å¤©çš„å»¶è¿Ÿï¼ŒCommitLogçš„é‡ä¼šå¾ˆå¤§ï¼Œè¿™å—æ€ä¹ˆå¤„ç†æ²¡æœ‰çœ‹åˆ°</p>

<p>ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Š
æ€»ç»“RocketMQçš„æ–¹æ¡ˆï¼Œé€šè¿‡åˆ’åˆ†Levelçš„æ–¹å¼ï¼Œå°†æ’åºæ“ä½œè½¬æ¢ä¸ºäº†O(1)çš„ConsumeQueue çš„appendæ“ä½œã€‚</p>

<p>æˆ‘ä»¬å»æ”¯æŒä»»æ„å»¶è¿Ÿçš„æ¶ˆæ¯ï¼Œå¿…ç„¶ä¹Ÿéœ€è¦é€šè¿‡ç±»ä¼¼çš„æ–¹å¼é¿å…æ‰æ’åºã€‚</p>

<p>æ­¤æ—¶æˆ‘ä»¬æƒ³åˆ°äº†TimeWheelï¼šã€ŠHashed and Hierarchical Timing Wheels: Data Structures for the Efficient Implementation of a Timer Facility ã€‹</p>

<p>Nettyä¸­ä¹Ÿæ˜¯ç”¨TimeWheelæ¥ä¼˜åŒ–I/Oè¶…æ—¶çš„æ“ä½œã€‚</p>

<p>TimeWheel
TimeWheelçš„å¤§è‡´åŸç†å¦‚ä¸‹ï¼š</p>

<p>ç®­å¤´æŒ‰ç…§ä¸€å®šæ–¹å‘å›ºå®šé¢‘ç‡ç§»åŠ¨ï¼ˆå¦‚æ‰‹è¡¨æŒ‡é’ˆï¼‰ï¼Œæ¯ä¸€æ¬¡è·³åŠ¨ç§°ä¸ºä¸€ä¸ªtickã€‚ticksPerWheelè¡¨ç¤ºä¸€ä¸ªå®šæ—¶è½®ä¸Šçš„tickæ•°ã€‚
å¦‚æ¯æ¬¡tickä¸º1ç§’ï¼ŒticksPerWheelä¸º60ï¼Œé‚£ä¹ˆè¿™å°±å’Œç°å®ä¸­çš„ç§’é’ˆèµ°åŠ¨å®Œå…¨ä¸€è‡´ã€‚</p>

<p>TimeWheelåº”ç”¨åˆ°å»¶è¿Ÿæ¶ˆæ¯ä¸­
æ— è®ºå®šæ—¶æ¶ˆæ¯è¿˜æ˜¯å»¶è¿Ÿæ¶ˆæ¯ï¼Œæœ€ç»ˆéƒ½æ˜¯æŠ•é€’åå»¶è¿Ÿä¸€æ®µæ—¶é—´å¯¹ç”¨æˆ·å¯è§ã€‚</p>

<p>å‡è®¾è¿™ä¸ªå»¶è¿Ÿæ—¶é—´ä¸ºXç§’ï¼Œé‚£ä¹ˆX%(ticksPerWheel * tick)å¯ä»¥è®¡ç®—å‡ºXæ‰€å±çš„TimeWheelä¸­ä½ç½®ã€‚</p>

<p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä»¥ä¸Šå›¾ä¸ºä¾‹ï¼ŒTimeWheelçš„sizeä¸º8ï¼Œé‚£ä¹ˆå»¶è¿Ÿ1ç§’å’Œ9ç§’çš„æ¶ˆæ¯éƒ½å¤„åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ã€‚å¦‚æœç”¨æˆ·å…ˆå‘äº†å»¶è¿Ÿ9ç§’çš„æ¶ˆæ¯å†å‘äº†å»¶è¿Ÿ1ç§’çš„æ¶ˆæ¯ï¼Œä»–ä»¬åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­æ‰€ä»¥å»¶è¿Ÿ1ç§’çš„æ¶ˆæ¯ä¼šéœ€è¦ç­‰å¾…å»¶è¿Ÿ9ç§’çš„æ¶ˆæ¯å…ˆæŠ•é€’ã€‚æ˜¾ç„¶è¿™æ˜¯ä¸èƒ½æ¥å—çš„ï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>

<p>æ’åº</p>

<p>æ˜¾ç„¶ï¼Œå¦‚æœå¯¹TimeWheelä¸€ä¸ªtickä¸­çš„å…ƒç´ è¿›è¡Œæ’åºæ˜¾ç„¶å°±è§£å†³äº†ä¸Šé¢çš„é—®é¢˜ã€‚ä½†æ˜¯æ˜¾è€Œæ˜“è§çš„æ˜¯æ’åºæ˜¯ä¸å¯èƒ½çš„ã€‚</p>

<p>æ‰©å¤§æ—¶é—´è½®</p>

<p>æœ€ç›´è§‚çš„æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½ä¸èƒ½é€šè¿‡æ‰©å¤§æ—¶é—´è½®çš„æ–¹å¼é¿å…å»¶è¿Ÿ9å’Œå»¶è¿Ÿ1è½åˆ°ä¸€ä¸ªtickä½ç½®ä¸Šï¼Ÿ</p>

<p>å‡è®¾æ”¯æŒ30å¤©ï¼Œç²¾åº¦ä¸º1ç§’ï¼Œé‚£ä¹ˆticksPerWheel=30 * 24 * 60 * 60ï¼Œè¿™æ ·æ¯ä¸€ä¸ªtickä¸Šçš„å»¶è¿Ÿéƒ½æ˜¯ä¸€è‡´çš„ï¼Œä¸å­˜åœ¨ä¸Šè¿°çš„é—®é¢˜ï¼ˆç±»ä¼¼äºå°†RocketMQçš„Levelæå‡åˆ°äº†30 * 24 * 60 * 60ä¸ªï¼‰ã€‚ä½†æ˜¯TimeWheeléœ€è¦è¢«åŠ è½½åˆ°å†…å­˜æ“ä½œï¼Œè¿™æ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„ã€‚</p>

<p>å¤šçº§æ—¶é—´è½®</p>

<p>å•ä¸ªTimeWheelæ— æ³•æ”¯æŒï¼Œé‚£ä¹ˆèƒ½å¦æ˜¾ç¤ºä¸­çš„æ—¶é’ˆã€åˆ†é’ˆçš„å½¢å¼ï¼Œæ„å»ºå¤šçº§æ—¶é—´è½®æ¥è§£å†³å‘¢ï¼Ÿ</p>

<p>å¤šçº§æ—¶é—´è½®è§£å†³äº†ä¸Šè¿°çš„é—®é¢˜ï¼Œä½†æ˜¯åˆå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼š</p>

<p>åœ¨æ•´ç‚¹ï¼ˆtickæŒ‡å‘0çš„ä½ç½®ï¼‰éœ€è¦åŠ è½½å¤§é‡çš„æ•°æ®ä¼šå¯¼è‡´å»¶è¿Ÿï¼Œæ¯”å¦‚ç¬¬äºŒä¸ªæ—¶é—´è½®åˆ°æ•´ç‚¹éœ€è¦åŠ è½½æœªæ¥ä¸€å¤©çš„æ•°æ®
æ—¶é—´è½®éœ€è¦è½½å…¥åˆ°å†…å­˜ï¼Œè¿™ä¸ªå¼€é”€æ˜¯ä¸å¯æ¥å—çš„
å»¶è¿ŸåŠ è½½</p>

<p>å¤šçº§å®šæ—¶è½®çš„é—®é¢˜åœ¨äºéœ€è¦åŠ è½½å¤§é‡æ•°æ®åˆ°å†…å­˜ï¼Œé‚£ä¹ˆèƒ½å¦ä¼˜åŒ–ä¸€ä¸‹å°†è¿™é‡Œçš„æ•°æ®å»¶è¿ŸåŠ è½½åˆ°å†…å­˜æ¥è§£å†³å†…å­˜å¼€é”€çš„é—®é¢˜å‘¢ï¼Ÿ</p>

<p>åœ¨å¤šçº§å®šæ—¶è½®çš„æ–¹æ¡ˆä¸­ï¼Œæ˜¾ç„¶å¯¹äºæœªæ¥ä¸€å°æ—¶æˆ–è€…æœªæ¥ä¸€å¤©çš„æ•°æ®å¯ä»¥ä¸åŠ è½½åˆ°å†…å­˜ï¼Œè€Œå¯ä»¥åªåŠ è½½å»¶è¿Ÿæ—¶é—´ä¸´è¿‘çš„æ¶ˆæ¯ã€‚</p>

<p>è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯ä»¥å°†æ•°æ®æŒ‰ç…§å›ºå®šå»¶è¿Ÿé—´éš”åˆ’åˆ†ï¼Œé‚£ä¹ˆæ¯æ¬¡åŠ è½½çš„æ•°æ®é‡æ˜¯å¤§è‡´ç›¸åŒçš„ï¼Œä¸ä¼šå‡ºtickçº¦å¤§çš„å®šæ—¶è½®éœ€è¦åŠ è½½è¶Šå¤šçš„æ•°æ®ï¼Œé‚£ä¹ˆæ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>

<p>åŸºäºä¸Šè¿°çš„æ–¹æ¡ˆï¼Œé‚£ä¹ˆTimeWheelä¸­å­˜å‚¨æœªæ¥30åˆ†é’Ÿéœ€è¦æŠ•é€’çš„æ¶ˆæ¯çš„ç´¢å¼•ï¼Œç´¢å¼•ä¸ºä¸€ä¸ªlongå‹ï¼Œé‚£ä¹ˆæ•°æ®é‡ä¸ºï¼š30 * 60 * 8 * TPSï¼Œç›¸å¯¹æ¥è¯´å†…å­˜å¼€é”€æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæ¯”å¦‚TPSä¸º1wé‚£ä¹ˆå¤§æ¦‚å¼€é”€ä¸º200M+ã€‚</p>

<p>ä¹‹åçš„æ•°æ®æŒ‰ç…§æ¯30åˆ†é’Ÿä¸€ä¸ªå—çš„å½¢å¼å†™å…¥æ–‡ä»¶ï¼Œé‚£ä¹ˆæ¯ä¸ªæ•´ç‚¹æ—¶çš„æ“ä½œå°±æ˜¯è®¡ç®—ä¸€ä¸‹å°†30åˆ†é’Ÿçš„æ¶ˆæ¯Hashåˆ°å¯¹åº”çš„TimeWheelä¸Šï¼Œé‚£ä¹ˆæ’åºé—®é¢˜å°±è§£å†³äº†ã€‚</p>

<p>åˆ°æ­¤ä¸ºæ­¢å°±åªå‰©ä¸‹ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä¿å­˜30å¤©çš„æ•°æ®ï¼Ÿ</p>

<p>CommitLogä¿å­˜è¶…é•¿å»¶è¿Ÿçš„æ•°æ®
CommitLogæ˜¯æœ‰æ—¶æ•ˆæ€§çš„ï¼Œæ¯”å¦‚åœ¨æˆ‘ä»¬åªä¿å­˜æœ€è¿‘7å¤©çš„æ¶ˆæ¯ï¼Œè¿‡æœŸæ•°æ®å°†è¢«åˆ é™¤ã€‚å¯¹äºå»¶è¿Ÿæ¶ˆæ¯ï¼Œå¯èƒ½éœ€è¦30å¤©ä¹‹åæŠ•é€’ï¼Œæ˜¾ç„¶æ˜¯ä¸èƒ½è¢«åˆ é™¤çš„ã€‚</p>

<p>é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆä¿å­˜å»¶è¿Ÿæ¶ˆæ¯å‘¢ï¼Ÿ</p>

<p>ç›´è§‚çš„æ–¹æ³•å°±æ˜¯å°†å»¶è¿Ÿæ¶ˆæ¯ä»CommitLogä¸­å‰¥ç¦»å‡ºæ¥ï¼Œç‹¬ç«‹å­˜å‚¨ä»¥ä¿å­˜æ›´é•¿çš„æ—¶é—´ã€‚</p>

<p>é€šè¿‡DispatchServiceå°†WALä¸­çš„å»¶è¿Ÿæ¶ˆæ¯å†™å…¥åˆ°ç‹¬ç«‹çš„æ–‡ä»¶ä¸­ã€‚è¿™äº›æ–‡ä»¶æŒ‰ç…§å»¶è¿Ÿæ—¶é—´ç»„æˆä¸€ä¸ªé“¾è¡¨ã€‚</p>

<p>é“¾è¡¨é•¿åº¦ä¸ºæœ€å¤§å»¶è¿Ÿæ—¶é—´/æ¯ä¸ªæ–‡ä»¶ä¿å­˜çš„æ—¶é—´é•¿åº¦ã€‚</p>

<p>é‚£ä¹ˆWALå¯ä»¥æŒ‰ç…§æ­£å¸¸çš„ç­–ç•¥è¿›è¡Œè¿‡æœŸåˆ é™¤ï¼ŒDelay Msg Fileåˆ™åœ¨ä¸€ä¸ªæ–‡ä»¶æŠ•é€’å®Œä¹‹åè¿›è¡Œåˆ é™¤ã€‚</p>

<p>å”¯ä¸€çš„é—®é¢˜æ˜¯è¿™é‡Œä¼šæœ‰Delay Msg Fileå¸¦æ¥çš„éšæœºå†™é—®é¢˜ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹ç³»ç»Ÿæ•´ä½“æ€§èƒ½ä¸ä¼šæœ‰å¾ˆå¤§å½±å“ï¼Œåœ¨å¯æ¥å—èŒƒå›´å†…ã€‚</p>

<p>BOUNS
ç»“åˆTimeWheelå’ŒCommitLogä¿å­˜è¶…é•¿å»¶è¿Ÿæ•°æ®çš„æ–¹æ¡ˆï¼ŒåŠ ä¸Šä¸€äº›ä¼˜åŒ–æ‰‹æ®µï¼ŒåŸºæœ¬å°±å®Œæˆäº†æ”¯æŒä»»æ„å»¶è¿Ÿæ—¶é—´çš„æ–¹æ¡ˆï¼š</p>

<p>æ¶ˆæ¯å†™å…¥WAL
Dispatcherå¤„ç†å»¶è¿Ÿæ¶ˆæ¯
å»¶è¿Ÿæ¶ˆæ¯ä¸€å®šæ—¶é—´çš„ç›´æ¥å†™å…¥TimeWheel
å»¶è¿Ÿè¶…è¿‡ä¸€å®šæ—¶é—´å†™å…¥DelayMessageStorage
DelayMessageStorageå¯¹DelayMsgFileæ„å»ºä¸€å±‚ç´¢å¼•ï¼Œè¿™æ ·åœ¨æ˜ å°„åˆ°TimeWheelæ—¶åªéœ€è¦åšä¸€æ¬¡Hashæ“ä½œ
é€šè¿‡TimeWheelå°†æ¶ˆæ¯æŠ•é€’åˆ°ConsumeQueueä¸­å®Œæˆå¯¹Consumerçš„å¯è§
é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆè§£å†³äº†æœ€åˆæå‡ºæ¥çš„ä»»æ„å»¶è¿Ÿæ¶ˆæ¯çš„ä¸¤ä¸ªéš¾ç‚¹ï¼š</p>

<p>æ¶ˆæ¯çš„æ’åºé—®é¢˜
è¶…é•¿å»¶è¿Ÿæ¶ˆæ¯çš„å­˜å‚¨é—®é¢˜</p>

<p>https://www.cnblogs.com/hzmark/p/mq-delay-msg.html</p>
:ET