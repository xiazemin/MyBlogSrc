I"Í<p>PHPçš„ç¼“å­˜æœ‰å¾ˆå¤šç§ï¼ŒåŒ…æ‹¬è¾“å‡ºç¼“å†²(obç³»åˆ—å‡½æ•°)ï¼Œopcodeç¼“å­˜(APCï¼ŒeAccelerator,XCacheç­‰æ‰©å±•å®ç°)ï¼Œè¿™äº›å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œæ¥ä¸‹æ¥ä»‹ç»ä¸€ä¸‹ä¸€ä¸ªä¸å¤ªè¢«äººæ³¨æ„çš„PHPç¼“å­˜æœºåˆ¶ï¼šrealpath_cacheã€‚</p>

<p>ä»‹ç»</p>

<p>require,require_once,include,include_onceè¿™å››ä¸ªè¯­å¥(å¹¶éå‡½æ•°)å¤§å®¶ç»å¸¸ä¼šç”¨åˆ°ï¼Œå¦‚æœç”¨è¿™ç±»è¯­å¥å»åŒ…å«æ–‡ä»¶(ç›¸å¯¹è·¯å¾„)çš„è¯ï¼Œé‚£ä¹ˆPHPä¼šå»include_pathæ‰€ æŒ‡å®šçš„è·¯å¾„ä¸­å»æŸ¥æ‰¾ç›¸å…³æ–‡ä»¶ã€‚ä¸€ä¸ªåº”ç”¨ä¸­ä¼šå­˜åœ¨å¤§é‡çš„require_onceè¯­å¥è°ƒç”¨ï¼Œå¦‚æœæ¯æ¬¡è°ƒç”¨éƒ½å»include_pathä¸­æŸ¥æ‰¾ç›¸åº”çš„æ–‡ä»¶ï¼ŒåŠ¿ å¿…ä¼šå¯¹åº”ç”¨çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ã€‚ä¸ºäº†é¿å…è¿™ç§è´Ÿé¢æ•ˆåº”äº§ç”Ÿçš„å½±å“ï¼ŒPHPERä»¬ä¼šä½¿ç”¨æ–‡ä»¶çš„ç»å¯¹è·¯å¾„æ¥åŒ…å«æ‰€éœ€çš„æ–‡ä»¶ï¼Œè¿™æ ·å°±å‡å°‘äº†æŸ¥è¯¢ include_pathçš„æ¬¡æ•°ã€‚</p>

<p>å…¶å®ï¼ŒPHPè‡ª5.1.0èµ·ï¼Œå°±å¼•å…¥äº†RealpathCacheã€‚RealpathCacheå¯ä»¥æŠŠPHPæ‰€ç”¨åˆ°æ–‡ä»¶çš„realpathè¿›è¡Œç¼“å­˜ï¼Œä»¥ä¾¿PHPå†ä½¿ç”¨è¿™äº›æ–‡ä»¶çš„æ—¶å€™ä¸éœ€è¦å†å»include_pathä¸­æŸ¥æ‰¾ï¼ŒåŠ å¿«PHPçš„æ‰§è¡Œé€Ÿåº¦ã€‚</p>

<p>é…ç½®</p>

<p>realpath cacheçš„é…ç½®é¡¹æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸ºrealpath_cache_sizeå’Œrealpath_cache_ttlï¼Œå¯ä»¥åœ¨php.iniä¸­è¿›è¡Œä¿®æ”¹ï¼š</p>

<p>; Determines the size of the realpath cache to be used by PHP. This value should
; be increased on systems where PHP opens many files to reflect the quantity of
; the file operations performed.
; http://php.net/realpath-cache-size
;realpath_cache_size = 16k</p>

<p>; Duration of time, in seconds for which to cache realpath information for a given
; file or directory. For systems with rarely changing files, consider increasing this
; value.
; http://php.net/realpath-cache-ttl
;realpath_cache_ttl = 120</p>

<p>å…¶ä¸­realpath_cache_sizeæŒ‡å®šäº†realpath cacheçš„å¤§å°ï¼Œé»˜è®¤ä¸º16kï¼Œå¦‚æœä½ è§‰å¾—è¿™ä¸ªå®¹é‡å¤ªå°ï¼Œå¯ä»¥é€‚å½“å¢åŠ ï¼›realpath_cache_ttlæŒ‡å®šäº†ç¼“å­˜çš„è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸º120ç§’ï¼Œ å¯¹äºä¸ç»å¸¸ä¿®æ”¹çš„ç”Ÿäº§ç¯å¢ƒæ¥è¯´ï¼Œè¿™ä¸ªæ•°å­—å¯ä»¥è°ƒæ•´çš„æ›´å¤§äº›ã€‚</p>

<p>é—®é¢˜</p>

<p>ç”±äºrealpathä¼š å±•å¼€symlink(å³è½¯è¿æ¥)ï¼Œæ‰€ä»¥å¦‚æœä½ ä½¿ç”¨ä¿®æ”¹symlinkç›®æ ‡è¿™ç§æ–¹å¼å‘å¸ƒåº”ç”¨çš„æ–°ç‰ˆæœ¬çš„è¯ï¼Œrealpath cacheä¼šå¯¼è‡´ä¸€äº›é—®é¢˜çš„å‡ºç°ï¼šå½“ä½ ä¿®æ”¹symlinkä½¿å…¶æŒ‡å‘ä¸€ä¸ªæ–°çš„releaseç›®å½•æ—¶å€™ï¼Œç”±äºrealpath cacheæ‰€ç¼“å­˜å†…å®¹è¿˜æ²¡æœ‰è¿‡æœŸï¼Œäºæ˜¯å°±ä¼šå‡ºç°åº”ç”¨ä½¿ç”¨çš„è¿˜æ˜¯æ—§çš„releaseï¼Œç›´åˆ°realpath cacheæ‰€ç¼“å­˜å†…å®¹è¿‡æœŸå¤±æ•ˆä¸ºæ­¢(é»˜è®¤120ç§’)ï¼Œæˆ–è€…é‡å¯php-fpmã€‚</p>

<p>çœ‹ä¸ªä¾‹å­ï¼š
åŸºç¡€ç¯å¢ƒï¼šnginx + fastcgi + php-fpm
åº”ç”¨ç¯å¢ƒï¼š/var/www/appæ˜¯ä¸€ä¸ªsymlinkï¼Œå¹¶åšä¸ºdocument_rootï¼Œåœ¨/var/wwwä¸‹å­˜åœ¨version0.1ï¼Œversion0.2ä¸¤ä¸ªç‰ˆæœ¬çš„releaseã€‚åˆå§‹æƒ…å†µä¸‹/var/www/appæŒ‡å‘version0.1</p>

<p>lrwxr-xr-x    1 weizhifeng  staff    10 10 22 16:41 app -&gt; version0.1
drwxr-xr-x    3 weizhifeng  staff   102 10 22 16:43 version0.1
drwxr-xr-x    3 weizhifeng  staff   102 10 22 16:43 version0.2</p>

<p>version0.1ï¼Œversion0.2å†…éƒ¨å„æœ‰ä¸€ä¸ªhello.php</p>

<p>[weizhifeng@Jeremys-Mac www]$ cat version0.1/hello.php
&lt;?php
echo â€˜in version0.1â€™;
?&gt;</p>

<p>[weizhifeng@Jeremys-Mac www]$ cat version0.2/hello.php
&lt;?php
echo â€˜in version0.2â€™;
?&gt;</p>

<p>nginxé…ç½®æ–‡ä»¶ç‰‡æ®µï¼š</p>

<p>location / {
            root /var/www/app;   #appä¸ºsymlink
            index  index.php index.html index.htm;
}</p>

<p>location ~ .php$ {
            root /var/www/app; #appä¸ºsymlink
            fastcgi_pass   127.0.0.1:9000;
            fastcgi_index  index.php;
            include        fastcgi_params;
}</p>

<p>æ­¤æ—¶é€šè¿‡HTTPè®¿é—®hello.phpï¼Œå¾—åˆ°çš„å†…å®¹æ˜¯â€™in version0.1â€²ï¼›ä¿®æ”¹/var/www/appï¼Œä½¿å…¶æŒ‡å‘version0.2</p>

<p>[weizhifeng@Jeremys-Mac www]$ rm -f app &amp;&amp; ln -s version0.2/ app</p>

<p>ä¿®æ”¹å®Œæˆä¹‹åé€šè¿‡HTTPè®¿é—®hello.phpï¼Œå¾—åˆ°çš„å†…å®¹ä»æ—§æ˜¯â€in version0.1â€³ï¼Œå¯è§æ˜¯realpath cacheåœ¨ä½œç¥Ÿäº†ï¼Œæ­¤æ—¶ä½ å¯ä»¥é‡å¯php-fpmæˆ–è€…ç­‰å¾…120ç§’é’Ÿè®©realpath cacheå¤±æ•ˆã€‚</p>

<p>ä½ å¯ä»¥ä½¿ç”¨clearstatcacheæ¥æ¸… é™¤realpath cacheï¼Œä½†æ˜¯è¿™ä¸ªåªå¯¹å½“å‰è°ƒç”¨clearstatcacheå‡½æ•°çš„PHPè¿›ç¨‹æœ‰æ•ˆï¼Œè€Œå…¶ä»–çš„PHPè¿›ç¨‹è¿˜æ˜¯æ— æ•ˆï¼Œç”±äºPHPè¿›ç¨‹æ± ï¼ˆphp-fpmç”Ÿ æˆï¼Œæˆ–è€…Apacheåœ¨preforkæ¨¡å¼ä¸‹äº§ç”Ÿçš„Nä¸ªhttpdå­è¿›ç¨‹ï¼‰çš„å­˜åœ¨ï¼Œè¿™ä¸ªæ–¹æ³•ä¸æ˜¯å¾ˆé€‚ç”¨ã€‚</p>

<p>å‚è€ƒï¼š</p>

<p>http://php.net/manual/en/ini.core.php#ini.sect.performance</p>

<p>http://sixohthree.com/1517/php-and-the-realpath-cache
<!-- more -->
php -i |grep realpath
realpath_cache_size =&gt; 16K =&gt; 16K
realpath_cache_ttl =&gt; 120 =&gt; 120</p>

<p>è¿™æ˜¯è°ƒæ•´åçš„é…ç½®ï¼Œå€¼è®¾ç½®å¤šå°‘åˆé€‚ï¼Œéœ€è¦æ ¹æ®è‡ªèº«çš„æƒ…å†µï¼Œä½ å¯ä»¥é€šè¿‡å¼€æºå·¥å…·cachetoolså»è·å–ç›®å‰å·²ç»ä½¿ç”¨çš„realpath_cache_sizeï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨phpå†…ç½®çš„realpath_cache_size è¿™ä¸ªæ–¹æ³•å»è·å–ã€‚</p>
:ET