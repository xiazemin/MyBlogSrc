I"­<p>APIExtensionServerï¼šä¸»è¦å¤„ç† CustomResourceDefinitionï¼ˆCRDï¼‰å’Œ CustomResourceï¼ˆCRï¼‰çš„ REST è¯·æ±‚ï¼Œä¹Ÿæ˜¯ Delegation çš„æœ€åä¸€ç¯ï¼Œå¦‚æœå¯¹åº” CR ä¸èƒ½è¢«å¤„ç†çš„è¯åˆ™ä¼šè¿”å› 404ã€‚
Aggregator å’Œ APIExtensionsServer å¯¹åº”ä¸¤ç§ä¸»è¦æ‰©å±• APIServer èµ„æºçš„æ–¹å¼ï¼Œå³åˆ†åˆ«æ˜¯ AA å’Œ CRDã€‚</p>

<p>https://www.bookstack.cn/read/source-code-reading-notes/kubernetes-kube_apiserver.md</p>

<p>registry å±‚
å®ç°å„ç§èµ„æºå¯¹è±¡çš„å­˜å‚¨é€»è¾‘</p>

<p>kubernetes/pkg/registryè´Ÿè´£k8så†…ç½®çš„èµ„æºå¯¹è±¡å­˜å‚¨é€»è¾‘å®ç°
k8s.io/apiextensions-apiserver/pkg/registryè´Ÿè´£crdå’Œcrèµ„æºå¯¹è±¡å­˜å‚¨é€»è¾‘å®ç°</p>

<p>https://qiankunli.github.io/2019/01/05/kubernetes_source_apiserver.html
<!-- more -->
kube-apiserverä½œä¸ºæ•´ä¸ªKubernetesé›†ç¾¤æ“ä½œetcdçš„å”¯ä¸€å…¥å£ï¼Œè´Ÿè´£Kuberneteså„èµ„æºçš„è®¤è¯&amp;é‰´æƒï¼Œæ ¡éªŒä»¥åŠCRUDç­‰æ“ä½œï¼Œæä¾›RESTful APIs</p>

<p>kube-apiserveråŒ…å«ä¸‰ç§APIServerï¼š</p>

<p>aggregatorServerï¼šè´Ÿè´£å¤„ç† apiregistration.k8s.io ç»„ä¸‹çš„APIServiceèµ„æºè¯·æ±‚ï¼ŒåŒæ—¶å°†æ¥è‡ªç”¨æˆ·çš„è¯·æ±‚æ‹¦æˆªè½¬å‘ç»™aggregated server(AA)
kubeAPIServerï¼šè´Ÿè´£å¯¹è¯·æ±‚çš„ä¸€äº›é€šç”¨å¤„ç†ï¼ŒåŒ…æ‹¬ï¼šè®¤è¯ã€é‰´æƒä»¥åŠå„ä¸ªå†…å»ºèµ„æº(pod, deploymentï¼Œservice and etc)çš„RESTæœåŠ¡ç­‰
apiExtensionsServerï¼šè´Ÿè´£CustomResourceDefinitionï¼ˆCRDï¼‰apiResourcesä»¥åŠapiVersionsçš„æ³¨å†Œï¼ŒåŒæ—¶å¤„ç†CRDä»¥åŠç›¸åº”CustomResourceï¼ˆCRï¼‰çš„RESTè¯·æ±‚(å¦‚æœå¯¹åº”CRä¸èƒ½è¢«å¤„ç†çš„è¯åˆ™ä¼šè¿”å›404)ï¼Œä¹Ÿæ˜¯apiserver Delegationçš„æœ€åä¸€ç¯</p>

<p>https://www.cnblogs.com/tencent-cloud-native/p/14301277.html</p>

<p>https://www.jianshu.com/p/7100880a8858
kube-apiserver-autoregistration
åœ¨aggregatorå¯åŠ¨çš„æ—¶å€™ï¼Œå³åœ¨createAggregatorServer()æ–¹æ³•ä¸­ï¼Œcrdå’Œapiserverä¸­å®šä¹‰çš„èµ„æºç»„(GroupVersion)ï¼Œä¼šé€šè¿‡kube-apiserver-autoregistration poststarthookï¼Œè¢«è½¬æ¢æˆAPIServiceï¼Œç„¶åæ³¨å†Œè¿›aggregatorä¸­ï¼Œæ¯”å¦‚å°†GroupVersion{Group: â€œappsâ€, Version: â€œv1â€}è½¬æˆAPIService{Spec: v1.APIServiceSpec{Group: â€œappsâ€, Versionâ€ â€œv1â€}}ï¼Œå­˜è¿›æ•°æ®åº“ä¸­ã€‚apiserverä¸­çš„å¯¹è±¡èµ„æºå› ä¸ºæ˜¯k8så†…ç½®çš„ï¼Œæ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ³¨å†Œä¸€æ¬¡å°±å¯ä»¥äº†ï¼Œä½†æ˜¯CRDä¸­çš„èµ„æºï¼Œæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œå¯èƒ½éšæ—¶å¢åˆ æ”¹ï¼Œæ‰€ä»¥éœ€è¦ä¸æ–­çš„è¿›è¡Œæ›´æ–°åŒæ­¥</p>

<p>è¿™ä¸ªè½¬æ¢è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸¤ä¸ªControlleræ¥å®ç°çš„: crdRegistrationControllerå’ŒautoRegistrationControllerï¼Œè¿™é‡Œå°±ä½“ç°äº†Kubernetesä¸­éå¸¸æ ¸å¿ƒçš„è®¾è®¡æ¨¡å¼ï¼ŒController-Loopæ¨¡å¼ï¼Œå³ä¸æ–­ä»APIä¸­è·å–å¯¹è±¡å®šä¹‰ï¼Œç„¶åæŒ‰ç…§APIå¯¹è±¡çš„å®šä¹‰ï¼Œæ‰§è¡Œå¯¹åº”çš„æ“ä½œï¼Œç¡®ä¿APIå¯¹è±¡å®šä¹‰å’Œå®é™…çš„æ•ˆæœæ˜¯ç›¸ç¬¦çš„ï¼Œè¿™ç§APIä¹Ÿå«åšdeclarative apiï¼Œå³ç”³æ˜å¼APIã€‚</p>

<p>autoRegistrationControllerä¸­å®šä¹‰äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜æ·»åŠ è¿›æ¥çš„APIServiceå¯¹è±¡ï¼Œè¿™äº›APIServiceï¼Œå¯èƒ½æ˜¯KubeAPIServeræˆ–è€…APIExtensions APIServerè½¬æ¢è¿‡æ¥çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡APIServiceçš„APIç›´æ¥æ·»åŠ è¿›æ¥çš„ï¼Œç„¶ååœ¨kube-apiserver-autoregistration PostStartHookä¸­ï¼Œå¯åŠ¨è¿™ä¸ªControllerï¼Œé€šè¿‡ä¸æ–­è½®è¯¢ï¼Œå°†é˜Ÿåˆ—ä¸­çš„APIServiceå–å‡ºï¼Œç„¶åè°ƒç”¨apiserviceå¯¹åº”çš„APIï¼Œå°†ä»–ä»¬æ·»åŠ æˆ–è€…æ›´æ–°åˆ°etcdæ•°æ®åº“ä¸­ï¼Œå›ºåŒ–ä¸‹æ¥ã€‚</p>

<p>crdRegistrationControlleråˆ™æ˜¯å°†APIExtensions APIServerä¸­å®šä¹‰çš„CRDå¯¹è±¡è½¬æ¢æˆAPIServiceï¼Œæ³¨å†Œåˆ°autoRegistrationControllerçš„é˜Ÿåˆ—ä¸­ï¼Œç„¶ååœ¨kube-apiserver-autoregistration PostStartHookä¸­ï¼Œå¯åŠ¨è¿™ä¸ªControllerï¼Œé€šè¿‡ä¸æ–­è½®è¯¢CRDçš„APIï¼Œå°†CRDä¸­çš„GroupVersionï¼Œè½¬æ¢æˆAPIServiceï¼Œæ·»åŠ åˆ°autoRegistrationControllerçš„é˜Ÿåˆ—ä¸­ã€‚é™¤äº†APIExtensions APIServerï¼Œè¿˜æœ‰KubeAPIServerï¼Œå› ä¸ºå®ƒé‡Œé¢çš„å¯¹è±¡èµ„æºæ˜¯å†…ç½®çš„ï¼Œä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ï¼Œåœ¨apiServicesToRegister()æ–¹æ³•ä¸­åªè¿›è¡Œä¸€æ¬¡è½¬æ¢ï¼Œç„¶åæ³¨å†Œè¿›autoRegistrationControlleré˜Ÿåˆ—ä¸­ã€‚</p>

<p>https://hackerain.me/2020/10/08/kubernetes/kube-apiserver-extensions.html</p>

<p>https://insujang.github.io/2020-02-11/kubernetes-custom-resource/</p>

:ET