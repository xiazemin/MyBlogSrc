I"ò<p>Flannelå®è´¨ä¸Šæ˜¯ä¸€ç§â€œè¦†ç›–ç½‘ç»œ(overlay network)â€ï¼Œä¹Ÿå°±æ˜¯å°†TCPæ•°æ®åŒ…è£…åœ¨å¦ä¸€ç§ç½‘ç»œåŒ…é‡Œé¢è¿›è¡Œè·¯ç”±è½¬å‘å’Œé€šä¿¡ï¼Œç›®å‰å·²ç»æ”¯æŒUDPã€VxLANã€AWS VPCå’ŒGCEè·¯ç”±ç­‰æ•°æ®è½¬å‘æ–¹å¼ã€‚
é»˜è®¤çš„èŠ‚ç‚¹é—´æ•°æ®é€šä¿¡æ–¹å¼æ˜¯UDPè½¬å‘ã€‚
<!-- more -->
æ•°æ®ä»æºå®¹å™¨ä¸­å‘å‡ºåï¼Œç»ç”±æ‰€åœ¨ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡è½¬å‘åˆ°flannel0è™šæ‹Ÿç½‘å¡ï¼Œè¿™æ˜¯ä¸ªP2Pçš„è™šæ‹Ÿç½‘å¡ï¼ŒflanneldæœåŠ¡ç›‘å¬åœ¨ç½‘å¡çš„å¦å¤–ä¸€ç«¯ã€‚
Flannelé€šè¿‡EtcdæœåŠ¡ç»´æŠ¤äº†ä¸€å¼ èŠ‚ç‚¹é—´çš„è·¯ç”±è¡¨ï¼Œè¯¦ç»†è®°å½•äº†å„èŠ‚ç‚¹å­ç½‘ç½‘æ®µ ã€‚
æºä¸»æœºçš„flanneldæœåŠ¡å°†åŸæœ¬çš„æ•°æ®å†…å®¹UDPå°è£…åæ ¹æ®è‡ªå·±çš„è·¯ç”±è¡¨æŠ•é€’ç»™ç›®çš„èŠ‚ç‚¹çš„flanneldæœåŠ¡ï¼Œæ•°æ®åˆ°è¾¾ä»¥åè¢«è§£åŒ…ï¼Œç„¶åç›´æ¥è¿›å…¥ç›®çš„èŠ‚ç‚¹çš„flannel0è™šæ‹Ÿç½‘å¡ï¼Œç„¶åè¢«è½¬å‘åˆ°ç›®çš„ä¸»æœºçš„docker0è™šæ‹Ÿç½‘å¡ï¼Œæœ€åå°±åƒæœ¬æœºå®¹å™¨é€šä¿¡ä¸€ä¸‹çš„æœ‰docker0è·¯ç”±åˆ°è¾¾ç›®æ ‡å®¹å™¨ã€‚</p>

<p>é…ç½®æ–‡ä»¶
/etc/sysconfig/flanneld</p>

<h1 id="vi-etcsysconfigflanneld">vi /etc/sysconfig/flanneld</h1>

<p>Flanneld configuration options
etcd url location. Point this to the server where etcd runs
FLANNELETCDENDPOINTS=â€http://etcd:2379â€</p>

<p>etcd config key. This is the configuration key that flannel queries
For address range assignment
FLANNELETCDPREFIX=â€/atomic.io/networkâ€</p>

<p>Any additional options that you want to pass
FLANNEL_OPTIONS=â€â€</p>

<p>Flannelä½¿ç”¨Etcdè¿›è¡Œé…ç½®ï¼Œæ¥ä¿è¯å¤šä¸ªFlannelå®ä¾‹ä¹‹é—´çš„é…ç½®ä¸€è‡´æ€§ï¼Œæ‰€ä»¥éœ€è¦åœ¨etcdä¸Šè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼šï¼ˆâ€˜/atomic.io/network/configâ€™è¿™ä¸ªkeyä¸ä¸Šæ–‡/etc/sysconfig/flannelä¸­çš„é…ç½®é¡¹FLANNELETCDPREFIXæ˜¯ç›¸å¯¹åº”çš„ï¼Œé”™è¯¯çš„è¯å¯åŠ¨å°±ä¼šå‡ºé”™ï¼‰
[root@k8s-master ~]# etcdctl mk /atomic.io/network/config â€˜{ â€œNetworkâ€: â€œ10.0.0.0/16â€ }â€™ { â€œNetworkâ€: â€œ10.0.0.0/16â€ }</p>

<p>UDPæŠ¥æ–‡å°è£…
æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªå›¾ï¼Œè¿™æ˜¯åœ¨å…¶ä¸­ä¸€ä¸ªé€šä¿¡èŠ‚ç‚¹ä¸ŠæŠ“å–åˆ°çš„pingå‘½ä»¤é€šä¿¡æ•°æ®åŒ…ã€‚å¯ä»¥çœ‹åˆ°åœ¨UDPçš„æ•°æ®å†…å®¹éƒ¨åˆ†å…¶å®æ˜¯å¦ä¸€ä¸ªICMPï¼ˆä¹Ÿå°±æ˜¯pingå‘½ä»¤ï¼‰çš„æ•°æ®åŒ…ã€‚
åŸå§‹æ•°æ®æ˜¯åœ¨èµ·å§‹èŠ‚ç‚¹çš„FlannelæœåŠ¡ä¸Šè¿›è¡ŒUDPå°è£…çš„ï¼ŒæŠ•é€’åˆ°ç›®çš„èŠ‚ç‚¹åå°±è¢«å¦ä¸€ç«¯çš„FlannelæœåŠ¡è¿˜åŸæˆäº†åŸå§‹çš„æ•°æ®åŒ…ï¼Œä¸¤è¾¹çš„DockeræœåŠ¡éƒ½æ„Ÿè§‰ä¸åˆ°è¿™ä¸ªè¿‡ç¨‹çš„å­˜åœ¨ã€‚
docker IP åˆ†é…
Flannelé€šè¿‡Etcdåˆ†é…äº†æ¯ä¸ªèŠ‚ç‚¹å¯ç”¨çš„IPåœ°å€æ®µåï¼Œå·å·çš„ä¿®æ”¹äº†Dockerçš„å¯åŠ¨å‚æ•°ã€‚
[root@k8s-node-1 ~]# ps aux | grep bip
root       3142  0.1  2.7 560620 27364 ?        Ssl  19:50   0:11 /usr/bin/dockerd-current â€“add-runtime docker-runc=/usr/libexec/docker/docker-runc-current â€“default-runtime=docker-runc â€“exec-opt native.cgroupdriver=systemd â€“userland-proxy-path=/usr/libexec/docker/docker-proxy-current â€“seccomp-profile=/etc/docker/seccomp.json â€“insecure-registry registry:5000 â€“storage-driver overlay2 â€“bip=10.0.53.1/24 â€“ip-masq=true â€“mtu=1472</p>

<p>è¿™ä¸ªæ˜¯åœ¨è¿è¡Œäº†FlannelæœåŠ¡çš„èŠ‚ç‚¹ä¸ŠæŸ¥çœ‹åˆ°çš„DockeræœåŠ¡è¿›ç¨‹è¿è¡Œå‚æ•°ã€‚
æ³¨æ„å…¶ä¸­çš„â€œâ€“bip=10.0.53.1/24â€è¿™ä¸ªå‚æ•°ï¼Œå®ƒé™åˆ¶äº†æ‰€åœ¨èŠ‚ç‚¹å®¹å™¨è·å¾—çš„IPèŒƒå›´ã€‚
è¿™ä¸ªIPèŒƒå›´æ˜¯ç”±Flannelè‡ªåŠ¨åˆ†é…çš„ï¼Œç”±Flannelé€šè¿‡ä¿å­˜åœ¨EtcdæœåŠ¡ä¸­çš„è®°å½•ç¡®ä¿å®ƒä»¬ä¸ä¼šé‡å¤ã€‚
å®¹å™¨IPå¹¶ä¸å›ºå®šï¼ŒIPåˆ†é…è¿˜æ˜¯Dockeråœ¨åšï¼ŒFlannelåªæ˜¯åˆ†é…äº†å­ç½‘æ®µã€‚
æ•°æ®è½¬å‘
ä»¥ä¸‹æ˜¯ k8sé›†ç¾¤ä¸¤ä¸ªnodeèŠ‚ç‚¹çš„è·¯ç”±è¡¨ï¼š
[root@k8s-node-1 ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 ens33
10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 flannel0
10.0.53.0       0.0.0.0         255.255.255.0   U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33</p>

<p>[root@k8s-node-2 ~]# route -n                          <br />
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.1.1     0.0.0.0         UG    100    0        0 ens33
10.0.0.0        0.0.0.0         255.255.0.0     U     0      0        0 flannel0
10.0.80.0       0.0.0.0         255.255.255.0   U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33</p>

<p>ä¾‹å¦‚ï¼šç°åœ¨æœ‰ä¸€ä¸ªæ•°æ®åŒ…è¦ä»IPä¸º10.0.53.2çš„å®¹å™¨å‘åˆ°IPä¸º10.0.80.2çš„å®¹å™¨ã€‚æ ¹æ®æ•°æ®å‘é€èŠ‚ç‚¹çš„è·¯ç”±è¡¨ï¼Œå®ƒåªä¸10.0.0.0/16åŒ¹é…è¿™æ¡è®°å½•åŒ¹é…ï¼Œå› æ­¤æ•°æ®ä»docker0å‡ºæ¥ä»¥åå°±è¢«æŠ•é€’åˆ°äº†flannel0ã€‚åŒç†åœ¨ç›®æ ‡èŠ‚ç‚¹ï¼Œç”±äºæŠ•é€’çš„åœ°å€æ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå› æ­¤ç›®çš„åœ°å€ä¸€å®šä¼šè½åœ¨docker0å¯¹äºçš„10.0.80.0/24è¿™ä¸ªè®°å½•ä¸Šï¼Œç„¶åæŠ•é€’åˆ°äº†docker0ç½‘å¡
å®‰è£…ä¸é…ç½®
åœ¨masterã€nodeä¸Šå‡æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œè¿›è¡Œå®‰è£…
[root@k8s-master ~]# yum install flannel</p>

<p>é…ç½®Flannel
masterã€nodeä¸Šå‡ç¼–è¾‘/etc/sysconfig/flanneld
[root@k8s-master ~]# vi /etc/sysconfig/flanneld</p>

<p>Flanneld configuration options
etcd url location. Point this to the server where etcd runs
FLANNELETCDENDPOINTS=â€http://etcd:2379â€</p>

<p>etcd config key. This is the configuration key that flannel queries
For address range assignment
FLANNELETCDPREFIX=â€/atomic.io/networkâ€</p>

<p>Any additional options that you want to pass
FLANNEL_OPTIONS=â€â€</p>

<p>é…ç½®etcdä¸­å…³äºflannelçš„key
Flannelä½¿ç”¨Etcdè¿›è¡Œé…ç½®ï¼Œæ¥ä¿è¯å¤šä¸ªFlannelå®ä¾‹ä¹‹é—´çš„é…ç½®ä¸€è‡´æ€§ï¼Œæ‰€ä»¥éœ€è¦åœ¨etcdä¸Šè¿›è¡Œå¦‚ä¸‹é…ç½®ï¼šï¼ˆâ€˜/atomic.io/network/configâ€™è¿™ä¸ªkeyä¸ä¸Šæ–‡/etc/sysconfig/flannelä¸­çš„é…ç½®é¡¹FLANNELETCDPREFIXæ˜¯ç›¸å¯¹åº”çš„ï¼Œé”™è¯¯çš„è¯å¯åŠ¨å°±ä¼šå‡ºé”™ï¼‰
[root@k8s-master ~]# etcdctl mk /atomic.io/network/config â€˜{ â€œNetworkâ€: â€œ10.0.0.0/16â€ }â€™ 
{ â€œNetworkâ€: â€œ10.0.0.0/16â€ }</p>

<p>å¯åŠ¨
å¯åŠ¨Flannelä¹‹åï¼Œéœ€è¦ä¾æ¬¡é‡å¯dockerã€kuberneteã€‚
åœ¨masteræ‰§è¡Œï¼š
systemctl enable flanneld.service</p>

<p>systemctl start flanneld.service</p>

<p>service docker restart</p>

<p>systemctl restart kube-apiserver.service</p>

<p>systemctl restart kube-controller-manager.service</p>

<p>systemctl restart kube-scheduler.service</p>

<p>åœ¨nodeä¸Šæ‰§è¡Œï¼š
systemctl enable flanneld.service</p>

<p>systemctl start flanneld.service</p>

<p>service docker restart</p>

<p>systemctl restart kubelet.service</p>

<p>systemctl restart kube-proxy.service</p>
:ET