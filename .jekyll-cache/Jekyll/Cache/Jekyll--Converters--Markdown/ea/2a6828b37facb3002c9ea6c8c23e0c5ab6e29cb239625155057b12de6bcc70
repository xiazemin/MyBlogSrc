I"Ã<p>å½“æ¶ˆæ¯é‡ç‰¹åˆ«å¤§æ—¶ï¼Œä½¿ç”¨kafkaä¹‹ç±»çš„message queueè‡ªç„¶æ˜¯é¦–é€‰ï¼Œä½†æ›´å¤šçš„æ—¶å€™ï¼Œæˆ‘ä»¬æƒ³ç”¨æ›´åŠ è½»é‡çš„æ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>ä¸‹é¢æ¥è¯¦ç»†åˆ†æä¸€ä¸‹æŠ€æœ¯éœ€æ±‚ï¼Œè¿™ä¸ªæ–¹æ¡ˆéœ€è¦å®ç°ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<p>æ¶ˆæ¯èšåˆåå¤„ç†ï¼ˆæœ€å¤§æ¡æ•°ä¸ºBatchSizeï¼‰
å»¶è¿Ÿå¤„ç†ï¼ˆå»¶è¿Ÿæ—¶é—´ä¸ºLingerTimeï¼‰
è‡ªå®šä¹‰é”™è¯¯å¤„ç†
å¹¶å‘å¤„ç†</p>

<p>å¸¦bufferçš„channelç›¸å½“äºä¸€ä¸ªFIFOçš„é˜Ÿåˆ—
å¤šä¸ªå¸¸é©»çš„goroutineæ¥æé«˜å¹¶å‘
goroutineä¹‹é—´æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ¯ä¸ªgoroutineå†…æ˜¯ä¸²è¡Œçš„ï¼Œæ‰€ä»¥å¯¹batchæ“ä½œæ˜¯ä¸ç”¨åŠ é”çš„ã€‚</p>

<!-- more -->

<p>var (
    eventQueue     = make(chan interface{}, 4)
    batchSize      = 8
    workers        = 2
    lingerTime     = 14 * time.Millisecond
    batchProcessor = func(batch []interface{}) error {
        fmt.Printf(â€œ%+v \nâ€, batch)
        return nil
    }
    errHandler = func(err error, batch []interface{}) {
        fmt.Println(â€œsome error happensâ€)
    }
)</p>

<p>for i := 0; i &lt; workers; i++ {
    go func() {
        var batch []interface{}
        lingerTimer := time.NewTimer(0)
        if !lingerTimer.Stop() {
            &lt;-lingerTimer.C
        }
        defer lingerTimer.Stop()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    for {
        select {
        case msg := &lt;-eventQueue:
            batch = append(batch, msg)
            if len(batch) != batchSize {
                if len(batch) == 1 {
                    lingerTimer.Reset(lingerTime)
                }
                break
            }

            if err := batchProcessor(batch); err != nil {
                errHandler(err, batch)
            }

            if !lingerTimer.Stop() {
                &lt;-lingerTimer.C
            }

            batch = make([]interface{}, 0)
        case &lt;-lingerTimer.C:
            if err := batchProcessor(batch); err != nil {
                errHandler(err, batch)
            }

            batch = make([]interface{}, 0)
        }
    }
}() }
</code></pre></div></div>

<p>for i := 0; i &lt; 100; i++ {
    eventQueue &lt;- i
    time.Sleep(1 * time.Millisecond)
}</p>

<p>https://www.jianshu.com/p/02f6647c3912</p>
:ET