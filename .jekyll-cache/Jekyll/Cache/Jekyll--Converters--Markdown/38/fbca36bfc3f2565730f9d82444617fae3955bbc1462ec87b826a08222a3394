I"›H<!-- more -->
<p>rpcæœæ¡†æ¶ï¼Œæä¾›å¤šè¯­è¨€çš„ç¼–è¯‘åŠŸèƒ½ï¼Œå¹¶æä¾›å¤šç§æœåŠ¡å™¨å·¥ä½œæ¨¡å¼ï¼›ç”¨æˆ·é€šè¿‡Thriftçš„IDLï¼ˆæ¥å£å®šä¹‰è¯­è¨€ï¼‰æ¥æè¿°æ¥å£å‡½æ•°åŠæ•°æ®ç±»å‹ï¼Œç„¶åé€šè¿‡Thriftçš„ç¼–è¯‘ç¯å¢ƒç”Ÿæˆå„ç§è¯­è¨€ç±»å‹çš„æ¥å£æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é‡‡ç”¨ä¸åŒçš„è¯­è¨€å¼€å‘å®¢æˆ·ç«¯ä»£ç å’ŒæœåŠ¡å™¨ç«¯ä»£ç ã€‚</p>

<p>è¿˜æœ‰å“ªäº›RPCæ¡†æ¶:protobufã€Avroã€MessagePackç­‰
Thrift interface definition languageï¼ˆIDLï¼‰å¯ä»¥ç”¨æ¥å®šä¹‰Thrift Typesã€‚ä¸€ä¸ªIDLæ–‡ä»¶å¯ä»¥é€šè¿‡Thriftä»£ç ç”Ÿæˆå™¨ç”¨æ¥äº§ç”Ÿä¸åŒè¯­è¨€çš„ä»£ç ä»è€Œæ”¯æŒIDLæ–‡ä»¶ä¸­å£°æ˜çš„ç»“æ„ä½“å’ŒæœåŠ¡ã€‚</p>

<p>thrift IDL
ä¸€. Document</p>

<p>æ¯ä¸ªthrift idlåŒ…å«0ä¸ªæˆ–è€…æ›´å¤šåœ°headersï¼Œheadersåé¢åŒ…å«0ä¸ªæˆ–è€…æ›´å¤šåœ°å®šä¹‰ã€‚</p>

<p>[1]  Document        ::=  Header* Definition*
äºŒ. Header</p>

<p>æ¯ä¸ªheaderè¦ä¹ˆæ˜¯ä¸€ä¸ªThrift includeï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªC++ includeï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªnamespaceå£°æ˜ã€‚</p>

<p>[2]  Header          ::=  Include | CppInclude | Namespace
Thrift Include 
thrift includeå¯ä»¥ä½¿å¾—å¦ä¸€ä¸ªthriftæ–‡ä»¶ä¸­çš„ç¬¦å·å¯ä»¥åœ¨å½“å‰æ–‡ä»¶ä¸­å¯ç”¨ï¼ˆä½¿ç”¨ä¸€ä¸ªå‰ç¼€ï¼‰ï¼Œå¹¶ä¸”æŠŠå¯¹åº”çš„includeå£°æ˜è¯­å¥åŠ å…¥åˆ°å½“å‰thriftæ–‡ä»¶ç”Ÿæˆçš„ä»£ç ä¸­ã€‚
[3]  Include         ::=  â€˜includeâ€™ Literal
C++ Include 
C++ IncludeæŠŠç‰¹å®šçš„C++åŒ…å«åˆ°C++ä»£ç è¾“å‡ºé‡Œé¢ã€‚
[4]  CppInclude      ::=  â€˜cpp_includeâ€™ Literal
Namespace 
å‘½åç©ºé—´ç”³æ˜äº†namespaces/package/module/etcï¼Œâ€œ*â€è¡¨ç¤ºnamespaceé€‚ç”¨æ‰€æœ‰ç›®æ ‡è¯­è¨€ã€‚
[5]  Namespace       ::=  ( â€˜namespaceâ€™ ( NamespaceScope Identifier ) |
                                        ( â€˜smalltalk.categoryâ€™ STIdentifier ) |
                                        ( â€˜smalltalk.prefixâ€™ Identifier ) ) |
                          ( â€˜php_namespaceâ€™ Literal ) |
                          ( â€˜xsd_namespaceâ€™ Literal )</p>

<p>[6]  NamespaceScope  ::=  â€˜*â€™ | â€˜cppâ€™ | â€˜javaâ€™ | â€˜pyâ€™ | â€˜perlâ€™ | â€˜rbâ€™ | â€˜cocoaâ€™ | â€˜csharpâ€™
ä¸¾ä¸ªæ —å­ï¼š</p>

<p>namespace java com.ffy.thrift.test
namespace cpp com.ffy.thrift.test
//namespace * com.ffy.thrift.test
ä¸‰. Definition</p>

<p>[7]  Definition      ::=  Const | Typedef | Enum | Senum | Struct | Union | Exception | Service
Const
[8]  Const           ::=  â€˜constâ€™ FieldType Identifier â€˜=â€™ ConstValue ListSeparator?
ä¾‹å¦‚ï¼š</p>

<p>const i32 DEFAULT_ID = 32
Typedef 
Typedefç”¨äºç»™æŸä¸ªç±»å‹åˆ›å»ºä¸€ä¸ªåˆ«å
[9]  Typedef         ::=  â€˜typedefâ€™ DefinitionType Identifier
ä¾‹å¦‚ï¼š</p>

<p>typedef i32 MyInteger
Enum 
æšä¸¾ç±»å‹ï¼ŒåŒ…å«åç§°å’Œå€¼ï¼›å¦‚æœå¸¸é‡çš„å€¼æ²¡æœ‰å£°æ˜ï¼Œåˆ™è¦ä¹ˆæ˜¯0ï¼ˆç¬¬ä¸€ä¸ªä½ç½®ï¼‰ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªæ¯”å‰é¢æšä¸¾å€¼å¤§çš„å€¼ã€‚ä»»ä½•å¸¸é‡å€¼éƒ½å¿…é¡»æ˜¯éè´Ÿæ•°ã€‚
[10] Enum            ::=  â€˜enumâ€™ Identifier â€˜{â€˜ (Identifier (â€˜=â€™ IntConstant)? ListSeparator?)* â€˜}â€™
ä¾‹å¦‚ï¼š</p>

<p>enum StatusType{
    SUCCESS = 1 
    FAILURE = 2
}
Senum 
å·²åºŸå¼ƒï¼Œç»Ÿä¸€ä½¿ç”¨Stringä»£æ›¿
Struct 
structæ˜¯Thriftä¸­çš„åŸºç¡€ç»„åˆç±»å‹ã€‚structä¸­çš„æ¯ä¸ªfieldçš„åç§°å¿…é¡»å”¯ä¸€ã€‚
[12] Struct          ::=  â€˜structâ€™ Identifier â€˜xsd_allâ€™? â€˜{â€˜ Field* â€˜}â€™
å¤‡æ³¨ï¼šxsd_allå…³é”®è¯åœ¨Facebookå†…éƒ¨æœ‰ä¸€äº›ç‰¹æ®Šæ„ä¹‰ï¼Œä½†thriftæœ¬èº«æ²¡æœ‰ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶ä¸ç”¨ç”¨è¿™ä¸ªå…³é”®è¯ã€‚ 
æ —å­æ¥äº†ï¼š</p>

<p>struct Book{
    1:required i32 id;
    2:required string sn;
    3:required float64 price;
    4:optional string writer;
    5:i32 year;
}
Union 
Unionå’Œstructç±»ä¼¼ï¼Œé™¤äº†ä»–ä»¬æä¾›ä¸€ç§æ–¹å¼åœ¨ä¼ è¾“çš„æ—¶å€™åªä¼ è¾“å¤šä¸ªfieldä¸­çš„ä¸€ä¸ªfieldï¼Œå’ŒC++ä¸­çš„union{}ç±»ä¼¼ã€‚ç®€å•çš„è¯´ï¼Œunioçš„æˆå‘˜éšå¼çš„å®šä¹‰ä¸ºoptionalã€‚
[13] Union          ::=  â€˜unionâ€™ Identifier â€˜xsd_allâ€™? â€˜{â€˜ Field* â€˜}â€™
Exception 
Exceptions å’ŒStructsç±»ä¼¼ï¼Œé™¤äº†ä»–ä¸»è¦æ˜¯ç”¨äº†å¯¹æ¥ç›®æ ‡è¯­è¨€çš„å¼‚å¸¸å¤„ç†é€»è¾‘ã€‚exceptionä¸­çš„æ¯ä¸ªfieldéƒ½å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚
[14] Exception       ::=  â€˜exceptionâ€™ Identifier â€˜{â€˜ Field* â€˜}â€™
Service 
serviceæä¾›äº†Thrift serverå¯¹å¤–æš´éœ²çš„interfaceã€‚è€Œinterfaceè¿™æ˜¯ç®€å•çš„functionåˆ—è¡¨ã€‚ä¸€ä¸ªserviceå¯ä»¥ç»§æ‰¿å¦ä¸€ä¸ªserviceï¼Œè¡¨ç¤ºå®ƒé™¤äº†æä¾›å®ƒè‡ªèº«ç‰¹ç‚¹çš„functionå¤–ï¼Œè¿˜æ‰©å±•äº†è¢«ç»§æ‰¿serviceçš„functionsã€‚
[15] Service         ::=  â€˜serviceâ€™ Identifier ( â€˜extendsâ€™ Identifier )? â€˜{â€˜ Function* â€˜}â€™
1
å››. Field</p>

<p>[16] Field           ::=  FieldID? FieldReq? FieldType Identifier (â€˜= ConstValue)? XsdFieldOptions ListSeparator?
1
Field ID
[17] FieldID         ::=  IntConstant â€˜:â€™
1
Field Requiredness 
fieldçš„requirednesså…·æœ‰ä¸¤ä¸ªæ˜¾ç¤ºå€¼ï¼Œä»¥åŠå¦‚æœrequiredå’Œoptionaléƒ½æ²¡æœ‰æ˜¾ç¤ºæŒ‡å®šï¼Œè®¾ç½®ä¸€ä¸ªdefault requirednessã€‚
[18] FieldReq        ::=  â€˜requiredâ€™ | â€˜optionalâ€™
1
requiredness è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ul>
  <li>required</li>
  <li>Writeï¼šRequired fieldsæ€»æ˜¯è¢«å†™å…¥å¹¶ä¸”æœŸæœ›è¢«è®¾ç½®ã€‚</li>
  <li>Readï¼šRequired fieldsæ€»æ˜¯å¯è¯»å¹¶ä¸”æœŸæœ›è¢«åŒ…å«åœ¨åœ¨è¾“å…¥æµä¸­ã€‚</li>
  <li>Default valuesï¼šæ€»æ˜¯å†™å…¥</li>
</ul>

<p>å¦‚æœä¸€ä¸ªrequired fieldåœ¨è¯»çš„è¿‡ç¨‹ä¸­ç¼ºå¤±ï¼ŒæœŸæœ›çš„è¡Œä¸ºæ˜¯åé¦ˆç»™è°ƒç”¨è€…è¯»å–æ“ä½œä¸æˆåŠŸï¼Œä¾‹å¦‚ï¼šæŠ›å‡ºä¸€ä¸ªexceptionæˆ–è€…è¿”å›ä¸€ä¸ªerrorã€‚ 
æ­£å› ä¸ºè¿™ä¸ªçº¦å®šå­˜åœ¨ï¼Œrequired fieldså½»åº•åœ°é™å®šäº†soft versioningçš„æé™ã€‚å› ä¸ºçš„è¯»å–çš„æ—¶å€™fieldå¿…é¡»å­˜åœ¨ï¼Œæ‰€ä»¥æ”¹fieldæ°¸è¿œä¸èƒ½è¢«è®¾ç½®ä¸ºè¿‡æœŸã€‚å¦‚æœä¸€ä¸ªrequired fieldè¢«ç§»é™¤ï¼Œæˆ–è€…ä¿®æ”¹ä¸ºoptionalï¼Œä¸åŒç‰ˆæœ¬ä¹‹é—´çš„æ•°æ®å°±ä¸åœ¨å…¼å®¹ã€‚</p>
<ul>
  <li>optional</li>
  <li>Write: Optional field åªæœ‰åœ¨ä»–ä»¬è¢«è®¾ç½®äº†ä¹‹åæ‰ä¼šå†™å…¥ã€‚</li>
  <li>Readï¼šOptional field å¯ä»¥æ˜¯ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯è¾“å…¥æµçš„ä¸€éƒ¨åˆ†ã€‚</li>
  <li>Default valuesï¼šåªæœ‰isset flagè¢«è®¾ç½®ä¹‹åæ‰ä¼šå†™å…¥ã€‚</li>
</ul>

<p>å¤§éƒ¨åˆ†è¯­è¨€éƒ½é‡‡ç”¨ä¸€ç§è¢«ç§°ä¸ºâ€œissetâ€ flagçš„æ¨èæ–¹æ¡ˆï¼Œæ¥è¡¨åä¸€ä¸ªç‰¹å®šçš„optional fieldæ˜¯å¦è¢«è®¾ç½®ã€‚åªæœ‰è¯¥æ ‡è®°è¢«è®¾ç½®ï¼Œfieldæ‰ä¼šè¢«å†™å…¥ï¼›ç›¸åçš„ï¼Œåªæœ‰field valueä»è¾“å…¥æµä¸­è¯»å–åˆ°ï¼Œæ”¹æ ‡è®°æ‰ä¼šè¢«è®¾ç½®ã€‚</p>

<p>default requiredness(implicit) 
Write: ç†è®ºä¸Šï¼Œfieldæ€»æ˜¯è¢«å†™å…¥ï¼Œå½“ç„¶æœ‰ä¸€äº›ä¾‹å¤–ï¼Œè§ä¸‹æ–‡ã€‚
Read: å’Œoptionalä¸€æ ·ï¼Œfieldå¯ä»¥æ˜¯ï¼Œä¹Ÿå¯ä»¥ä¸æ˜¯è¾“å…¥æµçš„ä¸€éƒ¨åˆ†ã€‚
Default values: å¯ä»¥ä¸è¢«å†™å…¥ï¼ˆè§ä¸‹ä¸€ç« ï¼‰
Default requiredness æ˜¯ä¸€ä¸ªä¸é”™çš„èµ·ç‚¹ã€‚æœŸæœ›çš„è¡Œä¸ºæ˜¯optionalå’Œrequiredçš„ç»¼åˆï¼Œå› æ­¤ä¹Ÿè¢«ç§°ä¸ºâ€œopt-in,req-outâ€ã€‚å°½ç®¡ç†è®ºä¸Šè¿™äº›fieldæœŸæœ›çš„æ˜¯è¢«å†™å…¥ï¼ˆâ€req-outâ€ï¼‰ï¼Œç°å®ä¸­unsetçš„fieldsæ€»æ˜¯ä¸è¢«å†™å…¥ã€‚ç‰¹åˆ«æ˜¯ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œä¸€äº›fieldçš„å€¼æ˜¯æ— æ³•é€šè¿‡thriftä¼ è¾“çš„ã€‚è¾¾åˆ°è¿™ç§æ•ˆæœçš„å”¯ä¸€é€”å¾„æ˜¯æ ¹æœ¬å°±ä¸å»å†™æ”¹fieldï¼Œè€Œè¿™ä¹Ÿæ˜¯ç»å¤§å¤šæ•°è¯­è¨€æ‰€åšçš„ã€‚</p>
<ul>
  <li>Default Valuesçš„è¯­ä¹‰</li>
</ul>

<p>There are ongoing discussions about that topic, see JIRA for details. Not all implementations treat default values in the very same way, but the current status quo is more or less that default fields are typically set at initialization time. Therefore, a value that equals the default may not be written, because the read end will set the value implicitly. On the other hand, an implementation is free to write the default value anyways, as there is no hard restriction that prevents this. 
The major point to keep in mind here is the fact, that any unwritten default value implicitly becomes part of the interface version. If that default is changed, the interface changes. If, in contrast, the default value is written into the output data, the default in the IDL can change at any time without affecting serialized data.</p>

<p>XSD Options 
N.B.: These have some internal purpose at Facebook but serve no current purpose in Thrift. Use of these options is strongly discouraged.
[19] XsdFieldOptions ::=  â€˜xsd_optionalâ€™? â€˜xsd_nillableâ€™? XsdAttrs?
[20] XsdAttrs        ::=  â€˜xsd_attrsâ€™ â€˜{â€˜ Field* â€˜}â€™
äº”. Functions</p>

<p>[21] Function        ::=  â€˜onewayâ€™? FunctionType Identifier â€˜(â€˜ Field* â€˜)â€™ Throws? ListSeparator?</p>

<table>
  <tbody>
    <tr>
      <td>[22] FunctionType    ::=  FieldType</td>
      <td>â€˜voidâ€™</td>
    </tr>
  </tbody>
</table>

<p>[23] Throws          ::=  â€˜throwsâ€™ â€˜(â€˜ Field* â€˜)â€™
å…­. Types</p>

<table>
  <tbody>
    <tr>
      <td>[24] FieldType       ::=  Identifier</td>
      <td>BaseType</td>
      <td>ContainerType</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>[25] DefinitionType  ::=  BaseType</td>
      <td>ContainerType</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>[26] BaseType        ::=  â€˜boolâ€™</td>
      <td>â€˜byteâ€™</td>
      <td>â€˜i8â€™</td>
      <td>â€˜i16â€™</td>
      <td>â€˜i32â€™</td>
      <td>â€˜i64â€™</td>
      <td>â€˜doubleâ€™</td>
      <td>â€˜stringâ€™</td>
      <td>â€˜binaryâ€™</td>
      <td>â€˜slistâ€™</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>[27] ContainerType   ::=  MapType</td>
      <td>SetType</td>
      <td>ListType</td>
    </tr>
  </tbody>
</table>

<p>[28] MapType         ::=  â€˜mapâ€™ CppType? â€˜&lt;â€™ FieldType â€˜,â€™ FieldType â€˜&gt;â€™</p>

<p>[29] SetType         ::=  â€˜setâ€™ CppType? â€˜&lt;â€™ FieldType â€˜&gt;â€™</p>

<p>[30] ListType        ::=  â€˜listâ€™ â€˜&lt;â€™ FieldType â€˜&gt;â€™ CppType?</p>

<p>[31] CppType         ::=  â€˜cpp_typeâ€™ Literal
ä¸ƒ. Constant Values</p>

<table>
  <tbody>
    <tr>
      <td>[32] ConstValue      ::=  IntConstant</td>
      <td>DoubleConstant</td>
      <td>Literal</td>
      <td>Identifier</td>
      <td>ConstList</td>
      <td>ConstMap</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>[33] IntConstant     ::=  (â€˜+â€™</td>
      <td>â€™-â€˜)? Digit+</td>
    </tr>
  </tbody>
</table>

<table>
  <tbody>
    <tr>
      <td>[34] DoubleConstant  ::=  (â€˜+â€™</td>
      <td>â€™-â€˜)? Digit* (â€˜.â€™ Digit+)? ( (â€˜Eâ€™</td>
      <td>â€˜eâ€™) IntConstant )?</td>
    </tr>
  </tbody>
</table>

<p>[35] ConstList       ::=  â€˜[â€™ (ConstValue ListSeparator?)* â€˜]â€™</p>

<p>[36] ConstMap        ::=  â€˜{â€˜ (ConstValue â€˜:â€™ ConstValue ListSeparator?)* â€˜}â€™
å…«. Basic Definitions</p>
<ol>
  <li>Literal</li>
</ol>

<p>[37] Literal         ::=  (â€˜â€â€™ [^â€]* â€˜â€â€™) | (â€œâ€™â€ [^â€™]* â€œâ€™â€)
1
Identifier
[38] Identifier      ::=  ( Letter | â€˜<em>â€™ ) ( Letter | Digit | â€˜.â€™ | â€˜</em>â€™ )*</p>

<p>[39] STIdentifier    ::=  ( Letter | â€˜<em>â€™ ) ( Letter | Digit | â€˜.â€™ | â€˜</em>â€™ | â€˜-â€˜ )*
1
2
3
List Separator
[40] ListSeparator   ::=  â€˜,â€™ | â€˜;â€™
1
Letters and Digits
[41] Letter          ::=  [â€˜Aâ€™-â€˜Zâ€™] | [â€˜aâ€™-â€˜zâ€™]</p>

<p>[42] Digit           ::=  [â€˜0â€™-â€˜9â€™]</p>

<p>Thriftæ”¯æŒçš„æ•°æ®ç±»å‹ 
1.åŸºæœ¬ç±»å‹ 
boolï¼šå¸ƒå°”å€¼ (true or false), one byte 
byteï¼šæœ‰ç¬¦å·å­—èŠ‚ 
i16ï¼š16ä½æœ‰ç¬¦å·æ•´å‹ 
i32ï¼š32ä½æœ‰ç¬¦å·æ•´å‹ 
i64ï¼š64ä½æœ‰ç¬¦å·æ•´å‹ 
doubleï¼š64ä½æµ®ç‚¹å‹ 
stringï¼šç¼–ç æˆ–è€…äºŒè¿›åˆ¶çš„å­—ç¬¦ä¸²</p>

<p>2.å®¹å™¨ï¼ˆContainersï¼‰ 
Thriftå®¹å™¨ä¸æµè¡Œç¼–ç¨‹è¯­è¨€çš„å®¹å™¨ç±»å‹ç›¸å¯¹åº”ï¼Œé‡‡ç”¨Javaæ³›å‹é£æ ¼ã€‚å®ƒæœ‰3ç§å¯ç”¨å®¹å™¨ç±»å‹ï¼š 
list: å…ƒç´ ç±»å‹ä¸ºt1çš„æœ‰åºè¡¨ï¼Œå®¹è®¸å…ƒç´ é‡å¤ã€‚ 
set:å…ƒç´ ç±»å‹ä¸ºt1çš„æ— åºè¡¨ï¼Œä¸å®¹è®¸å…ƒç´ é‡å¤ã€‚ 
map</p>

<p>includeï¼šå¼•å…¥thriftæ–‡ä»¶ * * *ä¸ºthritçš„æ–‡ä»¶å 
typedefï¼šå®šä¹‰éœ€è¦çš„ç»“æ„ä½“</p>

<p>ç¼–å†™IDLæ–‡ä»¶æ—¶éœ€è¦æ³¨æ„çš„é—®é¢˜</p>

<p>[1]å‡½æ•°çš„å‚æ•°è¦ç”¨æ•°å­—ä¾åºæ ‡å¥½ï¼Œåºå·ä»1å¼€å§‹ï¼Œå½¢å¼ä¸ºï¼šâ€œåºå·:å‚æ•°åâ€;
[2]æ¯ä¸ªå‡½æ•°çš„æœ€åè¦åŠ ä¸Šâ€œ,â€ï¼Œæœ€åä¸€ä¸ªå‡½æ•°ä¸åŠ ï¼›
[3]åœ¨IDLä¸­å¯ä»¥ä½¿ç”¨/<em>â€¦â€¦</em>/æ·»åŠ æ³¨é‡Š
[4]IDLå¤§å°å†™æ•æ„Ÿ</p>

<p>ã€ç±»å‹ ä¹‹ å¼‚å¸¸ã€‘</p>

<p>é™¤äº†ä½¿ç”¨exceptionæ¥æ›¿ä»£structä»¥å¤–ï¼Œâ€œå¼‚å¸¸â€è¿™ä¸ªç±»å‹ï¼Œåœ¨è¯­æ³•ä¸Šå’Œåˆšæ‰ä»‹ç»è¿‡çš„ç»“æ„ä½“çš„ç”¨æ³•æ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚ä½†æ˜¯ä»è¯­ä¹‰ä¸Šè®²ï¼Œexceptionå’Œstructå´å¤§ç›¸å¾„åº­ã€‚exceptionæ˜¯åœ¨è¿œç¨‹è°ƒç”¨å‘ç”Ÿå¼‚å¸¸æ—¶ç”¨æ¥æŠ›å‡ºå¼‚å¸¸ç”¨çš„ã€‚</p>

<p>ã€ç±»å‹ ä¹‹ æœåŠ¡ã€‘</p>

<p>æœåŠ¡çš„å®šä¹‰ï¼Œä¸é¢å‘å¯¹è±¡æŠ€æœ¯ä¸­å®šä¹‰ä¸€ä¸ªæ¥å£å¾ˆç±»ä¼¼ï¼Œè€Œè¿™äº›æ¥å£å…¶å®å°±æ˜¯çº¯è™šå‡½æ•°ã€‚thriftç¼–è¯‘å·¥å…·ä¼šæ ¹æ®æœåŠ¡çš„å®šä¹‰æ¥äº§ç”Ÿç›¸åº”çš„æ–¹æ³•å’Œå‡½æ•°ã€‚</p>

<p>æ¯ä¸ªæœåŠ¡ï¼Œéƒ½åŒ…æ‹¬äº†è‹¥å¹²ä¸ªå‡½æ•°ï¼Œæ¯ä¸ªå‡½æ•°åŒ…æ‹¬äº†è‹¥å¹²å‚æ•°å’Œä¸€ä¸ªè¿”å›å€¼ï¼ˆè¿”å›å€¼å¯ä»¥æ˜¯voidï¼‰ã€‚</p>

<p>ï¼ˆå°æŠ€å·§ï¼šè¿”å›å€¼ä¸ºvoidçš„å‡½æ•°ï¼Œä½ å¯ä»¥åœ¨å‡½æ•°åå‰åŠ ä¸Šonewayæ ‡è¯†ç¬¦ï¼Œå°†æ­¤å‡½æ•°ä»¥å¼‚æ­¥æ¨¡å¼æ‰§è¡Œï¼Œè¿™æ ·åœ¨è°ƒç”¨æ­¤å‡½æ•°åï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›ã€‚ï¼‰</p>

<p>å¯¹äºè¿”å›voidçš„å‡½æ•°ï¼Œthriftä»ç„¶ä¼šç¡®ä¿å‡½æ•°è¿”å›ï¼Œè¿™æ ·å°±è¡¨ç¤ºè¿™ä¸ªå‡½æ•°å·²è¢«æ­£ç¡®æ‰§è¡Œï¼Œä¸”æœåŠ¡å™¨ç«¯å·²æœ‰è¿”å›ä¿¡æ¯äº†ã€‚ä½†æ˜¯å¦‚æœç»™voidçš„å‡½æ•°å‰åŠ ä¸Šonewayï¼Œé‚£ä¹ˆæ­¤å‡½æ•°çš„è¿”å›åªèƒ½è¡¨ç¤ºæ•°æ®å·²ç»è¿›å…¥ä¼ è¾“å±‚ï¼Œå¹¶ä¸èƒ½è¡¨ç¤ºæœåŠ¡å™¨ç«¯å·²ç»æ”¶åˆ°å¹¶è¿”å›äº†æ•°æ®ã€‚</p>

<p>æœåŠ¡ç±»å‹ 
è§„åˆ™ 
ç»§æ‰¿ç±»å¿…é¡»å®ç°è¿™äº›æ–¹æ³• 
å‚æ•°å¯ä»¥æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…ç»“æ„ä½“ 
è¿”å›å€¼å¯ä»¥æ˜¯void 
æœåŠ¡æ”¯æŒç»§æ‰¿ï¼Œä¸€ä¸ªserviceå¯ä½¿ç”¨extendså…³é”®å­—ç»§æ‰¿å¦ä¸€ä¸ªservice 
æœåŠ¡ä¸æ”¯æŒé‡è½½</p>

<p>ä¼ è¾“æ–¹å¼ï¼š</p>
<ol>
  <li>TSocketï¼šé˜»å¡å‹ socketï¼Œç”¨äºå®¢æˆ·ç«¯ï¼Œé‡‡ç”¨ç³»ç»Ÿå‡½æ•° read å’Œ write è¿›è¡Œè¯»å†™æ•°æ®ã€‚</li>
  <li>TServerSocketï¼šéé˜»å¡å‹ socketï¼Œç”¨äºæœåŠ¡å™¨ç«¯ï¼Œaccecpt åˆ°çš„ socket ç±»å‹éƒ½æ˜¯ TSocketï¼ˆå³é˜»å¡å‹ socketï¼‰ã€‚</li>
  <li>TBufferedTransport å’Œ TFramedTransport éƒ½æ˜¯æœ‰ç¼“å­˜çš„ï¼Œå‡ç»§æ‰¿TBufferBaseï¼Œè°ƒç”¨ä¸‹ä¸€å±‚ TTransport ç±»è¿›è¡Œè¯»å†™æ“ä½œå—ï¼Œç»“æ„æä¸ºç›¸ä¼¼ã€‚å…¶ä¸­ TFramedTransport ä»¥å¸§ä¸ºä¼ è¾“å•ä½ï¼Œå¸§ç»“æ„ä¸ºï¼š4ä¸ªå­—èŠ‚ï¼ˆint32_tï¼‰+ä¼ è¾“å­—èŠ‚ä¸²ï¼Œå¤´4ä¸ªå­—èŠ‚æ˜¯å­˜å‚¨åé¢å­—èŠ‚ä¸²çš„é•¿åº¦ï¼Œè¯¥å­—èŠ‚ä¸²æ‰æ˜¯æ­£ç¡®éœ€è¦ä¼ è¾“çš„æ•°æ®ï¼Œå› æ­¤ TFramedTransport æ¯ä¼ ä¸€å¸§è¦æ¯” TBufferedTransport å’Œ TSocket å¤šä¼ 4ä¸ªå­—èŠ‚ã€‚</li>
  <li>TMemoryBuffer ç»§æ‰¿ TBufferBaseï¼Œç”¨äºç¨‹åºå†…éƒ¨é€šä¿¡ç”¨ï¼Œä¸æ¶‰åŠä»»ä½•ç½‘ç»œI/Oï¼Œå¯ç”¨äºä¸‰ç§æ¨¡å¼ï¼š 
ï¼ˆ1ï¼‰OBSERVEæ¨¡å¼ï¼Œä¸å¯å†™æ•°æ®åˆ°ç¼“å­˜ï¼› 
ï¼ˆ2ï¼‰TAKE_OWNERSHIPæ¨¡å¼ï¼Œéœ€è´Ÿè´£é‡Šæ”¾ç¼“å­˜ï¼› 
ï¼ˆ3ï¼‰COPYæ¨¡å¼ï¼Œæ‹·è´å¤–é¢çš„å†…å­˜å—åˆ°TMemoryBufferã€‚</li>
  <li>TFileTransport ç›´æ¥ç»§æ‰¿ TTransportï¼Œç”¨äºå†™æ•°æ®åˆ°æ–‡ä»¶ã€‚å¯¹äº‹ä»¶çš„å½¢å¼å†™æ•°æ®ï¼Œä¸»çº¿ç¨‹è´Ÿè´£å°†äº‹ä»¶å…¥åˆ—ï¼Œå†™çº¿ç¨‹å°†äº‹ä»¶å…¥åˆ—ï¼Œå¹¶å°†äº‹ä»¶é‡Œçš„æ•°æ®å†™å…¥ç£ç›˜ã€‚è¿™é‡Œé¢ç”¨åˆ°äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œç±»å‹ä¸º TFileTransportBufferï¼Œä¸€ä¸ªç”¨äºä¸»çº¿ç¨‹å†™äº‹ä»¶ï¼Œå¦ä¸€ä¸ªç”¨äºå†™çº¿ç¨‹è¯»äº‹ä»¶ï¼Œè¿™å°±é¿å…äº†çº¿ç¨‹ç«äº‰ã€‚åœ¨è¯»å®Œé˜Ÿåˆ—äº‹ä»¶åï¼Œå°±ä¼šè¿›è¡Œé˜Ÿåˆ—äº¤æ¢ï¼Œç”±äºç”±ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œäº¤æ¢åªè¦äº¤æ¢æŒ‡é’ˆå³å¯ã€‚å®ƒè¿˜æ”¯æŒä»¥ chunkï¼ˆå—ï¼‰çš„å½¢å¼å†™æ•°æ®åˆ°æ–‡ä»¶ã€‚</li>
  <li>TFDTransport æ˜¯éå¸¸ç®€å•åœ°å†™æ•°æ®åˆ°æ–‡ä»¶å’Œä»æ–‡ä»¶è¯»æ•°æ®ï¼Œå®ƒçš„ write å’Œ read å‡½æ•°éƒ½æ˜¯ç›´æ¥è°ƒç”¨ç³»ç»Ÿå‡½æ•° write å’Œ read è¿›è¡Œå†™å’Œè¯»æ–‡ä»¶ã€‚</li>
  <li>TSimpleFileTransport ç›´æ¥ç»§æ‰¿ TFDTransportï¼Œæ²¡æœ‰æ·»åŠ ä»»ä½•æˆå‘˜å‡½æ•°å’Œæˆå‘˜å˜é‡ï¼Œä¸åŒçš„æ˜¯æ„é€ å‡½æ•°çš„å‚æ•°å’Œåœ¨ TSimpleFileTransport æ„é€ å‡½æ•°é‡Œå¯¹çˆ¶ç±»è¿›è¡Œäº†åˆå§‹åŒ–ï¼ˆæ‰“å¼€æŒ‡å®šæ–‡ä»¶å¹¶å°†fdä¼ ç»™çˆ¶ç±»å’Œè®¾ç½®çˆ¶ç±»çš„close_policyä¸ºCLOSE_ON_DESTROYï¼‰ã€‚</li>
  <li>TZlibTransport è·Ÿ TBufferedTransport å’Œ TFramedTransportä¸€æ ·ï¼Œè°ƒç”¨ä¸‹ä¸€å±‚ TTransport ç±»è¿›è¡Œè¯»å†™æ“ä½œã€‚å®ƒé‡‡ç”¨æä¾›çš„ zlib å‹ç¼©å’Œè§£å‹ç¼©åº“å‡½æ•°æ¥è¿›è¡Œå‹è§£ç¼©ï¼Œå†™æ—¶å…ˆå‹ç¼©å†è°ƒç”¨åº•å±‚ TTransport ç±»å‘é€æ•°æ®ï¼Œè¯»æ—¶å…ˆè°ƒç”¨ TTransport ç±»æ¥æ”¶æ•°æ®å†è¿›è¡Œè§£å‹ï¼Œæœ€åä¾›ä¸Šå±‚å¤„ç†ã€‚</li>
  <li>TSSLSocket ç»§æ‰¿ TSocketï¼Œé˜»å¡å‹ socketï¼Œç”¨äºå®¢æˆ·ç«¯ã€‚é‡‡ç”¨ openssl çš„æ¥å£è¿›è¡Œè¯»å†™æ•°æ®ã€‚checkHandshake(ï¼‰å‡½æ•°è°ƒç”¨ SSL_set_fd å°† fd å’Œ ssl ç»‘å®šåœ¨ä¸€èµ·ï¼Œä¹‹åå°±å¯ä»¥é€šè¿‡ ssl çš„ SSL_readå’ŒSSL_write æ¥å£è¿›è¡Œè¯»å†™ç½‘ç»œæ•°æ®ã€‚</li>
  <li>TSSLServerSocket ç»§æ‰¿ TServerSocketï¼Œéé˜»å¡å‹ socketï¼Œ ç”¨äºæœåŠ¡å™¨ç«¯ã€‚accecpt åˆ°çš„ socket ç±»å‹éƒ½æ˜¯ TSSLSocket ç±»å‹ã€‚</li>
  <li>THttpClient å’Œ THttpServer æ˜¯åŸºäº Http1.1 åè®®çš„ç»§æ‰¿ Transport ç±»å‹ï¼Œå‡ç»§æ‰¿ THttpTransportï¼Œå…¶ä¸­ THttpClient ç”¨äºå®¢æˆ·ç«¯ï¼ŒTHttpServer ç”¨äºæœåŠ¡å™¨ç«¯ã€‚ä¸¤è€…éƒ½è°ƒç”¨ä¸‹ä¸€å±‚ TTransport ç±»è¿›è¡Œè¯»å†™æ“ä½œï¼Œå‡ç”¨åˆ°TMemoryBuffer ä½œä¸ºè¯»å†™ç¼“å­˜ï¼Œåªæœ‰è°ƒç”¨ flush() å‡½æ•°æ‰ä¼šå°†çœŸæ­£è°ƒç”¨ç½‘ç»œ I/O æ¥å£å‘é€æ•°æ®ã€‚</li>
</ol>

<p>ä¼ è¾“åè®®ï¼š 
Thrift ä¼ è¾“åè®®ä¸Šæ€»ä½“å¯åˆ’åˆ†ä¸ºæ–‡æœ¬ (text) å’ŒäºŒè¿›åˆ¶ (binary) ä¼ è¾“åè®®ä¸¤å¤§ç±»ï¼Œä¸€èˆ¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨äºŒè¿›åˆ¶ç±»å‹çš„ä¼ è¾“åè®®ä¸ºå¤šæ•°ã€‚ 
TBinaryProtocolï¼šæ˜¯Thriftçš„é»˜è®¤åè®®ï¼Œä½¿ç”¨äºŒè¿›åˆ¶ç¼–ç æ ¼å¼è¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒåŸºæœ¬ä¸Šç›´æ¥å‘é€åŸå§‹æ•°æ® 
TCompactProtocolï¼šå‹ç¼©çš„ã€å¯†é›†çš„æ•°æ®ä¼ è¾“åè®®ï¼ŒåŸºäºVariable-length quantityçš„zigzag ç¼–ç æ ¼å¼ 
TJSONProtocolï¼šä»¥JSON (JavaScript Object Notation)æ•°æ®ç¼–ç åè®®è¿›è¡Œæ•°æ®ä¼ è¾“ 
TDebugProtocolï¼šå¸¸å¸¸ç”¨ä»¥ç¼–ç äººå‘˜æµ‹è¯•ï¼Œä»¥æ–‡æœ¬çš„å½¢å¼å±•ç°æ–¹ä¾¿é˜…è¯»</p>

<p>æœåŠ¡ç«¯ç¼–å†™ï¼š 
åŒ…å«ä¸‰ä¸ªä¸»è¦çš„ç»„ä»¶ï¼šprotocolï¼Œtransport å’Œ serverã€‚ 
å…¶ä¸­ï¼Œprotocol å®šä¹‰äº†æ¶ˆæ¯æ˜¯æ€æ ·åºåˆ—åŒ–çš„ï¼›transport å®šä¹‰äº†æ¶ˆæ¯æ˜¯æ€æ ·åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ä¹‹é—´é€šä¿¡çš„ï¼›server ç”¨äºä» transport æ¥æ”¶åºåˆ—åŒ–çš„æ¶ˆæ¯ï¼Œæ ¹æ® protocol ååºåˆ—åŒ–ä¹‹ï¼Œè°ƒç”¨ç”¨æˆ·å®šä¹‰çš„æ¶ˆæ¯å¤„ç†å™¨ï¼Œå¹¶åºåˆ—åŒ–æ¶ˆæ¯å¤„ç†å™¨çš„å“åº”ï¼Œç„¶åå†å°†å®ƒä»¬å†™å› transportã€‚</p>

<p>thriftç¼–è¯‘å·¥å…·çš„åç§°å°±æ˜¯thriftï¼Œå…¶æœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š
thrift â€“gen ${å¼€å‘è¯­è¨€} ${thriftæ¥å£æè¿°æ–‡ä»¶}</p>

<p>eg:
thrift -gen php:server xxxApi.thrift
thrift -gen php xxxApi.thrift</p>

<p>åŠ äº†ï¼šserver ä¼šäº§ç”Ÿ xxxProcessor çš„ç±»ï¼ŒåŒ…å«å¤„ç†å‡½æ•°</p>

<p>æœåŠ¡ç«¯ç¼–å†™çš„ä¸€èˆ¬æ­¥éª¤ï¼š</p>

<ol>
  <li>
    <p>åˆ›å»ºHandler</p>
  </li>
  <li>
    <p>åŸºäºHandleråˆ›å»ºProcessor</p>
  </li>
  <li>
    <p>åˆ›å»ºTransportï¼ˆé€šä¿¡æ–¹å¼ï¼‰</p>
  </li>
  <li>
    <p>åˆ›å»ºProtocolæ–¹å¼ï¼ˆè®¾å®šä¼ è¾“æ ¼å¼ï¼‰</p>
  </li>
  <li>
    <p>åŸºäºProcessor, Transportå’ŒProtocolåˆ›å»ºServer</p>
  </li>
  <li>
    <p>è¿è¡ŒServer</p>
  </li>
</ol>

<p>å®¢æˆ·ç«¯ç¼–å†™çš„ä¸€èˆ¬æ­¥éª¤ï¼š</p>

<ol>
  <li>
    <p>åˆ›å»ºTransport</p>
  </li>
  <li>
    <p>åˆ›å»ºProtocolæ–¹å¼</p>
  </li>
  <li>
    <p>åŸºäºTransportå’ŒProtocolåˆ›å»ºClient</p>
  </li>
  <li>
    <p>è¿è¡ŒClientçš„æ–¹æ³•</p>
  </li>
</ol>

<p>ç»“æ„ä½“åŸŸæ ‡è¯†å”¯ä¸€ï¼Œå¯ä»¥ä¸è¿ç»­ï¼Œå¿…é¡»ä¸ºæ­£æ•´æ•°ï¼Œå¦åˆ™æŠ¥é”™
Nonpositive value (0) not allowed as a field key.</p>
:ET