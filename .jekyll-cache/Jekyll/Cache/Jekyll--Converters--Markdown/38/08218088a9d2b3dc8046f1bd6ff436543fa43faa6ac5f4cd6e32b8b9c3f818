I"Ü#<p>Goçš„ç¼–è¯‘æ–¹å¼æ˜¯é™æ€ç¼–è¯‘ï¼ŒæŠŠruntimeç›´æ¥ç¼–è¯‘åˆ°æœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶é‡Œã€‚é¦–å…ˆæˆ‘ä»¬æŠŠä»£ç è€ƒè¿‡æ¥ï¼Œç„¶åç¼–è¯‘å‡º go è¿™ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ å‡ºæ¥ã€‚</p>

<p>ç¼–å†™ä»¥ä¸‹ä»£ç ï¼Œç„¶åç”¨æˆ‘ä»¬è‡ªå·±ç¼–è¯‘å‡ºæ¥çš„ go æ¥ç¼–è¯‘å‡ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ã€‚æ³¨æ„è¦å¸¦è°ƒè¯•ä¿¡æ¯å¹¶ä¸”ç¦æ­¢ä¼˜åŒ–çš„ï¼Œè¦ä¸ç„¶ä¸æ–¹ä¾¿çœ‹ã€‚</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
)</p>

<p>func main() {
    fmt.Println(â€œhello world!â€)
}
$ ../bin/go build -gcflags â€œ-N -lâ€ -o test_demo1 demo1.go
$ gdb test_demo1
(gdb) source /home/jiajun/Code/go/src/runtime/runtime-gdb.py
Loading Go Runtime support.
(gdb) info files
Symbols from â€œ/home/jiajun/Code/go/analysis/test_demo1â€.
Local exec file:
    `/home/jiajun/Code/go/analysis/test_demo1â€™, file type elf64-x86-64.
    Entry point: 0x44fa90
    0x0000000000401000 - 0x0000000000482608 is .text
    0x0000000000483000 - 0x00000000004c4e3f is .rodata
    0x00000000004c4f60 - 0x00000000004c5ac0 is .typelink
    0x00000000004c5ac0 - 0x00000000004c5b00 is .itablink
    0x00000000004c5b00 - 0x00000000004c5b00 is .gosymtab
    0x00000000004c5b00 - 0x0000000000514042 is .gopclntab
    0x0000000000515000 - 0x0000000000521bdc is .noptrdata
    0x0000000000521be0 - 0x00000000005286f0 is .data
    0x0000000000528700 - 0x0000000000544d88 is .bss
    0x0000000000544da0 - 0x00000000005474b8 is .noptrbss
    0x0000000000400f9c - 0x0000000000401000 is .note.go.buildid
(gdb) b *0x44fa90
Breakpoint 1 at 0x44fa90: file /home/jiajun/Code/go/src/runtime/rt0_linux_amd64.s, line 8.
ç„¶åå°±è·³åˆ° rt0_linux_amd64.s çœ‹ã€‚è™½ç„¶æ²¡æœ‰ç³»ç»Ÿçš„å­¦æ±‡ç¼–ï¼Œä½†æ˜¯è¾¹çœ‹è¾¹çŒœè¿˜æ˜¯å¯ä»¥ç»§ç»­çœ‹ä¸‹å»çš„ã€‚</p>

<p>TEXT _rt0_amd64_linux(SB),NOSPLIT,$-8
    JMP _rt0_amd64(SB)
ç„¶åå‘ç° _rt0_amd64 ç»§ç»­ä¸ä¸‹å»äº†ã€‚äºæ˜¯ï¼š</p>

<p>(gdb) b _rt0_amd64
Breakpoint 2 at 0x44c2b0: file /home/jiajun/Code/go/src/runtime/asm_amd64.s, line 15.
å‘ç°è·³åˆ°äº† rt0_go ï¼Œä¸è¿‡gdbç›´æ¥æ‰“æ–­ç‚¹å‘ç°æ‰“ä¸å‡ºæ¥ï¼Œäºæ˜¯å°±åœ¨åŒä¸€ä¸ªæ–‡ä»¶é‡Œå°è¯•æœç´¢ã€‚ å‘ç°åœ¨ï¼š https://github.com/jiajunhuang/go/blob/67a58c5a2401e89fd4f688e8f70fd3be9506cea5/src/runtime/asm_amd64.s#L87</p>

<p>ç»§ç»­è·Ÿè¸ªï¼Œå‘ç°æœ‰æ ‡ç­¾ï¼Œæœ€ååˆ°äº† ok è¿™ä¸ªæ ‡ç­¾ã€‚
(gdb) b runtime.g0
Function â€œruntime.g0â€ not defined.
Make breakpoint pending on future shared library load? (y or [n]) n
(gdb) b runtime.m0
Function â€œruntime.m0â€ not defined.
Make breakpoint pending on future shared library load? (y or [n]) n
(gdb) b runtime.check
Breakpoint 3 at 0x434890: file /home/jiajun/Code/go/src/runtime/runtime1.go, line 141.
(gdb) b runtime.args
Breakpoint 4 at 0x434340: file /home/jiajun/Code/go/src/runtime/runtime1.go, line 65.
(gdb) b runtime.osinit
Breakpoint 5 at 0x424750: file /home/jiajun/Code/go/src/runtime/os_linux.go, line 274.
(gdb) b runtime.schedinit
Breakpoint 6 at 0x428b30: file /home/jiajun/Code/go/src/runtime/proc.go, line 508.
(gdb) b runtime.mainPC
Function â€œruntime.mainPCâ€ not defined.
Make breakpoint pending on future shared library load? (y or [n]) n
(gdb) b runtime.main
Breakpoint 7 at 0x427980: file /home/jiajun/Code/go/src/runtime/proc.go, line 131.
(gdb) b runtime.newproc
Breakpoint 8 at 0x42f540: file /home/jiajun/Code/go/src/runtime/proc.go, line 3321.
(gdb) b runtime.mstart
Breakpoint 9 at 0x42a920: file /home/jiajun/Code/go/src/runtime/proc.go, line 1208.
å› æ­¤å‡½æ•°è°ƒç”¨é“¾æ˜¯ï¼š</p>

<p>runtime.check -&gt; runtime.args -&gt; runtime.osinit -&gt; runtime.schedinit -&gt; runtime.newproc</p>

<p>æœ€åä¸€æ­¥é‡Œçš„ runtime.newproc ä¹‹å‰æœ‰æŠŠ runtime.mainPC å‹æ ˆã€‚</p>

<!-- more -->
<p>https://www.codercto.com/a/38162.html
https://github.com/jiajunhuang/go
https://github.com/jiajunhuang/go</p>

<p>OVQ    $runtimeÂ·mainPC(SB), AX     // entry</p>

<p>// ç„¶åå†ä¸‹é¢å°±æœ‰ï¼š
DATA    runtimeÂ·mainPC+0(SB)/8,$runtimeÂ·main(SB)
æ‰€ä»¥åº”è¯¥æ˜¯ runtime.mainPC ä½œä¸ºå…¥å£ç‚¹ï¼Œç”± runtime.newproc æ¥æ‰§è¡Œè¿›å…¥ã€‚</p>

<p>éœ€è¦æå‰æŠŠæˆ‘è¯»åˆ°çš„çŸ¥è¯†å‰§é€ï¼Œæ–¹ä¾¿è¯»è€…ç†è§£ã€‚</p>

<p>Goçš„runtimeä¸­ï¼ŒMæ˜¯ Machine ï¼Œä»£è¡¨æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹
Pæ˜¯ Processor ï¼Œæ„æ€æ˜¯é€»è¾‘å¤„ç†å™¨ï¼Œåœ¨æœ€åˆçš„ç‰ˆæœ¬é‡Œæ˜¯æ²¡æœ‰Pçš„
Gæ˜¯ Goroutine ã€‚æ˜¯Goä¸­æ‰§è¡Œä»»åŠ¡çš„å•å…ƒï¼Œä¹Ÿæ˜¯coroutineä¸­çš„æœ€å°ä¸ªä½“ã€‚
åœ¨æœ€åˆçš„ç‰ˆæœ¬é‡Œæ²¡æœ‰Pï¼Œæ‰€ä»¥ M å’Œ G æ˜¯ M:Nã€‚å†å²åŸå› ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œä¸è¿‡æˆ‘çŒœæµ‹å¼•å…¥Pçš„åŸå› æ˜¯ï¼Œå½“Mæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è€…cgoä»£ç  è€Œé˜»å¡æ—¶ï¼Œå¦‚æœæ²¡æœ‰Pçš„å­˜åœ¨ï¼Œé‚£ä¹ˆè¯¥Mä¸Šçš„æ‰€æœ‰Gå°±æ— æ³•æ‰§è¡Œã€‚è€Œå¼•å…¥Pä¹‹åï¼Œå¯ä»¥æŠŠè¯¥Mä¸Šçš„Pæ‘˜æ‰ï¼Œæ”¾åˆ°åˆ«çš„Mä¸Šæ‰§è¡Œã€‚
coroutineåˆç§°å¾®çº¿ç¨‹ï¼Œåç¨‹ï¼Œçº¤ç¨‹ç­‰ã€‚åŸå› æ˜¯ï¼Œçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿè°ƒåº¦çš„æœ€å°å•ä½ï¼Œè€Œcoroutineåˆ™æ˜¯ç”¨æˆ·æ€çš„ â€œçº¿ç¨‹â€ã€‚çº¿ç¨‹çš„ åˆ›å»ºï¼Œé”€æ¯ï¼Œåˆ‡æ¢ä»£ä»·éå¸¸çš„é«˜ã€‚é€šè¿‡çº¿ç¨‹æ± æ— æ³•è§£å†³c10ké—®é¢˜ï¼Œè€Œ I/Oå¤šè·¯å¤ç”¨+å›è°ƒçš„æ–¹å¼å†™èµ·æ¥åˆæ¯”è¾ƒåäººç±»ï¼Œæ‰€ä»¥æœ‰åç¨‹ è¿™ä¹ˆä¸€ä¸ªä¸œè¥¿ã€‚åœ¨ç”¨æˆ·æ€ï¼Œä»¥åŒæ­¥çš„æ–¹å¼å†™å¼‚æ­¥ã€‚é€šè¿‡æŸäº›å…³é”®å­—ä¸»åŠ¨è®©å‡ºæ‰§è¡Œæƒé™ï¼Œè€Œåç­‰åˆ° I/O äº‹ä»¶å‡†å¤‡å¥½æ—¶ï¼Œå†åˆ‡æ¢å›æ¥ã€‚</p>

<p>ä¾‹å¦‚ Python ä¸­çš„ Tornado å°±é€šè¿‡yield+I/Oå¤šè·¯å¤ç”¨å›è°ƒå®ç°äº†åç¨‹ã€‚gevnetåˆ™æ›´é»‘ä¸€ç‚¹ï¼Œç›´æ¥åˆ©ç”¨Pythonå¯¼å…¥çš„æœºåˆ¶æŠŠæ ‡å‡†åº“çš„ ä»£ç patchã€‚ AsyncIO å…¶å®å·®ä¸å¤šã€‚ä¸è¿‡ Tornado å’Œ AsyncIO çš„å¼‚æ­¥ä»£ç éƒ½å…·æœ‰ä¼ æŸ“æ€§ï¼Œè¯´çš„æ˜¯ä¾‹å¦‚ @gen.coroutine è¿™ç§ ç©æ„å„¿ã€‚</p>

<p>æ‰€ä»¥æœ‰äº†Goè¿™ç§ï¼Œåœ¨è¯­è¨€å±‚é¢å®ç°å¼‚æ­¥çš„æ–¹å¼(geventå…¶å®ä¸æ­¤ååˆ†ç±»ä¼¼)ã€‚</p>

<p>newproc æ‰§è¡Œ systemstack å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯åœ¨ç³»ç»Ÿæ ˆä¸­è°ƒç”¨ç»™å®šçš„å‡½æ•° fnã€‚çœ‹ä»–çš„æ³¨é‡Šï¼š
// systemstack runs fn on a system stack.
// If systemstack is called from the per-OS-thread (g0) stack, or
// if systemstack is called from the signal handling (gsignal) stack,
// systemstack calls fn directly and returns.
// Otherwise, systemstack is being called from the limited stack
// of an ordinary goroutine. In this case, systemstack switches
// to the per-OS-thread stack, calls fn, and switches back.
// It is common to use a func literal as the argument, in order
// to share inputs and outputs with the code around the call
// to system stack:
//
//  â€¦ set up y â€¦
//  systemstack(func() {
//      x = bigcall(y)
//  })
//  â€¦ use x â€¦
//
// systemstackå¦‚æœæ˜¯ç”±g0è°ƒç”¨ï¼Œæˆ–è€…æ”¶åˆ°ä¿¡å·è€Œè°ƒç”¨ï¼Œå°±ä¼šè°ƒç”¨fnç„¶åè¿”å›ã€‚
// å¦åˆ™ï¼Œsystemstackåˆ‡æ¢åˆ° per-OS-threadæ ˆæ‰§è¡Œå®Œfnä¹‹åï¼Œåˆåˆ‡å›å»
//go:noescape
func systemstack(fn func())
è€Œ newproc ç»™ systemstack ä¼ çš„å‚æ•°ä¾¿æ˜¯ newproc1 ã€‚è€Œ newproc1 åšçš„äº‹æƒ…å°±æ˜¯æ–°å»ºä¸€ä¸ªGoroutineä¸¢åˆ°é˜Ÿåˆ—é‡Œã€‚è€Œæ‰§è¡Œçš„fn å°±æ˜¯ runtime.mainPC ï¼Œå°±æ˜¯ runtime.main</p>

<p>æ¥ä¸‹æ¥è¯»åˆ° runtime.main ï¼Œæ²¡å¤šè¿œå°±æ‰§è¡Œäº†ä¸€ä¸ª
151     systemstack(func() {                                                                       <br />
152         newm(sysmon, nil)                                                                      <br />
153     })
è¿™ä¸ªsysmonæ˜¯ system monitor ï¼Œè´Ÿè´£æŠ¢å ï¼Œæ£€æŸ¥ç½‘ç»œäº‹ä»¶ç­‰ã€‚</p>

<p>ç„¶åæ‰§è¡Œ</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">runtime_init</code>ã€‚è¿™ä¸ªæ˜¯åŠ¨æ€ç”Ÿæˆçš„ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">gcenable</code> å¯åŠ¨gc</li>
  <li><code class="language-plaintext highlighter-rouge">main_init</code> åŠ¨æ€ç”Ÿæˆçš„ã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">main_main</code> å°±æ˜¯æˆ‘ä»¬ <code class="language-plaintext highlighter-rouge">main</code> åŒ…é‡Œçš„mainå‡½æ•°äº†ã€‚</li>
  <li>é€šè¿‡forå¾ªç¯ç¡®ä¿ <code class="language-plaintext highlighter-rouge">&amp;runningPanicDefers</code> ä¸º0æ‰é€€å‡ºã€‚</li>
  <li><code class="language-plaintext highlighter-rouge">exit</code> é€€å‡ºã€‚
_init çš„å‡½æ•°éƒ½æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œé¡ºåºä¸ import é¡ºåºä¸ä¸€å®šä¸€è‡´ï¼Œä½†æ˜¯è¢«ä¾èµ–çš„åŒ…çš„initå®Œäº†æ‰ä¼šinitå½“å‰æ–‡ä»¶ã€‚</li>
</ul>

<p>ä¼¼ä¹åˆ°è¿™é‡Œï¼Œæ•´ä¸ªå¯åŠ¨æµç¨‹å°±çœ‹å®Œäº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è·³åˆ°å…¶ä¸­çš„ç»†èŠ‚å»çœ‹ã€‚</p>

<p>tcmalloc. tcmallocæ˜¯ thread cache malloc çš„ç®€å†™ï¼Œçœ‹å®Œä¹‹åæš—è‡ªè§‰å¾—ï¼Œå¤§ç¥å°±æ˜¯å¤§ç¥ã€‚ã€‚ã€‚è®¾è®¡éå¸¸æ¼‚äº®ã€‚</p>

<p>https://github.com/gperftools/gperftools
https://en.wikipedia.org/wiki/C_dynamic_memory_allocation#Thread-caching_malloc_(tcmalloc)
schedinit é‡Œæœ‰æ•´ä¸ªè°ƒåº¦å™¨åˆå§‹åŒ–çš„ä»£ç ï¼š</p>

<p>https://github.com/jiajunhuang/go/blob/67a58c5a2401e89fd4f688e8f70fd3be9506cea5/src/runtime/proc.go#L508</p>

<p>findrunnable ä¸­å®ç°äº†work stealing:</p>

<p>æ£€æŸ¥æ˜¯å¦å¤„äºGCæ€
æ£€æŸ¥æœ¬åœ°æœ‰æ²¡æœ‰å¯æ‰§è¡Œçš„G
æ£€æŸ¥å…¨å±€é˜Ÿåˆ—æœ‰æ²¡æœ‰å¯æ‰§è¡Œçš„G
æ£€æŸ¥ç½‘ç»œI/Oæœ‰æ²¡æœ‰å¯ä»¥æ¢å¤æ‰§è¡Œçš„G
å»åˆ«çš„é˜Ÿåˆ—é‡Œå·
è¿˜æ˜¯æ²¡æœ‰ï¼Œå°±æŠŠè‡ªå·±æŒ‚èµ·
runtimeé‡Œæœ€é‡è¦çš„å‡ ä¸ªæ–‡ä»¶ï¼š</p>

<p>runtime1.go åˆå§‹åŒ–æ—¶çš„æ£€æµ‹
runtime2.go åˆå§‹åŒ–ç­‰
proc.go è°ƒåº¦ï¼Œwork stealingç­‰
mheap.go å’Œ malloc.go å†…å­˜åˆ†é…ç›¸å…³å®ç°
å¦‚ä½•å®ç°åç¨‹ï¼Ÿå¯ä»¥çœ‹çœ‹æˆ‘çš„è¿™ä¸ªé¡¹ç›®ï¼š</p>

<p>https://github.com/jiajunhuang/storm</p>

<p>https://medium.com/@cep21/using-go-1-10-new-trace-features-to-debug-an-integration-test-1dc39e4e812d</p>

<p>https://zhuanlan.zhihu.com/p/44851211</p>

:ET