I"™<p>åœ¨PHPæ‰©å±•é‡Œæ˜¯é€šè¿‡ call_user_function_ex å‡½æ•°æ¥è°ƒç”¨ç”¨æˆ·ç©ºé—´çš„å‡½æ•°çš„ã€‚</p>

<p>å®šä¹‰
å®ƒçš„å®šä¹‰åœ¨ Zend/zend_API.h :</p>

<p>#define call_user_function_ex(function_table, object, function_name, retval_ptr, param_count, params, no_separation, symbol_table)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_call_user_function_ex(object, function_name, retval_ptr, param_count, params, no_separation) é€šè¿‡å®å®šä¹‰æ›¿æ¢ä¸º_call_user_function_ex,å…¶ä¸­å‚æ•° function_table è¢«ç§»é™¤äº†ï¼Œå®ƒä¹‹æ‰€ä»¥åœ¨APIæ‰å­˜åœ¨å¤§æ¦‚æ˜¯ä¸ºäº†å…¼å®¹ä»¥å‰çš„å†™æ³• &lt;!-- more --&gt;
</code></pre></div></div>

<p>å‡½æ•°çš„çœŸæ­£å®šä¹‰æ˜¯ï¼š</p>

<p>ZEND_API int _call_user_function_ex(
    zval *object, 
    zval *function_name, 
    zval *retval_ptr, 
    uint32_t param_count, 
    zval params[], 
    int no_separation);
å‚æ•°åˆ†æï¼š</p>

<p>zval *object:è¿™ä¸ªæ˜¯ç”¨æ¥æˆ‘ä»¬è°ƒç”¨ç±»é‡Œçš„æŸä¸ªæ–¹æ³•çš„å¯¹è±¡ã€‚</p>

<p>zval *function_name:è¦è°ƒç”¨çš„å‡½æ•°çš„åå­—ã€‚</p>

<p>zval *retval_ptrï¼šæ”¶é›†å›è°ƒå‡½æ•°çš„è¿”å›å€¼ã€‚</p>

<p>uint32_t param_countï¼šå›è°ƒå‡½æ•°éœ€è¦ä¼ é€’å‚æ•°çš„ä¸ªæ•°ã€‚</p>

<p>zval params[]: å‚æ•°åˆ—è¡¨ã€‚</p>

<p>int no_separationï¼šæ˜¯å¦å¯¹zvalè¿›è¡Œåˆ†ç¦»ï¼Œå¦‚æœè®¾ä¸º1åˆ™ç›´æ¥ä¼šå‡ºé”™ï¼Œåˆ†ç¦»çš„ä½œç”¨æ˜¯ä¸ºäº†ä¼˜åŒ–ç©ºé—´ã€‚</p>

<p>å›è°ƒåŠŸèƒ½çš„å®ç°
PHP_FUNCTION(hello_callback)
{
    zval *function_name;
    zval retval;
    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, â€œzâ€, &amp;function_name) == FAILURE) {
        return;
    }
    if (Z_TYPE_P(function_name) != IS_STRING) {
        php_printf(â€œFunction require string argumnets!â€);
        return;
    }
    //TSRMLS_FETCH();
    if (call_user_function_ex(EG(function_table), NULL, function_name, &amp;retval, 0, NULL, 0, NULL TSRMLS_CC) != SUCCESS) {
        php_printf(â€œFunction call failed!â€);
        return;
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*return_value = retval;
zval_copy_ctor(return_value);
zval_ptr_dtor(&amp;retval);
</code></pre></div></div>

<p>}
zval_copy_ctor()åŸå§‹ï¼ˆzvalï¼‰çš„å†…å®¹æ‹·è´ç»™å®ƒã€‚zval_ptr_dtor()é‡Šæ”¾ç©ºé—´ã€‚return_valueä¸æ˜¯ä¸€ä¸ªå‡½æ•°å¤–çš„å˜é‡ï¼Œå®ƒçš„ç”±å‡½æ•°å£°æ˜é‡Œçš„å˜é‡ã€‚PHP_FUNCTION(hello_callback)è¿™ä¸ªå£°æ˜æ˜¯ç®€å†™ï¼Œæœ€ç»ˆä¼šè¢«é¢„å¤„ç†å®æ›¿æ¢ä¸ºï¼š</p>

<p>void zif_hello_callback(zend_execute_data *execute_data, zval *return_value)
return_valueå˜é‡å…¶å®ä¹Ÿå°±æ˜¯æœ€ç»ˆè¿”å›ç»™è°ƒç”¨è„šæœ¬çš„ï¼ŒRETURN_STR(s) ç­‰è¿”å›å‡½æ•°æœ€ç»ˆä¹Ÿéƒ½æ˜¯å®æ›¿æ¢ä¸ºå¯¹è¯¥å˜é‡çš„æ“ä½œã€‚</p>

<p>æµ‹è¯•è„šæœ¬ï¼š</p>

<p>&lt;?php
function fun1() {
    for ($i = 0; $i &lt; 5; $i++) {
        echo â€˜fun1:â€™.$i.â€\nâ€;
    }
    return â€˜call endâ€™;
}</p>

<p>echo hello_callback(â€˜fun1â€™);
ä¸€ä¸ªå¹¶è¡Œæ‰©å±•
æ—©æœŸçš„phpä¸æ”¯æŒå¤šè¿›ç¨‹å¤šçº¿ç¨‹çš„ï¼Œç°åœ¨éšç€å‘å±•æœ‰å¾ˆå¤šæ‰©å±•ä¸æ–­å®Œå–„å®ƒï¼Œè¯¸å¦‚pthread,swooleç­‰ï¼Œä¸ä»…èƒ½å¤šçº¿ç¨‹ï¼Œè€Œä¸”èƒ½å®ç°å¼‚æ­¥ã€‚</p>

<p>åˆ©ç”¨cè¯­è¨€å¤šçº¿ç¨‹pthreadåº“æ¥å®ç°ä¸€ä¸ªç®€å•çš„å¹¶è¡Œæ‰©å±•ã€‚</p>

<p>å…ˆå£°æ˜æˆ‘ä»¬ä¸€ä¼šç”¨åˆ°çš„ç»“æ„ï¼š</p>

<p>struct myarg
{
    zval *fun;
    zval ret;
};
çº¿ç¨‹å‡½æ•°ï¼š</p>

<p>static void my_thread(struct myarg *arg) {
    zval *fun = arg-&gt;fun;
    zval ret = arg-&gt;ret;
    if (call_user_function_ex(EG(function_table), NULL, fun, &amp;ret, 0, NULL, 0, NULL TSRMLS_CC) != SUCCESS) {
        return;
    }
}
å‡½æ•°çš„å®ç°ï¼š</p>

<p>PHP_FUNCTION(hello_thread)
{
    pthread_t tid;
    zval <em>fun1, *fun2;
    zval ret1, ret2;
    struct myarg arg;
    int ret;
    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, â€œzzâ€, &amp;fun1, &amp;fun2) == FAILURE) {
        return;
    }
    arg.fun = fun1;
    arg.ret = ret1;
    ret = pthread_create(&amp;tid, NULL, (void</em>)my_thread, (void*)&amp;arg);
    if(ret != 0) {
        php_printf(â€œThread Create Error\nâ€);
        exit(0);
    }
    if (call_user_function_ex(EG(function_table), NULL, fun2, &amp;ret2, 0, NULL, 0, NULL TSRMLS_CC) != SUCCESS) {
        return;
    }
    pthread_join(tid, NULL);
    RETURN_NULL();</p>

<p>}
æµ‹è¯•è„šæœ¬ï¼š</p>

<p>&lt;?php
function fun1() {
    for ($i = 0; $i &lt; 5; $i++) {
        echo â€˜fun1:â€™.$i.â€™\nâ€™;
    }
}</p>

<p>function fun2() {
    for ($i = 0; $i &lt; 5; $i++) {
        echo â€˜fun2:â€™.$i.â€™\nâ€™;
    }
}</p>

<p>hello_thread(â€˜fun1â€™, â€˜fun2â€™);
echo â€˜after å¤šå¹¶å‘â€™;
è¾“å‡ºï¼š</p>

<p>20161130143035.png</p>

<p>ä¸¤æ¬¡çš„è¾“å‡ºç»“æœä¸ä¸€æ ·ï¼Œå¹¶ä¸”echo â€˜after å¤šå¹¶å‘â€™;æ˜¯åœ¨ä¸¤ä¸ªå‡½æ•°éƒ½è¿è¡Œå®Œåæ‰æ‰§è¡Œçš„ã€‚</p>

<p>https://segmentfault.com/a/1190000007648157
https://blog.csdn.net/xing_____/article/details/78481547</p>
:ET