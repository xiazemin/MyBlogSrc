I"«<p>æ¯”å¦‚ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå¦‚æœæ²¡æœ‰åŠ ä¸Šé”ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªæ¯”è¾ƒåºå¤§çš„é¡¹ç›®ä¸‹æ¥ï¼Œå°±æ ¹æœ¬ä¸çŸ¥é“è¿™ä¸ªå˜é‡æ˜¯ä¸æ˜¯ä¼šå¼•èµ·å¤šä¸ªgoroutineç«äº‰ã€‚
<!-- more -->
package main</p>

<p>import(
    â€œtimeâ€
    â€œfmtâ€
    â€œmath/randâ€
)</p>

<p>func main() {
    start := time.Now()
    var t *time.Timer
    t = time.AfterFunc(randomDuration(), func() {
        fmt.Println(time.Now().Sub(start))
        t.Reset(randomDuration())
    })
    time.Sleep(5 * time.Second)
}</p>

<p>func randomDuration() time.Duration {
    return time.Duration(rand.Int63n(1e9))
}</p>

<p>time.AfterFuncæ˜¯ä¼šå¦å¤–å¯åŠ¨ä¸€ä¸ªgoroutineæ¥è¿›è¡Œè®¡æ—¶å’Œæ‰§è¡Œfunc()ã€‚
ç”±äºfuncä¸­æœ‰å¯¹t(Timer)è¿›è¡Œæ“ä½œ(t.Reset)ï¼Œè€Œä¸»goroutineä¹Ÿæœ‰å¯¹tè¿›è¡Œæ“ä½œ(t=time.After)ã€‚
è¿™ä¸ªæ—¶å€™ï¼Œå…¶å®æœ‰å¯èƒ½ä¼šé€ æˆä¸¤ä¸ªgoroutineå¯¹åŒä¸€ä¸ªå˜é‡è¿›è¡Œç«äº‰çš„æƒ…å†µã€‚</p>

<p>package main</p>

<p>import(
    â€œtimeâ€
    â€œfmtâ€
)</p>

<p>func main() {
    a := 1
    go func(){
        a = 2
    }()
    a = 3
    fmt.Println(â€œa is â€œ, a)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>time.Sleep(2 * time.Second) }
</code></pre></div></div>

<p>è¿™é‡Œçš„go funcè§¦å‘çš„goroutineä¼šä¿®æ”¹aã€‚
ä¸»goroutine ä¹Ÿä¼šå¯¹aè¿›è¡Œä¿®æ”¹ã€‚ä½†æ˜¯æˆ‘ä»¬å¦‚æœåªgo runè¿è¡Œï¼Œæˆ‘ä»¬å¯èƒ½å¾€å¾€ä¸ä¼šå‘ç°ä»€ä¹ˆå¤ªå¤§çš„é—®é¢˜ã€‚</p>

<p>golangåœ¨1.1ä¹‹åå¼•å…¥äº†ç«äº‰æ£€æµ‹çš„æ¦‚å¿µã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨go run -race æˆ–è€… go build -race æ¥è¿›è¡Œç«äº‰æ£€æµ‹ã€‚
golangè¯­è¨€å†…éƒ¨å¤§æ¦‚çš„å®ç°å°±æ˜¯åŒæ—¶å¼€å¯å¤šä¸ªgoroutineæ‰§è¡ŒåŒä¸€ä¸ªå‘½ä»¤ï¼Œå¹¶ä¸”çºªå½•æ¯ä¸ªå˜é‡çš„çŠ¶æ€ã€‚</p>

<p>ç”¨raceæ¥æ£€æµ‹ä¸Šé¢çš„ç¨‹åºï¼Œæˆ‘ä»¬å°±ä¼šçœ‹åˆ°è¾“å‡ºï¼š</p>

<p>runtime  go run -race race1.go
a is  3
==================
WARNING: DATA RACE
Write by goroutine 5:
  main.funcÂ·001()
      /Users/yejianfeng/Documents/workspace/go/src/runtime/race1.go:11 +0x3a</p>

<p>Previous write by main goroutine:
  main.main()
      /Users/yejianfeng/Documents/workspace/go/src/runtime/race1.go:13 +0xe7</p>

<p>Goroutine 5 (running) created at:
  main.main()
      /Users/yejianfeng/Documents/workspace/go/src/runtime/race1.go:12 +0xd7
==================
Found 1 data race(s)
exit status 66</p>

<p>è¿™ä¸ªå‘½ä»¤è¾“å‡ºäº†Warningï¼Œå‘Šè¯‰æˆ‘ä»¬ï¼Œgoroutine5è¿è¡Œåˆ°ç¬¬11è¡Œå’Œmain goroutineè¿è¡Œåˆ°13è¡Œçš„æ—¶å€™è§¦å‘ç«äº‰äº†ã€‚
è€Œä¸”goroutine5æ˜¯åœ¨ç¬¬12è¡Œçš„æ—¶å€™äº§ç”Ÿçš„ã€‚</p>

<p>è¿™æ ·æˆ‘ä»¬æ ¹æ®åˆ†æè¿™ä¸ªæç¤ºå°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªç¨‹åºåœ¨å“ªä¸ªåœ°æ–¹å†™çš„æœ‰é—®é¢˜äº†ã€‚</p>

<p>å½“ç„¶è¿™ä¸ªå‚æ•°ä¼šå¼•å‘CPUå’Œå†…å­˜çš„ä½¿ç”¨å¢åŠ ï¼Œæ‰€ä»¥åŸºæœ¬æ˜¯åœ¨æµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œä¸æ˜¯åœ¨æ­£å¼ç¯å¢ƒå¼€å¯ã€‚</p>

<p>$  go run -race main.go 
a is  3
==================
WARNING: DATA RACE
Write at 0x00c420018070 by goroutine 6:
  main.main.func1()
      /Users/didi/goLang/src/github.com/xiazemin/race/main.go:10 +0x3b</p>

<p>Previous write at 0x00c420018070 by main goroutine:
  main.main()
      /Users/didi/goLang/src/github.com/xiazemin/race/main.go:12 +0x8e</p>

<p>Goroutine 6 (running) created at:
  main.main()
      /Users/didi/goLang/src/github.com/xiazemin/race/main.go:9 +0x7d
==================
Found 1 data race(s)
exit status 66</p>

:ET