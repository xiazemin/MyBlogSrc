I"òo<p>å‘½åç©ºé—´çš„æœ¬è´¨å°±æ˜¯æŒ‡ï¼šä¸€ç§åœ¨ç©ºé—´ä¸Šéš”ç¦»çš„æ¦‚å¿µï¼Œå½“ä¸‹ç››è¡Œçš„è®¸å¤šå®¹å™¨è™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆå…¸å‹ä»£è¡¨å¦‚LXCã€Dockerï¼‰å°±æ˜¯åŸºäºlinuxå‘½åç©ºé—´çš„æ¦‚å¿µè€Œæ¥çš„ã€‚
ä¸»è¦æ˜¯ä¸‰ä¸ªç³»ç»Ÿè°ƒç”¨</p>

<p>clone() â€“ å®ç°çº¿ç¨‹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶å¯ä»¥é€šè¿‡è®¾è®¡ä¸Šè¿°å‚æ•°è¾¾åˆ°éš”ç¦»ã€‚
unshare() â€“ ä½¿æŸè¿›ç¨‹è„±ç¦»æŸä¸ªnamespace
setns() â€“ æŠŠæŸè¿›ç¨‹åŠ å…¥åˆ°æŸä¸ªnamespace
<!-- more -->
é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä¸€ä¸ªæœ€ç®€å•çš„clone()ç³»ç»Ÿè°ƒç”¨çš„ç¤ºä¾‹ï¼Œ(åé¢ï¼Œæˆ‘ä»¬çš„ç¨‹åºéƒ½ä¼šåŸºäºè¿™ä¸ªç¨‹åºåšä¿®æ”¹)ï¼š</p>

<p>æ–‡ä»¶å:clone.c</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    NULL
};</p>

<p>int container_main(void* arg)
{
    printf(â€œContainer - inside the container!\nâ€);
    /* ç›´æ¥æ‰§è¡Œä¸€ä¸ªshellï¼Œä»¥ä¾¿æˆ‘ä»¬è§‚å¯Ÿè¿™ä¸ªè¿›ç¨‹ç©ºé—´é‡Œçš„èµ„æºæ˜¯å¦è¢«éš”ç¦»äº† */
    execv(container_args[0], container_args);
    printf(â€œSomethingâ€™s wrong!\nâ€);
    return 1;
}</p>

<p>int main()
{
    printf(â€œParent - start a container!\nâ€);
    /* è°ƒç”¨cloneå‡½æ•°ï¼Œå…¶ä¸­ä¼ å‡ºä¸€ä¸ªå‡½æ•°ï¼Œè¿˜æœ‰ä¸€ä¸ªæ ˆç©ºé—´çš„ï¼ˆä¸ºä»€ä¹ˆä¼ å°¾æŒ‡é’ˆï¼Œå› ä¸ºæ ˆæ˜¯åç€çš„ï¼‰ <em>/
    int container_pid = clone(container_main, container_stack+STACK_SIZE, SIGCHLD, NULL);
    /</em> ç­‰å¾…å­è¿›ç¨‹ç»“æŸ */
    waitpid(container_pid, NULL, 0);
    printf(â€œParent - container stopped!\nâ€);
    return 0;
}
å¤åˆ¶ä»£ç 
 æµ‹è¯•å¼€è¾Ÿä¸€ä¸ªæ–°çš„åç§°ç©ºé—´:</p>

<p>å¤åˆ¶ä»£ç 
[root@www ~]# gcc -o clone clone.c #ç¼–è¯‘clone.c
[root@www ~]# ./clone #æ‰§è¡Œç¼–è¯‘çš„ç»“æœ
Parent - start a container!
Container - inside the container!
[root@www ~]#         #è¿›å…¥äº†ä¸€éš”ç¦»çš„ç©ºé—´
[root@www ~]# exit    #é€€å‡ºè¯¥ç©ºé—´
exit
Parent - container stopped!
[root@www ~]#         #åˆå›åˆ°æœ€åˆçš„ç©ºé—´
å¤åˆ¶ä»£ç 
ä»ä¸Šé¢çš„ç¨‹åºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™å’ŒpthreadåŸºæœ¬ä¸Šæ˜¯ä¸€æ ·çš„ç©æ³•ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸Šé¢çš„ç¨‹åºï¼Œçˆ¶å­è¿›ç¨‹çš„è¿›ç¨‹ç©ºé—´æ˜¯æ²¡æœ‰ä»€ä¹ˆå·®åˆ«çš„ï¼Œçˆ¶è¿›ç¨‹èƒ½è®¿é—®åˆ°çš„å­è¿›ç¨‹ä¹Ÿèƒ½ã€‚</p>

<p>ä¸‹é¢ï¼Œ è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­çœ‹çœ‹ï¼ŒLinuxçš„Namespaceæ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>

<p>å› ä¸ºä¸‹è¿°æµ‹è¯•æ¶‰åŠåˆ°ç”¨æˆ·æƒé™é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬æ–°å»ºç”¨æˆ·egonï¼ˆæœ¬äººçš„è‹±æ–‡åï¼Œå“ˆå“ˆï¼‰ï¼Œå¹¶ä¸”èµ‹äºˆè¯¥ç”¨æˆ·sudoæƒé™</p>

<p>æ‰§è¡Œvisudoç„¶åæ–°å¢å¦‚ä¸‹å†…å®¹ï¼š 
egon    ALL=(ALL)     NOPASSWD:ALL
2.1 UTSå‘½åç©ºé—´ï¼ˆç³»ç»Ÿè°ƒç”¨CLONE_NEWUTSï¼‰
ä¸»è¦ç›®çš„æ˜¯ç‹¬ç«‹å‡ºä¸»æœºåå’Œç½‘ç»œä¿¡æ¯æœåŠ¡ï¼ˆNISï¼‰ã€‚</p>

<p>æ–‡ä»¶å:uts.c</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    NULL
};</p>

<p>/* ä¸utsæœ‰å…³çš„ä»£ç :æ­¤å¤„åªæ¼”ç¤ºä¸»æœºåçš„éš”ç¦» <em>/
int container_main(void</em> arg) 
{ 
    printf(â€œContainer - inside the container!\nâ€); 
    sethostname(â€œcontainerâ€,10); /* è®¾ç½®hostname */ 
    execv(container_args[0], container_args); 
    printf(â€œSomethingâ€™s wrong!\nâ€); 
    return 1; 
}</p>

<p>int main() 
{ 
    printf(â€œParent - start a container!\nâ€); 
    int container_pid = clone(container_main, container_stack+STACK_SIZE,<br />
            CLONE_NEWUTS | SIGCHLD, NULL); /*å¯ç”¨CLONE_NEWUTS Namespaceéš”ç¦» */ 
    waitpid(container_pid, NULL, 0); 
    printf(â€œParent - container stopped!\nâ€); 
    return 0; 
} 
å¤åˆ¶ä»£ç 
 æµ‹è¯•å¼€è¾Ÿä¸€ä¸ªæ–°çš„UTSåç§°ç©ºé—´/å®¹å™¨containerï¼ŒéªŒè¯ä¸»æœºåçš„éš”ç¦»æ€§:</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ gcc -o uts uts.c #ç¼–è¯‘utc.cå¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶uts
[egon@www ~]$ sudo ./uts #éœ€è¦rootæƒé™æ‰èƒ½å¼€è¾Ÿæ–°çš„container
Parent - start a container!
Container - inside the container!
[root@container egon]#      #è¿›å…¥ä¸€ä¸ªéš”ç¦»çš„ç©ºé—´ï¼Œå³ä¸€ä¸ªcontainer
[root@container egon]# hostname #æŸ¥çœ‹è¯¥ç©ºé—´ä¸‹çš„ä¸»æœºå
container
[root@container egon]# exit #é€€å‡ºè¯¥container
exit
Parent - container stopped!
[egon@www ~]$ hostname  #æŸ¥çœ‹æœ€åˆçš„ç©ºé—´ä¸‹çš„ä¸»æœºå
www.egon.org #å‘ç°ç¡®å®ä¸åˆšåˆšæˆ‘ä»¬å¼€è¾Ÿçš„containeræ˜¯ä¸åŒçš„ä¸»æœºåï¼ŒéªŒè¯äº†éš”ç¦»æ€§
[egon@www ~]$ 
å¤åˆ¶ä»£ç 
2.2 IPCå‘½åç©ºé—´ï¼ˆç³»ç»Ÿè°ƒç”¨CLONE_NEWIPCï¼‰
IPCå…¨ç§° Inter-Process Communicationï¼Œæ˜¯Unix/Linuxä¸‹è¿›ç¨‹é—´é€šä¿¡çš„ä¸€ç§æ–¹å¼ï¼ŒIPCæœ‰å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œä¸ºäº†éš”ç¦»ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æŠŠIPCç»™éš”ç¦»å¼€æ¥ï¼Œè¿™æ ·ï¼Œåªæœ‰åœ¨åŒä¸€ä¸ªNamespaceä¸‹çš„è¿›ç¨‹æ‰èƒ½ç›¸äº’é€šä¿¡ã€‚å¦‚æœä½ ç†Ÿæ‚‰IPCçš„åŸç†çš„è¯ï¼Œä½ ä¼šçŸ¥é“ï¼ŒIPCéœ€è¦æœ‰ä¸€ä¸ªå…¨å±€çš„IDï¼Œå³ç„¶æ˜¯å…¨å±€çš„ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€æˆ‘ä»¬çš„Namespaceéœ€è¦å¯¹è¿™ä¸ªIDéš”ç¦»ï¼Œä¸èƒ½è®©åˆ«çš„Namespaceçš„è¿›ç¨‹çœ‹åˆ°ã€‚</p>

<p>æ–‡ä»¶åï¼šipc.c</p>

<p>è¦å¯åŠ¨IPCéš”ç¦»ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è°ƒç”¨cloneæ—¶åŠ ä¸ŠCLONE_NEWIPCå‚æ•°å°±å¯ä»¥äº†ï¼ˆè§ä¸‹è¿°ä»£ç æ ‡çº¢çš„åœ°æ–¹ï¼‰</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    NULL
};</p>

<p>/* ä¸utsæœ‰å…³çš„ä»£ç :æ­¤å¤„åªæ¼”ç¤ºä¸»æœºåçš„éš”ç¦» <em>/
int container_main(void</em> arg) 
{ 
    printf(â€œContainer - inside the container!\nâ€); 
    sethostname(â€œcontainerâ€,10); /* è®¾ç½®hostname */ 
    execv(container_args[0], container_args); 
    printf(â€œSomethingâ€™s wrong!\nâ€); 
    return 1; 
}</p>

<p>int main() 
{ 
    printf(â€œParent - start a container!\nâ€); 
    int container_pid = clone(container_main, container_stack+STACK_SIZE,<br />
            CLONE_NEWUTS | CLONE_NEWIPC | SIGCHLD, NULL); /*æ–°å¢CLONE_NEWIPCå°±å¯ä»¥äº† */ 
    waitpid(container_pid, NULL, 0); 
    printf(â€œParent - container stopped!\nâ€); 
    return 0; 
} 
å¤åˆ¶ä»£ç 
é¢„å¤‡é˜¶æ®µï¼ˆåœ¨å…¨å±€æ–°å»ºIPCé˜Ÿåˆ—ï¼‰ï¼š</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªIPCçš„Queue(å¦‚ä¸‹æ‰€ç¤ºï¼Œå…¨å±€çš„Queue IDæ˜¯0)</p>

<p>ipcmkåˆ›å»ºé˜Ÿåˆ—</p>

<p>ipcrmåˆ é™¤é˜Ÿåˆ—</p>

<p>ipcsæŸ¥çœ‹é˜Ÿåˆ—</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ ipcs -q #æŸ¥çœ‹é˜Ÿåˆ—</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
[egon@www ~]$ ipcmk -Q #åœ¨å…¨å±€åˆ›å»ºä¸€ä¸ªipcçš„é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—idä¸º0
Message queue id: 0
[egon@www ~]$ ipcs -q #æŸ¥çœ‹åˆšåˆšæ–°å»ºçš„å…¨å±€çš„é˜Ÿåˆ—çš„ä¿¡æ¯</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0c076dce 0          egon       644        0            0    <br />
å¤åˆ¶ä»£ç 
æˆ‘ä»¬æš‚ä¸”ä¸è¿è¡Œç¼–è¯‘çš„CLONE_NEWIPCçš„ç¨‹åºipcï¼Œè®©æˆ‘ä»¬å…ˆè¿è¡Œä¹‹å‰ç¼–è¯‘çš„utsï¼Œå‘ç°åœ¨å­è¿›ç¨‹ä¸­è¿˜æ˜¯èƒ½çœ‹åˆ°è¿™ä¸ªå…¨å±€çš„IPC Queueã€‚</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ ipcs -q #æŸ¥çœ‹å…¨å±€çš„é˜Ÿåˆ—</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0c076dce 0          egon       644        0            0</p>

<p>[egon@www ~]$ sudo ./uts #è¿›å…¥æ–°çš„utså®¹å™¨
Parent - start a container!
Container - inside the container!
[root@container egon]# ipcs -q #åœ¨utså®¹å™¨ä¸‹å‘ç°ä»ç„¶èƒ½çœ‹åˆ°å…¨å±€çš„IPCé˜Ÿåˆ—ï¼Œè¯æ˜æ­¤æ—¶æ²¡æœ‰å®ç°IPCéš”ç¦»</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0c076dce 0          egon       644        0            0</p>

<p>[root@container egon]# exit #é€€å‡ºutså®¹å™¨
exit
Parent - container stopped!
[egon@www ~]$ 
å¤åˆ¶ä»£ç 
æµ‹è¯•å¼€è¾Ÿä¸€ä¸ªæ–°çš„IPCåç§°ç©ºé—´/å®¹å™¨containerï¼ŒéªŒè¯IPCçš„éš”ç¦»æ€§:</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ gcc -o ipc ipc.c #ç¼–è¯‘
[egon@www ~]$ ipcs -q #åœ¨å…¨å±€æŸ¥çœ‹ipcé˜Ÿåˆ—ï¼Œè‚¯å®šå¯ä»¥çœ‹åˆ°</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0c076dce 0          egon       644        0            0</p>

<p>[egon@www ~]$ sudo ./ipc #è¿›å…¥ipcå®¹å™¨
Parent - start a container!
Container - inside the container!
[root@container egon]# ipcs -q #åœ¨å®¹å™¨å†…æŸ¥çœ‹ipcé˜Ÿåˆ—ï¼Œå‘ç°æŸ¥çœ‹ä¸åˆ°å…¨å±€çš„ipcé˜Ÿåˆ—ï¼Œè‡ªå·±è¿™é‡Œçš„ipcé˜Ÿåˆ—ä¸ºç©ºï¼ŒéªŒè¯äº†ipcçš„éš”ç¦»æ€§
                               #åŒç†å¦‚æœåœ¨è¯¥å®¹å™¨å†…ç”¨ipcmk -Qåˆ›å»ºçš„é˜Ÿåˆ—ï¼Œåœ¨å…¨å±€ä¹Ÿæ— æ³•çœ‹åˆ°ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œæµ‹è¯•
â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages</p>

<p>[root@container egon]# exit
exit
Parent - container stopped!
[egon@www ~]$ 
å¤åˆ¶ä»£ç 
2.3 PIDå‘½åç©ºé—´ï¼ˆç³»ç»Ÿè°ƒç”¨CLONE_NEWPIDï¼‰
ç©ºé—´å†…çš„PID æ˜¯ç‹¬ç«‹åˆ†é…çš„ï¼Œæ„æ€å°±æ˜¯å‘½åç©ºé—´å†…çš„è™šæ‹Ÿ PID å¯èƒ½ä¼šä¸å‘½åç©ºé—´å¤–çš„ PID ç›¸å†²çªï¼Œäºæ˜¯å‘½åç©ºé—´å†…çš„ PID æ˜ å°„åˆ°å‘½åç©ºé—´å¤–æ—¶ä¼šä½¿ç”¨å¦å¤–ä¸€ä¸ª PIDã€‚æ¯”å¦‚è¯´ï¼Œå‘½åç©ºé—´å†…ç¬¬ä¸€ä¸ª PID ä¸º1ï¼Œè€Œåœ¨å‘½åç©ºé—´å¤–å°±æ˜¯è¯¥ PID å·²è¢« init è¿›ç¨‹æ‰€ä½¿ç”¨ã€‚</p>

<p>æ–‡ä»¶åï¼špid.c</p>

<p>åŸºäºipc.cä¿®æ”¹è€Œæ¥ï¼Œè§æ ‡çº¢éƒ¨åˆ†ï¼Œå…¶ä¸­åªéœ€æ–°å¢CLONE_NEWPIDå°±å®Œå…¨å¯å®ç°PIDçš„éš”ç¦»,è€Œæ­¤å¤„æˆ‘ä»¬å³åŠ äº†CLONE_NEWUTSåˆåŠ äº†CLONE_NEWIPC,éšåæ‰æ·»åŠ äº†CLONE_NEWPID,ä»£è¡¨çš„æ„æ€æ˜¯ï¼šåœ¨UTSå’ŒIPCéš”ç¦»çš„åŸºç¡€ä¹‹ä¸Šå†è¿›è¡ŒPIDçš„éš”ç¦»ï¼Œæ­¤æ—¶çš„å®¹å™¨å·²ç»è¶Šæ¥è¶Šæ¥è¿‘äºåœ¨linuxæ“ä½œç³»ç»Ÿä¸Šæ–°å»ºä¸€ä¸ªéš”ç¦»çš„æ“ä½œç³»ç»Ÿäº†ã€‚</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    NULL
};</p>

<p>int container_main(void* arg) 
{ 
    printf(â€œContainer [%5d] - inside the container!\nâ€,getpid()); /* æ­¤å¤„çš„getpid()æ˜¯ä¸ºäº†è·å–å®¹å™¨çš„åˆå§‹è¿›ç¨‹(init)çš„pid <em>/
    sethostname(â€œcontainerâ€,10); /</em> è®¾ç½®hostname */ 
    execv(container_args[0], container_args); 
    printf(â€œSomethingâ€™s wrong!\nâ€); 
    return 1; 
}</p>

<p>int main() 
{ 
    printf(â€œParent [%5d] - start a container!\nâ€,getpid()); /* æ­¤å¤„çš„getpid()åˆ™æ˜¯ä¸ºäº†è·å–çˆ¶è¿›ç¨‹çš„pid <em>/ 
    int container_pid = clone(container_main, container_stack+STACK_SIZE,<br />
            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | SIGCHLD, NULL); /</em>æ–°å¢CLONE_NEWPIDå³å¯,æ­¤å¤„ä»£è¡¨åœ¨UTSå’ŒIPCéš”ç¦»çš„åŸºç¡€ä¹‹ä¸Šå†è¿›è¡ŒPIDçš„éš”ç¦»ï¼Œå…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥åªåŠ CLONE_NEWPIDè‡ªå·±:è¿™æ ·çš„è¯å°±åªä»£è¡¨éš”ç¦»PIDäº† */ 
    waitpid(container_pid, NULL, 0); 
    printf(â€œParent - container stopped!\nâ€); 
    return 0; 
}
å¤åˆ¶ä»£ç 
 æµ‹è¯•å¼€è¾Ÿä¸€ä¸ªæ–°çš„PIDåç§°ç©ºé—´/å®¹å™¨containerï¼ŒéªŒè¯PIDçš„éš”ç¦»æ€§:</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ gcc -o pid pid.c #ç¼–è¯‘
[egon@www ~]$ sudo ./pid #è¿›å…¥ä¸€ä¸ªæ–°çš„å®¹å™¨
Parent [ 4520] - start a container!
Container [    1] - inside the container!
[root@container egon]# echo $$ #æŸ¥çœ‹è¯¥å®¹å™¨çš„åˆå§‹ç¨‹åºï¼ˆinitï¼‰IDä¸º1ï¼Œè€Œå…¨å±€çš„initç¨‹åºçš„IDä¹Ÿä¸º1ï¼Œè¯æ˜äº†äºŒè€…çš„éš”ç¦»æ€§
1
[root@container egon]# hostname #å› ä¸ºæˆ‘ä»¬åœ¨pid.cæ–‡ä»¶ä¸­åŠ å…¥äº†CLONE_NEWUTS,æ‰€ä»¥æ­¤æ—¶çš„ä¸»æœºåä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œçœ‹åˆ°çš„æ˜¯è‡ªå·±çš„ä¸»æœºå
container
[root@container egon]# ipcs -q #å› ä¸ºæˆ‘ä»¬åœ¨pid.cæ–‡ä»¶ä¸­ä¹ŸåŠ å…¥äº†CLONE_NEWIPCï¼Œæ‰€ä»¥æ­¤æ—¶çš„IPCä¹Ÿæ˜¯éš”ç¦»çš„ï¼Œçœ‹ä¸åˆ°å…¨å±€æ–°å»ºçš„é‚£ä¸ªIPCé˜Ÿåˆ—</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages <br />
å¤åˆ¶ä»£ç 
 psï¼šcentos7ä¹‹åä½¿ç”¨systemdä»£æ›¿initï¼Œæ­¤å¤„æˆ‘ä»¬è¯´çš„åˆå§‹ç¨‹åºæŒ‡çš„å°±æ˜¯è¿™äºŒè€…ï¼Œæ˜¯ä¸€ä¸ªæ„æ€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>è¯´æ˜ï¼šåœ¨ä¼ ç»Ÿçš„UNIXç³»ç»Ÿä¸­ï¼ŒPIDä¸º1çš„è¿›ç¨‹æ˜¯initï¼Œåœ°ä½éå¸¸ç‰¹æ®Šã€‚ä»–ä½œä¸ºæ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œæœ‰å¾ˆå¤šç‰¹æƒ(æ¯”å¦‚ï¼šå±è”½ä¿¡å·ç­‰)ï¼Œå¦å¤–ï¼Œå…¶è¿˜ä¼šä¸ºæ£€æŸ¥æ‰€æœ‰è¿›ç¨‹çš„çŠ¶æ€ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœæŸä¸ªå­è¿›ç¨‹è„±ç¦»äº†çˆ¶è¿›ç¨‹(çˆ¶è¿›ç¨‹æ²¡æœ‰waitå®ƒ)ï¼Œé‚£ä¹ˆinitå°±ä¼šè´Ÿè´£å›æ”¶èµ„æºå¹¶ç»“æŸè¿™ä¸ªå­è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œè¦åšåˆ°è¿›ç¨‹ç©ºé—´çš„éš”ç¦»ï¼Œé¦–å…ˆè¦åˆ›å»ºå‡ºPIDä¸º1çš„è¿›ç¨‹ï¼Œæœ€å¥½å°±åƒchrooté‚£æ ·ï¼ŒæŠŠå­è¿›ç¨‹çš„PIDåœ¨å®¹å™¨å†…å˜æˆ1ã€‚
</code></pre></div></div>

<p>ä½†æ˜¯ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œåœ¨å­è¿›ç¨‹çš„shellé‡Œè¾“å…¥ps,topç­‰å‘½ä»¤ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¯ä»¥çœ‹å¾—åˆ°æ‰€æœ‰è¿›ç¨‹ã€‚è¯´æ˜å¹¶æ²¡æœ‰å®Œå…¨éš”ç¦»ã€‚è¿™æ˜¯å› ä¸ºï¼Œåƒps, topè¿™äº›å‘½ä»¤ä¼šå»è¯»/procæ–‡ä»¶ç³»ç»Ÿï¼Œæ‰€ä»¥ï¼Œå› ä¸º/procæ–‡ä»¶ç³»ç»Ÿåœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™äº›å‘½ä»¤æ˜¾ç¤ºçš„ä¸œè¥¿éƒ½æ˜¯ä¸€æ ·çš„ã€‚</p>

<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¯¹æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œéš”ç¦»ï¼Œè¿™å°±éœ€è¦ç”¨åˆ°mountå‘½åç©ºé—´äº†</p>

<p>2.4 Mountå‘½åç©ºé—´ï¼ˆç³»ç»Ÿè°ƒç”¨CLONE_NEWNSï¼‰
è¿›ç¨‹è¿è¡Œæ—¶å¯ä»¥å°†æŒ‚è½½ç‚¹ä¸ç³»ç»Ÿåˆ†ç¦»ï¼Œä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¾¾åˆ° chroot çš„åŠŸèƒ½ï¼Œè€Œåœ¨å®‰å…¨æ€§æ–¹é¢æ¯” chroot æ›´é«˜ã€‚</p>

<p>æ–‡ä»¶åï¼šfs.c</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    NULL
};</p>

<p>int container_main(void* arg) 
{ 
    printf(â€œContainer [%5d] - inside the container!\nâ€, getpid()); 
    sethostname(â€œcontainerâ€,10); 
    /* é‡æ–°mount procæ–‡ä»¶ç³»ç»Ÿåˆ° /procä¸‹ */ 
    system(â€œmount -t proc proc /procâ€); 
    execv(container_args[0], container_args); 
    printf(â€œSomethingâ€™s wrong!\nâ€); 
    return 1; 
}</p>

<p>int main() 
{ 
    printf(â€œParent [%5d] - start a container!\nâ€, getpid()); 
    /* å¯ç”¨Mount Namespace - å¢åŠ CLONE_NEWNSå‚æ•° */ 
    int container_pid = clone(container_main, container_stack+STACK_SIZE,<br />
            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL); 
    waitpid(container_pid, NULL, 0); 
    printf(â€œParent - container stopped!\nâ€); 
    return 0; 
} 
å¤åˆ¶ä»£ç 
æˆ‘ä»¬åŸºäºä¸Šæ¬¡pidå®¹å™¨ï¼Œåœ¨æ²¡æœ‰mountéš”ç¦»æƒ…å†µä¸‹æŸ¥çœ‹/procã€ps auxã€topç­‰ä¿¡æ¯</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ sudo ./pid
Parent [ 6231] - start a container!
Container [    1] - inside the container!
[root@container egon]# ls /proc/
1    116   132   148  165   18   197  213  230  248  265   282  36    5005  57    63   73   83   938        diskstats    locks         sysrq-trigger
10   117   133   149  166   180  198  214  231  249  266   283  37    51    58    64   731  84   94         dma          mdstat        sysvipc
100  118   134   15   167   181  199  215  232  25   267   284  38    514   59    640  74   841  95         driver       meminfo       timer_list
101  119   135   150  168   182  2    216  233  250  268   285  39    515   5939  641  745  85   957        execdomains  misc          timer_stats
102  12    136   151  169   183  20   217  234  251  2682  29   3944  517   60    642  75   86   96         fb           modules       tty
103  120   137   152  17    184  200  218  235  252  2684  293  3946  52    6047  643  76   863  960        filesystems  mounts        uptime
104  121   138   153  170   185  201  219  236  253  269   294  3982  520   6048  644  77   864  97         fs           mpt           version
105  122   139   154  171   186  202  22   237  254  27    295  40    53    6052  645  78   87   98         interrupts   mtrr          vmallocinfo
106  123   14    155  172   187  203  220  238  255  270   296  41    532   6053  646  780  871  99         iomem        net           vmstat
â€¦â€¦çœç•¥nè¡Œ<br />
[root@container egon]# ps aux
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          1  0.0  0.6  44000  6548 ?        Ss   10:24   0:02 /usr/lib/systemd/systemd â€“switched-root â€“system â€“deserialize 21
root          2  0.0  0.0      0     0 ?        S    10:24   0:00 [kthreadd]
root          3  0.0  0.0      0     0 ?        S    10:24   0:00 [ksoftirqd/0]
root          5  0.0  0.0      0     0 ?        S&lt;   10:24   0:00 [kworker/0:0H]
root          7  0.0  0.0      0     0 ?        S    10:24   0:00 [migration/0]
root          8  0.0  0.0      0     0 ?        S    10:24   0:00 [rcu_bh]
root          9  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/0]
root         10  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/1]
root         11  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/2]
root         12  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/3]
root         13  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/4]
root         14  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/5]
root         15  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/6]
root         16  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/7]
root         17  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/8]
root         18  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/9]
root         19  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/10]
root         20  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/11]
root         21  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/12]
root         22  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/13]
root         23  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/14]
root         24  0.0  0.0      0     0 ?        S    10:24   0:00 [rcuob/15]
â€¦â€¦çœç•¥nè¡Œ
å¤åˆ¶ä»£ç 
åˆæ¬¡ä¹‹å¤–è¿˜æœ‰topå‘½ä»¤è¿è¡Œçš„æˆªå›¾</p>

<p>æµ‹è¯•å¼€è¾Ÿä¸€ä¸ªæ–°çš„MOUNTåç§°ç©ºé—´/å®¹å™¨containerï¼ŒéªŒè¯MOUNTçš„éš”ç¦»æ€§:</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ gcc -o fs fs.c #ç¼–è¯‘
[egon@www ~]$ sudo ./fs #è¿›å…¥mountå®¹å™¨
Parent [ 6554] - start a container!
Container [    1] - inside the container!
[root@container egon]#    #æ­¤å¤„ä¾¿æ˜¯æ–°çš„å®¹å™¨äº†
[root@container egon]# ls /proc/ #æµè§ˆ/procå†…å®¹ï¼Œå‘ç°å°‘äº†å¥½å¤š
1          bus       crypto     execdomains  iomem     keys        loadavg  modules  pagetypeinfo  slabinfo  sysrq-trigger  uptime
13         cgroups   devices    fb           ioports   key-users   locks    mounts   partitions    softirqs  sysvipc        version
acpi       cmdline   diskstats  filesystems  irq       kmsg        mdstat   mpt      sched_debug   stat      timer_list     vmallocinfo
asound     consoles  dma        fs           kallsyms  kpagecount  meminfo  mtrr     scsi          swaps     timer_stats    vmstat
buddyinfo  cpuinfo   driver     interrupts   kcore     kpageflags  misc     net      self          sys       tty            zoneinfo
[root@container egon]# ps auxã€€ï¼ƒæŸ¥çœ‹è¿›ç¨‹ä¿¡æ¯å‘ç°åªèƒ½ä¸¤ä¸ªè¿›ç¨‹:ä¸€ä¸ªåˆå§‹è¿›ç¨‹idä¸º1,å¦å¤–ä¸€ä¸ªå°±ç®—pså‘½ä»¤æœ¬èº«
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          1  0.0  0.2 115384  2092 pts/0    S    11:35   0:00 /bin/bash
root         14  0.0  0.1 139500  1632 pts/0    R+   11:35   0:00 ps aux
å¤åˆ¶ä»£ç 
é™¤æ­¤ä¹‹å¤–æ‰§è¡Œtopå‘½ä»¤ï¼Œå‘ç°åŒ…æ‹¬topå‘½ä»¤æœ¬èº«ï¼Œä¹Ÿæ˜¯åªè¦ä¸¤ä¸ªè¿›ç¨‹</p>

<p>éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ï¼šåœ¨é€šè¿‡CLONE_NEWNSåˆ›å»ºmount namespaceåï¼Œçˆ¶è¿›ç¨‹ä¼šæŠŠè‡ªå·±çš„æ–‡ä»¶ç»“æ„å¤åˆ¶ç»™å­è¿›ç¨‹ä¸­ã€‚è€Œå­è¿›ç¨‹ä¸­æ–°çš„namespaceä¸­çš„æ‰€æœ‰mountæ“ä½œéƒ½åªå½±å“è‡ªèº«çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œä¸å¯¹å¤–ç•Œäº§ç”Ÿä»»ä½•å½±å“ã€‚è¿™æ ·å¯ä»¥åšåˆ°æ¯”è¾ƒä¸¥æ ¼åœ°éš”ç¦»ã€‚</p>

<p>å¹¶ä¸”æˆ‘ä»¬å®Œå…¨å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦æ¥ä¸ºå®¹å™¨å®šåˆ¶mounté€‰é¡¹ã€‚</p>

<p>Dockerçš„ Mount Namespace</p>

<p>ä¸‹é¢å°±è®©æˆ‘ä»¬æ¥æ¨¡æ‹Ÿåˆ¶ä½œä¸€ä¸ªé•œåƒï¼Œæ¨¡ä»¿Dockerçš„Mount Namespace</p>

<p>æ­¥éª¤ä¸€ï¼š</p>

<p>å¯¹äºchrootæ¥è¯´ï¼Œchroot ç›®å½•ï¼Œç„¶ååˆ‡å…¥åˆ°ç›®å½•å¯¹åº”çš„åç§°ç©ºé—´ä¸‹ï¼ŒåŒç†ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸ºæˆ‘ä»¬çš„mount namespaceæä¾›ä¸€ä¸ªç›®å½•ï¼ˆå³é•œåƒï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨/home/egonä¸‹æ–°å»ºç›®å½•rootfs</p>

<p>rootfsçš„ç›®å½•ç»“æ„å‚ç…§linuxæ ¹ç›®å½•çš„ç»“æ„</p>

<p>[root@www ~]# for i in <code class="language-plaintext highlighter-rouge">ls /</code>;do mkdir /home/egon/rootfs/$i -p;done
[root@www ~]# ls /home/egon/rootfs/
bin  boot  data  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
æ­¥éª¤äºŒ ï¼š</p>

<p>æŠŠä¸€äº›æˆ‘ä»¬éœ€è¦åœ¨å‘½åç©ºé—´å†…ä½¿ç”¨çš„å‘½ä»¤æ‹·è´åˆ°/home/egon/rootfs/binä»¥åŠ/home/egon/rootfs/usr/binç›®å½•ä¸‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š/bin/shå‘½ä»¤å¿…é¡»è¢«æ‹·è´ï¼Œä¸”è¦è¢«æ‹·è´åˆ°/home/egon/rootfs/binä¸‹ï¼Œå¦åˆ™æ— æ³•chroot</p>

<p>å¤åˆ¶ä»£ç 
#æ–°å¢ç›®å½•
[root@www ~]# mkdir /home/egon/rootfs/usr/libexec
[root@www ~]# mkdir /home/egon/rootfs/usr/bin</p>

<p>#æ‹·è´å‘½ä»¤
[root@www ~]# cp -r /bin/*  /home/egon/rootfs/bin/
[root@www ~]# cp -r /usr/bin/*  /home/egon/rootfs/usr/bin/</p>

<p>#æ‹·è´å‘½ä»¤ä¾èµ–çš„åº“ï¼Œå¯ä»¥ldd /bin/lsæ¥æŸ¥çœ‹lså‘½ä»¤ç”¨æ¥çš„åº“æ–‡ä»¶ï¼Œç„¶åå®šå‘æ‹·è´ï¼Œæ­¤å¤„æˆ‘ä»¬å°±ç®€å•ç²—æš´çš„ä½¿ç”¨<em>æ‹·è´æ‰€æœ‰äº†
[root@www ~]# cp -r /lib/</em>  /home/egon/rootfs/lib/
[root@www ~]# cp -r /lib64/*  /home/egon/rootfs/lib64/
[root@www ~]# cp -r /usr/libexec/* /home/egon/rootfs/usr/libexec/</p>

<p>#æ‹·è´å‘½ä»¤ä¾èµ–çš„ä¸€äº›é…ç½®æ–‡ä»¶
[root@www ~]# cp -r /etc/* /home/egon/rootfs/etc/
å¤åˆ¶ä»£ç 
æ­¥éª¤ä¸‰ï¼š</p>

<p>æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºå‘½åç©ºé—´å®šåˆ¶ä¸€äº›é…ç½®æ–‡ä»¶</p>

<p>å¤åˆ¶ä»£ç 
[root@www ~]# mkdir /home/egon/conf
[root@www ~]# echo â€˜egon_hostnameâ€™Â Â» /home/egon/conf/hostname #å®šä¹‰hostnameæ–‡ä»¶ï¼Œç”¨æ¥æŒ‚è½½åˆ°å‘½åç©ºé—´ä¸­çš„/etc/hostname
[root@www ~]# echo â€˜1.1.1.1 egon_hostnameâ€™Â Â» /home/egon/conf/hosts #å®šä¹‰hostsæ–‡ä»¶ï¼Œç”¨æ¥æŒ‚è½½åˆ°å‘½åç©ºé—´ä¸­çš„/etc/hosts
[root@www ~]# echo â€˜nameserver 202.110.110.213â€™Â Â» /home/egon/conf/resolv.conf #å®šä¹‰resolv.confæ–‡ä»¶ï¼Œç”¨æ¥æŒ‚è½½åˆ°å‘½åç©ºé—´ä¸­çš„/etc/resolv.conf
å¤åˆ¶ä»£ç 
åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æˆ‘æ–°çš„å‘½åç©ºé—´å®šåˆ¶ä¸€äº›ç›®å½•</p>

<p>[root@www ~]# mkdir /tmp/t1 #æœ¬æ–‡æœ€ç»ˆä¼šå°†è¯¥ç›®å½•æŒ‚è½½åˆ°å‘½åç©ºé—´ä¸­çš„/mntç›®å½•
[root@www ~]# touch /tmp/t1/egon_test.txt
æ­¥éª¤å››ï¼š</p>

<p>æ–‡ä»¶åï¼šnewns.c</p>

<p>å¤åˆ¶ä»£ç 
#define _GNU_SOURCE 
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/mount.h&gt;
#include <stdio.h>
#include <sched.h>
#include <signal.h>
#include <unistd.h></unistd.h></signal.h></sched.h></stdio.h></p>

<p>/* å®šä¹‰ä¸€ä¸ªç»™ clone ç”¨çš„æ ˆï¼Œæ ˆå¤§å°1M */
#define STACK_SIZE (1024 * 1024) 
static char container_stack[STACK_SIZE];</p>

<p>char* const container_args[] = {
    â€œ/bin/bashâ€,
    â€œ-lâ€,
    NULL
};</p>

<p>int container_main(void* arg) 
{ 
    printf(â€œContainer [%5d] - inside the container!\nâ€, getpid());</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sethostname("container",10); 
 
/* remount "/proc" to make sure the "top" and "ps" show container's information */
if (mount("proc", "rootfs/proc", "proc", 0, NULL) !=0 ) { 
    perror("proc"); 
} 
if (mount("sysfs", "rootfs/sys", "sysfs", 0, NULL)!=0) { 
    perror("sys"); 
} 
if (mount("none", "rootfs/tmp", "tmpfs", 0, NULL)!=0) { 
    perror("tmp"); 
} 
if (mount("udev", "rootfs/dev", "devtmpfs", 0, NULL)!=0) { 
    perror("dev"); 
} 
if (mount("devpts", "rootfs/dev/pts", "devpts", 0, NULL)!=0) { 
    perror("dev/pts"); 
} 
if (mount("shm", "rootfs/dev/shm", "tmpfs", 0, NULL)!=0) { 
    perror("dev/shm"); 
} 
if (mount("tmpfs", "rootfs/run", "tmpfs", 0, NULL)!=0) { 
    perror("run"); 
} 
/*  
 * æ¨¡ä»¿Dockerçš„ä»å¤–å‘å®¹å™¨é‡Œmountç›¸å…³çš„é…ç½®æ–‡ä»¶  
 * ä½ å¯ä»¥æŸ¥çœ‹ï¼š/var/lib/docker/containers/&lt;container_id&gt;/ç›®å½•ï¼Œ 
 * ä½ ä¼šçœ‹åˆ°dockerçš„è¿™äº›æ–‡ä»¶çš„ã€‚ 
 */ 
if (mount("conf/hosts", "rootfs/etc/hosts", "none", MS_BIND, NULL)!=0 || 
      mount("conf/hostname", "rootfs/etc/hostname", "none", MS_BIND, NULL)!=0 || 
      mount("conf/resolv.conf", "rootfs/etc/resolv.conf", "none", MS_BIND, NULL)!=0 ) { 
    perror("conf"); 
} 
/* æ¨¡ä»¿docker runå‘½ä»¤ä¸­çš„ -v, --volume=[] å‚æ•°å¹²çš„äº‹ */ 
if (mount("/tmp/t1", "rootfs/mnt", "none", MS_BIND, NULL)!=0) { 
    perror("mnt"); 
} 
 
/* chroot éš”ç¦»ç›®å½• */
if ( chdir("./rootfs") != 0 || chroot("./") != 0 ){ 
    perror("chdir/chroot"); 
}
 
execv(container_args[0], container_args); 
perror("exec1111"); 
printf("Something's wrong!\n"); 
return 1;  } 
</code></pre></div></div>

<p>int main() 
{ 
    printf(â€œParent [%5d] - start a container!\nâ€, getpid()); 
    int container_pid = clone(container_main, container_stack+STACK_SIZE,<br />
            CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNS | SIGCHLD, NULL); 
    waitpid(container_pid, NULL, 0); 
    printf(â€œParent - container stopped!\nâ€); 
    return 0; 
} 
å¤åˆ¶ä»£ç 
æ­¥éª¤äº”ï¼š</p>

<p>å¤åˆ¶ä»£ç 
[egon@www ~]$ gcc -o newns newns.c
[egon@www ~]$ sudo ./newns              #è¿›è¡Œæ–°çš„å‘½åç©ºé—´
Parent [ 2848] - start a container!
Container [    1] - inside the container!   #åŸºäºä¹‹å‰æ‰€åšï¼Œæˆ‘ä»¬å·²ç„¶å®ç°pidéš”ç¦»
bash-4.2#                                             #chrootè¿›äº†ä¸€ä¸ªæ–°çš„å‘½åç©ºé—´
bash-4.2# pwd                                      #chroot ./rootfsçš„æ•ˆæœ
/
bash-4.2# hostname                             #æŸ¥çœ‹ä¸»æœºåå‘ç°å®ç°äº†ä¸»æœºåéš”ç¦»
container
bash-4.2# ipcs -q                                  #ipcåŒæ ·ä¹Ÿæ˜¯éš”ç¦»çš„</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages</p>

<p>bash-4.2# ps aux
USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root          1  0.0  0.1  11768  1860 pts/0    S    20:55   0:00 /bin/bash -l
root         28  0.0  0.1  35884  1480 pts/0    R+   20:57   0:00 ps aux
bash-4.2# 
bash-4.2# 
bash-4.2# 
bash-4.2# 
bash-4.2# 
bash-4.2# 
bash-4.2# mount
proc on /proc type proc (rw,relatime)
sysfs on /sys type sysfs (rw,relatime,seclabel)
none on /tmp type tmpfs (rw,relatime,seclabel)
udev on /dev type devtmpfs (rw,relatime,seclabel,size=490432k,nr_inodes=122608,mode=755)
devpts on /dev/pts type devpts (rw,relatime,seclabel,mode=600,ptmxmode=000)
shm on /dev/shm type tmpfs (rw,relatime,seclabel)
tmpfs on /run type tmpfs (rw,relatime,seclabel)
/dev/mapper/centos-root on /etc/hosts type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hostname type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/resolv.conf type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /mnt type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
proc on /proc type proc (rw,relatime)
none on /tmp type tmpfs (rw,relatime,seclabel)
shm on /dev/shm type tmpfs (rw,relatime,seclabel)
tmpfs on /run type tmpfs (rw,relatime,seclabel)
/dev/mapper/centos-root on /etc/hosts type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/hostname type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /etc/resolv.conf type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
/dev/mapper/centos-root on /mnt type xfs (rw,relatime,seclabel,attr2,inode64,noquota)
bash-4.2# cat /etc/hostname #éªŒè¯æ­¥éª¤ä¸‰æ‰€è¿°
testhostname
bash-4.2# cat /etc/hosts    #åŒä¸Š
123
bash-4.2# cat /etc/resolv.conf #åŒä¸Š
123
bash-4.2# ls /mnt/             #åŒä¸Š
egon_test.txt
2.5 Networkå‘½åç©ºé—´
ç”¨äºéš”ç¦»ç½‘ç»œèµ„æºï¼ˆ/proc/netã€IP åœ°å€ã€ç½‘å¡ã€è·¯ç”±ç­‰ï¼‰ã€‚åå°è¿›ç¨‹å¯ä»¥è¿è¡Œåœ¨ä¸åŒå‘½åç©ºé—´å†…çš„ç›¸åŒç«¯å£ä¸Šï¼Œç”¨æˆ·è¿˜å¯ä»¥è™šæ‹Ÿå‡ºä¸€å—ç½‘å¡ã€‚</p>

<p>æ¯ä¸ªç½‘ç»œå‘½åç©ºé—´éƒ½æœ‰è‡ªå·±çš„è·¯ç”±è¡¨ï¼Œå®ƒè‡ªå·±çš„iptablesè®¾ç½®æä¾›natå’Œè¿‡æ»¤ã€‚Linuxç½‘ç»œå‘½åç©ºé—´è¿˜æä¾›äº†åœ¨ç½‘ç»œå‘½åç©ºé—´å†…è¿è¡Œè¿›ç¨‹çš„åŠŸèƒ½ã€‚</p>

<p>2.6 Userå‘½åç©ºé—´
åŒè¿›ç¨‹ ID ä¸€æ ·ï¼Œç”¨æˆ· ID å’Œç»„ ID åœ¨å‘½åç©ºé—´å†…å¤–æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¹¶ä¸”åœ¨ä¸åŒå‘½åç©ºé—´å†…å¯ä»¥å­˜åœ¨ç›¸åŒçš„ IDã€‚</p>
:ET