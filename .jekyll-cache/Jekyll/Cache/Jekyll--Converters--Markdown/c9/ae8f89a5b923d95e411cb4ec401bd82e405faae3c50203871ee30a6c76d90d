I"ş<<p>iptables -t nat -L â€“line-numbers</p>

<p>iptables -D INPUT 3: é€šè¿‡Chain Name(INPUT) å’Œ line number(3)æ¥åˆ é™¤è§„åˆ™</p>

<p>iptables -t nat -I PREROUTING -m set â€“match-set myset src -m comment â€“comment â€œmysetâ€ -j return</p>

<p>ipset create myset hash:ip
ipset add myset 192.168.1.1</p>

<p>ipset create myset hash:ip
ipset add myset 192.168.2.226
iptables -t nat -I SS_SPEC_WAN_FW -m set â€“match-set myset src -m comment â€“comment â€œmysetâ€ -j RETURN
#åœ¨natè¡¨çš„SS_SPEC_WAN_FWä¹‹å‰åŠ å…¥ä¸€ä¸ªè§„åˆ™:é‡åˆ°åŒ¹é…mysetçš„ipçš„è·³è¿‡ä½™ä¸‹è§„åˆ™
<!-- more -->
ä»k8sçš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œkube-proxyå¼•å…¥äº†IPVSæ¨¡å¼ï¼ŒIPVSæ¨¡å¼ä¸iptablesåŒæ ·åŸºäºNetfilterï¼Œä½†æ˜¯é‡‡ç”¨çš„hashè¡¨ï¼Œå› æ­¤å½“serviceæ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼ŒhashæŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜serviceçš„æœåŠ¡æ€§èƒ½ã€‚</p>

<p>å¼€å¯å†…æ ¸å‚æ•°
catÂ Â» /etc/sysctl.conf Â«Â EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF</p>

<p>sysctl -p
å¼€å¯ipvsæ”¯æŒ
yum -y install ipvsadm  ipset</p>

<h1 id="ä¸´æ—¶ç”Ÿæ•ˆ">ä¸´æ—¶ç”Ÿæ•ˆ</h1>
<p>modprobe â€“ ip_vs
modprobe â€“ ip_vs_rr
modprobe â€“ ip_vs_wrr
modprobe â€“ ip_vs_sh
modprobe â€“ nf_conntrack_ipv4</p>

<h1 id="æ°¸ä¹…ç”Ÿæ•ˆ">æ°¸ä¹…ç”Ÿæ•ˆ</h1>
<p>cat &gt; /etc/sysconfig/modules/ipvs.modules Â«EOF
modprobe â€“ ip_vs
modprobe â€“ ip_vs_rr
modprobe â€“ ip_vs_wrr
modprobe â€“ ip_vs_sh
modprobe â€“ nf_conntrack_ipv4
EOF
é…ç½®kube-proxy</p>
<h1 id="æ·»åŠ ä¸‹é¢ä¸¤è¡Œ">æ·»åŠ ä¸‹é¢ä¸¤è¡Œ</h1>
<p>â€“proxy-mode=ipvs  <br />
  â€“masquerade-all=true \</p>

<h1 id="ä¿®æ”¹æœåŠ¡æ–‡ä»¶">ä¿®æ”¹æœåŠ¡æ–‡ä»¶</h1>
<p>vim /usr/lib/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Kube-Proxy Server
Documentation=https://github.com/GoogleCloudPlatform/kubernetes
After=network.target</p>

<p>[Service]
WorkingDirectory=/data/k8s/kube-proxy
ExecStart=/data/k8s/bin/kube-proxy <br />
  â€“bind-address=192.168.1.145 <br />
  â€“hostname-override=192.168.1.145 <br />
  â€“cluster-cidr=10.254.0.0/16 <br />
  â€“kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig <br />
  â€“logtostderr=true <br />
  â€“proxy-mode=ipvs  <br />
  â€“masquerade-all=true <br />
  â€“v=2
Restart=on-failure
RestartSec=5
LimitNOFILE=65536</p>

<p>[Install]
WantedBy=multi-user.target 
é‡å¯kube-proxy
systemctl daemon-reload
systemctl restart kube-proxy
systemctl status kube-proxy
æµ‹è¯•æ˜¯å¦ç”Ÿæ•ˆ</p>

<p>[root@k8sNode01 docker]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.254.0.1:443 rr
  -&gt; 192.168.1.142:6443           Masq    1      0          0       <br />
  -&gt; 192.168.1.143:6443           Masq    1      1          0       <br />
  -&gt; 192.168.1.144:6443           Masq    1      1          0       <br />
TCP  10.254.27.38:80 rr
  -&gt; 172.30.36.4:9090             Masq    1      0          0       <br />
TCP  10.254.72.60:80 rr
  -&gt; 172.30.90.4:8080             Masq    1      0          0       <br />
TCP  10.254.72.247:80 rr
  -&gt; 172.30.36.5:3000             Masq    1      0          0       <br />
TCP  127.0.0.1:27841 rr
  -&gt; 172.30.36.2:80               Masq    1      0          0       <br />
  -&gt; 172.30.90.2:80               Masq    1      0          0       <br />
TCP  127.0.0.1:28453 rr
  -&gt; 172.30.36.5:3000             Masq    1      0          0       <br />
TCP  127.0.0.1:36018 rr
  -&gt; 172.30.36.4:9090             Masq    1      0          0       <br />
TCP  172.30.90.0:27841 rr
  -&gt; 172.30.36.2:80               Masq    1      0          0       <br />
  -&gt; 172.30.90.2:80               Masq    1      0          0</p>

<p>https://www.jianshu.com/p/492bbc74b7ea</p>

<p>k8sä¸­iptableså’ŒipvsåŒºåˆ«
 å‘è¡¨è¯„è®º
A+
æ‰€å±åˆ†ç±»ï¼šDevOps k8s
ä»k8sçš„1.8ç‰ˆæœ¬å¼€å§‹ï¼Œkube-proxyå¼•å…¥äº†IPVSæ¨¡å¼ï¼ŒIPVSæ¨¡å¼ä¸iptablesåŒæ ·åŸºäºNetfilterï¼Œä½†æ˜¯ipvsé‡‡ç”¨çš„hashè¡¨ï¼Œiptablesé‡‡ç”¨ä¸€æ¡æ¡çš„è§„åˆ™åˆ—è¡¨ã€‚iptablesåˆæ˜¯ä¸ºäº†é˜²ç«å¢™è®¾è®¡çš„ï¼Œé›†ç¾¤æ•°é‡è¶Šå¤šiptablesè§„åˆ™å°±è¶Šå¤šï¼Œè€Œiptablesè§„åˆ™æ˜¯ä»ä¸Šåˆ°ä¸‹åŒ¹é…ï¼Œæ‰€ä»¥æ•ˆç‡å°±è¶Šæ˜¯ä½ä¸‹ã€‚å› æ­¤å½“serviceæ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼ŒhashæŸ¥è¡¨çš„é€Ÿåº¦ä¼˜åŠ¿å°±ä¼šæ˜¾ç°å‡ºæ¥ï¼Œä»è€Œæé«˜serviceçš„æœåŠ¡æ€§èƒ½
æ¯ä¸ªèŠ‚ç‚¹çš„kube-proxyè´Ÿè´£ç›‘å¬API serverä¸­serviceå’Œendpointçš„å˜åŒ–æƒ…å†µã€‚å°†å˜åŒ–ä¿¡æ¯å†™å…¥æœ¬åœ°userspaceã€iptablesã€ipvsæ¥å®ç°serviceè´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨NATå°†vipæµé‡è½¬è‡³endpointä¸­ã€‚ç”±äºuserspaceæ¨¡å¼å› ä¸ºå¯é æ€§å’Œæ€§èƒ½ï¼ˆé¢‘ç¹åˆ‡æ¢å†…æ ¸/ç”¨æˆ·ç©ºé—´ï¼‰æ—©å·²ç»æ·˜æ±°ï¼Œæ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚svcï¼Œå…ˆç»è¿‡iptablesï¼Œç„¶åå†ç»è¿‡kube-proxyåˆ°podï¼Œæ‰€ä»¥æ€§èƒ½å¾ˆå·®ã€‚
ipvså’Œiptableséƒ½æ˜¯åŸºäºnetfilterçš„ï¼Œä¸¤è€…å·®åˆ«å¦‚ä¸‹ï¼š
ipvs ä¸ºå¤§å‹é›†ç¾¤æä¾›äº†æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½
ipvs æ”¯æŒæ¯” iptables æ›´å¤æ‚çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆæœ€å°è´Ÿè½½ã€æœ€å°‘è¿æ¥ã€åŠ æƒç­‰ç­‰ï¼‰
ipvs æ”¯æŒæœåŠ¡å™¨å¥åº·æ£€æŸ¥å’Œè¿æ¥é‡è¯•ç­‰åŠŸèƒ½
ä¸€ã€Iptablesæ¨¡å¼
åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œkube-proxyç›‘è§†API Serverä¸­serviceå’Œendpointçš„å˜åŒ–æƒ…å†µã€‚å¯¹äºæ¯ä¸ªserviceï¼Œå®ƒéƒ½ç”Ÿæˆç›¸åº”çš„iptablesè§„åˆ™ï¼Œè¿™äº›è§„åˆ™æ•è·åˆ°serviceçš„clusterIPå’Œportçš„æµé‡ï¼Œå¹¶å°†è¿™äº›æµé‡éšæœºé‡å®šå‘åˆ°serviceåç«¯Podã€‚å¯¹äºæ¯ä¸ªendpointå¯¹è±¡ï¼Œå®ƒç”Ÿæˆé€‰æ‹©åç«¯Podçš„iptablesè§„åˆ™ã€‚
å¦‚æœé€‰æ‹©çš„ç¬¬ä¸€ä¸ªPodæ²¡æœ‰å“åº”ï¼Œkube-proxyå°†æ£€æµ‹åˆ°åˆ°ç¬¬ä¸€ä¸ªPodçš„è¿æ¥å¤±è´¥ï¼Œå¹¶å°†è‡ªåŠ¨é‡è¯•å¦ä¸€ä¸ªåç«¯Podã€‚</p>

<p>ç¼ºç‚¹ï¼š
iptables å› ä¸ºå®ƒçº¯ç²¹æ˜¯ä¸ºé˜²ç«å¢™è€Œè®¾è®¡çš„ï¼Œå¹¶ä¸”åŸºäºå†…æ ¸è§„åˆ™åˆ—è¡¨ï¼Œé›†ç¾¤æ•°é‡è¶Šå¤šæ€§èƒ½è¶Šå·®ã€‚
ä¸€ä¸ªä¾‹å­æ˜¯ï¼Œåœ¨5000èŠ‚ç‚¹é›†ç¾¤ä¸­ä½¿ç”¨ NodePort æœåŠ¡ï¼Œå¦‚æœæˆ‘ä»¬æœ‰2000ä¸ªæœåŠ¡å¹¶ä¸”æ¯ä¸ªæœåŠ¡æœ‰10ä¸ª podï¼Œè¿™å°†åœ¨æ¯ä¸ªå·¥ä½œèŠ‚ç‚¹ä¸Šè‡³å°‘äº§ç”Ÿ20000ä¸ª iptable è®°å½•ï¼Œè¿™å¯èƒ½ä½¿å†…æ ¸éå¸¸ç¹å¿™ã€‚
äºŒã€IPVSæ¨¡å¼ï¼ˆNATæ¨¡å¼ï¼‰
åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œkube-proxyç›‘å¬API Serverä¸­serviceå’Œendpointçš„å˜åŒ–æƒ…å†µï¼Œè°ƒç”¨netlinkæ¥å£åˆ›å»ºç›¸åº”çš„ipvsè§„åˆ™ï¼Œå¹¶å®šæœŸå°†ipvsè§„åˆ™ä¸Kubernetesæœ Serviceså’ŒEndpointsåŒæ­¥ã€‚ä¿è¯IPVSçŠ¶æ€ã€‚å½“è®¿é—®Servicesæ—¶ï¼ŒIPVSå°†æµé‡å®šå‘åˆ°åç«¯podä¹‹ä¸€ã€‚
IPVSä»£ç†æ¨¡å¼åŸºäºnetfilter hookå‡½æ•°ï¼Œè¯¥å‡½æ•°ç±»ä¼¼äºiptablesæ¨¡å¼ï¼Œä½†ä½¿ç”¨hashè¡¨ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œåœ¨å†…æ ¸ç©ºé—´ä¸­å·¥ä½œã€‚è¿™æ„å‘³ç€IPVSæ¨¡å¼ä¸‹çš„kube-proxyä½¿ç”¨æ›´ä½çš„é‡å®šå‘æµé‡ã€‚å…¶åŒæ­¥è§„åˆ™çš„æ•ˆç‡å’Œç½‘ç»œååé‡ä¹Ÿæ›´é«˜ã€‚</p>

<p>pvsä¾èµ–iptablesè¿›è¡ŒåŒ…è¿‡æ»¤ã€SNATã€masquared(ä¼ªè£…)ã€‚ ä½¿ç”¨ ipset æ¥å­˜å‚¨éœ€è¦ DROP æˆ– masquared çš„æµé‡çš„æºæˆ–ç›®æ ‡åœ°å€ï¼Œä»¥ç¡®ä¿ iptables è§„åˆ™çš„æ•°é‡æ˜¯æ’å®šçš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸éœ€è¦å…³å¿ƒæˆ‘ä»¬æœ‰å¤šå°‘æœåŠ¡äº†
å¦‚æœæ²¡æœ‰åŠ è½½å¹¶å¯ç”¨ipvsæ¨¡å—ï¼Œåˆ™ä¼šè¢«é™çº§æˆiptablesæ¨¡å¼ã€‚</p>

<p>https://www.ayunw.cn/archives/773
https://www.jianshu.com/p/cb7eaf8f344d</p>

<p>ç­–ç•¥è·¯ç”± iproute2+çº¯ ip å’Œ iptables+ipset æœ‰åŒºåˆ«ï¼Ÿ</p>

<p>https://www.v2ex.com/t/161176</p>

<p>Cluster IP
Kubernetesä»¥Podä½œä¸ºåº”ç”¨éƒ¨ç½²çš„æœ€å°å•ä½ã€‚kubernetesä¼šæ ¹æ®Podçš„å£°æ˜å¯¹å…¶è¿›è¡Œè°ƒåº¦ï¼ŒåŒ…æ‹¬åˆ›å»ºã€é”€æ¯ã€è¿ç§»ã€æ°´å¹³ä¼¸ç¼©ç­‰ï¼Œå› æ­¤Pod çš„IPåœ°å€ä¸æ˜¯å›ºå®šçš„ï¼Œä¸æ–¹ä¾¿ç›´æ¥é‡‡ç”¨Pod IPå¯¹æœåŠ¡è¿›è¡Œè®¿é—®ã€‚</p>

<p>ä¸ºè§£å†³è¯¥é—®é¢˜ï¼ŒKubernetesæä¾›äº†Serviceèµ„æºï¼ŒServiceå¯¹æä¾›åŒä¸€ä¸ªæœåŠ¡çš„å¤šä¸ªPodè¿›è¡Œèšåˆã€‚ä¸€ä¸ªServiceæä¾›ä¸€ä¸ªè™šæ‹Ÿçš„Cluster IPï¼Œåç«¯å¯¹åº”ä¸€ä¸ªæˆ–è€…å¤šä¸ªæä¾›æœåŠ¡çš„Podã€‚åœ¨é›†ç¾¤ä¸­è®¿é—®è¯¥Serviceæ—¶ï¼Œé‡‡ç”¨Cluster IPå³å¯ï¼ŒKube-proxyè´Ÿè´£å°†å‘é€åˆ°Cluster IPçš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„Podä¸Šã€‚</p>

<p>Kube-proxyæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„goåº”ç”¨ç¨‹åºï¼Œæ”¯æŒä¸‰ç§å·¥ä½œæ¨¡å¼ï¼š</p>

<p>userspace æ¨¡å¼
è¯¥æ¨¡å¼ä¸‹kube-proxyä¼šä¸ºæ¯ä¸€ä¸ªServiceåˆ›å»ºä¸€ä¸ªç›‘å¬ç«¯å£ã€‚å‘å‘Cluster IPçš„è¯·æ±‚è¢«Iptablesè§„åˆ™é‡å®šå‘åˆ°Kube-proxyç›‘å¬çš„ç«¯å£ä¸Šï¼ŒKube-proxyæ ¹æ®LBç®—æ³•é€‰æ‹©ä¸€ä¸ªæä¾›æœåŠ¡çš„Podå¹¶å’Œå…¶å»ºç«‹é“¾æ¥ï¼Œä»¥å°†è¯·æ±‚è½¬å‘åˆ°Podä¸Šã€‚
è¯¥æ¨¡å¼ä¸‹ï¼ŒKube-proxyå……å½“äº†ä¸€ä¸ªå››å±‚Load balancerçš„è§’è‰²ã€‚ç”±äºkube-proxyè¿è¡Œåœ¨userspaceä¸­ï¼Œåœ¨è¿›è¡Œè½¬å‘å¤„ç†æ—¶ä¼šå¢åŠ ä¸¤æ¬¡å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œæ•ˆç‡è¾ƒå¦å¤–ä¸¤ç§æ¨¡å¼ä½ä¸€äº›ï¼›å¥½å¤„æ˜¯å½“åç«¯çš„Podä¸å¯ç”¨æ—¶ï¼Œkube-proxyå¯ä»¥é‡è¯•å…¶ä»–Podã€‚</p>

<p>iptables æ¨¡å¼
ä¸ºäº†é¿å…å¢åŠ å†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„æ•°æ®æ‹·è´æ“ä½œï¼Œæé«˜è½¬å‘æ•ˆç‡ï¼ŒKube-proxyæä¾›äº†iptablesæ¨¡å¼ã€‚åœ¨è¯¥æ¨¡å¼ä¸‹ï¼ŒKube-proxyä¸ºserviceåç«¯çš„æ¯ä¸ªPodåˆ›å»ºå¯¹åº”çš„iptablesè§„åˆ™ï¼Œç›´æ¥å°†å‘å‘Cluster IPçš„è¯·æ±‚é‡å®šå‘åˆ°ä¸€ä¸ªPod IPã€‚
è¯¥æ¨¡å¼ä¸‹Kube-proxyä¸æ‰¿æ‹…å››å±‚ä»£ç†çš„è§’è‰²ï¼Œåªè´Ÿè´£åˆ›å»ºiptablesè§„åˆ™ã€‚è¯¥æ¨¡å¼çš„ä¼˜ç‚¹æ˜¯è¾ƒuserspaceæ¨¡å¼æ•ˆç‡æ›´é«˜ï¼Œä½†ä¸èƒ½æä¾›çµæ´»çš„LBç­–ç•¥ï¼Œå½“åç«¯Podä¸å¯ç”¨æ—¶ä¹Ÿæ— æ³•è¿›è¡Œé‡è¯•ã€‚</p>

<p>ipvs æ¨¡å¼
è¯¥æ¨¡å¼å’Œiptablesç±»ä¼¼ï¼Œkube-proxyç›‘æ§Podçš„å˜åŒ–å¹¶åˆ›å»ºç›¸åº”çš„ipvs rulesã€‚ipvsä¹Ÿæ˜¯åœ¨kernelæ¨¡å¼ä¸‹é€šè¿‡netfilterå®ç°çš„ï¼Œä½†é‡‡ç”¨äº†hash tableæ¥å­˜å‚¨è§„åˆ™ï¼Œå› æ­¤åœ¨è§„åˆ™è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼ŒIpvsç›¸å¯¹iptablesè½¬å‘æ•ˆç‡æ›´é«˜ã€‚é™¤æ­¤ä»¥å¤–ï¼Œipvsæ”¯æŒæ›´å¤šçš„LBç®—æ³•ã€‚å¦‚æœè¦è®¾ç½®kube-proxyä¸ºipvsæ¨¡å¼ï¼Œå¿…é¡»åœ¨æ“ä½œç³»ç»Ÿä¸­å®‰è£…IPVSå†…æ ¸æ¨¡å—ã€‚</p>

<p>ä»€ä¹ˆæ˜¯IPVSï¼Ÿ
IPVS (IP Virtual Serverï¼ŒIPè™šæ‹ŸæœåŠ¡å™¨)æ˜¯åŸºäºNetfilterçš„ã€ä½œä¸ºlinuxå†…æ ¸çš„ä¸€éƒ¨åˆ†å®ç°ä¼ è¾“å±‚è´Ÿè½½å‡è¡¡çš„æŠ€æœ¯ï¼Œé€šå¸¸ç§°ä¸ºç¬¬4å±‚LANäº¤æ¢ã€‚</p>

<p>IPVSé›†æˆåœ¨LVS(Linux Virtual Server)ä¸­ï¼Œå®ƒåœ¨ä¸»æœºä¸­è¿è¡Œï¼Œå¹¶åœ¨çœŸå®æœåŠ¡å™¨é›†ç¾¤å‰å……å½“è´Ÿè½½å‡è¡¡å™¨ã€‚IPVSå¯ä»¥å°†å¯¹TCP/UDPæœåŠ¡çš„è¯·æ±‚è½¬å‘ç»™åç«¯çš„çœŸå®æœåŠ¡å™¨ï¼Œå¹¶ä½¿çœŸå®æœåŠ¡å™¨çš„æœåŠ¡åœ¨å•ä¸ªIPåœ°å€ä¸Šæ˜¾ç¤ºä¸ºè™šæ‹ŸæœåŠ¡ã€‚å› æ­¤IPVSå¤©ç„¶æ”¯æŒKubernetes Serviceã€‚</p>

<p>ä¸ºä»€ä¹ˆé€‰æ‹©IPVS
éšç€kubernetesä½¿ç”¨é‡çš„å¢é•¿ï¼Œå…¶èµ„æºçš„å¯æ‰©å±•æ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ç‰¹åˆ«æ˜¯å¯¹äºä½¿ç”¨kubernetesè¿è¡Œå¤§å‹å·¥ä½œè´Ÿè½½çš„å¼€å‘äººå‘˜æˆ–è€…å…¬å¸æ¥è¯´ï¼Œserviceçš„å¯æ‰©å±•æ€§è‡³å…³é‡è¦ã€‚</p>

<p>kube-proxyæ˜¯ä¸ºserviceæ„å»ºè·¯ç”±è§„åˆ™çš„æ¨¡å—ï¼Œä¹‹å‰ä¾èµ–iptablesæ¥å®ç°ä¸»è¦serviceç±»å‹çš„æ”¯æŒï¼Œæ¯”å¦‚(ClusterIPå’ŒNodePort)ã€‚ä½†æ˜¯iptableså¾ˆéš¾æ”¯æŒä¸Šä¸‡çº§çš„serviceï¼Œå› ä¸ºiptablesçº¯ç²¹æ˜¯ä¸ºé˜²ç«å¢™è€Œè®¾è®¡çš„ï¼Œå¹¶ä¸”åº•å±‚æ•°æ®ç»“æ„æ˜¯å†…æ ¸è§„åˆ™çš„åˆ—è¡¨ã€‚</p>

<p>kubernetesæ—©åœ¨1.6ç‰ˆæœ¬å°±å·²ç»æœ‰èƒ½åŠ›æ”¯æŒ5000å¤šèŠ‚ç‚¹ï¼Œè¿™æ ·åŸºäºiptablesçš„kube-proxyå°±æˆä¸ºé›†ç¾¤æ‰©å®¹åˆ°5000èŠ‚ç‚¹çš„ç“¶é¢ˆã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœåœ¨ä¸€ä¸ª5000èŠ‚ç‚¹çš„é›†ç¾¤ï¼Œæˆ‘ä»¬åˆ›å»º2000ä¸ªserviceï¼Œå¹¶ä¸”æ¯ä¸ªserviceæœ‰10ä¸ªpodï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæœ‰è‡³å°‘20000æ¡iptablesè§„åˆ™ï¼Œè¿™ä¼šå¯¼è‡´å†…æ ¸éå¸¸ç¹å¿™ã€‚</p>

<p>åŸºäºIPVSçš„é›†ç¾¤å†…è´Ÿè½½å‡è¡¡å°±å¯ä»¥å®Œç¾çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚IPVSæ˜¯ä¸“é—¨ä¸ºè´Ÿè½½å‡è¡¡è®¾è®¡çš„ï¼Œå¹¶ä¸”åº•å±‚ä½¿ç”¨å“ˆå¸Œè¡¨è¿™ç§éå¸¸é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼Œå‡ ä¹å¯ä»¥å…è®¸æ— é™æ‰©å®¹ã€‚</p>

<p>IPVS vs. IptablesåŒºåˆ«
IPVSæ¨¡å¼åœ¨Kubernetes v1.8ä¸­å¼•å…¥ï¼Œå¹¶åœ¨v1.9ä¸­è¿›å…¥äº†betaã€‚ 1.11ä¸­å®ç°äº†GA(General Availability)ã€‚IPTABLESæ¨¡å¼åœ¨v1.1ä¸­æ·»åŠ ï¼Œå¹¶æˆä¸ºè‡ªv1.2ä»¥æ¥çš„é»˜è®¤æ“ä½œæ¨¡å¼ã€‚ IPVSå’ŒIPTABLESéƒ½åŸºäºnetfilterã€‚ IPVSæ¨¡å¼å’ŒIPTABLESæ¨¡å¼ä¹‹é—´çš„å·®å¼‚å¦‚ä¸‹ï¼š</p>

<p>IPVSä¸ºå¤§å‹é›†ç¾¤æä¾›äº†æ›´å¥½çš„å¯æ‰©å±•æ€§å’Œæ€§èƒ½ã€‚ï¼ˆè§„åˆ™çš„å­˜å‚¨æ–¹å¼ä½¿ç”¨çš„æ•°æ®ç»“æ„æ›´é«˜æ•ˆï¼‰
IPVSæ”¯æŒæ¯”iptablesæ›´å¤æ‚çš„è´Ÿè½½å¹³è¡¡ç®—æ³•ï¼ˆæœ€å°è´Ÿè½½ï¼Œæœ€å°‘è¿æ¥ï¼Œä½ç½®ï¼ŒåŠ æƒç­‰ï¼‰ã€‚
IPVSæ”¯æŒæœåŠ¡å™¨å¥åº·æ£€æŸ¥å’Œè¿æ¥é‡è¯•ç­‰ã€‚
å¦‚ä½•ä»¥ ipvs æ¨¡å¼ è¿è¡Œkube-proxy
ç¡®ä¿IPVSéœ€è¦å†…æ ¸æ¨¡å—</p>

<p>ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack_ipv4
1
2
3
4
5
æŸ¥çœ‹æ˜¯å¦è¢«åŠ è½½</p>

<p>$ ls /usr/lib/modules/3.10.0-514.el7.x86_64/kernel/net/netfilter/ipvs/ |grep  -e ip_vs
ip_vs_dh.ko
ip_vs_ftp.ko
ip_vs.ko
ip_vs_lblc.ko
ip_vs_lblcr.ko
ip_vs_lc.ko
ip_vs_nq.ko
ip_vs_pe_sip.ko
ip_vs_rr.ko
ip_vs_sed.ko
ip_vs_sh.ko
ip_vs_wlc.ko
ip_vs_wrr.ko</p>

<p>$ ls /usr/lib/modules/3.10.0-514.el7.x86_64/kernel/net/ipv4/netfilter/ |grep nf_conntrack_ipv4
nf_conntrack_ipv4.ko</p>

<p>æˆ–
lsmod | grep -e ip_vs -e nf_conntrack_ipv4</p>

<p>æˆ–
cut -f1 -d â€œ â€œ  /proc/modules | grep -e ip_vs -e nf_conntrack_ipv4</p>

<p>å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åŠ è½½</p>

<p>modprobe â€“ ip_vs
modprobe â€“ ip_vs_rr
modprobe â€“ ip_vs_wrr
modprobe â€“ ip_vs_sh
modprobe â€“ nf_conntrack_ipv4</p>

<p>åœ¨ä½¿ç”¨IPVSæ¨¡å¼ä¹‹å‰ï¼Œè¿˜åº”åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…ipsetç­‰è½¯ä»¶åŒ…ã€‚</p>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒKube-proxyåœ¨ä»¥kubeadméƒ¨ç½²çš„é›†ç¾¤ä¸­ä»¥iptablesæ¨¡å¼è¿è¡Œã€‚æŸ¥çœ‹æ—¥å¿—å¦‚ä¸‹</p>

<p>[root@master] ~$ kubectl logs kube-proxy-58j2k  -n kube-system
W0115 11:00:48.003306       1 server_others.go:295] Flag proxy-mode=â€â€ unknown, assuming iptables proxy
I0115 11:00:48.814060       1 server_others.go:148] Using iptables Proxier.
I0115 11:00:48.831178       1 server_others.go:178] Tearing down inactive rules.
I0115 11:00:51.566086       1 server.go:464] Version: v1.13.0</p>

<p>ä¿®æ”¹ConfigMapçš„kube-system/kube-proxyä¸­çš„config.conf</p>

<p>[root@master] ~$ kubectl edit cm kube-proxy -n kube-system
configmap/kube-proxy edited</p>

<p>#ä¿®æ”¹å¦‚ä¸‹
kind: MasterConfiguration
apiVersion: kubeadm.k8s.io/v1alpha1
â€¦
ipvs:
      excludeCIDRs: null
      minSyncPeriod: 0s
      scheduler: â€œâ€
      syncPeriod: 30s
    kind: KubeProxyConfiguration
    metricsBindAddress: 127.0.0.1:10249
    mode: â€œipvsâ€                  #ä¿®æ”¹</p>

<p>â€¦</p>

<p>ä¹‹åé‡å¯å„ä¸ªèŠ‚ç‚¹ä¸Šçš„kube-proxyï¼ˆåˆ é™¤åä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºï¼‰</p>

<p>[root@master] ~$ kubectl get pod -n kube-system | grep kube-proxy |awk â€˜{system(â€œkubectl delete pod â€œ$1â€ -n kube-systemâ€)}â€™
pod â€œkube-proxy-7dstjâ€ deleted
pod â€œkube-proxy-lx887â€ deleted
pod â€œkube-proxy-nfsb9â€ deleted
pod â€œkube-proxy-pkj44â€ deleted</p>

<p>[root@master] ~$ kubectl get pod -n kube-system | grep kube-proxy 
kube-proxy-47dh9                           1/1     Running   0          13s
kube-proxy-64qnx                           1/1     Running   0          17s
kube-proxy-cbm26                           1/1     Running   0          20s
kube-proxy-xnpnn                           1/1     Running   0          15s</p>

<p>å†æ¬¡æŸ¥çœ‹æ—¥å¿—ï¼Œå¯ä»¥çœ‹åˆ°ipvså·²ç»å¯ç”¨äº†</p>

<p>[root@master] ~$ kubectl logs kube-proxy-47dh9  -n kube-system
I0118 22:12:10.119829       1 server_others.go:189] Using ipvs Proxier.
W0118 22:12:10.120601       1 proxier.go:381] IPVS scheduler not specified, use rr by default
I0118 22:12:10.120714       1 server_others.go:216] Tearing down inactive rules.
I0118 22:12:10.158816       1 server.go:464] Version: v1.13.2
I0118 22:12:10.163081       1 conntrack.go:52] Setting nf_conntrack_max to 131072
I0118 22:12:10.172084       1 config.go:202] Starting service config controller
I0118 22:12:10.172149       1 controller_utils.go:1027] Waiting for caches to sync for service config controller
I0118 22:12:10.172184       1 config.go:102] Starting endpoints config controller
I0118 22:12:10.172188       1 controller_utils.go:1027] Waiting for caches to sync for endpoints config controller
I0118 22:12:10.272577       1 controller_utils.go:1034] Caches are synced for endpoints config controller
I0118 22:12:10.272629       1 controller_utils.go:1034] Caches are synced for service config controller</p>

<p>https://segmentfault.com/a/1190000016333317
http://www.10tiao.com/html/606/201807/2664605531/1.html</p>

<p>https://blog.csdn.net/fanren224/article/details/86548398</p>

<p>https://blog.csdn.net/qq_36807862/article/details/106068871</p>

<p>https://www.cnblogs.com/si-jie/archive/2020/06/21/13173831.html</p>
:ET