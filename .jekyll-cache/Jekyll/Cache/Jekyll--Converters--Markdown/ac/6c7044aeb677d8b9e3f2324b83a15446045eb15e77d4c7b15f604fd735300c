I"ì<p>2019 å¹´ 11 æœˆ 21 æ—¥ï¼Œgolang çš„å®˜æ–¹ github ä»“åº“æäº¤äº†ä¸€ä¸ª https://github.com/golang/go/issues/35750 ,è¯¥ issue æŒ‡å‡ºå¦‚æœåˆå§‹åŒ– http.Server ç»“æ„ä½“æ—¶æŒ‡å®šäº†ä¸€ä¸ªéç©ºçš„ ConnContext æˆå‘˜å‡½æ•°ï¼Œä¸”å¦‚æœåœ¨è¯¥å‡½æ•°å†…ä½¿ç”¨äº† context.Value æ–¹æ³•å†™å…¥æ•°æ®åˆ°ä¸Šä¸‹æ–‡å¹¶è¿”å›ï¼Œåˆ™ Context å°†ä¼šä»¥é“¾è¡¨çš„æ–¹å¼æ³„æ¼ã€‚</p>

<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆææ€–çš„ bugï¼Œå› ä¸ºä¸€æ–¹é¢ http.Server æ˜¯å‡ ä¹æ‰€æœ‰å¸‚é¢ä¸Šæµè¡Œ web æ¡†æ¶å¦‚ ginï¼Œbeego çš„åº•å±‚ä¾èµ–ï¼Œä¸€æ—¦å‘ç”Ÿé—®é¢˜åˆ™å…¨éƒ¨ä¸­æ‹›ï¼Œä¸€ä¸ªéƒ½è·‘ä¸äº†ï¼›å¦ä¸€æ–¹é¢åˆ™ ConnContext å‡½æ•°åœ¨æ¯ä¸€ä¸ªè¯·æ±‚åˆå§‹åŒ–æ—¶éƒ½ä¼šè¢«è°ƒç”¨ï¼Œè¿™æ„å‘³ç€å¦‚æœä¸€æ—¦å‘ç”Ÿæ³„æ¼ï¼Œåˆ™æœåŠ¡ç«¯ç¨‹åºå‡ ä¹ä¸€å®šä¼šæº¢å‡ºã€‚</p>

<p>æ®å®˜æ–¹å¼€å‘äººå‘˜è¡¨ç¤ºï¼Œè¯¥ bug äº 1.13 ç‰ˆæœ¬å¼•è¿›ï¼Œç›®å‰å·²ç»åœ¨ 1.13.5 ä¿®å¤ã€‚
<!-- more --></p>

<p>å½±å“èŒƒå›´
æ‰€æœ‰ 1.13~1.13.4 ç‰ˆæœ¬ï¼Œä½¿ç”¨åŸç”Ÿ http.Server æŒ‡å®šäº† ConnContext æˆå‘˜å‡½æ•°ï¼Œä¸”åœ¨è¯¥å‡½æ•°ä¸­ä½¿ç”¨ With*æ–¹æ³•å†™å…¥æ•°æ®å¹¶è¿”å›æ–° Contextï¼›æˆ–è€…ä½¿ç”¨äº†ä¸Šå±‚æ¡†æ¶çš„ç›¸åº”åŠŸèƒ½ã€‚</p>

<p>ç°è±¡
å†…å­˜æ ¹æ®è®¿é—®é‡æŒç»­ä¸Šå‡ï¼Œä¸” pprof åˆ†æå‘ç° cpu å¤§é‡è€—è´¹åœ¨ Context çš„åº•å±‚æ–¹æ³•ä¸Šã€‚</p>

<p>æ•…éšœåŸç†
é—®é¢˜å‡ºåœ¨ Server.Serve æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯ http.Server å¯åŠ¨çš„åº•å±‚å”¯ä¸€å…¥å£ï¼Œè´Ÿè´£å¾ªç¯ Accept è¿æ¥ä»¥åŠä¸ºæ¯ä¸ªæ–°è¿æ¥å¼€å¯ goroutine åšä¸‹ä¸€æ­¥å¤„ç†ã€‚</p>

<p>æ¥çœ‹çœ‹å‡ºé—®é¢˜çš„ä»£ç ï¼Œä¸ºäº†ç®€æ´è¿™é‡Œç•¥å»ä¸å¿…è¦ä»£ç :</p>

<p>type Server struct {
    â€¦
	// ConnContext optionally specifies a function that modifies
	// the context used for a new connection c. The provided ctx
	// is derived from the base context and has a ServerContextKey
	// value.
	ConnContext func(ctx context.Context, c net.Conn) context.Context
    â€¦
}</p>

<p>func (srv *Server) Serve(l net.Listener) error {
        â€¦
	baseCtx := context.Background()
        â€¦
	ctx := context.WithValue(baseCtx, ServerContextKey, srv)
	for {
		rw, e := l.Accept()
	        â€¦
		if cc := srv.ConnContext; cc != nil {
			ctx = cc(ctx, rw)
			if ctx == nil {
				panic(â€œConnContext returned nilâ€)
			}
		}
                â€¦
		go c.serve(ctx)
	}
}
æˆ‘ä»¬çŸ¥é“ Context æ˜¯ä¸€ä¸ªåå‘é“¾è¡¨ç»“æ„ï¼Œä»æœ€åˆçš„ Background é€šè¿‡å„ç§ With æ–¹æ³•æ¨å…¥è¡¨å¤´èŠ‚ç‚¹ï¼Œè€Œ With æ–¹æ³•è¿”å›çš„åˆ™æ˜¯æ–°çš„è¡¨å¤´èŠ‚ç‚¹ã€‚</p>

<p>ä»ä¸Šè¾¹çš„ä»£ç ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œå¦‚æœ srv.ConnContext ä¸ä¸ºç©ºï¼Œåˆ™æ¯æ¬¡ Accept è¿æ¥åéƒ½ä¼šè°ƒç”¨æ­¤å‡½æ•°å¹¶ä¼ å…¥ ctxï¼Œç„¶åå°†è¿”å›çš„ç»“æœå­˜å…¥ ctx ä¸­ï¼Œè¿™æ„å‘³ç€å¦‚æœåœ¨æ­¤å‡½æ•°ä¸­ä½¿ç”¨ With å‡½æ•°å†™å…¥èŠ‚ç‚¹å¹¶è¿”å›ï¼Œåˆ™è¯¥èŠ‚ç‚¹å°†è¢«ç¼“å­˜åˆ°å…¨å±€çš„ ctxï¼Œä»è€Œé€ æˆæ³„æ¼ã€‚</p>

<p>å¤ç°
è¿™ä¸ª bug éå¸¸å®¹æ˜“å¤ç°ï¼Œä¸‹é¢æˆ‘ä»¬å¤ç°ä¸€ä¸‹ï¼š</p>

<p>// go version:1.13.4</p>

<p>func main() {
	var count int32 = 0
	server := &amp;http.Server{
		Addr: â€œ:4444â€,
		Handler: http.HandlerFunc(func(rw http.ResponseWriter, req *http.Request) {
			rw.Header().Set(â€œConnectionâ€, â€œcloseâ€)
		}),
		ConnContext: func(ctx context.Context, c net.Conn) context.Context {
			atomic.AddInt32(&amp;count, 1)
			if c2 := ctx.Value(â€œcountâ€); c2 != nil {
				fmt.Printf(â€œå‘ç°äº†é—ç•™æ•°æ®: %d\nâ€, c2.(int32))
			}
			fmt.Printf(â€œæœ¬æ¬¡æ•°æ®: %d\nâ€, count)
			return context.WithValue(ctx, â€œcountâ€, count)
		},
	}
	gofunc() {
		panic(server.ListenAndServe())
	}()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>var err error

fmt.Println("ç¬¬ä¸€æ¬¡è¯·æ±‚")
_, err = http.Get("http://localhost:4444/")
if err != nil {
	panic(err)
}
fmt.Println("\nç¬¬äºŒæ¬¡è¯·æ±‚")

_, err = http.Get("http://localhost:4444/")
if err != nil {
	panic(err)
} } ç»“æœï¼š
</code></pre></div></div>

<p>ç¬¬ä¸€æ¬¡è¯·æ±‚
æœ¬æ¬¡æ•°æ®: 1</p>

<p>ç¬¬äºŒæ¬¡è¯·æ±‚
å‘ç°äº†é—ç•™æ•°æ®: 1
æœ¬æ¬¡æ•°æ®: 2
å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒä¸ªä»è¯·æ±‚çš„ Context ä¸­èƒ½è¯»å–åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚çš„ Context ä¸­å†™å…¥çš„æ•°æ®ï¼Œç¡®å®å‘ç”Ÿäº†æ³„æ¼ã€‚</p>

<p>ä¿®å¤
æˆ‘ä»¬é¦–å…ˆè¦ç†è§£ ConnContext è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ï¼ŒæŒ‰ç…§è®¾è®¡å®ƒåº”è¯¥æ˜¯ä¸ºæ¯ä¸ªè¯·æ±‚çš„ Context åšä¸€äº›åˆå§‹åŒ–å¤„ç†ï¼Œç„¶åå°†è¿™ä¸ªå¤„ç†åçš„ Context é“¾ä¼ å…¥go c.serve(ctx)ï¼Œè€Œä¸åº”è¯¥ç¼“å­˜åˆ°å…¨å±€ï¼›ä¸‹ä¸€ä¸ªè¯·æ±‚è¿‡æ¥ååº”è¯¥å°†åŸå§‹çš„ Context ä¼ å…¥ ConnContext è¿›è¡Œå¤„ç†ï¼Œä»è€Œå¾—åˆ°æ–°çš„ Context é“¾ã€‚</p>

<p>æ˜ç™½äº†ç›®çš„ï¼Œå†çœ‹çœ‹é—®é¢˜ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ç½ªé­ç¥¸é¦–åœ¨è¿™é‡Œ</p>

<p>ctx = cc(ctx, rw)
è¿™ä¸€è¡Œé”™è¯¯åœ°å°† cc æ–¹æ³•ç”Ÿæˆçš„æ–°é“¾ç¼“å­˜åˆ°äº†å…¨å±€ï¼Œå¯¼è‡´æ³„æ¼(ps:å®åœ¨æ˜¯æä¸æ‡‚ google çš„å¤§ç¥å±…ç„¶ä¼šçŠ¯è¿™ä¹ˆä½çº§ä¸”è‡´å‘½çš„é”™è¯¯â€¦)ã€‚</p>

<p>ä¿®å¤åçš„ä»£ç å¦‚ä¸‹ï¼š</p>

<p>func (srv *Server) Serve(l net.Listener) error {
	â€¦
	baseCtx := context.Background()
	â€¦
	ctx := context.WithValue(baseCtx, ServerContextKey, srv)
	for {
		rw, e := l.Accept()
		â€¦
		connCtx = ctx
		if cc := srv.ConnContext; cc != nil {
			connCtx = cc(connCtx, rw)
			if connCtx == nil {
				panic(â€œConnContext returned nilâ€)
			}
		}
		â€¦
		go c.serve(connCtx)
	}
}</p>

<p>https://github.com/golang/go/issues/35750</p>
:ET