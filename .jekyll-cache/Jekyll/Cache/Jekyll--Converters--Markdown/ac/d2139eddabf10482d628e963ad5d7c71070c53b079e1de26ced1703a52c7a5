I"ï¬<p>Network Time Protocol ï¼ˆç½‘ç»œæ—¶é—´åè®®ï¼‰æ˜¯ GNU/Linux ç³»ç»Ÿé€šè¿‡äº’è”ç½‘æ—¶é—´æœåŠ¡å™¨åŒæ­¥ç³»ç»Ÿè½¯ä»¶æ—¶é’Ÿçš„æœ€å¸¸è§æ–¹æ³•ã€‚è®¾è®¡æ—¶è€ƒè™‘åˆ°äº†å„ç§ç½‘ç»œå»¶è¿Ÿï¼Œé€šè¿‡å…¬å…±ç½‘ç»œåŒæ­¥æ—¶ï¼Œè¯¯å·®å¯ä»¥é™ä½åˆ°10æ¯«ç§’ä»¥å†…ï¼›é€šè¿‡æœ¬åœ°ç½‘ç»œåŒæ­¥æ—¶ï¼Œè¯¯å·®å¯ä»¥é™ä½åˆ° 1 æ¯«ç§’ã€‚
é…ç½®
ä¸»è¦çš„åå°è¿›ç¨‹æ˜¯ ntpd, å¯ä»¥é€šè¿‡ /etc/ntp.conf é…ç½®ã€‚è¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒæ‰‹å†Œ ntp.conf(5) å’Œç›¸å…³çš„ man {ntpd|ntp_auth|ntp_mon|ntp_acc|ntp_clock|ntp_misc}.</p>

<p>è¿æ¥åˆ° NTP æœåŠ¡å™¨
NTP æœåŠ¡å™¨é€šè¿‡ä¸€ä¸ªå±‚çº§ç³»ç»Ÿè¿›è¡Œåˆ†ç±»ï¼Œä¸åŒçš„å±‚çº§ç§°ä¸º strata: ç‹¬ç«‹çš„æ—¶é—´æºä¸ºstratum 0; ç›´æ¥è¿æ¥åˆ° stratum 0 çš„è®¾å¤‡ä¸º stratum 1;ç›´æ¥è¿æ¥åˆ° stratum 1 çš„æºä¸º stratum 2ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>

<p>æœåŠ¡å™¨çš„ stratum å¹¶ä¸èƒ½å®Œå…¨ç­‰åŒäºå®ƒçš„ç²¾åº¦å’Œå¯é åº¦ã€‚é€šå¸¸çš„æ—¶é—´åŒæ­¥éƒ½ä½¿ç”¨ stratum 2 æœåŠ¡å™¨ã€‚é€šè¿‡pool.ntp.org æœåŠ¡å™¨æˆ–è¿™ä¸ªé“¾æ¥ å¯ä»¥é€‰æ‹©æ¯”è¾ƒè¿‘çš„æœåŠ¡å™¨æ± ã€‚
æœ‰ç½‘ç»œè¿æ¥çš„æ—¶å€™å¯åŠ¨ntpd
ntpd å¯ä»¥ç”±ä½ çš„ç½‘ç»œç®¡ç†å™¨å¯åŠ¨, æ‰€ä»¥ntpè¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹åªæœ‰åœ¨è®¡ç®—æœºæœ‰ç½‘ç»œè¿æ¥çš„æ—¶å€™æ‰ä¼šå¯åŠ¨.
NetworkManager
é€šè¿‡ç½‘ç»œç®¡ç†å™¨çš„ dispatcher è„šæœ¬ï¼Œå¯ä»¥åŒç½‘ç»œè¿æ¥ä¸€èµ·å¯åŠ¨/ç»ˆæ­¢ntpd å®ˆæŠ¤è¿›ç¨‹ã€‚ å®‰è£…networkmanager-dispatcher-ntpd é¢„é…ç½®åŒ… ntpd service[broken link: invalid section] æ¥è®©ç½‘ç»œè¿æ¥åŒæ­¥ntpå¯åŠ¨/ç»ˆæ­¢.</p>

<p>Wicd
å¯¹ Wicd æ¥è¯´, è¦åœ¨ postconnect ç›®å½•åˆ›å»ºä¸€ä¸ªå¯åŠ¨è„šæœ¬ï¼Œåœ¨ predisconnect ç›®å½•åˆ›å»ºä¸€ä¸ªç»ˆæ­¢è„šæœ¬ã€‚ è®°ä½è¦æŠŠä»–ä»¬è®¾ä¸ºå¯æ‰§è¡Œçš„å“¦:</p>

<p>/etc/wicd/scripts/postconnect/ntpd
#!/bin/bash
systemctl start ntpd &amp;
/etc/wicd/scripts/predisconnect/ntpd
#!/bin/bash
systemctl stop ntpd &amp;
Synopsis
ntpd [ -aAbdgLmNPqx ] [ -c conffile ] [ -f driftfile ] [ -g ] [ -k keyfile ] [ -l logfile ] [ -N high ] [ -p pidfile ] [ -r broadcastdelay ] [ -s statsdir ] [ -t key ] [ -v variable ] [ -V variable ] [ -x ]
Description
The ntpd program is an operating system daemon which sets and maintains the system time of day in synchronism with Internet standard time servers. It is a complete implementation of the Network Time Protocol (NTP) version 4, but also retains compatibility with version 3, as defined by RFC-1305, and version 1 and 2, as defined by RFC-1059 and RFC-1119, respectively. ntpd does most computations in 64-bit floating point arithmetic and does relatively clumsy 64-bit fixed point operations only when necessary to preserve the ultimate precision, about 232 picoseconds. While the ultimate precision, is not achievable with ordinary workstations and networks of today, it may be required with future gigahertz CPU clocks and gigabit LANs.
How NTP Operates
The ntpd program operates by exchanging messages with one or more configured servers at designated poll intervals. When started, whether for the first or subsequent times, the program requires several exahanges from the majority of these servers so the signal processing and mitigation algorithms can accumulate and groom the data and set the clock. In order to protect the network from bursts, the initial poll interval for each server is delayed an interval randomized over 0-16s. At the default initial poll interval of 64s, several minutes can elapse before the clock is set. The initial delay to set the clock can be reduced using the iburst keyword with the server configuration command, as described on the Configuration Options page.</p>

<p>Most operating systems and hardware of today incorporate a time-of-year (TOY) chip to maintain the time during periods when the power is off. When the machine is booted, the chip is used to initialize the operating system time. After the machine has synchronized to a NTP server, the operating system corrects the chip from time to time. In case there is no TOY chip or for some reason its time is more than 1000s from the server time, ntpd assumes something must be terribly wrong and the only reliable action is for the operator to intervene and set the clock by hand. This causes ntpd to exit with a panic message to the system log. The -g option overrides this check and the clock will be set to the server time regardless of the chip time. However, and to protect against broken hardware, such as when the CMOS battery fails or the clock counter becomes defective, once the clock has been set, an error greater than 1000s will cause ntpd to exit anyway.
<!-- more -->
Under ordinariy conditions, ntpd adjusts the clock in small steps so that the timescale is effectively continuous and without discontinuities. Under conditions of extreme network congestion, the roundtrip delay jitter can exceed three seconds and the synchronization distance, which is equal to one-half the roundtrip delay plus error budget terms, can become very large. The ntpd algorithms discard sample offsets exceeding 128 ms, unless the interval during which no sample offset is less than 128 ms exceeds 900s. The first sample after that, no matter what the offset, steps the clock to the indicated time. In practice this reduces the false alarm rate where the clock is stepped in error to a vanishingly low incidence.</p>

<p>As the result of this behavior, once the clock has been set, it very rarely strays more than 128 ms, even under extreme cases of network path congestion and jitter. Sometimes, in particular when ntpd is first started, the error might exceed 128 ms. This may on occasion cause the clock to be set backwards if the local clock time is more than 128 s in the future relative to the server. In some applications, this behavior may be unacceptable. If the -x option is included on the command line, the clock will never be stepped and only slew corrections will be used.</p>

<p>The issues should be carefully explored before deciding to use the -x option. The maximum slew rate possible is limited to 500 parts-per-million (PPM) as a consequence of the correctness principles on which the NTP protocol and algorithm design are based. As a result, the local clock can take a long time to converge to an acceptable offset, about 2,000 s for each second the clock is outside the acceptable range. During this interval the local clock will not be consistent with any other network clock and the system cannot be used for distributed applications that require correctly synchronized network time.</p>

<p>In spite of the above precautions, sometimes when large frequency errors are present the resulting time offsets stray outside the 128-ms range and an eventual step or slew time correction is required. If following such a correction the frequency error is so large that the first sample is outside the acceptable range, ntpd enters the same state as when the ntp.drift file is not present. The intent of this behavior is to quickly correct the frequency and restore operation to the normal tracking mode. In the most extreme cases (time.ien.it comes to mind), there may be occasional step/slew corrections and subsequent frequency corrections. It helps in these cases to use the burst keyword when configuring the server.</p>

<p>Frequency Discipline
The ntpd behavior at startup depends on whether the frequency file, usually ntp.drift, exists. This file contains the latest estimate of clock frequency error. When the ntpd is started and the file does not exist, the ntpd enters a special mode designed to quickly adapt to the particular system clock oscillator time and frequency error. This takes approximately 15 minutes, after which the time and frequency are set to nominal values and the ntpd enters normal mode, where the time and frequency are continuously tracked relative to the server. After one hour the frequency file is created and the current frequency offset written to it. When the ntpd is started and the file does exist, the ntpd frequency is initialized from the file and enters normal mode immediately. After that the current frequency offset is written to the file at hourly intervals.</p>

<p>Operating Modes
ntpd can operate in any of several modes, including symmetric active/passive, client/server broadcast/multicast and manycast, as described in the Association Management page. It normally operates continuously while monitoring for small changes in frequency and trimming the clock for the ultimate precision. However, it can operate in a one-time mode where the time is set from an external server and frequency is set from a previously recorded frequency file. A broadcast/multicast or manycast client can discover remote servers, compute server-client propagation delay correction factors and configure itself automatically. This makes it possible to deploy a fleet of workstations without specifying configuration details specific to the local environment.</p>

<p>By default, ntpd runs in continuous mode where each of possibly several external servers is polled at intervals determined by an intricate state machine. The state machine measures the incidental roundtrip delay jitter and oscillator frequency wander and determines the best poll interval using a heuristic algorithm. Ordinarily, and in most operating environments, the state machine will start with 64s intervals and eventually increase in steps to 1024s. A small amount of random variation is introduced in order to avoid bunching at the servers. In addition, should a server become unreachable for some time, the poll interval is increased in steps to 1024s in order to reduce network overhead.</p>

<p>In some cases it may not be practical for ntpd to run continuously. A common workaround has been to run the ntpdate program from a cron job at designated times. However, this program does not have the crafted signal processing, error checking and mitigation algorithms of ntpd. The -q option is intended for this purpose. Setting this option will cause ntpd to exit just after setting the clock for the first time. The procedure for initially setting the clock is the same as in continuous mode; most applications will probably want to specify the iburst keyword with the server configuration command. With this keyword a volley of messages are exchanged to groom the data and the clock is set in about a minute. If nothing is heard after a couple of minutes, the daemon times out and exits. After a suitable period of mourning, the ntpdate program may be retired.</p>

<p>When kernel support is available to discipline the clock frequency, which is the case for stock Solaris, Tru64, Linux and FreeBSD, a useful feature is available to discipline the clock frequency. First, ntpd is run in continuous mode with selected servers in order to measure and record the intrinsic clock frequency offset in the frequency file. It may take some hours for the frequency and offset to settle down. Then the ntpd is stopped and run in one-time mode as required. At each startup, the frequency is read from the file and initializes the kernel frequency.</p>

<p>Poll Interval Control
This version of NTP includes an intricate state machine to reduce the network load while maintaining a quality of synchronization consistent with the observed jitter and wander. There are a number of ways to tailor the operation in order enhance accuracy by reducing the interval or to reduce network overhead by increasing it. However, the user is advised to carefully consider the consequenses of changing the poll adjustment range from the default minimum of 64 s to the default maximum of 1,024 s. The default minimum can be changed with the tinker minpoll command to a value not less than 16 s. This value is used for all configured associations, unless overriden by the minpoll option on the configuration command. Note that most device drivers will not operate properly if the poll interval is less than 64 s and that the broadcast server and manycast client associations will also use the default, unless overriden.</p>

<p>In some cases involving dial up or toll services, it may be useful to increase the minimum interval to a few tens of minutes and maximum interval to a day or so. Under normal operation conditions, once the clock discipline loop has stabilized the interval will be increased in steps from the minumum to the maximum. However, this assumes the intrinsic clock frequency error is small enough for the discipline loop correct it. The capture range of the loop is 500 PPM at an interval of 64s decreasing by a factor of two for each doubling of interval. At a minimum of 1,024 s, for example, the capture range is only 31 PPM. If the intrinsic error is greater than this, the drift file ntp.drift will have to be specially tailored to reduce the residual error below this limit. Once this is done, the drift file is automatically updated once per hour and is available to initialize the frequency on subsequent daemon restarts.</p>

<p>The huff-nâ€™-puff filter
In scenarios where a considerable amount of data are to be downloaded or uploaded over telephone modems, timekeeping quality can be seriously degraded. This occurs because the differential delays on the two directions of transmission can be quite large. In many cases the apparent time errors are so large as to exceed the step threshold and a step correction can occur during and after the data transfer is in progress.</p>

<p>The huff-nâ€™-puff filter is designed to correct the apparent time offset in these cases. It depends on knowledge of the propagation delay when no other traffic is present. In common scenarios this occurs during other than work hours. The filter maintains a shift register that remembers the minimum delay over the most recent interval measured usually in hours. Under conditions of severe delay, the filter corrects the apparent offset using the sign of the offset and the difference between the apparent delay and minimum delay. The name of the filter reflects the negative (huff) and positive (puff) correction, which depends on the sign of the offset.</p>

<p>The filter is activated by the tinker command and huffpuff keyword, as described in the Miscellaneous Options page.</p>

<p>Notes
If NetInfo support is built into ntpd, then ntpd will attempt to read its configuration from the NetInfo if the default ntp.conf file cannot be read and no file is specified by the -c option.</p>

<p>Various internal ntpd variables can be displayed and configuration options altered while the ntpd is running using the ntpq and ntpdc utility programs.</p>

<p>When ntpd starts it looks at the value of umask, and if zero ntpd will set the umask to 022.</p>

<p>Command Line Options
-a
Enable authentication mode (default).
-A
Disable authentication mode.
-b
Synchronize using NTP broadcast messages.
-c conffile
Specify the name and path of the configuration file. (Disable netinfo?)
-d
Specify debugging mode. This flag may occur multiple times, with each occurrence indicating greater detail of display.
-D level
Specify debugging level directly.
-f driftfile
Specify the name and path of the drift file.
-g
Normally, ntpd exits if the offset exceeds the sanity limit, which is 1000 s by default. If the sanity limit is set to zero, no sanity checking is performed and any offset is acceptable. This option overrides the limit and allows the time to be set to any value without restriction; however, this can happen only once. After that, ntpd will exit if the limit is exceeded. This option can be used with the -q option.
-k keyfile
Specify the name and path of the file containing the NTP authentication keys.
-l logfile
Specify the name and path of the log file. The default is the system log facility.
-L
Listen to virtual IPs.
-m
Synchronize using NTP multicast messages on the IP multicast group address 224.0.1.1 (requires multicast kernel).
-n
Donâ€™t fork.
-N priority
To the extent permitted by the operating system, run the ntpd at a high priority.
-p pidfile
Specify the name and path to record the ntpdâ€™s process ID.
-P
Override the priority limit set by the operating system. Not recommended for sissies.
-q
Exit the ntpd just after the first time the clock is set. This behavior mimics that of the ntpdate program, which is to be retired. The -g and -x options can be used with this option.
-r broadcastdelay
Specify the default propagation delay from the broadcast/multicast server and this computer. This is necessary only if the delay cannot be computed automatically by the protocol.
-s statsdir
Specify the directory path for files created by the statistics facility.
-t key
Add a key number to the trusted key list.
-v variable
-V variable
Add a system variable listed by default.
-x
Normally, the time is slewed if the offset is less than the step threshold, which is 128 ms by default, and stepped if above the threshold. This option forces the time to be slewed in all cases. If the step threshold is set to zero, all offsets are stepped, regardless of value and regardless of the -x option. In general, this is not a good idea, as it bypasses the clock state machine which is designed to cope with large time and frequency errors Note: Since the slew rate is limited to 0.5 ms/s, each second of adjustment requires an amortization interval of 2000 s. Thus, an adjustment of many seconds can take hours or days to amortize. This option can be used with the -q option.
The Configuration File
Ordinarily, ntpd reads the ntp.conf configuration file at startup time in order to determine the synchronization sources and operating modes. It is also possible to specify a working, although limited, configuration entirely on the command line, obviating the need for a configuration file. This may be particularly useful when the local host is to be configured as a broadcast/multicast client, with all peers being determined by listening to broadcasts at run time.</p>

<p>Usually, the configuration file is installed in the /etc directory, but could be installed elsewhere (see the -c conffile command line option). The file format is similar to other Unix configuration files - comments begin with a # character and extend to the end of the line; blank lines are ignored.</p>

<table>
  <tbody>
    <tr>
      <td>Configuration commands consist of an initial keyword followed by a list of arguments, some of which may be optional, separated by whitespace. Commands may not be continued over multiple lines. Arguments may be host names, host addresses written in numeric, dotted-quad form, integers, floating point numbers (when specifying times in seconds) and text strings. Optional arguments are delimited by [ ] in the following descriptions, while alternatives are separated by</td>
      <td>. The notation [ â€¦ ] means an optional, indefinite repetition of the last item before the [ â€¦ ].</td>
    </tr>
  </tbody>
</table>

<p>Configuration Options
Authentication Options
Monitoring Options
Access Control Options
Reference Clock Options
Miscellaneous Options</p>

<p>Files
/etc/ntp.conf - the default name of the configuration file 
/etc/ntp.drift - the default name of the drift file 
/etc/ntp.keys - the default name of the key file
Bugs
ntpd has gotten rather fat. While not huge, it has gotten larger than might be desirable for an elevated-priority ntpd running on a workstation, particularly since many of the fancy features which consume the space were designed more with a busy primary server, rather than a high stratum workstation in mind.</p>

<p>å¦‚ä½•è®¾ç½®Linux Time Zone</p>

<p>åœ¨Linuxä¸‹glibcæä¾›äº†æˆ‘ä»¬äº‹å…ˆç¼–è¯‘å¥½çš„è®¸å¤štimezoneæ–‡ä»¶, ä»–ä»¬å°±æ”¾åœ¨/usr/share/zoneinfoè¿™ä¸ªç›®å½•ä¸‹,è¿™é‡ŒåŸºæœ¬æ¶µç›–äº†å¤§éƒ¨åˆ†çš„å›½å®¶å’ŒåŸå¸‚
CET          Europe/  HST        MET          Portugal  UCTåœ¨è¿™é‡Œé¢æˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°è‡ªå·±æ‰€åœ¨åŸå¸‚çš„time zoneæ–‡ä»¶. é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³æŸ¥çœ‹å¯¹äºæ¯ä¸ªtime zoneå½“å‰çš„æ—¶é—´æˆ‘ä»¬å¯ä»¥ç”¨zdumpå‘½ä»¤
ä»£ç :</p>
<h1 id="zdump-hongkong">zdump Hongkong</h1>
<p>Hongkong  Fri Jul  6 06:13:57 2007 HKTé‚£ä¹ˆæˆ‘ä»¬åˆæ€ä¹ˆæ¥å‘Šè¯‰ç³»ç»Ÿæˆ‘ä»¬æ‰€åœ¨time zoneæ˜¯å“ªä¸ªå‘¢? æ–¹æ³•æœ‰å¾ˆå¤š,è¿™é‡Œä¸¾å‡ºä¸¤ç§</p>

<p>ç¬¬ä¸€ä¸ªå°±æ˜¯ä¿®æ”¹/etc/localtimeè¿™ä¸ªæ–‡ä»¶,è¿™ä¸ªæ–‡ä»¶å®šä¹‰äº†æˆ‘ä¹ˆæ‰€åœ¨çš„local time zone.
æˆ‘ä»¬å¯ä»¥åœ¨/usr/share/zoneinfoä¸‹æ‰¾åˆ°æˆ‘ä»¬çš„time zoneæ–‡ä»¶ç„¶åæ‹·è´å»åˆ°/etc/localtimezone(æˆ–è€…åšä¸ªsymbolic link)</p>

<p>å‡è®¾æˆ‘ä»¬ç°åœ¨çš„time zoneæ˜¯BST(ä¹Ÿå°±æ˜¯è‹±å›½çš„å¤ä»¤æ—¶é—´,UTC+1)
ä»£ç :</p>
<h1 id="date">date</h1>
<p>Thu Jul  5 23:33:40 BST 2007æˆ‘ä»¬æƒ³æŠŠtime zoneæ¢æˆä¸Šæµ·æ‰€åœ¨çš„æ—¶åŒºå°±å¯ä»¥è¿™ä¹ˆåš
ä»£ç :</p>
<h1 id="ln--sf-usrsharezoneinfoposixasiashanghai-etclocaltime">ln -sf /usr/share/zoneinfo/posix/Asia/Shanghai /etc/localtime</h1>
<h1 id="date-1">date</h1>
<p>Fri Jul  6 06:35:52 CST 2007
è¿™æ ·æ—¶åŒºå°±æ”¹è¿‡æ¥äº†(æ³¨æ„æ—¶é—´ä¹Ÿåšäº†ç›¸åº”çš„è°ƒæ•´)</p>

<p>ç¬¬äºŒç§æ–¹æ³•ä¹Ÿå°±è®¾ç½®TZç¯å¢ƒå˜é‡çš„å€¼. è®¸å¤šç¨‹åºå’Œå‘½ä»¤éƒ½ä¼šç”¨åˆ°è¿™ä¸ªå˜é‡çš„å€¼. TZçš„å€¼å¯ä»¥æœ‰å¤šç§æ ¼å¼,æœ€ç®€å•çš„è®¾ç½®æ–¹æ³•å°±æ˜¯ä½¿ç”¨tzselectå‘½ä»¤
ä»£ç :</p>
<h1 id="tzselect">tzselect</h1>
<p>â€¦
TZ=â€™America/Los_Angelesâ€™;export TZtzselect
ä¼šè®©ä½ é€‰æ‹©æ‰€åœ¨çš„å›½å®¶å’ŒåŸå¸‚(æˆ‘çœç•¥äº†è¿™äº›æ­¥éª¤),æœ€åè¾“å‡ºç›¸åº”çš„TZå˜é‡çš„å€¼.é‚£ä¹ˆå¦‚æœä½ è®¾ç½®äº†TZçš„å€¼ä¹‹åæ—¶åŒºå°±åˆä¼šå‘ç”Ÿå˜åŒ–</p>

<p>ä»£ç :</p>
<h1 id="date-2">date</h1>
<p>Thu Jul  5 15:48:11 PDT 2007
é€šè¿‡è¿™ä¸¤ä¸ªä¾‹å­æˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°TZå˜é‡çš„å€¼ä¼šoverride /etc/localtime. ä¹Ÿå°±æ˜¯è¯´å½“TZå˜é‡æ²¡æœ‰å®šä¹‰çš„æ—¶å€™ç³»ç»Ÿæ‰ä½¿ç”¨/etc/localtimeæ¥ç¡®å®štime zone. æ‰€ä»¥ä½ æƒ³æ°¸ä¹…ä¿®æ”¹time zoneçš„è¯é‚£ä¹ˆå¯ä»¥æŠŠTZå˜é‡çš„è®¾ç½®å†™å…¥/etc/profileé‡Œ</p>

<p>å¥½äº†ç°åœ¨æˆ‘ä»¬çŸ¥é“æ€ä¹ˆè®¾ç½®æ—¶åŒºäº†,ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•è®¾ç½®Linuxçš„æ—¶é—´å§</p>

<ol>
  <li>Real Time Clock(RTC) and System Clock</li>
</ol>

<p>è¯´é“è®¾ç½®æ—¶é—´è¿™é‡Œè¿˜è¦æ˜ç¡®å¦å¤–ä¸€ä¸ªæ¦‚å¿µå°±æ˜¯åœ¨ä¸€å°è®¡ç®—æœºä¸Šæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ—¶é’Ÿ:ä¸€ä¸ªç§°ä¹‹ä¸ºç¡¬ä»¶æ—¶é—´æ—¶é’Ÿ(RTC),è¿˜æœ‰ä¸€ä¸ªç§°ä¹‹ä¸ºç³»ç»Ÿæ—¶é’Ÿ(System Clock)</p>

<p>ç¡¬ä»¶æ—¶é’Ÿæ˜¯æŒ‡åµŒåœ¨ä¸»æ¿ä¸Šçš„ç‰¹æ®Šçš„ç”µè·¯, å®ƒçš„å­˜åœ¨å°±æ˜¯å¹³æ—¶æˆ‘ä»¬å…³æœºä¹‹åè¿˜å¯ä»¥è®¡ç®—æ—¶é—´çš„åŸå› 
ç³»ç»Ÿæ—¶é’Ÿå°±æ˜¯æ“ä½œç³»ç»Ÿçš„kernelæ‰€ç”¨æ¥è®¡ç®—æ—¶é—´çš„æ—¶é’Ÿ. å®ƒä»1970å¹´1æœˆ1æ—¥00:00:00 UTCæ—¶é—´åˆ°ç›®å‰ä¸ºæ­¢ç§’æ•°æ€»å’Œçš„å€¼ åœ¨Linuxä¸‹ç³»ç»Ÿæ—¶é—´åœ¨å¼€æœºçš„æ—¶å€™ä¼šå’Œç¡¬ä»¶æ—¶é—´åŒæ­¥(synchronization),ä¹‹åä¹Ÿå°±å„è‡ªç‹¬ç«‹è¿è¡Œäº†</p>

<p>é‚£ä¹ˆæ—¢ç„¶ä¸¤ä¸ªæ—¶é’Ÿç‹¬è‡ªè¿è¡Œ,é‚£ä¹ˆæ—¶é—´ä¹…äº†å¿…ç„¶å°±ä¼šäº§ç”Ÿè¯¯å·®äº†,ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­
ä»£ç :</p>
<h1 id="date-3">date</h1>
<p>Fri Jul  6 00:27:13 BST 2007</p>
<h1 id="hwclock-show">hwclock â€“show</h1>
<p>Fri 06 Jul 2007 12:27:17 AM BST  -0.968931 seconds 
é€šè¿‡hwclock â€“show å‘½ä»¤æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æœºå™¨ä¸Šçš„ç¡¬ä»¶æ—¶é—´(always in local time zone), æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå’Œç³»ç»Ÿæ—¶é—´è¿˜æ˜¯æœ‰ä¸€å®šçš„è¯¯å·®çš„, é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æŠŠä»–ä»¬åŒæ­¥</p>

<p>å¦‚æœæˆ‘ä»¬æƒ³è¦æŠŠç¡¬ä»¶æ—¶é—´è®¾ç½®æˆç³»ç»Ÿæ—¶é—´æˆ‘ä»¬å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤
ä»£ç :</p>
<h1 id="hwclock-hctosys">hwclock â€“hctosys</h1>
<p>åä¹‹,æˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠç³»ç»Ÿæ—¶é—´è®¾ç½®æˆç¡¬ä»¶æ—¶é—´
ä»£ç :</p>
<h1 id="hwclock-systohc">hwclock â€“systohc</h1>
<p>é‚£ä¹ˆå¦‚æœæƒ³è®¾ç½®ç¡¬ä»¶æ—¶é—´æˆ‘ä»¬å¯ä»¥å¼€æœºçš„æ—¶å€™åœ¨BIOSé‡Œè®¾å®š.ä¹Ÿå¯ä»¥ç”¨hwclockå‘½ä»¤
ä»£ç :</p>
<h1 id="hwclock-set-datemmddyy-hhmmss">hwclock â€“set â€“date=â€mm/dd/yy hh:mm:ssâ€</h1>
<p>å¦‚æœæƒ³è¦ä¿®æ”¹ç³»ç»Ÿæ—¶é—´é‚£ä¹ˆç”¨dateå‘½ä»¤å°±æœ€ç®€å•äº†
ä»£ç :</p>
<h1 id="date--s-ddmmyyyy-hhmmss">date -s â€œdd/mm/yyyy hh:mm:ssâ€</h1>

<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å¦‚ä½•è®¾ç½®ç³»ç»Ÿå’Œç¡¬ä»¶çš„æ—¶é—´. ä½†é—®é¢˜æ˜¯å¦‚æœè¿™ä¸¤ä¸ªæ—¶é—´éƒ½ä¸å‡†ç¡®äº†æ€ä¹ˆåŠ? é‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨äº’è”ç½‘ä¸Šæ‰¾åˆ°ä¸€ä¸ªå¯ä»¥æä¾›æˆ‘ä»¬å‡†ç¡®æ—¶é—´çš„æœåŠ¡å™¨ç„¶åé€šè¿‡ä¸€ç§åè®®æ¥åŒæ­¥æˆ‘ä»¬çš„ç³»ç»Ÿæ—¶é—´,é‚£ä¹ˆè¿™ä¸ªåè®®å°±æ˜¯NTPäº†. æ³¨æ„æ¥ä¸‹å»æˆ‘ä»¬æ‰€è¦è¯´çš„åŒæ­¥å°±éƒ½æ˜¯æŒ‡ç³»ç»Ÿæ—¶é—´å’Œç½‘ç»œæœåŠ¡å™¨ä¹‹é—´çš„åŒæ­¥äº†</p>

<ol>
  <li>è®¾ç½®NTP Serverå‰çš„å‡†å¤‡</li>
</ol>

<p>å…¶å®è¿™ä¸ªæ ‡é¢˜åº”è¯¥æ”¹ä¸ºè®¾ç½®â€NTP Relay Serverâ€å‰çš„å‡†å¤‡æ›´åŠ åˆé€‚. å› ä¸ºä¸è®ºæˆ‘ä»¬çš„è®¡ç®—æœºé…ç½®å¤šå¥½è¿è¡Œæ—¶é—´ä¹…äº†éƒ½ä¼šäº§ç”Ÿè¯¯å·®,æ‰€ä»¥ä¸è¶³ä»¥ç»™äº’è”ç½‘ä¸Šçš„å…¶ä»–æœåŠ¡å™¨åšNTP Server. çœŸæ­£èƒ½å¤Ÿç²¾ç¡®åœ°æµ‹ç®—æ—¶é—´çš„è¿˜æ˜¯åŸå­é’Ÿ. ä½†ç”±äºåŸå­é’Ÿååˆ†çš„æ˜‚è´µ,åªæœ‰å°‘éƒ¨åˆ†ç»„ç»‡æ‹¥æœ‰, ä»–ä»¬è¿æ¥åˆ°è®¡ç®—æœºä¹‹åå°±æˆäº†ä¸€å°çœŸæ­£çš„NTP Server. è€Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯è¿æ¥åˆ°è¿™äº›æœåŠ¡å™¨ä¸ŠåŒæ­¥æˆ‘ä»¬ç³»ç»Ÿçš„æ—¶é—´,ç„¶åæŠŠæˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨åšæˆNTP Relay Serverå†ç»™äº’è”ç½‘æˆ–è€…æ˜¯å±€åŸŸç½‘å†…çš„ç”¨æˆ·æä¾›åŒæ­¥æœåŠ¡</p>

<p>å¥½äº†,å‰é¢è®²äº†ä¸€å¤§å †ç†è®º,ç°åœ¨æˆ‘ä»¬æ¥åŠ¨æ‰‹å®è·µä¸€ä¸‹å§. æ¶è®¾ä¸€ä¸ªNTP Relay Serverå…¶å®éå¸¸ç®€å•,æˆ‘ä»¬å…ˆæŠŠéœ€è¦çš„RPMåŒ…è£…ä¸Š
æ˜¯å¦å·²ç»å®‰è£…äº†NTPåŒ…å¯ä»¥ç”¨è¿™æ¡å‘½ä»¤æ¥ç¡®å®šï¼š</p>

<p>[root@NTPser ~]# rpm -qa | grep ntp
ntp-4.2.2p1-9.el5_4.1
chkfontpath-1.10.1-1.1
å‡ºç°ä»¥ä¸Šä»£ç åˆ™è¡¨ç¤ºå·²å®‰è£…NTPåŒ…ï¼Œå¦åˆ™ç”¨ä¸‹é¢æ–¹æ³•å®‰è£…ï¼š
ä»£ç :</p>

<h1 id="rpm--ivh-ntp-422p1-5el5rpm">rpm -ivh ntp-4.2.2p1-5.el5.rpm</h1>
<p>é‚£ä¹ˆç¬¬ä¸€æ­¥æˆ‘ä»¬å°±è¦æ‰¾åˆ°åœ¨äº’è”ç½‘ä¸Šç»™æˆ‘ä»¬æä¾›åŒæ­¥æœåŠ¡çš„NTP Server</p>

<p>http://www.pool.ntp.orgæ˜¯NTPçš„å®˜æ–¹ç½‘ç«™,åœ¨è¿™ä¸Šé¢æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç¦»æˆ‘ä»¬åŸå¸‚æœ€è¿‘çš„NTP Server. NTPå»ºè®®æˆ‘ä»¬ä¸ºäº†ä¿éšœæ—¶é—´çš„å‡†ç¡®æ€§,æœ€å°‘æ‰¾ä¸¤ä¸ªä¸ªNTP Server
é‚£ä¹ˆæ¯”å¦‚åœ¨è‹±å›½çš„è¯å°±å¯ä»¥é€‰æ‹©ä¸‹é¢ä¸¤ä¸ªæœåŠ¡å™¨
0.uk.pool.ntp.org
1.uk.pool.ntp.org</p>

<p>å®ƒçš„ä¸€èˆ¬æ ¼å¼éƒ½æ˜¯number.country.pool.ntp.org</p>

<p>ç¬¬äºŒæ­¥è¦åšçš„å°±æ˜¯åœ¨æ‰“å¼€NTPæœåŠ¡å™¨ä¹‹å‰å…ˆå’Œè¿™äº›æœåŠ¡å™¨åšä¸€ä¸ªåŒæ­¥,ä½¿å¾—æˆ‘ä»¬æœºå™¨çš„æ—¶é—´å°½é‡æ¥è¿‘æ ‡å‡†æ—¶é—´. 
è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç”¨ntpdateå‘½ä»¤æ‰‹åŠ¨æ›´æ–°æ—¶é—´
ä»£ç :</p>
<h1 id="ntpdate-0ukpoolntporg">ntpdate 0.uk.pool.ntp.org</h1>
<p>6 Jul 01:21:49 ntpdate[4528]: step time server 213.222.193.35 offset -38908.575181 sec</p>
<h1 id="ntpdate-0poolntporg">ntpdate 0.pool.ntp.org</h1>
<p>6 Jul 01:21:56 ntpdate[4530]: adjust time server 213.222.193.35 offset -0.000065 sec
å‡å¦‚ä½ çš„æ—¶é—´å·®çš„å¾ˆç¦»è°±çš„è¯ç¬¬ä¸€æ¬¡ä¼šçœ‹åˆ°è°ƒæ•´çš„å¹…åº¦æ¯”è¾ƒå¤§,æ‰€ä»¥ä¿é™©èµ·è§å¯ä»¥è¿è¡Œä¸¤æ¬¡. é‚£ä¹ˆä¸ºä»€ä¹ˆåœ¨æ‰“å¼€NTPæœåŠ¡ä¹‹å‰å…ˆè¦æ‰‹åŠ¨è¿è¡ŒåŒæ­¥å‘¢?</p>
<ol>
  <li>å› ä¸ºæ ¹æ®NTPçš„è®¾ç½®,å¦‚æœä½ çš„ç³»ç»Ÿæ—¶é—´æ¯”æ­£ç¡®æ—¶é—´è¦å¿«çš„è¯é‚£ä¹ˆNTPæ˜¯ä¸ä¼šå¸®ä½ è°ƒæ•´çš„,æ‰€ä»¥è¦ä¹ˆä½ æŠŠæ—¶é—´è®¾ç½®å›å»,è¦ä¹ˆå…ˆåšä¸€ä¸ªæ‰‹åŠ¨åŒæ­¥</li>
  <li>
    <p>å½“ä½ çš„æ—¶é—´è®¾ç½®å’ŒNTPæœåŠ¡å™¨çš„æ—¶é—´ç›¸å·®å¾ˆå¤§çš„æ—¶å€™,NTPä¼šèŠ±ä¸Šè¾ƒé•¿ä¸€æ®µæ—¶é—´è¿›è¡Œè°ƒæ•´.æ‰€ä»¥æ‰‹åŠ¨åŒæ­¥å¯ä»¥å‡å°‘è¿™æ®µæ—¶é—´</p>
  </li>
  <li>é…ç½®å’Œè¿è¡ŒNTP Server</li>
</ol>

<p>ç°åœ¨æˆ‘ä»¬å°±æ¥åˆ›å»ºNTPçš„é…ç½®æ–‡ä»¶äº†, å®ƒå°±æ˜¯/etc/ntp.conf. æˆ‘ä»¬åªéœ€è¦åŠ å…¥ä¸Šé¢çš„NTP Serverå’Œä¸€ä¸ªdriftfileå°±å¯ä»¥äº†
ä»£ç :</p>
<h1 id="vi-etcntpconf">vi /etc/ntp.conf</h1>

<p>server 210.72.145.44     #è¿™æ˜¯ä¸­å›½å›½å®¶æˆæ—¶ä¸­å¿ƒçš„IP
server 0.uk.pool.ntp.org
server 1.uk.pool.ntp.org</p>

<p>fudge 127.127.1.0 stratum 0  stratum  è¿™è¡Œæ˜¯æ—¶é—´æœåŠ¡å™¨çš„å±‚æ¬¡ã€‚è®¾ä¸º0åˆ™ä¸ºé¡¶çº§ï¼Œå¦‚æœè¦å‘åˆ«çš„NTPæœåŠ¡å™¨æ›´æ–°æ—¶é—´ï¼Œè¯·ä¸è¦æŠŠå®ƒè®¾ä¸º0</p>

<p>driftfile /var/lib/ntp/ntp.drift  éå¸¸çš„ç®€å•. æ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯åŠ¨NTP Server,å¹¶ä¸”è®¾ç½®å…¶åœ¨å¼€æœºåè‡ªåŠ¨è¿è¡Œ
ä»£ç :</p>
<h1 id="etcinitdntpd-start">/etc/init.d/ntpd start</h1>
<h1 id="chkconfig-level-35-ntpd-on">chkconfig â€“level 35 ntpd on</h1>

<ol>
  <li>æŸ¥çœ‹NTPæœåŠ¡çš„è¿è¡ŒçŠ¶å†µ</li>
</ol>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å¯åŠ¨äº†NTPçš„æœåŠ¡,ä½†æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿæ—¶é—´åˆ°åº•å’ŒæœåŠ¡å™¨åŒæ­¥äº†æ²¡æœ‰å‘¢? ä¸ºæ­¤NTPæä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„æŸ¥çœ‹å·¥å…·: ntpq (NTP query)</p>

<p>æˆ‘å»ºè®®å¤§å®¶åœ¨æ‰“å¼€NTPæœåŠ¡å™¨åå°±å¯ä»¥è¿è¡Œntpqå‘½ä»¤æ¥ç›‘æµ‹æœåŠ¡å™¨çš„è¿è¡Œ.è¿™é‡Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨watchå‘½ä»¤æ¥æŸ¥çœ‹ä¸€æ®µæ—¶é—´å†…æœåŠ¡å™¨å„é¡¹æ•°å€¼çš„å˜åŒ–
ä»£ç :</p>
<h1 id="watch-ntpq--p">watch ntpq -p</h1>
<p>Every 2.0s: ntpq -p                                  Sat Jul  7 00:41:45 2007</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> remote           refid      st t when poll reach   delay   offset  jitter =========================================================== +193.60.199.75   193.62.22.98     2 u   52   64  377    8.578   10.203 289.032 *mozart.musicbox 192.5.41.41      2 u   54   64  377   19.301  -60.218 292.411
</code></pre></div></div>

<p>ç°åœ¨æˆ‘å°±æ¥è§£é‡Šä¸€ä¸‹å…¶ä¸­çš„å«ä¹‰</p>

<p>remote: å®ƒæŒ‡çš„å°±æ˜¯æœ¬åœ°æœºå™¨æ‰€è¿æ¥çš„è¿œç¨‹NTPæœåŠ¡å™¨
      refid: å®ƒæŒ‡çš„æ˜¯ç»™è¿œç¨‹æœåŠ¡å™¨(e.g. 193.60.199.75)æä¾›æ—¶é—´åŒæ­¥çš„æœåŠ¡å™¨
          st: è¿œç¨‹æœåŠ¡å™¨çš„å±‚çº§åˆ«ï¼ˆstratumï¼‰. ç”±äºNTPæ˜¯å±‚å‹ç»“æ„,æœ‰é¡¶ç«¯çš„æœåŠ¡å™¨,å¤šå±‚çš„Relay Serverå†åˆ°å®¢æˆ·ç«¯. æ‰€ä»¥æœåŠ¡å™¨ä»é«˜åˆ°ä½çº§åˆ«å¯ä»¥è®¾å®šä¸º1-16. ä¸ºäº†å‡ç¼“è´Ÿè·å’Œç½‘ç»œå µå¡,åŸåˆ™ä¸Šåº”è¯¥é¿å…ç›´æ¥è¿æ¥åˆ°çº§åˆ«ä¸º1çš„æœåŠ¡å™¨çš„.
            t: è¿™ä¸ªâ€¦..æˆ‘ä¹Ÿä¸çŸ¥é“å•¥æ„æ€^_^
    when: æˆ‘ä¸ªäººæŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªè®¡æ—¶å™¨ç”¨æ¥å‘Šè¯‰æˆ‘ä»¬è¿˜æœ‰å¤šä¹…æœ¬åœ°æœºå™¨å°±éœ€è¦å’Œè¿œç¨‹æœåŠ¡å™¨è¿›è¡Œä¸€æ¬¡æ—¶é—´åŒæ­¥
       poll: æœ¬åœ°æœºå’Œè¿œç¨‹æœåŠ¡å™¨å¤šå°‘æ—¶é—´è¿›è¡Œä¸€æ¬¡åŒæ­¥(å•ä½ä¸ºç§’). åœ¨ä¸€å¼€å§‹è¿è¡ŒNTPçš„æ—¶å€™è¿™ä¸ªpollå€¼ä¼šæ¯”è¾ƒå°,é‚£æ ·å’ŒæœåŠ¡å™¨åŒæ­¥çš„é¢‘ç‡ä¹Ÿå°±å¢åŠ äº†,å¯ä»¥å°½å¿«è°ƒæ•´åˆ°æ­£ç¡®çš„æ—¶é—´èŒƒå›´.ä¹‹åpollå€¼ä¼šé€æ¸å¢å¤§,åŒæ­¥çš„é¢‘ç‡ä¹Ÿå°±ä¼šç›¸åº”å‡å°
    reach: è¿™æ˜¯ä¸€ä¸ªå…«è¿›åˆ¶å€¼,ç”¨æ¥æµ‹è¯•èƒ½å¦å’ŒæœåŠ¡å™¨è¿æ¥.æ¯æˆåŠŸè¿æ¥ä¸€æ¬¡å®ƒçš„å€¼å°±ä¼šå¢åŠ 
    delay: ä»æœ¬åœ°æœºå‘é€åŒæ­¥è¦æ±‚åˆ°æœåŠ¡å™¨çš„round trip time
    offset: è¿™æ˜¯ä¸ªæœ€å…³é”®çš„å€¼, å®ƒå‘Šè¯‰äº†æˆ‘ä»¬æœ¬åœ°æœºå’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ—¶é—´å·®åˆ«. offsetè¶Šæ¥è¿‘äº0,æˆ‘ä»¬å°±å’ŒæœåŠ¡å™¨çš„æ—¶é—´è¶Šæ¥è¿‘
     jitter: è¿™æ˜¯ä¸€ä¸ªç”¨æ¥åšç»Ÿè®¡çš„å€¼. å®ƒç»Ÿè®¡äº†åœ¨ç‰¹å®šä¸ªè¿ç»­çš„è¿æ¥æ•°é‡Œoffsetçš„åˆ†å¸ƒæƒ…å†µ. ç®€å•åœ°è¯´è¿™ä¸ªæ•°å€¼çš„ç»å¯¹å€¼è¶Šå°æˆ‘ä»¬å’ŒæœåŠ¡å™¨çš„æ—¶é—´å°±è¶Šç²¾ç¡®</p>

<p>é‚£ä¹ˆå¤§å®¶ç»†å¿ƒçš„è¯å°±ä¼šå‘ç°ä¸¤ä¸ªé—®é¢˜: ç¬¬ä¸€æˆ‘ä»¬è¿æ¥çš„æ˜¯0.uk.pool.ntp.orgä¸ºä»€ä¹ˆå’Œremote serverä¸ä¸€æ ·? ç¬¬äºŒé‚£ä¸ªæœ€å‰é¢çš„+å’Œ*éƒ½æ˜¯ä»€ä¹ˆæ„æ€å‘¢?</p>

<p>ç¬¬ä¸€ä¸ªé—®é¢˜ä¸éš¾ç†è§£,å› ä¸ºNTPæä¾›ç»™æˆ‘ä»¬çš„æ˜¯ä¸€ä¸ªcluster serveræ‰€ä»¥æ¯æ¬¡è¿æ¥çš„å¾—åˆ°çš„æœåŠ¡å™¨éƒ½æœ‰å¯èƒ½æ˜¯ä¸ä¸€æ ·.åŒæ ·è¿™ä¹Ÿå‘Šè¯‰æˆ‘ä»¬äº†åœ¨æŒ‡å®šNTP Serverçš„æ—¶å€™åº”è¯¥ä½¿ç”¨hostnameè€Œä¸æ˜¯IP</p>

<p>ç¬¬äºŒä¸ªé—®é¢˜å’Œç¬¬ä¸€ä¸ªç›¸å…³,æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šçš„æœåŠ¡å™¨å°±æ˜¯ä¸ºäº†åœ¨å‘ç”Ÿé—®é¢˜çš„æ—¶å€™å…¶ä»–çš„æœåŠ¡å™¨è¿˜å¯ä»¥æ­£å¸¸åœ°ç»™æˆ‘ä»¬æä¾›æœåŠ¡.é‚£ä¹ˆå¦‚ä½•çŸ¥é“è¿™äº›æœåŠ¡å™¨çš„çŠ¶æ€å‘¢? è¿™å°±æ˜¯ç¬¬ä¸€ä¸ªè®°å·ä¼šå‘Šè¯‰æˆ‘ä»¬çš„ä¿¡æ¯</p>

<ul>
  <li>å®ƒå‘Šè¯‰æˆ‘ä»¬è¿œç«¯çš„æœåŠ¡å™¨å·²ç»è¢«ç¡®è®¤ä¸ºæˆ‘ä»¬çš„ä¸»NTP Server,æˆ‘ä»¬ç³»ç»Ÿçš„æ—¶é—´å°†ç”±è¿™å°æœºå™¨æ‰€æä¾›</li>
  <li>å®ƒå°†ä½œä¸ºè¾…åŠ©çš„NTP Serverå’Œå¸¦æœ‰<em>å·çš„æœåŠ¡å™¨ä¸€èµ·ä¸ºæˆ‘ä»¬æä¾›åŒæ­¥æœåŠ¡. å½“</em>å·æœåŠ¡å™¨ä¸å¯ç”¨æ—¶å®ƒå°±å¯ä»¥æ¥ç®¡
ï¼ è¿œç¨‹æœåŠ¡å™¨è¢«clustering algorithmè®¤ä¸ºæ˜¯ä¸åˆæ ¼çš„NTP Server
x è¿œç¨‹æœåŠ¡å™¨ä¸å¯ç”¨</li>
</ul>

<p>äº†è§£è¿™äº›ä¹‹åæˆ‘ä»¬å°±å¯ä»¥å®æ—¶ç›‘æµ‹æˆ‘ä»¬ç³»ç»Ÿçš„æ—¶é—´åŒæ­¥çŠ¶å†µäº†</p>

<ol>
  <li>NTPå®‰å…¨è®¾ç½®</li>
</ol>

<p>è¿è¡Œä¸€ä¸ªNTP Serverä¸éœ€è¦å ç”¨å¾ˆå¤šçš„ç³»ç»Ÿèµ„æº,æ‰€ä»¥ä¹Ÿä¸ç”¨ä¸“é—¨é…ç½®ç‹¬ç«‹çš„æœåŠ¡å™¨,å°±å¯ä»¥ç»™è®¸å¤šclientæä¾›æ—¶é—´åŒæ­¥æœåŠ¡, ä½†æ˜¯ä¸€äº›åŸºæœ¬çš„å®‰å…¨è®¾ç½®è¿˜æ˜¯å¾ˆæœ‰å¿…è¦çš„
é‚£ä¹ˆè¿™é‡Œä¸€ä¸ªå¾ˆç®€å•çš„æ€è·¯å°±æ˜¯ç¬¬ä¸€æˆ‘ä»¬åªå…è®¸å±€åŸŸç½‘å†…ä¸€éƒ¨åˆ†çš„ç”¨æˆ·è¿æ¥åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨. ç¬¬äºŒä¸ªå°±æ˜¯è¿™äº›clientä¸èƒ½ä¿®æ”¹æˆ‘ä»¬æœåŠ¡å™¨ä¸Šçš„æ—¶é—´</p>

<p>å…³äºæƒé™è®¾å®šéƒ¨åˆ† 
æƒé™çš„è®¾å®šä¸»è¦ä»¥ restrict è¿™ä¸ªå‚æ•°æ¥è®¾å®šï¼Œä¸»è¦çš„è¯­æ³•ä¸ºï¼š 
restrict IPåœ°å€ mask å­ç½‘æ©ç  å‚æ•° 
å…¶ä¸­ IP å¯ä»¥æ˜¯IPåœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯ default ï¼Œdefault å°±æ˜¯æŒ‡æ‰€æœ‰çš„IP 
å‚æ•°æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š 
ignoreã€€ï¼šå…³é—­æ‰€æœ‰çš„ NTP è”æœºæœåŠ¡ 
nomodifyï¼šå®¢æˆ·ç«¯ä¸èƒ½æ›´æ”¹æœåŠ¡ç«¯çš„æ—¶é—´å‚æ•°ï¼Œä½†æ˜¯å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æœåŠ¡ç«¯è¿›è¡Œç½‘ç»œæ ¡æ—¶ã€‚ 
notrust ï¼šå®¢æˆ·ç«¯é™¤éé€šè¿‡è®¤è¯ï¼Œå¦åˆ™è¯¥å®¢æˆ·ç«¯æ¥æºå°†è¢«è§†ä¸ºä¸ä¿¡ä»»å­ç½‘ 
noquery ï¼šä¸æä¾›å®¢æˆ·ç«¯çš„æ—¶é—´æŸ¥è¯¢ 
æ³¨æ„ï¼šå¦‚æœå‚æ•°æ²¡æœ‰è®¾å®šï¼Œé‚£å°±è¡¨ç¤ºè¯¥ IP (æˆ–å­ç½‘)æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼</p>

<p>åœ¨/etc/ntp.confæ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥ç”¨restrictå…³é”®å­—æ¥é…ç½®ä¸Šé¢çš„è¦æ±‚</p>

<p>é¦–å…ˆæˆ‘ä»¬å¯¹äºé»˜è®¤çš„clientæ‹’ç»æ‰€æœ‰çš„æ“ä½œ
ä»£ç :
restrict default kod nomodify notrap nopeer noquery</p>

<p>ç„¶åå…è®¸æœ¬æœºåœ°å€ä¸€åˆ‡çš„æ“ä½œ
ä»£ç :
restrict 127.0.0.1</p>

<p>æœ€åæˆ‘ä»¬å…è®¸å±€åŸŸç½‘å†…æ‰€æœ‰clientè¿æ¥åˆ°è¿™å°æœåŠ¡å™¨åŒæ­¥æ—¶é—´.ä½†æ˜¯æ‹’ç»è®©ä»–ä»¬ä¿®æ”¹æœåŠ¡å™¨ä¸Šçš„æ—¶é—´
ä»£ç :
restrict 192.168.1.0 mask 255.255.255.0 nomodify</p>

<p>æŠŠè¿™ä¸‰æ¡åŠ å…¥åˆ°/etc/ntp.confä¸­å°±å®Œæˆäº†æˆ‘ä»¬çš„ç®€å•é…ç½®. NTPè¿˜å¯ä»¥ç”¨keyæ¥åšauthentication,è¿™é‡Œå°±ä¸è¯¦ç»†ä»‹ç»äº†</p>

<ol>
  <li>NTP clientçš„è®¾ç½®</li>
</ol>

<p>åšåˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€å°è‡ªå·±çš„Relay Server.å¦‚æœæˆ‘ä»¬æƒ³è®©å±€åŸŸç½‘å†…çš„å…¶ä»–clientéƒ½è¿›è¡Œæ—¶é—´åŒæ­¥çš„è¯é‚£ä¹ˆæˆ‘ä»¬å°±éƒ½åº”è¯¥ç…§æ ·å†æ­å»ºä¸€å°Relay Server,ç„¶åæŠŠæ‰€æœ‰çš„clientéƒ½æŒ‡å‘è¿™ä¸¤å°æœåŠ¡å™¨(æ³¨æ„ä¸è¦æŠŠæ‰€æœ‰çš„clientéƒ½æŒ‡å‘Internetä¸Šçš„æœåŠ¡å™¨). åªè¦åœ¨clientçš„/etc/ntp.confåŠ ä¸Šè¿™ä½ è‡ªå·±çš„æœåŠ¡å™¨å°±å¯ä»¥äº†
ä»£ç :
server ntp1.leonard.com
server ntp2.leonard.com</p>

<p>LINUXå®¢æˆ·ç«¯ä½¿ç”¨
ntpdate 172.30.218.114 
æ¥å‘NTPæœåŠ¡å™¨åŒæ­¥è‡ªå·±çš„æ—¶é—´
å…¶å®ƒLINUXå¦‚æœä»…ä½œä¸ºåªå®¢æˆ·ç«¯çš„è¯,åˆ™ä¸èƒ½å¯åŠ¨ntpdæœåŠ¡!å¦åˆ™æ— æ³•è¿è¡Œntpdata æœåŠ¡å™¨åœ°å€ æ¥åŒæ­¥æ—¶é—´
ä¹‹åå¯ä»¥ä½¿ç”¨cronæˆ–ä¿®æ”¹crontabæ–‡ä»¶å®šæœŸå‘NTPæœåŠ¡å™¨æ›´æ–°æ—¶é—´,å¹¶ç”¨</p>
<h1 id="hwclock-systohc-1">hwclock â€“systohc</h1>
<p>å°†ç³»ç»Ÿæ—¶é—´è®¾ç½®ä¸ºç¡¬ä»¶æ—¶é—´</p>

<ol>
  <li>
    <p>ä¸€äº›è¡¥å……å’Œæ‹¾é—ï¼ˆæŒºé‡è¦ï¼‰</p>
  </li>
  <li>
    <p>é…ç½®æ–‡ä»¶ä¸­çš„driftfileæ˜¯ä»€ä¹ˆ?
æˆ‘ä»¬æ¯ä¸€ä¸ªsystem clockçš„é¢‘ç‡éƒ½æœ‰å°å°çš„è¯¯å·®,è¿™ä¸ªå°±æ˜¯ä¸ºä»€ä¹ˆæœºå™¨è¿è¡Œä¸€æ®µæ—¶é—´åä¼šä¸ç²¾ç¡®. NTPä¼šè‡ªåŠ¨æ¥ç›‘æµ‹æˆ‘ä»¬æ—¶é’Ÿçš„è¯¯å·®å€¼å¹¶äºˆä»¥è°ƒæ•´.ä½†é—®é¢˜æ˜¯è¿™æ˜¯ä¸€ä¸ªå†—é•¿çš„è¿‡ç¨‹,æ‰€ä»¥å®ƒä¼šæŠŠè®°å½•ä¸‹æ¥çš„è¯¯å·®å…ˆå†™å…¥driftfile.è¿™æ ·å³ä½¿ä½ é‡æ–°å¼€æœºä»¥åä¹‹å‰çš„è®¡ç®—ç»“æœä¹Ÿå°±ä¸ä¼šä¸¢å¤±äº†</p>
  </li>
  <li>
    <p>å¦‚ä½•åŒæ­¥ç¡¬ä»¶æ—¶é’Ÿ?
NTPä¸€èˆ¬åªä¼šåŒæ­¥system clock. ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¹Ÿè¦åŒæ­¥RTC(hwclock)çš„è¯é‚£ä¹ˆåªéœ€è¦æŠŠä¸‹é¢çš„é€‰é¡¹æ‰“å¼€å°±å¯ä»¥äº†
ä»£ç :</p>
    <h1 id="vi-etcsysconfigntpd">vi /etc/sysconfig/ntpd</h1>
    <p>SYNC_HWCLOCK=yes</p>
  </li>
</ol>

<p>3ã€åˆ©ç”¨crontabè®©LINUX NTPå®šæ—¶æ›´æ–°æ—¶é—´
æ³¨ï¼šè®©linuxè¿è¡Œntpdateæ›´æ–°æ—¶é—´æ—¶ï¼Œlinuxä¸èƒ½å¼€å¯NTPæœåŠ¡ï¼Œå¦åˆ™ä¼šæç¤ºç«¯å£è¢«å ç”¨ï¼šå¦‚ä¸‹
[root@ESXI ~]# ntpdate 1.rhel.pool.ntp.org                               <br />
20 May 09:34:14 ntpdate[6747]: the NTP socket is in use, exiting</p>

<p>crontabæ–‡ä»¶é…ç½®ç®€è¦è¯´æ˜
å‘½ä»¤æ ¼å¼çš„å‰ä¸€éƒ¨åˆ†æ˜¯å¯¹æ—¶é—´çš„è®¾å®šï¼Œåé¢ä¸€éƒ¨åˆ†æ˜¯è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚æ—¶é—´çš„è®¾å®šæˆ‘ä»¬æœ‰ä¸€å®šçš„çº¦å®šï¼Œå‰é¢äº”ä¸ª<em>å·ä»£è¡¨äº”ä¸ªæ•°å­—ï¼Œæ•°å­—çš„å–å€¼èŒƒå›´å’Œå«ä¹‰å¦‚ä¸‹ï¼š
åˆ†é’Ÿã€€(0-59)
å°æ™‚ã€€(0-23)
æ—¥æœŸã€€(1-31)
æœˆä»½ã€€(1-12)
æ˜ŸæœŸã€€(0-6)//0ä»£è¡¨æ˜ŸæœŸå¤©
é™¤äº†æ•°å­—è¿˜æœ‰å‡ ä¸ªä¸ªç‰¹æ®Šçš„ç¬¦å·å°±æ˜¯â€œ</em>â€ã€â€œ/â€å’Œâ€œ-â€ã€â€œ,â€ï¼Œâ€œ<em>â€ä»£è¡¨æ‰€æœ‰çš„å–å€¼èŒƒå›´å†…çš„æ•°å­—ï¼Œâ€œ/â€ä»£è¡¨æ¯çš„æ„æ€,â€œ</em>/5â€è¡¨ç¤ºæ¯5ä¸ªå•ä½ï¼Œâ€œ-â€ä»£è¡¨ä»æŸä¸ªæ•°å­—åˆ°æŸä¸ªæ•°å­—,â€œ,â€åˆ†å¼€å‡ ä¸ªç¦»æ•£çš„æ•°å­—ã€‚ä»¥ä¸‹ä¸¾å‡ ä¸ªä¾‹å­è¯´æ˜é—®é¢˜ï¼š
æ¯å¤©æ—©ä¸Š6ç‚¹ï¼š
0 6 * * *  command
æ¯ä¸¤ä¸ªå°æ—¶ï¼š
0 */2 * * *  command
æ™šä¸Š11ç‚¹åˆ°æ—©ä¸Š8ç‚¹ä¹‹é—´æ¯ä¸¤ä¸ªå°æ—¶ï¼Œæ—©ä¸Šå…«ç‚¹ï¼š
0 23-7/2,8 * * * command
æ¯ä¸ªæœˆçš„4å·å’Œæ¯ä¸ªç¤¼æ‹œçš„ç¤¼æ‹œä¸€åˆ°ç¤¼æ‹œä¸‰çš„æ—©ä¸Š11ç‚¹ï¼š
0 11 4 * 1-3 command 
1æœˆ1æ—¥æ—©ä¸Š4ç‚¹ï¼š
0 4 1 1 * command</p>

<p>3.3ã€è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨æœåŠ¡
è¿è¡Œsetupæˆ–å…¶å®ƒæœåŠ¡è®¾ç½®å·¥å…·ï¼Œå°†crondæœåŠ¡å‹¾é€‰ä¸Š 
chkconfig â€“level 2345 crond on  å®šä¹‰åœ¨è¿™å‡ ä¸ªç³»ç»Ÿè¿è¡Œçº§åˆ«ä¸Šå¯ç”¨crond (ç³»ç»Ÿå®‰è£…å®Œé»˜è®¤å°±æ˜¯è¿™ä¸ªè®¾ç½®)
<strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong></p>

<p>10.NTPå®¢æˆ·ç«¯çš„è®¾ç½®</p>

<p>ä¸€ã€LINUXåšä¸ºå®¢æˆ·ç«¯è‡ªåŠ¨åŒæ­¥æ—¶é—´
å¦‚æœæƒ³å®šæ—¶è¿›è¡Œæ—¶é—´æ ¡å‡†ï¼Œå¯ä»¥ä½¿ç”¨crondæœåŠ¡æ¥å®šæ—¶æ‰§è¡Œã€‚
ç¼–è¾‘ /etc/crontab æ–‡ä»¶
åŠ å…¥ä¸‹é¢ä¸€è¡Œï¼š</p>

<p>30 8 * * * root /usr/sbin/ntpdate 192.168.0.1; /sbin/hwclock -w  #192.168.0.1æ˜¯NTPæœåŠ¡å™¨çš„IPåœ°å€
ç„¶åé‡å¯crondæœåŠ¡
service crond restart 
è¿™æ ·ï¼Œæ¯å¤© 8:30 Linux ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨çš„è¿›è¡Œç½‘ç»œæ—¶é—´æ ¡å‡†ã€‚</p>

<p>äºŒã€WINDOWS éœ€è¦æ‰“å¼€windows timeæœåŠ¡å’ŒRPCçš„äºŒä¸ªæœåŠ¡
å¦‚æœåœ¨æ‰“å¼€windows time æœåŠ¡ï¼Œæ—¶æŠ¥ é”™è¯¯1058ï¼Œè¿›è¡Œä¸‹é¢æ“ä½œ 
1.è¿è¡Œ cmd è¿›å…¥å‘½ä»¤è¡Œï¼Œç„¶åé”®å…¥
w32tm /register  è¿›è¡Œæ³¨å†Œ
æ­£ç¡®çš„å“åº”ä¸ºï¼šW32Time æˆåŠŸæ³¨å†Œã€‚</p>

<p>2.å¦‚æœä¸Šä¸€æ­¥æ­£ç¡®ï¼Œç”¨ net start â€œwindows timeâ€ æˆ– net start w32time å¯åŠ¨æœåŠ¡ã€‚</p>

<p>11.å…¶å®ƒé€ æˆæ— æ³•æˆåŠŸæ›´æ–°çš„åŸå› ï¼š
1ã€å®¢æˆ·ç«¯çš„æ—¥æœŸå¿…é¡»è¦è®¾ç½®æ­£ç¡®ï¼Œä¸èƒ½è¶…å‡ºæ­£å¸¸æ—¶é—´24å°æ—¶ï¼Œä¸ç„¶ä¼šå› ä¸ºå®‰å…¨åŸå› è¢«æ‹’ç»æ›´æ–°ã€‚å…¶æ¬¡å®¢æˆ·ç«¯çš„æ—¶åŒºå¿…é¡»è¦è®¾ç½®å¥½ï¼Œä»¥ç¡®ä¿ä¸ä¼šæ›´æ–°æˆå…¶å®ƒæ—¶åŒºçš„æ—¶é—´ã€‚
2ã€fudge 127.127.1.0 stratum 10 å¦‚æœæ˜¯LINUXåšä¸ºNTPæœåŠ¡å™¨ï¼Œstratum(å±‚çº§)çš„å€¼ä¸èƒ½å¤ªå¤§ï¼Œå¦‚æœè¦å‘ä¸Šçº§NTPæ›´æ–°å¯ä»¥è®¾æˆ2
3ã€LINUXçš„NTPæœåŠ¡å™¨å¿…é¡»è®°å¾—å°†ä»ä¸Šçº§NTPæ›´æ–°çš„æ—¶é—´ä»ç³»ç»Ÿæ—¶é—´å†™åˆ°ç¡¬ä»¶é‡Œå» hwclock â€“systohc 
     NTPä¸€èˆ¬åªä¼šåŒæ­¥system clock. ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¹Ÿè¦åŒæ­¥RTC(hwclock)çš„è¯é‚£ä¹ˆåªéœ€è¦æŠŠä¸‹é¢çš„é€‰é¡¹æ‰“å¼€å°±å¯ä»¥äº†
      ä»£ç :
      # vi /etc/sysconfig/ntpd
      SYNC_HWCLOCK=yes
4ã€Linuxå¦‚æœå¼€å¯äº†NTPæœåŠ¡ï¼Œåˆ™ä¸èƒ½æ‰‹åŠ¨è¿è¡Œntpdateæ›´æ–°æ—¶é—´ï¼ˆä¼šæŠ¥ç«¯å£è¢«å ç”¨ï¼‰ï¼Œå®ƒåªèƒ½æ ¹æ®/etc/ntp.conf é‡Œserver å­—æ®µåçš„æœåŠ¡å™¨åœ°å€æŒ‰ä¸€å®šæ—¶é—´é—´éš”è‡ªåŠ¨å‘ä¸Šçº§NTPæœåŠ¡å™¨æ›´æ–°æ—¶é—´ã€‚å¯ä»¥è¿è¡Œå‘½ä»¤ ntpstat æŸ¥çœ‹æ¯æ¬¡æ›´æ–°é—´éš”å¦‚ï¼š
[root@ESXI ~]# ntpstat
synchronised to NTP server (210.72.145.44) at stratum 2    #æœ¬NTPæœåŠ¡å™¨å±‚æ¬¡ä¸º2ï¼Œå·²å‘210.72.145.44 NTPåŒæ­¥è¿‡
   time correct to within 93 ms                                               #æ—¶é—´æ ¡æ­£åˆ°ç›¸å·®93msä¹‹å†…
   polling server every 1024 s                                                 #æ¯1024ç§’ä¼šå‘ä¸Šçº§NTPè½®è¯¢æ›´æ–°ä¸€æ¬¡æ—¶é—´</p>

<p>ç½‘ç»œæ—¶é—´åè®®ï¼ˆNTPï¼‰æ˜¯ä¸€ç§é€šè¿‡å› ç‰¹ç½‘æœåŠ¡äºè®¡ç®—æœºæ—¶é’Ÿçš„æ—¶é—´åŒæ­¥åè®®ã€‚å®ƒæä¾›äº†ä¸€ç§åŒæ­¥æ—¶é—´æœºåˆ¶ï¼Œèƒ½åœ¨åºå¤§è€Œå¤æ‚å¤šæ ·çš„å› ç‰¹ç½‘ä¸­ç”¨å…‰é€Ÿè°ƒæ•´æ—¶é—´åˆ†é…ã€‚å®ƒä½¿ç”¨çš„æ˜¯å¯è¿”å›æ—¶é—´è®¾è®¡ï¼Œåˆ†å¸ƒå¼å­ç½‘å†…çš„æ—¶é—´æœåŠ¡å™¨ï¼Œèƒ½è‡ªæˆ‘ç»„ç»‡æ“ä½œã€åˆ†å±‚ç®¡ç†é…ç½®ï¼Œç»è¿‡æœ‰çº¿æˆ–æ— çº¿æ–¹å¼åŒæ­¥å­ç½‘å†…çš„é€»è¾‘æ—¶é’Ÿè¾¾åˆ°å›½å®¶æ ‡å‡†æ—¶é—´ã€‚æ­¤å¤–ï¼Œé€šè¿‡æœ¬åœ°è·¯ç”±é€‰æ‹©è¿ç®—æ³•åˆ™åŠæ—¶é—´åå°ç¨‹åºï¼ŒæœåŠ¡å™¨å¯ä»¥é‡æ–°åˆ†é…æ ‡å‡†æ—¶é—´ã€‚
NTP çš„è®¾è®¡å¸¦æ¥äº†ä¸‰ç§äº§å“â€”â€”æ—¶é’Ÿåç§»ã€æ—¶é—´å»¶è¿ŸåŠå·®é‡ï¼Œå®ƒä»¬éƒ½ä¸æŒ‡å®šå‚è€ƒæ—¶é’Ÿç›¸å…³è”ã€‚æ—¶é’Ÿåç§»è¡¨ç¤ºè°ƒæ•´æœ¬åœ°æ—¶é’Ÿä¸å‚è€ƒæ—¶é’Ÿç›¸ä¸€è‡´è€Œäº§ç”Ÿçš„åå·®æ•°ï¼›æ—¶é—´å»¶è¿Ÿè¡¨ç¤ºåœ¨æŒ‡å®šæ—¶é—´å†…å‘é€æ¶ˆæ¯åˆ°è¾¾å‚è€ƒæ—¶é’Ÿçš„å»¶æ—¶æ—¶é—´ï¼›å·®é‡è¡¨ç¤ºäº†ç›¸å¯¹äºå‚è€ƒæ—¶é’Ÿæœ¬åœ°æ—¶é’Ÿçš„æœ€å¤§åå·®é”™è¯¯ã€‚å› ä¸ºå¤§å¤šæ•°ä¸»æœºæ—¶é—´æœåŠ¡å™¨é€šè¿‡å…¶å®ƒå¯¹ç­‰æ—¶é—´æœåŠ¡å™¨è¾¾åˆ°åŒæ­¥ï¼Œæ‰€ä»¥è¿™ä¸‰ç§äº§å“ä¸­çš„æ¯ä¸€ç§éƒ½æœ‰ä¸¤ä¸ªç»„æˆéƒ¨åˆ†ï¼šå…¶ä¸€æ˜¯ç”±å¯¹ç­‰å†³å®šçš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†æ˜¯ç›¸å¯¹äºåŸå§‹æ ‡å‡†æ—¶é—´çš„å‚è€ƒæ¥æºè€Œè¨€ï¼›å…¶äºŒæ˜¯ç”±ä¸»æœºè¡¡é‡çš„éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†æ˜¯ç›¸å¯¹äºå¯¹ç­‰è€Œè¨€ã€‚æ¯ä¸€éƒ¨åˆ†åœ¨åè®®ä¸­éƒ½æ˜¯ç‹¬ç«‹ç»´æŒçš„ï¼Œä»è€Œå¯ä»¥ä½¿é”™è¯¯æ§åˆ¶å’Œå­ç½‘æœ¬èº«çš„ç®¡ç†æ“ä½œå˜å¾—å®¹æ˜“ã€‚å®ƒä»¬ä¸ä»…æä¾›äº†åç§»å’Œå»¶è¿Ÿçš„ç²¾å¯†æµ‹é‡ï¼Œè€Œä¸”æä¾›äº†æ˜ç¡®çš„æœ€å¤§é”™è¯¯èŒƒå›´ï¼Œè¿™æ ·ç”¨æˆ·æ¥å£ä¸ä½†å¯ä»¥å†³å®šæ—¶é—´ï¼Œè€Œä¸”å¯ä»¥å†³å®šæ—¶é—´çš„å‡†ç¡®åº¦ã€‚
NTP æºäºæ—¶é—´åè®®å’Œ ICMP æ—¶é—´æ ‡å¿—æ¶ˆæ¯ï¼Œä½†å…¶è®¾è®¡æ›´å¼ºè°ƒç²¾ç¡®åº¦å’Œå¥å£®æ€§ä¸¤ä¸ªæ–¹é¢ï¼Œå³ä½¿æ˜¯åœ¨æœ‰å¤šè·¯ç½‘å…³ã€å»¶è¿Ÿå·®é‡åŠä¸å¯é ç½‘ç»œä¸Šä½¿ç”¨æ—¶ã€‚å½“å‰ä½¿ç”¨çš„æœ€æ–°ç‰ˆæ˜¯ NTPv3 ï¼Œå®ƒä¸ä»¥å‰çš„ç‰ˆæœ¬å…¼å®¹ã€‚</p>

<p>https://www.pool.ntp.org/en/</p>

<p>åœ¨ROSå®˜æ–¹å®‰è£…é¡¹ç›®ä¸­è™½ç„¶æ²¡æœ‰åŒ…æ‹¬NTPï¼Œä½†ä¸ºäº†ç¼©å°PCé—´é€šä¿¡ä¸­çš„ROS Timeçš„è¯¯
å·®ï¼Œä¸‹é¢æˆ‘ä»¬è®¾ç½®NTP4ã€‚è®¾ç½®æ–¹æ³•æ˜¯å®‰è£…chronyä¹‹åç”¨ntpdateå‘½ä»¤æŒ‡å®šntpæœåŠ¡å™¨å³
å¯ã€‚è¿™æ ·ä¸€æ¥ä¼šè¡¨ç¤ºæœåŠ¡å™¨å’Œå½“å‰è®¡ç®—æœºä¹‹é—´çš„æ—¶é—´è¯¯å·®ï¼Œè¿›è€Œä¼šè°ƒåˆ°æœåŠ¡å™¨çš„æ—¶é—´ã€‚è¿™
å°±æ˜¯é€šè¿‡ç»™ä¸åŒçš„PCæŒ‡å®šç›¸åŒçš„NTPæœåŠ¡å™¨ï¼Œå°†æ—¶é—´è¯¯å·®ç¼©çŸ­åˆ°æœ€å°çš„æ–¹æ³•ã€‚</p>

<p>$ sudo apt-get install -y chrony ntpdate
$ sudo ntpdate -q ntp.ubuntu.com</p>

<p>åœ¨å¤„ç†Webç³»ç»Ÿæ•°æ®æ—¶ï¼Œç”±äºå‡ å°æœåŠ¡å™¨ä¸Šçš„æ—¶é—´ä¸ä¸€è‡´ï¼Œå¯¼è‡´æ•°æ®æ—¶é—´çš„ä¸å‡†ç¡®ï¼Œå‡ºç°äº†é”™ä¹±ã€‚åœ¨æ›´ä¸¥æ ¼çš„æœåŠ¡ä¸Šï¼Œå› ä¸ºæœåŠ¡å™¨æ—¶é—´ä¸å‡†ç¡®æˆ–æ˜¯ä¸ä¸€è‡´ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå¸¦æ¥å®‰å…¨æˆ–æ˜¯åŠŸèƒ½çš„éšæ‚£ã€‚å› è€Œï¼Œæœ‰å¿…è¦é‡‡å–æªæ–½ä¿è¯ç½‘ç»œä¸­çš„æœåŠ¡å™¨ä¸Šçš„æ—¶é—´åŒæ­¥ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹ä½¿ç”¨NTPæœåŠ¡å¦‚ä½•å®ç°åŒæ­¥æ—¶é—´ã€‚</p>

<p>Network Time Protocol(NTP)ï¼Œå³ç½‘ç»œæ—¶é—´åè®®ï¼Œå®ƒçš„ç›®çš„æ˜¯åœ¨å›½é™…äº’è”ç½‘ä¸Šä¼ é€’ç»Ÿä¸€ã€æ ‡å‡†çš„æ—¶é—´ã€‚NTPæœåŠ¡å™¨å°†æœ¬åœ°ç³»ç»Ÿçš„æ—¶é’Ÿä¸ä¸€ä¸ªå…¬å…±çš„NTPæœåŠ¡å™¨åŒæ­¥ç„¶åä½œä¸ºæ—¶é—´ä¸»æœºæä¾›æœåŠ¡ï¼Œä½¿æœ¬åœ°ç½‘ç»œçš„æ‰€æœ‰å®¢æˆ·ç«¯èƒ½åŒæ­¥æ—¶é’Ÿã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   NTPæœåŠ¡çš„å®‰è£…ã€é…ç½®ã€ä½¿ç”¨è¿™é‡Œå°±ä¸å†ç»†è¯´äº†ï¼ˆä¸äº†è§£çš„å¯ä»¥googleä¸‹ï¼‰ã€‚æˆ‘ä»¬çŸ¥é“åœ¨NTPæœåŠ¡å™¨å¯åŠ¨åï¼ŒNTPå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ‰‹åŠ¨æ‰§è¡Œâ€œntpdate æœåŠ¡å™¨IPâ€æ¥åŒæ­¥æ—¶é—´ï¼Œæˆ–æ˜¯é€šè¿‡é…ç½®NTPå®¢æˆ·ç«¯å®šæ—¶è¿›è¡Œæ—¶é—´åŒæ­¥ã€‚ï¼ˆå½“ç„¶ï¼Œéœ€è¦ä¿è¯NTPæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„ä¹‹é—´æ²¡æœ‰é˜²ç«å¢™Blockå®ƒä»¬çš„é€šä¿¡ã€‚ï¼‰
</code></pre></div></div>

<p>ä¸‹é¢æˆ‘ä»¬æ¥ç€æ¥çœ‹ï¼Œå¦‚ä½•åœ¨æˆ‘ä»¬çš„ç¯å¢ƒä¸­æ‹¥æœ‰ä¸Šç™¾å°æœºå™¨ï¼Œä¸ºäº†åŒæ­¥æ—¶é—´ï¼Œä¸æƒ³æ‰‹åŠ¨çš„åœ¨æ¯å°æœºå™¨ä¸Šå»è¿è¡ŒntpdateåŒæ­¥å‘½ä»¤æˆ–æ˜¯é…ç½®ï¼Œä½ è¦çŸ¥é“å‡ ç™¾å°æœºå™¨ï¼Œä½ ç™»é™†å†è¿è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œä¹Ÿæ˜¯éœ€è¦è€—è´¹ä½ å¾ˆå¤šçš„æ—¶é—´ã€‚å½“ç„¶ï¼Œä½ è¦æ˜¯éƒ¨ç½²æ¯ä¸ªæœåŠ¡å™¨çš„æ—¶å€™å°±å·²ç»å»ºå¥½äº†NTPæœåŠ¡å™¨ï¼Œé‚£è¿˜æ˜¯å¯ä»¥é‚£æ—¶å€™å°±è¿›è¡ŒNTPå®¢æˆ·ç«¯çš„é…ç½®ã€‚ä½†æˆ‘ä»¬ä»¥å‰æ²¡è¿™ä¹ˆåšï¼Œé‚£åªæœ‰ç°åœ¨ä»å¤´å¼€å§‹äº†ã€‚æ‰‹å·¥æ´»å¤ªç´¯å¤ªéº»çƒ¦äº†ï¼Œæˆ‘ä»¬åšä¸ªè„šæœ¬ï¼Œåœ¨NTPæœåŠ¡å™¨ä¸Šè¿è¡Œä¸€æ¬¡ï¼Œå°±è®©æ‰€æœ‰æœåŠ¡å™¨éƒ½åŒæ­¥ä¸€æ¬¡æ—¶é—´ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   æˆ‘ä»¬å°±æ¥çœ‹çœ‹å¦‚ä½•æ¥ä½¿ç”¨æœ€ç®€å•çš„æ–¹å¼æ¥è¾¾åˆ°è¿™ä¸ªåŠŸèƒ½ã€‚Linuxçš„sshæä¾›äº†ä¸€ä¸ªè¿œç¨‹æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼ï¼Œç°åœ¨å°±æ¥ç”¨å®ƒæ¥è®©æ¯ä¸ªæœåŠ¡å™¨å‘NTPæœåŠ¡å™¨æ¥åŒæ­¥ä¸€æ¬¡æ—¶é—´ã€‚sshè®¿é—®æœ‰ä¸¤ç§æ–¹å¼ï¼šå¯†ç æ–¹å¼ã€å…¬é’¥æ–¹å¼ã€‚ä½¿ç”¨ç§˜é’¥æ–¹å¼ï¼Œæˆ‘ä»¬éœ€è¦ä¿å­˜æ‰€æœ‰æœåŠ¡å™¨çš„ipåœ°å€ã€ç”¨æˆ·ã€å¯†ç ã€‚ä½ å¦‚æœè§‰å¾—ä¸å®‰å…¨ï¼Œé‚£å¯ä»¥å»ºç«‹å¯†é’¥æ–¹å¼è®¿é—®ï¼Œè¿™æ—¶éœ€è¦ä¸€äº›æ‰‹å·¥é…ç½®ï¼Œå½“é…ç½®å¥½ä½¿ç”¨å…¬é’¥æ–¹å¼åï¼Œå°±å¯ä»¥ä¸è¾“å…¥å¯†ç è®¿é—®å¯¹æ–¹ã€‚
</code></pre></div></div>

<p>é‚£å°±æ¥çœ‹çœ‹è„šæœ¬å§ï¼Œè„šæœ¬1æ˜¯ä½¿ç”¨å…¬é’¥æ–¹å¼è¿›è¡Œè®¿é—®çš„ï¼Œè„šæœ¬2æ˜¯ä½¿ç”¨å¯†ç è®¿é—®çš„ï¼Œå…¶ä¸­æœåŠ¡å™¨ä¿¡æ¯éƒ½ä¿å­˜åœ¨/tmp/servers.txtæ–‡ä»¶ä¸­ã€‚</p>

<p>è„šæœ¬1ï¼š</p>

<p>#!/bin/sh</p>

<p>#in the servers.txt</p>

<p>#username1  server1</p>

<p>SERVERS=â€/tmp/servers.txtâ€</p>

<p>CMD=â€ntpdate  ntp_serverâ€</p>

<p>while read line; do</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     set â€” $line

     username=$1

     server=$2

    ssh $username@$server $CMD
</code></pre></div></div>

<p>done &lt; $SERVERS</p>

<p>è„šæœ¬2ï¼š</p>

<p>#!/usr/bin/expect</p>

<p>set SERVERS â€œ/tmp/servers.txtâ€</p>

<p>set CMD â€œntpdate ntp_serverâ€</p>

<p>set fp [open $SERVERS]</p>

<p>while {-1 != [gets $fp line]} {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    set ln [split $line " "]

    set username [lindex $ln 0]

    set passwd [lindex $ln 1]

    set server [lindex $ln 2]

    spawn ssh $username@$server $CMD;

    expect â€œ*password: â€œ;

    send â€œ$passwd â€;

    interact;
</code></pre></div></div>

<p>}</p>
:ET