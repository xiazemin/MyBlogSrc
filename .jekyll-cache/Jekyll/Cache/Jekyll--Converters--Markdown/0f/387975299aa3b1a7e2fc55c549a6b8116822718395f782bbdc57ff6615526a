I"p†<ol>
  <li>
    <p>Zendå¼•æ“ä¸»è¦åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šç¼–è¯‘ã€æ‰§è¡Œï¼š</p>

    <p>æ‰§è¡Œé˜¶æ®µä¸»è¦ç”¨åˆ°çš„æ•°æ®ç»“æ„ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   opcodeï¼š phpä»£ç ç¼–è¯‘äº§ç”Ÿçš„zendè™šæ‹Ÿæœºå¯è¯†åˆ«çš„æŒ‡ä»¤ï¼Œphp7æœ‰173ä¸ªopcodeï¼Œå®šä¹‰åœ¨ zend_vm_opcodes.hPHPä¸­çš„æ‰€æœ‰è¯­æ³•å®ç°éƒ½æ˜¯ç”±è¿™äº›opcodeç»„æˆçš„ã€‚
</code></pre></div>    </div>
  </li>
</ol>

<p>å¤åˆ¶ä»£ç 
struct _zend_op {
    const void *handler; //å¯¹åº”æ‰§è¡Œçš„Cè¯­è¨€functionï¼Œå³æ¯æ¡opcodeéƒ½æœ‰ä¸€ä¸ªC functionå¤„ç†
    znode_op op1;   //æ“ä½œæ•°1
    znode_op op2;   //æ“ä½œæ•°2
    znode_op result; //è¿”å›å€¼
    uint32_t extended_value; 
    uint32_t lineno; 
    zend_uchar opcode;  //opcodeæŒ‡ä»¤
    zend_uchar op1_type; //æ“ä½œæ•°1ç±»å‹
    zend_uchar op2_type; //æ“ä½œæ•°2ç±»å‹
    zend_uchar result_type; //è¿”å›å€¼ç±»å‹
};
å¤åˆ¶ä»£ç 
         zend_op_array : zendå¼•æ“æ‰§è¡Œé˜¶æ®µçš„è¾“å…¥æ•°æ®ç»“æ„ï¼Œæ•´ä¸ªæ‰§è¡Œé˜¶æ®µéƒ½æ˜¯æ“ä½œè¿™ä¸ªæ•°æ®ç»“æ„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ã€€ã€€ã€€ã€€ã€€ã€€ zend_op_arrayæœ‰ä¸‰ä¸ªæ ¸å¿ƒéƒ¨åˆ†ï¼šopcodeæŒ‡ä»¤(å¯¹åº”cçš„æŒ‡ä»¤)

                                               å­—é¢é‡å­˜å‚¨(å˜é‡åˆå§‹å€¼ã€è°ƒç”¨çš„å‡½æ•°åç§°ã€ç±»åç§°ã€å¸¸é‡åç§°ç­‰ç­‰ç§°ä¹‹ä¸ºå­—é¢é‡)

                                               å˜é‡åˆ†é…çš„æƒ…å†µ (å½“å‰arrayå®šä¹‰çš„å˜é‡ ä¸´æ—¶å˜é‡çš„æ•°é‡ ç¼–å·ï¼Œæ‰§è¡Œåˆå§‹åŒ–ä¸€æ¬¡æ€§åˆ†é…zvalï¼Œä½¿ç”¨æ—¶å®Œå…¨æŒ‰ç…§æ ‡å·ç´¢å¼•ä¸æ˜¯æ ¹æ®å˜é‡å)

     

       zend_executor_globals     PHPæ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªç»“æ„ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œåœ¨mainæ‰§è¡Œå‰åˆ†é…(éZTSä¸‹)ï¼Œç›´åˆ°PHPé€€å‡ºï¼Œå®ƒè®°å½•ç€å½“å‰è¯·æ±‚å…¨éƒ¨çš„ä¿¡æ¯ï¼Œç»å¸¸è§åˆ°çš„ä¸€ä¸ªå®EGæ“ä½œçš„å°±æ˜¯è¿™ä¸ªç»“æ„ã€‚

                            å®šä¹‰åœ¨zend_globals.hä¸­ï¼š

 

                               

 

            

           zend_execute_data  æ˜¯æ‰§è¡Œè¿‡ç¨‹ä¸­æœ€æ ¸å¿ƒçš„ä¸€ä¸ªç»“æ„ï¼Œæ¯æ¬¡å‡½æ•°çš„è°ƒç”¨ã€include/requireã€evalç­‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç»“æ„ï¼Œå®ƒè¡¨ç¤ºå½“å‰çš„ä½œç”¨åŸŸã€ä»£ç çš„æ‰§è¡Œä½ç½®ä»¥åŠå±€éƒ¨å˜é‡çš„åˆ†é…ç­‰ç­‰ï¼Œç­‰åŒäºæœºå™¨ç æ‰§è¡Œè¿‡ç¨‹ä¸­stackçš„è§’è‰²ï¼Œåé¢åˆ†æå…·ä½“æ‰§è¡Œæµç¨‹çš„æ—¶å€™ä¼šè¯¦ç»†åˆ†æå…¶ä½œç”¨ã€‚ 

          zend_execute_dataä¸zend_op_arrayçš„å…³è”å…³ç³»ï¼š
</code></pre></div></div>

<p>2.æ‰§è¡Œè¿‡ç¨‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Zendçš„executorä¸linuxäºŒè¿›åˆ¶ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚

    åœ¨Cç¨‹åºæ‰§è¡Œæ—¶æœ‰ä¸¤ä¸ªå¯„å­˜å™¨ebpã€espåˆ†åˆ«æŒ‡å‘å½“å‰ä½œç”¨æ ˆçš„æ ˆé¡¶ã€æ ˆåº•ï¼Œå±€éƒ¨å˜é‡å…¨éƒ¨åˆ†é…åœ¨å½“å‰æ ˆï¼Œå‡½æ•°è°ƒç”¨ã€è¿”å›é€šè¿‡callã€retæŒ‡ä»¤å®Œæˆï¼Œè°ƒç”¨æ—¶callå°†å½“å‰æ‰§è¡Œä½ç½®å‹å…¥æ ˆä¸­ï¼Œè¿”å›æ—¶retå°†ä¹‹å‰æ‰§è¡Œä½ç½®å‡ºæ ˆï¼Œè·³å›æ—§çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚

    Zend VMä¸­zend_execute_dataå°±æ‰®æ¼”äº†è¿™ä¸¤ä¸ªè§’è‰²ï¼Œzend_execute_data.prev_execute_dataä¿å­˜çš„æ˜¯è°ƒç”¨æ–¹çš„ä¿¡æ¯ï¼Œå®ç°äº†call/retï¼Œzend_execute_dataåé¢ä¼šåˆ†é…é¢å¤–çš„å†…å­˜ç©ºé—´ç”¨äºå±€éƒ¨å˜é‡çš„å­˜å‚¨ï¼Œå®ç°äº†ebp/espçš„ä½œç”¨ã€‚

                a. ä¸ºå½“å‰ä½œç”¨åŸŸåˆ†é…ä¸€å—å†…å­˜ï¼Œå……å½“è¿è¡Œæ ˆï¼Œzend_execute_dataç»“æ„ã€æ‰€æœ‰å±€éƒ¨å˜é‡ã€ä¸­é—´å˜é‡ç­‰ç­‰éƒ½åœ¨æ­¤å†…å­˜ä¸Šåˆ†é…

                b.åˆå§‹åŒ–å…¨å±€å˜é‡ç¬¦å·è¡¨ï¼Œç„¶åå°†å…¨å±€æ‰§è¡Œä½ç½®æŒ‡é’ˆEG(current_execute_data)æŒ‡å‘æ­¥éª¤aæ–°åˆ†é…çš„zend_execute_dataï¼Œç„¶åå°†zend_execute_data.oplineæŒ‡å‘op_arrayçš„èµ·å§‹ä½ç½®

                c.ä»EX(opline)å¼€å§‹è°ƒç”¨å„opcodeçš„Cå¤„ç†handler(å³_zend_op.handler)ï¼Œæ¯æ‰§è¡Œå®Œä¸€æ¡opcodeå°†EX(opline)++ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œç›´åˆ°æ‰§è¡Œå®Œå…¨éƒ¨opcode

                            ifè¯­å¥å°†æ ¹æ®æ¡ä»¶çš„æˆç«‹ä¸å¦å†³å®šEX(opline) + offsetæ‰€åŠ çš„åç§»é‡ï¼Œå®ç°è·³è½¬

                            å¦‚æœæ˜¯å‡½æ•°è°ƒç”¨ï¼Œåˆ™é¦–å…ˆä»EG(function_table)ä¸­æ ¹æ®function_nameå–å‡ºæ­¤functionå¯¹åº”çš„ç¼–è¯‘å®Œæˆçš„zend_op_arrayï¼Œç„¶ååƒæ­¥éª¤aä¸€æ ·æ–°åˆ†é…ä¸€ä¸ªzend_execute_dataç»“æ„ï¼Œå°†EG(current_execute_data)èµ‹å€¼ç»™æ–°ç»“æ„çš„prev_execute_dataï¼Œå†å°†EG(current_execute_data)æŒ‡å‘æ–°çš„zend_execute_dataï¼Œæœ€åä»æ–°çš„zend_execute_data.oplineå¼€å§‹æ‰§è¡Œï¼Œåˆ‡æ¢åˆ°å‡½æ•°å†…éƒ¨ï¼Œå‡½æ•°æ‰§è¡Œå®Œä»¥åå°†EG(current_execute_data)é‡æ–°æŒ‡å‘EX(prev_execute_data)ï¼Œé‡Šæ”¾åˆ†é…çš„è¿è¡Œæ ˆï¼Œé”€æ¯å±€éƒ¨å˜é‡ï¼Œç»§ç»­ä»åŸæ¥å‡½æ•°è°ƒç”¨çš„ä½ç½®æ‰§è¡Œ

                            ç±»æ–¹æ³•çš„è°ƒç”¨ä¸å‡½æ•°åŸºæœ¬ç›¸åŒ

                d.å…¨éƒ¨opcodeæ‰§è¡Œå®Œæˆåå°†æ­¥éª¤aåˆ†é…çš„å†…å­˜é‡Šæ”¾ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå°†æ‰€æœ‰çš„å±€éƒ¨å˜é‡"é”€æ¯"ï¼Œæ‰§è¡Œé˜¶æ®µç»“æŸ

                                

 

                          é¦–å…ˆæ ¹æ®zend_execute_dataã€å½“å‰zend_op_arrayä¸­å±€éƒ¨/ä¸´æ—¶å˜é‡æ•°è®¡ç®—éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œç¼–è¯‘é˜¶æ®µzend_op_arrayçš„ç»“æœï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å·²ç»ç¡®å®šå½“å‰ä½œç”¨åŸŸä¸‹æœ‰å¤šå°‘ä¸ªå±€éƒ¨å˜é‡(func-&gt;op_array.last_var)ã€ä¸´æ—¶/ä¸­é—´/æ— ç”¨å˜é‡(func-&gt;op_array.T)ï¼Œä»è€Œåœ¨æ‰§è¡Œä¹‹åˆå°±å°†ä»–ä»¬å…¨éƒ¨åˆ†é…å®Œæˆã€‚ &lt;!-- more --&gt;
</code></pre></div></div>

<p>https://www.cnblogs.com/hellohell/p/9101803.html
http://www.lvesu.com/blog/php/migration55.internals.php</p>

<p>å…ˆæ‰“å°ä¸€ä¸‹phpè°ƒç”¨è¿‡ç¨‹ï¼š</p>

<p>åœ¨å¢åŠ ä¸€å¼ å¼‚å¸¸è°ƒç”¨çš„æµç¨‹å›¾ï¼š</p>

<p>ä»Šå¤©ç¨å¾®å¯¹phpåšä¸‹æ€»ç»“ï¼Œé¦–å…ˆä»‹ç»æœ€é‡è¦çš„ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œä»¥åŠä¸¤ä¸ªç»“æ„é—´çš„æ•°æ®ä¼ é€’</p>

<p>struct _zend_op_array {
/* Common elements <em>/
zend_uchar type;
const char *function_name;
zend_class_entry *scope;
zend_uint fn_flags;
union _zend_function *prototype;
zend_uint num_args;
zend_uint required_num_args;
zend_arg_info *arg_info;
/</em> END of common elements */</p>

<p>zend_uint *refcount;</p>

<p>zend_op *opcodes;
zend_uint last;</p>

<p>zend_compiled_variable *vars;
int last_var;</p>

<p>zend_uint T;</p>

<p>zend_literal *literals;
int last_literal;</p>

<p>â€¦
};</p>

<p>ä¸é‡ç‚¹ä»‹ç»çš„å±æ€§æš‚æ—¶çœç•¥</p>

<p>struct _zend_execute_data {
struct _zend_op <em>opline;
zend_function_state function_state;
zend_op_array *op_array;
zval *object;
HashTable *symbol_table;
struct _zend_execute_data *prev_execute_data;
zval *old_error_reporting;
zend_bool nested;
zval **original_return_value;
zend_class_entry *current_scope;
zend_class_entry *current_called_scope;
zval *current_this;
struct _zend_op *fast_ret; /</em> used by FAST_CALL/FAST_RET (finally keyword) */
zval *delayed_exception;
call_slot *call_slots;
call_slot *call;
};</p>

<p>zend_execute_dataçš„æ•°æ®ç»“æ„å¤§éƒ¨åˆ†æ˜¯æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å†…å®¹æ˜¯è¿™æ ·åˆ†é…çš„
5.6å¾ˆæ¸…æ¥šçš„ç”»å‡ºäº†å†…å­˜åˆ†é…å›¾
/*
Â * Stack Frame Layout (the whole stack frame is allocated at once)
Â * ==================
Â *
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +========================================+
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | zend_execute_data Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |&lt;â€”+
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â  Â  EX(function_state).arguments Â  Â  Â  |â€“+ |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â | |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | ARGUMENT [1] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â | |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | Â | |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | ARGUMENT [ARGS_NUMBER] Â  Â  Â  Â  Â  Â  Â  Â  | Â | |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | ARGS_NUMBER Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |&lt;-+ |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +========================================+ Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +========================================+ Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | TMP_VAR[op_arrat-&gt;T-1] Â  Â  Â  Â  Â  Â  Â  Â  | Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | Â  Â |
Â * Â  Â  EX_TMP_VAR_NUM(0) â€”-&gt; | TMP_VAR[0] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ Â  Â |
Â * EG(current_execute_data) -&gt; | zend_execute_data Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Â  Â  EX(prev_execute_data) Â  Â  Â  Â  Â  Â  Â |â€”-+
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
Â * Â  Â  EX_CV_NUM(0) â€”â€”â€”&gt; | CV[0] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |â€“+
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | CV[op_array-&gt;last_var-1] Â  Â  Â  Â  Â  Â  Â  | Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Optional slot for CV[0] zval* Â  Â  Â  Â  Â |&lt;-+
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦for CV [op_array-&gt;last_var-1] zval* |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
Â * Â  Â  Â  Â  Â  EX(call_slots) -&gt; | CALL_SLOT[0] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | CALL_SLOT[op_array-&gt;nested_calls-1] Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
Â * zend_vm_stack_frame_base -&gt; | ARGUMENTS STACK [0] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * zend_vm_stack_top â€”â€”â€“&gt; | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | â€¦ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | ARGUMENTS STACK [op_array-&gt;used_stack] |
Â * Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  +â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
Â */
è¿™é‡Œåˆ†é…æœ‰ä¸ªæ¡ä»¶åˆ¤æ–­åœ¨5.2æ˜¯æ²¡æœ‰çš„
(op_array-&gt;fn_flags &amp; ZEND_ACC_GENERATOR) != 0
å½“å¦‚æœç”¨åˆ°äº†yieldå‡½æ•°æ—¶å°±ä¼šè§¦å‘è¯¥é€»è¾‘ï¼Œä»è€Œå†åˆ†é…ä¸Šé¢çš„å †æ ˆç»“æ„æ˜¯ä¼šç»™prev_execute_dataå•ç‹¬åˆ†é…ç©ºé—´ï¼Œå¹¶ä¸”æŒ‡å‘TMP_VARå˜é‡çš„ä¸Šé¢çš„å†…å­˜ä½ç½®ã€‚
è¿™ä¸ªæ•°æ®ç»“æ„é‡è¦çš„æ˜¯ä¸‰ä¸ªå±æ€§EX_TMP_VAR_NUM(ä¸´æ—¶å˜é‡çš„ç©ºé—´)ï¼ŒEX_CV_NUM(ç¼“å­˜å˜é‡çš„ç©ºé—´)ï¼Œzend_vm_stack_top(å‡½æ•°å‚æ•°çš„ç©ºé—´)</p>

<p>æ³¨é‡Šä¸‹php7çš„ç»“æ„ç®€åŒ–äº†ä¸å°‘</p>

<p>/*</p>
<ul>
  <li>Stack Frame Layout (the whole stack frame is allocated at once)</li>
  <li>==================
 *</li>
  <li>+========================================+</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>EG(current_execute_data) -&gt;</td>
          <td>zend_execute_data</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>EX_CV_NUM(0) â€”â€”â€”&gt;</td>
          <td>VAR[0] = ARG[1]</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>â€¦</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>VAR[op_array-&gt;num_args-1] = ARG[N]</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>â€¦</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>VAR[op_array-&gt;last_var-1]</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>VAR[op_array-&gt;last_var] = TMP[0]</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>â€¦</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>VAR[op_array-&gt;last_var+op_array-&gt;T-1]</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>ARG[N+1] (extra_args)</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>â€¦</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
 */</li>
</ul>

<p>ç¨å¾®äº†è§£äº†ä¸Šé¢ä¸¤ä¸ªæ•°æ®ç»“æ„åï¼Œä¸‹é¢å°±è®²zend_op_arrayä¸zend_executeä¹‹é—´çš„ç›¸äº’å…³ç³»
phpåˆ†ä¸ºå‡ ä¸ªé˜¶æ®µåŒ…æ‹¬ç”Ÿæˆopcodeé˜¶æ®µå’Œæ‰§è¡Œopcodeé˜¶æ®µï¼Œå…¶å®åˆ†åˆ«å¯¹åº”çš„å°±æ˜¯ä¸Šé¢ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼Œ
å¹¶ä¸”ä¸¤ä¸ªæ•°æ®ç»“æ„éƒ½æ˜¯åœ¨è§£æåˆ°æ–°çš„å‡½æ•°æ—¶åˆ†é…æ–°çš„ç©ºé—´ï¼Œç„¶åå±‚å±‚åµŒå¥—ï¼Œæœ€å¤–å±‚æ€»æ˜¯æœ‰ä¸ªå¤§çš„op_arrayä¸execute_data,å…·ä½“ç‚¹è¯´å°±æ˜¯è¿™ä¸¤ä¸ªæ•°æ®ç»“æ„å­˜å‚¨çš„æ˜¯å½“å‰å‡½æ•°ä¸‹çš„å˜é‡ç¯å¢ƒã€‚
ç„¶åå°±æ˜¯ä¸Šé¢ä¸¤ä¸ªä¸åŒé˜¶æ®µå­˜å‚¨è¯¥é˜¶æ®µåº”è¯¥å­˜å‚¨çš„æ•°æ®ï¼Œç„¶åå¯ä¾›ä¸‹ä¸€å±‚è°ƒç”¨ã€‚</p>

<p>ç¬¬ä¸€ä¸ªä¾‹å­$var = 1
æ­¤å¤„çœç•¥æ‰è¯­æ³•è§£æ(| variable â€˜=â€™ expr{ zend_check_writable_variable(&amp;$1); zend_do_assign(&amp;$$, &amp;$1, &amp;$3 TSRMLS_CC); })ï¼Œ</p>

<p>ç›´æ¥åˆ°opcondeç”Ÿæˆé˜¶æ®µ</p>

<p>ä»¥ä¸‹ä»£ç æ˜¯varè¯¥å­—ç¬¦ä¸²ä»£è¡¨çš„å˜é‡çš„ä¿¡æ¯ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å› ä¸ºç°åœ¨å®ƒè¿˜ä¸èƒ½æˆä¸ºå˜é‡ï¼Œopcondeè§£æçš„$varçš„è¿”å›å€¼æ‰æ˜¯å˜é‡
fetch_simple_variable -&gt; lookup_cv
æ ¸å¿ƒä»£ç 
i = op_array-&gt;last_var;
op_array-&gt;last_var++;</p>

<p>void fetch_simple_variable_ex(znode <em>result, znode *varname, int bp, zend_uchar op TSRMLS_DC) /</em> {{{ */
{
	zend_op opline;
	zend_op *opline_ptr;
	zend_llist *fetch_list_ptr;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (varname-&gt;op_type == IS_CONST) {
	ulong hash;
 
	if (Z_TYPE(varname-&gt;u.constant) != IS_STRING) {
		convert_to_string(&amp;varname-&gt;u.constant);
	}
 
	hash = str_hash(Z_STRVAL(varname-&gt;u.constant), Z_STRLEN(varname-&gt;u.constant));
	if (!zend_is_auto_global_quick(Z_STRVAL(varname-&gt;u.constant), Z_STRLEN(varname-&gt;u.constant), hash TSRMLS_CC) &amp;&amp;
	    !(Z_STRLEN(varname-&gt;u.constant) == (sizeof("this")-1) &amp;&amp;
	      !memcmp(Z_STRVAL(varname-&gt;u.constant), "this", sizeof("this") - 1)) &amp;&amp;
	    (CG(active_op_array)-&gt;last == 0 ||
	     CG(active_op_array)-&gt;opcodes[CG(active_op_array)-&gt;last-1].opcode != ZEND_BEGIN_SILENCE)) {
		result-&gt;op_type = IS_CV;
		result-&gt;u.op.var = lookup_cv(CG(active_op_array), Z_STRVAL(varname-&gt;u.constant), Z_STRLEN(varname-&gt;u.constant), hash TSRMLS_CC);
		Z_STRVAL(varname-&gt;u.constant) = (char*)CG(active_op_array)-&gt;vars[result-&gt;u.op.var].name;
		result-&gt;EA = 0;
		return;
	}
}
 
if (bp) {
	opline_ptr = &amp;opline;
	init_op(opline_ptr TSRMLS_CC);
} else {
	opline_ptr = get_next_op(CG(active_op_array) TSRMLS_CC);
}
 
opline_ptr-&gt;opcode = op;
opline_ptr-&gt;result_type = IS_VAR;
opline_ptr-&gt;result.var = get_temporary_variable(CG(active_op_array));
SET_NODE(opline_ptr-&gt;op1, varname);
GET_NODE(result, opline_ptr-&gt;result);
SET_UNUSED(opline_ptr-&gt;op2);
opline_ptr-&gt;extended_value = ZEND_FETCH_LOCAL;
 
if (varname-&gt;op_type == IS_CONST) {
	CALCULATE_LITERAL_HASH(opline_ptr-&gt;op1.constant);
	if (zend_is_auto_global_quick(Z_STRVAL(varname-&gt;u.constant), Z_STRLEN(varname-&gt;u.constant), Z_HASH_P(&amp;CONSTANT(opline_ptr-&gt;op1.constant)) TSRMLS_CC)) {
		opline_ptr-&gt;extended_value = ZEND_FETCH_GLOBAL;
	}
}
 
if (bp) {
	zend_stack_top(&amp;CG(bp_stack), (void **) &amp;fetch_list_ptr);
	zend_llist_add_element(fetch_list_ptr, opline_ptr);
} }
</code></pre></div></div>

<p>å¦‚æœæ˜¯$$varå°±ä¼šèµ°åˆ°ä¸‹é¢é€»è¾‘è¿›è¡Œoplineèµ‹å€¼ï¼Œå½“executeé˜¶æ®µå°±ä¼šæ‰§è¡ŒZEND_FETCH_W_SPEC_CV_VAR_HANDLERæ‰¾åˆ°$varå˜é‡çš„å€¼å†è¿›è¡Œå˜é‡æŸ¥è¯¢.</p>

<p>op_array-&gt;vars[i].name = zend_new_interned_string(name, name_len + 1, 1 TSRMLS_CC);
op_array-&gt;vars[i].name_len = name_len;
op_array-&gt;vars[i].hash_value = hash_value;
å¾ˆå¥½ç†è§£ï¼Œä¸º$varè¿™ä¸ªå˜é‡å±æ€§åˆ†é…äº†ç©ºé—´è€Œä¸æ˜¯ä¸ºå˜é‡åˆ†é…ç©ºé—´ï¼Œåˆ©ç”¨äº†op_arrayä¸¤ä¸ªå±æ€§last_varå˜é‡ä½ç½®å’Œvarsæ•°ç»„çš„å¯¹åº”å…³ç³»</p>

<p>é‚£$varè¿”å›å€¼æ˜¯ä»€ä¹ˆå‘¢
result-&gt;op_type = IS_CV;
result-&gt;u.op.var = op_array-&gt;last_var;
ä½†æ˜¯å‰æå¤§å®¶éœ€è¦çŸ¥é“è¯­æ³•è§£ææ—¶å°†å­—ç¬¦ä¸²æˆ–è€…æ•´å½¢ç»Ÿä¸€è§£æåˆ°znode-&gt;u.constantä¸­ï¼Œ</p>

<p>resultçš„æ•°æ®ç»“æ„æ˜¯zondeï¼Œ</p>

<p>åç»­opcodeé˜¶æ®µå¦‚æœæ˜¯å˜é‡èµ‹å€¼çš„æ˜¯znode_opçš„varå±æ€§ï¼Œå³åç§»é‡ï¼Œznode_op.zvå±æ€§ï¼Œå³å¸¸é‡ä¿¡æ¯(è¯¥å€¼æœ‰pass_twoèµ‹å€¼)</p>

<p>typedef union _znode_op {
	zend_uint      constant;
	zend_uint      var;
	zend_uint      num;
	zend_ulong     hash;
	zend_uint      opline_num; /*  Needs to be signed <em>/
	zend_op       *jmp_addr;
	zval          *zv;
	zend_literal  *literal;
	void          *ptr;        /</em> Used for passing pointers from the compile to execution phase, currently used for traits */
} znode_op;</p>

<p>typedef struct _znode { /* used only during compilation <em>/
	int op_type;
	union {
		znode_op op;
		zval constant; /</em> replaced by literal/zv <em>/
		zend_op_array *op_array;
		zend_ast *ast;
	} u;
	zend_uint EA;      /</em> extended attributes */
} znode;</p>

<p>è¿™é‡Œè¡¥å……ä¸‹ï¼Œè¯­æ³•æ‰«æè·å–znodeåï¼Œè¿›å…¥è¯­æ³•è§£æé˜¶æ®µï¼Œæ­¤åˆ»op_arrayä¸­æœ‰ä¸ªç‰¹æ®Šå±æ€§literalsï¼Œè¯¥å±æ€§æ˜¯ä¸ªæ•°ç»„ä¼šæå‰åˆ†é…å¥½ï¼Œæœ€ç»ˆå¯è¿›è¡Œopcodeé˜¶æ®µä¼˜åŒ–è§update_op1_constå‡½æ•°ï¼Œå°†å˜é‡è½¬ä¸ºå¸¸é‡ã€‚</p>

<p>accel_startup:
accelerator_orig_compile_fileÂ =Â zend_compile_file; // ä¿å­˜åŸç”Ÿhandle
zend_compile_fileÂ =Â persistent_compile_file; //èµ‹å€¼æ–°çš„handle
ç”¨persistent_compile_file -&gt; compile_and_cache_file -&gt; cache_script_in_shared_memory -&gt; zend_accel_script_optimize
-&gt;zend_accel_optimize-&gt;zend_optimize-&gt;replace_var_by_const-&gt;update_op1_constæœ€åä¼šåˆ©ç”¨literalsæ•°ç»„å°†å˜é‡è½¬æ¢ä¸ºå¸¸é‡æ›´æ”¹oplineçš„op1æˆ–è€…op2</p>

<p>è¯¥æ•°ç»„indexä¸valueæ–¹å¼è¿›è¡Œå­˜å‚¨</p>

<p>#define SET_NODE(target, src) do { <br />
		target ## _type = (src)-&gt;op_type; <br />
		if ((src)-&gt;op_type == IS_CONST) { <br />
			target.constant = zend_add_literal(CG(active_op_array), &amp;(src)-&gt;u.constant TSRMLS_CC); <br />
		} else { <br />
			target = (src)-&gt;u.op; <br />
		} <br />
	} while (0)</p>

<p>å¦‚æœæ˜¯å¸¸é‡op1-&gt;constant = index, Â å…¶ç§valueå­˜åœ¨å°†æ•°æ®å­˜åˆ°literalsä¸­ï¼Œæ¥ä¸‹æ¥çš„ç”¨é€”è§pass_two;</p>

<p>compile-&gt;pass_two æ­¤æ—¶ä¼šç”Ÿæˆopcodeçš„å›è°ƒop-&gt;handlerï¼Œå¹¶ä¸”ä¼šä»constantçš„indexä¸­å°†valueèµ‹å€¼ç»™oplineä¸­çš„op1.zvï¼Œ</p>

<p>è¿™æ ·åœ¨çœŸæ­£executeé˜¶æ®µç”¨çš„å°±æ˜¯op1.zvè·å–å¸¸é‡ä¿¡æ¯</p>

<p>while (opline &lt; end) {
		if (opline-&gt;op1_type == IS_CONST) {
			opline-&gt;op1.zv = &amp;op_array-&gt;literals[opline-&gt;op1.constant].constant;
		}
		if (opline-&gt;op2_type == IS_CONST) {
			opline-&gt;op2.zv = &amp;op_array-&gt;literals[opline-&gt;op2.constant].constant;
		}
		ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	ZEND_VM_SET_OPCODE_HANDLER(opline);
	opline++;
} #defineÂ IS_CONST	(1&lt;&lt;0) #defineÂ IS_TMP_VAR	(1&lt;&lt;1) #defineÂ IS_VAR		(1&lt;&lt;2) #defineÂ IS_UNUSED	(1&lt;&lt;3)	/*Â UnusedÂ variableÂ */ #defineÂ IS_CV		(1&lt;&lt;4)	/*Â CompiledÂ variableÂ */ å¦‚ï¼š opline-&gt;result_typeÂ =Â IS_TMP_VAR; // opline-&gt;result.varÂ =Â get_temporary_variable(CG(active_op_array)); opline-&gt;result_typeÂ =Â IS_VAR; opline-&gt;result.varÂ =Â get_temporary_variable(CG(active_op_array)); æœ€åç”Ÿæˆçš„å‡½æ•°å°±æ˜¯ ZEND_ASSIGN_SPEC_VAR_TMP_HANDLER VARä¸TMPå‡æ¥è‡ªä¸´æ—¶å˜é‡ï¼Œä½†æ˜¯ä¸¤è€…ç”¨çš„æ•°æ®ç»“æ„ä¸åŒï¼Œå…·ä½“å¯è§ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•° valueÂ =Â _get_zval_ptr_tmp(opline-&gt;op2.var,Â execute_data,Â &amp;free_op2Â TSRMLS_CC); variable_ptr_ptrÂ =Â _get_zval_ptr_ptr_var(opline-&gt;op1.var,Â execute_data,Â &amp;free_op1Â TSRMLS_CC); å®Œï¼
</code></pre></div></div>

<p>//åˆåˆ©ç”¨äº†op_arrayçš„ä¸€ä¸ªå±æ€§op_array&gt;T++,//æ­¤åˆ»ä»ç„¶æ˜¯ä¸ªä½ç½®å˜é‡ï¼Œè¦çŸ¥é“ä¸€ä¸ªop_arrayå¯ä»¥æœ‰nå¤šå˜é‡ï¼Œè¿™ä¸ªå±æ€§å°±åƒä¸€ä¸ªå…¨å±€æ•°ç»„ï¼Œæ‰€ä»¥ä½ç½®var//è¶³å¯ä»¥ä»£è¡¨ä¸€ä¸ªå˜é‡ã€‚</p>

<p>ä¸Šé¢åˆ†æçš„æ˜¯($)(var)çš„è¿‡ç¨‹
æ¥ä¸‹æ¥è¯¥èµ‹å€¼äº†é€šè¿‡è¯­æ³•è§£æçŸ¥é“è°ƒç”¨çš„æ˜¯zend_do_assignå‡½æ•°
åŸå‹zend_do_assign(znode *result, znode *variable, znode *value TSRMLS_DC)
resultæ˜¯è¿”å›å€¼ï¼Œvariableå°±æ˜¯ä¸Šé¢ä»‹ç»çš„å˜é‡çš„è¿”å›å€¼(result.op_type)ï¼Œvalueå°±æ˜¯å¸¸é‡1
opline-&gt;handle = ZEND_ASSIGN_SPEC_CV_CONST_HANDLER</p>

<p>åˆšæ‰è¯´è¿‡opcodeçš„è§£æé˜¶æ®µå®Œæˆï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¦æ‰§è¡Œopcodeäº†
ZEND_ASSIGN_SPEC_CV_CONST_HANDLER -&gt; _get_zval_ptr_ptr_cv_BP_VAR_W -&gt; _get_zval_cv_lookup_BP_VAR_W -&gt; zend_assign_const_to_variable</p>

<p>variable_ptr_ptr = _get_zval_ptr_ptr_cv_BP_VAR_W(execute_data, opline-&gt;op1.var TSRMLS_CC);
è¯¥å‡½æ•°åŸå‹ï¼š
static zend_always_inline zval <em>*_get_zval_ptr_ptr_cv_BP_VAR_W(const zend_execute_data *execute_data, zend_uint var TSRMLS_DC)
{
zval **</em>ptr = EX_CV_NUM(execute_data, var); //è¿™æ˜¯execute_dataçš„cvç¬¬ä¸€éƒ¨åˆ†CV[i]çš„å€¼å…¶å®æ˜¯ä¸ªæŒ‡é’ˆ</p>

<p>if (UNEXPECTED(*ptr == NULL)) {
return _get_zval_cv_lookup_BP_VAR_W(ptr, var TSRMLS_CC);//è¿™æ˜¯execute_dataçš„cvç¬¬ä¸€éƒ¨åˆ†CV[i]çš„å€¼å…¶å®æ˜¯ä¸ªæŒ‡é’ˆ,è¿™ä¸ªæŒ‡é’ˆçœŸæ­£åˆ†é…çš„ç©ºé—´(è¯¥ç©ºé—´å¯èƒ½æ˜¯execute_dataçš„cvåˆ†é…ï¼Œä¹Ÿå¯èƒ½æ˜¯ç¬¦å·è¡¨æ¥åˆ†é…ï¼Œä¸¤è€…åªèƒ½é€‰å…¶ä¸€ï¼Œæ‰€ä»¥ä»£ç é‡Œå¯ä»¥çœ‹åˆ°size_t CVs_size = ZEND_MM_ALIGNED_SIZE(sizeof(zval **) * op_array-&gt;last_var * (EG(active_symbol_table) ? 1 : 2));å¦‚æœæ²¡æœ‰ç¬¦å·è¡¨å°±éœ€è¦åˆ†é…ä¸¤å€ç©ºé—´)
}
return *ptr;
}
å¯ä»¥çœ‹åˆ°å°±æ˜¯è¿™ä¸ªå‡½æ•°åšäº†execute_dataä¸op_arrayä¹‹é—´çš„å…³è”</p>

<p>æ€»ç»“ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œopcodeè§£æé˜¶æ®µop_arrayå­˜æ”¾çš„æ˜¯å˜é‡çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œopcodeçš„æ‰§è¡Œé˜¶æ®µexecute_dataåˆ†é…ç©ºé—´å­˜æ”¾æ•°æ®,ä¸¤è€…è”ç³»å°±æ˜¯é€šè¿‡opcodeçš„å˜é‡ä½ç½®ç­‰</p>

<p>æ¥ä¸‹æ¥ç¬¬äºŒä¸ªä¾‹å­å‡½æ•°è°ƒç”¨æˆ‘ä»¬å…³æ³¨çš„æ˜¯å‚æ•°çš„ä¼ é€’ï¼Œåˆ†ä¸¤éƒ¨åˆ†(ä»ç„¶å¿½è§†æ‰è¯­æ³•è§£æç›´æ¥åˆ°è¾¾opcodeç”Ÿæˆ)ï¼Œ1 å‡½æ•°è§£æ 2 å‡½æ•°è°ƒç”¨ï¼š
&lt;?php
function foo($arg1)
{
Â  Â  print($arg1);
}</p>

<p>$bar = â€˜hello phpâ€™;
foo($bar);</p>

<p>å‡½æ•°è§£æ:
zend_do_begin_function_declaration(è¿›è¡ŒCG(active_op_array)çš„åˆ‡æ¢ï¼Œå¹¶ä¸”å°†æ–°çš„å‡½æ•°æ³¨å†Œåˆ°CG(function_table)å…¨å±€å˜é‡ä¸­) -&gt; zend_do_receive_param -&gt; zend_do_end_function_declaration(é€€å‡ºå½“å‰ï¼Œå°†ä¹‹å‰çš„op_arrayé‡ç½®)</p>

<p>zend_do_receive_param:
(åŒä¸Šå¯¹$arg1å˜é‡ä¿¡æ¯è¿›è¡Œå­˜å‚¨ï¼Œç„¶åæ¯ä¸€ä¸ªå‚æ•°å°±ä¼šè°ƒç”¨ä¸€æ¬¡receive)
è¯¥å‡½æ•°åˆ©ç”¨åˆ°äº†op_arrayçš„ä¸¤ä¸ªå±æ€§num_argsä¸arg_info</p>

<p>CG(active_op_array)-&gt;num_args++; ä½œç”¨æ˜¾è€Œæ˜“è§
ä»¥åŠcur_arg_info = &amp;CG(active_op_array)-&gt;arg_info[CG(active_op_array)-&gt;num_args-1];
å°†å‚æ•°ä¿¡æ¯è¿›è¡Œå­˜å‚¨ï¼Œå°†æ¥ç”¨æ¥è¿›è¡Œå‚æ•°ç±»å‹çš„å¯¹æ¯”æ£€æŸ¥</p>

<p>å‡½æ•°è°ƒç”¨ï¼š
zend_do_begin_function_call â€“&gt; Â zend_do_pass_param() â€“&gt; zend_do_end_function_call</p>

<p>zend_do_begin_function_call:
å‡½æ•°è§£ææ—¶æ›¾ç»æ³¨å†Œåˆ°å‡½æ•°è¡¨ï¼Œæ­¤å‡½æ•°ä¼šåˆ¤æ–­å‡½æ•°åæ˜¯å¦å­˜åœ¨
è·å–å‡½æ•°åï¼Œä¼šå°†å‡½æ•°å‹å…¥å †æ ˆï¼Œæ–¹ä¾¿å¤„ç†ä¸‹é¢å®¹æ˜“è·å–å‡½æ•°æœ¬èº«
zend_stack_push(&amp;CG(function_call_stack), (void *) &amp;function, sizeof(zend_function *));</p>

<p>zend_do_pass_paramï¼š
ä¼šå°†$barå¦‚åŒå‰é¢ä»‹ç»çš„ä¸€æ ·è¿›è¡Œå˜é‡å¤„ç†ï¼Œç„¶åç”Ÿæˆ
op-&gt;handle=ZEND_SEND_VAR_NO_REF</p>

<p>åœ¨è§£æopcodeæ—¶è°ƒç”¨çš„æ˜¯ZEND_SEND_VAR_NO_REF_SPEC_CV_HANDLERå‡½æ•°ï¼š
è¯¥å‡½æ•°å¦‚åŒä¸Šé¢ä»‹ç»ä¸€æ ·åˆ†é…äº†$barçš„å­˜å‚¨ç©ºé—´ï¼Œç„¶åéœ€è¦æ³¨æ„çš„æ˜¯zend_vm_stack_push(varptr TSRMLS_CC);
ç”¨åˆ°äº†zend_excuteç»“æ„ä¸­çš„å †æ ˆï¼Œå°†å‡½æ•°ç©ºé—´çš„æŒ‡é’ˆå‹å…¥åˆ°äº†å †æ ˆä¸­ã€‚</p>

<p>zend_do_end_function_callï¼š
op-&gt;handle=ZEND_DO_FCALL_BY_NAME</p>

<p>åœ¨è§£æopcodeæ—¶è°ƒç”¨çš„æ˜¯ZEND_DO_FCALL_BY_NAME_SPEC_HANDLERå‡½æ•°ï¼š
ä¼šå°†å‚æ•°çš„æ•°é‡å‹å…¥åˆ°å †æ ˆä¸­ï¼Œå¦‚åŒcçš„å‡½æ•°è°ƒç”¨å‹å…¥å‚æ•°ä¸€æ ·ï¼Œarg1ï¼Œarg2ï¼Œargnum
zend_vm_stack_push_args(num_args TSRMLS_CC);//æ³¨æ„å…ˆå‹å…¥å‚æ•°æ‰åˆ‡æ¢op_array
ç„¶åzend_execute(op_array);
è°ƒç”¨å®Œåå›åˆ°æœ¬å‡½æ•°è°ƒç”¨zend_vm_stack_clear_multipleè¿›è¡Œå †æ ˆé‡Šæ”¾</p>

<p>ä»è¿™ä¸€æ­¥å¼€å§‹è¿›å…¥äº†å‡½æ•°ä¸­ï¼Œè¿˜è®°å¾—å‡½æ•°çš„zend_do_receive_paramä¸­çš„op-&gt;handle=ZEND_RECV_SPEC_HANDLER:
zval **param = zend_vm_stack_get_arg(arg_num TSRMLS_CC);</p>

<p>static zend_always_inline zval** zend_vm_stack_get_arg(int requested_arg TSRMLS_DC)
{
return zend_vm_stack_get_arg_ex(EG(current_execute_data)-&gt;prev_execute_data, requested_arg);
}</p>

<p>ä¸ºä»€ä¹ˆè¦ç”¨prev_execute_dataå› ä¸ºå‡½æ•°å‹æ ˆæ˜¯åœ¨å½“å‰excute_dataä¹‹å‰çš„excute_dataå®Œæˆï¼Œ
å®é™…ä¸Šï¼Œåœ¨çœŸæ­£æ‰§è¡Œå‡½æ•°ä¹‹å‰ï¼Œphpä¼šå°†å‚æ•°ä¸ªæ•°å…¥æ ˆã€‚</p>

<p>å…ˆæ ¹æ®å‚æ•°ä¸ªæ•°æŠŠå †æ ˆä¸­çš„å‚æ•°åˆ—è¡¨å–å‡ºæ¥ï¼Œç„¶åè¿›è¡Œå‚æ•°éªŒè¯ï¼Œ
é¡ºä¾¿var_ptr = _get_zval_ptr_ptr_cv_BP_VAR_W(execute_data, opline-&gt;result.var TSRMLS_CC);
å°†å‡½æ•°çš„å‚æ•°å˜é‡$arg1è¿›è¡Œèµ‹å€¼</p>

<p>æ•´ä¸ªè¿‡ç¨‹ç»“æŸ</p>

<p>ä¸Šé¢æ˜¯æ‹†åˆ†è®²è§£ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå½“å°†æ‰€æœ‰ç¨‹åºè§£ææˆop_arrayæ•°ç»„åï¼Œå°±ä¼šè°ƒç”¨execute_exæ¥æ‰§è¡Œæ‰€æœ‰çš„opcodeæ•°ç»„ã€‚</p>

<p>zend_execute_scripts -&gt; zend_execute -&gt; zend_execute_ex -&gt; execute_ex -&gt; i_create_execute_data_from_op_array</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (0) { zend_vm_enter:
	execute_data = i_create_execute_data_from_op_array(EG(active_op_array), 1 TSRMLS_CC);
}
 
LOAD_REGS();
LOAD_OPLINE();
 
while (1) {
	int ret; #ifdef ZEND_WIN32
	if (EG(timed_out)) {
		zend_timeout(0);
	} #endif
 
	if ((ret = OPLINE-&gt;handler(execute_data TSRMLS_CC)) &gt; 0) {
		switch (ret) {
			case 1:
				EG(in_execution) = original_in_execution;
				return;
			case 2:
				goto zend_vm_enter;
				break;
			case 3:
				execute_data = EG(current_execute_data);
				break;
			default:
				break;
		}
	}
 
}
zend_error_noreturn(E_ERROR, "Arrived at end of main loop which shouldn't happen"); } ä»¥ä¸Šæ˜¯ä¸ªæ­»å¾ªç¯ï¼Œè§£æop_arrayæ•°ç»„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿”å›å€¼ #defineÂ ZEND_VM_CONTINUE()Â Â Â Â Â Â Â Â Â returnÂ 0 #defineÂ ZEND_VM_RETURN()Â Â Â Â Â Â Â Â Â Â Â returnÂ 1   è¿”å›returnæ˜¯å‡½æ•°ç»ˆæ­¢ï¼Œ #defineÂ ZEND_VM_ENTER()Â Â Â Â Â Â Â Â Â Â Â Â returnÂ 2  å‡½æ•°è°ƒç”¨ #defineÂ ZEND_VM_LEAVE()Â Â Â Â Â Â Â Â Â Â Â Â returnÂ 3  å‡½æ•°é€€å‡º ZEND_VM_RETURNå‡½æ•°è¿”å›returenç»ˆæ­¢ï¼Œ5.2ç‰ˆæœ¬å¾ˆå°‘æœ‰è¿”å›1ï¼Œä½†æ˜¯5.3å¢åŠ äº†yieldè°ƒç”¨åï¼Œyieldè°ƒç”¨çš„opcodeåŸºæœ¬ä¸Šéƒ½ä¼šè¿”å›1ï¼Œä»è€Œ å‡½æ•°ç»ˆæ­¢ï¼Œæœ‰ä¸ªç–‘é—®ï¼Œreturnäº†åä¸‹é¢å¦‚ä½•æ‰§è¡Œï¼Ÿ è¿™é‡Œé¢æœ‰ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œå½“æˆ‘ä»¬è°ƒç”¨å‡½æ•°çš„æ—¶å€™å¤§å®¶çŸ¥é“opcodeè§£æçš„å‡½æ•°æ˜¯ zend_do_fcall_common_helper_SPEC  è¯¥å‡½æ•°åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ typedef union _zend_function { zend_uchar type; /* î›–...ï¹š... #define ZEND_USER_FUNCTION 2 MUST be the first element of this struct! */ struct { zend_uchar type; /* never used */ char *function_name; //ã„§.îš½. zend_class_entry *scope; //ã„§.â”®î›ˆî€™.îœ†.åŠ zend_uint fn_flags; // îœ†..çŒ­.î€™...î©å•î“‡î›–ZEND_ACC_STATICå• union _zend_function *prototype; //ã„§.î…¥î© zend_uint num_args; //.... zend_uint required_num_args; //æƒ ç’¶î€™.... zend_arg_info *arg_info; //..çºî…¾î‚¹. zend_bool pass_rest_by_reference; unsigned char return_reference; //îî›„î… } common; zend_op_array op_array; //ã„§.ã„î€™å·¨îœ† zend_internal_function internal_function; } zend_function;
</code></pre></div></div>

<p>1 å†…éƒ¨Cå‡½æ•°(ZEND_INTERNAL_FUNCTION):å†…éƒ¨å‡½æ•°åœ¨zend_register_functionsæ—¶å€™å°±æ³¨å†Œåˆ°äº†å‡½æ•°è¡¨ï¼Œå…¶ä¸­internal_function.handleræŒ‡å‘Cå‡½æ•°(å‡½æ•°æŒ‡é’ˆ)
é€šè¿‡opcodeè§£æå‡½æ•°ååˆ°å‡½æ•°è¡¨ä¸­æŸ¥æ‰¾å³å¯è·å–åˆ°å‡½æ•°æŒ‡é’ˆï¼Œè¿›è¡Œè°ƒç”¨
2 phpå‡½æ•°(ZEND_USER_FUNCTION):ä¼šç»§ç»­è°ƒç”¨zend_executeï¼Œæ‰€ä»¥åˆšæ‰è¯´çš„ZEND_VM_RETURNç»ˆæ­¢çš„åªæ˜¯å…·ä½“æŸä¸ªå‡½æ•°è€Œå·²ï¼Œå¤§å®¶å¦‚æœåœ¨ä¸€ä¸ªå‡½æ•°
ä¸­å†™yieldï¼Œå‡½æ•°å°±ä¸ä¼šç»§ç»­æ‰§è¡Œäº†ï¼Œå°±æ˜¯è¿™ä¸ªé“ç†ã€‚</p>

<p>é¡ºå¸¦ç€ä»‹ç»ä¸‹è¯æ³•è§£æè¿‡ç¨‹</p>

<p>Zend/zend_language_scanner.l Â è¯æ³•è§£æè§„åˆ™æ–‡ä»¶
Zend/zend_language_parser.y Â  è¯­æ³•åˆ†æè§„åˆ™æ–‡ä»¶</p>

<p>bison -o zend_language_parser.cÂ zend_language_parser.y
åœ¨Zendç›®å½•ä¸‹å°±ä¼šç”Ÿæˆè¯­æ³•è§£æå™¨zend_language_parser.cã€‚
yyarseï¼ˆï¼‰æ˜¯bisonç”Ÿæˆçš„åˆ†æå™¨çš„ä¸»å‡½æ•°ã€‚Â è°ƒç”¨yyarse()ï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œé‚£ä¹ˆä¸Šä¾‹ä¸­çš„g_rootå°†æŒ‡å‘ä¸€ä¸ªå®Œæˆçš„è¯­æ³•æ ‘ã€‚
#define yylex zendlex
#define YYSTYPE znode
yyparse -&gt; zendlex -&gt;Â lex_scan
lex_scanä¼šè§£æYYSTYPEå­—æ®µï¼Œå¹¶ä¸”å°†znode.u.constantè¿›è¡Œè¯æ³•è§£æèµ‹å€¼æ•°æ®</p>

<p>è¯­æ³•æ‰«æ(lex_scan)å‰éƒ½ä¼šè¿›è¡Œè¯¥å‡½æ•°è°ƒç”¨è¿›è¡Œå‡†å¤‡ï¼Œå¯ä»¥å‚è€ƒå‡½æ•°token_get_allçš„å®ç°</p>

<p>static void yy_scan_buffer(char <em>str, unsigned int len TSRMLS_DC)
{
	YYCURSOR = (YYCTYPE</em>)str;
	SCNG(yy_start) = YYCURSOR;
	YYLIMIT  = YYCURSOR + len;
}</p>

<p>é¡ºä¾¿è¯´ä¸€ä¸‹php7ï¼š</p>

<p>compile_file -&gt; zendparse(yyparse) -&gt; zend_compile_top_stmt -&gt; zend_compile_stmt ç”Ÿæˆopcodeï¼Œå› ä¸ºphp7ä¸­é—´ç”¨äº†æŠ½è±¡è¯­æ³•æ ‘ï¼Œ
éœ€è¦æ ¹æ®æŠ½è±¡è¯­æ³•æ ‘çš„èŠ‚ç‚¹è¿›è¡Œåˆ†æåè·å¾—æœ€çš„opcode
åœ¨è¿™é‡Œè¡¥å……ä¸‹ä¸€ä¸ªçŸ¥è¯†ç‚¹:
ZEND_ASSIGN_ADD_SPEC_VAR_CONST_HANDLER 
	if (RETURN_VALUE_USED(opline)) {
		PZVAL_LOCK(<em>var_ptr);
		EX_T(opline-&gt;result.var).var.ptr = *var_ptr;
	}
è¿™é‡Œæ”¾çš„æ˜¯ä¸´æ—¶å˜é‡çš„varå±æ€§ptrï¼Œä¸ºä»€ä¹ˆæ˜¯æŒ‡é’ˆï¼Œè€Œä¸æ˜¯ä¸‹é¢çš„tmp_var,æ˜¯å› ä¸ºptræŒ‡å‘çš„zvalæ˜¯ä¸èƒ½ç«‹é©¬é‡Šæ”¾çš„ï¼Œæ˜¯éœ€è¦assign
èµ‹å€¼ç»™å…¶ä»–å˜é‡ç”¨ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ª</em>zal å…±åŒæŒ‡å‘çš„ç»“æ„ï¼Œè¿™ä¸ªæ—¶å€™é‡‡ç”¨çš„å°±æ˜¯å­˜æ”¾åˆ°ä¸´æ—¶å˜é‡çš„varä¸­çš„ptrå±æ€§ã€‚
å†çœ‹ä¸ªä¾‹å­
ZEND_ADD_SPEC_CV_TMP_HANDLER
static int ZEND_FASTCALL  ZEND_ADD_SPEC_CV_TMP_HANDLER(ZEND_OPCODE_HANDLER_ARGS)
{
	USE_OPLINE
	zend_free_op free_op2;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SAVE_OPLINE();
fast_add_function(&amp;EX_T(opline-&gt;result.var).tmp_var,
	_get_zval_ptr_cv_BP_VAR_R(execute_data, opline-&gt;op1.var TSRMLS_CC),
	_get_zval_ptr_tmp(opline-&gt;op2.var, execute_data, &amp;free_op2 TSRMLS_CC) TSRMLS_CC);
 
zval_dtor(free_op2.var);
CHECK_EXCEPTION();
ZEND_VM_NEXT_OPCODE(); } å¾ˆæ˜æ˜¾æ”¾åˆ°äº†èµ‹å€¼ç»™äº†ä¸´æ—¶å˜é‡ï¼Œä¸ºä»€ä¹ˆæ˜¯ä¸´æ—¶å˜é‡ï¼Œå› ä¸ºè¯¥å˜é‡ä¸å¼•ç”¨å…¶ä»–æŒ‡é’ˆæ•°æ®ï¼Œæ‰€ä»¥é‡Šæ”¾æ¯”è¾ƒç®€å•
</code></pre></div></div>

<p>a++çš„opcode
zend_do_post_incdec çš„opcode opline-&gt;result_type = IS_TMP_VAR;å¾ˆæ˜æ˜¾æ˜¯ä¸ªtmpå˜é‡</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>opline = get_next_op(CG(active_op_array) TSRMLS_CC);
opline-&gt;opcode = op;
SET_NODE(opline-&gt;op1, op1);
SET_UNUSED(opline-&gt;op2);
opline-&gt;result_type = IS_TMP_VAR;
opline-&gt;result.var = get_temporary_variable(CG(active_op_array));
GET_NODE(result, opline-&gt;result);
</code></pre></div></div>

<p>static int ZEND_FASTCALL  ZEND_POST_INC_SPEC_VAR_HANDLER(ZEND_OPCODE_HANDLER_ARGS)
{
	USE_OPLINE
	zend_free_op free_op1;
	zval **var_ptr, *retval;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SAVE_OPLINE();
var_ptr = _get_zval_ptr_ptr_var(opline-&gt;op1.var, execute_data, &amp;free_op1 TSRMLS_CC);
 
if (IS_VAR == IS_VAR &amp;&amp; UNEXPECTED(var_ptr == NULL)) {
	zend_error_noreturn(E_ERROR, "Cannot increment/decrement overloaded objects nor string offsets");
}
if (IS_VAR == IS_VAR &amp;&amp; UNEXPECTED(*var_ptr == &amp;EG(error_zval))) {
	ZVAL_NULL(&amp;EX_T(opline-&gt;result.var).tmp_var);
	if (free_op1.var) {zval_ptr_dtor_nogc(&amp;free_op1.var);};
	CHECK_EXCEPTION();
	ZEND_VM_NEXT_OPCODE();
}
 
retval = &amp;EX_T(opline-&gt;result.var).tmp_var;
ZVAL_COPY_VALUE(retval, *var_ptr);
zendi_zval_copy_ctor(*retval); å½“è¿”å›çš„æ˜¯tmp_varå˜é‡æ—¶ï¼Œè¯´æ˜è¯¥å˜é‡åªæ˜¯ä¸ªä¸´æ—¶å€¼ä¸ä¼šåšé¢å¤–çš„æ“ä½œï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦å¢åŠ gc_recount++ç­‰æ“ä½œï¼Œç›´æ¥å †æ ˆé‡Šæ”¾å³å¯ã€‚ ++açš„opcodeï¼šopline-&gt;result_type = IS_VAR; IS_VARç±»å‹

opline = get_next_op(CG(active_op_array) TSRMLS_CC);
opline-&gt;opcode = op;
SET_NODE(opline-&gt;op1, op1);
SET_UNUSED(opline-&gt;op2);
opline-&gt;result_type = IS_VAR;
opline-&gt;result.var = get_temporary_variable(CG(active_op_array));
GET_NODE(result, opline-&gt;result);
</code></pre></div></div>

<p>è§£æåï¼š
	if (RETURN_VALUE_USED(opline)) {
		PZVAL_LOCK(*var_ptr);
		EX_T(opline-&gt;result.var).var.ptr = *var_ptr;
	}</p>

<p>æ­¤æ—¶è¿”å›çš„varçš„ä¸´æ—¶å˜é‡å¢åŠ äº†gc_recount++ï¼Œæ‰€ä»¥è¯¥è¿”å›å€¼è¢«åˆ«äººç”¨çš„æ—¶å€™ï¼Œå°±éœ€è¦æœ‰ä¸ªé‡Šæ”¾çš„è¿‡ç¨‹ï¼Œ
static zend_always_inline zval <strong>_get_zval_ptr_ptr_var(zend_uint var, const zend_execute_data *execute_data, zend_free_op *should_free TSRMLS_DC)
{
	zval</strong> ptr_ptr = EX_T(var).var.ptr_ptr;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (EXPECTED(ptr_ptr != NULL)) {
	PZVAL_UNLOCK(*ptr_ptr, should_free);
} else {
	/* string offset */
	PZVAL_UNLOCK(EX_T(var).str_offset.str, should_free);
}
return ptr_ptr; } è·å–è¯¥å˜é‡å€¼é€šè¿‡è¯¥å‡½æ•°ï¼Œæ‰€ä»¥å°±ä¼šè¿›è¡Œé‡Šæ”¾gc_recount--. varå’Œtmpç±»å‹çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Œå¤§å®¶éƒ½æ˜¯æ”¾åœ¨tmpåˆ†é…çš„å †æ ˆä¸­ï¼ŒåŒºåˆ«å°±æ˜¯ï¼Œvar.ptr_ptræ˜¯ä¸ªæŒ‡é’ˆï¼Œä¸ºäº†èŠ‚çœç©ºé—´å¤§å®¶ç›®å‰å…ˆå…±ç”¨ï¼Œæ¯”å¦‚++aï¼Œè¿”å›çš„ä¸´æ—¶å˜é‡å’Œå˜é‡aè¿”å›å€¼ä¸€æ ·ï¼Œæ‰€ä»¥å°±ç”¨æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªzvalï¼Œæ¯”å¦‚a++ï¼Œè¿”å›å€¼çš„ä¸´æ—¶å˜é‡å’Œå˜é‡aè¿”å›å€¼ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å¿…é¡»é‡æ–°ç”³è¯·ä¸€ä¸ªzvalï¼Œæ‰€ä»¥å°±å¹²è„†æ‰”åˆ°äº†tmpä¸­ï¼Œå¯ä»¥éšæ—¶é‡Šæ”¾ã€‚
</code></pre></div></div>

<p>https://blog.csdn.net/xiaolei1982/article/details/52140544
https://blog.csdn.net/xiaolei1982/article/details/20584291
http://www.phppan.com/2012/02/php-execute-data/</p>

<p>https://type.so/c/php-extension-in-action-get-arguments-after-zend-execute-ex.html</p>
:ET