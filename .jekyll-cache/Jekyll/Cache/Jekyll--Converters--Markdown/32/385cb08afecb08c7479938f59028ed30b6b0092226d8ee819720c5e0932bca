I"Æ<p>å½“nginxæ”¶åˆ°å¦‚ä¸Šé”™è¯¯ç æ—¶ï¼Œå¯ä»¥ç¡®å®šåç«¯php-fpmè§£æphpå‡ºäº†æŸç§é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œæ‰§è¡Œé”™è¯¯ï¼Œæ‰§è¡Œè¶…æ—¶ã€‚</p>

<p>php-fpm.confçš„é…ç½®æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªå‚æ•°request_slowlog_timeoutæ˜¯è¿™æ ·æè¿°çš„</p>

<p>; The timeout for serving a single request after which a PHP backtrace will be
; dumped to the â€˜slowlogâ€™ file. A value of â€˜0sâ€™ means â€˜offâ€™.
; Available units: s(econds)(default), m(inutes), h(ours), or d(ays)
; Default Value: 0
;request_slowlog_timeout = 0</p>

<p>å½“request_slowlog_timeout è®¾ä¸ºä¸€ä¸ªå…·ä½“ç§’æ—¶request_slowlog_timeout =5ï¼Œè¡¨ç¤ºå¦‚æœå“ªä¸ªè„šæœ¬æ‰§è¡Œæ—¶é—´å¤§äº5ç§’ï¼Œä¼šè®°å½•è¿™ä¸ªè„šæœ¬åˆ°æ…¢æ—¥å¿—æ–‡ä»¶ä¸­</p>

<p>request_slowlog_timeout =0è¡¨ç¤ºå…³é—­æ…¢æ—¥å¿—è¾“å‡ºã€‚</p>

<p>æ…¢æ—¥å¿—æ–‡ä»¶ä½ç½®é»˜è®¤åœ¨phpçš„å®‰è£…ç›®å½•ä¸‹çš„logæ–‡ä»¶å¤¹ä¸­ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹slowlog = log/$pool.log.slowå‚æ•°æ¥æŒ‡å®šã€‚</p>

<p>php-fpmæ…¢æ—¥å¿—çš„ä¾‹å­ï¼Œæ…¢æ—¥å¿—ä¼šè®°å½•ä¸‹è¿›ç¨‹å·ï¼Œè„šæœ¬åç§°ï¼Œå…·ä½“å“ªä¸ªæ–‡ä»¶å“ªè¡Œä»£ç çš„å“ªä¸ªå‡½æ•°æ‰§è¡Œæ—¶é—´è¿‡é•¿</p>

<!-- more -->
<p>[21-Nov-2013 14:30:38] [pool www] pid 11877
script_filename = /usr/local/lnmp/nginx/html/www.quancha.cn/www/fyzb.php
[0xb70fb88c] file_get_contents() /usr/local/lnmp/nginx/html/www.quancha.cn/www/fyzb.php:2
[21-Nov-2013 14:15:23] ERROR: [pool www] â€˜slowlogâ€™ must be specified for use with â€˜request_slowlog_timeoutâ€™</p>

<p>request_slowlog_timeout å’Œ slowlogéœ€è¦åŒæ—¶è®¾ç½®ï¼Œå¼€å¯request_slowlog_timeoutçš„åŒæ—¶éœ€è¦å¼€å¯ slowlog</p>

<p>[21-Nov-2013 14:16:27] ERROR: Unable to create or open slowlog(/usr/local/lnmp/php/log/www.log.slow): No such file or directory (2)</p>

<p>æ…¢æ—¥å¿—è·¯å¾„éœ€è¦æ‰‹åŠ¨åˆ›å»º
å…·ä½“å¼€å¯php-fpmæ…¢æ—¥å¿—æ­¥éª¤ï¼š</p>

<p>cd /usr/local/lnmp/php</p>

<p>vi etc/php-fpm.conf
å»æ‰request_slowlog_timeout ã€slowlogçš„å‰ç¼€åˆ†å·â€™;â€™ï¼Œè®¾ç½®request_slowlog_timeout =5ï¼›
:wq
ä¿å­˜é€€å‡º</p>

<p>åˆ›å»ºæ…¢æ—¥å¿—ç›®å½•
mkdir log</p>

<p>é‡å¯php-fpm
kill -INT `cat var/run/php-fpm.pid
sbin/php-fpm</p>

<p>æ…¢æ—¥å¿—è·¯å¾„éœ€è¦æ‰‹åŠ¨åˆ›å»º</p>

<p>å…·ä½“å¼€å¯php-fpmæ…¢æ—¥å¿—æ­¥éª¤ï¼š</p>

<p>cd /usr/local/lnmp/php</p>

<p>vi etc/php-fpm.conf
å»æ‰request_slowlog_timeout ã€slowlogçš„å‰ç¼€åˆ†å·â€™;â€™ï¼Œè®¾ç½®request_slowlog_timeout =5ï¼›</p>

<p>:wq
ä¿å­˜é€€å‡º</p>

<p>åˆ›å»ºæ…¢æ—¥å¿—ç›®å½•
mkdir log</p>

<p>é‡å¯php-fpm
kill -INT `cat var/run/php-fpm.pid
sbin/php-fpm</p>

<p>PHP-FPMçš„é”™è¯¯æ—¥å¿—å»ºè®®æ‰“å¼€ï¼Œè¿™æ ·å¯ä»¥çœ‹åˆ°PHPçš„é”™è¯¯ä¿¡æ¯ï¼š
ä¸€èˆ¬æ˜¯è¿™ä¸ªé…ç½®è·¯å¾„ /etc/php/7.3/fpm/pool.d/www.confï¼Œæ—¥å¿—ç›®å½•å¦‚æœéœ€è¦è‡ªå·±å»ºç«‹PHPç›®å½•ï¼Œä¸€å®šè¦æŠŠæƒé™èµ‹ç»™www-dataç”¨æˆ·ï¼Œå¦åˆ™æ²¡æœ‰åˆ›å»ºç›®å½•çš„æƒé™ï¼Œå°±æ— æ³•è®°å½•æ—¥å¿—
chown www-data:www-data /var/log/php/</p>

<p>php_flag[display_errors] = on
php_admin_value[error_log] = /var/log/php/www.error.log
php_admin_flag[log_errors] = on</p>

<p>è¿˜å¯ä»¥æŠŠphpçš„accessæ—¥å¿—ä¹Ÿæ‰“å¼€ï¼Œæ˜¯åœ¨åŒä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­
access.log = /var/log/php/www.access.log</p>

<p>æœ€åè¿˜æœ‰ä¸€ä¸ªæ…¢æ—¥å¿—çš„è®°å½•ä¹Ÿå¯ä»¥æ‰“å¼€
slowlog = /var/log/php/www.log.slow
request_slowlog_timeout = 10</p>

<p>é…ç½®æ–‡ä»¶ï¼š</p>

<p>request_slowlog_timeout = 1s
slowlog = /var/log/www.log.slow
request_terminate_timeout = 3s</p>

<p>æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶:</p>

<p>-rwxrwxrwx 1 www-data www-data 2663 Sep 28 09:49 fpm-php.www.log
-rwxrwxrwx 1 www-data www-data 0 Sep 28 09:00 www.log.slow</p>

<p>ä»£ç ï¼š</p>

<p>&lt;?php
sleep(3);
var_dump(11);
åœ¨nginxä»£ç†ä¸‹çš„æ‰§è¡Œç»“æœï¼š</p>

<p>Status Code:502 Bad Gateway</p>

<p>php-fpm æ—¥å¿—ï¼š</p>

<p>[28-Sep-2017 11:20:04] WARNING: [pool www] child 130, script â€˜test.phpâ€™ (request: â€œGET /test.phpâ€) execution timed out (2.990237 sec), terminating</p>

<p>PS:
1 fpmæˆ‘å°è¯•è¿‡rootç”¨æˆ·è¿è¡Œ
2 é…ç½®æ–‡ä»¶æ”¹æˆè¿™æ ·è¿˜æ˜¯è®°å½•ä¸äº†æ—¥å¿—ï¼š</p>

<p>request_slowlog_timeout = 1s</p>

<p>request_terminate_timeout = 30s</p>

<p>request_terminate_timeout = 3s
è¿™æ¡è¯­å¥ç”Ÿæ•ˆã€‚å¯¼è‡´è¿›ç¨‹è¢«å¹²æ‰äº†ã€‚è¯·æ±‚è¿˜æ²¡ç»“æŸï¼Œæ‰€ä»¥æ…¢æ—¥å¿—è¿˜æ²¡æ¥å¾—åŠå†™å…¥</p>

:ET