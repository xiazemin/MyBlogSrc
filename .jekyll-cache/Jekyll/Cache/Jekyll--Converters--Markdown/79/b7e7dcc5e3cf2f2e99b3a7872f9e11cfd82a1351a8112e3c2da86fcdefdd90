I"ŞY<p>ä¸¤ä¸ªåŸºç¡€é™æµç®—æ³•æ˜¯æ¼æ–—ç®—æ³•å’Œä»¤ç‰Œç®—æ³•
åˆ†å¸ƒå¼é™æµ
å¦‚æœä½ çš„åº”ç”¨æ˜¯å•ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹ˆé™æµå°±å¾ˆç®€å•ï¼Œè¯·æ±‚çš„è®¡æ•°ç®—æ³•éƒ½å¯ä»¥åœ¨å†…å­˜é‡Œå®Œæˆã€‚é™æµç®—æ³•å‡ ä¹æ²¡æœ‰æŸè€—ï¼Œéƒ½æ˜¯çº¯å†…å­˜çš„è®¡ç®—ã€‚ä½†æ˜¯äº’è”ç½‘ä¸–ç•Œçš„åº”ç”¨éƒ½æ˜¯å¤šèŠ‚ç‚¹çš„åˆ†å¸ƒå¼çš„ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„è¯·æ±‚å¤„ç†èƒ½åŠ›è¿˜ä¸ä¸€å®šä¸€æ ·ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„æ˜¯è¿™å¤šä¸ªèŠ‚ç‚¹çš„æ•´ä½“è¯·æ±‚å¤„ç†èƒ½åŠ›ã€‚
å•ä¸ªè¿›ç¨‹çš„å¤„ç†èƒ½åŠ›æ˜¯1w QPS å¹¶ä¸æ„å‘³ç€æ•´ä½“çš„è¯·æ±‚å¤„ç†èƒ½åŠ›æ˜¯ N * 1w QPSï¼Œå› ä¸ºæ•´ä½“çš„å¤„ç†èƒ½åŠ›è¿˜ä¼šæœ‰å…±äº«èµ„æºçš„èƒ½åŠ›é™åˆ¶ã€‚è¿™ä¸ªå…±äº«èµ„æºä¸€èˆ¬æ˜¯æŒ‡æ•°æ®åº“ï¼Œä¹Ÿå¯ä»¥æ˜¯åŒä¸€å°æœºå™¨çš„å¤šä¸ªè¿›ç¨‹å…±äº«çš„ CPU å’Œ ç£ç›˜ ç­‰èµ„æºï¼Œè¿˜æœ‰ç½‘ç»œå¸¦å®½å› ç´ ä¹Ÿä¼šåˆ¶çº¦æ•´ä½“çš„è¯·æ±‚é‡ã€‚
è¿™æ—¶å€™è¯·æ±‚çš„è®¡æ•°ç®—æ³•å°±éœ€è¦é›†ä¸­åœ¨ä¸€ä¸ªåœ°æ–¹ï¼ˆé™æµä¸­é—´ä»¶ï¼‰æ¥å®Œæˆã€‚åº”ç”¨ç¨‹åºåœ¨å¤„ç†è¯·æ±‚ä¹‹å‰éƒ½éœ€è¦å‘è¿™ç§é›†ä¸­ç®¡ç†å™¨ç”³è¯·æµé‡ï¼ˆç©ºæ°”ã€ä»¤ç‰Œæ¡¶ï¼‰ã€‚ æ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦ä¸€æ¬¡ç½‘ç»œ IOï¼Œä»åº”ç”¨ç¨‹åºåˆ°é™æµä¸­é—´ä»¶ä¹‹é—´ã€‚</p>

<p>æ¯”å¦‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Redis + Lua æ¥å®ç°è¿™ä¸ªé™æµåŠŸèƒ½ï¼Œä½†æ˜¯ Lua çš„æ€§èƒ½è¦æ¯” C å¼±å¾ˆå¤šï¼Œé€šå¸¸è¿™ä¸ªé™æµç®—æ³•èƒ½è¾¾åˆ° 1w å·¦å³çš„ QPSå°±åˆ°é¡¶äº†ã€‚è¿˜å¯ä»¥ä½¿ç”¨ Redis-Cell æ¨¡å—ï¼Œå…¶å†…éƒ¨ä½¿ç”¨ Rust å®ç°ï¼Œå®ƒèƒ½è¾¾åˆ° 5w å·¦å³çš„ QPS ä¹Ÿå°±åˆ°æé™äº†ã€‚è¿™æ—¶å€™å®ƒä»¬éƒ½è¿›å…¥äº†æ»¡è´Ÿè·çŠ¶æ€ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬ä¸ä¼šå¸Œæœ›å®ƒä»¬ä¸€ç›´æ»¡è´Ÿè·å·¥ä½œã€‚
é‚£å¦‚ä½•å®Œæˆ 10w QPS çš„é™æµå‘¢ï¼Ÿ
ä¸€ä¸ªç®€å•çš„æƒ³æ³•å°±æ˜¯å°†é™æµçš„ key åˆ†æ¡¶ï¼Œç„¶åä½¿ç”¨ Redis é›†ç¾¤æ¥æ‰©å®¹ï¼Œè®©é™æµçš„ç”³è¯·æŒ‡ä»¤ç»è¿‡å®¢æˆ·ç«¯çš„ hash åˆ†æ¡¶åæ‰“æ•£çš„é›†ç¾¤çš„å¤šä¸ªå‡ ç‚¹ï¼Œå€Ÿæ­¤åˆ†æ•£å‹åŠ›ã€‚
é‚£å¦‚ä½•å®Œæˆ ç™¾ä¸‡ QPS ï¼ˆ1Mï¼‰çš„é™æµå‘¢ï¼Ÿ
å¦‚æœè¿˜ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•é‚£éœ€è¦çš„å¸¦å®½èµ„æºå’ŒRediså®ä¾‹ä¹Ÿæ˜¯æƒŠäººçš„ã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦å‡ åä¸ª Redis èŠ‚ç‚¹ï¼Œå¤–åŠ ä¸Šç™¾Mï¼ˆ1M * 20 å­—èŠ‚ * 8ï¼‰ çš„å¸¦å®½æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚
è¿™æ—¶æˆ‘ä»¬å¿…é¡»è½¬æ¢æ€è·¯ï¼Œä¸å†ä½¿ç”¨è¿™ç§é›†ä¸­ç®¡æ§çš„æ–¹å¼æ¥å·¥ä½œäº†ã€‚
æˆ‘ä»¬å°†æ•´ä½“çš„ QPS æŒ‰ç…§æƒé‡åˆ†æ•£å¤šæ¯ä¸ªå­èŠ‚ç‚¹ï¼Œæ¯ä¸ªå­—èŠ‚ç‚¹åœ¨å†…å­˜ä¸­è¿›è¡Œå•æœºé™æµã€‚å¦‚æœæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œé‚£ä¹ˆæ¯ä¸ªå­èŠ‚ç‚¹å°±å¯ä»¥åˆ†å¾— 1/n çš„ QPSã€‚
å®ƒçš„ä¼˜ç‚¹åœ¨äºåˆ†æ•£äº†é™æµå‹åŠ›ï¼Œå°† IO æ“ä½œå˜æˆçº¯å†…å­˜è®¡ç®—ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆè½»æ¾åœ°åº”å¯¹è¶…é«˜çš„ QPS é™æµã€‚ä½†æ˜¯è¿™ä¹Ÿå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œéœ€è¦æœ‰ä¸€ä¸ªé›†ä¸­çš„é…ç½®ä¸­å¿ƒæ¥å‘æ¯ä¸ªå­èŠ‚ç‚¹æ¥åˆ†å‘ QPS é˜ˆå€¼ï¼Œéœ€è¦æ¯ä¸ªåº”ç”¨å­—èŠ‚ç‚¹å‘è¿™ä¸ªé…ç½®ä¸­å¿ƒè¿›è¡Œæ³¨å†Œï¼Œéœ€è¦æœ‰ä¸€ä¸ªé…ç½®ç®¡ç†åå°æ¥å¯¹ç³»ç»Ÿçš„ QPS åˆ†é…è¿›è¡Œç®¡ç†ã€‚
<!-- more --></p>
<ol>
  <li>æ¥å£å®šä¹‰
package ratelimit</li>
</ol>

<p>import â€œtimeâ€</p>

<p>// é™æµå™¨æ¥å£
type Limiter interface {
    Acquire() error
    TryAcquire() bool
}</p>

<p>// é™æµå®šä¹‰æ¥å£
type Limit interface {
    Name() string
    Key() string
    Period() time.Duration
    Count() int32
    LimitType() LimitType
}</p>

<p>// æ”¯æŒ burst
type BurstLimit interface {
    Limit
    BurstCount() int32
}</p>

<p>// åˆ†å¸ƒå¼å®šä¹‰çš„ burst
type DistLimit interface {
    Limit
    ClusterNum() int32
}</p>

<p>type LimitType int32
const (
    CUSTOM LimitType = iota
    IP
)
Limiter æ¥å£å‚è€ƒäº† Google çš„ guava åŒ…é‡Œçš„ Limiter å®ç°ã€‚Acquire æ¥å£æ˜¯é˜»å¡æ¥å£ï¼Œå…¶å®è¿˜éœ€è¦åŠ ä¸Š context æ¥ä¿è¯è°ƒç”¨é“¾å®‰å…¨ï¼Œå› ä¸ºå®é™…é¡¹ç›®ä¸­å¹¶æ²¡æœ‰ç”¨åˆ° Acquire æ¥å£ï¼Œæ‰€ä»¥æ²¡æœ‰å®ç°å®Œå–„ï¼›åŒç†ï¼Œè¶…æ—¶æ—¶é—´çš„æ”¯æŒä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ æ–°æ¥å£ç»§æ‰¿è‡ª Limiter æ¥å£æ¥å®ç°ã€‚TryAcquire ä¼šç«‹å³è¿”å›ã€‚</p>

<p>Limit æŠ½è±¡äº†ä¸€ä¸ªé™æµå®šä¹‰ï¼ŒKey() æ–¹æ³•è¿”å›è¿™ä¸ª Limit çš„å”¯ä¸€æ ‡è¯†ï¼ŒName() ä»…ä½œè¾…åŠ©ï¼ŒPeriod() è¡¨ç¤ºå‘¨æœŸï¼Œå•ä½æ˜¯ç§’ï¼ŒCount() è¡¨ç¤ºå‘¨æœŸå†…çš„æœ€å¤§æ¬¡æ•°ï¼ŒLimitType(ï¼‰è¡¨ç¤ºæ ¹æ®ä»€ä¹ˆæ¥åšåŒºåˆ†ï¼Œå¦‚ IPï¼Œé»˜è®¤æ˜¯ CUSTOM.</p>

<p>BurstLimit æä¾›çªå‘çš„èƒ½åŠ›ï¼Œä¸€èˆ¬æ˜¯é…åˆä»¤ç‰Œæ¡¶ç®—æ³•ã€‚DistLimit æ–°å¢ ClusterNum() æ–¹æ³•ï¼Œå› ä¸º mentor è¦æ±‚åˆ†å¸ƒå¼é‡åˆ°é”™è¯¯çš„æ—¶å€™ï¼Œéœ€è¦é€€åŒ–ä¸ºå•æœºç‰ˆæœ¬ï¼Œé€€åŒ–çš„ç­–ç•¥å³æ˜¯ï¼š2 èŠ‚ç‚¹æ€»å…± 100QPSï¼Œå¦‚æœå‡ºç°åˆ†åŒºï¼Œæ¯ä¸ªèŠ‚ç‚¹éœ€è¦è°ƒæ•´ä¸ºå„ 50QPS</p>

<p>https://github.com/GuoZhaoran/rateLimit
https://github.com/GuoZhaoran/Go-RateLimit</p>

<p>ä»¤ç‰Œæ¡¶çš„çŠ¶æ€å˜é‡å¾—æ”¾åœ¨ä¸€ä¸ª çº¿ç¨‹å®‰å…¨/ä¸€è‡´ çš„åœ°æ–¹ï¼Œredis æ˜¯ä¸äºŒäººé€‰ã€‚ä½†æ˜¯ä»¤ç‰Œæ¡¶çš„ç®—æ³•æ ¸å¿ƒæ˜¯ä¸ªå»¶è¿Ÿè®¡ç®—å¾—åˆ°ä»¤ç‰Œæ•°é‡ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªå¾ˆé•¿çš„ä¸´ç•ŒåŒºï¼Œæ‰€ä»¥è¦ä¹ˆç”¨åˆ†å¸ƒå¼é”ï¼Œè¦ä¹ˆç›´æ¥åˆ©ç”¨ redis çš„å•çº¿ç¨‹ä»¥åŸå­æ–¹å¼è·‘ã€‚ä¸€èˆ¬ä¸šç•Œæ˜¯åè€…ï¼Œå³ lua è„šæœ¬ç»´æŠ¤ä»¤ç‰Œæ¡¶çš„çŠ¶æ€å˜é‡ã€è®¡ç®—ä»¤ç‰Œã€‚</p>

<p>phpå®ç°æ¼æ¡¶ç®—æ³•
Redisä¸­è®¾ç½®æ¥å£é™åˆ¶1så†…è®¿é—®100æ¬¡çš„hash:</p>

<p>hmset org1/user/list expire 1 limitReq 100
æˆ‘ä»¬ä½¿ç”¨Predisè¿æ¥redisè¿›è¡Œæ“ä½œï¼Œæ¨¡æ‹Ÿæ¥å£æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬åªè·å–ä¸¤ä¸ªå‚æ•°ï¼Œorgå’ŒpathInfo,RateLimitç±»ä¸­ç›¸å…³æ–¹æ³•æ˜¯ï¼š</p>

<p>&lt;?php
/**</p>
<ul>
  <li>Description: æ¼æ¡¶é™æµ</li>
  <li>User: guozhaoran<a href="mailto:guozhaoran@cmcm.com">guozhaoran@cmcm.com</a></li>
  <li>Date: 2019-06-13
 */</li>
</ul>

<p>class RateLimit
{
    private $conn = null;       //redisè¿æ¥
    private $org = â€˜â€™;          //å…¬å¸æ ‡è¯†
    private $pathInfo = â€˜â€™;     //æ¥å£è·¯å¾„ä¿¡æ¯</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * RateLimit constructor.
 * @param $org
 * @param $pathInfo
 * @param $expire
 * @param $limitReq
 */
public function __construct($org, $pathInfo)
{
    $this-&gt;conn = $this-&gt;getRedisConn();
    $this-&gt;org = $org;
    $this-&gt;pathInfo = $pathInfo;
}
//......æ­¤å¤„çœç•¥getLuaScriptæ–¹æ³•
/**
 * è·å–redisè¿æ¥
 * @return \Predis\Client
 */
private function getRedisConn()
{
    require_once('vendor/autoload.php');
    $conn = new Predis\Client(['host' =&gt; '127.0.0.1',
        'port' =&gt; 6379,]);
    return $conn;
}
//......æ­¤å¤„çœç•¥isActionAllowedæ–¹æ³• } ä¸‹è¾¹æˆ‘ä»¬çœ‹çœ‹Luaè„šæœ¬çš„è®¾è®¡ï¼š
</code></pre></div></div>

<p>/**
     * è·å–luaè„šæœ¬
     * @return string
     */
    private function getLuaScript()
    {
        $luaScript = Â«&lt;LUA_SCRIPT
â€“ é™åˆ¶æ¥å£è®¿é—®é¢‘æ¬¡
local times = redis.call(â€˜incrâ€™, KEYS[1]);    â€“å°†keyè‡ªå¢1</p>

<p>if times == 1 then
redis.call(â€˜expireâ€™, KEYS[1], ARGV[1])    â€“ç»™keyè®¾ç½®è¿‡æœŸæ—¶é—´
end</p>

<p>if times &gt; tonumber(ARGV[2]) then
return 0
end</p>

<p>return 1
LUA_SCRIPT;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    return $luaScript;
} Luaè„šæœ¬å¯ä»¥æ‰“åŒ…åˆ°RedisæœåŠ¡ç«¯è¿›è¡Œæ‰§è¡Œï¼Œå› ä¸ºRedisæœåŠ¡ç«¯redis-serveråœ¨2.6ç‰ˆæœ¬é»˜è®¤å†…ç½®äº†Luaè§£æå™¨ï¼Œphpçš„Rediså®¢æˆ·ç«¯ä¸Luaè„šæœ¬äº¤äº’ä¸»è¦ä¼ ä¸¤ä¸ªKEYSå’ŒARGV,å…¶ä¸­KEYSæ˜¯å¯¹åº”Redisä¸­æ“ä½œçš„keyå€¼ï¼ˆç¤ºä¾‹ä¸­çš„KEYS[1]å°±æ˜¯org1/user/list),ARGVæ˜¯è¦è®¾ç½®çš„å±æ€§å‚æ•°ã€‚åœ¨Luaè„šæœ¬ä¸­Tableçš„ç´¢å¼•æ˜¯ä»1å¼€å§‹è‡ªå¢çš„ï¼ŒLuaè„šæœ¬æ‰§è¡ŒRediså‘½ä»¤å¯ä»¥ä¿è¯åŸå­æ€§(å› ä¸ºRedisæ˜¯å•çº¿ç¨‹çš„)ï¼Œæ‰€ä»¥åœ¨å¹¶å‘ç«æ€æ¡ä»¶ä¸‹ä¹Ÿèƒ½ä¿è¯hashçš„è¯»å†™ä¸€è‡´ã€‚å‘½ä»¤é¦–å…ˆè°ƒç”¨incrè®¾ç½®org/user/listè®°æ•°,Redisä¸­çš„listã€setã€hashã€zsetè¿™å››ç§æ•°æ®ç»“æ„æ˜¯å®¹å™¨å‹æ•°æ®ç»“æ„ï¼Œä»–ä»¬å…±äº«ä¸‹é¢ä¸¤æ¡é€šç”¨è§„åˆ™ï¼š
</code></pre></div></div>

<p>1.create if not existsï¼šå¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªå†è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚incr org/user/listæ—¶ï¼Œå¦‚æœorg/user/listä¸å­˜åœ¨ï¼Œå°±ç›¸å½“äºè®¾ç½®äº†org/user/listä¸º1,è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šè¾¹Luaè„šæœ¬ä½¿ç”¨expireå½“timesä¸º1æ—¶è®¾ç½®org/user/listçš„è¿‡æœŸæ—¶é—´
2.drop if no elementsï¼šå¦‚æœå®¹å™¨é‡Œçš„å…ƒç´ æ²¡æœ‰äº†ï¼Œé‚£ä¹ˆç«‹å³åˆ é™¤å®¹å™¨ï¼Œé‡Šæ”¾å†…å­˜ã€‚æ¯”å¦‚lpopæ“ä½œå®Œä¸€ä¸ªlistä¹‹åï¼Œlistä¸­æ²¡æœ‰å…ƒç´ å†…å®¹äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªlistä¹Ÿå°±ä¸å­˜åœ¨äº†
ä¸‹è¾¹çš„é€»è¾‘å°±å¾ˆæ˜äº†äº†ï¼Œå°±æ˜¯çœ‹æ¥å£çš„è°ƒç”¨ç´¯åŠ æ¬¡æ•°æœ‰æ²¡æœ‰è¶…é™ï¼ˆé™åˆ¶é¢‘ç‡é€šè¿‡ARGV[2]ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œè¶…é™è¿”å›0ï¼Œå¦åˆ™è¿”å›1.</p>

<p>ä¸‹è¾¹æˆ‘ä»¬å°±å¯ä»¥çœ‹çœ‹æ€æ ·isActionAllowedæ–¹æ³•åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œé™æµäº†:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * åˆ¤æ–­æ¥å£æ˜¯å¦é™åˆ¶è®¿é—®
 * @return bool
 */
public function isActionAllowed()
{
    $pathInfo = $this-&gt;org . $this-&gt;pathInfo;
    $config = $this-&gt;conn-&gt;hgetall($pathInfo);
    //é…ç½®ä¸­æ²¡æœ‰å¯¹æ¥å£è¿›è¡Œé™åˆ¶
    if (!$config) return true;

    $pathInfoLimitKey = $this-&gt;org . '-' . $this-&gt;pathInfo;
    try {
        $ret = $this-&gt;conn-&gt;evalsha(sha1($this-&gt;getLuaScript()), 1, $pathInfoLimitKey, $config['expire'], $config['limitReq']);
    } catch (Exception $e) {
        $ret = $this-&gt;conn-&gt;eval($this-&gt;getLuaScript(), 1, $pathInfoLimitKey, $config['expire'], $config['limitReq']);
    }

    return boolval($ret);
} Predisä½¿ç”¨evalshaæ‰“åŒ…Luaè„šæœ¬å‘é€åˆ°æœåŠ¡ç«¯æ‰§è¡Œã€‚evalshaçš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯sha1ç¼–ç åçš„Luaè„šæœ¬ã€‚redis-serverå¯ä»¥å¯¹Luaè„šæœ¬è¿›è¡Œç¼“å­˜ï¼Œç¼“å­˜çš„æ–¹æ³•æ˜¯key:valueçš„å½¢å¼ï¼Œå…¶ä¸­keyæ˜¯sha1åçš„luaè„šæœ¬å†…å®¹,è¿™æ ·åœ¨Luaè„šæœ¬æ¯”è¾ƒå¤§æ—¶ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å‘é€sha1åçš„å€¼åˆ°redis-serverå°±å¯ä»¥äº†ï¼Œå‡å°äº†æ¯æ¬¡å‘é€å‘½ä»¤å†…å®¹çš„å­—èŠ‚å¤§å°ã€‚å¦‚æœevalshaæŠ¥å‡ºé”™è¯¯ä¿¡æ¯å¯ä»¥æ”¹ä¸ºevalå‡½æ•°ï¼Œå› ä¸ºredis-serverç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°luaè„šæœ¬ï¼Œå¯èƒ½è¿˜æ²¡æ²¡æœ‰è¿›è¡Œç¼“å­˜ã€‚æœ€å¥½æ˜¯ä½¿ç”¨try...catch...åšä¸€ä¸‹å…¼å®¹å¤„ç†ã€‚evalshaçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯keyçš„ä¸ªæ•°ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªï¼Œ$pathInfoLimitKeyï¼Œä¸‹è¾¹ä¸¤ä¸ªæ˜¯ä»Redisä¸­å–å‡ºçš„é…ç½®å€¼ï¼Œæ ‡ç¤º1så†…å…è®¸$pathInfoLimitKeyè¢«æ“ä½œ100æ¬¡ã€‚å¦‚æœæ²¡æœ‰å¯¹$pathInfoLimitKeyåšé…ç½®é™åˆ¶é¢‘ç‡ï¼Œé»˜è®¤ä¸å—é™ã€‚
</code></pre></div></div>

<p>ä»¥ä¸Šå°±æ˜¯rateLimitç±»çš„å…¨éƒ¨å†…å®¹äº†ï¼Œæ€è·¯æ¯”è¾ƒç®€å•ï¼Œä¸‹è¾¹ç®€å•çœ‹ä¸€ä¸‹å…¥å£æ–‡ä»¶ï¼Œä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ¥æ”¶å‚æ•°ï¼Œç„¶åå°†æ¥å£æ˜¯å¦å—é™çš„ä¿¡æ¯å†™åˆ°stat.logæ—¥å¿—æ–‡ä»¶ä¸­å»ã€‚</p>

<p>&lt;?php
/**</p>
<ul>
  <li>Description: æ¼æ–—é™æµå…¥å£æ–‡ä»¶</li>
  <li>User: guozhaoran<a href="mailto:guozhaoran@cmcm.com">guozhaoran@cmcm.com</a></li>
  <li>Date: 2019-06-16
 */
require_once(â€˜./RateLimit.phpâ€™);
ini_set(â€˜display_errorsâ€™, true);</li>
</ul>

<p>$org = $_GET[â€˜orgâ€™];
$pathInfo = $_GET[â€˜path_infoâ€™];</p>

<p>$result = (new RateLimit($org, $pathInfo))-&gt;isActionAllowed();</p>

<p>$handler = fopen(â€˜./stat.logâ€™, â€˜aâ€™) or die(â€˜can not open file!â€™);
if ($result) {
    fwrite($handler, â€˜request success!â€™ . PHP_EOL);
} else {
    fwrite($handler, â€˜request failed!â€™ . PHP_EOL);
}
fclose($handler);
æˆ‘ä»¬é€šè¿‡abå·¥å…·å‹æµ‹ä¸€ä¸‹æ¥å£ä¿¡æ¯ï¼Œç¨‹åºé™åˆ¶1så†…å…è®¸100æ¬¡è®¿é—®ï¼Œæˆ‘ä»¬å°±å¼€10ä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚110æ¬¡ï¼Œç†è®ºä¸Šåº”è¯¥æ˜¯å‰ä¸€ç™¾æ¬¡æ˜¯æˆåŠŸçš„ï¼Œååæ¬¡æ˜¯å¤±è´¥çš„ï¼Œå‘½ä»¤ä¸º:</p>

<p>ab -n 110 -c 10 http://localhost/demo/rateLimit/index.php\?org=org1\&amp;path_info=/user/list
stat.logä¸­çš„æ—¥å¿—ä¿¡æ¯å’Œæˆ‘ä»¬é¢„æœŸä¸­çš„ä¸€æ ·ï¼Œè¯´æ˜æˆ‘ä»¬çš„æ¥å£é¢‘æ¬¡è®¾ç½®è¾¾åˆ°äº†é¢„æœŸæ•ˆæœï¼š</p>

<p>â€¦//æ­¤å¤„çœç•¥96è¡Œ
request success!
request success!
request success!
request success!
request failed!
request failed!
request failed!
request failed!
request failed!
request failed!
request failed!
request failed!
request failed!
request failed!
ä½†æ˜¯æ¼æ–—é™æµè¿˜æ˜¯æœ‰ä¸€äº›ç¼ºç‚¹çš„ï¼Œå®ƒä¸æ”¯æŒçªå‘æµé‡ï¼Œæˆ‘ä»¬æ¥å£è®¾ç½®1så†…é™åˆ¶è®¿é—®100æ¬¡ï¼Œå‡å¦‚è¯´å‰900æ¯«ç§’åªæœ‰80æ¬¡è®¿é—®ï¼Œçªç„¶åœ¨æ¥ä¸‹æ¥çš„100æ¯«ç§’æ¥äº†50æ¬¡è®¿é—®ï¼Œé‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼Œåè¾¹30æ¬¡è®¿é—®æ˜¯å¤±è´¥çš„ã€‚ä¸è¿‡æ¼æ–—è¿™ç§ç®€å•ç²—æš´çš„é™æµå¤„ç†æ–¹æ¡ˆå¯¹äºæµé‡é›†ä¸­æ€§è®¿é—®ï¼Œæ¯”å¦‚(1åˆ†é’Ÿåªå…è®¸è®¿é—®1000æ¬¡)è¿˜æ˜¯éå¸¸é€‚åˆçš„ã€‚</p>

<p>3.2 goè¯­è¨€å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•
æˆ‘ä»¬é¦–å…ˆä¸è€ƒè™‘ç«æ€æ¡ä»¶ï¼Œç”¨goè¯­è¨€å®ç°ä¸€ä¸ªv1ç‰ˆæœ¬çš„ä»¤ç‰Œæ¡¶æ¥ä½“ä¼šä¸€ä¸‹å®ƒçš„ç®—æ³•æ€æƒ³ã€‚æˆ‘ä»¬æ–°å»ºä¸€ä¸ªfunnelæ¨¡å—ï¼Œå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº†ä»¤ç‰Œæ¡¶éœ€è¦çš„å±æ€§ï¼š</p>

<p>package funnel</p>

<p>import (
    â€œmathâ€
    â€œtimeâ€
)</p>

<p>type Funnel struct {
    Capacity          int64   //ä»¤ç‰Œæ¡¶å®¹é‡
    LeakingRate       float64 //ä»¤ç‰Œæ¡¶æµæ°´é€Ÿç‡:æ¯æ¯«ç§’å‘ä»¤ç‰Œæ¡¶ä¸­æ·»åŠ çš„ä»¤ç‰Œæ•°
    RemainingCapacity int64   //ä»¤ç‰Œæ¡¶å‰©ä½™ç©ºé—´
    LastLeakingTime   int64   //ä¸Šæ¬¡æµæ°´(æ”¾å…¥ä»¤ç‰Œ)æ—¶é—´:æ¯«ç§’æ—¶é—´æˆ³
Funnelç»“æ„ä½“æ”¯æŒå¯¼å‡ºï¼Œåˆ†åˆ«åŒ…å«ä»¤ç‰Œæ¡¶çš„å®¹é‡ã€å‘ä»¤ç‰Œæ¡¶ä¸­æ·»åŠ ä»¤ç‰Œçš„é€Ÿç‡ã€ä»¤ç‰Œæ¡¶å‰©ä½™ç©ºé—´
å’Œä¸Šæ¬¡æ”¾å…¥ä»¤ç‰Œæ—¶é—´çš„å››ä¸ªå±æ€§ã€‚
æˆ‘ä»¬é‡‡ç”¨è¯·æ±‚è¿›æ¥æ—¶å®æ—¶æ”¹å˜ä»¤ç‰Œæ¡¶çŠ¶æ€çš„æ€è·¯ï¼Œæ”¹å˜ä»¤ç‰Œæ¡¶çŠ¶æ€çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>//æœ‰è¯·æ±‚æ—¶æ›´æ–°ä»¤ç‰Œæ¡¶çš„çŠ¶æ€,ä¸»è¦æ˜¯ä»¤ç‰Œæ¡¶å‰©ä½™ç©ºé—´å’Œè®°å½•å–èµ°Tokençš„æ—¶é—´æˆ³
func (rateLimit *Funnel) updateFunnelStatus() {
    nowTs := time.Now().UnixNano() / int64(time.Millisecond)
    //è·ç¦»ä¸Šä¸€æ¬¡å–èµ°ä»¤ç‰Œå·²ç»è¿‡å»äº†å¤šé•¿æ—¶é—´
    timeDiff := nowTs - rateLimit.LastLeakingTime
    //æ ¹æ®æ—¶é—´å·®å’Œæµæ°´é€Ÿç‡è®¡ç®—éœ€è¦å‘ä»¤ç‰Œæ¡¶ä¸­æ·»åŠ å¤šå°‘ä»¤ç‰Œ
    needAddSpace := int64(math.Floor(rateLimit.LeakingRate * float64(timeDiff)))
    //ä¸éœ€è¦æ·»åŠ ä»¤ç‰Œ
    if needAddSpace &lt; 1 {
        return
    }
    rateLimit.RemainingCapacity += needAddSpace
    //æ·»åŠ çš„ä»¤ç‰Œä¸èƒ½å¤§äºä»¤ç‰Œæ¡¶çš„å‰©ä½™ç©ºé—´
    if rateLimit.RemainingCapacity &gt; rateLimit.Capacity {
        rateLimit.RemainingCapacity = rateLimit.Capacity
    }
    //æ›´æ–°ä¸Šæ¬¡ä»¤ç‰Œæ¡¶æµæ°´(æ·»åŠ ä»¤ç‰Œ)æ—¶é—´æˆ³
    rateLimit.LastLeakingTime = nowTs
}
å› ä¸ºè¦æ”¹å˜ä»¤ç‰Œæ¡¶çš„çŠ¶æ€ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä½¿ç”¨æŒ‡é’ˆæ¥æ”¶è€…ä¸ºç»“æ„ä½“Funnelå®šä¹‰æ–¹æ³•ã€‚ä¸»è¦æ€è·¯å°±æ˜¯æ ¹æ®å½“å‰æ—¶é—´å’Œä¸Šæ¬¡æ”¾å…¥ä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œçš„æ—¶é—´æˆ³ï¼Œå†ç»“åˆæ¯æ¯«ç§’åº”è¯¥æ”¾å…¥ä»¤ç‰Œæ¡¶ä¸­ä»¤ç‰Œï¼Œè®¡ç®—æ·»åŠ åº”è¯¥æ”¾å…¥åˆ°ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œï¼Œæ”¾å…¥ä»¤ç‰Œåä¸èƒ½è¶…è¿‡ä»¤ç‰Œæ¡¶æœ¬èº«å®¹é‡çš„å¤§å°ã€‚ç„¶åå–å‡ºä»¤ç‰Œï¼Œæ›´æ–°ä¸Šæ¬¡æ·»åŠ ä»¤ç‰Œæ—¶é—´æˆ³ã€‚
åˆ¤æ–­æ¥å£æ˜¯å¦é™æµå…¶å®å°±æ˜¯çœ‹èƒ½ä¸èƒ½ä»ä»¤ç‰Œæ¡¶ä¸­å–å‡ºä»¤ç‰Œï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>

<p>//åˆ¤æ–­æ¥å£æ˜¯å¦è¢«é™æµ
func (rateLimit *Funnel) IsActionAllowed() bool {
    //æ›´æ–°ä»¤ç‰Œæ¡¶çŠ¶æ€
    rateLimit.updateFunnelStatus()
    if rateLimit.RemainingCapacity &lt; 1 {
        return false
    }
    rateLimit.RemainingCapacity = rateLimit.RemainingCapacity - 1
    return true
}
åˆ°äº†è¿™é‡Œï¼Œç›¸ä¿¡è¯»è€…å·²ç»å¯¹ä»¤ç‰Œæ¡¶ç®—æ³•æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†äº†ã€‚æˆ‘ä»¬å†æ¥è¯´é—®é¢˜ï¼Œå› ä¸ºé™æµæœ€ç»ˆè¿˜æ˜¯è¦é€šè¿‡æ“ä½œRedisæ¥å®ç°çš„ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥åœ¨Redisé‡Œåˆå§‹åŒ–å¥½æ¥å£é™æµçš„é…ç½®ï¼š</p>

<p>hmset org2/user/list Capacity 100 LeakingRate 0.1 RemainingCapacity 0 LastLeakingTime 1560789716896
æˆ‘ä»¬è®¾ç½®å…¬å¸äºŒ(org2)çš„æ¥å£ï¼ˆ/user/listï¼‰ä»¤ç‰Œæ¡¶å®¹é‡100ï¼Œæ¯éš”10msæ”¾å…¥ä¸€ä»¤ç‰Œï¼ˆè®¡ç®—æ–¹æ³•100/1000ï¼‰ã€‚æˆ‘ä»¬å°†Funnelå¯¹è±¡å†…å®¹çš„å­—æ®µå­˜å‚¨åˆ°ä¸€ä¸ªhashç»“æ„ä¸­ï¼Œæˆ‘ä»¬åœ¨è®¡ç®—æ˜¯å¦é™æµçš„æ—¶å€™éœ€è¦ä»hashç»“æ„ä¸­å–å€¼ï¼Œåœ¨å†…å­˜ä¸­åšè¿ç®—ï¼Œå†å›å¡«åˆ°hashç»“æ„ï¼Œå°¤å…¶å¯¹äºgoè¯­è¨€è¿™ç§å¤©ç„¶å¹¶å‘çš„ç¨‹åºæ¥è®²ï¼Œæˆ‘ä»¬æ— æ³•ä¿è¯æ•´ä¸ªè¿‡ç¨‹çš„åŸå­åŒ–ï¼ˆè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Luaè„šæœ¬çš„åŸå› ï¼Œå› ä¸ºå¦‚æœç”¨ç¨‹åºæ¥å®ç°ï¼Œå°±éœ€è¦åŠ é”ï¼Œä¸€æ—¦åŠ é”å°±æœ‰åŠ é”å¤±è´¥çš„å¯èƒ½ï¼Œå¤±è´¥åªèƒ½é€‰æ‹©é‡è¯•æˆ–æ”¾å¼ƒï¼Œé‡è¯•ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œæ”¾å¼ƒä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œä»£ç å¤æ‚åº¦ä¼šå¢åŠ ä¸å°‘ï¼‰ã€‚æˆ‘ä»¬V2ç‰ˆæœ¬è¿˜æ˜¯ä¼šé€‰æ‹©ä½¿ç”¨Luaè„šæœ¬æ¥å®ç°ï¼šå…·ä½“è°ƒç ”è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>æ–¹æ¡ˆ	ç‰¹ç‚¹
å•æœåŠ¡å¯¹æ“ä½œé‡‡ç”¨é”æœºåˆ¶	æ–‡ç« æœ‰æåˆ°ï¼Œè¿™ç§åªèƒ½ä¿è¯å•èŠ‚ç‚¹ä¸‹ä¸²è¡Œä¸”æ€§èƒ½å·®
RedisåŸå­æ“ä½œincr	è¿™ç§æ–¹æ¡ˆæˆ‘ä»¬åœ¨æ¼æ–—æ¨¡å‹ä¸­æœ‰ä½¿ç”¨ï¼Œå®ƒåªèƒ½åº”å¯¹ç®€å•çš„åœºæ™¯ï¼Œæ¶‰åŠåˆ°å¤æ‚åœºæ™¯å°±æ¯”è¾ƒéš¾å¤„ç†
Redisåˆ†å¸ƒå¼äº‹åŠ¡	è™½ç„¶Redisçš„åˆ†å¸ƒå¼äº‹åŠ¡èƒ½ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å®ç°å¤æ‚ï¼Œå¹¶ä¸”ç½‘ç»œå¼€é”€å¤§ï¼Œéœ€è¦å¤§é‡çš„ç½‘ç»œä¼ è¾“
Redis+Lua	è¿™é‡Œå°±ä¸å¾—ä¸å¤¸ä¸€ä¸‹è¿™ç§æ–¹æ¡ˆäº†ï¼ŒLuaè„šæœ¬ä¸­è¿è¡Œåœ¨Redisä¸­ï¼Œredisåˆæ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤èƒ½ä¿è¯æ“ä½œçš„ä¸²è¡Œã€‚å¦å¤–ï¼šå‡å°‘ç½‘ç»œå¼€é”€ï¼Œå‰è¾¹æˆ‘ä»¬æåˆ°è¿‡ï¼ŒLuaä»£ç åŒ…è£…çš„å‘½ä»¤ä¸éœ€è¦å‘é€å¤šæ¬¡å‘½ä»¤è¯·æ±‚ï¼ŒRediså¯ä»¥å¯¹Luaè„šæœ¬è¿›è¡Œç¼“å­˜ï¼Œå‡å°‘äº†ç½‘ç»œä¼ è¾“,å¦å¤–å…¶ä»–çš„å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ä½¿ç”¨ç¼“å­˜
è¡¥å……ä¸€ç‚¹ï¼šRedis4.0æä¾›äº†ä¸€ä¸ªé™æµæ¨¡å—Redisæ¨¡å—ï¼Œå®ƒå«Redis-Cellã€‚è¯¥æ¨¡å—ä¹Ÿä½¿ç”¨äº†æ¼æ–—ç®—æ³•ï¼Œå¹¶æä¾›äº†åŸå­çš„é™æµå‘½ä»¤ï¼Œé‡è¯•æœºåˆ¶ä¹Ÿéå¸¸ç®€å•ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸€ä¸‹ã€‚æˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯ä½¿ç”¨Lua + Redisè§£å†³æ–¹æ¡ˆï¼ŒåºŸè¯å°‘è¯´ï¼Œä¸ŠV2ç‰ˆæœ¬çš„ä»£ç ï¼š</p>

<p>const luaScript = `
â€“ æ¥å£é™æµ
â€“ last_leaking_time æœ€åè®¿é—®æ—¶é—´çš„æ¯«ç§’
â€“ remaining_capacity å½“å‰ä»¤ç‰Œæ¡¶ä¸­å¯ç”¨è¯·æ±‚ä»¤ç‰Œæ•°
â€“ capacity ä»¤ç‰Œæ¡¶å®¹é‡
â€“ leaking_rate    ä»¤ç‰Œæ¡¶æ·»åŠ ä»¤ç‰Œçš„é€Ÿç‡</p>

<p>â€“ æŠŠå‘ç”Ÿæ•°æ®å˜æ›´çš„å‘½ä»¤ä»¥äº‹åŠ¡çš„æ–¹å¼åšæŒä¹…åŒ–å’Œä¸»ä»å¤åˆ¶(Redis4.0æ”¯æŒ)
redis.replicate_commands()</p>

<p>â€“ è·å–ä»¤ç‰Œæ¡¶çš„é…ç½®ä¿¡æ¯
local rate_limit_info = redis.call(â€œHGETALLâ€, KEYS[1])</p>

<p>â€“ è·å–å½“å‰æ—¶é—´æˆ³
local timestamp = redis.call(â€œTIMEâ€)
local now = math.floor((timestamp[1] * 1000000 + timestamp[2]) / 1000)</p>

<p>if rate_limit_info == nil then â€“ æ²¡æœ‰è®¾ç½®é™æµé…ç½®,åˆ™é»˜è®¤æ‹¿åˆ°ä»¤ç‰Œ
    return now * 10 + 1
end</p>

<p>local capacity = tonumber(rate_limit_info[2])
local leaking_rate = tonumber(rate_limit_info[4])
local remaining_capacity = tonumber(rate_limit_info[6])
local last_leaking_time = tonumber(rate_limit_info[8])</p>

<p>â€“ è®¡ç®—éœ€è¦è¡¥ç»™çš„ä»¤ç‰Œæ•°,æ›´æ–°ä»¤ç‰Œæ•°å’Œè¡¥ç»™æ—¶é—´æˆ³
local supply_token = math.floor((now - last_leaking_time) * leaking_rate)
if (supply_token &gt; 0) then
   last_leaking_time = now
   remaining_capacity = supply_token + remaining_capacity
   if remaining_capacity &gt; capacity then
      remaining_capacity = capacity
   end
end</p>

<p>local result = 0 â€“ è¿”å›ç»“æœæ˜¯å¦èƒ½å¤Ÿæ‹¿åˆ°ä»¤ç‰Œ,é»˜è®¤å¦</p>

<p>â€“ è®¡ç®—è¯·æ±‚æ˜¯å¦èƒ½å¤Ÿæ‹¿åˆ°ä»¤ç‰Œ
if (remaining_capacity &gt; 0) then
    remaining_capacity = remaining_capacity - 1
    result = 1
end</p>

<p>â€“ æ›´æ–°ä»¤ç‰Œæ¡¶çš„é…ç½®ä¿¡æ¯
redis.call(â€œHMSETâ€, KEYS[1], â€œRemainingCapacityâ€, remaining_capacity, â€œLastLeakingTimeâ€, last_leaking_time)</p>

<p>return now * 10 + result
`
æˆ‘ä»¬è¿™æ®µè„šæœ¬è¿”å›ä¸€ä¸ªint64ç±»å‹çš„æ•´æ•°ï¼Œæœ€åä¸€ä½0æˆ–1è¡¨ç¤ºæ˜¯å¦è¦å¯¹æ¥å£é™æµï¼Œå‰è¾¹çš„æ•°å­—è¡¨ç¤ºæ¯«ç§’æ—¶é—´æˆ³ï¼Œå°†æ¥è®°å½•åˆ°æ—¥å¿—é‡Œè¿›è¡Œå‹æµ‹ç»Ÿè®¡ä½¿ç”¨ã€‚ç¨‹åºè¿è¡Œæ—¶å½“å‰æ—¶é—´æˆ³æˆ‘æ˜¯è°ƒç”¨Redisçš„timeå‘½ä»¤è®¡ç®—è·å¾—çš„ï¼ŒåŸå› æœ‰äºŒï¼š</p>

<p>Luaå‘½ä»¤è·å¾—å½“å‰æ—¶é—´æˆ³åªèƒ½ç²¾ç¡®åˆ°ç§’ï¼Œè€ŒRedisç¡®å¯ä»¥ç²¾ç¡®åˆ°çº³ç§’ã€‚
å¦‚æœæ—¶é—´æˆ³ä½œä¸ºè„šæœ¬è°ƒç”¨å‚æ•°ï¼ˆgoç¨‹åºï¼‰ä¼ è¿›æ¥ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºè„šæœ¬ä¼ å‚åˆ°Luaåœ¨Redisä¸­æ‰§è¡Œè¿˜æœ‰ä¸€æ®µæ—¶é—´è¯¯å·®ï¼Œä¸èƒ½ä¿è¯æœ€å…ˆè¢«æ¥æ”¶åˆ°çš„è¯·æ±‚å…ˆè¢«å¤„ç†ï¼Œè€ŒLuaä¸­è·å–æ—¶é—´æˆ³å¯ä»¥ä¿è¯è¯·æ±‚ã€æ—¶é—´ä¸²è¡Œ
å’Œä»¥å‰ä¸€æ ·ï¼Œæ²¡æœ‰è®¾ç½®é™æµé…ç½®ï¼Œå°±é»˜è®¤å¯ä»¥è¯·æ±‚ã€‚
ç„¶åæ ¹æ®æ—¶é—´æˆ³è¡¥ç»™ä»¤ç‰Œï¼Œè®¡ç®—æ˜¯å¦èƒ½å¤Ÿå–åˆ°ä»¤ç‰Œï¼Œç„¶åæ›´æ–°ä»¤ç‰ŒçŠ¶æ€ï¼Œæ€è·¯å’ŒV1ç‰ˆæœ¬ä¸€æ ·ï¼Œè¯»è€…å¯è‡ªè¡Œé˜…è¯»ã€‚è¯´æ˜ä¸€ç‚¹ï¼Œè„šæœ¬å¼€å§‹å¤„çš„redis.replicate_commands()å‘½ä»¤æ˜¯å› ä¸ºRedisä½ç‰ˆæœ¬ä¸æ”¯æŒå¯¹Redisæ—¢è¯»åˆå†™ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è¿˜æ˜¯å­˜åœ¨ç‰ˆæœ¬å…¼å®¹æ€§ï¼Œä½†æ˜¯è§£å†³åŠæ³•ç¡®æ˜¯æœ€å®Œç¾çš„ã€‚
æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹goé€»è¾‘ä»£ç ï¼š</p>

<p>func main() {
    http.HandleFunc(â€œ/user/listâ€, handleReq)
    http.ListenAndServe(â€œ:8082â€, nil)
}</p>

<p>//åˆå§‹åŒ–redisè¿æ¥æ± 
func newPool() *redis.Pool {
    return &amp;redis.Pool{
        MaxIdle:   80,
        MaxActive: 12000, // max number of connections
        Dial: func() (redis.Conn, error) {
            c, err := redis.Dial(â€œtcpâ€, â€œ:6379â€)
            if err != nil {
                panic(err.Error())
            }
            return c, err
        },
    }
}</p>

<p>//å†™å…¥æ—¥å¿—
func writeLog(msg string, logPath string) {
    fd, _ := os.OpenFile(logPath, os.O_RDWR|os.O_CREATE|os.O_APPEND, 0644)
    defer fd.Close()
    content := strings.Join([]string{msg, â€œ\r\nâ€}, â€œâ€)
    buf := []byte(content)
    fd.Write(buf)
}</p>

<p>//å¤„ç†è¯·æ±‚å‡½æ•°,æ ¹æ®è¯·æ±‚å°†å“åº”ç»“æœä¿¡æ¯å†™å…¥æ—¥å¿—
func handleReq(w http.ResponseWriter, r *http.Request) {
    //è·å–urlä¿¡æ¯
    pathInfo := r.URL.Path
    //è·å–getä¼ é€’çš„å…¬å¸ä¿¡æ¯org
    orgInfo, ok := r.URL.Query()[â€œorgâ€]
    if !ok || len(orgInfo) &lt; 1 {
        fmt.Println(â€œParam org is missing!â€)
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è°ƒç”¨luaè„šæœ¬åŸå­æ€§è¿›è¡Œæ¥å£é™æµç»Ÿè®¡
conn := newPool().Get()
key := orgInfo[0] + pathInfo
lua := redis.NewScript(1, luaScript)
reply, err := redis.Int64(lua.Do(conn, key))
if err != nil {
    fmt.Println(err)
    return
}
//æ¥å£æ˜¯å¦è¢«é™åˆ¶è®¿é—®
isLimit := bool(reply % 10 == 1)
reqTime := int64(math.Floor(float64(reply) / 10))
//å°†ç»Ÿè®¡ç»“æœå†™å…¥æ—¥å¿—å½“ä¸­
if !isLimit {
    successLog := strconv.FormatInt(reqTime, 10) + " request failed!"
    writeLog(successLog, "./stat.log")
    return
}

failedLog := strconv.FormatInt(reqTime, 10) + " request success!"
writeLog(failedLog, "./stat.log") } è„šæœ¬ç›‘å¬æœ¬åœ°8082ç«¯å£ï¼Œä½¿ç”¨goçš„redisæ¡†æ¶redigoæ¥æ“ä½œredisï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªredisè¿æ¥æ± ï¼Œä»è¿æ¥æ± ä¸­å–å¾—è¿æ¥è¿›è¡Œæ“ä½œã€‚æˆ‘ä»¬åˆ†æå¦‚ä¸‹ä»£ç ï¼š
</code></pre></div></div>

<p>lua := redis.NewScript(1, luaScript)
    reply, err := redis.Int64(lua.Do(conn, key))
NewScriptä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨è¦æ“ä½œRedisçš„keyçš„ä¸ªæ•°ï¼Œè¿™ç‚¹å’ŒPredisçš„evalshaç¬¬äºŒä¸ªå‚æ•°ç±»ä¼¼ã€‚ç„¶åé‡‡ç”¨Doæ–¹æ³•æ‰§è¡Œè„šæœ¬ï¼Œè¿”å›å€¼ä½¿ç”¨redis.Int64åšå¤„ç†ï¼Œç„¶åè¿›è¡Œè¿ç®—åˆ¤æ–­æ¥å£æ˜¯å¦å…è®¸è¢«è®¿é—®ï¼Œç„¶åå°†è®¿é—®æ—¶é—´å’Œç»“æœå†™å…¥åˆ°stat.logæ—¥å¿—æ–‡ä»¶ä¸­ã€‚
é€»è¾‘è¿˜æ˜¯éå¸¸çš„ç®€å•ï¼Œæˆ‘ä»¬ä¸»è¦çœ‹å‹æµ‹ç»“æœï¼Œå¯åŠ¨ä»£ç ï¼Œä½¿ç”¨abå‹æµ‹å‘½ä»¤æ‰§è¡Œï¼š</p>

<p>ab -n 110 -c 10 http://127.0.0.1:8082/user/list\?org=org2
ç„¶åæˆ‘ä»¬åˆ†æstat.logæ—¥å¿—å…´è®¸ä¼šæœ‰äº›æƒŠè®¶ï¼š</p>

<p>1561263349294 request success!    //ç¬¬ä¸€è¡Œæ—¥å¿—
â€¦//çœç•¥95è¡Œ
1561263349387 request success!
1561263349388 request success!
1561263349398 request success!
1561263349396 request success!
1561263349404 request success!
1561263349407 request success!
1561263349406 request success!
1561263349406 request success!
1561263349407 request success!
1561263349406 request success!
1561263349406 request success!
1561263349405 request success!
1561263349406 request success!
1561263349406 request success!
1561263349406 request success!
æ˜¯çš„ï¼Œéƒ½æˆåŠŸäº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ç»Ÿè®¡æ—¶é—´ä¼šå‘ç°æ‰§è¡Œè¿™100ä¸ªè¯·æ±‚æ€»å…±ç”¨äº†110æ¯«ç§’ï¼Œåœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯éš”10msä¼šå‘ä»¤ç‰Œæ¡¶ä¸­æ·»åŠ ä¸€ä¸ªä»¤ç‰Œï¼Œä¸€å…±æ·»åŠ äº†11ä¸ªä»¤ç‰Œï¼Œæ‰€ä»¥110æ¬¡è¯·æ±‚éƒ½æ‹¿åˆ°äº†ä»¤ç‰Œã€‚å¯ä»¥çœ‹å‡ºä»¤ç‰Œæ¡¶é€‚ç”¨äºå¤§æµé‡ä¸‹çš„é™æµï¼Œå¯ä»¥ä¿è¯æµé‡æŒ‰ç…§æ—¶é—´å‡åŒ€åˆ†æ‘Šï¼Œé¿å…å‡ºç°æµé‡çš„é›†ä¸­å¼çˆ†å‘è®¿é—®ã€‚</p>
:ET