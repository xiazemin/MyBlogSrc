I"Í<p>https://book-consul-guide.vnzmi.com/
æœåŠ¡å‘ç° Consulçš„å®¢æˆ·ç«¯å¯ç”¨æä¾›ä¸€ä¸ªæœåŠ¡,æ¯”å¦‚ api æˆ–è€…mysql ,å¦å¤–ä¸€äº›å®¢æˆ·ç«¯å¯ç”¨ä½¿ç”¨Consulå»å‘ç°ä¸€ä¸ªæŒ‡å®šæœåŠ¡çš„æä¾›è€….é€šè¿‡DNSæˆ–è€…HTTPåº”ç”¨ç¨‹åºå¯ç”¨å¾ˆå®¹æ˜“çš„æ‰¾åˆ°ä»–æ‰€ä¾èµ–çš„æœåŠ¡.
å¥åº·æ£€æŸ¥ Consulå®¢æˆ·ç«¯å¯ç”¨æä¾›ä»»æ„æ•°é‡çš„å¥åº·æ£€æŸ¥,æŒ‡å®šä¸€ä¸ªæœåŠ¡(æ¯”å¦‚:webserveræ˜¯å¦è¿”å›äº†200 OK çŠ¶æ€ç )æˆ–è€…ä½¿ç”¨æœ¬åœ°èŠ‚ç‚¹(æ¯”å¦‚:å†…å­˜ä½¿ç”¨æ˜¯å¦å¤§äº90%). è¿™ä¸ªä¿¡æ¯å¯ç”±operatorç”¨æ¥ç›‘è§†é›†ç¾¤çš„å¥åº·.è¢«æœåŠ¡å‘ç°ç»„ä»¶ç”¨æ¥é¿å…å°†æµé‡å‘é€åˆ°ä¸å¥åº·çš„ä¸»æœº.
Key/Valueå­˜å‚¨ åº”ç”¨ç¨‹åºå¯ç”¨æ ¹æ®è‡ªå·±çš„éœ€è¦ä½¿ç”¨Consulçš„å±‚çº§çš„Key/Valueå­˜å‚¨.æ¯”å¦‚åŠ¨æ€é…ç½®,åŠŸèƒ½æ ‡è®°,åè°ƒ,é¢†è¢–é€‰ä¸¾ç­‰ç­‰,ç®€å•çš„HTTP APIè®©ä»–æ›´æ˜“äºä½¿ç”¨.
å¤šæ•°æ®ä¸­å¿ƒ: Consulæ”¯æŒå¼€ç®±å³ç”¨çš„å¤šæ•°æ®ä¸­å¿ƒ.è¿™æ„å‘³ç€ç”¨æˆ·ä¸éœ€è¦æ‹…å¿ƒéœ€è¦å»ºç«‹é¢å¤–çš„æŠ½è±¡å±‚è®©ä¸šåŠ¡æ‰©å±•åˆ°å¤šä¸ªåŒºåŸŸ.
<!-- more -->
åœ¨åˆ©ç”¨go microæ¥å®ç°æœåŠ¡å‘ç°ä¾¿åˆ©å¾ˆå¤šï¼Œmicroä¸­é»˜è®¤æ”¯æŒä½¿ç”¨ Consul æ¥åšæœåŠ¡å‘ç°ï¼Œå½“ç„¶å®ƒä½¿ç”¨æ’ä»¶æœºåˆ¶ï¼ˆgo-pluginsï¼‰è¿˜æ”¯æŒ Etcd, Gossip, NATSç­‰å…¶ä»–çš„ç¬¬ä¸‰æ–¹æœåŠ¡æ³¨å†Œå‘ç°å·¥å…·ã€‚åœ¨æ¯ä¸ªæœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œéƒ½å°†è‡ªå·±æ³¨å†Œåˆ°registryä¸Šï¼Œé€€å‡ºæ—¶ä¹Ÿè‡ªåŠ¨è§£æ³¨å†Œ</p>

<p>func (s *service) run(exit chan bool) {
    if s.opts.RegisterInterval &lt;= time.Duration(0) {
        return
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//å®šæ—¶æ³¨å†Œè‡ªå·±
t := time.NewTicker(s.opts.RegisterInterval)

for {
    select {
    case &lt;-t.C:
        err := s.opts.Server.Register()
        if err != nil {
            log.Log("service run Server.Register error: ", err)
        }
    case &lt;-exit:
        t.Stop()
        return
    }
} }
</code></pre></div></div>

<p>â€¦â€¦</p>

<p>func (s *service) Start() error {
    for _, fn := range s.opts.BeforeStart {
        if err := fn(); err != nil {
            return err
        }
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if err := s.opts.Server.Start(); err != nil {
    return err
}
// Run() è°ƒç”¨ä¸­ä¹Ÿä¼šç»“æœrunæ¥è°ƒåˆ°è¿™é‡Œæ¥æ³¨å†Œ
if err := s.opts.Server.Register(); err != nil {
    return err
}

for _, fn := range s.opts.AfterStart {
    if err := fn(); err != nil {
        return err
    }
}

return nil }
</code></pre></div></div>

<p>func (s *service) Stop() error {
    var gerr error</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for _, fn := range s.opts.BeforeStop {
    if err := fn(); err != nil {
        gerr = err
    }
}    // é€€å‡ºæ—¶è‡ªåŠ¨è§£é™¤æ³¨å†Œ
if err := s.opts.Server.Deregister(); err != nil {
    return err
}

if err := s.opts.Server.Stop(); err != nil {
    return err
}

for _, fn := range s.opts.AfterStop {
    if err := fn(); err != nil {
        gerr = err
    }
}

return gerr }
</code></pre></div></div>
:ET