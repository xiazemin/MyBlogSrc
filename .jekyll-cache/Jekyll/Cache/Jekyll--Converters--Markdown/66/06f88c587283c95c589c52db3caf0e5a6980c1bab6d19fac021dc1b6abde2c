I"Ş<p>https://github.com/grpc-ecosystem/go-grpc-middleware
https://github.com/mwitkow/go-proto-validators</p>

<p>https://www.cnblogs.com/FireworksEasyCool/p/12761033.html</p>

<p>Interceptors
Please send a PR to add new interceptors or middleware to this list</p>

<p>Auth
grpc_auth - a customizable (via AuthFunc) piece of auth middleware
Logging
grpc_ctxtags - a library that adds a Tag map to context, with data populated from request body
grpc_zap - integration of zap logging library into gRPC handlers.
grpc_logrus - integration of logrus logging library into gRPC handlers.
grpc_kit - integration of go-kit logging library into gRPC handlers.
Monitoring
grpc_prometheusâš¡ - Prometheus client-side and server-side monitoring middleware
otgrpcâš¡ - OpenTracing client-side and server-side interceptors
grpc_opentracing - OpenTracing client-side and server-side interceptors with support for streaming and handler-returned tags
Client
grpc_retry - a generic gRPC response code retry mechanism, client-side middleware
Server
grpc_validator - codegen inbound message validation from .proto options
grpc_recovery - turn panics into gRPC errors
ratelimit - grpc rate limiting by your own limiter
<!-- more -->
https://www.cnblogs.com/ExMan/p/12269799.html
https://github.com/at-ishikawa/go-grpc-validator
go get github.com/mwitkow/go-proto-validators</p>

<p>1.æ–°å»ºsimple.protoæ–‡ä»¶</p>

<p>syntax = â€œproto3â€;</p>

<p>package proto;</p>

<p>import â€œgithub.com/mwitkow/go-proto-validators/validator.protoâ€;</p>

<p>message InnerMessage {
  // some_integer can only be in range (1, 100).
  int32 some_integer = 1 [(validator.field) = {int_gt: 0, int_lt: 100}];
  // some_float can only be in range (0;1).
  double some_float = 2 [(validator.field) = {float_gte: 0, float_lte: 1}];
}</p>

<p>message OuterMessage {
  // important_string must be a lowercase alpha-numeric of 5 to 30 characters (RE2 syntax).
  string important_string = 1 [(validator.field) = {regex: â€œ^[a-z]{2,5}$â€}];
  // proto3 doesnâ€™t have <code class="language-plaintext highlighter-rouge">required</code>, the <code class="language-plaintext highlighter-rouge">msg_exist</code> enforces presence of InnerMessage.
  InnerMessage inner = 2 [(validator.field) = {msg_exists : true}];
}</p>

<p>service Simple{
  rpc Route (InnerMessage) returns (OuterMessage){};
}
ä»£ç import â€œgithub.com/mwitkow/go-proto-validators/validator.protoâ€ï¼Œæ–‡ä»¶validator.protoéœ€è¦import â€œgoogle/protobuf/descriptor.protoâ€;åŒ…ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚</p>

<p>google/protobufåœ°å€ï¼šhttps://github.com/protocolbuffers/protobuf/blob/master/src/google/protobuf/descriptor.protoã€‚</p>

<p>æŠŠsrcæ–‡ä»¶å¤¹ä¸­çš„protobufç›®å½•ä¸‹è½½åˆ°GOPATHç›®å½•ä¸‹ã€‚</p>

<p>2.ç¼–è¯‘simple.protoæ–‡ä»¶</p>

<p>go get github.com/mwitkow/go-proto-validators/protoc-gen-govalidators</p>

<p>æŒ‡ä»¤ç¼–è¯‘ï¼šprotoc â€“govalidators_out=. â€“go_out=plugins=grpc:./ ./simple.proto</p>

<p>æˆ–è€…ä½¿ç”¨VSCode-proto3æ’ä»¶ï¼Œç¬¬ä¸€ç¯‡æœ‰ä»‹ç»ã€‚åªéœ€è¦æ·»åŠ â€â€“govalidators_out=.â€å³å¯ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// vscode-proto3æ’ä»¶é…ç½®
"protoc": {
    // protoc.exeæ‰€åœ¨ç›®å½•
    "path": "C:\\Go\\bin\\protoc.exe",
    // ä¿å­˜æ—¶è‡ªåŠ¨ç¼–è¯‘
    "compile_on_save": true,
    "options": [
        // goç¼–è¯‘è¾“å‡ºæŒ‡ä»¤
        "--go_out=plugins=grpc:.",
        "--govalidators_out=."
    ]
}, ç¼–è¯‘å®Œæˆåï¼Œè‡ªåŠ¨ç”Ÿæˆsimple.pb.goå’Œsimple.validator.pb.goæ–‡ä»¶ï¼Œsimple.pb.goæ–‡ä»¶ä¸å†ä»‹ç»ï¼Œæˆ‘ä»¬çœ‹ä¸‹simple.validator.pb.goæ–‡ä»¶ã€‚
</code></pre></div></div>

<p>// Code generated by protoc-gen-gogo. DO NOT EDIT.
// source: go-grpc-example/9-grpc_proto_validators/proto/simple.proto</p>

<p>package proto</p>

<p>import (
    fmt â€œfmtâ€
    math â€œmathâ€
    proto â€œgithub.com/golang/protobuf/protoâ€
    _ â€œgithub.com/mwitkow/go-proto-validatorsâ€
    regexp â€œregexpâ€
    github_com_mwitkow_go_proto_validators â€œgithub.com/mwitkow/go-proto-validatorsâ€
)</p>

<p>// Reference imports to suppress errors if they are not otherwise used.
var _ = proto.Marshal
var _ = fmt.Errorf
var _ = math.Inf</p>

<p>func (this *InnerMessage) Validate() error {
    if !(this.SomeInteger &gt; 0) {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œSomeIntegerâ€, fmt.Errorf(<code class="language-plaintext highlighter-rouge">value '%v' must be greater than '0'</code>, this.SomeInteger))
    }
    if !(this.SomeInteger &lt; 100) {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œSomeIntegerâ€, fmt.Errorf(<code class="language-plaintext highlighter-rouge">value '%v' must be less than '100'</code>, this.SomeInteger))
    }
    if !(this.SomeFloat &gt;= 0) {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œSomeFloatâ€, fmt.Errorf(<code class="language-plaintext highlighter-rouge">value '%v' must be greater than or equal to '0'</code>, this.SomeFloat))
    }
    if !(this.SomeFloat &lt;= 1) {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œSomeFloatâ€, fmt.Errorf(<code class="language-plaintext highlighter-rouge">value '%v' must be lower than or equal to '1'</code>, this.SomeFloat))
    }
    return nil
}</p>

<p>var _regex_OuterMessage_ImportantString = regexp.MustCompile(<code class="language-plaintext highlighter-rouge">^[a-z]{2,5}$</code>)</p>

<p>func (this *OuterMessage) Validate() error {
    if !_regex_OuterMessage_ImportantString.MatchString(this.ImportantString) {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œImportantStringâ€, fmt.Errorf(<code class="language-plaintext highlighter-rouge">value '%v' must be a string conforming to regex "^[a-z]{2,5}$"</code>, this.ImportantString))
    }
    if nil == this.Inner {
        return github_com_mwitkow_go_proto_validators.FieldError(â€œInnerâ€, fmt.Errorf(â€œmessage must existâ€))
    }
    if this.Inner != nil {
        if err := github_com_mwitkow_go_proto_validators.CallValidatorIfExists(this.Inner); err != nil {
            return github_com_mwitkow_go_proto_validators.FieldError(â€œInnerâ€, err)
        }
    }
    return nil
}
é‡Œé¢è‡ªåŠ¨ç”Ÿæˆäº†messageä¸­å±æ€§çš„éªŒè¯è§„åˆ™ã€‚</p>

<p>æŠŠgrpc_validatoréªŒè¯æ‹¦æˆªå™¨æ·»åŠ åˆ°æœåŠ¡ç«¯
grpcServer := grpc.NewServer(cred.TLSInterceptor(),
    grpc.StreamInterceptor(grpc_middleware.ChainStreamServer(
            grpc_validator.StreamServerInterceptor(),
            grpc_auth.StreamServerInterceptor(auth.AuthInterceptor),
            grpc_zap.StreamServerInterceptor(zap.ZapInterceptor()),
            grpc_recovery.StreamServerInterceptor(recovery.RecoveryInterceptor()),
        )),
        grpc.UnaryInterceptor(grpc_middleware.ChainUnaryServer(
            grpc_validator.UnaryServerInterceptor(),
            grpc_auth.UnaryServerInterceptor(auth.AuthInterceptor),
            grpc_zap.UnaryServerInterceptor(zap.ZapInterceptor()),
            grpc_recovery.UnaryServerInterceptor(recovery.RecoveryInterceptor()),
        )),
    )
è¿è¡Œåï¼Œå½“è¾“å…¥æ•°æ®éªŒè¯å¤±è´¥åï¼Œä¼šæœ‰ä»¥ä¸‹é”™è¯¯è¿”å›</p>

<p>Call Route err: rpc error: code = InvalidArgument desc = invalid field SomeInteger: value â€˜101â€™ must be less than â€˜100â€™
å…¶ä»–ç±»å‹éªŒè¯è§„åˆ™è®¾ç½®
enuméªŒè¯</p>

<p>syntax = â€œproto3â€;
package proto;
import â€œgithub.com/mwitkow/go-proto-validators/validator.protoâ€;</p>

<p>message SomeMsg {
  Action do = 1 [(validator.field) = {is_in_enum : true}];
}</p>

<p>enum Action {
  ALLOW = 0;
  DENY = 1;
  CHILL = 2;
}
UUIDéªŒè¯</p>

<p>syntax = â€œproto3â€;
package proto;
import â€œgithub.com/mwitkow/go-proto-validators/validator.protoâ€;</p>

<p>message UUIDMsg {
  // user_id must be a valid version 4 UUID.
  string user_id = 1 [(validator.field) = {uuid_ver: 4, string_not_empty: true}];
}
æ€»ç»“
go-grpc-middlewareä¸­grpc_validatoré›†æˆgo-proto-validatorsï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨ç¼–å†™protoæ—¶è®¾å¥½éªŒè¯è§„åˆ™ï¼Œå¹¶æŠŠgrpc_validatoræ·»åŠ åˆ°gRPCæœåŠ¡ç«¯ï¼Œå°±èƒ½å®ŒæˆgRPCçš„æ•°æ®éªŒè¯ï¼Œå¾ˆç®€å•ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p>

<p>https://github.com/grpc-ecosystem/go-grpc-middleware/tree/master/validator</p>
:ET