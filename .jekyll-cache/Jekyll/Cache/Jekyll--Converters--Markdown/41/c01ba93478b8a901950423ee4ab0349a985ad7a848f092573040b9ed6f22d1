I"¶Q<p>å®˜æ–¹è§£é‡Šä¸‹å°±æ˜¯ï¼šåå‘ä»£ç†çš„åœºæ™¯ï¼Œupstreamåç«¯ç”¨åŸŸåæ—¶ï¼Œé…ç½®resolverä»¥ä¾¿äºnginxèƒ½å¤Ÿè§£æè¯¥åŸŸå</p>

<p>Configures name servers used to resolve names of upstream servers into addresses</p>

<p>å®˜ç½‘åœ°å€ï¼šhttp://nginx.org/en/docs/http/ngx_http_core_module.html#resolver</p>

<p>å¹³æ—¶æˆ‘ä»¬åœ¨é…ç½®NG upstream ä¸€èˆ¬éƒ½æ˜¯æŒ‡å®šå·IP åœ°å€æˆ–è€…æ˜¯åœ°å€æ± ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå›ºå®šçš„åŸŸå</p>

<p>å¦‚æœä¸€äº›å¤æ‚çš„åœºæ™¯ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„upstream æ˜¯å˜é‡çš„servernameï¼Œè¿™æ—¶å€™éœ€è¦ç”¨åˆ°resolver çš„æŒ‡ä»¤ç”¨æ¥å¯¹å˜é‡åšè§£æäº†ã€‚
<!-- more -->
å‰æœ‰ä¸ªæµ‹è¯•ç¯å¢ƒé…ç½® proxy_pass æ—¶ç›´æ¥æŒ‡å®šåŸŸåæ˜¯å¯ä»¥ç”¨çš„ï¼Œæ¯”å¦‚</p>

<p>location / {
    proxy_pass http://dev.abc.com:10068;
}
é‡åˆ°ä¸€ä¸ªé—®é¢˜æ˜¯ï¼š
åå‘ä»£ç†çš„åœ°å€æ˜¯é€šè¿‡èŠ±ç”Ÿå£³åŠ¨æ€dnså®ç°çš„ã€‚
dev.abc.comé€šè¿‡cnameè§£æåˆ°èŠ±ç”Ÿå£³ä¹‹ç±»çš„åŠ¨æ€dnsç»™åˆ†é…çš„åŸŸåä¸Šï¼Œå¦‚æœè·¯ç”±å™¨å› ä¸ºæ–­ç”µæˆ–è€…æ‰çº¿ä¹‹ç±»çš„åŸå› é‡æ–°æ‹¨å·åipå‘ç”Ÿå˜åŒ–ï¼Œæ­¤å¤„nginxå°±æ— æ³•åå‘ä»£ç†äº†ï¼Œå¿…é¡»é‡å¯ä¸€æ¬¡nginxæ‰è¡Œã€‚</p>

<p>ä»Šå¤©é‡åˆ°ä¸€ä¸ªé—®é¢˜å°±æ˜¯é€šè¿‡ set è®¾ç½®å˜é‡ï¼Œç„¶å proxy_pass è°ƒç”¨å˜é‡å®ç°åå‘ä»£ç†ï¼ˆç›®çš„æ˜¯å‡å°‘é…ç½®å¤æ‚åº¦ï¼‰ï¼Œæ¯”å¦‚ï¼š</p>

<p>set $skyneturl â€œhttp://dev.abc.com:10077â€; # æ³¨æ„setå¥½åƒä¸æ”¯æŒå˜é‡åä¸­å¸¦ä¸‹åˆ’çº¿æˆ–å…¶å®ƒç‰¹æ®Šå­—ç¬¦</p>

<p>location /applyrecord/aladinnApplyrecord { 
    proxy_pass $skyneturl;
}
é‡å¯nginxåå‘ç°æŠ¥502é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¿ä¸ä¸Šåç«¯æœåŠ¡å™¨ã€‚
çœ‹nginxæ—¥å¿—å‘ç°é”™è¯¯æç¤ºï¼š</p>

<p>1
2019/04/11 10:34:04 [error] 17241#0: *4334742 no resolver defined to resolve dev.abc.com â€¦
è¯´æ²¡æœ‰å®šä¹‰ resolverå‘½ä»¤ æ¥è§£æåŸŸåï¼ŒæŸ¥äº†ä¸€ä¸‹å‘ç°éœ€è¦é…ç½®resolverå‚æ•°ã€‚</p>

<p>å®˜ç½‘æ–‡æ¡£ï¼šhttp://nginx.org/en/docs/http/ngx_http_core_module.html#resolver</p>

<p>Syntax: resolver address â€¦ [valid=time] [ipv6=on|off];
Default:    â€”
Context:    http, server, location</p>

<p>Configures name servers used to resolve names of upstream servers into addresses, for example:
æ„æ€æ˜¯éœ€è¦é…ç½®dnsåœ°å€ç”¨æ¥è§£æupstreamä¸­çš„åŸŸåï¼ˆç”¨åŸŸåæ›¿ä»£ipåœ°å€ï¼Œåæ¥ç»è¿‡æµ‹è¯•upstreamä¸­é…ç½®åŸŸååªä¼šåœ¨nginxå¯åŠ¨æ—¶è§£æä¸€æ¬¡ï¼Œç„¶åå°±ä¸€ç›´ç”¨è¿™ä¸ªipï¼Œæ— æ³•ä½¿ç”¨resolverå®ç°æ¯æ¬¡è§£æï¼‰</p>

<p>æ·»åŠ resolveré…ç½®å‚æ•°ï¼š</p>

<p>resolver 202.102.134.68 114.114.114.114 valid=5 ipv6=off;
set $skyneturl â€œhttp://dev.abc.com:10077â€;
location /applyrecord/aladinnApplyrecord { 
    proxy_pass $skyneturl;
}
é‡å¯nginxåè®¿é—®æˆåŠŸã€‚</p>

<p>è¿‡ç¨‹å›é¡¾:</p>

<p>æ— æ„é—´æŸ¥èµ„æ–™å‘ç° proxy_pass åé¢è·ŸåŸŸåçš„è¯å¹¶ä¸æ˜¯æ¯æ¬¡è¯·æ±‚éƒ½ä¼šè§£æå‡ºè¿™ä¸ªåŸŸåçš„ipï¼ˆè¿™ä¹ŸéªŒè¯äº†å¿…é¡»é‡å¯nginxæ‰èƒ½è§£å†³ï¼‰ï¼Œæ‰€ä»¥å°±ä¼šå¯¼è‡´è·¯ç”±ipå˜åŒ–æ—¶é€ æˆæœåŠ¡æ— æ³•è®¿é—®ã€‚
è§£å†³è¿™ä¸ªé—®é¢˜çš„è¯ï¼Œå°±å¯ä»¥ç”¨ set è®¾ç½®ä¸€ä¸ªå˜é‡ï¼Œé€šè¿‡ resolver å®ç°æ¯æ¬¡è®¿é—®éƒ½é‡æ–°è§£æå‡ºipåœ°å€ã€‚
è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå‘ç°é€šè¿‡setå’Œresolverè®¾ç½®åŸŸåè§£ææ—¶ï¼Œé‡å¯è·¯ç”±å™¨æµ‹è¯•è®¿é—®æ—¶ï¼Œè¿˜æ˜¯æ— æ³•è§£æå‡ºæ–°åœ°å€ï¼Œé€šè¿‡tcpdumpæŠ“åŒ…æ²¡æœ‰å‘ç°æœ‰è¯·æ±‚dnsè§£æã€‚
åæ¥æ³¨æ„åˆ°è¿˜æœ‰ä¸ª valid å‚æ•°éœ€è¦é…ç½®ï¼Œè¿™ä¸ªå‚æ•°ç”¨æ¥æ§åˆ¶ç¼“å­˜æ—¶é—´çš„ï¼Œé»˜è®¤æ—¶é—´å–å†³äºdnsè®°å½•çš„ttlå€¼ï¼Œæ¯”å¦‚æˆ‘ç”¨windowsæ­å»ºçš„dnsè§£æé»˜è®¤æ˜¯3600ç§’ï¼Œä¹Ÿå°±æ˜¯ä¸€å°æ—¶ã€‚
é€šè¿‡ä¿®æ”¹validå‚æ•°ï¼Œè¿™é‡Œè®¾ç½®ä¸º5ç§’åï¼Œå†æ¬¡æŠ“åŒ…å‘ç°æ¯éš”5ç§’åè®¿é—®è™šæ‹Ÿä¸»æœºçš„æ—¶å€™å°±ä¼šäº§ç”Ÿä¸€æ¬¡dnsè§£æã€‚</p>

<p>è¿™æ ·æ‰è§£å†³åŠ¨æ€dnsè§£æè®¿é—®é—®é¢˜ã€‚</p>

<p>Nginxæ€ä¹ˆåšåŸŸåè§£æï¼Ÿæ€ä¹ˆåœ¨ä½ è‡ªå·±å¼€å‘çš„æ¨¡å—é‡Œé¢ä½¿ç”¨Nginxæä¾›çš„æ–¹æ³•è§£æåŸŸåï¼Ÿå®ƒå†…éƒ¨å®ç°æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ</p>

<p>æœ¬æ–‡ä»¥Nginx 1.5.1ä¸ºä¾‹ï¼Œä»nginx_mail_smtpæ¨¡å—å¦‚ä½•è¿›è¡ŒåŸŸåè§£æå‡ºå‘ï¼Œåˆ†æNginxè¿›è¡ŒåŸŸåè§£æçš„è¿‡ç¨‹ã€‚ä¸ºäº†ç®€åŒ–æµç¨‹ï¼Œçªå‡ºé‡ç‚¹ï¼Œåœ¨ç¤ºä¾‹ä»£ç ä¸­çœæ‰äº†ä¸€äº›å¼‚å¸¸éƒ¨åˆ†çš„å¤„ç†ï¼Œæ¯”å¦‚å†…å­˜åˆ†é…å¤±è´¥ç­‰ã€‚DNSæŸ¥è¯¢åˆ†ä¸ºä¸¤ç§ï¼šæ ¹æ®åŸŸåæŸ¥è¯¢åœ°å€å’Œæ ¹æ®åœ°å€æŸ¥è¯¢åŸŸåï¼Œåœ¨ä»£ç ç»“æ„ä¸Šè¿™ä¸¤ç§æ–¹å¼éå¸¸ç›¸ä¼¼ï¼Œè¿™é‡Œåªä»‹ç»æ ¹æ®åŸŸåæŸ¥è¯¢åœ°å€è¿™ä¸€ç§æ–¹å¼ã€‚æœ¬æ–‡å°†ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¿›è¡Œä»‹ç»ï¼š</p>

<p>åŸŸåæŸ¥è¯¢çš„å‡½æ•°æ¥å£ä»‹ç»
åŸŸåè§£ææµç¨‹åˆ†æ
æŸ¥è¯¢åœºæ™¯åˆ†æåŠå®ç°ä»‹ç»
ä¸€ã€åŸŸåæŸ¥è¯¢çš„å‡½æ•°æ¥å£ä»‹ç»
åœ¨ä½¿ç”¨åŒæ­¥IOçš„æƒ…å†µä¸‹ï¼Œè°ƒç”¨gethostbyname()æˆ–è€…gethostbyname_r()å°±å¯ä»¥æ ¹æ®åŸŸåæŸ¥è¯¢åˆ°å¯¹åº”çš„IPåœ°å€, ä½†å› ä¸ºå¯èƒ½ä¼šé€šè¿‡ç½‘ç»œè¿›è¡Œè¿œç¨‹æŸ¥è¯¢ï¼Œæ‰€ä»¥éœ€è¦çš„æ—¶é—´æ¯”è¾ƒé•¿ã€‚</p>

<p>ä¸ºäº†ä¸é˜»å¡å½“å‰çº¿ç¨‹ï¼ŒNginxé‡‡ç”¨äº†å¼‚æ­¥çš„æ–¹å¼è¿›è¡ŒåŸŸåæŸ¥è¯¢ã€‚æ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹ä¸»è¦åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼Œè¿™ç‚¹åœ¨å„ç§å¼‚æ­¥å¤„ç†æ—¶éƒ½æ˜¯ä¸€æ ·çš„ï¼š</p>

<p>å‡†å¤‡å‡½æ•°è°ƒç”¨éœ€è¦çš„ä¿¡æ¯ï¼Œå¹¶è®¾ç½®å›è°ƒæ–¹æ³•
è°ƒç”¨å‡½æ•°
å¤„ç†ç»“æŸåå›è°ƒæ–¹æ³•è¢«è°ƒç”¨
å¦å¤–ï¼Œä¸ºäº†å°½é‡å‡å°‘æŸ¥è¯¢èŠ±è´¹çš„æ—¶é—´ï¼ŒNginxè¿˜å¯¹æŸ¥è¯¢ç»“æœåšäº†æœ¬åœ°ç¼“å­˜ã€‚ä¸ºäº†åˆå§‹åŒ–DNS Serveråœ°å€å’Œæœ¬åœ°ç¼“å­˜ç­‰ä¿¡æ¯ï¼Œéœ€è¦åœ¨çœŸæ­£æŸ¥è¯¢å‰éœ€è¦å…ˆè¿›è¡Œä¸€äº›å…¨å±€çš„åˆå§‹åŒ–æ“ä½œã€‚</p>

<p>ä¸‹é¢å…ˆä»è°ƒç”¨è€…çš„è§’åº¦å¯¹æ¯ä¸ªæ­¥éª¤åšè¯¦ç»†çš„åˆ†æï¼š</p>

<p>åˆå§‹åŒ–åŸŸåæŸ¥è¯¢æ‰€éœ€è¦çš„çš„å…¨å±€ä¿¡æ¯
éœ€è¦åˆå§‹åŒ–çš„å…¨å±€ä¿¡æ¯åŒ…æ‹¬ï¼š</p>

<p>DNS æœåŠ¡å™¨çš„åœ°å€ï¼Œå¦‚æœæŒ‡å®šäº†å¤šä¸ªæœåŠ¡å™¨ï¼Œnginxä¼šé‡‡ç”¨Round Robinçš„æ–¹å¼è½®æµæŸ¥è¯¢æ¯ä¸ªæœåŠ¡å™¨
å¯¹æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ï¼Œé‡‡ç”¨Red Black Treeçš„æ•°æ®ç»“æ„ï¼Œä»¥è¦æŸ¥è¯¢åå­—çš„Hashä½œä¸ºKey, èŠ‚ç‚¹ä¿¡æ¯å­˜æ”¾åœ¨ struct ngx_resolver_node_tä¸­ã€‚
å› ä¸ºresolveræ˜¯å…¨å±€çš„ï¼Œä¸ä»»ä½•ä¸€ä¸ªconnectionéƒ½æ— å…³ï¼Œæ‰€æœ‰éœ€è¦æ”¾åœ¨ä¸€ä¸ªéšæ—¶éƒ½å¯ä»¥å–åˆ°çš„åœ°æ–¹ï¼Œå¦‚ ngx_mail_core_srv_conf_tç»“æ„ä½“ä¸Šï¼Œåœ¨ä½¿ç”¨æ—¶ä»å½“å‰sessionæ‰¾åˆ°ngx_mail_core_srv_conf_tï¼Œç„¶åæ‰¾åˆ°resolverã€‚</p>

<p>DNS æœåŠ¡å™¨çš„ä¿¡æ¯éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æ˜ç¡®æŒ‡å‡ºï¼Œæ¯”å¦‚</p>

<p>#nginx.conf</p>

<p>resolver 8.8.8.8
#nginx é»˜è®¤ä¼šæ ¹æ®DNSè¯·æ±‚ç»“æœé‡Œçš„TTLå€¼æ¥è¿›è¡Œç¼“å­˜ï¼Œ
#å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªå¯é€‰çš„å‚æ•°validæ¥è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚:
#resolver 127.0.0.1 [::1]:5353 valid=30s;
ä¸‹é¢æ ¹æ®é…ç½®ä¸­çš„resolverå‚æ•°ï¼Œåˆå§‹åŒ–å…¨å±€çš„ngx_resolver_tï¼Œå…¶ä¸­ä¿å­˜äº†å‰é¢æåŠçš„DNSæœåŠ¡å™¨åœ°å€å’ŒæŸ¥è¯¢ç»“æœç­‰ä¿¡æ¯:</p>

<p>static char *
ngx_mail_core_resolver(ngx_conf_t *cf, ngx_command_t *cmd, void *conf)
{
     ngx_mail_core_srv_conf_t  *cscf = conf;
     ngx_str_t  *value;
     value = cf-&gt;args-&gt;elts;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> cscf-&gt;resolver = ngx_resolver_create(cf, &amp;value[1],
                                      cf-&gt;args-&gt;nelts - 1);
 return NGX_CONF_OK; } å‡†å¤‡æœ¬æ¬¡æŸ¥è¯¢çš„ä¿¡æ¯ å’Œæœ¬æ¬¡æŸ¥è¯¢ç›¸å…³çš„ä¿¡æ¯æ”¾åœ¨ngx_resolver_ctx_tç»“æ„ä½“ä¸­ï¼ŒåŒ…æ‹¬è¦æŸ¥è¯¢çš„åç§°ï¼ŒæŸ¥è¯¢å®Œçš„å›è°ƒæ–¹æ³•ï¼Œä»¥åŠè¶…æ—¶æ—¶é—´ç­‰ã€‚å¦‚æœæœ¬æ¬¡è¦æŸ¥è¯¢çš„åœ°å€å·²ç»æ˜¯IPv4ç”¨ç‚¹åˆ†éš”çš„åœ°å€äº†ï¼Œæ¯”å¦‚74.125.128.100, nginxä¼šåœ¨ngx_resolve_startä¸­è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶è®¾ç½®å¥½æ ‡å¿—ä½ï¼Œåœ¨è°ƒç”¨ngx_resolve_nameæ—¶ä¸ä¼šå‘é€çœŸæ­£çš„DNSæŸ¥è¯¢è¯·æ±‚ã€‚
</code></pre></div></div>

<p>static void
ngx_mail_smtp_resolve_name(ngx_event_t *rev)
{
     ngx_connection_t          *c;
     ngx_mail_session_t        *s;
     ngx_resolver_ctx_t        *ctx;
     ngx_mail_core_srv_conf_t  *cscf;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> c = rev-&gt;data;
 s = c-&gt;data;
 
 cscf = ngx_mail_get_module_srv_conf(s, ngx_mail_core_module);
 
 ctx = ngx_resolve_start(cscf-&gt;resolver, NULL);
 if (ctx == NULL) {
     ngx_mail_close_connection(c);
     return ;
 }
 
 ctx-&gt;name = s-&gt;host;
 ctx-&gt;type = NGX_RESOLVE_A;
 ctx-&gt;handler = ngx_mail_smtp_resolve_name_handler;
 ctx-&gt;data = s;
 ctx-&gt;timeout = cscf-&gt;resolver_timeout;
 
 //æ ¹æ®åå­—è¿›è¡ŒIPåœ°å€æŸ¥è¯¢
 if (ngx_resolve_name(ctx) != NGX_OK) {
     ngx_mail_close_connection(c);
 } } æ ¹æ®åå­—è¿›è¡ŒIPåœ°å€æŸ¥è¯¢ å‰é¢æ–¹æ³•çš„æœ€åé€šè¿‡ngx_resolve_nameæ–¹æ³•è¿›è¡ŒIPåœ°å€æŸ¥è¯¢ã€‚æŸ¥è¯¢æ—¶ï¼ŒNginxä¼šå…ˆæ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼Œå¦‚æœåœ¨ç¼“å­˜ä¸­ï¼Œå°±æ›´æ–°ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œå¹¶å›è°ƒè®¾ç½®çš„handler, å¦‚å‰é¢è®¾ç½®çš„ï¼šngx_mail_smtp_resolve_name_handlerï¼Œç„¶åæ•´ä¸ªæŸ¥è¯¢è¿‡ç¨‹ç»“æŸã€‚å¦‚æœæ²¡æœ‰åœ¨ç¼“å­˜ä¸­å°±å‘é€æŸ¥è¯¢è¯·æ±‚ç»™dns serverï¼ŒåŒæ—¶æ–¹æ³•è¿”å›ã€‚
</code></pre></div></div>

<p>æŸ¥è¯¢å®Œæˆåå›è°ƒåœ¨ngx_resolver_ctx_tä¸­æŒ‡å®šçš„æ–¹æ³•
çœŸæ­£çš„DNSæŸ¥è¯¢å®Œæˆåï¼Œä¸ç®¡æˆåŠŸï¼Œå¤±è´¥æˆ–æ˜¯è¶…æ—¶ï¼Œnginxä¼šå›è°ƒç›¸åº”æŸ¥è¯¢çš„handler, å¦‚å‰é¢è®¾ç½®çš„ï¼šngx_mail_smtp_resolve_name_handlerã€‚åœ¨handlerä¸­éƒ½éœ€è¦è°ƒç”¨ngx_resolve_addr_doneæ¥æ ‡è¯†æŸ¥è¯¢ç»“æŸã€‚</p>

<p>static void
ngx_mail_smtp_resolve_name_handler(ngx_resolver_ctx_t *ctx)
{
     in_addr_t            addr;
     ngx_uint_t           i;
     ngx_connection_t    *c;
     struct sockaddr_in  * sin ;
     ngx_mail_session_t  *s;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> s = ctx-&gt;data;
 c = s-&gt;connection;
 
 if (ctx-&gt;state) {
     ngx_log_error(NGX_LOG_ERR, c-&gt; log , 0,
                   "" %V " could not be resolved (%i: %s)" ,
                   &amp;ctx-&gt;name, ctx-&gt;state,
                   ngx_resolver_strerror(ctx-&gt;state));
 } else {
     /* AF_INET only */
     sin = ( struct sockaddr_in *) c-&gt;sockaddr;
 
     for (i = 0; i &lt; ctx-&gt;naddrs; i++) {
         addr = ctx-&gt;addrs[i];
 
         ngx_log_debug4(NGX_LOG_DEBUG_MAIL, c-&gt; log , 0,
                        "name was resolved to %ud.%ud.%ud.%ud" ,
                        (ntohl(addr) &gt;&gt; 24) &amp; 0xff,
                        (ntohl(addr) &gt;&gt; 16) &amp; 0xff,
                        (ntohl(addr) &gt;&gt; 8) &amp; 0xff,
                        ntohl(addr) &amp; 0xff);
 
         if (addr == sin -&gt;sin_addr.s_addr) {
             goto found;
         }
     }
 
     s-&gt;host = smtp_unavailable;
 }
</code></pre></div></div>

<p>found:
     //ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½è¦æ‰§è¡Œ
     ngx_resolve_name_done(ctx);
}
äºŒã€åŸŸåè§£ææµç¨‹åˆ†æ
é€šè¿‡Nginxè¿›è¡ŒåŸŸåæŸ¥è¯¢çš„æµç¨‹å›¾å¦‚ä¸‹ï¼Œé¢œè‰²è¶Šæ·±èŠ±è´¹çš„æ—¶é—´è¶Šé•¿ã€‚è°ƒç”¨è¿‡ç¨‹åˆ†ä¸ºä¸‰ç§ï¼š</p>

<p>é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯IPv4åœ°å€ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥è°ƒç”¨Handler
å†æ¬¡æ£€æŸ¥æ˜¯ä¸æ˜¯åœ¨ç¼“å­˜ä¸­ï¼Œå¦‚æœæœ‰ï¼Œå°±è°ƒç”¨Handler
æœ€åå‘é€è¿œç¨‹DNSè¯·æ±‚ï¼Œæ”¶åˆ°å›å¤åè°ƒç”¨Handler
nginx_dns_resolve (3)</p>

<p>ä¸‰ã€æŸ¥è¯¢åœºæ™¯åˆ†æåŠå®ç°ä»‹ç»
æŸ¥è¯¢çš„åœ°å€æ˜¯IP v4åœ°å€
æ¯”å¦‚74.125.128.100, nginxä¼šåœ¨ngx_resolve_startä¸­é€šè¿‡ngx_inet_addræ–¹æ³•è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯IPv4çš„åœ°å€ï¼Œå°±è®¾ç½®å¥½æ ‡å¿—ä½ ngx_resolver_ctx_t-&gt;quickï¼Œåœ¨æ¥ä¸‹æ¥çš„ngx_resolve_nameä¸­ä¼šå¯¹è¿™ä¸ªæ ‡å¿—ä½è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¸º1ï¼Œå°±ç›´æ¥è°ƒç”¨ngx_resolver_ctx_t-&gt;handler</p>

<p>ngx_resolver_ctx_t *
ngx_resolve_start(ngx_resolver_t *r, ngx_resolver_ctx_t *temp)
{
     in_addr_t            addr;
     ngx_resolver_ctx_t  *ctx;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> if (temp) {
     addr = ngx_inet_addr(temp-&gt;name.data, temp-&gt;name.len);
 
     if (addr != INADDR_NONE) {
         temp-&gt;resolver = r;
         temp-&gt;state = NGX_OK;
         temp-&gt;naddrs = 1;
         temp-&gt;addrs = &amp;temp-&gt;addr;
         temp-&gt;addr = addr;
         temp-&gt;quick = 1;
 
         return temp;
     }
 }
 ... } è¶…æ—¶æ²¡æœ‰å¾—åˆ°æŸ¥è¯¢ç»“æœ è°ƒç”¨ngx_resolve_nameæ—¶è®¾ç½®çš„å›è°ƒæ–¹æ³•è¢«è°ƒç”¨ï¼ŒåŒæ—¶ngx_resolver_ctx_t-&gt;stateè¢«è®¾ç½®ä¸ºNGX_RESOLVE_TIMEDOUTã€‚ç›¸åº”çš„ä»£ç ä¸ºï¼š
</code></pre></div></div>

<p>static void
ngx_resolver_timeout_handler(ngx_event_t *ev)
{
     ngx_resolver_ctx_t  *ctx;
     ctx = ev-&gt;data;
     ctx-&gt;state = NGX_RESOLVE_TIMEDOUT;
     ctx-&gt;handler(ctx);
}
æ­£å¸¸æŸ¥è¯¢ä¸€ä¸ªä¸åœ¨ç¼“å­˜ä¸­çš„åŸŸå
å¦‚æœè¦æŸ¥è¯¢çš„åŸŸåä¸åœ¨ç¼“å­˜ä¸­ï¼Œé¦–å…ˆæŠŠåŸŸåæŒ‰hashå€¼æ”¾åœ¨ç¼“å­˜ä¸­ï¼Œç„¶åå‡†å¤‡æŸ¥è¯¢éœ€è¦çš„æ•°æ®ï¼Œå‘é€DNSæŸ¥è¯¢çš„UDPè¯·æ±‚ç»™DNSæœåŠ¡å™¨ï¼Œ</p>

<p>static ngx_int_t
ngx_resolve_name_locked(ngx_resolver_t *r, ngx_resolver_ctx_t *ctx)
{
     ngx_resolver_node_t  *rn;
     rn = ngx_resolver_alloc(r, sizeof (ngx_resolver_node_t));
     ngx_rbtree_insert(&amp;r-&gt;name_rbtree, &amp;rn-&gt;node);
     ngx_resolver_create_name_query(rn, ctx);
     ngx_resolver_send_query(r, rn);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> rn-&gt;cnlen = 0;
 rn-&gt;naddrs = 0;
 rn-&gt;valid = 0;
 rn-&gt;waiting = ctx;
 
 ctx-&gt;state = NGX_AGAIN; }
</code></pre></div></div>

<p>//æ”¶åˆ°DNSæŸ¥è¯¢ç»“æœåçš„å›è°ƒæ–¹æ³•
static void
ngx_resolver_read_response(ngx_event_t *rev)
{
     ssize_t            n;
     ngx_connection_t  *c;
     u_char             buf[NGX_RESOLVER_UDP_SIZE];
     c = rev-&gt;data;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> do {
     n = ngx_udp_recv(c, buf, NGX_RESOLVER_UDP_SIZE);
     if (n &lt; 0) {
         return ;
     }
 
     ngx_resolver_process_response(c-&gt;data, buf, n);
 } while (rev-&gt;ready); }
</code></pre></div></div>

<p>static void
ngx_resolver_process_a(ngx_resolver_t *r, u_char *buf, size_t last,
     ngx_uint_t ident, ngx_uint_t code, ngx_uint_t nan, ngx_uint_t ans)
{
     hash = ngx_crc32_short(name.data, name.len);
     rn = ngx_resolver_lookup_name(r, &amp;name, hash);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> //copy addresses to cached node
 rn-&gt;u.addrs = addrs;
 
 //å›è°ƒæ‰€æœ‰ç­‰å¾…æœ¬åŸŸåè§£æçš„è¯·æ±‚
 next = rn-&gt;waiting;
 rn-&gt;waiting = NULL;
 
 while (next) {
      ctx = next;
      ctx-&gt;state = NGX_OK;
      ctx-&gt;naddrs = naddrs;
      ctx-&gt;addrs = (naddrs == 1) ? &amp;ctx-&gt;addr : addrs;
      ctx-&gt;addr = addr;
      next = ctx-&gt;next;
 
      ctx-&gt;handler(ctx);
 } } å¯¹åŒä¸€åŸŸåæŸ¥è¯¢å¤šæ¬¡æŸ¥è¯¢ å¦‚æœå¤šæ¬¡æŸ¥è¯¢æ—¶ï¼Œä¹‹å‰çš„æŸ¥è¯¢ç»“æœè¿˜åœ¨ç¼“å­˜ä¸­å¹¶ä¸”æ²¡æœ‰å¤±æ•ˆï¼Œå°±ç›´æ¥ä»ç¼“å­˜ä¸­å–åˆ°æŸ¥è¯¢ç»“æœï¼Œå¹¶è°ƒç”¨è®¾ç½®çš„å›è°ƒæ–¹æ³•ã€‚
</code></pre></div></div>

<p>static ngx_int_t
ngx_resolve_name_locked(ngx_resolver_t *r, ngx_resolver_ctx_t *ctx)
{
     uint32_t              hash;
     in_addr_t             addr, *addrs;
     ngx_uint_t            naddrs;
     ngx_resolver_ctx_t   *next;
     ngx_resolver_node_t  *rn;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> hash = ngx_crc32_short(ctx-&gt;name.data, ctx-&gt;name.len);
 rn = ngx_resolver_lookup_name(r, &amp;ctx-&gt;name, hash);
 
 if (rn) {
     if (rn-&gt;valid &gt;= ngx_time()) {
         naddrs = rn-&gt;naddrs;
 
         if (naddrs) {
             ctx-&gt;next = rn-&gt;waiting;
             rn-&gt;waiting = NULL;
 
             do {
                 ctx-&gt;state = NGX_OK;
                 ctx-&gt;naddrs = naddrs;
                 ctx-&gt;addrs = (naddrs == 1) ? &amp;ctx-&gt;addr : addrs;
                 ctx-&gt;addr = addr;
                 next = ctx-&gt;next;
 
                 ctx-&gt;handler(ctx);
 
                 ctx = next;
             } while (ctx);
 
             return NGX_OK;
         }
     }
 } } å¾—åˆ°æŸ¥è¯¢ç»“æœæ—¶åŒæ—¶è¶…æ—¶äº† å¦‚æœåœ¨å¾—åˆ°æŸ¥è¯¢ç»“æœçš„åŒæ—¶ï¼Œè®¾ç½®çš„è¶…æ—¶æ—¶é—´ä¹Ÿåˆ°æœŸäº†ï¼Œé‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ Nginxä¼šå…ˆå¤„ç†å„ç§ç½‘ç»œè¯»å†™äº‹ä»¶ï¼Œå†å¤„ç†è¶…æ—¶äº‹ä»¶ï¼Œåœ¨å¤„ç†ç½‘ç»œäº‹ä»¶æ—¶ï¼Œä¼šç›¸åº”åœ°æŠŠè®¾ç½®çš„å®šæ—¶å™¨åˆ é™¤ï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œè¶…æ—¶äº‹ä»¶æ—¶å°±ä¸ä¼šå†æ‰§è¡Œäº†ã€‚
</code></pre></div></div>

<p>void
ngx_process_events_and_timers(ngx_cycle_t *cycle)
{
     ngx_uint_t  flags;
     ngx_msec_t  timer, delta;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> //å¤„ç†å„ç§ç½‘ç»œäº‹ä»¶
 ( void ) ngx_process_events(cycle, timer, flags);
 
 //å¤„ç†å„ç§timeräº‹ä»¶ï¼Œå…¶ä¸­åŒ…å«äº†æŸ¥è¯¢è¶…æ—¶
 ngx_event_expire_timers(); } å¾—åˆ°æŸ¥è¯¢ç»“æœæ—¶å®¢æˆ·ç«¯å·²ç»å…³é—­è¿æ¥ å¦‚æœä¸åšä»»ä½•å¤„ç†ï¼Œé‚£ä¹ˆåœ¨æ”¶åˆ°dnsæŸ¥è¯¢ç»“æœåï¼Œä¼šå›è°ƒæŸ¥è¯¢æ—¶è®¾ç½®çš„å›è°ƒæ–¹æ³•ï¼Œä½†å› ä¸ºè¿æ¥å·²ç»è¢«å…³é—­ï¼Œç›¸åº”çš„å†…å­˜å·²ç»è¢«é‡Šæ”¾ï¼Œæ‰€ä»¥ä¼šæœ‰éæ³•å†…å­˜è®¿é—®çš„é—®é¢˜ã€‚æ€ä¹ˆé¿å…å‘¢ï¼Ÿåœ¨å¤„ç†è¿æ¥å…³é—­äº‹ä»¶æ—¶ï¼ŒåŒæ—¶éœ€è¦è°ƒç”¨ngx_resolve_name_done(ctx)æ–¹æ³•,è°ƒç”¨æ—¶éœ€è¦æŠŠstateè®¾ä¸ºNGX_AGAINæˆ–è€…NGX_RESOLVE_TIMEDOUTï¼Œè¿™æ ·å°±ä¼šåˆ é™¤æŸ¥è¯¢æ‰€è®¾ç½®çš„å›è°ƒä¿¡æ¯:
</code></pre></div></div>

<p>void ngx_close_xxx_session(ngx_xxx_session_t *s)
{
     if (s-&gt;resolver_ctx != NULL) {
         s-&gt;resolver_ctx-&gt;state = NGX_RESOLVE_TIMEDOUT;
         ngx_resolve_name_done(s-&gt;resolver_ctx);
         s-&gt;resolver_ctx = NULL;
     }
}</p>

<p>void ngx_resolve_name_done(ngx_resolver_ctx_t *ctx)
{
     uint32_t              hash;
     ngx_resolver_t       *r;
     ngx_resolver_ctx_t   *w, **p;
     ngx_resolver_node_t  *rn;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> r = ctx-&gt;resolver;
 if (ctx-&gt;state == NGX_AGAIN || ctx-&gt;state == NGX_RESOLVE_TIMEDOUT) {
     hash = ngx_crc32_short(ctx-&gt;name.data, ctx-&gt;name.len);
     rn = ngx_resolver_lookup_name(r, &amp;ctx-&gt;name, hash);
 
     if (rn) {
         p = &amp;rn-&gt;waiting;
         w = rn-&gt;waiting;
 
         while (w) {
             if (w == ctx) {
                 *p = w-&gt;next;
                 goto done;
             }
 
             p = &amp;w-&gt;next;
             w = w-&gt;next;
         }
     }
 }
</code></pre></div></div>

<p>done:
     ngx_resolver_free_locked(r, ctx);
}
æœ¬åœ°ç¼“å­˜çš„åœ°å€æ²¡æœ‰å†æ¬¡è¢«æŸ¥è¯¢
æ¯æ¬¡åœ¨æŸ¥è¯¢ç»“æŸçš„æ—¶å€™ï¼ˆè°ƒç”¨ngx_resolve_addr_doneï¼‰ï¼Œéƒ½ä¼šæ£€æŸ¥æœ‰æ²¡æœ‰ç¼“å­˜è¿‡æœŸï¼Œå¦‚æœæœ‰ï¼Œå°±ä¼šè¿›è¡Œé‡Šæ”¾ã€‚</p>

<p>static void
ngx_resolver_expire(ngx_resolver_t *r, ngx_rbtree_t *tree,
                     ngx_queue_t *queue)
{
     time_t                now;
     ngx_uint_t            i;
     ngx_queue_t          *q;
     ngx_resolver_node_t  *rn;
     now = ngx_time();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> for (i = 0; i &lt; 2; i++) {
     if (ngx_queue_empty(queue)) {
         return ;
     }
 
     q = ngx_queue_last(queue);
     rn = ngx_queue_data(q, ngx_resolver_node_t, queue);
 
     if (now &lt;= rn-&gt;expire) {
         return ;
     }
 
     ngx_log_debug2(NGX_LOG_DEBUG_CORE, r-&gt; log , 0,
         "resolver expire " %*s "" , ( size_t ) rn-&gt;nlen, rn-&gt;name);
 
     ngx_queue_remove(q);
     ngx_rbtree_delete(tree, &amp;rn-&gt;node);
     ngx_resolver_free_node(r, rn);
 } } åŸŸåå¯¹åº”è¿™å¤šä¸ªIPåœ°å€ å¦‚æœå¯¹åº”çš„æœ‰å¤šä¸ªip,é‚£ä¹ˆåœ¨æ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œä¼šéšæœºçš„é‡æ–°æ’åˆ—é¡ºåºï¼Œç„¶åè¿”å›ã€‚å¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œåªè¦å»ç¬¬ä¸€ä¸ªåœ°å€ï¼Œå°±å¯ä»¥è¾¾åˆ°å–éšæœºåœ°å€çš„ç›®çš„äº†ã€‚
</code></pre></div></div>

<p>static ngx_int_t
ngx_resolve_name_locked(ngx_resolver_t *r, ngx_resolver_ctx_t *ctx)
{
     if (naddrs) {
         if (naddrs != 1) {
             addr = 0;
             addrs = ngx_resolver_rotate(r, rn-&gt;u.addrs, naddrs);
             if (addrs == NULL) {
                 return NGX_ERROR;
             }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     } else {
         addr = rn-&gt;u.addr;
         addrs = NULL;
     }
 } }
</code></pre></div></div>

<p>static in_addr_t *
ngx_resolver_rotate(ngx_resolver_t *r, in_addr_t *src, ngx_uint_t n)
{
     void        *dst, *p;
     ngx_uint_t   j;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> dst = ngx_resolver_alloc(r, n * sizeof (in_addr_t));
 j = ngx_random() % n;
 
 if (j == 0) {
     ngx_memcpy(dst, src, n * sizeof (in_addr_t));
     return dst;
 }
 
 p = ngx_cpymem(dst, &amp;src[j], (n - j) * sizeof (in_addr_t));
 ngx_memcpy(p, src, j * sizeof (in_addr_t));
 
 return dst; } æŒ‡å®šäº†å¤šä¸ªdns serveråœ°å€ä¼šæ€ä¹ˆæŸ¥è¯¢ å¦‚æœåœ¨é…ç½®æ–‡ä»¶é‡ŒæŒ‡å®šäº†å¤šä¸ªdns serveråœ°å€ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ¯”å¦‚
</code></pre></div></div>

<p>#nginx.conf
resolver 8.8.8.8 8.8.4.4
é‚£ä¹ˆnginx ä¼šé‡‡ç”¨Round Robin çš„æ–¹å¼è½®æµæŸ¥è¯¢å„ä¸ªdns serverã€‚åœ¨æ–¹æ³•ngx_resolver_send_queryä¸­é€šè¿‡åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ”¹å˜last_connectionæ¥è½®æµä½¿ç”¨ä¸åŒçš„dns serverè¿›è¡ŒæŸ¥è¯¢</p>

<p>static ngx_int_t
ngx_resolver_send_query(ngx_resolver_t *r, ngx_resolver_node_t *rn)
{
     ssize_t                n;
     ngx_udp_connection_t  *uc;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> uc = r-&gt;udp_connections.elts;
 
 uc = &amp;uc[r-&gt;last_connection++];
 if (r-&gt;last_connection == r-&gt;udp_connections.nelts) {
     r-&gt;last_connection = 0;
 }
 ... }
</code></pre></div></div>
:ET