I"Ì4<p>CGI(Common Gateway Interface)æ˜¯èƒ½è®©webæœåŠ¡å™¨å’ŒCGIè„šæœ¬å…±åŒå¤„ç†å®¢æˆ·çš„è¯·æ±‚çš„åè®®ã€‚å®ƒçš„åè®®å®šä¹‰æ–‡æ¡£æ˜¯http://www.ietf.org/rfc/rfc3875ã€‚</p>

<p>å…¶ä¸­WebæœåŠ¡å™¨è´Ÿè´£ç®¡ç†è¿æ¥ï¼Œæ•°æ®ä¼ è¾“ï¼Œç½‘ç»œäº¤äº’ç­‰ã€‚è‡³äºCGIè„šæœ¬å°±è´Ÿè´£ç®¡ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>

<p>WebæœåŠ¡å™¨çš„åŠŸèƒ½æ˜¯å°†å®¢æˆ·ç«¯è¯·æ±‚ï¼ˆHTTP Requestï¼‰è½¬æ¢æˆCGIè„šæœ¬è¯·æ±‚ï¼Œç„¶åæ‰§è¡Œè„šæœ¬ï¼Œæ¥ç€å°†CGIè„šæœ¬å›å¤è½¬æ¢ä¸ºå®¢æˆ·ç«¯çš„å›å¤ï¼ˆHTTP Responseï¼‰ã€‚</p>

<p>CGIçš„è„šæœ¬è¯·æ±‚æœ‰ä¸¤éƒ¨åˆ†ï¼šè¯·æ±‚å…ƒæ•°æ®ï¼ˆrequest meta-variablesï¼‰å’Œç›¸å…³çš„æ¶ˆæ¯ä½“ï¼ˆmessage-bodyï¼‰ã€‚</p>

<p>è¯·æ±‚å…ƒæ•°æ®
åŒ…å«ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                           "AUTH_TYPE" | "CONTENT_LENGTH" |
                       "CONTENT_TYPE" | "GATEWAY_INTERFACE" |
                       "PATH_INFO" | "PATH_TRANSLATED" |
                       "QUERY_STRING" | "REMOTE_ADDR" |
                       "REMOTE_HOST" | "REMOTE_IDENT" |
                       "REMOTE_USER" | "REQUEST_METHOD" |
                       "SCRIPT_NAME" | "SERVER_NAME" |
                       "SERVER_PORT" | "SERVER_PROTOCOL" |
                       "SERVER_SOFTWARE" | scheme |
                       protocol-var-name | extension-var-name
</code></pre></div></div>

<p>ä¸‹é¢ä¸€ä¸ªä¸€ä¸ªçœ‹ï¼š</p>

<p>AUTH_TYPEæ˜¯å”¯ä¸€æ ‡è¯†äº†ç”¨æˆ·çš„è®¤è¯æ–¹å¼ï¼Œæ¯”å¦‚basicï¼ŒDigestç­‰
CONTENT_LENGTHæ˜¯è¯·æ±‚æ¶ˆæ¯ä½“çš„é•¿åº¦
CONTENT_TYPEæ˜¯æ ‡è¯†æ¶ˆæ¯ä½“çš„æ ¼å¼
GATEWAY_INTERFACEæ ‡è¯†ä½¿ç”¨çš„CGIçš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚CGI/1.1
PATH_INFOè¯´æ˜äº†è§£é‡ŠCGIè„šæœ¬çš„åœ°å€
PATH_TRANSLATEDå°±æ˜¯å¯ä»¥è¢«è®¿é—®çš„cgiçš„è·¯å¾„ï¼Œå®ƒå¯¹åº”CGIè„šæœ¬çš„è·¯å¾„ï¼Œæ¯”å¦‚
http://somehost.com/cgi-bin/somescript/this%2eis%2epath%3binfo
å¯¹åº”çš„PATH_INFOå°±æ˜¯/this.is.the.path;info
QUERY_STRING è¯·æ±‚å‚æ•°ï¼ˆGETçš„å‚æ•°å°±æ˜¯æ”¾åœ¨è¿™ä¸ªé‡Œé¢çš„ï¼‰
REMOTE_ADDRæ ‡è¯†å®¢æˆ·ç«¯çš„ipåœ°å€
REMOTE_HOSTæ ‡è¯†çš„æ˜¯å®¢æˆ·ç«¯çš„åŸŸå
REMOTE_IDENTæ˜¯å‘å‡ºè¯·æ±‚çš„ä½¿ç”¨è€…æ ‡ç¤ºï¼Œå¤§å¤šæ•°æœåŠ¡ç«¯é€‰æ‹©å¿½ç•¥è¿™ä¸ªå±æ€§
REMOTE_USERæ˜¯ä½¿ç”¨è€…çš„åˆæ³•åç§°
REQUEST_METHODæ˜¯è¯·æ±‚æ–¹æ³•ï¼ŒåŒ…æ‹¬GET/POST/PUT/DELETEç­‰
SCRIPT_NAMEæ˜¯è„šæœ¬ç¨‹åºçš„è™šæ‹Ÿè·¯å¾„ï¼Œæ¯”å¦‚æ˜¯/test/test.php
SERVER_NAMEæ˜¯WEBæœåŠ¡å™¨çš„åŸŸå
SERVER_PORTæ˜¯WEBæœåŠ¡å™¨ç«¯å£å
SERVER_PROTOCOLæ˜¯WEBæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯çš„äº¤äº’è¯·æ±‚åè®®
SERVER_SOFTWAREå‘é€ç»™å®¢æˆ·ç«¯çš„responseçš„WebæœåŠ¡å™¨çš„æ ‡è¯†ï¼Œæ¯”å¦‚nginx/1.0.6</p>

<p>è¯·æ±‚æ¶ˆæ¯ä½“
å°±æ˜¯ç›´æ¥å°†å®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯ä½“è½¬å‘ï¼Œå°†æ¶ˆæ¯ä½“æ”¾åœ¨stdinä¸­ä¼ é€’ç»™scriptçš„</p>

<p>ç›¸å…³çŸ¥è¯†ç‚¹
å‚æ•°ä¼ é€’
ä¸‹é¢çš„é—®é¢˜å°±æ˜¯webæœåŠ¡å™¨è·å–äº†httpè¯·æ±‚åï¼Œç”±äºhttpè¯·æ±‚æ˜¯æœ‰åˆ†GETå’ŒPOSTç­‰æ–¹æ³•çš„ã€‚å‚æ•°æ€ä¹ˆä¼ é€’ç»™å¯æ‰§è¡Œç¨‹åºå‘¢ï¼Ÿ
æ¯”å¦‚GETæ–¹æ³•ï¼ŒCGIç¨‹åºå°±ä¼šä»ç¯å¢ƒå˜é‡QUERY_STRINGä¸­è·å–æ•°æ®ã€‚
POSTå‘¢ï¼ŸWebæœåŠ¡å™¨ä¼šé€šè¿‡stdinï¼ˆæ ‡å‡†è¾“å…¥ï¼‰æƒ³CGIä¸­ä¼ é€æ•°æ®çš„ã€‚è€Œä¼ é€çš„æ•°æ®é•¿åº¦å°±æ˜¯æ”¾åœ¨CONTENT_LENGTHä¸­çš„ã€‚
å¯¹åº”äºHTTPè¯·æ±‚ï¼ŒQUERY_STRINGå­˜æ”¾httpçš„GETå‚æ•°ï¼Œstdinå­˜æ”¾HTTPçš„BODYå‚æ•°</p>

<p>ç°åœ¨æµè¡Œçš„nginx+phpçš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨nginx(webæœåŠ¡å™¨)å°†è¯·æ±‚å˜æˆcgiè¯·æ±‚åˆ°php-cgiä¸Šï¼Œç„¶åphp-cgiè¿›ç¨‹æ‰§è¡Œphpï¼Œå°†è¿”å›å€¼å˜æˆcgi responseè¿”å›ç»™nginxã€‚nginxå†å°†å®ƒå˜æˆhttpå›å¤è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p>

<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œcgiæ˜¯å•è¿›ç¨‹çš„ï¼Œä¸€ä¸ªè¿›ç¨‹çš„ç”Ÿå‘½æœŸå°±åªæ˜¯è¯·æ±‚è¿›æ¥ï¼Œå¤„ç†ï¼Œè¿”å›å›å¤è¿™å‡ ä¸ªé˜¶æ®µã€‚ä½†æ˜¯webæœåŠ¡å™¨éƒ½æ˜¯éœ€è¦æ¥å—å¤šä¸ªwebè¯·æ±‚çš„ï¼Œè¿™é‡Œå°±éœ€è¦åœ¨åç«¯å¼€å¯å¤šä¸ªcgiäº†ã€‚ä¸€èˆ¬çš„cgiæœåŠ¡å™¨éƒ½ä¼šè®¾ç½®å…è®¸å¼€å¯å¤šå°‘ä¸ªcgiçš„æ•°é‡çš„ã€‚</p>

<p>è¿™é‡Œè¦æ˜ç¡®ä¸€ç‚¹ï¼Œcgiæ˜¯æœ‰åˆ†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„åŒºåˆ«çš„ï¼Œcgiå®¢æˆ·ç«¯æ˜¯æ”¾åœ¨webæœåŠ¡å™¨ä¸€ä¾§ï¼Œåƒnginxï¼Œapacheè¿™æ ·çš„webæœåŠ¡å™¨å°±å·²ç»æ˜¯å®ç°äº†è¿™ä¸ªå®¢æˆ·ç«¯ã€‚æœåŠ¡å™¨ç«¯éœ€è¦å¦å¤–é‡å¯ã€‚åƒnginx+cgi+phpè¿™æ ·çš„é…åˆå°±éœ€è¦å¯åŠ¨php-cgiæœåŠ¡ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥æƒ³åˆ°è¿™æ ·çš„æœåŠ¡ä¸€å®šæ˜¯ä»¥deamonçš„å½¢å¼åœ¨åå°è¿è¡Œï¼Œç„¶åä¼šforkå‡ºå¾ˆå¤šä¸ªcgiè¿›ç¨‹ã€‚</p>

<p>å¤ç”¨
å½“ç„¶æœ‰äººä¼šé—®ï¼Œcgiè¿›ç¨‹ä¸èƒ½å¤ç”¨æ˜¯ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸å‘¢ï¼Œfastcgiå‡ºç°å°±æ˜¯è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚å®ƒçš„ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¯·æ±‚ã€‚è¿™æ ·é€Ÿåº¦å½“ç„¶å°±å‡ä¸Šå»äº†ã€‚ç„¶åè¿˜æœ‰ä¸€ç§cgiæ˜¯scgiï¼ˆsimple cgiï¼‰ï¼Œscgiå’Œfastcgiç›¸ä¼¼ï¼Œåªèƒ½è¯´å®ƒå®šä¹‰çš„åè®®æ›´ç®€å•ï¼ˆæ‰€ä»¥æ‰å«åšsimpleï¼‰ã€‚scgiçš„å®¢æˆ·ç«¯æ˜¯cå†™çš„ï¼ŒæœåŠ¡ç«¯æ˜¯perlå†™çš„ã€‚</p>

<p>å°±æœ€å¸¸è§çš„nginx+cgi+phpæ¥è¯´ï¼Œè¦æ˜ç¡®ä¸€ç‚¹phpä¸­$_SERVERä¸­è·å–çš„ä¿¡æ¯å®é™…éƒ½æ˜¯ä»cgiä¸­è·å–çš„ï¼Œå½“ç„¶è¿™ä¸ªå’Œnginxä¸­è·å–çš„å®¢æˆ·ç«¯ä¿¡æ¯æ˜¯ä¸€è‡´çš„ã€‚å¦å¤–ç”±äºcgiæ˜¯æœ‰å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„åŒºåˆ«çš„ï¼Œå› æ­¤å¾ˆå®¹æ˜“æƒ³åˆ°cgiå®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨tcpä¸å®¢æˆ·ç«¯è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥å½“ç„¶éœ€è¦å ç”¨ä¸€ä¸ªç«¯å£ï¼Œå› æ­¤è¿˜æ˜¯ä¼šæœ‰ç«¯å£é™åˆ¶çš„ã€‚æ‰€ä»¥ä»è¿™ä¸ªè§’åº¦ä¸Šè¯´ï¼Œå¹¶ä¸æ˜¯cgiå¼€çš„è¶Šå¤šè¶Šå¥½ï¼ˆå½“ç„¶6wçš„ç«¯å£é™åˆ¶æ˜¯è¿œè¿œå¤Ÿçš„äº†ï¼‰ã€‚</p>

<p>å®‰å…¨
å…³äºå¼€å¯çš„cgiå®‰å…¨é—®é¢˜ï¼Œæ›¾ç»é¸Ÿå“¥å°±çˆ†å‡ºäº†ä¸€ä¸ªbugï¼šhttp://www.laruence.com/2010/05/20/1495.html
æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥çœ‹çœ‹ã€‚</p>

<p>è¿˜æœ‰cgiæœåŠ¡å™¨ä¸æ˜¯åœ¨ç›‘å¬ç«¯å£å—ï¼Ÿæ€ä¹ˆé˜²æ­¢å¤–ç½‘çš„è¯·æ±‚æ‰§è¡Œcgiå‘¢ï¼Ÿæˆ‘ä»¬ä¸€èˆ¬çš„åŠæ³•å°±æ˜¯ç›´æ¥ç»‘å®šåœ¨127.0.0.1çš„ipåœ°å€ä¸Šï¼Œä¿è¯åªæœ‰æœ¬æœºæ‰èƒ½è®¿é—®
<!-- more -->
CGIåŒ…é˜…è¯»
cgiåŒ…çš„å­˜åœ¨å°±å‘Šè¯‰æˆ‘ä»¬ä¸€ä»¶äº‹æƒ…ï¼ŒcgiæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å®Œå…¨å¯ä»¥ä½¿ç”¨Goæ¥å†™</p>

<p>è¿™ä¸ªåŒ…å…¶å®å¾ˆç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªæ–‡ä»¶ï¼Œå…¶ä»–éƒ½æ˜¯æµ‹è¯•ç¨‹åº</p>

<p>child.go</p>

<p>host.go</p>

<p>host.goæ˜¯å¯ä»¥ç›´æ¥å®¿ä¸»åˆ°goçš„webæœåŠ¡å™¨ä¸Šçš„ä»£ç ï¼Œé‡Œé¢æä¾›äº†å¯¹requestå’Œresponseçš„ç›´æ¥å¤„ç†å‡½æ•°ServerHTTP, å½“ä½ æ˜¯ä½¿ç”¨goçš„httpåŒ…å†™äº†ä¸ªhttpä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ServerHTTPå¯¹è¯·æ±‚ç›´æ¥é…ç½®ä¸Šcgiï¼Œæœ‰ç‚¹åƒapacheä¸­è‡ªå¸¦äº†php-cgi</p>

<p>child.goåˆ™æ˜¯å·²ç»è¿›å…¥åˆ°è„šæœ¬å­è¿›ç¨‹ä¸­äº†ï¼Œå¦‚æœä½ çš„CGIè„šæœ¬æ˜¯goä»£ç ç”Ÿæˆçš„å¯æ‰§è¡Œè„šæœ¬ï¼Œé‚£ä¹ˆä½ å°±ä¼šæœ‰ç”¨åˆ°è¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„å‡½æ•°äº†ã€‚è¿™ä¸ªæ–‡ä»¶å†…æä¾›äº†å°†å‘½ä»¤è¡Œç¯å¢ƒï¼ˆCGIè¯·æ±‚ï¼‰è½¬æ¢æˆGoçš„httpåŒ…ä¸­çš„requestçš„æ–¹æ³•ã€‚</p>

<p>host.goæ˜¯cgiçš„å¯åŠ¨çˆ¶ç¨‹åºéœ€è¦ç”¨åˆ°çš„åŒ…ï¼Œchild.goæ˜¯å­ç¨‹åºéœ€è¦ç”¨åˆ°çš„åŒ…</p>

<p>å…ˆçœ‹host.go
é¦–å…ˆæ˜¯trailingPortï¼Œè¿™ä¸ªå˜é‡æ˜¯cgiæœåŠ¡å™¨ç›‘å¬çš„ç«¯å£å·ï¼Œï¼ˆæ¯”å¦‚åœ¨nginxä¸­æˆ‘ä»¬ä¸€èˆ¬éƒ½ç›‘å¬9000ï¼‰</p>

<p>ç„¶åæ˜¯osDefaultInheritEnvï¼Œè¿™ä¸ªmapå°†å„ä¸ªå¹³å°çš„å…±äº«åº“é»˜è®¤è·¯å¾„åˆ—å‡ºæ¥äº†ã€‚ä¸ºä»€ä¹ˆè®¾ç½®è¿™ä¸ªå˜é‡å‘¢ï¼Ÿè¿™æ ·è¯´ï¼Œç”±äºcgiæœåŠ¡å™¨æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™å‘½ä»¤æŸ¥æ‰¾è®¾ç½®å‚æ•°æœ‰çš„æ˜¯å»ç¯å¢ƒå˜é‡ä¸­è·å–çš„ï¼Œå› æ­¤å¯¹æ¯ä¸ªå‘½ä»¤æ‰§è¡Œéœ€è¦è®¾ç½®ä¸€ä¸‹ç¯å¢ƒå˜é‡ã€‚è€Œåœ¨ä¸åŒçš„å¹³å°ï¼ŒåŠ¨æ€åº“çš„è·¯å¾„æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æœ‰äº†è¿™ä¹ˆä¸ªMapã€‚</p>

<p>Handleræ˜¯åœ¨å­ç¨‹åºä¸­æ‰§è¡Œcgiè„šæœ¬çš„ã€‚é‡Œé¢è¦æ³¨æ„çš„ç»“æ„æ˜¯ä¸¤ä¸ªEnvå’ŒInheritEnvä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ç‰¹åˆ«è®¾å®šçš„ç¯å¢ƒå˜é‡ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ç»§æ‰¿çš„ç¯å¢ƒå˜é‡ã€‚</p>

<p>è¿˜æœ‰Handlerä¸­çš„Pathï¼Œå°±æ˜¯æ‰§è¡Œæ–‡ä»¶çš„è·¯å¾„ï¼Œæ¯”å¦‚/test.php</p>

<p>ä¸‹é¢å°±æ˜¯æœ€é‡è¦çš„ServeHTTPäº†ï¼Œè¿™ä¸ªæ˜¯ç”¨æ¥å›è°ƒå¤„ç†HTTPè¯·æ±‚çš„ï¼Œå®ƒä¼šå°†HTTPè¯·æ±‚è½¬åŒ–ä¸ºCGIè¯·æ±‚ï¼Œå¹¶ä¸”æ‰§è¡Œè¿™ä¸ªcgiè„šæœ¬ã€‚</p>

<p>åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œèƒ½çœ‹åˆ°CGIçš„RFCæ ‡å‡†å‚æ•°èµ‹å€¼ï¼Œç„¶åå¯ä»¥çœ‹åˆ°æ‹¼å‡ºäº†envä¹‹åå°†envä½œä¸ºexec.Cmdçš„Envæ¥è°ƒç”¨cgiè„šæœ¬ï¼ˆpathï¼‰ã€‚åŒæ—¶ä¹Ÿçœ‹åˆ°äº†å½“bodyå†…æœ‰contentçš„æ—¶å€™ï¼Œä¼šå°†Bodyä½œä¸ºstdinè¾“å…¥ï¼Œç„¶åä»stdoutå‡ºæ¥çš„ä¸œè¥¿é€è¡Œè¯»å–ï¼Œç„¶åè¯»å–åˆ°headerå’Œbodyä¸­å»ã€‚</p>

<p>çœ‹äº†host.goçš„å®ç°å°±å¾ˆå¥½ç†è§£child.goçš„å®ç°äº†ã€‚</p>

<p>ä»Serveï¼ˆhandlerï¼‰æ¥çœ‹ï¼Œå…ˆæ˜¯ä½¿ç”¨å°†nginxæä¾›çš„cgiè¯·æ±‚è½¬æ¢æˆä¸ºnetåŒ…ä¸­çš„http requestå’Œresponseï¼Œå¦‚æœä½ æœ‰è®¾ç½®handlerï¼Œå°±ç”¨requestå’Œresponseæ¥è¿›è¡Œå¤„ç†ã€‚</p>

<p>åç»­çš„å‡ ä¸ªæ“ä½œWriteï¼ŒFlushéƒ½å·²ç»æ˜¯ç®€å•çš„bufferå¤„ç†äº†ã€‚</p>

<p>CGIåŒ…ä½¿ç”¨
ç„¶åè‡ªç„¶æƒ³åˆ°çš„ä¸€ä¸ªé—®é¢˜ï¼Œèƒ½ä¸èƒ½å®ç°</p>

<p>go-webæœåŠ¡å™¨ + go-cgi + cgi-script</p>

<p>è¿™ä¸ªæ˜¯å¯ä»¥åšçš„ï¼Œè€Œä¸”ä¹Ÿä¸å¤æ‚ï¼š</p>

<p>ä»£ç å¦‚ä¸‹ï¼š</p>

<p>package main</p>

<p>import(
  â€œnet/http/cgiâ€
  â€œlogâ€
  â€œnet/httpâ€
)</p>

<p>func main() {
  http.HandleFunc(â€œ/â€, func(w http.ResponseWriter, r *http.Request){
    handler := new(cgi.Handler)
    handler.Path = â€œ/usr/local/go/gopath/src/cgi-script/â€ + r.URL.Path
    log.Println(handler.Path)
    handler.Dir = â€œ/usr/local/go/gopath/src/cgi-script/â€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>handler.ServeHTTP(w, r)   })
</code></pre></div></div>

<p>log.Fatal(http.ListenAndServe(â€œ:8989â€,nil))
}
å¦‚æœä½ åœ¨cgi-scriptä¸­æœ‰ä¸ªå¯è¿è¡Œçš„cgiè„šæœ¬ï¼Œæ¯”å¦‚test.perl</p>

<p>é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨æµè§ˆå™¨ä¸­è°ƒç”¨http://10.16.15.64:8989/test.perl</p>

<p>æ¥è¿›è¡Œè„šæœ¬è°ƒç”¨</p>

<p>ç„¶åè¿›ä¸€æ­¥æƒ³ï¼Œèƒ½ä¸èƒ½æŠŠgoä»£ç å½“ä½œæ˜¯phpè¿™æ ·çš„åŠ¨æ€è„šæœ¬æ¥è¿è¡Œå‘¢ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€è¾¹ä¿®æ”¹goæºç ï¼Œä¸€è¾¹å°±å¯ä»¥åœ¨é¡µé¢ä¸­ç«‹åˆ»æ˜¾ç¤ºä¿®æ”¹ç»“æœäº†ã€‚å³</p>

<p>go-web + go-cgi + go-cgi-script?
ç­”æ¡ˆåŒæ ·ä¹Ÿæ˜¯å¯ä»¥ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™ç”±äºxx.goå¹¶éæ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼Œåªèƒ½ä½¿ç”¨go run æ¥è¿›è¡Œè°ƒç”¨ã€‚</p>

<p>ä»£ç ï¼š
package main</p>

<p>import(
  â€œnet/http/cgiâ€
  â€œlogâ€
  â€œnet/httpâ€
)</p>

<p>func main() {
  http.HandleFunc(â€œ/â€, func(w http.ResponseWriter, r *http.Request){
    handler := new(cgi.Handler)
    handler.Path = â€œ/usr/local/bin/goâ€
    script := â€œ/usr/local/go/gopath/src/cgi-script/â€ + r.URL.Path
    log.Println(handler.Path)
    handler.Dir = â€œ/usr/local/go/gopath/src/cgi-script/â€
    args := []string{â€œrunâ€, script}
    handler.Args = append(handler.Args, argsâ€¦)
    handler.Env = append(handler.Env, â€œGOPATH=/usr/local/go/gopathâ€)
    handler.Env = append(handler.Env, â€œGOROOT=/usr/local/go/goâ€)
    log.Println(handler.Args)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>handler.ServeHTTP(w, r)   })
</code></pre></div></div>

<p>log.Fatal(http.ListenAndServe(â€œ:8989â€,nil))
}</p>

<p>ç„¶ååœ¨cgi-scriptæ–‡ä»¶å¤¹ä¸­å»ºç«‹test.go
package main</p>

<p>import(
  â€œfmtâ€
)</p>

<p>func init() {
  fmt.Print(â€œContent-Type: text/plain;charset=utf-8\n\nâ€);
}</p>

<p>func main() {
  fmt.Println(â€œThis is go test!!!!â€)
}
è¿™é‡Œçš„init()æ˜¯å¿…é¡»æ‰“å°å‡ºæ¥çš„</p>

<p>http://127.0.0.1:8086/cgi/testcgi.go</p>

<p>CGI error: fork/exec /Users/didi/goLang/src/github.com/xiazemin/cgi/gocgi/cgi: permission denied
åŸå›   éœ€è¦å°† pathè®¾ç½®æˆgoå®‰è£…ç›®å½•
  handler.Path = â€œ/usr/local/go/bin/goâ€</p>

<p>æˆ‘ä»¬èšç„¦åœ¨ go run çš„è¾“å‡ºç»“æœä¸Šï¼Œå‘ç°å®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶çš„åœ°å€ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>åœ¨go help runä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°</p>

<p>Run compiles and runs the main package comprising the named Go source files.
 A Go source file is defined to be a file ending in a literal â€œ.goâ€ suffix.
 ä¹Ÿå°±æ˜¯ go run æ‰§è¡Œæ—¶ä¼šå°†æ–‡ä»¶æ”¾åˆ° /tmp/go-buildâ€¦ ç›®å½•ä¸‹ï¼Œç¼–è¯‘å¹¶è¿è¡Œ</p>

<p>å› æ­¤go run main.goå‡ºç°/tmp/go-build962610262/b001/exeç»“æœä¹Ÿä¸å¥‡æ€ªäº†ï¼Œå› ä¸ºå®ƒå·²ç»è·‘åˆ°ä¸´æ—¶ç›®å½•ä¸‹å»æ‰§è¡Œå¯æ‰§è¡Œæ–‡ä»¶äº†</p>

<p>è§£å†³åŠæ³•ï¼š//export TMPDIR=/run/shm</p>

<p>type Handler struct{
       Path string // æ‰§è¡Œç¨‹åº 
       Root string // å¤„ç† url çš„æ ¹ï¼Œä¸ºç©ºçš„æ—¶å€™â€œ/â€
       Dir string         // ç›®å½• 
       Env        []string    // ç¯å¢ƒå˜é‡ 
       InheritEnv []string    // é›†æˆç¯å¢ƒå˜é‡ 
       Logger     *log.Logger// æ—¥å¿— 
       Args       []string    // å‚æ•° 
       PathLocationHandlerhttp.Handler //http åŒ…çš„ handler å®¿ä¸» 
    }</p>

<p>child.go ä¸»è¦æ˜¯ç”Ÿæˆcgiå¤„ç†ç¨‹åºç”¨ï¼Œä½¿ç”¨èŒƒä¾‹
https://ilmanzo.github.io/programming/2015/10/29/cgi-apps-in-go</p>

<p>//save this as todoapp.go
package main</p>

<p>import (
    â€œfmtâ€
    â€œhtml/templateâ€
    â€œio/ioutilâ€
    â€œlogâ€
    â€œnet/httpâ€
    â€œnet/http/cgiâ€
    â€œstringsâ€
)</p>

<p>const datafile = â€œ/tmp/todos.txtâ€
const templatefile = â€œ/data/templates/page.gtplâ€
const htmlheader = â€œtext/html; charset=utf-8â€</p>

<p>func CGIHandler(rw http.ResponseWriter, req *http.Request) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type ViewData struct {
    Todos []string
    DisplayTodos bool
}

viewdata := ViewData{}
check(req.ParseForm(),"parsing form")

// load data from file to array string
content, err := ioutil.ReadFile(datafile)
check(err,"reading data file:")
viewdata.Todos = strings.Split(string(content), "\n")
viewdata.DisplayTodos = (len(viewdata.Todos) &gt; 0)
if len(req.Form["entry"]) &gt; 0 {
    // request coming from submit: append to the stored list
    viewdata.Todos = append(viewdata.Todos, req.Form["entry"][0])
    data := strings.Join(viewdata.Todos, "\n")
    // save current array string to disk. TODO: locking!!
    err := ioutil.WriteFile(datafile, []byte(data), 0644)
    check(err,"writing data file")
}
header := rw.Header()
header.Set("Content-Type", htmlheader)
t, err := template.ParseFiles(templatefile)
check(err,"parsing template")
err = t.Execute(rw, viewdata)
check(err,"executing template") }
</code></pre></div></div>

<p>func check(err error, msg string) {
    if err != nil {
        log.Fatal(msg,err)
    }
}</p>

<p>func main() {
    err := cgi.Serve(http.HandlerFunc(CGIHandler))
    check(err,â€cannot serve requestâ€)
}</p>
:ET