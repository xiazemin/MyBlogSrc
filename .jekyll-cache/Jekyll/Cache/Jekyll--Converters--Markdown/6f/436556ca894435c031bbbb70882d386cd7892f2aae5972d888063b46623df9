I"Ö!<p>Go Runtimeé™¤äº†æä¾›:GC, goroutineè°ƒåº¦ï¼Œ å®šæ—¶å™¨ï¼Œnetwork pollingç­‰æœåŠ¡å¤–ï¼Œ è¿˜æä¾›å…¶å®ƒä¸€äº›å·¥å…·è®¾æ–½ï¼Œç”¨äºå¼€å¯é¢å¤–çš„è°ƒè¯•è¾“å‡ºï¼Œ</p>

<p>æˆ–æ˜¯æ”¹å˜Go Runtimeè‡ªèº«çš„ä¸€äº›è¡Œä¸ºã€‚è¿™äº›å·¥å…·è®¾æ–½ç”±ä¼ ç»™Go programçš„ä¸€äº›ç¯å¢ƒå˜é‡æ§åˆ¶ï¼Œ æœ¬æ–‡ä¸»è¦è®²è¿°å®ƒä»¬ã€‚</p>

<p>GOGC</p>

<p>GOGC æ˜¯Go Runtimeæœ€æ—©æ”¯æŒçš„ç¯å¢ƒå˜é‡ï¼Œç”šè‡³æ¯”GOROOTè¿˜æ—©ï¼Œå‡ ä¹æ— äººä¸çŸ¥ã€‚GOGC ç”¨äºæ§åˆ¶GCçš„å¤„å‘é¢‘ç‡ï¼Œ å…¶å€¼é»˜è®¤ä¸º100,</p>

<p>æ„ä¸ºç›´åˆ°è‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶åheap sizeå·²ç»å¢é•¿äº†100%æ—¶GCæ‰è§¦å‘è¿è¡Œã€‚å³æ˜¯GOGC=100æ„å‘³ç€live heap size æ¯å¢é•¿ä¸€å€ï¼ŒGCè§¦å‘è¿è¡Œä¸€æ¬¡ã€‚</p>

<p>å¦‚è®¾å®šGOGC=200, åˆ™live heap size è‡ªä¸Šæ¬¡åƒåœ¾å›æ”¶åï¼Œå¢é•¿2å€æ—¶ï¼ŒGCè§¦å‘è¿è¡Œï¼Œ æ€»ä¹‹ï¼Œå…¶å€¼è¶Šå¤§åˆ™GCè§¦å‘è¿è¡Œé¢‘ç‡è¶Šä½ï¼Œ åä¹‹åˆ™è¶Šé«˜ï¼Œ</p>

<p>å¦‚æœGOGC=off åˆ™å…³é—­GC.</p>

<p>è™½ç„¶go 1.5å¼•å…¥äº†ä½å»¶è¿Ÿçš„GC, ä½†æ˜¯GOGCå¯¹GCè¿è¡Œé¢‘ç‡çš„å½±å“ä¸å˜ï¼Œ ä»ç„¶æ˜¯å…¶å€¼å¤§äº100,åˆ™è¶Šå¤§GCè¿è¡Œé¢‘ç‡è¶Šé«˜ï¼Œ
åä¹‹åˆ™è¶Šä½ã€‚
<!-- more -->
GOTRACEBACK</p>

<p>GOTRACEBACKç”¨äºæ§åˆ¶å½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿæä¾›ä¿¡æ¯çš„è¯¦ç»†ç¨‹åº¦ï¼Œ åœ¨go 1.5ï¼Œ GOTRACEBACKæœ‰4ä¸ªå€¼ã€‚</p>

<p>GOTRACEBACK=0 åªè¾“å‡ºpanicå¼‚å¸¸ä¿¡æ¯ã€‚
GOTRACEBACK=1 æ­¤ä¸ºgoçš„é»˜è®¤è®¾ç½®å€¼ï¼Œ è¾“å‡ºæ‰€æœ‰goroutineçš„stack traces, é™¤å»ä¸go runtimeç›¸å…³çš„stack frames.
GOTRACEBACK=2 åœ¨GOTRACEBACK=1çš„åŸºç¡€ä¸Šï¼Œ è¿˜è¾“å‡ºä¸go runtimeç›¸å…³çš„stack frames,ä»è€Œäº†è§£å“ªäº›goroutinesæ˜¯ç”±go runtimeå¯åŠ¨è¿è¡Œçš„ã€‚
GOTRACEBACK=crash, åœ¨GOTRACEBACK=2çš„åŸºç¡€ä¸Šï¼Œgo runtimeå¤„å‘è¿›ç¨‹segfaulté”™è¯¯ï¼Œä»è€Œç”Ÿæˆcore dump, å½“ç„¶è¦æ“ä½œç³»ç»Ÿå…è®¸çš„æƒ…å†µä¸‹ï¼Œ è€Œä¸æ˜¯è°ƒç”¨os.Exitã€‚</p>

<p>ä»¥ä¸‹ä¸ºGOTRACEBACKçš„ä»£ç æµ‹è¯•ä¾‹å­</p>

<p>package main</p>

<p>func main() {</p>

<p>panic(â€œkerboomâ€)</p>

<p>}</p>

<p>è¿è¡Œç»“æœï¼š</p>

<p>$ env GOTRACEBACK=0 ./crash 
panic: kerboom
$ echo $?
2</p>

<p>è¯»è€…æœ‰å…´è¶£å¯ä»¥å°è¯•å…¶å®ƒå€¼ï¼Œ çœ‹çœ‹æ•ˆæœã€‚</p>

<p>GOTRACEBACK åœ¨go 1.6ä¸­çš„å˜åŒ–</p>

<p>GOTRACEBACK=none åªè¾“å‡ºpanicå¼‚å¸¸ä¿¡æ¯ã€‚
GOTRACEBACK=single åªè¾“å‡ºè¢«è®¤ä¸ºå¼•å‘panicå¼‚å¸¸çš„é‚£ä¸ªgoroutineçš„ç›¸å…³ä¿¡æ¯ã€‚
GOTRACEBACK=all è¾“å‡ºæ‰€æœ‰goroutinesçš„ç›¸å…³ä¿¡æ¯ï¼Œé™¤å»ä¸go runtimeç›¸å…³çš„stack frames.
GOTRACEBACK=system è¾“å‡ºæ‰€æœ‰goroutinesçš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸go runtimeç›¸å…³çš„stack frames,ä»è€Œå¾—çŸ¥å“ªäº›goroutineæ˜¯go runtimeå¯åŠ¨è¿è¡Œçš„ã€‚
GOTRACEBACK=crash ä¸go 1.5ç›¸åŒï¼Œ æœªå˜åŒ–ã€‚</p>

<p>ä¸ºäº†ä¸go 1.5å…¼å®¹ï¼Œ0 å¯¹åº” none, 1 å¯¹åº” all, ä»¥åŠ 2 å¯¹åº” system.</p>

<p>æ³¨æ„ï¼š åœ¨go 1.6ä¸­ï¼Œ é»˜è®¤ï¼Œåªè¾“å‡ºå¼•å‘panciå¼‚å¸¸çš„goroutineçš„stack trace.</p>

<p>GOMAXPROCS</p>

<p>GOMAXPROCS å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰ï¼Œ ç”¨äºæ§åˆ¶æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ•°é‡ï¼Œ è¿™äº›çº¿ç¨‹ç”¨äºè¿è¡Œgoç¨‹åºä¸­çš„goroutines.
åˆ°go 1.5çš„æ—¶å€™ï¼Œ GOMAXPROCSçš„é»˜è®¤å€¼å°±æ˜¯æˆ‘ä»¬çš„goç¨‹åºå¯åŠ¨æ—¶å¯è§çš„æ“ä½œç³»ç»Ÿè®¤ä¸ºçš„CPUä¸ªæ•°ã€‚</p>

<p>æ³¨æ„ï¼š åœ¨æˆ‘ä»¬çš„goç¨‹åºä¸­ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°é‡ï¼Œä¹ŸåŒ…æ‹¬ï¼šæ­£æœåŠ¡äºcgo callsçš„çº¿ç¨‹, é˜»å¡äºæ“ä½œç³»ç»Ÿcallsçš„çº¿ç¨‹ï¼Œ
æ‰€ä»¥go ç¨‹åºä¸­ä½¿ç”¨çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹æ•°é‡å¯èƒ½å¤§äºGOMAXPROCSçš„å€¼ã€‚</p>

<p>GODEBUG</p>

<p>è€é¼ æ‹‰é“é”¹ï¼Œå¤§å¤´åœ¨åè¾¹ï¼Œ æœ¬æ–‡å…¶ä½™ç¯‡å¹…ä¸»è¦è®²è®²GODEBUG. GODEBUGçš„å€¼è¢«è§£é‡Šä¸ºä¸€ä¸ªä¸ªçš„
name=valueå¯¹ï¼Œ æ¯ä¸€å¯¹é—´ç”±é€—å·åˆ†å‰²ï¼Œæ¯ä¸€å¯¹ç”¨äºæ§åˆ¶go runtime è°ƒè¯•å·¥å…·è®¾æ–½ï¼Œ ä¾‹å¦‚ï¼š</p>

<p>$ env GODEBUG=gctrace=1,schedtrace=1000 godoc -http=:8080</p>

<p>ä¸Šé¢è¿™æ¡å‘½ä»¤ç”¨äºè¿è¡Œgodocç¨‹åºæ—¶å¼€å¯ GC tracing and schedule tracing.</p>

<p>ä¸‹é¢å¼€å§‹ä»‹ç»å‡ ä¸ªæ¯”è¾ƒæœ‰ç”¨çš„è°ƒè¯•å·¥å…·è®¾æ–½</p>

<p>gctrace</p>

<p>è¿™ä¸ªå·¥å…·æˆ‘è®¤ä¸ºæœ€æœ‰ç”¨å¤„äº†ï¼Œè¯·çœ‹ç¨‹åºè¾“å‡ºä¾¿çŸ¥</p>

<p>$ env GODEBUG=gctrace=1 godoc -http=:8080 -index
gc #1 @0.042s 4%: 0.051+1.1+0.026+16+0.43 ms clock, 0.10+1.1+0+2.0/6.7/0+0.86 ms cpu, 4-&gt;32-&gt;10 MB, 4 MB goal, 4 P
gc #2 @0.062s 5%: 0.044+1.0+0.017+2.3+0.23 ms clock, 0.044+1.0+0+0.46/2.0/0+0.23 ms cpu, 4-&gt;12-&gt;3 MB, 8 MB goal, 4 P
gc #3 @0.067s 6%: 0.041+1.1+0.078+4.0+0.31 ms clock, 0.082+1.1+0+0/2.8/0+0.62 ms cpu, 4-&gt;6-&gt;4 MB, 8 MB goal, 4 P
gc #4 @0.073s 7%: 0.044+1.3+0.018+3.1+0.27 ms clock, 0.089+1.3+0+0/2.9/0+0.54 ms cpu, 4-&gt;7-&gt;4 MB, 6 MB goal, 4 P</p>

<p>æ­¤ä¿¡æ¯çš„è¾“å‡ºæ ¼å¼éšç€goçš„æ¯ä¸€ä¸åŒçš„ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œä½†æ€»æ˜¯èƒ½å‘ç°å…±æ€§çš„ä¸œè¥¿ï¼Œ å¦‚ï¼š æ¯ä¸€GC é˜¶æ®µæ‰€èŠ±è´¹çš„æ—¶é—´é‡ï¼Œ heap size çš„å˜åŒ–é‡ï¼Œ 
ä¹ŸåŒ…æ‹¬æ¯ä¸€GCé˜¶æ®µå®Œæˆæ—¶é—´ï¼Œç›¸å¯¹äºç¨‹åºå¯åŠ¨æ—¶çš„æ—¶é—´ï¼Œå½“ç„¶è€ç‰ˆæœ¬goå¯èƒ½çœç•¥ä¸€äº›ä¿¡æ¯ã€‚</p>

<p>æ¯ä¸€è¡Œä¿¡æ¯éƒ½å¾ˆæœ‰ç”¨ï¼Œ ä¸è¿‡æˆ‘è®¤ä¸ºç»¼åˆåˆ†æè¿™äº›ä¿¡æ¯åˆ™æ›´æœ‰ç”¨ï¼Œæ¯”å¦‚ï¼Œ ä¸æ–­è¾“å‡ºçš„gc tracing,å¯ä»¥æ¸…æ¥šåœ¨è¡¨æ˜ç¨‹åºçš„å†…å­˜åˆ†é…æƒ…å†µï¼Œ</p>

<p>æŒç»­ä¸æ–­å¢é•¿çš„heap size åˆ™è¡¨æ˜å¯èƒ½æœ‰å†…å­˜æ³„éœ²ï¼Œä¹Ÿè®¸ä¸€äº›è¢«å¼•ç”¨çš„ä¸œè¥¿æ²¡æœ‰è¢«é‡Šæ”¾ã€‚</p>

<p>å¼€å¯gctraceçš„ä»£ä»·æ˜¯å¾ˆå°çš„ï¼Œä¸è¿‡å…¶é€šå¸¸æ˜¯å…³é—­çš„ï¼Œ ä¸è¿‡æˆ‘æ¨èåœ¨ä¸€äº›äº§å“ç¯å¢ƒä¸­ï¼ŒæŠ½å–ä¸€äº›
æ ·æœ¬äº§å“ï¼Œå¼€å¯è¿™ä¸ªè°ƒè¯•å·¥å…·ã€‚</p>

<p>åŸæ–‡æœªç¿»è¯‘ï¼Œæœªæ‰¾åˆ°å‡†ç¡®è¡¨è¿°ã€‚
note:setting gctrace to values larger than 1 causes each garbage collection cycle to be run twice.
 This exercises some aspects of finalisation that require two garbage collection cycles to complete. 
 You should not use this as a mechanism to alter finalisation performance in your programs because you should not write programs whoâ€™s correctness depends on finalisation.</p>

<p>The heap scavenger</p>

<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œgctraceç»™å‡ºçš„æœ€æœ‰ç”¨çš„ä¿¡æ¯å°±æ˜¯ the heap scavengerçš„è¾“å‡º.</p>

<p>scvg143: inuse: 8, idle: 104, sys: 113, released: 104, consumed: 8 (MB)</p>

<p>scavenger çš„å·¥ä½œå°±æ˜¯å‘¨æœŸæ€§åœ°æ‰“æ‰«heapä¸­æ— ç”¨çš„æ“ä½œç³»ç»Ÿå†…å­˜åˆ†é¡µï¼Œ å®ƒä¼šå‘æ“ä½œç³»ç»Ÿå‘å‡ºå»ºä¹‰ï¼Œè¯·æ“ä½œç³»ç»Ÿå›æ”¶æ— ç”¨å†…å­˜é¡µï¼Œ</p>

<p>å½“ç„¶å¹¶ä¸èƒ½å¼ºè¿«æ“ä½œç³»ç»Ÿç«‹åˆ»å°±å»åšå›æ”¶å¤„ç†ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å¿½ç•¥æ­¤å»ºä¹‰ï¼Œæˆ–æ˜¯å»¶è¿Ÿå›æ”¶ï¼Œæ¯”å¦‚ç›´åˆ°å¯åˆ†é…çš„ç©ºé—²å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ã€‚</p>

<p>scavengerè¾“å‡ºçš„ä¿¡æ¯æ˜¯æˆ‘ä»¬äº†è§£goç¨‹åºè™šæ‹Ÿå†…å­˜ç©ºé—´ä½¿ç”¨æƒ…å†µçš„æœ€å¥½æ–¹å¼ï¼Œ å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡å…¶å®ƒå·¥å…·ï¼Œå¦‚free, topæ¥è·åˆ°è¿™äº›ä¿¡æ¯ï¼Œ
ä¸è¿‡ä½ åº”ç”¨ä¿¡ä»»scavenger.</p>

<p>schedtrace</p>

<p>å› ä¸ºgo runtimeç®¡ç†ç€å¤§é‡çš„goroutine, å¹¶è°ƒåº¦goroutineåœ¨æ“ä½œç³»ç»Ÿçº¿ç¨‹é›†ä¸Šè¿è¡Œï¼Œ
è¿™ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹é›†ï¼Œå…¶å®æ˜¯å°±æ˜¯çº¿ç¨‹æ± ï¼Œ æ‰€ä»¥ä»å¤–éƒ¨è€ƒå¯Ÿgoç¨‹åºçš„æ€§èƒ½æˆ‘ä»¬ä¸èƒ½è·å–è¶³å¤Ÿçš„ç»†èŠ‚ä¿¡æ¯ï¼Œ
æ›´è°ˆä¸ä¸Šå‡†ç¡®åˆ†æç¨‹åºæ€§èƒ½ã€‚æ•…æ­¤æˆ‘ä»¬éœ€è¦ç›´æ¥äº†è§£go runtime schedulerçš„æ¯ä¸€ä¸ªæ“ä½œï¼Œå…¶è¾“å‡ºå¦‚ä¸‹ï¼š</p>

<p>$ env GODEBUG=schedtrace=1000 godoc -http=:8080 -index
SCHED 0ms: gomaxprocs=4 idleprocs=2 threads=4 spinningthreads=1 idlethreads=0 runqueue=0 [0 0 0 0]
SCHED 1001ms: gomaxprocs=4 idleprocs=0 threads=8 spinningthreads=0 idlethreads=2 runqueue=0 [189 197 231 142]
SCHED 2004ms: gomaxprocs=4 idleprocs=0 threads=9 spinningthreads=0 idlethreads=1 runqueue=0 [54 45 38 86]
SCHED 3011ms: gomaxprocs=4 idleprocs=0 threads=9 spinningthreads=0 idlethreads=2 runqueue=2 [85 0 67 111]
SCHED 4018ms: gomaxprocs=4 idleprocs=3 threads=9 spinningthreads=0 idlethreads=4 runqueue=0 [0 0 0 0]</p>

<p>è¯¦ç»†è®¨è®ºè¯·çœ‹ Dmitry Vyukovâ€™s excellent blog post from the Intel DeveloperZone.</p>

<p>è®¾å®šscheddetail=1å°†ä½¿go runtimeè¾“å‡ºæ€»ç»“æ€§ä¿¡æ¯æ—¶ï¼Œ ä¸€å¹¶è¾“å‡ºæ¯ä¸€ä¸ªgoroutineçš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚ï¼š</p>

<p>$ env GODEBUG=scheddetail=1,schedtrace=1000 godoc -http=:8080 -index
SCHED 0ms: gomaxprocs=4 idleprocs=3 threads=3 spinningthreads=0 idlethreads=0 runqueue=0 gcwaiting=0 nmidlelocked=0 stopwait=0 sysmonwait=0
  P0: status=1 schedtick=0 syscalltick=0 m=0 runqsize=0 gfreecnt=0
  P1: status=0 schedtick=0 syscalltick=0 m=-1 runqsize=0 gfreecnt=0
  P2: status=0 schedtick=0 syscalltick=0 m=-1 runqsize=0 gfreecnt=0
  P3: status=0 schedtick=0 syscalltick=0 m=-1 runqsize=0 gfreecnt=0
  M2: p=-1 curg=-1 mallocing=0 throwing=0 preemptoff= locks=1 dying=0 helpgc=0 spinning=false blocked=false lockedg=-1
  M1: p=-1 curg=17 mallocing=0 throwing=0 preemptoff= locks=0 dying=0 helpgc=0 spinning=false blocked=false lockedg=17
  M0: p=0 curg=1 mallocing=0 throwing=0 preemptoff= locks=2 dying=0 helpgc=0 spinning=false blocked=false lockedg=1
  G1: status=2(stack growth) m=0 lockedm=0
  G17: status=3() m=1 lockedm=1
  G2: status=1() m=-1 lockedm=-1</p>

<p>è¿™ä¸ªè¾“å‡ºå¯¹äºè°ƒè¯•goroutines leakingå¾ˆæœ‰å¸®åŠ©ï¼Œ ä¸è¿‡å…¶å®ƒå·¥å…·ï¼Œ è¯¸å¦‚ï¼šnet/http/pprof 
 å¥½åƒæ›´æœ‰ç”¨ä¸€äº›ã€‚</p>

<p>æ·±å…¥é˜…è¯»è¯·çœ‹godoc for the runtime package.</p>

<p>https://studygolang.com/articles/6346</p>
:ET