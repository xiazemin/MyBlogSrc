I"<p>MySQL Proxyå¤„äºå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºå’ŒMySQLæœåŠ¡å™¨ä¹‹é—´ï¼Œé€šè¿‡æˆªæ–­ã€æ”¹å˜å¹¶è½¬å‘å®¢æˆ·ç«¯å’Œåç«¯æ•°æ®åº“ä¹‹é—´çš„é€šä¿¡æ¥å®ç°å…¶åŠŸèƒ½ï¼Œè¿™å’ŒWinGateä¹‹ç±»çš„ç½‘ç»œä»£ç†æœåŠ¡å™¨çš„åŸºæœ¬æ€æƒ³æ˜¯ä¸€æ ·çš„ã€‚ä»£ç†æœåŠ¡å™¨æ˜¯å’ŒTCP/IPåè®®æ‰“äº¤é“ï¼Œè€Œè¦ç†è§£MySQL Proxyçš„å·¥ä½œæœºåˆ¶ï¼ŒåŒæ ·è¦æ¸…æ¥šMySQLå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡åè®®ï¼ŒMySQLÂ ProtocolåŒ…æ‹¬è®¤è¯å’ŒæŸ¥è¯¢ä¸¤ä¸ªåŸºæœ¬è¿‡ç¨‹ï¼š
ã€€ã€€è®¤è¯è¿‡ç¨‹åŒ…æ‹¬ï¼š
ã€€ã€€å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·è¿æ¥è¯·æ±‚
ã€€ã€€æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€æ¡æ‰‹ä¿¡æ¯
ã€€ã€€å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è®¤è¯è¯·æ±‚
ã€€ã€€æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘é€è®¤è¯ç»“æœ
ã€€ã€€å¦‚æœè®¤è¯é€šè¿‡ï¼Œåˆ™è¿›å…¥æŸ¥è¯¢è¿‡ç¨‹ï¼š
ã€€ã€€å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘èµ·æŸ¥è¯¢è¯·æ±‚
ã€€ã€€æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿”å›æŸ¥è¯¢ç»“æœ
ã€€ã€€å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç²—ç•¥çš„æè¿°ï¼Œæ¯ä¸ªè¿‡ç¨‹ä¸­å‘é€çš„åŒ…éƒ½æ˜¯æœ‰å›ºå®šæ ¼å¼çš„ï¼Œæƒ³è¯¦ç»†äº†è§£MySQL Protocolçš„åŒå­¦ï¼Œå¯ä»¥å»è¿™é‡Œçœ‹çœ‹ã€‚MySQL Proxyè¦åšçš„ï¼Œå°±æ˜¯ä»‹å…¥åè®®çš„å„ä¸ªè¿‡ç¨‹ã€‚é¦–å…ˆMySQL Proxyä»¥æœåŠ¡å™¨çš„èº«ä»½æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ ¹æ®é…ç½®å¯¹è¿™äº›è¯·æ±‚è¿›è¡Œåˆ†æå¤„ç†ï¼Œç„¶åä»¥å®¢æˆ·ç«¯çš„èº«ä»½è½¬å‘ç»™ç›¸åº”çš„åç«¯æ•°æ®åº“æœåŠ¡å™¨ï¼Œå†æ¥å—æœåŠ¡å™¨çš„ä¿¡æ¯ï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ã€‚æ‰€ä»¥MySQL Proxyéœ€è¦åŒæ—¶å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„åè®®ã€‚
ã€€ã€€ç”±äºè¦å¯¹å®¢æˆ·ç«¯å‘é€è¿‡æ¥çš„SQLè¯­å¥è¿›è¡Œåˆ†æï¼Œè¿˜éœ€è¦åŒ…å«ä¸€ä¸ªSQLè§£æå™¨ã€‚å¯ä»¥è¯´MySQL Proxyç›¸å½“äºä¸€ä¸ªè½»é‡çº§çš„MySQLäº†ï¼Œå®é™…ä¸Šï¼ŒMySQL Proxyçš„admin serveræ˜¯å¯ä»¥æ¥å—SQLæ¥æŸ¥è¯¢çŠ¶æ€ä¿¡æ¯çš„ã€‚
ã€€ã€€MySQL Proxyé€šè¿‡luaè„šæœ¬æ¥æ§åˆ¶è¿æ¥è½¬å‘çš„æœºåˆ¶ã€‚ä¸»è¦çš„å‡½æ•°éƒ½æ˜¯é…åˆMySQL Protocolå„ä¸ªè¿‡ç¨‹çš„ï¼Œè¿™ä¸€ç‚¹ä»å‡½æ•°åä¸Šå°±èƒ½çœ‹å‡ºæ¥ï¼š
ã€€ã€€connect_server()Â  Â 
ã€€ã€€read_handshake()Â  Â 
ã€€ã€€read_auth()Â  Â 
ã€€ã€€read_auth_result()Â  Â 
ã€€ã€€read_query()Â  Â 
ã€€ã€€read_query_result()Â Â 
ã€€ã€€è‡³äºä¸ºä»€ä¹ˆé‡‡ç”¨luaè„šæœ¬è¯­è¨€ï¼Œæˆ‘æƒ³è¿™æ˜¯å› ä¸ºMySQL Proxyä¸­é‡‡ç”¨äº†wormholeå­˜å‚¨å¼•æ“çš„å…³ç³»å§ï¼Œè¿™ä¸ªè™«æ´å­˜å‚¨å¼•æ“å¾ˆæœ‰æ„æ€ï¼Œæ•°æ®çš„å­˜å‚¨æ ¼å¼å°±æ˜¯ä¸€æ®µluaè„šæœ¬
<!-- more -->
é€šè¿‡è¿™å‡ ä¸ªå…¥å£å‡½æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶mysql-proxyçš„ä¸€äº›è¡Œä¸ºã€‚</p>

<p>connect_server()          å½“ä»£ç†æœåŠ¡å™¨æ¥å—åˆ°å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚æ—¶(tcpä¸­çš„æ¡æ‰‹)ä¼šè°ƒç”¨è¯¥å‡½æ•°
read_handshake()        å½“mysqlæœåŠ¡å™¨è¿”å›æ¡æ‰‹ç›¸åº”æ—¶ä¼šè¢«è°ƒç”¨
read_auth()ã€€ã€€           å½“å®¢æˆ·ç«¯å‘é€è®¤è¯ä¿¡æ¯(username,password,port,database)æ—¶ä¼šè¢«è°ƒç”¨
read_auth_result(aut)  å½“mysqlè¿”å›è®¤è¯ç»“æœæ—¶ä¼šè¢«è°ƒç”¨
read_query(packet)      å½“å®¢æˆ·ç«¯æäº¤ä¸€ä¸ªsqlè¯­å¥æ—¶ä¼šè¢«è°ƒç”¨
read_query_result(inj)ã€€å½“mysqlè¿”å›æŸ¥è¯¢ç»“æœæ—¶ä¼šè¢«è°ƒç”¨</p>

<p>é…ç½®æ–‡ä»¶</p>

<p>mysql-proxy.cnf(æƒé™è®¾ä¸º660)</p>

<p>[mysql-proxy]</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin-username=root

admin-password=123456

admin-lua-script=/usr/local/lib/admin.lua

proxy-read-only-backend-addresses=192.168.2.115

proxy-backend-addresses=192.168.2.117

proxy-lua-script=/usr/local/lib/rw-splitting.lua

log-file=/var/log/mysql-proxy.log

log-level=debug

daemon=true
</code></pre></div></div>

<p>keepalive=true</p>

<p>proxy-lua-scriptï¼ŒæŒ‡å®šä¸€ä¸ªLuaè„šæœ¬æ¥æ§åˆ¶mysql-proxyçš„è¿è¡Œå’Œè®¾ç½®ï¼Œè¿™ä¸ªè„šæœ¬åœ¨æ¯æ¬¡æ–°å»ºè¿æ¥å’Œè„šæœ¬å‘ç”Ÿä¿®æ”¹çš„çš„æ—¶å€™å°†é‡æ–°è°ƒç”¨</p>

<p>keepaliveï¼Œé¢å¤–å»ºç«‹ä¸€ä¸ªè¿›ç¨‹ä¸“é—¨ç›‘æ§mysql_proxyè¿›ç¨‹ï¼Œå½“mysql_proxy crashäºˆä»¥é‡æ–°å¯åŠ¨ï¼›</p>

<p>å¯åŠ¨</p>

<p>/usr/local/mysql-proxy/bin/mysql-proxy -P 192.168.2.112:3306 â€“defaults-file=/etc/mysql-proxy.cnf</p>

<p>è¯»å†™åˆ†ç¦»</p>

<p>å½“proxy-lua-scriptæŒ‡å®šä¸ºrw-splitting.luaæ—¶ï¼Œmysql_proxyä¼šå¯¹å®¢æˆ·ç«¯ä¼ å…¥çš„sqlæ‰§è¡Œè¯»å†™åˆ†ç¦»ï¼›</p>

<p>åŒä¸€ä¸ªäº‹åŠ¡ï¼ŒDMLä¼ è¾“ç»™backendï¼Œselectåˆ™è¢«ä¼ åˆ°read-only-backendï¼›</p>

<p>Luaè„šæœ¬é»˜è®¤æœ€å°4ä¸ªæœ€å¤§8ä¸ªä»¥ä¸Šçš„å®¢æˆ·ç«¯è¿æ¥æ‰ä¼šå®ç°è¯»å†™åˆ†ç¦»ï¼ˆè¿™æ˜¯å› ä¸ºmysql-proxyä¼šæ£€æµ‹å®¢æˆ·ç«¯è¿æ¥, å½“è¿æ¥æ²¡æœ‰è¶…è¿‡min_idle_connectionsé¢„è®¾å€¼æ—¶ï¼Œä¸ä¼šè¿›è¡Œè¯»å†™åˆ†ç¦»ï¼Œå³æŸ¥è¯¢æ“ä½œä¼šå‘ç”Ÿåˆ°Masterä¸Šï¼‰ï¼Œç°æ”¹ä¸ºæœ€å°1ä¸ªæœ€å¤§2ä¸ªï¼Œæˆ‘ä»¬ç”¨vimä¿®æ”¹/usr/local/lib/rw-splitting.luaè„šæœ¬ï¼Œæ”¹åŠ¨å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if not proxy.global.config.rwsplit then

        proxy.global.config.rwsplit = {

                min_idle_connections = 1,

                max_idle_connections = 2,

   

                is_debug = false

        }

end
</code></pre></div></div>

<p>read_query()å‡½æ•°å†…æœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­</p>

<p>if stmt.token_name == â€œTK_SQL_SELECTâ€ then</p>

<p>è¿™ä¸ªè¯­å¥çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­sqlè¯­å¥æ˜¯ä¸æ˜¯ä»¥SELECTå¼€å§‹çš„ï¼Œå¦‚æœæ˜¯æŸ¥è¯¢çš„è¯ï¼Œæ¥ä¸‹æ¥ä¼šæœ‰è¿™ä¹ˆä¸ªè¯­å¥</p>

<p>local backend_ndx = lb.idle_ro()</p>

<p>lb.idle_ro() æ˜¯é€šè¿‡ local lb = require(â€œproxy.balanceâ€) å¼•å…¥çš„balance.luaæ–‡ä»¶</p>

<p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯é€‰æ‹©ä½¿ç”¨å“ªä¸ªè¯»æœåŠ¡å™¨ï¼Œå¹¶è¿”å›æœåŠ¡å™¨çš„index:max_conns_ndx</p>

<p>å¦‚ä½•é€‰æ‹©æœåŠ¡å™¨å‘¢ï¼Ÿ å®ƒé€šè¿‡å¾ªç¯éå†æ‰€æœ‰æœåŠ¡å™¨ï¼Œç„¶åé€‰å‡ºä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼ˆs.connected_clientsï¼‰æœ€å°‘çš„æœåŠ¡å™¨ï¼Œè¿™æ ·åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°è´Ÿè½½å‡è¡¡</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function idle_ro()  

    local max_conns = -1 

    local max_conns_ndx = 0 

 

    for i = 1, #proxy.global.backends do 

        local s = proxy.global.backends[i] 

        local conns = s.pool.users[proxy.connection.client.username] 

        -- pick a slave which has some idling connections 

        if s.type == proxy.BACKEND_TYPE_RO and s.state ~= proxy.BACKEND_STATE_DOWN and conns.cur_idle_connections &gt; 0 then 

            if max_conns == -1 or s.connected_clients &lt; max_conns then 

                max_conns = s.connected_clients 

                max_conns_ndx = i 

            end 

        end

    end 

 

    return max_conns_ndx 

end
</code></pre></div></div>

<p>http://blog.csdn.net/clh604/article/details/8906022</p>

<p>failover</p>

<p>åˆ©ç”¨mysql_proxyå®ç°failover</p>

<p>ç¼ºç‚¹ï¼šmysql_proxyå•ç‚¹æ•…éšœï¼›</p>

<p>åŸç†ï¼šé»˜è®¤è¿æ¥Aï¼Œå¦‚æœAå®•æ‰åˆ™è¿æ¥Bï¼ŒAå¯åŠ¨åå†è¿æ¥åˆ°Aï¼›</p>

<p>ç¼–å†™failoverè„šæœ¬</p>

<p>vi $mysql-proxy_path/share/doc/mysql-proxy/mysql_failover.lua</p>

<p>function connect_server()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i = 1, #proxy.backends do

    local s = proxy.backends[i]

    print ("s.state:" + s.state)

    if s.state ~= proxy.BACKEND_STATE_DOWN then

        proxy.connection.backend_ndx = i

        print ("connecting to " .. i)

        return

    end

end
</code></pre></div></div>

<p>end</p>

<p>function read_query(packet)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for i = 1, #proxy.backends do

    local s = proxy.backends[i]

    print ("s.state:" + s.state)

    if s.state ~= proxy.BACKEND_STATE_DOWN then

        proxy.connection.backend_ndx = i

        print ("connecting to " .. i)

        return

    end

end
</code></pre></div></div>

<p>end</p>

<p>å¯åŠ¨mysql-proxy</p>

<p>$mysql-proxy_path/bin/mysql-proxy â€“proxy-address=:4040 â€“proxy-lua-script=$mysql-proxy_path/share/doc/mysql-proxy/mysql_failover.lua â€“proxy-backend-addresses=$A:3306 â€“proxy-backend-addresses=$B:3306 â€“log-level=error  â€“log-file=$mysql-proxy_path/mysql-proxy.log â€“keepalive â€“proxy-fix-bug-25371</p>

<p>æ­¤æ—¶å®¢æˆ·ç«¯ç›´æ¥è¿æ¥mysql-proxyå³å¯ï¼›</p>
:ET