I"·<p>PHPå‡½æ•°stream_set_timeoutï¼ˆStream Functionsï¼‰ä½œç”¨äºè¯»å–æµæ—¶çš„æ—¶é—´æ§åˆ¶ã€‚fsockopenå‡½æ•°çš„timeoutåªç®¡åˆ›å»ºè¿æ¥æ—¶çš„è¶…æ—¶ï¼Œå¯¹äºè¿æ¥åè¯»å–æµæ—¶çš„è¶…æ—¶ï¼Œåˆ™éœ€è¦ç”¨åˆ° stream_set_timeoutå‡½æ•°ã€‚ç”±äºå›½å†…çš„ç½‘ç»œç¯å¢ƒä¸æ˜¯å¾ˆç¨³å®šï¼Œå°¤å…¶æ˜¯è¿æ¥å›½å¤–çš„æ—¶å€™ï¼Œä¸æƒ³ç¨‹åºå‡ºç°Fatal error: Maximum execution time of 30 seconds exceeded in â€¦çš„é”™è¯¯ï¼Œè¯¥å‡½æ•°å°¤å…¶æœ‰ç”¨ã€‚stream_set_timeoutéœ€é…åˆstream_get_meta_dataä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰timeoutï¼Œ stream_get_meta_dataè¿”å›æ•°ç»„ä¸­time_outä¸ºç©ºï¼Œåä¹‹ä¸º1ï¼Œå¯æ ¹æ®æ­¤åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚å¦å¤–ç”±äºPHPé»˜è®¤çš„Maximum execution timeä¸º30ç§’ï¼Œè¿™æ˜¯ä¸€æ¬¡æ‰§è¡Œå‘¨æœŸçš„æ—¶é—´ï¼Œä¸ºäº†ä¸å‡ºç°ä¸Šè¿°çš„Fatal errorï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ€»çš„è¯»å–æµçš„æ—¶é—´
<!-- more -->
$server=â€www.yahoo.comâ€;<br />
$port = 80;</p>

<p>$data=â€GET / HTTP/1.0rnâ€;<br />
$data.=â€Connection: Closernâ€;<br />
$data.=â€User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)rnrnâ€;</p>

<p>$start_time = time();<br />
$fp=fsockopen($server, $port, $errno, $errstr, 5);<br />
if (!$fp) {<br />
die(â€œConnect Timeout.nâ€);<br />
} else {<br />
stream_set_blocking($fp, True);<br />
stream_set_timeout($fp, 3);</p>

<p>fputs($fp, â€œ$dataâ€);<br />
while (!feof($fp)) {<br />
$text .= fread($fp, 2000);</p>

<p>$diff = time() - $start_time;<br />
if ($diff &gt; 24) {<br />
die(â€œTimeout!nâ€);<br />
}</p>

<p>$status = stream_get_meta_data($fp);<br />
if ($status[â€™timed_outâ€™]) {<br />
die(â€œStream Timeout!nâ€);<br />
}<br />
}<br />
}</p>

<p>fclose($fp);</p>

<p>æ¥å£è¶…æ—¶502 bad gate way
è¶…æ—¶é™åˆ¶å¤±æ•ˆ
é¡µé¢è°ƒç”¨æ¥å£çš„æ—¶å€™ï¼Œå“åº”10sã€‚é€šè¿‡ä½¿ç”¨xhprofç›‘æ§ï¼Œå‘ç°æ˜¯è°ƒç”¨æ¥å£è¶…æ—¶ã€‚ä½†æ˜¯å®é™…ä¸Šæ¥å£è¶…æ—¶çš„æ—¶å€™æœ€å¤šåªå…è®¸2sï¼Œé€šè¿‡stream_set_timeoutè¿›è¡Œäº†è¯»æµè¶…æ—¶é™åˆ¶ã€‚</p>

<p>æŸ¥è¯¢æ‰‹å†Œ
æ‰‹å†Œä¸­æœ‰ä¸€äº›ä¾‹å­ï¼Œå…¶ä¸­æœ‰ä¸€æ®µæ˜¯è¿™æ ·è¯´çš„ï¼š</p>

<p>If you are using fsockopen() to create a connection, first going to write into the stream and then waiting for the reply (e.g. simulating HTTP request with some extra headers), then stream_set_timeout() must be set only after the write - if it is before write, it has no effect on the read timeout :-(
ä½†æ˜¯å®é™…ä¸Šï¼ŒæŒ‰ç…§è¿™ç§å†™æ³•è¿›è¡Œäº†é€»è¾‘ä¿®æ”¹ï¼Œä¾ç„¶æ˜¯æ— æ•ˆçš„ã€‚</p>

<p>https://www.jb51.net/shouce/php5/zh/function.stream-set-timeout.html</p>

<p>PHPå‡½æ•°stream_set_timeoutï¼ˆStream Functionsï¼‰ä½œç”¨äºè¯»å–æµæ—¶çš„æ—¶é—´æ§åˆ¶ã€‚fsockopenå‡½æ•°çš„timeoutåªç®¡åˆ›å»ºè¿æ¥æ—¶çš„è¶…æ—¶ï¼Œå¯¹äºè¿æ¥åè¯»å–æµæ—¶çš„è¶…æ—¶ï¼Œåˆ™éœ€è¦ç”¨åˆ°stream_set_timeoutå‡½æ•°ã€‚ç”±äºå›½å†…çš„ç½‘ç»œç¯å¢ƒä¸æ˜¯å¾ˆç¨³å®šï¼Œå°¤å…¶æ˜¯è¿æ¥å›½å¤–çš„æ—¶å€™ï¼Œä¸æƒ³ç¨‹åºå‡ºç°Fatal error: Maximum execution time of 30 seconds exceeded in â€¦çš„é”™è¯¯ï¼Œè¯¥å‡½æ•°å°¤å…¶æœ‰ç”¨ã€‚stream_set_timeoutéœ€é…åˆstream_get_meta_dataä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰timeoutï¼Œ stream_get_meta_dataè¿”å›æ•°ç»„ä¸­time_outä¸ºç©ºï¼Œåä¹‹ä¸º1ï¼Œå¯æ ¹æ®æ­¤åˆ¤æ–­æ˜¯å¦è¶…æ—¶ã€‚å¦å¤–ç”±äºPHPé»˜è®¤çš„Maximum execution timeä¸º30ç§’ï¼Œè¿™æ˜¯ä¸€æ¬¡æ‰§è¡Œå‘¨æœŸçš„æ—¶é—´ï¼Œä¸ºäº†ä¸å‡ºç°ä¸Šè¿°çš„Fatal errorï¼Œè¿˜éœ€è¦è®¾ç½®ä¸€ä¸ªæ€»çš„è¯»å–æµçš„æ—¶é—´</p>

<p>stream_set_timeout
(PHP 4 &gt;= 4.3.0, PHP 5)</p>

<p>stream_set_timeout â€” Set timeout period on a stream</p>

<p>è¯´æ˜
bool stream_set_timeout ( resource $stream , int $seconds [, int $microseconds = 0 ] )
Sets the timeout value on stream, expressed in the sum of seconds and microseconds.</p>

<p>When the stream times out, the â€˜timed_outâ€™ key of the array returned by stream_get_meta_data() is set to TRUE, although no error/warning is generated.</p>

<p>å‚æ•°
stream
The target stream.</p>

<p>seconds
The seconds part of the timeout to be set.</p>

<p>microseconds
The microseconds part of the timeout to be set.</p>

<p>è¿”å›å€¼
æˆåŠŸæ—¶è¿”å› TRUEï¼Œ æˆ–è€…åœ¨å¤±è´¥æ—¶è¿”å› FALSE.</p>

<p>æ›´æ–°æ—¥å¿—
ç‰ˆæœ¬	è¯´æ˜
4.3.0	As of PHP 4.3, this function can (potentially) work on any kind of stream. In PHP 4.3, socket based streams are still the only kind supported in the PHP core, although streams from other extensions may support this function.
èŒƒä¾‹</p>

<p>Example #1 stream_set_timeout() example</p>

<p>&lt;?php
$fp = fsockopen(â€œwww.example.comâ€, 80);
if (!$fp) {
    echo â€œUnable to open â€œ;
} else {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fwrite($fp, "GET / HTTP/1.0 ");
stream_set_timeout($fp, 2);
$res = fread($fp, 2000);

$info = stream_get_meta_data($fp);
fclose($fp);

if ($info['timed_out']) {
    echo 'Connection timed out!';
} else {
    echo $res;
}
</code></pre></div></div>

<p>}
?&gt;
æ³¨é‡Š
Note:</p>

<p>This function doesnâ€™t work with advanced operations like stream_socket_recvfrom(), use stream_select() with timeout parameter instead.</p>

<p>This function was previously called as set_socket_timeout() and later socket_set_timeout() but this usage is deprecated.</p>

<p>å‚è§
fsockopen() - Open Internet or Unix domain socket connection
fopen() - æ‰“å¼€æ–‡ä»¶æˆ–è€… URL</p>

<p>stream_set_timeoutå’Œstream_socket_sendtoçŒ›ä¸€çœ‹å¥½åƒæ²¡å•¥é—®é¢˜ï¼Œä»å‡½æ•°åçœ‹ä¸Šå»ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯é€šè¿‡phpæ‰‹å†Œå¯ä»¥çœ‹åˆ°stream_set_timeoutæ˜¯ä¸èƒ½æ§åˆ¶stream_socket_sendtoçš„</p>

<p>å…¶å®æˆ‘ä»¬çŸ¥é“fgetså°±å¯ä»¥è¯»å–æµçš„æ•°æ®ï¼Œå¹¶ä¸”stream_set_timeoutæ˜¯å¯ä»¥æ§åˆ¶freadçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ç®€å•çš„æŠŠ</p>

<p>stream_socket_sendtoæ›¿æ¢æˆfwriteå°±å¯ä»¥äº†ï¼Œstream_socket_recvfromæ›¿æ¢ä¸ºfreadå³å¯</p>
:ET