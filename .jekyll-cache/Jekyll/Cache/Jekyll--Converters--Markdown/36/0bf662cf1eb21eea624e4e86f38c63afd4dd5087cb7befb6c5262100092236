I"ø$<p>goroutineçš„çŠ¶æ€è¿ç§»å›¾ï¼Œåœ†å½¢æ¡†è¡¨ç¤ºçŠ¶æ€ï¼Œç®­å¤´åŠæ–‡å­—ä¿¡æ¯è¡¨ç¤ºåˆ‡æ¢çš„æ–¹å‘å’Œæ¡ä»¶ï¼š
<img src="https://xiazemin.github.io/MyBlog/img/goroutine_statemachine.jpg" />
<!-- more -->
å…¶ä¸­çŠ¶æ€ Gidle åœ¨Goè°ƒåº¦å™¨ä»£ç ä¸­å¹¶æ²¡æœ‰è¢«çœŸæ­£è¢«ä½¿ç”¨åˆ°ï¼Œæ‰€ä»¥ç›´æ¥å¿½ç•¥ã€‚ äº‹å®ä¸Šï¼Œä¸€æ—¦runtimeæ–°å»ºäº†ä¸€ä¸ªgoroutineç»“æ„ï¼Œå°±ä¼šå°†å…¶çŠ¶æ€ç½®ä¸ºGrunnableå¹¶åŠ å…¥åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå› æ­¤æˆ‘ä»¬ä»¥è¯¥çŠ¶æ€ä½œä¸ºèµ·ç‚¹è¿›è¡Œä»‹ç»ã€‚</p>

<p>Grunnable
Golangä¸­ï¼Œä¸€ä¸ªåç¨‹åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹ä¼šè¢«è®¾ç½®ä¸º GrunnableçŠ¶æ€ï¼š</p>

<p>åˆ›å»º</p>

<p>Go è¯­è¨€ä¸­ï¼ŒåŒ…æ‹¬ç”¨æˆ·å…¥å£å‡½æ•°mainÂ·mainçš„æ‰§è¡Œgoroutineåœ¨å†…çš„æ‰€æœ‰ä»»åŠ¡ï¼Œéƒ½æ˜¯é€šè¿‡runtimeÂ·newproc -&gt; runtimeÂ·newproc1 è¿™ä¸¤ä¸ªå‡½æ•°åˆ›å»ºçš„ï¼Œå‰è€…å…¶å®å°±æ˜¯å¯¹åè€…çš„ä¸€å±‚å°è£…ï¼Œæä¾›å¯å˜å‚æ•°æ”¯æŒï¼ŒGoè¯­è¨€çš„goå…³é”®å­—æœ€ç»ˆä¼šè¢«ç¼–è¯‘å™¨æ˜ å°„ä¸ºå¯¹runtimeÂ·newprocçš„è°ƒç”¨ã€‚å½“runtimeÂ·newproc1å®Œæˆäº†èµ„æºçš„åˆ†é…åŠåˆå§‹åŒ–åï¼Œæ–°ä»»åŠ¡çš„çŠ¶æ€ä¼šè¢«ç½®ä¸ºGrunnableï¼Œç„¶åè¢«æ·»åŠ åˆ°å½“å‰ P çš„ç§æœ‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦æ‰§è¡Œã€‚ç›¸å…³åˆå§‹åŒ–ä»£ç å¦‚ä¸‹:</p>

<p>G* runtimeÂ·newproc1(FuncVal *fn, byte *argp, int32 narg, int32 nret, void *callerpc) 
{
    G *newg;
    P *p;
    int32 siz;
    â€¦â€¦
    // è·å–å½“å‰gæ‰€åœ¨çš„pï¼Œä»pä¸­åˆ›å»ºä¸€ä¸ªæ–°g(newg)
    p = g-&gt;m-&gt;p;
    if((newg = gfget(p)) == nil) {
        â€¦â€¦  <br />
    }
    â€¦â€¦
    // è®¾ç½®GoroutineçŠ¶æ€ä¸ºGrunnable
    runtimeÂ·casgstatus(newg, Gdead,           <br />
        Grunnable);
    â€¦..
    // æ–°åˆ›å»ºçš„gæ·»åŠ åˆ°runé˜Ÿåˆ—ä¸­
    runqput(p, newg);
    â€¦â€¦
}
é˜»å¡ä»»åŠ¡å”¤é†’</p>

<p>å½“æŸä¸ªé˜»å¡ä»»åŠ¡ï¼ˆçŠ¶æ€ä¸ºGwaitingï¼‰çš„ç­‰å¾…æ¡ä»¶æ»¡è¶³è€Œè¢«å”¤é†’æ—¶â€”å¦‚ä¸€ä¸ªä»»åŠ¡G#1å‘æŸä¸ªchannelå†™å…¥æ•°æ®å°†å”¤é†’ä¹‹å‰ç­‰å¾…è¯»å–è¯¥channelæ•°æ®çš„ä»»åŠ¡G#2â€”â€”G#1é€šè¿‡è°ƒç”¨runtimeÂ·readyå°†G#2çŠ¶æ€é‡æ–°ç½®ä¸ºGrunnableå¹¶æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚å…³äºä»»åŠ¡é˜»å¡ï¼Œç¨åè¿˜å¾ˆè¯¦ç»†ä»‹ç»ã€‚</p>

<p>// Mark gp ready to run.
void
runtimeÂ·ready(G *gp)
{
    uint32 status;
    status = runtimeÂ·readgstatus(gp);
    // Mark runnable.
    g-&gt;m-&gt;locks++;<br />
    if((status&amp;~Gscan) != Gwaiting){
        dumpgstatus(gp);
        runtimeÂ·throw(â€œbad g-&gt;status in readyâ€);
    }
    // è®¾ç½®è¢«å”¤é†’çš„gçŠ¶æ€ä»Gwaitingè½¬å˜è‡³Grunnable
    runtimeÂ·casgstatus(gp, Gwaiting, Grunnable);
    // æ·»åŠ åˆ°è¿è¡Œé˜Ÿåˆ—ä¸­
    runqput(g-&gt;m-&gt;p, gp);
    if(runtimeÂ·atomicload(&amp;runtimeÂ·sched.npidle) != 0 &amp;&amp; runtimeÂ·atomicload(&amp;runtimeÂ·sched.nmspinning) == 0) 
    // çœ‹èµ·æ¥è¿™æ˜¯ä¸ªæ¯”è¾ƒé‡è¦çš„å‡½æ•°ï¼Œä½†è¿˜ä¸æ˜¯å¾ˆç†è§£
    wakep();
    g-&gt;m-&gt;locksâ€“;
    if(g-&gt;m-&gt;locks == 0 &amp;&amp; g-&gt;preempt) 
        g-&gt;stackguard0 = StackPreempt;
}
å…¶ä»–</p>

<p>å¦å¤–çš„è·¯å¾„æ˜¯ä»Grunningå’ŒGsyscallçŠ¶æ€å˜æ¢åˆ°Grunnableï¼Œæˆ‘ä»¬ä¹Ÿéƒ½åˆå¹¶åˆ°åé¢ä»‹ç»ã€‚ æ€»ä¹‹ï¼Œå¤„äºGrunnableçš„ä»»åŠ¡ä¸€å®šåœ¨æŸä¸ªä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œéšæ—¶ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œã€‚</p>

<p>Grunning
æ‰€æœ‰çŠ¶æ€ä¸ºGrunnableçš„ä»»åŠ¡éƒ½å¯èƒ½é€šè¿‡findrunnableå‡½æ•°è¢«è°ƒåº¦å™¨ï¼ˆP&amp;Mï¼‰è·å–ï¼Œè¿›è€Œé€šè¿‡executeå‡½æ•°å°†å…¶çŠ¶æ€åˆ‡æ¢åˆ°Grunning, æœ€åè°ƒç”¨runtimeÂ·gogoåŠ è½½å…¶ä¸Šä¸‹æ–‡å¹¶æ‰§è¡Œã€‚</p>

<p>// One round of scheduler: find a runnable goroutine and execute it. Never returns.
static void
schedule(void)
{
    G *gp;
    uint32 tick;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if(g-&gt;m-&gt;locks)
    runtimeÂ·throw("schedule: holding locks");

if(g-&gt;m-&gt;lockedg) {
    stoplockedm();
    execute(g-&gt;m-&gt;lockedg);  // Never returns.
}
</code></pre></div></div>

<p>top:
    if(runtimeÂ·sched.gcwaiting) {
        gcstopm();
        goto top;
    }</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gp = nil;
// æŒ‘ä¸€ä¸ªå¯è¿è¡Œçš„gï¼Œå¹¶æ‰§è¡Œ
......
if(gp == nil) {
    gp = findrunnable();  // blocks until work is available
    resetspinning();
}
......
execute(gp); }
</code></pre></div></div>

<p>// Schedules gp to run on the current M.
// Never returns.
static void
execute(G *gp)
{
    int32 hz;
    // çŠ¶æ€ä»Grunnableè½¬å˜ä¸ºGrunning
    runtimeÂ·casgstatus(gp, Grunnable, Grunning);
    gp-&gt;waitsince = 0;
    gp-&gt;preempt = false;
    gp-&gt;stackguard0 = gp-&gt;stack.lo + StackGuard;
    g-&gt;m-&gt;p-&gt;schedtick++;
    g-&gt;m-&gt;curg = gp;
    gp-&gt;m = g-&gt;m;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Check whether the profiler needs to be turned on or off.
hz = runtimeÂ·sched.profilehz;
if(g-&gt;m-&gt;profilehz != hz)
    runtimeÂ·resetcpuprofiler(hz);
// çœŸæ­£æ‰§è¡Œg
runtimeÂ·gogo(&amp;gp-&gt;sched); } å‰é¢è®²è¿‡Goæœ¬è´¨é‡‡ç”¨ä¸€ç§åä½œå¼è°ƒåº¦æ–¹æ¡ˆï¼Œä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨yieldçš„æ–¹å¼æ˜¾å¼è®©å‡ºå¤„ç†å™¨ï¼›åœ¨Go1.2ä¹‹åï¼Œè¿è¡Œæ—¶ä¹Ÿå¼€å§‹æ”¯æŒä¸€å®šç¨‹åº¦çš„ä»»åŠ¡æŠ¢å â€”â€”å½“ç³»ç»Ÿçº¿ç¨‹sysmonå‘ç°æŸä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿æˆ–è€…runtimeåˆ¤æ–­éœ€è¦è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œä¼šå°†ä»»åŠ¡ç½®ä¸ºâ€å¯è¢«æŠ¢å â€œçš„ï¼Œå½“è¯¥ä»»åŠ¡ä¸‹ä¸€æ¬¡å‡½æ•°è°ƒç”¨æ—¶ï¼Œ å°±ä¼šè®©å‡ºå¤„ç†å™¨å¹¶é‡æ–°åˆ‡ä¼šåˆ°GrunnableçŠ¶æ€ã€‚å…³äºGo1.2ä¸­æŠ¢å æœºåˆ¶çš„å®ç°ç»†èŠ‚ï¼Œåé¢åˆæœºä¼šå†åšä»‹ç»ã€‚
</code></pre></div></div>

<p>Gsyscall
Goè¿è¡Œæ—¶ä¸ºäº†ä¿è¯é«˜çš„å¹¶å‘æ€§èƒ½ï¼Œå½“ä¼šåœ¨ä»»åŠ¡æ‰§è¡ŒOSç³»ç»Ÿè°ƒç”¨å‰ï¼Œå…ˆè°ƒç”¨runtimeÂ·entersyscallå‡½æ•°å°†è‡ªå·±çš„çŠ¶æ€ç½®ä¸ºGsyscallâ€”â€”å¦‚æœç³»ç»Ÿè°ƒç”¨æ˜¯é˜»å¡å¼çš„æˆ–è€…æ‰§è¡Œè¿‡ä¹…ï¼Œåˆ™å°†å½“å‰Mä¸Påˆ†ç¦»â€”â€”å½“ç³»ç»Ÿè°ƒç”¨è¿”å›åï¼Œæ‰§è¡Œçº¿ç¨‹è°ƒç”¨runtimeÂ·exitsyscallå°è¯•é‡æ–°è·å–Pï¼Œå¦‚æœæˆåŠŸä¸”å½“å‰ä»»åŠ¡æ²¡æœ‰è¢«æŠ¢å ï¼Œåˆ™å°†çŠ¶æ€åˆ‡å›Grunningå¹¶ç»§ç»­æ‰§è¡Œï¼›å¦åˆ™å°†çŠ¶æ€ç½®ä¸ºGrunnableï¼Œç­‰å¾…å†æ¬¡è¢«è°ƒåº¦æ‰§è¡Œã€‚</p>

<p>// Puts the current goroutine into a waiting state and calls unlockf.
// If unlockf returns false, the goroutine is resumed.
void
runtimeÂ·park(bool(<em>unlockf)(G</em>, void<em>), void *lock, String reason)
{
    void (</em>fn)(G*);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g-&gt;m-&gt;waitlock = lock;
g-&gt;m-&gt;waitunlockf = unlockf;
g-&gt;waitreason = reason;
fn = runtimeÂ·park_m;
runtimeÂ·mcall(&amp;fn); } // runtimeÂ·park continuation on g0. void runtimeÂ·park_m(G *gp) {
bool ok;
// è®¾ç½®å½“å‰çŠ¶æ€ä»Grunning--&gt;Gwaiting
runtimeÂ·casgstatus(gp, Grunning, Gwaiting);
// å½“å‰gæ”¾å¼ƒm
dropg();

if(g-&gt;m-&gt;waitunlockf) {
    ok = g-&gt;m-&gt;waitunlockf(gp, g-&gt;m-&gt;waitlock);
    g-&gt;m-&gt;waitunlockf = nil;
    g-&gt;m-&gt;waitlock = nil;
    if(!ok) {
        runtimeÂ·casgstatus(gp, Gwaiting, Grunnable);
        execute(gp);  // Schedule it back, never returns.
    }
}

schedule(); } Gwaiting å½“ä¸€ä¸ªä»»åŠ¡éœ€è¦çš„èµ„æºæˆ–è¿è¡Œæ¡ä»¶ä¸èƒ½è¢«æ»¡è¶³æ—¶ï¼Œéœ€è¦è°ƒç”¨runtimeÂ·parkå‡½æ•°è¿›å…¥è¯¥çŠ¶æ€ï¼Œä¹‹åé™¤éç­‰å¾…æ¡ä»¶æ»¡è¶³ï¼Œå¦åˆ™ä»»åŠ¡å°†ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ä¸èƒ½æ‰§è¡Œã€‚é™¤äº†ä¹‹å‰ä¸¾è¿‡çš„channelçš„ä¾‹å­å¤–ï¼ŒGoè¯­è¨€çš„å®šæ—¶å™¨ã€ç½‘ç»œIOæ“ä½œéƒ½å¯èƒ½å¼•èµ·ä»»åŠ¡çš„é˜»å¡ã€‚
</code></pre></div></div>

<p>// runtimeÂ·park continuation on g0.
void
runtimeÂ·park_m(G *gp)
{
    bool ok;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>runtimeÂ·casgstatus(gp, Grunning, Gwaiting);
dropg();

if(g-&gt;m-&gt;waitunlockf) {
    ok = g-&gt;m-&gt;waitunlockf(gp, g-&gt;m-&gt;waitlock);
    g-&gt;m-&gt;waitunlockf = nil;
    g-&gt;m-&gt;waitlock = nil;
    if(!ok) {
        runtimeÂ·casgstatus(gp, Gwaiting, Grunnable);
        execute(gp);  // Schedule it back, never returns.
    }
}

schedule(); } runtimeÂ·parkå‡½æ•°åŒ…å«3ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è§£é”å‡½æ•°æŒ‡é’ˆï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªLockæŒ‡é’ˆï¼Œæœ€åæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç”¨ä»¥æè¿°é˜»å¡çš„åŸå› ã€‚ å¾ˆæ˜æ˜¾ï¼Œå‰ä¸¤ä¸ªå‚æ•°æ˜¯é…å¯¹çš„ç»“æ„â€”â€”ç”±äºä»»åŠ¡é˜»å¡å‰å¯èƒ½è·å¾—äº†æŸäº›Lockï¼Œè¿™äº›Lockå¿…é¡»åœ¨ä»»åŠ¡çŠ¶æ€ä¿å­˜å®Œæˆåæ‰èƒ½é‡Šæ”¾ï¼Œä»¥é¿å…æ•°æ®ç«äº‰ã€‚æˆ‘ä»¬çŸ¥é“channelå¿…é¡»é€šè¿‡Lockç¡®ä¿äº’æ–¥è®¿é—®ï¼Œä¸€ä¸ªé˜»å¡çš„ä»»åŠ¡G#1éœ€è¦å°†è‡ªå·±æ”¾åˆ°channelçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœåœ¨å®Œæˆä¸Šä¸‹æ–‡ä¿å­˜å‰å°±é‡Šæ”¾äº†Lockï¼Œåˆ™å¯èƒ½å¯¼è‡´G#2å°†æœªçŸ¥çŠ¶æ€çš„G#1ç½®ä¸ºGrunnableï¼Œå› æ­¤é‡Šæ”¾Lockå¿…é¡»åœ¨runtimeÂ·parkå†…å®Œæˆã€‚ ç”±äºé˜»å¡æ—¶ä»»åŠ¡æŒæœ‰çš„Lockç±»å‹ä¸å°½ç›¸åŒâ€”â€”å¦‚Selectæ“ä½œçš„é”å®é™…ä¸Šæ˜¯ä¸€ç»„Lockçš„é›†åˆâ€”â€”å› æ­¤éœ€è¦ç‰¹åˆ«æŒ‡å‡ºUnlockçš„å…·ä½“æ–¹å¼ã€‚ æœ€åä¸€ä¸ªå‚æ•°ä¸»è¦æ˜¯åœ¨gdbè°ƒè¯•çš„æ—¶å€™æ–¹ä¾¿å‘ç°ä»»åŠ¡é˜»å¡çš„åŸå› ã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½å¤„äºGwaitingçŠ¶æ€æ—¶ï¼Œä¹Ÿå°±è¡¨ç¤ºå½“å‰ç¨‹åºè¿›å…¥äº†æ­»é”æ€ï¼Œä¸å¯èƒ½ç»§ç»­æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆruntimeä¼šæ£€æµ‹åˆ°è¿™ç§æƒ…å†µï¼Œå¹¶è¾“å‡ºæ‰€æœ‰Gwaitingä»»åŠ¡çš„backtraceä¿¡æ¯ã€‚
</code></pre></div></div>

<p>Gdead
æœ€åï¼Œå½“ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œä¼šè°ƒç”¨runtimeÂ·goexitç»“æŸè‡ªå·±çš„ç”Ÿå‘½â€”â€”å°†çŠ¶æ€ç½®ä¸ºGdeadï¼Œå¹¶å°†ç»“æ„ä½“é“¾åˆ°ä¸€ä¸ªå±äºå½“å‰Pçš„ç©ºé—²Gé“¾è¡¨ä¸­ï¼Œä»¥å¤‡åç»­ä½¿ç”¨ã€‚</p>

<p>Goè¯­è¨€çš„å¹¶å‘æ¨¡å‹åŸºæœ¬ä¸Šéµç…§äº†CSPæ¨¡å‹ï¼Œgoroutineé—´å®Œå…¨é channelé€šä¿¡ï¼Œæ²¡æœ‰åƒUnixè¿›ç¨‹çš„waitæˆ–waitpidçš„ç­‰å¾…æœºåˆ¶ï¼Œä¹Ÿæ²¡æœ‰ç±»ä¼¼â€œPOSIX Threadâ€ä¸­çš„pthread_joinçš„æ±‡åˆæœºåˆ¶ï¼Œæ›´æ²¡æœ‰åƒkillæˆ–signalè¿™ç±»çš„ä¸­æ–­æœºåˆ¶ã€‚æ¯ä¸ªgoroutineç»“æŸåå°±è‡ªè¡Œé€€å‡ºé”€æ¯ï¼Œä¸ç•™ä¸€ä¸ç—•è¿¹ã€‚</p>
:ET