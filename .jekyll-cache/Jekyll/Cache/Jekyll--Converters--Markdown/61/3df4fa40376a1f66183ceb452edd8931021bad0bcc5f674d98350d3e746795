I"Ú\<p>åœ¨net/httpé‡Œæ‰“å°http.Requestçš„contextä¼šå‡ºç°panicã€‚å…·ä½“çš„é”™è¯¯errorï¼Œ fatal error: concurrent map read and map write ã€‚
æˆ‘ä»¬çŸ¥é“golangçš„mapä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¤šä¸ªåç¨‹ä¸åŠ é”å¯¹mapå¹¶å‘è¯»å†™ä¼šè§¦å‘data raceï¼Œç„¶åpanicå¼‚å¸¸é€€å‡ºã€‚
<!-- more -->
ä¸‹é¢æ˜¯å‡ºç°net/http context panicçš„é—®é¢˜ä»£ç ï¼Œä»£ç çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯å®šä¹‰ä¸€ä¸ªapiï¼Œç„¶åæ‰“å°contextè€Œå·²ã€‚æŠŠæœåŠ¡è¿è¡Œèµ·æ¥åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ab, wrkæ¥è¿›è¡Œå‹æµ‹ï¼Œæ¥åˆ¶é€ data raceç«äº‰çš„åœºæ™¯ã€‚</p>

<p>// xiaorui.cc</p>

<p>package main</p>

<p>import (
	â€œfmtâ€
	â€œnet/httpâ€
)</p>

<p>func panic(w http.ResponseWriter, r *http.Request) {
	fmt.Printf(â€œ%+vâ€, r.Context())
}</p>

<p>func main() {
	http.HandleFunc(â€œ/â€, panic)
	err := http.ListenAndServe(â€œ:9090â€, nil)
	if err != nil {
		fmt.Println(err)
	}
}</p>

<p>package main</p>

<p>import (
	â€œfmtâ€
	â€œnet/httpâ€
)</p>

<p>func panic(w http.ResponseWriter, r *http.Request) {
	fmt.Printf(â€œ%+vâ€, r.Context())
}</p>

<p>func main() {
	http.HandleFunc(â€œ/â€, panic)
	err := http.ListenAndServe(â€œ:9090â€, nil)
	if err != nil {
		fmt.Println(err)
	}
}
ä¸‹é¢æ˜¯wrkå‹æµ‹æ—¶ï¼Œnet/httpæœåŠ¡çš„å¼‚å¸¸ä¿¡æ¯ã€‚</p>

<p>// xiaorui.cc</p>

<p>fatal error: concurrent map read and map write</p>

<p>context.Background.WithValue(&amp;http.contextKey{name:â€http-serverâ€}, &amp;http.Server{Addr:â€:9090â€, Handler:http.Handler(nil), TLSConfig:(<em>tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(</em>http.Server, <em>tls.Conn, http.Handler){â€œh2â€:(func(</em>http.Server, <em>tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(</em>log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[<em>net.Listener]struct {}{(</em>net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[<em>http.conn]struct {}{(</em>http.conn)(0xc00009cb40):struct {}{}, (<em>http.conn)(0xc00009d2c0):struct {}{}, (</em>http.conn)(0xc00009d540):struct {}{}, (<em>http.conn)(0xc00009dcc0):struct {}{}, (</em>http.conn)(0xc00009cd20):struct {}{}, (<em>http.conn)(0xc00009d5e0):struct {}â€¦
xiaorui.cc
goroutine 32 [running]:
runtime.throw(0x12b35e3, 0x21)
        /usr/local/go/src/runtime/panic.go:608 +0x72 fp=0xc00018a858 sp=0xc00018a828 pc=0x102b892
runtime.mapaccess2(0x1255800, 0xc000080ea0, 0xc00018a978, 0x14bf328, 0xc0000ac868)
        /usr/local/go/src/runtime/map.go:453 +0x223 fp=0xc00018a8a0 sp=0xc00018a858 pc=0x100ed93
reflect.mapaccess(0x1255800, 0xc000080ea0, 0xc00018a978, 0x12afece)
        /usr/local/go/src/runtime/map.go:1249 +0x3f fp=0xc00018a8d8 sp=0xc00018a8a0 pc=0x1010adf
reflect.Value.MapIndex(0x1255800, 0xc000083280, 0x1b5, 0x1288180, 0xc00009da40, 0x36, 0x1257ae0, 0x14bf328, 0xb9)
        /usr/local/go/src/reflect/value.go:1111 +0x11d fp=0xc00018a958 sp=0xc00018a8d8 pc=0x1099b7d
fmt.(</em>pp).printValue(0xc000188180, 0x1255800, 0xc000083280, 0x1b5, 0x76, 0x2)
        /usr/local/go/src/fmt/print.go:757 +0xf43 fp=0xc00018ab38 sp=0xc00018a958 pc=0x10aa853
fmt.(<em>pp).printValue(0xc000188180, 0x12a0720, 0xc0000831e0, 0x199, 0xc000000076, 0x1)
        /usr/local/go/src/fmt/print.go:783 +0x1ce9 fp=0xc00018ad18 sp=0xc00018ab38 pc=0x10ab5f9
fmt.(</em>pp).printValue(0xc000188180, 0x129ed00, 0xc0000831e0, 0x16, 0x76, 0x0)
        /usr/local/go/src/fmt/print.go:853 +0x1b2c fp=0xc00018aef8 sp=0xc00018ad18 pc=0x10ab43c
fmt.(<em>pp).printArg(0xc000188180, 0x129ed00, 0xc0000831e0, 0x76)
        /usr/local/go/src/fmt/print.go:689 +0x2b7 fp=0xc00018af90 sp=0xc00018aef8 pc=0x10a91a7
fmt.(</em>pp).doPrintf(0xc000188180, 0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b078 sp=0xc00018af90 pc=0x10acde6
fmt.Sprintf(0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3, 0x0, 0x0)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b0d0 sp=0xc00018b078 pc=0x10a5b26
context.(<em>valueCtx).String(0xc000080e10, 0x12be400, 0xc0001880c0)
        /usr/local/go/src/context/context.go:486 +0xab fp=0xc00018b148 sp=0xc00018b0d0 pc=0x11121bb
fmt.(</em>pp).handleMethods(0xc0001880c0, 0x76, 0x1)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b1d8 sp=0xc00018b148 pc=0x10a8cac
fmt.(<em>pp).printArg(0xc0001880c0, 0x1274ce0, 0xc000080e10, 0x76)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b270 sp=0xc00018b1d8 pc=0x10a90f3
fmt.(</em>pp).doPrintf(0xc0001880c0, 0x12afaf0, 0x16, 0xc00018b3e8, 0x3, 0x3)
â€¦
fmt.(<em>pp).printArg(0xc000188000, 0x1274ce0, 0xc000114480, 0xc000000076)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b638 sp=0xc00018b550 pc=0x10acde6
fmt.Sprintf(0x12ad1be, 0xd, 0xc0001106c8, 0x1, 0x1, 0xc00011e080, 0xc0001106f8)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b690 sp=0xc00018b638 pc=0x10a5b26
context.(</em>cancelCtx).String(0xc000116640, 0x12be400, 0xc000188300)
        /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b6e8 sp=0xc00018b690 pc=0x111158d
fmt.(<em>pp).handleMethods(0xc000188300, 0xc000000076, 0x1034601)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b778 sp=0xc00018b6e8 pc=0x10a8cac
fmt.(</em>pp).printArg(0xc000188300, 0x12785e0, 0xc000116640, 0xc000000076)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b810 sp=0xc00018b778 pc=0x10a90f3
fmt.(<em>pp).doPrintf(0xc000188300, 0x12ad1be, 0xd, 0xc00018b988, 0x1, 0x1)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b8f8 sp=0xc00018b810 pc=0x10acde6
fmt.Sprintf(0x12ad1be, 0xd, 0xc000110988, 0x1, 0x1, 0xc00011e030, 0xc0001109b8)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b950 sp=0xc00018b8f8 pc=0x10a5b26
context.(</em>cancelCtx).String(0xc000116740, 0x12be400, 0xc000188240)
        /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b9a8 sp=0xc00018b950 pc=0x111158d
fmt.(<em>pp).handleMethods(0xc000188240, 0x76, 0xc000080c01)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018ba38 sp=0xc00018b9a8 pc=0x10a8cac
fmt.(</em>pp).printArg(0xc000188240, 0x12785e0, 0xc000116740, 0x76)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018bad0 sp=0xc00018ba38 pc=0x10a90f3
fmt.(<em>pp).doPrintf(0xc000188240, 0x12ab4df, 0x3, 0xc00018bcc0, 0x1, 0x1)
 â€¦
fmt.Printf(0x12ab4df, 0x3, 0xc000110cc0, 0x1, 0x1, 0xc0000fa780, 0x3, 0xc000022a70)
        /usr/local/go/src/fmt/print.go:197 +0x72 fp=0xc00018bc80 sp=0xc00018bc20 pc=0x10a5a82
main.panic(0x12f10c0, 0xc0001821c0, 0xc000120600)
        /Users/ruifengyun/test/k.go:9 +0x89 fp=0xc00018bce0 sp=0xc00018bc80 pc=0x121bb79
net/http.HandlerFunc.ServeHTTP(0x12be4e0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:1964 +0x44 fp=0xc00018bd08 sp=0xc00018bce0 pc=0x11f1b14
net/http.(</em>ServeMux).ServeHTTP(0x14a17a0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:2361 +0x127 fp=0xc00018bd48 sp=0xc00018bd08 pc=0x11f37c7
net/http.serverHandler.ServeHTTP(0xc0000831e0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:2741 +0xab fp=0xc00018bd78 sp=0xc00018bd48 pc=0x11f427b
net/http.(<em>conn).serve(0xc00009d180, 0x12f12c0, 0xc000116640)
        /usr/local/go/src/net/http/server.go:1847 +0x646 fp=0xc00018bfc8 sp=0xc00018bd78 pc=0x11f0d66
runtime.goexit()
        /usr/local/go/src/runtime/asm_amd64.s:1333 +0x1 fp=0xc00018bfd0 sp=0xc00018bfc8 pc=0x1057f81
created by net/http.(</em>Server).Serve
        /usr/local/go/src/net/http/server.go:2851 +0x2f5</p>

<p>fatal error: concurrent map read and map write</p>

<p>context.Background.WithValue(&amp;http.contextKey{name:â€http-serverâ€}, &amp;http.Server{Addr:â€:9090â€, Handler:http.Handler(nil), TLSConfig:(<em>tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(</em>http.Server, <em>tls.Conn, http.Handler){â€œh2â€:(func(</em>http.Server, <em>tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(</em>log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[<em>net.Listener]struct {}{(</em>net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[<em>http.conn]struct {}{(</em>http.conn)(0xc00009cb40):struct {}{}, (<em>http.conn)(0xc00009d2c0):struct {}{}, (</em>http.conn)(0xc00009d540):struct {}{}, (<em>http.conn)(0xc00009dcc0):struct {}{}, (</em>http.conn)(0xc00009cd20):struct {}{}, (<em>http.conn)(0xc00009d5e0):struct {}â€¦
xiaorui.cc
goroutine 32 [running]:
runtime.throw(0x12b35e3, 0x21)
        /usr/local/go/src/runtime/panic.go:608 +0x72 fp=0xc00018a858 sp=0xc00018a828 pc=0x102b892
runtime.mapaccess2(0x1255800, 0xc000080ea0, 0xc00018a978, 0x14bf328, 0xc0000ac868)
        /usr/local/go/src/runtime/map.go:453 +0x223 fp=0xc00018a8a0 sp=0xc00018a858 pc=0x100ed93
reflect.mapaccess(0x1255800, 0xc000080ea0, 0xc00018a978, 0x12afece)
        /usr/local/go/src/runtime/map.go:1249 +0x3f fp=0xc00018a8d8 sp=0xc00018a8a0 pc=0x1010adf
reflect.Value.MapIndex(0x1255800, 0xc000083280, 0x1b5, 0x1288180, 0xc00009da40, 0x36, 0x1257ae0, 0x14bf328, 0xb9)
        /usr/local/go/src/reflect/value.go:1111 +0x11d fp=0xc00018a958 sp=0xc00018a8d8 pc=0x1099b7d
fmt.(</em>pp).printValue(0xc000188180, 0x1255800, 0xc000083280, 0x1b5, 0x76, 0x2)
        /usr/local/go/src/fmt/print.go:757 +0xf43 fp=0xc00018ab38 sp=0xc00018a958 pc=0x10aa853
fmt.(<em>pp).printValue(0xc000188180, 0x12a0720, 0xc0000831e0, 0x199, 0xc000000076, 0x1)
        /usr/local/go/src/fmt/print.go:783 +0x1ce9 fp=0xc00018ad18 sp=0xc00018ab38 pc=0x10ab5f9
fmt.(</em>pp).printValue(0xc000188180, 0x129ed00, 0xc0000831e0, 0x16, 0x76, 0x0)
        /usr/local/go/src/fmt/print.go:853 +0x1b2c fp=0xc00018aef8 sp=0xc00018ad18 pc=0x10ab43c
fmt.(<em>pp).printArg(0xc000188180, 0x129ed00, 0xc0000831e0, 0x76)
        /usr/local/go/src/fmt/print.go:689 +0x2b7 fp=0xc00018af90 sp=0xc00018aef8 pc=0x10a91a7
fmt.(</em>pp).doPrintf(0xc000188180, 0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b078 sp=0xc00018af90 pc=0x10acde6
fmt.Sprintf(0x12afaf0, 0x16, 0xc00018b108, 0x3, 0x3, 0x0, 0x0)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b0d0 sp=0xc00018b078 pc=0x10a5b26
context.(<em>valueCtx).String(0xc000080e10, 0x12be400, 0xc0001880c0)
        /usr/local/go/src/context/context.go:486 +0xab fp=0xc00018b148 sp=0xc00018b0d0 pc=0x11121bb
fmt.(</em>pp).handleMethods(0xc0001880c0, 0x76, 0x1)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b1d8 sp=0xc00018b148 pc=0x10a8cac
fmt.(<em>pp).printArg(0xc0001880c0, 0x1274ce0, 0xc000080e10, 0x76)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b270 sp=0xc00018b1d8 pc=0x10a90f3
fmt.(</em>pp).doPrintf(0xc0001880c0, 0x12afaf0, 0x16, 0xc00018b3e8, 0x3, 0x3)
â€¦
fmt.(<em>pp).printArg(0xc000188000, 0x1274ce0, 0xc000114480, 0xc000000076)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b638 sp=0xc00018b550 pc=0x10acde6
fmt.Sprintf(0x12ad1be, 0xd, 0xc0001106c8, 0x1, 0x1, 0xc00011e080, 0xc0001106f8)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b690 sp=0xc00018b638 pc=0x10a5b26
context.(</em>cancelCtx).String(0xc000116640, 0x12be400, 0xc000188300)
        /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b6e8 sp=0xc00018b690 pc=0x111158d
fmt.(<em>pp).handleMethods(0xc000188300, 0xc000000076, 0x1034601)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018b778 sp=0xc00018b6e8 pc=0x10a8cac
fmt.(</em>pp).printArg(0xc000188300, 0x12785e0, 0xc000116640, 0xc000000076)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018b810 sp=0xc00018b778 pc=0x10a90f3
fmt.(<em>pp).doPrintf(0xc000188300, 0x12ad1be, 0xd, 0xc00018b988, 0x1, 0x1)
        /usr/local/go/src/fmt/print.go:1003 +0x166 fp=0xc00018b8f8 sp=0xc00018b810 pc=0x10acde6
fmt.Sprintf(0x12ad1be, 0xd, 0xc000110988, 0x1, 0x1, 0xc00011e030, 0xc0001109b8)
        /usr/local/go/src/fmt/print.go:203 +0x66 fp=0xc00018b950 sp=0xc00018b8f8 pc=0x10a5b26
context.(</em>cancelCtx).String(0xc000116740, 0x12be400, 0xc000188240)
        /usr/local/go/src/context/context.go:343 +0x7d fp=0xc00018b9a8 sp=0xc00018b950 pc=0x111158d
fmt.(<em>pp).handleMethods(0xc000188240, 0x76, 0xc000080c01)
        /usr/local/go/src/fmt/print.go:603 +0x27c fp=0xc00018ba38 sp=0xc00018b9a8 pc=0x10a8cac
fmt.(</em>pp).printArg(0xc000188240, 0x12785e0, 0xc000116740, 0x76)
        /usr/local/go/src/fmt/print.go:686 +0x203 fp=0xc00018bad0 sp=0xc00018ba38 pc=0x10a90f3
fmt.(<em>pp).doPrintf(0xc000188240, 0x12ab4df, 0x3, 0xc00018bcc0, 0x1, 0x1)
 â€¦
fmt.Printf(0x12ab4df, 0x3, 0xc000110cc0, 0x1, 0x1, 0xc0000fa780, 0x3, 0xc000022a70)
        /usr/local/go/src/fmt/print.go:197 +0x72 fp=0xc00018bc80 sp=0xc00018bc20 pc=0x10a5a82
main.panic(0x12f10c0, 0xc0001821c0, 0xc000120600)
        /Users/ruifengyun/test/k.go:9 +0x89 fp=0xc00018bce0 sp=0xc00018bc80 pc=0x121bb79
net/http.HandlerFunc.ServeHTTP(0x12be4e0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:1964 +0x44 fp=0xc00018bd08 sp=0xc00018bce0 pc=0x11f1b14
net/http.(</em>ServeMux).ServeHTTP(0x14a17a0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:2361 +0x127 fp=0xc00018bd48 sp=0xc00018bd08 pc=0x11f37c7
net/http.serverHandler.ServeHTTP(0xc0000831e0, 0x12f10c0, 0xc0001821c0, 0xc000120600)
        /usr/local/go/src/net/http/server.go:2741 +0xab fp=0xc00018bd78 sp=0xc00018bd48 pc=0x11f427b
net/http.(<em>conn).serve(0xc00009d180, 0x12f12c0, 0xc000116640)
        /usr/local/go/src/net/http/server.go:1847 +0x646 fp=0xc00018bfc8 sp=0xc00018bd78 pc=0x11f0d66
runtime.goexit()
        /usr/local/go/src/runtime/asm_amd64.s:1333 +0x1 fp=0xc00018bfd0 sp=0xc00018bfc8 pc=0x1057f81
created by net/http.(</em>Server).Serve
        /usr/local/go/src/net/http/server.go:2851 +0x2f5
é€šè¿‡panicå‡ºæ¥çš„åç¨‹è°ƒç”¨æ ˆä¿¡æ¯å¯ä»¥åˆ†æå‡ºï¼Œfmt printä¼šä¸æ–­çš„é€’å½’åå°„åŠéå†è§£æcontexté‡Œçš„æ•°æ®ã€‚ é€šè¿‡ä¸Šé¢çš„panicä¿¡æ¯æˆ‘ä»¬å¯ä»¥å¾—çŸ¥æ ¹æœ¬é—®é¢˜æ˜¯ç”±äºmapçš„å¹¶å‘è¯»å†™é€ æˆçš„ï¼Œè¿™ä¹Ÿå°±è¯´ context å†…éƒ¨æ˜¯æœ‰mapçš„ã€‚
æˆ‘ä»¬åœ¨æ­£å¸¸æƒ…å†µä¸‹æ‰“å°http.Request contextï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªmapï¼Œä¸€ä¸ªæ˜¯listenersï¼Œä¸€ä¸ªæ˜¯activeConnã€‚å¦å¤–åœ¨activeConnè¿™ä¸ªç»“æ„é‡Œè¿˜èƒ½çœ‹åˆ°å¾ˆå¤šçš„connã€‚è¯´æ˜è¿™ä¸ªcontextä¸å•å•æ˜¯å«æœ‰è¿™ä¸ªè¯·æ±‚æœ¬èº«éœ€è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯äº†ï¼Œè€Œä¸”è¿˜åŒ…å«äº†è¯¥serverå¯¹è±¡ã€‚</p>

<p>// xiaorui.cc</p>

<p>context.Background.WithValue(&amp;http.contextKey{name:â€http-serverâ€}, &amp;http.Server{Addr:â€:9090â€, Handler:http.Handler(nil), TLSConfig:(<em>tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(</em>http.Server, <em>tls.Conn, http.Handler){â€œh2â€:(func(</em>http.Server, <em>tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(</em>log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[<em>net.Listener]struct {}{(</em>net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[<em>http.conn]struct {}{(</em>http.conn)(0xc00009cb40):struct {}{}, (<em>http.conn)(0xc00009d2c0):struct {}{}, (</em>http.conn)(0xc00009d540):struct {}{}, (<em>http.conn)(0xc00009dcc0):struct {}{}, (</em>http.conn)(0xc00009cd20):struct {}{}, (<em>http.conn)(0xc00009d5e0):struct {}{}, (</em>http.conn)(0xc00009d860):struct {}{}, (<em>http.conn)(0xc00009d9a0):struct {}{}, (</em>http.conn)(0xc0001940a0):struct {}{}, (<em>http.conn)(0xc00009cfa0):struct {}{}, (</em>http.conn)(0xc00009d400):struct {}{}, (<em>http.conn)(0xc00009dd60):struct {}{}, (</em>http.conn)(0xc000194140):struct {}{}, (<em>http.conn)(0xc0001941e0):struct {}{}, (</em>http.conn)(0xc00009caa0):struct {}{}, (<em>http.conn)(0xc00009d180):struct {}{}, (</em>http.conn)(0xc00009d220):struct {}{}, (<em>http.conn)(0xc00009d680):struct {}{}, (</em>http.conn)(0xc00009d900):struct {}{}, (<em>http.conn)(0xc00009cc80):struct {}{}, (</em>http.conn)(0xc00009ce60):struct {}{}, (<em>http.conn)(0xc00009d040):struct {}{}, (</em>http.conn)(0xc00009dc20):struct {}{}, (<em>http.conn)(0xc00009dea0):struct {}{}, (</em>http.conn)(0xc00009ca00):struct {}{}, (<em>http.conn)(0xc00009cdc0):struct {}{}, (</em>http.conn)(0xc00009d0e0):struct {}{}, (<em>http.conn)(0xc00009d360):struct {}{}, (</em>http.conn)(0xc00009da40):struct {}{}, (<em>http.conn)(0xc00009dae0):struct {}{}, (</em>http.conn)(0xc00009cbe0):struct {}{}, (<em>http.conn)(0xc00009d4a0):struct {}{}, (</em>http.conn)(0x
1
2
3
// xiaorui.cc</p>

<p>context.Background.WithValue(&amp;http.contextKey{name:â€http-serverâ€}, &amp;http.Server{Addr:â€:9090â€, Handler:http.Handler(nil), TLSConfig:(<em>tls.Config)(0xc000062780), ReadTimeout:0, ReadHeaderTimeout:0, WriteTimeout:0, IdleTimeout:0, MaxHeaderBytes:0, TLSNextProto:map[string]func(</em>http.Server, <em>tls.Conn, http.Handler){â€œh2â€:(func(</em>http.Server, <em>tls.Conn, http.Handler))(0x120b620)}, ConnState:(func(net.Conn, http.ConnState))(nil), ErrorLog:(</em>log.Logger)(nil), disableKeepAlives:0, inShutdown:0, nextProtoOnce:sync.Once{m:sync.Mutex{state:0, sema:0x0}, done:0x1}, nextProtoErr:error(nil), mu:sync.Mutex{state:0, sema:0x0}, listeners:map[<em>net.Listener]struct {}{(</em>net.Listener)(0xc00007ccb0):struct {}{}}, activeConn:map[<em>http.conn]struct {}{(</em>http.conn)(0xc00009cb40):struct {}{}, (<em>http.conn)(0xc00009d2c0):struct {}{}, (</em>http.conn)(0xc00009d540):struct {}{}, (<em>http.conn)(0xc00009dcc0):struct {}{}, (</em>http.conn)(0xc00009cd20):struct {}{}, (<em>http.conn)(0xc00009d5e0):struct {}{}, (</em>http.conn)(0xc00009d860):struct {}{}, (<em>http.conn)(0xc00009d9a0):struct {}{}, (</em>http.conn)(0xc0001940a0):struct {}{}, (<em>http.conn)(0xc00009cfa0):struct {}{}, (</em>http.conn)(0xc00009d400):struct {}{}, (<em>http.conn)(0xc00009dd60):struct {}{}, (</em>http.conn)(0xc000194140):struct {}{}, (<em>http.conn)(0xc0001941e0):struct {}{}, (</em>http.conn)(0xc00009caa0):struct {}{}, (<em>http.conn)(0xc00009d180):struct {}{}, (</em>http.conn)(0xc00009d220):struct {}{}, (<em>http.conn)(0xc00009d680):struct {}{}, (</em>http.conn)(0xc00009d900):struct {}{}, (<em>http.conn)(0xc00009cc80):struct {}{}, (</em>http.conn)(0xc00009ce60):struct {}{}, (<em>http.conn)(0xc00009d040):struct {}{}, (</em>http.conn)(0xc00009dc20):struct {}{}, (<em>http.conn)(0xc00009dea0):struct {}{}, (</em>http.conn)(0xc00009ca00):struct {}{}, (<em>http.conn)(0xc00009cdc0):struct {}{}, (</em>http.conn)(0xc00009d0e0):struct {}{}, (<em>http.conn)(0xc00009d360):struct {}{}, (</em>http.conn)(0xc00009da40):struct {}{}, (<em>http.conn)(0xc00009dae0):struct {}{}, (</em>http.conn)(0xc00009cbe0):struct {}{}, (<em>http.conn)(0xc00009d4a0):struct {}{}, (</em>http.conn)(0x
æˆ‘ä»¬å†æ¥åˆ†æä¸‹ net/httpçš„ä»£ç é‡Œå¯¹activeConn mapçš„ä¿®æ”¹é€»è¾‘ã€‚ä¸ç®¡æ˜¯åˆå§‹åŒ–ï¼Œæ–°å¢ï¼Œåˆ é™¤éƒ½æœ‰åŠ é”ã€‚ä½†æ˜¯ä»–çš„é”çš„èŒƒå›´åªæ˜¯ net/http serverçš„é”ã€‚fmt.Printfé‡Œå¯¹serverå¯¹è±¡çš„activeConn mapéå†æ‰“å°è‡ªç„¶ä¸å—å½±å“ã€‚
é‚£ä¹ˆï¼Œè‡ªç„¶å°±ä¼šæœ‰é€ æˆ map çš„panicã€‚</p>

<p>// xiaorui.cc</p>

<p>// åˆ›å»ºå…ˆçš„æ´»åŠ¨è¿æ¥
func (s <em>Server) trackConn(c *conn, add bool) {
	s.mu.Lock()
	defer s.mu.Unlock()
	if s.activeConn == nil {
		s.activeConn = make(map[</em>conn]struct{})
	}
	if add {
		s.activeConn[c] = struct{}{}
	} else {
		delete(s.activeConn, c)
	}
}</p>

<p>// å…³é—­ç©ºé—²è¿æ¥
func (s *Server) closeIdleConns() bool {
	s.mu.Lock()
	defer s.mu.Unlock()
	for c := range s.activeConn {
		st, unixSec := c.getState()
                â€¦
		delete(s.activeConn, c)
	}
	return quiescent
}</p>

<p>// åˆ›å»ºå…ˆçš„æ´»åŠ¨è¿æ¥
func (s <em>Server) trackConn(c *conn, add bool) {
	s.mu.Lock()
	defer s.mu.Unlock()
	if s.activeConn == nil {
		s.activeConn = make(map[</em>conn]struct{})
	}
	if add {
		s.activeConn[c] = struct{}{}
	} else {
		delete(s.activeConn, c)
	}
}</p>

<p>// å…³é—­ç©ºé—²è¿æ¥
func (s *Server) closeIdleConns() bool {
	s.mu.Lock()
	defer s.mu.Unlock()
	for c := range s.activeConn {
		st, unixSec := c.getState()
                â€¦
		delete(s.activeConn, c)
	}
	return quiescent
}
è¿™é‡Œè¿˜æœ‰ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªserveræ˜¯ä»å“ªé‡Œä¼ ç»™æ¯ä¸ªè¯·æ±‚çš„handlerçš„ã€‚</p>

<p>// xiaorui.cc</p>

<p>func (srv *Server) Serve(l net.Listener) error {
	baseCtx := context.Background()
        â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // æŠŠä»–è‡ªèº«é€šè¿‡withValueç”Ÿæˆä¸€ä¸ªctxï¼Œå¹¶ä¼ é€’ä¸‹å»
ctx := context.WithValue(baseCtx, ServerContextKey, srv)
for {
	rw, e := l.Accept()
    ...
	go c.serve(ctx)
} }
</code></pre></div></div>

<p>// Serve a new connection.
func (c *conn) serve(ctx context.Context) {
	c.remoteAddr = c.rwc.RemoteAddr().String()
	ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr())
    â€¦
	for {
		w, err := c.readRequest(ctx)
		if c.r.remain != c.server.initialReadLimitSize() {
			// If we read any bytes off the wire, weâ€™re active.
			c.setState(c.rwc, StateActive)
		}
        â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	req := w.req
	serverHandler{c.server}.ServeHTTP(w, w.req)
    }
} }
</code></pre></div></div>

<p>func (srv *Server) Serve(l net.Listener) error {
	baseCtx := context.Background()
        â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // æŠŠä»–è‡ªèº«é€šè¿‡withValueç”Ÿæˆä¸€ä¸ªctxï¼Œå¹¶ä¼ é€’ä¸‹å»
ctx := context.WithValue(baseCtx, ServerContextKey, srv)
for {
	rw, e := l.Accept()
    ...
	go c.serve(ctx)
} }
</code></pre></div></div>

<p>// Serve a new connection.
func (c *conn) serve(ctx context.Context) {
	c.remoteAddr = c.rwc.RemoteAddr().String()
	ctx = context.WithValue(ctx, LocalAddrContextKey, c.rwc.LocalAddr())
    â€¦
	for {
		w, err := c.readRequest(ctx)
		if c.r.remain != c.server.initialReadLimitSize() {
			// If we read any bytes off the wire, weâ€™re active.
			c.setState(c.rwc, StateActive)
		}
        â€¦</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	req := w.req
	serverHandler{c.server}.ServeHTTP(w, w.req)
    }
} } å¦‚ä½•è§£å†³ï¼Ÿ æˆ–è€…è¯´å®‰å…¨æ‰“å°
</code></pre></div></div>

<p>åˆ«ç›´æ¥æŠŠcontextéƒ½è¾“å‡ºæ‰“å°å°±å¯ä»¥äº†</p>

<p>// fmtåŒ… interface å‚æ•°è½¬å­—ç¬¦ä¸²å…¬å…±æ–¹æ³•
func (p *pp) printArg(arg interface{}, verb rune) {
default:
        // åˆ¤æ–­ç»“æ„ä½“æœ‰æ²¡æœ‰ String() æ–¹æ³•
        if !p.handleMethods(verb) {
            // è¿ç”¨åå°„æ‰“å°å…¨éƒ¨æˆå‘˜
            p.printValue(reflect.ValueOf(f), verb, 0)</p>

<p>type Stringer interface {
    String() string
}</p>

<p>// åˆ¤æ–­å‚æ•°ç»“æ„ä½“æ˜¯å¦å®ç°äº† Stringer æ¥å£
func (p *pp) handleMethods(verb rune) (handled bool) {
 case Stringer:
        handled = true
        defer p.catchPanic(p.arg, verb)
        p.fmtString(v.String(), verb)</p>

<p>// éå†ç»“æ„ä½“å†…æ‰€æœ‰æˆå‘˜ï¼Œå…¨éƒ¨æ‰“å°ï¼ˆä¸åŒºåˆ†å…¬æœ‰ç§æœ‰ï¼‰
func (p *pp) printValue(value reflect.Value, verb rune, depth int) {</p>

<p>case reflect.Struct:
        â€¦. çœç•¥ â€¦  <br />
        for i := 0; i &lt; f.NumField(); i++ {
            â€¦ çœç•¥ â€¦
            if name := f.Type().Field(i).Name; name != â€œâ€ {
                p.buf.WriteString(name)
                p.buf.WriteByte(â€˜:â€™)</p>

:ET