I"àl<p>https://mp.weixin.qq.com/s/ogtRE_LbllN2Tla97LnFrQ
é¡¹ç›®èƒŒæ™¯
ç½‘å…³æœåŠ¡ä½œä¸ºç»Ÿä¸€æ¥å…¥æœåŠ¡ï¼Œæ˜¯å¤§éƒ¨åˆ†æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚ä¸ºäº†é¿å…æˆåŠŸç“¶é¢ˆï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå°½å¯èƒ½åœ°ä¼˜åŒ–ã€‚å› æ­¤ï¼Œç‰¹åˆ«æ€»ç»“ä¸€ä¸‹ golang åå°æœåŠ¡æ€§èƒ½ä¼˜åŒ–çš„æ–¹å¼ï¼Œå¹¶å¯¹ç½‘å…³æœåŠ¡è¿›è¡Œä¼˜åŒ–ã€‚</p>

<p>æŠ€æœ¯èƒŒæ™¯ï¼š</p>

<p>åŸºäº tarsgo æ¡†æ¶çš„ http æ¥å…¥æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡ä½¿ç”¨ tarsgo åè®®è¿›è¡Œäº¤äº’
æ€§èƒ½æŒ‡æ ‡
ç½‘å…³æœåŠ¡æœ¬èº«æ²¡æœ‰ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä»…ä½œä¸ºç»Ÿä¸€å…¥å£è¿›è¡Œè¯·æ±‚è½¬å‘ï¼Œå› æ­¤æˆ‘ä»¬ä¸»è¦å…³æ³¨ä¸‹åˆ—æŒ‡æ ‡</p>

<p>ååé‡ï¼šæ¯ç§’é’Ÿå¯ä»¥å¤„ç†çš„è¯·æ±‚æ•°
å“åº”æ—¶é—´ï¼šä»å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œåˆ°æ”¶åˆ°å›åŒ…çš„æ€»è€—æ—¶
å®šä½ç“¶é¢ˆ
ä¸€èˆ¬åå°æœåŠ¡çš„ç“¶é¢ˆä¸»è¦ä¸º CPUï¼Œå†…å­˜ï¼ŒIO æ“ä½œä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªã€‚è‹¥è¿™ä¸‰è€…çš„è´Ÿè½½éƒ½ä¸é«˜ï¼Œä½†ç³»ç»Ÿååé‡ä½ï¼ŒåŸºæœ¬å°±æ˜¯ä»£ç é€»è¾‘å‡ºé—®é¢˜äº†ã€‚</p>

<p>åœ¨ä»£ç æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¦é’ˆå¯¹æŸä¸ªæ–¹é¢çš„é«˜è´Ÿè½½è¿›è¡Œä¼˜åŒ–ï¼Œæ‰èƒ½æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚golang å¯é€šè¿‡ benchmark åŠ  pprof æ¥å®šä½å…·ä½“çš„æ€§èƒ½ç“¶é¢ˆã€‚
<!-- more -->
benchmark ç®€ä»‹
go test -v gate_test.go -run=none -bench=. -benchtime=3s -cpuprofile cpu.prof -memprofile mem.prof
-run çŸ¥é“å•æ¬¡æµ‹è¯•ï¼Œä¸€èˆ¬ç”¨äºä»£ç é€»è¾‘éªŒè¯
-bench=. æ‰§è¡Œæ‰€æœ‰ Benchmarkï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç”¨ä¾‹å‡½æ•°åæ¥æŒ‡å®šéƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹
-benchtime æŒ‡å®šæµ‹è¯•æ‰§è¡Œæ—¶é•¿
-cpuprofile è¾“å‡º cpu çš„ pprof ä¿¡æ¯æ–‡ä»¶
-memprofile è¾“å‡º heap çš„ pprof ä¿¡æ¯æ–‡ä»¶ã€‚
-blockprofile é˜»å¡åˆ†æï¼Œè®°å½• goroutine é˜»å¡ç­‰å¾…åŒæ­¥ï¼ˆåŒ…æ‹¬å®šæ—¶å™¨é€šé“ï¼‰çš„ä½ç½®
-mutexprofile äº’æ–¥é”åˆ†æï¼ŒæŠ¥å‘Šäº’æ–¥é”çš„ç«äº‰æƒ…å†µ
benchmark æµ‹è¯•ç”¨ä¾‹å¸¸ç”¨å‡½æ•°
b.ReportAllocs() è¾“å‡ºå•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡å’Œå¯¹è±¡ allocs ä¿¡æ¯
b.RunParallel() ä½¿ç”¨åç¨‹å¹¶å‘æµ‹è¯•
b.SetBytes(n int64) è®¾ç½®å•æ¬¡å¾ªç¯ä½¿ç”¨çš„å†…å­˜æ•°é‡
pprof ç®€ä»‹
ç”Ÿæˆæ–¹å¼
runtime/pprof: æ‰‹åŠ¨è°ƒç”¨å¦‚runtime.StartCPUProfileæˆ–è€…runtime.StopCPUProfileç­‰ API æ¥ç”Ÿæˆå’Œå†™å…¥é‡‡æ ·æ–‡ä»¶ï¼Œçµæ´»æ€§é«˜ã€‚ä¸»è¦ç”¨äºæœ¬åœ°æµ‹è¯•ã€‚
net/http/pprof: é€šè¿‡ http æœåŠ¡è·å– Profile é‡‡æ ·æ–‡ä»¶ï¼Œç®€å•æ˜“ç”¨ï¼Œé€‚ç”¨äºå¯¹åº”ç”¨ç¨‹åºçš„æ•´ä½“ç›‘æ§ã€‚é€šè¿‡ runtime/pprof å®ç°ã€‚ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æµ‹è¯•ã€‚
go test: é€šè¿‡ go test -bench . -cpuprofile cpuprofile.outç”Ÿæˆé‡‡æ ·æ–‡ä»¶ï¼Œä¸»è¦ç”¨äºæœ¬åœ°åŸºå‡†æµ‹è¯•ã€‚å¯ç”¨äºé‡ç‚¹æµ‹è¯•æŸäº›å‡½æ•°ã€‚
æŸ¥çœ‹æ–¹å¼
go tool pprof [options][binary] â€¦</p>

<p>â€“text çº¯æ–‡æœ¬
â€“web ç”Ÿæˆ svg å¹¶ç”¨æµè§ˆå™¨æ‰“å¼€ï¼ˆå¦‚æœ svg çš„é»˜è®¤æ‰“å¼€æ–¹å¼æ˜¯æµè§ˆå™¨)
â€“svg åªç”Ÿæˆ svg
â€“list funcname ç­›é€‰å‡ºæ­£åˆ™åŒ¹é… funcname çš„å‡½æ•°çš„ä¿¡æ¯
-http=â€:portâ€ ç›´æ¥æœ¬åœ°æµè§ˆå™¨æ‰“å¼€ profile æŸ¥çœ‹ï¼ˆåŒ…æ‹¬ topï¼Œgraphï¼Œç«ç„°å›¾ç­‰ï¼‰
go tool pprof -base profile1 profile2</p>

<p>å¯¹æ¯”æŸ¥çœ‹ 2 ä¸ª profileï¼Œä¸€èˆ¬ç”¨äºä»£ç ä¿®æ”¹å‰åå¯¹æ¯”ï¼Œå®šä½å·®å¼‚ç‚¹ã€‚
é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼æŸ¥çœ‹ profile æ—¶ï¼Œå¯ä»¥åœ¨å‘½ä»¤è¡Œå¯¹è¯ä¸­ï¼Œä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ï¼ŒæŸ¥çœ‹ç›¸å…³ä¿¡æ¯</p>

<p>flat  flat%   sum%        cum   cum%
 5.95s 27.56% 27.56%      5.95s 27.56%  runtime.usleep
 4.97s 23.02% 50.58%      5.08s 23.53%  sync.(<em>RWMutex).RLock
 4.46s 20.66% 71.24%      4.46s 20.66%  sync.(</em>RWMutex).RUnlock
 2.69s 12.46% 83.70%      2.69s 12.46%  runtime.pthread_cond_wait
 1.50s  6.95% 90.64%      1.50s  6.95%  runtime.pthread_cond_signal
flat: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°æ­£åœ¨è¿è¡Œçš„æ¬¡æ•°*é‡‡æ ·é¢‘ç‡(10ms)ï¼Œå³å¾—åˆ°ä¼°ç®—çš„å‡½æ•°è¿è¡Œâ€é‡‡æ ·æ—¶é—´â€ã€‚è¿™é‡Œä¸åŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚</p>

<p>flat%: flat / æ€»é‡‡æ ·æ—¶é—´å€¼</p>

<p>sum%: å‰é¢æ‰€æœ‰è¡Œçš„ flat% çš„ç´¯åŠ å€¼ï¼Œå¦‚ç¬¬ä¸‰è¡Œ sum% = 71.24% = 27.56% + 50.58%</p>

<p>cum: é‡‡æ ·æ—¶ï¼Œè¯¥å‡½æ•°å‡ºç°åœ¨è°ƒç”¨å †æ ˆçš„é‡‡æ ·æ—¶é—´ï¼ŒåŒ…æ‹¬å‡½æ•°ç­‰å¾…å­å‡½æ•°è¿”å›ã€‚å› æ­¤ flat &lt;= cum</p>

<p>cum%: cum / æ€»é‡‡æ ·æ—¶é—´å€¼</p>

<p>topN [-cum] æŸ¥çœ‹å‰ N ä¸ªæ•°æ®ï¼š</p>

<p>list ncname æŸ¥çœ‹æŸä¸ªå‡½æ•°çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥æ˜ç¡®å…·ä½“çš„èµ„æºï¼ˆcpuï¼Œå†…å­˜ç­‰ï¼‰æ˜¯ç”±å“ªä¸€è¡Œè§¦å‘çš„ã€‚
pprof æ¥å…¥ tarsgo
æœåŠ¡ä¸­ main æ–¹æ³•æ’å…¥ä»£ç </p>

<p>cfg := tars.GetServerConfig()
profMux := &amp;tars.TarsHttpMux{}
profMux.HandleFunc(â€œ/debug/pprof/â€, pprof.Index)
profMux.HandleFunc(â€œ/debug/pprof/cmdlineâ€, pprof.Cmdline)
profMux.HandleFunc(â€œ/debug/pprof/profileâ€, pprof.Profile)
profMux.HandleFunc(â€œ/debug/pprof/symbolâ€, pprof.Symbol)
profMux.HandleFunc(â€œ/debug/pprof/traceâ€, pprof.Trace)
tars.AddHttpServant(profMux, cfg.App+â€.â€+cfg.Server+â€.ProfObjâ€)
taf ç®¡ç†å¹³å°ä¸­ï¼Œæ·»åŠ  servantï¼šProfObj ï¼ˆåå­—å¯è‡ªå·±ä¿®æ”¹)</p>

<p>å‘å¸ƒæœåŠ¡</p>

<p>æŸ¥çœ‹ tasrgo æœåŠ¡çš„ pprof
ä¿è¯å¼€å‘æœºèƒ½ç›´æ¥è®¿é—®åˆ° tarsgo èŠ‚ç‚¹éƒ¨ç½²çš„ ip å’Œ portã€‚</p>

<p>æŸ¥çœ‹ profile(http åœ°å€ä¸­çš„ ip,port ä¸º ProfObj çš„ ip å’Œ port)</p>

<h1 id="ä¸‹è½½cpu-profile">ä¸‹è½½cpu profile</h1>
<p>go tool pprof http://ip:port/debug/pprof/profile?seconds=120 # ç­‰å¾…120sï¼Œä¸å¸¦æ­¤å‚æ•°æ—¶ç­‰å¾…30s</p>

<h1 id="ä¸‹è½½heap-profile">ä¸‹è½½heap profile</h1>
<p>go tool pprof http://ip:port/debug/pprof/heap</p>

<h1 id="ä¸‹è½½goroutine-profile">ä¸‹è½½goroutine profile</h1>
<p>go tool pprof http://ip:port/debug/pprof/goroutine</p>

<h1 id="ä¸‹è½½block-profile">ä¸‹è½½block profile</h1>
<p>go tool pprof http://ip:port/debug/pprof/block</p>

<h1 id="ä¸‹è½½mutex-profile">ä¸‹è½½mutex profile</h1>
<p>go tool pprof http://ip:port/debug/pprof/mutex</p>

<h1 id="ä¸‹è½½20ç§’çš„traceè®°å½•é‡åˆ°æ£˜æ‰‹é—®é¢˜æ—¶æŸ¥çœ‹traceä¼šæ¯”è¾ƒå®¹æ˜“å®šä½">ä¸‹è½½20ç§’çš„traceè®°å½•ï¼ˆé‡åˆ°æ£˜æ‰‹é—®é¢˜æ—¶ï¼ŒæŸ¥çœ‹traceä¼šæ¯”è¾ƒå®¹æ˜“å®šä½)</h1>
<p>curl http://100.97.1.35:10078/debug/pprof/trace?seconds=20 &gt; trace.out
 go tool trace trace.out æŸ¥çœ‹
ç›´æ¥åœ¨ç»ˆç«¯ä¸­é€šè¿‡ pprof å‘½ä»¤æŸ¥çœ‹</p>

<p>sz ä¸Šé¢å‘½ä»¤æ‰§è¡Œæ—¶å‡ºç°çš„Saved profile in /root/pprof/pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gzåˆ°æœ¬åœ°</p>

<p>åœ¨æœ¬åœ°ç¯å¢ƒï¼Œæ‰§è¡Œgo tool pprof -http=â€:8081â€ pprof.binary.alloc_objects.xxxxxxx.xxxx.pb.gz å³å¯ç›´æ¥é€šè¿‡http://localhost:8081é¡µé¢æŸ¥çœ‹ã€‚åŒ…æ‹¬topNï¼Œç«ç„°å›¾ä¿¡æ¯ç­‰,ä¼šæ›´æ–¹ä¾¿ä¸€ç‚¹ã€‚</p>

<p>GC Trace
golang å…·å¤‡ GC åŠŸèƒ½ï¼Œè€Œ GC æ˜¯æœ€å®¹æ˜“è¢«å¿½è§†çš„æ€§èƒ½å½±å“å› ç´ ã€‚å°¤å…¶æ˜¯åœ¨æœ¬åœ°ä½¿ç”¨ benchmark æµ‹è¯•æ—¶ï¼Œç”±äºæ—¶é—´è¾ƒçŸ­ï¼Œå ç”¨å†…å­˜è¾ƒå°‘ã€‚å¾€å¾€ä¸ä¼šè§¦å‘ GCã€‚è€Œä¸€æ—¦çº¿ä¸Šå‡ºç° GC é—®é¢˜ï¼Œåˆä¸å¤ªå¥½å®šä½ã€‚ç›®å‰å¸¸ç”¨çš„å®šä½æ–¹å¼æœ‰ä¸¤ç§ï¼š</p>

<p>æœ¬åœ° gctrace
åœ¨æ‰§è¡Œç¨‹åºå‰åŠ  GODEBUG=gctrace=1ï¼Œæ¯æ¬¡ gc æ—¶ä¼šè¾“å‡ºä¸€è¡Œå¦‚ä¸‹å†…å®¹</p>

<p>gc 1 @0.001s 11%: 0.007+1.5+0.004 ms clock, 0.089+1.5/2.8/0.27+0.054 ms cpu, 4-&gt;4-&gt;3 MB, 5 MB goal, 12 P
scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB)
ä¹Ÿé€šè¿‡æ—¥å¿—è½¬ä¸ºå›¾å½¢åŒ–ï¼š</p>

<p>GODEBUG=gctrace=1 godoc -index -http=:6060 2&gt; stderr.log
cat stderr.log | gcvis
inuseï¼šä½¿ç”¨äº†å¤šå°‘ M å†…å­˜
idleï¼šå‰©ä¸‹è¦æ¸…é™¤çš„å†…å­˜
sysï¼šç³»ç»Ÿæ˜ å°„çš„å†…å­˜
releasedï¼šé‡Šæ”¾çš„ç³»ç»Ÿå†…å­˜
consumedï¼šç”³è¯·çš„ç³»ç»Ÿå†…å­˜
gc 1 è¡¨ç¤ºç¬¬ 1 æ¬¡ gc</p>

<p>@0.001s è¡¨ç¤ºç¨‹åºæ‰§è¡Œçš„æ€»æ—¶é—´</p>

<p>11% è¡¨ç¤ºåƒåœ¾å›æ”¶æ—¶é—´å ç”¨æ€»çš„è¿è¡Œæ—¶é—´ç™¾åˆ†æ¯”</p>

<p>0.007+1.5+0.004 ms clock è¡¨ç¤ºå·¥ä½œçº¿ç¨‹å®Œæˆ GC çš„ stop-the-world,sweeping,marking å’Œ waiting çš„æ—¶é—´</p>

<p>0.089+1.5/2.8/0.27+0.054 ms cpu åƒåœ¾å›æ”¶å ç”¨ cpu æ—¶é—´</p>

<p>4-&gt;4-&gt;3 MB è¡¨ç¤ºå †çš„å¤§å°ï¼Œgc åå †çš„å¤§å°ï¼Œå­˜æ´»å †çš„å¤§å°</p>

<p>5 MB goal æ•´ä½“å †çš„å¤§å°</p>

<p>12 P ä½¿ç”¨çš„å¤„ç†å™¨æ•°é‡</p>

<p>scvg: inuse: 4, idle: 57, sys: 62, released: 57, consumed: 4 (MB) è¡¨ç¤ºç³»ç»Ÿå†…å­˜å›æ”¶ä¿¡æ¯</p>

<p>é‡‡ç”¨å›¾å½¢åŒ–çš„æ–¹å¼æŸ¥çœ‹ï¼šhttps://github.com/davecheney/gcvis</p>

<table>
  <tbody>
    <tr>
      <td>GODEBUG=gctrace=1 go test -v *.go -bench=. -run=none -benchtime 3m</td>
      <td>&amp; gcvis</td>
    </tr>
  </tbody>
</table>

<p>çº¿ä¸Š trace
åœ¨çº¿ä¸Šä¸šåŠ¡ä¸­æ·»åŠ net/http/pprofåï¼Œå¯é€šè¿‡ä¸‹åˆ—å‘½ä»¤é‡‡é›† 20 ç§’çš„ trace ä¿¡æ¯</p>

<p>curl http://ip:port/debug/pprof/trace?seconds=20 &gt; trace.out
å†é€šè¿‡go tool trace trace.out å³å¯åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­æŸ¥çœ‹ trace ä¿¡æ¯ã€‚</p>

<p>View traceï¼šæŸ¥çœ‹è·Ÿè¸ª
Goroutine analysisï¼šGoroutine åˆ†æ
Network blocking profileï¼šç½‘ç»œé˜»å¡æ¦‚å†µ
Synchronization blocking profileï¼šåŒæ­¥é˜»å¡æ¦‚å†µ
Syscall blocking profileï¼šç³»ç»Ÿè°ƒç”¨é˜»å¡æ¦‚å†µ
Scheduler latency profileï¼šè°ƒåº¦å»¶è¿Ÿæ¦‚å†µ
User defined tasksï¼šç”¨æˆ·è‡ªå®šä¹‰ä»»åŠ¡
User defined regionsï¼šç”¨æˆ·è‡ªå®šä¹‰åŒºåŸŸ
Minimum mutator utilizationï¼šæœ€ä½ Mutator åˆ©ç”¨ç‡
GC ç›¸å…³çš„ä¿¡æ¯å¯ä»¥åœ¨ View trace ä¸­çœ‹åˆ°</p>

<p>å¯é€šè¿‡ç‚¹å‡» heap çš„è‰²å—åŒºåŸŸï¼ŒæŸ¥çœ‹ heap ä¿¡æ¯ã€‚</p>

<p>ç‚¹å‡» GC å¯¹åº”è¡Œçš„è“è‰²è‰²å—ï¼ŒæŸ¥çœ‹ GC è€—æ—¶åŠç›¸å…³å›æ”¶ä¿¡æ¯ã€‚</p>

<p>é€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯å°±å¯ä»¥ç¡®è®¤æ˜¯å¦å­˜åœ¨ GC é—®é¢˜ï¼Œä»¥åŠé€ æˆé«˜ GC çš„å¯èƒ½åŸå› ã€‚</p>

<p>ä½¿ç”¨é—®é¢˜
trace çš„å±•ç¤ºä»…æ”¯æŒ chrome æµè§ˆå™¨ã€‚ä½†æ˜¯ç›®å‰å¸¸ç”¨çš„ chrome æµè§ˆå™¨å±è”½äº† go tool trace ä½¿ç”¨çš„ HTML import åŠŸèƒ½ã€‚å³æ‰“å¼€â€œview traceâ€æ—¶ï¼Œä¼šå‡ºç°ä¸€ç‰‡ç©ºç™½ã€‚å¹¶å¯ä»¥åœ¨ console ä¸­çœ‹åˆ°è­¦å‘Šä¿¡æ¯ï¼š</p>

<p>HTML Imports is deprecated and has now been removed as of M80. See https://www.chromestatus.com/features/5144752345317376 and https://developers.google.com/web/updates/2019/07/web-components-time-to-upgrade for more details.
è§£å†³åŠæ³•
ç”³è¯· token
https://developers.chrome.com/origintrials/#/register_trial/2431943798780067841 ç„¶åç™»å½•
web origin å¤„å¡«å†™ http://localhost:8001 ç«¯å£åªèƒ½æ˜¯ 8000 - 8003ï¼Œæ”¯æŒ http å’Œ httpsã€‚ï¼ˆä¹Ÿå¯ä»¥å¡«å†™ 127.0.0.1:8001,ä¾èµ–äºä½ æµè§ˆå™¨ä¸­æ˜¾ç¤ºçš„åœ°å€ï¼Œå¦åˆ™å¯¹ä¸ä¸Šçš„è¯ï¼Œè¿˜è¦æ‰‹åŠ¨æ”¹ä¸€ä¸‹)</p>

<p>ç‚¹å‡»æ³¨å†Œåå³å¯çœ‹åˆ° token
ä¿®æ”¹ trace.go
ç¼–è¾‘${GOROOT}/src/cmd/trace/trace.go æ–‡ä»¶ï¼Œåœ¨æ–‡ä»¶ä¸­æ‰¾åˆ° templTrace ç„¶ååœ¨  æ ‡ç­¾çš„ä¸‹ä¸€è¡Œæ·»åŠ <meta http-equiv="origin-trial" content="ä½ å¤åˆ¶çš„token" />
é‡æ–°ç¼–è¯‘ go
${GOROOT}/src ç›®å½•ï¼Œæ‰§è¡Œ ./all.bash
è‹¥æç¤ºï¼šERROR: Cannot find go1.4\bin\go Set GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4 åˆ™éœ€è¦å…ˆå®‰è£…ä¸€ä¸ª go1.4 çš„ç‰ˆæœ¬ï¼Œå†é€šè¿‡å®ƒæ¥ç¼–è¯‘ goã€‚ï¼ˆä¸‹è½½é“¾æ¥https://dl.google.com/go/go1.4-bootstrap-20171003.tar.gzï¼‰ åœ¨ go1.4/src ä¸‹æ‰§è¡Œ./make.bash. æŒ‡å®š GOROOT_BOOTSTRAP ä¸º go1.4 çš„æ ¹ç›®å½•ã€‚ç„¶åå°±å¯ä»¥é‡æ–°ç¼–è¯‘ go
æŸ¥çœ‹ trace
go tool trace -http=localhost:8001 trace.out</p>

<p>è‹¥æ‰“å¼€ view trace è¿˜æ˜¯ç©ºç™½,åˆ™æ£€æŸ¥ä¸€ä¸‹æµè§ˆå™¨åœ°å€æ ä¸­çš„åœ°å€ï¼Œæ˜¯å¦ä¸æ³¨å†Œæ—¶çš„ä¸€æ ·ã€‚å³æ³¨å†Œç”¨çš„ localhost æˆ– 127.0.0.1 åˆ™åœ°å€æ ä¸­ä¹Ÿè¦ä¸€æ ·ã€‚</p>

<p>å¸¸è§æ€§èƒ½ç“¶é¢ˆ
ä¸šåŠ¡é€»è¾‘
å‡ºç°æ— æ•ˆç”šè‡³é™ä½æ€§èƒ½çš„é€»è¾‘ã€‚å¸¸è§çš„æœ‰</p>

<p>é€»è¾‘é‡å¤ï¼šç›¸åŒçš„æ“ä½œåœ¨ä¸åŒçš„ä½ç½®åšäº†å¤šæ¬¡æˆ–å¾ªç¯è·³å‡ºçš„æ¡ä»¶è®¾ç½®ä¸å½“ã€‚
èµ„æºæœªå¤ç”¨ï¼šå†…å­˜é¢‘ç¹ç”³è¯·å’Œé‡Šæ”¾ï¼Œæ•°æ®åº“é“¾æ¥é¢‘ç¹å»ºç«‹å’Œé”€æ¯ç­‰ã€‚
æ— æ•ˆä»£ç ã€‚
å­˜å‚¨
æœªé€‰æ‹©æ°å½“çš„å­˜å‚¨æ–¹å¼ï¼Œå¸¸è§çš„æœ‰ï¼š</p>

<p>ä¸´æ—¶æ•°æ®å­˜æ”¾åˆ°æ•°æ®åº“ä¸­ï¼Œå¯¼è‡´é¢‘ç¹è¯»å†™æ•°æ®åº“ã€‚
å°†å¤æ‚çš„æ ‘çŠ¶ç»“æ„çš„æ•°æ®ç”¨ SQL æ•°æ®åº“å­˜å‚¨ï¼Œå‡ºç°å¤§é‡å†—ä½™åˆ—ï¼Œå¹¶ä¸”åœ¨è¯»å†™æ—¶è¦è¿›è¡Œæ‹†è§£å’Œæ‹¼æ¥ã€‚
æ•°æ®åº“è¡¨è®¾è®¡ä¸å½“ï¼Œæ— æ³•æœ‰æ•ˆåˆ©ç”¨ç´¢å¼•æŸ¥è¯¢ï¼Œå¯¼è‡´æŸ¥è¯¢æ“ä½œè€—æ—¶é«˜ç”šè‡³å‡ºç°å¤§é‡æ…¢æŸ¥è¯¢ã€‚
çƒ­ç‚¹æ•°æ®æœªä½¿ç”¨ç¼“å­˜ï¼Œå¯¼è‡´æ•°æ®åº“è´Ÿè½½è¿‡é«˜ï¼Œå“åº”é€Ÿåº¦ä¸‹é™ã€‚
å¹¶å‘å¤„ç†
å¹¶å‘æ“ä½œçš„é—®é¢˜ä¸»è¦å‡ºç°åœ¨èµ„æºç«äº‰ä¸Šï¼Œå¸¸è§çš„æœ‰ï¼š</p>

<p>æ­»é”/æ´»é”å¯¼è‡´å¤§é‡é˜»å¡ï¼Œæ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚
èµ„æºç«äº‰æ¿€çƒˆï¼šå¤§é‡çš„çº¿ç¨‹æˆ–åç¨‹æŠ¢å¤ºä¸€ä¸ªé”ã€‚
ä¸´ç•ŒåŒºè¿‡å¤§ï¼šå°†ä¸å¿…è¦çš„æ“ä½œä¹Ÿæ”¾å…¥ä¸´ç•ŒåŒºï¼Œå¯¼è‡´é”çš„é‡Šæ”¾é€Ÿåº¦è¿‡æ…¢ï¼Œå¼•èµ·å…¶ä»–çº¿ç¨‹æˆ–åç¨‹é˜»å¡ã€‚
golang éƒ¨åˆ†ç»†èŠ‚ç®€ä»‹
åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ golang çš„å®ç°ç»†èŠ‚æœ‰ä¸€ä¸ªç®€å•çš„äº†è§£ï¼Œæ‰èƒ½æ˜ç™½å“ªäº›åœ°æ–¹æœ‰é—®é¢˜ï¼Œå“ªäº›åœ°æ–¹å¯ä»¥ä¼˜åŒ–ï¼Œä»¥åŠæ€ä¹ˆä¼˜åŒ–ã€‚ä»¥ä¸‹å†…å®¹çš„è¯¦ç»†è®²è§£å»ºè®®æŸ¥é˜…ç½‘ä¸Šä¼˜ç§€çš„ blogã€‚å¯¹è¯­è¨€çš„åº•å±‚å®ç°æœºåˆ¶æœ€å¥½æœ‰ä¸ªåŸºæœ¬çš„äº†è§£ï¼Œå¦åˆ™æœ‰æ—¶å€™æ‰åˆ°å‘é‡Œéƒ½ä¸çŸ¥é“ä¸ºå•¥ã€‚</p>

<p>åç¨‹è°ƒåº¦
Golang è°ƒåº¦æ˜¯éæŠ¢å å¼å¤šä»»åŠ¡å¤„ç†ï¼Œç”±åç¨‹ä¸»åŠ¨äº¤å‡ºæ§åˆ¶æƒã€‚é‡åˆ°å¦‚ä¸‹æ¡ä»¶æ—¶ï¼Œæ‰æœ‰å¯èƒ½äº¤å‡ºæ§åˆ¶æƒ</p>

<p>I/O,select
channel
ç­‰å¾…é”
å‡½æ•°è°ƒç”¨ï¼ˆæ˜¯ä¸€ä¸ªåˆ‡æ¢çš„æœºä¼šï¼Œæ˜¯å¦ä¼šåˆ‡æ¢ç”±è°ƒåº¦å™¨å†³å®šï¼‰
runtime.Gosched()
å› æ­¤ï¼Œè‹¥å­˜åœ¨è¾ƒé•¿æ—¶é—´çš„ for å¾ªç¯å¤„ç†ï¼Œå¹¶ä¸”å¾ªç¯å†…æ²¡æœ‰ä¸Šè¿°é€»è¾‘æ—¶ï¼Œä¼šé˜»å¡ä½å…¶ä»–çš„åç¨‹è°ƒåº¦ã€‚åœ¨å®é™…ç¼–ç ä¸­ä¸€å®šè¦æ³¨æ„ã€‚</p>

<p>å†…å­˜ç®¡ç†
Go ä¸ºæ¯ä¸ªé€»è¾‘å¤„ç†å™¨ï¼ˆPï¼‰æä¾›äº†ä¸€ä¸ªç§°ä¸ºmcacheçš„æœ¬åœ°å†…å­˜çº¿ç¨‹ç¼“å­˜ã€‚æ¯ä¸ª mcache ä¸­æŒæœ‰ 67 ä¸ªçº§åˆ«çš„ mspanã€‚æ¯ä¸ª msapn åˆåŒ…å«ä¸¤ç§ï¼šscanï¼ˆåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰å’Œ noscanï¼ˆä¸åŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ï¼‰ã€‚åœ¨è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼ŒGC æ— éœ€éå† noscan å¯¹è±¡ã€‚</p>

<p>GC å¤„ç†
GC çš„å·¥ä½œå°±æ˜¯ç¡®å®šå“ªäº›å†…å­˜å¯ä»¥é‡Šæ”¾ï¼Œå®ƒæ˜¯é€šè¿‡æ‰«æå†…å­˜æŸ¥æ‰¾å†…å­˜åˆ†é…çš„æŒ‡é’ˆæ¥å®Œæˆè¿™ä¸ªå·¥ä½œçš„ã€‚GC è§¦å‘æ—¶æœºï¼š</p>

<p>åˆ°è¾¾å †é˜ˆå€¼ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨å †å¤§å°åŠ å€æ—¶è¿è¡Œï¼Œå¯é€šè¿‡ GOGC æ¥è®¾å®šæ›´é«˜é˜ˆå€¼ï¼ˆä¸å»ºè®®å˜æ›´æ­¤é…ç½®ï¼‰
åˆ°è¾¾æ—¶é—´é˜ˆå€¼ï¼šæ¯ä¸¤åˆ†é’Ÿä¼šå¼ºåˆ¶å¯åŠ¨ä¸€æ¬¡ GC å¾ªç¯
ä¸ºå•¥è¦æ³¨æ„ GCï¼Œæ˜¯å› ä¸º GC æ—¶å‡ºç° 2 æ¬¡ Stop the worldï¼Œå³åœæ­¢æ‰€æœ‰åç¨‹ï¼Œè¿›è¡Œæ‰«ææ“ä½œã€‚è‹¥æ˜¯ GC è€—æ—¶é«˜ï¼Œåˆ™ä¼šä¸¥é‡å½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚</p>

<p>å˜é‡é€ƒé€¸
æ³¨æ„ï¼Œgolang ä¸­çš„æ ˆæ˜¯è·Ÿå‡½æ•°ç»‘å®šçš„ï¼Œå‡½æ•°ç»“æŸæ—¶æ ˆè¢«å›æ”¶ã€‚
å˜é‡å†…å­˜å›æ”¶ï¼š
å¦‚æœåˆ†é…åœ¨æ ˆä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯è‡ªåŠ¨å°†å†…å­˜å›æ”¶ï¼›</p>

<p>å¦‚æœåˆ†é…åœ¨å †ä¸­ï¼Œåˆ™å‡½æ•°æ‰§è¡Œç»“æŸå¯äº¤ç»™ GCï¼ˆåƒåœ¾å›æ”¶ï¼‰å¤„ç†ï¼›</p>

<p>è€Œå˜é‡é€ƒé€¸å°±æ„å‘³ç€å¢åŠ äº†å †ä¸­çš„å¯¹è±¡ä¸ªæ•°ï¼Œå½±å“ GC è€—æ—¶ã€‚ä¸€èˆ¬è¦å°½é‡é¿å…é€ƒé€¸ã€‚</p>

<p>é€ƒé€¸åˆ†æä¸å˜æ€§ï¼š
æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½å­˜åœ¨äºå †ä¸­ï¼›
æŒ‡å‘æ ˆå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½åœ¨æ ˆå¯¹è±¡å›æ”¶åå­˜æ´»ï¼›
åœ¨é€ƒé€¸åˆ†æè¿‡ç¨‹ä¸­ï¼Œå‡¡æ˜¯å‘ç°å‡ºç°è¿åä¸Šè¿°çº¦å®šçš„å˜é‡ï¼Œå°±å°†å…¶ç§»åˆ°å †ä¸­ã€‚</p>

<p>é€ƒé€¸å¸¸è§çš„æƒ…å†µï¼š
æŒ‡é’ˆé€ƒé€¸ï¼šè¿”å›å±€éƒ¨å˜é‡çš„åœ°å€ï¼ˆä¸å˜æ€§ 2ï¼‰
æ ˆç©ºé—´ä¸è¶³
åŠ¨æ€ç±»å‹é€ƒé€¸ï¼šå¦‚ fmt.Sprintf,json.Marshel ç­‰æ¥å—å˜é‡ä¸ºâ€¦interface{}å‡½æ•°çš„è°ƒç”¨ï¼Œä¼šå¯¼è‡´ä¼ å…¥çš„å˜é‡é€ƒé€¸ã€‚
é—­åŒ…å¼•ç”¨
åŒ…å«æŒ‡é’ˆç±»å‹çš„åº•å±‚ç»“æ„
string
type StringHeader struct {
 Data uintptr
 Len  int
}
slice
type SliceHeader struct {
 Data uintptr
 Len  int
 Cap  int
}
map
type hmap struct {
 count     int
 flags     uint8
 B         uint8
 noverflow uint16
 hash0     uint32
 buckets    unsafe.Pointer
 oldbuckets unsafe.Pointer
 nevacuate  uintptr
 extra *mapextra
}
è¿™äº›æ˜¯å¸¸è§ä¼šåŒ…å«æŒ‡é’ˆçš„å¯¹è±¡ã€‚å°¤å…¶æ˜¯ stringï¼Œåœ¨åå°åº”ç”¨ä¸­å¤§é‡å‡ºç°ã€‚å¹¶ç»å¸¸ä¼šä½œä¸º map çš„ key æˆ– valueã€‚è‹¥æ•°æ®é‡è¾ƒå¤§æ—¶ï¼Œå°±ä¼šå¼•å‘ GC è€—æ—¶ä¸Šå‡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° string å’Œ slice éå¸¸ç›¸ä¼¼ï¼Œä»æŸç§æ„ä¹‰ä¸Šè¯´å®ƒä»¬ä¹‹é—´æ˜¯å¯ä»¥ç›´æ¥äº’ç›¸è½¬æ¢çš„ã€‚è¿™å°±å¯ä»¥é¿å… string å’Œ[]byte ä¹‹é—´ç±»å‹è½¬æ¢æ—¶ï¼Œè¿›è¡Œå†…å­˜æ‹·è´</p>

<p>ç±»å‹è½¬æ¢ä¼˜åŒ–
func String(b []byte) string {
 return <em>(</em>string)(unsafe.Pointer(&amp;b))
}
func Str2Bytes(s string) []byte {
 x := (<em>[2]uintptr)(unsafe.Pointer(&amp;s))
 h := [3]uintptr{x[0], x[1], x[1]}
 return *(</em>[]byte)(unsafe.Pointer(&amp;h))
}
æ€§èƒ½æµ‹è¯•æ–¹å¼
æœ¬åœ°æµ‹è¯•
å°†æœåŠ¡å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œä½¿ç”¨ go test çš„ benchmark åŠ  pprof æ¥æµ‹è¯•ã€‚å»ºè®®ä¸Šçº¿å‰ï¼Œå°±å¯¹æ•´ä¸ªä¸šåŠ¡é€»è¾‘çš„æ€§èƒ½è¿›è¡Œæµ‹è¯•ï¼Œæå‰ä¼˜åŒ–ç“¶é¢ˆã€‚</p>

<p>çº¿ä¸Šæµ‹è¯•
ä¸€èˆ¬ http æœåŠ¡å¯ä»¥é€šè¿‡å¸¸è§çš„æµ‹è¯•å·¥å…·è¿›è¡Œå‹æµ‹ï¼Œå¦‚ wrkï¼Œlocust ç­‰ã€‚taf æœåŠ¡åˆ™éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ä¸€äº›æµ‹è¯•è„šæœ¬ã€‚åŒæ—¶ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œå‹æµ‹çš„ç›®çš„æ˜¯å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ï¼Œè€Œä¸æ˜¯ç›²ç›®çš„é«˜å¹¶å‘è¯·æ±‚æµ‹è¯•ã€‚å› æ­¤ï¼Œä¸€èˆ¬éœ€è¦é€æ­¥æå‡å¹¶å‘è¯·æ±‚æ•°é‡ï¼Œæ¥å®šä½å‡ºæœåŠ¡çš„æœ€ä½³æ€§èƒ½ç‚¹ã€‚</p>

<p>æ³¨æ„ï¼šç”±äº taf å¹³å°å…·å¤‡æ‰©å®¹åŠŸèƒ½ï¼Œå› æ­¤ä¸ºäº†æ›´å‡†ç¡®çš„æµ‹è¯•ï¼Œæˆ‘ä»¬åº”è¯¥åœ¨æµ‹è¯•å‰å…³é—­è¦æµ‹è¯•èŠ‚ç‚¹çš„è‡ªåŠ¨æ‰©å®¹ã€‚
å®é™…é¡¹ç›®ä¼˜åŒ–
ä¸ºäº†é¿å…å½±å“åç«¯æœåŠ¡ï¼Œä¹Ÿä¸ºäº†é¿å…åç«¯æœåŠ¡å½±å“ç½‘å…³è‡ªèº«ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å‹æµ‹å‰ï¼Œå°†å¯¹åç«¯æœåŠ¡çš„è°ƒç”¨å±è”½ã€‚</p>

<p>æµ‹è¯•å‡†å¤‡ï¼šå±è”½è¿œç¨‹è°ƒç”¨ï¼šä¸‹æ¸¸æœåŠ¡è°ƒç”¨ï¼Œå¥åº·åº¦ä¸ŠæŠ¥ï¼Œç»Ÿè®¡ä¸ŠæŠ¥ï¼Œè¿œç¨‹æ—¥å¿—ã€‚ä»¥ä¾¿å…³æ³¨ç½‘å…³è‡ªèº«æ€§èƒ½ã€‚
QPS ç°çŠ¶
é¦–å…ˆçœ‹ä¸‹å½“å‰ä¸šåŠ¡çš„æ€§èƒ½æŒ‡æ ‡ï¼Œä½¿ç”¨ wrk å‹æµ‹ç½‘å…³æœåŠ¡</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ€»é“¾æ¥æ•°ä¸º 70 çš„æ—¶å€™ï¼ŒQPS æœ€é«˜ï¼Œä¸º 13245ã€‚</p>

<p>ç«ç„°å›¾</p>

<p>æ ¹æ®ç«ç„°å›¾æˆ‘ä»¬å®šä½å‡º cpu å æ¯”è¾ƒé«˜çš„å‡ ä¸ªæ–¹æ³•ä¸ºï¼š</p>

<p>json.Marshal
json.Unmarshal
rogger.Infof
ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå°†ä»£ç æ”¹ä¸ºæœ¬åœ°è¿è¡Œï¼Œå¹¶é€šè¿‡ benchmark çš„æ–¹å¼æ¥å¯¹æ¯”ä¿®æ”¹å‰åçš„å·®å¼‚ã€‚</p>

<p>ç”±äºæ­£å¼ç¯å¢ƒä½¿ç”¨çš„ golang ç‰ˆæœ¬ä¸º 1.12ï¼Œå› æ­¤æœ¬åœ°æµ‹è¯•æ—¶ï¼Œä¹Ÿè¦ä½¿ç”¨åŒæ ·çš„ç‰ˆæœ¬ã€‚
benchmark
Benchmark   	50000000	      3669 ns/op	    4601 B/op	      73 allocs/op
æŸ¥çœ‹ cpu å’Œ memory çš„ profileï¼Œå‘ç°å¥åº·åº¦ä¸ŠæŠ¥çš„æ•°æ®ç»“æ„å¡«å……å æ¯”è¾ƒé«˜ã€‚è¿™éƒ¨åˆ†é€»è¾‘åŸºäº tars æ¡†æ¶å®ç°ã€‚æš‚æ—¶å¿½ç•¥ï¼Œä¸ºé¿å…å½±å“å…¶ä»–æµ‹è¯•ï¼Œå…ˆæ³¨é‡Šæ‰ã€‚å†çœ‹çœ‹ benchmarkã€‚</p>

<p>Benchmark   	  500000	      3146 ns/op	    2069 B/op	      55 allocs/op
ä¼˜åŒ–ç­–ç•¥
JSON ä¼˜åŒ–
å…ˆæŸ¥çœ‹ json è§£æçš„éƒ¨åˆ†ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä¼˜åŒ–ç©ºé—´</p>

<p>è¯·æ±‚å¤„ç†
//RootHandle view.ReadReq2Json readJsonReq ä¸­è¿›è¡Œjsonè§£æ
type GatewayReqBody struct {
 Header  GatewayReqBodyHeader   <code class="language-plaintext highlighter-rouge">json:"header"</code>
 Payload map[string]interface{} <code class="language-plaintext highlighter-rouge">json:"payload"</code>
}
func readJsonReq(data []byte, req *model.GatewayReqBody) error {
 dataMap := make(map[string]interface{})
 err := jsoniter.Unmarshal(data, &amp;dataMap)
 â€¦
  headerMap, ok := header.(map[string]interface{})
  businessName, ok := headerMap[â€œbusinessNameâ€]
  qua, ok := headerMap[â€œquaâ€]
  sessionId, ok := headerMap[â€œsessionIdâ€]
  â€¦
  payload, ok := dataMap[â€œpayloadâ€]
  req.Payload, ok = payload.(map[string]interface{})
}
è¿™ä¸ªå‡½æ•°æœ¬è´¨ä¸Šå°† data è§£æä¸º model.GatewayReqBody ç±»å‹çš„ç»“æ„ä½“ã€‚ä½†æ˜¯è¿™é‡Œå´å­˜åœ¨ 2 ä¸ªé—®é¢˜</p>

<p>ä½¿ç”¨äº†å¤æ‚çš„è§£ææ–¹å¼ï¼Œå…ˆå°† data è§£æä¸º mapï¼Œå†é€šè¿‡æ¯ä¸ªå­—æ®µçš„åå­—æ¥å–å€¼ï¼Œå¹¶è¿›è¡Œç±»å‹è½¬æ¢ã€‚
Req.Playload è§£æä¸ºä¸€ä¸ª mapã€‚ä½†åˆæœªä½¿ç”¨ã€‚æˆ‘ä»¬çœ‹çœ‹åé¢è¿™ä¸ª payload æ˜¯ç”¨æ¥åšå•¥ã€‚ç¡®è®¤æ˜¯å¦ä¸ºæ— æ•ˆä»£ç ã€‚
func invokeTafServant(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq) {
 â€¦
  payloadBytes, err := json.Marshal(gatewayHttpReq.ReqBody.Payload)
 if err == nil {
  commonReq.Payload = string(payloadBytes)
 } else {
  responseData(gatewayHttpReq, StatusInternalServerError, â€œå°è£…jsonå¼‚å¸¸â€, â€œâ€, resp)
  return
 }
  â€¦
 }
åç»­çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåˆå°†è¿™ä¸ª payload è½¬ä¸º stringã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®å®šï¼Œä¸Šé¢çš„ json è§£ææ˜¯æ²¡æœ‰æ„ä¹‰ï¼ŒåŒæ—¶ä¹Ÿä¼šæµªè´¹èµ„æºï¼ˆpayload æ•°æ®é‡ä¸€èˆ¬ä¸å°ï¼‰ã€‚</p>

<p>ä¼˜åŒ–æ–¹æ³•
golang è‡ªå¸¦çš„ json è§£ææ€§èƒ½è¾ƒä½ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ›¿æ¢ä¸ºgithub.com/json-iteratoræ¥æå‡æ€§èƒ½</p>

<p>åœ¨ golang ä¸­ï¼Œé‡åˆ°ä¸éœ€è¦è§£æçš„ json æ•°æ®ï¼Œå¯ä»¥å°†å…¶ç±»å‹å£°æ˜ä¸ºjson.RawMessage. å³ï¼Œå¯ä»¥å°†ä¸Šè¿° 2 ä¸ªæ–¹æ³•ä¼˜åŒ–ä¸º</p>

<p>type GatewayReqBody struct {
 Header  GatewayReqBodyHeader <code class="language-plaintext highlighter-rouge">json:"header"</code>
 Payload json.RawMessage      <code class="language-plaintext highlighter-rouge">json:"payload"</code>
}
func readJsonReq(data []byte, req *model.GatewayReqBody) error {
 err := jsoniter.Unmarshal(data, req)
 if err != nil {
  return jsonParseErr
 }
 for k, v := range req.Header.Qua {
  req.Header.Qua[k] = v
  if len(req.Header.QuaStr) == 0 {
   req.Header.QuaStr = k + â€œ=â€ + v
  } else {
   req.Header.QuaStr += â€œ&amp;â€ + k + â€œ=â€ + v
  }
 }
 return nil
}
func invokeTafServant(resp http.ResponseWriter, gatewayHttpReq *model.GatewayHttpReq) {
 commonReq.Payload = string(gatewayHttpReq.ReqBody.Payload)
}
è¿™é‡Œæ³¨æ„ï¼å‡ºç°äº† string å’Œ[]byte ä¹‹é—´çš„ç±»å‹è½¬æ¢.ä¸ºäº†é¿å…å†…å­˜æ‹·è´ï¼Œè¿™é‡Œå°† string()æ”¹ä¸ºä¸Šé¢çš„ç±»å‹è½¬æ¢ä¼˜åŒ–ä¸­æ‰€å®šä¹‰çš„è½¬æ¢å‡½æ•°ï¼Œå³commonReq.Payload = encode.String(gatewayHttpReq.ReqBody.Payload)
å›åŒ…å¤„ç†
type GatewayRespBody struct {
 Header  GatewayRespBodyHeader  <code class="language-plaintext highlighter-rouge">json:"header"</code>
 Payload map[string]interface{} <code class="language-plaintext highlighter-rouge">json:"payload"</code>
}</p>

<p>func responseData(gatewayReq *model.GatewayHttpReq, code int32, message string, payload string, resp http.ResponseWriter) {
 jsonPayload := make(map[string]interface{})</p>

<p>if len(payload) != 0 {
  err := json.Unmarshal([]byte(payload), &amp;jsonPayload)
  if err != nil {
   â€¦
  }
 }</p>

<p>body := model.GatewayRespBody{
  Header: model.GatewayRespBodyHeader{
   Code:    code,
   Message: message,
  },
  Payload: jsonPayload,
 }
  data, err := view.RenderResp(â€œjsonâ€, &amp;body)
  â€¦
  resp.WriteHeader(http.StatusOK)
 resp.Write(data)
}
åŒæ ·çš„ï¼Œè¿™é‡Œçš„ jsonPayloadï¼Œä¹Ÿæ˜¯å‡ºç°äº†ä¸å¿…è¦çš„ json è§£æã€‚æˆ‘ä»¬å¯ä»¥æ”¹ä¸º</p>

<p>type GatewayRespBody struct {
 Header  GatewayRespBodyHeader  <code class="language-plaintext highlighter-rouge">json:"header"</code>
 Payload json.RawMessage <code class="language-plaintext highlighter-rouge">json:"payload"</code>
}</p>

<p>body := model.GatewayRespBody{
  Header: model.GatewayRespBodyHeader{
   Code:    code,
   Message: message,
  },
  Payload: encode.Str2Bytes(payload),
 }
ç„¶ååœ¨ view.RenderResp æ–¹æ³•ä¸­</p>

<p>func RenderResp(format string, resp interface{}) ([]byte, error) {
 if â€œjsonâ€ == format {
  return jsoniter.Marshal(resp)
 }
 return nil, errors.New(â€œformat errorâ€)
}
benchmark
Benchmark   	  500000	      3326 ns/op	    2842 B/op	      50 allocs/op
è™½ç„¶å¯¹è±¡ alloc å‡å°‘äº†ï¼Œä½†å•æ¬¡æ“ä½œå†…å­˜ä½¿ç”¨å¢åŠ äº†ï¼Œä¸”æ€§èƒ½ä¸‹é™äº†ã€‚è¿™å°±æœ‰ç‚¹å¥‡æ€ªäº†ã€‚æˆ‘ä»¬æ¥å¯¹æ¯”ä¸€ä¸‹ 2 ä¸ªæƒ…å†µä¸‹çš„ pprofã€‚</p>

<p>é€ƒé€¸åˆ†æåŠå¤„ç†
go tool pprof -base
cpu å·®å¼‚</p>

<p>flat  flat%   sum%        cum   cum%
     0.09s  1.17%  1.17%      0.40s  5.20%  runtime.mallocgc
     0.01s  0.13%  1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(<em>Iterator).readObjectStart
         0     0%  1.30%      0.35s  4.55%  /vendor/github.com/json-iterator/go.(</em>twoFieldsStructDecoder).Decode
mem å·®å¼‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  flat  flat%   sum%        cum   cum%   478.96MB 20.33% 20.33%   279.94MB 11.88%  gateway.RootHandle
     0     0% 20.33%   279.94MB 11.88%  command-line-arguments.BenchmarkTestHttp.func1
     0     0% 20.33%   279.94MB 11.88%  testing.(*B).RunParallel.func1 å¯ä»¥çœ‹å‡º RootHandle å¤šäº† 478.96M çš„å†…å­˜ä½¿ç”¨ã€‚é€šè¿‡ list RootHandle å¯¹æ¯” 2 ä¸ªæƒ…å†µä¸‹çš„å†…å­˜ä½¿ç”¨ã€‚å‘ç°ä¿®æ”¹åçš„ RootHandle ä¸­å¤šå‡ºäº†è¿™ä¸€è¡Œï¼š475.46MB 475.46MB 158: gatewayHttpReq := model.GatewayHttpReq{} è¿™ä¸€èˆ¬æ„å‘³ç€å˜é‡ gatewayHttpReq å‡ºç°äº†é€ƒé€¸ã€‚
</code></pre></div></div>

<p>go build -gcflags â€œ-m -mâ€ gateway/*.go</p>

<p>gateway/logic.go:270:26: &amp;gatewayHttpReq escapes to heap
å¯ä»¥çœ‹åˆ°ç¡®å®å‡ºç°äº†é€ƒé€¸ã€‚è¿™ä¸ªå¯¹åº”çš„ä»£ç ä¸ºerr = view.ReadReq2Json(&amp;gatewayHttpReq),è€Œé€ æˆé€ƒé€¸çš„æœ¬è´¨æ˜¯å› ä¸ºä¸Šé¢æ”¹åŠ¨äº†å‡½æ•° readJsonReqï¼ˆåŠ¨æ€ç±»å‹é€ƒé€¸ï¼Œå³å‡½æ•°å‚æ•°ä¸º interface ç±»å‹ï¼Œæ— æ³•åœ¨ç¼–è¯‘æ—¶ç¡®å®šå…·ä½“ç±»å‹çš„ï¼‰</p>

<p>func readJsonReq(data []byte, req *model.GatewayReqBody) error {
 err := jsoniter.Unmarshal(data, req)
 â€¦
}
å› æ­¤ï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ä¸€ä¸‹ï¼Œæ”¹ä¸º</p>

<p>func readJsonReq(data []byte, req *model.GatewayReqBody) error {
	var tmp model.GatewayReqBody
	err := jsoniter.Unmarshal(data, &amp;tmp)
	â€¦
}
benchmark
Benchmark   	  500000	      2994 ns/op	    1892 B/op	      50 allocs/op
å¯ä»¥çœ‹åˆ°å †å†…å­˜ä½¿ç”¨æ˜æ˜¾ä¸‹é™ã€‚æ€§èƒ½ä¹Ÿæå‡äº†ã€‚å†çœ‹ä¸€ä¸‹ pprofï¼Œå¯»æ‰¾ä¸‹ä¸ªç“¶é¢ˆã€‚</p>

<p>cpu profile</p>

<p>æŠ›å¼€ responeseData(ä»–å†…éƒ¨ä¸»è¦æ˜¯æ—¥å¿—æ‰“å°å æ¯”é«˜ï¼‰ï¼Œå æ¯”è¾ƒé«˜çš„ä¸º util.GenerateSessionIdï¼Œå…ˆæ¥çœ‹çœ‹è¿™ä¸ªæ€ä¹ˆä¼˜åŒ–ã€‚</p>

<p>éšæœºå­—ç¬¦ä¸²ç”Ÿæˆ
var letterRunes = []rune(â€œ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZâ€)
func RandStringRunes(n int) string {
 b := make([]rune, n)
 for i := range b {
  b[i] = letterRunes[rand.Intn(len(letterRunes))]
 }
 return string(b)
}
ç›®å‰çš„ç”Ÿæˆæ–¹å¼ä½¿ç”¨çš„ç±»å‹æ˜¯ runeï¼Œä½†å…¶å®ç”¨ byte å°±å¤Ÿäº†ã€‚å¦å¤–ï¼ŒletterRunes æ˜¯ 62 ä¸ªå­—ç¬¦ï¼Œå³æœ€å¤§éœ€è¦ 6 ä½çš„ index å°±å¯ä»¥éå†å®Œæˆäº†ã€‚è€Œéšæœºæ•°è·å–çš„æ˜¯ 63 ä½ã€‚å³æ¯ä¸ªéšæœºæ•°ï¼Œå…¶å®å¯ä»¥äº§ç”Ÿ 10 ä¸ªéšæœºå­—ç¬¦ã€‚è€Œä¸ç”¨æ¯ä¸ªå­—ç¬¦éƒ½è·å–ä¸€æ¬¡éšæœºæ•°ã€‚æ‰€ä»¥æˆ‘ä»¬æ”¹ä¸º</p>

<p>const (
 letterBytes   = â€œ0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZâ€
 letterIdxBits = 6
 letterIdxMask = 1Â«letterIdxBits - 1
 letterIdxMax  = 63 / letterIdxBits
)
func RandStringRunes(n int) string {
 b := make([]byte, n)
 for i, cache, remain := n-1, rand.Int63(), letterIdxMax; i &gt;= 0; {
  if remain == 0 {
   cache, remain = rand.Int63(), letterIdxMax
  }
  if idx := int(cache &amp; letterIdxMask); idx &lt; len(letterBytes) {
   b[i] = letterBytes[idx]
   iâ€“
  }
  cacheÂ Â»= letterIdxBits
  remainâ€“
 }
 return string(b)
}
benchmark
Benchmark   	 1000000	      1487 ns/op	    1843 B/op	      50 allocs/op
ç±»å‹è½¬æ¢åŠå­—ç¬¦ä¸²æ‹¼æ¥
ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½ä¼šè¯´å°† string å’Œ[]byte çš„è½¬æ¢æ”¹ä¸º unsafeï¼›ä»¥åŠåœ¨å­—ç¬¦ä¸²æ‹¼æ¥æ—¶ï¼Œç”¨ byte.Buffer ä»£æ›¿ fmt.Sprintfã€‚ä½†æ˜¯ç½‘å…³è¿™é‡Œçš„æƒ…å†µæ¯”è¾ƒç‰¹æ®Šï¼Œå­—ç¬¦ä¸²çš„æ“ä½œåŸºæœ¬é›†ä¸­åœ¨æ‰“å°æ—¥å¿—çš„æ“ä½œã€‚è€Œ tars çš„æ—¥å¿—æ‰“å°æœ¬èº«å°±æ˜¯é€šè¿‡ byte.Buffer æ‹¼æ¥çš„ã€‚æ‰€ä»¥è¿™å¯ä»¥é¿å…ã€‚å¦å¤–ï¼Œç”±äºæ—¥å¿—æ‰“å°é‡å¤§ï¼Œä½¿ç”¨ unsafe è½¬æ¢[]byte ä¸º string å¸¦æ¥çš„æ”¶ç›Šï¼Œå¾€å¾€ä¼šå› ä¸ºé€ƒé€¸ä»è€Œå½±å“ GCï¼Œåæ­£ä¼šå½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œä¸åŒçš„åœºæ™¯ä¸‹ï¼Œä¸èƒ½ç®€å•çš„å¥—ç”¨ä¸€äº›ä¼˜åŒ–æ–¹æ³•ã€‚éœ€è¦é€šè¿‡å‹æµ‹åŠç»“æœåˆ†ææ¥åˆ¤æ–­å…·ä½“çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>

<p>ä¼˜åŒ–ç»“æœ</p>

<p>å¯ä»¥çœ‹åˆ°ä¼˜åŒ–åï¼Œæœ€å¤§é“¾æ¥æ•°ä¸º 110ï¼Œæœ€é«˜ QPS ä¸º21153.35ã€‚å¯¹æ¯”ä¹‹å‰çš„13245ï¼Œå¤§çº¦æå‡ 60%ã€‚</p>

<p>åç»­
ä» pprof ä¸­å¯ä»¥çœ‹åˆ°æ—¥å¿—æ‰“å°ï¼Œè¿œç¨‹æ—¥å¿—ï¼Œå¥åº·ä¸ŠæŠ¥ç­‰ä¿¡æ¯å ç”¨è¾ƒå¤š cpu èµ„æºï¼Œä¸”å¯¼è‡´å¤šä¸ªæ•°æ®é€ƒé€¸ï¼ˆå°¤å…¶æ˜¯æ—¥å¿—æ‰“å°ï¼‰ã€‚è¿‡å¤šçš„æ—¥å¿—åŸºæœ¬ç­‰äºæ²¡æœ‰æ—¥å¿—ã€‚åç»­å¯è€ƒè™‘è£å‰ªæ—¥å¿—ï¼Œä»…ä¿ç•™å‡ºé”™æ—¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</p>

<p>æ€»ç»“
æ€§èƒ½æŸ¥çœ‹å·¥å…· pprof,trace åŠå‹æµ‹å·¥å…· wrk æˆ–å…¶ä»–å‹æµ‹å·¥å…·çš„ä½¿ç”¨è¦æ¯”è¾ƒäº†è§£ã€‚
ä»£ç é€»è¾‘å±‚é¢çš„èµ°è¯»éå¸¸é‡è¦ï¼Œè¦å°½é‡é¿å…æ— æ•ˆé€»è¾‘ã€‚
å¯¹äº golang è‡ªèº«åº“å­˜åœ¨ç¼ºé™·çš„ï¼Œå¯ä»¥å¯»æ‰¾ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå·±æ”¹é€ ã€‚
golang ç‰ˆæœ¬å°½é‡æ›´æ–°ï¼Œè¿™æ¬¡çš„æµ‹è¯•æ˜¯åœ¨ golang1.12 ä¸‹è¿›è¡Œçš„ã€‚è€Œ go1.13 ç”šè‡³ go1.14 åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œäº†æ”¹è¿›ã€‚æ¯”å¦‚ fmt.Sprintfï¼Œsync.Pool ç­‰ã€‚æ›¿æ¢æˆæ–°ç‰ˆæœ¬åº”è¯¥èƒ½è¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚
æœ¬åœ° benchmark ç»“æœä¸ç­‰äºçº¿ä¸Šè¿è¡Œç»“æœã€‚å°¤å…¶æ˜¯åœ¨ä½¿ç”¨ç¼“å­˜æ¥æé«˜å¤„ç†é€Ÿåº¦æ—¶ï¼Œè¦è€ƒè™‘ GC çš„å½±å“ã€‚
ä¼ å‚æ•°æˆ–è¿”å›å€¼æ—¶ï¼Œå°½é‡æŒ‰ golang çš„è®¾è®¡å“²å­¦ï¼Œå°‘ç”¨æŒ‡é’ˆï¼Œå¤šç”¨å€¼å¯¹è±¡ï¼Œé¿å…å¼•èµ·è¿‡å¤šçš„å˜é‡é€ƒé€¸ï¼Œå¯¼è‡´ GC è€—æ—¶æš´æ¶¨ã€‚struct çš„å¤§å°ä¸€èˆ¬åœ¨ 2K ä»¥ä¸‹çš„æ‹·è´ä¼ å€¼ï¼Œæ¯”ä½¿ç”¨æŒ‡é’ˆè¦å¿«ï¼ˆå¯é’ˆå¯¹ä¸åŒçš„æœºå™¨å‹æµ‹ï¼Œåˆ¤æ–­å„è‡ªçš„é˜ˆå€¼)ã€‚
å€¼ç±»å‹åœ¨æ»¡è¶³éœ€è¦çš„æƒ…å†µä¸‹ï¼Œè¶Šå°è¶Šå¥½ã€‚èƒ½ç”¨ int8ï¼Œå°±ä¸è¦ç”¨ int64ã€‚
èµ„æºå°½é‡å¤ç”¨,åœ¨ golang1.13 ä»¥ä¸Šï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ sync.Pool ç¼“å­˜ä¼šé‡å¤ç”³è¯·çš„å†…å­˜æˆ–å¯¹è±¡ã€‚æˆ–è€…è‡ªå·±ä½¿ç”¨å¹¶ç®¡ç†å¤§å—å†…å­˜ï¼Œç”¨æ¥å­˜å‚¨å°å¯¹è±¡ï¼Œé¿å… GC å½±å“ï¼ˆå¦‚æœ¬åœ°ç¼“å­˜çš„åœºæ™¯)ã€‚</p>
:ET