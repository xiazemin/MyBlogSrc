I"Nµ<!-- more -->
<p>1.ä¸ºä»€ä¹ˆé€‰æ‹©Netty
Socketé€šä¿¡ï¼ˆIO/NIO/AIOï¼‰ç¼–ç¨‹ä»…ä»…æ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œå¦‚æœæƒ³æŠŠè¿™äº›çœŸæ­£çš„ç”¨äºå®é™…å·¥ä½œä¸­ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ä¸æ–­çš„å®Œå–„ã€æ‰©å±•å’Œä¼˜åŒ–ã€‚æ¯”å¦‚ç»å…¸çš„TCPè¯»åŒ…å†™åŒ…é—®é¢˜ï¼Œæˆ–è€…æ˜¯æ•°æ®æ¥æ”¶çš„å¤§å°ï¼Œå®é™…çš„é€šä¿¡å¤„ç†ä¸åº”ç­”çš„å¤„ç†é€»è¾‘ç­‰ç­‰ä¸€äº›ç»†èŠ‚é—®é¢˜éœ€è¦è®¤çœŸçš„å»æ€è€ƒï¼Œè€Œè¿™äº›éƒ½éœ€è¦å¤§é‡çš„æ—¶é—´å’Œç»å†ï¼Œä»¥åŠä¸°å¯Œçš„ç»éªŒã€‚æ‰€ä»¥æƒ³å­¦å¥½Socketé€šä¿¡ä¸æ˜¯ä»¶å®¹æ˜“äº‹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¥å­¦ä¹ ä¸€ä¸‹æ–°çš„æŠ€æœ¯Nettyï¼Œä¸ºä»€ä¹ˆä¼šé€‰æ‹©Nettyï¼Ÿå› ä¸ºå®ƒç®€å•ï¼ä½¿ç”¨Nettyä¸å¿…ç¼–å†™å¤æ‚çš„é€»è¾‘ä»£ç å»å®ç°é€šä¿¡ï¼Œå†ä¹Ÿä¸éœ€è¦å»è€ƒè™‘æ€§èƒ½é—®é¢˜ï¼Œä¸éœ€è¦è€ƒè™‘ç¼–ç é—®é¢˜ï¼ŒåŠåŒ…è¯»å†™ç­‰é—®é¢˜ã€‚å¼ºå¤§çš„Nettyå·²ç»å¸®æˆ‘ä»¬å®ç°å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨å³å¯ã€‚</p>

<p>Nettyæ˜¯æœ€æµè¡Œçš„NIOæ¡†æ¶ï¼Œå®ƒçš„å¥å£®æ€§ã€åŠŸèƒ½ã€æ€§èƒ½ã€å¯å®šåˆ¶æ€§å’Œå¯æ‰©å±•æ€§åœ¨åŒç±»æ¡†æ¶éƒ½æ˜¯é¦–å±ˆä¸€æŒ‡çš„ã€‚å®ƒå·²ç»å¾—åˆ°æˆç™¾ä¸Šåƒçš„å•†ä¸š/å•†ç”¨é¡¹ç›®éªŒè¯ï¼Œå¦‚Hadoopçš„RPCæ¡†æ¶Avroã€RocketMQä»¥åŠä¸»æµçš„åˆ†å¸ƒå¼é€šä¿¡æ¡†æ¶Dubboxç­‰ç­‰ã€‚</p>

<p>2.Nettyç®€ä»‹</p>

<p>Nettyæ˜¯åŸºäºJava NIO client-serverçš„ç½‘ç»œåº”ç”¨æ¡†æ¶ï¼Œä½¿ç”¨Nettyå¯ä»¥å¿«é€Ÿå¼€å‘ç½‘ç»œåº”ç”¨ï¼Œä¾‹å¦‚æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åè®®ã€‚Nettyæä¾›äº†ä¸€ç§æ–°çš„æ–¹å¼æ¥å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œè¿™ç§æ–°çš„æ–¹å¼ä½¿å®ƒå¾ˆå®¹æ˜“ä½¿ç”¨å’Œå…·æœ‰å¾ˆå¼ºçš„æ‰©å±•æ€§ã€‚Nettyçš„å†…éƒ¨å®ç°æ˜¯å¾ˆå¤æ‚çš„ï¼Œä½†æ˜¯Nettyæä¾›äº†ç®€å•æ˜“ç”¨çš„APIä»ç½‘ç»œå¤„ç†ä»£ç ä¸­è§£è€¦ä¸šåŠ¡é€»è¾‘ã€‚Nettyæ˜¯å®Œå…¨åŸºäºNIOå®ç°çš„ï¼Œæ‰€ä»¥æ•´ä¸ªNettyéƒ½æ˜¯å¼‚æ­¥çš„ã€‚</p>

<p>ç½‘ç»œåº”ç”¨ç¨‹åºé€šå¸¸éœ€è¦æœ‰è¾ƒé«˜çš„å¯æ‰©å±•æ€§ï¼Œæ— è®ºæ˜¯Nettyè¿˜æ˜¯å…¶ä»–çš„åŸºäºJava Nioçš„æ¡†æ¶ï¼Œéƒ½ä¼šæä¾›å¯æ‰©å±•æ€§çš„è§£å†³æ–¹æ¡ˆã€‚Nettyä¸­ä¸€ä¸ªå…³é”®ç»„æˆéƒ¨åˆ†æ˜¯å®ƒçš„å¼‚æ­¥ç‰¹æ€§ï¼Œæœ¬ç‰‡æ–‡ç« å°†è®¨è®ºåŒæ­¥ï¼ˆé˜»å¡ï¼‰å’Œå¼‚æ­¥ï¼ˆéé˜»å¡ï¼‰çš„IOæ¥è¯´æ˜ä¸ºä»€ä¹ˆä½¿ç”¨å¼‚æ­¥ä»£ç è§£å†³æ‰©å±•æ€§é—®é¢˜ä»¥åŠå¦‚ä½•ä½¿ç”¨å¼‚æ­¥ã€‚</p>

<p>3.Nettyæ¶æ„ç»„æˆï¼ˆå€Ÿç”¨ä¸€ä¸‹ç½‘ä¸Šçš„å›¾ç‰‡ï¼‰</p>

<p>Nettyå®ç°åŸç†æµ…æï¼Œå†™çš„å¾ˆä¸é”™ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹ã€‚</p>

<p>4.Helloworldå…¥é—¨</p>

<p>åœ¨å­¦ä¹ Nettyä¹‹å‰ï¼Œå…ˆæ¥å›é¡¾ä¸€ä¸‹NIOçš„é€šä¿¡æ­¥éª¤ï¼š</p>

<p>â‘ åˆ›å»ºServerSocketChannelï¼Œä¸ºå…¶é…ç½®éé˜»å¡æ¨¡å¼ã€‚</p>

<p>â‘¡ç»‘å®šç›‘å¬ï¼Œé…ç½®TCPå‚æ•°ï¼Œå½•å…¥backlogå¤§å°ç­‰ã€‚</p>

<p>â‘¢åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„IOçº¿ç¨‹ï¼Œç”¨äºè½®è¯¢å¤šè·¯å¤ç”¨å™¨Selectorã€‚</p>

<p>â‘£åˆ›å»ºSelectorï¼Œå°†ä¹‹å‰åˆ›å»ºçš„ServerSocketChannelæ³¨å†Œåˆ°Selectorä¸Šï¼Œå¹¶è®¾ç½®ç›‘å¬æ ‡è¯†ä½SelectionKey.OP_ACCEPTã€‚</p>

<p>â‘¤å¯åŠ¨IOçº¿ç¨‹ï¼Œåœ¨å¾ªç¯ä½“ä¸­æ‰§è¡ŒSelector.select()æ–¹æ³•ï¼Œè½®è¯¢å°±ç»ªçš„é€šé“ã€‚</p>

<p>â‘¥å½“è½®è¯¢åˆ°å¤„äºå°±ç»ªçŠ¶æ€çš„é€šé“æ—¶ï¼Œéœ€è¦è¿›è¡Œæ“ä½œä½åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ACCEPTçŠ¶æ€ï¼Œè¯´æ˜æ˜¯æ–°çš„å®¢æˆ·ç«¯æ¥å…¥ï¼Œåˆ™è°ƒç”¨acceptæ–¹æ³•æ¥æ”¶æ–°çš„å®¢æˆ·ç«¯ã€‚</p>

<p>â‘¦è®¾ç½®æ–°æ¥å…¥å®¢æˆ·ç«¯çš„ä¸€äº›å‚æ•°ï¼Œå¦‚éé˜»å¡ï¼Œå¹¶å°†å…¶ç»§ç»­æ³¨å†Œåˆ°Selectorä¸Šï¼Œè®¾ç½®ç›‘å¬æ ‡è¯†ä½ç­‰ã€‚</p>

<p>â‘§å¦‚æœè½®è¯¢çš„é€šé“æ ‡è¯†ä½æ˜¯READï¼Œåˆ™è¿›è¡Œè¯»å–ï¼Œæ„é€ Bufferå¯¹è±¡ç­‰ã€‚</p>

<p>â‘¨æ›´ç»†èŠ‚çš„é—®é¢˜è¿˜æœ‰æ•°æ®æ²¡å‘é€å®Œæˆç»§ç»­å‘é€çš„é—®é¢˜â€¦â€¦</p>

<p>å¥½å•¦ï¼Œå¼€å§‹å­¦ä¹ Nettyäº†ã€‚å…ˆå»http://netty.io/ä¸Šä¸‹è½½æ‰€æœ‰çš„NettyåŒ…ã€‚</p>

<p>Nettyé€šä¿¡çš„æ­¥éª¤ï¼š</p>

<p>â‘ åˆ›å»ºä¸¤ä¸ªNIOçº¿ç¨‹ç»„ï¼Œä¸€ä¸ªä¸“é—¨ç”¨äºç½‘ç»œäº‹ä»¶å¤„ç†ï¼ˆæ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ï¼‰ï¼Œå¦ä¸€ä¸ªåˆ™è¿›è¡Œç½‘ç»œé€šä¿¡çš„è¯»å†™ã€‚</p>

<p>â‘¡åˆ›å»ºä¸€ä¸ªServerBootstrapå¯¹è±¡ï¼Œé…ç½®Nettyçš„ä¸€ç³»åˆ—å‚æ•°ï¼Œä¾‹å¦‚æ¥å—ä¼ å‡ºæ•°æ®çš„ç¼“å­˜å¤§å°ç­‰ã€‚</p>

<p>â‘¢åˆ›å»ºä¸€ä¸ªç”¨äºå®é™…å¤„ç†æ•°æ®çš„ç±»ChannelInitializerï¼Œè¿›è¡Œåˆå§‹åŒ–çš„å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚è®¾ç½®æ¥å—ä¼ å‡ºæ•°æ®çš„å­—ç¬¦é›†ã€æ ¼å¼ä»¥åŠå®é™…å¤„ç†æ•°æ®çš„æ¥å£ã€‚</p>

<p>â‘£ç»‘å®šç«¯å£ï¼Œæ‰§è¡ŒåŒæ­¥é˜»å¡æ–¹æ³•ç­‰å¾…æœåŠ¡å™¨ç«¯å¯åŠ¨å³å¯ã€‚</p>

<p>å¼ºçƒˆæ¨èè¯»ä¸€è¯»Nettyå®˜æ–¹ç¿»è¯‘æ–‡æ¡£ã€‚</p>

<p>å¥½äº†ï¼Œè¯´äº†é‚£ä¹ˆå¤šï¼Œä¸‹é¢å°±æ¥HelloWorldå…¥é—¨å§ï¼</p>

<p>æœåŠ¡å™¨ç«¯ï¼š</p>

<p>[java] view plain copy print?
public class Server {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private int port;  
  
public Server(int port) {  
    this.port = port;  
}  
  
public void run() {  
    EventLoopGroup bossGroup = new NioEventLoopGroup(); //ç”¨äºå¤„ç†æœåŠ¡å™¨ç«¯æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥  
    EventLoopGroup workerGroup = new NioEventLoopGroup(); //è¿›è¡Œç½‘ç»œé€šä¿¡ï¼ˆè¯»å†™ï¼‰  
    try {  
        ServerBootstrap bootstrap = new ServerBootstrap(); //è¾…åŠ©å·¥å…·ç±»ï¼Œç”¨äºæœåŠ¡å™¨é€šé“çš„ä¸€ç³»åˆ—é…ç½®  
        bootstrap.group(bossGroup, workerGroup) //ç»‘å®šä¸¤ä¸ªçº¿ç¨‹ç»„  
                .channel(NioServerSocketChannel.class) //æŒ‡å®šNIOçš„æ¨¡å¼  
                .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() { //é…ç½®å…·ä½“çš„æ•°æ®å¤„ç†æ–¹å¼  
                    @Override  
                    protected void initChannel(SocketChannel socketChannel) throws Exception {  
                        socketChannel.pipeline().addLast(new ServerHandler());  
                    }  
                })  
                /** 
                 * å¯¹äºChannelOption.SO_BACKLOGçš„è§£é‡Šï¼š 
                 * æœåŠ¡å™¨ç«¯TCPå†…æ ¸ç»´æŠ¤æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºAã€Bé˜Ÿåˆ—ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡å™¨ç«¯connectæ—¶ï¼Œä¼šå‘é€å¸¦æœ‰SYNæ ‡å¿—çš„åŒ…ï¼ˆç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼‰ï¼ŒæœåŠ¡å™¨ç«¯ 
                 * æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„SYNæ—¶ï¼Œå‘å®¢æˆ·ç«¯å‘é€SYN ACKç¡®è®¤ï¼ˆç¬¬äºŒæ¬¡æ¡æ‰‹ï¼‰ï¼Œæ­¤æ—¶TCPå†…æ ¸æ¨¡å—æŠŠå®¢æˆ·ç«¯è¿æ¥åŠ å…¥åˆ°Aé˜Ÿåˆ—ä¸­ï¼Œç„¶åæœåŠ¡å™¨æ¥æ”¶åˆ° 
                 * å®¢æˆ·ç«¯å‘é€çš„ACKæ—¶ï¼ˆç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼‰ï¼ŒTCPå†…æ ¸æ¨¡å—æŠŠå®¢æˆ·ç«¯è¿æ¥ä»Aé˜Ÿåˆ—ç§»åŠ¨åˆ°Bé˜Ÿåˆ—ï¼Œè¿æ¥å®Œæˆï¼Œåº”ç”¨ç¨‹åºçš„acceptä¼šè¿”å›ã€‚ä¹Ÿå°±æ˜¯è¯´accept 
                 * ä»Bé˜Ÿåˆ—ä¸­å–å‡ºå®Œæˆäº†ä¸‰æ¬¡æ¡æ‰‹çš„è¿æ¥ã€‚ 
                 * Aé˜Ÿåˆ—å’ŒBé˜Ÿåˆ—çš„é•¿åº¦ä¹‹å’Œå°±æ˜¯backlogã€‚å½“Aã€Bé˜Ÿåˆ—çš„é•¿åº¦ä¹‹å’Œå¤§äºChannelOption.SO_BACKLOGæ—¶ï¼Œæ–°çš„è¿æ¥å°†ä¼šè¢«TCPå†…æ ¸æ‹’ç»ã€‚ 
                 * æ‰€ä»¥ï¼Œå¦‚æœbacklogè¿‡å°ï¼Œå¯èƒ½ä¼šå‡ºç°accepté€Ÿåº¦è·Ÿä¸ä¸Šï¼ŒAã€Bé˜Ÿåˆ—æ»¡äº†ï¼Œå¯¼è‡´æ–°çš„å®¢æˆ·ç«¯æ— æ³•è¿æ¥ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œbacklogå¯¹ç¨‹åºæ”¯æŒçš„ 
                 * è¿æ¥æ•°å¹¶æ— å½±å“ï¼Œbacklogå½±å“çš„åªæ˜¯è¿˜æ²¡æœ‰è¢«acceptå–å‡ºçš„è¿æ¥ 
                 */  
                .option(ChannelOption.SO_BACKLOG, 128) //è®¾ç½®TCPç¼“å†²åŒº  
                .option(ChannelOption.SO_SNDBUF, 32 * 1024) //è®¾ç½®å‘é€æ•°æ®ç¼“å†²å¤§å°  
                .option(ChannelOption.SO_RCVBUF, 32 * 1024) //è®¾ç½®æ¥å—æ•°æ®ç¼“å†²å¤§å°  
                .childOption(ChannelOption.SO_KEEPALIVE, true); //ä¿æŒè¿æ¥  
        ChannelFuture future = bootstrap.bind(port).sync();  
        future.channel().closeFuture().sync();  
    } catch (Exception e) {  
        e.printStackTrace();  
    } finally {  
        workerGroup.shutdownGracefully();  
        bossGroup.shutdownGracefully();  
    }  
}  
  
public static void main(String[] args) {  
    new Server(8379).run();  
}   }  
</code></pre></div></div>

<p>ServerHandlerç±»ï¼š</p>

<p>[java] view plain copy print?
public class ServerHandler  extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override  
public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {  
  
        //do something msg  
        ByteBuf buf = (ByteBuf)msg;  
        byte[] data = new byte[buf.readableBytes()];  
        buf.readBytes(data);  
        String request = new String(data, "utf-8");  
        System.out.println("Server: " + request);  
        //å†™ç»™å®¢æˆ·ç«¯  
        String response = "æˆ‘æ˜¯åé¦ˆçš„ä¿¡æ¯";  
        ctx.writeAndFlush(Unpooled.copiedBuffer("888".getBytes()));  
        //.addListener(ChannelFutureListener.CLOSE);  
          
  
}  
  
@Override  
public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {  
    cause.printStackTrace();  
    ctx.close();  
}  
</code></pre></div></div>

<p>}</p>

<p>å®¢æˆ·ç«¯ï¼š</p>

<p>[java] view plain copy print?
public class Client {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void main(String[] args) throws InterruptedException {  
    EventLoopGroup workerGroup = new NioEventLoopGroup();  
    Bootstrap bootstrap = new Bootstrap();  
    bootstrap.group(workerGroup)  
            .channel(NioSocketChannel.class)  
            .handler(new ChannelInitializer&lt;SocketChannel&gt;() {  
                @Override  
                protected void initChannel(SocketChannel socketChannel) throws Exception {  
                    socketChannel.pipeline().addLast(new ClientHandler());  
                }  
            });  
    ChannelFuture future = bootstrap.connect("127.0.0.1", 8379).sync();  
    future.channel().writeAndFlush(Unpooled.copiedBuffer("777".getBytes()));  
    future.channel().closeFuture().sync();  
    workerGroup.shutdownGracefully();  
}  
</code></pre></div></div>

<p>}</p>

<p>ClientHandlerç±»ï¼š
[java] view plain copy print?
public class ClientHandler extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override  
public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {  
    try {  
        ByteBuf buf = (ByteBuf) msg;  
        byte[] data = new byte[buf.readableBytes()];  
        buf.readBytes(data);  
        System.out.println("Clientï¼š" + new String(data).trim());  
    } finally {  
        ReferenceCountUtil.release(msg);  
    }  
}  
  
  
@Override  
public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {  
    cause.printStackTrace();  
    ctx.close();  
}  
</code></pre></div></div>

<p>}</p>

<p>è¿è¡Œç»“æœï¼š</p>

<p>5.TCPç²˜åŒ…ã€æ‹†åŒ…é—®é¢˜</p>

<p>ç†Ÿæ‚‰TCPç¼–ç¨‹çš„å¯èƒ½éƒ½çŸ¥é“ï¼Œæ— è®ºæ˜¯æœåŠ¡å™¨ç«¯è¿˜æ˜¯å®¢æˆ·ç«¯ï¼Œå½“æˆ‘ä»¬è¯»å–æˆ–è€…å‘é€æ•°æ®çš„æ—¶å€™ï¼Œéƒ½éœ€è¦è€ƒè™‘TCPåº•å±‚çš„ç²˜åŒ…/æ‹†åŒ…æœºåˆ¶ã€‚</p>

<p>TCPæ˜¯ä¸€ä¸ªâ€œæµâ€åè®®ï¼Œæ‰€è°“æµå°±æ˜¯æ²¡æœ‰ç•Œé™çš„é—ä¼ æ•°æ®ã€‚å¤§å®¶å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæ²³æ°´å°±å¥½æ¯”æ•°æ®ï¼Œä»–ä»¬æ˜¯è¿æˆä¸€ç‰‡çš„ï¼Œæ²¡æœ‰åˆ†ç•Œçº¿ï¼ŒTCPåº•å±‚å¹¶ä¸äº†è§£ä¸Šå±‚ä¸šåŠ¡æ•°æ®çš„å…·ä½“å«ä¹‰ï¼Œå®ƒä¼šæ ¹æ®TCPç¼“å†²åŒºçš„å…·ä½“æƒ…å†µè¿›è¡ŒåŒ…çš„åˆ’åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸šåŠ¡ä¸Šä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢«TCPåˆ†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿå¯èƒ½æŠŠå¤šä¸ªå°åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€å‡ºå»ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ç²˜åŒ…/æ‹†åŒ…é—®é¢˜ã€‚</p>

<p>è§£å†³æ–¹æ¡ˆï¼š</p>

<p>â‘ æ¶ˆæ¯å®šé•¿ï¼Œä¾‹å¦‚æ¯ä¸ªæŠ¥æ–‡çš„å¤§å°å›ºå®šä¸º200ä¸ªå­—èŠ‚ï¼Œå¦‚æœä¸å¤Ÿï¼Œç©ºä½è¡¥ç©ºæ ¼ã€‚</p>

<p>â‘¡åœ¨åŒ…å°¾éƒ¨å¢åŠ ç‰¹æ®Šå­—ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œä¾‹å¦‚åŠ å›è½¦ç­‰ã€‚</p>

<p>â‘¢å°†æ¶ˆæ¯åˆ†ä¸ºæ¶ˆæ¯å¤´å’Œæ¶ˆæ¯ä½“ï¼Œåœ¨æ¶ˆæ¯å¤´ä¸­åŒ…å«è¡¨ç¤ºæ¶ˆæ¯æ€»é•¿åº¦çš„å­—æ®µï¼Œç„¶åè¿›è¡Œä¸šåŠ¡é€»è¾‘çš„å¤„ç†ã€‚</p>

<p>Nettyä¸­è§£å†³TCPç²˜åŒ…/æ‹†åŒ…çš„æ–¹æ³•ï¼š</p>

<p>â‘ åˆ†éš”ç¬¦ç±»ï¼šDelimiterBasedFrameDecoderï¼ˆè‡ªå®šä¹‰åˆ†éš”ç¬¦ï¼‰</p>

<p>â‘¡å®šé•¿ï¼šFixedLengthFrameDecoder</p>

<p>6.Nettyç¼–è§£ç æŠ€æœ¯</p>

<p>é€šå¸¸æˆ‘ä»¬ä¹Ÿä¹ æƒ¯å°†ç¼–ç ï¼ˆEncodeï¼‰æˆä¸ºåºåˆ—åŒ–ï¼Œå®ƒå°†æ•°æ®åºåˆ—åŒ–ä¸ºå­—èŠ‚æ•°ç»„ï¼Œç”¨äºç½‘ç»œä¼ è¾“ã€æ•°æ®æŒä¹…åŒ–æˆ–è€…å…¶ä»–ç”¨é€”ã€‚åä¹‹ï¼Œè§£ç ï¼ˆDecodeï¼‰/ååºåˆ—åŒ–ï¼ˆdeserializationï¼‰</p>

<p>æŠŠä»ç½‘ç»œã€ç£ç›˜ç­‰è¯»å–çš„å­—èŠ‚æ•°ç»„è¿˜åŸæˆåŸå§‹å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯åŸå§‹å¯¹è±¡çš„æ‹·è´ï¼‰ï¼Œä»¥æ–¹ä¾¿åç»­çš„ä¸šåŠ¡é€»è¾‘æ“ä½œã€‚è¿›è¡Œè¿œç¨‹è·¨è¿›ç¨‹æœåŠ¡è°ƒç”¨æ—¶ï¼ˆä¾‹å¦‚RPCè°ƒç”¨ï¼‰ï¼Œéœ€è¦ä½¿ç”¨ç‰¹å®šçš„ç¼–è§£ç æŠ€æœ¯ï¼Œå¯¹éœ€è¦è¿›è¡Œç½‘ç»œä¼ è¾“çš„å¯¹è±¡åšç¼–ç æˆ–è€…è§£ç ï¼Œä»¥ä¾¿å®Œæˆè¿œç¨‹è°ƒç”¨ã€‚</p>

<p>ä¸»æµçš„ç¼–è§£ç æ¡†æ¶ï¼š</p>

<p>â‘ JBossçš„MarshallingåŒ…</p>

<p>â‘¡googleçš„Protobuf</p>

<p>â‘¢åŸºäºProtobufçš„Kyro</p>

<p>â‘£MessagePackæ¡†æ¶</p>

<p>ä¸Šä»£ç ï¼Œä¸€è¯»å°±æ‡‚ï¼Œæ³¨æ„çº¢è‰²å­—ä½“éƒ¨åˆ†ã€‚</p>

<p>æœåŠ¡å™¨ç«¯ï¼š</p>

<p>public class Server {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public Server(int port) {

    EventLoopGroup bossGroup = newNioEventLoopGroup();

    EventLoopGroup workerGroup = newNioEventLoopGroup();

    try {

        ServerBootstrap bootstrap = newServerBootstrap();

        bootstrap.group(bossGroup, workerGroup)

               .channel(NioServerSocketChannel.class)

                .handler(newLoggingHandler(LogLevel.INFO))

                .childHandler(newChannelInitializer&lt;SocketChannel&gt;() {

                    @Override

                    protected voidinitChannel(SocketChannel socketChannel) throws Exception {

                        socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingDecoder());

                        socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingEncoder());

                       socketChannel.pipeline().addLast(new ServerHandler());

                    }

                })

                .option(ChannelOption.SO_BACKLOG,1024)

               .option(ChannelOption.SO_RCVBUF, 32 * 1024)

               .option(ChannelOption.SO_SNDBUF, 32 * 1024)

               .option(ChannelOption.SO_KEEPALIVE, true);

        ChannelFuture future = bootstrap.bind(port).sync();

       future.channel().closeFuture().sync();

    } catch (Exception e) {

        e.printStackTrace();

    } finally {

        bossGroup.shutdownGracefully();

        workerGroup.shutdownGracefully();

    }

}

 

public static void main(String[] args) {

    new Server(8765);

}
</code></pre></div></div>

<p>}</p>

<p>ServerHandlerç±»ï¼š</p>

<p>public classServerHandler extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override

public voidexceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {

    cause.printStackTrace();

    ctx.close();

}

 

@Override

public voidchannelActive(ChannelHandlerContext ctx) throws Exception {

    super.channelActive(ctx);

}

 

@Override

public void channelRead(ChannelHandlerContextctx, Object msg) throws Exception {

    Request request = (Request) msg;

    System.out.println("Server:"+ request.getId() + "," + request.getName() + "," +request.getReqeustMessag());

 

    Response response = new Response();

    response.setId(request.getId());

    response.setName("response "+ request.getId());

    response.setResponseMessage("å“åº”å†…å®¹ï¼š" +request.getReqeustMessag());

    byte[] unGizpData =GzipUtils.unGzip(request.getAttachment());

    char separator = File.separatorChar;

    FileOutputStream outputStream = newFileOutputStream(System.getProperty("user.dir") + separator +"recieve" + separator + "1.png");

    outputStream.write(unGizpData);

    outputStream.flush();

    outputStream.close();

    ctx.writeAndFlush(response);

}
</code></pre></div></div>

<p>}</p>

<p>å®¢æˆ·ç«¯ï¼š</p>

<p>public class Client {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void main(String[] args) {

    EventLoopGroup workerGroup = newNioEventLoopGroup();

    try {

        Bootstrap bootstrap = new Bootstrap();

        bootstrap.group(workerGroup)

                .handler(newLoggingHandler(LogLevel.INFO))

               .channel(NioSocketChannel.class)

                .handler(newChannelInitializer&lt;SocketChannel&gt;() {

                    @Override

                    protected voidinitChannel(SocketChannel socketChannel) throws Exception {

                        socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingEncoder());

                        socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingDecoder());

                       socketChannel.pipeline().addLast(new ClientHandler());

                    }

                });

        ChannelFuture future =bootstrap.connect(new InetSocketAddress("127.0.01", 8765)).sync();

        for(int i=1; i&lt;=5; i++) {

            Request request = newRequest();

            request.setId(i);

            request.setName("pro"+ i);

           request.setReqeustMessag("æ•°æ®ä¿¡æ¯" + i);

            //ä¼ è¾“å›¾ç‰‡

            char separator =File.separatorChar;

            File file = newFile(System.getProperty("user.dir") + separator + "source"+ separator + "2.jpg");

            FileInputStream inputStream = newFileInputStream(file);

            byte[] data = newbyte[inputStream.available()];

            inputStream.read(data);

            inputStream.close();

            byte[] gzipData =GzipUtils.gzip(data);

           request.setAttachment(gzipData);

           future.channel().writeAndFlush(request);

        }

 

       future.channel().closeFuture().sync();

    } catch (Exception e) {

        e.printStackTrace();

    } finally {

        workerGroup.shutdownGracefully();

    }

}
</code></pre></div></div>

<p>}</p>

<p>ClientHandlerç±»ï¼š</p>

<p>public classClientHandler extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Override

public voidexceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {

    super.exceptionCaught(ctx, cause);

}

 

@Override

public voidchannelActive(ChannelHandlerContext ctx) throws Exception {

    super.channelActive(ctx);

}

 

@Override

public voidchannelRead(ChannelHandlerContext ctx, Object msg) throws Exception {

    Response response = (Response) msg;

    System.out.println("Client:"+ response.getId() + "," + response.getName() + "," +response.getResponseMessage());

}
</code></pre></div></div>

<p>}</p>

<p>Marshallingå·¥å…·ç±»ï¼š</p>

<p>public final classMarshallingCodeCFactory {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**

 * åˆ›å»ºJboss Marshallingè§£ç å™¨MarshallingDecoder

 * @return MarshallingDecoder

 */

public static MarshallingDecoderbuildMarshallingDecoder() {

      //é¦–å…ˆé€šè¿‡Marshallingå·¥å…·ç±»çš„ç²¾é€šæ–¹æ³•è·å–Marshallingå®ä¾‹å¯¹è±¡ å‚æ•°serialæ ‡è¯†åˆ›å»ºçš„æ˜¯javaåºåˆ—åŒ–å·¥å‚å¯¹è±¡ã€‚

              final MarshallerFactorymarshallerFactory =Marshalling.getProvidedMarshallerFactory("serial");

              //åˆ›å»ºäº†MarshallingConfigurationå¯¹è±¡ï¼Œé…ç½®äº†ç‰ˆæœ¬å·ä¸º5

              final MarshallingConfigurationconfiguration = new MarshallingConfiguration();

              configuration.setVersion(5);

              //æ ¹æ®marshallerFactoryå’Œconfigurationåˆ›å»ºprovider

              UnmarshallerProvider provider= new DefaultUnmarshallerProvider(marshallerFactory, configuration);

              //æ„å»ºNettyçš„MarshallingDecoderå¯¹è±¡ï¼Œä¿©ä¸ªå‚æ•°åˆ†åˆ«ä¸ºproviderå’Œå•ä¸ªæ¶ˆæ¯åºåˆ—åŒ–åçš„æœ€å¤§é•¿åº¦

              MarshallingDecoder decoder =new MarshallingDecoder(provider, 1024 * 1024);

              return decoder;

}

 

/**

 * åˆ›å»ºJboss Marshallingç¼–ç å™¨MarshallingEncoder

 * @return MarshallingEncoder

 */

public static MarshallingEncoderbuildMarshallingEncoder() {

              final MarshallerFactorymarshallerFactory =Marshalling.getProvidedMarshallerFactory("serial");

              final MarshallingConfigurationconfiguration = new MarshallingConfiguration();

              configuration.setVersion(5);

              MarshallerProvider provider =new DefaultMarshallerProvider(marshallerFactory, configuration);

              //æ„å»ºNettyçš„MarshallingEncoderå¯¹è±¡ï¼ŒMarshallingEncoderç”¨äºå®ç°åºåˆ—åŒ–æ¥å£çš„POJOå¯¹è±¡åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ•°ç»„

              MarshallingEncoder encoder =new MarshallingEncoder(provider);

              return encoder;

}
</code></pre></div></div>

<p>}</p>

<p>Gizpå‹ç¼©ä¸è§£å‹ç¼©å·¥å…·ç±»ï¼š</p>

<p>public classGzipUtils {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static byte[] gzip(byte[] val)throws IOException {

    ByteArrayOutputStream bos = newByteArrayOutputStream(val.length);

    GZIPOutputStream gos = null;

    try {

        gos = new GZIPOutputStream(bos);

        gos.write(val, 0, val.length);

        gos.finish();

        gos.flush();

        bos.flush();

        val = bos.toByteArray();

    } finally {

        if (gos != null)

            gos.close();

        if (bos != null)

            bos.close();

    }

    return val;

}

 

public static byte[] unGzip(byte[] buf)throws IOException {

    GZIPInputStream gzi = null;

    ByteArrayOutputStream bos = null;

    try {

        gzi = new GZIPInputStream(newByteArrayInputStream(buf));

        bos = newByteArrayOutputStream(buf.length);

        int count = 0;

        byte[] tmp = new byte[2048];

        while ((count = gzi.read(tmp)) !=-1) {

            bos.write(tmp, 0, count);

        }

        buf = bos.toByteArray();

    } finally {

        if (bos != null) {

            bos.flush();

            bos.close();

        }

        if (gzi != null)

            gzi.close();

    }

    return buf;

}
</code></pre></div></div>

<p>}</p>

<p>7.æœ€ä½³å®è·µ</p>

<p>ï¼ˆ1ï¼‰æ•°æ®é€šä¿¡</p>

<p>æˆ‘ä»¬éœ€è¦äº†è§£åœ¨çœŸæ­£é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨Nettyï¼Œå¤§ä½“ä¸Šå¯¹äºä¸€äº›å‚æ•°è®¾ç½®éƒ½æ˜¯æ ¹æ®æœåŠ¡å™¨æ€§èƒ½å†³å®šçš„ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„é—®é¢˜æ˜¯ä¸¤å°æœºå™¨ï¼ˆç”šè‡³å¤šå°ï¼‰ä½¿ç”¨Nettyæ€æ ·è¿›è¡Œé€šä¿¡ã€‚</p>

<p>å¤§ä½“ä¸Šåˆ†ä¸ºä¸‰ç§ï¼š
     â‘ ä½¿ç”¨é•¿è¿æ¥é€šé“ä¸æ–­å¼€çš„å½¢å¼è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯çš„é€šé“ä¸€ç›´å¤„äºå¼€å¯çŠ¶æ€ï¼Œå¦‚æœæœåŠ¡å™¨æ€§èƒ½è¶³å¤Ÿå¥½ï¼Œå¹¶ä¸”å®¢æˆ·ç«¯æ•°é‡ä¹Ÿæ¯”è¾ƒä¸Šçš„æƒ…å†µä¸‹ï¼Œæ¨èè¿™ç§æ–¹å¼ã€‚
     â‘¡ä¸€æ¬¡æ€§æ‰¹é‡æäº¤æ•°æ®ï¼Œé‡‡ç”¨çŸ­è¿æ¥æ–¹å¼ã€‚ä¹Ÿå°±æ˜¯è¯´å…ˆæŠŠæ•°æ®ä¿å­˜åˆ°æœ¬åœ°ä¸´æ—¶ç¼“å­˜åŒºæˆ–è€…ä¸´æ—¶è¡¨ï¼Œå½“è¾¾åˆ°ç•Œå€¼æ—¶è¿›è¡Œä¸€æ¬¡æ€§æ‰¹é‡æäº¤ï¼Œåˆæˆ–è€…æ ¹æ®å®šæ—¶ä»»åŠ¡è½®è¯¢æäº¤ï¼Œ</p>

<p>è¿™ç§æƒ…å†µçš„å¼Šç«¯æ˜¯åšä¸åˆ°å®æ—¶æ€§ä¼ è¾“ï¼Œå¯¹å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„åº”ç”¨ç¨‹åºä¸­æ¨èä½¿ç”¨ã€‚
     â‘¢ä½¿ç”¨ä¸€ç§ç‰¹æ®Šçš„é•¿è¿æ¥ï¼Œåœ¨æŸä¸€æŒ‡å®šæ—¶é—´æ®µå†…ï¼ŒæœåŠ¡å™¨ä¸æŸå°å®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•é€šä¿¡ï¼Œåˆ™æ–­å¼€è¿æ¥ã€‚ä¸‹æ¬¡è¿æ¥åˆ™æ˜¯å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œå†æ¬¡å»ºç«‹è¿æ¥ã€‚
     åœ¨è¿™é‡Œå°†ä»‹ç»ä½¿ç”¨Nettyå®ç°ç¬¬ä¸‰ç§æ–¹å¼çš„è¿æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸¤ä¸ªå› ç´ ï¼š
     â‘ å¦‚ä½•åœ¨è¶…æ—¶ï¼ˆå³æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯æ²¡æœ‰ä»»ä½•é€šä¿¡ï¼‰åå…³é—­é€šé“ï¼Ÿå…³é—­é€šé“ååˆå¦‚ä½•å†æ¬¡å»ºç«‹è¿æ¥ï¼Ÿ
     â‘¡å®¢æˆ·ç«¯å®•æœºæ—¶ï¼Œæˆ‘ä»¬æ— éœ€è€ƒè™‘ï¼Œä¸‹æ¬¡é‡å¯å®¢æˆ·ç«¯ä¹‹åå°±å¯ä»¥ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œä½†æœåŠ¡å™¨å®•æœºæ—¶ï¼Œå®¢æˆ·ç«¯å¦‚ä½•ä¸æœåŠ¡å™¨ç«¯é€šä¿¡ï¼Ÿ</p>

<p>æœåŠ¡å™¨ç«¯ï¼šå¢åŠ äº†çº¢è‰²æ¡†éƒ¨åˆ†</p>

<p>å®¢æˆ·ç«¯ï¼ˆæ³¨æ„çº¢è‰²å­—ä½“éƒ¨åˆ†ï¼‰ï¼š</p>

<p>public class Client {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static class SingleHodler {

    static final Client client = newClient();

}

 

public static Client getInstance() {

    return SingleHodler.client;

}

 

private EventLoopGroup workerGroup;

private Bootstrap bootstrap;

private ChannelFuture future;

 

private Client() {

    workerGroup = new NioEventLoopGroup();

    bootstrap = new Bootstrap();

    bootstrap.group(workerGroup)

           .channel(NioSocketChannel.class)

            .handler(newChannelInitializer&lt;SocketChannel&gt;() {

                @Override

                protected voidinitChannel(SocketChannel socketChannel) throws Exception {

                   socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingEncoder());

                   socketChannel.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingDecoder());

                    socketChannel.pipeline().addLast(newReadTimeoutHandler(5)); //5ç§’åæœªä¸æœåŠ¡å™¨é€šä¿¡ï¼Œåˆ™æ–­å¼€è¿æ¥ã€‚

                   socketChannel.pipeline().addLast(new ClientHandler());

                }

            });

}

 

public void connect() {

    try {

        future =bootstrap.connect("127.0.0.1", 8765).sync();

    } catch (InterruptedException e) {

        e.printStackTrace();

    }

}

 

public ChannelFuture getFuture() {

    if(future == null ||!future.channel().isActive()) {

        this.connect();

    }

    return future;

}

 

public static void main(String[] args)throws InterruptedException {

    Client client = getInstance();

    ChannelFuture future = client.getFuture();

 

    for(int i=1; i&lt;=3; i++) {

        Message message = new Message(i,"pro" + i, "æ•°æ®ä¿¡æ¯" + i);

       future.channel().writeAndFlush(message);

        Thread.sleep(4000);  //ä¼‘çœ 4ç§’åå†å‘é€æ•°æ®

    }

 

    future.channel().closeFuture().sync();

 

    new Thread(() -&gt; {

        try {

            System.out.println("å­çº¿ç¨‹å¼€å§‹....");

            ChannelFuture f =client.getFuture();

            Message message = newMessage(4, "pro" + 4, "æ•°æ®ä¿¡æ¯" + 4);

            f.channel().writeAndFlush(message);

           f.channel().closeFuture().sync();

        } catch (Exception e) {

            e.printStackTrace();

        }

    }).start();

 

    System.out.println("ä¸»çº¿ç¨‹é€€å‡º......");

}
</code></pre></div></div>

<p>}</p>

<p>å…¶ä»–çš„ç±»ä¸ä¹‹å‰çš„ä¸€æ ·ï¼Œæ²¡æœ‰å˜åŒ–ã€‚</p>

<p>è¿è¡Œç»“æœï¼š</p>

<p>ï¼ˆ2ï¼‰å¿ƒè·³æ£€æµ‹</p>

<p>æˆ‘ä»¬ä½¿ç”¨Socketé€šä¿¡ä¸€èˆ¬ç»å¸¸ä¼šå¤„ç†å¤šä¸ªæœåŠ¡å™¨ä¹‹é—´çš„å¿ƒè·³æ£€æµ‹ï¼Œä¸€èˆ¬æ¥è®²æˆ‘ä»¬å»ç»´æŠ¤æœåŠ¡å™¨é›†ç¾¤ï¼Œè‚¯å®šè¦æœ‰ä¸€å°æˆ–å¤šå°æœåŠ¡å™¨ä¸»æœºï¼ˆMasterï¼‰ï¼Œç„¶åè¿˜åº”è¯¥æœ‰Nå°ï¼ˆSlaveï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ä¸»æœºè‚¯å®šè¦æ—¶æ—¶åˆ»åˆ»çŸ¥é“è‡ªå·±ä¸‹é¢çš„ä»æœåŠ¡å™¨çš„å„æ–¹é¢æƒ…å†µï¼Œç„¶åè¿›è¡Œå®æ—¶ç›‘æ§çš„åŠŸèƒ½ã€‚è¿™ä¸ªåœ¨åˆ†å¸ƒå¼æ¶æ„é‡Œäº¤åšå¿ƒè·³æ£€æµ‹æˆ–è€…å¿ƒè·³ç›‘æ§ã€‚æœ€ä½³å¤„ç†æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸€äº›é€šä¿¡æ¡†æ¶è¿›è¡Œå®ç°ï¼ŒNettyå°±å¯ä»¥åšè¿™æ ·çš„äº‹ã€‚</p>

<p>è¿™ä¸ªä¾‹å­éœ€è¦ä½¿ç”¨Sigarï¼Œä¸ç†Ÿæ‚‰çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ã€‚</p>

<p>Server</p>

<p>public class Server {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public Server(int port) {

    EventLoopGroup bossGroup = newNioEventLoopGroup();

    EventLoopGroup workerGroup = newNioEventLoopGroup();

    try {

        ServerBootstrap bootstrap = newServerBootstrap();

        bootstrap.group(bossGroup,workerGroup)

               .channel(NioServerSocketChannel.class)

                .childHandler(newChannelInitializer&lt;SocketChannel&gt;() {

                    @Override

                    protected voidinitChannel(SocketChannel sc) throws Exception {

                       sc.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingEncoder());

                        sc.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingDecoder());

                       sc.pipeline().addLast(new ServerHeartBeatHandler());

                    }

                })

                .handler(newLoggingHandler(LogLevel.INFO))

               .option(ChannelOption.SO_BACKLOG, 1024);

        ChannelFuture future =bootstrap.bind(new InetSocketAddress("127.0.0.1", port)).sync();

       future.channel().closeFuture().sync();

    } catch (Exception e) {

        e.printStackTrace();

    } finally {

        bossGroup.shutdownGracefully();

        workerGroup.shutdownGracefully();

    }

}

 

public static void main(String[] args) {

    new Server(8765);

}
</code></pre></div></div>

<p>}</p>

<p>ServerHeartBeatHandlerç±»ï¼š</p>

<p>public classServerHeartBeatHandler extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private static Map&lt;String, String&gt;AUTH_IP_MAP = new HashMap&lt;&gt;();

private static final String SUCCESS_KEY ="auth_success_key";

 

static {

    AUTH_IP_MAP.put("192.168.3.176","1234");

}

 

private boolean auth(ChannelHandlerContextctx, Object msg) {

    String[] rets = ((String)msg).split(",");

    String auth = AUTH_IP_MAP.get(rets[0]);

    if(auth != null &amp;&amp;auth.equals(rets[1])) {

        ctx.writeAndFlush(SUCCESS_KEY);

        return true;

    } else {

        ctx.writeAndFlush("authfailure!").addListener(ChannelFutureListener.CLOSE);

        return false;

    }

}

 

@Override

public void channelRead(ChannelHandlerContextctx, Object msg) throws Exception {

    if(msg instanceof String) {

        auth(ctx, msg);

    } else if(msg instanceof RequestInfo) {

        RequestInfo info = (RequestInfo)msg;

        System.out.println("----------------------------------------------");

        System.out.println("å½“å‰ä¸»æœºipï¼š" +info.getIp());

        System.out.println("å½“å‰ä¸»æœºcpuï¼šæƒ…å†µ");

        Map&lt;String, Object&gt; cpuMap =info.getCpuPercMap();

        System.out.println("æ€»ä½¿ç”¨ç‡ï¼š" +  cpuMap.get("combined"));

        System.out.println("ç”¨æˆ·ä½¿ç”¨ç‡ï¼š" +cpuMap.get("user"));

        System.out.println("ç³»ç»Ÿä½¿ç”¨ç‡ï¼š" +cpuMap.get("sys"));

        System.out.println("ç­‰å¾…ç‡ï¼š" +cpuMap.get("wait"));

        System.out.println("ç©ºé—²ç‡ï¼š" +cpuMap.get("idle"));

        System.out.println("å½“å‰ä¸»æœºmemoryæƒ…å†µï¼š");

        Map&lt;String, Object&gt; memMap =info.getMemoryMap();

        System.out.println("å†…å­˜æ€»é‡ï¼š" +memMap.get("total"));

        System.out.println("å½“å‰å†…å­˜ä½¿ç”¨é‡ï¼š" +memMap.get("used"));

        System.out.println("å½“å‰å†…å­˜å‰©ä½™é‡ï¼š" +memMap.get("free"));

       System.out.println("-----------------------------------------------");

        ctx.writeAndFlush("inforeceived!");

    } else {

        ctx.writeAndFlush("connectfailure").addListener(ChannelFutureListener.CLOSE);

    }

}
</code></pre></div></div>

<p>}</p>

<p>Clientç±»ï¼š</p>

<p>public class Client {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void main(String[] args) {

    EventLoopGroup workerGroup = newNioEventLoopGroup();

    try {

        Bootstrap bootstrap = newBootstrap();

        bootstrap.group(workerGroup)

               .channel(NioSocketChannel.class)

                .handler(newChannelInitializer&lt;SocketChannel&gt;() {

                    @Override

                    protected void initChannel(SocketChannelsc) throws Exception {

                       sc.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingDecoder());

                       sc.pipeline().addLast(MarshallingCodeCFactory.buildMarshallingEncoder());

                       sc.pipeline().addLast(new ClientHeartBeatHandler());

                    }

                });

        ChannelFuture future =bootstrap.connect(new InetSocketAddress("127.0.0.1", 8765)).sync();

        future.channel().closeFuture().sync();

    } catch (Exception e) {

        e.printStackTrace();

    } finally {

        workerGroup.shutdownGracefully();

    }

}
</code></pre></div></div>

<p>}</p>

<p>ClientHeartBeatHandlerç±»ï¼š</p>

<p>public classClientHeartBeatHandler extends ChannelHandlerAdapter {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>private ScheduledExecutorService scheduled= Executors.newScheduledThreadPool(1);

private ScheduledFuture&lt;?&gt; heartBeat;

private InetAddress address;

private static final String SUCCESS_KEY ="auth_success_key";

 

@Override

public voidchannelActive(ChannelHandlerContext ctx) throws Exception {

    address = InetAddress.getLocalHost();

    String ip = address.getHostAddress();

    String key = "1234";

    String auth = ip + "," + key;

    ctx.writeAndFlush(auth);

}

 

@Override

public voidexceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {

    cause.printStackTrace();

    if(heartBeat != null) {

        heartBeat.cancel(true);

        heartBeat = null;

    }

    ctx.fireExceptionCaught(cause);

}

 

@Override

public voidchannelRead(ChannelHandlerContext ctx, Object msg) throws Exception {

    try {

        if(msg instanceof String) {

            String data = (String) msg;

            if(SUCCESS_KEY.equals(data)) {

                heartBeat =scheduled.scheduleWithFixedDelay(new HeartBeatTask(ctx), 0, 5,TimeUnit.SECONDS);

                System.out.println(msg);

            } else {

                System.out.println(msg);

            }

        }

    } finally {

        ReferenceCountUtil.release(msg);

    }

}

 

private class HeartBeatTask implements Runnable{

    private final ChannelHandlerContextctx;

 

    publicHeartBeatTask(ChannelHandlerContext ctx) {

        this.ctx = ctx;

    }

 

    @Override

    public void run() {

        try {

            RequestInfo requestInfo = newRequestInfo();

           requestInfo.setIp(address.getHostAddress());

            Sigar sigar = new Sigar();

            CpuPerc cpuPerc =sigar.getCpuPerc();

            Map&lt;String, Object&gt;cpuPercMap = new HashMap&lt;&gt;();

            cpuPercMap.put("combined",cpuPerc.getCombined());

           cpuPercMap.put("user", cpuPerc.getUser());

            cpuPercMap.put("sys",cpuPerc.getSys());

           cpuPercMap.put("wait", cpuPerc.getWait());

            cpuPercMap.put("idle",cpuPerc.getIdle());

 

            Mem mem = sigar.getMem();

            Map&lt;String, Object&gt;memoryMap = new HashMap&lt;&gt;();

           memoryMap.put("total", mem.getTotal() / (1024 * 1024));

            memoryMap.put("used",mem.getUsed() / (1024 * 1024));

            memoryMap.put("free",mem.getFree() / (1024 * 1024));

 

           requestInfo.setCpuPercMap(cpuPercMap);

           requestInfo.setMemoryMap(memoryMap);

 

            ctx.writeAndFlush(requestInfo);

        } catch (Exception e) {

            e.printStackTrace();

        }

    }

}
</code></pre></div></div>

<p>}</p>

<p>RequestInfoç±»ï¼š</p>

<p>public classRequestInfo implements Serializable {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     private String ip ;

     private Map&lt;String, Object&gt;cpuPercMap ;

     private Map&lt;String, Object&gt;memoryMap;

     //.. other field

 

     public String getIp() {

              return ip;

     }

 

     public void setIp(String ip) {

              this.ip = ip;

     }

 

     public Map&lt;String, Object&gt;getCpuPercMap() {

              return cpuPercMap;

     }

 

     public voidsetCpuPercMap(Map&lt;String, Object&gt; cpuPercMap) {

              this.cpuPercMap = cpuPercMap;

     }

 

     public Map&lt;String, Object&gt;getMemoryMap() {

              return memoryMap;

     }

 

     public void setMemoryMap(Map&lt;String,Object&gt; memoryMap) {

              this.memoryMap = memoryMap;

     }
</code></pre></div></div>

<p>}</p>

<p>MarshallingCodeCFactoryç±»å°±ä¸è´´å‡ºæ¥äº†ï¼Œè·Ÿä¹‹å‰çš„ä¸€æ ·ã€‚
æ¯5ç§’å‘é€ä¸€æ¬¡æ•°æ®åˆ°æœåŠ¡å™¨ç«¯ï¼Œè¿™æ ·ä¸»æœåŠ¡å™¨å°±å¯ä»¥çŸ¥é“æ¯å°ä»æœåŠ¡å™¨çš„çŠ¶æ€äº†ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„å°ä¾‹å­ï¼ŒçœŸå®ç¯å¢ƒä¸­è‚¯å®šéœ€è¦æ›´ä¸¥æ ¼çš„æ ¡éªŒã€‚</p>

<p>ä½œè€…ï¼šéƒ­æ— å¿ƒ
é“¾æ¥ï¼šhttps://www.zhihu.com/question/24322387/answer/78947405
æ¥æºï¼šçŸ¥ä¹
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>

<p>Nettyæ˜¯ä»€ä¹ˆï¼Ÿ1ï¼‰æœ¬è´¨ï¼šJBossåšçš„ä¸€ä¸ªJaråŒ…2ï¼‰ç›®çš„ï¼šå¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é æ€§çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åº3ï¼‰ä¼˜ç‚¹ï¼šæä¾›å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·é€šä¿—çš„è¯´ï¼šä¸€ä¸ªå¥½ä½¿çš„å¤„ç†Socketçš„ä¸œä¸œå¦‚æœæ²¡æœ‰Nettyï¼Ÿè¿œå¤ï¼šjava.net + java.io
è¿‘ä»£ï¼šjava.nio
å…¶ä»–ï¼šMinaï¼ŒGrizzly
ä¸Minaç›¸æ¯”æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ1ã€éƒ½æ˜¯Trustin Leeçš„ä½œå“ï¼ŒNettyæ›´æ™šï¼›2ã€Minaå°†å†…æ ¸å’Œä¸€äº›ç‰¹æ€§çš„è”ç³»è¿‡äºç´§å¯†ï¼Œä½¿å¾—ç”¨æˆ·åœ¨ä¸éœ€è¦è¿™äº›ç‰¹æ€§çš„æ—¶å€™æ— æ³•è„±ç¦»ï¼Œç›¸æ¯”ä¸‹æ€§èƒ½ä¼šæœ‰æ‰€ä¸‹é™ï¼ŒNettyè§£å†³äº†è¿™ä¸ªè®¾è®¡é—®é¢˜ï¼›3ã€Nettyçš„æ–‡æ¡£æ›´æ¸…æ™°ï¼Œå¾ˆå¤šMinaçš„ç‰¹æ€§åœ¨Nettyé‡Œéƒ½æœ‰ï¼›4ã€Nettyæ›´æ–°å‘¨æœŸæ›´çŸ­ï¼Œæ–°ç‰ˆæœ¬çš„å‘å¸ƒæ¯”è¾ƒå¿«ï¼›5ã€å®ƒä»¬çš„æ¶æ„å·®åˆ«ä¸å¤§ï¼ŒMinaé apacheç”Ÿå­˜ï¼Œè€ŒNettyé jbossï¼Œå’Œjbossçš„ç»“åˆåº¦éå¸¸é«˜ï¼ŒNettyæœ‰å¯¹google protocal bufçš„æ”¯æŒï¼Œæœ‰æ›´å®Œæ•´çš„iocå®¹å™¨æ”¯æŒ(spring,guice,jbossmcå’Œosgi)ï¼›6ã€Nettyæ¯”Minaä½¿ç”¨èµ·æ¥æ›´ç®€å•ï¼ŒNettyé‡Œä½ å¯ä»¥è‡ªå®šä¹‰çš„å¤„ç†upstream events æˆ–/å’Œ downstream eventsï¼Œå¯ä»¥ä½¿ç”¨decoderå’Œencoderæ¥è§£ç å’Œç¼–ç å‘é€å†…å®¹ï¼›7ã€Nettyå’ŒMinaåœ¨å¤„ç†UDPæ—¶æœ‰ä¸€äº›ä¸åŒï¼ŒNettyå°†UDPæ— è¿æ¥çš„ç‰¹æ€§æš´éœ²å‡ºæ¥ï¼›è€ŒMinaå¯¹UDPè¿›è¡Œäº†é«˜çº§å±‚æ¬¡çš„æŠ½è±¡ï¼Œå¯ä»¥æŠŠUDPå½“æˆâ€é¢å‘è¿æ¥â€çš„åè®®ï¼Œè€Œè¦Nettyåšåˆ°è¿™ä¸€ç‚¹æ¯”è¾ƒå›°éš¾ã€‚â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€“Nettyçš„ç‰¹æ€§1ï¼‰è®¾è®¡ç»Ÿä¸€çš„APIï¼Œé€‚ç”¨äºä¸åŒçš„åè®®ï¼ˆé˜»å¡å’Œéé˜»å¡ï¼‰åŸºäºçµæ´»ã€å¯æ‰©å±•çš„äº‹ä»¶é©±åŠ¨æ¨¡å‹é«˜åº¦å¯å®šåˆ¶çš„çº¿ç¨‹æ¨¡å‹å¯é çš„æ— è¿æ¥æ•°æ®Socketæ”¯æŒï¼ˆUDPï¼‰2ï¼‰æ€§èƒ½æ›´å¥½çš„ååé‡ï¼Œä½å»¶è¿Ÿæ›´çœèµ„æºå°½é‡å‡å°‘ä¸å¿…è¦çš„å†…å­˜æ‹·è´3ï¼‰å®‰å…¨å®Œæ•´çš„SSL/TLSå’ŒSTARTTLSçš„æ”¯æŒèƒ½åœ¨Appletä¸Androidçš„é™åˆ¶ç¯å¢ƒè¿è¡Œè‰¯å¥½4ï¼‰å¥å£®æ€§ä¸å†å› è¿‡å¿«ã€è¿‡æ…¢æˆ–è¶…è´Ÿè½½è¿æ¥å¯¼è‡´OutOfMemoryErrorä¸å†æœ‰åœ¨é«˜é€Ÿç½‘ç»œç¯å¢ƒä¸‹NIOè¯»å†™é¢‘ç‡ä¸ä¸€è‡´çš„é—®é¢˜5ï¼‰æ˜“ç”¨å®Œå–„çš„JavaDocï¼Œç”¨æˆ·æŒ‡å—å’Œæ ·ä¾‹ç®€æ´ç®€å•ä»…ä¿¡èµ–äºJDK1.5â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-Netty åœ¨å“ªäº›è¡Œä¸šå¾—åˆ°äº†åº”ç”¨ï¼Ÿäº’è”ç½‘è¡Œä¸šï¼šéšç€ç½‘ç«™è§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œç³»ç»Ÿå¹¶å‘è®¿é—®é‡ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œä¼ ç»ŸåŸºäº Tomcat ç­‰ Web å®¹å™¨çš„å‚ç›´æ¶æ„å·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œéœ€è¦æ‹†åˆ†åº”ç”¨è¿›è¡ŒæœåŠ¡åŒ–ï¼Œä»¥æé«˜å¼€å‘å’Œç»´æŠ¤æ•ˆç‡ã€‚ä»ç»„ç½‘æƒ…å†µçœ‹ï¼Œå‚ç›´çš„æ¶æ„æ‹†åˆ†ä¹‹åï¼Œç³»ç»Ÿé‡‡ç”¨åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´éœ€è¦è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Œé«˜æ€§èƒ½çš„ RPC æ¡†æ¶å¿…ä¸å¯å°‘ï¼ŒNetty ä½œä¸ºå¼‚æ­¥é«˜æ€§èƒ½çš„é€šä¿¡æ¡†æ¶ï¼Œå¾€å¾€ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶è¢«è¿™äº› RPC æ¡†æ¶ä½¿ç”¨ã€‚ã€€ã€€å…¸å‹çš„åº”ç”¨æœ‰ï¼šé˜¿é‡Œåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ Dubbo çš„ RPC æ¡†æ¶ä½¿ç”¨ Dubbo åè®®è¿›è¡ŒèŠ‚ç‚¹é—´é€šä¿¡ï¼ŒDubbo åè®®é»˜è®¤ä½¿ç”¨ Netty ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œç”¨äºå®ç°å„è¿›ç¨‹èŠ‚ç‚¹ä¹‹é—´çš„å†…éƒ¨é€šä¿¡ã€‚
    æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ä¹‹é—´ï¼ŒæœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…å’Œæ€§èƒ½ç»Ÿè®¡èŠ‚ç‚¹ä¹‹é—´ä½¿ç”¨ Netty è¿›è¡Œå¼‚æ­¥/åŒæ­¥é€šä¿¡ã€‚ã€€ã€€é™¤äº† Dubbo ä¹‹å¤–ï¼Œæ·˜å®çš„æ¶ˆæ¯ä¸­é—´ä»¶ RocketMQ çš„æ¶ˆæ¯ç”Ÿäº§è€…å’Œæ¶ˆæ¯æ¶ˆè´¹è€…ä¹‹é—´ï¼Œä¹Ÿé‡‡ç”¨ Netty è¿›è¡Œé«˜æ€§èƒ½ã€å¼‚æ­¥é€šä¿¡ã€‚ã€€ã€€é™¤äº†é˜¿é‡Œç³»å’Œæ·˜å®ç³»ä¹‹å¤–ï¼Œå¾ˆå¤šå…¶å®ƒçš„å¤§å‹äº’è”ç½‘å…¬å¸æˆ–è€…ç”µå•†å†…éƒ¨ä¹Ÿå·²ç»å¤§é‡ä½¿ç”¨ Netty æ„å»ºé«˜æ€§èƒ½ã€åˆ†å¸ƒå¼çš„ç½‘ç»œæœåŠ¡å™¨ã€‚æ¸¸æˆè¡Œä¸šï¼šæ— è®ºæ˜¯æ‰‹æ¸¸æœåŠ¡ç«¯ã€è¿˜æ˜¯å¤§å‹çš„ç½‘ç»œæ¸¸æˆï¼ŒJava è¯­è¨€å¾—åˆ°äº†è¶Šæ¥è¶Šå¹¿æ³›çš„åº”ç”¨ã€‚Netty ä½œä¸ºé«˜æ€§èƒ½çš„åŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œå®ƒæœ¬èº«æä¾›äº† TCP/UDP å’Œ HTTP åè®®æ ˆï¼Œéå¸¸æ–¹ä¾¿å®šåˆ¶å’Œå¼€å‘ç§æœ‰åè®®æ ˆã€‚è´¦å·ç™»é™†æœåŠ¡å™¨ã€åœ°å›¾æœåŠ¡å™¨ä¹‹é—´å¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ Netty è¿›è¡Œé«˜æ€§èƒ½çš„é€šä¿¡ï¼Œæ¶æ„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<img src="https://pic2.zhimg.com/50/9adabad98edc4b4e9001e2fc63d6da87_hd.jpg" data-rawwidth="494" data-rawheight="196" class="origin_image zh-lightbox-thumb" width="494" data-original="https://pic2.zhimg.com/9adabad98edc4b4e9001e2fc63d6da87_r.jpg" />ã€€ã€€å›¾1-2 Netty åœ¨æ¸¸æˆæœåŠ¡å™¨æ¶æ„ä¸­çš„åº”ç”¨å¤§æ•°æ®é¢†åŸŸï¼šç»å…¸çš„ Hadoop çš„é«˜æ€§èƒ½é€šä¿¡å’Œåºåˆ—åŒ–ç»„ä»¶ Avro çš„ RPC æ¡†æ¶ï¼Œé»˜è®¤é‡‡ç”¨ Netty è¿›è¡Œè·¨èŠ‚ç‚¹é€šä¿¡ï¼Œå®ƒçš„ Netty Service åŸºäº Netty æ¡†æ¶äºŒæ¬¡å°è£…å®ç°ã€‚ã€€ã€€å¤§æ•°æ®è®¡ç®—å¾€å¾€é‡‡ç”¨å¤šä¸ªè®¡ç®—èŠ‚ç‚¹å’Œä¸€ä¸ª/Nä¸ªæ±‡æ€»èŠ‚ç‚¹è¿›è¡Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå„èŠ‚ç‚¹ä¹‹é—´å­˜åœ¨æµ·é‡çš„æ•°æ®äº¤æ¢ã€‚ç”±äº Netty çš„ç»¼åˆæ€§èƒ½æ˜¯ç›®å‰å„ä¸ªæˆç†Ÿ NIO æ¡†æ¶ä¸­æœ€é«˜çš„ï¼Œå› æ­¤ï¼Œå¾€å¾€ä¼šè¢«é€‰ä¸­ç”¨ä½œå¤§æ•°æ®å„èŠ‚ç‚¹é—´çš„é€šä¿¡ã€‚ä¼ä¸šè½¯ä»¶ï¼šä¼ä¸šå’Œ IT é›†æˆéœ€è¦ ESBï¼ŒNetty å¯¹å¤šåè®®æ”¯æŒã€ç§æœ‰åè®®å®šåˆ¶çš„ç®€æ´æ€§å’Œé«˜æ€§èƒ½æ˜¯ ESB RPC æ¡†æ¶çš„é¦–é€‰é€šä¿¡ç»„ä»¶ã€‚äº‹å®ä¸Šï¼Œå¾ˆå¤šä¼ä¸šæ€»çº¿å‚å•†ä¼šé€‰æ‹© Netty ä½œä¸ºåŸºç¡€é€šä¿¡ç»„ä»¶ï¼Œç”¨äºä¼ä¸šçš„ IT é›†æˆã€‚é€šä¿¡è¡Œä¸šï¼šNetty çš„å¼‚æ­¥é«˜æ€§èƒ½ã€é«˜å¯é æ€§å’Œé«˜æˆç†Ÿåº¦çš„ä¼˜ç‚¹ï¼Œä½¿å®ƒåœ¨é€šä¿¡è¡Œä¸šå¾—åˆ°äº†å¤§é‡çš„åº”ç”¨ã€‚</p>

<p>ä½œè€…ï¼šçŸ¥ä¹ç”¨æˆ·
é“¾æ¥ï¼šhttps://www.zhihu.com/question/24322387/answer/282001188
æ¥æºï¼šçŸ¥ä¹
è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚</p>

<p>ä½œä¸ºä¸€ä¸ªå­¦Javaçš„ï¼Œå¦‚æœæ²¡æœ‰ç ”ç©¶è¿‡Nettyï¼Œé‚£ä¹ˆä½ å¯¹Javaè¯­è¨€çš„ä½¿ç”¨å’Œç†è§£ä»…ä»…åœç•™åœ¨è¡¨é¢æ°´å¹³ï¼Œä¼šç‚¹SSHï¼Œå†™å‡ ä¸ªMVCï¼Œè®¿é—®æ•°æ®åº“å’Œç¼“å­˜ï¼Œè¿™äº›åªæ˜¯åˆç­‰Javaç¨‹åºå‘˜å¹²çš„äº‹ã€‚å¦‚æœä½ è¦è¿›é˜¶ï¼Œæƒ³äº†è§£JavaæœåŠ¡å™¨çš„æ·±å±‚é«˜é˜¶çŸ¥è¯†ï¼ŒNettyç»å¯¹æ˜¯ä¸€ä¸ªå¿…é¡»è¦è¿‡çš„é—¨æ§›ã€‚æœ‰äº†Nettyï¼Œä½ å¯ä»¥å®ç°è‡ªå·±çš„HTTPæœåŠ¡å™¨ï¼ŒFTPæœåŠ¡å™¨ï¼ŒUDPæœåŠ¡å™¨ï¼ŒRPCæœåŠ¡å™¨ï¼ŒWebSocketæœåŠ¡å™¨ï¼ŒRedisçš„ProxyæœåŠ¡å™¨ï¼ŒMySQLçš„ProxyæœåŠ¡å™¨ç­‰ç­‰ã€‚å¦‚æœä½ æƒ³çŸ¥é“Nginxæ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„ï¼Œå¦‚æœä½ æƒ³çŸ¥é“Tomcatå’ŒJettyæ˜¯å¦‚ä½•å®ç°çš„ï¼Œå¦‚æœä½ ä¹Ÿæƒ³å®ç°ä¸€ä¸ªç®€å•çš„RedisæœåŠ¡å™¨ï¼Œé‚£éƒ½åº”è¯¥å¥½å¥½ç†è§£ä¸€ä¸‹Nettyï¼Œå®ƒä»¬é«˜æ€§èƒ½çš„åŸç†éƒ½æ˜¯ç±»ä¼¼çš„ã€‚æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¼ ç»Ÿçš„HTTPæœåŠ¡å™¨çš„åŸç†åˆ›å»ºä¸€ä¸ªServerSocketï¼Œç›‘å¬å¹¶ç»‘å®šä¸€ä¸ªç«¯å£ä¸€ç³»åˆ—å®¢æˆ·ç«¯æ¥è¯·æ±‚è¿™ä¸ªç«¯å£æœåŠ¡å™¨ä½¿ç”¨Acceptï¼Œè·å¾—ä¸€ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„Socketè¿æ¥å¯¹è±¡å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†è¿æ¥è¯»Socketï¼Œå¾—åˆ°å­—èŠ‚æµè§£ç åè®®ï¼Œå¾—åˆ°Httpè¯·æ±‚å¯¹è±¡å¤„ç†Httpè¯·æ±‚ï¼Œå¾—åˆ°ä¸€ä¸ªç»“æœï¼Œå°è£…æˆä¸€ä¸ªHttpResponseå¯¹è±¡ç¼–ç åè®®ï¼Œå°†ç»“æœåºåˆ—åŒ–å­—èŠ‚æµå†™Socketï¼Œå°†å­—èŠ‚æµå‘ç»™å®¢æˆ·ç«¯ç»§ç»­å¾ªç¯æ­¥éª¤3HTTPæœåŠ¡å™¨ä¹‹æ‰€ä»¥ç§°ä¸ºHTTPæœåŠ¡å™¨ï¼Œæ˜¯å› ä¸ºç¼–ç è§£ç åè®®æ˜¯HTTPåè®®ï¼Œå¦‚æœåè®®æ˜¯Redisåè®®ï¼Œé‚£å®ƒå°±æˆäº†RedisæœåŠ¡å™¨ï¼Œå¦‚æœåè®®æ˜¯WebSocketï¼Œé‚£å®ƒå°±æˆäº†WebSocketæœåŠ¡å™¨ï¼Œç­‰ç­‰ã€‚ä½¿ç”¨Nettyä½ å°±å¯ä»¥å®šåˆ¶ç¼–è§£ç åè®®ï¼Œå®ç°è‡ªå·±çš„ç‰¹å®šåè®®çš„æœåŠ¡å™¨ã€‚ä¸Šé¢æˆ‘ä»¬è¯´çš„æ˜¯ä¸€ä¸ªä¼ ç»Ÿçš„å¤šçº¿ç¨‹æœåŠ¡å™¨ï¼Œè¿™ä¸ªä¹Ÿæ˜¯Apacheå¤„ç†è¯·æ±‚çš„æ¨¡å¼ã€‚åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹æ•°é‡å¯èƒ½ä¼šåˆ›å»ºå¤ªå¤šï¼Œæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å‹åŠ›å¤§ï¼Œç³»ç»Ÿè´Ÿè½½ä¹Ÿä¼šæ¯”è¾ƒé«˜ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿäºæ˜¯NIOè¯ç”Ÿäº†ï¼ŒNIOå¹¶ä¸æ˜¯Javaç‹¬æœ‰çš„æ¦‚å¿µï¼ŒNIOä»£è¡¨çš„ä¸€ä¸ªè¯æ±‡å«ç€IOå¤šè·¯å¤ç”¨ã€‚å®ƒæ˜¯ç”±æ“ä½œç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ—©æœŸè¿™ä¸ªæ“ä½œç³»ç»Ÿè°ƒç”¨çš„åå­—æ˜¯selectï¼Œä½†æ˜¯æ€§èƒ½ä½ä¸‹ï¼Œåæ¥æ¸æ¸æ¼”åŒ–æˆäº†Linuxä¸‹çš„epollå’ŒMacé‡Œçš„kqueueã€‚æˆ‘ä»¬ä¸€èˆ¬å°±è¯´æ˜¯epollï¼Œå› ä¸ºæ²¡æœ‰äººæ‹¿è‹¹æœç”µè„‘ä½œä¸ºæœåŠ¡å™¨ä½¿ç”¨å¯¹å¤–æä¾›æœåŠ¡ã€‚è€ŒNettyå°±æ˜¯åŸºäºJava NIOæŠ€æœ¯å°è£…çš„ä¸€å¥—æ¡†æ¶ã€‚ä¸ºä»€ä¹ˆè¦å°è£…ï¼Œå› ä¸ºåŸç”Ÿçš„Java NIOä½¿ç”¨èµ·æ¥æ²¡é‚£ä¹ˆæ–¹ä¾¿ï¼Œè€Œä¸”è¿˜æœ‰è‡­åæ˜­è‘—çš„bugï¼ŒNettyæŠŠå®ƒå°è£…ä¹‹åï¼Œæä¾›äº†ä¸€ä¸ªæ˜“äºæ“ä½œçš„ä½¿ç”¨æ¨¡å¼å’Œæ¥å£ï¼Œç”¨æˆ·ä½¿ç”¨èµ·æ¥ä¹Ÿå°±ä¾¿æ·å¤šäº†ã€‚é‚£NIOç©¶ç«Ÿæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼ŸNIOçš„å…¨ç§°æ˜¯NoneBlocking IOï¼Œéé˜»å¡IOï¼ŒåŒºåˆ«ä¸BIOï¼ŒBIOçš„å…¨ç§°æ˜¯Blocking IOï¼Œé˜»å¡IOã€‚é‚£è¿™ä¸ªé˜»å¡æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼ŸAcceptæ˜¯é˜»å¡çš„ï¼Œåªæœ‰æ–°è¿æ¥æ¥äº†ï¼ŒAcceptæ‰ä¼šè¿”å›ï¼Œä¸»çº¿ç¨‹æ‰èƒ½ç»§Readæ˜¯é˜»å¡çš„ï¼Œåªæœ‰è¯·æ±‚æ¶ˆæ¯æ¥äº†ï¼ŒReadæ‰èƒ½è¿”å›ï¼Œå­çº¿ç¨‹æ‰èƒ½ç»§ç»­å¤„ç†Writeæ˜¯é˜»å¡çš„ï¼Œåªæœ‰å®¢æˆ·ç«¯æŠŠæ¶ˆæ¯æ”¶äº†ï¼ŒWriteæ‰èƒ½è¿”å›ï¼Œå­çº¿ç¨‹æ‰èƒ½ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªè¯·æ±‚æ‰€ä»¥ä¼ ç»Ÿçš„å¤šçº¿ç¨‹æœåŠ¡å™¨æ˜¯BlockingIOæ¨¡å¼çš„ï¼Œä»å¤´åˆ°å°¾æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ˜¯é˜»å¡çš„ã€‚è¿™äº›çº¿ç¨‹å°±å¹²ç­‰åœ¨å“ªé‡Œï¼Œå ç”¨äº†æ“ä½œç³»ç»Ÿçš„è°ƒåº¦èµ„æºï¼Œä»€ä¹ˆäº‹ä¹Ÿä¸å¹²ï¼Œæ˜¯æµªè´¹ã€‚é‚£ä¹ˆNIOæ˜¯æ€ä¹ˆåšåˆ°éé˜»å¡çš„å‘¢ã€‚å®ƒç”¨çš„æ˜¯äº‹ä»¶æœºåˆ¶ã€‚å®ƒå¯ä»¥ç”¨ä¸€ä¸ªçº¿ç¨‹æŠŠAcceptï¼Œè¯»å†™æ“ä½œï¼Œè¯·æ±‚å¤„ç†çš„é€»è¾‘å…¨å¹²äº†ã€‚å¦‚æœä»€ä¹ˆäº‹éƒ½æ²¡å¾—åšï¼Œå®ƒä¹Ÿä¸ä¼šæ­»å¾ªç¯ï¼Œå®ƒä¼šå°†çº¿ç¨‹ä¼‘çœ èµ·æ¥ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶æ¥äº†å†ç»§ç»­å¹²æ´»ï¼Œè¿™æ ·çš„ä¸€ä¸ªçº¿ç¨‹ç§°ä¹‹ä¸ºNIOçº¿ç¨‹ã€‚while true {
    events = takeEvents(fds)  // è·å–äº‹ä»¶ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œçº¿ç¨‹å°±ä¼‘çœ 
    for event in events {
        if event.isAcceptable {
            doAccept() // æ–°é“¾æ¥æ¥äº†
        } elif event.isReadable {
            request = doRead() // è¯»æ¶ˆæ¯
            if request.isComplete() {
                doProcess()
            }
        } elif event.isWriteable {
            doWrite()  // å†™æ¶ˆæ¯
        }
    }
}
NIOçš„æµç¨‹å¤§è‡´å°±æ˜¯ä¸Šé¢çš„ä¼ªä»£ç æè¿°çš„è¿‡ç¨‹ï¼Œè·Ÿå®é™…çœŸå®çš„ä»£ç æœ‰è¾ƒå¤šå·®å¼‚ï¼Œä¸è¿‡å¯¹äºåˆå­¦è€…ï¼Œè¿™æ ·ç†è§£ä¹Ÿæ˜¯è¶³å¤Ÿäº†ã€‚Nettyæ˜¯å»ºç«‹åœ¨NIOåŸºç¡€ä¹‹ä¸Šï¼ŒNettyåœ¨NIOä¹‹ä¸Šåˆæä¾›äº†æ›´é«˜å±‚æ¬¡çš„æŠ½è±¡ã€‚åœ¨Nettyé‡Œé¢ï¼ŒAcceptè¿æ¥å¯ä»¥ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ± å»å¤„ç†ï¼Œè¯»å†™æ“ä½œåˆæ˜¯å¦å¤–çš„çº¿ç¨‹æ± æ¥å¤„ç†ã€‚Acceptè¿æ¥å’Œè¯»å†™æ“ä½œä¹Ÿå¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªçº¿ç¨‹æ± æ¥è¿›è¡Œå¤„ç†ã€‚è€Œè¯·æ±‚å¤„ç†é€»è¾‘æ—¢å¯ä»¥ä½¿ç”¨å•ç‹¬çš„çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œä¹Ÿå¯ä»¥è·Ÿæ”¾åœ¨è¯»å†™çº¿ç¨‹ä¸€å—å¤„ç†ã€‚çº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯NIOçº¿ç¨‹ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œç»„è£…ï¼Œæ„é€ å‡ºæ»¡è¶³ç³»ç»Ÿéœ€æ±‚çš„å¹¶å‘æ¨¡å‹ã€‚Nettyæä¾›äº†å†…ç½®çš„å¸¸ç”¨ç¼–è§£ç å™¨ï¼ŒåŒ…æ‹¬è¡Œç¼–è§£ç å™¨ï¼»ä¸€è¡Œä¸€ä¸ªè¯·æ±‚ï¼½ï¼Œå‰ç¼€é•¿åº¦ç¼–è§£ç å™¨ï¼»å‰Nä¸ªå­—èŠ‚å®šä¹‰è¯·æ±‚çš„å­—èŠ‚é•¿åº¦ï¼½ï¼Œå¯é‡æ”¾è§£ç å™¨ï¼»è®°å½•åŠåŒ…æ¶ˆæ¯çš„çŠ¶æ€ï¼½ï¼ŒHTTPç¼–è§£ç å™¨ï¼ŒWebSocketæ¶ˆæ¯ç¼–è§£ç å™¨ç­‰ç­‰Nettyæä¾›äº†ä¸€äº›åˆ—ç”Ÿå‘½å‘¨æœŸå›è°ƒæ¥å£ï¼Œå½“ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå½“ä¸€ä¸ªè¿æ¥å…³é—­æ—¶ï¼Œå½“ä¸€ä¸ªè¿æ¥å»ºç«‹æ—¶ï¼Œç”¨æˆ·éƒ½ä¼šæ”¶åˆ°å›è°ƒäº‹ä»¶ï¼Œç„¶åè¿›è¡Œé€»è¾‘å¤„ç†ã€‚Nettyå¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªç«¯å£ï¼Œå¯ä»¥ä½¿ç”¨NIOå®¢æˆ·ç«¯æ¨¡å‹ï¼Œè¿™äº›å¯¹äºRPCæœåŠ¡æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚Nettyé™¤äº†å¯ä»¥å¤„ç†TCP Socketä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¤„ç†UDP Socketã€‚åœ¨æ¶ˆæ¯è¯»å†™è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¤§é‡ä½¿ç”¨ByteBufferï¼ŒNettyå¯¹ByteBufferåœ¨æ€§èƒ½å’Œä½¿ç”¨çš„ä¾¿æ·æ€§ä¸Šéƒ½è¿›è¡Œäº†ä¼˜åŒ–å’ŒæŠ½è±¡ã€‚æ€»ä¹‹ï¼ŒNettyæ˜¯Javaç¨‹åºå‘˜è¿›é˜¶çš„å¿…å¤‡ç¥å¥‡ã€‚å¦‚æœä½ çŸ¥å…¶ç„¶ï¼Œè¿˜æƒ³çŸ¥å…¶æ‰€ä»¥ç„¶ï¼Œä¸€å®šè¦å¥½å¥½ç ”ç©¶ä¸‹Nettyã€‚å¦‚æœä½ è§‰å¾—Javaæ¯ç‡¥æ— è°“ï¼ŒNettyåˆ™æ˜¯é‡æ–°å¼€å¯ä½ å¯¹Javaå…´è¶£å¤§é—¨çš„é’¥åŒ™ã€‚</p>
:ET