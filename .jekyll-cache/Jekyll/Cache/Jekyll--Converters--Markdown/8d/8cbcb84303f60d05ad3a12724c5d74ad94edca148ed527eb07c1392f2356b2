I"É@<p>å®‰è£…
go get github.com/uber/go-torch</p>
<h1 id="å†å®‰è£…-brendangreggflamegraph">å†å®‰è£… brendangregg/FlameGraph</h1>
<p>export PATH=$PATH:/absolute/path/FlameGraph-master</p>
<h1 id="è¿˜éœ€è¦å®‰è£…ä¸€ä¸ªgraphvizç”¨æ¥ç”»å†…å­˜å›¾">è¿˜éœ€è¦å®‰è£…ä¸€ä¸ªgraphvizç”¨æ¥ç”»å†…å­˜å›¾</h1>
<p>yum install graphviz</p>

<p>https://studygolang.com/articles/11556
<!-- more -->
1.å®‰è£…ç»„ä»¶
å®‰è£…go-torch
go get github.com/uber/go-torch
å®‰è£… FlameGraph
cd $WORK_PATH &amp;&amp; git clone https://github.com/brendangregg/FlameGraph.git
export PATH=$PATH:$WORK_PATH/FlameGraph
å®‰è£…graphviz
yum install graphviz(CentOS, Redhat)</p>

<p>import â€œnet/httpâ€
import _ â€œnet/http/pprofâ€
func main() {
    // ä¸»å‡½æ•°ä¸­æ·»åŠ 
    go func() {
		http.HandleFunc(â€œ/program/htmlâ€, htmlHandler) // ç”¨æ¥æŸ¥çœ‹è‡ªå®šä¹‰çš„å†…å®¹
		log.Println(http.ListenAndServe(â€œ0.0.0.0:8080â€, nil))
	}()
}</p>

<p>ä½¿ç”¨</p>
<h1 id="ç”¨--u-åˆ†æcpuä½¿ç”¨æƒ…å†µ">ç”¨ -u åˆ†æCPUä½¿ç”¨æƒ…å†µ</h1>
<p>./go-torch -u http://127.0.0.1:8080</p>
<h1 id="ç”¨--alloc_space-æ¥åˆ†æå†…å­˜çš„ä¸´æ—¶åˆ†é…æƒ…å†µ">ç”¨ -alloc_space æ¥åˆ†æå†…å­˜çš„ä¸´æ—¶åˆ†é…æƒ…å†µ</h1>
<p>./go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem</p>
<h1 id="ç”¨--inuse_space-æ¥åˆ†æç¨‹åºå¸¸é©»å†…å­˜çš„å ç”¨æƒ…å†µ">ç”¨ -inuse_space æ¥åˆ†æç¨‹åºå¸¸é©»å†…å­˜çš„å ç”¨æƒ…å†µï¼›</h1>
<p>./go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem</p>
<h1 id="ç”»å‡ºå†…å­˜åˆ†é…å›¾">ç”»å‡ºå†…å­˜åˆ†é…å›¾</h1>
<p>go tool pprof -alloc_space -cum -svg http://127.0.0.1:8080/debug/pprof/heap &gt; heap.svg</p>

<p>æŸ¥çœ‹
ä½¿ç”¨æµè§ˆå™¨æŸ¥çœ‹svgæ–‡ä»¶ï¼Œç¨‹åºè¿è¡Œä¸­ï¼Œå¯ä»¥ç™»å½• http://127.0.0.1:10086/debug/pprof/ æŸ¥çœ‹ç¨‹åºå®æ—¶çŠ¶æ€ åœ¨æ­¤åŸºç¡€ä¸Šï¼Œå¯ä»¥é€šè¿‡é…ç½®handleæ¥å®ç°è‡ªå®šä¹‰çš„å†…å®¹æŸ¥çœ‹ï¼Œå¯ä»¥æ·»åŠ Htmlæ ¼å¼çš„è¾“å‡ºï¼Œä¼˜åŒ–æ˜¾ç¤ºæ•ˆæœ</p>

<p>func writeBuf(buffer <em>bytes.Buffer, format string, a â€¦interface{}) {
	(</em>buffer).WriteString(fmt.Sprintf(format, aâ€¦))
}
func htmlHandler(w http.ResponseWriter, req *http.Request) {
	io.WriteString(w, statusHtml())
}
// è®¿é—® localhost:8080/program/html å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè¡¨æ ¼ï¼Œä¸€ç§’é’Ÿåˆ·æ–°ä¸€æ¬¡
func statusHtml() string {
	var buf bytes.Buffer
	buf.WriteString(â€œ&lt;html&gt;&lt;meta http-equiv="refresh" content="1"&gt;â€ +
		â€œ&lt;body&gt;&lt;h2&gt;netflow-decoder status count&lt;/h2&gt;â€ +
		â€œ&lt;table width="500px" border="1" cellpadding="5" cellspacing="1"&gt;â€ +
		â€œ&lt;tr&gt;&lt;th&gt;NAME&lt;/th&gt;&lt;th&gt;TOTAL&lt;/th&gt;&lt;th&gt;SPEED&lt;/th&gt;&lt;/tr&gt;â€)
	writeBuf(&amp;buf, â€œ&lt;tr&gt;&lt;td&gt;UDP&lt;/td&gt;&lt;td&gt;%d&lt;/td&gt;&lt;td&gt;%d&lt;/td&gt;&lt;/tr&gt;â€,
		lastRecord.RecvUDP, currSpeed.RecvUDP)
	â€¦
	writeBuf(&amp;buf, â€œ&lt;/table&gt;&lt;p&gt;Count time: %s&lt;/p&gt;&lt;p&gt;Time now: %s&lt;/p&gt;â€,
		countTime.Format(â€œ2006-01-02 15:04:05â€), time.Now().Format(â€œ2006-01-02 15:04:05â€))
	buf.WriteString(â€œ&lt;/body&gt;&lt;/html&gt;â€)
	return buf.String()
}</p>

<p>#!/bin/bash
go build -o m  main.go
./m</p>

<p>$go-torch -u http://127.0.0.1:8080
INFO[13:48:29] Run pprof command: go tool pprof -raw -seconds 30 http://127.0.0.1:8080/debug/pprof/profile
ERROR: No stack counts found</p>

<p>$go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem
INFO[13:51:37] Run pprof command: go tool pprof -raw -seconds 30 -alloc_space http://127.0.0.1:8080/debug/pprof/heap
INFO[13:51:37] Writing svg to torch.svg</p>

<p>$go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap â€“colors=mem
INFO[13:53:28] Run pprof command: go tool pprof -raw -seconds 30 -inuse_space http://127.0.0.1:8080/debug/pprof/heap
INFO[13:53:28] Writing svg to torch.svg</p>

<p>$go tool pprof -alloc_space -cum -svg http://127.0.0.1:8080/debug/pprof/heap &gt; heap.svg
Fetching profile over HTTP from http://127.0.0.1:8080/debug/pprof/heap
Saved profile in /Users/didi/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.006.pb.gz</p>

<p>å¯åŠ¨æœåŠ¡
ä½¿ç”¨å·¥å…·è¿›è¡Œæ‰“å‹ï¼Œå‹è‡³ç¨‹åºé—®é¢˜æš´éœ²
ä½¿ç”¨go tool pprof http://localhost:9999/pprof/profileæ”¶é›†æ•°æ®ï¼Œæ”¶é›†30sååœ¨è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼åè¾“å…¥quité€€å‡ºï¼Œä¼šç”Ÿæˆåä¸ºã€pprof.äºŒè¿›åˆ¶å.samples.cpu.00x.pb.gzã€‘çš„æ–‡ä»¶ï¼Œé»˜è®¤æ”¾åˆ°$HOME/pprof/ä¸‹
ä½¿ç”¨go tool pprof -http=:8080 [æ­¥éª¤5ä¸­ç”Ÿæˆçš„æ–‡ä»¶]è§£é‡Šæ•°æ®å¹¶ç”Ÿæˆè°ƒç”¨æ ˆgraphå›¾ç¤ºï¼Œç‚¹å‡»viewåˆ‡æ¢æˆç«ç„°å›¾ï¼Œ</p>

<p>ç«ç„°å›¾(æˆ–è€…å«å†°æŸ±å›¾)ä¼šé»˜è®¤ä»å·¦åˆ°å³æŒ‰å¤„ç†æ—¶é—´ä»å¤§åˆ°å°æ’åˆ—ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜ï¼›
æ ¹æ®ç«ç„°å›¾çš„ç»“æœï¼Œåˆ†æç¨‹åºå“åº”å˜æ…¢æ—¶ï¼Œå“ªä¸ªå‡½æ•°å æ®äº†æ›´å¤šçš„å¤„ç†æ—¶é—´ï¼Œå¯ä»¥æ›´ç›´è§‚çš„å®šä½é—®é¢˜</p>

<p>Golangçš„æ€§èƒ½è°ƒä¼˜æ‰‹æ®µ
Goè¯­è¨€å†…ç½®çš„CPUå’ŒHeap profiler
Goå¼ºå¤§ä¹‹å¤„æ˜¯å®ƒå·²ç»åœ¨è¯­è¨€å±‚é¢é›†æˆäº†profileé‡‡æ ·å·¥å…·,å¹¶ä¸”å…è®¸æˆ‘ä»¬åœ¨ç¨‹åºçš„è¿è¡Œæ—¶ä½¿ç”¨å®ƒä»¬ï¼Œ
ä½¿ç”¨Goçš„profileræˆ‘ä»¬èƒ½è·å–ä»¥ä¸‹çš„æ ·æœ¬ä¿¡æ¯ï¼š
CPU profiles
Heap profiles
block profileã€tracesç­‰</p>

<p>Goè¯­è¨€å¸¸è§çš„profilingä½¿ç”¨åœºæ™¯
åŸºå‡†æµ‹è¯•æ–‡ä»¶ï¼šä¾‹å¦‚ä½¿ç”¨å‘½ä»¤go test . -bench . -cpuprofile prof.cpu ç”Ÿæˆé‡‡æ ·æ–‡ä»¶åï¼Œå†é€šè¿‡å‘½ä»¤ go tool pprof [binary] prof.cpu æ¥è¿›è¡Œåˆ†æã€‚</p>

<p>import _ net/http/pprofï¼šå¦‚æœæˆ‘ä»¬çš„åº”ç”¨æ˜¯ä¸€ä¸ªwebæœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨httpæœåŠ¡å¯åŠ¨çš„ä»£ç æ–‡ä»¶(eg: main.go)æ·»åŠ  import _ net/http/pprofï¼Œè¿™æ ·æˆ‘ä»¬çš„æœåŠ¡ ä¾¿èƒ½è‡ªåŠ¨å¼€å¯profileåŠŸèƒ½ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç›´æ¥åˆ†æé‡‡æ ·ç»“æœã€‚</p>

<p>é€šè¿‡åœ¨ä»£ç é‡Œé¢è°ƒç”¨ runtime.StartCPUProfileæˆ–è€…runtime.WriteHeapProfile</p>

<p>go-torchæ˜¯Uber
å…¬å¸å¼€æºçš„ä¸€æ¬¾é’ˆå¯¹Goè¯­è¨€ç¨‹åºçš„ç«ç„°å›¾ç”Ÿæˆå·¥å…·ï¼Œèƒ½æ”¶é›† stack traces,å¹¶æŠŠå®ƒä»¬æ•´ç†æˆç«ç„°å›¾ï¼Œç›´è§‚åœ°ç¨‹åºç»™å¼€å‘äººå‘˜ã€‚
go-torchæ˜¯åŸºäºä½¿ç”¨BrendanGreggåˆ›å»ºçš„ç«ç„°å›¾å·¥å…·ç”Ÿæˆç›´è§‚çš„å›¾åƒï¼Œå¾ˆæ–¹ä¾¿åœ°åˆ†æGoçš„å„ä¸ªæ–¹æ³•æ‰€å ç”¨çš„CPUçš„æ—¶é—´ï¼Œ ç«ç„°å›¾æ˜¯ä¸€ä¸ªæ–°çš„æ–¹æ³•æ¥å¯è§†åŒ–CPUçš„ä½¿ç”¨æƒ…å†µï¼Œæœ¬æ–‡ä¸­æˆ‘ä¼šå±•ç¤ºå¦‚ä½•ä½¿ç”¨å®ƒè¾…åŠ©æˆ‘ä»¬æ’æŸ¥é—®é¢˜ã€‚</p>

<p>å®‰è£…
1.é¦–å…ˆï¼Œæˆ‘ä»¬è¦é…ç½®FlameGraph
çš„è„šæœ¬
FlameGraph æ˜¯profileæ•°æ®çš„å¯è§†åŒ–å±‚å·¥å…·ï¼Œå·²è¢«å¹¿æ³›ç”¨äºPythonå’ŒNode
git clone https://github.com/brendangregg/FlameGraph.git</p>

<p>2.æ£€å‡ºå®Œæˆåï¼ŒæŠŠflamegraph.pl
æ‹·åˆ°æˆ‘ä»¬æœºå™¨ç¯å¢ƒå˜é‡$PATHçš„è·¯å¾„ä¸­å»ï¼Œä¾‹å¦‚ï¼š
cp flamegraph.pl /usr/local/bin</p>

<p>3.åœ¨ç»ˆç«¯è¾“å…¥ flamegraph.pl -h
æ˜¯å¦å®‰è£…FlameGraphæˆåŠŸ
$ flamegraph.pl -hOption h is ambiguous (hash, height, help)USAGE: /usr/local/bin/flamegraph.pl [options] infile &gt; outfile.svg â€“title # change title text â€“width # width of image (default 1200) â€“height # height of each frame (default 16) â€“minwidth # omit smaller functions (default 0.1 pixels) â€“fonttype # font type (default â€œVerdanaâ€) â€“fontsize # font size (default 12) â€“countname # count type label (default â€œsamplesâ€) â€“nametype # name type label (default â€œFunction:â€) â€“colors # set color palette. choices are: hot (default), mem, io, # wakeup, chain, java, js, perl, red, green, blue, aqua, # yellow, purple, orange â€“hash # colors are keyed by function name hash â€“cp # use consistent palette (palette.map) â€“reverse # generate stack-reversed flame graph â€“inverted # icicle graph â€“negate # switch differential hues (blue&lt;-&gt;red) â€“help # this message eg, /usr/local/bin/flamegraph.pl â€“title=â€Flame Graph: malloc()â€ trace.txt &gt; graph.svg</p>

<p>4.å®‰è£…go-torch
æœ‰äº†flamegraphçš„æ”¯æŒï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥è¦ä½¿ç”¨go-torchå±•ç¤ºprofileçš„è¾“å‡ºï¼Œè€Œå®‰è£…go-torchå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯å®Œæˆå®‰è£…
go get -v github.com/uber/go-torch</p>

<p>5.ä½¿ç”¨go-torchå‘½ä»¤
$ go-torch -hUsage: go-torch [options] [binary] <profile source="">pprof Options: -u, --url= Base URL of your Go program (default: http://localhost:8080) -s, --suffix= URL path of pprof profile (default: /debug/pprof/profile) -b, --binaryinput= File path of previously saved binary profile. (binary profile is anything accepted by https://golang.org/cmd/pprof) --binaryname= File path of the binary that the binaryinput is for, used for pprof inputs -t, --seconds= Number of seconds to profile for (default: 30) --pprofArgs= Extra arguments for pprofOutput Options: -f, --file= Output file name (must be .svg) (default: torch.svg) -p, --print Print the generated svg to stdout instead of writing to file -r, --raw Print the raw call graph output to stdout instead of creating a flame graph; use with Brendan Gregg's flame graph perl script (see https://github.com/brendangregg/FlameGraph) --title= Graph title to display in the output file (default: Flame Graph) --width= Generated graph width (default: 1200) --hash Colors are keyed by function name hash --colors= set color palette. choices are: hot (default), mem, io, wakeup, chain, java, js, perl, red, green, blue, aqua, yellow, purple, orange --cp Use consistent palette (palette.map) --reverse Generate stack-reversed flame graph --inverted icicle graphHelp Options: -h, --help Show this help message</profile></p>

<p>https://github.com/uber-archive/go-torch
https://blog.golang.org/profiling-go-programs</p>

<p>å†…å­˜ä½¿ç”¨è°ƒä¼˜
å†…å­˜è°ƒä¼˜ä¸»è¦æ˜¯ä½¿ç”¨ä¸Šé¢é‚£ä¸ªpprofå›¾ï¼Œè§‚å¯Ÿæµç¨‹æ˜¯å¦åˆç†ï¼Œæ˜¯å¦å¯ä»¥ç®€åŒ–ï¼Œä»¥åŠæ¯ä¸ªå‡½æ•°çš„å†…å­˜åˆ†é…æƒ…å†µï¼Œå…·ä½“è¿‡ç¨‹ä¸åƒä¸Šé¢é‚£ä¹ˆæ¸…æ´—ï¼Œéƒ½æ˜¯å°ä¿®å°è¡¥ï¼Œæ•…ç›´æ¥æ€»ç»“ä¸€äº›å¯èƒ½ä¸å¤Ÿå¯é çš„ç»éªŒï¼š</p>

<p>å‡å°‘ä¸å¿…è¦çš„ä¸´æ—¶å˜é‡ï¼Œå‡½æ•°çš„å‚æ•°å¦‚æœæ¯”è¾ƒé•¿åˆ™åº”è¯¥ä¼ é€’æŒ‡é’ˆ
åœ¨å­—èŠ‚æµå¤„ç†ä¸­ï¼ŒåŸæ¥ç»å¸¸å‡ºç°ä½¿ç”¨ bytes.NewBuffer(buffer) ä½œä¸ºå‚æ•°çš„æƒ…å†µï¼Œè¿™ç§ç”¨æ³•æ˜¯ä¸ºäº†ä½¿ç”¨ bytes.Buffer çš„ä¸€ç³»åˆ—å‡½æ•°ï¼Œä½†æ˜¯éœ€è¦é‡æ–°ç”³è¯·ä¸€æ¬¡ç©ºé—´ï¼Œå…¶å®è¿™æ ·ä¼šå¤šç”³è¯·ä¸€ä¸ªbytes.Bufferå¯¹è±¡ï¼Œå¦‚æœæ“ä½œæ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç›´æ¥å¯¹bufferæ•°ç»„è¿›è¡Œï¼Œä¸ç”¨è½¬æ¢ã€‚è¿˜æœ‰å°±æ˜¯ string çš„è½¬æ¢ä¹Ÿä¼šç”³è¯·ç©ºé—´ï¼Œæ¯”å¦‚æŠŠ []byte è½¬ string ï¼Œåšä¸ªç®€å•çš„å¤„ç†åˆè½¬æˆ []byte å‘é€å‡ºå» ï¼Œå¯ä»¥å°½é‡å»æ‰ä¸­é—´çš„è¿‡ç¨‹
å¦‚æœå·²çŸ¥åˆ‡ç‰‡å¤§å°ï¼Œç›´æ¥makeå‡ºæŒ‡å®šé•¿åº¦ï¼Œå¦åˆ™é¢‘ç¹çš„ grow å ç”¨èµ„æº</p>

<p>google/pprofæ˜¯ä¸€ä¸ªæ€§èƒ½å¯è§†åŒ–å’Œåˆ†æå·¥å…·ï¼Œç”±Googleçš„å·¥ç¨‹å¸ˆå¼€å‘ã€‚è™½ç„¶è‡ªç§°ä¸æ˜¯Googleå®˜æ–¹çš„å·¥å…·ï¼Œä½†æ˜¯é¡¹ç›®æŒ‚åœ¨googleçš„teamä¸‹ï¼Œè€Œä¸”è¿˜åœ¨Googleå…¶å®ƒé¡¹ç›®ä¸­å¾—åˆ°åº”ç”¨ï¼Œæ˜¯éå¸¸å¥½çš„ä¸€ä¸ªæ€§èƒ½å‰–æå·¥å…·ã€‚</p>

<p>go tool pprof å¤åˆ¶äº†ä¸€ä»½google/pprofçš„ä»£ç ï¼Œ å°è£…äº†ä¸€ä¸ªgolangçš„å·¥å…·ï¼Œç”¨æ¥åˆ†æGo pprofåŒ…äº§ç”Ÿçš„å‰–ææ•°æ®,ä¹Ÿå°±æ˜¯æœ€ç»ˆæ•°æ®çš„å¤„ç†å’Œåˆ†æè¿˜æ˜¯é€šè¿‡gogole/pprofæ¥å®ç°çš„ã€‚</p>

<p>è¿™æ ·ï¼Œä½ è‡³å°‘å°±ç”¨ä¸¤ç§æ–¹å¼æ¥åˆ†æGoç¨‹åºçš„ pprofæ•°æ®ï¼š</p>

<p>go tool pprof : Goå°è£…çš„pprofçš„å·¥å…·
pprof: åŸå§‹çš„pprofå·¥å…·
pprofè¯»å†™ä¸€ç»„profile.protoæ ¼å¼çš„æ•°æ®ï¼Œäº§ç”Ÿå¯è§†åŒ–çš„æ•°æ®åˆ†ææŠ¥å‘Šï¼Œæ•°æ®æ˜¯protocol bufferæ ¼å¼çš„æ•°æ®ï¼Œå…·ä½“æ ¼å¼å¯ä»¥å‚è€ƒ: profile.protoã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥åˆ†æå¯ä»¥ä»»æ„äº§ç”Ÿè¿™ç§æ ¼å¼çš„ç¨‹åºï¼Œä¸ç®¡ç¨‹åºæ˜¯ä»€ä¹ˆè¯­è¨€å¼€å‘çš„ã€‚</p>

<p>å®ƒå¯ä»¥è¯»å–æœ¬åœ°çš„å‰–ææ•°æ®ï¼Œæˆ–è€…é€šè¿‡httpè®¿é—®çº¿ä¸Šçš„å®æ—¶çš„å‰–ææ•°æ®ï¼Œå…·ä½“ä½¿ç”¨æ–¹æ³•å¯ä»¥å‚è€ƒå®˜æ–¹çš„è¯´æ˜ã€‚</p>

<p>ä»Šå¤©8æœˆä»½çš„æ—¶å€™ï¼Œpprofå‘å¸ƒäº†æ–°çš„UIã€‚ æ–°çš„UIæä¾›äº†é¡¶éƒ¨èœå•(å·¥å…·æ )ï¼Œ å¯ä»¥æä¾›å„ç§ä¸åŒçš„åŠŸèƒ½çš„åˆ‡æ¢ï¼Œéå¸¸çš„æ–¹ä¾¿ã€‚ åŒæ—¶ï¼Œå±•ç¤ºä¹Ÿæä¾›äº†æ–°çš„æ ·å¼ï¼Œæ›´åŠ çš„å¥½çœ‹ï¼ŒSVGå›¾ä¸­çš„å±•ç¤ºä¹Ÿæ›´åŠ é†’ç›®ã€‚</p>

<p>ç°åœ¨, å¦ä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½ç«ç„°å›¾ä¹Ÿè¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬ä¸ç”¨å†åˆ©ç”¨ç¬¬ä¸‰æ–¹çš„å·¥å…·go-torchç­‰æ¥æŸ¥çœ‹ç«ç„°å›¾ã€‚ è¿™ä¹Ÿæ„å‘³ç€ï¼Œ æ˜å¹´äºŒæœˆä»½å‘å¸ƒçš„Go 1.10ä¸­æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡go tool pprofæŸ¥çœ‹ç«ç„°å›¾äº†ã€‚</p>

<p>å¦‚æœä½ ä¸æƒ³ç­‰å¾…åˆ°æ˜å¹´äºŒæœˆä»½ï¼Œä½ å¯ä»¥ä¸‹è½½æœ€æ–°çš„pprofæ¥æŸ¥çœ‹ã€‚</p>

<p>go get -u github.com/google/pprof</p>

<p>ä¸€ã€perf å‘½ä»¤
è®©æˆ‘ä»¬ä» perf å‘½ä»¤ï¼ˆperformance çš„ç¼©å†™ï¼‰è®²èµ·ï¼Œå®ƒæ˜¯ Linux ç³»ç»ŸåŸç”Ÿæä¾›çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œä¼šè¿”å› CPU æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°åä»¥åŠè°ƒç”¨æ ˆï¼ˆstackï¼‰ã€‚</p>

<p>é€šå¸¸ï¼Œå®ƒçš„æ‰§è¡Œé¢‘ç‡æ˜¯ 99Hzï¼ˆæ¯ç§’99æ¬¡ï¼‰ï¼Œå¦‚æœ99æ¬¡éƒ½è¿”å›åŒä¸€ä¸ªå‡½æ•°åï¼Œé‚£å°±è¯´æ˜ CPU è¿™ä¸€ç§’é’Ÿéƒ½åœ¨æ‰§è¡ŒåŒä¸€ä¸ªå‡½æ•°ï¼Œå¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚</p>

<p>$ sudo perf record -F 99 -p 13204 -g â€“ sleep 30
ä¸Šé¢çš„ä»£ç ä¸­ï¼Œperf recordè¡¨ç¤ºè®°å½•ï¼Œ-F 99è¡¨ç¤ºæ¯ç§’99æ¬¡ï¼Œ-p 13204æ˜¯è¿›ç¨‹å·ï¼Œå³å¯¹å“ªä¸ªè¿›ç¨‹è¿›è¡Œåˆ†æï¼Œ-gè¡¨ç¤ºè®°å½•è°ƒç”¨æ ˆï¼Œsleep 30åˆ™æ˜¯æŒç»­30ç§’ã€‚</p>

<p>è¿è¡Œåä¼šäº§ç”Ÿä¸€ä¸ªåºå¤§çš„æ–‡æœ¬æ–‡ä»¶ã€‚å¦‚æœä¸€å°æœåŠ¡å™¨æœ‰16ä¸ª CPUï¼Œæ¯ç§’æŠ½æ ·99æ¬¡ï¼ŒæŒç»­30ç§’ï¼Œå°±å¾—åˆ° 47,520 ä¸ªè°ƒç”¨æ ˆï¼Œé•¿è¾¾å‡ åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡è¡Œã€‚</p>

<p>ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œperf recordå‘½ä»¤å¯ä»¥ç»Ÿè®¡æ¯ä¸ªè°ƒç”¨æ ˆå‡ºç°çš„ç™¾åˆ†æ¯”ï¼Œç„¶åä»é«˜åˆ°ä½æ’åˆ—ã€‚</p>

<p>$ sudo perf report -n â€“stdio</p>

<p>è¿™ä¸ªç»“æœè¿˜æ˜¯ä¸æ˜“è¯»ï¼Œæ‰€ä»¥æ‰æœ‰äº†ç«ç„°å›¾ã€‚</p>

<p>äºŒã€ç«ç„°å›¾çš„å«ä¹‰
ç«ç„°å›¾æ˜¯åŸºäº perf ç»“æœäº§ç”Ÿçš„ SVG å›¾ç‰‡ï¼Œç”¨æ¥å±•ç¤º CPU çš„è°ƒç”¨æ ˆã€‚</p>

<p>y è½´è¡¨ç¤ºè°ƒç”¨æ ˆï¼Œæ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚è°ƒç”¨æ ˆè¶Šæ·±ï¼Œç«ç„°å°±è¶Šé«˜ï¼Œé¡¶éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ï¼Œä¸‹æ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°ã€‚</p>

<p>x è½´è¡¨ç¤ºæŠ½æ ·æ•°ï¼Œå¦‚æœä¸€ä¸ªå‡½æ•°åœ¨ x è½´å æ®çš„å®½åº¦è¶Šå®½ï¼Œå°±è¡¨ç¤ºå®ƒè¢«æŠ½åˆ°çš„æ¬¡æ•°å¤šï¼Œå³æ‰§è¡Œçš„æ—¶é—´é•¿ã€‚æ³¨æ„ï¼Œx è½´ä¸ä»£è¡¨æ—¶é—´ï¼Œè€Œæ˜¯æ‰€æœ‰çš„è°ƒç”¨æ ˆåˆå¹¶åï¼ŒæŒ‰å­—æ¯é¡ºåºæ’åˆ—çš„ã€‚</p>

<p>ç«ç„°å›¾å°±æ˜¯çœ‹é¡¶å±‚çš„å“ªä¸ªå‡½æ•°å æ®çš„å®½åº¦æœ€å¤§ã€‚åªè¦æœ‰â€å¹³é¡¶â€ï¼ˆplateausï¼‰ï¼Œå°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚</p>

<p>é¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå› ä¸ºç«ç„°å›¾è¡¨ç¤ºçš„æ˜¯ CPU çš„ç¹å¿™ç¨‹åº¦ï¼Œæ‰€ä»¥ä¸€èˆ¬é€‰æ‹©æš–è‰²è°ƒã€‚</p>

<p>ä¸‰ã€äº’åŠ¨æ€§
ç«ç„°å›¾æ˜¯ SVG å›¾ç‰‡ï¼Œå¯ä»¥ä¸ç”¨æˆ·äº’åŠ¨ã€‚</p>

<p>ï¼ˆ1ï¼‰é¼ æ ‡æ‚¬æµ®</p>

<p>ç«ç„°çš„æ¯ä¸€å±‚éƒ½ä¼šæ ‡æ³¨å‡½æ•°åï¼Œé¼ æ ‡æ‚¬æµ®æ—¶ä¼šæ˜¾ç¤ºå®Œæ•´çš„å‡½æ•°åã€æŠ½æ ·æŠ½ä¸­çš„æ¬¡æ•°ã€å æ®æ€»æŠ½æ ·æ¬¡æ•°çš„ç™¾åˆ†æ¯”ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ã€‚</p>

<p>mysqldâ€™JOIN::exec (272,959 samples, 78.34 percent)
ï¼ˆ2ï¼‰ç‚¹å‡»æ”¾å¤§</p>

<p>åœ¨æŸä¸€å±‚ç‚¹å‡»ï¼Œç«ç„°å›¾ä¼šæ°´å¹³æ”¾å¤§ï¼Œè¯¥å±‚ä¼šå æ®æ‰€æœ‰å®½åº¦ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ã€‚</p>

<p>å·¦ä¸Šè§’ä¼šåŒæ—¶æ˜¾ç¤ºâ€Reset Zoomâ€ï¼Œç‚¹å‡»è¯¥é“¾æ¥ï¼Œå›¾ç‰‡å°±ä¼šæ¢å¤åŸæ ·ã€‚</p>

<p>ï¼ˆ3ï¼‰æœç´¢</p>

<p>æŒ‰ä¸‹ Ctrl + F ä¼šæ˜¾ç¤ºä¸€ä¸ªæœç´¢æ¡†ï¼Œç”¨æˆ·å¯ä»¥è¾“å…¥å…³é”®è¯æˆ–æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å‡½æ•°åä¼šé«˜äº®æ˜¾ç¤ºã€‚</p>

<p>å››ã€ç«ç„°å›¾ç¤ºä¾‹
ä¸‹é¢æ˜¯ä¸€ä¸ªç®€åŒ–çš„ç«ç„°å›¾ä¾‹å­ã€‚</p>

<p>é¦–å…ˆï¼ŒCPU æŠ½æ ·å¾—åˆ°äº†ä¸‰ä¸ªè°ƒç”¨æ ˆã€‚</p>

<p>func_c 
func_b 
func_a 
start_thread</p>

<p>func_d 
func_a 
start_thread</p>

<p>func_d 
func_a 
start_thread
ä¸Šé¢ä»£ç ä¸­ï¼Œstart_threadæ˜¯å¯åŠ¨çº¿ç¨‹ï¼Œè°ƒç”¨äº†func_aã€‚åè€…åˆè°ƒç”¨äº†func_bå’Œfunc_dï¼Œè€Œfunc_båˆè°ƒç”¨äº†func_cã€‚</p>

<p>ç»è¿‡åˆå¹¶å¤„ç†åï¼Œå¾—åˆ°äº†ä¸‹é¢çš„ç»“æœï¼Œå³å­˜åœ¨ä¸¤ä¸ªè°ƒç”¨æ ˆï¼Œç¬¬ä¸€ä¸ªè°ƒç”¨æ ˆæŠ½ä¸­1æ¬¡ï¼Œç¬¬äºŒä¸ªæŠ½ä¸­2æ¬¡ã€‚</p>

<p>start_thread;func_a;func_b;func_c 1 
start_thread;func_a;func_d 2
æœ‰äº†è¿™ä¸ªè°ƒç”¨æ ˆç»Ÿè®¡ï¼Œç«ç„°å›¾å·¥å…·å°±èƒ½ç”Ÿæˆ SVG å›¾ç‰‡ã€‚</p>

<p>ä¸Šé¢å›¾ç‰‡ä¸­ï¼Œæœ€é¡¶å±‚çš„å‡½æ•°g()å ç”¨ CPU æ—¶é—´æœ€å¤šã€‚d()çš„å®½åº¦æœ€å¤§ï¼Œä½†æ˜¯å®ƒç›´æ¥è€—ç”¨ CPU çš„éƒ¨åˆ†å¾ˆå°‘ã€‚b()å’Œc()æ²¡æœ‰ç›´æ¥æ¶ˆè€— CPUã€‚å› æ­¤ï¼Œå¦‚æœè¦è°ƒæŸ¥æ€§èƒ½é—®é¢˜ï¼Œé¦–å…ˆåº”è¯¥è°ƒæŸ¥g()ï¼Œå…¶æ¬¡æ˜¯i()ã€‚</p>

<p>å¦å¤–ï¼Œä»å›¾ä¸­å¯çŸ¥a()æœ‰ä¸¤ä¸ªåˆ†æ”¯b()å’Œh()ï¼Œè¿™è¡¨æ˜a()é‡Œé¢å¯èƒ½æœ‰ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œè€Œb()åˆ†æ”¯æ¶ˆè€—çš„ CPU å¤§å¤§é«˜äºh()ã€‚</p>

<p>äº”ã€å±€é™
ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ— æ³•ç”»å‡ºç«ç„°å›¾ï¼Œéœ€è¦ä¿®æ­£ç³»ç»Ÿè¡Œä¸ºã€‚</p>

<p>ï¼ˆ1ï¼‰è°ƒç”¨æ ˆä¸å®Œæ•´</p>

<p>å½“è°ƒç”¨æ ˆè¿‡æ·±æ—¶ï¼ŒæŸäº›ç³»ç»Ÿåªè¿”å›å‰é¢çš„ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚å‰10å±‚ï¼‰ã€‚</p>

<p>ï¼ˆ2ï¼‰å‡½æ•°åç¼ºå¤±</p>

<p>æœ‰äº›å‡½æ•°æ²¡æœ‰åå­—ï¼Œç¼–è¯‘å™¨åªç”¨å†…å­˜åœ°å€æ¥è¡¨ç¤ºï¼ˆæ¯”å¦‚åŒ¿åå‡½æ•°ï¼‰ã€‚</p>

<p>å…­ã€Node åº”ç”¨çš„ç«ç„°å›¾
Node åº”ç”¨çš„ç«ç„°å›¾å°±æ˜¯å¯¹ Node è¿›ç¨‹è¿›è¡Œæ€§èƒ½æŠ½æ ·ï¼Œä¸å…¶ä»–åº”ç”¨çš„æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚</p>

<p>$ perf record -F 99 -p <code class="language-plaintext highlighter-rouge">pgrep -n node</code> -g â€“ sleep 30
è¯¦ç»†çš„æ“ä½œå¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ã€‚</p>

<p>ä¸ƒã€æµè§ˆå™¨çš„ç«ç„°å›¾
Chrome æµè§ˆå™¨å¯ä»¥ç”Ÿæˆé¡µé¢è„šæœ¬çš„ç«ç„°å›¾ï¼Œç”¨æ¥è¿›è¡Œ CPU åˆ†æã€‚</p>

<p>æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåˆ‡æ¢åˆ° Performance é¢æ¿ã€‚ç„¶åï¼Œç‚¹å‡»â€å½•åˆ¶â€æŒ‰é’®ï¼Œå¼€å§‹è®°å½•æ•°æ®ã€‚è¿™æ—¶ï¼Œå¯ä»¥åœ¨é¡µé¢è¿›è¡Œå„ç§æ“ä½œï¼Œç„¶ååœæ­¢â€å½•åˆ¶â€ã€‚</p>

<p>è¿™æ—¶ï¼Œå¼€å‘è€…å·¥å…·ä¼šæ˜¾ç¤ºä¸€ä¸ªæ—¶é—´è½´ã€‚å®ƒçš„ä¸‹æ–¹å°±æ˜¯ç«ç„°å›¾ã€‚</p>
:ET