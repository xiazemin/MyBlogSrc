I"§m<p>Golang mapå®ç°åŸç†æ˜¯hash mapï¼ˆæ ¸å¿ƒå…ƒç´ æ˜¯æ¡¶ï¼Œkeyé€šè¿‡å“ˆå¸Œç®—æ³•è¢«å½’å…¥ä¸åŒçš„bucketä¸­ï¼‰ï¼Œkeyæ˜¯æ— åºçš„ï¼Œå¾ˆå¤šåº”ç”¨åœºæ™¯å¯èƒ½éœ€è¦map keyæœ‰åºï¼ˆä¾‹å¦‚äº¤æ˜“æ‰€è®¢å•æ’®åˆï¼‰ï¼ŒC++ çš„stl map å®ç°äº†keyæœ‰åºï¼Œå®é™…ä¸Šæ˜¯TreeMapæ˜¯åŸºäºæ ‘ï¼ˆçº¢é»‘æ ‘ï¼‰çš„å®ç°æ–¹å¼ï¼Œå³æ·»åŠ åˆ°ä¸€ä¸ªæœ‰åºåˆ—è¡¨ï¼Œåœ¨O(log n)çš„å¤æ‚åº¦å†…é€šè¿‡keyå€¼æ‰¾åˆ°valueï¼Œä¼˜ç‚¹æ˜¯ç©ºé—´è¦æ±‚ä½ï¼Œä½†åœ¨æ—¶é—´ä¸Šä¸å¦‚HashMapã€‚</p>

<p>é—²æ¥ç”¨go map + sliceåˆ‡ç‰‡ï¼Œå®ç°äº†ä¸€å¥—keyæœ‰åºmapæ•°æ®ç»“æ„ï¼Œå°±æ˜¯ç©ºé—´æ¢æ—¶é—´çš„ç©æ³•ï¼Œ å®è´¨æ˜¯map è´Ÿè´£å­˜k vï¼Œ sliceè´Ÿè´£ç»´æŠ¤kçš„æœ‰åºç´¢å¼•ä½ç½®(æŸ¥æ‰¾keyé‡‡ç”¨çš„æ˜¯2åˆ†æ³•)ï¼Œå®ç°åèµ æ”¹åˆ æ—¶é—´è´Ÿè´£åº¦æ˜¯ O(log2n), ã€‚
ä¼˜åŒ–çš„ä¸€ç‚¹æ€è€ƒï¼šå®é™…ä¸Šä¸»è¦å°±æ˜¯åœ¨sliceä¸Šç»´æŠ¤kä½ç½®æ—¶çš„å¢æ”¹åˆ è´¹æ“ä½œï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯æ ¹æ®å…·ä½“åº”ç”¨åœ¨2åˆ†æŸ¥æ‰¾ä¸Šä¸‹ç‚¹æ–‡ç« ã€‚ ä¾‹å¦‚å¯èƒ½æ‰€å­˜çš„æ•°æ®ç»“æ„é¢‘ç¹æ“ä½œçš„èŠ‚ç‚¹åªæœ‰å‰é¢ä¸€éƒ¨åˆ†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥åŠ ä¸ªé€»è¾‘ï¼Œæ“ä½œæ—¶sliceæ—¶å…ˆ2æŸ¥æ‰¾ sliceå­é›†ï¼ˆä¾‹å¦‚å¤´éƒ¨çƒ­ç‚¹ï¼‰ï¼Œè¿™æ ·å¯èƒ½å¾ˆå¤šå¢æ”¹åˆ æ“ä½œåœ¨ç¬¬ä¸€æ—¶é—´å°±è§£å†³äº†ï¼Œæ•´ä½“æ€§èƒ½ä¼šæœ‰å¾ˆå¤§æå‡ï¼Œ æœ€å¥½æ ¹æ®åº”ç”¨åœºæ™¯æ¥å…·ä½“åˆ†æè§£å†³</p>

<p>https://github.com/iancoleman/orderedmap
<!-- more -->
package Order_Map</p>

<p>func findIndexByBinarySearch(s []int, k int) (int, bool) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lo, hi := 0, len(s)

var m int

max := len(s)

if max == 0 {

    return 0, false

}

res := false

for lo &lt;= hi {

    m = (lo + hi) &gt;&gt; 1

    if m == 0 &amp;&amp; s[0] &gt; k {

        return 0, res

    }

    if m == max-1 &amp;&amp; s[max-1] &lt; k {

        return m + 1, res

    }

    if s[m] &lt; k &amp;&amp; s[m+1] &gt; k {

        return m + 1, res

    }

    if s[m] &gt; k &amp;&amp; s[m-1] &lt; k {

        return m, res

    }

    if s[m] &lt; k {

        lo = m + 1

    } else if s[m] &gt; k {

        hi = m - 1

    } else {

        return m, true

    }

}

return -1, false
</code></pre></div></div>

<p>}</p>

<p>type Int_Map struct {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dataMap  map[int]interface{}

keyArray []int
</code></pre></div></div>

<p>}</p>

<p>func NewIntMap(cap int) *Int_Map {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return &amp;Int_Map{

    dataMap:  make(map[int]interface{}),

    keyArray: make([]int, 0, cap),

}
</code></pre></div></div>

<p>}</p>

<p>func (m *Int_Map) Exists(key int) bool {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>_, exists := m.dataMap[key]

return exists
</code></pre></div></div>

<p>}</p>

<p>func (m *Int_Map) Insert(key int, data interface{}) bool {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m.dataMap[key] = data

index, res := findIndexByBinarySearch(m.keyArray, key)

if index == -1 {

    return false

}

if res == true { //å­˜åœ¨åˆ™ç›´æ¥è¿”å›

    return true

}

if len(m.keyArray) == 0 {

    m.keyArray = append(m.keyArray, key)

    return true

}

//è¿½åŠ æœ«å°¾

if index &gt;= len(m.keyArray) {

    m.keyArray = append(m.keyArray[0:], []int{key}...)

} else if index == 0 { //è¿½åŠ å¤´éƒ¨

    m.keyArray = append([]int{key}, m.keyArray[:len(m.keyArray)]...)

} else { //æ’å…¥

    rear := append([]int{}, m.keyArray[index:]...)

    m.keyArray = append(m.keyArray[0:index], key)

    m.keyArray = append(m.keyArray, rear...)

}

return true
</code></pre></div></div>

<p>}</p>

<p>func (m *Int_Map) Erase(key int) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if !m.Exists(key) {

    return

}

index, res := findIndexByBinarySearch(m.keyArray, key)

if res == false {

    return

}

delete(m.dataMap, key)

if index == 0 {

    m.keyArray = m.keyArray[1:]

} else if index == len(m.keyArray) {

    m.keyArray = m.keyArray[:len(m.keyArray)-2]

} else {

    m.keyArray = append(m.keyArray[:index], m.keyArray[index+1:]...)

}
</code></pre></div></div>

<p>}</p>

<p>func (m *Int_Map) Size() int {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return len(m.keyArray)
</code></pre></div></div>

<p>}</p>

<p>func (m *Int_Map) GetByOrderIndex(index int) (int, interface{}, bool) {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if index &lt; 0 || index &gt;= len(m.keyArray) {

    return -1, nil, false

}

key := m.keyArray[index]

return key, m.dataMap[key], true
</code></pre></div></div>

<p>}</p>

<p>package main</p>

<p>import (</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Order_Map"

"fmt"


"math/rand"


"reflect"

"time"
</code></pre></div></div>

<p>)</p>

<p>func main() {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>t := time.Now()

r := rand.New(rand.NewSource(time.Now().UnixNano()))

testmap := Order_Map.NewIntMap(10000)

t1 := t.Second()

for i := 0; i &lt; 10000; i++ {

    testmap.Insert(r.Intn(10000), r.Intn(10000))

}

t = time.Now()

t2 := t.Second()

fmt.Println("insert  time  span", t2-t1)

testmap.Erase(88)

for i := 0; i &lt; testmap.Size(); i++ {

    k, v, _ := testmap.GetByOrderIndex(i)

    tmp_v := reflect.ValueOf(v)

    fmt.Println("k:", k, "---", "value:", tmp_v)

}


t = time.Now()

t3 := t.Second()

fmt.Println("range  time  span:", t3-t2)
</code></pre></div></div>

<p>}</p>

<p>golang å¦‚ä½•è¿”å›ä¸€ä¸ªæœ‰åºçš„mapç±»å‹çš„æ•°æ®
ä¸¤ç§åœºæ™¯ï¼š
1.è‡ªå·±ç¨‹åºå†…çš„è¯å°½é‡æ˜¯æŒ‰ç…§ç»“æ„ä½“å­æ®µæ’åºï¼Œèµ°sortæ¥å£è‡ªå®šä¹‰ç»“æ„ä½“æ’åºè§„åˆ™å°±å¯ä»¥äº†ã€‚
2.å¦‚æœæ˜¯ç”±äºä¸šåŠ¡ï¼Œå’Œå…¶ä»–æ¨¡å—äº¤äº’åœºæ™¯å¿…é¡»å¯¹mapæ’åºè¿”å›æœ‰åºçš„jsonå­—ç¬¦ä¸²ï¼Œå¯ä»¥è€ƒè™‘ä»åºåˆ—åŒ–å…¥æ‰‹ï¼Œæƒ³çœäº‹çš„è¯å¯ä»¥ç›´æ¥ç”¨ç¬¬ä¸‰æ–¹åº“github.com/iancoleman/orderedmap</p>

<p>æ˜¯çš„ï¼Œ é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘ä¸€ä¸ªhashè¡¨æ’å…¥çš„å…ƒç´ æ˜¯æ²¡æœ‰å›ºå®šé¡ºåºçš„ã€‚ä½†æ˜¯å› ä¸ºå¾ˆå¤šåŸå› ï¼Œæ¯”å¦‚æœ‰ä¸€äº›å¸–å­å°±æŒ‡å‡ºäº†ä¸æ˜¯æ‰€æœ‰çš„mapéƒ½æ˜¯hashè¡¨ï¼ˆè€Œä¸”æœ‰äº›è¯­è¨€è¿˜æœ‰æœ‰é¡ºåºçš„hashè¡¨ï¼Œæ¯”å¦‚javaçš„TreeMapï¼‰ï¼Œ æˆ‘è¿˜æ˜¯èƒ½å¤Ÿäº†è§£ä¸ºä»€ä¹ˆå¾ˆå¤šäººï¼ˆå°¤å…¶æ˜¯å¯¹Go mapå®ç°æœºåˆ¶æ¯”è¾ƒäº†è§£çš„äººï¼‰ä¼šå‡å®šéå†mapå…ƒç´ çš„é¡ºåºå’Œå‘mapæ’å…¥å…ƒç´ çš„é¡ºåºæ˜¯ç›¸åŒçš„ã€‚</p>

<p>æˆ‘åŸæ¥çš„ä¾‹å­æ˜¯æˆ‘è‡ªå·±æƒ³å‡ºæ¥çš„ï¼Œå¹¶æ²¡æœ‰æ¼”ç¤ºå‡ºå¤§å¤šæ•°ç‰ˆæœ¬çš„Goå…³äºè¿™æ–¹é¢çš„ç‰¹ç‚¹ï¼ˆå°½ç®¡æˆ‘å¬è¯´å¯¹äº1.3ç‰ˆæœ¬å¯èƒ½æ˜¯å¯ä»¥å·¥ä½œçš„ï¼‰ã€‚æ‰€ä»¥æˆ‘æŠŠä»£ç æ›´æ–°äº†ä¸€ä¸‹ï¼Œä½ å¯ä»¥æŠŠä»£ç å¤åˆ¶åˆ°ä½ çš„ç¼–è¾‘å™¨æˆ–è€…Go Playgroundæ¥çœ‹çœ‹æ•ˆæœã€‚</p>

<p>Goç¡®å®æ˜¯ä»éšæœºåç§»ä½ç½®æ¥å¼€å§‹mapçš„å…ƒç´ éå†çš„ï¼Œå¹¶ä¸æ˜¯æ²¡æœ‰è§„å¾‹å¯å¾ªã€‚</p>

<p>å¥½äº†ï¼Œç°åœ¨å›æ¥çœ‹çœ‹è¿™ä¸ªæ–‡ç« ã€‚</p>

<p>è¿‡å»å‡ å‘¨ï¼Œæˆ‘çœ‹åˆ°çš„äººä»¬å¯¹Goè¯­è¨€çš„çƒ­æƒ…å’Œè¯­è¨€çš„å‘å±•åŠ¿å¤´çœŸæ˜¯è®©æˆ‘æ— æ¯”æƒŠå¹ã€‚è¿™é‡Œé¢çš„ä¸€éƒ¨åˆ†åŸå› å¯èƒ½æ˜¯å’ŒGophercon 2014æœ‰å…³ï¼Œåœ¨æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œåˆšåˆšä¸¾åŠå®Œã€‚æˆ‘å¯¹é‚£äº›èƒ½å‚åŠ çš„äººçœŸæ˜¯ç¾¡æ…•ï¼Œå«‰å¦’ï¼Œæ¨å•Šï¼ä»ä¼šè®®è®¡åˆ’å’Œè®¨è®ºè¯é¢˜æ¥çœ‹ï¼Œä¼šè®®ç¡®å®å¾ˆæ£’ã€‚å¦å¤–èƒ½å¤Ÿå»å’ŒRob Pikeç¥æä¸ªåŸºï¼Œä»¥åŠçœ‹çœ‹é‚£äº›å®¶ä¼™ç”¨Goåˆ›é€ å‡ºæ¥çš„å¥½ä¸œè¥¿ä¹Ÿæ˜¯å¾ˆä¸é”™çš„ã€‚å¦å¤–æˆ‘æ„Ÿè§‰æœ€è¿‘å…³äºGoçš„åšå®¢æ•°é‡ä¹Ÿçˆ†å‘äº†ã€‚è€Œä¸”ï¼Œå¾ˆå¤šäººå¼€å§‹é‡ç‚¹åœ°å°†Goåœ¨ä»–ä»¬çš„æœåŠ¡ä¸­ä½¿ç”¨ã€‚æ¯”å¦‚Digital Oceanï¼Œå¤§è§„æ¨¡äº‘è®¡ç®—åˆ›ä¸šå…¬å¸ï¼Œåˆšåˆšå®£å¸ƒä»–ä»¬æŠŠä¸€å¤§å¨Perlä»£ç æ”¹ä¸ºGoå®ç°ï¼Œå¹¶ä¸”æå¤§åœ°æ”¹è¿›äº†è¯¸å¦‚å“åº”æ—¶é—´ç­‰é—®é¢˜ã€‚</p>

<p>æˆ‘ä»æ¥ä¸ä¼šå†™é‚£ç§å±Œä¸çº§å¿…å¤‡çš„â€œå“‡å¡ï¼Œæˆ‘ç”¨Golangä¸¤å‘¨äº†ï¼ŒçœŸçš„å¥½æ£’å•Šï¼â€è¿™ç§æ–‡ç« ã€‚å› ä¸ºæˆ‘è§‰å¾—è¿™äº›æ–‡ç« æ²¡æœ‰å•¥æ„æ€ï¼Œé›¶ä»·å€¼ã€‚ä½†æ˜¯ï¼Œæœ€è¿‘æˆ‘é‡åˆ°äº†ä¸€ä¸ªGoç‰¹æ€§ï¼Œè€Œä¸”æˆ‘è®¤ä¸ºè¿™ä¸ªç‰¹æ€§éå¸¸é…·ï¼Œå¹¶ä¸”åœ¨æˆ‘çœ‹æ¥åæ˜ å‡ºäº†Goä½œä¸ºä¸€é—¨ç‰›é€¼è¯­è¨€çš„åŸºæœ¬å§¿æ€ã€‚</p>

<p>Goçš„mapå…ƒç´ éå†é¡ºåº(ä½¿ç”¨rangeå…³é”®å­—)æ˜¯éšæœºçš„ï¼Œè€Œä¸æ˜¯éµå¾ªå…ƒç´ çš„æ·»åŠ é¡ºåºã€‚è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå¾ˆç‰¹åˆ«ä¹ˆï¼Ÿ</p>

<p>Maps
Mapçš„ç®€å•ä»‹ç»ã€‚
ä»Andrew Gerrandçš„å…³äºmapsçš„æ–‡ç« ç›´æ¥å·è¿‡æ¥ç”¨ã€‚</p>

<p>è®¡ç®—æœºç§‘å­¦é‡Œé¢æœ€æœ‰ç”¨çš„æ•°æ®ç»“æ„ä¹‹ä¸€å°±æ˜¯hashè¡¨ã€‚ä¸åŒçš„hashè¡¨å®ç°æä¾›äº†å¾ˆå¤šç‹¬ç‰¹çš„ç‰¹æ€§ã€‚ä½†æ˜¯åŸºæœ¬ä¸Šéƒ½åŒ…æ‹¬å…ƒç´ æŸ¥è¯¢ï¼Œæ·»åŠ å’Œåˆ é™¤ã€‚Goæä¾›äº†ä¸€ä¸ªå†…ç½®çš„ç±»å‹mapï¼Œè¿™ä¸ªç±»å‹å®ç°äº†hashè¡¨çš„åŸºæœ¬åŠŸèƒ½ã€‚</p>

<p>æ‰€ä»¥åœ¨Goè¯­è¨€é‡Œé¢å¦‚æœä½ éœ€è¦ä½¿ç”¨hashè¡¨ï¼Œé‚£ä¹ˆå°±ç”¨mapå§ã€‚å› ä¸ºGoæ˜¯å¼ºç±»å‹è¯­è¨€ï¼Œæ‰€ä»¥ä½ å¿…é¡»ä¸ºmapçš„é”®å’Œå¯¹åº”çš„å€¼æŒ‡å®šå…·ä½“çš„ç±»å‹ã€‚è¿™äº›é”®æˆ–å€¼çš„ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œæ•´å‹ï¼ŒæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆç­‰ã€‚ä¸€ä¸ªå¸¸è§çš„ç”¨æ³•å°±æ˜¯é”®å’Œå€¼éƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚
go m := make(map[string]string)</p>

<p>ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ã€‚åœ¨å…ƒç´ è¢«èµ‹å€¼ä¹‹å‰ï¼Œkeyå¯ä»¥ä¸å­˜åœ¨ï¼Œç”šè‡³åœ¨è¢«å–å€¼çš„æ—¶å€™ä¹Ÿå¯ä»¥ä¸å­˜åœ¨ï¼ˆè¿™æ ·å°±è¿”å›é›¶å€¼ï¼Œé›¶å€¼å¯¹äºä¸åŒçš„ç±»å‹æ˜¯ä¸åŒçš„ï¼Œæ¯”å¦‚æ•´å‹æ˜¯0ï¼Œè€Œå­—ç¬¦ä¸²æ˜¯ç©ºå­—ç¬¦ä¸²â€â€œï¼‰ã€‚</p>

<p>m[â€œbandNameâ€] = â€œFunny Bonesâ€             // â€œcreateâ€
websiteTitle := m[â€œbandNameâ€] + â€œ Musicâ€  // â€œreadâ€
m[â€œbandNameâ€] = â€œMoon Taxiâ€               // â€œupdateâ€
delete(m, â€œbandNameâ€)                     // â€œdeleteâ€
fmt.Printf(m[â€œbandNameâ€])                 // prints nothing since m[â€œbandNameâ€] == â€œâ€
å¯ä»¥ä½¿ç”¨rangeå…³é”®å­—æ¥éå†mapçš„æ‰€æœ‰å…ƒç´ ã€‚</p>

<p>for key, value := range m {
  fmt.Println(â€œKey:â€, key, â€œValue:â€, value)
}
éå†é¡ºåº
ç¬¬ä¸€çœ¼çœ‹ä¸Šå»ï¼ŒGoç¨‹åºå‘˜æˆ–è®¸ä¼šä»¥ä¸ºä¸‹é¢çš„ä»£ç è¾“å‡ºï¼š</p>

<p>package main</p>

<p>import â€œfmtâ€</p>

<p>func main() {
  blogArticleViews := map[string]int{
      â€œunixâ€: 0,
      â€œpythonâ€: 1,
      â€œgoâ€: 2,
      â€œjavascriptâ€: 3,
      â€œtestingâ€: 4,
      â€œphilosophyâ€: 5,
      â€œstartupsâ€: 6,
      â€œproductivityâ€: 7,
      â€œhnâ€: 8,
      â€œredditâ€: 9,
      â€œC++â€: 10,
  }
  for key, views := range blogArticleViews {
      fmt.Println(â€œThere areâ€, views, â€œviews forâ€, key)
  }
}
ä¼šæ˜¯è¿™æ ·çš„ï¼š</p>

<p>$ go run map_iteration_order.go
There are 0 views for unix
There are 1 views for python
There are 2 views for go
There are 3 views for javascript
There are 4 views for testing
There are 5 views for philosophy
There are 6 views for startups
There are 7 views for productivity
There are 8 views for hn
There are 9 views for reddit
There are 10 views for C++
ä½†ä»Go 1ç‰ˆæœ¬å¼€å§‹ï¼Œmapçš„éå†é¡ºåºæ˜¯éšæœºçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸‹é¢çš„ç»“æœæ›´æœ‰å¯èƒ½ï¼š</p>

<p>$ go run map_iteration_order.go
There are 3 views for javascript
There are 5 views for philosophy
There are 10 views for C++
There are 0 views for unix
There are 1 views for python
There are 2 views for go
There are 4 views for testing
There are 6 views for startups
There are 7 views for productivity
There are 8 views for hn
There are 9 views for reddit
Goè¯­è¨€çš„è®¾è®¡è€…ä»¬æ³¨æ„åˆ°äººä»¬è¿‡äºä¾èµ–è¿™ç§é€šå¸¸æƒ…å†µä¸‹keyçš„å­˜å‚¨é¡ºåºå’Œkeyçš„æ·»åŠ é¡ºåºä¸€è‡´çš„ç‰¹æ€§ã€‚æ‰€ä»¥ä»–ä»¬æŠŠkeyçš„éå†é¡ºåºéšæœºåŒ–äº†ã€‚å› æ­¤ï¼Œå¦‚æœä½ å¸Œæœ›keyçš„è¾“å‡ºé¡ºåºå’Œæ·»åŠ é¡ºåºä¸€è‡´çš„è¯ï¼Œä½ éœ€è¦è‡ªå·±å»è¿½è¸ªå“ªä¸ªå€¼å­˜å‚¨åœ¨å“ªä¸ªä½ç½®ï¼Œå°±åƒè¿™æ ·ï¼š</p>

<p>package main</p>

<p>import (
    â€œfmtâ€
    â€œsortâ€
)</p>

<p>func main() {
    var m = map[string]int{
        â€œunixâ€:         0,
        â€œpythonâ€:       1,
        â€œgoâ€:           2,
        â€œjavascriptâ€:   3,
        â€œtestingâ€:      4,
        â€œphilosophyâ€:   5,
        â€œstartupsâ€:     6,
        â€œproductivityâ€: 7,
        â€œhnâ€:           8,
        â€œredditâ€:       9,
        â€œC++â€:          10,
    }
    var keys []string
    for k := range m {
        keys = append(keys, k)
    }
    sort.Strings(keys)
    for _, k := range keys {
        fmt.Println(â€œKey:â€, k, â€œValue:â€, m[k])
    }
}
ä¸Šé¢çš„ä»£ç æ˜¯åˆä¸€æ¬¡åšé¢œæ— è€»åœ°ä»Andrew çš„å¤§ä½œå·è¿‡æ¥ç›´æ¥ç”¨çš„ã€‚</p>

<p>æˆ‘è§‰å¾—å¤§å®¶å¯¹è¿™ä¸ªç‰¹æ€§çš„æ€åº¦å¯ä»¥åˆ†ä¸ºä¸¤ç±»ã€‚
ç¬¬ä¸€ç±»äººä¼šæœ‰å„ç§ååº”ï¼Œä»ä¸æ˜ç™½ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œåˆ°æœ‰ç‚¹ä¸çˆ½ï¼Œç”šè‡³æ˜¯å¼ºçƒˆåå¯¹ã€‚è¿™äº›äººå¤§éƒ¨åˆ†æ˜¯å–œæ¬¢å¼„äº›æœ‰æ½œåœ¨å±é™©æ€§çš„æˆ–è€…å°æŠ€å·§çš„ä»£ç ï¼Œå¹¶ä¸”ä»–ä»¬å¸Œæœ›Goè¯­è¨€çš„è®¾è®¡è€…ä¹Ÿèƒ½æ»¡è¶³ä»–ä»¬çš„æ„¿æœ›ã€‚
å¦ä¸€ç±»äººå€’æ˜¯èƒ½å¤Ÿå®Œå…¨æ¥å—ï¼Œè€Œä¸”å¾ˆæ„Ÿæ¿€Goè®¾è®¡è€…ä»¬èƒ½å¤Ÿä¸ºä»–ä»¬ç€æƒ³ï¼Œä¸æ–­å®Œå–„å’Œæ”¹è¿›Goè¯­è¨€ã€‚</p>

<p>ä¸ºä»€ä¹ˆè¿™å¾ˆç‰¹åˆ«ï¼Ÿ</p>

<p>ä¸€å¥è¯ï¼šæ€åº¦ã€‚</p>

<p>è¿™ä¸ªæ— ä¼¤å¤§é›…çš„è¯­è¨€ç‰¹æ€§åœ¨æˆ‘çœ‹æ¥æ°æ˜¯ä½œä¸ºé€šç”¨è¯­è¨€å“²å­¦çš„ä¸€ä¸ªé—ªå…‰ç‚¹ã€‚æ²¡æœ‰è¿‡äºçµæ´»åœ°å…è®¸é©¬é©¬è™è™çš„ä»£ç ï¼ŒGoå¼ºè¿«ä½ ä»ä¸€å¼€å§‹å°±æŠŠäº‹æƒ…å¼„å¾—ç›´æ¥ä¸€ç‚¹ã€‚Goç¨‹åºå‘˜å‚è€ƒé‡Œé¢è¯´å¦‚æœä»–ä»¬çš„ç¨‹åºå¯ä»¥ç¼–è¯‘ï¼ˆè€Œä¸”ä»£ç ç¬¦åˆGoçš„é£æ ¼ï¼‰ï¼Œé‚£ä¹ˆä»£ç æœ‰å¾ˆå¤§çš„å¯èƒ½å¯ä»¥åƒé¢„æœŸçš„é‚£æ ·å·¥ä½œï¼Œè¿™ç§æ¨¡æ¨¡ç³Šç³Šå´ä¸é”™çš„æ„Ÿè§‰ä¹Ÿæœ‰Goä¸¥è°¨æ€§çš„è´¡çŒ®ã€‚æ²¡æœ‰è¯¡å¼‚çš„ç±»å‹bugï¼Œä¸¢å¤±åˆ†å·ç­‰ç­‰é”™è¯¯ã€‚</p>

<p>å°¤å…¶æ˜¯ï¼Œåœ¨Andrewçš„å‚è€ƒæ–‡ç« ä¸­ï¼Œä»–æŒ‡å‡ºè¿™æ˜¯Goçš„è®¾è®¡è€…ä»¬æ‰€ä½œå‡ºçš„æ”¹å˜ã€‚ä»–ä»¬ä¸å†å…è®¸äººä»¬ä¾èµ–äºé‚£äº›ç ´ç ´çƒ‚çƒ‚çš„å‡è®¾ã€‚æˆ‘æœ€ç—›æ¨çš„ä¸€ç‚¹å°±æ˜¯é‚£äº›ç ´çƒ‚çš„ï¼Œåˆ°å¤„æ˜¯bugçš„åŠŸèƒ½ï¼ˆè¿™å‘ç”Ÿåœ¨äº¤ä»˜çš„äº§å“ä¸­ï¼Œæˆ–è€…æ˜¯ç¼–ç¨‹è¯­è¨€ï¼Œç­‰ç­‰å¾ˆå¤šåœ°æ–¹ï¼‰ï¼Œé€šè¿‡æƒè¡¡ï¼Œæ¥å—ï¼Œä»è€Œå˜æˆäº†ä¸€ä¸ªç‰¹æ€§ï¼Œå¦å¤–å°è¯•ä¿®å¤è¿™äº›â€ç‰¹æ€§â€çœŸçš„æ˜¯å¾ˆæ¶å¿ƒã€‚å¾ˆæ˜æ˜¾çš„ï¼ŒPHPå’ŒJavaScriptçš„è¯­è¨€æ–‡åŒ–å°±æ˜¯å› ä¸ºå„ç§åŸå› å¾€è¿™ä¸ªæ–¹å‘å‘å±•çš„ï¼ˆä»–ä»¬ä½¿ç”¨å®ƒï¼Œä½†æ˜¯æ³¨å®šè¦ä»˜å‡ºä»£ä»·ï¼Œè€Œä¸”å¾ˆå¤šä¸œè¥¿åˆ°æœ€åéƒ½æ˜¯æ²¡æœ‰è§£å†³çš„ï¼‰ã€‚</p>

<p>ä¾‹å¦‚ï¼ŒPHPçš„ä¸€ä¸ªæœ€å¤§çš„ç¼ºç‚¹æ˜¯ï¼Œé’ˆä¸å¹²è‰å †çš„é—®é¢˜ï¼ˆåœ¨å¹²è‰å †é‡Œé¢æ‰¾é’ˆï¼‰ã€‚æˆ‘ç†æƒ³ä¸­çš„è¯­è¨€æ‰€åº”è¯¥å…·æœ‰çš„ç‰¹ç‚¹å’Œè¿™ç§ä¸ä¸€è‡´æ€§æ ¼æ ¼ä¸å…¥ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘å‘ç°Goçš„è®¾è®¡è€…æ‹’ç»ç³Ÿç³•çš„å¼‚å¸¸å’Œæ³›å‹è®¾è®¡ã€‚ä»–ä»¬å°±æ˜¯æƒ³åšæ­£ç¡®çš„äº‹æƒ…ï¼Œå½“ç„¶ä»–ä»¬çŸ¥é“è¿™éœ€è¦èŠ±è´¹æ—¶é—´ã€‚ä»–ä»¬ä¸ç€æ€¥ï¼Œè€Œä¸”å‘è¯­è¨€ä¸­æ·»åŠ ç‰¹æ€§æ¯”åˆ é™¤ç‰¹æ€§å®¹æ˜“å¤šäº†ã€‚</p>

<p>æ€»ç»“
Goæ˜¯ä¸€ç§ä»¤äººæ„‰æ‚¦çš„è¯­è¨€ï¼Œè€Œä¸”å¾ˆå¤šæ–¹é¢éƒ½æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„ã€‚ä¸è¦å› ä¸ºå®ƒç¼ºå°‘ä¸€äº›ä½ å¸¸ç”¨çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ³›å‹å’ŒåŠ¨æ€ç±»å‹ï¼Œè€Œæ€¥äºå»è¯„æ–­å’Œæ‰¹è¯„å®ƒã€‚å¦‚æœä½ è‡ªå·±æ„¿æ„è¯•ä¸€è¯•ï¼Œä½ ä¼šå‘ç°ä½ ä¸ä¸€å®šéœ€è¦è¿™äº›åŠŸèƒ½ã€‚è€Œä¸”ï¼Œä½ é€šè¿‡ä½¿ç”¨ç®€å•çš„å¹¶è¡ŒåŠŸèƒ½ä¼šå†™å‡ºæ›´ç®€å•ï¼Œæ•´æ´ï¼Œä¼˜é›…çš„ä»£ç ã€‚</p>

<p>Goä¸€ç›´åœ¨åšå®šåœ°æˆé•¿å’Œå‘å±•ä¸­ï¼Œè¿™ä¹Ÿæ˜¯Goæ‰€èƒ½å¸¦æ¥çš„ä¹è¶£ä¹‹ä¸€ã€‚å®ƒç»å¯¹æ˜¯å¯é çš„ï¼Œè€Œä¸”å¯ä»¥ç”¨äºç”Ÿäº§ç¯å¢ƒä¸­ã€‚åŒæ—¶Goçš„æ€§èƒ½å’Œç¨³å®šæ€§ä¹Ÿåœ¨ä¸æ–­åœ°æé«˜ã€‚çœ‹çœ‹ä¸‹é¢ç”±Rob Pikeæœ€è¿‘è´´å‡ºæ¥çš„å¯¹æ¯”Go 1å’Œæœ€æ–°ç‰ˆï¼ˆå¿«1.3äº†ï¼‰çš„å¯¹æ¯”ã€‚</p>

<p>benchmark                          old ns/op      new ns/op      delta 
BenchmarkBinaryTree17              7102124000     5790215308     -18.47% 
BenchmarkFannkuch11                7139655000     4361664854     -38.91% 
BenchmarkFmtFprintfEmpty           177            104            -41.24% 
BenchmarkFmtFprintfString          575            312            -45.74% 
BenchmarkFmtFprintfInt             424            230            -45.75% 
BenchmarkFmtFprintfIntInt          682            403            -40.91% 
BenchmarkFmtFprintfPrefixedInt     661            394            -40.39% 
BenchmarkFmtFprintfFloat           907            598            -34.07% 
BenchmarkFmtManyArgs               2787           1663           -40.33% 
BenchmarkGobDecode                 31284200       10693446       -65.82% 
BenchmarkGobEncode                 13900550       6919498        -50.22% 
BenchmarkGzip                      636714400      704154254      +10.59% 
BenchmarkGunzip                    275620600      139906588      -49.24% 
BenchmarkHTTPClientServer          144041         71739          -50.20% 
BenchmarkJSONEncode                83472200       32969241       -60.50% 
BenchmarkJSONDecode                391968600      120858167      -69.17% 
BenchmarkMandelbrot200             9540360        6062905        -36.45% 
BenchmarkGoParse                   10007700       6760226        -32.45% 
BenchmarkRegexpMatchEasy0_32       198            168            -15.15% 
BenchmarkRegexpMatchEasy0_1K       540            479            -11.30% 
BenchmarkRegexpMatchEasy1_32       175            149            -14.86% 
BenchmarkRegexpMatchEasy1_1K       1353           1414           +4.51%
BenchmarkRegexpMatchMedium_32      311            307            -1.29% 
BenchmarkRegexpMatchMedium_1K      108924         126452         +16.09%
BenchmarkRegexpMatchHard_32        4972           5681           +14.26%
BenchmarkRegexpMatchHard_1K        157354         181042         +15.05%
BenchmarkRevcomp                   1362067000     1162752845     -14.63% 
BenchmarkTemplate                  714330000      144396424      -79.79% 
BenchmarkTimeParse                 1651           669            -59.48% 
BenchmarkTimeFormat                3215           714            -77.79%</p>

<p>http://play.golang.org/p/ppIvkgAGL1</p>

<p>å…ˆæ¥çœ‹ä¸€æ®µ Golang ç”Ÿæˆ json çš„ä»£ç ï¼Œé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª map[string]interface{}  çš„å˜é‡ï¼Œç„¶åå­˜ä¸€äº›å€¼ï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯ previews å­—æ®µï¼Œä¸ºäº†æµè§ˆå™¨è·å–åˆ°çš„ json æ•°æ®æ˜¯æœ‰åºçš„ï¼Œæ‰€ä»¥å®šä¹‰äº†ä¸€ä¸ª map[int]map[string]string çš„ç±»å‹ï¼ŒåŠ ä¸Šäº†ä¸€ä¸ªè¡¨ç¤ºé¡ºåºçš„é”®ï¼š</p>

<p>?
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
list := make(map[string]interface{})
list[â€œidâ€] = detail[â€œidâ€]
list[â€œgame_nameâ€] = detail[â€œgame_nameâ€]
list[â€œgame_logoâ€] = detail[â€œgame_m_logoâ€]
gameTags, _ := utils.InterfaceToStr(detail[â€œgame_tagsâ€])
list[â€œgame_tagsâ€] = strings.Split(gameTags, â€œ,â€)
list[â€œgame_descâ€] = detail[â€œgame_long_descâ€]
list[â€œplay_total_timesâ€] = 33333
testImages := make(map[int]map[string]string)
testImages[1] = map[string]string{â€œvideoâ€: â€œxxxâ€}
testImages[2] = map[string]string{â€œimageâ€: â€œyyy1â€}
testImages[3] = map[string]string{â€œimageâ€: â€œyyy2â€}
testImages[5] = map[string]string{â€œimageâ€: â€œyyy5â€}
testImages[4] = map[string]string{â€œimageâ€: â€œyyy3â€}
list[â€œpreviewsâ€] = testImages</p>

<p>fmt.Println(â€œtest list:â€, list)
ä½†å®é™…ä¸Šï¼Œå¯¹äº Golang æ¥è¯´ï¼Œpreviews å­—æ®µå¹¶éå› æ­¤å°±å˜æˆæ˜¯æœ‰åºçš„ï¼Œé€šè¿‡æ‰“å°å°±å¯ä»¥çŸ¥é“äº†ï¼Œä½†æ˜¯æµè§ˆå™¨ä¼šè‡ªåŠ¨å¯¹å¸¦æœ‰ int å‹ä¸»é”®çš„ json æ•°æ®è¿›è¡Œæ’åºï¼Œä»è€Œå®ç°äº†ç›®çš„ã€‚</p>

<p>ç”Ÿæˆçš„ json æ ¼å¼æ•°æ®å¦‚ä¸‹ï¼ŒæŒ‰ç…§ int ä»å°åˆ°å¤§æ’åˆ—äº†ï¼š</p>

<p>?
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
{
 â€œdataâ€: {
  â€œgame_descâ€: â€œä»ç§€æ‰ä¸€è·¯å‰è¿›ï¼Œä½ æœ€ç»ˆèƒ½å®˜å±…å‡ å“ï¼Ÿ ä¸ºäº†å®Œæˆçˆ¶äº²çš„é—æ„¿ï¼Œä½ èµ°ä¸Šäº†è¿™æ¡æ¼«æ¼«å‡å®˜è·¯ã€‚ æœ€ç»ˆä½ ä¼šæˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ â€œ,
  â€œgame_logoâ€: â€œhttp://image.egret.com/game/gameIcon/181/90681/icon_200.jpg?1472698847â€,
  â€œgame_nameâ€: â€œå®˜å±…å‡ å“â€,
  â€œgame_tagsâ€: [
   â€œå‘µå‘µâ€
  ],
  â€œidâ€: â€œ3â€,
  â€œplay_total_timesâ€: 33333,
  â€œpreviewsâ€: {
   â€œ1â€: {
    â€œvideoâ€: â€œxxxâ€
   },
   â€œ2â€: {
    â€œimageâ€: â€œyyy1â€
   },
   â€œ3â€: {
    â€œimageâ€: â€œyyy2â€
   },
   â€œ4â€: {
    â€œimageâ€: â€œyyy3â€
   },
   â€œ5â€: {
    â€œimageâ€: â€œyyy5â€
   }
  }
 },
 â€œmsgâ€: â€œokâ€,
 â€œresultâ€: 0
}
è¿™æ ·çš„è¯æœ‰ä¸ªç¼ºç‚¹ï¼Œæœ¬æ¥å¯ä»¥è¾“å‡ºæ›´ä¸ºç®€æ´çš„æ•°æ®ç»“æ„ï¼Œä½†å› ä¸º map çš„æ— åºä¸å¾—ä¸åŠ ä¸€ä¸ªä¸»é”®ï¼Œè®©å‰ç«¯è§£æå¢åŠ äº†éº»çƒ¦ã€‚</p>

<p>Golang mapå¦‚ä½•ç”Ÿæˆæœ‰åºçš„jsonæ•°æ®è¯¦è§£</p>

<p>mapæ˜¯å¿…ä¸å¯å°‘çš„æ•°æ®ç»“æ„ï¼Œåœ¨Golangä¸­ï¼Œä½¿ç”¨mapæˆ–å¤šæˆ–å°‘ä¼šé‡åˆ°ä¸å…¶ä»–è¯­è¨€ä¸ä¸€æ ·çš„ä½“éªŒï¼Œæ¯”å¦‚è®¿é—®ä¸å­˜åœ¨çš„å…ƒç´ ä¼šè¿”å›å…¶ç±»å‹çš„ç©ºå€¼ã€mapçš„å¤§å°ç©¶ç«Ÿæ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆä¼šæŠ¥â€cannot take the address ofâ€é”™è¯¯ï¼Œéå†mapçš„éšæœºæ€§ç­‰ç­‰ã€‚
æœ¬æ–‡å¸Œæœ›é€šè¿‡ç ”ç©¶mapçš„åº•å±‚å®ç°ï¼Œä»¥è§£ç­”è¿™äº›ç–‘æƒ‘ã€‚
åŸºäºGolang 1.8.3</p>

<ol>
  <li>æ•°æ®ç»“æ„åŠå†…å­˜ç®¡ç†
hashmapçš„å®šä¹‰ä½äº src/runtime/hashmap.go ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬çœ‹ä¸‹hashmapå’Œbucketçš„å®šä¹‰ï¼š</li>
</ol>

<p>type hmap struct {
    count     int    // å…ƒç´ çš„ä¸ªæ•°
    flags     uint8  // çŠ¶æ€æ ‡å¿—
    B         uint8  // å¯ä»¥æœ€å¤šå®¹çº³ 6.5 * 2 ^ B ä¸ªå…ƒç´ ï¼Œ6.5ä¸ºè£…è½½å› å­
    noverflow uint16 // æº¢å‡ºçš„ä¸ªæ•°
    hash0     uint32 // å“ˆå¸Œç§å­</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>buckets    unsafe.Pointer // æ¡¶çš„åœ°å€
oldbuckets unsafe.Pointer // æ—§æ¡¶çš„åœ°å€ï¼Œç”¨äºæ‰©å®¹
nevacuate  uintptr        // æ¬è¿è¿›åº¦ï¼Œå°äºnevacuateçš„å·²ç»æ¬è¿
overflow *[2]*[]*bmap  } å…¶ä¸­ï¼Œoverflowæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå…ƒç´ ä¸ªæ•°ä¸º2çš„æ•°ç»„ï¼Œæ•°ç»„çš„ç±»å‹æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªsliceï¼Œsliceçš„å…ƒç´ æ˜¯æ¡¶(bmap)çš„åœ°å€ï¼Œè¿™äº›æ¡¶éƒ½æ˜¯æº¢å‡ºæ¡¶ï¼›ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªï¼Ÿå› ä¸ºGo mapåœ¨hashå†²çªè¿‡å¤šæ—¶ï¼Œä¼šå‘ç”Ÿæ‰©å®¹æ“ä½œï¼Œä¸ºäº†ä¸å…¨é‡æ¬è¿æ•°æ®ï¼Œä½¿ç”¨äº†å¢é‡æ¬è¿ï¼Œ[0]è¡¨ç¤ºå½“å‰ä½¿ç”¨çš„æº¢å‡ºæ¡¶é›†åˆï¼Œ[1]æ˜¯åœ¨å‘ç”Ÿæ‰©å®¹æ—¶ï¼Œä¿å­˜äº†æ—§çš„æº¢å‡ºæ¡¶é›†åˆï¼›overflowå­˜åœ¨çš„æ„ä¹‰åœ¨äºé˜²æ­¢æº¢å‡ºæ¡¶è¢«gcã€‚
</code></pre></div></div>

<p>// A bucket for a Go map.
type bmap struct {
    // æ¯ä¸ªå…ƒç´ hashå€¼çš„é«˜8ä½ï¼Œå¦‚æœtophash[0] &lt; minTopHashï¼Œè¡¨ç¤ºè¿™ä¸ªæ¡¶çš„æ¬è¿çŠ¶æ€
    tophash [bucketCnt]uint8
    // æ¥ä¸‹æ¥æ˜¯8ä¸ªkeyã€8ä¸ªvalueï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½ç›´æ¥çœ‹åˆ°ï¼›ä¸ºäº†ä¼˜åŒ–å¯¹é½ï¼Œgoé‡‡ç”¨äº†keyæ”¾åœ¨ä¸€èµ·ï¼Œvalueæ”¾åœ¨ä¸€èµ·çš„å­˜å‚¨æ–¹å¼ï¼Œ
    // å†æ¥ä¸‹æ¥æ˜¯hashå†²çªå‘ç”Ÿæ—¶ï¼Œä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€
}
tophashçš„å­˜åœ¨æ˜¯ä¸ºäº†å¿«é€Ÿè¯•é”™ï¼Œæ¯•ç«Ÿåªæœ‰8ä½ï¼Œæ¯”è¾ƒèµ·æ¥ä¼šå¿«ä¸€ç‚¹ã€‚</p>

<p>ä»å®šä¹‰å¯ä»¥çœ‹å‡ºï¼Œä¸åŒäºSTLä¸­mapä»¥çº¢é»‘æ ‘å®ç°çš„æ–¹å¼ï¼ŒGolangé‡‡ç”¨äº†HashTableçš„å®ç°ï¼Œè§£å†³å†²çªé‡‡ç”¨çš„æ˜¯é“¾åœ°å€æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨æ•°ç»„+é“¾è¡¨æ¥å®ç°mapã€‚ç‰¹åˆ«çš„ï¼Œå¯¹äºä¸€ä¸ªkeyï¼Œå‡ ä¸ªæ¯”è¾ƒé‡è¦çš„è®¡ç®—å…¬å¼ä¸º:</p>

<p>key	hash	hashtop	bucket index
key	hash := alg.hash(key, uintptr(h.hash0))	top := uint8(hashÂ Â» (sys.PtrSize*8 - 8))	bucket := hash &amp; (uintptr(1)Â«h.B - 1)ï¼Œå³ hash % 2^B
ä¾‹å¦‚ï¼Œå¯¹äºB = 3ï¼Œå½“hash(key) = 4æ—¶ï¼Œ hashtop = 0ï¼Œ bucket = 4ï¼Œå½“hash(key) = 20æ—¶ï¼Œhashtop = 0ï¼Œ bucket = 4ï¼›è¿™ä¸ªä¾‹å­æˆ‘ä»¬åœ¨æ¬è¿è¿‡ç¨‹è¿˜ä¼šç”¨åˆ°ã€‚</p>

<p>å†…å­˜å¸ƒå±€ç±»ä¼¼äºè¿™æ ·ï¼š</p>

<p>hashmap-buckets</p>
<ol>
  <li>åˆ›å»º - makemap
mapçš„åˆ›å»ºæ¯”è¾ƒç®€å•ï¼Œåœ¨å‚æ•°æ ¡éªŒä¹‹åï¼Œéœ€è¦æ‰¾åˆ°åˆé€‚çš„Bæ¥ç”³è¯·æ¡¶çš„å†…å­˜ç©ºé—´ï¼Œæ¥ç€ä¾¿æ˜¯ç©¿ä»¶hmapè¿™ä¸ªç»“æ„ï¼Œä»¥åŠå¯¹å®ƒçš„åˆå§‹åŒ–ã€‚</li>
</ol>

<p>makemap</p>
<ol>
  <li>è®¿é—® - mapaccess
å¯¹äºç»™å®šçš„ä¸€ä¸ªkeyï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ“ä½œæ‰¾åˆ°å®ƒæ˜¯å¦å­˜åœ¨</li>
</ol>

<p>image.png
æ–¹æ³•å®šä¹‰ä¸º</p>

<p>// returns key, if not find, returns nil
func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer</p>

<p>// returns key and exist. if not find, returns nil, false
func mapaccess2(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, bool)</p>

<p>// returns both key and value. if not find, returns nil, nil
func mapaccessK(t *maptype, h *hmap, key unsafe.Pointer) (unsafe.Pointer, unsafe.Pointer)
å¯è§åœ¨æ‰¾ä¸åˆ°å¯¹åº”keyçš„æƒ…å†µä¸‹ï¼Œä¼šè¿”å›nil</p>

<ol>
  <li>åˆ†é… - mapassign
ä¸ºä¸€ä¸ªkeyåˆ†é…ç©ºé—´çš„é€»è¾‘ï¼Œå¤§è‡´ä¸æŸ¥æ‰¾ç±»ä¼¼ï¼›ä½†å¢åŠ äº†å†™ä¿æŠ¤å’Œæ‰©å®¹çš„æ“ä½œï¼›æ³¨æ„ï¼Œåˆ†é…è¿‡ç¨‹å’Œåˆ é™¤è¿‡ç¨‹éƒ½æ²¡æœ‰åœ¨oldbucketsä¸­æŸ¥æ‰¾ï¼Œè¿™æ˜¯å› ä¸ºé¦–å…ˆè¦è¿›è¡Œæ‰©å®¹åˆ¤æ–­å’Œæ“ä½œï¼›å¦‚ä¸‹ï¼š</li>
</ol>

<p>assign
æ‰©å®¹æ˜¯æ•´ä¸ªhashmapçš„æ ¸å¿ƒç®—æ³•ï¼Œæˆ‘ä»¬æ”¾åœ¨ç¬¬6éƒ¨åˆ†é‡ç‚¹ç ”ç©¶ã€‚</p>

<p>æ–°å»ºä¸€ä¸ªæº¢å‡ºæ¡¶ï¼Œå¹¶å°†å…¶æ‹¼æ¥åœ¨å½“å‰æ¡¶çš„å°¾éƒ¨ï¼Œå®ç°äº†ç±»ä¼¼é“¾è¡¨çš„æ“ä½œï¼š</p>

<p>// è·å–å½“å‰æ¡¶çš„æº¢å‡ºæ¡¶
func (b *bmap) overflow(t *maptype) *bmap {
    return *(**bmap)(add(unsafe.Pointer(b), uintptr(t.bucketsize)-sys.PtrSize))
}</p>

<p>// è®¾ç½®å½“å‰æ¡¶çš„æº¢å‡ºæ¡¶
func (h <em>hmap) setoverflow(t *maptype, b, ovf *bmap) {
    h.incrnoverflow()
    if t.bucket.kind&amp;kindNoPointers != 0 {
        h.createOverflow()
        //é‡ç‚¹ï¼Œè¿™é‡Œè®²æº¢å‡ºæ¡¶appendåˆ°overflow[0]çš„åé¢
        *h.overflow[0] = append(</em>h.overflow[0], ovf)
    }
    *(**bmap)(add(unsafe.Pointer(b), uintptr(t.bucketsize)-sys.PtrSize)) = ovf
}</p>
<ol>
  <li>åˆ é™¤ - mapdelete
åˆ é™¤æŸä¸ªkeyçš„æ“ä½œä¸åˆ†é…ç±»ä¼¼ï¼Œç”±äºhashmapçš„å­˜å‚¨ç»“æ„æ˜¯æ•°ç»„+é“¾è¡¨ï¼Œæ‰€ä»¥çœŸæ­£åˆ é™¤keyä»…ä»…æ˜¯å°†å¯¹åº”çš„slotè®¾ç½®ä¸ºemptyï¼Œå¹¶æ²¡æœ‰å‡å°‘å†…å­˜ï¼›å¦‚ä¸‹ï¼š</li>
</ol>

<p>mapdelete</p>
<ol>
  <li>æ‰©å®¹ - growWork
é¦–å…ˆï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹çš„é€»è¾‘æ˜¯</li>
</ol>

<p>func (h *hmap) growing() bool {
    return h.oldbuckets != nil
}
ä½•æ—¶h.oldbucketsä¸ä¸ºnilå‘¢ï¼Ÿåœ¨åˆ†é…assigné€»è¾‘ä¸­ï¼Œå½“æ²¡æœ‰ä½ç½®ç»™keyä½¿ç”¨ï¼Œè€Œä¸”æ»¡è¶³æµ‹è¯•æ¡ä»¶(è£…è½½å› å­&gt;6.5æˆ–æœ‰å¤ªå¤šæº¢å‡ºé€š)æ—¶ï¼Œä¼šè§¦å‘hashGrowé€»è¾‘ï¼š</p>

<p>func hashGrow(t *maptype, h *hmap) {
    //åˆ¤æ–­æ˜¯å¦éœ€è¦sameSizeGrowï¼Œå¦åˆ™â€çœŸâ€æ‰©
    bigger := uint8(1)
    if !overLoadFactor(int64(h.count), h.B) {
        bigger = 0
        h.flags |= sameSizeGrow
    }
        // ä¸‹é¢å°†bucketså¤åˆ¶ç»™oldbuckets
    oldbuckets := h.buckets
    newbuckets := newarray(t.bucket, 1Â«(h.B+bigger))
    flags := h.flags &amp;^ (iterator | oldIterator)
    if h.flags&amp;iterator != 0 {
        flags |= oldIterator
    }
    // æ›´æ–°hmapçš„å˜é‡
    h.B += bigger
    h.flags = flags
    h.oldbuckets = oldbuckets
    h.buckets = newbuckets
    h.nevacuate = 0
    h.noverflow = 0
        // è®¾ç½®æº¢å‡ºæ¡¶
    if h.overflow != nil {
        if h.overflow[1] != nil {
            throw(â€œoverflow is not nilâ€)
        }
// äº¤æ¢æº¢å‡ºæ¡¶
        h.overflow[1] = h.overflow[0]
        h.overflow[0] = nil
    }
}
OKï¼Œä¸‹é¢æ­£å¼è¿›å…¥é‡ç‚¹ï¼Œæ‰©å®¹é˜¶æ®µï¼›åœ¨assignå’Œdeleteæ“ä½œä¸­ï¼Œéƒ½ä¼šè§¦å‘æ‰©å®¹growWorkï¼š</p>

<p>func growWork(t *maptype, h *hmap, bucket uintptr) {
    // æ¬è¿æ—§æ¡¶ï¼Œè¿™æ ·assignå’Œdeleteéƒ½ç›´æ¥åœ¨æ–°æ¡¶é›†åˆä¸­è¿›è¡Œ
    evacuate(t, h, bucket&amp;h.oldbucketmask())
        //å†æ¬è¿ä¸€æ¬¡æ¬è¿è¿‡ç¨‹ä¸­çš„æ¡¶
    if h.growing() {
        evacuate(t, h, h.nevacuate)
    }
}
6.1 æ¬è¿è¿‡ç¨‹
ä¸€èˆ¬æ¥è¯´ï¼Œæ–°æ¡¶æ•°ç»„å¤§å°æ˜¯åŸæ¥çš„2å€(åœ¨!sameSizeGrow()æ¡ä»¶ä¸‹)ï¼Œæ–°æ¡¶æ•°ç»„å‰åŠæ®µå¯ä»¥â€ç±»æ¯”â€ä¸ºæ—§æ¡¶ï¼Œå¯¹äºä¸€ä¸ªkeyï¼Œæ¬è¿åè½å…¥å“ªä¸€ä¸ªç´¢å¼•ä¸­å‘¢ï¼Ÿ</p>

<p>å‡è®¾æ—§æ¡¶æ•°ç»„å¤§å°ä¸º2^Bï¼Œ æ–°æ¡¶æ•°ç»„å¤§å°ä¸º2*2^Bï¼Œå¯¹äºæŸä¸ªhashå€¼X
è‹¥ X &amp; (2^B) == 0ï¼Œè¯´æ˜ X &lt; 2^Bï¼Œé‚£ä¹ˆå®ƒå°†è½å…¥ä¸æ—§æ¡¶é›†åˆç›¸åŒçš„ç´¢å¼•xiä¸­ï¼›
å¦åˆ™ï¼Œå®ƒå°†è½å…¥xi + 2^Bä¸­ã€‚
ä¾‹å¦‚ï¼Œå¯¹äºæ—§B = 3æ—¶ï¼Œhash1 = 4ï¼Œhash2 = 20ï¼Œå…¶æ¬è¿ç»“æœç±»ä¼¼è¿™æ ·ã€‚</p>

<p>example.png
æºç ä¸­æœ‰äº›å˜é‡çš„å‘½åæ¯”è¾ƒç®€å•ï¼Œå®¹æ˜“æ‰°ä¹±æ€è·¯ï¼Œæˆ‘ä»¬æ³¨æ˜ä¸€ä¸‹ä¾¿äºç†è§£ã€‚</p>

<p>å˜é‡	é‡Šä¹‰
x *bmap	æ¡¶xè¡¨ç¤ºä¸åœ¨æ—§æ¡¶æ—¶ç›¸åŒçš„ä½ç½®ï¼Œå³ä½äºæ–°æ¡¶å‰åŠæ®µ
y *bmap	æ¡¶yè¡¨ç¤ºä¸åœ¨æ—§æ¡¶æ—¶ç›¸åŒçš„ä½ç½®+æ—§æ¡¶æ•°ç»„å¤§å°ï¼Œå³ä½äºæ–°æ¡¶ååŠæ®µ
xi int	æ¡¶xçš„slotç´¢å¼•
yi int	æ¡¶yçš„slotç´¢å¼•
xk unsafe.Pointer	ç´¢å¼•xiå¯¹åº”çš„keyåœ°å€
yk unsafe.Pointer	ç´¢å¼•yiå¯¹åº”çš„keyåœ°å€
xv unsafe.Pointer	ç´¢å¼•xiå¯¹åº”çš„valueåœ°å€
yv unsafe.Pointer	ç´¢å¼•yiå¯¹åº”çš„valueåœ°å€
æ¬è¿è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>evacuate
æ€»ç»“
åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒGolangçš„mapå®ç°ç»†èŠ‚å·²ç»åˆ†æå®Œæ¯•ï¼Œä½†ä¸åŒ…å«è¿­ä»£å™¨ç›¸å…³æ“ä½œã€‚é€šè¿‡åˆ†æï¼Œæˆ‘ä»¬äº†è§£äº†mapæ˜¯ç”±æ•°ç»„+é“¾è¡¨å®ç°çš„HashTableï¼Œå…¶å¤§å°å’ŒBæ¯æ¯ç›¸å…³ï¼ŒåŒæ—¶ä¹Ÿäº†è§£äº†mapçš„åˆ›å»ºã€æŸ¥è¯¢ã€åˆ†é…ã€åˆ é™¤ä»¥åŠæ‰©å®¹æ¬è¿åŸç†ã€‚æ€»çš„æ¥è¯´ï¼ŒGolangé€šè¿‡hashtopå¿«é€Ÿè¯•é”™åŠ å¿«äº†æŸ¥æ‰¾è¿‡ç¨‹ï¼Œåˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³è§£å†³äº†æ‰©å®¹çš„é—®é¢˜ï¼Œåˆ©ç”¨å°†8ä¸ªkey(8ä¸ªvalue)ä¾æ¬¡æ”¾ç½®å‡å°‘äº†paddingç©ºé—´ç­‰ç­‰ã€‚</p>
:ET