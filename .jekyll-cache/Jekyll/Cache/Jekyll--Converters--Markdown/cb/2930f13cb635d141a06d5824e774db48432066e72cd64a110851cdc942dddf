I"`È<p>ç³»ç»Ÿè°ƒç”¨å·	å‡½æ•°å	å…¥å£ç‚¹	æºä»£ç 
0	read	sys_read	fs/read_write.c
1	write	sys_write	fs/read_write.c
2	open	sys_open	fs/open.c
3	close	sys_close	fs/open.c
4	stat	sys_newstat	fs/stat.c
5	fstat	sys_newfstat	fs/stat.c
6	lstat	sys_newlstat	fs/stat.c
7	poll	sys_poll	fs/select.c
8	lseek	sys_lseek	fs/read_write.c
9	mmap	sys_mmap	arch/x86/kernel/sys_x86_64.c
10	mprotect	sys_mprotect	mm/mprotect.c
11	munmap	sys_munmap	mm/mmap.c
12	brk	sys_brk	mm/mmap.c
13	rt_sigaction	sys_rt_sigaction	kernel/signal.c
14	rt_sigprocmask	sys_rt_sigprocmask	kernel/signal.c
15	rt_sigreturn	stub_rt_sigreturn	arch/x86/kernel/signal.c
16	ioctl	sys_ioctl	fs/ioctl.c
17	pread64	sys_pread64	fs/read_write.c
18	pwrite64	sys_pwrite64	fs/read_write.c
19	readv	sys_readv	fs/read_write.c
20	writev	sys_writev	fs/read_write.c
21	access	sys_access	fs/open.c
22	pipe	sys_pipe	fs/pipe.c
23	select	sys_select	fs/select.c
24	sched_yield	sys_sched_yield	kernel/sched/core.c
25	mremap	sys_mremap	mm/mmap.c
26	msync	sys_msync	mm/msync.c
27	mincore	sys_mincore	mm/mincore.c
28	madvise	sys_madvise	mm/madvise.c
29	shmget	sys_shmget	ipc/shm.c
30	shmat	sys_shmat	ipc/shm.c
31	shmctl	sys_shmctl	ipc/shm.c
32	dup	sys_dup	fs/file.c
33	dup2	sys_dup2	fs/file.c
34	pause	sys_pause	kernel/signal.c
35	nanosleep	sys_nanosleep	kernel/hrtimer.c
36	getitimer	sys_getitimer	kernel/itimer.c
37	alarm	sys_alarm	kernel/timer.c
38	setitimer	sys_setitimer	kernel/itimer.c
39	getpid	sys_getpid	kernel/sys.c
40	sendfile	sys_sendfile64	fs/read_write.c
41	socket	sys_socket	net/socket.c
42	connect	sys_connect	net/socket.c
43	accept	sys_accept	net/socket.c
44	sendto	sys_sendto	net/socket.c
45	recvfrom	sys_recvfrom	net/socket.c
46	sendmsg	sys_sendmsg	net/socket.c
47	recvmsg	sys_recvmsg	net/socket.c
48	shutdown	sys_shutdown	net/socket.c
49	bind	sys_bind	net/socket.c
50	listen	sys_listen	net/socket.c
51	getsockname	sys_getsockname	net/socket.c
52	getpeername	sys_getpeername	net/socket.c
53	socketpair	sys_socketpair	net/socket.c
54	setsockopt	sys_setsockopt	net/socket.c
55	getsockopt	sys_getsockopt	net/socket.c
56	clone	stub_clone	kernel/fork.c
57	fork	stub_fork	kernel/fork.c
58	vfork	stub_vfork	kernel/fork.c
59	execve	stub_execve	fs/exec.c
60	exit	sys_exit	kernel/exit.c
61	wait4	sys_wait4	kernel/exit.c
62	kill	sys_kill	kernel/signal.c
63	uname	sys_newuname	kernel/sys.c
64	semget	sys_semget	ipc/sem.c
65	semop	sys_semop	ipc/sem.c
66	semctl	sys_semctl	ipc/sem.c
67	shmdt	sys_shmdt	ipc/shm.c
68	msgget	sys_msgget	ipc/msg.c
69	msgsnd	sys_msgsnd	ipc/msg.c
70	msgrcv	sys_msgrcv	ipc/msg.c
71	msgctl	sys_msgctl	ipc/msg.c
72	fcntl	sys_fcntl	fs/fcntl.c
73	flock	sys_flock	fs/locks.c
74	fsync	sys_fsync	fs/sync.c
75	fdatasync	sys_fdatasync	fs/sync.c
76	truncate	sys_truncate	fs/open.c
77	ftruncate	sys_ftruncate	fs/open.c
78	getdents	sys_getdents	fs/readdir.c
79	getcwd	sys_getcwd	fs/dcache.c
80	chdir	sys_chdir	fs/open.c
81	fchdir	sys_fchdir	fs/open.c
82	rename	sys_rename	fs/namei.c
83	mkdir	sys_mkdir	fs/namei.c
84	rmdir	sys_rmdir	fs/namei.c
85	creat	sys_creat	fs/open.c
86	link	sys_link	fs/namei.c
87	unlink	sys_unlink	fs/namei.c
88	symlink	sys_symlink	fs/namei.c
89	readlink	sys_readlink	fs/stat.c
90	chmod	sys_chmod	fs/open.c
91	fchmod	sys_fchmod	fs/open.c
92	chown	sys_chown	fs/open.c
93	fchown	sys_fchown	fs/open.c
94	lchown	sys_lchown	fs/open.c
95	umask	sys_umask	kernel/sys.c
96	gettimeofday	sys_gettimeofday	kernel/time.c
97	getrlimit	sys_getrlimit	kernel/sys.c
98	getrusage	sys_getrusage	kernel/sys.c
99	sysinfo	sys_sysinfo	kernel/sys.c
100	times	sys_times	kernel/sys.c
101	ptrace	sys_ptrace	kernel/ptrace.c
102	getuid	sys_getuid	kernel/sys.c
103	syslog	sys_syslog	kernel/printk/printk.c
104	getgid	sys_getgid	kernel/sys.c
105	setuid	sys_setuid	kernel/sys.c
106	setgid	sys_setgid	kernel/sys.c
107	geteuid	sys_geteuid	kernel/sys.c
108	getegid	sys_getegid	kernel/sys.c
109	setpgid	sys_setpgid	kernel/sys.c
110	getppid	sys_getppid	kernel/sys.c
111	getpgrp	sys_getpgrp	kernel/sys.c
112	setsid	sys_setsid	kernel/sys.c
113	setreuid	sys_setreuid	kernel/sys.c
114	setregid	sys_setregid	kernel/sys.c
115	getgroups	sys_getgroups	kernel/groups.c
116	setgroups	sys_setgroups	kernel/groups.c
117	setresuid	sys_setresuid	kernel/sys.c
118	getresuid	sys_getresuid	kernel/sys.c
119	setresgid	sys_setresgid	kernel/sys.c
120	getresgid	sys_getresgid	kernel/sys.c
121	getpgid	sys_getpgid	kernel/sys.c
122	setfsuid	sys_setfsuid	kernel/sys.c
123	setfsgid	sys_setfsgid	kernel/sys.c
124	getsid	sys_getsid	kernel/sys.c
125	capget	sys_capget	kernel/capability.c
126	capset	sys_capset	kernel/capability.c
127	rt_sigpending	sys_rt_sigpending	kernel/signal.c
128	rt_sigtimedwait	sys_rt_sigtimedwait	kernel/signal.c
129	rt_sigqueueinfo	sys_rt_sigqueueinfo	kernel/signal.c
130	rt_sigsuspend	sys_rt_sigsuspend	kernel/signal.c
131	sigaltstack	sys_sigaltstack	kernel/signal.c
132	utime	sys_utime	fs/utimes.c
133	mknod	sys_mknod	fs/namei.c
134	uselib	Â 	fs/exec.c
135	personality	sys_personality	kernel/exec_domain.c
136	ustat	sys_ustat	fs/statfs.c
137	statfs	sys_statfs	fs/statfs.c
138	fstatfs	sys_fstatfs	fs/statfs.c
139	sysfs	sys_sysfs	fs/filesystems.c
140	getpriority	sys_getpriority	kernel/sys.c
141	setpriority	sys_setpriority	kernel/sys.c
142	sched_setparam	sys_sched_setparam	kernel/sched/core.c
143	sched_getparam	sys_sched_getparam	kernel/sched/core.c
144	sched_setscheduler	sys_sched_setscheduler	kernel/sched/core.c
145	sched_getscheduler	sys_sched_getscheduler	kernel/sched/core.c
146	sched_get_priority_max	sys_sched_get_priority_max	kernel/sched/core.c
147	sched_get_priority_min	sys_sched_get_priority_min	kernel/sched/core.c
148	sched_rr_get_interval	sys_sched_rr_get_interval	kernel/sched/core.c
149	mlock	sys_mlock	mm/mlock.c
150	munlock	sys_munlock	mm/mlock.c
151	mlockall	sys_mlockall	mm/mlock.c
152	munlockall	sys_munlockall	mm/mlock.c
153	vhangup	sys_vhangup	fs/open.c
154	modify_ldt	sys_modify_ldt	arch/x86/um/ldt.c
155	pivot_root	sys_pivot_root	fs/namespace.c
156	_sysctl	sys_sysctl	kernel/sysctl_binary.c
157	prctl	sys_prctl	kernel/sys.c
158	arch_prctl	sys_arch_prctl	arch/x86/um/syscalls_64.c
159	adjtimex	sys_adjtimex	kernel/time.c
160	setrlimit	sys_setrlimit	kernel/sys.c
161	chroot	sys_chroot	fs/open.c
162	sync	sys_sync	fs/sync.c
163	acct	sys_acct	kernel/acct.c
164	settimeofday	sys_settimeofday	kernel/time.c
165	mount	sys_mount	fs/namespace.c
166	umount2	sys_umount	fs/namespace.c
167	swapon	sys_swapon	mm/swapfile.c
168	swapoff	sys_swapoff	mm/swapfile.c
169	reboot	sys_reboot	kernel/reboot.c
170	sethostname	sys_sethostname	kernel/sys.c
171	setdomainname	sys_setdomainname	kernel/sys.c
172	iopl	stub_iopl	arch/x86/kernel/ioport.c
173	ioperm	sys_ioperm	arch/x86/kernel/ioport.c
174	create_module	Â 	NOT IMPLEMENTED
175	init_module	sys_init_module	kernel/module.c
176	delete_module	sys_delete_module	kernel/module.c
177	get_kernel_syms	Â 	NOT IMPLEMENTED
178	query_module	Â 	NOT IMPLEMENTED
179	quotactl	sys_quotactl	fs/quota/quota.c
180	nfsservctl	Â 	NOT IMPLEMENTED
181	getpmsg	Â 	NOT IMPLEMENTED
182	putpmsg	Â 	NOT IMPLEMENTED
183	afs_syscall	Â 	NOT IMPLEMENTED
184	tuxcall	Â 	NOT IMPLEMENTED
185	security	Â 	NOT IMPLEMENTED
186	gettid	sys_gettid	kernel/sys.c
187	readahead	sys_readahead	mm/readahead.c
188	setxattr	sys_setxattr	fs/xattr.c
189	lsetxattr	sys_lsetxattr	fs/xattr.c
190	fsetxattr	sys_fsetxattr	fs/xattr.c
191	getxattr	sys_getxattr	fs/xattr.c
192	lgetxattr	sys_lgetxattr	fs/xattr.c
193	fgetxattr	sys_fgetxattr	fs/xattr.c
194	listxattr	sys_listxattr	fs/xattr.c
195	llistxattr	sys_llistxattr	fs/xattr.c
196	flistxattr	sys_flistxattr	fs/xattr.c
197	removexattr	sys_removexattr	fs/xattr.c
198	lremovexattr	sys_lremovexattr	fs/xattr.c
199	fremovexattr	sys_fremovexattr	fs/xattr.c
200	tkill	sys_tkill	kernel/signal.c
201	time	sys_time	kernel/time.c
202	futex	sys_futex	kernel/futex.c
203	sched_setaffinity	sys_sched_setaffinity	kernel/sched/core.c
204	sched_getaffinity	sys_sched_getaffinity	kernel/sched/core.c
205	set_thread_area	Â 	arch/x86/kernel/tls.c
206	io_setup	sys_io_setup	fs/aio.c
207	io_destroy	sys_io_destroy	fs/aio.c
208	io_getevents	sys_io_getevents	fs/aio.c
209	io_submit	sys_io_submit	fs/aio.c
210	io_cancel	sys_io_cancel	fs/aio.c
211	get_thread_area	Â 	arch/x86/kernel/tls.c
212	lookup_dcookie	sys_lookup_dcookie	fs/dcookies.c
213	epoll_create	sys_epoll_create	fs/eventpoll.c
214	epoll_ctl_old	Â 	NOT IMPLEMENTED
215	epoll_wait_old	Â 	NOT IMPLEMENTED
216	remap_file_pages	sys_remap_file_pages	mm/fremap.c
217	getdents64	sys_getdents64	fs/readdir.c
218	set_tid_address	sys_set_tid_address	kernel/fork.c
219	restart_syscall	sys_restart_syscall	kernel/signal.c
220	semtimedop	sys_semtimedop	ipc/sem.c
221	fadvise64	sys_fadvise64	mm/fadvise.c
222	timer_create	sys_timer_create	kernel/posix-timers.c
223	timer_settime	sys_timer_settime	kernel/posix-timers.c
224	timer_gettime	sys_timer_gettime	kernel/posix-timers.c
225	timer_getoverrun	sys_timer_getoverrun	kernel/posix-timers.c
226	timer_delete	sys_timer_delete	kernel/posix-timers.c
227	clock_settime	sys_clock_settime	kernel/posix-timers.c
228	clock_gettime	sys_clock_gettime	kernel/posix-timers.c
229	clock_getres	sys_clock_getres	kernel/posix-timers.c
230	clock_nanosleep	sys_clock_nanosleep	kernel/posix-timers.c
231	exit_group	sys_exit_group	kernel/exit.c
232	epoll_wait	sys_epoll_wait	fs/eventpoll.c
233	epoll_ctl	sys_epoll_ctl	fs/eventpoll.c
234	tgkill	sys_tgkill	kernel/signal.c
235	utimes	sys_utimes	fs/utimes.c
236	vserver	Â 	NOT IMPLEMENTED
237	mbind	sys_mbind	mm/mempolicy.c
238	set_mempolicy	sys_set_mempolicy	mm/mempolicy.c
239	get_mempolicy	sys_get_mempolicy	mm/mempolicy.c
240	mq_open	sys_mq_open	ipc/mqueue.c
241	mq_unlink	sys_mq_unlink	ipc/mqueue.c
242	mq_timedsend	sys_mq_timedsend	ipc/mqueue.c
243	mq_timedreceive	sys_mq_timedreceive	ipc/mqueue.c
244	mq_notify	sys_mq_notify	ipc/mqueue.c
245	mq_getsetattr	sys_mq_getsetattr	ipc/mqueue.c
246	kexec_load	sys_kexec_load	kernel/kexec.c
247	waitid	sys_waitid	kernel/exit.c
248	add_key	sys_add_key	security/keys/keyctl.c
249	request_key	sys_request_key	security/keys/keyctl.c
250	keyctl	sys_keyctl	security/keys/keyctl.c
251	ioprio_set	sys_ioprio_set	fs/ioprio.c
252	ioprio_get	sys_ioprio_get	fs/ioprio.c
253	inotify_init	sys_inotify_init	fs/notify/inotify/inotify_user.c
254	inotify_add_watch	sys_inotify_add_watch	fs/notify/inotify/inotify_user.c
255	inotify_rm_watch	sys_inotify_rm_watch	fs/notify/inotify/inotify_user.c
256	migrate_pages	sys_migrate_pages	mm/mempolicy.c
257	openat	sys_openat	fs/open.c
258	mkdirat	sys_mkdirat	fs/namei.c
259	mknodat	sys_mknodat	fs/namei.c
260	fchownat	sys_fchownat	fs/open.c
261	futimesat	sys_futimesat	fs/utimes.c
262	newfstatat	sys_newfstatat	fs/stat.c
263	unlinkat	sys_unlinkat	fs/namei.c
264	renameat	sys_renameat	fs/namei.c
265	linkat	sys_linkat	fs/namei.c
266	symlinkat	sys_symlinkat	fs/namei.c
267	readlinkat	sys_readlinkat	fs/stat.c
268	fchmodat	sys_fchmodat	fs/open.c
269	faccessat	sys_faccessat	fs/open.c
270	pselect6	sys_pselect6	fs/select.c
271	ppoll	sys_ppoll	fs/select.c
272	unshare	sys_unshare	kernel/fork.c
273	set_robust_list	sys_set_robust_list	kernel/futex.c
274	get_robust_list	sys_get_robust_list	kernel/futex.c
275	splice	sys_splice	fs/splice.c
276	tee	sys_tee	fs/splice.c
277	sync_file_range	sys_sync_file_range	fs/sync.c
278	vmsplice	sys_vmsplice	fs/splice.c
279	move_pages	sys_move_pages	mm/migrate.c
280	utimensat	sys_utimensat	fs/utimes.c
281	epoll_pwait	sys_epoll_pwait	fs/eventpoll.c
282	signalfd	sys_signalfd	fs/signalfd.c
283	timerfd_create	sys_timerfd_create	fs/timerfd.c
284	eventfd	sys_eventfd	fs/eventfd.c
285	fallocate	sys_fallocate	fs/open.c
286	timerfd_settime	sys_timerfd_settime	fs/timerfd.c
287	timerfd_gettime	sys_timerfd_gettime	fs/timerfd.c
288	accept4	sys_accept4	net/socket.c
289	signalfd4	sys_signalfd4	fs/signalfd.c
290	eventfd2	sys_eventfd2	fs/eventfd.c
291	epoll_create1	sys_epoll_create1	fs/eventpoll.c
292	dup3	sys_dup3	fs/file.c
293	pipe2	sys_pipe2	fs/pipe.c
294	inotify_init1	sys_inotify_init1	fs/notify/inotify/inotify_user.c
295	preadv	sys_preadv	fs/read_write.c
296	pwritev	sys_pwritev	fs/read_write.c
297	rt_tgsigqueueinfo	sys_rt_tgsigqueueinfo	kernel/signal.c
298	perf_event_open	sys_perf_event_open	kernel/events/core.c
299	recvmmsg	sys_recvmmsg	net/socket.c
300	fanotify_init	sys_fanotify_init	fs/notify/fanotify/fanotify_user.c
301	fanotify_mark	sys_fanotify_mark	fs/notify/fanotify/fanotify_user.c
302	prlimit64	sys_prlimit64	kernel/sys.c
303	name_to_handle_at	sys_name_to_handle_at	fs/fhandle.c
304	open_by_handle_at	sys_open_by_handle_at	fs/fhandle.c
305	clock_adjtime	sys_clock_adjtime	kernel/posix-timers.c
306	syncfs	sys_syncfs	fs/sync.c
307	sendmmsg	sys_sendmmsg	net/socket.c
308	setns	sys_setns	kernel/nsproxy.c
309	getcpu	sys_getcpu	kernel/sys.c
310	process_vm_readv	sys_process_vm_readv	mm/process_vm_access.c
311	process_vm_writev	sys_process_vm_writev	mm/process_vm_access.c
312	kcmp	sys_kcmp	kernel/kcmp.c
313	finit_module	sys_finit_module	kernel/module.c
<!-- more -->
åœ¨linux æŸ¥çœ‹32ä½çš„ç³»ç»Ÿè°ƒç”¨å·
cat /usr/include/asm/unistd_32.h</p>

<p>æŸ¥çœ‹64ä½çš„ç³»ç»Ÿè°ƒç”¨å·
cat /usr/include/asm/unistd_64.h</p>

<p>ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š</p>

<p>åº”ç”¨ç¨‹åº ä»£ç è°ƒç”¨ç³»ç»Ÿè°ƒç”¨( xyz )ï¼Œè¯¥å‡½æ•°æ˜¯ä¸€ä¸ªåŒ…è£…ç³»ç»Ÿè°ƒç”¨çš„ åº“å‡½æ•° ï¼›
åº“å‡½æ•° ( xyz )è´Ÿè´£å‡†å¤‡å‘å†…æ ¸ä¼ é€’çš„å‚æ•°ï¼Œå¹¶è§¦å‘ è½¯ä¸­æ–­ ä»¥åˆ‡æ¢åˆ°å†…æ ¸ï¼›
CPU è¢« è½¯ä¸­æ–­ æ‰“æ–­åï¼Œæ‰§è¡Œ ä¸­æ–­å¤„ç†å‡½æ•° ï¼Œå³ ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° ( system_call )ï¼›
ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° è°ƒç”¨ ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹ ( sys_xyz )ï¼ŒçœŸæ­£å¼€å§‹å¤„ç†è¯¥ç³»ç»Ÿè°ƒç”¨ï¼›
æ‰§è¡Œæ€åˆ‡æ¢
åº”ç”¨ç¨‹åº ( application program )ä¸ åº“å‡½æ•° ( libc )ä¹‹é—´ï¼Œ ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° ( system call handler )ä¸ ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹ ( system call service routine )ä¹‹é—´ï¼Œ å‡æ˜¯æ™®é€šå‡½æ•°è°ƒç”¨ï¼Œåº”è¯¥ä¸éš¾ç†è§£ã€‚ è€Œ åº“å‡½æ•° ä¸ ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° ä¹‹é—´ï¼Œç”±äºæ¶‰åŠç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„åˆ‡æ¢ï¼Œè¦å¤æ‚ä¸€äº›ã€‚</p>

<p>Linux é€šè¿‡ è½¯ä¸­æ–­ å®ç°ä» ç”¨æˆ·æ€ åˆ° å†…æ ¸æ€ çš„åˆ‡æ¢ã€‚ ç”¨æˆ·æ€ ä¸ å†…æ ¸æ€ æ˜¯ç‹¬ç«‹çš„æ‰§è¡Œæµï¼Œå› æ­¤åœ¨åˆ‡æ¢æ—¶ï¼Œéœ€è¦å‡†å¤‡ æ‰§è¡Œæ ˆ å¹¶ä¿å­˜ å¯„å­˜å™¨ ã€‚</p>

<p>å†…æ ¸å®ç°äº†å¾ˆå¤šä¸åŒçš„ç³»ç»Ÿè°ƒç”¨(æä¾›ä¸åŒåŠŸèƒ½)ï¼Œè€Œ ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° åªæœ‰ä¸€ä¸ªã€‚ å› æ­¤ï¼Œç”¨æˆ·è¿›ç¨‹å¿…é¡»ä¼ é€’ä¸€ä¸ªå‚æ•°ç”¨äºåŒºåˆ†ï¼Œè¿™ä¾¿æ˜¯ ç³»ç»Ÿè°ƒç”¨å· ( system call number )ã€‚ åœ¨ Linux ä¸­ï¼Œ ç³»ç»Ÿè°ƒç”¨å· ä¸€èˆ¬é€šè¿‡ eax å¯„å­˜å™¨ æ¥ä¼ é€’ã€‚</p>

<p>æ€»ç»“èµ·æ¥ï¼Œ æ‰§è¡Œæ€åˆ‡æ¢ è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<p>åº”ç”¨ç¨‹åº åœ¨ ç”¨æˆ·æ€ å‡†å¤‡å¥½è°ƒç”¨å‚æ•°ï¼Œæ‰§è¡Œ int æŒ‡ä»¤è§¦å‘ è½¯ä¸­æ–­ ï¼Œä¸­æ–­å·ä¸º 0x80 ï¼›
CPU è¢«è½¯ä¸­æ–­æ‰“æ–­åï¼Œæ‰§è¡Œå¯¹åº”çš„ ä¸­æ–­å¤„ç†å‡½æ•° ï¼Œè¿™æ—¶ä¾¿å·²è¿›å…¥ å†…æ ¸æ€ ï¼›
ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° å‡†å¤‡ å†…æ ¸æ‰§è¡Œæ ˆ ï¼Œå¹¶ä¿å­˜æ‰€æœ‰ å¯„å­˜å™¨ (ä¸€èˆ¬ç”¨æ±‡ç¼–è¯­è¨€å®ç°)ï¼›
ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° æ ¹æ® ç³»ç»Ÿè°ƒç”¨å· è°ƒç”¨å¯¹åº”çš„ C å‡½æ•°â€”â€” ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹ ï¼›
ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° å‡†å¤‡ è¿”å›å€¼ å¹¶ä» å†…æ ¸æ ˆ ä¸­æ¢å¤ å¯„å­˜å™¨ ï¼›
ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•° æ‰§è¡Œ ret æŒ‡ä»¤åˆ‡æ¢å› ç”¨æˆ·æ€ ï¼›
ç¼–ç¨‹å®è·µ
ä¸‹é¢ï¼Œé€šè¿‡ä¸€ä¸ªç®€å•çš„ç¨‹åºï¼Œçœ‹çœ‹åº”ç”¨ç¨‹åºå¦‚ä½•åœ¨ ç”¨æˆ·æ€ å‡†å¤‡å‚æ•°å¹¶é€šè¿‡ int æŒ‡ä»¤è§¦å‘ è½¯ä¸­æ–­ ä»¥é™·å…¥ å†…æ ¸æ€ æ‰§è¡Œ ç³»ç»Ÿè°ƒç”¨ ï¼š
hello_world-int.S
.section .rodata</p>

<p>msg:
    .ascii â€œHello, world!\nâ€</p>

<p>.section .text</p>

<p>.global _start</p>

<p>_start:
    # call SYS_WRITE
    movl $4, %eax
    # push arguments
    movl $1, %ebx
    movl $msg, %ecx
    movl $14, %edx
    int $0x80</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Call SYS_EXIT
movl $1, %eax
# push arguments
movl $0, %ebx
# initiate
int $0x80 è¿™æ˜¯ä¸€ä¸ªæ±‡ç¼–è¯­è¨€ç¨‹åºï¼Œç¨‹åºå…¥å£åœ¨ _start æ ‡ç­¾ä¹‹åã€‚
</code></pre></div></div>

<p>ç¬¬ 12 è¡Œï¼Œå‡†å¤‡ ç³»ç»Ÿè°ƒç”¨å· ï¼šå°†å¸¸æ•° 4 æ”¾è¿› å¯„å­˜å™¨ eax ã€‚ ç³»ç»Ÿè°ƒç”¨å· 4 ä»£è¡¨ ç³»ç»Ÿè°ƒç”¨ SYS_write ï¼Œ æˆ‘ä»¬å°†é€šè¿‡è¯¥ç³»ç»Ÿè°ƒç”¨å‘æ ‡å‡†è¾“å‡ºå†™å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</p>

<p>ç¬¬ 14-16 è¡Œï¼Œ å‡†å¤‡ç³»ç»Ÿè°ƒç”¨å‚æ•°ï¼šç¬¬ä¸€ä¸ªå‚æ•°æ”¾è¿› å¯„å­˜å™¨ ebx ï¼Œç¬¬äºŒä¸ªå‚æ•°æ”¾è¿› ecx ï¼Œ ä»¥æ­¤ç±»æ¨ã€‚</p>

<p>write ç³»ç»Ÿè°ƒç”¨éœ€è¦ 3 ä¸ªå‚æ•°ï¼š</p>

<p>æ–‡ä»¶æè¿°ç¬¦ ï¼Œæ ‡å‡†è¾“å‡ºæ–‡ä»¶æè¿°ç¬¦ä¸º 1 ï¼›
å†™å…¥å†…å®¹(ç¼“å†²åŒº)åœ°å€ï¼›
å†™å…¥å†…å®¹é•¿åº¦(å­—èŠ‚æ•°)ï¼›
ç¬¬ 17 è¡Œï¼Œæ‰§è¡Œ int æŒ‡ä»¤è§¦å‘è½¯ä¸­æ–­ 0x80 ï¼Œç¨‹åºå°†é™·å…¥å†…æ ¸æ€å¹¶ç”±å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå®Œæ¯•åï¼Œå†…æ ¸å°†è´Ÿè´£åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œåº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œä¹‹åçš„æŒ‡ä»¤( ä» 20 è¡Œå¼€å§‹ )ã€‚</p>

<p>ç¬¬ 20-24 è¡Œï¼Œè°ƒç”¨ exit ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥ä¾¿é€€å‡ºç¨‹åºã€‚</p>

<p>æ³¨è§£
æ³¨æ„åˆ°ï¼Œè¿™é‡Œå¿…é¡»æ˜¾å¼è°ƒç”¨ exit ç³»ç»Ÿè°ƒç”¨é€€å‡ºç¨‹åºã€‚ å¦åˆ™ï¼Œç¨‹åºå°†ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæœ€ç»ˆé‡åˆ°æ®µé”™è¯¯( segmentation fault )ï¼</p>

<p>è¯»è€…å¯èƒ½å¾ˆå¥½å¥‡â€”â€”æˆ‘åœ¨å†™ C è¯­è¨€æˆ–è€…å…¶ä»–ç¨‹åºæ—¶ï¼Œè¿™ä¸ªè°ƒç”¨å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼</p>

<p>è¿™æ˜¯å› ä¸º C åº“( libc )å·²ç»å¸®ä½ æŠŠè„æ´»ç´¯æ´»éƒ½å¹²äº†ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç¼–è¯‘å¹¶æ‰§è¡Œè¿™ä¸ªæ±‡ç¼–è¯­è¨€ç¨‹åºï¼š</p>

<p>$ ls
hello_world-int.S
$ as -o hello_world-int.o hello_world-int.S
$ ls
hello_world-int.o  hello_world-int.S
$ ld -o hello_world-int hello_world-int.o
$ ls
hello_world-int  hello_world-int.o  hello_world-int.S
$ ./hello_world-int
Hello, world!
å…¶å®ï¼Œå°† ç³»ç»Ÿè°ƒç”¨å· å’Œ è°ƒç”¨å‚æ•° æ”¾è¿›æ­£ç¡®çš„ å¯„å­˜å™¨ å¹¶è§¦å‘æ­£ç¡®çš„ è½¯ä¸­æ–­ æ˜¯ä¸ªé‡å¤çš„éº»çƒ¦äº‹ã€‚ C åº“å·²ç»æŠŠè¿™è„ç´¯æ´»ç»™å¹²äº†â€”â€”è¯•è¯• syscall å‡½æ•°å§ï¼</p>

<p>hello_world-syscall.c
#include <string.h>
#include &lt;sys/syscall.h&gt;
#include <unistd.h></unistd.h></string.h></p>

<p>int main(int argc, char *argv[])
{
    char *msg = â€œHello, world!\nâ€;
    syscall(SYS_write, 1, msg, strlen(msg));</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return 0; }
</code></pre></div></div>

<p>ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬åŸç†
ç³»ç»Ÿè°ƒç”¨å…¶å®å°±æ˜¯å‡½æ•°è°ƒç”¨ï¼Œåªä¸è¿‡è°ƒç”¨çš„æ˜¯å†…æ ¸æ€çš„å‡½æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œç”¨æˆ·æ€æ˜¯ä¸èƒ½éšæ„è°ƒç”¨å†…æ ¸æ€çš„å‡½æ•°çš„ï¼Œæ‰€ä»¥é‡‡ç”¨è½¯ä¸­æ–­çš„æ–¹å¼ä»ç”¨æˆ·æ€é™·å…¥åˆ°å†…æ ¸æ€ã€‚åœ¨å†…æ ¸ä¸­é€šè¿‡è½¯ä¸­æ–­0X80ï¼Œç³»ç»Ÿä¼šè·³è½¬åˆ°ä¸€ä¸ªé¢„è®¾å¥½çš„å†…æ ¸ç©ºé—´åœ°å€ï¼Œå®ƒæŒ‡å‘äº†ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºï¼ˆä¸è¦å’Œç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹æ··æ·†ï¼‰ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯åœ¨entry.Sæ–‡ä»¶ä¸­çš„system_callå‡½æ•°ã€‚å°±æ˜¯è¯´ï¼Œæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½ä¼šç»Ÿä¸€è·³è½¬åˆ°è¿™ä¸ªåœ°å€æ‰§è¡Œsystem_callå‡½æ•°ï¼Œé‚£ä¹ˆsystem_callå‡½æ•°å¦‚ä½•æ´¾å‘å®ƒä»¬åˆ°å„è‡ªçš„æœåŠ¡ä¾‹ç¨‹å‘¢ï¼Ÿ
æˆ‘ä»¬çŸ¥é“æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½æœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·ã€‚åŒæ—¶ï¼Œå†…æ ¸ä¸­ä¸€ä¸ªæœ‰ä¸€ä¸ªsystem_call_tableæ•°ç»„ï¼Œå®ƒæ˜¯ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ¯ä¸ªå‡½æ•°æŒ‡é’ˆéƒ½æŒ‡å‘äº†ç³»ç»Ÿè°ƒç”¨çš„æœåŠ¡ä¾‹ç¨‹ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ˜¯system_call_tableçš„ä¸‹æ ‡ï¼Œç”¨æ¥æŒ‡æ˜åˆ°åº•è¦æ‰§è¡Œå“ªä¸ªç³»ç»Ÿè°ƒç”¨ã€‚å½“int ox80çš„è½¯ä¸­æ–­æ‰§è¡Œæ—¶ï¼Œç³»ç»Ÿè°ƒç”¨å·ä¼šè¢«æ”¾è¿›eaxå¯„å­˜å™¨ä¸­ï¼Œsystem_callå‡½æ•°å¯ä»¥è¯»å–eaxå¯„å­˜å™¨è·å¾—ç³»ç»Ÿè°ƒç”¨å·ï¼Œå°†å…¶ä¹˜ä»¥4å¾—åˆ°åç§»åœ°å€ï¼Œä»¥sys_call_tableä¸ºåŸºåœ°å€ï¼ŒåŸºåœ°å€åŠ ä¸Šåç§»åœ°å€å°±æ˜¯åº”è¯¥æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹çš„åœ°å€ã€‚</p>

<p>ç³»ç»Ÿè°ƒç”¨çš„ä¼ å‚é—®é¢˜
å½“ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¸ªæ•°å¤§äº5æ—¶ï¼ˆå› ä¸º5ä¸ªå¯„å­˜å™¨ï¼ˆeax, ebx, ecx, edx,esiï¼‰å·²ç»ç”¨å®Œäº†ï¼‰ï¼Œæ‰§è¡Œint 0x80æŒ‡ä»¤æ—¶ä»éœ€å°†ç³»ç»Ÿè°ƒç”¨åŠŸèƒ½å·ä¿å­˜åœ¨å¯„å­˜å™¨eaxä¸­ï¼Œæ‰€ä¸åŒçš„åªæ˜¯å…¨éƒ¨å‚æ•°åº”è¯¥ä¾æ¬¡æ”¾åœ¨ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸé‡Œï¼ŒåŒæ—¶åœ¨å¯„å­˜å™¨ebxä¸­ä¿å­˜æŒ‡å‘è¯¥å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆã€‚ç³»ç»Ÿè°ƒç”¨å®Œæˆä¹‹åï¼Œè¿”å›å€¼æ‰”å°†ä¿å­˜åœ¨å¯„å­˜å™¨eaxä¸­ã€‚ç”±äºåªæ˜¯éœ€è¦ä¸€å—è¿ç»­çš„å†…å­˜åŒºåŸŸæ¥ä¿å­˜ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ï¼Œå› æ­¤å®Œå…¨å¯ä»¥åƒæ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·ä½¿ç”¨æ ˆï¼ˆstackï¼‰æ¥ä¼ é€’ç³»ç»Ÿè°ƒç”¨æ‰€éœ€è¦çš„å‚æ•°ã€‚ä½†æ˜¯è¦æ³¨æ„ä¸€ç‚¹ï¼ŒLinuxé‡‡ç”¨çš„æ˜¯cè¯­è¨€çš„è°ƒç”¨æ¨¡å¼ï¼Œè¿™å°±æ„å‘³ç€æ‰€æœ‰å‚æ•°å¿…é¡»ä»¥ç›¸åçš„é¡ºåºè¿›æ ˆï¼Œå³æœ€åä¸€ä¸ªå‚æ•°å…ˆå…¥æ ˆï¼Œè€Œç¬¬ä¸€ä¸ªå‚æ•°åˆ™æœ€åå…¥æ ˆã€‚å¦‚æœé‡‡ç”¨æ ˆæ¥ä¼ é€’ç³»ç»Ÿè°ƒç”¨æ‰€éœ€è¦çš„å‚æ•°ï¼Œåœ¨æ‰§è¡Œint 0x80æŒ‡ä»¤æ—¶è¿˜åº”è¯¥å°†æ ˆæŒ‡é’ˆçš„å½“å‰å€¼å¤åˆ¶åˆ°å¯„å­˜å™¨ebxä¸­ã€‚</p>

<p>1.æ·»åŠ ç³»ç»Ÿè°ƒç”¨çš„ä¸¤ç§æ–¹æ³•
æ–¹æ³•ä¸€ï¼šç¼–è¯‘å†…æ ¸æ³•
æ‹¿åˆ°æºç ä¹‹å</p>

<p>ä¿®æ”¹å†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨åº“å‡½æ•° /usr/include/asm-generic/unistd.hï¼Œåœ¨è¿™é‡Œé¢å¯ä»¥ä½¿ç”¨åœ¨syscall_tableä¸­æ²¡æœ‰ç”¨åˆ°çš„223å·
æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·ï¼Œè®©ç³»ç»Ÿæ ¹æ®è¿™ä¸ªå·ï¼Œå»æ‰¾åˆ°syscall_tableä¸­çš„ç›¸åº”è¡¨é¡¹ã€‚åœ¨/arch/x86/kernel/syscall_table_32.sæ–‡ä»¶ä¸­æ·»åŠ ç³»ç»Ÿè°ƒç”¨å·å’Œè°ƒç”¨å‡½æ•°çš„å¯¹åº”å…³ç³»
æ¥ç€å°±æ˜¯my_syscallçš„å®ç°äº†ï¼Œåœ¨è¿™é‡Œæœ‰ä¸¤ç§æ–¹æ³•ï¼šç¬¬ä¸€ç§æ–¹æ³•æ˜¯åœ¨kernelä¸‹è‡ªå·±æ–°å»ºä¸€ä¸ªç›®å½•æ·»åŠ è‡ªå·±çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¦ç¼–å†™Makefileï¼Œè€Œä¸”è¦ä¿®æ”¹å…¨å±€çš„Makefileã€‚ç¬¬äºŒç§æ¯”è¾ƒç®€ä¾¿çš„æ–¹æ³•æ˜¯ï¼Œåœ¨kernel/sys.cä¸­æ·»åŠ è‡ªå·±çš„æœåŠ¡å‡½æ•°ï¼Œè¿™æ ·å­ä¸ç”¨ä¿®æ”¹Makefile.
ä»¥ä¸Šå‡†å¤‡å·¥ä½œåšå®Œä¹‹åï¼Œç„¶åå°±è¦è¿›è¡Œç¼–è¯‘å†…æ ¸äº†ï¼Œä»¥ä¸‹æ˜¯æˆ‘ç¼–è¯‘å†…æ ¸çš„ä¸€ä¸ªè¿‡ç¨‹ã€‚</p>

<p>1.make menuconfig (ä½¿ç”¨å›¾å½¢åŒ–çš„å·¥å…·ï¼Œæ›´æ–°.configæ–‡ä»¶)
2.make -j3 bzImage  ï¼ˆç¼–è¯‘ï¼Œ-j3æŒ‡çš„æ˜¯åŒæ—¶ä½¿ç”¨3ä¸ªcpuæ¥ç¼–è¯‘ï¼ŒbzImageæŒ‡çš„æ˜¯æ›´æ–°grubï¼Œä»¥ä¾¿é‡æ–°å¼•å¯¼ï¼‰
3.make modules   ï¼ˆå¯¹æ¨¡å—è¿›è¡Œç¼–è¯‘ï¼‰
4.make modules_installï¼ˆå®‰è£…ç¼–è¯‘å¥½çš„æ¨¡å—ï¼‰
5.depmod  ï¼ˆè¿›è¡Œä¾èµ–å…³ç³»çš„å¤„ç†ï¼‰
6.reboot  ï¼ˆé‡å¯çœ‹åˆ°è‡ªå·±ç¼–è¯‘å¥½çš„å†…æ ¸ï¼‰
æ–¹æ³•äºŒï¼šå†…æ ¸æ¨¡å—æ³•
è¿™ç§æ–¹æ³•æ˜¯é‡‡ç”¨ç³»ç»Ÿè°ƒç”¨æ‹¦æˆªçš„ä¸€ç§æ–¹å¼ï¼Œæ”¹å˜æŸä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·å¯¹åº”çš„æœåŠ¡ç¨‹åºä¸ºæˆ‘ä»¬è‡ªå·±çš„ç¼–å†™çš„ç¨‹åºï¼Œä»è€Œç›¸å½“äºæ·»åŠ äº†æˆ‘ä»¬è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨ã€‚å…·ä½“å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ï¼š</p>

<p>2.é€šè¿‡å†…æ ¸æ¨¡å—å®ç°æ·»åŠ ç³»ç»Ÿè°ƒç”¨
è¿™ç§æ–¹æ³•å…¶å®æ˜¯ç³»ç»Ÿè°ƒç”¨æ‹¦æˆªçš„å®ç°ã€‚ç³»ç»Ÿè°ƒç”¨æœåŠ¡ç¨‹åºçš„åœ°å€æ˜¯æ”¾åœ¨sys_call_tableä¸­é€šè¿‡ç³»ç»Ÿè°ƒç”¨å·å®šä½åˆ°å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨åœ°å€ï¼Œé‚£ä¹ˆæˆ‘ä»¬é€šè¿‡ç¼–å†™å†…æ ¸æ¨¡å—æ¥ä¿®æ”¹sys_call_tableä¸­çš„ç³»ç»Ÿè°ƒç”¨çš„åœ°å€ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å‡½æ•°çš„åœ°å€ï¼Œå°±å¯ä»¥å®ç°ç³»ç»Ÿè°ƒç”¨çš„æ‹¦æˆªã€‚
æƒ³æ³•æœ‰äº†ï¼šé‚£å°±æ˜¯é€šè¿‡æ¨¡å—åŠ è½½æ—¶ï¼Œå°†ç³»ç»Ÿè°ƒç”¨è¡¨é‡Œé¢çš„é‚£ä¸ªç³»ç»Ÿè°ƒç”¨å·çš„é‚£ä¸ªç³»ç»Ÿè°ƒç”¨å·å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹æ”¹ä¸ºæˆ‘ä»¬è‡ªå·±å®ç°çš„ç³»ç»Ÿå†ç¨‹å‡½æ•°åœ°å€ã€‚ä½†æ˜¯å†…æ ¸å·²ç»ä¸çŸ¥é“ä»å“ªä¸ªç‰ˆæœ¬å°±ä¸æ”¯æŒå¯¼å‡ºsys_call_tableäº†ã€‚æ‰€ä»¥é¦–å…ˆè¦è·å–sys_call_tableçš„åœ°å€ã€‚
ç½‘ä¸Šä»‹ç»äº†å¥½å¤šç§æ–¹æ³•æ¥å¾—åˆ°sys_call_tableçš„åœ°å€ï¼Œè¿™é‡Œä»‹ç»æœ€ç®€å•çš„ä¸€ç§æ–¹æ³•</p>

<p>grep sys_call_table /boot/System.map-<code class="language-plaintext highlighter-rouge">uname -r</code></p>

<p>è¿™æ ·å°±å¾—åˆ°äº†sys_call_tableçš„åœ°å€ï¼Œä½†åŒæ—¶ä¹Ÿå¾—åˆ°äº†ä¸€ä¸ªé‡è¦çš„ä¿¡æ¯ï¼Œè¯¥ç¬¦å·å¯¹åº”çš„å†…å­˜åŒºåŸŸæ˜¯åªè¯»çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹å®ƒï¼Œå¿…é¡»å¯¹å®ƒè¿›è¡Œæ¸…æ¥šå†™ä¿æŠ¤ï¼Œè¿™é‡Œä»‹ç»ä¸¤ç§æ–¹æ³•ï¼š
ç¬¬ä¸€ç§æ–¹æ³•ï¼šï¼šæˆ‘ä»¬çŸ¥é“æ§åˆ¶å¯„å­˜å™¨cr0çš„ç¬¬16ä½æ˜¯å†™ä¿æŠ¤ä½ã€‚cr0çš„ç¬¬16ä½ç½®ä¸ºäº†ç¦æ­¢è¶…çº§æƒé™ï¼Œè‹¥æ¸…é›¶äº†åˆ™å…è®¸è¶…çº§æƒé™å¾€å†…æ ¸ä¸­å†™å…¥æ•°æ®ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥å†å†™å…¥ä¹‹å‰ï¼Œå°†é‚£ä¸€ä½æ¸…é›¶ï¼Œä½¿æˆ‘ä»¬å¯ä»¥å†™å…¥ã€‚ç„¶åå†™å®Œåï¼Œåˆå°†é‚£ä¸€ä½å¤åŸå°±è¡Œäº†ã€‚</p>

<p>unsigned int clear_and_return_cr0(void)
{
 unsigned int cr0 = 0;
 unsigned int ret;
 asm(â€œmovl %%cr0, %%eaxâ€:â€=aâ€(cr0));
 ret = cr0;
 cr0 &amp;= 0xfffeffff;
 asm(â€œmovl %%eax, %%cr0â€::â€aâ€(cr0));
 return ret;
}</p>

<p>void setback_cr0(unsigned int val) //è¯»å–valçš„å€¼åˆ°eaxå¯„å­˜å™¨ï¼Œå†å°†eaxå¯„å­˜å™¨çš„å€¼æ”¾å…¥cr0ä¸­
{
 asm volatile(â€œmovl %%eax, %%cr0â€::â€aâ€(val));
}</p>

<p>ç¬¬äºŒç§æ–¹æ³•ï¼šé€šè¿‡è®¾ç½®è™šæ‹Ÿåœ°å€å¯¹åº”çš„ä¹Ÿè¡¨é¡¹çš„è¯»å†™å±æ€§æ¥è®¾ç½®ï¼š</p>

<p>int make_rw(unsigned long address)<br />
{<br />
        unsigned int level;<br />
        pte_t *pte = lookup_address(address, &amp;level);//æŸ¥æ‰¾è™šæ‹Ÿåœ°å€æ‰€åœ¨çš„é¡µè¡¨åœ°å€<br />
        if (pte-&gt;pte &amp; ~_PAGE_RW)  //è®¾ç½®é¡µè¡¨è¯»å†™å±æ€§
                pte-&gt;pte |=  _PAGE_RW;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    return 0;   }  
</code></pre></div></div>

<p>int make_ro(unsigned long address)<br />
{<br />
        unsigned int level;<br />
        pte_t *pte = lookup_address(address, &amp;level);<br />
        pte-&gt;pte &amp;= ~_PAGE_RW;  //è®¾ç½®åªè¯»å±æ€§</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    return 0;   } 
</code></pre></div></div>

<p>3.ç¼–å†™ç³»ç»Ÿè°ƒç”¨æŒ‡å®šè‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨
å†…æ ¸çš„åˆå§‹åŒ–å‡½æ•°
åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨ç³»ç»Ÿç©ºé—²çš„223å·ç©ºé—²çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œä½ ä¹Ÿå¯ä»¥æ¢æˆå…¶ä»–ç³»ç»Ÿè°ƒç”¨çš„è°ƒç”¨å·ï¼Œè¿™æ ·ä½ åœ¨æ‰§è¡Œå…¶ä»–å‡½æ•°æ—¶ï¼Œå°±ä¼šè°ƒç”¨è‡ªå·±çš„å†™çš„å‡½æ•°çš„å†…å®¹ã€‚</p>

<p>static int syscall_init_module(void)<br />
{<br />
        printk(KERN_ALERT â€œsys_call_table: 0x%p\nâ€, sys_call_table);//è·å–ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€
        orig_saved = (unsigned long *)(sys_call_table[223]);  //ä¿å­˜åŸæœ‰çš„223å·çš„ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€
        printk(KERN_ALERT â€œorig_saved : 0x%p\nâ€, orig_saved );</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    make_rw((unsigned long)sys_call_table);  //ä¿®æ”¹é¡µçš„å†™å±æ€§
    sys_call_table[223] = (unsigned long *)sys_mycall;  //å°†223å·æŒ‡å‘è‡ªå·±å†™çš„è°ƒç”¨å‡½æ•°
    make_ro((unsigned long)sys_call_table);  
  
    return 0;   } è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹
</code></pre></div></div>

<p>asmlinkage long sys_mycall(void)
{
    printk(KERN_ALERT â€œi am hack syscall!\nâ€);
    return 0;
}
ç§»é™¤å†…æ ¸æ¨¡å—æ—¶ï¼Œå°†åŸæœ‰çš„ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¿˜åŸ</p>

<p>static void syscall_cleanup_module(void)<br />
{<br />
        printk(KERN_ALERT â€œModule syscall unloaded.\nâ€);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    make_rw((unsigned long)sys_call_table);  
    sys_call_table[223] = (unsigned long *) orig_saved ;   
    make_ro((unsigned long)sys_call_table);   } æ¨¡å—æ³¨å†Œç›¸å…³
</code></pre></div></div>

<p>module_init(syscall_init_module);<br />
module_exit(syscall_cleanup_module);</p>

<p>MODULE_LICENSE(â€œGPLâ€);<br />
MODULE_DESCRIPTION(â€œmysyscallâ€);<br />
4.ç¼–å†™ç”¨æˆ·æ€çš„æµ‹è¯•ç¨‹åº
  1 #include &lt;linux/unistd.h&gt;
  2 #include <syscall.h>
  3 #include &lt;sys/types.h&gt;
  4 #include <stdio.h>
  5 
  6 int main(void)
  7 {
  8     long pid = 0;
  9     pid = syscall(223);
 10     printf("%ld\n",pid);
 11     return 0;
 12 }
å½“æˆ‘ä»¬ä½¿ç”¨syscall()è¿™ä¸ªå‡½æ•°å»è§¦å‘223çš„ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œdmesgä¼šå‘ç°æˆ‘ä»¬è‡ªå·±å†™çš„æœåŠ¡å‡½æ•°çš„è¾“å‡ºç»“æœ:</stdio.h></syscall.h></p>

<p>start_kernelä»å†…æ ¸ä¸€å¯åŠ¨çš„æ—¶å€™å®ƒä¼šä¸€ç›´å­˜åœ¨ï¼Œè¿™ä¸ªå°±æ˜¯0å·è¿›ç¨‹ï¼Œidleå°±æ˜¯ä¸€ä¸ªwhile0,ä¸€ç›´åœ¨å¾ªç¯ç€ï¼Œå½“ç³»ç»Ÿæ²¡æœ‰è¿›ç¨‹éœ€è¦æ‰§è¡Œçš„æ—¶å€™å°±è°ƒåº¦åˆ°idleè¿›ç¨‹ï¼Œæˆ‘ä»¬åœ¨windowsç³»ç»Ÿä¸Šä¼šç»å¸¸è§åˆ°ï¼Œå«åšsystem idle,è¿™æ˜¯ä¸€ä¸ªä¸€ç›´ä¼šå­˜åœ¨çš„0å·è¿›ç¨‹ï¼Œç„¶åå‘¢å°±æ˜¯0å·è¿›ç¨‹åˆ›å»ºäº†1å·è¿›ç¨‹ï¼Œè¿™ä¸ªinit_processæ˜¯æˆ‘ä»¬çš„1å·è¿›ç¨‹ä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯å®ƒé»˜è®¤çš„å°±æ˜¯æ ¹ç›®å½•ä¸‹çš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å¸¸ä¼šæ‰¾é»˜è®¤è·¯å¾„ä¸‹çš„ç¨‹åºæ¥ä½œä¸º1å·è¿›ç¨‹ï¼Œ1å·è¿›ç¨‹æ¥ä¸‹æ¥è¿˜åˆ›å»ºäº†kthreaddæ¥ç®¡ç†å†…æ ¸çš„ä¸€äº›çº¿ç¨‹ï¼Œè¿™æ ·æ•´ä¸ªç¨‹åºå°±å¯åŠ¨èµ·æ¥äº†ã€‚</p>

<p>äºŒ.å†…æ ¸æ€ã€ç”¨æˆ·æ€ã€ä¸­æ–­ç­‰æ¦‚å¿µçš„ä»‹ç»</p>

<p>ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„åŒºåˆ†ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   ç°ä»£è®¡ç®—æœºæœºä¸­éƒ½æœ‰å‡ ç§ä¸åŒçš„æŒ‡ä»¤çº§åˆ«ï¼Œåœ¨é«˜æ‰§è¡Œçº§åˆ«ä¸‹ï¼Œä»£ç å¯ä»¥æ‰§è¡Œç‰¹æƒæŒ‡ä»¤ï¼Œè®¿é—®ä»»æ„çš„ç‰©ç†åœ°å€ï¼Œè¿™ç§CPUæ‰§è¡Œçº§åˆ«å°±å¯¹åº”ç€å†…æ ¸æ€ï¼Œè€Œåœ¨ç›¸åº”çš„ä½çº§åˆ«æ‰§è¡ŒçŠ¶æ€ä¸‹ï¼Œä»£ç çš„æŒæ§èŒƒå›´ä¼šå—åˆ°é™åˆ¶ï¼Œåªèƒ½åœ¨å¯¹åº”çº§åˆ«å…è®¸çš„èŒƒå›´å†…æ´»åŠ¨ã€‚ä¸¾ä¾‹ï¼šIntrel x86 CPUæœ‰å››ç§ä¸åŒçš„æ‰§è¡Œçº§åˆ«0-3ï¼ŒLinuxåªä½¿ç”¨äº†å…¶ä¸­çš„0çº§å’Œ3çº§æ¥åˆ†åˆ«è¡¨ç¤ºå†…æ ¸æ€å’Œç”¨æˆ·æ€ã€‚æ“ä½œç³»ç»Ÿè®©ç³»ç»Ÿæœ¬èº«æ›´ä¸ºç¨³å®šçš„æ–¹å¼ï¼Œè¿™æ ·ç¨‹åºå‘˜è‡ªå·±å†™çš„ç”¨æˆ·æ€ä»£ç å¾ˆéš¾æŠŠæ•´ä¸ªç³»ç»Ÿéƒ½ç»™æå´©æºƒï¼Œå†…æ ¸çš„ä»£ç ç»è¿‡ä»”ç»†çš„åˆ†ææœ‰ä¸“ä¸šçš„äººå‘˜å†™çš„ä»£ç ä¼šæ›´åŠ å¥å£®ä¸€äº›ï¼Œæ•´ä¸ªç¨‹åºä¼šæ›´åŠ ç¨³å®šä¸€äº›ï¼Œæ³¨æ„ï¼šè¿™é‡Œæ‰€è¯´çš„åœ°å€ç©ºé—´æ˜¯é€»è¾‘åœ°å€è€Œä¸æ˜¯ç‰©ç†åœ°å€ã€‚

 ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„å¾ˆæ˜¾è‘—çš„åŒºåˆ†å°±æ˜¯ï¼šCSå’ŒEIPï¼Œ CSå¯„å­˜å™¨çš„æœ€ä½ä¸¤ä½è¡¨æ˜äº†å½“å‰ä»£ç çš„ç‰¹æƒçº§åˆ«ï¼›CPUæ¯æ¡æŒ‡ä»¤çš„è¯»å–éƒ½æ˜¯é€šè¿‡CS:EIPè¿™ä¸¤ä¸ªå¯„å­˜å™¨ï¼šå…¶ä¸­CSæ˜¯ä»£ç æ®µé€‰æ‹©å¯„å­˜å™¨ï¼ŒEIPæ˜¯åç§»é‡å¯„å­˜å™¨ï¼Œä¸Šè¿°åˆ¤æ–­ç”±ç¡¬ä»¶å®Œæˆã€‚ä¸€èˆ¬æ¥è¯´åœ¨Linuxä¸­ï¼Œåœ°å€ç©ºé—´æ˜¯ä¸€ä¸ªæ˜¾è‘—çš„æ ‡å¿—ï¼š0xc0000000ä»¥ä¸Šçš„åœ°å€ç©ºé—´åªèƒ½åœ¨å†…æ ¸æ€ä¸‹è®¿é—®ï¼Œ0xc00000000-0xbfffffffçš„åœ°å€ç©ºé—´åœ¨ä¸¤ç§çŠ¶æ€ä¸‹éƒ½å¯ä»¥è®¿é—®ã€‚
</code></pre></div></div>

<p>ä¸­æ–­å¤„ç†æ˜¯ä»ç”¨æˆ·æ€è¿›å…¥åˆ°å†…æ ¸æ€çš„ä¸»è¦çš„æ–¹å¼ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ä¹Ÿå¯èƒ½æ˜¯ç”¨æˆ·æ€ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹ä¸­è°ƒç”¨äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨é™·å…¥äº†å†…æ ¸æ€å½“ä¸­ï¼Œè¿™ä¸ªå«åštrap,ç³»ç»Ÿè°ƒç”¨åªæ˜¯ä¸€ç§ç‰¹æ®Šçš„ä¸­æ–­ã€‚
  å¯„å­˜å™¨ä¸Šä¸‹æ–‡ï¼š
        â€”â€”ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€çš„æ—¶å€™
              å¿…é¡»ä¿å­˜ç”¨æˆ·æ€çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡
              è¦ä¿å­˜å“ªäº›ï¼Ÿ
              ä¿å­˜åœ¨å“ªé‡Œï¼Ÿ
  ä¸­æ–­/intæŒ‡ä»¤ä¼šåœ¨å †æ ˆä¸Šä¿å­˜ä¸€äº›å¯„å­˜å™¨çš„å€¼
        â€”â€”å¦‚ï¼šç”¨æˆ·æ€æ ˆé¡¶åœ°å€ã€å½“æ—¶çš„çŠ¶æ€å­—ã€å½“æ—¶çš„cs:eipçš„å€¼
  ä¸­æ–­å‘ç”Ÿçš„åçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ä¿æŠ¤ç°åœºï¼Œä¿æŠ¤ç°åœºå°±æ˜¯è¿›å…¥ä¸­æ–­çš„ç¨‹åºä¿å­˜éœ€è¦ç”¨åˆ°çš„å¯„å­˜å™¨æ•°æ®ï¼Œæ¢å¤ç°åœºå°±æ˜¯é€€å‡ºä¸­æ–­ç¨‹åºï¼Œæ¢å¤ã€ä¿å­˜å¯„å­˜å™¨çš„æ•°æ®ã€‚
</code></pre></div></div>

<p>1
2
3
4
5
6
7
8
9
10
11
12
13
14
#define SAVE_ALL                                                      RESTORE_ALL
      â€œcld\n\tâ€\                                                      popl %ebx;
      â€œpushl %es\n\tâ€\                                                popl %ecx;
      â€œpushl %ds\n\tâ€\                                                popl %ebx;
      â€œpushl %eax\n\tâ€\                                               popl %edx;
      â€œpushl %ebp\n\tâ€\                                               popl %esi;
      â€œpushl %edi\n\tâ€\                                               popl %edi;
      â€œpushl %esi\n\tâ€\                                               popl %ebp; 
      â€œpushl %edx\n\tâ€\                                               popl %eax;
      â€œpushl %ecx\n\tâ€\                                               popl %ds;           <br />
      â€œpushl %ebx\n\tâ€\                                               popl %es;
      â€œmovl $â€ STR(_KERNEL_DS)â€,%edx\n\tâ€\                            addl $4,%esp;
      â€œmovl %edx,%ds\n\tâ€\                                            iret;
      â€œmovl %edx,%es\n\tâ€
      iretæŒ‡ä»¤ä¸ä¸­æ–­ä¿¡å·(åŒ…æ‹¬intæŒ‡ä»¤),å‘ç”Ÿæ—¶çš„CPUçš„åŠ¨ä½œæ­£å¥½ç›¸åã€‚</p>

<p>ä»”ç»†åˆ†æä¸€ä¸‹ä¸­æ–­å¤„ç†çš„å®Œæ•´è¿‡ç¨‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  interrupt(ex:int0x80)-save//å‘ç”Ÿç³»ç»Ÿè°ƒç”¨     
   cs:eip/ss:esp/ss:esp/efalgs(current)to kernel stack,then load cs:eip(entry of a specific ISR)and ss:esp(point to kernel stack) //ä¿å­˜äº†cs:eipçš„å€¼ï¼Œä¿å­˜äº†å †æ ˆå¯„å­˜å™¨å½“å‰çš„æ ˆé¡¶ï¼Œå½“å‰çš„æ ‡å¿—å¯„å­˜å™¨ï¼Œå½“å‰çš„ä¿å­˜åˆ°å†…æ ¸å †æ ˆé‡Œé¢ï¼Œå½“å‰åŠ è½½äº†ä¸­æ–­ä¿¡å·å’Œç³»ç»Ÿè°ƒç”¨ç›¸å…³è”çš„ä¸­æ–­æœåŠ¡ç¨‹åºçš„å…¥å£ï¼ŒæŠŠå®ƒåŠ è½½åˆ°å½“å‰cs:eipçš„é‡Œé¢ï¼ŒåŒæ—¶ä¹Ÿè¦æŠŠå½“å‰çš„espå’Œå †æ ˆæ®µä¹Ÿå°±æ˜¯æŒ‡å‘å†…æ ¸çš„ä¿¡æ¯ä¹ŸåŠ è½½åˆ°cpué‡Œé¢,è¿™æ˜¯ç”±ä¸­æ–­å‘é‡æˆ–è€…è¯´æ˜¯intæŒ‡ä»¤å®Œæˆçš„ã€‚è¿™ä¸ªæ—¶å€™å¼€å§‹å†…æ ¸æ€çš„ä»£ç ã€‚ SAVE_ALL
 -...//å†…æ ¸ä»£ç ï¼Œå®Œæˆä¸­æ–­æœåŠ¡ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè¿›ç¨‹è°ƒåº¦  
RESTOER_ALL                //å®Œæˆä¹‹åå†è¿”å›åˆ°åŸæ¥çš„çŠ¶æ€
iret-pop    
 cs:eip/ss:eip/eflag from kernel stack ä¸‰.ç³»ç»Ÿè°ƒç”¨æ¦‚è¿°
</code></pre></div></div>

<p>ç³»ç»Ÿè°ƒç”¨çš„æ„ä¹‰ï¼š
      æ“ä½œç³»ç»Ÿä¸ºç”¨æˆ·æ€è¿›ç¨‹ä¸ç¡¬ä»¶è®¾å¤‡è¿›è¡Œäº¤äº’æä¾›äº†ä¸€ç»„æ¥å£â€”â€”ç³»ç»Ÿè°ƒç”¨:1.æŠŠç”¨æˆ·ä»åº•å±‚çš„ç¡¬ä»¶ç¼–ç¨‹ä¸­è§£æ”¾äº†å‡ºæ¥;2.æå¤§åœ°æé«˜äº†ç³»ç»Ÿçš„å®‰å…¨æ€§ä½¿ç”¨æˆ·ç¨‹åºå…·æœ‰å¯ç§»æ¤æ€§;ç”¨æˆ·ç¨‹åºä¸å…·ä½“ç¡¬ä»¶å·²ç»è¢«æŠ½è±¡æ¥å£æ‰€æ›¿ä»£ã€‚
æ“ä½œç³»ç»Ÿæä¾›çš„APIå’Œç³»ç»Ÿè°ƒç”¨çš„å…³ç³»:
    APIï¼ˆåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼‰å’Œç³»ç»Ÿè°ƒç”¨ï¼šåº”ç”¨ç¼–ç¨‹æ¥å£å’Œç³»ç»Ÿè°ƒç”¨æ˜¯ä¸åŒçš„ï¼š1.APIåªæ˜¯ä¸€ä¸ªå‡½æ•°å®šä¹‰ï¼›2.ç³»ç»Ÿè°ƒç”¨é€šè¿‡è½¯ä¸­æ–­å‘å†…æ ¸å‘å‡ºäº†ä¸€ä¸ªæ˜ç¡®çš„è¯·æ±‚ã€‚
     Libcåº“å®šä¹‰çš„ä¸€äº›APIå¼•ç”¨äº†å°è£…ä¾‹æˆï¼Œå”¯ä¸€ç›®çš„å°±æ˜¯å‘å¸ƒç³»ç»Ÿè°ƒç”¨ï¼š1.ä¸€èˆ¬æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹åº”ä¸€ä¸ªå°è£…ä¾‹ç¨‹ï¼›2.åº“å‡½æ•°å†ç”¨è¿™äº›å°è£…ä¾‹ç¨‹å®šä¹‰å‡ºç»™ç”¨æˆ·çš„APIï¼ˆæŠŠç³»ç»Ÿè°ƒç”¨å°è£…æˆå¾ˆå¤šæ­Œæ–¹ä¾¿ç¨‹åºå‘˜ä½¿ç”¨çš„å‡½æ•°ï¼Œä¸æ˜¯æ¯ä¸ªAPIéƒ½å¯¹åº”ä¸€ä¸ªç‰¹å®šçš„ç³»ç»Ÿè°ƒç”¨ï¼‰
     APIå¯èƒ½ç›´æ¥æä¾›ç”¨æˆ·æ€çš„æœåŠ¡ å¦‚ï¼šä¸€äº›æ•°å­¦å‡½æ•° 1.ä¸€ä¸ªå•ç‹¬çš„APIå¯èƒ½è°ƒç”¨å‡ ä¸ªç³»ç»Ÿè°ƒç”¨2.ä¸åŒçš„APIå¯èƒ½è°ƒç”¨äº†åŒä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿”å›ï¼šå¤§éƒ¨åˆ†å°è£…ä¾‹ç¨‹è¿”å›ä¸€ä¸ªæ•´æ•°ï¼Œå…¶å€¼çš„å«ä¹‰ä¾èµ–äºç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨-1åœ¨å¤šæ•°æƒ…å†µä¸‹è¡¨ç¤ºå†…æ ¸ä¸èƒ½æ»¡è¶³è¿›ç¨‹çš„è¯·æ±‚ï¼ŒLibcä¸­å®šä¹‰çš„errnoå˜é‡åŒ…å«ç‰¹å®šçš„å‡ºé”™ç ï¼›ä¸‹é¢ä¸€å¼ å›¾å¯ä»¥è¡¨ç¤ºå®ƒä»¬çš„å·¥ä½œè¿‡ç¨‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  x,y,zå°±æ˜¯å‡½æ•°ï¼Œç³»ç»Ÿè°ƒç”¨åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œè¿™ä¸ªåº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£é‡Œé¢å°è£…äº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè¿™ä¼šè§¦å‘ä¸€ä¸ª0x80çš„ä¸€ä¸ªä¸­æ–­ï¼Œè¿™ä¸ªä¸­æ–­å‘é‡å°±å¯¹åº”ç€SYSTEM_CALLè¿™ä¸ªå†…æ ¸ä»£ç çš„å…¥å£çš„èµ·ç‚¹ï¼Œsys_xyzæ˜¯å¯¹åº”çš„ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œåœ¨ä¸­æ–­æœåŠ¡ç¨‹åºæ‰§è¡Œå®Œä¹‹åï¼Œå®ƒå¯èƒ½ä¼šret_from_sys_callï¼Œ ä¹‹åå°±ç»è¿‡è¿™ä¸ªå‡½æ•°è¿›è¡Œå¤„ç†ï¼Œ è¿™æ˜¯ä¸€ä¸ªè¿›ç¨‹è°ƒåº¦çš„æ—¶æœºï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿç³»ç»Ÿè°ƒç”¨çš„æ—¶æœºï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒå°±ä¼šireturnå¯èƒ½å°±ä¼šè¿”å›åˆ°ç”¨æˆ·æ€æ¥ç€æ‰§è¡Œã€‚ æˆ‘ä»¬è¦æ‰’å¼€ç³»ç»Ÿè°ƒç”¨çš„ä¸‰å±‚çš®ï¼Œæˆ‘ä»¬è®²è¿™ä¸‰å±‚çš®åˆ†åˆ«æ˜¯ï¼šxyzã€system_callå’Œsys_xyz
 ç¬¬ä¸€ä¸ªå°±æ˜¯APIã€ç¬¬äºŒä¸ªå°±æ˜¯ä¸­æ–­å‘é‡å¯¹åº”çš„è¿™äº›ä¹Ÿå°±æ˜¯ä¸­æ–­æœåŠ¡ç¨‹åºï¼Œä¸­æ–­å‘é‡å¯¹ç”¨çš„ç³»ç»Ÿè°ƒç”¨å®ƒæœ‰å¾ˆå¤šç§ä¸åŒçš„æœåŠ¡ç¨‹åºï¼Œæ¯”å¦‚sys_xyz,è¿™å°±æ˜¯ä¸‰å±‚çš®ã€‚
  æˆ‘ä»¬ä»”ç»†çœ‹ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨çš„æœåŠ¡å†ç¨‹ï¼šä¸­æ–­å‘é‡0x80ä¸system_callç»‘å®šèµ·æ¥ï¼š
  å½“ç”¨æˆ·æ€è¿›ç¨‹è°ƒç”¨ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒCPUåˆ‡æ¢åˆ°å†…æ ¸æ€å¹¶å¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªå†…æ ¸å‡½æ•°
  1.åœ¨Linuxä¸­æ˜¯é€šè¿‡æ‰§è¡Œini $0x80æ¥æ‰§è¡Œç³»ç»Ÿè°ƒç”¨çš„ï¼Œè¿™æ¡æ±‡ç¼–æŒ‡ä»¤äº§ç”Ÿå‘é‡ä¸º128çš„ç¼–ç¨‹å¼‚å¸¸
  2. Intel Pentium llä¸­å¼•è¿›äº†sysenteræŒ‡ä»¤ï¼ˆå¿«é€Ÿç³»ç»Ÿè°ƒç”¨ï¼‰ ç³»ç»Ÿè°ƒç”¨å·å°†xyzå’Œsys_xyzå…³è”èµ·æ¥äº†ï¼š
 ä¼ å‚ï¼š
  1.å†…æ ¸å®ç°äº†å¾ˆå¤šä¸åŒçš„ç³»ç»Ÿè°ƒç”¨
  2.è¿›ç¨‹å¿…é¡»æŒ‡æ˜éœ€è¦å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™éœ€è¦ä¼ é€’ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å·çš„å‚æ•°ï¼Œä½¿ç”¨eaxå¯„å­˜å™¨
 ç³»ç»Ÿè°ƒç”¨ä¹Ÿéœ€è¦è¾“å…¥è¾“å‡ºå‚æ•°ï¼Œä¾‹å¦‚ï¼š 
 1.å®é™…çš„å€¼ 2.ç”¨æˆ·æ€è¿›ç¨‹åœ°å€ç©ºé—´çš„å˜é‡çš„åœ°å€ 3.ç”šè‡³æ˜¯åŒ…å«æŒ‡å‘ç”¨æˆ·æ€å‡½æ•°çš„æŒ‡é’ˆçš„æ•°æ®ç»“æ„çš„åœ°å€  system_callæ˜¯linuxä¸­æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ç‚¹ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨è‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå³ç”±eaxä¼ é€’çš„ç³»ç»Ÿè°ƒç”¨å·
 2.ä¸€ä¸ªåº”ç”¨ç¨‹åºè°ƒç”¨fork(0å°è£…ä¾‹ç¨‹ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œint $0x80ä¹‹å‰å°±æŠŠeaxå¯„å­˜å™¨çš„å€¼ç½®ä¸º2ï¼ˆå³_NR_fork)
 3.è¿™ä¸ªå¯„å­˜å™¨çš„è®¾ç½®æ˜¯libcåº“ä¸­å°è£…ä¾‹ç¨‹è¿›è¡Œçš„ï¼Œå› æ­¤ç”¨æˆ·ä¸€èˆ¬ä¸å…³å¿ƒç³»ç»Ÿè°ƒç”¨å·
 4.è¿›å…¥sys_callä¹‹åï¼Œç«‹å³å°†eaxçš„å€¼å‹å…¥å†…æ ¸å †æ ˆ å¯„å­˜å™¨ä¼ é€’å‚æ•°æœ‰å¦‚ä¸‹é™åˆ¶ï¼š
1.æ¯ä¸ªå‚æ•°çš„é•¿åº¦ä¸èƒ½è¶…è¿‡å¯„å­˜å™¨çš„é•¿åº¦ï¼Œå³32ä½
 2.åœ¨ç³»ç»Ÿè°ƒç”¨å·eaxä¹‹å¤–ï¼Œå‚æ•°çš„ä¸ªæ•°ä¸èƒ½è¶…è¿‡6ä¸ªï¼ˆebx,ecx,edx,esi,edi,ebp)
 è¶…è¿‡6ä¸ªæ€ä¹ˆåŠï¼Ÿåšä¸€ä¸ªæŠŠæŸä¸ªå¯„å­˜å™¨ä½œä¸ºæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€å—å†…å­˜ï¼Œè¿™æ ·è¿›å…¥å†…æ ¸æ€ä¹‹åå¯ä»¥è®¿é—®æ‰€æœ‰å†…å­˜ç©ºé—´ï¼Œè¿™å°±æ˜¯ç³»ç»Ÿè°ƒç”¨çš„å‚æ•°ä¼ é€’æ–¹å¼ã€‚  å››.åº“å‡½æ•°APIå’ŒCä»£ç ä¸­åµŒå…¥æ±‡ç¼–ä»£ç ä¸¤ç§æ–¹å¼ç³»ç»Ÿè°ƒç”¨  é¦–å…ˆé€‰æ‹©ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘é€‰çš„æ˜¯writeï¼Œç„¶åæ˜¯ç”¨cè¯­è¨€å†™ä¸€æ®µæ­£å¸¸ç†Ÿæ‚‰çš„ç³»ç»Ÿè°ƒç”¨ä»£ç ï¼Œå¦‚ä¸‹ï¼š å¤åˆ¶ä»£ç  #include&lt;stdio.h&gt; #include&lt;unistd.h&gt; int main(void) {
write(1,"hello world!5124\n",13);
return 0;  } å¤åˆ¶ä»£ç     ä¸‹é¢æ˜¯æˆ‘çš„å‘½ä»¤è¡Œå†…å®¹ï¼š



  å…¶ä¸­ï¼Œwriteæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¡¨ç¤ºå†™åˆ°ç»ˆç«¯å±å¹•ä¸Šï¼Œ1å¯ä»¥è®¤ä¸ºæ˜¯å±å¹•çš„ä»£å·ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å†™çš„å†…å®¹ï¼Œæˆ‘æ˜¯æŠŠhello world!å†™åˆ°å±å¹•ä¸Šï¼Œå¹¶æ¢è¡Œï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å†™å…¥çš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œé•¿åº¦è¦å¤§äºç­‰äºè¦è¾“å‡ºçš„å­—ç¬¦ä¸²é•¿åº¦ï¼Œå¦åˆ™åªèƒ½è¾“å‡ºå­—ç¬¦ä¸²çš„ä¸€éƒ¨åˆ†ã€‚ç¨‹åºæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š
</code></pre></div></div>

<p>ç„¶åæ˜¯æŠŠè¿™æ®µä»£ç è½¬å†™ä¸ºåµŒå…¥å¼æ±‡ç¼–ï¼ŒåµŒå…¥å¼æ±‡ç¼–çš„æ ¼å¼å¦‚ä¸‹ï¼š
å¤åˆ¶ä»£ç 
<em>asm</em>(
     æ±‡ç¼–è¯­å¥æ¨¡å—:
     è¾“å‡ºéƒ¨åˆ†:å‡½æ•°è°ƒç”¨æ—¶å€™çš„å‚æ•°
     è¾“å…¥éƒ¨åˆ†:å‡½æ•°è°ƒç”¨æ—¶å€™çš„å‚æ•°
     ç ´åæè¿°éƒ¨åˆ†):
     å³æ ¼å¼ä¸ºasm(â€œstatementsâ€:output_regs:input_regs:clobbered_regs);
å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæœ‰æ—¶å€™å¯ä»¥åŠ ä¸€ä¸ª_volatile_æ¥é€‰æ‹©è®©ç¼–è¯‘å™¨ä¼˜åŒ–æˆ–è€…ä¸è®©ç¼–è¯‘å™¨ä¼˜åŒ–ã€‚
å¤åˆ¶ä»£ç 
ä»£ç å¦‚ä¸‹ï¼š</p>

<p>å¤åˆ¶ä»£ç 
#include<stdio.h>
#include<unistd.h>
 int main()
{
   int a;
   char *ch="hello world!\n";</unistd.h></stdio.h></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asm volatile(
    "movl $0x4,%%eax\n\t"
    "movl $0x1,%%ebx\n\t"
    "movl $0x1,%%ecx\n\t"
    "movl $0xd,%%edx\n\t"
    "int $0x80\n\t"
    "movl %%eax,%0\n\t"
    :"=m"(a)
    :"s"(ch)
    );
  return 0;  } å¤åˆ¶ä»£ç   writeç³»ç»Ÿè°ƒç”¨æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šå†™å…¥çš„ä½ç½®ï¼Œå†…å®¹å’Œé•¿åº¦ï¼Œæ‰€ä»¥è½¬åŒ–ä¸ºæ±‡ç¼–å¯¹åº”çš„å¯„å­˜å™¨ä¸ºeaxï¼ˆç³»ç»Ÿè°ƒç”¨å·ä¸º4ï¼‰,ebx(å‚æ•°),ecx(è¾“å‡ºä½ç½®),edx(å‚æ•°é•¿åº¦)
</code></pre></div></div>

<p>æ‰§è¡Œä»£ç å¦‚ä¸‹ï¼š</p>

<p>äº”.å®éªŒæ„Ÿæƒ³
      è®¡ç®—æœºç§‘å­¦ä¸­æœ‰ä¸€å¥è¯ï¼Œä»»ä½•è®¡ç®—æœºç›¸å…³é—®é¢˜éƒ½å¯ä»¥é€šè¿‡åŠ ä¸€ä¸ªä¸­é—´å±‚æ¥è§£å†³ã€‚æ“ä½œç³»ç»Ÿçš„ç³»ç»Ÿè°ƒç”¨ä¹Ÿæ˜¯è¿™æ ·ï¼Œsystem_callå°†apiå’Œç³»ç»Ÿå‡½æ•°è¿æ¥èµ·æ¥ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œä¸ä¼šå› ä¸ºç”¨æˆ·çš„å¤±è¯¯æ“ä½œè€Œé€ æˆé—®é¢˜ã€‚æ“ä½œç³»ç»Ÿä¸ºäº†å®‰å…¨ï¼ŒæŠŠä¸€äº›é‡è¦çš„è°ƒç”¨æ”¾åœ¨å†…æ ¸éƒ¨åˆ†ï¼Œè¿™æ ·åªèƒ½é€šè¿‡è§¦å‘ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆç›¸åº”åŠŸèƒ½ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å†…æ ¸çš„å®‰å…¨ï¼Œä½†æ˜¯ä¸å¯é¿å…çš„ä¹Ÿé€ æˆäº†ç³»ç»Ÿè°ƒç”¨çš„æ¶ˆè€—æ¯”è¾ƒå¤§ã€‚</p>

<p>ç³»ç»Ÿè°ƒç”¨å¤§è‡´å¯åˆ†ä¸ºå…­å¤§ç±»ï¼šè¿›ç¨‹æ§åˆ¶ï¼ˆprocess controlï¼‰ã€æ–‡ä»¶ç®¡ç†ï¼ˆfile manipulationï¼‰ã€è®¾å¤‡ç®¡ç†ï¼ˆdevice manipulationï¼‰ã€ä¿¡æ¯ç»´æŠ¤ï¼ˆinformation maintenanceï¼‰ã€é€šä¿¡ï¼ˆcommunicationï¼‰ å’Œä¿æŠ¤ï¼ˆprotectionï¼‰ã€‚
è¿›ç¨‹æ§åˆ¶
æ‰§è¡Œç¨‹åºåº”èƒ½æ­£å¸¸ï¼ˆend()ï¼‰æˆ–å¼‚å¸¸ï¼ˆabort()ï¼‰åœæ­¢æ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å¼‚å¸¸åœæ­¢å½“å‰æ‰§è¡Œçš„ç¨‹åºï¼Œæˆ–è€…ç¨‹åºè¿è¡Œé‡åˆ°é—®é¢˜å¹¶å¼•èµ·é”™è¯¯é™·é˜±ï¼Œé‚£ä¹ˆæœ‰æ—¶è½¬å‚¨å†…å­˜åˆ°ç£ç›˜ï¼Œå¹¶ç”Ÿæˆé”™è¯¯ä¿¡æ¯ã€‚å†…å­˜ä¿¡æ¯è½¬å‚¨åˆ°ç£ç›˜åï¼Œå¯ç”¨è°ƒè¯•å™¨ï¼ˆdebuggerï¼‰æ¥ç¡®å®šé—®é¢˜åŸå› ï¼ˆè°ƒè¯•å™¨ä¸ºç³»ç»Ÿç¨‹åºï¼Œç”¨ä»¥å¸®åŠ©ç¨‹åºå‘˜å‘ç°å’Œçº æ­£é”™è¯¯ï¼ˆbugï¼‰ï¼‰ã€‚</p>

<p>æ— è®ºæ˜¯æ­£å¸¸æƒ…å†µè¿˜æ˜¯å¼‚å¸¸æƒ…å†µï¼Œæ“ä½œç³»ç»Ÿéƒ½åº”å°†æ§åˆ¶è½¬åˆ°è°ƒç”¨å‘½ä»¤è§£é‡Šç¨‹åºã€‚å‘½ä»¤è§£é‡Šç¨‹åºæ¥ç€è¯»å…¥ä¸‹ä¸ªå‘½ä»¤ã€‚å¯¹äºäº¤äº’ç³»ç»Ÿï¼Œå‘½ä»¤è§£é‡Šç¨‹åºåªæ˜¯ç®€å•è¯»å…¥ä¸‹ä¸ªå‘½ä»¤ï¼Œè€Œå‡å®šç”¨æˆ·ä¼šé‡‡å–åˆé€‚å‘½ä»¤ä»¥å¤„ç†é”™è¯¯ã€‚å¯¹äº GUI ç³»ç»Ÿï¼Œå¼¹å‡ºçª—å£å¯ç”¨äºæé†’ç”¨æˆ·å‡ºé”™ï¼Œå¹¶è¯·æ±‚æŒ‡å¼•ã€‚å¯¹äºæ‰¹å¤„ç†ç³»ç»Ÿï¼Œå‘½ä»¤è§£é‡Šç¨‹åºé€šå¸¸ç»ˆæ­¢æ•´ä¸ªä½œä¸šï¼Œå¹¶ç»§ç»­ä¸‹ä¸ªä½œä¸šã€‚å½“å‡ºç°é”™è¯¯æ—¶ï¼Œæœ‰çš„ç³»ç»Ÿå¯èƒ½å…è®¸ç‰¹æ®Šçš„æ¢å¤æ“ä½œã€‚</p>

<p>å¦‚æœç¨‹åºå‘ç°è¾“å…¥æœ‰é”™å¹¶ä¸”æƒ³è¦å¼‚å¸¸ç»ˆæ­¢ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå¯èƒ½éœ€è¦å®šä¹‰é”™è¯¯çº§åˆ«ã€‚é”™è¯¯è¶Šä¸¥é‡ï¼Œé”™è¯¯å‚æ•°çš„çº§åˆ«ä¹Ÿè¶Šé«˜ã€‚é€šè¿‡å°†æ­£å¸¸ç»ˆæ­¢çš„é”™è¯¯çº§åˆ«å®šä¹‰ä¸º 0ï¼Œå¯ä»¥æŠŠæ­£å¸¸å’Œå¼‚å¸¸ç»ˆæ­¢æ”¾åœ¨ä¸€èµ·å¤„ç†ã€‚å‘½ä»¤è§£é‡Šç¨‹åºæˆ–åé¢çš„ç¨‹åºå¯ä»¥åˆ©ç”¨è¿™ç§é”™è¯¯çº§åˆ«æ¥è‡ªåŠ¨ç¡®å®šä¸‹ä¸ªåŠ¨ä½œã€‚</p>

<p>æ‰§è¡Œä¸€ä¸ªç¨‹åºçš„è¿›ç¨‹æˆ–ä½œä¸šå¯èƒ½éœ€è¦åŠ è½½ï¼ˆload()ï¼‰å’Œæ‰§è¡Œï¼ˆexecute()ï¼‰å¦ä¸€ä¸ªç¨‹åºã€‚è¿™ç§åŠŸèƒ½å…è®¸å‘½ä»¤è§£é‡Šç¨‹åºæ¥æ‰§è¡Œä¸€ä¸ªç¨‹åºï¼Œè¯¥å‘½ä»¤å¯ä»¥é€šè¿‡ç”¨æˆ·å‘½ä»¤ã€é¼ æ ‡ç‚¹å‡»æˆ–æ‰¹å¤„ç†å‘½ä»¤æ¥ç»™å®šã€‚ä¸€ä¸ªæœ‰è¶£çš„é—®é¢˜æ˜¯ï¼šåŠ è½½ç¨‹åºç»ˆæ­¢æ—¶ä¼šå°†æ§åˆ¶è¿”å›åˆ°å“ªé‡Œï¼Ÿä¸ä¹‹ç›¸å…³çš„é—®é¢˜æ˜¯ï¼šåŸæœ‰ç¨‹åºæ˜¯å¦å¤±å»æˆ–ä¿å­˜äº†ï¼Œæˆ–è€…å¯ä¸æ–°çš„ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Ÿ</p>

<p>å¦‚æœæ–°ç¨‹åºç»ˆæ­¢æ—¶æ§åˆ¶è¿”å›åˆ°ç°æœ‰ç¨‹åºï¼Œé‚£ä¹ˆå¿…é¡»ä¿å­˜ç°æœ‰ç¨‹åºçš„å†…å­˜æ˜ åƒã€‚å› æ­¤ï¼Œäº‹å®ä¸Šåˆ›å»ºäº†ä¸€ä¸ªæœºåˆ¶ï¼Œä»¥ä¾¿ä¸€ä¸ªç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªç¨‹åºã€‚å¦‚æœä¸¤ä¸ªç¨‹åºå¹¶å‘ç»§ç»­ï¼Œé‚£ä¹ˆä¹Ÿå°±åˆ›å»ºäº†ä¸€ä¸ªæ–°ä½œä¸šæˆ–è¿›ç¨‹ï¼Œä»¥ä¾¿å¤šé“æ‰§è¡Œã€‚é€šå¸¸ï¼Œæœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ä¸“é—¨ç”¨äºè¿™ä¸€ç›®çš„ï¼ˆcreate_process() æˆ– submit_job()ï¼‰ã€‚</p>

<p>å¦‚æœåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ä½œä¸šæˆ–è¿›ç¨‹æˆ–è€…ä¸€ç»„ä½œä¸šæˆ–è¿›ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”èƒ½æ§åˆ¶æ‰§è¡Œã€‚è¿™ç§æ§åˆ¶è¦èƒ½åˆ¤å®šå’Œé‡ç½®è¿›ç¨‹æˆ–ä½œä¸šçš„å±æ€§ï¼ŒåŒ…æ‹¬ä½œä¸šçš„ä¼˜å…ˆçº§ã€æœ€å¤§å…è®¸æ‰§è¡Œæ—¶é—´ç­‰ï¼ˆget_ process_attributes() å’Œ set_process_attributes()ï¼‰ã€‚å¦‚æœå‘ç°åˆ›å»ºçš„è¿›ç¨‹æˆ–ä½œä¸šä¸æ­£ç¡®æˆ–è€…ä¸å†éœ€è¦ï¼Œé‚£ä¹ˆä¹Ÿè¦èƒ½ç»ˆæ­¢å®ƒï¼ˆterminate_process()ï¼‰ã€‚</p>

<p>åˆ›å»ºäº†æ–°çš„ä½œä¸šæˆ–è¿›ç¨‹åï¼Œå¯èƒ½è¦ç­‰å¾…å…¶æ‰§è¡Œå®Œæˆï¼Œä¹Ÿå¯èƒ½è¦ç­‰å¾…ä¸€å®šæ—¶é—´ï¼ˆwait_time()ï¼‰ã€‚æ›´æœ‰å¯èƒ½è¦ç­‰å¾…æŸä¸ªäº‹ä»¶çš„å‡ºç°ï¼ˆwait_event()ï¼‰ã€‚å½“äº‹ä»¶å‡ºç°æ—¶ï¼Œä½œä¸šæˆ–è¿›ç¨‹å°±ä¼šå“åº”ï¼ˆsignal_event()ï¼‰ã€‚</p>

<p>é€šå¸¸ï¼Œä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹ä¼šå…±äº«æ•°æ®ã€‚ä¸ºäº†ç¡®ä¿å…±äº«æ•°æ®çš„å®Œæ•´æ€§ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸æä¾›ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥å…è®¸ä¸€ä¸ªè¿›ç¨‹é”å®šï¼ˆlockï¼‰å…±äº«æ•°æ®ã€‚è¿™æ ·ï¼Œåœ¨è§£é”ä¹‹å‰ï¼Œå…¶ä»–è¿›ç¨‹ä¸èƒ½è®¿é—®è¯¥æ•°æ®ã€‚é€šå¸¸ï¼Œè¿™æ ·çš„ç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬ acquire_lock() å’Œ release_lock()ã€‚è¿™ç±»ç³»ç»Ÿè°ƒç”¨ç”¨äºåè°ƒå¹¶å‘è¿›ç¨‹ï¼Œå°†åœ¨åç»­ç« èŠ‚è¯¦ç»†è®¨è®ºã€‚</p>

<p>è¿›ç¨‹å’Œä½œä¸šæ§åˆ¶å·®å¼‚å¾ˆå¤§ï¼Œè¿™é‡Œé€šè¿‡ä¸¤ä¸ªä¾‹å­åŠ ä»¥è¯´æ˜ï¼šä¸€ä¸ªæ¶‰åŠå•ä»»åŠ¡ç³»ç»Ÿï¼Œå¦ä¸€ä¸ªæ¶‰åŠå¤šä»»åŠ¡ç³»ç»Ÿã€‚</p>

<p>MS-DOS æ“ä½œç³»ç»Ÿæ˜¯ä¸ªå•ä»»åŠ¡çš„ç³»ç»Ÿï¼Œåœ¨è®¡ç®—æœºå¯åŠ¨æ—¶å®ƒå°±è¿è¡Œä¸€ä¸ªå‘½ä»¤è§£é‡Šç¨‹åºï¼ˆå›¾ 1aï¼‰ã€‚ç”±äº MS-DOS æ˜¯å•ä»»åŠ¡çš„ï¼Œå®ƒé‡‡ç”¨äº†ä¸€ç§ç®€å•æ–¹æ³•æ¥æ‰§è¡Œç¨‹åºè€Œä¸”ä¸åˆ›å»ºæ–°è¿›ç¨‹ã€‚å®ƒåŠ è½½ç¨‹åºåˆ°å†…å­˜ï¼Œå¹¶å¯¹è‡ªèº«è¿›è¡Œæ”¹å†™ï¼Œä»¥ä¾¿ä¸ºæ–°ç¨‹åºæä¾›å°½å¯èƒ½å¤šçš„ç©ºé—´ï¼ˆå›¾ 1bï¼‰ã€‚</p>

<p>MS-DOS æ‰§è¡ŒçŠ¶æ€
å›¾ 1 MS-DOS æ‰§è¡ŒçŠ¶æ€</p>

<p>æ¥ç€ï¼Œå®ƒå°†æŒ‡ä»¤æŒ‡é’ˆè®¾ä¸ºç¨‹åºçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚ç„¶åï¼Œè¿è¡Œç¨‹åºï¼Œæˆ–è€…é”™è¯¯å¼•èµ·ä¸­æ–­ï¼Œæˆ–è€…ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ¥ç»ˆæ­¢ã€‚æ— è®ºå¦‚ä½•ï¼Œé”™è¯¯ä»£ç ä¼šä¿å­˜åœ¨ç³»ç»Ÿå†…å­˜ä¸­ä»¥ä¾¿ä»¥åä½¿ç”¨ã€‚ä¹‹åï¼Œå‘½ä»¤è§£é‡Šç¨‹åºä¸­çš„å°šæœªæ”¹å†™éƒ¨åˆ†é‡æ–°å¼€å§‹æ‰§è¡Œã€‚å®ƒé¦–å…ˆä»ç£ç›˜ä¸­é‡æ–°åŠ è½½å‘½ä»¤è§£é‡Šç¨‹åºçš„å…¶ä»–éƒ¨åˆ†ã€‚ç„¶åï¼Œå‘½ä»¤è§£é‡Šç¨‹åºä¼šå‘ç”¨æˆ·æˆ–ä¸‹ä¸ªç¨‹åºæä¾›å…ˆå‰çš„é”™è¯¯ä»£ç ã€‚</p>

<p>FreeBSDï¼ˆæºäº Berkeley UNIXï¼‰æ˜¯ä¸ªå¤šä»»åŠ¡ç³»ç»Ÿã€‚åœ¨ç”¨æˆ·ç™»å½•åˆ°ç³»ç»Ÿåï¼Œç”¨æˆ·æ‰€é€‰çš„å¤–å£³å°±å¼€å§‹è¿è¡Œã€‚è¿™ç§å¤–å£³ç±»ä¼¼äº MS-DOS å¤–å£³ï¼šæŒ‰ç”¨æˆ·è¦æ±‚ï¼Œæ¥å—å‘½ä»¤å¹¶æ‰§è¡Œç¨‹åºã€‚ä¸è¿‡ï¼Œç”±äº FreeBSD æ˜¯å¤šä»»åŠ¡ç³»ç»Ÿï¼Œå‘½ä»¤è§£é‡Šç¨‹åºåœ¨å¦ä¸€ä¸ªç¨‹åºæ‰§è¡Œï¼Œä¹Ÿå¯ç»§ç»­æ‰§è¡Œï¼ˆå›¾ 2ï¼‰ã€‚</p>

<p>è¿è¡Œå¤šä¸ªç¨‹åºçš„FreeBSD
å›¾ 2 è¿è¡Œå¤šä¸ªç¨‹åºçš„ FreeBSD</p>

<p>ä¸ºäº†å¯åŠ¨æ–°è¿›ç¨‹ï¼Œå¤–å£³æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ fork()ã€‚æ¥ç€ï¼Œæ‰€é€‰ç¨‹åºé€šè¿‡ç³»ç»Ÿè°ƒç”¨ exec() åŠ è½½åˆ°å†…å­˜ï¼Œç¨‹åºå¼€å§‹æ‰§è¡Œã€‚æ ¹æ®å‘½ä»¤æ‰§è¡Œæ–¹å¼ï¼Œå¤–å£³è¦ä¹ˆç­‰å¾…è¿›ç¨‹å®Œæˆï¼Œè¦ä¹ˆåå°æ‰§è¡Œè¿›ç¨‹ã€‚å¯¹äºåä¸€ç§æƒ…å†µï¼Œå¤–å£³å¯ä»¥é©¬ä¸Šæ¥å—ä¸‹ä¸ªå‘½ä»¤ã€‚å½“è¿›ç¨‹åœ¨åå°è¿è¡Œæ—¶ï¼Œå®ƒä¸èƒ½ç›´æ¥æ¥å—é”®ç›˜è¾“å…¥ï¼Œè¿™æ˜¯å› ä¸ºå¤–å£³å·²åœ¨ä½¿ç”¨é”®ç›˜ã€‚å› æ­¤ I/O å¯é€šè¿‡æ–‡ä»¶æˆ– GUI æ¥å®Œæˆã€‚</p>

<p>åŒæ—¶ï¼Œç”¨æˆ·å¯ä»¥è®©å¤–å£³æ‰§è¡Œå…¶ä»–ç¨‹åºï¼Œç›‘è§†è¿è¡Œè¿›ç¨‹çŠ¶æ€ï¼Œæ”¹å˜ç¨‹åºä¼˜å…ˆçº§ç­‰ã€‚å½“è¿›ç¨‹å®Œæˆæ—¶ï¼Œå®ƒæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ exit() ä»¥ç»ˆæ­¢ï¼Œå¹¶å°† 0 æˆ–é 0 çš„é”™è¯¯ä»£ç è¿”å›åˆ°è°ƒç”¨è¿›ç¨‹ã€‚è¿™ä¸€çŠ¶æ€ï¼ˆæˆ–é”™è¯¯ï¼‰ä»£ç å¯ç”¨äºå¤–å£³æˆ–å…¶ä»–ç¨‹åºã€‚åç»­ç« èŠ‚å°†é€šè¿‡ä¸€ä¸ªä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ fork() å’Œ exec() çš„ç¨‹åºä¾‹å­æ¥è®¨è®ºè¿›ç¨‹ã€‚
æ–‡ä»¶ç®¡ç†
ä¸‹é¢ï¼Œæˆ‘ä»¬è®¨è®ºä¸€äº›æœ‰å…³æ–‡ä»¶çš„å¸¸ç”¨ç³»ç»Ÿè°ƒç”¨ã€‚</p>

<p>é¦–å…ˆè¦èƒ½åˆ›å»ºï¼ˆcreate()ï¼‰å’Œåˆ é™¤ï¼ˆdelete()ï¼‰æ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨éœ€è¦æ–‡ä»¶åç§°ï¼Œè¿˜å¯èƒ½éœ€è¦æ–‡ä»¶çš„ä¸€äº›å±æ€§ã€‚ä¸€æ—¦æ–‡ä»¶åˆ›å»ºåï¼Œå°±ä¼šæ‰“å¼€ï¼ˆopen()ï¼‰å¹¶ä½¿ç”¨å®ƒï¼Œä¹Ÿä¼šè¯»(read()ï¼‰ã€å†™ï¼ˆwrite()ï¼‰æˆ–é‡å®šä½ï¼ˆreposition()ï¼‰ï¼ˆä¾‹å¦‚ï¼Œé‡æ–°å›åˆ°æ–‡ä»¶å¼€å¤´ï¼Œæˆ–ç›´æ¥è·³åˆ°æ–‡ä»¶æœ«å°¾ï¼‰ã€‚æœ€åï¼Œéœ€è¦å…³é—­ï¼ˆclose()ï¼‰æ–‡ä»¶ï¼Œè¡¨ç¤ºä¸å†ä½¿ç”¨å®ƒäº†ã€‚</p>

<p>å¦‚æœé‡‡ç”¨ç›®å½•ç»“æ„æ¥ç»„ç»‡æ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ï¼Œé‚£ä¹ˆä¹Ÿä¼šéœ€è¦åŒæ ·çš„ç›®å½•æ“ä½œã€‚å¦å¤–ï¼Œä¸ç®¡æ˜¯æ–‡ä»¶è¿˜æ˜¯ç›®å½•ï¼Œéƒ½è¦èƒ½å¯¹å„ç§å±æ€§çš„å€¼åŠ ä»¥è¯»å–æˆ–è®¾ç½®ã€‚æ–‡ä»¶å±æ€§åŒ…æ‹¬ï¼šæ–‡ä»¶åã€æ–‡ä»¶ç±»å‹ã€ä¿æŠ¤ç ã€è®°è´¦ä¿¡æ¯ç­‰ã€‚</p>

<p>é’ˆå¯¹è¿™ä¸€åŠŸèƒ½ï¼Œè‡³å°‘éœ€è¦ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼šè·å–æ–‡ä»¶å±æ€§ï¼ˆget_file_attributes()ï¼‰å’Œè®¾ç½®æ–‡ä»¶å±æ€§ï¼ˆset_file_attributes()ï¼‰ã€‚æœ‰çš„æ“ä½œç³»ç»Ÿè¿˜æä¾›å…¶ä»–ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚æ–‡ä»¶çš„ç§»åŠ¨ï¼ˆmove()ï¼‰å’Œå¤åˆ¶ï¼ˆcopy()ï¼‰ã€‚è¿˜æœ‰çš„æ“ä½œç³»ç»Ÿé€šè¿‡ä»£ç æˆ–ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆè¿™äº› API çš„åŠŸèƒ½ã€‚å…¶ä»–çš„æ“ä½œç³»ç»Ÿå¯èƒ½é€šè¿‡ç³»ç»Ÿç¨‹åºæ¥å®ç°è¿™äº›åŠŸèƒ½ã€‚å¦‚æœç³»ç»Ÿç¨‹åºå¯è¢«å…¶ä»–ç¨‹åºè°ƒç”¨ï¼Œé‚£ä¹ˆè¿™äº›ç³»ç»Ÿç¨‹åºä¹Ÿå°±ç›¸å½“äº APIã€‚
è®¾å¤‡ç®¡ç†
è¿›ç¨‹æ‰§è¡Œéœ€è¦ä¸€äº›èµ„æºï¼Œå¦‚å†…å­˜ã€ç£ç›˜é©±åŠ¨ã€æ‰€éœ€æ–‡ä»¶ç­‰ã€‚å¦‚æœæœ‰å¯ç”¨èµ„æºï¼Œé‚£ä¹ˆç³»ç»Ÿå¯ä»¥å…è®¸è¯·æ±‚ï¼Œå¹¶å°†æ§åˆ¶äº¤ç»™ç”¨æˆ·ç¨‹åºï¼›å¦åˆ™ï¼Œç¨‹åºåº”ç­‰å¾…ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿå¯ç”¨çš„èµ„æºä¸ºæ­¢ã€‚</p>

<p>æ“ä½œç³»ç»Ÿæ§åˆ¶çš„å„ç§èµ„æºå¯çœ‹ä½œè®¾å¤‡ã€‚æœ‰çš„è®¾å¤‡æ˜¯ç‰©ç†è®¾å¤‡ï¼ˆå¦‚ç£ç›˜é©±åŠ¨ï¼‰ï¼Œè€Œå…¶ä»–çš„å¯å½“ä½œæŠ½è±¡æˆ–è™šæ‹Ÿçš„è®¾å¤‡ï¼ˆå¦‚æ–‡ä»¶ï¼‰ã€‚å¤šç”¨æˆ·ç³»ç»Ÿè¦æ±‚å…ˆè¯·æ±‚ï¼ˆrequest()ï¼‰è®¾å¤‡ï¼Œä»¥ç¡®ä¿è®¾å¤‡çš„ä¸“é—¨ä½¿ç”¨ã€‚åœ¨è®¾å¤‡ç”¨å®Œåï¼Œè¦é‡Šæ”¾ï¼ˆrelease()ï¼‰å®ƒã€‚è¿™äº›å‡½æ•°ç±»ä¼¼äºæ–‡ä»¶çš„ç³»ç»Ÿè°ƒç”¨ open() å’Œ close()ã€‚å…¶ä»–æ“ä½œç³»ç»Ÿå¯¹è®¾å¤‡è®¿é—®ä¸åŠ ç®¡ç†ã€‚è¿™æ ·å¸¦æ¥çš„å±å®³æ˜¯æ½œåœ¨çš„è®¾å¤‡äº‰ç”¨ä»¥åŠå¯èƒ½å‘ç”Ÿçš„æ­»é”ï¼Œè¿™å°†åœ¨åç»­ç« èŠ‚ä¸­è®¨è®ºã€‚</p>

<p>åœ¨è¯·æ±‚äº†è®¾å¤‡ï¼ˆå¹¶å¾—åˆ°ï¼‰åï¼Œå°±èƒ½å¦‚åŒå¯¹æ–‡ä»¶ä¸€æ ·ï¼Œå¯¹è®¾å¤‡è¿›è¡Œè¯»ï¼ˆread())ã€å†™ï¼ˆwrite())ã€é‡å®šä½ï¼ˆreposition()ï¼‰ã€‚äº‹å®ä¸Šï¼ŒI/O è®¾å¤‡å’Œæ–‡ä»¶æä¸ºç›¸ä¼¼ï¼Œä»¥è‡³äºè®¸å¤šæ“ä½œç³»ç»Ÿå¦‚ UNIX éƒ½å°†è¿™ä¸¤è€…ç»„åˆæˆæ–‡ä»¶-è®¾å¤‡ç»“æ„ã€‚è¿™æ ·ï¼Œä¸€ç»„ç³»ç»Ÿè°ƒç”¨ä¸ä½†ç”¨äºæ–‡ä»¶è€Œä¸”ç”¨äºè®¾å¤‡ã€‚æœ‰æ—¶ï¼ŒI/O è®¾å¤‡å¯é€šè¿‡ç‰¹æ®Šæ–‡ä»¶åã€ç›®å½•ä½ç½®æˆ–æ–‡ä»¶å±æ€§æ¥è¾¨è®¤ã€‚</p>

<p>ç”¨æˆ·ç•Œé¢å¯ä»¥è®©æ–‡ä»¶å’Œè®¾å¤‡çœ‹èµ·æ¥ç›¸ä¼¼ï¼Œå³ä¾¿å†…åœ¨ç³»ç»Ÿè°ƒç”¨ä¸åŒã€‚åœ¨è®¾è®¡ã€æ„å»ºæ“ä½œç³»ç»Ÿå’Œç”¨æˆ·ç•Œé¢æ—¶ï¼Œè¿™ä¹Ÿæ˜¯è¦åŠ ä»¥è€ƒè™‘çš„ã€‚
ä¿¡æ¯ç»´æŠ¤
è®¸å¤šç³»ç»Ÿè°ƒç”¨åªä¸è¿‡ç”¨äºåœ¨ç”¨æˆ·ç¨‹åºä¸æ“ä½œç³»ç»Ÿä¹‹é—´ä¼ é€’ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½æœ‰ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œä»¥ä¾¿è¿”å›å½“å‰çš„æ—¶é—´ï¼ˆtime()ï¼‰å’Œæ—¥æœŸï¼ˆdate()ï¼‰ã€‚è¿˜æœ‰çš„ç³»ç»Ÿè°ƒç”¨å¯ä»¥è¿”å›ç³»ç»Ÿçš„å…¶ä»–ä¿¡æ¯ï¼Œå¦‚å½“å‰ç”¨æˆ·æ•°ã€æ“ä½œç³»ç»Ÿç‰ˆæœ¬ã€å†…å­˜æˆ–ç£ç›˜çš„å¯ç”¨é‡ç­‰ã€‚</p>

<p>è¿˜æœ‰ä¸€ç»„ç³»ç»Ÿè°ƒç”¨å¸®åŠ©è°ƒè¯•ç¨‹åºã€‚è®¸å¤šç³»ç»Ÿéƒ½æä¾›ç”¨äºè½¬å‚¨å†…å­˜ï¼ˆdump()ï¼‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚å¯¹äºè°ƒè¯•ï¼Œè¿™å¾ˆæœ‰ç”¨ã€‚ç¨‹åº trace å¯ä»¥åˆ—å‡ºç¨‹åºæ‰§è¡Œæ—¶çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ã€‚ç”šè‡³å¾®å¤„ç†å™¨éƒ½æœ‰ä¸€ä¸ª CPU æ¨¡å¼ï¼Œç§°ä¸ºå•æ­¥ï¼ˆsingle stepï¼‰ï¼Œå³ CPU æ¯æ‰§è¡Œä¸€æ¡æŒ‡ä»¤éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé™·é˜±ã€‚è°ƒè¯•å™¨é€šå¸¸å¯ä»¥æ•è·åˆ°è¿™äº›é™·é˜±ã€‚</p>

<p>è®¸å¤šæ“ä½œç³»ç»Ÿéƒ½æä¾›ç¨‹åºçš„æ—¶é—´æ›²çº¿ï¼ˆtime profileï¼‰ï¼Œç”¨äºè¡¨ç¤ºåœ¨ç‰¹å®šä½ç½®æˆ–ä½ç½®ç»„åˆä¸Šçš„æ‰§è¡Œæ—¶é—´ã€‚æ—¶é—´æ›²çº¿éœ€è¦è·Ÿè¸ªåŠŸèƒ½æˆ–å›ºå®šå®šæ—¶ä¸­æ–­ã€‚å½“å®šæ—¶ä¸­æ–­å‡ºç°æ—¶ï¼Œå°±ä¼šè®°å½•ç¨‹åºè®¡æ•°å™¨çš„å€¼ã€‚å¦‚æœ‰è¶³å¤Ÿé¢‘ç¹çš„å®šæ—¶ä¸­æ–­ï¼Œé‚£ä¹ˆå°±å¯å¾—åˆ°èŠ±åœ¨ç¨‹åºå„ä¸ªéƒ¨åˆ†çš„æ—¶é—´ç»Ÿè®¡ä¿¡æ¯ã€‚</p>

<p>å†è€…ï¼Œæ“ä½œç³»ç»Ÿç»´æŠ¤æ‰€æœ‰è¿›ç¨‹çš„ä¿¡æ¯ï¼Œè¿™äº›å¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥è®¿é—®ã€‚é€šå¸¸ï¼Œä¹Ÿå¯ç”¨ç³»ç»Ÿè°ƒç”¨é‡ç½®è¿›ç¨‹ä¿¡æ¯ï¼ˆget_process_attributes() å’Œ set_process_attributes ()ï¼‰ã€‚
é€šä¿¡
è¿›ç¨‹é—´é€šä¿¡çš„å¸¸ç”¨æ¨¡å‹æœ‰ä¸¤ä¸ªï¼šæ¶ˆæ¯ä¼ é€’æ¨¡å‹å’Œå…±äº«å†…å­˜æ¨¡å‹ã€‚</p>

<p>å¯¹äºæ¶ˆæ¯ä¼ é€’æ¨¡å‹ï¼ˆmessage-passing modelï¼‰ï¼Œé€šä¿¡è¿›ç¨‹é€šè¿‡ç›¸äº’äº¤æ¢æ¶ˆæ¯æ¥ä¼ é€’ä¿¡æ¯ã€‚è¿›ç¨‹é—´çš„æ¶ˆæ¯äº¤æ¢å¯ä»¥ç›´æ¥è¿›è¡Œï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªå…±åŒé‚®ç®±æ¥é—´æ¥è¿›è¡Œã€‚åœ¨å¼€å§‹é€šä¿¡å‰ï¼Œåº”å…ˆå»ºç«‹è¿æ¥ã€‚åº”çŸ¥é“å¦ä¸€ä¸ªé€šä¿¡å®ä½“åç§°ï¼Œå®ƒå¯èƒ½æ˜¯åŒä¸€ç³»ç»Ÿçš„å¦ä¸€ä¸ªè¿›ç¨‹ï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡ç½‘ç»œç›¸è¿çš„å¦ä¸€è®¡ç®—æœºçš„è¿›ç¨‹ã€‚</p>

<p>æ¯å°ç½‘ç»œè®¡ç®—æœºéƒ½æœ‰ä¸€ä¸ªä¸»æœºåï¼ˆhostnameï¼‰ï¼Œè¿™æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ã€‚å¦å¤–ï¼Œæ¯å°ä¸»æœºä¹Ÿéƒ½æœ‰ä¸€ä¸ªç½‘ç»œæ ‡è¯†ç¬¦ï¼Œå¦‚IPåœ°å€ã€‚ç±»ä¼¼åœ°ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰è¿›ç¨‹åï¼ˆprocess nameï¼‰ï¼Œå®ƒé€šå¸¸å¯è½¬æ¢æˆæ ‡è¯†ç¬¦ï¼Œä»¥ä¾¿æ“ä½œç³»ç»Ÿå¼•ç”¨ã€‚ç³»ç»Ÿè°ƒç”¨ get_hostid() å’Œ get_processid() å¯ä»¥æ‰§è¡Œè¿™ç±»è½¬æ¢ã€‚è¿™äº›æ ‡è¯†ç¬¦å†ä¼ ç»™é€šç”¨ç³»ç»Ÿè°ƒç”¨ open() å’Œ close()ï¼ˆç”±æ–‡ä»¶ç³»ç»Ÿæä¾›ï¼‰ï¼Œæˆ–ä¸“ç”¨ç³»ç»Ÿè°ƒç”¨ open_connection() å’Œ close_connection()ï¼Œè¿™å–å†³äºç³»ç»Ÿé€šä¿¡æ¨¡å‹ã€‚</p>

<p>æ¥å—è¿›ç¨‹åº”é€šè¿‡ç³»ç»Ÿè°ƒç”¨ accept_connection() æ¥è®¸å¯é€šä¿¡ã€‚å¤§å¤šæ•°å¯æ¥å—è¿æ¥çš„è¿›ç¨‹ä¸ºä¸“ç”¨çš„å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰ï¼Œå³ä¸“ç”¨ç³»ç»Ÿç¨‹åºã€‚å®ƒä»¬æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ wait_for_connection()ï¼Œåœ¨æœ‰è¿æ¥æ—¶ä¼šè¢«å”¤é†’ã€‚é€šä¿¡æºç§°ä¸ºå®¢æˆ·æœºï¼ˆclientï¼‰ï¼Œè€Œæ¥å—åå°ç¨‹åºç§°ä¸ºæœåŠ¡å™¨ï¼ˆserverï¼‰ï¼Œå®ƒä»¬é€šè¿‡ç³»ç»Ÿè°ƒç”¨ read_message() å’Œ write_message() æ¥äº¤æ¢æ¶ˆæ¯ã€‚ç³»ç»Ÿè°ƒç”¨ close_connection() ç»ˆæ­¢é€šä¿¡ã€‚</p>

<p>å¯¹äºå…±äº«å†…å­˜æ¨¡å‹ï¼ˆshared-memory modelï¼‰ï¼Œè¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ shared_memory_create() å’Œ shared_memory_attach() åˆ›å»ºå…±äº«å†…å­˜ï¼Œå¹¶è®¿é—®å…¶ä»–è¿›ç¨‹æ‹¥æœ‰çš„å†…å­˜åŒºåŸŸã€‚</p>

<p>æ³¨æ„ï¼Œæ“ä½œç³»ç»Ÿé€šå¸¸éœ€è¦é˜»æ­¢ä¸€ä¸ªè¿›ç¨‹è®¿é—®å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜ã€‚å…±äº«å†…å­˜è¦æ±‚ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹éƒ½åŒæ„å–æ¶ˆè¿™ä¸€é™åˆ¶ï¼Œè¿™æ ·å®ƒä»¬å°±å¯é€šè¿‡è¯»å†™å…±äº«åŒºåŸŸçš„æ•°æ®æ¥äº¤æ¢ä¿¡æ¯ã€‚è¿™ç§æ•°æ®çš„ç±»å‹æ˜¯ç”±è¿™äº›è¿›ç¨‹æ¥å†³å®šçš„ï¼Œè€Œä¸å—æ“ä½œç³»ç»Ÿçš„æ§åˆ¶ã€‚è¿›ç¨‹ä¹Ÿè´Ÿè´£ç¡®ä¿ä¸ä¼šåŒæ—¶å‘åŒä¸€ä¸ªåœ°æ–¹è¿›è¡Œå†™æ“ä½œã€‚</p>

<p>ä¸Šé¢è®¨è®ºçš„ä¸¤ç§æ¨¡å‹å¸¸ç”¨äºæ“ä½œç³»ç»Ÿï¼Œè€Œä¸”å¤§å¤šæ•°ç³»ç»Ÿä¸¤ç§éƒ½å®ç°äº†ã€‚æ¶ˆæ¯ä¼ é€’å¯¹å°‘é‡æ•°æ®çš„äº¤æ¢å¾ˆæœ‰ç”¨ï¼Œå› ä¸ºæ²¡æœ‰å†²çªéœ€è¦é¿å…ã€‚ä¸ç”¨äºè®¡ç®—æœºé—´çš„å…±äº«å†…å­˜ç›¸æ¯”ï¼Œå®ƒä¹Ÿæ›´å®¹æ˜“å®ç°ã€‚å…±äº«å†…å­˜åœ¨é€šä¿¡æ–¹é¢å…·æœ‰é«˜é€Ÿå’Œä¾¿æ·çš„ç‰¹ç‚¹ï¼Œå› ä¸ºå½“é€šä¿¡å‘ç”Ÿåœ¨åŒä¸€è®¡ç®—æœºå†…æ—¶ï¼Œå®ƒå¯ä»¥æŒ‰å†…å­˜ä¼ è¾“é€Ÿåº¦æ¥è¿›è¡Œã€‚ä¸è¿‡ï¼Œå…±äº«å†…å­˜çš„è¿›ç¨‹åœ¨ä¿æŠ¤å’ŒåŒæ­¥æ–¹é¢æœ‰é—®é¢˜ã€‚
ä¿æŠ¤
ä¿æŠ¤æä¾›æ§åˆ¶è®¿é—®è®¡ç®—æœºçš„ç³»ç»Ÿèµ„æºçš„æœºåˆ¶ã€‚è¿‡å»ï¼Œåªæœ‰å¤šç”¨æˆ·çš„å¤šé“è®¡ç®—æœºç³»ç»Ÿæ‰è¦è€ƒè™‘ä¿æŠ¤ã€‚éšç€ç½‘ç»œå’Œå› ç‰¹ç½‘çš„å‡ºç°ï¼Œæ‰€æœ‰è®¡ç®—æœºï¼ˆä»æœåŠ¡å™¨åˆ°æ‰‹æŒç§»åŠ¨è®¾å¤‡ï¼‰éƒ½åº”è€ƒè™‘ä¿æŠ¤ã€‚</p>

<p>é€šå¸¸ï¼Œæä¾›ä¿æŠ¤çš„ç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬ set_permission() å’Œ get_permission()ï¼Œç”¨äºè®¾ç½®èµ„æºï¼ˆå¦‚æ–‡ä»¶å’Œç£ç›˜ï¼‰æƒé™ã€‚ç³»ç»Ÿè°ƒç”¨ allow_user() å’Œ deny_user() åˆ†åˆ«ç”¨äºå…è®¸å’Œæ‹’ç»ç‰¹å®šç”¨æˆ·è®¿é—®æŸäº›èµ„æºã€‚</p>

:ET