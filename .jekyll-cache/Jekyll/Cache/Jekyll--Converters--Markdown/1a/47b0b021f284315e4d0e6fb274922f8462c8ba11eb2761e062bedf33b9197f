I"íi<p>Squirrelï¼ˆæ¾é¼ ï¼‰æ˜¯ç¾å›¢æŠ€æœ¯å›¢é˜ŸåŸºäºRedis Clusteræ‰“é€ çš„ç¼“å­˜ç³»ç»Ÿã€‚
https://www.cnblogs.com/meituantech/p/9376472.html
https://tech.meituan.com/2018/03/16/redis-high-concurrency-optimization.html
Root Cause å®šä½</p>

<p>ç”±äºSlaveå†…å­˜åŒºåŸŸæ¯”Masterå°‘ä¸€ä¸ªrepl-backlog bufferï¼ˆçº¿ä¸Šä¸€èˆ¬é…ç½®ä¸º128Mï¼‰ï¼Œæ­£å¸¸æƒ…å†µä¸‹Masteråˆ°è¾¾æ»¡å®¹åæ ¹æ®é©±é€ç­–ç•¥æ·˜æ±°Keyå¹¶åŒæ­¥ç»™Slaveã€‚æ‰€ä»¥Slaveè¿™ç§æƒ…å†µä¸‹ä¸ä¼šå› æ»¡å®¹è§¦å‘é©±é€ã€‚</p>

<p>æŒ‰ç…§ä»¥å¾€ç»éªŒï¼Œæ’æŸ¥æ€è·¯ä¸»è¦èšç„¦åœ¨é€ æˆSlaveå†…å­˜é™¡å¢çš„é—®é¢˜ä¸Šï¼ŒåŒ…æ‹¬å®¢æˆ·ç«¯è¿æ¥ã€è¾“å…¥/è¾“å‡ºç¼“å†²åŒºã€ä¸šåŠ¡æ•°æ®å­˜å–è®¿é—®ã€ç½‘è·¯æŠ–åŠ¨ç­‰å¯¼è‡´Rediså†…å­˜é™¡å¢çš„æ‰€æœ‰å¤–éƒ¨å› ç´ ï¼Œé€šè¿‡Redisç›‘æ§å’Œä¸šåŠ¡é“¾è·¯ç›‘æ§å‡æ²¡æœ‰å®šä½æˆåŠŸã€‚</p>

<p>äºæ˜¯ï¼Œé€šè¿‡æ¢³ç†Redisæºç ï¼Œæˆ‘ä»¬å°è¯•å°†ç›®å…‰æŠ•å‘äº†Redisä¼šå ç”¨å†…å­˜å¼€é”€çš„ä¸€ä¸ªé‡è¦æœºåˆ¶â€”â€”Redis Rehashã€‚
<!-- more -->
Redis Rehash å†…éƒ¨å®ç°</p>

<p>åœ¨Redisä¸­ï¼Œé”®å€¼å¯¹ï¼ˆKey-Value Pairï¼‰å­˜å‚¨æ–¹å¼æ˜¯ç”±å­—å…¸ï¼ˆDictï¼‰ä¿å­˜çš„ï¼Œè€Œå­—å…¸åº•å±‚æ˜¯é€šè¿‡å“ˆå¸Œè¡¨æ¥å®ç°çš„ã€‚é€šè¿‡å“ˆå¸Œè¡¨ä¸­çš„èŠ‚ç‚¹ä¿å­˜å­—å…¸ä¸­çš„é”®å€¼å¯¹ã€‚ç±»ä¼¼Javaä¸­çš„HashMapï¼Œå°†Keyé€šè¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°å“ˆå¸Œè¡¨èŠ‚ç‚¹ä½ç½®ã€‚</p>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥åˆ†æRedis Dict Reashçš„æœºåˆ¶å’Œè¿‡ç¨‹ã€‚</p>

<p>(1) Redis å“ˆå¸Œè¡¨ç»“æ„ä½“ï¼š</p>

<p>/* hashè¡¨ç»“æ„å®šä¹‰ */
typedef struct dictht { 
    dictEntry **table;   // å“ˆå¸Œè¡¨æ•°ç»„
    unsigned long size;  // å“ˆå¸Œè¡¨çš„å¤§å°
    unsigned long sizemask; // å“ˆå¸Œè¡¨å¤§å°æ©ç 
    unsigned long used;  // å“ˆå¸Œè¡¨ç°æœ‰èŠ‚ç‚¹çš„æ•°é‡
} dictht; 
å®ä½“åŒ–ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€æŒ‡ä¸€ä¸ªå¤§å°ä¸º4çš„ç©ºå“ˆå¸Œè¡¨ï¼ˆRedisé»˜è®¤åˆå§‹åŒ–å€¼ä¸º4ï¼‰ï¼š</p>

<p>(2) Redis å“ˆå¸Œæ¡¶</p>

<p>Redis å“ˆå¸Œè¡¨ä¸­çš„tableæ•°ç»„å­˜æ”¾ç€å“ˆå¸Œæ¡¶ç»“æ„ï¼ˆdictEntryï¼‰ï¼Œé‡Œé¢å°±æ˜¯Redisçš„é”®å€¼å¯¹ï¼›ç±»ä¼¼Javaå®ç°çš„HashMapï¼ŒRedisçš„dictEntryä¹Ÿæ˜¯é€šè¿‡é“¾è¡¨ï¼ˆnextæŒ‡é’ˆï¼‰æ–¹å¼æ¥è§£å†³hashå†²çªï¼š</p>

<p>/* å“ˆå¸Œæ¡¶ */
typedef struct dictEntry { 
    void *key;     // é”®å®šä¹‰
    // å€¼å®šä¹‰
    union { 
        void *val;    // è‡ªå®šä¹‰ç±»å‹
        uint64_t u64; // æ— ç¬¦å·æ•´å½¢
        int64_t s64;  // æœ‰ç¬¦å·æ•´å½¢
        double d;     // æµ®ç‚¹å‹
    } v;   <br />
    struct dictEntry *next;  //æŒ‡å‘ä¸‹ä¸€ä¸ªå“ˆå¸Œè¡¨èŠ‚ç‚¹
} dictEntry;</p>

<p>(3) å­—å…¸</p>

<p>Redis Dict ä¸­å®šä¹‰äº†ä¸¤å¼ å“ˆå¸Œè¡¨ï¼Œæ˜¯ä¸ºäº†åç»­å­—å…¸çš„æ‰©å±•ä½œRehashä¹‹ç”¨ï¼š</p>

<p>/* å­—å…¸ç»“æ„å®šä¹‰ */
typedef struct dict { 
    dictType *type;  // å­—å…¸ç±»å‹
    void *privdata;  // ç§æœ‰æ•°æ®
    dictht ht[2];    // å“ˆå¸Œè¡¨[ä¸¤ä¸ª]
    long rehashidx;   // è®°å½•rehash è¿›åº¦çš„æ ‡å¿—ï¼Œå€¼ä¸º-1è¡¨ç¤ºrehashæœªè¿›è¡Œ
    int iterators;   //  å½“å‰æ­£åœ¨è¿­ä»£çš„è¿­ä»£å™¨æ•°
} dict;</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>

<p>åœ¨Clusteræ¨¡å¼ä¸‹ï¼Œä¸€ä¸ªRediså®ä¾‹å¯¹åº”ä¸€ä¸ªRedisDB(db0);</p>

<p>ä¸€ä¸ªRedisDBå¯¹åº”ä¸€ä¸ªDict;</p>

<p>ä¸€ä¸ªDictå¯¹åº”2ä¸ªDicthtï¼Œæ­£å¸¸æƒ…å†µåªç”¨åˆ°ht[0]ï¼›ht[1] åœ¨Rehashæ—¶ä½¿ç”¨ã€‚</p>

<p>å¦‚ä¸Šï¼Œæˆ‘ä»¬å›é¡¾äº†ä¸€ä¸‹Redis KVå­˜å‚¨çš„å®ç°ã€‚ï¼ˆRediså†…éƒ¨è¿˜æœ‰å…¶ä»–ç»“æ„ä½“ï¼Œç”±äºè·ŸRehashä¸æ¶‰åŠï¼Œä¸å†èµ˜è¿°ï¼‰</p>

<p>æˆ‘ä»¬çŸ¥é“å½“HashMapä¸­ç”±äºHashå†²çªï¼ˆè´Ÿè½½å› å­ï¼‰è¶…è¿‡æŸä¸ªé˜ˆå€¼æ—¶ï¼Œå‡ºäºé“¾è¡¨æ€§èƒ½çš„è€ƒè™‘ï¼Œä¼šè¿›è¡ŒResizeçš„æ“ä½œã€‚Redisä¹Ÿä¸€æ ·ã€Redisä¸­é€šè¿‡dictExpand()å®ç°ã€‘ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹Redisä¸­çš„å®ç°æ–¹å¼ï¼š</p>

<p>/* æ ¹æ®ç›¸å…³è§¦å‘æ¡ä»¶æ‰©å±•å­—å…¸ <em>/
static int _dictExpandIfNeeded(dict *d) 
{ 
    if (dictIsRehashing(d)) return DICT_OK;  // å¦‚æœæ­£åœ¨è¿›è¡ŒRehashï¼Œåˆ™ç›´æ¥è¿”å›
    if (d-&gt;ht[0].size == 0) return dictExpand(d, DICT_HT_INITIAL_SIZE);  // å¦‚æœht[0]å­—å…¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºå¹¶åˆå§‹åŒ–ht[0]<br />
    /</em> (ht[0].used/ht[0].size)&gt;=1å‰æä¸‹ï¼Œ
       å½“æ»¡è¶³dict_can_resize=1æˆ–ht[0].used/t[0].size&gt;5æ—¶ï¼Œä¾¿å¯¹å­—å…¸è¿›è¡Œæ‰©å±• <em>/
    if (d-&gt;ht[0].used &gt;= d-&gt;ht[0].size &amp;&amp; 
        (dict_can_resize || 
         d-&gt;ht[0].used/d-&gt;ht[0].size &gt; dict_force_resize_ratio)) 
    { 
        return dictExpand(d, d-&gt;ht[0].used</em>2);   // æ‰©å±•å­—å…¸ä¸ºåŸæ¥çš„2å€
    } 
    return DICT_OK; 
}</p>

<p>â€¦</p>

<p>/* è®¡ç®—å­˜å‚¨Keyçš„bucketçš„ä½ç½® */
static int _dictKeyIndex(dict *d, const void *key) 
{ 
    unsigned int h, idx, table; 
    dictEntry *he;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* æ£€æŸ¥æ˜¯å¦éœ€è¦æ‰©å±•å“ˆå¸Œè¡¨ï¼Œä¸è¶³åˆ™æ‰©å±• */ 
if (_dictExpandIfNeeded(d) == DICT_ERR)  
    return -1; 
/* è®¡ç®—Keyçš„å“ˆå¸Œå€¼ */ 
h = dictHashKey(d, key); 
for (table = 0; table &lt;= 1; table++) { 
    idx = h &amp; d-&gt;ht[table].sizemask;  //è®¡ç®—Keyçš„bucketä½ç½®
    /* æ£€æŸ¥èŠ‚ç‚¹ä¸Šæ˜¯å¦å­˜åœ¨æ–°å¢çš„Key */ 
    he = d-&gt;ht[table].table[idx]; 
    /* åœ¨èŠ‚ç‚¹é“¾è¡¨æ£€æŸ¥ */ 
    while(he) { 
        if (key==he-&gt;key || dictCompareKeys(d, key, he-&gt;key)) 
            return -1; 
        he = he-&gt;next;
    } 
    if (!dictIsRehashing(d)) break;  // æ‰«å®Œht[0]åï¼Œå¦‚æœå“ˆå¸Œè¡¨ä¸åœ¨rehashingï¼Œåˆ™æ— éœ€å†æ‰«ht[1]
} 
return idx;  } 
</code></pre></div></div>

<p>â€¦</p>

<p>/* å°†Keyæ’å…¥å“ˆå¸Œè¡¨ */
dictEntry *dictAddRaw(dict *d, void *key) 
{ 
    int index; 
    dictEntry *entry; 
    dictht *ht;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (dictIsRehashing(d)) _dictRehashStep(d);  // å¦‚æœå“ˆå¸Œè¡¨åœ¨rehashingï¼Œåˆ™æ‰§è¡Œå•æ­¥rehash

/* è°ƒç”¨_dictKeyIndex() æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›NULL */ 
if ((index = _dictKeyIndex(d, key)) == -1) 
    return NULL; 


ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0]; 
entry = zmalloc(sizeof(*entry));   // ä¸ºæ–°å¢çš„èŠ‚ç‚¹åˆ†é…å†…å­˜
entry-&gt;next = ht-&gt;table[index];  //  å°†èŠ‚ç‚¹æ’å…¥é“¾è¡¨è¡¨å¤´
ht-&gt;table[index] = entry;   // æ›´æ–°èŠ‚ç‚¹å’Œæ¡¶ä¿¡æ¯
ht-&gt;used++;    //  æ›´æ–°ht

/* è®¾ç½®æ–°èŠ‚ç‚¹çš„é”® */ 
dictSetKey(d, entry, key); 
return entry;  }
</code></pre></div></div>

<p>â€¦
/* æ·»åŠ æ–°é”®å€¼å¯¹ */
int dictAdd(dict *d, void *key, void *val) 
{ 
    dictEntry *entry = dictAddRaw(d,key);  // æ·»åŠ æ–°é”®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (!entry) return DICT_ERR;  // å¦‚æœé”®å­˜åœ¨ï¼Œåˆ™è¿”å›å¤±è´¥
dictSetVal(d, entry, val);   // é”®ä¸å­˜åœ¨ï¼Œåˆ™è®¾ç½®èŠ‚ç‚¹å€¼
return DICT_OK;  } ç»§ç»­dictExpandçš„æºç å®ç°ï¼š
</code></pre></div></div>

<p>int dictExpand(dict *d, unsigned long size) 
{ 
    dictht n; // æ–°å“ˆå¸Œè¡¨
    unsigned long realsize = _dictNextPower(size);  // è®¡ç®—æ‰©å±•æˆ–ç¼©æ”¾æ–°å“ˆå¸Œè¡¨çš„å¤§å°(è°ƒç”¨ä¸‹é¢å‡½æ•°_dictNextPower())</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* å¦‚æœæ­£åœ¨rehashæˆ–è€…æ–°å“ˆå¸Œè¡¨çš„å¤§å°å°äºç°å·²ä½¿ç”¨ï¼Œåˆ™è¿”å›error */ 
if (dictIsRehashing(d) || d-&gt;ht[0].used &gt; size) 
    return DICT_ERR; 

/* å¦‚æœè®¡ç®—å‡ºå“ˆå¸Œè¡¨sizeä¸ç°å“ˆå¸Œè¡¨å¤§å°ä¸€æ ·ï¼Œä¹Ÿè¿”å›error */ 
if (realsize == d-&gt;ht[0].size) return DICT_ERR; 

/* åˆå§‹åŒ–æ–°å“ˆå¸Œè¡¨ */ 
n.size = realsize; 
n.sizemask = realsize-1; 
n.table = zcalloc(realsize*sizeof(dictEntry*));  // ä¸ºtableæŒ‡å‘dictEntry åˆ†é…å†…å­˜
n.used = 0; 

/* å¦‚æœht[0] ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ht[0]ä¸ºå½“å‰é”®å€¼å¯¹çš„å“ˆå¸Œè¡¨ */ 
if (d-&gt;ht[0].table == NULL) { 
    d-&gt;ht[0] = n; 
    return DICT_OK; 
} 

/* å¦‚æœht[0]ä¸ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–ht[1]ä¸ºå½“å‰é”®å€¼å¯¹çš„å“ˆå¸Œè¡¨ï¼Œå¹¶å¼€å¯æ¸è¿›å¼rehashæ¨¡å¼ */ 
d-&gt;ht[1] = n; 
d-&gt;rehashidx = 0; 
return DICT_OK;  } ... static unsigned long _dictNextPower(unsigned long size) { 
unsigned long i = DICT_HT_INITIAL_SIZE;  // å“ˆå¸Œè¡¨çš„åˆå§‹å€¼ï¼š4


if (size &gt;= LONG_MAX) return LONG_MAX; 
/* è®¡ç®—æ–°å“ˆå¸Œè¡¨çš„å¤§å°ï¼šç¬¬ä¸€ä¸ªå¤§äºç­‰äºsizeçš„2çš„N æ¬¡æ–¹çš„æ•°å€¼ */
while(1) { 
    if (i &gt;= size) 
        return i; 
    i *= 2; 
}  } æ€»ç»“ä¸€ä¸‹å…·ä½“é€»è¾‘å®ç°ï¼š
</code></pre></div></div>

<p>å¯ä»¥ç¡®è®¤å½“Redis Hashå†²çªåˆ°è¾¾æŸä¸ªæ¡ä»¶æ—¶å°±ä¼šè§¦å‘dictExpand()å‡½æ•°æ¥æ‰©å±•HashTableã€‚</p>

<p>DICT_HT_INITIAL_SIZEåˆå§‹åŒ–å€¼ä¸º4ï¼Œé€šè¿‡ä¸Šè¿°è¡¨è¾¾å¼ï¼Œå–å½“4<em>2^n &gt;= ht[0].used</em>2çš„å€¼ä½œä¸ºå­—å…¸æ‰©å±•çš„sizeå¤§å°ã€‚å³ä¸ºï¼šht[1].size çš„å€¼ç­‰äºç¬¬ä¸€ä¸ªå¤§äºç­‰äºht[0].used*2çš„2^nçš„æ•°å€¼ã€‚</p>

<p>Redisé€šè¿‡dictCreate()åˆ›å»ºè¯å…¸ï¼Œåœ¨åˆå§‹åŒ–ä¸­ï¼ŒtableæŒ‡é’ˆä¸ºNullï¼Œæ‰€ä»¥ä¸¤ä¸ªå“ˆå¸Œè¡¨ht[0].tableå’Œht[1].tableéƒ½æœªçœŸæ­£åˆ†é…å†…å­˜ç©ºé—´ã€‚åªæœ‰åœ¨dictExpand()å­—å…¸æ‰©å±•æ—¶æ‰ç»™tableåˆ†é…æŒ‡å‘dictEntryçš„å†…å­˜ã€‚</p>

<p>ç”±ä¸Šå¯çŸ¥ï¼Œå½“Redisè§¦å‘Resizeåï¼Œå°±ä¼šåŠ¨æ€åˆ†é…ä¸€å—å†…å­˜ï¼Œæœ€ç»ˆç”±ht[1].tableæŒ‡å‘ï¼ŒåŠ¨æ€åˆ†é…çš„å†…å­˜å¤§å°ä¸ºï¼šrealsize<em>sizeof(dictEntry</em>)ï¼ŒtableæŒ‡å‘dictEntry<em>çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œå¤§å°ä¸º8bytesï¼ˆ64ä½OSï¼‰ï¼Œå³ht[1].tableéœ€åˆ†é…çš„å†…å­˜å¤§å°ä¸ºï¼š8</em>2*2^n ï¼ˆnå¤§äºç­‰äº2ï¼‰ã€‚</p>

<p>æ¢³ç†ä¸€ä¸‹å“ˆå¸Œè¡¨å¤§å°å’Œå†…å­˜ç”³è¯·å¤§å°çš„å¯¹åº”å…³ç³»ï¼š</p>

<p>ht[0].size	è§¦å‘Resizeæ—¶ï¼Œht[1]éœ€åˆ†é…çš„å†…å­˜
4	64bytes
8	128bytes
16	256bytes
â€¦	â€¦
65536	1024K
â€¦	â€¦
8388608	128M
16777216	256M
33554432	512M
67108864	1024M
â€¦	â€¦
å¤ç°éªŒè¯
æˆ‘ä»¬é€šè¿‡æµ‹è¯•ç¯å¢ƒæ•°æ®æ¥éªŒè¯ä¸€ä¸‹ï¼Œå½“Redis Rehashè¿‡ç¨‹ä¸­ï¼Œå†…å­˜çœŸæ­£çš„å ç”¨æƒ…å†µã€‚</p>

<p>ä¸Šè¿°ä¸¤å¹…å›¾ä¸­ï¼ŒRedis Keyä¸ªæ•°çªç ´Redis Resizeçš„ä¸´ç•Œç‚¹ï¼Œå½“Keyæ€»æ•°ç¨³å®šä¸”Rehashå®Œæˆåï¼ŒRediså†…å­˜ï¼ˆSlaveï¼‰ä»3586Mé™è‡³ä¸º3522Mï¼š3586-3522=64Mã€‚å³éªŒè¯ä¸Šè¿°Redisåœ¨Resizeè‡³å®Œæˆçš„ä¸­é—´çŠ¶æ€ï¼Œä¼šç»´æŒä¸€æ®µæ—¶é—´å†…å­˜æ¶ˆè€—ï¼Œä¸”å ç”¨å†…å­˜çš„å€¼ä¸ºä¸Šæ–‡åˆ—è¡¨ç›¸åº”çš„å†…å­˜ç©ºé—´ã€‚</p>

<p>è¿›ä¸€æ­¥è§‚å¯Ÿä¸€ä¸‹Rediså†…éƒ¨ç»Ÿè®¡ä¿¡æ¯ï¼š</p>

<p>/* RedisèŠ‚ç‚¹800ä¸‡å·¦å³Keyæ—¶å€™çš„DictçŠ¶æ€ä¿¡æ¯:åªæœ‰ht[0]ä¿¡æ¯ã€‚*/
â€œ[Dictionary HT]
Hash table 0 stats (main hash table):
 table size: 8388608
 number of elements: 8003582
 different slots: 5156314
 max chain length: 9
 avg chain length (counted): 1.55
 avg chain length (computed): 1.55
 Chain length distribution:
   0: 3232294 (38.53%)
   1: 3080243 (36.72%)
   2: 1471920 (17.55%)
   3: 466676 (5.56%)
   4: 112320 (1.34%)
   5: 21301 (0.25%)
   6: 3361 (0.04%)
   7: 427 (0.01%)
   8: 63 (0.00%)
   9: 3 (0.00%)
â€œ</p>

<p>/* RedisèŠ‚ç‚¹840ä¸‡å·¦å³Keyæ—¶å€™çš„DictçŠ¶æ€ä¿¡æ¯æ­£åœ¨Rehasingä¸­ï¼ŒåŒ…å«äº†ht[0]å’Œht[1]ä¿¡æ¯ã€‚*/
â€œ[Dictionary HT]
[Dictionary HT]
Hash table 0 stats (main hash table):
 table size: 8388608
 number of elements: 8019739
 different slots: 5067892
 max chain length: 9
 avg chain length (counted): 1.58
 avg chain length (computed): 1.58
 Chain length distribution:
   0: 3320716 (39.59%)
   1: 2948053 (35.14%)
   2: 1475756 (17.59%)
   3: 491069 (5.85%)
   4: 123594 (1.47%)
   5: 24650 (0.29%)
   6: 4135 (0.05%)
   7: 553 (0.01%)
   8: 78 (0.00%)
   9: 4 (0.00%)
Hash table 1 stats (rehashing target):
 table size: 16777216
 number of elements: 384321
 different slots: 305472
 max chain length: 6
 avg chain length (counted): 1.26
 avg chain length (computed): 1.26
 Chain length distribution:
   0: 16471744 (98.18%)
   1: 238752 (1.42%)
   2: 56041 (0.33%)
   3: 9378 (0.06%)
   4: 1167 (0.01%)
   5: 119 (0.00%)
   6: 15 (0.00%)
â€œ</p>

<p>/* RedisèŠ‚ç‚¹840ä¸‡å·¦å³Keyæ—¶å€™çš„DictçŠ¶æ€ä¿¡æ¯(Rehashå®Œæˆå);ht[0].sizeä»8388608æ‰©å±•åˆ°äº†16777216ã€‚*/
â€œ[Dictionary HT]
Hash table 0 stats (main hash table):
 table size: 16777216
 number of elements: 8404060
 different slots: 6609691
 max chain length: 7
 avg chain length (counted): 1.27
 avg chain length (computed): 1.27
 Chain length distribution:
   0: 10167525 (60.60%)
   1: 5091002 (30.34%)
   2: 1275938 (7.61%)
   3: 213024 (1.27%)
   4: 26812 (0.16%)
   5: 2653 (0.02%)
   6: 237 (0.00%)
   7: 25 (0.00%)
â€œ     <br />
ç»è¿‡Redis Rehashå†…éƒ¨æœºåˆ¶çš„æ·±å…¥ã€RedisçŠ¶æ€ç›‘æ§å’ŒRediså†…éƒ¨ç»Ÿè®¡ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼š</p>

<p>å½“Redis èŠ‚ç‚¹ä¸­çš„Keyæ€»é‡åˆ°è¾¾ä¸´ç•Œç‚¹åï¼ŒRediså°±ä¼šè§¦å‘Dictçš„æ‰©å±•ï¼Œè¿›è¡ŒRehashã€‚ç”³è¯·æ‰©å±•åç›¸åº”çš„å†…å­˜ç©ºé—´å¤§å°ã€‚</p>

<p>å¦‚ä¸Šï¼ŒRedisåœ¨æ»¡å®¹é©±é€çŠ¶æ€ä¸‹ï¼ŒRedis Rehashæ˜¯å¯¼è‡´Redis Masterå’ŒSlaveå¤§é‡è§¦å‘é©±é€æ·˜æ±°çš„æ ¹æœ¬åŸå› ã€‚</p>

<p>é™¤äº†å¯¼è‡´æ»¡å®¹é©±é€æ·˜æ±°ï¼ŒRedis Rehashè¿˜ä¼šå¼•èµ·å…¶ä»–ä¸€äº›é—®é¢˜ï¼š</p>

<p>åœ¨tablesizeçº§åˆ«ä¸ç°æœ‰Keysæ•°é‡ä¸åœ¨åŒä¸€ä¸ªåŒºé—´å†…ï¼Œä¸»ä»åˆ‡æ¢åï¼Œç”±äºRediså…¨é‡åŒæ­¥ï¼Œä»åº“tablesizeé™ä¸ºä¸ç°æœ‰KeyåŒ¹é…å€¼ï¼Œå¯¼è‡´å†…å­˜å€¾æ–œï¼›</p>

<p>Redis Clusterä¸‹çš„æŸä¸ªåˆ†ç‰‡ç”±äºKeyæ•°é‡ç›¸å¯¹è¾ƒå¤šæå‰Resizeï¼Œå¯¼è‡´é›†ç¾¤åˆ†ç‰‡å†…å­˜ä¸å‡ã€‚</p>

<p>ç­‰ç­‰â€¦</p>

<p>Redis Rehashæœºåˆ¶ä¼˜åŒ–
é‚£ä¹ˆé’ˆå¯¹åœ¨Redisæ»¡å®¹é©±é€çŠ¶æ€ä¸‹ï¼Œå¦‚ä½•é¿å…å› Rehashè€Œå¯¼è‡´RedisæŠ–åŠ¨çš„è¿™ç§é—®é¢˜ã€‚</p>

<p>æˆ‘ä»¬åœ¨Redis Rehashæºç å®ç°çš„é€»è¾‘ä¸Šï¼ŒåŠ ä¸Šäº†ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œå¦‚æœç°æœ‰çš„å‰©ä½™å†…å­˜ä¸å¤Ÿè§¦å‘Rehashæ“ä½œæ‰€éœ€ç”³è¯·çš„å†…å­˜å¤§å°ï¼Œå³ä¸è¿›è¡ŒResizeæ“ä½œï¼›</p>

<p>é€šè¿‡æå‰è¿è¥è¿›è¡Œè§„é¿ï¼Œæ¯”å¦‚å®¹é‡é¢„ä¼°æ—¶å°†Rehashå ç”¨çš„å†…å­˜è€ƒè™‘åœ¨å†…ï¼Œæˆ–è€…é€šè¿‡ç›‘æ§å®šæ—¶æ‰©å®¹ã€‚</p>

<p>Redis Rehashæœºåˆ¶é™¤äº†ä¼šå½±å“ä¸Šè¿°å†…å­˜ç®¡ç†å’Œä½¿ç”¨å¤–ï¼Œä¹Ÿä¼šå½±å“Rediså…¶ä»–å†…éƒ¨ä¸ä¹‹ç›¸å…³è”çš„åŠŸèƒ½æ¨¡å—ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†äº«ä¸€ä¸‹ç”±äºRehashæœºåˆ¶è€Œè¸©åˆ°çš„ç¬¬äºŒä¸ªå‘ã€‚</p>

<p>Redisä½¿ç”¨Scanæ¸…ç†Keyç”±äºRehashå¯¼è‡´æ¸…ç†æ•°æ®ä¸å½»åº•</p>

<p>Squirrelå¹³å°æä¾›ç»™ä¸šåŠ¡æ¸…ç†Keyçš„APIåå°é€»è¾‘ï¼Œæ˜¯é€šè¿‡Scanæ¥å®ç°çš„ã€‚å®é™…çº¿ä¸Šè¿è¡Œæ•ˆæœå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½èƒ½å®Œå…¨æ¸…ç†å¹²å‡€ã€‚å³é€šè¿‡Scanæ‰«ææ¸…ç†ç›¸åŒ¹é…çš„Keyï¼Œè¾ƒä½é¢‘ç‡ä¼šæœ‰é—æ¼ã€Keyæœªè¢«å…¨éƒ¨æ¸…ç†æ‰çš„ç°è±¡ã€‚æœ‰äº†å‰å‡ æ¬¡çš„ç›¸å…³ç»éªŒåï¼Œæˆ‘ä»¬ç›´æ¥ä»åŸç†å…¥æ‰‹ã€‚</p>

<p>ScanåŸç†</p>

<p>ä¸ºäº†é«˜æ•ˆåœ°åŒ¹é…å‡ºæ•°æ®åº“ä¸­æ‰€æœ‰ç¬¦åˆç»™å®šæ¨¡å¼çš„Keyï¼ŒRedisæä¾›äº†Scanå‘½ä»¤ã€‚è¯¥å‘½ä»¤ä¼šåœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™è¿”å›ç¬¦åˆè§„åˆ™çš„éƒ¨åˆ†Keyä»¥åŠä¸€ä¸ªæ¸¸æ ‡å€¼Cursorï¼ˆåˆå§‹å€¼ä½¿ç”¨0ï¼‰ï¼Œä½¿ç”¨æ¯æ¬¡è¿”å›Cursorä¸æ–­è¿­ä»£ï¼Œç›´åˆ°Cursorçš„è¿”å›å€¼ä¸º0ä»£è¡¨éå†ç»“æŸã€‚</p>

<p>Rediså®˜æ–¹å®šä¹‰Scanç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>

<p>æ•´ä¸ªéå†ä»å¼€å§‹åˆ°ç»“æŸæœŸé—´ï¼Œ ä¸€ç›´å­˜åœ¨äºRedisæ•°æ®é›†å†…çš„ä¸”ç¬¦åˆåŒ¹é…æ¨¡å¼çš„æ‰€æœ‰Keyéƒ½ä¼šè¢«è¿”å›ï¼›</p>

<p>å¦‚æœå‘ç”Ÿäº†rehashï¼ŒåŒä¸€ä¸ªå…ƒç´ å¯èƒ½ä¼šè¢«è¿”å›å¤šæ¬¡ï¼Œéå†è¿‡ç¨‹ä¸­æ–°å¢æˆ–è€…åˆ é™¤çš„Keyå¯èƒ½ä¼šè¢«è¿”å›ï¼Œä¹Ÿå¯èƒ½ä¸ä¼šã€‚</p>

<p>å…·ä½“å®ç°</p>

<p>ä¸Šè¿°æåŠRedisçš„Keysæ˜¯ä»¥Dictæ–¹å¼æ¥å­˜å‚¨çš„ï¼Œæ­£å¸¸åªè¦ä¸€æ¬¡éå†Dictä¸­æ‰€æœ‰Hashæ¡¶å°±å¯ä»¥å®Œæ•´æ‰«æå‡ºæ‰€æœ‰Keyã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­ï¼ŒRedis Dictæ˜¯æœ‰çŠ¶æ€çš„ï¼Œä¼šéšç€Keyçš„å¢åˆ ä¸æ–­å˜åŒ–ã€‚</p>

<p>æ¥ä¸‹æ¥æ ¹æ®Dictå››ç§çŠ¶æ€æ¥åˆ†æä¸€ä¸‹Scançš„ä¸åŒå®ç°ã€‚</p>

<p>Dictçš„å››ç§çŠ¶æ€åœºæ™¯ï¼š</p>

<p>å­—å…¸tablesizeä¿æŒä¸å˜ï¼Œæ²¡æœ‰æ‰©ç¼©å®¹ï¼›</p>

<p>å­—å…¸Resizeï¼ŒDictæ‰©å¤§äº†ï¼ˆå®ŒæˆçŠ¶æ€ï¼‰ï¼›</p>

<p>å­—å…¸Resizeï¼ŒDictç¼©å°äº†ï¼ˆå®ŒæˆçŠ¶æ€ï¼‰ï¼›</p>

<p>å­—å…¸æ­£åœ¨Rehashingï¼ˆæ‰©å±•æˆ–æ”¶ç¼©ï¼‰ã€‚</p>

<p>(1) å­—å…¸tablesizeä¿æŒä¸å˜ï¼Œåœ¨Redis Dictç¨³å®šçš„çŠ¶æ€ä¸‹ï¼Œç›´æ¥é¡ºåºéå†å³å¯ã€‚
(2) å­—å…¸Resizeï¼ŒDictæ‰©å¤§äº†ï¼Œå¦‚æœè¿˜æ˜¯æŒ‰ç…§é¡ºåºéå†ï¼Œå°±ä¼šå¯¼è‡´æ‰«æå¤§é‡é‡å¤Keyã€‚æ¯”å¦‚å­—å…¸tablesizeä»8å˜æˆäº†16ï¼Œå‡è®¾ä¹‹å‰è®¿é—®çš„æ˜¯3å·æ¡¶ï¼Œé‚£ä¹ˆè¡¨æ‰©å±•ååˆ™æ˜¯ç»§ç»­è®¿é—®4~15å·æ¡¶ï¼›ä½†æ˜¯ï¼ŒåŸå…ˆçš„0~3å·æ¡¶ä¸­çš„æ•°æ®åœ¨Dicté•¿åº¦å˜å¤§åè¢«è¿ç§»åˆ°8~11å·æ¡¶ä¸­ï¼Œå› æ­¤ï¼Œéå†8~11å·æ¡¶çš„æ—¶å€™ä¼šæœ‰å¤§é‡çš„é‡å¤Keyè¢«è¿”å›ã€‚
(3) å­—å…¸Resizeï¼ŒDictç¼©å°äº†ï¼Œå¦‚æœè¿˜æ˜¯æŒ‰ç…§é¡ºåºéå†ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡çš„Keyè¢«é—æ¼ã€‚æ¯”å¦‚å­—å…¸tablesizeä»8å˜æˆäº†4ï¼Œå‡è®¾å½“å‰è®¿é—®çš„æ˜¯3å·æ¡¶ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡åˆ™ä¼šç›´æ¥è¿”å›éå†ç»“æŸäº†ï¼›ä½†æ˜¯ä¹‹å‰4~7å·æ¡¶ä¸­çš„æ•°æ®åœ¨ç¼©å®¹åè¿ç§»å¸¦å¯0~3å·æ¡¶ä¸­ï¼Œå› æ­¤è¿™éƒ¨åˆ†Keyå°±æ— æ³•æ‰«æåˆ°ã€‚
(4) å­—å…¸æ­£åœ¨Rehashingï¼Œè¿™ç§æƒ…å†µå¦‚(2)å’Œ(3)æƒ…å†µä¸€ä¸‹ï¼Œè¦ä¹ˆå¤§é‡é‡å¤æ‰«æã€è¦ä¹ˆé—æ¼å¾ˆå¤šKeyã€‚</p>

<p>é‚£ä¹ˆåœ¨Dictéç¨³å®šçŠ¶æ€ï¼Œå³å‘ç”ŸRehashçš„æƒ…å†µä¸‹ï¼ŒScanè¦å¦‚ä½•ä¿è¯åŸæœ‰çš„Keyéƒ½èƒ½éå†å‡ºæ¥ï¼Œåˆå°½å°‘å¯èƒ½é‡å¤æ‰«æå‘¢ï¼ŸRedis Scané€šè¿‡Hashæ¡¶æ©ç çš„é«˜ä½é¡ºåºè®¿é—®æ¥è§£å†³ã€‚</p>

<p>é«˜ä½é¡ºåºè®¿é—®å³æŒ‰ç…§Dict sizemaskï¼ˆæ©ç ï¼‰ï¼Œåœ¨æœ‰æ•ˆä½ï¼ˆä¸Šå›¾ä¸­Dict sizemaskä¸º3ï¼‰ä¸Šä»é«˜ä½å¼€å§‹åŠ ä¸€æšä¸¾ï¼›ä½ä½åˆ™æŒ‰ç…§æœ‰æ•ˆä½çš„ä½ä½é€æ­¥åŠ ä¸€è®¿é—®ã€‚
ä½ä½åºï¼š0â†’1â†’2â†’3â†’4â†’5â†’6â†’7
é«˜ä½åºï¼š0â†’4â†’2â†’6â†’1â†’5â†’3â†’7</p>

<p>Scané‡‡ç”¨é«˜ä½åºè®¿é—®çš„åŸå› ï¼Œå°±æ˜¯ä¸ºäº†å®ç°Redis Dictåœ¨Rehashæ—¶å°½å¯èƒ½å°‘é‡å¤æ‰«æè¿”å›Keyã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœDictçš„tablesizeä»8æ‰©å±•åˆ°äº†16ï¼Œæ¢³ç†ä¸€ä¸‹Scanæ‰«ææ–¹å¼:</p>

<p>Dict(8) ä»Cursor 0å¼€å§‹æ‰«æï¼›</p>

<p>å‡†å¤‡æ‰«æCursor 6æ—¶å‘ç”ŸResizeï¼Œæ‰©å±•ä¸ºä¹‹å‰çš„2å€ï¼Œå¹¶å®ŒæˆRehashï¼›</p>

<p>å®¢æˆ·ç«¯è¿™æ—¶å¼€å§‹ä»Dict(16)çš„Cursor 6ç»§ç»­è¿­ä»£ï¼›</p>

<p>è¿™æ—¶æŒ‰ç…§ 6â†’14â†’1â†’9â†’5â†’13â†’3â†’11â†’7â†’15 Scanå®Œæˆã€‚</p>

<p>å¯ä»¥çœ‹å‡ºï¼Œé«˜ä½åºScanåœ¨Dict Rehashæ—¶å³å¯ä»¥é¿å…é‡å¤éå†ï¼Œåˆèƒ½å®Œæ•´è¿”å›åŸå§‹çš„æ‰€æœ‰Keyã€‚åŒç†ï¼Œå­—å…¸ç¼©å®¹æ—¶ä¹Ÿä¸€æ ·ï¼Œå­—å…¸ç¼©å®¹å¯ä»¥çœ‹å‡ºæ˜¯åå‘æ‰©å®¹ã€‚</p>

<p>ä¸Šè¿°æ˜¯Scançš„ç†è®ºåŸºç¡€ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Redisæºç å¦‚ä½•å®ç°ã€‚</p>

<p>(1) éRehashing çŠ¶æ€ä¸‹çš„å®ç°ï¼š</p>

<p>if (!dictIsRehashing(d)) {     // åˆ¤æ–­æ˜¯å¦æ­£åœ¨rehashingï¼Œå¦‚æœä¸åœ¨åˆ™åªæœ‰ht[0]
        t0 = &amp;(d-&gt;ht[0]);  // ht[0]
        m0 = t0-&gt;sizemask;  // æ©ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /* Emit entries at cursor */
    de = t0-&gt;table[v &amp; m0];  // ç›®æ ‡æ¡¶
    while (de) {           
        fn(privdata, de);
        de = de-&gt;next;       // éå†æ¡¶ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¹¶é€šè¿‡å›è°ƒå‡½æ•°fn()è¿”å›
    }
 ...
  /* åå‘äºŒè¿›åˆ¶è¿­ä»£ç®—æ³•å…·ä½“å®ç°é€»è¾‘â€”â€”æ¸¸æ ‡å®ç°çš„ç²¾é«“ */
 /* Set unmasked bits so incrementing the reversed cursor
 * operates on the masked bits of the smaller table */
v |= ~m0;

/* Increment the reverse cursor */
v = rev(v);
v++;
v = rev(v);

return v; } æºç ä¸­Rediså°†Cursorçš„è®¡ç®—é€šè¿‡Reverse Binary Iterationï¼ˆåå‘äºŒè¿›åˆ¶è¿­ä»£ç®—æ³•ï¼‰æ¥å®ç°ä¸Šè¿°çš„é«˜ä½åºæ‰«ææ–¹å¼ã€‚
</code></pre></div></div>

<p>(2) Rehashing çŠ¶æ€ä¸‹çš„å®ç°ï¼š</p>

<p>â€¦
  else {    // å¦åˆ™è¯´æ˜æ­£åœ¨rehashingï¼Œå°±å­˜åœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨ht[0]ã€ht[1]
        t0 = &amp;d-&gt;ht[0];
        t1 = &amp;d-&gt;ht[1];  // æŒ‡å‘ä¸¤ä¸ªå“ˆå¸Œè¡¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    /* Make sure t0 is the smaller and t1 is the bigger table */
    if (t0-&gt;size &gt; t1-&gt;size) {  ç¡®ä¿t0å°äºt1
        t0 = &amp;d-&gt;ht[1];
        t1 = &amp;d-&gt;ht[0];  
    }

    m0 = t0-&gt;sizemask;
    m1 = t1-&gt;sizemask;  // ç›¸å¯¹åº”çš„æ©ç 

    /* Emit entries at cursor */
    /* è¿­ä»£(å°è¡¨)t0æ¡¶ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ */
    de = t0-&gt;table[v &amp; m0];
    while (de) {   
        fn(privdata, de);
        de = de-&gt;next;
    }

    /* Iterate over indices in larger table that are the expansion
     * of the index pointed to by the cursor in the smaller table */
    /* */

    do {
        /* Emit entries at cursor */
        /* è¿­ä»£(å¤§è¡¨)t1 ä¸­æ‰€æœ‰èŠ‚ç‚¹ï¼Œå¾ªç¯è¿­ä»£ï¼Œä¼šæŠŠå°è¡¨æ²¡æœ‰è¦†ç›–çš„slotå…¨éƒ¨æ‰«æä¸€é */ 
        de = t1-&gt;table[v &amp; m1];
        while (de) {
            fn(privdata, de);
            de = de-&gt;next;
        }

        /* Increment bits not covered by the smaller mask */
        v = (((v | m0) + 1) &amp; ~m0) | (v &amp; m0);

        /* Continue while bits covered by mask difference is non-zero */
    } while (v &amp; (m0 ^ m1));
}

/* Set unmasked bits so incrementing the reversed cursor
 * operates on the masked bits of the smaller table */
v |= ~m0;

/* Increment the reverse cursor */
v = rev(v);
v++;
v = rev(v);

return v; å¦‚ä¸ŠRehashingæ—¶ï¼ŒRedis é€šè¿‡elseåˆ†æ”¯å®ç°è¯¥è¿‡ç¨‹ä¸­å¯¹ä¸¤å¼ Hashè¡¨è¿›è¡Œæ‰«æè®¿é—®ã€‚
</code></pre></div></div>

<p>æ¢³ç†ä¸€ä¸‹é€»è¾‘æµç¨‹ï¼š</p>

<p>Redisåœ¨å¤„ç†dictScan()æ—¶ï¼Œä¸Šé¢ç»†åˆ†çš„å››ä¸ªåœºæ™¯çš„å®ç°åˆ†æˆäº†ä¸¤ä¸ªé€»è¾‘ï¼š</p>

<p>æ­¤æ—¶ä¸åœ¨Rehashingçš„çŠ¶æ€ï¼š
è¿™ç§çŠ¶æ€ï¼Œå³Dictæ˜¯é™æ­¢çš„ã€‚é’ˆå¯¹è¿™ç§çŠ¶æ€ä¸‹çš„ä¸Šè¿°ä¸‰ç§åœºæ™¯ï¼ŒRedisé‡‡ç”¨ä¸Šè¿°çš„Reverse Binary Iterationï¼ˆåå‘äºŒè¿›åˆ¶è¿­ä»£ç®—æ³•ï¼‰ï¼š
â… . é¦–å…ˆå¯¹æ¸¸æ ‡ï¼ˆCursorï¼‰äºŒè¿›åˆ¶ä½ç¿»è½¬ï¼›
â…¡. å†å¯¹ç¿»è½¬åçš„å€¼åŠ 1ï¼›
â…¢. æœ€åå†æ¬¡å¯¹â…¡çš„ç»“æœè¿›è¡Œç¿»è½¬ã€‚</p>

<p>é€šè¿‡ç©·ä¸¾é«˜ä½ï¼Œä¾æ¬¡å‘ä½ä½æ¨è¿›çš„æ–¹å¼ï¼ˆå³é«˜ä½åºè®¿é—®çš„å®ç°ï¼‰æ¥ç¡®ä¿æ‰€æœ‰å…ƒç´ éƒ½ä¼šè¢«éå†åˆ°ã€‚</p>

<p>è¿™ç§ç®—æ³•å·²ç»å°½å¯èƒ½å‡å°‘é‡å¤å…ƒç´ çš„è¿”å›ï¼Œä½†æ˜¯å®é™…å®ç°å’Œé€»è¾‘ä¸­è¿˜æ˜¯ä¼šæœ‰å¯èƒ½å­˜åœ¨é‡å¤è¿”å›ï¼Œæ¯”å¦‚åœ¨Dictç¼©å®¹æ—¶ï¼Œé«˜ä½åˆå¹¶åˆ°ä½ä½æ¡¶ä¸­ï¼Œä½ä½æ¡¶ä¸­çš„å…ƒç´ å°±ä¼šè¢«é‡å¤å–å‡ºã€‚</p>

<p>æ­£åœ¨Rehashingçš„çŠ¶æ€ï¼š
Redisåœ¨RehashingçŠ¶æ€çš„æ—¶å€™ï¼ŒdictScan()å®ç°é€šè¿‡ä¸€æ¬¡æ€§æ‰«æç°æœ‰çš„ä¸¤ç§å­—å…¸è¡¨ï¼Œé¿å…ä¸­é—´çŠ¶æ€æ— æ³•ç»´æŠ¤ã€‚
å…·ä½“å®ç°å°±æ˜¯åœ¨éå†å®Œå°è¡¨Cursorä½ç½®åï¼Œå°†å°è¡¨Cursorä½ç½®å¯èƒ½Rehashåˆ°çš„å¤§è¡¨æ‰€æœ‰ä½ç½®å…¨éƒ¨éå†ä¸€éï¼Œç„¶åå†è¿”å›éå†å…ƒç´ å’Œä¸‹ä¸€ä¸ªå°è¡¨éå†ä½ç½®ã€‚</p>

<p>Root Cause å®šä½
RehashingçŠ¶æ€æ—¶ï¼Œæ¸¸æ ‡è¿­ä»£ä¸»è¦é€»è¾‘ä»£ç å®ç°ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         /* Increment bits not covered by the smaller mask */
        v = (((v | m0) + 1) &amp; ~m0) | (v &amp; m0);   //BUG â… . vä½ä½åŠ 1å‘é«˜ä½è¿›ä½ï¼› â…¡. å»æ‰væœ€å‰é¢å’Œæœ€åé¢çš„éƒ¨åˆ†ï¼Œåªä¿ç•™vç›¸è¾ƒäºm0çš„é«˜ä½éƒ¨åˆ†ï¼› â…¢. ä¿ç•™vçš„ä½ä½ï¼Œé«˜ä½ä¸æ–­åŠ 1ã€‚å³ä½ä½ä¸å˜ï¼Œé«˜ä½ä¸æ–­åŠ 1ï¼Œå®ç°äº†å°è¡¨åˆ°å¤§è¡¨æ¡¶çš„å…³è”ã€‚
</code></pre></div></div>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœDictçš„tablesizeä»8æ‰©å±•åˆ°äº†32ï¼Œæ¢³ç†ä¸€ä¸‹Scanæ‰«ææ–¹å¼:</p>

<p>Dict(8) ä»Cursor 0å¼€å§‹æ‰«æï¼›
å‡†å¤‡æ‰«æCursor 4æ—¶å‘ç”ŸResizeï¼Œæ‰©å±•ä¸ºä¹‹å‰çš„4å€ï¼ŒRehashingï¼›
å®¢æˆ·ç«¯å…ˆè®¿é—®Dict(8)ä¸­çš„4å·æ¡¶ï¼›
ç„¶åå†åˆ°Dict(32)ä¸Šè®¿é—®:4â†’12â†’20â†’28ã€‚
è¿™é‡Œå¯ä»¥çœ‹åˆ°å¤§è¡¨çš„ç›¸å…³æ¡¶çš„é¡ºåºå¹¶éæ˜¯æŒ‰ç…§ä¹‹å‰æ‰€è¿°çš„äºŒè¿›åˆ¶é«˜ä½åºï¼Œå®é™…ä¸Šæ˜¯æŒ‰ç…§ä½ä½åºæ¥éå†å¤§è¡¨ä¸­é«˜å‡ºå°è¡¨çš„æœ‰æ•ˆä½ã€‚</p>

<p>å¤§è¡¨t1é«˜ä½éƒ½æ˜¯å‘ä½ä½åŠ 1è®¡ç®—å¾—å‡ºçš„ï¼Œæ‰«æçš„é¡ºåºå´æ˜¯ä»ä½ä½åŠ 1ï¼Œå‘é«˜ä½è¿›ä½ã€‚Redisé’ˆå¯¹Rehashingæ—¶è¿™ç§é€»è¾‘å®ç°åœ¨æ‰©å®¹æ—¶æ˜¯å¯ä»¥è¿è¡Œæ­£å¸¸çš„ï¼Œä½†æ˜¯åœ¨ç¼©å®¹æ—¶é«˜ä½åºå’Œä½ä½åºçš„éå†åœ¨å¤§å°è¡¨ä¸Šçš„æ··ç”¨åœ¨ä¸€å®šæ¡ä»¶ä¸‹ä¼šå‡ºç°é—®é¢˜ã€‚</p>

<p>å†æ¬¡ç¤ºä¾‹ï¼ŒDictçš„tablesizeä»32ç¼©å®¹åˆ°8ï¼š</p>

<p>Dict(32) ä»Cursor 0å¼€å§‹æ‰«æï¼›</p>

<p>å‡†å¤‡æ‰«æCursor 20æ—¶å‘ç”ŸResizeï¼Œç¼©å®¹è‡³åŸæ¥çš„å››åˆ†ä¹‹ä¸€å³tablesizeä¸º8ï¼ŒRehashingï¼›</p>

<p>å®¢æˆ·ç«¯å‘èµ·Cursor 20,é¦–å…ˆè®¿é—®Dict(8)ä¸­çš„4å·æ¡¶ï¼›</p>

<p>å†åˆ°Dict(32)ä¸Šè®¿é—®:20â†’28;</p>

<p>æœ€åè¿”å›Cursor = 2ã€‚</p>

<p>å¯ä»¥çœ‹å‡ºå¤§è¡¨ä¸­çš„12å·æ¡¶æ²¡æœ‰è¢«è®¿é—®åˆ°ï¼Œå³éå†å¤§è¡¨æ—¶ï¼ŒæŒ‰ç…§ä½ä½åºè®¿é—®ä¼šé—æ¼å¯¹æŸäº›æ¡¶çš„è®¿é—®ã€‚</p>

<p>ä¸Šè¿°è¿™ç§æƒ…å†µå‘ç”Ÿéœ€è¦å…·å¤‡ä¸€å®šçš„æ¡ä»¶ï¼š</p>

<p>åœ¨Dictç¼©å®¹Rehashæ—¶Scanï¼›</p>

<p>Dictç¼©å®¹è‡³è‡³å°‘åŸDict tablesizeçš„å››åˆ†ä¹‹ä¸€ï¼Œåªæœ‰åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤§è¡¨ç›¸å¯¹å°è¡¨çš„æœ‰æ•ˆä½æ‰ä¼šé«˜å‡ºäºŒä½ä»¥ä¸Šï¼Œä»è€Œè§¦å‘è·³è¿‡æŸä¸ªæ¡¶çš„æƒ…å†µï¼›</p>

<p>å¦‚æœåœ¨Rehashå¼€å§‹å‰è¿”å›çš„Cursoræ˜¯åœ¨å°è¡¨èƒ½è¡¨ç¤ºçš„èŒƒå›´å†…ï¼ˆå³ä¸è¶…è¿‡7ï¼‰ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œé«˜ä½æœ‰æ•ˆä½çš„åŠ ä¸€æ“ä½œæ—¶ï¼Œå¿…ç„¶éƒ½æ˜¯ä»0å¼€å§‹è®¡ç®—ï¼Œæ¯æ¬¡åŠ ä¸€ä¹Ÿå¿…ç„¶èƒ½å¤Ÿè®¿é—®çš„å…¨æ‰€æœ‰çš„ç›¸å…³æ¡¶ï¼›å¦‚æœåœ¨Rehashå¼€å§‹å‰è¿”å›çš„cursorä¸åœ¨å°è¡¨èƒ½è¡¨ç¤ºçš„èŒƒå›´å†…ï¼ˆæ¯”å¦‚20ï¼‰ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œé«˜ä½æœ‰æ•ˆä½åŠ ä¸€æ“ä½œçš„æ—¶å€™ï¼Œå°±æœ‰å¯èƒ½è·³è¿‡ ï¼Œæˆ–è€…é‡å¤è®¿é—®æŸäº›æ¡¶çš„æƒ…å†µã€‚</p>

<p>å¯è§ï¼Œåªæœ‰æ»¡è¶³ä¸Šè¿°ä¸‰ç§æƒ…å†µæ‰ä¼šå‘ç”ŸScanéå†è¿‡ç¨‹ä¸­æ¼æ‰äº†ä¸€äº›Keyçš„æƒ…å†µã€‚åœ¨æ‰§è¡Œæ¸…ç†Keyçš„æ—¶å€™ï¼Œå¦‚æœæ¸…ç†çš„Keyæ•°é‡å¾ˆå¤§ï¼Œå¯¼è‡´äº†Rediså†…éƒ¨çš„Hashè¡¨ç¼©å®¹è‡³å°‘åŸDict tablesizeçš„å››åˆ†ä¹‹ä¸€ï¼Œå°±å¯èƒ½å­˜åœ¨ä¸€äº›Keyè¢«æ¼æ‰çš„é£é™©ã€‚</p>

<p>Scanæºç ä¼˜åŒ–
ä¿®å¤é€»è¾‘å°±æ˜¯å…¨éƒ¨éƒ½ä»é«˜ä½å¼€å§‹å¢åŠ è¿›è¡Œéå†ï¼Œå³å¤§å°è¡¨éƒ½ä½¿ç”¨é«˜ä½åºè®¿é—®ï¼Œä¿®å¤æºç å¦‚ä¸‹ï¼š</p>

<p>unsigned long dictScan(dict <em>d,
                       unsigned long v,
                       dictScanFunction *fn,
                       dictScanBucketFunction</em> bucketfn,
                       void *privdata)
{
    dictht *t0, *t1;
    const dictEntry *de, *next;
    unsigned long m0, m1;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (dictSize(d) == 0) return 0;

if (!dictIsRehashing(d)) {
    t0 = &amp;(d-&gt;ht[0]);
    m0 = t0-&gt;sizemask;

    /* Emit entries at cursor */
    if (bucketfn) bucketfn(privdata, &amp;t0-&gt;table[v &amp; m0]);
    de = t0-&gt;table[v &amp; m0];
    while (de) {
        next = de-&gt;next;
        fn(privdata, de);
        de = next;
    }

    /* Set unmasked bits so incrementing the reversed cursor
     * operates on the masked bits */
    v |= ~m0;

    /* Increment the reverse cursor */
    v = rev(v);
    v++;
    v = rev(v);

} else {
    t0 = &amp;d-&gt;ht[0];
    t1 = &amp;d-&gt;ht[1];

    /* Make sure t0 is the smaller and t1 is the bigger table */
    if (t0-&gt;size &gt; t1-&gt;size) {
        t0 = &amp;d-&gt;ht[1];
        t1 = &amp;d-&gt;ht[0];
    }

    m0 = t0-&gt;sizemask;
    m1 = t1-&gt;sizemask;

    /* Emit entries at cursor */
    if (bucketfn) bucketfn(privdata, &amp;t0-&gt;table[v &amp; m0]);
    de = t0-&gt;table[v &amp; m0];
    while (de) {
        next = de-&gt;next;
        fn(privdata, de);
        de = next;
    }

    /* Iterate over indices in larger table that are the expansion
     * of the index pointed to by the cursor in the smaller table */
    do {
        /* Emit entries at cursor */
        if (bucketfn) bucketfn(privdata, &amp;t1-&gt;table[v &amp; m1]);
        de = t1-&gt;table[v &amp; m1];
        while (de) {
            next = de-&gt;next;
            fn(privdata, de);
            de = next;
        }

        /* Increment the reverse cursor not covered by the smaller mask.*/
        v |= ~m1;
        v = rev(v);
        v++;
        v = rev(v);

        /* Continue while bits covered by mask difference is non-zero */
    } while (v &amp; (m0 ^ m1));
}

return v; } æˆ‘ä»¬å›¢é˜Ÿå·²ç»å°†æ­¤PR Pushåˆ°Rediså®˜æ–¹ï¼šFix dictScan(): It can't scan all buckets when dict is shrinkingï¼Œå¹¶å·²ç»è¢«å®˜æ–¹Mergeã€‚
</code></pre></div></div>

<p>è‡³æ­¤ï¼ŒåŸºäºRedis Rehashä»¥åŠScanå®ç°ä¸­æ¶‰åŠRehashçš„ä¸¤ä¸ªæœºåˆ¶å·²ç»åŸºæœ¬äº†è§£å’Œä¼˜åŒ–å®Œæˆã€‚</p>

<p>æ€»ç»“</p>

<p>æœ¬æ–‡ä¸»è¦é˜è¿°äº†å› Redisçš„Rehashæœºåˆ¶è¸©åˆ°çš„ä¸¤ä¸ªå‘ï¼Œä»ç°è±¡åˆ°åŸç†è¿›è¡Œäº†è¯¦ç»†çš„ä»‹ç»ã€‚è¿™é‡Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œç¬¬ä¸€ä¸ªæ¡ˆä¾‹ä¼šé€ æˆçº¿ä¸Šé›†ç¾¤è¿›è¡Œå¤§é‡æ·˜æ±°ï¼Œè€Œä¸”äº§ç”Ÿä¸»ä»ä¸ä¸€è‡´çš„æƒ…å†µï¼Œåœ¨ä¸šåŠ¡å±‚é¢ä¹Ÿä¼šå‘ç”Ÿå¤§é‡è¶…æ—¶ï¼Œå½±å“ä¸šåŠ¡å¯ç”¨æ€§ï¼Œé—®é¢˜ä¸¥é‡ï¼Œéå¸¸å€¼å¾—å¤§å®¶å…³æ³¨ï¼›ç¬¬äºŒä¸ªæ¡ˆä¾‹ä¼šé€ æˆæ•°æ®æ¸…ç†æ— æ³•å®Œå…¨æ¸…ç†ï¼Œä½†æ˜¯å¯ä»¥å†åˆ©ç”¨Scanæ¸…ç†ä¸€éä¹Ÿèƒ½å¤Ÿæ¸…ç†å®Œæ¯•ã€‚</p>
:ET