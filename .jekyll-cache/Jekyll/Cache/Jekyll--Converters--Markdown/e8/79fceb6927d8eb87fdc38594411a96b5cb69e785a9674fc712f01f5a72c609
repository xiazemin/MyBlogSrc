I"ÿ±<p>Namespaceæ˜¯å¯¹å…¨å±€ç³»ç»Ÿèµ„æºçš„ä¸€ç§å°è£…éš”ç¦»ï¼Œä½¿å¾—å¤„äºä¸åŒnamespaceçš„è¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„å…¨å±€ç³»ç»Ÿèµ„æºï¼Œæ”¹å˜ä¸€ä¸ªnamespaceä¸­çš„ç³»ç»Ÿèµ„æºåªä¼šå½±å“å½“å‰namespaceé‡Œçš„è¿›ç¨‹ï¼Œå¯¹å…¶ä»–namespaceä¸­çš„è¿›ç¨‹æ²¡æœ‰å½±å“ã€‚</p>

<p>ä¸‹é¢çš„æ‰€æœ‰ä¾‹å­éƒ½åœ¨ubuntu-server-x86_64 16.04ä¸‹æ‰§è¡Œé€šè¿‡</p>

<p>Linuxå†…æ ¸æ”¯æŒçš„namespaces
ç›®å‰ï¼ŒLinuxå†…æ ¸é‡Œé¢å®ç°äº†7ç§ä¸åŒç±»å‹çš„namespaceã€‚</p>

<p>åç§°        å®å®šä¹‰             éš”ç¦»å†…å®¹
Cgroup      CLONE_NEWCGROUP   Cgroup root directory (since Linux 4.6)
IPC         CLONE_NEWIPC      System V IPC, POSIX message queues (since Linux 2.6.19)
Network     CLONE_NEWNET      Network devices, stacks, ports, etc. (since Linux 2.6.24)
Mount       CLONE_NEWNS       Mount points (since Linux 2.4.19)
PID         CLONE_NEWPID      Process IDs (since Linux 2.6.24)
User        CLONE_NEWUSER     User and group IDs (started in Linux 2.6.23 and completed in Linux 3.8)
UTS         CLONE_NEWUTS      Hostname and NIS domain name (since Linux 2.6.19)
æ³¨æ„ï¼š ç”±äºCgroup namespaceåœ¨4.6çš„å†…æ ¸ä¸­æ‰å®ç°ï¼Œå¹¶ä¸”å’Œcgroup v2å…³ç³»å¯†åˆ‡ï¼Œç°åœ¨æ™®åŠç¨‹åº¦è¿˜ä¸é«˜ï¼Œæ¯”å¦‚dockerç°åœ¨å°±è¿˜æ²¡æœ‰ç”¨å®ƒï¼Œæ‰€ä»¥åœ¨namespaceè¿™ä¸ªç³»åˆ—ä¸­ä¸ä¼šä»‹ç»Cgroup namespaceã€‚
<!-- more -->
æŸ¥çœ‹è¿›ç¨‹æ‰€å±çš„namespaces
ç³»ç»Ÿä¸­çš„æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰/proc/[pid]/ns/è¿™æ ·ä¸€ä¸ªç›®å½•ï¼Œé‡Œé¢åŒ…å«äº†è¿™ä¸ªè¿›ç¨‹æ‰€å±namespaceçš„ä¿¡æ¯ï¼Œé‡Œé¢æ¯ä¸ªæ–‡ä»¶çš„æè¿°ç¬¦éƒ½å¯ä»¥ç”¨æ¥ä½œä¸ºsetnså‡½æ•°(åé¢ä¼šä»‹ç»)çš„å‚æ•°ã€‚</p>

<p>#æŸ¥çœ‹å½“å‰bashè¿›ç¨‹æ‰€å±çš„namespace
dev@ubuntu:~$ ls -l /proc/$$/ns   <br />
total 0
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 cgroup -&gt; cgroup:[4026531835] #(since Linux 4.6)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 ipc -&gt; ipc:[4026531839]       #(since Linux 3.0)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 mnt -&gt; mnt:[4026531840]       #(since Linux 3.8)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 net -&gt; net:[4026531957]       #(since Linux 3.0)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 pid -&gt; pid:[4026531836]       #(since Linux 3.8)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 user -&gt; user:[4026531837]     #(since Linux 3.8)
lrwxrwxrwx 1 dev dev 0 7æœˆ 7 17:24 uts -&gt; uts:[4026531838]       #(since Linux 3.0)
ä¸Šé¢æ¯ç§ç±»å‹çš„namespaceéƒ½æ˜¯åœ¨ä¸åŒçš„Linuxç‰ˆæœ¬è¢«åŠ å…¥åˆ°/proc/[pid]/ns/ç›®å½•é‡Œå»çš„ï¼Œæ¯”å¦‚pid namespaceæ˜¯åœ¨Linux 3.8æ‰è¢«åŠ å…¥åˆ°/proc/[pid]/ns/é‡Œé¢ï¼Œä½†è¿™å¹¶ä¸æ˜¯è¯´åˆ°3.8æ‰æ”¯æŒpid namespaceï¼Œå…¶å®pid namespaceåœ¨2.6.24çš„æ—¶å€™å°±å·²ç»åŠ å…¥åˆ°å†…æ ¸äº†ï¼Œåœ¨é‚£ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨pid namespaceäº†ï¼Œåªæ˜¯æœ‰äº†/proc/[pid]/ns/pidä¹‹åï¼Œä½¿å¾—æ“ä½œpid namespaceæ›´æ–¹ä¾¿äº†</p>

<p>è™½ç„¶è¯´cgroupæ˜¯åœ¨Linux 4.6ç‰ˆæœ¬æ‰è¢«åŠ å…¥å†…æ ¸ï¼Œå¯æ˜¯åœ¨Ubuntu 16.04ä¸Šï¼Œå°½ç®¡å†…æ ¸ç‰ˆæœ¬æ‰4.4ï¼Œä½†ä¹Ÿæ”¯æŒcgroup namespaceï¼Œä¼°è®¡åº”è¯¥æ˜¯Ubuntuå°†4.6çš„cgroup namespaceè¿™éƒ¨åˆ†ä»£ç patchåˆ°äº†ä»–ä»¬çš„4.4å†…æ ¸ä¸Šã€‚</p>

<p>ä»¥ipc:[4026531839]ä¸ºä¾‹ï¼Œipcæ˜¯namespaceçš„ç±»å‹ï¼Œ4026531839æ˜¯inode numberï¼Œå¦‚æœä¸¤ä¸ªè¿›ç¨‹çš„ipc namespaceçš„inode numberä¸€æ ·ï¼Œè¯´æ˜ä»–ä»¬å±äºåŒä¸€ä¸ªnamespaceã€‚è¿™æ¡è§„åˆ™å¯¹å…¶ä»–ç±»å‹çš„namespaceä¹ŸåŒæ ·é€‚ç”¨ã€‚</p>

<p>ä»ä¸Šé¢çš„è¾“å‡ºå¯ä»¥çœ‹å‡ºï¼Œå¯¹äºæ¯ç§ç±»å‹çš„namespaceï¼Œè¿›ç¨‹éƒ½ä¼šä¸ä¸€ä¸ªnamespace IDå…³è”ã€‚</p>

<p>è·Ÿnamespaceç›¸å…³çš„API
å’Œnamespaceç›¸å…³çš„å‡½æ•°åªæœ‰ä¸‰ä¸ªï¼Œè¿™é‡Œç®€å•çš„çœ‹ä¸€ä¸‹ï¼Œåé¢ä»‹ç»UTS namespaceçš„æ—¶å€™ä¼šæœ‰è¯¦ç»†çš„ç¤ºä¾‹</p>

<p>cloneï¼š åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹å¹¶æŠŠä»–æ”¾åˆ°æ–°çš„namespaceä¸­
int clone(int (*child_func)(void *), void *child_stack
            , int flags, void *arg);</p>

<p>flagsï¼š 
    æŒ‡å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸Šé¢çš„CLONE_NEW*ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥åŒ…å«è·Ÿnamespaceæ— å…³çš„flagsï¼‰ï¼Œ 
    è¿™æ ·å°±ä¼šåˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªæ–°çš„ä¸åŒç±»å‹çš„namespaceï¼Œ 
    å¹¶æŠŠæ–°åˆ›å»ºçš„å­è¿›ç¨‹åŠ å…¥æ–°åˆ›å»ºçš„è¿™äº›namespaceä¸­ã€‚
setnsï¼š å°†å½“å‰è¿›ç¨‹åŠ å…¥åˆ°å·²æœ‰çš„namespaceä¸­
int setns(int fd, int nstype);</p>

<p>fdï¼š 
    æŒ‡å‘/proc/[pid]/ns/ç›®å½•é‡Œç›¸åº”namespaceå¯¹åº”çš„æ–‡ä»¶ï¼Œ
    è¡¨ç¤ºè¦åŠ å…¥å“ªä¸ªnamespace</p>

<p>nstypeï¼š
    æŒ‡å®šnamespaceçš„ç±»å‹ï¼ˆä¸Šé¢çš„ä»»æ„ä¸€ä¸ªCLONE_NEW*ï¼‰ï¼š
    1. å¦‚æœå½“å‰è¿›ç¨‹ä¸èƒ½æ ¹æ®fdå¾—åˆ°å®ƒçš„ç±»å‹ï¼Œå¦‚fdç”±å…¶ä»–è¿›ç¨‹åˆ›å»ºï¼Œ
    å¹¶é€šè¿‡UNIX domain socketä¼ ç»™å½“å‰è¿›ç¨‹ï¼Œ
    é‚£ä¹ˆå°±éœ€è¦é€šè¿‡nstypeæ¥æŒ‡å®šfdæŒ‡å‘çš„namespaceçš„ç±»å‹
    2. å¦‚æœè¿›ç¨‹èƒ½æ ¹æ®fdå¾—åˆ°namespaceç±»å‹ï¼Œæ¯”å¦‚è¿™ä¸ªfdæ˜¯ç”±å½“å‰è¿›ç¨‹æ‰“å¼€çš„ï¼Œ
    é‚£ä¹ˆnstypeè®¾ç½®ä¸º0å³å¯
unshare: ä½¿å½“å‰è¿›ç¨‹é€€å‡ºæŒ‡å®šç±»å‹çš„namespaceï¼Œå¹¶åŠ å…¥åˆ°æ–°åˆ›å»ºçš„namespaceï¼ˆç›¸å½“äºåˆ›å»ºå¹¶åŠ å…¥æ–°çš„namespaceï¼‰
int unshare(int flags);</p>

<p>flagsï¼š
    æŒ‡å®šä¸€ä¸ªæˆ–è€…å¤šä¸ªä¸Šé¢çš„CLONE_NEW*ï¼Œ
    è¿™æ ·å½“å‰è¿›ç¨‹å°±é€€å‡ºäº†å½“å‰æŒ‡å®šç±»å‹çš„namespaceå¹¶åŠ å…¥åˆ°æ–°åˆ›å»ºçš„namespace
cloneå’Œunshareçš„åŒºåˆ«
cloneå’Œunshareçš„åŠŸèƒ½éƒ½æ˜¯åˆ›å»ºå¹¶åŠ å…¥æ–°çš„namespaceï¼Œ ä»–ä»¬çš„åŒºåˆ«æ˜¯ï¼š</p>

<p>unshareæ˜¯ä½¿å½“å‰è¿›ç¨‹åŠ å…¥æ–°çš„namespace</p>

<p>cloneæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ï¼Œç„¶åè®©å­è¿›ç¨‹åŠ å…¥æ–°çš„namespaceï¼Œè€Œå½“å‰è¿›ç¨‹ä¿æŒä¸å˜</p>

<p>å…¶å®ƒ
å½“ä¸€ä¸ªnamespaceä¸­çš„æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºæ—¶ï¼Œè¯¥namespaceå°†ä¼šè¢«é”€æ¯ã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–æ–¹æ³•è®©namespaceä¸€ç›´å­˜åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè¿›ç¨‹å·ä¸º1000çš„è¿›ç¨‹ï¼Œä»¥ipc namespaceä¸ºä¾‹ï¼š</p>

<p>é€šè¿‡mount â€“bindå‘½ä»¤ã€‚ä¾‹å¦‚mount â€“bind /proc/1000/ns/ipc /other/fileï¼Œå°±ç®—å±äºè¿™ä¸ªipc namespaceçš„æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºäº†ï¼Œåªè¦/other/fileè¿˜åœ¨ï¼Œè¿™ä¸ªipc namespaceå°±ä¸€ç›´å­˜åœ¨ï¼Œå…¶ä»–è¿›ç¨‹å°±å¯ä»¥åˆ©ç”¨/other/fileï¼Œé€šè¿‡setnså‡½æ•°åŠ å…¥åˆ°è¿™ä¸ªnamespace</p>

<p>åœ¨å…¶ä»–namespaceçš„è¿›ç¨‹ä¸­æ‰“å¼€/proc/1000/ns/ipcæ–‡ä»¶ï¼Œå¹¶ä¸€ç›´æŒæœ‰è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸å…³é—­ï¼Œä»¥åå°±å¯ä»¥ç”¨setnså‡½æ•°åŠ å…¥è¿™ä¸ªnamespaceã€‚</p>

<p>ä½¿ç”¨setnsæ¨¡æ‹Ÿå°†æ–°ç¨‹åºè¿½åŠ åˆ°å·²æœ‰çš„pid namespaceä¸­, å‘ç°ä¸èµ·ä½œç”¨.</p>

<p>æˆ‘çš„æ­¥éª¤:</p>

<p>æ‰¾åˆ°å®¹å™¨, æŸ¥çœ‹å®ƒçš„ns</p>

<p>$ docker inspect 7caa18cb2657|grep -i pid
            â€œPidâ€: 13059,
            â€œPidModeâ€: â€œâ€,
            â€œPidsLimitâ€: 0,
$ sudo ls -l /proc/13059/ns
[sudo] chen çš„å¯†ç ï¼š
æ€»ç”¨é‡ 0
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 cgroup -&gt; cgroup:[4026531835]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 ipc -&gt; ipc:[4026532571]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 mnt -&gt; mnt:[4026532569]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:14 net -&gt; net:[4026532574]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 pid -&gt; pid:[4026532572]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 pid_for_children -&gt; pid:[4026532572]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:15 uts -&gt; uts:[4026532570]
æŸ¥çœ‹docker execçš„æ•ˆæœ</p>

<p>$ sudo ps -ef |grep /bin/sh
â€¦
chen     12941 11444  0 09:14 pts/2    00:00:00 docker run -it alpine /bin/sh
root     13059 13033  0 09:14 pts/0    00:00:00 /bin/sh
chen     14750 13127  0 09:23 pts/3    00:00:00 docker exec -it 7caa18cb2657 /bin/sh
root     14839 13033  0 09:23 pts/1    00:00:00 /bin/sh
â€¦
$ sudo ls -l /proc/14839/ns
æ€»ç”¨é‡ 0
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 cgroup -&gt; cgroup:[4026531835]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 ipc -&gt; ipc:[4026532571]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 mnt -&gt; mnt:[4026532569]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 net -&gt; net:[4026532574]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 pid -&gt; pid:[4026532572] // å’Œå®¹å™¨çš„pid namespaceä¸€è‡´
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 pid_for_children -&gt; pid:[4026532572]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:25 uts -&gt; uts:[4026532570]
ä½¿ç”¨setnsæ¨¡æ‹Ÿdocker exec
ä½¿ç”¨çš„setnsä»£ç :</p>

<p>#define _GNU_SOURCE
#include <fcntl.h>
#include <sched.h>
#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <errno.h></errno.h></string.h></stdio.h></stdlib.h></unistd.h></sched.h></fcntl.h></p>

<p>// å®ƒéœ€è¦ä¸¤ä¸ªå‚æ•°: argv[1]æ˜¯å½“å‰è¿›ç¨‹è¦åŠ å…¥çš„ Namespace æ–‡ä»¶çš„è·¯å¾„, è€Œargv[1]æ˜¯å°†è¦åœ¨è¿™ä¸ª Namespace é‡Œè¿è¡Œçš„è¿›ç¨‹
// è¿™æ®µä»£ç çš„çš„æ ¸å¿ƒæ“ä½œæ˜¯é€šè¿‡ open() ç³»ç»Ÿè°ƒç”¨æ‰“å¼€äº†æŒ‡å®šçš„ Namespace æ–‡ä»¶ï¼Œå¹¶æŠŠè¿™ä¸ªæ–‡ä»¶çš„æè¿°ç¬¦ fd äº¤ç»™ setns() ä½¿ç”¨. 
// åœ¨ setns() æ‰§è¡Œåï¼Œå½“å‰è¿›ç¨‹å°±åŠ å…¥äº†è¿™ä¸ªæ–‡ä»¶å¯¹åº”çš„ Linux Namespace ä¸­.
int main(int argc, char *argv[]) {
    int fd;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fprintf(stdout, "argv1: %s, argv2\n", argv[1],argv[2]);

fd = open(argv[1], O_RDONLY);
if (setns(fd, 0) == -1) {
    fprintf(stderr, "setns failed: %s\n", strerror(errno));
    return -1;
}

if (execvp(argv[2], &amp;argv[2]) != 0 ) {
    fprintf(stderr, "failed to execvp argments %s\n", strerror(errno));
    return -1;
  }

  printf("all done!\n");
  return 0; } æ‰§è¡ŒæŸ¥çœ‹æ•ˆæœ:
</code></pre></div></div>

<p>$ gcc -o setns setns.c
$ sudo ./setns /proc/13059/ns/pid /bin/bash
[sudo] chen çš„å¯†ç ï¼š
argv1: /proc/13059/ns/pid, argv2:/bin/bash
root@chen-pc:/home/chen/test#
åœ¨å¦ä¸€ä¸ªç»ˆç«¯æŸ¥çœ‹æ•ˆæœ:</p>

<p>$ sudo ps -ef |grep bin/bash
â€¦
root     16210 13790  0 09:40 pts/6    00:00:00 sudo ./setns /proc/13059/ns/pid /bin/bash
root     16240 16210  0 09:40 pts/6    00:00:00 /bin/bash
â€¦
$ sudo ls -l /proc/16240/ns
æ€»ç”¨é‡ 0
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 cgroup -&gt; cgroup:[4026531835]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 mnt -&gt; mnt:[4026531840]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 net -&gt; net:[4026531993]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 pid -&gt; pid:[4026531836] # å’Œå®¹å™¨çš„pid namespaceä¸€è‡´
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 pid_for_children -&gt; pid:[4026532572]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 user -&gt; user:[4026531837]
lrwxrwxrwx 1 root root 0 5æœˆ  28 09:43 uts -&gt; uts:[4026531838]
æœ€åå‘ç°setns.cæ¨¡æ‹Ÿç»“æœå’Œå®¹å™¨çš„pid namespaceä¸ä¸€è‡´, è¯·é—®è¿™æ˜¯æ€ä¹ˆå›äº‹?</p>

<p>æˆ‘ä¹Ÿç”¨sudo ./setns /proc/13059/ns/net /bin/bashæ¨¡æ‹Ÿè¿‡, å‘ç°å®¹å™¨é‡Œçš„ifconfigç»“æœä¸åœ¨æ¨¡æ‹Ÿä¸­è¿è¡Œçš„ç»“æœä¸€è‡´.</p>

<p>PID namespace æ¯”è¾ƒç‰¹æ®Š..å½“å‰è°ƒç”¨è€…æ‰€å±PID namespaceä¸èƒ½è¢«æ”¹å˜</p>

<p>ä½ å¯ä»¥å‚è€ƒä¸‹runcçš„åšæ³•ï¼Œç”¨å­è¿›ç¨‹åšè¿™ä¸ªäº‹.</p>

<p>1 æ¦‚è¿°
Linuxå®¹å™¨æŠ€æœ¯(LXC)è¿‘å‡ å¹´ååˆ†æµè¡Œï¼Œè€Œå…¶ä¾æ‰˜çš„æŠ€æœ¯å¹¶ä¸æ˜¯å¾ˆæ–°çš„ä¸œè¥¿ï¼Œè€Œæ˜¯Linuxå†…æ ¸è‡ªå¸¦çš„ä¸€å¥—å†…æ ¸çº§åˆ«ç¯å¢ƒéš”ç¦»æœºåˆ¶ã€‚å½“ç„¶ï¼Œæœ€æµè¡Œçš„LXCæŠ€æœ¯è«è¿‡äºdockeräº†ï¼Œç°åœ¨ç¤¾åŒºç‰ˆæœ¬æ›´åå«mobyäº†ã€‚ Linuxå®¹å™¨æŠ€æœ¯ä¾èµ–Linuxå†…æ ¸çš„3ä¸ªä¸»è¦çš„éš”ç¦»æœºåˆ¶ï¼šchrootï¼Œcgroupsï¼Œnamespaceã€‚å…ˆæ¥çœ‹çœ‹namespaceï¼Œåœ¨Linux Kernel3.8ä»¥åï¼ŒLinuxæ”¯æŒ6ç§namespaceã€‚åˆ†åˆ«æ˜¯ï¼š</p>

<p>namespace	éš”ç¦»å†…å®¹	flag
UTS	ä¸»æœºå	CLONE_NEWUTS
IPC	è¿›ç¨‹é—´é€šä¿¡	CLONE_NEWIPC
PID	chrootè¿›ç¨‹æ ‘	CLONE_NEWPID
NS(Mount)	æŒ‚è½½ç‚¹(mount points)	CLONE_NEWNS
NET	ç½‘ç»œè®¿é—®ï¼ŒåŒ…æ‹¬æ¥å£	CLONE_NEWNET
USER	å°†è™šæ‹Ÿçš„æœ¬åœ°UIDæ˜ å°„åˆ°çœŸå®çš„UID	CLONE_NEWUSER
Linuxå†…æ ¸æä¾›äº†ä¸€å¥—APIç”¨äºæ“ä½œnamespaceå®ç°ç¯å¢ƒéš”ç¦»ï¼Œç›®å‰namespaceæ“ä½œçš„APIåŒ…æ‹¬clone(), setns()ä»¥åŠunshare()ç­‰ã€‚é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿä¸€ä¸ªç±»ä¼¼å®¹å™¨çš„ç¯å¢ƒ(éš”ç¦»äº†PID namespaceï¼Œå¹¶æŒ‚è½½äº†procç›®å½•)ï¼Œä½ å¯ä»¥å‘ç°åªèƒ½çœ‹åˆ°bashå’Œshellä¸¤ä¸ªè¿›ç¨‹äº†ï¼Œè€Œä¸”PIDæ˜¯1å’Œ2ã€‚è€Œåœ¨åŸPID namespaceï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°bashè¿›ç¨‹çš„PIDåˆ™æ˜¯15011ã€‚ä¸ªä¸­ç¼˜ç”±ï¼Œä¸”æ…¢æ…¢é“æ¥ã€‚</p>

<p>root@ubuntu:/home/vagrant/nstest# sudo unshare â€“fork â€“pid â€“mount-proc bash
root@ubuntu:/home/vagrant/nstest# ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.0  0.0  29164  5876 pts/1    S    22:14   0:00 bash
root         2  0.0  0.0  24388  2592 pts/1    R+   22:14   0:00 ps aux</p>

<p>root@ubuntu:/home/vagrant/nstest# ps -ef|grep unshare
root     15011   952  0 22:14 pts/1    00:00:00 unshare â€“fork â€“pid â€“mount-proc bash
1.1 ä½¿ç”¨cloneåˆ›å»ºæ–°è¿›ç¨‹åŒæ—¶åˆ›å»ºnamespace
ä»£ç  ns.c ä»å­è¿›ç¨‹è¿è¡Œ /bin/bashï¼Œå…ˆä»è¿™ä¸ªä¾‹å­æ¥çœ‹çœ‹Linux namespaceçš„ä½œç”¨ï¼ˆä¸ºäº†ç®€å•èµ·è§ï¼Œç•¥å»äº†é”™è¯¯æ£€æŸ¥ä»£ç ï¼‰ã€‚</p>

<p>æ³¨æ„åˆ°åœ¨ä»£ç ä¸­ä½¿ç”¨äº†cloneæ¥ä»£æ›¿æ›´å¸¸è§çš„forkç³»ç»Ÿè°ƒç”¨ï¼Œcloneå®é™…ä¸Šæ˜¯Unixç³»ç»Ÿè°ƒç”¨forkçš„ä¸€ç§æ›´é€šç”¨çš„å®ç°æ–¹å¼ï¼Œå®ƒçš„åŸå‹æ˜¯è¿™æ ·çš„</p>

<p>int clone(int (<em>child_func)(void *), void *child_stack, int flags, void *arg);
child_funcå‚æ•°ä¸ºä¼ é€’å­è¿›ç¨‹è¿è¡Œçš„ä¸»å‡½æ•°ï¼Œå¦‚ns.cä¸­çš„child_mainï¼›child_stackå‚æ•°ä¸ºå­è¿›ç¨‹ä½¿ç”¨çš„æ ˆç©ºé—´ï¼Œå‚æ•°flagså¯ä»¥æŒ‡å®šä½¿ç”¨çš„CLONE_</em>æ ‡å¿—ï¼Œä¸€æ¬¡å¯ä»¥æŒ‡å®šå¤šä¸ªflagï¼›è€Œargsåˆ™æ˜¯å­è¿›ç¨‹çš„å‚æ•°ã€‚ç¼–è¯‘è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿è¡Œæ­£å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬å¾ˆéš¾åŒºåˆ†è¿™æ˜¯åœ¨å­è¿›ç¨‹è¿è¡Œçš„/bin/bashè¿˜æ˜¯æœ¬èº«çš„/bin/bashã€‚</p>

<p>root@ubuntu:/home/vagrant/nstest# gcc -Wall ns.c -o ns &amp;&amp; ./ns</p>
<ul>
  <li>Hello ?</li>
  <li>World !
root@ubuntu:/home/vagrant/nstest#  #inside container
root@ubuntu:/home/vagrant/nstest# exit
root@ubuntu:/home/vagrant/nstest#  #outside container
äºæ˜¯ï¼ŒCLONE_NEWUTSå¯ä»¥æ´¾ä¸Šç”¨åœºäº†ã€‚UTS namespaceæä¾›äº†ä¸»æœºåå’ŒåŸŸåçš„éš”ç¦»ï¼Œè¿™æ ·æ¯ä¸ªå®¹å™¨å°±æœ‰ç‹¬ç«‹çš„ä¸»æœºåå’ŒåŸŸåï¼Œä»è€Œå¯ä»¥åœ¨ç½‘ç»œä¸Šè¢«å½“ä½œä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹è€Œä¸æ˜¯å®¿ä¸»æœºçš„ä¸€ä¸ªè¿›ç¨‹ã€‚ä¿®æ”¹cloneå‡½æ•°è¿™è¡Œä»£ç ï¼ŒåŠ å…¥CLONE_NEWUTSçš„flagï¼Œç„¶ååœ¨å­è¿›ç¨‹ä¸­è°ƒç”¨sethostnameå‡½æ•°ï¼Œä¿®æ”¹åä»£ç  ns_uts.cã€‚</li>
</ul>

<p>ä»¥rootèº«ä»½è¿è¡Œå®ƒ</p>

<p>root@ubuntu:/home/vagrant/nstest# gcc -Wall ns_uts.c -o ns_uts &amp;&amp; ./ns_uts</p>
<ul>
  <li>Hello ?</li>
  <li>World !
root@In Namespace:/home/vagrant/nstest#  #inside container
root@In Namespace:/home/vagrant/nstest# exit
root@ubuntu:/home/vagrant/nstest#        #outside container
å¯ä»¥çœ‹åˆ°ï¼Œåœ¨å­è¿›ç¨‹ä¸­hostnameå˜æˆäº†In Namespaceï¼Œè€Œçˆ¶è¿›ç¨‹çš„hostnameä¸ºubuntuä¸å—å­è¿›ç¨‹ä¿®æ”¹hostnameçš„å½±å“ï¼Œé€šè¿‡CLONE_NEWUTSå®ç°äº†ä¸»æœºåçš„éš”ç¦»ã€‚æ³¨æ„ï¼Œå¦‚æœä¸åŠ CLONE_NEWUTSæ ‡è®°è¿è¡Œï¼Œä¼šå‘ç°é€€å‡ºå­è¿›ç¨‹åhostnameä¹Ÿè¿˜åŸäº†ï¼Œè¿™æ˜¯å› ä¸ºbashåªåœ¨ç™»å½•çš„æ—¶å€™è¯»å–ä¸€æ¬¡UTSï¼Œç­‰ä½ é‡æ–°ç™»é™†å°±ä¼šå‘ç°hostnameå˜äº†ã€‚å› æ­¤ï¼Œä¸ºäº†hostnameéš”ç¦»ï¼ŒåŠ ä¸ŠCLONE_NEWUTSæ ‡å¿—ã€‚</li>
</ul>

<p>dockerå®¹å™¨çš„hostnameä¹Ÿæ˜¯é€šè¿‡è¯¥æœºåˆ¶å®ç°çš„éš”ç¦»ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰è‡ªå·±çš„hostnameï¼ˆé»˜è®¤æ˜¯å®¹å™¨IDï¼‰ï¼Œå¹¶ä¸ä¼šå¯¹å®¿ä¸»æœºçš„hostnameäº§ç”Ÿä»»ä½•å½±å“ã€‚</p>

<p>root@ubuntu:/home/ssj# docker exec -it ssjtestnew /bin/bash
root@c9df3369e321:/# hostname
c9df3369e321
1.2 /proc/PID/nsæ–‡ä»¶
ä»/proc/PID/nsç›®å½•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªè¿›ç¨‹çš„namespaceã€‚æ¯”å¦‚æˆ‘ä»¬è¿è¡Œä¸Šé¢çš„ ./nsï¼Œå¹¶æŸ¥çœ‹çˆ¶å­è¿›ç¨‹çš„namespaceï¼Œç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°nså’Œå­è¿›ç¨‹bashçš„nsç›®å½•ä¸­ï¼Œé™¤äº†UTS namespaceæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¡¨æ˜è¿™ä¸¤ä¸ªè¿›ç¨‹åœ¨ä¸åŒçš„UTSåå­—ç©ºé—´ï¼Œå…¶ä»–5ä¸ªnamespaceæ˜¯ç›¸åŒçš„ã€‚/proc/PID/nsç›®å½•ä¸­çš„ä¸ºç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘çš„æ˜¯å¯¹åº”namespaceçš„åå­—ï¼Œåå­—å‘½åè§„åˆ™æ˜¯namespaceç±»å‹+inodeæ•°å­—ï¼Œå¦‚ipc:[4026531839]ã€‚</p>

<p>root@ubuntu:/home/vagrant# ps -ef 
root      3086  2741  0 02:46 pts/0    00:00:00 ./ns
root      3087  3086  0 02:46 pts/0    00:00:00 /bin/bash
root@ubuntu:/home/vagrant# ls -ls /proc/3086/ns/
total 0
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 ipc -&gt; ipc:[4026531839]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 mnt -&gt; mnt:[4026531840]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 net -&gt; net:[4026531956]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 pid -&gt; pid:[4026531836]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 user -&gt; user:[4026531837]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 uts -&gt; uts:[4026531838]
root@ubuntu:/home/vagrant# ls -ls /proc/3087/ns/ 
total 0
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 ipc -&gt; ipc:[4026531839]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 mnt -&gt; mnt:[4026531840]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 net -&gt; net:[4026531956]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 pid -&gt; pid:[4026531836]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 user -&gt; user:[4026531837]
0 lrwxrwxrwx 1 root root 0 Aug 16 02:47 uts -&gt; uts:[4026532182]
root@ubuntu:/home/vagrant# readlink /proc/3086/ns/uts # show parent UTS namespace
uts:[4026531838]
root@ubuntu:/home/vagrant# readlink /proc/3087/ns/uts # show child UTS namespace
uts:[4026532182]
root@ubuntu:/home/vagrant# touch ~/uts
root@ubuntu:/home/vagrant# mount â€“bind /proc/3087/ns/uts ~/uts</p>

<p>å½“ç„¶namespaceè¿˜æœ‰å…¶ä»–çš„ç”¨å¤„ï¼Œåªè¦namespaceçš„æ–‡ä»¶æè¿°ç¬¦æ˜¯æ‰“å¼€çš„ï¼Œå³ä¾¿è¯¥namespaceæ‰€æœ‰è¿›ç¨‹éƒ½ç»ˆæ­¢äº†ï¼Œè¯¥namespaceè¿˜æ˜¯ä¾æ—§å­˜åœ¨ã€‚æˆ‘ä»¬å¦‚æœç›´æ¥é€€å‡ºç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°è¿›ç¨‹é€€å‡ºå/proc/PIDç›®å½•ä¼šæ•´ä¸ªåˆ æ‰ï¼ŒåŒ…æ‹¬nsç›®å½•ã€‚äºæ˜¯ï¼Œä¸ºäº†ä¿å­˜å­è¿›ç¨‹çš„UTS namespaceï¼Œæˆ‘ä»¬ç”¨mountå‘½ä»¤å…ˆæŒ‚è½½è¯¥namespaceï¼Œç¨åæˆ‘ä»¬ä¼šç”¨setns()å°†è¿›ç¨‹åŠ å…¥åˆ°è¯¥UTS namespaceã€‚</p>

<p>mount â€“bind /proc/3087/ns/uts ~/uts
1.3 åŠ å…¥å·²ç»å­˜åœ¨çš„namespaceï¼šsetns()
é€šè¿‡setnså’Œexecveå¯ä»¥è®©ä¸€ä¸ªè¿›ç¨‹åŠ å…¥ä¸€ä¸ªå·²ç»å­˜åœ¨çš„namespaceå¹¶åœ¨é‚£ä¸ªnamespaceæ‰§è¡Œå‘½ä»¤ã€‚æµ‹è¯•ä»£ç  ns_setns.cï¼Œè¿™é‡Œç”¨åˆ°ä¸Šä¸€èŠ‚ä¸­ä¿ç•™çš„UTS namespaceã€‚</p>

<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>

<p>root@ubuntu:/home/vagrant/nstest# gcc -o ns_setns ns_setns.c 
root@ubuntu:/home/vagrant/nstest# ./ns_setns ~/uts /bin/bash 
root@In Namespace:/home/vagrant/nstest# echo $$  ## show pid
3375
root@In Namespace:/home/vagrant/nstest# hostname
In Namespace
root@In Namespace:/home/vagrant/nstest# readlink /proc/3375/ns/
ipc   mnt   net   pid   user  uts <br />
root@In Namespace:/home/vagrant/nstest# readlink /proc/3375/ns/uts 
uts:[4026532182]
å¯ä»¥çœ‹åˆ°è¯¥è¿›ç¨‹çš„UTS namespaceä¸ºæˆ‘ä»¬æŒ‡å®šçš„ä¹‹å‰ä¿ç•™çš„child processçš„UTS namespaceã€‚</p>

<p>1.4 éš”ç¦»ä¸€ä¸ªnamespaceï¼šunshare()
unshareå‡½æ•°å¯ä»¥è®©è¿›ç¨‹è„±ç¦»ä¸€ä¸ªnamespaceï¼Œå®ƒä¸cloneç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼Œunshareä¸éœ€è¦åˆ›å»ºæ–°çš„è¿›ç¨‹ï¼Œè€Œæ˜¯åœ¨å½“å‰è¿›ç¨‹ç›´æ¥éš”ç¦»namespaceã€‚</p>

<p>æµ‹è¯•ä»£ç  ns_unshare.c ï¼Œè¿è¡Œä¹‹ï¼Œåœ¨å‚æ•°ä¸­æˆ‘ä»¬ä¼ é€’-mç”¨æ¥éš”ç¦»NS namespaceï¼ˆå³æŒ‚è½½ç‚¹çš„namespaceï¼‰ï¼Œç»“æœå¯ä»¥çœ‹åˆ°åœ¨æ–°çš„NS namespaceçš„shellè¿›ç¨‹ä¸­umountäº†ä¸€ä¸ªç›®å½•/run/lockï¼Œå¹¶ä¸å½±å“è€çš„shellè¿›ç¨‹çš„æŒ‚è½½ç‚¹ã€‚</p>

<p>root@ubuntu:/home/vagrant/nstest# echo \(#Show pid of shell
4434
root@ubuntu:/home/vagrant/nstest# readlink /proc/4434/ns/mnt     # Show shell NS namespace id
mnt:[4026532183]
root@ubuntu:/home/vagrant/nstest# cat /proc/4434/mounts|grep '/run/lock'
none /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
root@ubuntu:/home/vagrant/nstest# ./ns_unshare -m /bin/bash        #Start new shell in separate mount namespace
hello, pid=4927
root@ubuntu:/home/vagrant/nstest# echo\)
4927
root@ubuntu:/home/vagrant/nstest# readlink /proc/4927/ns/mnt   #Show mount namespace ID in new shell
mnt:[4026532184]
root@ubuntu:/home/vagrant/nstest# cat /proc/4927/mounts|grep â€˜run/lockâ€™
none /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
root@ubuntu:/home/vagrant/nstest# umount /run/lock    #Umount dir in separate mount namespace
root@ubuntu:/home/vagrant/nstest# cat /proc/4927/mounts|grep â€˜run/lockâ€™
root@ubuntu:/home/vagrant/nstest# exit
root@ubuntu:/home/vagrant/nstest# cat /proc/4434/mounts|grep â€˜/run/lockâ€™  #Old shell not affected
none /run/lock tmpfs rw,nosuid,nodev,noexec,relatime,size=5120k 0 0
è‡³æ­¤ï¼Œnamespaceæ“ä½œçš„ç›¸å…³APIå‡½æ•°å·²ç»éƒ½è¯´å®Œäº†ï¼Œæ¥ä¸‹æ¥åˆ†åˆ«çœ‹çœ‹è¿™6ä¸ªnamespaceã€‚</p>

<p>2 UTS Namespace
UTSæ˜¯å®ç°ä¸»æœºåå’ŒåŸŸåçš„éš”ç¦»ï¼Œåœ¨ç¬¬ä¸€èŠ‚ä¸­å·²ç»è¯´è¿‡ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>

<p>3 IPC Namespace
IPCæŒ‡Unix/Linuxä¸‹è¿›ç¨‹é—´é€šä¿¡çš„æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡å…±äº«å†…å­˜ï¼Œä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç®¡é“ç­‰æ–¹æ³•å®ç°ã€‚è¿™é‡Œæˆ‘ä»¬è¦éš”ç¦»IPC namespaceï¼Œå®ç°æ–¹å¼ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨cloneå‡½æ•°çš„flagså‚æ•°ä¸­åŠ å…¥CLONE_NEWIPCå³å¯ï¼Œè¿™æ ·ä½ å¯ä»¥åœ¨æ–°çš„namespaceä¸­åˆ›å»ºIPCï¼Œç”šè‡³æ˜¯å‘½åä¸€ä¸ªï¼Œå¹¶ä¸ä¼šæœ‰ä¸å…¶ä»–åº”ç”¨å†²çªçš„é£é™©ã€‚</p>

<p>æˆ‘ä»¬åœ¨æœ€åˆçš„å®ä¾‹ä»£ç ns.cä¸­ä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ å…¥CLONE_NEWIPCçš„flagã€‚ä¿®æ”¹çš„ä»£ç åªæœ‰ä¸€è¡Œï¼Œå¦‚ä¸‹ã€‚å½“ç„¶è¿™é‡Œçš„CLONE_NEWUTSä¸æ˜¯å¿…é¡»çš„ï¼Œä¿ç•™è¿™ä¸ªflagåªæ˜¯ä¸ºäº†æ›´åŠ æ–¹ä¾¿çš„æ˜¾ç¤ºæ•ˆæœã€‚</p>

<p>/*
ns_ipc.c: used to test ipc
*/
[â€¦]
int child_pid = clone(child_main, child_stack+STACK_SIZE,
      CLONE_NEWUTS | CLONE_NEWIPC| SIGCHLD, NULL);
[â€¦]
å…ˆé€šè¿‡ipcmk -Qåˆ›å»ºä¸€ä¸ªIPCé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—IDä¸º65536ï¼Œç„¶åè¿è¡Œ./ns_ipcï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ–°çš„namespaceä¸­å¹¶æ²¡æœ‰è¯¥IPCé˜Ÿåˆ—ï¼Œåšåˆ°äº†IPCéš”ç¦»ã€‚</p>

<p>root@ubuntu:/home/vagrant/nstest# ipcmk -Q 
Message queue id: 65536
root@ubuntu:/home/vagrant/nstest# ipcs -q</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0a3817cf 65536      root       644        0            0</p>

<p>root@ubuntu:/home/vagrant/nstest# ./ns_ipc</p>
<ul>
  <li>Hello ?</li>
  <li>World !
root@In Namespace:/home/vagrant/nstest# ipcs -q</li>
</ul>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages</p>

<p>root@In Namespace:/home/vagrant/nstest# exit
root@ubuntu:/home/vagrant/nstest# ipcs -q</p>

<p>â€”â€” Message Queues â€”â€”â€“
key        msqid      owner      perms      used-bytes   messages  <br />
0x0a3817cf 65536      root       644        0            0 <br />
æ¥ä¸‹æ¥å¯èƒ½æœ‰äººè¦é—®äº†ï¼Œé‚£è¿™ç§çˆ¶å­è¿›ç¨‹åœ¨ä¸åŒçš„IPC namespaceäº†ï¼Œå®ƒä»¬ä¹‹é—´æ€ä¹ˆé€šä¿¡å‘¢ï¼Ÿå‰é¢è¯´è¿‡ï¼Œè¿›ç¨‹é—´é€šä¿¡æœ‰ä¿¡å·é‡ï¼Œå…±äº«å†…å­˜ï¼Œç®¡é“ï¼ŒFIFOï¼Œsocketsç­‰ã€‚ç”±äºä¸Šä¸‹æ–‡çš„æ”¹å˜ï¼Œä½¿ç”¨ä¿¡å·é‡ä¹Ÿè®¸ä¸æ˜¯æœ€ä½³æ–¹æ¡ˆã€‚è€Œä½¿ç”¨å…±äº«å†…å­˜åˆ™æœ‰æ•ˆç‡ä¸Šçš„é—®é¢˜ï¼Œå¦‚æœä¸éš”ç¦»ç½‘ç»œæ ˆçš„è¯ä¹Ÿå¯ä»¥ç”¨socketsï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨è¦ä¸€æ­¥æ­¥éš”ç¦»ä¸€åˆ‡ï¼Œå› æ­¤socketsä¹Ÿä¸åˆé€‚ã€‚FIFOåˆ™å¯ä»¥ç”¨äºä»»æ„è¿›ç¨‹é—´çš„é€šä¿¡ï¼ŒFIFOæ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ç±»å‹ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­æ˜¯æœ‰å¯¹åº”è·¯å¾„çš„ï¼Œå®ƒçš„é—®é¢˜ä¹Ÿä¸socketsç±»ä¼¼ï¼Œå› ä¸ºæˆ‘ä»¬è¦éš”ç¦»æ–‡ä»¶ç³»ç»Ÿçš„è¯ï¼Œå®ƒä¹Ÿä¸åˆé€‚ã€‚ç®¡é“ç”¨äºæœ‰äº²å±å…³ç³»çš„è¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œæ¯”å¦‚çˆ¶å­è¿›ç¨‹æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´é€šä¿¡ï¼Œå¾ˆé€‚åˆä¸åŒnamespaceçš„è¿›ç¨‹é€šä¿¡ã€‚</p>

<p>ä½¿ç”¨ç®¡é“å®ç°ä¸åŒnamespaceä¹‹é—´è¿›ç¨‹é€šä¿¡çš„ç¤ºä¾‹ä»£ç  ns_ipc.cï¼Œè¿è¡Œä¹‹ï¼Œå¯ä»¥çœ‹åˆ°ä½äºä¸åŒnamespaceçš„çˆ¶å­è¿›ç¨‹ç¡®å®é€šä¿¡æˆåŠŸäº†ã€‚</p>

<p>root@ubuntu:/home/vagrant/nstest# ./ns_ipc</p>
<ul>
  <li>Hello ?</li>
  <li>World !
root@In Namespace:/home/vagrant/nstest# exit
root@ubuntu:/home/vagrant/nstest# 
4 PID Namespace
å®ç°PIDéš”ç¦»åŠ ä¸ŠCLONE_NEWPIDæ ‡è¯†å³å¯ã€‚ç¤ºä¾‹ä»£ç  ns_pid.c ï¼Œè¿è¡Œä¹‹ï¼š</li>
</ul>

<p>root@ubuntu:/home/vagrant/nstest# ./ns_pid</p>
<ul>
  <li>[ 7627] Hello ?</li>
  <li>[    1] World !
root@In Namespace:/home/vagrant/nstest# echo $$    ##In new PID namespace
1
root@In Namespace:/home/vagrant/nstest# kill -KILL 7627
bash: kill: (7627) - No such process</li>
</ul>

<p>###host ps view
root@ubuntu:/home/vagrant/nstest# ps -ef|grep 7627
root      7627  2768  0 04:40 pts/1    00:00:00 ./pid
root      7628  7627  0 04:40 pts/1    00:00:00 /bin/bash
å¯ä»¥çœ‹åˆ°åœ¨ä¸åŒPID namespaceä¸­è¿è¡Œçš„/bin/bashçš„PIDä¸º1ã€‚è€Œå®ƒçš„çˆ¶è¿›ç¨‹çš„PIDæ˜¯7627ã€‚è€Œåœ¨çˆ¶è¿›ç¨‹namespaceä¸­ï¼Œå¯ä»¥çœ‹åˆ°/bin/bashçš„è¿›ç¨‹ä¸º7268ã€‚å¦‚æœä½ è¯•å›¾åœ¨æ–°çš„Namespaceä¸­å»killæŸä¸ªä¸åŒnamespaceä¸­çš„è¿›ç¨‹ï¼Œåˆ™ä¼šæŠ¥é”™æç¤ºè¿›ç¨‹ä¸å­˜åœ¨ï¼Œè¾¾åˆ°äº†è¿›ç¨‹éš”ç¦»çš„ç›®çš„ã€‚</p>

<p>è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™ä½ åœ¨æ–°çš„namespaceä¸­ç”¨psï¼Œtopç­‰å‘½ä»¤å»æŸ¥çœ‹ï¼Œä¼šå‘ç°7627è¿™ä¸ªè¿›ç¨‹æ˜¯å¯è§çš„ã€‚è¿™ä¸æˆ‘ä»¬åœ¨dockerå®¹å™¨ä¸­çœ‹åˆ°çš„ä¸ä¸€è‡´ï¼Œå¦‚åœ¨æˆ‘åˆ›å»ºçš„ä¸€ä¸ªrediså®¹å™¨ä¸­ï¼Œç”¨ps, topå…¶å®æ˜¯åªçœ‹å¾—åˆ°å®¹å™¨æ‰€åœ¨namespaceçš„è¿›ç¨‹çš„ã€‚</p>

<p>root@ubuntu:/home/ssj# docker exec -it redistest /bin/bash</p>

<p>root@0b86fb961783:/data# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
redis        1     0  0 02:44 ?        00:00:00 redis-server *:6379
root        18     0  0 02:45 ?        00:00:00 /bin/bash
root        25    18  0 02:45 ?        00:00:00 ps -ef
è¿™æ˜¯å› ä¸ºpså‘½ä»¤è¯»å–çš„æ˜¯/procæ–‡ä»¶ç³»ç»Ÿè·å–çš„ä¿¡æ¯ï¼Œè€Œæ–‡ä»¶ç³»ç»Ÿæˆ‘ä»¬è¿˜æ²¡æœ‰éš”ç¦»ï¼Œæ‰€ä»¥åœ¨æ–°çš„namespaceä¸­å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šç”¨NS namespaceæ¥å®ç°è¿™ä¸ªéš”ç¦»ã€‚</p>

<p>5 NS Namespace
NS namespaceä¹Ÿå°±æ˜¯æŒ‚è½½ç‚¹ç›¸å…³çš„äº†ï¼Œåœ¨ç¬¬4èŠ‚çš„ä»£ç åŸºç¡€ä¸ŠåŠ å…¥CLONE_NEWNSçš„flagï¼Œå¹¶åœ¨å­è¿›ç¨‹æŒ‚è½½ /procç›®å½•ã€‚ä¿®æ”¹ååˆ›å»ºè¿›ç¨‹çš„ä»£ç  ns_ns.c, è¿è¡Œä¹‹:</p>

<p>root@ubuntu:/home/vagrant/nstest# ./ns_ns</p>
<ul>
  <li>[27137] Hello ?</li>
  <li>[    1] World !
root@In Namespace:/home/vagrant/nstest# ps -ef
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 20:37 pts/0    00:00:00 /bin/bash
root         3     1  0 20:39 pts/0    00:00:00 ps -ef
root@In Namespace:/home/vagrant/nstest# ls /proc/
1      bus       cpuinfo    dma      filesystems  ioports   kcore      kpagecount  meminfo  mpt       partitions   softirqs  sysrq-trigger  tty      vmstat
5      cgroups   crypto driver       fs       ipmi      keys       kpageflags  misc     mtrr      sched_debug  stat  sysvipc    uptime       zoneinfo
acpi       cmdline   devices    execdomains  interrupts   irq       key-users  loadavg     modules  net       self         swaps     timer_list version
buddyinfo  consoles  diskstats  fb       iomem    kallsyms  kmsg       locks       mounts   pagetypeinfo  slabinfo     sys   timer_stats    vmallocinfo
å¯ä»¥çœ‹åˆ°pså‘½ä»¤ç¡®å®åªæ˜¾ç¤ºäº†å½“å‰namespaceä¸‹é¢çš„è¿›ç¨‹äº†ï¼Œè€Œä¸”ls /proc/å‘½ä»¤æŸ¥çœ‹å‘ç°/procç›®å½•ä¸‹é¢çš„å†…å®¹ä¹Ÿæ¸…çˆ½å¤šäº†ã€‚dockerä½¿ç”¨NS namespaceå®ç°äº†ä¸€äº›æ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ï¼ŒåŸç†ä¸è¿™ä¸ªç±»ä¼¼ï¼Œç»“åˆchdirå’Œchrootå¯ä»¥å®ç°ä¸€ä¸ªå±±å¯¨çš„dockeré•œåƒã€‚</li>
</ul>

<p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å†æ¥çœ‹çœ‹dockerä¸­PIDå’ŒNS namespaceå…·ä½“çš„å®ç°(æˆ‘çš„dockerç‰ˆæœ¬æ˜¯1.13.1ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€ä¸åŒ)ï¼Œæˆ‘è¿™é‡Œåœ¨å®¿ä¸»æœºèµ·äº†ä¸€ä¸ªrediså®¹å™¨åä¸ºredistestï¼Œé€šè¿‡pstreeå¯ä»¥çœ‹åˆ°è¿›ç¨‹å…³ç³»å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    |-dockerd-+-docker-containerd-+-docker-containerd-shim-+-redis-server---3*[{redis-server}]
    |         |                 |                 `-8*[{docker-containe}]
    |         |                 `-12*[{docker-containe}]
    |         `-19*[{dockerd}] è¿™é‡Œå¯¹åº”è¿›ç¨‹å…³ç³»å°±æ˜¯ï¼š
</code></pre></div></div>

<p>dockerdè¿›ç¨‹åˆ›å»ºäº†ä¸€ä¸ªdocker-containerdå­è¿›ç¨‹ï¼Œè€Œdocker-contianerdå­è¿›ç¨‹å†åˆ›å»ºå­è¿›ç¨‹docker-containerd-shimï¼Œä¹Ÿå°±æ˜¯å¯¹åº”å…·ä½“å®¹å™¨çš„è¿›ç¨‹ã€‚
å®¹å™¨è¿›ç¨‹docker-containerd-shimåˆ›å»ºå®¹å™¨é‡Œé¢çš„1å·è¿›ç¨‹redis-serverã€‚
é€šè¿‡æŸ¥çœ‹/proc/PID/nsç›®å½•å°±å¯ä»¥å‘ç°ï¼Œdockerdï¼Œdockerd-containerdä»¥åŠdockerd-containerd-shimçš„namespaceéƒ½æ˜¯ä¸€æ ·çš„ï¼Œè€Œå®¹å™¨é‡Œé¢çš„1å·è¿›ç¨‹ redis-serverçš„namespaceé™¤äº†User namespaceå¤–ï¼Œå…¶ä»–çš„namespaceéƒ½å·²ç»ä¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»å®¹å™¨é‡Œé¢çš„1å·è¿›ç¨‹å¼€å§‹ï¼Œè¿›ç¨‹çš„namespaceå¼€å§‹éš”ç¦»ã€‚
å¦å¤–æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œå½“ä½ ä½¿ç”¨ docker exec -it redistest /bin/bashå‘½ä»¤è¿›å…¥å®¹å™¨çš„æ—¶å€™ï¼Œè¿™ä¸ª/bin/bashè¿›ç¨‹çš„çˆ¶è¿›ç¨‹å…¶å®æ˜¯å¦å¤–ä¸€ä¸ª docker-containerd-shimè¿›ç¨‹ï¼Œåªæ˜¯/bin/bashè¿›ç¨‹çš„namespaceå’Œredis-serverè¿›ç¨‹ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ä½ åœ¨redistestå®¹å™¨ä¸­ps -efï¼Œå¯ä»¥çœ‹åˆ°é™¤äº†redis-serverè¿›ç¨‹å¤–ï¼Œè¿˜æœ‰/bin/bashè¿›ç¨‹ã€‚é€šè¿‡execå‘½ä»¤è¿›å…¥å®¹å™¨åï¼Œå†æ¥çœ‹è¿›ç¨‹å…³ç³»ï¼Œæ˜¯ä¸‹é¢è¿™æ ·çš„:
       |-dockerd-+-docker-containerd-+-docker-containerd-shim-+-redis-serverâ€”3<em>[{redis-server}]
        |         |                  |                 <code class="language-plaintext highlighter-rouge">-8*[{docker-containe}]
        |         |                  |-docker-containerd-shim-+-bash
        |         |                  |                 </code>-8</em>[{docker-containe}]
        |         |                  <code class="language-plaintext highlighter-rouge">-12*[{docker-containe}]
        |         </code>-19*[{dockerd}]
è€Œåœ¨å®¹å™¨åœ¨è‡ªå·±çš„NS namespaceä¸­æŒ‚è½½äº†å¾ˆå¤šç›®å½•ï¼Œå¦‚ä¸‹é¢è¿™äº›ï¼š</p>

<p>/dev/sda8 on /etc/resolv.conf type ext4 (rw,relatime,data=ordered)
/dev/sda8 on /etc/hostname type ext4 (rw,relatime,data=ordered)
/dev/sda8 on /etc/hosts type ext4 (rw,relatime,data=ordered)
â€¦
proc on /proc/irq type proc (ro,nosuid,nodev,noexec,relatime)
proc on /proc/sys type proc (ro,nosuid,nodev,noexec,relatime)
6 NET Namespace
NET namespaceæ˜¯æŒ‡ç½‘ç»œä¸Šçš„éš”ç¦»ï¼Œé€šè¿‡åŠ å…¥CLONE_NEWNETæ¥å®ç°ã€‚åœ¨è®¨è®ºè¿™ä¸ªä¹‹å‰ï¼Œå¯ä»¥å…ˆçœ‹çœ‹é€šè¿‡ipå‘½ä»¤å¦‚ä½•æ‰‹åŠ¨åˆ›å»ºnetwork namespaceä»¥åŠvethè®¾å¤‡ç­‰ã€‚vethä¸»è¦çš„ç›®çš„æ˜¯ä¸ºäº†è·¨NET namespaceä¹‹é—´æä¾›ä¸€ç§ç±»ä¼¼äºLinuxè¿›ç¨‹é—´é€šä¿¡çš„æŠ€æœ¯ï¼Œæ‰€ä»¥vethæ€»æ˜¯æˆå¯¹å‡ºç°ï¼Œå¦‚ä¸‹é¢çš„veth0å’Œveth1ã€‚å®ƒä»¬ä½äºä¸åŒçš„NET namespaceä¸­ï¼Œåœ¨vethè®¾å¤‡ä»»æ„ä¸€ç«¯æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œéƒ½ä¼šä»å¦ä¸€ç«¯å‘é€å‡ºå»ã€‚vethå·¥ä½œåœ¨L2æ•°æ®é“¾è·¯å±‚ï¼Œåªè´Ÿè´£æ•°æ®ä¼ è¾“ï¼Œä¸ä¼šæ›´æ”¹æ•°æ®åŒ…ã€‚</p>

<h1 id="create-a-demo-namespace">Create a â€œdemoâ€ namespace</h1>
<p>ip netns add demo</p>

<h1 id="create-a-veth-pair">create a â€œvethâ€ pair</h1>
<p>ip link add veth0 type veth peer name veth1</p>

<h1 id="and-move-one-to-the-namespace">and move one to the namespace</h1>
<p>ip link set veth1 netns demo</p>

<h1 id="configure-the-interfaces-up--ip">configure the interfaces (up + IP)</h1>
<p>ip netns exec demo ip link set lo up
ip netns exec demo ip link set veth1 up
ip netns exec demo ip addr add 169.254.1.2/30 dev veth1
ip link set veth0 up
ip addr add 169.254.1.1/30 dev veth0
æ‰§è¡Œå®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å®¿ä¸»æœºé‡Œé¢çœ‹åˆ°ç½‘ç»œè®¾å¤‡æ˜¯è¿™æ ·çš„:</p>

<p>root@ubuntu:/home/vagrant# ip -d link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:ec:df:9c brd ff:ff:ff:ff:ff:ff promiscuity 0 
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:57:25:68 brd ff:ff:ff:ff:ff:ff promiscuity 0 
5: veth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 62:14:fd:45:f8:0e brd ff:ff:ff:ff:ff:ff promiscuity 0 
    veth 
root@ubuntu:/home/vagrant# ethtool -S veth0
NIC statistics:
     peer_ifindex: 4
è€Œåœ¨demoè¿™ä¸ªNET namespaceä¸­ï¼Œçœ‹åˆ°çš„ç½‘ç»œè®¾å¤‡æ˜¯è¿™æ ·çš„ï¼š</p>

<p>root@ubuntu:/home/vagrant# ip netns exec demo ip -d link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 
4: veth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 6a:7d:49:3f:bc:8e brd ff:ff:ff:ff:ff:ff promiscuity 0 
    veth 
è¿™ä¸ªåŸç†å°±æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„NET namespaceåä¸ºdemoï¼Œç„¶ååˆ›å»ºä¸€å¯¹vethè®¾å¤‡ï¼Œveth0å’Œveth1ï¼Œæ¥ç€å°†veth1ç§»åŠ¨åˆ°namespace demoï¼Œè€Œveth0ä»ç„¶ä¿ç•™åœ¨åŸæ¥çš„namespaceï¼Œç„¶åå¯åŠ¨å¯¹åº”çš„vethè®¾å¤‡ã€‚è¿™æ ·ä¸€å¯¹vethè®¾å¤‡åˆ†å±äºä¸åŒçš„namespaceï¼Œå¹¶å¯ä»¥é€šä¿¡ã€‚ç„¶åç»™veth0å’Œveth1è®¾ç½®ipå¹¶å¯åŠ¨å®ƒä»¬ã€‚è¦æŸ¥çœ‹vethçš„ä¸€å¯¹è®¾å¤‡ä¸­å¦å¤–ä¸€ä¸ªï¼Œå¯ä»¥ç”¨ ethtool -Så‘½ä»¤ã€‚å®ç°ä¸Šé¢åŠŸèƒ½çš„ä»£ç  ns_net.c ï¼Œè¿è¡Œä¹‹ï¼Œå¦‚ä¸‹ï¼š</p>

<p>root@ubuntu:/home/vagrant/nstest# ./ns_net</p>
<ul>
  <li>[ 2760] Hello ?</li>
  <li>[    1] World !</li>
</ul>

<h3 id="å®¿ä¸»æœºnamespace">å®¿ä¸»æœºnamespace</h3>
<p>root@ubuntu:/home/vagrant/nstest# ip -d link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:ec:df:9c brd ff:ff:ff:ff:ff:ff promiscuity 0 
3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 08:00:27:57:25:68 brd ff:ff:ff:ff:ff:ff promiscuity 0 
11: veth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether ce:95:ad:9e:ee:6b brd ff:ff:ff:ff:ff:ff promiscuity 0 
    veth</p>

<h3 id="æ–°çš„namespace">æ–°çš„namespace</h3>
<p>root@In Namespace:/home/vagrant/nstest# ip -d link
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default 
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 promiscuity 0 
10: veth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP mode DEFAULT group default qlen 1000
    link/ether 9a:e9:95:53:c3:28 brd ff:ff:ff:ff:ff:ff promiscuity 0 
    veth 
root@In Namespace:/home/vagrant/nstest# ethtool -S veth1
NIC statistics:
     peer_ifindex: 11
dockerç½‘ç»œåˆ†ä¸ºbridgeï¼Œ hostï¼Œ overlayç­‰å‡ ç§ç±»å‹ã€‚hostå°±æ˜¯ä¸ä¸»æœºå…±ç”¨namespaceï¼Œè¿™é‡Œä¸å•ç‹¬åˆ†æäº†ã€‚è€Œbridgeå°±ä¸å‰é¢ä¾‹å­ä¸­ç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ä»…ä»…æœ‰vethå®¹å™¨è¿˜æ— æ³•ä¸å¤–éƒ¨è”é€šï¼Œå› æ­¤dockerå€ŸåŠ©äº†ç½‘æ¡¥æŠ€æœ¯ç”¨äºè¿æ¥ä¸åŒç½‘æ®µï¼Œåœ¨L2å±‚è¿›è¡Œæ•°æ®è½¬å‘ï¼Œå°†veth0åŠ å…¥åˆ°å®¿ä¸»æœºçš„ç½‘æ¡¥docker0ä¸­ï¼Œå¹¶åœ¨iptablesåŠ å…¥å¯¹åº”çš„NATè§„åˆ™ï¼Œä»¥ä¿è¯å®¹å™¨å¯ä»¥ä¸å¤–éƒ¨è¿é€šã€‚æ³¨æ„dockerä¸­NET namespaceçš„éš”ç¦»ä¸æ˜¯é€šè¿‡ipå‘½ä»¤å®ç°çš„(å› ä¸ºä¸æ˜¯æ‰€æœ‰çš„å†…æ ¸ç‰ˆæœ¬éƒ½æœ‰ip netnsè¿™ä¸ªé«˜çº§å‘½ä»¤)ï¼Œè€Œæ˜¯é€šè¿‡netlinkåŸºäºæ“ä½œç³»ç»Ÿè°ƒç”¨çš„æ–¹å¼å®ç°çš„ã€‚è€Œoverlayç½‘ç»œåˆ™æ˜¯é€šè¿‡vxlanåè®®å®ç°ï¼Œå¯¹åº”çš„vethä¼šæ¡¥æ¥åˆ°overlayçš„NET namespaceä¸€ä¸ªbr0ç½‘æ¡¥ä¸Šã€‚bridgeå’Œoverlayç½‘ç»œçš„ä¸€ä¸ªç¤ºæ„å›¾å¦‚ä¸‹(å›¾æ¥è‡ª deep-dive-into-docker-overlay-networks)ï¼Œå…¶ä¸­192.168.0.Xè¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„overlayç½‘ç»œï¼Œè€Œ172.18.0.Xçš„åˆ™æ˜¯bridgeç½‘ç»œï¼Œdockerç½‘ç»œéƒ¨åˆ†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« å†è¯¦ç»†åˆ†æã€‚</p>

<p>dockerç½‘ç»œç¤ºæ„å›¾
7 USER Namespace
7.1 åˆ›å»ºæ–°çš„USER Namespace
åŠ ä¸Š CLONE_NEWUSER flagå¯ä»¥å®ç°USER namespaceçš„éš”ç¦»ã€‚ç¤ºä¾‹å¦‚ä¸‹(æ³¨æ„ï¼Œåœ¨debianæˆ–è€…ubuntuä¸­å¿…é¡»è®¾ç½®/proc/sys/kernel/unprivileged_userns_cloneè¿™ä¸ªæ–‡ä»¶å€¼ä¸º1ï¼Œå¦åˆ™æ— æ³•ä»¥æ™®é€šç”¨æˆ·è¿è¡Œå¸¦CLONE_NEWUSERæ ‡è®°çš„cloneå‘½ä»¤
)
ç¤ºä¾‹ä»£ç  ns_user.cï¼Œä»¥æ™®é€šç”¨æˆ·è¿è¡Œä¹‹ï¼š</p>

<p>vagrant@ubuntu:~/nstest$ id -u
1000
vagrant@ubuntu:~/nstest$ id -g
1000
vagrant@ubuntu:~/nstest$ gcc -o ns_user ns_user.c -lcap<br />
#å¦‚æœç¼–è¯‘æŠ¥é”™çš„è¯ï¼Œå®‰è£…libcap-devæ¨¡å—ï¼Œsudo apt-get install libcap-dev
vagrant@ubuntu:~/nstest$ ./user 
eUID = 65534;  eGID = 65534;  capabilities: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend+ep
è¿™é‡Œæœ‰å‡ ç‚¹æ³¨æ„çš„ï¼š</p>

<p>å…¶ä¸€ï¼Œä»capabilitiesè¾“å‡ºå¯ä»¥çœ‹åˆ°å­è¿›ç¨‹åœ¨å®ƒçš„namespaceé‡Œé¢æœ‰å…¨éƒ¨çš„capabilityï¼Œè™½ç„¶æˆ‘ä»¬æ˜¯ç”¨æ™®é€šç”¨æˆ·æƒé™è¿è¡Œçš„ç¨‹åºã€‚å½“ä¸€ä¸ªæ–°çš„USER namespaceåˆ›å»ºçš„æ—¶å€™ï¼Œè¿™ä¸ªnamespaceçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹å°±è¢«èµ‹äºˆäº†å…¨éƒ¨çš„capabilityã€‚capabilityæ˜¯ä¸ºäº†å®ç°æ›´ç²¾ç»†åŒ–çš„æƒé™æ§åˆ¶è€ŒåŠ å…¥çš„ã€‚(æˆ‘ä»¬ä»¥å‰ç†ŸçŸ¥é€šè¿‡è®¾ç½®æ–‡ä»¶çš„SUIDä½ï¼Œè¿™æ ·érootç”¨æˆ·çš„å¯æ‰§è¡Œæ–‡ä»¶è¿è¡Œåçš„euidä¼šæˆä¸ºæ–‡ä»¶çš„æ‹¥æœ‰è€…IDï¼Œæ¯”å¦‚passwdå‘½ä»¤è¿è¡Œèµ·æ¥åæœ‰rootæƒé™ã€‚ä¸€æ—¦SUIDçš„æ–‡ä»¶å­˜åœ¨æ¼æ´ï¼Œä¾¿å¯èƒ½è¢«åˆ©ç”¨è€Œå¢åŠ å®‰å…¨é£é™©ï¼‰ã€‚æŸ¥çœ‹æ–‡ä»¶çš„capabilityçš„å‘½ä»¤ä¸º filecap -aï¼Œè€ŒæŸ¥çœ‹è¿›ç¨‹capabilityçš„å‘½ä»¤ä¸º pscap -a(pscapå’Œfilecapå·¥å…·éœ€è¦å®‰è£… libcap-ng-utilsè¿™ä¸ªåŒ…)ã€‚å¯¹capabilityçš„é‚£ä¸²æ•°å­—è§£ç å‘½ä»¤ä¸º capsh â€“decode=00000000000000c0ã€‚æ›´å¤šcapabilityçš„å†…å®¹è§å‚è€ƒèµ„æ–™4ã€‚</p>

<p>å¯¹äºcapabilityï¼Œå¯ä»¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ä¾¿äºç†è§£ã€‚å¦‚ubuntu14.04ç³»ç»Ÿä¸­è‡ªå¸¦çš„pingå·¥å…·ï¼Œå®ƒæ˜¯æœ‰è®¾ç½®SUIDä½çš„ã€‚è¿™é‡Œæ‹·è´pingåˆ°æˆ‘çš„ç”¨æˆ·ç›®å½•ä¸‹åä¸ºanotherpingï¼Œå¯ä»¥çœ‹åˆ°å®ƒçš„SUIDä½æ˜¯æ²¡æœ‰äº†çš„ï¼Œè¿è¡Œanotherpingï¼Œä¼šæç¤ºæƒé™é”™è¯¯ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬åªè¦å°†å…¶åŠ ä¸Š cap_net_rawæƒé™å³å¯ï¼Œä¸éœ€è¦è®¾ç½®SUIDä½é‚£ä¹ˆå¤§çš„æƒé™ã€‚</p>

<p>vagrant@ubuntu:~$ ls -ls /bin/ping
44 -rwsr-xr-x 1 root root 44168 May  7  2014 /bin/ping
vagrant@ubuntu:~$ cp /bin/ping anotherping
vagrant@ubuntu:~$ ls -ls anotherping 
44 -rwxr-xr-x 1 vagrant vagrant 44168 Aug 27 03:27 anotherping
vagrant@ubuntu:~$ ping -c1 www.163.com
PING 163.xdwscache.ourglb0.com (112.90.246.87) 56(84) bytes of data.
64 bytes from ns.local (112.90.246.87): icmp_seq=1 ttl=63 time=11.9 ms
â€¦
vagrant@ubuntu:~$ ./anotherping -c1 www.163.com
ping: icmp open socket: Operation not permitted</p>

<p>vagrant@ubuntu:~$ sudo setcap cap_net_raw+ep ./anotherping 
vagrant@ubuntu:~$ ./anotherping -c1 www.163.com
PING 163.xdwscache.ourglb0.com (112.90.246.87) 56(84) bytes of data.
64 bytes from ns.local (112.90.246.87): icmp_seq=1 ttl=63 time=12.4 ms
â€¦
å…¶äºŒï¼Œä¸€ä¸ªè¿›ç¨‹çš„uidå’Œgidåœ¨ä¸åŒçš„USER namespaceæ˜¯å¯ä»¥ä¸ä¸€æ ·çš„ï¼Œè¿™éœ€è¦ä¸€ä¸ªnamespaceå†…éƒ¨æ˜ å°„åˆ°namespaceå¤–éƒ¨çš„æ˜ å°„å…³ç³»ã€‚è¿™æ ·å½“ä¸€ä¸ªUSER namespaceä¸­çš„è¿›ç¨‹çš„æ“ä½œå¯èƒ½å½±å“åˆ°å¤–éƒ¨ç³»ç»Ÿæ—¶ï¼Œå¯ä»¥å¯¹è¿™ä¸ªè¿›ç¨‹çš„æƒé™è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœä¸€ä¸ªç”¨æˆ·IDåœ¨USER namespaceä¸­æ²¡æœ‰æ˜ å°„å…³ç³»ï¼Œåˆ™getuid()ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å› /proc/sys/kernel/overflowuidå€¼ä½œä¸ºç”¨æˆ·IDï¼Œè¿™ä¸ªå€¼é»˜è®¤ä¸º65534ï¼Œå°±å¦‚æˆ‘ä»¬å‰é¢ç¨‹åºä¸­è¾“å‡ºä¸€æ ·(gidå¯¹åº”çš„æ–‡ä»¶åä¸ºoverflowgid)ã€‚</p>

<p>å…¶ä¸‰ï¼Œå°½ç®¡é€šè¿‡cloneç³»ç»Ÿè°ƒç”¨åˆ›å»ºçš„å­è¿›ç¨‹åœ¨æ–°çš„USER namespaceä¸­æœ‰æ‰€æœ‰æƒé™ï¼Œä½†æ˜¯å®ƒåœ¨parent user namespaceæ˜¯æ²¡æœ‰ä»»ä½•æƒé™çš„ï¼Œå³ä¾¿ä»¥rootèº«ä»½è¿è¡Œä¹Ÿæ˜¯ä¸€æ ·ã€‚user namespaceçš„åˆ›å»ºå¯ä»¥æ˜¯åµŒå¥—çš„ï¼Œä¸€ä¸ªuser namespaceä¸€å®šæœ‰ä¸ªparent user namespaceï¼Œå¯ä»¥æœ‰é›¶æˆ–è€…å¤šä¸ª child user namespaceã€‚å­è¿›ç¨‹çš„parent user namespaceå°±æ˜¯è°ƒç”¨clone()æˆ–è€…unshare()é€šè¿‡CLONE_NEWUSERçš„flagåˆ›å»ºæ–°namespaceçš„é‚£ä¸ªçˆ¶è¿›ç¨‹çš„user namespaceã€‚</p>

<p>7.2 æ˜ å°„uidå’Œgid
åˆ›å»ºæ–°çš„user namespaceä¹‹åç¬¬ä¸€æ­¥å°±æ˜¯è®¾ç½®å¥½userå’Œgroupçš„æ˜ å°„å…³ç³»ã€‚è¿™ä¸ªæ˜ å°„é€šè¿‡è®¾ç½®/proc/PID/uid_map(gid_map)å®ç°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ID-inside-ns   ID-outside-ns   length ä¸æ˜¯æ‰€æœ‰çš„è¿›ç¨‹éƒ½èƒ½éšä¾¿ä¿®æ”¹æ˜ å°„æ–‡ä»¶çš„ï¼Œå¿…é¡»åŒæ—¶å…·å¤‡å¦‚ä¸‹æ¡ä»¶ï¼š
</code></pre></div></div>

<p>ä¿®æ”¹æ˜ å°„æ–‡ä»¶çš„è¿›ç¨‹å¿…é¡»æœ‰PIDè¿›ç¨‹æ‰€åœ¨user namespaceçš„CAP_SETUID/CAP_SETGIDæƒé™ã€‚è¿›ç¨‹çš„capabilityä¸€èˆ¬æ˜¯é€šè¿‡å…¶å¯æ‰§è¡Œæ–‡ä»¶çš„capabilityè·å¾—ã€‚
ä¿®æ”¹æ˜ å°„æ–‡ä»¶çš„è¿›ç¨‹å¿…é¡»æ˜¯è·ŸPIDåœ¨åŒä¸€ä¸ªuser namespaceæˆ–è€…PIDçš„parent user namespaceã€‚
æ˜ å°„æ–‡ä»¶uid_mapå’Œgid_mapåªèƒ½å†™å…¥ä¸€æ¬¡ï¼Œå†æ¬¡å†™å…¥ä¼šæŠ¥é”™ã€‚
ä¸‹é¢æ¥æµ‹è¯•ä¸‹7.1ä¸­çš„ä¾‹å­ï¼š</p>

<p>#åœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯è¿è¡Œ ns_user
vagrant@ubuntu:~/nstest$ ./ns_user x
eUID = 65534;  eGID = 65534; capabilities: = â€¦ep</p>

<p>#åœ¨ç¬¬äºŒä¸ªç»ˆç«¯å†™å…¥è¯¥è¿›ç¨‹å¯¹åº”çš„uid_map
vagrant@ubuntu:~/nstest$ ps -C ns_user -o â€˜pid ppid uid commâ€™
  PID  PPID   UID COMMAND
 8775  8577  1000 ns_user
 8776  8775  1000 ns_user
vagrant@ubuntu:~/nstest$ echo â€˜0 1000 1â€™ &gt; /proc/8776/uid_map</p>

<p>#ç¬¬ä¸€ä¸ªç»ˆç«¯æ­¤æ—¶è¾“å‡ºä¸ºï¼š
vagrant@ubuntu:~/nstest$ ./ns_user x
eUID = 0;  eGID = 65534; capabilities: = â€¦ep</p>

<p>#åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ç»§ç»­å†™å…¥gid_map
vagrant@ubuntu:~/nstest$ echo â€˜0 1000 1â€™ &gt; /proc/8776/gid_map</p>

<p>#ç¬¬ä¸€ä¸ªç»ˆç«¯æ­¤æ—¶è¾“å‡ºä¸ºï¼š
vagrant@ubuntu:~/nstest$ ./ns_user x
eUID = 0;  eGID = 0; capabilities: = â€¦ep</p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ä½äºparent user namespaceçš„bashè¿›ç¨‹ä¸­é€šè¿‡echoå‘½ä»¤ä¿®æ”¹uid_mapå’Œgid_mapéƒ½æ˜¯å¯ä»¥æˆåŠŸçš„ã€‚è¿™æ˜¯å› ä¸ºæˆ‘çš„æµ‹è¯•ç¯å¢ƒçš„bashè¿›ç¨‹å…·æœ‰CAP_SETUIDå’ŒCAP_SETGIDæƒé™çš„ï¼ŒæŸ¥çœ‹/proc/PID/statuså¯ä»¥éªŒè¯è¿›ç¨‹çš„æƒé™æˆ–è€…getcapå¯ä»¥éªŒè¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„æƒé™ï¼Œå¦‚ä¸‹éªŒè¯bashçš„æƒé™ï¼Œå¦‚æœbashåŸæ¥æ²¡æœ‰è¿™ä¸¤ä¸ªæƒé™ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤sudo setcap cap_setgid,cap_setuid+ep /bin/bashè®¾ç½®:</p>

<p>vagrant@ubuntu:~/nstest$ cat /proc/$$/status | egrep â€˜Cap(Inh|Prm|Eff)â€™
CapInh: 0000000000000000
CapPrm: 00000000000000c0
CapEff: 00000000000000c0</p>

<p>vagrant@ubuntu:~/nstest$ getcap /bin/bash
/bin/bash = cap_setgid,cap_setuid+ep
è¿™é‡Œæœ‰ä¸ªè¦æ³¨æ„çš„åœ°æ–¹ï¼Œubuntu14.04çš„/bin/bashæ–‡ä»¶é»˜è®¤å°±æœ‰ä¿®æ”¹æ–°çš„user namespaceè¿›ç¨‹çš„uid_mapçš„æƒé™ï¼Œå¦‚æœè¦ä¿®æ”¹gid_mapè¦å¦å¤–åŠ ä¸‹cap_setgidæƒé™ã€‚è€Œå…¶ä»–çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œé»˜è®¤ä¹Ÿæ˜¯åªæœ‰cap_setuidæƒé™ï¼Œæ¯”å¦‚ç½‘ä¸Šå¾ˆå¤šæ–‡ç« ä¸­æåˆ°çš„ä¸€ä¸ªè®¾ç½®user namespaceçš„ä¾‹å­ï¼Œåœ¨ubuntu14.04é‡Œé¢è®¾ç½®gid_mapä¼šå¤±è´¥ï¼Œå› ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æ²¡æœ‰cap_setgidæƒé™ï¼Œéœ€è¦åŠ ä¸Šgidæƒé™æ‰èƒ½æˆåŠŸä¿®æ”¹gid_mapã€‚</p>

<p>çœ‹è¿™ä¸ªä¾‹å­ï¼Œä»£ç  ns_child_exec.cï¼Œæ‰§è¡Œåå¯ä»¥å‘ç°åœ¨æ–°çš„user namespaceé‡Œé¢çš„bashé‡Œé¢é€šè¿‡echoå‘½ä»¤è®¾ç½®uid_mapå’Œgid_mapéƒ½ä¼šå¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºå½“ä¸€ä¸ªérootç”¨æˆ·çš„è¿›ç¨‹æ‰§è¡Œexecve()æ—¶ï¼Œè¿›ç¨‹çš„capabilityä¼šè¢«æ¸…ç©ºã€‚äºæ˜¯ï¼Œå­è¿›ç¨‹è™½ç„¶æœ‰æ–°çš„user namespaceæ‰€æœ‰çš„æƒé™é›†åˆï¼Œä½†æ˜¯é€šè¿‡å®ƒexevceæ‰§è¡Œçš„bashè¿›ç¨‹ä»¥åŠbashè¿›ç¨‹çš„å­è¿›ç¨‹æ˜¯æ²¡æœ‰å¯¹åº”çš„capabilityçš„ã€‚</p>

<p>vagrant@ubuntu:~/nstest$ ./ns_child_exec -U bash
nobody@ubuntu:~/nstest$ id -u  #æ–°çš„user namespaceè¿è¡Œçš„bashè¿›ç¨‹
65534
nobody@ubuntu:~/nstest$ id -g
65534
nobody@ubuntu:~/nstest$ echo â€˜0 1000 1â€™ &gt; /proc/\(/uid_map
bash: echo: write error: Operation not permitted
nobody@ubuntu:~/nstest$ echo '0 1000 1' &gt; /proc/\)/gid_map
bash: echo: write error: Operation not permitted
ä¸ºäº†è®¾ç½®æ˜ å°„æ–‡ä»¶ï¼Œå› æ­¤éœ€è¦åœ¨çˆ¶è¿›ç¨‹ä¸­è®¾ç½®ï¼Œç¤ºä¾‹ä»£ç  userns_child_exec.cã€‚æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼Œè¦åœ¨userns_child_execè¿›ç¨‹ä¸­æˆåŠŸè®¾ç½®gid_mapæ–‡ä»¶ï¼Œéœ€è¦ç»™å¯æ‰§è¡Œæ–‡ä»¶åŠ ä¸Š cap_setgidæƒé™ï¼Œæ­¤å¤–ï¼Œè¿˜è¦ä¿è¯ /bin/bashæ˜¯æœ‰cap_setgidæƒé™çš„ï¼š</p>

<p>root@ubuntu:~/nstest# setcap cap_setgid+ep ./userns_child_exec
vagrant@ubuntu:~/nstest$ ./userns_child_exec -U -M â€˜0 1000 1â€™ -G â€˜0 1000 1â€™ bash
root@ubuntu:~/nstest# id -u # æ–°çš„user namespace
0
root@ubuntu:~/nstest# id -g
0
root@ubuntu:~/nstest# cat /proc/$$/status | egrep â€˜Cap(Inh|Prm|Eff)â€™
CapInh: 0000000000000000
CapPrm: 0000003fffffffff
CapEff: 0000003fffffffff
æœ€åä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œuid_mapæ–‡ä»¶é‡Œé¢çš„ ID-outside-ns è¿™ä¸ªå€¼æ˜¯æ ¹æ®å½“å‰è¯»å–æ–‡ä»¶çš„user namespaceç”Ÿæˆçš„ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„ä¾‹å­å°±æ˜ç™½äº†ã€‚åœ¨ä¸¤ä¸ªç»ˆç«¯é‡Œé¢åˆ†åˆ«è¿è¡Œ userns_child_execç¨‹åºï¼Œè®¾ç½®ä¸åŒçš„ID-inside-nsï¼Œè¿è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨åˆå§‹çš„user namespaceåˆ›å»ºäº†2ä¸ªchild user namespaceï¼Œä¸€ä¸ªæ˜¯æ˜ å°„çš„uidä¸º0ï¼Œå¦ä¸€ä¸ªæ˜ å°„çš„ä¸º200ï¼Œåœ¨ç¬¬ä¸€ä¸ªç»ˆç«¯çœ‹ç¬¬äºŒä¸ªç»ˆç«¯è¿›ç¨‹å¯¹åº”çš„æ˜ å°„å…³ç³»æ—¶å¯ä»¥å‘ç°uid_mapå€¼ä¸º 200 0 1ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬äºŒä¸ªuser namespaceä¸­çš„è¿›ç¨‹ç”¨æˆ·IDæ˜ å°„åˆ°äº†å½“å‰user namespaceçš„uid 0ï¼Œè€Œä¸æ˜¯åˆå§‹çš„user namespaceçš„1000ã€‚ä»ç¬¬äºŒä¸ªç»ˆç«¯é‡Œé¢çœ‹ç¬¬ä¸€ä¸ªç»ˆç«¯çš„è¿›ç¨‹çš„uid_mapæ­£å¥½åè½¬ã€‚å½“ç„¶ï¼Œä½ å¦‚æœåœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ä»åˆå§‹çš„user namespaceé‡Œé¢å»çœ‹uid_mapï¼Œæ˜¯è·Ÿä¹‹å‰ä¸€æ ·çš„ã€‚</p>

<h1 id="ç¬¬ä¸€ä¸ªç»ˆç«¯æ˜ å°„-0---1000">ç¬¬ä¸€ä¸ªç»ˆç«¯ï¼Œæ˜ å°„ 0 -&gt; 1000</h1>
<p>vagrant@ubuntu:~/nstest$ ./userns_child_exec -U -M â€˜0 1000 1â€™ -G â€˜0 1000 1â€™ bash 
root@ubuntu:~/nstest# id -u
0
root@ubuntu:~/nstest# id -g
0
root@ubuntu:~/nstest# echo \(25730
root@ubuntu:~/nstest# cat /proc/\)/uid_map
         0       1000          1
root@ubuntu:~/nstest# cat /proc/26091/uid_map<br />
       200          0          1</p>

<h1 id="ç¬¬äºŒä¸ªç»ˆç«¯æ˜ å°„-200-1000">ç¬¬äºŒä¸ªç»ˆç«¯ï¼Œæ˜ å°„ 200-&gt;1000</h1>
<p>vagrant@ubuntu:~/nstest$ ./userns_child_exec -U -M â€˜200 1000 1â€™ -G â€˜200 1000 1â€™ bash
I have no name!@ubuntu:~/nstest$ id -u
200
I have no name!@ubuntu:~/nstest$ echo \(26091
I have no name!@ubuntu:~/nstest$ cat /proc/\)/uid_map 
       200       1000          1
I have no name!@ubuntu:~/nstest$ cat /proc/25730/uid_map 
         0        200          1</p>

<h1 id="ç¬¬ä¸‰ä¸ªç»ˆç«¯åˆå§‹user-namespaceé‡Œé¢æŸ¥çœ‹æ˜ å°„å…³ç³»">ç¬¬ä¸‰ä¸ªç»ˆç«¯ï¼Œåˆå§‹user namespaceé‡Œé¢æŸ¥çœ‹æ˜ å°„å…³ç³»</h1>
<p>vagrant@ubuntu:~/nstest$ cat /proc/25730/uid_map 
         0       1000          1
vagrant@ubuntu:~/nstest$ cat /proc/26091/uid_map 
       200       1000          1
ä¹‹å‰æˆ‘ä»¬æåˆ°çš„dockerç¤ºä¾‹ä¸­ï¼Œæ²¡æœ‰å¯¹user namespaceè¿›è¡Œéš”ç¦»ã€‚user namespaceåŠŸèƒ½è™½ç„¶åœ¨å¾ˆæ—©å°±å‡ºç°äº†ï¼Œä½†æ˜¯ç›´åˆ°Linux kernel 3.8ä¹‹åè¿™ä¸ªåŠŸèƒ½æ‰é€æ­¥ç¨³å®šã€‚docker1.10ä¹‹åçš„ç‰ˆæœ¬å¯ä»¥é€šè¿‡åœ¨docker daemonå¯åŠ¨æ—¶åŠ ä¸Šâ€“userns-remap=[USERNAME]æ¥å®ç°USER Namespaceçš„éš”ç¦»ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­æˆ‘ä»¬æš‚æ—¶æ²¡æœ‰ç”¨åˆ°USER namespaceçš„éš”ç¦»ï¼Œä¸è¿‡dockerå¯¹äºCAPå¾ˆæ—©å°±æœ‰ä½¿ç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥çœ‹åˆ°å®¹å™¨å¯åŠ¨çš„æ—¶å€™å¦‚æœéœ€è¦ç‰¹å®šåŠŸèƒ½çš„éœ€è¦åŠ â€“cap-add SYS_ADMINï¼ŒNET_ADMINè¿™äº›å‚æ•°ã€‚</p>

<p>http://www.man7.org/linux/man-pages/man2/setns.2.html</p>
:ET