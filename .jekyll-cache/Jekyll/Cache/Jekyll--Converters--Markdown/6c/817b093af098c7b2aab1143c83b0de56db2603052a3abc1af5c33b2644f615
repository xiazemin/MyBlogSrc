I"Î<!-- more -->
<p>ä¸€ã€INETåè®®æ—è¯´æ˜</p>

<p>åœ¨socketç¼–ç¨‹ä¸­ï¼Œå¯ä»¥æŒ‡å®šåè®®ç±»å‹ã€‚</p>

<p>int socket(int domain, int type, int protocol);</p>

<p>åŸºæœ¬ä¸Šä¸Šå¯ä»¥æŒ‡å®šåè®®ç±»å‹å¦‚ä¸‹ï¼š</p>

<p>tcp_socket = socket(PF_INET, SOCK_STREAM, 0);</p>

<p>udp_socket = socket(PF_INET, SOCK_DGRAM, 0);</p>

<p>raw_socket = socket(PF_INET, SOCK_RAW, protocol);</p>

<p>å…¶ä¸­SOCK_STREAMä¸SOCK_DGRAMæ˜¯TCPä¸UDPåè®®æ—ç±»å‹ï¼Œæ˜¯æœ€å¸¸ç”¨çš„åè®®ç±»å‹ã€‚</p>

<p>SOCK_RAWæ˜¯åŸç”Ÿæ•°æ®åè®®ï¼Œè¿™é‡Œçš„åŸç”Ÿæ•°æ®æ˜¯å»ºç«‹åœ¨IPåè®®ä¹‹ä¸Šçš„ä¼ è¾“å±‚åŸç”Ÿåè®®ã€‚</p>

<p>äºŒã€SOCK_RAWè¯´æ˜</p>

<p>SOCK_RAWæŒ‡å»ºç«‹åœ¨IPä¹‹ä¸Šçš„åè®®ç±»å‹ï¼Œå¯ä»¥ç›´æ¥è®¿é—®IPåè®®ï¼Œä¸€èˆ¬å¯ä»¥æŒ‡å®šIPPROTO_TCPä¸IPPROTO_UDPã€‚</p>

<p>ä½†SOCK_RAWæŒ‡å®šçš„åè®®ç±»å‹åœ¨RFC 9700ä¸­è§„èŒƒå®šä¹‰ï¼š</p>

<p>Assigned Internet Protocol Numbers</p>

<p>Decimal Keyword Protocol References</p>

<hr />

<p>0 Reserved [JBP]</p>

<p>1 ICMP Internet Control Message [RFC792,JBP]</p>

<p>6 TCP Transmission Control [RFC793,JBP]</p>

<p>17     UDP         User Datagram                  [RFC768,JBP]</p>

<p>ä»¥ä¸Šåè®®å¯ä»¥ä½¿ç”¨getprotobynameå‡½æ•°æ ¹æ®å­—ç¬¦ä¸²åå­—è·å–ã€‚</p>

<p>int proto(const char *pname)</p>

<p>{</p>

<p>struct protoent *pro=getprotobyname(pname);</p>

<p>if(pro==NULL) return -1;</p>

<p>elsereturn pro-&gt;p_proto;</p>

<p>}</p>

<p>ä¹Ÿå¯ä»¥åœ¨netinet/in.hçš„å¤´æ–‡ä»¶ä¸­çœ‹åˆ°å®šä¹‰çš„å®æˆ–è€…æšä¸¾ç±»å‹ã€‚</p>

<p>==========================================================</p>

<p>enum</p>

<p>{</p>

<p>IPPROTO_IP = 0,        /* Dummy protocol for TCP.  */</p>

<p>#define IPPROTO_IP              IPPROTO_IP</p>

<p>IPPROTO_HOPOPTS = 0,   /* IPv6 Hop-by-Hop options.  */</p>

<p>#define IPPROTO_HOPOPTS         IPPROTO_HOPOPTS</p>

<p>IPPROTO_ICMP = 1,      /* Internet Control Message Protocol.  */</p>

<p>#define IPPROTO_ICMP            IPPROTO_ICMP</p>

<p>IPPROTO_IGMP = 2,      /* Internet Group Management Protocol. */</p>

<p>#define IPPROTO_IGMP            IPPROTO_IGMP</p>

<p>IPPROTO_IPIP = 4,      /* IPIP tunnels (older KA9Q tunnels use 94).  */</p>

<p>#define IPPROTO_IPIP            IPPROTO_IPIP</p>

<p>IPPROTO_TCP = 6,       /* Transmission Control Protocol.  */</p>

<p>#define IPPROTO_TCP             IPPROTO_TCP</p>

<p>IPPROTO_EGP = 8,       /* Exterior Gateway Protocol.  */</p>

<p>#define IPPROTO_EGP             IPPROTO_EGP</p>

<p>IPPROTO_PUP = 12,      /* PUP protocol.  */</p>

<p>#define IPPROTO_PUP             IPPROTO_PUP</p>

<p>IPPROTO_UDP = 17,      /* User Datagram Protocol.  */</p>

<p>#define IPPROTO_UDP             IPPROTO_UDP</p>

<p>â€¦â€¦</p>

<p>==========================================================</p>

<p>å»ºè®®åœ¨IPä¹‹ä¸Šçš„åŸç”Ÿåè®®å¯ä»¥è‡ªå·±æŒ‡å®šICMPï¼ŒTCPï¼ŒUDPã€‚</p>

<p>ä¸€èˆ¬åœ¨å¼€å‘ä¸­æœ‰ä¸‹é¢æƒ…å†µã€‚</p>

<p>int fd=socket(PF_INET,SOCK_RAW,IPPROTO_ICMP);</p>

<p>int fd=socket(PF_INET,SOCK_RAW,IPPROTO_TCP);</p>

<p>int fd=socket(PF_INET,SOCK_RAW,IPPROTO_UDP);</p>

<p>å¦‚æœä½¿ç”¨åŸç”Ÿæ•°æ®å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸è‡ªåŠ¨åŒ…å«IPå¤´çš„ï¼Œé™¤éé€šè¿‡é€‰é¡¹è®¾ç½®setsockoptå‡½æ•°è®¾ç½®IP_HDRINCLé€‰é¡¹ã€‚</p>

<p>å¦‚æœè®¾ç½®IP_HDRINCLé€‰é¡¹ï¼Œåˆ™å¯ä»¥åœ¨å‘é€åŸç”Ÿæ•°æ®çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ·»åŠ IPå¤´ã€‚æ¥æ”¶æ•°æ®æ²¡æœ‰è¿™ä¸ªè§„åˆ™ã€‚</p>

<p>å¦‚æœæŒ‡å®šIPPROTO_RAWæ¥æ¥æ”¶ä»»æ„IPåè®®æ˜¯ä¸å¯èƒ½çš„ã€‚</p>

<p>è‡ªåŠ¨åŒ…å«çš„IPå¤´æŒ‰å¦‚ä¸‹è§„åˆ™ç”Ÿæˆï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   +---------------------------------------------------+

   |IP Header fields modified on sending by IP_HDRINCL |

   +----------------------+----------------------------+

   |IP Checksum           |Always filled in.           |

   +----------------------+----------------------------+

   |Source Address        |Filled in when zero.        |

   +----------------------+----------------------------+

   |Packet Id             |Filled in when zero.        |

   +----------------------+----------------------------+

   |Total Length          |Always filled in.           |

   +----------------------+----------------------------+
</code></pre></div></div>

<p>ä¸‰ã€RAWçš„é€‰é¡¹è®¾ç½®</p>

<p>int setsockopt(int s, int level, int optname, const void *optval, socklen_t optlen);</p>

<p>å¯¹RAWæ¥è¯´levelä¸€å®šè¦æŒ‡å®šä¸ºIPPROTO_RAW</p>

<p>å¯ä»¥æŒ‡å®šçš„é€‰é¡¹é€‰é¡¹ä¸ºï¼š</p>

<p>ICMP_FILTER</p>

<p>IPPROTO_IPçš„æ‰€æœ‰é€‰é¡¹å¯¹RAWä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚</p>

<p>ä¸€èˆ¬å¦‚ä¸‹æŒ‡å®šSOL_IPå’ŒSOL_RAWã€‚</p>

<p>SOL_RAWçº§åˆ«ä¸Šåªæœ‰ä¸€ä¸ªé€‰é¡¹ï¼Œå³ICMP_FILTERï¼Œåœ¨IPPROTO_ICMPåè®®ä¸‹æœ‰æ•ˆã€‚</p>

<p>å®ƒæ¿€æ´»ç»‘å®šåˆ°IPPROTO_ICMPåè®®çš„ä¸€ä¸ªç”¨äºRAW socketç‰¹æ®Šçš„è¿‡æ»¤å™¨ã€‚è¯¥å€¼å¯¹æ¯ç§ICMPæ¶ˆæ¯éƒ½æœ‰ä¸€ä¸ªä½ï¼ˆæ©ç ï¼‰ï¼Œå¯ä»¥æŠŠé‚£ç§ICMPæ¶ˆæ¯è¿‡æ»¤æ‰ï¼Œç¼ºçœæ—¶æ˜¯ä¸è¿‡æ»¤ICMPæ¶ˆæ¯ã€‚</p>

<p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>

<p>struct icmp_filter filter={};</p>

<p>filter.data=1;/<em>è®¾ç½®åå°±è¿‡æ»¤æ‰æœåŠ¡å™¨çš„å›æ˜¾æ¶ˆæ¯ï¼Œåªèƒ½çœ‹è§ä¸€ä¸ªæ¶ˆæ¯</em>/</p>

<p>r=setsockopt(fd,SOL_RAW,ICMP_FILTER,&amp;filter,sizeof(struct icmp_filter) );</p>

<p>if(r==-1) printf(â€œsetsockopt error:%m\nâ€),exit(-1);</p>

<p>======================================================</p>

<p>ç®€å•çš„ä»£ç ï¼Œå¯ä»¥æ¥æ”¶åˆ°pingå‘é€çš„æ¶ˆæ¯ï¼š</p>

<p>int proto(const char <em>); main() { int pt=proto(â€œICMPâ€); printf(â€œåè®®æ˜¯:%d\nâ€,pt); int fd=socket(PF_INET,SOCK_RAW,pt); if(fd==-1) { printf(â€œsocket error:%m\nâ€);exit(-1); } int r; //è®¾ç½®socketé€‰é¡¹ int val=0; r=setsockopt(fd,IPPROTO_IP,IP_HDRINCL,&amp;val,sizeof(int)); if(r==-1) printf(â€œsetsockopt error:%m\nâ€),exit(-1); struct icmp_filter filter={}; filter.data=1;/</em>è®¾ç½® å å°± è¿‡æ»¤æ‰æœåŠ¡å™¨çš„ å›æ˜¾ æ¶ˆæ¯ï¼Œåªèƒ½çœ‹è§ä¸€ä¸ªæ¶ˆæ¯*/ r=setsockopt(fd,SOL_RAW,ICMP_FILTER,&amp;filter,sizeof(struct icmp_filter) ); if(r==-1) printf(â€œsetsockopt error:%m\nâ€),exit(-1); //è¯»å–çš„åŸç”Ÿæ•°æ®åŒ… struct ip buf={}; while(1) { bzero(&amp;buf,sizeof(struct ip)); r=recv(fd,&amp;buf,sizeof(struct ip),0); if(r&lt;=0) { printf(â€œæ²¡æœ‰è¯»å–åˆ°æ•°æ®\nâ€); } printf(â€œè¯»å–åˆ°æ•°æ®é•¿åº¦%d\nâ€,r); printf(â€œå¤´é•¿åº¦:%d\nâ€,buf.ip_hl); printf(â€œç‰ˆæœ¬%d\nâ€,buf.ip_v); } } int proto(const char *pname) { struct protoent *pro=getprotobyname(pname); if(pro==NULL) return -1; elsereturn pro-&gt;p_proto; }</p>
:ET