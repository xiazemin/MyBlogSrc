I"´<p>è¿™æ¬¡ï¼Œæˆ‘ä»¬å°†æ¼”ç¤ºå¦‚ä½•åœ¨PHPæ‰©å±•ä¸­å¦‚ä½•å¯¹æ•°ç»„è¿›è¡Œå¤„ç†ã€‚è¦å®ç°çš„PHPä»£ç å¦‚ä¸‹ï¼š</p>

<p>&lt;?php
function array_concat ($arr, $prefix) {
    foreach($arr as $key =&gt; $val) {
        if (isset($prefix[$key]) 
                &amp;&amp; is_string($val) 
                &amp;&amp; is_string($prefix[$key])) {
            $arr[$key] = $prefix[$key].$val;
        } <br />
    } <br />
    return $arr;
}</p>

<p>$arr = array(
    0 =&gt; â€˜0â€™,
    1 =&gt; â€˜123â€™,
    â€˜aâ€™ =&gt; â€˜abcâ€™,
);<br />
$prefix = array(
    1 =&gt; â€˜456â€™,
    â€˜aâ€™ =&gt; â€˜defâ€™,
);<br />
var_dump(array_concat($arr, $prefix));
?&gt;</p>

<p>æŠŠä¸¤ä¸ªæ•°ç»„ï¼Œç›¸åŒkeyçš„å­—ç¬¦ä¸²å€¼æ‹¼æ¥ã€‚</p>

<p>ä»£ç 
åŸºç¡€ä»£ç 
è¿™ä¸ªæ‰©å±•ï¼Œæˆ‘ä»¬å°†åœ¨sayæ‰©å±•ä¸Šå¢åŠ  array_concat æ–¹æ³•ã€‚sayæ‰©å±•ç›¸å…³ä»£ç å¤§å®¶è¯·çœ‹è¿™ç¯‡åšæ–‡ã€‚PHP7æ‰©å±•å¼€å‘ä¹‹hello word æ–‡ä¸­å·²ç»è¯¦ç»†ä»‹ç»äº†å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ‰©å±•å’Œæä¾›äº†æºç ä¸‹è½½ã€‚</p>

<p>å®ç°array_concatæ–¹æ³•
array_concatæ–¹æ³•çš„PHPæ‰©å±•æºç ï¼š</p>

<p>PHP_FUNCTION(array_concat)
{
    zval *arr, *prefix, *entry, *prefix_entry, value;
    zend_string *string_key, *result;
    zend_ulong num_key;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (zend_parse_parameters(ZEND_NUM_ARGS(), "aa", &amp;arr, &amp;prefix) == FAILURE) {
    return;
}

array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(arr)));

ZEND_HASH_FOREACH_KEY_VAL(Z_ARRVAL_P(arr), num_key, string_key, entry) {
    if (string_key &amp;&amp; zend_hash_exists(Z_ARRVAL_P(prefix), string_key)) {
        prefix_entry = zend_hash_find(Z_ARRVAL_P(prefix), string_key);
        if (Z_TYPE_P(entry) == IS_STRING &amp;&amp; prefix_entry != NULL &amp;&amp; Z_TYPE_P(prefix_entry) == IS_STRING) {
            result = strpprintf(0, "%s%s", Z_STRVAL_P(prefix_entry), Z_STRVAL_P(entry));
            ZVAL_STR(&amp;value, result);
            zend_hash_update(Z_ARRVAL_P(return_value), string_key, &amp;value);
        }   
    } else if (string_key == NULL &amp;&amp; zend_hash_index_exists(Z_ARRVAL_P(prefix), num_key)){
        prefix_entry = zend_hash_index_find(Z_ARRVAL_P(prefix), num_key);
        if (Z_TYPE_P(entry) == IS_STRING &amp;&amp; prefix_entry != NULL &amp;&amp; Z_TYPE_P(prefix_entry) == IS_STRING) {
            result = strpprintf(0, "%s%s", Z_STRVAL_P(prefix_entry), Z_STRVAL_P(entry));
            ZVAL_STR(&amp;value, result);
            zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, &amp;value);
        }
    } else if (string_key) {
        zend_hash_update(Z_ARRVAL_P(return_value), string_key, entry);
        zval_add_ref(entry);
    } else  {
        zend_hash_index_update(Z_ARRVAL_P(return_value), num_key, entry);
        zval_add_ref(entry);
    }
}ZEND_HASH_FOREACH_END();
</code></pre></div></div>

<p>}</p>

<p>ä»£ç è¯´æ˜
PHPä¸­çš„æ•°ç»„æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå“ˆå¸Œã€‚
å¯¹äºå“ˆå¸Œå¤„ç†çš„æ–¹æ³•ä¸»è¦é›†ä¸­åœ¨Zend/zend_hash.hä¸­ã€‚
å¯¹äºæ•°ç»„çš„æ“ä½œæ–¹æ³•ä¸»è¦é›†ä¸­åœ¨Zend/API.hã€‚æ•°ç»„çš„æ–¹æ³•å…¶å®å°±æ˜¯å¯¹å“ˆå¸Œå¤„ç†æ–¹æ³•çš„ä¸€å±‚åŒ…è£…ã€‚
æ•°ç»„æ“ä½œçš„æ–¹æ³•ä¸»è¦æ˜¯ä»¥add_assoc_ å’Œ add_index_å¼€å¤´çš„ä¸€äº›åˆ—æ–¹æ³•ã€‚</p>

<p>ä¸‹é¢æ˜¯ä»£ç ä¸­æ¶‰åŠçš„ä¸€äº›æ–¹æ³•ã€‚
zend_hash_num_elementsè·å–æ•°ç»„çš„å…ƒç´ ä¸ªæ•°ã€‚</p>

<p>array_init_size(return_value, zend_hash_num_elements(Z_ARRVAL_P(arr))); åˆå§‹åŒ–ä¸€ä¸ªæ•°ç»„ã€‚åœ¨PHPæ‰©å±•ä¸­ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡return_valueè¿™ä¸ªå˜é‡è®¾ç½®æ–¹æ³•çš„è¿”å›å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç›´æ¥ä¿®æ”¹è¿™ä¸ªreturn_valueå˜é‡å³å¯ã€‚æ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥æŠŠå®æ–¹æ³•PHP_FUNCTIONå±•å¼€çœ‹ä¸‹ã€‚</p>

<p>PHP7æä¾›äº†ä¸€å¥—å®æ–¹æ³•ç”¨äºéå†å“ˆå¸Œå’Œå¯¹å“ˆå¸Œè¿›è¡Œæ“ä½œã€‚è¿™äº›å®æ–¹æ³•ä¸»è¦æ”¾åœ¨Zend/zend_hash.hæ–‡ä»¶ä¸­ã€‚å¦‚ï¼Œä»£ç ä¸­çš„ZEND_HASH_FOREACH_KEY_VALå°±æ˜¯ä¸€ä¸ªå˜é‡å“ˆå¸Œçš„å®ã€‚æ˜¯ä¸æ˜¯å’ŒPHPä»£ç ä¸­çš„foreachæœ‰ç‚¹åƒï¼Ÿ</p>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬æŠŠä»£ç ä¸­ç”¨åˆ°çš„å“ˆå¸Œç›¸å…³çš„æ–¹æ³•åšä¸‹æ•´ç†è¯´æ˜ï¼š
ZEND_HASH_FOREACH_KEY_VAL å’Œ ZEND_HASH_FOREACH_END é…åˆä½¿ç”¨ï¼Œå®ç°foreachçš„æ•ˆæœã€‚
zend_hash_exists æ£€æµ‹æŒ‡å®šçš„keyåœ¨å“ˆå¸Œä¸­æ˜¯å¦å­˜åœ¨ã€‚keyä¸ºå­—ç¬¦ä¸²ã€‚
zend_hash_index_exists æ£€æµ‹æŒ‡å®šçš„keyåœ¨å“ˆå¸Œä¸­æ˜¯å¦å­˜åœ¨ã€‚keyä¸ºæ•°å­—ã€‚
zend_hash_find æ ¹æ®keyæŸ¥æ‰¾æŒ‡å®šçš„å€¼ã€‚keyä¸ºå­—ç¬¦ä¸²ã€‚
zend_hash_index_find æ ¹æ®keyæŸ¥æ‰¾æŒ‡å®šçš„å€¼ã€‚keyä¸ºæ•°å­—ã€‚
zend_hash_update æ›´æ–°æŒ‡å®škeyçš„å€¼ã€‚keyä¸ºå­—ç¬¦ä¸²ã€‚
zend_hash_index_update æ›´æ–°æŒ‡å®škeyçš„å€¼ã€‚keyä¸ºæ•°å­—ã€‚
åŸºæœ¬ä¸Šæœ‰è¿™äº›æ–¹æ³•ï¼Œä½ å°±å¯ä»¥å¯¹æ•°ç»„è¿›è¡Œä¸€äº›åŸºæœ¬æ“ä½œäº†ã€‚æ–¹æ³•å‘½åä¹Ÿå¾ˆæœ‰è§„å¾‹ï¼Œkeyä¸ºå­—ç¬¦ä¸²å’Œæ•°å­—æä¾›äº†ä¸¤å¥—ã€‚</p>

<p>zval_add_ref(entry); ç»™æ•°ç»„çš„å€¼ï¼Œå¢åŠ ä¸€æ¬¡å¼•ç”¨è®¡æ•°ã€‚zend_hash_updateæ–¹æ³•åªè‡ªåŠ¨ç»™string_keyè‡ªåŠ¨å¢åŠ äº†ä¸€æ¬¡å¼•ç”¨è®¡æ•°ã€‚æ•°ç»„return_valueå…±ç”¨æ•°ç»„arrçš„å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨å¢åŠ ä¸€æ¬¡å¼•ç”¨è®¡æ•°
<!-- more -->
https://blog.csdn.net/u013474436/article/details/53485140</p>

<p>1ã€zend_hash_num_elements è·å–æ•°ç»„å…ƒç´ ä¸ªæ•°ã€‚å®å®šä¹‰å¦‚ä¸‹ï¼š
1 #define zend_hash_num_elements(ht) <br />
2     (ht)-&gt;nNumOfElements
2ã€ZEND_HASH_FOREACH_KEY_VAL éå†æ•°ç»„é”®å€¼ã€‚ä½¿ç”¨æ–¹æ³•ï¼š
1 ZEND_HASH_FOREACH_KEY_VAL(Z_ARRVAL_P(array), num_key, string_key, entry) {
2             // code
3 } ZEND_HASH_FOREACH_END();
ã€€ZEND_HASH_FOREACH_KEY_VALæ˜¯ä¸ªå®å‡½æ•°ï¼š
1 #define ZEND_HASH_FOREACH_KEY_VAL(ht, _h, _key, _val) <br />
2     ZEND_HASH_FOREACH(ht, 0); <br />
3     _h = _p-&gt;h; <br />
4     _key = _p-&gt;key; <br />
5     _val = _z;
ã€€  ç»§ç»­å±•å¼€ ZEND_HASH_FOREACHï¼š</p>

<p>å¤åˆ¶ä»£ç 
1 #define ZEND_HASH_FOREACH(_ht, indirect) do { <br />
2         Bucket *_p = (_ht)-&gt;arData; <br />
3         Bucket *_end = _p + (_ht)-&gt;nNumUsed; <br />
4         for (; _p != _end; _p++) { <br />
5             zval *_z = &amp;_p-&gt;val; <br />
6             if (indirect &amp;&amp; Z_TYPE_P(_z) == IS_INDIRECT) { <br />
7                 _z = Z_INDIRECT_P(_z); <br />
8             } <br />
9             if (UNEXPECTED(Z_TYPE_P(_z) == IS_UNDEF)) continue;
å¤åˆ¶ä»£ç 
ZEND_HASH_FOREACH_ENDå±•å¼€ï¼š
1 #define ZEND_HASH_FOREACH_END() <br />
2         } <br />
3     } while (0)</p>

<p>ZEND_HASH_FOREACH_KEY_VAL(Z_ARRVAL_P(array), num_key, string_key, entry) {
             // code
} ZEND_HASH_FOREACH_END();
å®Œå…¨å±•å¼€ï¼š
å¤åˆ¶ä»£ç 
 1 do { 
 2     Bucket *_p = (_ht)-&gt;arData;  // Z_ARRVAL_P(array) â€”&gt; ht â€”&gt; _ht
 3     Bucket *_end = _p + (_ht)-&gt;nNumUsed;  // èµ·å§‹åœ°å€+åç§»åœ°å€
 4     for (; _p != _end; _p++) { 
 5         zval *_z = &amp;_p-&gt;val; 
 6         if (indirect &amp;&amp; Z_TYPE_P(_z) == IS_INDIRECT) { 
 7             _z = Z_INDIRECT_P(_z); 
 8         } 
 9         if (UNEXPECTED(Z_TYPE_P(_z) == IS_UNDEF)) continue;
10         _h = _p-&gt;h;  // zend_ulong num_key â€”&gt; _h
11         _key = _p-&gt;key; // zend_string *string_key â€”&gt; _key
12         _val = _z; // zval *entry â€”&gt; _val
13         {
14            //code
15         } 
16     } 
17 } while (0)</p>

<p>https://www.cnblogs.com/natian-ws/p/9105338.html</p>
:ET