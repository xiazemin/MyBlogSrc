I"…<!-- more -->
<p>å…¨éƒ¨è§†é¢‘ï¼šhttps://segmentfault.com/a/11â€¦</p>

<p>åŸè§†é¢‘åœ°å€ï¼šhttp://replay.xesv5.com/ll/24â€¦</p>

<p>æµç¨‹å›é¡¾
ä¸ŠèŠ‚è¯¾æˆ‘ä»¬æŠŠ$a=1è¿™ä¸ªè¿‡ç¨‹ç¼–è¯‘æ¢³ç†äº†ä¸€éï¼Œæˆ‘ä»¬äº†è§£åˆ°op1,op2,result,opcodeçš„ç”Ÿæˆè¿‡ç¨‹ï¼Œä¸‹é¢æˆ‘ä»¬æŠŠæ•´ä¸ªè¿‡ç¨‹æ¥å›é¡¾ä¸€ä¸‹ã€‚</p>

<p>static zend_op_array *zend_compile(int type)
{
    zend_op_array *op_array = NULL;
    zend_bool original_in_compilation = CG(in_compilation);</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CG(in_compilation) = 1;
CG(ast) = NULL;
CG(ast_arena) = zend_arena_create(1024 * 32); //é¦–å…ˆä¼šåˆ†é…å†…å­˜

if (!zendparse()) {  //zendparseï¼ˆå°±æ˜¯yyparseï¼‰(zend_language_parse.y) ==&gt; é€šè¿‡parserè°ƒç”¨lexerï¼Œç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘ast_listï¼Œå­˜åˆ°CG(ast)ï¼›yyparseæ˜¯é€šè¿‡bisonç¼–è¯‘zend_language_parser.yç”Ÿæˆ
    int last_lineno = CG(zend_lineno);
    zend_file_context original_file_context;
    zend_oparray_context original_oparray_context;
    zend_op_array *original_active_op_array = CG(active_op_array);

    op_array = emalloc(sizeof(zend_op_array));
    init_op_array(op_array, type, INITIAL_OP_ARRAY_SIZE); //åˆå§‹åŒ–oparray
    CG(active_op_array) = op_array;

    if (zend_ast_process) {
        zend_ast_process(CG(ast));
    }

    zend_file_context_begin(&amp;original_file_context);  
    zend_oparray_context_begin(&amp;original_oparray_context);
    zend_compile_top_stmt(CG(ast));  //ç¼–è¯‘astç”Ÿæˆoparray
    CG(zend_lineno) = last_lineno;
    zend_emit_final_return(type == ZEND_USER_FUNCTION); //PHPä¸­ä¼šåŠ return 1ï¼Œåœ¨æ­¤è¿›è¡Œå¤„ç†
    op_array-&gt;line_start = 1;
    op_array-&gt;line_end = last_lineno;
    pass_two(op_array);  //å¯¹äºhandlerçš„å¤„ç†
    zend_oparray_context_end(&amp;original_oparray_context);
    zend_file_context_end(&amp;original_file_context);

    CG(active_op_array) = original_active_op_array;
}

zend_ast_destroy(CG(ast));
zend_arena_destroy(CG(ast_arena));

CG(in_compilation) = original_in_compilation;

return op_array; } å¤§ä½“æµç¨‹ä¸ºï¼šè¯æ³•åˆ†æ-&gt;è¯­æ³•åˆ†æ-&gt;ç¼–è¯‘astç”Ÿæˆop_array-&gt;å¤„ç†return 1-&gt;å¯¹äºhandleråšå¤„ç† ä»¥ä¸Šå¤„ç†return 1 ç¯èŠ‚ä¹‹å‰çš„æ–‡ç« ä¸­æˆ‘ä»¬éƒ½å·²ç»æåˆ°è¿‡ï¼Œå¦‚æœæœ‰ä¸å¤ªç†è§£çš„è¯·ç¿»é˜…ä¹‹å‰çš„æ–‡ç« ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬gdbç¨‹åºåˆ°ç¯èŠ‚return 1ã€‚ä»£ç ï¼š
</code></pre></div></div>

<p>&lt;?php
$a = 2;
$b = 3;
æˆ‘ä»¬æ¥çœ‹ä¸€çœ‹åˆ°ç¼–è¯‘astç”Ÿæˆop_arrayå¤„çš„ç»“æœï¼š</p>

<p>clipboard.png</p>

<p>æˆ‘ä»¬æ¥çœ‹è¿™ä¸ªç»“æœï¼Œvarsæ˜¯å­˜æˆ‘ä»¬çš„å˜é‡çš„ï¼Œåœ¨è¿™å­˜çš„æ˜¯aå’Œbï¼Œå¹¶ä¸”last_Var=2åªæœ‰ä¸¤ä¸ªï¼›Tæ˜¯temporaryï¼ŒT=2è¯´æ˜æœ‰ä¸¤ä¸ªä¸´æ—¶å˜é‡ã€‚ç„¶åliteralsæ˜¯å­˜æˆ‘ä»¬çš„å­—é¢é‡ï¼Œå†è¿™é‡Œå­˜çš„æ˜¯2ï¼Œ3,last_literal=2è¡¨ç¤ºç°åœ¨æœ‰ä¸¤ä¸ªå­—é¢é‡ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ‰“å°ä¸€ä¸‹çœ‹æ˜¯å¦å’Œæˆ‘ä»¬æ‰€è§£é‡Šçš„ä¸€è‡´ã€‚</p>

<p>clipboard.png</p>

<p>ç»“æœå’Œæˆ‘ä»¬è®¾æƒ³çš„ä¸€è‡´ã€‚å¦å¤–ï¼Œå¯¹äºopcodeçš„å€¼åˆæ˜¯å¦‚ä½•å‘¢ï¼Ÿ</p>

<p>clipboard.png</p>

<p>æˆ‘ä»¬å‘ç°ï¼Œ$a=2 op1æ˜¯80ï¼Œ$b=3 op1ä¸º96ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¹‹å‰æˆ‘ä»¬è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨æ ˆä¸­æˆ‘ä»¬æ˜¯åˆ†é…ä¸€ä¸ªå¤§å°ä¸º16çš„å†…å­˜ï¼Œæ‰€ä»¥éœ€è¦å¢åŠ 16.ç¬¬äºŒä¸ªï¼Œæˆ‘ä»¬çŸ¥é“result.constantçš„0å’Œ1ä»£è¡¨å­—é¢é‡åç§»é‡åˆ†åˆ«ä¸º0å’Œ1.
åˆ°è¿™é‡Œéƒ½æ˜¯ä¹‹å‰å­¦ä¹ è¿‡çš„å†…å®¹ï¼Œæ¥ä¸‹æ¥ç»§ç»­å­¦ä¹ ã€‚</p>

<p>return 1çš„åšäº†ä»€ä¹ˆï¼Ÿ
ç»§ç»­æ‰§è¡Œä»£ç ï¼š</p>

<p>clipboard.png</p>

<p>æˆ‘ä»¬å‘ç°åœ¨æ‰§è¡Œå®Œzend_emit_final_returnè¿™å¥ä¹‹åæˆ‘ä»¬çš„op_arrayå‘ç”Ÿäº†å˜åŒ–ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™æ ·çš„å˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬åœ¨æ–‡ç« å¼€å¤´æœ‰äº›åˆ°è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å¢åŠ return 1ç»“å°¾ï¼Œé‚£ä¹ˆå…·ä½“å…¶ä¸­æ˜¯æ€ä¹ˆæ¥æ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä»£ç ï¼š</p>

<p>void zend_emit_final_return(int return_one) /* {{{ */
{
    znode zn;
    zend_op *ret;
    zend_bool returns_reference = (CG(active_op_array)-&gt;fn_flags &amp; ZEND_ACC_RETURN_REFERENCE) != 0;</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>if (CG(active_op_array)-&gt;fn_flags &amp; ZEND_ACC_HAS_RETURN_TYPE
        &amp;&amp; !(CG(active_op_array)-&gt;fn_flags &amp; ZEND_ACC_GENERATOR)) {
    zend_emit_return_type_check(NULL, CG(active_op_array)-&gt;arg_info - 1, 1);
}

zn.op_type = IS_CONST;
if (return_one) {
    ZVAL_LONG(&amp;zn.u.constant, 1); //åœ¨gdbè¿‡ç¨‹ä¸­ä¼šèµ°åˆ°è¿™ä¸€æ­¥ï¼ŒæŠŠ1èµ‹å€¼ç»™zn.u.constant
} else {
    ZVAL_NULL(&amp;zn.u.constant);
}

ret = zend_emit_op(NULL, returns_reference ? ZEND_RETURN_BY_REF : ZEND_RETURN, &amp;zn, NULL);//åœ¨æ­¤ä¼šåƒå­—é¢é‡ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„å…ƒç´ 1
ret-&gt;extended_value = -1; } static zend_op *zend_emit_op(znode *result, zend_uchar opcode, znode *op1, znode *op2) /* \{\{\{ */ {
zend_op *opline = get_next_op(CG(active_op_array));
opline-&gt;opcode = opcode;

if (op1 == NULL) {
    SET_UNUSED(opline-&gt;op1);
} else {
    SET_NODE(opline-&gt;op1, op1);
}

if (op2 == NULL) {
    SET_UNUSED(opline-&gt;op2);
} else {
    SET_NODE(opline-&gt;op2, op2);
}

zend_check_live_ranges(opline);

if (result) {
    zend_make_var_result(result, opline);
}
return opline; } #define SET_NODE(target, src) do { \
    target ## _type = (src)-&gt;op_type; \
    if ((src)-&gt;op_type == IS_CONST) { \
        target.constant = zend_add_literal(CG(active_op_array), &amp;(src)-&gt;u.constant); \ //å¢åŠ å…ƒç´ 
    } else { \
        target = (src)-&gt;u.op; \
    } \
} while (0) æˆ‘ä»¬å‘ç°ï¼Œgdbè¿‡ç¨‹åœ¨è¿™ä¸ªå‡½æ•°ä¸­åƒliteralsé‡Œè¾¹åˆæ–°å¢1ä¸ªå…ƒç´ ï¼Œæˆ‘ä»¬æ‰“å°opcodesï¼š
</code></pre></div></div>

<p>clipboard.png</p>

<p>æˆ‘ä»¬å‘ç°ï¼Œæ–°å¢äº†ä¸€æ¡æŒ‡ä»¤ï¼Œåœ¨ä»£ç ä¸­å°±æ˜¯return 1ã€‚
å¥½çš„ï¼Œåˆ°æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œæœ‰ä¸‰æ¡æŒ‡ä»¤ï¼Œä¸¤ä¸ªå˜é‡ï¼Œä¸‰ä¸ªå­—é¢é‡ã€‚$aå’Œ$bçš„ä½ç½®å·²ç»æœ‰äº†ï¼Œå­—é¢é‡ä¹Ÿæœ‰äº†ï¼Œæˆ‘ä»¬å‘ç°handlerè¿˜æ˜¯ä¸ªç©ºæŒ‡é’ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹handlerçš„ç”Ÿæˆã€‚</p>

<p>pass_twoè®¾ç½®handler
æˆ‘ä»¬æ¥ç€èµ°ï¼Œä¼šèµ°åˆ°pass_twoè¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­ï¼Œå¯¹oplineæŒ‡ä»¤é›†åšäº†è¿›ä¸€æ­¥çš„åŠ å·¥ï¼Œæœ€ä¸»è¦çš„å·¥ä½œæ˜¯è®¾ç½®æŒ‡ä»¤çš„handler,</p>
:ET