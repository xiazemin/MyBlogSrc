I"î<p>https://www.cyningsun.com/05-11-2020/proto-marshal-panic.html
èƒŒæ™¯ä»‹ç»
åœ¨æ–‹æœˆèŠ‚å¤§ä¿ƒå‹æµ‹æœŸé—´ï¼Œæœ‰ä¸€ä¸ªä¸šåŠ¡å‹æµ‹å‘ç°ï¼Œæœ‰ä¸€ä¸ªRPCè°ƒç”¨ï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹å‡ºç°panicï¼Œè€Œpanicçš„ä½ç½®æ˜¯åœ¨å¾®æœåŠ¡æ¡†æ¶åºåˆ—åŒ–çš„ä½ç½®(proto.Marshal)ã€‚ä½†æ˜¯ç”±äºæ¡†æ¶åœ¨è¿‘æœŸæ²¡æœ‰åšä»€ä¹ˆå˜æ›´ï¼Œè€Œä¸”ä¸šåŠ¡æœ€è¿‘ä¹Ÿæ²¡ä¸Šçº¿ä»€ä¹ˆæ–°çš„éœ€æ±‚ã€‚æ‰€æœ‰çš„Panicä»…åœ¨å¹¶å‘é‡è¾ƒé«˜çš„æ—¶å€™å¶ç„¶å‡ºç°ï¼Œå¹¶ä¸”è¢«æ¡†æ¶çš„recoveræ•è·ï¼Œå› æ­¤åˆ¤å®šæ­¤é—®é¢˜å·²ç»åœ¨çº¿ä¸Šå¾ˆä¹…ï¼Œåªæ˜¯ç”±äºå‡ºç°çš„æ¦‚ç‡è¾ƒä½æ²¡æœ‰è¢«å‘ç°ã€‚</p>

<p>ç¤ºä¾‹ä»£ç ï¼š</p>

<p>2020/05/11 19:56:32 http: panic serving 127.0.0.1:59816: runtime error: index out of range
goroutine 20 [running]:
net/http.(*conn).serve.func1(0xc00015e0a0)
	/usr/local/Cellar/go@1.12/1.12.13/libexec/src/net/http/server.go:1769 +0x139
panic(0x13c1cc0, 0x175ad90)
	/usr/local/Cellar/go@1.12/1.12.13/libexec/src/runtime/panic.go:522 +0x1b5
github.com/cyningsun/go-test/20200508-go-race/pb.encodeVarintPerson(0xc000228ec0, 0x3c, 0x3c, 0x3c, 0x1f, 0x3b)
	/Users/yinhang.sun/Documents/workspace/src/github.com/cyningsun/go-test/20200508-go-race/pb/person.pb.go:146 +0x6a</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	...
	
/Users/yinhang.sun/Documents/workspace/src/github.com/cyningsun/go-test/20200508-go-race/pb/person.pb.go:47 +0x5b github.com/gogo/protobuf/proto.Marshal(0x14af2e0, 0xc0000bc040, 0x1, 0x140e400, 0xc0000bc040, 0xc00015c001, 0x0)

	...
	
/usr/local/Cellar/go@1.12/1.12.13/libexec/src/net/http/server.go:2884 +0x2f4 ç”±äºæŠ¥é”™çš„ç»“æ„ä½“æ˜¯ä¸šåŠ¡æœ€å¸¸ç”¨çš„ä¸€ä¸ªï¼Œä¸”æŠ¥é”™çš„æ¥å£é€»è¾‘è¾ƒæ·±ï¼Œé€šè¯»ä»£ç ä¹Ÿæ²¡æœ‰å‘ç°æ˜æ˜¾çš„ç‚¹ï¼ˆå…¶å®æ˜¯ä»£ç é‡å¤ªå¤§äº†ï¼Œå¾ˆéš¾å…³æ³¨çš„åˆ°ï¼‰ã€‚æŠ¥é”™åˆå‡ºç°åœ¨æ¡†æ¶å±‚ï¼Œpanic è°ƒç”¨æ ˆå¹¶æ²¡æœ‰æä¾›ä»»ä½•æœ‰æ•ˆä¿¡æ¯ã€‚ &lt;!-- more --&gt; é—®é¢˜æ’æŸ¥ ç»è¿‡èƒŒæ™¯çš„ä¸€ç³»åˆ—åˆ†æä¹‹åï¼Œæ‰€æœ‰çš„æ’æŸ¥æ€è·¯éƒ½è¢«æ‰“æ–­äº†ã€‚å¥½åœ¨æˆ‘ä»¬å‘ç°æŠ¥é”™çš„é”™è¯¯ç±»å‹æ˜¯index out of rangeï¼Œé€šè¿‡é˜…è¯»proto.Marshalçš„ä»£ç ä¹‹åå‘ç°ï¼Œæ­¤å‡½æ•°åˆ†ä¸ºä¸‰æ­¥ï¼š
</code></pre></div></div>

<p>siz := info.Size(pb)
b := make([]byte, 0, siz)
return info.Marshal(b, pb, false)
å…ˆè·å–ç»“æ„ä½“ Size
ç„¶åæŒ‰ç…§ Size åˆ›å»ºå­—èŠ‚æ•°ç»„
å°†æ•°æ®åºåˆ—åŒ–åˆ°å­—èŠ‚æ•°ç»„ä¸­
å› æ­¤ï¼Œåˆç†çŒœæµ‹æ˜¯å†è·å– Sizeä¹‹åï¼ŒMarshalä¹‹å‰ï¼Œç»“æ„ä½“çš„å¤§å°å‘ç”Ÿäº†å˜åŒ–ã€‚å°† protobuf çš„ç±»å‹åˆ†ç±»ï¼Œå¯ä»¥æ’é™¤å›ºå®šé•¿åº¦çš„æ•°å€¼ç±»å‹ï¼Œå‰©ä¸‹å°±æ˜¯å˜é•¿çš„ string ç±»å‹å’Œ bytes ç±»å‹ã€‚è™½ç„¶æœ‰äº†è¿™ä¸ªæ¨è®ºï¼Œç”±äºå‘ç”Ÿpanicçš„ç»“æ„ä½“ååˆ†å¤æ‚ï¼Œè¿˜æ˜¯å¾ˆéš¾å®šä½åˆ°å…·ä½“æ˜¯å“ªä¸ªå­—æ®µå˜åŒ–å¯¼è‡´çš„ã€‚æœ€åæ²¡æœ‰åŠæ³•åªæœ‰ä½¿ç”¨å¾ˆç¬¨çš„æ–¹æ³•ï¼Œä¿®æ”¹ vendor ä¸­çš„ protobuf ä»£ç ï¼Œæ·»åŠ æ—¥å¿—ï¼Œä½¿ç”¨äºŒåˆ†æ³•ï¼Œåœ¨info.Size()å’Œinfo.Marshal()ä¸­æ‰“å°å­—æ®µçš„åç§»é‡ï¼Œå¹¶ä¸”åœ¨proto.Marshalä¸­ç›´æ¥æ•è·å‘ç”Ÿpanicçš„åç¨‹å†æ‰“å°æ•°æ®ï¼Œé¿å…å…¨éƒ¨æ‰“å°æ—¶panicè¯·æ±‚ä¸æ—¥å¿—æ— æ³•å¯¹åº”ã€‚ç„¶åå¯¹æ¯”æ’æŸ¥ï¼Œæœ€ç»ˆå®šä½åˆ°äº†å‡ºç°é—®é¢˜çš„å­—æ®µï¼Œç„¶åæ ¹æ®ç›¸å…³å­—æ®µæœç´¢ç›¸å…³ä»£ç ï¼Œæœ€ç»ˆå®šä½åˆ°äº†é—®é¢˜æ‰€åœ¨ã€‚</p>

<p>é—®é¢˜åæ€
ä¿®å¤å®Œé—®é¢˜ä¹‹åï¼Œä¿ƒä½¿æˆ‘ä»¬åæ€ï¼Œéš¾é“æ’æŸ¥ç±»ä¼¼çš„é—®é¢˜ä¸€å®šè¦å¦‚æ­¤è‰°éš¾ä¹ˆï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆé€šç”¨çš„æ–¹æ¡ˆæ¥æ’æŸ¥ç±»ä¼¼çš„é—®é¢˜å‘¢ã€‚ä»é—®é¢˜æºå¤´å‡ºå‘ï¼Œè¯¥é—®é¢˜æœ¬è´¨æ¥è¯´è¿˜æ˜¯æ•°æ®çš„åç¨‹å¹¶å‘è®¿é—®é¢˜ï¼Œæœ‰äº†è¿™ä¸ªç»“è®ºå†çœ‹æˆ‘ä»¬æ‰‹å¤´çš„å·²æœ‰å·¥å…·ï¼Œgolang race å·¥å…· å‡ºç°åœ¨çœ¼å‰ã€‚</p>

<p>ç†è®ºä¸Šè®²ï¼Œå¯ä»¥åœ¨éç”Ÿäº§ç¯å¢ƒæ‰“å¼€ race å‚æ•°ï¼Œè¾…åŠ©å®šä½é—®é¢˜ã€‚è¯´åšå°±åšï¼ŒæŒ‰ç…§é—®é¢˜çš„åŸå› ï¼Œç¼–å†™æµ‹è¯•å¤ç°çš„test case</p>

<p>è¿›ç¨‹ç¼“å­˜</p>

<p>const Max = uint64(1)
type PersonCache struct {
	c *gocache.Cache
}</p>

<p>func NewPersonCache() *PersonCache {
	one := &amp;PersonCache{c:gocache.New(time.Minute, time.Hour)}
	go one.load()
	return one
}</p>

<p>func (p *PersonCache) load() {
	for i:=uint64(0); i &lt; Max; i++{
		r :=  i % 100
		key := strconv.FormatUint(r,10)
		newOne := &amp;pb.Person{
			Id:                   proto.Uint64(r),
			Name:                 proto.String(â€œinit Nameâ€),
			Age:                  proto.Uint32(rand.Uint32()),
			Address:   proto.String(â€œinit addressâ€),
		}
		p.c.Set(key, newOne, time.Minute)
	}
}</p>

<p>func (p <em>PersonCache) Get(key string) (</em>pb.Person,bool) {
	ret, ok := p.c.Get(key)
	if !ok {
		return nil, false
	}
	return ret.(*pb.Person),true
}
å¹¶å‘è®¿é—®</p>

<p>const letterBytes = â€œabcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZâ€
const letterLength = len(letterBytes)</p>

<p>var (
	c = cache.NewPersonCache()
)</p>

<p>func randString(n int) string {
	b := make([]byte, n)
	for i := range b {
		b[i] = letterBytes[rand.Intn(len(letterBytes))]
	}
	return string(b)
}</p>

<p>func Write(w http.ResponseWriter, req *http.Request) {
	r := rand.Uint64() % cache.Max
	key := strconv.FormatUint(r, 10)
	p, ok := c.Get(key)
	if !ok {
		return
	}
	p.Name = proto.String(randString(rand.Int()%letterLength))
	time.Sleep(time.Nanosecond)
	p.Address = proto.String(randString(rand.Int()%letterLength))
}</p>

<p>func Read(w http.ResponseWriter, req *http.Request) {
	r :=  rand.Uint64() % cache.Max
	key := strconv.FormatUint(r,10)
	p,ok := c.Get(key)
	if !ok {
		return
	}
	b,_ := proto.Marshal(p)
	w.Write(b)
}</p>

<p>func main() {
	http.HandleFunc(â€œ/readâ€, Read)
	http.HandleFunc(â€œ/writeâ€, Write)
	fmt.Println(â€œserver is listening on 8080â€)
	http.ListenAndServe(â€œ:8080â€, nil)
}
å‹æµ‹è„šæœ¬</p>

<p>run:
	go run main.go &amp;&gt; normal.log</p>

<p>racerun:
	go run -race main.go &amp;&gt; race.log</p>

<p>benchmark:
	wrk -t1 -c2 -d30s http://127.0.0.1:8080/read &amp;
	wrk -t1 -c2 -d30s http://127.0.0.1:8080/write &amp;
æ—¥å¿—ç»“æœ</p>

<p>==================
WARNING: DATA RACE
Read at 0x00c000188140 by goroutine 11:
  github.com/cyningsun/go-test/20200508-go-race/pb.(*Person).Size()</p>

<p>â€¦</p>

<p>Previous write at 0x00c000188140 by goroutine 55:
  main.Write()
      /Users/yinhang.sun/Documents/workspace/src/github.com/cyningsun/go-test/20200508-go-race/main.go:39 +0x271</p>

<p>â€¦
é€šè¿‡æ—¥å¿—ï¼Œå¯ä»¥å¾ˆè½»æ¾çš„å‘ç°é—®é¢˜çš„åŸå› ã€‚</p>

<p>æ€»ç»“ä¼˜åŒ–
ä»¥ä¸Šè¿‡ç¨‹ä¿ƒä½¿æˆ‘ä»¬ä¼˜åŒ–éç”Ÿäº§ç¯å¢ƒçš„è¿è¡Œè„šæœ¬ï¼Œé€šè¿‡ç¼–è¯‘å‚æ•°æ§åˆ¶ -race å‚æ•°çš„å¼€å…³ï¼Œå½“å†é‡åˆ°ç±»ä¼¼çš„é—®é¢˜æ—¶ï¼Œå¯ä»¥å¿«é€Ÿå¤ç°ã€å®šä½ã€ä¿®å¤ã€‚</p>
:ET