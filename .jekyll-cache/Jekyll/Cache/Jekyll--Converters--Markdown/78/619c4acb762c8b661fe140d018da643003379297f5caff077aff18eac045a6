I"ç/<!-- more -->
<p>ä¸€ã€æ¦‚å¿µï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  åˆ†ç‰‡ï¼ˆshardingï¼‰æ˜¯æŒ‡å°†æ•°æ®åº“æ‹†åˆ†ï¼Œå°†å…¶åˆ†æ•£åœ¨ä¸åŒçš„æœºå™¨ä¸Šçš„è¿‡ç¨‹ã€‚å°†æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œä¸éœ€è¦åŠŸèƒ½å¼ºå¤§çš„æœåŠ¡å™¨å°±å¯ä»¥å­˜å‚¨æ›´å¤šçš„æ•°æ®å’Œå¤„ç†æ›´å¤§çš„è´Ÿè½½ã€‚åŸºæœ¬æ€æƒ³å°±æ˜¯å°†é›†åˆåˆ‡æˆå°å—ï¼Œè¿™äº›å—åˆ†æ•£åˆ°è‹¥å¹²ç‰‡é‡Œï¼Œæ¯ä¸ªç‰‡åªè´Ÿè´£æ€»æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªå‡è¡¡å™¨æ¥å¯¹å„ä¸ªåˆ†ç‰‡è¿›è¡Œå‡è¡¡ï¼ˆæ•°æ®è¿ç§»ï¼‰ã€‚é€šè¿‡ä¸€ä¸ªåä¸ºmongosçš„è·¯ç”±è¿›ç¨‹è¿›è¡Œæ“ä½œï¼ŒmongosçŸ¥é“æ•°æ®å’Œç‰‡çš„å¯¹åº”å…³ç³»ï¼ˆé€šè¿‡é…ç½®æœåŠ¡å™¨ï¼‰ã€‚å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯éƒ½æ˜¯è§£å†³ç£ç›˜ç©ºé—´çš„é—®é¢˜ï¼Œå¯¹äºå†™å…¥æœ‰å¯èƒ½ä¼šå˜å·®ï¼ˆ+++é‡Œé¢çš„è¯´æ˜+++ï¼‰ï¼ŒæŸ¥è¯¢åˆ™å°½é‡é¿å…è·¨åˆ†ç‰‡æŸ¥è¯¢ã€‚ä½¿ç”¨åˆ†ç‰‡çš„æ—¶æœºï¼š
</code></pre></div></div>

<p>1ï¼Œæœºå™¨çš„ç£ç›˜ä¸å¤Ÿç”¨äº†ã€‚ä½¿ç”¨åˆ†ç‰‡è§£å†³ç£ç›˜ç©ºé—´çš„é—®é¢˜ã€‚
2ï¼Œå•ä¸ªmongodå·²ç»ä¸èƒ½æ»¡è¶³å†™æ•°æ®çš„æ€§èƒ½è¦æ±‚ã€‚é€šè¿‡åˆ†ç‰‡è®©å†™å‹åŠ›åˆ†æ•£åˆ°å„ä¸ªåˆ†ç‰‡ä¸Šé¢ï¼Œä½¿ç”¨åˆ†ç‰‡æœåŠ¡å™¨è‡ªèº«çš„èµ„æºã€‚
3ï¼Œæƒ³æŠŠå¤§é‡æ•°æ®æ”¾åˆ°å†…å­˜é‡Œæé«˜æ€§èƒ½ã€‚å’Œä¸Šé¢ä¸€æ ·ï¼Œé€šè¿‡åˆ†ç‰‡ä½¿ç”¨åˆ†ç‰‡æœåŠ¡å™¨è‡ªèº«çš„èµ„æºã€‚
äºŒã€éƒ¨ç½²å®‰è£…ï¼š å‰ææ˜¯å®‰è£…äº†mongodbï¼ˆæœ¬æ–‡ç”¨3.0æµ‹è¯•ï¼‰</p>

<p>åœ¨æ­å»ºåˆ†ç‰‡ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸‹åˆ†ç‰‡ä¸­å„ä¸ªè§’è‰²çš„ä½œç”¨ã€‚</p>

<p>â‘  é…ç½®æœåŠ¡å™¨ã€‚æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„mongodè¿›ç¨‹ï¼Œä¿å­˜é›†ç¾¤å’Œåˆ†ç‰‡çš„å…ƒæ•°æ®ï¼Œå³å„åˆ†ç‰‡åŒ…å«äº†å“ªäº›æ•°æ®çš„ä¿¡æ¯ã€‚æœ€å…ˆå¼€å§‹å»ºç«‹ï¼Œå¯ç”¨æ—¥å¿—åŠŸèƒ½ã€‚åƒå¯åŠ¨æ™®é€šçš„mongodä¸€æ ·å¯åŠ¨é…ç½®æœåŠ¡å™¨ï¼ŒæŒ‡å®šconfigsvré€‰é¡¹ã€‚ä¸éœ€è¦å¤ªå¤šçš„ç©ºé—´å’Œèµ„æºï¼Œé…ç½®æœåŠ¡å™¨çš„1KBç©ºé—´ç›¸å½“äºçœŸæ˜¯æ•°æ®çš„200MBã€‚ä¿å­˜çš„åªæ˜¯æ•°æ®çš„åˆ†å¸ƒè¡¨ã€‚å½“æœåŠ¡ä¸å¯ç”¨ï¼Œåˆ™å˜æˆåªè¯»ï¼Œæ— æ³•åˆ†å—ã€è¿ç§»æ•°æ®ã€‚
â‘¡ è·¯ç”±æœåŠ¡å™¨ã€‚å³mongosï¼Œèµ·åˆ°ä¸€ä¸ªè·¯ç”±çš„åŠŸèƒ½ï¼Œä¾›ç¨‹åºè¿æ¥ã€‚æœ¬èº«ä¸ä¿å­˜æ•°æ®ï¼Œåœ¨å¯åŠ¨æ—¶ä»é…ç½®æœåŠ¡å™¨åŠ è½½é›†ç¾¤ä¿¡æ¯ï¼Œå¼€å¯mongosè¿›ç¨‹éœ€è¦çŸ¥é“é…ç½®æœåŠ¡å™¨çš„åœ°å€ï¼ŒæŒ‡å®šconfigdbé€‰é¡¹ã€‚
â‘¢ åˆ†ç‰‡æœåŠ¡å™¨ã€‚æ˜¯ä¸€ä¸ªç‹¬ç«‹æ™®é€šçš„mongodè¿›ç¨‹ï¼Œä¿å­˜æ•°æ®ä¿¡æ¯ã€‚å¯ä»¥æ˜¯ä¸€ä¸ªå‰¯æœ¬é›†ä¹Ÿå¯ä»¥æ˜¯å•ç‹¬çš„ä¸€å°æœåŠ¡å™¨ã€‚
éƒ¨ç½²ç¯å¢ƒï¼š3å°æœºå­</p>

<p>Aï¼šé…ç½®(3)ã€è·¯ç”±1ã€åˆ†ç‰‡1ï¼›</p>

<p>Bï¼šåˆ†ç‰‡2ï¼Œè·¯ç”±2ï¼›</p>

<p>Cï¼šåˆ†ç‰‡3</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  åœ¨éƒ¨ç½²ä¹‹å‰å…ˆæ˜ç™½ç‰‡é”®çš„æ„ä¹‰ï¼Œä¸€ä¸ªå¥½çš„ç‰‡é”®å¯¹åˆ†ç‰‡è‡³å…³é‡è¦ã€‚ç‰‡é”®å¿…é¡»æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œæ•°æ®æ ¹æ®è¿™ä¸ªç‰‡é”®è¿›è¡Œæ‹†åˆ†åˆ†æ•£ã€‚é€šè¿‡sh.shardCollectionåŠ ä¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ã€‚ä¸€ä¸ªè‡ªå¢çš„ç‰‡é”®å¯¹å†™å…¥å’Œæ•°æ®å‡åŒ€åˆ†å¸ƒå°±ä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºè‡ªå¢çš„ç‰‡é”®æ€»ä¼šåœ¨ä¸€ä¸ªåˆ†ç‰‡ä¸Šå†™å…¥ï¼Œåç»­è¾¾åˆ°æŸä¸ªé˜€å€¼å¯èƒ½ä¼šå†™åˆ°åˆ«çš„åˆ†ç‰‡ã€‚ä½†æ˜¯æŒ‰ç…§ç‰‡é”®æŸ¥è¯¢ä¼šéå¸¸é«˜æ•ˆã€‚éšæœºç‰‡é”®å¯¹æ•°æ®çš„å‡åŒ€åˆ†å¸ƒæ•ˆæœå¾ˆå¥½ã€‚æ³¨æ„å°½é‡é¿å…åœ¨å¤šä¸ªåˆ†ç‰‡ä¸Šè¿›è¡ŒæŸ¥è¯¢ã€‚åœ¨æ‰€æœ‰åˆ†ç‰‡ä¸ŠæŸ¥è¯¢ï¼Œmongosä¼šå¯¹ç»“æœè¿›è¡Œå½’å¹¶æ’åºã€‚
</code></pre></div></div>

<p>å¯åŠ¨ä¸Šé¢è¿™äº›æœåŠ¡ï¼Œå› ä¸ºåœ¨åå°è¿è¡Œï¼Œæ‰€ä»¥ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼Œé…ç½®æ–‡ä»¶è¯´æ˜ã€‚</p>

<p>1ï¼‰é…ç½®æœåŠ¡å™¨çš„å¯åŠ¨ã€‚(Aä¸Šå¼€å¯3ä¸ªï¼ŒPortï¼š20000ã€21000ã€22000)</p>

<p>é…ç½®æœåŠ¡å™¨æ˜¯ä¸€ä¸ªæ™®é€šçš„mongodè¿›ç¨‹ï¼Œæ‰€ä»¥åªéœ€è¦æ–°å¼€ä¸€ä¸ªå®ä¾‹å³å¯ã€‚é…ç½®æœåŠ¡å™¨å¿…é¡»å¼€å¯1ä¸ªæˆ–åˆ™3ä¸ªï¼Œå¼€å¯2ä¸ªåˆ™ä¼šæŠ¥é”™ï¼š</p>

<p>BadValue need either 1 or 3 configdbs
å› ä¸ºè¦æ”¾åˆ°åå°ç”¨ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨ï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p>

<p>/etc/mongod_20000.conf</p>

<p>å¤åˆ¶ä»£ç 
#æ•°æ®ç›®å½•
dbpath=/usr/local/config/
#æ—¥å¿—æ–‡ä»¶
logpath=/var/log/mongodb/mongodb_config.log
#æ—¥å¿—è¿½åŠ 
logappend=true
#ç«¯å£
port = 20000
#æœ€å¤§è¿æ¥æ•°
maxConns = 50
pidfilepath = /var/run/mongo_20000.pid
#æ—¥å¿—,redo log
journal = true
#åˆ·å†™æäº¤æœºåˆ¶
journalCommitInterval = 200
#å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
fork = true
#åˆ·å†™æ•°æ®åˆ°æ—¥å¿—çš„é¢‘ç‡
syncdelay = 60
#storageEngine = wiredTiger
#æ“ä½œæ—¥å¿—,å•ä½M
oplogSize = 1000
#å‘½åç©ºé—´çš„æ–‡ä»¶å¤§å°,é»˜è®¤16Mï¼Œæœ€å¤§2Gã€‚
nssize = 16
noauth = true
unixSocketPrefix = /tmp
configsvr = true
å¤åˆ¶ä»£ç 
/etc/mongod_21000.conf</p>

<p>å¤åˆ¶ä»£ç 
æ•°æ®ç›®å½•
dbpath=/usr/local/config1/
#æ—¥å¿—æ–‡ä»¶
logpath=/var/log/mongodb/mongodb_config1.log
#æ—¥å¿—è¿½åŠ 
logappend=true
#ç«¯å£
port = 21000
#æœ€å¤§è¿æ¥æ•°
maxConns = 50
pidfilepath = /var/run/mongo_21000.pid
#æ—¥å¿—,redo log
journal = true
#åˆ·å†™æäº¤æœºåˆ¶
journalCommitInterval = 200
#å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
fork = true
#åˆ·å†™æ•°æ®åˆ°æ—¥å¿—çš„é¢‘ç‡
syncdelay = 60
#storageEngine = wiredTiger
#æ“ä½œæ—¥å¿—,å•ä½M
oplogSize = 1000
#å‘½åç©ºé—´çš„æ–‡ä»¶å¤§å°,é»˜è®¤16Mï¼Œæœ€å¤§2Gã€‚
nssize = 16
noauth = true
unixSocketPrefix = /tmp
configsvr = true
å¤åˆ¶ä»£ç 
å¼€å¯é…ç½®æœåŠ¡å™¨ï¼š</p>

<p>å¤åˆ¶ä»£ç 
root@mongo1:~# mongod -f /etc/mongod_20000.conf 
about to fork child process, waiting until server is ready for connections.
forked process: 8545
child process started successfully, parent exiting</p>

<p>root@mongo1:~# mongod -f /etc/mongod_21000.conf 
about to fork child process, waiting until server is ready for connections.
forked process: 8595
child process started successfully, parent exiting
å¤åˆ¶ä»£ç 
åŒç†å†èµ·ä¸€ä¸ª22000ç«¯å£çš„é…ç½®æœåŠ¡å™¨ã€‚</p>

<p>View Code
2ï¼‰è·¯ç”±æœåŠ¡å™¨çš„å¯åŠ¨ã€‚(Aã€Bä¸Šå„å¼€å¯1ä¸ªï¼ŒPortï¼š30000)</p>

<p>è·¯ç”±æœåŠ¡å™¨ä¸ä¿å­˜æ•°æ®ï¼ŒæŠŠæ—¥å¿—è®°å½•ä¸€ä¸‹å³å¯ã€‚</p>

<p>å¤åˆ¶ä»£ç </p>
<h1 id="mongos">mongos</h1>

<p>#æ—¥å¿—æ–‡ä»¶
logpath=/var/log/mongodb/mongodb_route.log
#æ—¥å¿—è¿½åŠ 
logappend=true
#ç«¯å£
port = 30000
#æœ€å¤§è¿æ¥æ•°
maxConns = 100
#ç»‘å®šåœ°å€
#bind_ip=192.168.200.*,â€¦,</p>

<p>pidfilepath = /var/run/mongo_30000.pid</p>

<p>configdb=192.168.200.A:20000,192.168.200.A:21000,192.168.200.A:22000  #å¿…é¡»æ˜¯1ä¸ªæˆ–åˆ™3ä¸ªé…ç½® ã€‚
#configdb=127.0.0.1:20000  #æŠ¥é”™
#å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼ fork = true
å¤åˆ¶ä»£ç 
å…¶ä¸­æœ€é‡è¦çš„å‚æ•°æ˜¯configdbï¼Œä¸èƒ½åœ¨å…¶åé¢å¸¦çš„é…ç½®æœåŠ¡å™¨çš„åœ°å€å†™æˆlocalhostæˆ–åˆ™127.0.0.1ï¼Œéœ€è¦è®¾ç½®æˆå…¶ä»–åˆ†ç‰‡ä¹Ÿèƒ½è®¿é—®çš„åœ°å€ï¼Œå³192.168.200.A:20000/21000/22000ã€‚å¦åˆ™åœ¨addshardçš„æ—¶å€™ä¼šæŠ¥é”™ï¼š</p>

<p>{
â€œokâ€ : 0,
â€œerrmsgâ€ : â€œcanâ€™t use localhost as a shard since all shards need to communicate. either use all shards and configdbs in localhost or all in actual IPs  host: 172.16.5.104:20000 isLocalHost:0â€
}
å¼€å¯mongosï¼š</p>

<p>root@mongo1:~# mongos -f /etc/mongod_30000.conf 
2015-07-10T14:42:58.741+0800 W SHARDING running with 1 config server should be done only for testing purposes and is not recommended for production
about to fork child process, waiting until server is ready for connections.
forked process: 8965
child process started successfully, parent exiting
3ï¼‰åˆ†ç‰‡æœåŠ¡å™¨çš„å¯åŠ¨ï¼š</p>

<p>å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„mongodè¿›ç¨‹ï¼š</p>

<p>root@mongo1:~# mongod -f /etc/mongod_40000.conf 
note: noprealloc may hurt performance in many applications
about to fork child process, waiting until server is ready for connections.
forked process: 9020
child process started successfully, parent exiting
AæœåŠ¡å™¨ä¸Šé¢çš„æœåŠ¡å¼€å¯å®Œæ¯•</p>

<p>root@mongo1:~# ps -ef | grep mongo
root      9020     1  0 14:47 ?        00:00:06 mongod -f /etc/mongod_40000.conf
root      9990     1  0 15:14 ?        00:00:02 mongod -f /etc/mongod_20000.conf
root     10004     1  0 15:14 ?        00:00:01 mongod -f /etc/mongod_21000.conf
root     10076     1  0 15:20 ?        00:00:00 mongod -f /etc/mongod_22000.conf
root     10096     1  0 15:20 ?        00:00:00 mongos -f /etc/mongod_30000.conf
æŒ‰ç…§ä¸Šé¢çš„æ–¹æ³•å†åˆ°Bä¸Šå¼€å¯åˆ†ç‰‡æœåŠ¡å’Œè·¯ç”±æœåŠ¡(é…ç½®æ–‡ä»¶ä¸€æ ·)ï¼Œä»¥åŠåœ¨Cä¸Šå¼€å¯åˆ†ç‰‡æœåŠ¡ã€‚åˆ°æ­¤åˆ†ç‰‡çš„é…ç½®æœåŠ¡å™¨ã€è·¯ç”±æœåŠ¡å™¨ã€åˆ†ç‰‡æœåŠ¡å™¨éƒ½å·²ç»éƒ¨ç½²å®Œæˆã€‚</p>

<p>ä¸‰ã€é…ç½®åˆ†ç‰‡ï¼šä¸‹é¢çš„æ“ä½œéƒ½æ˜¯åœ¨mongodbçš„å‘½ä»¤è¡Œé‡Œæ‰§è¡Œ</p>

<p>1ï¼‰æ·»åŠ åˆ†ç‰‡ï¼šsh.addShard(â€œIP:Portâ€)</p>

<p>ç™»é™†è·¯ç”±æœåŠ¡å™¨mongos æ“ä½œï¼š</p>

<p>root@mongo1:~# mongo â€“port=30000
MongoDB shell version: 3.0.4
connecting to: 127.0.0.1:30000/test
mongos&gt; 
æ·»åŠ åˆ†ç‰‡ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; sh.status()    #æŸ¥çœ‹é›†ç¾¤çš„ä¿¡æ¯
â€” Sharding Status â€” 
  sharding version: {
    â€œ_idâ€ : 1,
    â€œminCompatibleVersionâ€ : 5,
    â€œcurrentVersionâ€ : 6,
    â€œclusterIdâ€ : ObjectId(â€œ559f72470f93270ba60b26c6â€)
}
  shards:
  balancer:
    Currently enabled:  yes
    Currently running:  no
    Failed balancer rounds in last 5 attempts:  0
    Migration Results for the last 24 hours: 
        No recent migrations
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }</p>

<p>mongos&gt; sh.addShard(â€œ192.168.200.A:40000â€) #æ·»åŠ åˆ†ç‰‡
{ â€œshardAddedâ€ : â€œshard0000â€, â€œokâ€ : 1 }
mongos&gt; sh.addShard(â€œ192.168.200.B:40000â€) #æ·»åŠ åˆ†ç‰‡
{ â€œshardAddedâ€ : â€œshard0001â€, â€œokâ€ : 1 }
mongos&gt; sh.addShard(â€œ192.168.200.C:40000â€) #æ·»åŠ åˆ†ç‰‡
{ â€œshardAddedâ€ : â€œshard0002â€, â€œokâ€ : 1 }</p>

<p>mongos&gt; sh.status()    #æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯
â€” Sharding Status â€” 
  sharding version: {
    â€œ_idâ€ : 1,
    â€œminCompatibleVersionâ€ : 5,
    â€œcurrentVersionâ€ : 6,
    â€œclusterIdâ€ : ObjectId(â€œ559f72470f93270ba60b26c6â€)
}
  shards:  #åˆ†ç‰‡ä¿¡æ¯
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.A:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.B:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.C:40000â€ }
  balancer:
    Currently enabled:  yes
    Currently running:  no
    Failed balancer rounds in last 5 attempts:  0
    Migration Results for the last 24 hours: 
        No recent migrations
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
å¤åˆ¶ä»£ç 
2ï¼‰å¼€å¯åˆ†ç‰‡åŠŸèƒ½ï¼šsh.enableSharding(â€œåº“åâ€)ã€sh.shardCollection(â€œåº“å.é›†åˆåâ€,{â€œkeyâ€:1})</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; sh.enableSharding(â€œdbaâ€)  #é¦–å…ˆå¯¹æ•°æ®åº“å¯ç”¨åˆ†ç‰‡
{ â€œokâ€ : 1 }
mongos&gt; sh.status()               #æŸ¥çœ‹åˆ†ç‰‡ä¿¡æ¯
â€” Sharding Status â€”â€¦
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }</p>

<p>mongos&gt; sh.shardCollection(â€œdba.accountâ€,{â€œnameâ€:1})    #å†å¯¹é›†åˆè¿›è¡Œåˆ†ç‰‡ï¼Œnameå­—æ®µæ˜¯ç‰‡é”®ã€‚ç‰‡é”®çš„é€‰æ‹©ï¼šåˆ©äºåˆ†å—ã€åˆ†æ•£å†™è¯·æ±‚ã€æŸ¥è¯¢æ•°æ®ã€‚
{ â€œcollectionshardedâ€ : â€œdba.accountâ€, â€œokâ€ : 1 }
mongos&gt; sh.status()
â€” Sharding Status â€”â€¦
  shards:
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.51:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.52:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.53:40000â€ }
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }  #åº“
        dba.account
            shard key: { â€œnameâ€ : 1 }                                    #é›†åˆ
            chunks:
                shard0000    1
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(1, 0) 
å¤åˆ¶ä»£ç 
ä¸Šé¢åŠ ç²—éƒ¨åˆ†è¡¨ç¤ºåˆ†ç‰‡ä¿¡æ¯å·²ç»é…ç½®å®Œæˆã€‚è¦æ˜¯å‡ºç°ï¼š</p>

<p>too many chunks to print, use verbose if you want to force print
æƒ³è¦çœ‹åˆ°è¯¦ç»†çš„ä¿¡æ¯åˆ™éœ€è¦æ‰§è¡Œï¼š</p>

<p>mongos&gt; sh.status({â€œverboseâ€:1})
æˆ–åˆ™
mongos&gt; db.printShardingStatus(â€œvvvvâ€)
æˆ–åˆ™
mongos&gt; printShardingStatus(db.getSisterDB(â€œconfigâ€),1)
å››ã€æµ‹è¯• ï¼šå¯¹dbaåº“çš„accounté›†åˆè¿›è¡Œæµ‹è¯•ï¼Œéšæœºå†™å…¥ï¼ŒæŸ¥çœ‹æ˜¯å¦åˆ†æ•£åˆ°3ä¸ªåˆ†ç‰‡ä¸­ã€‚</p>

<p>åˆ¤æ–­æ˜¯å¦ä¸ºshardï¼šdb.runCommand({isdbgrid:1})</p>

<p>mongos&gt; db.runCommand({isdbgrid:1})
{ â€œisdbgridâ€ : 1, â€œhostnameâ€ : â€œmongo3câ€, â€œokâ€ : 1 }
é€šè¿‡ä¸€ä¸ªpythonè„šæœ¬è¿›è¡Œéšæœºå†™å…¥ï¼šåˆ†åˆ«å‘Aã€B 2ä¸ªmongoså„å†™å…¥10ä¸‡æ¡è®°å½•ã€‚</p>

<p>View Code
æŸ¥çœ‹æ˜¯å¦åˆ†ç‰‡ï¼šdb.collection.stats()</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.stats() #æŸ¥çœ‹é›†åˆçš„åˆ†å¸ƒæƒ…å†µ
â€¦
â€¦
    â€œshardsâ€ : {
        â€œshard0000â€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 89710,
            â€œsizeâ€ : 10047520,
â€¦
â€¦
        â€œshard0001â€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 19273,
            â€œsizeâ€ : 2158576,
â€¦
â€¦
        â€œshard0002â€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 91017,
            â€œsizeâ€ : 10193904,
â€¦
â€¦
å¤åˆ¶ä»£ç 
ä¸Šé¢åŠ ç²—éƒ¨åˆ†ä¸ºé›†åˆçš„åŸºæœ¬ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°åˆ†ç‰‡æˆåŠŸï¼Œå„ä¸ªåˆ†ç‰‡éƒ½æœ‰æ•°æ®(count)ã€‚åˆ°æ­¤MongoDBåˆ†ç‰‡é›†ç¾¤æ­å»ºæˆåŠŸã€‚</p>

<p>++++++++++++++++++++++++++++++++++++++++++++++++</p>

<p>æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸‹é¢è¿™ä¸ªæ¯”è¾ƒæœ‰è¶£çš„ç°è±¡ï¼š</p>

<p>å¤åˆ¶ä»£ç 
#åœ¨å†™ä¹‹å‰åˆ†ç‰‡çš„åŸºæœ¬ä¿¡æ¯ï¼š
mongos&gt; sh.status()
â€” Sharding Status â€” 
â€¦
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:
                shard0000    1
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(1, 0)   #å¯ä»¥çœ‹åˆ°è¿™é‡Œç‰‡é”®çš„å†™å…¥ï¼Œéƒ½æ˜¯å†™åœ¨shard0000é‡Œé¢çš„ã€‚</p>

<p>#åœ¨å†™æœŸé—´çš„åˆ†ç‰‡åŸºæœ¬ä¿¡æ¯ï¼š
mongos&gt; sh.status()
â€” Sharding Status â€” 
â€¦
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:          #æ•°æ®å—åˆ†å¸ƒ
                shard0000    1
                shard0001    1
                shard0002    1
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 0) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(3, 1)   #å¯ä»¥çœ‹åˆ°ç‰‡é”®å†™å…¥çš„åŸºæœ¬åˆ†å¸ƒ</p>

<p>#åœ¨å†™å®Œæˆåçš„åŸºæœ¬ä¿¡æ¯ï¼š
mongos&gt; sh.status()
â€” Sharding Status â€” 
â€¦
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:          #æ•°æ®å—åˆ†å¸ƒ
                shard0000    2
                shard0001    1
                shard0002    2
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } on : shard0000 Timestamp(4, 0) 
            { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } â€“Â» { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } on : shard0002 Timestamp(4, 1) 
            { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 4) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(3, 1)  #æœ€åç‰‡é”®å†™å…¥çš„åˆ†å¸ƒ
å¤åˆ¶ä»£ç 
ä¸Šé¢åŠ ç²—çš„ä¿¡æ¯å¯¹æ¯”ä¸Šçœ‹åˆ°ï¼Œæœ¬æ¥åœ¨æ¯ä¸ªåˆ†ç‰‡ä¸Šéƒ½åªæœ‰ä¸€ä¸ªå—ï¼Œæœ€ååœ¨shard0000ã€shard0002ä¸Šæœ‰2ä¸ªå—ï¼Œè¢«æ‹†åˆ†äº†ã€‚shard0001ä¸å˜ã€‚è¿™æ˜¯å› ä¸ºmongosåœ¨æ”¶åˆ°å†™è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šæ£€æŸ¥å½“å‰å—çš„æ‹†åˆ†é˜€å€¼ç‚¹ã€‚åˆ°è¾¾è¯¥é˜€å€¼çš„æ—¶å€™ï¼Œä¼šå‘åˆ†ç‰‡å‘èµ·ä¸€ä¸ªæ‹†åˆ†çš„è¯·æ±‚ã€‚ä¾‹å­ä¸­shard0000å’Œshard0002é‡Œçš„å—è¢«æ‹†åˆ†äº†ã€‚åˆ†ç‰‡å†…çš„æ•°æ®è¿›è¡Œäº†è¿ç§»ï¼ˆæœ‰ä¸€å®šçš„æ¶ˆè€—ï¼‰ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªå‡è¡¡å™¨æ¥å¯¹æ•°æ®è¿›è¡Œè½¬ç§»åˆ†é…ã€‚æ‰€ä»¥åœ¨å†™å…¥é€”ä¸­è¦æ˜¯çœ‹åˆ°ä¸€ä¸ªåˆ†ç‰‡ä¸­é›†åˆçš„æ•°é‡å˜å°ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚</p>

<p>balancer:  #å‡è¡¡å™¨
    Currently enabled:  yes
    Currently running:  yes   #æ­£åœ¨è½¬ç§»
        Balancer lock taken at Fri Jul 10 2015 22:57:27 GMT+0800 (CST) by mongo2:30000:1436540125:1804289383:Balancer:846930886
å‡è¡¡å™¨ï¼šå‡è¡¡å™¨è´Ÿè´£æ•°æ®è¿ç§»ï¼Œå‘¨æœŸæ€§çš„æ£€æŸ¥åˆ†ç‰‡æ˜¯å¦å­˜åœ¨ä¸å‡è¡¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä¼šå¼€å§‹å—çš„è¿ç§»ï¼Œconfig.locksé›†åˆé‡Œçš„stateè¡¨ç¤ºå‡è¡¡å™¨æ˜¯å¦æ‰¾æ­£åœ¨è¿è¡Œï¼Œ0è¡¨ç¤ºéæ´»åŠ¨çŠ¶æ€ï¼Œ2è¡¨ç¤ºæ­£åœ¨å‡è¡¡ã€‚å‡è¡¡è¿ç§»æ•°æ®çš„è¿‡ç¨‹ä¼šå¢åŠ ç³»ç»Ÿçš„è´Ÿè½½ï¼šç›®æ ‡åˆ†ç‰‡å¿…é¡»æŸ¥è¯¢æºåˆ†ç‰‡çš„æ‰€æœ‰æ–‡æ¡£ï¼Œå°†æ–‡æ¡£æ’å…¥ç›®æ ‡åˆ†ç‰‡ä¸­ï¼Œå†æ¸…é™¤æºåˆ†ç‰‡çš„æ•°æ®ã€‚å¯ä»¥å…³é—­å‡è¡¡å™¨ï¼ˆä¸å»ºè®®ï¼‰ï¼šå…³é—­ä¼šå¯¼è‡´å„åˆ†ç‰‡æ•°æ®åˆ†å¸ƒä¸å‡è¡¡ï¼Œç£ç›˜ç©ºé—´å¾—ä¸åˆ°æœ‰æ•ˆçš„åˆ©ç”¨ã€‚</p>

<p>mongos&gt; sh.setBalancerState(false)  #å…³é—­è‡ªåŠ¨å‡è¡¡å™¨ï¼Œæ‰‹åŠ¨å‡è¡¡ï¼Œæ‰“å¼€ï¼šsh.setBalancerState(true)
mongos&gt; db.settings.find()          #æŸ¥çœ‹å‡è¡¡å™¨çŠ¶æ€
{ â€œ_idâ€ : â€œbalancerâ€, â€œstoppedâ€ : true }
å¯ä»¥ä¸ºå‡è¡¡å™¨è®¾ç½®ä¸€ä¸ªå‡è¡¡æ—¶é—´çª—å£ï¼šactiveWindow</p>

<p>mongos&gt; db.settings.update({â€œ_idâ€:â€balancerâ€},{â€œ$setâ€:{â€œactiveWindowâ€:{â€œstartâ€:â€08:00â€,â€stopâ€:â€02:00â€}}},true)
WriteResult({ â€œnMatchedâ€ : 1, â€œnUpsertedâ€ : 0, â€œnModifiedâ€ : 1 })
mongos&gt; db.settings.find({â€œ_idâ€:â€balancerâ€})
{ â€œ_idâ€ : â€œbalancerâ€, â€œstoppedâ€ : false, â€œactiveWindowâ€ : { â€œstartâ€ : â€œ08:00â€, â€œstopâ€ : â€œ02:00â€ } }
ä¸Šé¢è¯´æ˜ï¼šå‡è¡¡åªä¼šåœ¨æ—©ä¸Š8ç‚¹åˆ°å‡Œæ™¨2ç‚¹è¿›è¡Œå‡è¡¡æ“ä½œã€‚å‡è¡¡å™¨æ˜¯ä»¥å—çš„æ•°é‡ä½œä¸ºè¿ç§»æŒ‡æ ‡ï¼Œè€Œéæ•°æ®å¤§å°ï¼Œå—çš„å¤§å°é»˜è®¤æ˜¯64Mï¼Œå¯ä»¥ä¿®æ”¹:(config.settings)</p>

<p>mongos&gt; db.settings.find()
{ â€œ_idâ€ : â€œchunksizeâ€, â€œvalueâ€ : 64 }
mongos&gt; db.settings.save({â€œ_idâ€:â€chunksizeâ€,â€valueâ€:32})
WriteResult({ â€œnMatchedâ€ : 1, â€œnUpsertedâ€ : 0, â€œnModifiedâ€ : 1 })
mongos&gt; db.settings.find()
{ â€œ_idâ€ : â€œchunksizeâ€, â€œvalueâ€ : 32 }
ä¸Šé¢æŠŠå—çš„é»˜è®¤å¤§å°æ”¹æˆäº†32Mï¼Œé™¤äº†é€šè¿‡å‡è¡¡å™¨è‡ªåŠ¨è¿ç§»å¤–ï¼Œè¿˜å¯ä»¥æ‰‹åŠ¨è¿ç§»æ•°æ®ï¼šsh.moveChunk(â€œdb.collectionâ€,{å—åœ°å€},â€æ–°ç‰‡åç§°â€)</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.chunks.find({â€œ<em>idâ€ : â€œabc.account-name</em>"wPeFnJEvendSTbH"â€}).pretty() #å…ˆåˆ°config.chunksä¸Šä»»æ„æ‰¾ä¸€ä¸ªå—
{
    â€œ<em>idâ€ : â€œabc.account-name</em>"wPeFnJEvendSTbH"â€,
    â€œlastmodâ€ : Timestamp(3, 1),
    â€œlastmodEpochâ€ : ObjectId(â€œ55a52ff1fdd9a605a0371327â€),
    â€œnsâ€ : â€œabc.accountâ€,
    â€œminâ€ : {
        â€œnameâ€ : â€œwPeFnJEvendSTbHâ€              #è¢«ç§»åŠ¨çš„å—
    },
    â€œmaxâ€ : {
        â€œnameâ€ : { â€œ$maxKeyâ€ : 1 }
    },
    â€œshardâ€ : â€œshard0000â€                       #åŸå…ˆæ‰€åœ¨çš„åˆ†ç‰‡
}
mongos&gt; sh.moveChunk(â€œabc.accountâ€,{â€œnameâ€ : â€œwPeFnJEvendSTbHâ€},â€mableviâ€)  #æŠŠabc.accounté›†åˆä¸­åŒ…å«name(ç‰‡é”®)ä¸ºâ€â€œçš„å¿«è¿ç§»åˆ°mableviåˆ†ç‰‡ä¸­
{ â€œmillisâ€ : 6800, â€œokâ€ : 1 }
mongos&gt; db.chunks.find({â€œ<em>idâ€ : â€œabc.account-name</em>"wPeFnJEvendSTbH"â€}).pretty()<br />
{
    â€œ<em>idâ€ : â€œabc.account-name</em>"wPeFnJEvendSTbH"â€,
    â€œlastmodâ€ : Timestamp(5, 0),
    â€œlastmodEpochâ€ : ObjectId(â€œ55a52ff1fdd9a605a0371327â€),
    â€œnsâ€ : â€œabc.accountâ€,
    â€œminâ€ : {
        â€œnameâ€ : â€œwPeFnJEvendSTbHâ€
    },
    â€œmaxâ€ : {
        â€œnameâ€ : { â€œ$maxKeyâ€ : 1 }
    },
    â€œshardâ€ : â€œmableviâ€                        #å·²è¢«è¿ç§»åˆ°æ–°ç‰‡
}
å¤åˆ¶ä»£ç 
ä¸Šé¢æ˜¯æ‰‹åŠ¨ç§»åŠ¨æ•°æ®çš„æ“ä½œï¼Œæ•°æ®è¢«ç§»åŠ¨ã€‚ è¦æ˜¯å—è¶…å‡ºäº†64Mé™åˆ¶ã€åŸå› æ˜¯ç‰‡é”®æ²¡é€‰å¥½(æ—¥æœŸã€çŠ¶æ€å€¼ç­‰)ï¼Œå¯¼è‡´ä¸€ä¸ªå—æ— é™å¢å¤§ã€‘ï¼Œåˆ™æ— æ³•è¿›è¡Œè‡ªåŠ¨å‡è¡¡ï¼Œæ— æ³•åˆ†å—ã€‚æœ‰2ä¸ªåŠæ³•ï¼š1æ˜¯åŠ å¤§å—çš„å¤§å°(setting)ï¼Œ2æ˜¯æ‹†åˆ†sh.splitAt()ï¼ˆæ¨èï¼‰ã€‚</p>

<p>æ‰€ä»¥è¦æ˜¯é‡åˆ°åˆ†ç‰‡å†™å…¥æ¯”å•ç‚¹å†™å…¥æ…¢å°±æ˜¯å› ä¸ºåˆ†ç‰‡è·¯ç”±æœåŠ¡ï¼ˆmongosï¼‰éœ€è¦ç»´æŠ¤å…ƒæ•°æ®ã€æ•°æ®è¿ç§»ã€è·¯ç”±å¼€é”€ç­‰ã€‚</p>

<p>++++++++++++++++++++++++++++++++++++++++++++++++</p>

<p>äº”ã€é«˜å¯ç”¨ï¼šSharding+Replset</p>

<p>ä¸Šé¢çš„åˆ†ç‰‡éƒ½æ˜¯å•ç‚¹çš„ï¼Œè¦æ˜¯ä¸€ä¸ªåˆ†ç‰‡åäº†ï¼Œåˆ™æ•°æ®ä¼šä¸¢å¤±ï¼Œåˆ©ç”¨ä¹‹å‰å‡å°‘çš„å‰¯æœ¬é›†ï¼Œèƒ½å¦æŠŠå‰¯æœ¬é›†åŠ å…¥åˆ°åˆ†ç‰‡ä¸­ï¼Ÿä¸‹é¢å°±æ¥è¯´æ˜ä¸‹ã€‚</p>

<p>1ï¼‰æ·»åŠ å‰¯æœ¬é›†åˆ†ç‰‡æœåŠ¡å™¨ï¼ˆmmmå‰¯æœ¬é›†åç§°ï¼‰ï¼šè¿™é‡Œæµ‹è¯•å°±åªå¯¹ä¸€ä¸ªåˆ†ç‰‡åŠ å‰¯æœ¬é›†ï¼Œè¦å®ç°å®Œå…¨çš„é«˜å¯ç”¨å°±éœ€è¦å¯¹æ‰€æœ‰åˆ†ç‰‡åŠ å‰¯æœ¬é›†ï¼Œé¿å…å•ç‚¹æ•…éšœ</p>

<p>ä¸€ä¸ªæ™®é€šçš„å‰¯æœ¬é›†ï¼š</p>

<p>View Code
ç°åœ¨éœ€è¦æŠŠè¿™ä¸ªå‰¯æœ¬é›†åŠ å…¥åˆ°åˆ†ç‰‡ä¸­ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; sh.addShard(â€œmmm/192.168.200.25:27017,192.168.200.245:27017,192.168.200.245:37017â€) #åŠ å…¥å‰¯æœ¬é›†åˆ†ç‰‡
{ â€œshardAddedâ€ : â€œmmmâ€, â€œokâ€ : 1 }</p>

<p>mongos&gt; sh.status()
â€” Sharding Status â€” 
â€¦
â€¦
shards:
    {  â€œ_idâ€ : â€œmmmâ€,  â€œhostâ€ : â€œmmm/192.168.200.245:27017,192.168.200.245:37017,192.168.200.25:27017â€ }
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.51:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.52:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.53:40000â€ }
  balancer:
    Currently enabled:  yes
    Currently running:  no
    Failed balancer rounds in last 5 attempts:  0
    Migration Results for the last 24 hours: 
        4 : Success
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:
                mmm    1
                shard0000    1
                shard0001    1
                shard0002    2
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } on : mmm Timestamp(5, 0) 
            { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } â€“Â» { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } on : shard0002 Timestamp(4, 1) 
            { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 4) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(5, 1) 
    {  â€œ_idâ€ : â€œabcâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }   #æœªè®¾ç½®åˆ†ç‰‡
å¤åˆ¶ä»£ç 
ä¸Šé¢åŠ ç²—éƒ¨åˆ†è¡¨ç¤ºå‰¯æœ¬é›†åˆ†ç‰‡å·²ç»æˆåŠŸåŠ å…¥ï¼Œå¹¶ä¸”æ–°åŠ å…¥çš„åˆ†ç‰‡ä¼šåˆ†åˆ°å·²æœ‰çš„åˆ†ç‰‡æ•°æ®ã€‚</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.stats()
â€¦
â€¦
    â€œshardsâ€ : {
        â€œmmmâ€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 7723,        #ååŠ å…¥çš„åˆ†ç‰‡å¾—åˆ°äº†æ•°æ®
            â€œsizeâ€ : 741408,
            â€œavgObjSizeâ€ : 96,
            â€œstorageSizeâ€ : 2793472,
            â€œnumExtentsâ€ : 5,
            â€œnindexesâ€ : 2,
            â€œlastExtentSizeâ€ : 2097152,
            â€œpaddingFactorâ€ : 1,
            â€œsystemFlagsâ€ : 1,
            â€œuserFlagsâ€ : 0,
            â€œtotalIndexSizeâ€ : 719488,
            â€œindexSizesâ€ : {
                â€œ<em>id</em>â€ : 343392,
                â€œname_1â€ : 376096
            },
            â€œokâ€ : 1
        },
â€¦
â€¦
å¤åˆ¶ä»£ç 
2ï¼‰ç»§ç»­ç”¨pythonè„šæœ¬å†™æ•°æ®ï¼Œå¡«å……åˆ°å‰¯æœ¬é›†ä¸­</p>

<p>ç”±äºä¹‹å‰çš„å‰¯æœ¬é›†æ˜¯æ¯”è¾ƒè€çš„ç‰ˆæœ¬ï¼ˆ2.4ï¼‰ï¼Œæ‰€ä»¥åœ¨å†™å…¥å‰¯æœ¬é›†åˆ†ç‰‡çš„æ—¶å€™æŠ¥é”™ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.insert({â€œnameâ€:â€UavMbMlfsz1OFrzâ€})
WriteResult({
    â€œnInsertedâ€ : 0,
    â€œwriteErrorâ€ : {
        â€œcodeâ€ : 83,
        â€œerrmsgâ€ : â€œwrite results unavailable from 192.168.200.25:27017 :: caused by :: Location28563 cannot send batch write operation to server 192.168.200.25:27017 (192.168.200.25)â€
    }
})
å¤åˆ¶ä»£ç 
å¤ªæ··è›‹äº†ï¼Œé”™è¯¯æç¤ºä¸å¤ªäººæ€§åŒ–ï¼Œæäº†åŠå¤©ã€‚æ‰€ä»¥è¯´ç‰ˆæœ¬ä¸€è‡´æ€§è¿˜æ˜¯å¾ˆé‡è¦çš„ã€‚ç°åœ¨é‡æ–°å¼€äº†ä¸€ä¸ªå‰¯æœ¬é›†ï¼š</p>

<p>View Code
æŠŠä¹‹å‰çš„å‰¯æœ¬é›†åˆ†ç‰‡åˆ é™¤äº†ï¼Œå¦‚ä½•åˆ é™¤è§ä¸‹é¢3ï¼‰ã€‚</p>

<p>æ–°çš„å‰¯æœ¬é›†åŠ å…¥åˆ†ç‰‡ä¸­ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; sh.addShard(â€œmablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002â€)
{ â€œshardAddedâ€ : â€œmableviâ€, â€œokâ€ : 1 }</p>

<p>mongos&gt; sh.status()
â€” Sharding Status â€” 
â€¦
â€¦
  shards:
    {  â€œ_idâ€ : â€œmableviâ€,  â€œhostâ€ : â€œmablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002â€ }
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.51:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.52:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.53:40000â€ }
â€¦
â€¦
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:
                mablevi    1
                shard0000    1
                shard0001    1
                shard0002    2
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } on : mablevi Timestamp(9, 0) #æ–°åŠ å…¥çš„åˆ†ç‰‡å¾—åˆ°æ•°æ®
            { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } â€“Â» { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } on : shard0002 Timestamp(4, 1) 
            { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 4) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(9, 1) 
    {  â€œ_idâ€ : â€œabcâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œmableviâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0001â€ }
å¤åˆ¶ä»£ç 
ç»§ç»­ç”¨pythonå†™å…¥æ“ä½œï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.stats()
{
â€¦
â€¦
    â€œshardsâ€ : {
        â€œmableviâ€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 47240,
            â€œsizeâ€ : 5290880,
â€¦
â€¦
å¤åˆ¶ä»£ç 
å‰¯æœ¬é›†çš„åˆ†ç‰‡è¢«å†™å…¥äº†47240æ¡è®°å½•ã€‚æ­¤æ—¶æŠŠå‰¯æœ¬é›†åˆ†ç‰‡çš„Primary shutdownæ‰ï¼Œå†æŸ¥çœ‹ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.stats()
{
    â€œshardedâ€ : true,
    â€œcodeâ€ : 13639,
    â€œokâ€ : 0,
    â€œerrmsgâ€ : â€œexception: canâ€™t connect to new replica set master [192.168.200.53:50000], err: couldnâ€™t connect to server 192.168.200.53:50000 (192.168.200.53), connection attempt failedâ€  #ç”±äºå‰¯æœ¬é›†çš„Primaryè¢«shutdownä¹‹åï¼Œé€‰ä¸¾æ–°ä¸»è¿˜æ˜¯è¦å‡ ç§’çš„æ—¶é—´ï¼ŒæœŸé—´æ•°æ®ä¸èƒ½è®¿é—®ï¼Œå¯¼è‡´åˆ†ç‰‡æ•°æ®ä¹Ÿä¸èƒ½è®¿é—®
}
mongos&gt; db.account.stats()
â€¦
â€¦
    â€œshardsâ€ : {
        â€œmableviâ€ : {
            â€œnsâ€ : â€œdba.accountâ€,
            â€œcountâ€ : 47240,       #å‰¯æœ¬é›†æ–°ä¸»é€‰ä¸¾å®Œæ¯•ä¹‹åï¼Œåˆ†ç‰‡æ•°æ®è®¿é—®æ­£å¸¸ã€‚æ•°æ®æ²¡æœ‰ä¸¢å¤±ï¼Œé«˜å¯ç”¨å¾—åˆ°äº†å®ç°ã€‚
            â€œsizeâ€ : 5290880,
â€¦
â€¦
å¤åˆ¶ä»£ç 
è¦æ˜¯è®©å‰¯æœ¬é›†åˆ†ç‰‡åªå‰©ä¸‹ä¸€å°ï¼ˆSecondaryï¼‰ï¼Œåˆ™åˆ†ç‰‡ä¼šæŠ¥é”™ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; db.account.stats()
{
    â€œshardedâ€ : true,
    â€œcodeâ€ : 10009,
    â€œokâ€ : 0,
    â€œerrmsgâ€ : â€œexception: ReplicaSetMonitor no master found for set: mableviâ€ #æ•°æ®ä¸èƒ½è®¿é—®
}
å¤åˆ¶ä»£ç 
3ï¼‰åˆ é™¤åˆ†ç‰‡ï¼š db.runCommand({â€œremoveshardâ€:â€mmmâ€})</p>

<p>è¦æ˜¯è§‰å¾—åˆ†ç‰‡å¤ªå¤šäº†ï¼Œæƒ³åˆ é™¤ï¼Œåˆ™ï¼š</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; use admin   #éœ€è¦åˆ°adminä¸‹é¢åˆ é™¤
switched to db admin
mongos&gt; db.runCommand({â€œremoveshardâ€:â€mmmâ€})
{
    â€œmsgâ€ : â€œdraining started successfullyâ€,
    â€œstateâ€ : â€œstartedâ€,   #å¼€å§‹åˆ é™¤ï¼Œæ•°æ®æ­£åœ¨è½¬ç§»
    â€œshardâ€ : â€œmmmâ€,
    â€œokâ€ : 1
}
mongos&gt; sh.status()
â€” Sharding Status â€”â€¦
â€¦
  shards:
    {  â€œ_idâ€ : â€œmmmâ€,  â€œhostâ€ : â€œmmm/192.168.200.245:27017,192.168.200.245:37017,192.168.200.25:27017â€,  â€œdrainingâ€ : true }  #åˆ é™¤çš„åˆ†ç‰‡æ•°æ®ç§»åŠ¨åˆ°å…¶ä»–åˆ†ç‰‡
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.51:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.52:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.53:40000â€ }
â€¦
â€¦
  databases:
    {  â€œ_idâ€ : â€œadminâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œconfigâ€ }
    {  â€œ_idâ€ : â€œtestâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œdbaâ€,  â€œpartitionedâ€ : true,  â€œprimaryâ€ : â€œshard0000â€ }
        dba.account
            shard key: { â€œnameâ€ : 1 }
            chunks:
                shard0000    2
                shard0001    1
                shard0002    2
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } on : shard0000 Timestamp(8, 0) 
            { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } â€“Â» { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } on : shard0002 Timestamp(4, 1) #è¿™é‡Œå·²ç»æ²¡æœ‰äº†è¢«åˆ é™¤åˆ†ç‰‡ä¿¡æ¯
            { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 4) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(7, 1) 
    {  â€œ_idâ€ : â€œabcâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œmableviâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0001â€ }</p>

<p>mongos&gt; db.runCommand({â€œremoveshardâ€:â€mmmâ€})   #å†æ¬¡æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡ŒæˆåŠŸï¼Œè¦æ˜¯åŸæ¥åˆ†ç‰‡çš„æ•°æ®æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œæ¯”è¾ƒè´¹æ—¶ï¼Œè¦æ˜¯ä¸€ä¸ªä¸»åˆ†ç‰‡åˆ™éœ€è¦æ‰§è¡ŒmovePrimary
{
    â€œmsgâ€ : â€œremoveshard completed successfullyâ€,
    â€œstateâ€ : â€œcompletedâ€,  #å®Œæˆåˆ é™¤
    â€œshardâ€ : â€œmmmâ€,
    â€œokâ€ : 1
}
mongos&gt; sh.status()
â€” Sharding Status â€”â€¦
  shards:   #åˆ†ç‰‡æ¶ˆå¤±
    {  â€œ_idâ€ : â€œshard0000â€,  â€œhostâ€ : â€œ192.168.200.51:40000â€ }
    {  â€œ_idâ€ : â€œshard0001â€,  â€œhostâ€ : â€œ192.168.200.52:40000â€ }
    {  â€œ_idâ€ : â€œshard0002â€,  â€œhostâ€ : â€œ192.168.200.53:40000â€ }
â€¦
â€¦
            { â€œnameâ€ : { â€œ$minKeyâ€ : 1 } } â€“Â» { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } on : shard0001 Timestamp(2, 0) 
            { â€œnameâ€ : â€œ5yyfY8mmR5HyhGJâ€ } â€“Â» { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } on : shard0000 Timestamp(8, 0) 
            { â€œnameâ€ : â€œUavMbMlfszZOFrzâ€ } â€“Â» { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } on : shard0002 Timestamp(4, 1) #å·²ç»æ²¡æœ‰äº†è¢«åˆ é™¤åˆ†ç‰‡çš„ä¿¡æ¯
            { â€œnameâ€ : â€œt9LyVSNXDmf6esPâ€ } â€“Â» { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } on : shard0002 Timestamp(3, 4) 
            { â€œnameâ€ : â€œwoQAv99Pq1FVoMXâ€ } â€“Â» { â€œnameâ€ : { â€œ$maxKeyâ€ : 1 } } on : shard0000 Timestamp(7, 1) 
    {  â€œ_idâ€ : â€œabcâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0000â€ }
    {  â€œ_idâ€ : â€œmableviâ€,  â€œpartitionedâ€ : false,  â€œprimaryâ€ : â€œshard0001â€ }
å¤åˆ¶ä»£ç 
åˆ†ç‰‡è¢«åˆ é™¤ä¹‹åï¼Œæ•°æ®è¢«ç§»åˆ°å…¶ä»–åˆ†ç‰‡ä¸­ï¼Œä¸ä¼šä¸¢å¤±ã€‚è¦æ˜¯æƒ³è®©ä¸»åˆ†ç‰‡è¿›è¡Œè½¬ç§»åˆ™(movePrimary):</p>

<p>mongos&gt; db.adminCommand({â€œmovePrimaryâ€:â€testâ€,â€toâ€:â€shard0001â€}) #æŠŠtestçš„ä¸»åˆ†ç‰‡ä»shard0000è¿ç§»åˆ°shard0001 
åˆ·æ–°ä¸‹é…ç½®æœåŠ¡å™¨ï¼šdb.adminCommand({â€œflushRouterConfigâ€:1})</p>

<p>db.adminCommand({â€œflushRouterConfigâ€:1})
æœ€åæ¥æŸ¥çœ‹ä¸‹åˆ†ç‰‡æˆå‘˜ï¼šdb.runCommand({ listshards : 1 })</p>

<p>å¤åˆ¶ä»£ç 
mongos&gt; use admin  #éœ€è¦è¿›å…¥adminæ‰èƒ½æ‰§è¡Œ
switched to db admin
mongos&gt; db.runCommand({ listshards : 1 })
{
    â€œshardsâ€ : [
        {
            â€œ_idâ€ : â€œshard0000â€,
            â€œhostâ€ : â€œ192.168.200.51:40000â€
        },
        {
            â€œ_idâ€ : â€œshard0001â€,
            â€œhostâ€ : â€œ192.168.200.52:40000â€
        },
        {
            â€œ_idâ€ : â€œshard0002â€,
            â€œhostâ€ : â€œ192.168.200.53:40000â€
        },
        {
            â€œ_idâ€ : â€œmableviâ€,
            â€œhostâ€ : â€œmablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002â€
        }
    ],
    â€œokâ€ : 1
}
å¤åˆ¶ä»£ç 
åˆ°æ­¤å·²ç»æŠŠMongoDBåˆ†ç‰‡åŸç†ã€æ­å»ºã€åº”ç”¨å¤§è‡´å·²ç»ä»‹ç»å®Œã€‚</p>

<p>å…­ã€è®¤è¯åˆ†é…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  ä¸Šé¢çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åœ¨æ— è´¦å·å¯†ç ä¸‹è¿›è¡Œçš„ï¼Œè¿™æ ·æ˜¯ä¸å®‰å…¨çš„ï¼Œé‚£å¦‚ä½•ä½¿ç”¨è´¦å·å¯†ç å‘¢ï¼Ÿå’Œå‰¯æœ¬çº§ä¸€æ ·ï¼Œéœ€è¦æ·»åŠ KeyFileå‚æ•°ï¼Œä½†æ˜¯é’ˆå¯¹ä¸Šé¢çš„ä¸‰ä¸ªè§’è‰²ï¼ˆconfigã€mongosã€mongodï¼‰è´¦å·å¯†ç æ€ä¹ˆæ·»åŠ å‘¢ï¼Ÿå®˜ç½‘ä¸Šå·²ç»åšäº†è¯´æ˜ï¼šhttp://docs.mongodb.org/manual/tutorial/enable-authentication-in-sharded-cluster/ã€‚ä¸‹é¢å°±å¯¹æœ‰è´¦å·å¯†ç è®¤è¯åˆ†ç‰‡è¿›è¡Œç›¸å…³è®¾ç½®è¯´æ˜ã€‚
</code></pre></div></div>

<p>é¦–å…ˆè¦åˆ›å»ºè´¦å·(Rootè§’è‰²)å’Œç”Ÿæˆä¸€ä¸ªKeyFileæ–‡ä»¶ï¼Œå…¶ä¸­mongos ä¸éœ€è¦åˆ›å»ºè´¦å·ã€‚</p>

<p>openssl rand -base64 741 &gt; mongodb-keyfile
chmod 600 mongodb-keyfile
å…¶å®è¿™ä¸ªæ–‡ä»¶ä¹Ÿå¯ä»¥ç›´æ¥ç”¨æ˜æ–‡ï¼Œåªè¦ä¿è¯å„ä¸ªåœ°æ–¹æŒ‡å®šçš„æ–‡ä»¶æ˜¯åŒä¸€ä¸ªå°±å¯ä»¥äº†ã€‚</p>

<p>1ï¼‰mongdï¼š é¦–å…ˆåœ¨mongodè§’è‰²çš„åˆ†ç‰‡æˆå‘˜ä¸Šç”Ÿæˆkey fileæ–‡ä»¶ï¼Œç‰¹åˆ«æ³¨æ„çš„æ˜¯æœ‰å‰¯æœ¬çº§çš„åˆ†ç‰‡ï¼Œå†æŠŠè¿™ä¸ªæ–‡ä»¶åˆ†åˆ«å¤åˆ¶åˆ°å…¶ä»–è§’è‰²çš„æœåŠ¡å™¨ä¸Šã€‚å†æ·»åŠ å‚æ•°ï¼š</p>

<p>auth = true
keyFile = /usr/local/mongodb-keyfile
2ï¼‰Configä¸Šæ·»åŠ å‚æ•°ï¼š</p>

<p>auth = true
keyFile = /usr/local/mongodb-keyfile
3ï¼‰mongosä¸Šæ·»åŠ å‚æ•°ï¼Œå› ä¸ºmongosæœ¬æ¥å°±æ˜¯ä»configé‡ŒåŠ è½½æ•°æ®çš„ï¼Œæ‰€ä»¥åªéœ€è¦æ·»åŠ keyfileæ–‡ä»¶å³å¯ï¼Œä¸éœ€è¦æ‰¾ä¸Šé¢createUserã€‚</p>

<p>keyFile = /usr/local/mongodb-keyfile
æœ€åé‡å¯å„ä¸ªæœåŠ¡ï¼Œå†è¿›å…¥mongosé‡ŒæŸ¥çœ‹ï¼š</p>

<p>å¤åˆ¶ä»£ç 
root@mongo1:/usr/local# mongo â€“port=30000
MongoDB shell version: 3.0.4
connecting to: 127.0.0.1:30000/test
mongos&gt; sh.status()      #æ²¡æœ‰è®¤è¯ï¼Œæ²¡æœ‰æƒé™æŠ¥é”™ã€‚
2015-07-14T23:42:11.800+0800 E QUERY    Error: error: { â€œ$errâ€ : â€œnot authorized for query on config.versionâ€, â€œcodeâ€ : 13 }
    at Error (<anonymous>)
    at DBQuery.next (src/mongo/shell/query.js:259:15)
    at DBCollection.findOne (src/mongo/shell/collection.js:189:22)
    at printShardingStatus (src/mongo/shell/shardingtest.js:659:55)
    at Function.sh.status (src/mongo/shell/utils_sh.js:60:5)
    at (shell):1:4 at src/mongo/shell/query.js:259
mongos&gt; use admin
switched to db admin
mongos&gt; db.auth('dba','dba')   #è®¤è¯
1
mongos&gt; sh.status()            #æœ‰æƒé™
--- Sharding Status --- 
  sharding version: {
    "_id" : 1,
    "minCompatibleVersion" : 5,
    "currentVersion" : 6,
    "clusterId" : ObjectId("55a51ef18bd517d4acec5ef9")
}
  shards:
    {  "_id" : "mablevi",  "host" : "mablevi/192.168.200.53:50000,192.168.200.53:50001,192.168.200.53:50002" }
    {  "_id" : "shard0000",  "host" : "192.168.200.51:40000" }
    {  "_id" : "shard0001",  "host" : "192.168.200.52:40000" }
    {  "_id" : "shard0002",  "host" : "192.168.200.53:40000" }
  balancer:
  ...
  ...
  databases:
    {  "_id" : "admin",  "partitioned" : false,  "primary" : "config" }
    {  "_id" : "test",  "partitioned" : false,  "primary" : "shard0000" }
    {  "_id" : "dba",  "partitioned" : true,  "primary" : "shard0000" }
        dba.account
            shard key: { "name" : 1 }
            chunks:
                mablevi    1
                shard0000    1
                shard0001    2
                shard0002    1
            { "name" : { "$minKey" : 1 } } --&gt;&gt; { "name" : "9XXqCaBhfhPIXLq" } on : mablevi Timestamp(2, 0) 
            { "name" : "9XXqCaBhfhPIXLq" } --&gt;&gt; { "name" : "RWINvgjYYQmbZds" } on : shard0002 Timestamp(4, 0) 
            { "name" : "RWINvgjYYQmbZds" } --&gt;&gt; { "name" : "jSPRBNH8rvnzblG" } on : shard0001 Timestamp(4, 1) 
            { "name" : "jSPRBNH8rvnzblG" } --&gt;&gt; { "name" : "okmjUUZuuKgftDC" } on : shard0001 Timestamp(3, 4) 
            { "name" : "okmjUUZuuKgftDC" } --&gt;&gt; { "name" : { "$maxKey" : 1 } } on : shard0000 Timestamp(3, 1) 
å¤åˆ¶ä»£ç 
ä¸ƒã€åˆ†ç‰‡å¤‡ä»½ã€è¿˜åŸ</anonymous></p>

<p>å› ä¸ºåˆ†ç‰‡æœºåˆ¶é‡Œé¢ä¼šæœ‰å¹³è¡¡å™¨æ¥è¿ç§»æ•°æ®ï¼Œæ‰€ä»¥å„ä¸ªåˆ†ç‰‡é‡Œçš„æ•°æ®å¾ˆå¯èƒ½ä¼šç§»åŠ¨ï¼Œæ‰€ä»¥åœ¨å¤‡ä»½åˆ†ç‰‡æ—¶éœ€è¦åšï¼š</p>

<p>â‘ ï¼šå…ˆåœæ­¢å¹³è¡¡å™¨çš„å·¥ä½œï¼Œå¹¶æ£€æŸ¥æ²¡æœ‰chunk moveåŠ¨ä½œï¼Œä¿è¯dumpçš„æ—¶å€™æ²¡æœ‰è¿›è¡Œæ•°æ®è¿ç§»ã€‚</p>

<p>mongos&gt; sh.stopBalancer()
â‘¡ï¼šé”å®šæ•°æ®åº“ï¼Œä¿è¯æ•°æ®æ²¡æœ‰å†™å…¥ï¼šåœ¨å„ä¸ªåˆ†ç‰‡ä¸Šå’Œé…ç½®æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚</p>

<blockquote>
  <p>db.fsyncLock()
{
    â€œinfoâ€ : â€œnow locked against writes, use db.fsyncUnlock() to unlockâ€,
    â€œseeAlsoâ€ : â€œhttp://dochub.mongodb.org/core/fsynccommandâ€,
    â€œokâ€ : 1
}
â‘¢ï¼šæ‰§è¡Œå¤‡ä»½æ“ä½œï¼Œå¤‡ä»½å„ä¸ªåˆ†ç‰‡æœåŠ¡å™¨å’Œé…ç½®æœåŠ¡å™¨ã€‚</p>
</blockquote>

<p>mongodump -udba -p12345 -d dba_test â€“authenticationDatabase admin -o backup/
â‘£ï¼šè§£é”æ•°æ®åº“ï¼Œå¤‡ä»½å®Œæˆä¹‹ååœ¨åˆ†ç‰‡å’Œé…ç½®æœåŠ¡å™¨ä¸Šè§£é”æ•°æ®åº“ï¼Œå…è®¸ä¿®æ”¹ã€‚</p>

<blockquote>
  <p>db.fsyncUnlock()
{ â€œokâ€ : 1, â€œinfoâ€ : â€œunlock completedâ€ }
å½“æ•°æ®åº“å‡ºç°é—®é¢˜ï¼Œéœ€è¦è¿˜åŸçš„æ—¶å€™ï¼Œéœ€è¦è¿˜åŸå„ä¸ªåˆ†ç‰‡å’Œé…ç½®æœåŠ¡å™¨ï¼Œå¹¶ä¸”é‡å¯MongoDBå®ä¾‹ã€‚è¿˜åŸæ•°æ®åº“éœ€è¦åšï¼š</p>
</blockquote>

<p>â‘ ï¼šè¿˜åŸå„ä¸ªåˆ†ç‰‡å’Œé…ç½®æœåŠ¡å™¨ã€‚</p>

<p>mongorestore â€“host=127.0.0.1 â€“port=27017 -udba -p12345 -d dba_test â€“authenticationDatabase admin â€“drop backup/dba_test
â‘¡ï¼šé‡å¯å„ä¸ªå®ä¾‹</p>

<p>ä¸ºä»€ä¹ˆéœ€è¦ç´¢å¼•ï¼Ÿ
å½“ä½ æŠ±æ€¨MongoDBé›†åˆæŸ¥è¯¢æ•ˆç‡ä½çš„æ—¶å€™ï¼Œå¯èƒ½ä½ å°±éœ€è¦è€ƒè™‘ä½¿ç”¨ç´¢å¼•äº†ï¼Œä¸ºäº†æ–¹ä¾¿åç»­ä»‹ç»ï¼Œå…ˆç§‘æ™®ä¸‹MongoDBé‡Œçš„ç´¢å¼•æœºåˆ¶ï¼ˆåŒæ ·é€‚ç”¨äºå…¶ä»–çš„æ•°æ®åº“æ¯”å¦‚mysqlï¼‰ã€‚</p>

<p>mongo-9552:PRIMARY&gt; db.person.find()
{ â€œ_idâ€ : ObjectId(â€œ571b5da31b0d530a03b3ce82â€), â€œnameâ€ : â€œjackâ€, â€œageâ€ : 19 }
{ â€œ_idâ€ : ObjectId(â€œ571b5dae1b0d530a03b3ce83â€), â€œnameâ€ : â€œroseâ€, â€œageâ€ : 20 }
{ â€œ_idâ€ : ObjectId(â€œ571b5db81b0d530a03b3ce84â€), â€œnameâ€ : â€œjackâ€, â€œageâ€ : 18 }
{ â€œ_idâ€ : ObjectId(â€œ571b5dc21b0d530a03b3ce85â€), â€œnameâ€ : â€œtonyâ€, â€œageâ€ : 21 }
{ â€œ_idâ€ : ObjectId(â€œ571b5dc21b0d530a03b3ce86â€), â€œnameâ€ : â€œadamâ€, â€œageâ€ : 18 }
å½“ä½ å¾€æŸå„ä¸ªé›†åˆæ’å…¥å¤šä¸ªæ–‡æ¡£åï¼Œæ¯ä¸ªæ–‡æ¡£åœ¨ç»è¿‡åº•å±‚çš„å­˜å‚¨å¼•æ“æŒä¹…åŒ–åï¼Œä¼šæœ‰ä¸€ä¸ªä½ç½®ä¿¡æ¯ï¼Œé€šè¿‡è¿™ä¸ªä½ç½®ä¿¡æ¯ï¼Œå°±èƒ½ä»å­˜å‚¨å¼•æ“é‡Œè¯»å‡ºè¯¥æ–‡æ¡£ã€‚æ¯”å¦‚mmapv1å¼•æ“é‡Œï¼Œä½ç½®ä¿¡æ¯æ˜¯ã€æ–‡ä»¶id + æ–‡ä»¶å†…offset ã€ï¼Œ åœ¨wiredtigerå­˜å‚¨å¼•æ“ï¼ˆä¸€ä¸ªKVå­˜å‚¨å¼•æ“ï¼‰é‡Œï¼Œä½ç½®ä¿¡æ¯æ˜¯wiredtigeråœ¨å­˜å‚¨æ–‡æ¡£æ—¶ç”Ÿæˆçš„ä¸€ä¸ªkeyï¼Œé€šè¿‡è¿™ä¸ªkeyèƒ½è®¿é—®åˆ°å¯¹åº”çš„æ–‡æ¡£ï¼›ä¸ºæ–¹ä¾¿ä»‹ç»ï¼Œç»Ÿä¸€ç”¨pos(positionçš„ç¼©å†™)æ¥ä»£è¡¨ä½ç½®ä¿¡æ¯ã€‚</p>

<p>æ¯”å¦‚ä¸Šé¢çš„ä¾‹å­é‡Œï¼Œpersoné›†åˆé‡ŒåŒ…å«æ’å…¥äº†4ä¸ªæ–‡æ¡£ï¼Œå‡è®¾å…¶å­˜å‚¨åä½ç½®ä¿¡æ¯å¦‚ä¸‹(ä¸ºæ–¹ä¾¿æè¿°ï¼Œæ–‡æ¡£çœå»_idå­—æ®µ)</p>

<p>ä½ç½®ä¿¡æ¯	æ–‡æ¡£
pos1	{â€œnameâ€ : â€œjackâ€, â€œageâ€ : 19 }
pos2	{â€œnameâ€ : â€œroseâ€, â€œageâ€ : 20 }
pos3	{â€œnameâ€ : â€œjackâ€, â€œageâ€ : 18 }
pos4	{â€œnameâ€ : â€œtonyâ€, â€œageâ€ : 21}
pos5	{â€œnameâ€ : â€œadamâ€, â€œageâ€ : 18}
å‡è®¾ç°åœ¨æœ‰ä¸ªæŸ¥è¯¢ db.person.find( {age: 18} ), æŸ¥è¯¢æ‰€æœ‰å¹´é¾„ä¸º18å²çš„äººï¼Œè¿™æ—¶éœ€è¦éå†æ‰€æœ‰çš„æ–‡æ¡£ï¼ˆã€å…¨è¡¨æ‰«æã€ï¼‰ï¼Œæ ¹æ®ä½ç½®ä¿¡æ¯è¯»å‡ºæ–‡æ¡£ï¼Œå¯¹æ¯”ageå­—æ®µæ˜¯å¦ä¸º18ã€‚å½“ç„¶å¦‚æœåªæœ‰4ä¸ªæ–‡æ¡£ï¼Œå…¨è¡¨æ‰«æçš„å¼€é”€å¹¶ä¸å¤§ï¼Œä½†å¦‚æœé›†åˆæ–‡æ¡£æ•°é‡åˆ°ç™¾ä¸‡ã€ç”šè‡³åƒä¸‡ä¸Šäº¿çš„æ—¶å€™ï¼Œå¯¹é›†åˆè¿›è¡Œå…¨è¡¨æ‰«æå¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œä¸€ä¸ªæŸ¥è¯¢è€—è´¹æ•°åç§’ç”šè‡³å‡ åˆ†é’Ÿéƒ½æœ‰å¯èƒ½ã€‚</p>

<p>å¦‚æœæƒ³åŠ é€Ÿ db.person.find( {age: 18} ï¼‰ï¼Œå°±å¯ä»¥è€ƒè™‘å¯¹personè¡¨çš„ageå­—æ®µå»ºç«‹ç´¢å¼•ã€‚</p>

<p>db.person.createIndex( {age: 1} )  // æŒ‰ageå­—æ®µåˆ›å»ºå‡åºç´¢å¼•
å»ºç«‹ç´¢å¼•åï¼ŒMongoDBä¼šé¢å¤–å­˜å‚¨ä¸€ä»½æŒ‰ageå­—æ®µå‡åºæ’åºçš„ç´¢å¼•æ•°æ®ï¼Œç´¢å¼•ç»“æ„ç±»ä¼¼å¦‚ä¸‹ï¼Œç´¢å¼•é€šå¸¸é‡‡ç”¨ç±»ä¼¼btreeçš„ç»“æ„æŒä¹…åŒ–å­˜å‚¨ï¼Œä»¥ä¿è¯ä»ç´¢å¼•é‡Œå¿«é€Ÿï¼ˆO(logN)çš„æ—¶é—´å¤æ‚åº¦ï¼‰æ‰¾å‡ºæŸä¸ªageå€¼å¯¹åº”çš„ä½ç½®ä¿¡æ¯ï¼Œç„¶åæ ¹æ®ä½ç½®ä¿¡æ¯å°±èƒ½è¯»å–å‡ºå¯¹åº”çš„æ–‡æ¡£ã€‚</p>

<p>AGE	ä½ç½®ä¿¡æ¯
18	pos3
18	pos5
19	pos1
20	pos2
21	pos4
ç®€å•çš„è¯´ï¼Œç´¢å¼•å°±æ˜¯å°†æ–‡æ¡£æŒ‰ç…§æŸä¸ªï¼ˆæˆ–æŸäº›ï¼‰å­—æ®µé¡ºåºç»„ç»‡èµ·æ¥ï¼Œä»¥ä¾¿èƒ½æ ¹æ®è¯¥å­—æ®µé«˜æ•ˆçš„æŸ¥è¯¢ã€‚æœ‰äº†ç´¢å¼•ï¼Œè‡³å°‘èƒ½ä¼˜åŒ–å¦‚ä¸‹åœºæ™¯çš„æ•ˆç‡ï¼š</p>

<p>æŸ¥è¯¢ï¼Œæ¯”å¦‚æŸ¥è¯¢å¹´é¾„ä¸º18çš„æ‰€æœ‰äºº
æ›´æ–°/åˆ é™¤ï¼Œå°†å¹´é¾„ä¸º18çš„æ‰€æœ‰äººçš„ä¿¡æ¯æ›´æ–°æˆ–åˆ é™¤ï¼Œå› ä¸ºæ›´æ–°æˆ–åˆ é™¤æ—¶ï¼Œéœ€è¦æ ¹æ®æ¡ä»¶å…ˆæŸ¥è¯¢å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡æ¡£ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨ä¼˜åŒ–æŸ¥è¯¢
æ’åºï¼Œå°†æ‰€æœ‰äººçš„ä¿¡æ¯æŒ‰å¹´é¾„æ’åºï¼Œå¦‚æœæ²¡æœ‰ç´¢å¼•ï¼Œéœ€è¦å…¨è¡¨æ‰«ææ–‡æ¡£ï¼Œç„¶åå†å¯¹æ‰«æçš„ç»“æœè¿›è¡Œæ’åº
ä¼—æ‰€å‘¨çŸ¥ï¼ŒMongoDBé»˜è®¤ä¼šä¸ºæ’å…¥çš„æ–‡æ¡£ç”Ÿæˆ_idå­—æ®µï¼ˆå¦‚æœåº”ç”¨æœ¬èº«æ²¡æœ‰æŒ‡å®šè¯¥å­—æ®µï¼‰ï¼Œ_idæ˜¯æ–‡æ¡£å”¯ä¸€çš„æ ‡è¯†ï¼Œä¸ºäº†ä¿è¯èƒ½æ ¹æ®æ–‡æ¡£idå¿«é€’æŸ¥è¯¢æ–‡æ¡£ï¼ŒMongoDBé»˜è®¤ä¼šä¸ºé›†åˆåˆ›å»º_idå­—æ®µçš„ç´¢å¼•ã€‚</p>

<p>mongo-9552:PRIMARY&gt; db.person.getIndexes() // æŸ¥è¯¢é›†åˆçš„ç´¢å¼•ä¿¡æ¯
[
    {
        â€œnsâ€ : â€œtest.personâ€,  // é›†åˆå
        â€œvâ€ : 1,               // ç´¢å¼•ç‰ˆæœ¬
        â€œkeyâ€ : {              // ç´¢å¼•çš„å­—æ®µåŠæ’åºæ–¹å‘
            â€œ<em>idâ€ : 1           // æ ¹æ®_idå­—æ®µå‡åºç´¢å¼•
        },
        â€œnameâ€ : â€œ_id</em>â€        // ç´¢å¼•çš„åç§°
    }
]
MongoDBç´¢å¼•ç±»å‹
MongoDBæ”¯æŒå¤šç§ç±»å‹çš„ç´¢å¼•ï¼ŒåŒ…æ‹¬å•å­—æ®µç´¢å¼•ã€å¤åˆç´¢å¼•ã€å¤škeyç´¢å¼•ã€æ–‡æœ¬ç´¢å¼•ç­‰ï¼Œæ¯ç§ç±»å‹çš„ç´¢å¼•æœ‰ä¸åŒçš„ä½¿ç”¨åœºåˆã€‚</p>

<p>å•å­—æ®µç´¢å¼• ï¼ˆSingle Field Indexï¼‰
    db.person.createIndex( {age: 1} ) 
ä¸Šè¿°è¯­å¥é’ˆå¯¹ageåˆ›å»ºäº†å•å­—æ®µç´¢å¼•ï¼Œå…¶èƒ½åŠ é€Ÿå¯¹ageå­—æ®µçš„å„ç§æŸ¥è¯¢è¯·æ±‚ï¼Œæ˜¯æœ€å¸¸è§çš„ç´¢å¼•å½¢å¼ï¼ŒMongoDBé»˜è®¤åˆ›å»ºçš„idç´¢å¼•ä¹Ÿæ˜¯è¿™ç§ç±»å‹ã€‚</p>

<p>{age: 1} ä»£è¡¨å‡åºç´¢å¼•ï¼Œä¹Ÿå¯ä»¥é€šè¿‡{age: -1}æ¥æŒ‡å®šé™åºç´¢å¼•ï¼Œå¯¹äºå•å­—æ®µç´¢å¼•ï¼Œå‡åº/é™åºæ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>

<p>å¤åˆç´¢å¼• (Compound Index)
å¤åˆç´¢å¼•æ˜¯Single Field Indexçš„å‡çº§ç‰ˆæœ¬ï¼Œå®ƒé’ˆå¯¹å¤šä¸ªå­—æ®µè”åˆåˆ›å»ºç´¢å¼•ï¼Œå…ˆæŒ‰ç¬¬ä¸€ä¸ªå­—æ®µæ’åºï¼Œç¬¬ä¸€ä¸ªå­—æ®µç›¸åŒçš„æ–‡æ¡£æŒ‰ç¬¬äºŒä¸ªå­—æ®µæ’åºï¼Œä¾æ¬¡ç±»æ¨ï¼Œå¦‚ä¸‹é’ˆå¯¹age, nameè¿™2ä¸ªå­—æ®µåˆ›å»ºä¸€ä¸ªå¤åˆç´¢å¼•ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.person.createIndex( {age: 1, name: 1} )  ä¸Šè¿°ç´¢å¼•å¯¹åº”çš„æ•°æ®ç»„ç»‡ç±»ä¼¼ä¸‹è¡¨ï¼Œä¸{age: 1}ç´¢å¼•ä¸åŒçš„æ—¶ï¼Œå½“ageå­—æ®µç›¸åŒæ—¶ï¼Œåœ¨æ ¹æ®nameå­—æ®µè¿›è¡Œæ’åºï¼Œæ‰€ä»¥pos5å¯¹åº”çš„æ–‡æ¡£æ’åœ¨pos3ä¹‹å‰ã€‚
</code></pre></div></div>

<p>AGE,NAME	ä½ç½®ä¿¡æ¯
18,adam	pos5
18,jack	pos3
19,jack	pos1
20,rose	pos2
21,tony	pos4
å¤åˆç´¢å¼•èƒ½æ»¡è¶³çš„æŸ¥è¯¢åœºæ™¯æ¯”å•å­—æ®µç´¢å¼•æ›´ä¸°å¯Œï¼Œä¸å…‰èƒ½æ»¡è¶³å¤šä¸ªå­—æ®µç»„åˆèµ·æ¥çš„æŸ¥è¯¢ï¼Œæ¯”å¦‚db.person.find( {ageï¼š 18ï¼Œ name: â€œjackâ€} )ï¼Œä¹Ÿèƒ½æ»¡è¶³æ‰€ä»¥èƒ½åŒ¹é…ç¬¦åˆç´¢å¼•å‰ç¼€çš„æŸ¥è¯¢ï¼Œè¿™é‡Œ{age: 1}å³ä¸º{age: 1, name: 1}çš„å‰ç¼€ï¼Œæ‰€ä»¥ç±»ä¼¼db.person.find( {ageï¼š 18} )çš„æŸ¥è¯¢ä¹Ÿèƒ½é€šè¿‡è¯¥ç´¢å¼•æ¥åŠ é€Ÿï¼›ä½†db.person.find( {name: â€œjackâ€} )åˆ™æ— æ³•ä½¿ç”¨è¯¥å¤åˆç´¢å¼•ã€‚å¦‚æœç»å¸¸éœ€è¦æ ¹æ®ã€nameå­—æ®µã€ä»¥åŠã€nameå’Œageå­—æ®µç»„åˆã€æ¥æŸ¥è¯¢ï¼Œåˆ™åº”è¯¥åˆ›å»ºå¦‚ä¸‹çš„å¤åˆç´¢å¼•</p>

<p>db.person.createIndex( {name: 1, age: 1} ) 
é™¤äº†æŸ¥è¯¢çš„éœ€æ±‚èƒ½å¤Ÿå½±å“ç´¢å¼•çš„é¡ºåºï¼Œå­—æ®µçš„å€¼åˆ†å¸ƒä¹Ÿæ˜¯ä¸€ä¸ªé‡è¦çš„è€ƒé‡å› ç´ ï¼Œå³ä½¿personé›†åˆæ‰€æœ‰çš„æŸ¥è¯¢éƒ½æ˜¯ã€nameå’Œageå­—æ®µç»„åˆã€ï¼ˆæŒ‡å®šç‰¹å®šçš„nameå’Œageï¼‰ï¼Œå­—æ®µçš„é¡ºåºä¹Ÿæ˜¯æœ‰å½±å“çš„ã€‚</p>

<p>ageå­—æ®µçš„å–å€¼å¾ˆæœ‰é™ï¼Œå³æ‹¥æœ‰ç›¸åŒageå­—æ®µçš„æ–‡æ¡£ä¼šæœ‰å¾ˆå¤šï¼›è€Œnameå­—æ®µçš„å–å€¼åˆ™ä¸°å¯Œå¾ˆå¤šï¼Œæ‹¥æœ‰ç›¸åŒnameå­—æ®µçš„æ–‡æ¡£å¾ˆå°‘ï¼›æ˜¾ç„¶å…ˆæŒ‰nameå­—æ®µæŸ¥æ‰¾ï¼Œå†åœ¨ç›¸åŒnameçš„æ–‡æ¡£é‡ŒæŸ¥æ‰¾ageå­—æ®µæ›´ä¸ºé«˜æ•ˆã€‚</p>

<p>å¤škeyç´¢å¼• ï¼ˆMultikey Indexï¼‰
å½“ç´¢å¼•çš„å­—æ®µä¸ºæ•°ç»„æ—¶ï¼Œåˆ›å»ºå‡ºçš„ç´¢å¼•ç§°ä¸ºå¤škeyç´¢å¼•ï¼Œå¤škeyç´¢å¼•ä¼šä¸ºæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å»ºç«‹ä¸€æ¡ç´¢å¼•ï¼Œæ¯”å¦‚personè¡¨åŠ å…¥ä¸€ä¸ªhabbitå­—æ®µï¼ˆæ•°ç»„ï¼‰ç”¨äºæè¿°å…´è¶£çˆ±å¥½ï¼Œéœ€è¦æŸ¥è¯¢æœ‰ç›¸åŒå…´è¶£çˆ±å¥½çš„äººå°±å¯ä»¥åˆ©ç”¨habbitå­—æ®µçš„å¤škeyç´¢å¼•ã€‚</p>

<p>{â€œnameâ€ : â€œjackâ€, â€œageâ€ : 19, habbit: [â€œfootball, runnningâ€]}
db.person.createIndex( {habbit: 1} )  // è‡ªåŠ¨åˆ›å»ºå¤škeyç´¢å¼•
db.person.find( {habbit: â€œfootballâ€} )
å…¶ä»–ç±»å‹ç´¢å¼•
å“ˆå¸Œç´¢å¼•ï¼ˆHashed Indexï¼‰æ˜¯æŒ‡æŒ‰ç…§æŸä¸ªå­—æ®µçš„hashå€¼æ¥å»ºç«‹ç´¢å¼•ï¼Œç›®å‰ä¸»è¦ç”¨äºMongoDB Sharded Clusterçš„Hashåˆ†ç‰‡ï¼Œhashç´¢å¼•åªèƒ½æ»¡è¶³å­—æ®µå®Œå…¨åŒ¹é…çš„æŸ¥è¯¢ï¼Œä¸èƒ½æ»¡è¶³èŒƒå›´æŸ¥è¯¢ç­‰ã€‚</p>

<p>åœ°ç†ä½ç½®ç´¢å¼•ï¼ˆGeospatial Indexï¼‰èƒ½å¾ˆå¥½çš„è§£å†³O2Oçš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚ã€æŸ¥æ‰¾é™„è¿‘çš„ç¾é£Ÿã€ã€ã€æŸ¥æ‰¾æŸä¸ªåŒºåŸŸå†…çš„è½¦ç«™ã€ç­‰ã€‚</p>

<p>æ–‡æœ¬ç´¢å¼•ï¼ˆText Indexï¼‰èƒ½è§£å†³å¿«é€Ÿæ–‡æœ¬æŸ¥æ‰¾çš„éœ€æ±‚ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªåšå®¢æ–‡ç« é›†åˆï¼Œéœ€è¦æ ¹æ®åšå®¢çš„å†…å®¹æ¥å¿«é€ŸæŸ¥æ‰¾ï¼Œåˆ™å¯ä»¥é’ˆå¯¹åšå®¢å†…å®¹å»ºç«‹æ–‡æœ¬ç´¢å¼•ã€‚</p>

<p>ç´¢å¼•é¢å¤–å±æ€§
MongoDBé™¤äº†æ”¯æŒå¤šç§ä¸åŒç±»å‹çš„ç´¢å¼•ï¼Œè¿˜èƒ½å¯¹ç´¢å¼•å®šåˆ¶ä¸€äº›ç‰¹æ®Šçš„å±æ€§ã€‚</p>

<p>å”¯ä¸€ç´¢å¼• (unique index)ï¼šä¿è¯ç´¢å¼•å¯¹åº”çš„å­—æ®µä¸ä¼šå‡ºç°ç›¸åŒçš„å€¼ï¼Œæ¯”å¦‚_idç´¢å¼•å°±æ˜¯å”¯ä¸€ç´¢å¼•
TTLç´¢å¼•ï¼šå¯ä»¥é’ˆå¯¹æŸä¸ªæ—¶é—´å­—æ®µï¼ŒæŒ‡å®šæ–‡æ¡£çš„è¿‡æœŸæ—¶é—´ï¼ˆç»è¿‡æŒ‡å®šæ—¶é—´åè¿‡æœŸ æˆ– åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸï¼‰
éƒ¨åˆ†ç´¢å¼• (partial index): åªé’ˆå¯¹ç¬¦åˆæŸä¸ªç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œ3.2ç‰ˆæœ¬æ‰æ”¯æŒè¯¥ç‰¹æ€§
ç¨€ç–ç´¢å¼•(sparse index): åªé’ˆå¯¹å­˜åœ¨ç´¢å¼•å­—æ®µçš„æ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œå¯çœ‹åšæ˜¯éƒ¨åˆ†ç´¢å¼•çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µ
ç´¢å¼•ä¼˜åŒ–
db profiling
MongoDBæ”¯æŒå¯¹DBçš„è¯·æ±‚è¿›è¡Œprofilingï¼Œç›®å‰æ”¯æŒ3ç§çº§åˆ«çš„profilingã€‚</p>

<p>0ï¼š ä¸å¼€å¯profiling
1ï¼š å°†å¤„ç†æ—¶é—´è¶…è¿‡æŸä¸ªé˜ˆå€¼(é»˜è®¤100ms)çš„è¯·æ±‚éƒ½è®°å½•åˆ°DBä¸‹çš„system.profileé›†åˆ ï¼ˆç±»ä¼¼äºmysqlã€redisçš„slowlogï¼‰
2ï¼š å°†æ‰€æœ‰çš„è¯·æ±‚éƒ½è®°å½•åˆ°DBä¸‹çš„system.profileé›†åˆï¼ˆç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼‰
é€šå¸¸ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨1çº§åˆ«çš„profilingï¼Œå¹¶æ ¹æ®è‡ªèº«éœ€æ±‚é…ç½®åˆç†çš„é˜ˆå€¼ï¼Œç”¨äºç›‘æµ‹æ…¢è¯·æ±‚çš„æƒ…å†µï¼Œå¹¶åŠæ—¶çš„åšç´¢å¼•ä¼˜åŒ–ã€‚</p>

<p>å¦‚æœèƒ½åœ¨é›†åˆåˆ›å»ºçš„æ—¶å€™å°±èƒ½ã€æ ¹æ®ä¸šåŠ¡æŸ¥è¯¢éœ€æ±‚å†³å®šåº”è¯¥åˆ›å»ºå“ªäº›ç´¢å¼•ã€ï¼Œå½“ç„¶æ˜¯æœ€ä½³çš„é€‰æ‹©ï¼›ä½†ç”±äºä¸šåŠ¡éœ€æ±‚å¤šå˜ï¼Œè¦æ ¹æ®å®é™…æƒ…å†µä¸æ–­çš„è¿›è¡Œä¼˜åŒ–ã€‚ç´¢å¼•å¹¶ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œé›†åˆçš„ç´¢å¼•å¤ªå¤šï¼Œä¼šå½±å“å†™å…¥ã€æ›´æ–°çš„æ€§èƒ½ï¼Œæ¯æ¬¡å†™å…¥éƒ½éœ€è¦æ›´æ–°æ‰€æœ‰ç´¢å¼•çš„æ•°æ®ï¼›æ‰€ä»¥ä½ system.profileé‡Œçš„æ…¢è¯·æ±‚å¯èƒ½æ˜¯ç´¢å¼•å»ºç«‹çš„ä¸å¤Ÿå¯¼è‡´ï¼Œä¹Ÿå¯èƒ½æ˜¯ç´¢å¼•è¿‡å¤šå¯¼è‡´ã€‚</p>

<p>æŸ¥è¯¢è®¡åˆ’
ç´¢å¼•å·²ç»å»ºç«‹äº†ï¼Œä½†æŸ¥è¯¢è¿˜æ˜¯å¾ˆæ…¢æ€ä¹ˆç ´ï¼Ÿè¿™æ—¶å°±å¾—æ·±å…¥çš„åˆ†æä¸‹ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µäº†ï¼Œå¯é€šè¿‡æŸ¥çœ‹ä¸‹è¯¦ç»†çš„æŸ¥è¯¢è®¡åˆ’æ¥å†³å®šå¦‚ä½•ä¼˜åŒ–ã€‚é€šè¿‡æ‰§è¡Œè®¡åˆ’å¯ä»¥çœ‹å‡ºå¦‚ä¸‹é—®é¢˜</p>

<p>æ ¹æ®æŸä¸ª/äº›å­—æ®µæŸ¥è¯¢ï¼Œä½†æ²¡æœ‰å»ºç«‹ç´¢å¼•
æ ¹æ®æŸä¸ª/äº›å­—æ®µæŸ¥è¯¢ï¼Œä½†å»ºç«‹äº†å¤šä¸ªç´¢å¼•ï¼Œæ‰§è¡ŒæŸ¥è¯¢æ—¶æ²¡æœ‰ä½¿ç”¨é¢„æœŸçš„ç´¢å¼•ã€‚
å»ºç«‹ç´¢å¼•å‰ï¼Œdb.person.find( {ageï¼š 18} )å¿…é¡»æ‰§è¡ŒCOLLSCANï¼Œå³å…¨è¡¨æ‰«æã€‚</p>

<p>mongo-9552:PRIMARY&gt; db.person.find({age: 18}).explain()
{
    â€œqueryPlannerâ€ : {
        â€œplannerVersionâ€ : 1,
        â€œnamespaceâ€ : â€œtest.personâ€,
        â€œindexFilterSetâ€ : false,
        â€œparsedQueryâ€ : {
            â€œageâ€ : {
                â€œ$eqâ€ : 18
            }
        },
        â€œwinningPlanâ€ : {
            â€œstageâ€ : â€œCOLLSCANâ€,
            â€œfilterâ€ : {
                â€œageâ€ : {
                    â€œ$eqâ€ : 18
                }
            },
            â€œdirectionâ€ : â€œforwardâ€
        },
        â€œrejectedPlansâ€ : [ ]
    },
    â€œserverInfoâ€ : {
        â€œhostâ€ : â€œlocalhostâ€,
        â€œportâ€ : 9552,
        â€œversionâ€ : â€œ3.2.3â€,
        â€œgitVersionâ€ : â€œb326ba837cf6f49d65c2f85e1b70f6f31ece7937â€
    },
    â€œokâ€ : 1
}
å»ºç«‹ç´¢å¼•åï¼Œé€šè¿‡æŸ¥è¯¢è®¡åˆ’å¯ä»¥çœ‹å‡ºï¼Œå…ˆè¿›è¡Œ[IXSCAN]((https://docs.mongodb.org/manual/reference/explain-results/#queryplanner)(ä»ç´¢å¼•ä¸­æŸ¥æ‰¾)ï¼Œç„¶åFETCHï¼Œè¯»å–å‡ºæ»¡è¶³æ¡ä»¶çš„æ–‡æ¡£ã€‚</p>

<p>mongo-9552:PRIMARY&gt; db.person.find({age: 18}).explain()
{
    â€œqueryPlannerâ€ : {
        â€œplannerVersionâ€ : 1,
        â€œnamespaceâ€ : â€œtest.personâ€,
        â€œindexFilterSetâ€ : false,
        â€œparsedQueryâ€ : {
            â€œageâ€ : {
                â€œ$eqâ€ : 18
            }
        },
        â€œwinningPlanâ€ : {
            â€œstageâ€ : â€œFETCHâ€,
            â€œinputStageâ€ : {
                â€œstageâ€ : â€œIXSCANâ€,
                â€œkeyPatternâ€ : {
                    â€œageâ€ : 1
                },
                â€œindexNameâ€ : â€œage_1â€,
                â€œisMultiKeyâ€ : false,
                â€œisUniqueâ€ : false,
                â€œisSparseâ€ : false,
                â€œisPartialâ€ : false,
                â€œindexVersionâ€ : 1,
                â€œdirectionâ€ : â€œforwardâ€,
                â€œindexBoundsâ€ : {
                    â€œageâ€ : [
                        â€œ[18.0, 18.0]â€
                    ]
                }
            }
        },
        â€œrejectedPlansâ€ : [ ]
    },
    â€œserverInfoâ€ : {
        â€œhostâ€ : â€œlocalhostâ€,
        â€œportâ€ : 9552,
        â€œversionâ€ : â€œ3.2.3â€,
        â€œgitVersionâ€ : â€œb326ba837cf6f49d65c2f85e1b70f6f31ece7937â€
    },
    â€œokâ€ : 1
}</p>

<p>ä¸€ã€å­˜å‚¨å¼•æ“ï¼ˆStorageï¼‰</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mongodb 3.0é»˜è®¤å­˜å‚¨å¼•æ“ä¸ºMMAPV1ï¼Œè¿˜æœ‰ä¸€ä¸ªæ–°å¼•æ“wiredTigerå¯é€‰ï¼Œæˆ–è®¸å¯ä»¥æé«˜ä¸€å®šçš„æ€§èƒ½ã€‚

mongodbä¸­æœ‰å¤šä¸ªdatabasesï¼Œæ¯ä¸ªdatabaseå¯ä»¥åˆ›å»ºå¤šä¸ªcollectionsï¼Œcollectionæ˜¯åº•å±‚æ•°æ®åˆ†åŒºï¼ˆpartitionï¼‰çš„å•ä½ï¼Œæ¯ä¸ªcollectionéƒ½æœ‰å¤šä¸ªåº•å±‚çš„æ•°æ®æ–‡ä»¶ç»„æˆã€‚ï¼ˆå‚è§ä¸‹æ–‡data fileså­˜å‚¨åŸç†ï¼‰

 

wiredTigerå¼•æ“ï¼š3.0æ–°å¢å¼•æ“ï¼Œå®˜æ–¹å®£ç§°åœ¨readã€insertå’Œå¤æ‚çš„updateä¸‹å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚æ‰€ä»¥åç»­ç‰ˆæœ¬ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨wiredTigerã€‚æ‰€æœ‰çš„writeè¯·æ±‚éƒ½åŸºäºâ€œæ–‡æ¡£çº§åˆ«â€çš„lockï¼Œå› æ­¤å¤šä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶æ›´æ–°ä¸€ä¸ªcollecitonä¸­çš„ä¸åŒæ–‡æ¡£ï¼Œè¿™ç§æ›´ç»†é¢—ç²’åº¦çš„lockï¼Œå¯ä»¥æ”¯æ’‘æ›´é«˜çš„è¯»å†™è´Ÿè½½å’Œå¹¶å‘é‡ã€‚å› ä¸ºå¯¹äºproductionç¯å¢ƒï¼Œæ›´å¤šçš„CPUå¯ä»¥æœ‰æ•ˆæå‡wireTigerçš„æ€§èƒ½ï¼Œå› ä¸ºå®ƒæ˜¯çš„IOæ˜¯å¤šçº¿ç¨‹çš„ã€‚wiredTigerä¸åƒMMAPV1å¼•æ“é‚£æ ·å°½å¯èƒ½çš„è€—å°½å†…å­˜ï¼Œå®ƒå¯ä»¥é€šè¿‡åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šâ€œcacheSizeGBâ€å‚æ•°è®¾å®šå¼•æ“ä½¿ç”¨çš„å†…å­˜é‡ï¼Œæ­¤å†…å­˜ç”¨äºç¼“å­˜å·¥ä½œé›†æ•°æ®ï¼ˆç´¢å¼•ã€namespaceï¼Œæœªæäº¤çš„writeï¼Œqueryç¼“å†²ç­‰ï¼‰ã€‚

journalå°±æ˜¯ä¸€ä¸ªé¢„å†™äº‹åŠ¡æ—¥å¿—ï¼Œæ¥ç¡®ä¿æ•°æ®çš„æŒä¹…æ€§ï¼ŒwiredTigeræ¯éš”60ç§’ï¼ˆé»˜è®¤ï¼‰æˆ–è€…å¾…å†™å…¥çš„æ•°æ®è¾¾åˆ°2Gæ—¶ï¼Œmongodbå°†å¯¹journalæ–‡ä»¶æäº¤ä¸€ä¸ªcheckpointï¼ˆæ£€æµ‹ç‚¹ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®å˜æ›´flushåˆ°ç£ç›˜ä¸­çš„æ•°æ®æ–‡ä»¶ä¸­ï¼Œå¹¶åšä¸€ä¸ªæ ‡è®°ç‚¹ï¼Œè¡¨ç¤ºæ­¤å‰çš„æ•°æ®è¡¨ç¤ºå·²ç»æŒä¹…å­˜å‚¨åœ¨äº†æ•°æ®æ–‡ä»¶ä¸­ï¼Œæ­¤åçš„æ•°æ®å˜æ›´å­˜åœ¨äºå†…å­˜å’Œjournalæ—¥å¿—ï¼‰ã€‚å¯¹äºwriteæ“ä½œï¼Œé¦–å…ˆè¢«æŒä¹…å†™å…¥journalï¼Œç„¶ååœ¨å†…å­˜ä¸­ä¿å­˜å˜æ›´æ•°æ®ï¼Œæ¡ä»¶æ»¡è¶³åæäº¤ä¸€ä¸ªæ–°çš„æ£€æµ‹ç‚¹ï¼Œå³æ£€æµ‹ç‚¹ä¹‹å‰çš„æ•°æ®åªæ˜¯åœ¨journalä¸­æŒä¹…å­˜å‚¨ï¼Œä½†å¹¶æ²¡æœ‰åœ¨mongodbçš„æ•°æ®æ–‡ä»¶ä¸­æŒä¹…åŒ–ï¼Œå»¶è¿ŸæŒä¹…åŒ–å¯ä»¥æå‡ç£ç›˜æ•ˆç‡ï¼Œå¦‚æœåœ¨æäº¤checkpointä¹‹å‰ï¼Œmongodbå¼‚å¸¸é€€å‡ºï¼Œæ­¤åå†æ¬¡å¯åŠ¨å¯ä»¥æ ¹æ®journalæ—¥å¿—æ¢å¤æ•°æ®ã€‚journalæ—¥å¿—é»˜è®¤æ¯ä¸ª100æ¯«ç§’åŒæ­¥ç£ç›˜ä¸€æ¬¡ï¼Œæ¯100Mæ•°æ®ç”Ÿæˆä¸€ä¸ªæ–°çš„journalæ–‡ä»¶ï¼Œjournalé»˜è®¤ä½¿ç”¨äº†snappyå‹ç¼©ï¼Œæ£€æµ‹ç‚¹åˆ›å»ºåï¼Œæ­¤å‰çš„journalæ—¥å¿—å³å¯æ¸…é™¤ã€‚mongodå¯ä»¥ç¦ç”¨journalï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥é™ä½å®ƒå¸¦æ¥çš„å¼€æ”¯ï¼›å¯¹äºå•ç‚¹mongodï¼Œå…³é—­journalå¯èƒ½ä¼šåœ¨å¼‚å¸¸å…³é—­æ—¶ä¸¢å¤±checkpointä¹‹é—´çš„æ•°æ®ï¼ˆé‚£äº›å°šæœªæäº¤åˆ°ç£ç›˜æ•°æ®æ–‡ä»¶çš„æ•°æ®ï¼‰ï¼›å¯¹äºreplica setæ¶æ„ï¼ŒæŒä¹…æ€§çš„ä¿è¯ç¨é«˜ï¼Œä½†ä»ç„¶ä¸èƒ½ä¿è¯ç»å¯¹çš„å®‰å…¨ï¼ˆæ¯”å¦‚replica setä¸­æ‰€æœ‰èŠ‚ç‚¹å‡ ä¹åŒæ—¶é€€å‡ºæ—¶ï¼‰ã€‚



 

MMAPv1å¼•æ“ï¼šmongodbåŸç”Ÿçš„å­˜å‚¨å¼•æ“ï¼Œæ¯”è¾ƒç®€å•ï¼Œç›´æ¥ä½¿ç”¨ç³»ç»Ÿçº§çš„å†…å­˜æ˜ å°„æ–‡ä»¶æœºåˆ¶ï¼ˆmemory mapped filesï¼‰ï¼Œä¸€ç›´æ˜¯mongodbçš„é»˜è®¤å­˜å‚¨å¼•æ“ï¼Œå¯¹äºinsertã€readå’Œin-place updateï¼ˆupdateä¸å¯¼è‡´æ–‡æ¡£çš„sizeå˜å¤§ï¼‰æ€§èƒ½è¾ƒé«˜ï¼›ä¸è¿‡MMAPV1åœ¨lockçš„å¹¶å‘çº§åˆ«ä¸Šï¼Œæ”¯æŒåˆ°collectionçº§åˆ«ï¼Œæ‰€ä»¥å¯¹äºåŒä¸€ä¸ªcollectionåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªwriteæ“ä½œæ‰§è¡Œï¼Œè¿™ä¸€ç‚¹ç›¸å¯¹äºwiredTigerè€Œè¨€ï¼Œåœ¨writeå¹¶å‘æ€§ä¸Šå°±ç¨å¼±ä¸€äº›ã€‚å¯¹äºproductionç¯å¢ƒè€Œè¨€ï¼Œè¾ƒå¤§çš„å†…å­˜å¯ä»¥ä½¿æ­¤å¼•æ“æ›´åŠ é«˜æ•ˆï¼Œæœ‰æ•ˆå‡å°‘â€œpage faultâ€é¢‘ç‡ï¼Œä½†æ˜¯å› ä¸ºå…¶å¹¶å‘çº§åˆ«çš„é™åˆ¶ï¼Œå¤šæ ¸CPUå¹¶ä¸èƒ½ä½¿å…¶å—ç›Šã€‚æ­¤å¼•æ“å°†ä¸ä¼šä½¿ç”¨åˆ°swapç©ºé—´ï¼Œä½†æ˜¯å¯¹äºwiredTigerè€Œè¨€éœ€è¦ä¸€å®šçš„swapç©ºé—´ã€‚ï¼ˆæ ¸å¿ƒï¼šå¯¹äºå¤§æ–‡ä»¶MAPæ“ä½œï¼Œæ¯”è¾ƒå¿Œè®³çš„å°±æ˜¯åœ¨æ–‡ä»¶çš„ä¸­é—´ä¿®æ”¹æ•°æ®ï¼Œè€Œä¸”å¯¼è‡´æ–‡ä»¶é•¿åº¦å¢é•¿ï¼Œè¿™ä¼šæ¶‰åŠåˆ°ç´¢å¼•å¼•ç”¨çš„å¤§é¢ç§¯è°ƒæ•´ï¼‰

 

ä¸ºäº†ç¡®ä¿æ•°æ®çš„å®‰å…¨æ€§ï¼Œmongodbå°†æ‰€æœ‰çš„å˜æ›´æ“ä½œå†™å…¥journalå¹¶é—´æ­‡æ€§çš„æŒä¹…åˆ°ç£ç›˜ä¸Šï¼Œå¯¹äºå®é™…æ•°æ®æ–‡ä»¶å°†å»¶è¿Ÿå†™å…¥ï¼Œå’ŒwiredTigerä¸€æ ·journalä¹Ÿæ˜¯ç”¨äºæ•°æ®æ¢å¤ã€‚æ‰€æœ‰çš„è®°å½•åœ¨ç£ç›˜ä¸Šè¿ç»­å­˜å‚¨ï¼Œå½“ä¸€ä¸ªdocumentå°ºå¯¸å˜å¤§æ—¶ï¼Œmongodbéœ€è¦é‡æ–°åˆ†é…ä¸€ä¸ªæ–°çš„è®°å½•ï¼ˆæ—§çš„recordæ ‡è®°åˆ é™¤ï¼Œæ–°çš„è®°recordåœ¨æ–‡ä»¶å°¾éƒ¨é‡æ–°åˆ†é…ç©ºé—´ï¼‰ï¼Œè¿™æ„å‘³ç€mongodbåŒæ—¶è¿˜éœ€è¦æ›´æ–°æ­¤æ–‡æ¡£çš„ç´¢å¼•ï¼ˆæŒ‡å‘æ–°çš„recordçš„offsetï¼‰ï¼Œä¸in-place updateç›¸æ¯”ï¼Œå°†æ¶ˆè€—æ›´å¤šçš„æ—¶é—´å’Œå­˜å‚¨å¼€æ”¯ã€‚ç”±æ­¤å¯è§ï¼Œå¦‚æœä½ çš„mongodbçš„ä½¿ç”¨åœºæ™¯ä¸­æœ‰å¤§é‡çš„è¿™ç§updateï¼Œé‚£ä¹ˆæˆ–è®¸MMAPv1å¼•æ“å¹¶ä¸å¤ªé€‚åˆï¼ŒåŒæ—¶ä¹Ÿåæ˜ å‡ºå¦‚æœdocumentæ²¡æœ‰ç´¢å¼•ï¼Œæ˜¯æ— æ³•ä¿è¯documentåœ¨readä¸­çš„é¡ºåºï¼ˆå³è‡ªç„¶é¡ºåºï¼‰ã€‚3.0ä¹‹åï¼Œmongodbé»˜è®¤é‡‡ç”¨â€œPower of 2 Sized Allocationsâ€ï¼Œæ‰€ä»¥æ¯ä¸ªdocumentå¯¹åº”çš„recordå°†æœ‰å®é™…æ•°æ®å’Œä¸€äº›paddingç»„æˆï¼Œè¿™paddingå¯ä»¥å…è®¸documentçš„å°ºå¯¸åœ¨updateæ—¶é€‚åº¦çš„å¢é•¿ï¼Œä»¥æœ€å°åŒ–é‡æ–°åˆ†é…recordçš„å¯èƒ½æ€§ã€‚æ­¤å¤–é‡æ–°åˆ†é…ç©ºé—´ï¼Œä¹Ÿä¼šå¯¼è‡´ç£ç›˜ç¢ç‰‡ï¼ˆæ—§çš„recordç©ºé—´ï¼‰ã€‚

 

Power of 2 Sized Allocationsï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒMMAPv1ä¸­ç©ºé—´åˆ†é…ä½¿ç”¨æ­¤ç­–ç•¥ï¼Œæ¯ä¸ªdocumentçš„sizeæ˜¯2çš„æ¬¡å¹‚ï¼Œæ¯”å¦‚32ã€64ã€128ã€256...2MBï¼Œå¦‚æœæ–‡æ¡£å°ºå¯¸å¤§äº2MBï¼Œåˆ™ç©ºé—´ä¸º2MBçš„å€æ•°ï¼ˆ2M,4M,6Mç­‰ï¼‰ã€‚è¿™ç§ç­–ç•¥æœ‰2ç§ä¼˜åŠ¿ï¼Œé¦–å…ˆé‚£äº›åˆ é™¤æˆ–è€…updateå˜å¤§è€Œäº§ç”Ÿçš„ç£ç›˜ç¢ç‰‡ç©ºé—´ï¼ˆå°ºå¯¸å˜å¤§ï¼Œæ„å‘³ç€å¼€è¾Ÿæ–°ç©ºé—´å­˜å‚¨æ­¤documentï¼Œæ—§çš„ç©ºé—´è¢«markä¸ºdeletedï¼‰å¯ä»¥è¢«å…¶ä»–inserté‡ç”¨ï¼Œå†è€…paddingå¯ä»¥å…è®¸æ–‡æ¡£å°ºå¯¸æœ‰é™åº¦çš„å¢é•¿ï¼Œè€Œæ— éœ€æ¯æ¬¡updateå˜å¤§éƒ½é‡æ–°åˆ†é…ç©ºé—´ã€‚æ­¤å¤–ï¼Œmongodbè¿˜æä¾›äº†ä¸€ä¸ªå¯é€‰çš„â€œNo padding Allocationâ€ç­–ç•¥ï¼ˆå³æŒ‰ç…§å®é™…æ•°æ®å°ºå¯¸åˆ†é…ç©ºé—´ï¼‰ï¼Œå¦‚æœä½ ç¡®ä¿¡æ•°æ®ç»å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯insertã€in-place updateï¼Œæå°‘çš„deleteï¼Œæ­¤ç­–ç•¥å°†å¯ä»¥æœ‰æ•ˆçš„èŠ‚çº¦ç£ç›˜ç©ºé—´ï¼Œçœ‹èµ·æ¥æ•°æ®æ›´åŠ ç´§å‡‘ï¼Œç£ç›˜åˆ©ç”¨ç‡ä¹Ÿæ›´é«˜ã€‚

 

å¤‡æ³¨ï¼šmongodb 3.2+ä¹‹åï¼Œé»˜è®¤çš„å­˜å‚¨å¼•æ“ä¸ºâ€œwiredTigerâ€ï¼Œå¤§é‡ä¼˜åŒ–äº†å­˜å‚¨æ€§èƒ½ï¼Œå»ºè®®å‡çº§åˆ°3.2+ç‰ˆæœ¬ã€‚
</code></pre></div></div>

<p>äºŒã€Capped Collectionsï¼šä¸€ç§ç‰¹æ®Šçš„collectionï¼Œå…¶å°ºå¯¸å¤§å°æ˜¯å›ºå®šå€¼ï¼Œç±»ä¼¼äºä¸€ä¸ªå¯å¾ªç¯ä½¿ç”¨çš„bufferï¼Œå¦‚æœç©ºé—´è¢«å¡«æ»¡ä¹‹åï¼Œæ–°çš„æ’å…¥å°†ä¼šè¦†ç›–æœ€æ—§çš„æ–‡æ¡£ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šå¯¹Cappedè¿›è¡Œåˆ é™¤æˆ–è€…updateæ“ä½œï¼Œæ‰€ä»¥è¿™ç§ç±»å‹çš„collectionèƒ½å¤Ÿæ”¯æ’‘è¾ƒé«˜çš„writeå’Œreadï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸éœ€è¦å¯¹è¿™ç§collectionæ„å»ºç´¢å¼•ï¼Œå› ä¸ºinsertæ˜¯appendï¼ˆinsertçš„æ•°æ®ä¿å­˜æ˜¯ä¸¥æ ¼æœ‰åºçš„ï¼‰ã€readæ˜¯iteratoræ–¹å¼ï¼Œå‡ ä¹æ²¡æœ‰éšæœºè¯»ï¼›åœ¨replica setæ¨¡å¼ä¸‹ï¼Œå…¶oplogå°±æ˜¯ä½¿ç”¨è¿™ç§collecitonå®ç°çš„ã€‚    Capped Collectionçš„è®¾è®¡ç›®çš„å°±æ˜¯ç”¨æ¥ä¿å­˜â€œæœ€è¿‘çš„â€ä¸€å®šå°ºå¯¸çš„documentã€‚</p>

<p>Javaä»£ç   æ”¶è—ä»£ç 
db.createCollection(â€œcapped_collectionsâ€,new CreateCollectionOptions()<br />
                .capped(true)<br />
                .maxDocuments(6552350)<br />
                .usePowerOf2Sizes(false).autoIndex(true));//ä¸ä¼šæ¶‰åŠåˆ°æ›´æ–°ï¼Œæ‰€ä»¥å¯ä»¥ä¸ç”¨power of 2</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Capped Collectionåœ¨è¯­ä¹‰ä¸Šï¼Œç±»ä¼¼äºâ€œFIFOâ€é˜Ÿåˆ—ï¼Œè€Œä¸”æ˜¯æœ‰ç•Œé˜Ÿåˆ—ã€‚é€‚ç”¨äºæ•°æ®ç¼“å­˜ï¼Œæ¶ˆæ¯ç±»å‹çš„å­˜å‚¨ã€‚Cappedæ”¯æŒupdateï¼Œä½†æ˜¯æˆ‘ä»¬é€šå¸¸ä¸å»ºè®®ï¼Œå¦‚æœæ›´æ–°å¯¼è‡´documentçš„å°ºå¯¸å˜å¤§ï¼Œæ“ä½œå°†ä¼šå¤±è´¥ï¼Œåªèƒ½ä½¿ç”¨in-place updateï¼Œè€Œä¸”è¿˜éœ€è¦å»ºç«‹åˆé€‚çš„ç´¢å¼•ã€‚åœ¨cappedä¸­ä½¿ç”¨removeæ“ä½œæ˜¯å…è®¸çš„ã€‚autoIndexå±æ€§è¡¨ç¤ºé»˜è®¤å¯¹_idå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæˆ‘ä»¬æ¨èè¿™ä¹ˆåšã€‚åœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°äº†Tailable Cursorï¼Œå°±æ˜¯ä¸ºCappedè€Œè®¾è®¡çš„ï¼Œæ•ˆæœç±»ä¼¼äºâ€œtail -f â€ã€‚
</code></pre></div></div>

<p>ä¸‰ã€æ•°æ®æ¨¡å‹ï¼ˆData Modelï¼‰</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä¸Šæ–‡å·²ç»æè¿°è¿‡ï¼Œmongodbæ˜¯ä¸€ä¸ªæ¨¡å¼è‡ªç”±çš„NOSQLï¼Œä¸åƒå…¶ä»–RDBMSä¸€æ ·éœ€è¦é¢„å…ˆå®šä¹‰Schemaè€Œä¸”æ‰€æœ‰çš„æ•°æ®éƒ½â€œæ•´é½åˆ’ä¸€â€ï¼Œmongodbçš„documentæ˜¯BSONæ ¼å¼ï¼Œæ¾æ•£çš„ï¼ŒåŸåˆ™ä¸Šè¯´ä»»ä½•ä¸€ä¸ªCollecitonéƒ½å¯ä»¥ä¿å­˜ä»»æ„ç»“æ„çš„documentï¼Œç”šè‡³å®ƒä»¬çš„æ ¼å¼åƒå·®ä¸‡åˆ«ï¼Œä¸è¿‡ä»åº”ç”¨è§’åº¦è€ƒè™‘ï¼ŒåŒ…æ‹¬ä¸šåŠ¡æ•°æ®åˆ†ç±»å’ŒæŸ¥è¯¢ä¼˜åŒ–æœºåˆ¶ç­‰ï¼Œæˆ‘ä»¬ä»ç„¶å»ºè®®æ¯ä¸ªcollecitonä¸­çš„documentæ•°æ®ç»“æ„åº”è¯¥æ¯”è¾ƒæ¥è¿‘ã€‚

å¯¹äºæœ‰äº›updateï¼Œæ¯”å¦‚å¯¹arrayæ–°å¢å…ƒç´ ç­‰ï¼Œä¼šå¯¼è‡´documentå°ºå¯¸çš„å¢åŠ ï¼Œæ— è®ºä»»ä½•å­˜å‚¨ç³»ç»ŸåŒ…æ‹¬MYSQLã€Hbaseç­‰ï¼Œå¯¹äºè¿™ç§æƒ…å†µéƒ½éœ€è¦é¢å¤–çš„è€ƒè™‘ï¼Œè¿™å½’ç»“äºç£ç›˜ç©ºé—´çš„åˆ†é…æ˜¯è¿ç»­çš„ï¼ˆè¿ç»­æ„å‘³ç€è¯»å–æ€§èƒ½å°†æ›´é«˜ï¼Œå­˜å‚¨æ–‡ä»¶ç©ºé—´é€šå¸¸æ˜¯é¢„åˆ†é…å›ºå®šå°ºå¯¸ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½çš„åˆ©ç”¨ç£ç›˜IOçš„è¿™ç§ä¼˜åŠ¿ï¼‰ã€‚å¯¹äºMMAPV1å¼•æ“ï¼Œå¦‚æœæ–‡æ¡£å°ºå¯¸è¶…è¿‡äº†åŸåˆ†é…çš„ç©ºé—´ï¼ˆä¸Šæ–‡æåˆ°Power of 2 Allocateï¼‰ï¼Œmongodbå°†ä¼šé‡æ–°åˆ†é…æ–°çš„ç©ºé—´æ¥ä¿å­˜æ•´ä¸ªæ–‡æ¡£ï¼ˆæ—§æ–‡æ¡£ç©ºé—´å›æ”¶ï¼Œå¯ä»¥è¢«åç»­çš„inserté‡ç”¨ï¼‰ã€‚

 

documentæ¨¡å‹çš„è®¾è®¡ä¸å­˜å‚¨ï¼Œéœ€è¦å…¼é¡¾åº”ç”¨çš„å®é™…éœ€è¦ï¼Œå¦åˆ™å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚mongodbæ”¯æŒå†…åµŒdocumentï¼Œå³documentä¸­ä¸€ä¸ªå­—æ®µçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªdocumentï¼Œå¯ä»¥å½¢æˆç±»ä¼¼äºRDBMSä¸­çš„â€œone-to-oneâ€ã€â€œone-to-manyâ€ï¼Œåªéœ€è¦å¯¹referenceä½œä¸ºä¸€ä¸ªå†…åµŒæ–‡æ¡£ä¿å­˜å³å¯ã€‚è¿™ç§æƒ…å†µå°±éœ€è¦è€ƒè™‘mongodbå­˜å‚¨å¼•æ“çš„æœºåˆ¶äº†ï¼Œå¦‚æœä½ çš„å†…åµŒæ–‡æ¡£ï¼ˆå³referenceæ–‡æ¡£ï¼‰å°ºå¯¸æ˜¯åŠ¨æ€çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªuserå¯ä»¥æœ‰å¤šä¸ªcardï¼Œå› ä¸ºcardæ•°é‡æ— æ³•é¢„ä¼°ï¼Œè¿™å°±ä¼šå¯¼è‡´documentçš„å°ºå¯¸å¯èƒ½ä¸æ–­å¢åŠ ä»¥è‡³äºè¶…è¿‡â€œPower of 2 Allocateâ€ï¼Œä»è€Œè§¦å‘ç©ºé—´é‡æ–°åˆ†é…ï¼Œå¸¦æ¥æ€§èƒ½å¼€é”€ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å†…åµŒæ–‡æ¡£å•ç‹¬ä¿å­˜åˆ°ä¸€ä¸ªé¢å¤–çš„collectionä¸­ï¼Œä½œä¸ºä¸€ä¸ªæˆ–è€…å¤šä¸ªdocumentå­˜å‚¨ï¼Œæ¯”å¦‚æŠŠcardåˆ—è¡¨ä¿å­˜åœ¨card collectionä¸­ã€‚â€œone-to-oneâ€çš„æƒ…å†µä¹Ÿéœ€è¦ä¸ªåˆ«è€ƒè™‘ï¼Œå¦‚æœreferenceæ–‡æ¡£å°ºå¯¸è¾ƒå°ï¼Œå¯ä»¥å†…åµŒï¼Œå¦‚æœå°ºå¯¸è¾ƒå¤§ï¼Œå»ºè®®å•ç‹¬å­˜å‚¨ã€‚æ­¤å¤–å†…åµŒæ–‡æ¡£è¿˜æœ‰ä¸ªä¼˜ç‚¹å°±æ˜¯writeçš„åŸå­æ€§ï¼Œå¦‚æœä½¿ç”¨referenceçš„è¯ï¼Œå°±æ— æ³•ä¿è¯äº†ã€‚

 

ç´¢å¼•ï¼šæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹_idå­—æ®µä¼šè¢«åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼›å› ä¸ºç´¢å¼•ä¸ä»…éœ€è¦å ç”¨å¤§é‡å†…å­˜è€Œä¸”ä¹Ÿä¼šå ç”¨ç£ç›˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»ºç«‹æœ‰é™ä¸ªç´¢å¼•ï¼Œè€Œä¸”æœ€å¥½ä¸è¦å»ºç«‹é‡å¤ç´¢å¼•ï¼›æ¯ä¸ªç´¢å¼•éœ€è¦8KBçš„ç©ºé—´ï¼ŒåŒæ—¶updateã€insertæ“ä½œä¼šå¯¼è‡´ç´¢å¼•çš„è°ƒæ•´ï¼Œä¼šç¨å¾®å½±å“writeçš„æ€§èƒ½ï¼Œç´¢å¼•åªèƒ½ä½¿readæ“ä½œæ”¶ç›Šï¼Œæ‰€ä»¥è¯»å†™æ¯”é«˜çš„åº”ç”¨å¯ä»¥è€ƒè™‘å»ºç«‹ç´¢å¼•ã€‚

 

å¤§é›†åˆæ‹†åˆ†ï¼šæ¯”å¦‚ä¸€ä¸ªç”¨äºå­˜å‚¨logçš„collectionï¼Œlogåˆ†ä¸ºæœ‰ä¸¤ç§â€œdevâ€ã€â€œdebugâ€ï¼Œç»“æœå¤§è‡´ä¸º{"log":"dev","content":"...."},{"log":"debug","content":"....."}ã€‚è¿™ä¸¤ç§æ—¥å¿—çš„documentä¸ªæ•°æ¯”è¾ƒæ¥è¿‘ï¼Œå¯¹äºæŸ¥è¯¢æ—¶ï¼Œå³ä½¿ç»™logå­—æ®µå»ºç«‹ç´¢å¼•ï¼Œè¿™ä¸ªç´¢å¼•ä¹Ÿä¸æ˜¯é«˜æ•ˆçš„ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘å°†å®ƒä»¬åˆ†åˆ«æ”¾åœ¨2ä¸ªCollectionä¸­ï¼Œæ¯”å¦‚ï¼šlog_devå’Œlog_debugã€‚

 

æ•°æ®ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šmongodbæä¾›äº†expireæœºåˆ¶ï¼Œå³å¯ä»¥æŒ‡å®šæ–‡æ¡£ä¿å­˜çš„æ—¶é•¿ï¼Œè¿‡æœŸåè‡ªåŠ¨åˆ é™¤ï¼Œå³TTLç‰¹æ€§ï¼Œè¿™ä¸ªç‰¹æ€§åœ¨å¾ˆå¤šåœºåˆå°†æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæ¯”å¦‚â€œéªŒè¯ç ä¿ç•™15åˆ†é’Ÿæœ‰æ•ˆæœŸâ€ã€â€œæ¶ˆæ¯ä¿å­˜7å¤©â€ç­‰ç­‰ï¼Œmongodbä¼šå¯åŠ¨ä¸€ä¸ªåå°çº¿ç¨‹æ¥åˆ é™¤é‚£äº›è¿‡æœŸçš„documentã€‚éœ€è¦å¯¹ä¸€ä¸ªæ—¥æœŸå­—æ®µåˆ›å»ºâ€œTTLç´¢å¼•â€ï¼Œæ¯”å¦‚æ’å…¥ä¸€ä¸ªæ–‡æ¡£ï¼š{"check_code":"101010",$currentDate:{"created":true}}}ï¼Œå…¶ä¸­createdå­—æ®µé»˜è®¤å€¼ä¸ºç³»ç»Ÿæ—¶é—´Dateï¼›ç„¶åæˆ‘ä»¬å¯¹createdå­—æ®µå»ºç«‹TTLç´¢å¼•ï¼š
</code></pre></div></div>

<p>Javaä»£ç   æ”¶è—ä»£ç 
collection.createIndex(new Document(â€œcreatedâ€,1),new IndexOptions().expireAfter(15L,TimeUnit.MILLISECONDS));//15åˆ†é’Ÿ<br />
    æˆ‘ä»¬å‘collectionä¸­insertæ–‡æ¡£æ—¶ï¼Œcreatedçš„æ—¶é—´ä¸ºç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œå…¶ä¸­åœ¨creatdå­—æ®µä¸Šå»ºç«‹äº†â€œTTLâ€ç´¢å¼•ï¼Œç´¢å¼•TTLä¸º15åˆ†é’Ÿï¼Œmongodbåå°çº¿ç¨‹å°†ä¼šæ‰«æå¹¶æ£€æµ‹æ¯æ¡documentçš„ï¼ˆcreatedæ—¶é—´ + 15åˆ†é’Ÿï¼‰ä¸å½“å‰æ—¶é—´æ¯”è¾ƒï¼Œå¦‚æœå‘ç°è¿‡æœŸï¼Œåˆ™åˆ é™¤ç´¢å¼•æ¡ç›®ï¼ˆè¿å¸¦åˆ é™¤documentï¼‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å®ç°â€œåœ¨æŸä¸ªæŒ‡å®šçš„æ—¶åˆ»è¿‡æœŸâ€ï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä¸Šè¿°æ–‡æ¡£å’Œç´¢å¼•å˜é€šæ”¹é€ å³å¯ï¼Œå³createdæŒ‡å®šä¸ºâ€œç›®æ ‡æ—¶é—´â€ï¼ŒexpiredAfteræŒ‡å®šä¸º0ã€‚ 
</code></pre></div></div>

<p>å››ã€æ¶æ„æ¨¡å¼</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Replica setï¼šå¤åˆ¶é›†ï¼Œmongodbçš„æ¶æ„æ–¹å¼ä¹‹ä¸€ ï¼Œé€šå¸¸æ˜¯ä¸‰ä¸ªå¯¹ç­‰çš„èŠ‚ç‚¹æ„æˆä¸€ä¸ªâ€œå¤åˆ¶é›†â€é›†ç¾¤ï¼Œæœ‰â€œprimaryâ€å’Œsecondaryç­‰å¤šä¸­è§’è‰²ï¼ˆç¨åè¯¦ç»†ä»‹ç»ï¼‰ï¼Œå…¶ä¸­primaryè´Ÿè´£è¯»å†™è¯·æ±‚ï¼Œsecondaryå¯ä»¥è´Ÿè´£è¯»è¯·æ±‚ï¼Œè¿™æœ‰é…ç½®å†³å®šï¼Œå…¶ä¸­secondaryç´§è·Ÿprimaryå¹¶åº”ç”¨writeæ“ä½œï¼›å¦‚æœprimayå¤±æ•ˆï¼Œåˆ™é›†ç¾¤è¿›è¡Œâ€œå¤šæ•°æ´¾â€é€‰ä¸¾ï¼Œé€‰ä¸¾å‡ºæ–°çš„primaryï¼Œå³failoveræœºåˆ¶ï¼Œå³HAæ¶æ„ã€‚å¤åˆ¶é›†è§£å†³äº†å•ç‚¹æ•…éšœé—®é¢˜ï¼Œä¹Ÿæ˜¯mongodbå‚ç›´æ‰©å±•çš„æœ€å°éƒ¨ç½²å•ä½ï¼Œå½“ç„¶sharding clusterä¸­æ¯ä¸ªshardèŠ‚ç‚¹ä¹Ÿå¯ä»¥ä½¿ç”¨Replica setæé«˜æ•°æ®å¯ç”¨æ€§ã€‚

 

Sharding clusterï¼šåˆ†ç‰‡é›†ç¾¤ï¼Œæ•°æ®æ°´å¹³æ‰©å±•çš„æ‰‹æ®µä¹‹ä¸€ï¼›replica setè¿™ç§æ¶æ„çš„ç¼ºç‚¹å°±æ˜¯â€œé›†ç¾¤æ•°æ®å®¹é‡â€å—é™äºå•ä¸ªèŠ‚ç‚¹çš„ç£ç›˜å¤§å°ï¼Œå¦‚æœæ•°æ®é‡ä¸æ–­å¢åŠ ï¼Œå¯¹å®ƒè¿›è¡Œæ‰©å®¹å°†æ—¶éå¸¸è‹¦éš¾çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é‡‡ç”¨Shardingæ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å°†æ•´ä¸ªcollectionçš„æ•°æ®å°†æ ¹æ®sharding keyè¢«shardingåˆ°å¤šä¸ªmongodèŠ‚ç‚¹ä¸Šï¼Œå³æ¯ä¸ªèŠ‚ç‚¹æŒæœ‰collectionçš„ä¸€éƒ¨åˆ†æ•°æ®ï¼Œè¿™ä¸ªé›†ç¾¤æŒæœ‰å…¨éƒ¨æ•°æ®ï¼ŒåŸåˆ™ä¸Šshardingå¯ä»¥æ”¯æ’‘æ•°TBçš„æ•°æ®ã€‚

 

ç³»ç»Ÿé…ç½®ï¼š1ï¼‰å»ºè®®mongodbéƒ¨ç½²åœ¨linuxç³»ç»Ÿä¸Šï¼Œè¾ƒé«˜ç‰ˆæœ¬ï¼Œé€‰æ‹©åˆé€‚çš„åº•å±‚æ–‡ä»¶ç³»ç»Ÿï¼ˆext4ï¼‰ï¼Œå¼€å¯åˆé€‚çš„swapç©ºé—´  2ï¼‰æ— è®ºæ˜¯MMAPV1æˆ–è€…wiredTigerå¼•æ“ï¼Œè¾ƒå¤§çš„å†…å­˜æ€»èƒ½å¸¦æ¥ç›´æ¥æ”¶ç›Šã€‚3ï¼‰å¯¹æ•°æ®å­˜å‚¨æ–‡ä»¶å…³é—­â€œatimeâ€ï¼ˆæ–‡ä»¶æ¯æ¬¡accesséƒ½ä¼šæ›´æ”¹è¿™ä¸ªæ—¶é—´å€¼ï¼Œè¡¨ç¤ºæ–‡ä»¶æœ€è¿‘è¢«è®¿é—®çš„æ—¶é—´ï¼‰ï¼Œå¯ä»¥æå‡æ–‡ä»¶è®¿é—®æ•ˆç‡ã€‚ 4ï¼‰ulimitå‚æ•°è°ƒæ•´ï¼Œè¿™ä¸ªåœ¨åŸºäºç½‘ç»œIOæˆ–è€…ç£ç›˜IOæ“ä½œçš„åº”ç”¨ä¸­ï¼Œé€šå¸¸éƒ½ä¼šè°ƒæ•´ï¼Œä¸Šè°ƒç³»ç»Ÿå…è®¸æ‰“å¼€çš„æ–‡ä»¶ä¸ªæ•°ï¼ˆulimit -n 65535ï¼‰ã€‚
</code></pre></div></div>

<p>äº”ã€æ•°æ®æ–‡ä»¶å­˜å‚¨åŸç†ï¼ˆData Files storageï¼ŒMMAPV1å¼•æ“ï¼‰</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1ã€Data Files

mongodbçš„æ•°æ®å°†ä¼šä¿å­˜åœ¨åº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬dbpathè®¾å®šä¸ºâ€œ/data/dbâ€ç›®å½•ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªdatabaseä¸ºâ€œtestâ€ï¼Œcollectionä¸ºâ€œsampleâ€ï¼Œç„¶ååœ¨æ­¤collectionä¸­æ’å…¥æ•°æ¡documentsã€‚æˆ‘ä»¬æŸ¥çœ‹dbpathä¸‹ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼š
</code></pre></div></div>

<p>Javaä»£ç   æ”¶è—ä»£ç </p>
<blockquote>
  <p>ls -lh<br />
-rwâ€”â€”-  1 mongo  mongo    16M 11  6 17:24 test.0<br />
-rwâ€”â€”-  1 mongo  mongo    32M 11  6 17:24 test.1<br />
-rwâ€”â€”-  1 mongo  mongo    64M 11  6 17:24 test.2<br />
-rwâ€”â€”-  1 mongo  mongo   128M 11  6 17:24 test.3<br />
-rwâ€”â€”-  1 mongo  mongo   256M 11  6 17:24 test.4<br />
-rwâ€”â€”-  1 mongo  mongo   512M 11  6 17:24 test.5<br />
-rwâ€”â€”-  1 mongo  mongo   512M 11  6 17:24 test.6<br />
-rwâ€”â€”-  1 mongo  mongo    16M 11  6 17:24 test.ns</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å¯ä»¥çœ‹åˆ°testè¿™ä¸ªæ•°æ®åº“ç›®å‰å·²ç»æœ‰6ä¸ªæ•°æ®æ–‡ä»¶ï¼ˆdata filesï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶ä»¥â€œdatabaseâ€çš„åå­— + åºåˆ—æ•°å­—ç»„æˆï¼Œåºåˆ—å·ä»0å¼€å§‹ï¼Œé€ä¸ªé€’å¢ï¼Œæ•°æ®æ–‡ä»¶ä»16Må¼€å§‹ï¼Œæ¯æ¬¡æ‰©å¼ ä¸€å€ï¼ˆ16Mã€32Mã€64Mã€128M...ï¼‰ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹å•ä¸ªdata fileçš„æœ€å¤§å°ºå¯¸ä¸º2Gï¼Œå¦‚æœè®¾ç½®äº†smallFileså±æ€§ï¼ˆé…ç½®æ–‡ä»¶ä¸­ï¼‰åˆ™æœ€å¤§é™å®šä¸º512Mï¼›mongodbä¸­æ¯ä¸ªdatabaseæœ€å¤šæ”¯æŒ16000ä¸ªæ•°æ®æ–‡ä»¶ï¼Œå³çº¦32Tï¼Œå¦‚æœè®¾ç½®äº†smallFilesåˆ™å•ä¸ªdatabaseçš„æœ€å¤§æ•°æ®é‡ä¸º8Tã€‚å¦‚æœä½ çš„databaseä¸­çš„æ•°æ®æ–‡ä»¶å¾ˆå¤šï¼Œå¯ä»¥ä½¿ç”¨directoryPerDBé…ç½®é¡¹å°†æ¯ä¸ªdbçš„æ•°æ®æ–‡ä»¶æ”¾ç½®åœ¨å„è‡ªçš„ç›®å½•ä¸­ã€‚å½“æœ€åä¸€ä¸ªdata fileæœ‰æ•°æ®å†™å…¥åï¼Œmongodbå°†ä¼šç«‹å³é¢„åˆ†é…ä¸‹ä¸€ä¸ªdata fileï¼Œå¯ä»¥é€šè¿‡â€œ--nopreallocateâ€å¯åŠ¨å‘½ä»¤å‚æ•°æ¥å…³é—­æ­¤é€‰é¡¹ã€‚

 

ä¸€ä¸ªdatabaseä¸­æ‰€æœ‰çš„collectionsä»¥åŠç´¢å¼•ä¿¡æ¯ä¼šåˆ†æ•£å­˜å‚¨åœ¨å¤šä¸ªæ•°æ®æ–‡ä»¶ä¸­ï¼Œå³mongodbå¹¶æ²¡æœ‰åƒSQLæ•°æ®åº“é‚£æ ·ï¼Œæ¯ä¸ªè¡¨çš„æ•°æ®ã€ç´¢å¼•åˆ†åˆ«å­˜å‚¨ï¼›æ•°æ®åˆ†å—çš„å•ä½ä¸ºextentï¼ˆèŒƒå›´ï¼ŒåŒºåŸŸï¼‰ï¼Œå³ä¸€ä¸ªdata fileä¸­æœ‰å¤šä¸ªextentsç»„æˆï¼Œextentä¸­å¯ä»¥ä¿å­˜collectionæ•°æ®æˆ–è€…indexesæ•°æ®ï¼Œä¸€ä¸ªextentåªèƒ½ä¿å­˜åŒä¸€ä¸ªcollectionæ•°æ®ï¼Œä¸åŒçš„collectionsæ•°æ®åˆ†å¸ƒåœ¨ä¸åŒçš„extentsä¸­ï¼Œindexesæ•°æ®ä¹Ÿä¿å­˜åœ¨å„è‡ªçš„extentsä¸­ï¼›æœ€ç»ˆï¼Œä¸€ä¸ªcollectionæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªextentsæ„æˆï¼Œæœ€å°sizeä¸º8Kï¼Œæœ€å¤§å¯ä»¥ä¸º2Gï¼Œä¾æ¬¡å¢å¤§ï¼›å®ƒä»¬åˆ†æ•£åœ¨å¤šä¸ªdata filesä¸­ã€‚å¯¹äºä¸€ä¸ªdata fileè€Œè¨€ï¼Œå¯èƒ½åŒ…å«å¤šä¸ªcollectionçš„æ•°æ®ï¼Œå³æœ‰å¤šä¸ªä¸åŒcollectionsçš„extentsã€index extentsæ··åˆæ„æˆã€‚æ¯ä¸ªextentåŒ…å«å¤šæ¡documentsï¼ˆæˆ–è€…index entriesï¼‰ï¼Œæ¯ä¸ªextentçš„å¤§å°å¯èƒ½ä¸ç›¸ç­‰ï¼Œä½†ä¸€ä¸ªextentä¸ä¼šè·¨è¶Š2ä¸ªdata filesã€‚

 



 

æœ‰äººè‚¯å®šç–‘é—®ï¼šä¸€ä¸ªcollectionä¸­æœ‰å“ªäº›extentsï¼Œè¿™ç§ä¿¡æ¯mongodbå­˜åœ¨å“ªé‡Œï¼Ÿåœ¨æ¯ä¸ªdatabaseçš„namespaceæ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚test.nsæ–‡ä»¶ä¸­ï¼Œæ¯ä¸ªcollectionåªä¿å­˜äº†ç¬¬ä¸€ä¸ªextentçš„ä½ç½®ä¿¡æ¯ï¼Œå¹¶ä¸ä¿å­˜æ‰€æœ‰çš„extentsåˆ—è¡¨ï¼Œä½†æ¯ä¸ªextentéƒ½ç»´æŠ¤è€…ä¸€ä¸ªé“¾è¡¨å…³ç³»ï¼Œå³æ¯ä¸ªextentéƒ½åœ¨å…¶headerä¿¡æ¯ä¸­è®°å½•äº†æ­¤extentçš„ä¸Šä¸€ä¸ªã€ä¸‹ä¸€ä¸ªextentçš„ä½ç½®ä¿¡æ¯ï¼Œè¿™æ ·å½“å¯¹æ­¤collectionè¿›è¡Œscanæ“ä½œæ—¶ï¼ˆæ¯”å¦‚å…¨è¡¨æ‰«æï¼‰ï¼Œå¯ä»¥æä¾›å¾ˆå¤§çš„ä¾¿åˆ©æ€§ã€‚

 

æˆ‘ä»¬å¯ä»¥é€šè¿‡db.stats()æŒ‡ä»¤æŸ¥çœ‹å½“å‰databaseä¸­extentsçš„ä¿¡æ¯ï¼š
</code></pre></div></div>

<p>Javaä»£ç   æ”¶è—ä»£ç </p>
<blockquote>
  <p>use test<br />
switched to db test<br />
db.stats();<br />
{<br />
    â€œdbâ€ : â€œtestâ€,<br />
    â€œcollectionsâ€ : 3,  ##collectionçš„ä¸ªæ•°<br />
    â€œobjectsâ€ : 1000006, ##documentsæ€»æ¡æ•°<br />
    â€œavgObjSizeâ€ : 495.9974400153599, ##recordçš„å¹³å‡å¤§å°ï¼Œå•ä½byte<br />
    â€œdataSizeâ€ : 496000416, ##documentæ‰€å ç©ºé—´çš„æ€»é‡<br />
    â€œstorageSizeâ€ : 629649408, ##<br />
    â€œnumExtentsâ€ : 18,  ##extentsä¸ªæ•°<br />
    â€œindexesâ€ : 2,<br />
    â€œindexSizeâ€ : 108282944,<br />
    â€œfileSizeâ€ : 1006632960,<br />
    â€œnsSizeMBâ€ : 16, ##namespaceæ–‡ä»¶å¤§å°<br />
    â€œextentFreeListâ€ : {   ##å°šæœªä½¿ç”¨ï¼ˆå·²åˆ†é…å°šæœªä½¿ç”¨ã€å·²åˆ é™¤ä½†å°šæœªè¢«é‡ç”¨ï¼‰çš„extentåˆ—è¡¨<br />
        â€œnumâ€ : 0,<br />
        â€œtotalSizeâ€ : 0<br />
    },<br />
    â€œdataFileVersionâ€ : {<br />
        â€œmajorâ€ : 4,<br />
        â€œminorâ€ : 22<br />
    },<br />
    â€œokâ€ : 1<br />
}<br />
    åˆ—è¡¨ä¿¡æ¯ä¸­æœ‰å‡ ä¸ªå­—æ®µç®€å•ä»‹ç»ä¸€ä¸‹ï¼š</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1ï¼‰ dataSizeï¼šdocumentsæ‰€å çš„ç©ºé—´æ€»é‡ï¼Œmongodbå°†ä¼šä¸ºæ¯ä¸ªdocumentåˆ†é…ä¸€å®šç©ºé—´ç”¨äºä¿å­˜æ•°æ®ï¼Œæ¯ä¸ªdocumentæ‰€å ç©ºé—´åŒ…æ‹¬â€œæ–‡æ¡£å®é™…å¤§å°â€ + â€œpaddingâ€ï¼Œå¯¹äºMMAPV1å¼•æ“ï¼Œmongodbé»˜è®¤é‡‡ç”¨äº†â€œPower of 2 Sized Allocationsâ€ç­–ç•¥ï¼Œè¿™ä¹Ÿæ„å‘³ç€é€šå¸¸ä¼šæœ‰paddingï¼Œä¸è¿‡å¦‚æœä½ çš„documentä¸ä¼šè¢«updateï¼ˆæˆ–è€…updateä¸ºin-placeæ–¹å¼ï¼Œä¸ä¼šå¯¼è‡´æ–‡æ¡£å°ºå¯¸å˜å¤§ï¼‰ï¼Œå¯ä»¥åœ¨åœ¨createCollectionæ˜¯æŒ‡å®šnoPaddingå±æ€§ä¸ºtrueï¼Œè¿™æ ·dataSizeçš„å¤§å°å°±æ˜¯documentså®é™…å¤§å°ï¼›å½“documentsè¢«åˆ é™¤åï¼Œå°†å¯¼è‡´dataSizeå‡å°ï¼›ä¸è¿‡å¦‚æœåœ¨åŸæœ‰documentçš„ç©ºé—´å†…ï¼ˆåŒ…æ‹¬å…¶paddingç©ºé—´ï¼‰updateï¼ˆæˆ–è€…replaceï¼‰ï¼Œåˆ™ä¸ä¼šå¯¼è‡´dataSizeçš„å˜å¤§ï¼Œå› ä¸ºmongodbå¹¶æ²¡æœ‰åˆ†é…ä»»ä½•æ–°çš„documentç©ºé—´ã€‚

2ï¼‰storageSizeï¼šæ‰€æœ‰collectionçš„documentså ç”¨æ€»ç©ºé—´ï¼ŒåŒ…æ‹¬é‚£äº›å·²ç»åˆ é™¤çš„documentsæ‰€å çš„ç©ºé—´ï¼Œä¸ºå­˜å‚¨documentsçš„extentsæ‰€å ç©ºé—´æ€»å’Œã€‚æ–‡æ¡£çš„åˆ é™¤æˆ–è€…æ”¶ç¼©ä¸ä¼šå¯¼è‡´storageSizeå˜å°ã€‚

3ï¼‰indexSizeï¼šæ‰€ç”¨collectionçš„ç´¢å¼•æ•°æ®çš„å¤§å°ï¼Œä¸ºå­˜å‚¨indexesçš„extentsæ‰€å ç©ºé—´çš„æ€»å’Œã€‚

4ï¼‰fileSizeï¼šä¸ºåº•å±‚æ‰€æœ‰data filesçš„å¤§å°æ€»å’Œï¼Œä½†ä¸åŒ…æ‹¬namespaceæ–‡ä»¶ã€‚ä¸ºstorageSizeã€indexSizeã€ä»¥åŠä¸€äº›å°šæœªä½¿ç”¨çš„ç©ºé—´ç­‰ç­‰ã€‚å½“åˆ é™¤databaseã€collectionsæ—¶ä¼šå¯¼è‡´æ­¤å€¼å˜å°ã€‚

 

æ­¤å¤–ï¼Œå¦‚æœä½ æƒ³æŸ¥çœ‹ä¸€ä¸ªcollectionä¸­extentsçš„åˆ†é…æƒ…å†µï¼Œå¯ä»¥ä½¿ç”¨db.&lt;collectionåç§°&gt;.stats()ï¼Œç»“æ„ä¸ä¸Šè¿°ç±»ä¼¼ï¼›å¦‚æœä½ å¸Œæœ›æ›´ç»†è‡´çš„äº†è§£collectionä¸­extentsçš„å…¨éƒ¨ä¿¡æ¯ï¼Œåˆ™å¯ä»¥ä½¿ç”¨db.&lt;collectionåç§°&gt;.validate()ï¼Œæ­¤æ–¹æ³•æ¥æ”¶ä¸€ä¸ªbooleanå€¼ï¼Œè¡¨ç¤ºæ˜¯å¦æŸ¥çœ‹æ˜ç»†ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¼šscanå…¨éƒ¨çš„data filesï¼Œå› æ­¤æ¯”è¾ƒè€—æ—¶ï¼š
</code></pre></div></div>

<p>Javaä»£ç   æ”¶è—ä»£ç </p>
<blockquote>
  <p>db.sample.validate(true);<br />
{<br />
    â€œnsâ€ : â€œtest.sampleâ€,<br />
    â€œdatasizeâ€ : 496000000,<br />
    â€œnrecordsâ€ : 1000000,<br />
    â€œlastExtentSizeâ€ : 168742912,<br />
    â€œfirstExtentâ€ : â€œ0:5000 ns:test.sampleâ€,<br />
    â€œlastExtentâ€ : â€œ3:a05f000 ns:test.sampleâ€,<br />
    â€œextentCountâ€ : 16,<br />
    â€œextentsâ€ : [<br />
        {<br />
            â€œlocâ€ : â€œ0:5000â€,<br />
            â€œxnextâ€ : â€œ0:49000â€,<br />
            â€œxprevâ€ : â€œnullâ€,<br />
            â€œnsdiagâ€ : â€œtest.sampleâ€,<br />
            â€œsizeâ€ : 8192,<br />
            â€œfirstRecordâ€ : â€œ0:50b0â€,<br />
            â€œlastRecordâ€ : â€œ0:6cb0â€<br />
        },<br />
        â€¦<br />
        ]<br />
        â€¦<br />
}<br />
    å¯ä»¥çœ‹åˆ°extentsåœ¨é€»è¾‘ä¸Šæ˜¯é“¾è¡¨å½¢å¼ï¼Œä»¥åŠæ¯ä¸ªextentçš„æ•°æ®é‡ã€ä»¥åŠæ‰€åœ¨data fileçš„offsetä½ç½®ã€‚å…·ä½“å‚è§ã€validateæ–¹æ³•ã€‘</p>
</blockquote>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä»ä¸Šæ–‡ä¸­æˆ‘ä»¬å·²ç»å¾—çŸ¥ï¼Œåˆ é™¤documentä¼šå¯¼è‡´ç£ç›˜ç¢ç‰‡ï¼Œæœ‰äº›updateä¹Ÿä¼šå¯¼è‡´ç£ç›˜ç¢ç‰‡ï¼Œæ¯”å¦‚updateå¯¼è‡´æ–‡æ¡£å°ºå¯¸å˜å¤§ï¼Œè¿›è€Œè¶…è¿‡åŸæ¥åˆ†é…çš„ç©ºé—´ï¼›å½“æœ‰æ–°çš„insertæ“ä½œæ—¶ï¼Œmongodbä¼šæ£€æµ‹ç°æœ‰çš„extentsä¸­æ˜¯å¦åˆé€‚çš„ç¢ç‰‡ç©ºé—´å¯ä»¥è¢«é‡ç”¨ï¼Œå¦‚æœæœ‰ï¼Œåˆ™é‡ç”¨è¿™äº›fragmentï¼Œå¦åˆ™åˆ†é…æ–°çš„å­˜å‚¨ç©ºé—´ã€‚ç£ç›˜ç¢ç‰‡ï¼Œå¯¹writeæ“ä½œæœ‰ä¸€å®šçš„æ€§èƒ½å½±å“ï¼Œè€Œä¸”ä¼šå¯¼è‡´ç£ç›˜ç©ºé—´æµªè´¹ï¼›å¦‚æœä½ éœ€è¦åˆ é™¤æŸä¸ªcollectionä¸­å¤§éƒ¨åˆ†æ•°æ®ï¼Œåˆ™å¯ä»¥è€ƒè™‘å°†æœ‰æ•ˆæ•°æ®å…ˆè½¬å­˜åˆ°æ–°çš„collectionï¼Œç„¶åç›´æ¥drop()åŸæœ‰çš„collectionã€‚æˆ–è€…ä½¿ç”¨db.runCommand({compact: '&lt;collection&gt;'})ã€‚

å¦‚æœä½ çš„databaseå·²ç»è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œæ•°æ®å·²ç»æœ‰å¾ˆå¤§çš„ç£ç›˜ç¢ç‰‡ï¼ˆstorageSizeä¸dataSizeæ¯”è¾ƒï¼‰ï¼Œå¯ä»¥é€šè¿‡mongodumpå°†æŒ‡å®šdatabaseçš„æ‰€æœ‰æ•°æ®å¯¼å‡ºï¼Œç„¶åå°†åŸæœ‰çš„dbåˆ é™¤ï¼Œå†é€šè¿‡mongorestoreæŒ‡ä»¤å°†æ•°æ®é‡æ–°å¯¼å…¥ã€‚ï¼ˆåŒcompactï¼Œè¿™ç§æ“ä½œéœ€è¦åœæœºç»´æŠ¤ï¼‰

 

mongodä¸­è¿˜æœ‰2ä¸ªé»˜è®¤çš„databaseï¼Œç³»ç»Ÿçº§çš„ï¼Œâ€œadminâ€å’Œâ€œlocalâ€ï¼›å®ƒä»¬çš„å­˜å‚¨åŸç†åŒä¸Šï¼Œå…¶ä¸­â€œadminâ€ç”¨äºå­˜å‚¨â€œç”¨æˆ·æˆæƒä¿¡æ¯â€ï¼Œæ¯”å¦‚æ¯ä¸ªdatabaseä¸­ç”¨æˆ·çš„roleã€æƒé™ç­‰ï¼›â€œlocalâ€å³ä¸ºæœ¬åœ°æ•°æ®åº“ï¼Œæˆ‘ä»¬å¸¸è¯´çš„oplogï¼ˆreplicationæ¶æ„ä¸­ä½¿ç”¨ï¼Œç±»ä¼¼ä¸binlogï¼‰å³ä¿å­˜åœ¨æ­¤æ•°æ®åº“ä¸­ã€‚

 

2ã€Namespaceæ–‡ä»¶

å¯¹äºnamespaceæ–‡ä»¶ï¼Œæ¯”å¦‚â€œtest.nsâ€æ–‡ä»¶ï¼Œé»˜è®¤å¤§å°ä¸º16Mï¼Œæ­¤æ–‡ä»¶ä¸­ä¸»è¦ç”¨äºä¿å­˜â€œcollectionâ€ã€indexçš„å‘½åä¿¡æ¯ï¼Œæ¯”å¦‚collectionçš„â€œå±æ€§â€ä¿¡æ¯ã€æ¯ä¸ªç´¢å¼•çš„å±æ€§ç±»å‹ç­‰ï¼Œå¦‚æœä½ çš„databaseä¸­éœ€è¦å­˜å‚¨å¤§é‡çš„collectionï¼ˆæ¯”å¦‚æ¯ä¸€å°æ—¶ç”Ÿæˆä¸€ä¸ªcollectionï¼Œåœ¨æ•°æ®åˆ†æåº”ç”¨ä¸­ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶â€œnsSizeâ€é€‰é¡¹æ¥æŒ‡å®šã€‚å‚è§ã€mongodbé…ç½®æ–‡ä»¶ã€‘

 

3ã€journalæ–‡ä»¶

journalæ—¥å¿—ä¸ºmongodbæä¾›äº†æ•°æ®ä¿éšœèƒ½åŠ›ï¼Œå®ƒæœ¬è´¨ä¸Šä¸mysql binlogæ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œç”¨äºå½“mongodbå¼‚å¸¸crashåï¼Œé‡å¯æ—¶è¿›è¡Œæ•°æ®æ¢å¤ï¼›è¿™å½’ç»“äºmongodbçš„æ•°æ®æŒä¹…å†™å…¥ç£ç›˜æ˜¯æ»åçš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œâ€œjournalâ€ç‰¹æ€§æ˜¯å¼€å¯çš„ï¼Œç‰¹åˆ«åœ¨productionç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰ç†ç”±æ¥å…³é—­å®ƒã€‚ï¼ˆé™¤éï¼Œæ•°æ®ä¸¢å¤±å¯¹åº”ç”¨è€Œè¨€ï¼Œæ˜¯æ— å…³ç´§è¦çš„ï¼‰

 

ä¸€ä¸ªmongodbå®ä¾‹ä¸­æ‰€æœ‰çš„databaseså…±äº«journalæ–‡ä»¶ã€‚

 

å¯¹äºwriteæ“ä½œè€Œè¨€ï¼Œé¦–å…ˆå†™å…¥journalæ—¥å¿—ï¼Œç„¶åå°†æ•°æ®åœ¨å†…å­˜ä¸­ä¿®æ”¹ï¼ˆmmapï¼‰ï¼Œæ­¤ååå°çº¿ç¨‹é—´æ­‡æ€§çš„å°†å†…å­˜ä¸­å˜æ›´çš„æ•°æ®flushåˆ°åº•å±‚çš„data filesä¸­ï¼Œæ—¶é—´é—´éš”ä¸º60ç§’ï¼ˆå‚è§é…ç½®é¡¹â€œsyncPeriodSecsâ€ï¼‰ï¼›writeæ“ä½œåœ¨journalæ–‡ä»¶ä¸­æ˜¯æœ‰åºçš„ï¼Œä¸ºäº†æå‡æ€§èƒ½ï¼Œwriteå°†ä¼šé¦–å…ˆå†™å…¥journalæ—¥å¿—çš„å†…å­˜bufferä¸­ï¼Œå½“bufferæ•°æ®è¾¾åˆ°100Mæˆ–è€…æ¯éš”100æ¯«ç§’ï¼Œbufferä¸­çš„æ•°æ®å°†ä¼šflushåˆ°ç£ç›˜ä¸­çš„journalæ–‡ä»¶ä¸­ï¼›å¦‚æœmongodbå¼‚å¸¸é€€å‡ºï¼Œå°†å¯èƒ½å¯¼è‡´æœ€å¤š100Mæ•°æ®æˆ–è€…æœ€è¿‘100mså†…çš„æ•°æ®ä¸¢å¤±ï¼Œflushç£ç›˜çš„æ—¶é—´é—´éš”æœ‰é…ç½®é¡¹â€œcommitIntervalMsâ€å†³å®šï¼Œé»˜è®¤ä¸º100æ¯«ç§’ã€‚mongodbä¹‹æ‰€ä»¥ä¸èƒ½å¯¹æ¯ä¸ªwriteéƒ½å°†journalåŒæ­¥ç£ç›˜ï¼Œè¿™ä¹Ÿæ˜¯å¯¹æ€§èƒ½çš„è€ƒè™‘ï¼Œmysqlçš„binlogä¹Ÿé‡‡ç”¨äº†ç±»ä¼¼çš„æƒè¡¡æ–¹å¼ã€‚å¼€å¯journalæ—¥å¿—åŠŸèƒ½ï¼Œå°†ä¼šå¯¼è‡´writeæ€§èƒ½æœ‰æ‰€é™ä½ï¼Œå¯èƒ½é™ä½5~30%ï¼Œå› ä¸ºå®ƒç›´æ¥åŠ å‰§äº†ç£ç›˜çš„å†™å…¥è´Ÿè½½ï¼Œæˆ‘ä»¬å¯ä»¥å°†journalæ—¥å¿—å•ç‹¬æ”¾ç½®åœ¨å…¶ä»–ç£ç›˜é©±åŠ¨å™¨ä¸­æ¥æé«˜å†™å…¥å¹¶å‘èƒ½åŠ›ï¼ˆä¸data filesåˆ†åˆ«ä½¿ç”¨ä¸åŒçš„ç£ç›˜é©±åŠ¨å™¨ï¼‰ã€‚

 

å¦‚æœä½ å¸Œæœ›æ•°æ®å°½å¯èƒ½çš„ä¸ä¸¢å¤±ï¼Œå¯ä»¥è€ƒè™‘ï¼š1ï¼‰å‡å°commitIntervalMsçš„å€¼ 2ï¼‰æ¯ä¸ªwriteæŒ‡å®šâ€œwrite concernâ€ä¸­æŒ‡å®šâ€œjâ€å‚æ•°ä¸ºtrue  3ï¼‰æœ€ä½³æ‰‹æ®µå°±æ˜¯é‡‡ç”¨â€œreplica setâ€æ¶æ„æ¨¡å¼ï¼Œé€šè¿‡æ•°æ®å¤‡ä»½æ–¹å¼è§£å†³ï¼ŒåŒæ—¶è¿˜éœ€è¦åœ¨â€œwrite concernâ€ä¸­æŒ‡å®šâ€œwâ€é€‰é¡¹ï¼Œä¸”ä¿éšœçº§åˆ«ä¸ä½äºâ€œmajorityâ€ã€‚ã€å‚è§mongodbå¤åˆ¶é›†ã€‘æœ€ç»ˆæˆ‘ä»¬éœ€è¦åœ¨â€œå†™å…¥æ€§èƒ½â€å’Œâ€œæ•°æ®ä¸€è‡´æ€§â€ä¸¤ä¸ªæ–¹é¢æƒè¡¡ï¼Œå³CAPç†è®ºã€‚

 

æ ¹æ®writeå¹¶å‘é‡ï¼Œjournalæ—¥å¿—æ–‡ä»¶ä¸º1Gï¼Œå¦‚æœæŒ‡å®šäº†smallFilesé…ç½®é¡¹ï¼Œåˆ™æœ€å¤§ä¸º128Mï¼Œå’Œdata filesä¸€æ ·journalæ–‡ä»¶ä¹Ÿé‡‡ç”¨äº†â€œpreallocatedâ€æ–¹å¼ï¼Œjournalæ—¥å¿—ä¿å­˜åœ¨dbpathä¸‹â€œjournalâ€å­ç›®å½•ä¸­ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸‰ä¸ªjournalæ–‡ä»¶ï¼Œæ¯ä¸ªjournalæ–‡ä»¶æ ¼å¼ç±»ä¼¼äºâ€œj._&lt;åºåˆ—æ•°å­—&gt;â€ã€‚å¹¶ä¸æ˜¯æ¯æ¬¡buffer flushéƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„journalæ—¥å¿—ï¼Œè€Œæ˜¯å½“å‰journalæ–‡ä»¶å³å°†æ»¡æ—¶ä¼šé¢„åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶ï¼Œjournalæ–‡ä»¶ä¸­ä¿å­˜äº†writeæ“ä½œçš„è®°å½•ï¼Œæ¯æ¡è®°å½•ä¸­åŒ…å«writeæ“ä½œå†…å®¹ä¹‹å¤–ï¼Œè¿˜åŒ…å«ä¸€ä¸ªâ€œlsnâ€ï¼ˆlast sequence numberï¼‰ï¼Œè¡¨ç¤ºæ­¤è®°å½•çš„IDï¼›æ­¤å¤–æˆ‘ä»¬ä¼šå‘ç°åœ¨journalç›®å½•ä¸‹ï¼Œè¿˜æœ‰ä¸€ä¸ªâ€œlsnâ€æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶éå¸¸å°ï¼Œåªä¿å­˜äº†ä¸€ä¸ªæ•°å­—ï¼Œå½“writeå˜æ›´çš„æ•°æ®è¢«flushåˆ°ç£ç›˜ä¸­çš„data filesåï¼Œä¹Ÿæ„å‘³ç€è¿™äº›æ•°æ®å·²ç»æŒä¹…åŒ–äº†ï¼Œé‚£ä¹ˆå®ƒä»¬åœ¨â€œå¼‚å¸¸æ¢å¤â€æ—¶ä¹Ÿä¸éœ€è¦äº†ï¼Œé‚£ä¹ˆå…¶å¯¹åº”çš„journalæ—¥å¿—å°†å¯ä»¥åˆ é™¤ï¼Œâ€œlsnâ€æ–‡ä»¶ä¸­è®°å½•çš„å°±æ˜¯writeæŒä¹…åŒ–çš„æœ€åä¸€ä¸ªjournalè®°å½•çš„IDï¼Œæ­¤IDä¹‹å‰çš„writeæ“ä½œå·²ç»è¢«æŒä¹…å†™å…¥data filesï¼Œæ­¤IDä¹‹å‰çš„journalåœ¨â€œå¼‚å¸¸æ¢å¤â€æ—¶åˆ™ä¸éœ€è¦å…³æ³¨ï¼›å¦‚æœæŸä¸ªjournalæ–‡ä»¶ä¸­æœ€å¤§ IDå°äºâ€œlsnâ€ï¼Œåˆ™æ­¤journalå¯ä»¥è¢«åˆ é™¤æˆ–è€…é‡ç”¨ã€‚
</code></pre></div></div>

:ET