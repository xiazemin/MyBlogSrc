I"©&<p>ç¼–è¯‘è¿‡çš„äºŒè¿›åˆ¶æ–‡ä»¶å·²ç»åŒ…å«äº† DWARFv3 è°ƒè¯•ä¿¡æ¯ï¼Œåªè¦ GDB7.1 ä»¥ä¸Šç‰ˆæœ¬éƒ½å¯ä»¥è¿›è¡Œè°ƒè¯•ã€‚ åœ¨OSXä¸‹ï¼Œå¦‚æ— æ³•æ‰§è¡Œè°ƒè¯•æŒ‡ä»¤ï¼Œå¯å°è¯•ç”¨sudoæ–¹å¼æ‰§è¡Œgdbã€‚</p>

<p>åˆ é™¤è°ƒè¯•ç¬¦å·ï¼šgo build -ldflags â€œ-s -wâ€</p>

<p>-s: å»æ‰ç¬¦å·ä¿¡æ¯ã€‚
-w: å»æ‰DWARFè°ƒè¯•ä¿¡æ¯ã€‚
å…³é—­å†…è”ä¼˜åŒ–ï¼šgo build -gcflags â€œ-N -lâ€</p>

<p>è°ƒè¯•ç›¸å…³å‡½æ•°ï¼š
runtime.Breakpoint()ï¼šè§¦å‘è°ƒè¯•å™¨æ–­ç‚¹ã€‚
runtime/debug.PrintStack()ï¼šæ˜¾ç¤ºè°ƒè¯•å †æ ˆã€‚
logï¼šé€‚åˆæ›¿ä»£ printæ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ã€‚
GDB è°ƒè¯•æ”¯æŒï¼š</p>

<p>å‚æ•°è½½å…¥ï¼šgdb -d $GCROOT ã€‚
æ‰‹å·¥è½½å…¥ï¼šsource pkg/runtime/runtime-gdb.pyã€‚
æ›´å¤šç»†èŠ‚ï¼Œè¯·å‚è€ƒ: http://golang.org/doc/gdb
<!-- more -->
$ go build -gcflags â€œ-N -lâ€ // ç¼–è¯‘ï¼Œå…³é—­å†…è”ä¼˜åŒ–ã€‚</p>

<p>$ sudo gdb demo // å¯åŠ¨ gdb è°ƒè¯•å™¨ï¼Œæ‰‹å·¥è½½å…¥ Go Runtime ã€‚
GNU gdb (GDB) 7.5.1
Reading symbols from demoâ€¦done.
(gdb) source /usr/local/go/src/pkg/runtime/runtime-gdb.py
Loading Go Runtime support.</p>

<p>(gdb) l main.main // ä»¥ .æ–¹å¼æŸ¥çœ‹æºç ã€‚
9 r = fmt.Sprintf(â€œtest: %s %dâ€, s, x)
10 runtime.Breakpoint()
11 return r
12 }
13
14 func main() {
15 s := â€œhahaâ€
16 i := 1234
17 println(test(s, i))
18 }</p>

<p>(gdb) l main.go:8 // ä»¥ :æ–¹å¼æŸ¥çœ‹æºç ã€‚
3 import (
4 â€œfmtâ€
5 â€œruntimeâ€
6 )
7
8 func test(s string, x int) (r string) {
9 r = fmt.Sprintf(â€œtest: %s %dâ€, s, x)
10 runtime.Breakpoint()
11 return r
12 }</p>

<p>(gdb) b main.main // ä»¥ .æ–¹å¼è®¾ç½®æ–­ç‚¹ã€‚
Breakpoint 1 at 0x2131: file main.go, line 14.</p>

<p>(gdb) b main.go:17 // ä»¥ :æ–¹å¼è®¾ç½®æ–­ç‚¹ã€‚
Breakpoint 2 at 0x2167: file main.go, line 17.</p>

<p>(gdb) info breakpoints // æŸ¥çœ‹æ‰€æœ‰æ–­ç‚¹ã€‚
Num Type Disp Enb Address What
1 breakpoint keep y 0x0000000000002131 in main.main at main.go:14
2 breakpoint keep y 0x0000000000002167 in main.main at main.go:17</p>

<p>(gdb) r // å¯åŠ¨è¿›ç¨‹ï¼Œè§¦å‘ç¬¬ä¸€ä¸ªæ–­ç‚¹ã€‚
Starting program: demo
[New Thread 0x1c03 of process 4088]
[Switching to Thread 0x1c03 of process 4088]
Breakpoint 1, main.main () at main.go:14
14 func main() {</p>

<p>(gdb) info goroutines // æŸ¥çœ‹ goroutines ä¿¡æ¯ã€‚</p>
<ul>
  <li>1 running runtime.gosched</li>
  <li>2 syscall runtime.entersyscall</li>
</ul>

<p>(gdb) goroutine 1 bt // æŸ¥çœ‹æŒ‡å®šåºå·çš„ goroutine è°ƒç”¨å †æ ˆã€‚
#0 0x000000000000f6c0 in runtime.gosched () at pkg/runtime/proc.c:927
#1 0x000000000000e44c in runtime.main () at pkg/runtime/proc.c:244
#2 0x000000000000e4ef in schedunlock () at pkg/runtime/proc.c:267
#3 0x0000000000000000 in ?? ()</p>

<p>(gdb) goroutine 2 bt // è¿™ä¸ª goroutine è²Œä¼¼è·Ÿ GC æœ‰å…³ã€‚
#0 runtime.entersyscall () at pkg/runtime/proc.c:989
#1 0x000000000000d01d in runtime.MHeap_Scavenger () at pkg/runtime/mheap.c:363
#2 0x000000000000e4ef in schedunlock () at pkg/runtime/proc.c:267
#3 0x0000000000000000 in ?? ()</p>

<p>(gdb) c / / ç»§ç»­æ‰§è¡Œï¼Œè§¦å‘ä¸‹ä¸€ä¸ªæ–­ç‚¹ã€‚
Continuing.
Breakpoint 2, main.main () at main.go:17
17! ! println(test(s, i))</p>

<p>(gdb) info goroutines // å½“å‰ goroutine åºå·ä¸º 1ã€‚</p>
<ul>
  <li>1 running runtime.gosched
2 runnable runtime.gosched</li>
</ul>

<p>(gdb) goroutine 1 bt // å½“å‰ goroutine è°ƒç”¨å †æ ˆã€‚
#0 0x000000000000f6c0 in runtime.gosched () at pkg/runtime/proc.c:927
#1 0x000000000000e44c in runtime.main () at pkg/runtime/proc.c:244
#2 0x000000000000e4ef in schedunlock () at pkg/runtime/proc.c:267
#3 0x0000000000000000 in ?? ()</p>

<p>(gdb) bt // æŸ¥çœ‹å½“å‰è°ƒâ½¤å †æ ˆï¼Œå¯ä»¥ä¸å½“å‰ goroutine è°ƒç”¨å †æ ˆå¯¹æ¯”ã€‚
#0 main.main () at main.go:17
#1 0x000000000000e44c in runtime.main () at pkg/runtime/proc.c:244
#2 0x000000000000e4ef in schedunlock () at pkg/runtime/proc.c:267
#3 0x0000000000000000 in ?? ()</p>

<p>(gdb) info frame // å †æ ˆå¸§ä¿¡æ¯ã€‚
Stack level 0, frame at 0x442139f88:
rip = 0x2167 in main.main (main.go:17); saved rip 0xe44c
called by frame at 0x442139fb8
source language go.
Arglist at 0x442139f28, args:
Locals at 0x442139f28, Previous frameâ€™s sp is 0x442139f88
Saved registers:
rip at 0x442139f80</p>

<p>(gdb) info locals // æŸ¥çœ‹å±€éƒ¨å˜é‡ã€‚
i = 1234
s = â€œhahaâ€</p>

<p>(gdb) p s // ä»¥ Pretty-Print æ–¹å¼æŸ¥çœ‹å˜é‡ã€‚
$1 = â€œhahaâ€</p>

<p>(gdb) p $len(s) // è·å–å¯¹è±¡é•¿åº¦($cap)
$2 = 4</p>

<p>(gdb) whatis i // æŸ¥çœ‹å¯¹è±¡ç±»å‹ã€‚
type = int</p>

<p>(gdb) c // ç»§ç»­æ‰§è¡Œï¼Œè§¦å‘ breakpoint() æ–­ç‚¹ã€‚
Continuing.
Program received signal SIGTRAP, Trace/breakpoint trap.
runtime.breakpoint () at pkg/runtime/asm_amd64.s:81
81 RET</p>

<p>(gdb) n // ä» breakpoint() ä¸­å‡ºæ¥ï¼Œæ‰§è¡Œæºç ä¸‹ä¸€è¡Œä»£ç ã€‚
main.test (s=â€hahaâ€, x=1234, r=â€test: haha 1234â€³) at main.go:11
11 return r</p>

<p>(gdb) info args // ä»å‚æ•°ä¿¡æ¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å‘½åè¿”å›å‚æ•°çš„å€¼ã€‚
s = â€œhahaâ€
x = 1234
r = â€œtest: haha 1234â€</p>

<p>(gdb) x/3xw &amp;r // æŸ¥çœ‹ r å†…å­˜æ•°æ®ã€‚(æŒ‡é’ˆ 8 + é•¿åº¦ 4)
0x442139f48: 0x42121240 0x00000000 0x0000000f
(gdb) x/15xb 0x42121240 // æŸ¥çœ‹å­—ç¬¦ä¸²å­—èŠ‚æ•°ç»„
0x42121240: 0x74 0x65 0x73 0x74 0x3a 0x20 0x68 0x61
0x42121248: 0x68 0x61 0x20 0x31 0x32 0x33 0x34</p>

<p>(gdb) c // ç»§ç»­æ‰§è¡Œï¼Œè¿›ç¨‹ç»“æŸã€‚</p>

<p>Continuing.
test: haha 1234
[Inferior 1 (process 4088) exited normally]</p>

<p>(gdb) q // é€€å‡º GDB</p>

<p>2.Â å¸¸ç”¨å‘½ä»¤
2.1.Â list
ç®€å†™å‘½ä»¤lï¼Œç”¨æ¥æ˜¾ç¤ºæºä»£ç ï¼Œé»˜è®¤æ˜¾ç¤ºåè¡Œä»£ç ï¼Œåé¢å¯ä»¥å¸¦ä¸Šå‚æ•°æ˜¾ç¤ºçš„å…·ä½“è¡Œï¼Œä¾‹å¦‚ï¼šlist 15ï¼Œæ˜¾ç¤ºåè¡Œä»£ç ï¼Œå…¶ä¸­ç¬¬15è¡Œåœ¨æ˜¾ç¤ºçš„åè¡Œé‡Œé¢çš„ä¸­é—´ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<p>10	        time.Sleep(2 * time.Second)
  11	        c &lt;- i
  12	    }
  13	    close(c)
  14	}
  15	
  16	func main() {
  17	    msg := â€œStarting mainâ€
  18	    fmt.Println(msg)
  19	    bus := make(chan int)
2.2.Â break
ç®€å†™å‘½ä»¤Â b,ç”¨æ¥è®¾ç½®æ–­ç‚¹ï¼Œåé¢è·Ÿä¸Šå‚æ•°è®¾ç½®æ–­ç‚¹çš„è¡Œæ•°ï¼Œä¾‹å¦‚b 10åœ¨ç¬¬åè¡Œè®¾ç½®æ–­ç‚¹ã€‚</p>

<p>2.3.Â delete
ç®€å†™å‘½ä»¤Â d,ç”¨æ¥åˆ é™¤æ–­ç‚¹ï¼Œåé¢è·Ÿä¸Šæ–­ç‚¹è®¾ç½®çš„åºå·ï¼Œè¿™ä¸ªåºå·å¯ä»¥é€šè¿‡info breakpointsè·å–ç›¸åº”çš„è®¾ç½®çš„æ–­ç‚¹åºå·ï¼Œå¦‚ä¸‹æ˜¯æ˜¾ç¤ºçš„è®¾ç½®æ–­ç‚¹åºå·ã€‚</p>

<p>Num     Type           Disp Enb Address            What
  2       breakpoint     keep y   0x0000000000400dc3 in main.main at /home/xiemengjun/gdb.go:23
  breakpoint already hit 1 time
2.4.Â backtrace
ç®€å†™å‘½ä»¤Â bt,ç”¨æ¥æ‰“å°æ‰§è¡Œçš„ä»£ç è¿‡ç¨‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p>#0  main.main () at /home/xiemengjun/gdb.go:23
  #1  0x000000000040d61e in runtime.main () at /home/xiemengjun/go/src/pkg/runtime/proc.c:244
  #2  0x000000000040d6c1 in schedunlock () at /home/xiemengjun/go/src/pkg/runtime/proc.c:267
  #3  0x0000000000000000 in ?? ()
2.5.Â info
infoå‘½ä»¤ç”¨æ¥æ˜¾ç¤ºä¿¡æ¯ï¼Œåé¢æœ‰å‡ ç§å‚æ•°ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>

<p>info locals</p>

<p>æ˜¾ç¤ºå½“å‰æ‰§è¡Œçš„ç¨‹åºä¸­çš„å˜é‡å€¼</p>

<p>info breakpoints</p>

<p>æ˜¾ç¤ºå½“å‰è®¾ç½®çš„æ–­ç‚¹åˆ—è¡¨</p>

<p>info goroutines</p>

<p>æ˜¾ç¤ºå½“å‰æ‰§è¡Œçš„goroutineåˆ—è¡¨ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤º,å¸¦*çš„è¡¨ç¤ºå½“å‰æ‰§è¡Œçš„</p>

<ul>
  <li>1  running runtime.gosched</li>
  <li>2  syscall runtime.entersyscall
3  waiting runtime.gosched
4 runnable runtime.gosched
2.6.Â print
ç®€å†™å‘½ä»¤pï¼Œç”¨æ¥æ‰“å°å˜é‡æˆ–è€…å…¶ä»–ä¿¡æ¯ï¼Œåé¢è·Ÿä¸Šéœ€è¦æ‰“å°çš„å˜é‡åï¼Œå½“ç„¶è¿˜æœ‰ä¸€äº›å¾ˆæœ‰ç”¨çš„å‡½æ•°$len()å’Œ$cap()ï¼Œç”¨æ¥è¿”å›å½“å‰stringã€slicesæˆ–è€…mapsçš„é•¿åº¦å’Œå®¹é‡ã€‚</li>
</ul>

<p>2.7.Â whatis
ç”¨æ¥æ˜¾ç¤ºå½“å‰å˜é‡çš„ç±»å‹ï¼Œåé¢è·Ÿä¸Šå˜é‡åï¼Œä¾‹å¦‚whatis msg,æ˜¾ç¤ºå¦‚ä¸‹ï¼š</p>

<p>type = struct string
2.8.Â next
ç®€å†™å‘½ä»¤Â n,ç”¨æ¥å•æ­¥è°ƒè¯•ï¼Œè·³åˆ°ä¸‹ä¸€æ­¥ï¼Œå½“æœ‰æ–­ç‚¹ä¹‹åï¼Œå¯ä»¥è¾“å…¥nè·³è½¬åˆ°ä¸‹ä¸€æ­¥ç»§ç»­æ‰§è¡Œ</p>

<p>2.9.Â coutinue
ç®€ç§°å‘½ä»¤Â cï¼Œç”¨æ¥è·³å‡ºå½“å‰æ–­ç‚¹å¤„ï¼Œåé¢å¯ä»¥è·Ÿå‚æ•°Nï¼Œè·³è¿‡å¤šå°‘æ¬¡æ–­ç‚¹</p>

<p>2.10.Â set variable
è¯¥å‘½ä»¤ç”¨æ¥æ”¹å˜è¿è¡Œè¿‡ç¨‹ä¸­çš„å˜é‡å€¼ï¼Œæ ¼å¼å¦‚ï¼šset variable <var>=<value></value></var></p>

<ol>
  <li>è°ƒè¯•æ­¥éª¤
ç¼–è¯‘æ–‡ä»¶ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶gdbfile:
go build -gcflags â€œ-N -lâ€ gdbfile.go
é€šè¿‡gdbå‘½ä»¤å¯åŠ¨è°ƒè¯•ï¼š
gdb gdbfile</li>
</ol>

<p>å¯åŠ¨ä¹‹åé¦–å…ˆçœ‹çœ‹è¿™ä¸ªç¨‹åºæ˜¯ä¸æ˜¯å¯ä»¥è¿è¡Œèµ·æ¥ï¼Œåªè¦è¾“å…¥runå‘½ä»¤å›è½¦åç¨‹åºå°±å¼€å§‹è¿è¡Œï¼Œç¨‹åºæ­£å¸¸çš„è¯å¯ä»¥çœ‹åˆ°ç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼Œå’Œæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œç›´æ¥æ‰§è¡Œç¨‹åºè¾“å‡ºæ˜¯ä¸€æ ·çš„ï¼š
(gdb) run
Starting program: /home/xiemengjun/gdbfile
Starting main</p>

<p>start                         //å¼€å§‹è°ƒè¯•
n                             //ä¸€æ¡ä¸€æ¡æ‰§è¡Œ
step/s                        //æ‰§è¡Œä¸‹ä¸€æ¡ï¼Œå¦‚æœå‡½æ•°è¿›å…¥å‡½æ•°
backtrace/bt                  //æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆå¸§
info/i locals                 //æŸ¥çœ‹å½“å‰æ ˆå¸§å±€éƒ¨å˜é‡
frame/f                       //é€‰æ‹©æ ˆå¸§ï¼Œå†æŸ¥çœ‹å±€éƒ¨å˜é‡
print/p                       //æ‰“å°å˜é‡çš„å€¼
finish                        //è¿è¡Œåˆ°å½“å‰å‡½æ•°è¿”å›
set var sum=0                 //ä¿®æ”¹å˜é‡å€¼
list/l è¡Œå·æˆ–å‡½æ•°å             //åˆ—å‡ºæºç 
display/undisplay sum         //æ¯æ¬¡åœä¸‹æ˜¾ç¤ºå˜é‡çš„å€¼/å–æ¶ˆè·Ÿè¸ª
break/b  è¡Œå·æˆ–å‡½æ•°å           //è®¾ç½®æ–­ç‚¹
continue/c                    //è¿ç»­è¿è¡Œ
info/i breakpoints            //æŸ¥çœ‹å·²ç»è®¾ç½®çš„æ–­ç‚¹
delete breakpoints 2          //åˆ é™¤æŸä¸ªæ–­ç‚¹
disable/enable breakpoints 3  //ç¦ç”¨/å¯ç”¨æŸä¸ªæ–­ç‚¹
break 9 if sum != 0           //æ»¡è¶³æ¡ä»¶æ‰æ¿€æ´»æ–­ç‚¹
run/r                         //é‡æ–°ä»ç¨‹åºå¼€å¤´è¿ç»­æ‰§è¡Œ
watch input[4]                //è®¾ç½®è§‚å¯Ÿç‚¹
info/i watchpoints            //æŸ¥çœ‹è®¾ç½®çš„è§‚å¯Ÿç‚¹
x/7b input                    //æ‰“å°å­˜å‚¨å™¨å†…å®¹ï¼Œbâ€“æ¯ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œ7â€“7ç»„
disassemble                   //åæ±‡ç¼–å½“å‰å‡½æ•°æˆ–æŒ‡å®šå‡½æ•°
si                            // ä¸€æ¡æŒ‡ä»¤ä¸€æ¡æŒ‡ä»¤è°ƒè¯• è€Œ s æ˜¯ä¸€è¡Œä¸€è¡Œä»£ç 
info registers                // æ˜¾ç¤ºæ‰€æœ‰å¯„å­˜å™¨çš„å½“å‰å€¼
x/20 $esp                    //æŸ¥çœ‹å†…å­˜ä¸­å¼€å§‹çš„20ä¸ªæ•°</p>
:ET