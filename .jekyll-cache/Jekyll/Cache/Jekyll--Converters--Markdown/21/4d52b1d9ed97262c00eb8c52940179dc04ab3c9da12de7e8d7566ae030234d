I"`<p>https://xargin.com/map-concurrent-throw/
æŸç³»ç»Ÿä¸­æœ‰ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ä»£ç ï¼š</p>

<p>package main</p>

<p>import (
	â€œsyncâ€
	â€œtimeâ€
)</p>

<p>type resp struct {
	k string
	v string
}</p>

<p>func main() {
	res := fetchData()
    log.Print(res)
}</p>

<p>func rpcwork() resp {
	// do some rpc work
	return resp{}
}</p>

<p>func fetchData() (map[string]string, error) {
	var result = map[string]string{} // result is k -&gt; v
	var keys = []string{â€œaâ€, â€œbâ€, â€œcâ€}
	var wg sync.WaitGroup
	var m sync.Mutex
	for i := 0; i &lt; len(keys); i++ {
		wg.Add(1)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	go func() {
		m.Lock()
		defer m.Unlock()
		defer wg.Done()

		// do some rpc
		resp := rpcwork()

		result[resp.k] = resp.v
	}()
}

waitTimeout(&amp;wg, time.Second)
return result, nil }
</code></pre></div></div>

<p>func waitTimeout(wg *sync.WaitGroup, timeout time.Duration) bool {
	c := make(chan struct{})
	go func() {
		defer close(c)
		wg.Wait()
	}()
	select {
	case &lt;-c:
		return false // completed normally
	case &lt;-time.After(timeout):
		return true // timed out
	}
}</p>

<p>çº¿ä¸Šä¼šå¶ç°å´©æºƒ(concurrent write and iteration)ï¼Œä½†å…¶è´Ÿè´£äººå£°ç§°ä¸€å®šæ˜¯ç¦»èŒå‘˜å·¥çš„é”…ï¼Œè¿ä»£ç éƒ½ä¸æ„¿æ„çœ‹ã€‚</p>

<p>è¿™é‡Œçš„ä»£ç æˆ‘å·²ç»ç®€åŒ–è¿‡äº†ï¼Œç›¸ä¿¡ä½ å¤§æ¦‚å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™é‡Œçš„ waitgroup ä½¿ç”¨ä¸æ°å½“ï¼Œè‹¥ä¸‹æ¸¸ç³»ç»Ÿå‘ç”Ÿè¶…æ—¶æ—¶ï¼Œè¯¥ waitgroup å…¶å®å¹¶æ²¡æœ‰å®Œæˆï¼Œè¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå…¶å­ä»»åŠ¡ä¹Ÿå¹¶æ²¡æœ‰å…¨éƒ¨å®Œæˆã€‚è™½ç„¶åœ¨ fetchData å†…éƒ¨å¯¹ map çš„ä¿®æ”¹åŠ äº†å†™é”ï¼Œä½†è‹¥ä¸‹æ¸¸è¶…æ—¶ï¼Œåœ¨ fetchData è¿”å›åï¼ŒfetchData å†…éƒ¨å¯åŠ¨çš„ goroutine ä»ç„¶å¯èƒ½å¯¹è¿”å›çš„ map è¿›è¡Œä¿®æ”¹ã€‚</p>

<p>å½“ map å¯¹è±¡åŒæ—¶è¿›è¡ŒåŠ é”çš„ write å’Œä¸åŠ é”çš„è¯»å–æ—¶ï¼Œä¹Ÿä¼šå‘ç”Ÿå´©æºƒã€‚ä¸åŠ é”çš„è¯»å–å‘ç”Ÿåœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿå…¶å®å°±æ˜¯è¿™é‡Œä¾‹å­çš„ log.Printã€‚å¦‚æœä½ åšä¸ª json.Marshal ä¹‹ç±»çš„ï¼Œæ•ˆæœä¹Ÿå·®ä¸å¤šã€‚</p>

<p>è‡³äºä¸ºä»€ä¹ˆæ˜¯å¶å‘ï¼Œè¶…æ—¶æœ¬æ¥ä¹Ÿä¸æ˜¯ç»å¸¸å‘ç”Ÿçš„ï¼Œçœ‹èµ·æ¥è¿™ä¸ª bug å°±å˜æˆäº†ä¸€ä¸ªå¶ç° bugã€‚</p>

<p>å’Œè¿™ä¸ª bug ç±»ä¼¼çš„è¿˜æœ‰åœ¨æ‰“å° context å¯¹è±¡çš„æ—¶å€™ï¼Œå‚è€ƒè¿™é‡Œã€‚</p>

<p>æˆ‘ä»¬å†é¡ºä¾¿æ§è¯‰ä¸€ä¸‹ Go æœ¬èº«ï¼Œè¿™ç§ map å¹¶å‘å´©æºƒçš„ bug å¯¹å¾ˆå¤šäººé€ æˆäº†å›°æ‰°ï¼ŒæŒ‰è¯´å´©æºƒçš„æ—¶å€™ä¼šæ‰“å°å¯¼è‡´å´©æºƒçš„ goroutine æ ˆï¼Œä½†ä¸ºä»€ä¹ˆè¿˜æ˜¯ä¸€ä¸ªå€¼å¾—æ€»ç»“çš„é—®é¢˜å‘¢ï¼Ÿ</p>

<p>æ˜¯å› ä¸º Go åœ¨å´©æºƒæ—¶ï¼Œå…¶å®å¹¶ä¸èƒ½å®Œæ•´åœ°æ‰“å°å¯¼è‡´å´©æºƒçš„å› æœå…³ç³»ï¼Œå‚è€ƒè¿™é‡Œã€‚</p>

<p>è¿™ä¸ª issue ä¸­åŒæ—¶ä¹Ÿç»™äº†ä¸‹é¢è¿™æ®µä»£ç ï¼Œåªæœ‰åœ¨ go run -race æ—¶ï¼Œæ‰èƒ½çœ‹åˆ°å¯¼è‡´ throw çš„çœŸæ­£åŸå› ã€‚</p>

<p>package main</p>

<p>import (
	â€œsyncâ€
)</p>

<p>var x map[int]string = make(map[int]string)</p>

<p>func f(s string, wg *sync.WaitGroup) {
	x[0] = s
	wg.Done()
}</p>

<p>func g(s string, wg *sync.WaitGroup) {
	x[1] = s
	wg.Done()
}</p>

<p>func main() {
	for {
		var wg sync.WaitGroup
		wg.Add(2)
		go f(â€œHelloâ€, &amp;wg)
		go g(â€œPlaygroundâ€, &amp;wg)
		wg.Wait()
	}
}
ä¸‹é¢è¿™ä¸ªå´©æºƒæ ˆåªèƒ½çœ‹åˆ° main.g(ä½ è¿è¡Œçš„æ—¶å€™ï¼Œä¹Ÿå¯èƒ½åªèƒ½çœ‹åˆ° main.f)ã€‚</p>

<p>~/test â¯â¯â¯ go run mmmm.go
fatal error: concurrent map writes</p>

<p>goroutine 48 [running]:
runtime.throw(0x1074091, 0x15)
	/usr/local/go/src/runtime/panic.go:774 +0x72 fp=0xc000030758 sp=0xc000030728 pc=0x1024fb2
runtime.mapassign_fast64(0x1060d00, 0xc000064000, 0x1, 0xc000066048)
	/usr/local/go/src/runtime/map_fast64.go:101 +0x350 fp=0xc000030798 sp=0xc000030758 pc=0x100dcd0
main.g(0x1072f92, 0xa, 0xc0000680f0)
	/Users/didi/test/mmmm.go:15 +0x46 fp=0xc0000307c8 sp=0xc000030798 pc=0x10525f6
runtime.goexit()
	/usr/local/go/src/runtime/asm_amd64.s:1357 +0x1 fp=0xc0000307d0 sp=0xc0000307c8 pc=0x104c001
created by main.main
	/Users/didi/test/mmmm.go:24 +0xbb</p>

<p>goroutine 1 [semacquire]:
sync.runtime_Semacquire(0xc0000680f8)
	/usr/local/go/src/runtime/sema.go:56 +0x42
sync.(*WaitGroup).Wait(0xc0000680f0)
	/usr/local/go/src/sync/waitgroup.go:130 +0x64
main.main()
	/Users/didi/test/mmmm.go:25 +0xc9
exit status 2
ä¸‹é¢è¿™æ ·æ‰èƒ½çœ‹åˆ°çœŸæ­£çš„åŸå› ï¼š</p>

<h1 id="test--go-run--race-mmmmgo">~/test â¯â¯â¯ go run -race mmmm.go</h1>
<p>WARNING: DATA RACE
Write at 0x00c00008c000 by goroutine 7:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  main.g()
      /Users/didi/test/mmmm.go:15 +0x63</p>

<p>Previous write at 0x00c00008c000 by goroutine 6:
  runtime.mapassign_fast64()
      /usr/local/go/src/runtime/map_fast64.go:92 +0x0
  main.f()
      /Users/didi/test/mmmm.go:10 +0x63</p>

<p>Goroutine 7 (running) created at:
  main.main()
      /Users/didi/test/mmmm.go:24 +0xee</p>

<p>Goroutine 6 (finished) created at:
  main.main()
      /Users/didi/test/mmmm.go:23 +0xb7
==================
fatal error: concurrent map writes</p>

<p>goroutine 67286 [running]:
runtime.throw(0x10ad440, 0x15)
	/usr/local/go/src/runtime/panic.go:774 +0x72 fp=0xc000094750 sp=0xc000094720 pc=0x105c272
runtime.mapassign_fast64(0x1099c20, 0xc00008c000, 0x0, 0x0)
	/usr/local/go/src/runtime/map_fast64.go:176 +0x364 fp=0xc000094790 sp=0xc000094750 pc=0x1044ed4
main.f(0x10abea9, 0x5, 0xc00017ffa0)
	/Users/didi/test/mmmm.go:10 +0x64 fp=0xc0000947c8 sp=0xc000094790 pc=0x108b184
runtime.goexit()
	/usr/local/go/src/runtime/asm_amd64.s:1357 +0x1 fp=0xc0000947d0 sp=0xc0000947c8 pc=0x1084651
created by main.main
	/Users/didi/test/mmmm.go:23 +0xb8</p>

<p>goroutine 1 [semacquire]:
sync.runtime_Semacquire(0xc00017ffa8)
	/usr/local/go/src/runtime/sema.go:56 +0x42
sync.(*WaitGroup).Wait(0xc00017ffa0)
	/usr/local/go/src/sync/waitgroup.go:130 +0xb1
main.main()
	/Users/didi/test/mmmm.go:25 +0xfd
exit status 2
å¦‚è‹¥åœ¨å®è·µä¸­ç¢°åˆ°äº†ç±»ä¼¼çš„ bugï¼Œåªèƒ½å¥½å¥½è¯»ä»£ç ï¼Œåˆ«æ— ä»–æ³•ï¼Œç”©é”…ç»™ç¦»èŒå‘˜å·¥æ˜¯è§£å†³ä¸äº†é—®é¢˜çš„ã€‚</p>

<p>å¦‚æœä½ æ‰‹è¾¹çš„ä»£ç æŠ½è±¡ç¨‹åº¦æ¯”è¾ƒé«˜ï¼Œæ¯”å¦‚å‡½æ•°çš„å‚æ•°éƒ½æ˜¯ä¸€äº› interfaceï¼Œç”±è¿è¡ŒæœŸæ¥å†³å®šï¼Œé‚£å¯èƒ½è¦å®šä½è¿™ç§ bug å°±æ›´è´¹åŠ²ä¸€äº›ã€‚
<!-- more -->
http://xiaorui.cc/archives/5919
https://github.com/golang/go/issues/26703
https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651437803&amp;idx=1&amp;sn=fe69335648dde77395659d2bb88bf832&amp;chksm=80bb6419b7cced0fd4eca56ae5a7a928990e189dd9c94aaae75950be70b73f9523ad1351e8e5&amp;scene=21#wechat_redirect
https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651436434&amp;idx=1&amp;sn=33143ae7dea378157f1555fa4a213dba&amp;chksm=80bb6b60b7cce2764ad7b0152f47ea26971c5ce9a9980aa65a0e0daa9a079ba596117109401f&amp;scene=21#wechat_redirect</p>

<p>å½“æˆ‘æ„è¯†åˆ°æˆ‘ä¸€ç›´åœ¨å¤„ç†å’Œè§£å†³çš„é—®é¢˜æœ‰ä¸€ä¸ªä¸“æœ‰åè¯æè¿°çš„æ—¶å€™ï¼Œæˆ‘æ€»ä¼šè§‰å¾—è¿™äº‹ååˆ†æœ‰è¶£ã€‚è¿™æ¬¡å‡ºç°è¿™ç§æƒ…å†µçš„æ˜¯ç«äº‰æ¡ä»¶(Race Conditions)ã€‚å½“ä½ å¤„ç†å¤šä¸ª routine å…±äº«æŸç±»èµ„æºçš„æ—¶å€™ï¼Œä¸å¯é¿å…çš„éœ€è¦è€ƒè™‘åˆ°è¿™ä¸ªã€‚å¦‚æœä½ æœªæ›¾åœ¨ä½ çš„ä»£ç ä¸­è€ƒè™‘è¿‡è¿™ä¸ªé—®é¢˜ï¼Œç°åœ¨å°±æ˜¯ä¸€ä¸ªä¸é”™çš„æ—¶å€™ã€‚</p>

<p>ç«äº‰æ¡ä»¶æ˜¯ï¼šå½“ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ routines è®¿é—®ç›¸åŒèµ„æºçš„æ—¶å€™ï¼Œä¾‹å¦‚ä¸€ä¸ªå˜é‡æˆ–è€…ç»“æ„ä½“ï¼Œå¹¶ä¸”åœ¨ä¸è€ƒè™‘å…¶ä»– Gorutines çš„æƒ…å†µä¸‹å¯¹èµ„æºè¿›è¡Œè¯»/å†™ã€‚è¿™ç±»ä»£ç èƒ½å¤Ÿé€ æˆä½ æ‰€èƒ½è§åˆ°çš„æœ€ä»¤äººå¤´ç–¼ï¼Œæœ€éšæœºçš„ bugsã€‚é€šå¸¸éœ€è¦å¤§é‡çš„æ—¥å¿—å’Œä¸€äº›è¿æ°”æ‰èƒ½æ‰¾åˆ°è¿™äº›ç±»å‹çš„é”™è¯¯ã€‚è¿™ä¹ˆå¤šå¹´æ¥ï¼Œæˆ‘å®Œå–„äº†æˆ‘çš„æ—¥å¿—çš„æŠ€èƒ½ï¼Œä»¥ä¾¿è¯†åˆ«è¿™äº›é—®é¢˜ã€‚</p>

<p>Go å·¥å…·å¥—ä»¶åœ¨ Go ç‰ˆæœ¬ 1.1 å¼•å…¥äº†ä¸€ä¸ªç«æ€æ£€æµ‹å·¥å…·(race detector)ã€‚è¿™ä¸ªç«æ€æ£€æµ‹å·¥å…·æ˜¯åœ¨ç¼–è¯‘æµç¨‹ä¸­å†…ç½®åˆ°ä½ ç¨‹åºçš„ä»£ç ã€‚ä¸€æ—¦ä½ çš„ç¨‹åºå¼€å§‹è¿è¡Œï¼Œå®ƒèƒ½å¤Ÿå‘ç°å’ŒæŠ¥å‘Šä»»ä½•ä»–æ‰€æ£€æµ‹åˆ°çš„ç«æ€æƒ…å†µã€‚è¿™æ˜¯éå¸¸æ£’çš„åŠŸèƒ½, ä¸ºè¯†åˆ«ç¼ºé™·ä»£ç åšå‡ºäº†éå¸¸é‡è¦çš„å·¥ä½œã€‚</p>

<p>è®©æˆ‘ä»¬å†™ä¸€ä¸ªéå¸¸çš„ç®€å•çš„åŒ…å«ç«æ€æ¡ä»¶å†…ç½®ç«æ€æ£€æµ‹ä»£ç çš„ç¨‹åºã€‚</p>

<p>package main</p>

<p>import (
   â€œfmtâ€
   â€œsyncâ€
)</p>

<p>var Wait sync.WaitGroup
var Counter int = 0</p>

<p>func main() {</p>

<p>for routine := 1; routine &lt;= 2; routine++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Wait.Add(1)
   go Routine(routine)   }
</code></pre></div></div>

<p>Wait.Wait()
   fmt.Printf(â€œFinal Counter: %d\nâ€, Counter)
}</p>

<p>func Routine(id int) {</p>

<p>for count := 0; count &lt; 2; count++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   value := Counter
   value++
   Counter = value   }
</code></pre></div></div>

<p>Wait.Done()
}
è¿™ä¸ªç¨‹åºçœ‹èµ·æ¥æ²¡æœ‰é—®é¢˜ã€‚å®ƒåˆ›å»ºäº†ä¸¤ä¸ªåç¨‹ï¼Œæ¯ä¸€ä¸ªåç¨‹éƒ½ä¼šå¢åŠ å…¨å±€å˜é‡ Counter ä¸¤æ¬¡ã€‚å½“ä»–ä»¬éƒ½è¿è¡Œç»“æŸåï¼Œç¨‹åºæ˜¾ç¤ºå…¨å±€å˜é‡ Counter çš„å€¼ã€‚å½“æˆ‘è¿è¡Œè¿™ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œä»–ä¼šæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ 4ã€‚æ‰€ä»¥è¿™ä¸ªç¨‹åºå·¥ä½œæ­£å¸¸,ä½†çœŸçš„å—ï¼Ÿ</p>

<p>è®©æˆ‘ä»¬é€šè¿‡ Go ç«æ€æ£€æµ‹è¿è¡Œè¿™ä¸ªä»£ç ï¼Œçœ‹çœ‹å®ƒä¼šå‘ç°ä»€ä¹ˆï¼Ÿåœ¨ä»£ç æ‰€åœ¨çš„ç›®å½•æ‰“å¼€ç»ˆç«¯ï¼Œä»¥ -race å‚æ•°ç¼–è¯‘ä»£ç ã€‚</p>

<p>go build -race
ç„¶åç¨‹åºè¾“å‡º</p>

<p>==================
WARNING: DATA RACE
Read by goroutine 5:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:29 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<p>Previous write by goroutine 4:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:33 +0x65
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<p>Goroutine 5 (running) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:17 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<p>Goroutine 4 (finished) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:17 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<p>==================
Final Counter: 4
Found 1 data race(s)
çœ‹èµ·æ¥ï¼Œå·¥å…·åœ¨ä»£ç ä¸­æ£€æµ‹åˆ°ç«äº‰æ¡ä»¶ã€‚å¦‚æœä½ æŸ¥çœ‹ä¸Šé¢çš„ç«äº‰æ¡ä»¶æŠ¥å‘Šï¼Œä½ ä¼šçœ‹åˆ°é’ˆå¯¹ç¨‹åºçš„è¾“å‡ºã€‚å…¨å±€å˜é‡ Counter çš„å€¼æ˜¯ 4ã€‚è¿™å°±æ˜¯è¿™ç±»çš„ bug çš„éš¾ç‚¹æ‰€åœ¨ï¼Œä»£ç å¤§éƒ¨åˆ†æƒ…å†µæ˜¯å·¥ä½œæ­£å¸¸çš„ï¼Œä½†é”™è¯¯çš„æƒ…å†µä¼šéšæœºäº§ç”Ÿã€‚ç«äº‰æ£€æµ‹å‘Šè¯‰æˆ‘ä»¬éšè—åœ¨ä»£ç ä¸­çš„ç³Ÿç³•é—®é¢˜ã€‚</p>

<p>è­¦å‘ŠæŠ¥å‘Šå‘Šè¯‰æˆ‘ä»¬é—®é¢˜å‘ç”Ÿçš„å‡†ç¡®ä½ç½®:</p>

<p>Read by goroutine 5:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:29 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  value := Counter
</code></pre></div></div>

<p>Previous write by goroutine 4:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:33 +0x65
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Counter = value
</code></pre></div></div>

<p>Goroutine 5 (running) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:17 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  go Routine(routine) ä½ èƒ½å‘ç°ç«äº‰æ£€æµ‹å™¨æŒ‡å‡ºä¸¤è¡Œè¯»å’Œå†™å…¨å±€å˜é‡ Counter çš„ä»£ç ã€‚åŒæ—¶ä¹ŸæŒ‡å‡ºç”Ÿæˆåç¨‹çš„ä»£ç ã€‚
</code></pre></div></div>

<p>è®©æˆ‘ä»¬å¯¹ä»£ç è¿›è¡Œç®€å•ä¿®æ”¹ï¼Œè®©ç«äº‰æƒ…å†µæ›´å®¹æ˜“æš´éœ²å‡ºæ¥ã€‚</p>

<p>package main</p>

<p>import (
   â€œfmtâ€
   â€œsyncâ€
   â€œtimeâ€
)</p>

<p>var Wait sync.WaitGroup
var Counter int = 0</p>

<p>func main() {</p>

<p>for routine := 1; routine &lt;= 2; routine++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Wait.Add(1)
   go Routine(routine)   }
</code></pre></div></div>

<p>Wait.Wait()
   fmt.Printf(â€œFinal Counter: %d\nâ€, Counter)
}</p>

<p>func Routine(id int) {</p>

<p>for count := 0; count &lt; 2; count++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   value := Counter
   time.Sleep(1 * time.Nanosecond)
   value++
   Counter = value   }
</code></pre></div></div>

<p>Wait.Done()
}
æˆ‘åœ¨å¾ªç¯ä¸­å¢åŠ äº†ä¸€ä¸ªçº³ç§’çš„æš‚åœã€‚è¿™ä¸ªæš‚åœæ­£å¥½ä½äºåç¨‹è¯»å–å…¨å±€å˜é‡ Couter å­˜å‚¨åˆ°æœ¬åœ°å‰¯æœ¬ä¹‹åã€‚è®©æˆ‘ä»¬è¿è¡Œè¿™ä¸ªç¨‹åºçœ‹çœ‹åœ¨è¿™ç§ä¿®æ”¹ä¹‹åï¼Œå…¨å±€å˜é‡ Counter çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ</p>

<p>Final Counter: 2
å¾ªç¯ä¸­çš„æš‚åœå¯¼è‡´ç¨‹åºçš„å¤±è´¥ã€‚Counter å˜é‡çš„å€¼ä¸å†æ˜¯ 4 è€Œæ˜¯ 2ã€‚å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿè®©æˆ‘ä»¬æ·±æŒ–ä»£ç çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ä¸ªçº³ç§’çš„æš‚åœä¼šå¯¼è‡´è¿™ä¸ª Bugã€‚</p>

<p>åœ¨æ²¡æœ‰æš‚åœçš„æƒ…å†µä¸‹ï¼Œä»£ç è¿è¡Œå¦‚ä¸‹å›¾ï¼š</p>

<p>æ²¡æœ‰æš‚åœçš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸€ä¸ªåç¨‹è¢«ç”Ÿæˆï¼Œå¹¶ä¸”å®Œæˆæ‰§è¡Œï¼Œç´§æ¥ç€ç¬¬äºŒä¸ªåç¨‹æ‰å¼€å§‹è¿è¡Œã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç¨‹åºçœ‹èµ·æ¥åƒæ­£ç¡®è¿è¡Œçš„åŸå› ï¼Œå› ä¸ºå®ƒåœ¨æˆ‘çš„ç”µè„‘ä¸Šè¿è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œä»¥è‡³äºä»£ç è‡ªè¡Œæ’é˜Ÿè¿è¡Œã€‚</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹åœ¨æœ‰æš‚åœçš„æƒ…å†µä¸‹ï¼Œä»£ç å¦‚ä½•è¿è¡Œ:</p>

<p>ä¸Šå›¾å·²ç»å±•ç¤ºäº†æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯ï¼Œå› æ­¤æˆ‘å°±æ²¡æœ‰æŠŠä»–å…¨éƒ¨ç”»å‡ºæ¥ã€‚è¿™ä¸ªæš‚åœå¯¼è‡´è¿è¡Œçš„ä¸¤ä¸ªåç¨‹ä¹‹é—´è¿›è¡Œäº†ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚è¿™æ¬¡æˆ‘ä»¬æœ‰ä¸€ä¸ªå®Œå…¨ä¸åŒçš„æƒ…å†µã€‚è®©æˆ‘ä»¬çœ‹çœ‹å›¾ä¸­å±•ç¤ºçš„ä»£ç :</p>

<p>value := Counter</p>

<p>time.Sleep(1 * time.Nanosecond)</p>

<p>value++</p>

<p>Counter = value
åœ¨æ¯ä¸€æ¬¡å¾ªç¯çš„è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå…¨å±€å˜é‡ Counter çš„å€¼éƒ½è¢«æš‚å­˜åˆ°æœ¬åœ°å˜é‡ valueï¼Œæœ¬åœ°çš„å‰¯æœ¬è‡ªå¢åï¼Œæœ€ç»ˆå†™å›å…¨å±€å˜é‡ Counterã€‚å¦‚æœè¿™ä¸‰è¡Œä»£ç åœ¨æ²¡æœ‰ä¸­æ–­çš„æƒ…å†µä¸‹ï¼Œæ²¡æœ‰ç«‹å³è¿è¡Œï¼Œé‚£ä¹ˆç¨‹åºå°±ä¼šå‡ºç°é—®é¢˜ã€‚ä¸Šé¢çš„å›¾ç‰‡å±•ç¤ºäº†å…¨å±€å˜é‡ Counter çš„è¯»å–å’Œä¸Šä¸‹æ–‡åˆ‡æ¢æ˜¯å¦‚ä½•å¯¼è‡´é—®é¢˜çš„ã€‚</p>

<p>åœ¨è¿™å¹…å›¾ä¸­ï¼Œåœ¨è¢«åç¨‹ 1 å¢åŠ çš„å˜é‡è¢«å†™å›å…¨å±€å˜é‡ Counter ä¹‹å‰ï¼Œåç¨‹ 2 è¢«å”¤é†’å¹¶è¯»å–å…¨å±€å˜é‡ Counterã€‚å®è´¨ä¸Šï¼Œè¿™ä¸¤ä¸ªåç¨‹å¯¹å…¨å±€Counterå˜é‡æ‰§è¡Œå®Œå…¨ç›¸åŒçš„è¯»å†™æ“ä½œï¼Œå› æ­¤æœ€ç»ˆçš„ç»“æœæ‰æ˜¯ 2ã€‚</p>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ ä¹Ÿè®¸è®¤ä¸ºæˆ‘ä»¬åªéœ€è¦å°†å¢åŠ å…¨å±€å˜é‡ Counter çš„ä¸‰è¡Œä»£ç æ”¹å†™å‡å°‘åˆ°ä¸€è¡Œå³å¯ã€‚</p>

<p>package main</p>

<p>import (
   â€œfmtâ€
   â€œsyncâ€
   â€œtimeâ€
)</p>

<p>var Wait sync.WaitGroup
var Counter int = 0</p>

<p>func main() {</p>

<p>for routine := 1; routine &lt;= 2; routine++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Wait.Add(1)
   go Routine(routine)   }
</code></pre></div></div>

<p>Wait.Wait()
   fmt.Printf(â€œFinal Counter: %d\nâ€, Counter)
}</p>

<p>func Routine(id int) {</p>

<p>for count := 0; count &lt; 2; count++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Counter = Counter + 1
   time.Sleep(1 * time.Nanosecond)   }
</code></pre></div></div>

<p>Wait.Done()
}
å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªç‰ˆæœ¬çš„ä»£ç çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šå†æ¬¡å¾—åˆ°æ­£ç¡®çš„ç»“æœ:</p>

<p>Final Counter: 4
å¦‚æœæˆ‘ä»¬å¯åŠ¨ç«äº‰æ£€æµ‹æ¥è¿è¡Œè¯¥ä»£ç ï¼Œä¸Šé¢å‡ºç°çš„é—®é¢˜åº”è¯¥ä¼šæ¶ˆå¤±:</p>

<p>go build -race
å¹¶ä¸”è¾“å‡ºä¸º:</p>

<p>==================
WARNING: DATA RACE
Write by goroutine 5:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:30 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<p>Previous write by goroutine 4:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:30 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<p>Goroutine 5 (running) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:18 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<p>Goroutine 4 (running) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:18 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<p>==================
Final Counter: 4
Found 1 data race(s)
ç„¶è€Œï¼Œåœ¨è¿™ä¸‰åè¡Œä»£ç çš„ç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä»ç„¶æ£€æµ‹åˆ°ä¸€ä¸ªç«äº‰æ¡ä»¶ã€‚</p>

<p>Write by goroutine 5:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:30 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Counter = Counter + 1
</code></pre></div></div>

<p>Previous write by goroutine 4:
main.Routine()
    /Users/bill/Spaces/Test/src/test/main.go:30 +0x44
gosched0()
    /usr/local/go/src/pkg/runtime/proc.c:1218 +0x9f</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  Counter = Counter + 1
</code></pre></div></div>

<p>Goroutine 5 (running) created at:
main.main()
    /Users/bill/Spaces/Test/src/test/main.go:18 +0x66
runtime.main()
    /usr/local/go/src/pkg/runtime/proc.c:182 +0x91</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  go Routine(routine) ä½¿ç”¨ä¸€è¡Œä»£ç è¿›è¡Œå¢åŠ æ“ä½œçš„ç¨‹åºæ­£ç¡®åœ°è¿è¡Œäº†ã€‚ä½†ä¸ºä»€ä¹ˆä»£ç ä»ç„¶æœ‰ä¸€ä¸ªç«æ€æ¡ä»¶ï¼Ÿä¸è¦è¢«æˆ‘ä»¬ç”¨äºé€’å¢ Counter å˜é‡çš„ä¸€è¡ŒGoä»£ç æ‰€æ¬ºéª—ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸€è¡Œä»£ç ç”Ÿæˆçš„æ±‡ç¼–ä»£ç :
</code></pre></div></div>

<p>0064 (./main.go:30) MOVQ Counter+0(SB),BX ; Copy the value of Counter to BX
0065 (./main.go:30) INCQ ,BX             ; Increment the value of BX
0066 (./main.go:30) MOVQ BX,Counter+0(SB) ; Move the new value to Counter
å®é™…ä¸Šæ˜¯æ‰§è¡Œè¿™ä¸‰è¡Œæ±‡ç¼–ä»£ç å¢åŠ  counter å˜é‡ã€‚ä»–ä»¬ååˆ†è¯¡å¼‚åœ°çœ‹èµ·æ¥åƒæœ€åˆçš„ Go ä»£ç ã€‚ä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½å‘ç”Ÿåœ¨è¿™ä¸‰è¡Œæ±‡ç¼–çš„ä¸­çš„ä»»æ„ä¸€è¡Œåé¢ã€‚å°½ç®¡è¿™ä¸ªç¨‹åºæ­£å¸¸å·¥ä½œäº†ï¼Œä½†ä¸¥æ ¼æ¥è¯´ï¼ŒBug ä»ç„¶å­˜åœ¨ã€‚</p>

<p>å°½ç®¡æˆ‘ä½¿ç”¨çš„ä¾‹å­éå¸¸ç®€å•ï¼Œå®ƒè¿˜æ˜¯ä½“ç°å‘ç°è¿™ç§ Bug çš„å¤æ‚æ€§ã€‚ä»»ä½•ä¸€è¡Œç”± Go ç¼–è¯‘å™¨äº§ç”Ÿçš„æ±‡ç¼–ä»£ç éƒ½æœ‰å¯èƒ½å› ä¸ºä¸‹æ–‡åˆ‡æ¢è€Œåœæ­¢è¿è¡Œã€‚æˆ‘ä»¬çš„ Go ä»£ç ä¹Ÿè®¸çœ‹èµ·æ¥èƒ½å¤Ÿå®‰å…¨åœ°è®¿é—®èµ„æºï¼Œå®é™…ä¸Šåº•å±‚æ±‡ç¼–ä»£ç å¯èƒ½æ¼æ´ç™¾å‡ºã€‚</p>

<p>ä¸ºäº†è§£å†³è¿™ç±»é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿è¯»å†™å…¨å±€å˜é‡ Counter æ€»æ˜¯åœ¨ä»»ä½•å…¶ä»–åç¨‹è®¿é—®è¯¥å˜é‡ä¹‹å‰å®Œæˆã€‚ç®¡é“(channle)èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æœ‰åºåœ°è®¿é—®èµ„æºã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä¼šä½¿ç”¨ä¸€ä¸ªäº’æ–¥é”(Mutex):</p>

<p>package main</p>

<p>import (
   â€œfmtâ€
   â€œsyncâ€
   â€œtimeâ€
)</p>

<p>var Wait sync.WaitGroup
var Counter int = 0
var Lock sync.Mutex</p>

<p>func main() {</p>

<p>for routine := 1; routine &lt;= 2; routine++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Wait.Add(1)
   go Routine(routine)   }
</code></pre></div></div>

<p>Wait.Wait()
   fmt.Printf(â€œFinal Counter: %d\nâ€, Counter)
}</p>

<p>func Routine(id int) {</p>

<p>for count := 0; count &lt; 2; count++ {</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   Lock.Lock()

   value := Counter
   time.Sleep(1 * time.Nanosecond)
   value++
   Counter = value

   Lock.Unlock()   }
</code></pre></div></div>

<p>Wait.Done()
}
ä»¥ç«æ€æ£€æµ‹çš„æ¨¡å¼ï¼Œç¼–è¯‘ç¨‹åºï¼ŒæŸ¥çœ‹è¿è¡Œç»“æœ:</p>

<p>go build -race
./test</p>

<p>Final Counter: 4
è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å¾—åˆ°äº†æ­£ç¡®çš„ç»“æœï¼Œå¹¶ä¸”æ²¡æœ‰å‘ç°ä»»ä½•ç«æ€æ¡ä»¶ã€‚è¿™ä¸ªç¨‹åºæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚äº’æ–¥é”ä¿æŠ¤äº†åœ¨ Lock å’Œ Unlock ä¹‹é—´çš„ä»£ç ï¼Œç¡®ä¿äº†ä¸€æ¬¡åªæœ‰ä¸€ä¸ªåç¨‹æ‰§è¡Œè¯¥æ®µä»£ç ã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–‡ç« å­¦ä¹ æ›´å¤šä¾‹å­ï¼Œæ›´å¥½åœ°ç†è§£ Go ç«æ€æ£€æµ‹å™¨ï¼š</p>

<p>http://blog.golang.org/race-detector</p>

<p>å¦‚æœä½ ä½¿ç”¨äº†å¤šä¸ªåç¨‹ï¼Œé‚£ä¹ˆä½¿ç”¨ç«æ€æ£€æµ‹å™¨æµ‹è¯•ä½ çš„ä»£ç æ˜¯ä¸ªä¸é”™çš„å»ºè®®ã€‚å®ƒä¼šåœ¨å•å…ƒæµ‹è¯•å’Œè´¨é‡ä¿è¯æµ‹è¯•ä¸­ï¼Œä¸ºä½ èŠ‚çœå¤§é‡çš„æ—¶é—´å’Œéº»çƒ¦ã€‚Go å¼€å‘äººå‘˜èƒ½æœ‰è¿™æ ·çš„å·¥å…·æ˜¯å¾ˆå¹¸è¿åœ°ï¼Œæ‰€ä»¥å€¼å¾—å­¦ä¹ ä¸€ä¸‹ã€‚</p>

<p>https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651437922&amp;idx=4&amp;sn=7950c36dc1c53c4cd7f3f619459cd3b9&amp;chksm=80bb6590b7ccec861b15ac40e54856add76bb0befd1a186d7e07c3d4767ce4f521c3060420ff&amp;scene=21#wechat_redirect</p>

<p>https://mp.weixin.qq.com/s?__biz=MzAxMTA4Njc0OQ==&amp;mid=2651437922&amp;idx=4&amp;sn=7950c36dc1c53c4cd7f3f619459cd3b9&amp;chksm=80bb6590b7ccec861b15ac40e54856add76bb0befd1a186d7e07c3d4767ce4f521c3060420ff&amp;scene=21#wechat_redirect</p>

<p>Any race is a bug
æˆ‘åœ¨æ¥æ‰‹å…¶ä»–åŒäº‹çš„ golang é¡¹ç›®æ—¶ï¼Œä¸€èˆ¬éƒ½ä¼šä¹ æƒ¯æ€§çš„åšä¸€ä¸ªç«æ€æ£€æµ‹ã€‚æœ‰æ—¶æ€»ä¼šå¾—åˆ°ä¸€äº›â€œæƒŠå–œâ€ï¼Œæ¯”å¦‚åƒä¸‹é¢è¿™æ®µä»£ç ï¼š</p>

<p>package
 main</p>

<p>import</p>

<p>(</p>

<p>â€œfmtâ€</p>

<p>â€œruntimeâ€</p>

<p>â€œtimeâ€</p>

<p>)</p>

<p>var
 i 
=</p>

<p>0</p>

<p>func main
()</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>runtime . GOMAXPROCS ( 2 )



go func ()
</code></pre></div></div>

<p>{</p>

<p>for</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        fmt . Println ( "i is" ,  i )

        time . Sleep ( time . Second )
</code></pre></div></div>

<p>}</p>

<p>}()</p>

<p>for</p>

<p>{</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    i  +=
</code></pre></div></div>

<p>1</p>

<p>}</p>

<p>}</p>

<p>å½“é€šè¿‡ go run-race cmd.go æ‰§è¡Œæ—¶ï¼Œå¯ä»¥çœ‹åˆ°æœ‰æ˜æ˜¾çš„ç«æ€å‡ºç°ï¼š</p>

<p>==================</p>

<p>WARNING
:
 DATA RACE</p>

<p>Read
 at 
0x0000005e4600</p>

<p>by
 goroutine 
6
:</p>

<p>main
.
main
.
func1
()</p>

<p>/
root
/
gofourge
/
src
/
lab
/
cmd
.
go
:
15</p>

<p>+
0x63</p>

<p>Previous
 write at 
0x0000005e4600</p>

<p>by
 main goroutine
:</p>

<p>main
.
main
()</p>

<p>/
root
/
gofourge
/
src
/
lab
/
cmd
.
go
:
20</p>

<p>+
0x7b</p>

<p>Goroutine</p>

<p>6</p>

<p>(
running
)
 created at
:</p>

<p>main
.
main
()</p>

<p>/
root
/
gofourge
/
src
/
lab
/
cmd
.
go
:
13</p>

<p>+
0x4f</p>

<p>==================</p>

<p>i 
is
:</p>

<p>8212</p>

<p>i 
is
:</p>

<p>54959831</p>

<p>i 
is
:</p>

<p>109202117</p>

<p>æˆ‘è§‰å¾—ä¸åŒçš„ goroutine å¹¶å‘è¯»å†™åŒä¸€ä¸ªå˜é‡ï¼Œéœ€è¦åŠ é”ï¼Œè¿™åº”è¯¥æ˜¯å¤©ç»åœ°ä¹‰çš„å¸¸è¯†ã€‚ä½†æ˜¯æ€»æœ‰äººä»¥ä¸ºï¼Œä¸åŠ é”å¯¼è‡´çš„é—®é¢˜æœ€å¤šå°±æ˜¯è¯»å–çš„æ•°æ®æ˜¯ä¿®æ”¹å‰çš„æ•°æ®ï¼Œä¸èƒ½ä¿è¯åŸå­æ€§ç½¢äº†ã€‚æ˜¯è¿™æ ·çš„å—ï¼Ÿä»ä¸Šé¢çš„è¾“å‡ºæ¥çœ‹ï¼Œä¼¼ä¹ä¹Ÿå·®ä¸å¤šï¼Œå…¶å®è¿™äº›éƒ½æ˜¯å…¸å‹çš„è¯¯è§£ã€‚</p>

<p>æœ‰äº›æœ‹å‹å¯èƒ½ä¸çŸ¥é“ï¼Œåœ¨ Goï¼ˆç”šè‡³æ˜¯å¤§éƒ¨åˆ†è¯­è¨€ï¼‰ä¸­ï¼Œä¸€æ¡æ™®é€šçš„èµ‹å€¼è¯­å¥å…¶å®å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼ˆè¯­è¨€è§„èŒƒåŒæ ·æ²¡æœ‰å®šä¹‰ i++ æ˜¯åŸå­æ“ä½œ, ä»»ä½•å˜é‡çš„èµ‹å€¼éƒ½ä¸æ˜¯åŸå­æ“ä½œï¼‰ã€‚ä¾‹å¦‚ï¼Œåœ¨ 32 ä½æœºå™¨ä¸Šå†™ int64ç±»å‹çš„å˜é‡æ˜¯æœ‰ä¸­é—´çŠ¶æ€çš„ï¼Œå®ƒä¼šè¢«æ‹†æˆä¸¤æ¬¡å†™æ“ä½œ MOV â€”â€” å†™ä½ 32 ä½å’Œå†™é«˜ 32 ä½ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p>å¦‚æœä¸€ä¸ªçº¿ç¨‹åˆšå†™å®Œä½ 32 ä½ï¼Œè¿˜æ²¡æ¥å¾—åŠå†™é«˜ 32 ä½æ—¶ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¯»å–äº†è¿™ä¸ªå˜é‡ï¼Œé‚£å®ƒå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ¯«æ— é€»è¾‘çš„ä¸­é—´å˜é‡ï¼Œè¿™å¾ˆæœ‰å¯èƒ½ä½¿æˆ‘ä»¬çš„ç¨‹åºå‡ºç°è¯¡å¼‚çš„ Bugã€‚</p>

<p>è€Œåœ¨ Go çš„å†…å­˜æ¨¡å‹ä¸­ï¼Œæœ‰ race çš„ Go ç¨‹åºçš„è¡Œä¸ºæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œç†è®ºä¸Šå‡ºç°ä»€ä¹ˆæƒ…å†µéƒ½æ˜¯æ­£å¸¸çš„ã€‚å°±æ‹¿ä¸Šé¢çš„ä»£ç æ¥è¯´ï¼Œå½“å»æ‰ -race å‚æ•°æ‰§è¡Œæ—¶ï¼Œå¤§æ¦‚ç‡ä¼šå¾—åˆ°è¿™æ ·çš„è¾“å‡ºï¼š</p>

<p>i 
is
:</p>

<p>0</p>

<p>i 
is
:</p>

<p>0</p>

<p>i 
is
:</p>

<p>0</p>

<p>i 
is
:</p>

<p>0</p>

<p>è€Œç”¨è¾ƒè€çš„ go ç‰ˆæœ¬æ‰§è¡Œæ—¶ï¼ŒåŸºæœ¬ä¸Šæ‰§è¡Œä¸€æ®µæ—¶é—´ï¼Œç¨‹åºå°±ä¼š HANG ä½ã€‚æ‰€ä»¥è®¨è®ºä¸ºä»€ä¹ˆå‡ºç°è¿™ç§ç°è±¡å®é™…ä¸Šæ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œä¸è¦ä¾èµ–è¿™ç§è¡Œä¸ºã€‚</p>

<p>Mutex vs Atomic
è§£å†³ race çš„é—®é¢˜æ—¶ï¼Œæ— éå°±æ˜¯ä¸Šé”ã€‚å¯èƒ½å¾ˆå¤šäººéƒ½å¬è¯´è¿‡ä¸€ä¸ªé«˜é€¼æ ¼çš„è¯å«ã€Œæ— é”é˜Ÿåˆ—ã€ã€‚éƒ½ä¸€å¬åˆ°åŠ é”å°±è§‰å¾—å¾ˆ lowï¼Œé‚£æ— é”åˆæ˜¯æ€ä¹ˆä¸€å›äº‹ï¼Ÿå…¶å®å°±æ˜¯åˆ©ç”¨ atomic ç‰¹æ€§ï¼Œé‚£ atomic ä¼šæ¯” mutex æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼ŸBenign Data Races: What Could Possibly Go Wrong? çš„ä½œè€…æ€»ç»“äº†è¿™ä¸¤è€…çš„ä¸€ä¸ªåŒºåˆ«ï¼š</p>

<p>Mutexes do no scale. Atomic loads do.</p>

<p>mutex ç”±æ“ä½œç³»ç»Ÿå®ç°ï¼Œè€Œ atomic åŒ…ä¸­çš„åŸå­æ“ä½œåˆ™ç”±åº•å±‚ç¡¬ä»¶ç›´æ¥æä¾›æ”¯æŒã€‚åœ¨ CPU å®ç°çš„æŒ‡ä»¤é›†é‡Œï¼Œæœ‰ä¸€äº›æŒ‡ä»¤è¢«å°è£…è¿›äº† atomic åŒ…ï¼Œè¿™äº›æŒ‡ä»¤åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ˜¯ä¸å…è®¸ä¸­æ–­ï¼ˆinterruptï¼‰çš„ï¼Œå› æ­¤åŸå­æ“ä½œå¯ä»¥åœ¨ lock-free çš„æƒ…å†µä¸‹ä¿è¯å¹¶å‘å®‰å…¨ï¼Œå¹¶ä¸”å®ƒçš„æ€§èƒ½ä¹Ÿèƒ½åšåˆ°éš CPU ä¸ªæ•°çš„å¢å¤šè€Œçº¿æ€§æ‰©å±•ã€‚</p>

<p>è‹¥å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œåè€…é€šå¸¸ä¼šæ›´æœ‰æ•ˆç‡ï¼Œå¹¶ä¸”æ›´èƒ½åˆ©ç”¨è®¡ç®—æœºå¤šæ ¸çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œä»¥åå½“æˆ‘ä»¬æƒ³å¹¶å‘å®‰å…¨çš„æ›´æ–°ä¸€äº›å˜é‡çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥ä¼˜å…ˆé€‰æ‹©ç”¨ atomic æ¥å®ç°ã€‚</p>
:ET