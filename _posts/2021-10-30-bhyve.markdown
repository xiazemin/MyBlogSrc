---
title: bhyve
layout: post
categories: docker k8s
author: å¤æ³½æ°‘
---
FreeBSD ä¸‹çš„è™šæ‹ŸæŠ€æœ¯ bhyve (The BSD Hypervisor) åŒ…å«åœ¨äº† FreeBSD 10.0 å‘è¡Œç‰ˆä¸­ã€‚è€Œè¿™ä¸ª xhyve æ˜¯åŸºäº bhyve çš„ Mac OS X ç§»æ¤ç‰ˆæœ¬

https://github.com/machyve/xhyve

ä½¿ç”¨ git ä¸‹è½½æºç åç¼–è¯‘ï¼Œè¿è¡Œ xhyverun.sh åä¼šå¯åŠ¨ä¸€ä¸ªç®€å•çš„ Tiny Core Linux è™šæ‹Ÿæœºï¼š

$ git clone https://github.com/mist64/xhyve.git 
$ cd xhyve 
$ make 
$ ./xhyverun.sh
<!-- more -->
æˆ‘ä»¬çŸ¥é“docker æ˜¯åŸºäºlinux ç³»ç»Ÿçš„namespace + cgroupå®ç°çš„è¿›ç¨‹éš”ç¦»æŠ€æœ¯ï¼Œåœ¨macä¸‹å¹¶ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒï¼Œå› æ­¤éœ€è¦è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šï¼Œè™šæ‹Ÿæœºå’Œdockerçš„åŒºåˆ«åœ¨äºï¼Œè™šæ‹Ÿæœºå¤šäº†ä¸€å±‚hypervisorã€‚FreeBSD ä¸‹çš„è™šæ‹ŸæŠ€æœ¯ bhyve (The BSD Hypervisor) åŒ…å«åœ¨äº† FreeBSD 10.0 å‘è¡Œç‰ˆä¸­ã€‚è€Œè¿™ä¸ª xhyve æ˜¯åŸºäº bhyve çš„ Mac OS X ç§»æ¤ç‰ˆæœ¬

https://github.com/machyve/xhyve

        Docker for Mac ä¹Ÿæ˜¯åœ¨æœ¬åœ°è·‘äº†ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è¿è¡Œ Dockerï¼Œä¸è¿‡ Hypervisor é‡‡ç”¨çš„æ˜¯ xhyveï¼Œè€Œ xhyve åˆåŸºäº Mac è‡ªå¸¦çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆ Hypervisor.frameworkï¼Œè™šæ‹Ÿæœºé‡Œè¿è¡Œçš„å‘è¡Œç‰ˆæ˜¯ Docker è‡ªå·±æ‰“åŒ…çš„ LinuxKitã€‚HyperKitæ˜¯ä¸€ä¸ªå…·æœ‰hyperisorèƒ½åŠ›çš„å·¥å…·é›†ï¼ŒåŒ…å«äº†åŸºäº xhyve - macOSå¹³å°çš„KVM/bhyve (è½»é‡çº§è™šæ‹Ÿæœºå’Œå®¹å™¨éƒ¨ç½²) çš„å®Œæ•´hypervisorã€‚HyperKitè®¾è®¡æˆä¸Šå±‚ç»„ä»¶è¯¸å¦‚ VPNKit å’Œ DataKit çš„æ¥å£ã€‚

æ³¨è§£

 VPNKitï¼šåµŒå…¥å¼è™šæ‹Ÿç½‘ç»œåº“ï¼ŒVPNKit æ˜¯ä¸€ä¸ªå·¥å…·å’ŒæœåŠ¡é›†åˆç”¨äºå¸®åŠ©HyperKitè™šæ‹Ÿæœºå’Œä¸»æœºVPNé…ç½®åä½œã€‚https://github.com/moby/vpnkit

HyperKitï¼šOSXä¸Šè¿è¡Œçš„è½»é‡çº§è™šæ‹ŸåŒ–å·¥å…·åŒ…https://github.com/moby/hyperkit

DataKitï¼šç°ä»£åŒ–åˆ†å¸ƒå¼ç»„ä»¶æ¡†æ¶https://github.com/moby/datakit

linuxkitæ˜¯ä¸€ä¸ªdockerè‡ªå·±æ‰“åŒ…çš„linuxé•œåƒï¼Œéå¸¸å°æœ‰ç‚¹ç±»ä¼¼apline

https://github.com/linuxkit/linuxkit

        æ€»ç»“èµ·æ¥ï¼šdocker for mac æ˜¯è¿è¡Œåœ¨macä¸Šçš„è™šæ‹Ÿæœºxhyveé‡Œï¼Œlinuxé•œåƒlinuxkitçš„å®ä¾‹é‡Œã€‚

        é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•è¿›å…¥linuxkitå‘¢ï¼Ÿæ•´ä½“ä¸Šæœ‰ä¸¤å¤§ç±»æ–¹æ³•ï¼š1ï¼Œé€šè¿‡å®¿ä¸»æœºçš„ttyæˆ–è€…socketè¿›å…¥ã€‚2ï¼Œåœ¨linuxkitä¸Šè¿è¡Œå®¹å™¨ï¼Œé€šè¿‡enternsè¿›å…¥ã€‚

     

        åœ¨æ—©æœŸçš„docker for mac ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶è·¯å¾„æ˜¯ï¼š

/Users/Kamus/Library/Containers/com.docker.docker/Data/vms/0/Docker.raw
è¿›å…¥åˆ°è¿™ä¸ªæ–‡ä»¶çš„æ‰€åœ¨ç›®å½•ã€‚å¯ä»¥çœ‹åˆ°ttyè¿™ä¸ªè½¯é“¾æ¥æ–‡ä»¶ã€‚

$ cd /Users/Kamus/Library/Containers/com.docker.docker/Data/vms/0
$ ls -l
total 31067864
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000002.000005f4
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000002.00001000
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000002.00001001
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000002.0000f3a5
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000003.000005f5
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 00000003.00000948
-rw-r--r--@ 1 Kamus  staff  63999836160  7  7 12:51 Docker.raw
-rw-r--r--  1 Kamus  staff       215040  7  4 12:22 config.iso
srwxr-xr-x  1 Kamus  staff            0  7  4 12:22 connect
lrwxr-xr-x  1 Kamus  staff           17  7  4 12:22 guest.000005f5 -> 00000003.000005f5
lrwxr-xr-x  1 Kamus  staff           17  7  4 12:22 guest.00000948 -> 00000003.00000948
-rw-r--r--  1 Kamus  staff         2303  7  4 12:22 hyperkit.json
-rw-r--r--  1 Kamus  staff            4  7  4 12:22 hyperkit.pid
drwxr-xr-x  2 Kamus  staff           64 11 21  2018 log
-rw-r--r--  1 Kamus  staff           36 11 21  2018 nic1.uuid
lrwxr-xr-x  1 Kamus  staff           12  7  4 12:22 tty -> /dev/ttys000
screenè¯¥æ–‡ä»¶å³å¯è¿æ¥åˆ°è™šæ‹Ÿæœºçš„è¾“å‡ºçª—å£ä¸­ã€‚

$ screen tty
åœ¨æ–°çš„ç‰ˆæœ¬é‡Œï¼ˆ20.10.5ï¼‰ç‰ˆæœ¬ä»¥åï¼Œä½¿ç”¨socketä»£æ›¿äº†ï¼š

I think the new version of docker (my version is 20.10.5) uses socket instead of TTY to communicate with the virtual machine so you can use the nc command instead of the screen command.

nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock
?????uname -a
Linux docker-desktop 5.10.47-linuxkit #1 SMP PREEMPT Sat Jul 3 21:50:16 UTC 2021 aarch64 Linux
å¯ä»¥çœ‹åˆ°ï¼Œè¿è¡Œçš„é•œåƒæ˜¯linuxkit

        è¿˜å¯ä»¥ä½¿ç”¨æ›´ä¼˜é›…çš„æ–¹å¼ï¼Œä¸´æ—¶å»ºä¸€ä¸ªæœ€å°åŒ–çš„debianå®¹å™¨ï¼ŒæŒ‡å®šå®¹å™¨è¿è¡Œåœ¨pid=hostå‘½åç©ºé—´ä¸‹ï¼Œç„¶åè¯¥å®¹å™¨è¿è¡Œnsenterå‘½ä»¤ã€‚

$ docker run -it --rm --privileged --pid=host debian nsenter -t 1 -m -u -n -i sh
Unable to find image 'debian:latest' locally
latest: Pulling from library/debian
6f2f362378c5: Pull complete
Digest: sha256:118cf8f3557e1ea766c02f36f05f6ac3e63628427ea8965fb861be904ec35a6f
Status: Downloaded newer image for debian:latest
 # uname -a
Linux linuxkit-025000000001 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 Linux
è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™æ¡å‘½ä»¤ä¸ºä»€ä¹ˆå°±ä¼šç™»å½•è¿›macOSä¸­ä½œä¸ºå®¿ä¸»æœºçš„VMé‡Œé¢ã€‚
â€“rmè¡¨ç¤ºåœ¨é€€å‡ºçš„æ—¶å€™å°±è‡ªåŠ¨åˆ é™¤è¯¥å®¹å™¨ï¼›
â€“privilegedè¡¨ç¤ºå…è®¸è¯¥å®¹å™¨è®¿é—®å®¿ä¸»æœºï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬æƒ³è¦ç™»å½•çš„VMï¼‰ä¸­çš„å„ç§è®¾å¤‡ï¼›
â€“pid=hostè¡¨ç¤ºå…è®¸å®¹å™¨å…±äº«å®¿ä¸»æœºçš„è¿›ç¨‹å‘½åç©ºé—´ï¼ˆnamespaceï¼‰ï¼Œæˆ–è€…é€šä¿—ç‚¹å„¿è§£é‡Šå°±æ˜¯å…è®¸å®¹å™¨çœ‹åˆ°å®¿ä¸»æœºä¸­çš„å„ç§è¿›ç¨‹ï¼›
è¿™äº›æ˜¯dockeråœ¨å¯åŠ¨å®¹å™¨æ—¶å€™çš„å‚æ•°è®¾ç½®ï¼Œä½†æ˜¯ä»…ä»…ä¾é è¿™äº›å‚æ•°è¿˜æ— æ³•è®©æˆ‘ä»¬ç›´æ¥ç™»å½•åˆ°å®¿ä¸»æœºVMä¸­ï¼Œæ¥ä¸‹æ¥è§£é‡Šæœ€ä¸»è¦çš„nsenterå‘½ä»¤ã€‚

nsenteræ˜¯ä¸€ä¸ªå°å·¥å…·å…è®¸æˆ‘ä»¬è¿›å…¥ä¸€ä¸ªæŒ‡å®šçš„namespaceç„¶åè¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œns=namespaceï¼Œenter=è¿›å…¥ã€‚
namespaceæ˜¯å®¹å™¨æŠ€æœ¯çš„æ ¹åŸºï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºnamespaceå°±æ˜¯ä¸€ç»„éš”ç¦»çš„èµ„æºï¼Œä¸åŒçš„è¿›ç¨‹å¯ä»¥çœ‹åˆ°ä¸åŒçš„ç³»ç»Ÿèµ„æºè¿™é‡Œå’Œè¿™é‡Œæœ‰æ¯”è¾ƒè¯¦ç»†çš„å…³äºnamespaceçš„ä»‹ç»ã€‚
å¯ä»¥ä»æ“ä½œç³»ç»Ÿçš„/proc/[pid]/nsç›®å½•ä¸‹ä¸€çª¥å…¨è²Œã€‚æ¯”å¦‚æˆ‘ä»¬è¿›å…¥pid=1çš„nsç›®å½•ä¸‹ã€‚å¯ä»¥çœ‹åˆ°æœ‰ä¸€å…±8ç§namespaceã€‚

# pwd
/proc/1/ns
# ls -l
total 0
lrwxrwxrwx 1 root root 0 Jul  8 12:51 cgroup -> cgroup:[4026531835]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 ipc -> ipc:[4026531839]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 mnt -> mnt:[4026531840]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 net -> net:[4026531889]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 pid -> pid:[4026531836]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 pid_for_children -> pid:[4026531836]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 user -> user:[4026531837]
lrwxrwxrwx 1 root root 0 Jul  8 12:51 uts -> uts:[4026531838]
æœ€åè§£é‡Šä¸€ä¸‹nsenterå‘½ä»¤çš„é€‰é¡¹ã€‚å›é¡¾ä¸€ä¸‹å‘½ä»¤æ˜¯ï¼šnsenter -t 1 -m -u -n -i sh
-t 1: è¡¨ç¤ºè¦è¿›å…¥å“ªä¸ªpidï¼Œ1è¡¨ç¤ºæ•´ä¸ªæ“ä½œç³»ç»Ÿçš„ä¸»è¿›ç¨‹id
-m: è¿›å…¥mount namespaceï¼ŒæŒ‚è½½ç‚¹
-u: è¿›å…¥UTS namespaceï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æˆ‘ä»¬æ¼”ç¤ºçš„é‚£ä¸ªnamespace
-n: è¿›å…¥network namespaceï¼Œç½‘ç»œ
-i: è¿›å…¥IPC namespaceï¼Œè¿›ç¨‹é—´é€šä¿¡
sh: è¡¨ç¤ºè¿è¡Œ/bin/sh



https://developer.aliyun.com/article/116675

https://cloud-atlas.readthedocs.io/zh_CN/latest/kvm/macos_xhyve/xhyve.html

https://www.kaifa99.com/GitHub/article_125375

https://medium.com/@hintcnuie/the-difference-between-xhyve-and-hyperkit-67a9f378ab97

https://github.com/moby/vpnkit

https://github.com/moby/datakit

https://www.nebulaworks.com/insights/posts/getting-started-linuxkit-mac-os-x-xhyve/

https://docs.docker.com/desktop/mac/

Docker for Mac ä¹Ÿæ˜¯åœ¨æœ¬åœ°è·‘äº†ä¸€ä¸ªè™šæ‹Ÿæœºæ¥è¿è¡Œ Dockerï¼Œä¸è¿‡ Hypervisor é‡‡ç”¨çš„æ˜¯ xhyveï¼Œè€Œ xhyve åˆåŸºäº Mac è‡ªå¸¦çš„è™šæ‹ŸåŒ–æ–¹æ¡ˆ Hypervisor.frameworkï¼Œè™šæ‹Ÿæœºé‡Œè¿è¡Œçš„å‘è¡Œç‰ˆæ˜¯ Docker è‡ªå·±æ‰“åŒ…çš„ LinuxKit

https://www.haoyizebo.com/posts/fd0b9bd8/

% brew install opam libev

opam init No configuration file found, using built-in defaults. Checking for available remotes: rsync and local, git.

you won't be able to use mercurial repositories unless you install the hg command on your system.
you won't be able to use darcs repositories unless you install the darcs command on your system.
<><> Fetching repository information ><><><><><><><><><><><><><><><><><><><> ğŸ« Processing 1/1: [default: http]

https://github.com/linuxkit/linuxkit

https://github.com/linuxkit/kubernetes

https://blog.51cto.com/lullaby/2421309

https://tonybai.com/2021/03/23/io-fs-interface-is-an-excellent-design/

https://github.com/docker/for-mac

https://www.zhihu.com/question/40051989?sort=created

https://cleanmymac.cn/download https://www.pagetable.com/?p=831

https://github.com/Wang-Kai/cherish-today/issues/83

https://www.zhihu.com/question/454947910/answer/1841432604

https://github.com/moby/hyperkit. âˆš

https://forums.docker.com/t/how-to-make-changes-to-xhyve-host/11820/5

https://github.com/machyve/xhyve

https://forums.docker.com/t/is-it-possible-to-ssh-to-the-xhyve-machine/17426

https://zhuanlan.zhihu.com/p/43237959

https://docs.docker.com/engine/reference/commandline/dockerd/

https://blog.csdn.net/zhangmenghao1983/article/details/82184957

https://blog.csdn.net/baidu_32656897/article/details/86504317

https://www.cnblogs.com/cag2050/p/10100899.html

https://www.dbform.com/2019/07/08/how-to-login-the-vm-of-docker-desktop-for-mac/

https://medium.com/carvago-development/my-docker-on-macos-part-1-setup-ubuntu-virtual-machine-both-intel-and-apple-silicon-cpu-5d886af0ebba

https://gist.github.com/BretFisher/5e1a0c7bcca4c735e716abf62afad389

https://www.modb.pro/db/5458

https://earthly.dev/blog/using-apple-silicon-m1-as-a-cloud-engineer-two-months-in/

2

I think the new version of docker (my version is 20.10.5) uses socket instead of TTY to communicate with the virtual machine so you can use the nc command instead of the screen command.

nc -U ~/Library/Containers/com.docker.docker/Data/debug-shell.sock

https://stackoverflow.com/questions/38532483/where-is-var-lib-docker-on-mac-os-x

?????uname -a Linux docker-desktop 5.10.47-linuxkit #1 SMP PREEMPT Sat Jul 3 21:50:16 UTC 2021 aarch64 Linux

https://www.krenger.ch/blog/docker-desktop-for-mac-ssh-into-the-docker-vm/

https://stackoverflow.com/questions/39739560/how-to-access-the-vm-created-by-dockers-hyperkit

https://www.jianshu.com/p/ab6f8be85470

https://collabnix.com/how-docker-for-mac-works-under-the-hood/

https://collabnix.com/how-docker-for-mac-works-under-the-hood/

https://gist.github.com/retraut/1dee3d6331c4b8eeb4ef54bfdce09d62

https://wongyouth.github.io/2019/04/28/xhyve-%E8%8B%B9%E6%9E%9C%E7%94%B5%E8%84%91%E4%B8%8B%E8%BD%BB%E9%87%8F%E7%BA%A7%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%96%B9%E6%A1%88/

https://www.wavether.com/2016/09/docker-machine-xhyve-mac-os

/ # ^[[26;5Rctr version ctr version Client: Version: v1.3.4 Revision: 814b7956fafc7a0980ea07e950f983d0837e5578

Server: Version: v1.3.4 Revision: 814b7956fafc7a0980ea07e950f983d0837e5578 UUID: d0bdf2c7-b3d8-45f2-be9a-ffdd6c782cc5 / # ^[[26;5R^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@

hyperkit % make

% ./hyperkitrun.sh ~/source/hyperkit/test ~/source/hyperkit Downloading tinycore linux

~/source/hyperkit hv_vm_create HV_ERROR (unspecified error) ./hyperkitrun.sh: line 39: 84413 Abort trap: 6 build/hyperkit $ACPI $MEM $SMP $PCI_DEV $LPC_DEV $NET $IMG_CD $IMG_HDD $UUID -f kexec,$KERNEL,$INITRD,"$CMDLINE"

https://github.com/kubernetes/minikube/issues/10120

https://github.com/moby/hyperkit/issues/303#issuecomment-875122919

HyperKitæ˜¯ä¸€ä¸ªå…·æœ‰hyperisorèƒ½åŠ›çš„å·¥å…·é›†ï¼ŒåŒ…å«äº†åŸºäº xhyve - macOSå¹³å°çš„KVM/bhyve (è½»é‡çº§è™šæ‹Ÿæœºå’Œå®¹å™¨éƒ¨ç½²) çš„å®Œæ•´hypervisorã€‚HyperKitè®¾è®¡æˆä¸Šå±‚ç»„ä»¶è¯¸å¦‚ VPNKit å’Œ DataKit çš„æ¥å£ã€‚

æ³¨è§£

VPNKit æ˜¯ä¸€ä¸ªå·¥å…·å’ŒæœåŠ¡é›†åˆç”¨äºå¸®åŠ©HyperKitè™šæ‹Ÿæœºå’Œä¸»æœºVPNé…ç½®åä½œã€‚

DataKit æ˜¯ä¸€ä¸ªä½¿ç”¨ç±»ä¼¼Gitçš„å·¥ä½œæµæ¥ç¼–æ’åº”ç”¨ç¨‹åºçš„å·¥å…·ï¼Œå€Ÿé‰´äº†UNIXç®¡é“(pipline)æ¦‚å¿µï¼Œä½¿ç”¨äº†æ›¿ä»£åº•å±‚æ–‡æœ¬çš„æ ‘çŠ¶ç»“æ„æ•°æ®çš„æµã€‚DataKitå¯ä»¥åœ¨ç‰ˆæœ¬æ§åˆ¶æ•°æ®ä¸Šå®šä¹‰å¤æ‚çš„ç¼–è¯‘å·¥ä½œæµã€‚å½“å‰DataKitä½œä¸ºHyperKitçš„ä¸€ä¸ªå†™ä½œæµï¼Œä»¥åŠç”¨äº DataKitCI æŒç»­é›†æˆç³»ç»Ÿã€‚

è¦æ¿€æ´»å—è®¾å¤‡åç«¯æ”¯æŒqcowï¼Œå‡†å¤‡ä¸€ä¸ª OCaml OPAMå¼€å‘ç¯å¢ƒã€‚åˆ™éœ€è¦é€šè¿‡ brew å®‰è£… opam å’Œ libev ç„¶åä½¿ç”¨ opam æ¥å®‰è£…ç›¸åº”çš„åº“:

brew install opam libev opam init eval opam config env opam install uri qcow.0.10.4 conduit.1.0.0 lwt.3.1.0 qcow-tool mirage-block-unix.2.9.0 conf-libev logs fmt mirage-unix prometheus-app

https://cloud-atlas.readthedocs.io/zh_CN/latest/docker/moby/hyperkit/run_hyperkit.html

HyperKitï¼šOSXä¸Šè¿è¡Œçš„è½»é‡çº§è™šæ‹ŸåŒ–å·¥å…·åŒ… DataKitï¼šç°ä»£åŒ–åˆ†å¸ƒå¼ç»„ä»¶æ¡†æ¶ VPNKitï¼šåµŒå…¥å¼è™šæ‹Ÿç½‘ç»œåº“

http://dockone.io/article/1329

https://github.com/moby/hyperkit

https://minikube.sigs.k8s.io/docs/drivers/hyperkit/